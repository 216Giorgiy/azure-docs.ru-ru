Ниже показано, как подключиться к экземпляру SQL Server через Интернет с помощью SQL Server Management Studio (SSMS). Однако, чтобы сделать виртуальную машину SQL Server доступной для приложений, выполняющихся как локально, так и в среде Azure, необходимо выполнить те же действия.

Чтобы подключиться к экземпляру SQL Server из другой виртуальной машины или через Интернет, необходимо выполнить задачи, описанные в следующих разделах:

- [Создание конечной точки TCP для виртуальной машины](#create-a-tcp-endpoint-for-the-virtual-machine)
- [Открытие портов TCP в брандмауэре Windows](#open-tcp-ports-in-the-windows-firewall-for-the-default-instance-of-the-database-engine)
- [Настройка SQL Server для прослушивания через протокол TCP](#configure-sql-server-to-listen-on-the-tcp-protocol)
- [Настройка SQL Server для аутентификации в смешанном режиме](#configure-sql-server-for-mixed-mode-authentication)
- [Создание имен входа для аутентификации SQL Server](#create-sql-server-authentication-logins)
- [Определение DNS-имени виртуальной машины](#determine-the-dns-name-of-the-virtual-machine)
- [Подключение к ядру СУБД с другого компьютера](#connect-to-the-database-engine-from-another-computer)

Процедура подключения показана на следующей схеме:

![Подключение к виртуальной машине SQL Server](./media/virtual-machines-sql-server-connection-steps/SQLServerinVMConnectionMap.png)

### Создайте конечную точку TCP для виртуальной машины

Для доступа к SQL Server из Интернета на виртуальной машине должна быть настроена конечная точка для прослушивания входящих TCP-подключений. На данном этапе настройки Azure направляет входящий трафик TCP-порта на TCP-порт, доступный для виртуальной машины.

>[AZURE.NOTE]При подключении в пределах той же облачной службы или виртуальной сети не нужно создавать общедоступную конечную точку. В этом случае можно перейти к следующему шагу. Дополнительные сведения см. в статье [Сценарии подключения](../articles/virtual-machines/virtual-machines-sql-server-connectivity.md#connection-scenarios).

1. На портале управления Azure щелкните **ВИРТУАЛЬНЫЕ МАШИНЫ**.
	
2. Щелкните только что созданную виртуальную машину. Отображаются сведения о вашей виртуальной машине.
	
3. В верхней части страницы выберите **КОНЕЧНЫЕ ТОЧКИ**, а в нижней части щелкните **ДОБАВИТЬ**.
	
4. На странице **Добавление конечной точки для виртуальной машины** нажмите кнопку **Добавить автономную конечную точку**, а затем щелкните стрелку "Далее" для продолжения.
	
5. На странице **Укажите подробные сведения конечной точки** введите следующую информацию.

	- В поле **ИМЯ** укажите имя конечной точки.
	- В поле **ПРОТОКОЛ** выберите **TCP**. В поле **ОБЩИЙ ПОРТ** можно ввести значение **57500**. Аналогичным образом в поле **Частный порт** можно указать значение **1433** для порта прослушивания SQL Server по умолчанию. Обратите внимание, что многие организации предпочитают использовать различные номера портов для предотвращения вредоносных атак. 

6. Установите флажок для продолжения. Конечная точка создана.

### Откройте TCP-порты в брандмауэре Windows для экземпляра ядра СУБД по умолчанию

1. Подключитесь к виртуальной машине через удаленный рабочий стол Windows. После входа введите **WF.msc** на начальном экране и нажмите клавишу ВВОД. 

	![Запустите программу брандмауэра](./media/virtual-machines-sql-server-connection-steps/12Open-WF.png)
2. В поле **Брандмауэр Windows в режиме повышенной безопасности** в левой области щелкните правой кнопкой мыши **Правила для входящих подключений** и нажмите кнопку **Создать правило** в области действий.

	![Создать правило](./media/virtual-machines-sql-server-connection-steps/13New-FW-Rule.png)

3. В области **Тип правила** диалогового окна **Мастер создания правила для нового входящего подключения** выберите **Порт** и нажмите кнопку **Далее**.

4. В диалоговом окне **Протокол и порты** используйте значение по умолчанию **TCP**. Выберите поле **Определенные локальные порты**, а затем введите номер порта экземпляра ядра СУБД (**1433** для экземпляра по умолчанию или номер для частного порта, указанный при настройке конечной точки).

	![TCP-порт 1433](./media/virtual-machines-sql-server-connection-steps/14Port-1433.png)

5. Нажмите кнопку **Далее**.

6. В диалоговом окне **Действие** выберите **Разрешить подключение** и нажмите кнопку **Далее**.

	**Примечание по безопасности.** Выбрав вариант **Разрешить только безопасное подключение**, можно обеспечить дополнительную защиту. Выберите этот вариант, если требуется настроить дополнительные параметры безопасности в вашей среде.

	![Разрешить подключения](./media/virtual-machines-sql-server-connection-steps/15Allow-Connection.png)

7. В диалоговом окне **Профиль** выберите **Общий**, **Личный** и **Доменный**. Нажмите кнопку **Далее**.

    **Примечание по безопасности.** Выбрав вариант **Открытый**, вы получите доступ через Интернет. Во всех возможных случаях выбирайте более строгий профиль.

	![Открытый профиль](./media/virtual-machines-sql-server-connection-steps/16Public-Private-Domain-Profile.png)

8. В диалоговом окне **Имя** введите имя и описание правила и нажмите кнопку **Готово**.

	![Имя правила](./media/virtual-machines-sql-server-connection-steps/17Rule-Name.png)

При необходимости откройте дополнительные порты для других компонентов. Дополнительные сведения содержатся в разделе [Настройка брандмауэра Windows для разрешения доступа к SQL Server](http://msdn.microsoft.com/library/cc646023.aspx).


### Настройка SQL Server для прослушивания через протокол TCP

1. При установленном подключении к виртуальной машине на начальной странице введите **SQL Server Configuration Manager** и нажмите клавишу ВВОД.
	
	![Откройте SSCM](./media/virtual-machines-sql-server-connection-steps/9Click-SSCM.png)

2. В диспетчере конфигурации SQL Server в области консоли разверните пункт **Сетевая конфигурация SQL Server**.

3. В области консоли щелкните **Протоколы для MSSQLSERVER** (имя экземпляра по умолчанию). В области сведений щелкните правой кнопкой мыши TCP; он должен быть включен для образов из коллекции по умолчанию. Для пользовательских образов щелкните **Включить** (если его состояние "Отключено").

	![Включение TCP](./media/virtual-machines-sql-server-connection-steps/10Enable-TCP.png)

5. В области консоли выберите **Службы SQL Server**. В области сведений щелкните правой кнопкой мыши **SQL Server (_имя экземпляра_)** (экземпляр по умолчанию — **SQL Server (MSSQLSERVER)**) и нажмите кнопку **Перезагрузить**, чтобы остановить и перезапустить экземпляр SQL Server.

	![Перезапустите ядро СУБД](./media/virtual-machines-sql-server-connection-steps/11Restart.png)

7. Закройте диспетчер конфигурации SQL Server.

Дополнительные сведения о включении протоколов для компонента SQL Server Database Engine см. в разделе [Включение или отключение сетевого протокола сервера](http://msdn.microsoft.com/library/ms191294.aspx).

### Настройка SQL Server на проверку подлинности в смешанном режиме

Компонент SQL Server Database Engine не может использовать проверку подлинности Windows без среды домена. Чтобы подключиться к компоненту Database Engine с другого компьютера, необходимо настроить для SQL Server смешанный режим проверки подлинности. Смешанный режим позволяет выполнять проверку подлинности SQL Server и проверку подлинности Windows.

>[AZURE.NOTE]Настройка аутентификации в смешанном режиме может быть необязательна, если вы настроили виртуальную сеть Azure с помощью настроенной доменной среды.

1. При установленном подключении к виртуальной машине на начальной странице введите **SQL Server 2014 Management Studio** и щелкните выбранный значок.

	![Запустите SSMS](./media/virtual-machines-sql-server-connection-steps/18Start-SSMS.png)

	При первом открытии Management Studio необходимо создать среду пользователей Management Studio. Это может занять несколько минут.

2. Management Studio отображает диалоговое окно **Подключение к серверу**. В поле **Имя сервера** введите имя виртуальной машины для подключения к компоненту Database Engine с помощью обозревателя объектов. (Вместо имени виртуальной машины можно также использовать **(local)** или один период в качестве **имени сервера**. Выберите **Проверка подлинности Windows** и оставьте **_your\_VM\_name_\\your\_local\_administrator** в поле **Имя пользователя**. Щелкните **Подключить**.

	![Подключение к серверу](./media/virtual-machines-sql-server-connection-steps/19Connect-to-Server.png)

3. В обозревателе объектов SQL Server Management Studio щелкните правой кнопкой мыши имя экземпляра SQL Server (имя виртуальной машины) и нажмите **Свойства**.

	![Свойства сервера](./media/virtual-machines-sql-server-connection-steps/20Server-Properties.png)

4. На странице **Безопасность** в разделе **Проверка подлинности сервера** выберите **Режим проверки подлинности SQL Server и Windows** и нажмите кнопку **ОК**.

	![Выберите режим проверки подлинности](./media/virtual-machines-sql-server-connection-steps/21Mixed-Mode.png)

5. В диалоговом окне SQL Server Management Studio щелкните **ОК** для подтверждения необходимости перезапуска SQL Server.

6. В обозревателе объектов щелкните сервер правой кнопкой мыши и выберите **Перезагрузить**. (Если выполняется агент SQL Server, его также нужно перезапустить).

	![Перезагрузить](./media/virtual-machines-sql-server-connection-steps/22Restart2.png)

7. В диалоговом окне SQL Server Management Studio щелкните **Да** для подтверждения перезапуска SQL Server.

### Создание учетных записей проверки подлинности SQL Server

Чтобы подключиться к компоненту Database Engine с другого компьютера, необходимо создать как минимум одну учетную запись проверки подлинности SQL Server.

1. В обозревателе объектов SQL Server Management Studio разверните папку экземпляра сервера, на котором требуется создать новую учетную запись.

2. Щелкните правой кнопкой мыши папку **Безопасность**, выберите **Создать** и **Учетная запись...**

	![Новая учетная запись](./media/virtual-machines-sql-server-connection-steps/23New-Login.png)

3. В диалоговом окне **Создание учетной записи** на странице **Общие** введите имя нового пользователя в поле **Имя для входа в систему**.

4. Выберите **Проверка подлинности SQL Server**.

5. В поле **Пароль** введите пароль для нового пользователя. В поле **Подтвердите пароль** введите пароль еще раз.

6. Для принудительного применения политики паролей в плане их сложности выберите **Требовать использование политики паролей** (рекомендуется). Этот параметр активируется по умолчанию, если выбрана проверка подлинности SQL Server.

7. Для принудительного применения политики паролей в плане времени действия пароля выберите **Задать срок окончания действия пароля** (рекомендуется). Для установки этого флажка нужно выбрать пункт "Требовать использование политики паролей". Этот параметр активируется по умолчанию, если выбрана проверка подлинности SQL Server.

8. Чтобы предложить пользователю создать новый пароль после первого входа в систему, выберите **Пользователь должен сменить пароль при следующем входе в систему** (рекомендуется если имя входа предназначается для использования другим человеком. Если создается имя входа для собственного использования, этот параметр выбирать не нужно). Для установки этого флажка нужно выбрать пункт "Задать срок окончания действия пароля". Этот параметр активируется по умолчанию, если выбрана проверка подлинности SQL Server.

9. В списке **База данных по умолчанию** выберите базу данных по умолчанию для учетной записи. По умолчанию используется значение **Основная**. Если пользовательская база данных еще не создана, оставьте значение **Основная**.

10. В списке **Язык по умолчанию** оставьте значение **По умолчанию**.
    
	![Свойства учетной записи](./media/virtual-machines-sql-server-connection-steps/24Test-Login.png)

11. При первом создании учетной записи может потребоваться ее назначение в качестве администратора SQL Server. В таком случае на странице **Роли сервера** выберите **sysadmin**.

	**Примечание по безопасности.** Представители фиксированной серверной роли sysadmin получают полный контроль над компонентом ядра СУБД. Количество представителей этой роли нужно ограничить.

	![sysadmin](./media/virtual-machines-sql-server-connection-steps/25sysadmin.png)

12. Нажмите кнопку ОК.

Более подробные сведения об учетных записях SQL Server см. в разделе [Создание учетной записи](http://msdn.microsoft.com/library/aa337562.aspx).

### Определение DNS-имени виртуальной машины

Для подключения к компоненту SQL Server Database Engine с другого компьютера необходимо знать имя виртуальной машины в системе доменных имен (DNS). (Это имя используется для идентификации виртуальной машины в сети Интернет. Можно использовать IP-адрес, но IP-адрес может измениться при перемещении ресурсов Azure для обеспечения избыточности или при выполнении обслуживания. DNS-имя будет оставаться неизменным, так как оно может быть перенаправлено на новый IP-адрес).

1. На портале управления Azure (или на предыдущем этапе) выберите **ВИРТУАЛЬНЫЕ МАШИНЫ**. 

2. На странице **ЭКЗЕМПЛЯРЫ ВИРТУАЛЬНОЙ МАШИНЫ** в столбце **Сводка** найдите и скопируйте DNS-имя для виртуальной машины.

	![DNS-имя](./media/virtual-machines-sql-server-connection-steps/sql-vm-dns-name.png)
	

### Подключение к ядру СУБД с другого компьютера
 
1. На компьютере, подключенном к сети Интернет, откройте SQL Server Management Studio.
2. В диалоговом окне **Подключение к серверу** или **Подключение к ядру СУБД** в поле **Имя сервера** введите DNS-имя виртуальной машины (определяется на предыдущем этапе) и номер порта открытой конечной точки в формате *DNSName,portnumber*, например **tutorialtestVM.cloudapp.net,57500**. Чтобы получить номер порта, войдите на портал управления Azure и найдите нужную виртуальную машину. На панели мониторинга щелкните **КОНЕЧНЫЕ ТОЧКИ** и используйте **ОБЩИЙ ПОРТ**, назначенный для **MSSQL**. ![Общий порт](./media/virtual-machines-sql-server-connection-steps/sql-vm-port-number.png)
3. В поле **Проверка подлинности** выберите **Проверка подлинности SQL Server**.
5. В поле **Учетная запись** введите имя учетной записи, которая была создана на предыдущем этапе.
6. В поле **Пароль** введите пароль учетной записи, которая была создана на предыдущем этапе.
7. Щелкните **Подключить**.

	![Connect using SSMS](./media/virtual-machines-sql-server-connection-steps/33Connect-SSMS.png)

<!---HONumber=Oct15_HO3-->