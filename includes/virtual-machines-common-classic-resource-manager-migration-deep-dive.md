## <a name="meaning-of-migration-of-iaas-resources-from-classic-to-resource-manager"></a>Значение переноса ресурсов IaaS из классической модели в модель Resource Manager
Прежде чем углубиться в подробности, давайте остановимся на отличиях между операциями с ресурсами IaaS в плоскости данных и плоскости управления.

* *Плоскость управления* описывает вызовы, поступающие в плоскость управления или API для изменения ресурсов. Например, такие операции, как создание виртуальной машины, перезапуск виртуальной машины и добавление в виртуальную сеть новой подсети, оперируют работающими ресурсами. Они не оказывают непосредственного влияния на подключение к экземплярам.
* *Плоскость данных* (приложение) описывает среду выполнения приложения, включая взаимодействие с экземплярами, которое не осуществляется через API Azure. Доступ к веб-сайту или извлечение данных из работающего экземпляра SQL Server или сервера MongoDB будут считаться операциями в плоскости данных или взаимодействием с приложением. Копирование большого двоичного объекта из учетной записи хранения и доступ к общедоступному IP-адресу для подключения к виртуальной машине по протоколу RDP или SSH также являются операциями в плоскости данных. Эти операции обеспечивают рабочее состояние приложения для вычислительных и сетевых ресурсов, а также ресурсов хранения.

![Снимок экрана, иллюстрирующий различие между плоскостью управления и плоскостью данных.](../articles/virtual-machines/media/virtual-machines-windows-migration-classic-resource-manager/data-control-plane.png)

> [!NOTE]
> В некоторых сценариях миграции платформа Azure останавливает, освобождает и перезапускает виртуальные машины. Это приводит к кратковременному простою плоскости данных.
>
>

## <a name="the-migration-experience"></a>Процесс миграции
Прежде чем начать миграцию, настоятельно рекомендуется следующее.

* Убедитесь, что ресурсы, которые вы хотите перенести, не используют какие-либо неподдерживаемые компоненты или конфигурации. Обычно платформа обнаруживает такие проблемы и выдает ошибку.
* В ходе подготовки виртуальные машины, которые не находятся в виртуальной сети, будут остановлены, а их распределение отменено. Если вы не хотите потерять общедоступный IP-адрес, зарезервируйте его, прежде чем начать подготовку. Тем не менее, если виртуальные машины расположены в виртуальной сети, то они не будут остановлены и освобождены.
* Планируйте провести миграцию в нерабочее время, чтобы справиться с любыми непредвиденными сбоями, которые могут возникнуть.
* Скачайте текущую конфигурацию виртуальных машин с помощью PowerShell, команд интерфейса командной строки или интерфейсов REST API, чтобы упростить проверку после завершения подготовки.
* Обновите сценарии автоматизации и ввода в эксплуатацию для работы с моделью развертывания с помощью Resource Manager, прежде чем начать миграцию. При необходимости можно выполнять операции GET, пока ресурсы находятся в состоянии подготовки.
* Оцените политики RBAC, настроенные для классических ресурсов IaaS, и составьте план на период после завершения миграции.

Ниже представлен рабочий процесс переноса.

![Снимок экрана с этапами миграции](../articles/virtual-machines/windows/media/migration-classic-resource-manager/migration-workflow.png)

> [!NOTE]
> Все операции, описанные в следующих разделах, являются идемпотентными. Если вы столкнетесь с какой-либо проблемой, не связанной с неподдерживаемой функцией или ошибкой конфигурации, мы рекомендуем повторить подготовку, прервать или зафиксировать текущую операцию. Платформа Azure попытается повторить это действие.
>
>

### <a name="validate"></a>Проверка
Операция проверки — это первый шаг в процессе переноса. Цель этого шага — анализировать данные для переносимых ресурсов в фоновом режиме и сообщать об успешном завершении или сбое в зависимости от того, можно ли перенести ресурсы.

Вы выберете виртуальную сеть или размещенную службу (если она не является виртуальной сетью), которую нужно проверить перед переносом.

* Если ресурс невозможно перенести, то платформа Azure укажет все соответствующие причины.

При проверке служб хранилища вы найдете перенесенную учетную запись в группе ресурсов с именем вашей учетной записи хранения, к которому добавлен суффикс "-Migrated".  Например, если ваша учетная запись хранения — mystorage, то вы найдете ресурс с поддержкой ARM в группе ресурсов mystorage-Migrated, и она будет содержать учетную запись хранения mystorage.

### <a name="prepare"></a>Подготовка.
Операция подготовки — это второй шаг в процессе переноса. На этом этапе моделируется преобразование классических ресурсов IaaS в ресурсы Resource Manager, после чего на экране рядом отображаются ресурсы до и после преобразования для наглядности.

Следует выбрать виртуальную сеть или размещенную службу (если она не является виртуальной сетью), которую нужно подготовить к миграции.

* Если ресурс не может быть перенесен, платформа Azure остановит процесс переноса и укажет причину, по которой не удалось выполнить операцию подготовки.
* Если ресурс можно перенести, платформа Azure сначала заблокирует для него операции в плоскости управления для переносимых ресурсов. Например, вы не сможете добавить диск данных в виртуальную машину, которая переносится.

Затем платформа Azure начнет перенос метаданных переносимых ресурсов из классической модели в модель Resource Manager.

После завершения подготовки можно будет визуализировать ресурсы в классической модели и модели Resource Manager. Для каждой облачной службы в классической модели развертывания платформа Azure создает имя группы ресурсов по шаблону `cloud-service-name>-Migrated`.

> [!NOTE]
> Невозможно выбрать имя группы ресурсов, созданной для перенесенных ресурсов (т. е. -Migrated), но после завершения миграции можно использовать функцию перемещения Azure Resource Manager, чтобы переместить ресурсы в любую группу ресурсов на ваш выбор. Дополнительные сведения об этом см. в статье [Перемещение ресурсов в новую группу ресурсов или подписку](../articles/resource-group-move-resources.md).

Ниже приведены два снимка экрана, на которых показан результат успешной операции подготовки. На первом показана группа ресурсов, содержащая исходную облачную службу. На втором — группа ресурсов -Migrated, содержащая эквивалентные ресурсы Azure Resource Manager.

![Снимок экрана классический облачной службы на портале](../articles/virtual-machines/windows/media/migration-classic-resource-manager/portal-classic.png)

![Снимок экрана подготовки ресурсов Azure Resource Manager на портале.](../articles/virtual-machines/windows/media/migration-classic-resource-manager/portal-arm.png)

> [!NOTE]
> Виртуальные машины, не входящие в классическую виртуальную сеть, на этом этапе миграции будут остановлены и освобождены.
>
>

### <a name="check-manual-or-scripted"></a>Проверка (вручную или с помощью сценария)
На этапе проверки можно дополнительно использовать конфигурацию, скачанную ранее, чтобы проверить, выполнена ли миграция правильно. Можно также войти на портал и выборочно просмотреть свойства и ресурсы, чтобы проверить, выполнена ли миграция метаданных должным образом.

В случае переноса виртуальной сети большинство конфигураций виртуальных машин не будут перезапущены. Однако можно проверить, работают ли приложения в виртуальных машинах.

Можно проверить мониторинг и автоматизацию, а также рабочие сценарии, чтобы убедиться, что виртуальные машины работают надлежащим образом и обновленные сценарии работают правильно. Если ресурсы находятся в состоянии подготовки, то для них доступны только операции GET.

Длительность миграции не фиксирована. В этом состоянии время не ограничено. Тем не менее плоскость управления для этих ресурсов будет заблокирована, пока не будет выполнено прерывание или фиксация.

Если возникнут какие-либо неполадки, всегда можно прервать миграцию и вернуться к классической модели развертывания. После этого платформа Azure разблокирует операции с ресурсами в плоскости управления, чтобы вы могли возобновить обычную работу этих виртуальных машин в классической модели развертывания.

### <a name="abort"></a>Прерывание
Прерывание — необязательный шаг, который позволяет отменить изменения классической модели развертывания и прервать миграцию.

> [!NOTE]
> Эту операцию нельзя выполнить, если вы активировали фиксацию.     
>
>

### <a name="commit"></a>Фиксация
После завершения проверки миграцию можно зафиксировать. Ресурсы больше не будут отображаться в классической модели и будут доступны только в модели развертывания с помощью Resource Manager. Перенесенными ресурсами можно управлять только на новом портале.

> [!NOTE]
> Эта идемпотентная операция. В случае сбоя этой операции рекомендуется повторить попытку. Если проблема не устраняется, отправьте запрос в службу поддержки или создайте запись с тегом ClassicIaaSMigration на нашем [форуме о виртуальных машинах](https://social.msdn.microsoft.com/Forums/azure/home?forum=WAVirtualMachinesforWindows).
>
>
<br>
Ниже приведена последовательность действий при переносе.

![Снимок экрана с последовательностью операций переноса](../articles/virtual-machines/windows/media/migration-classic-resource-manager/migration-flow.png)

## <a name="translation-of-classic-to-azure-resource-manager-resources"></a>Преобразование классических ресурсов в ресурсы Azure Resource Manager
В таблице ниже представлены ресурсы в классической модели и модели Resource Manager. Остальные функции и ресурсы в настоящий момент не поддерживаются.

| Представление классической модели | Представление Resource Manager | Подробные примечания |
| --- | --- | --- |
| Имя облачной службы |DNS-имя |Во время миграции для каждой облачной службы создается новая группа ресурсов, которая именуется по шаблону `<cloudservicename>-migrated`. Эта группа ресурсов содержит все ваши ресурсы. Имя облачной службы становится DNS-именем, связанным с общедоступным IP-адресом. |
| Виртуальная машина. |Виртуальная машина. |Свойства, относящиеся к виртуальной машине, переносятся без изменений. Определенные данные osProfile, например имя компьютера, не хранятся в классической модели развертывания, и после миграции они остались пустыми. |
| Ресурсы дисков, подключенные к виртуальной машине |Скрытые диски, подключенные к виртуальной машине |Диски не моделируются в виде ресурсов верхнего уровня в модели развертывания с помощью Resource Manager. Они переносятся в качестве скрытых дисков в виртуальной машине. В настоящее время поддерживаются только диски, подключенные к виртуальной машине. Теперь виртуальные машины Resource Manager могут использовать классические учетные записи хранения, что позволяет легко перенести диски без каких-либо изменений. |
| Расширения виртуальных машин |Расширения виртуальных машин |Все расширения ресурсов (кроме расширений XML) переносятся из классической модели развертывания. |
| Сертификаты виртуальных машин |Сертификаты в хранилище ключей Azure |Если облачная служба содержит сертификаты службы, то для каждой облачной службы создается новое хранилище ключей Azure, в которое перемещаются эти сертификаты. В виртуальных машинах будут обновлены ссылки на сертификаты из хранилища ключей. <br><br> **Примечание**. Не удаляйте хранилище ключей, так как это может привести к сбою виртуальной машины. Мы работаем над улучшением серверной части, чтобы хранилища ключей можно было безопасно удалить или переместить вместе с виртуальной машиной в новую подписку. |
| Конфигурация WinRM |Конфигурация WinRM в osProfile |Конфигурация службы удаленного управления Windows в ходе миграции перемещается без изменений. |
| Свойство группы доступности |Ресурс группы доступности | Спецификация группы доступности являлась свойством в виртуальной машине в классической модели развертывания. Группы доступности становятся ресурсами верхнего уровня в ходе миграции. Не поддерживаются следующие конфигурации: несколько групп доступности на одну облачную службу либо одна или несколько групп доступности с виртуальными машинами, которые не находятся в какой-либо группе доступности в облачной службе. |
| Конфигурация сети в виртуальной машине |Основной сетевой интерфейс |Конфигурация сети в виртуальной машине после миграции представлена ресурсом основного сетевого интерфейса. У виртуальных машин, которые не находятся в виртуальной сети, при миграции изменится внутренний IP-адрес. |
| Несколько сетевых интерфейсов в виртуальной машине |Сетевые интерфейсы |Если с виртуальной машиной связано несколько сетевых интерфейсов, то в ходе миграции каждый из них (и все соответствующие свойства) становится ресурсом верхнего уровня в модели развертывания с помощью Resource Manager. |
| Набор конечных точек с балансировкой нагрузки |Подсистема балансировки нагрузки |В классической модели развертывания платформа назначает скрытый балансировщик нагрузки для каждой облачной службы. Во время миграции создается новый ресурс балансировщика нагрузки, а набор конечных точек с балансировкой нагрузки преобразовывается в правила балансировщика нагрузки. |
| Правила преобразования сетевых адресов для входящих подключений |Правила преобразования сетевых адресов для входящих подключений |При миграции входные конечные точки, определенные на виртуальной машине, преобразовываются в правила преобразования сетевых адресов для входящих подключений в балансировщике нагрузки. |
| Виртуальный IP-адрес |Общедоступный IP-адрес с DNS-именем |Виртуальный IP-адрес становится общедоступным IP-адресом, связанным с балансировщиком нагрузки. Виртуальный IP-адрес можно перенести только в том случае, если ему назначена входная конечная точка. |
| Виртуальная сеть |Виртуальная сеть |Виртуальная сеть и все ее свойства переносятся в модель развертывания с помощью Resource Manager. Создается новая группа ресурсов с именем `-migrated`. |
| Зарезервированные IP-адреса |Общедоступный IP-адрес с методом статического выделения |Зарезервированные IP-адреса, связанные с балансировщиком нагрузки, переносятся вместе с облачной службой или виртуальной машиной. Перенос несвязанных зарезервированных IP-адресов в настоящее время не поддерживается. |
| Общедоступный IP-адрес для каждой виртуальной машины |Общедоступный IP-адрес с методом динамического выделения |Общедоступный IP-адрес, связанный с виртуальной машиной, преобразуется в ресурс общедоступного IP-адреса со статическим методом выделения. |
| Группы NSG |Группы NSG |Группы безопасности сети, связанные с подсетью, в ходе миграции клонируются в модель развертывания с помощью Resource Manager. Группа безопасности сети в классической модели развертывания не удаляется в ходе миграции. Однако на период миграции для группы безопасности сети блокируются операции в плоскости управления. |
| "Серверы DNS" |"Серверы DNS" |DNS-серверы, связанные с виртуальной сетью или виртуальной машиной, переносятся в ходе миграции соответствующего ресурса вместе со всеми свойствами. |
| Определяемые пользователем маршруты |Определяемые пользователем маршруты |Определяемые пользователем маршруты, связанные с подсетью, в ходе миграции клонируются в модель развертывания с помощью Resource Manager. Определяемый пользователем маршрут (UDR) в классической модели развертывания не удаляется в ходе миграции. На период миграции для определяемого пользователем маршрута блокируются операции в плоскости управления. |
| Свойство IP-пересылки в конфигурации сети виртуальной машины |Свойство IP-пересылки в сетевой карте |Свойство IP-пересылки в виртуальной машине во время миграции преобразуется в свойство в сетевом интерфейсе. |
| Балансировщик нагрузки с несколькими IP-адресами |Балансировщик нагрузки с несколькими ресурсами IP-адресов |Каждый общедоступный IP-адрес, связанный с балансировщиком нагрузки, после миграции преобразуется в ресурс общедоступного IP-адреса и связывается с балансировщиком нагрузки. |
| Внутренние DNS-имена в виртуальной машине |Внутренние DNS-имена в сетевой карте |Во время миграции внутренние DNS-суффиксы виртуальных машин переносятся в свойство только для чтения InternalDomainNameSuffix в сетевой карте. После миграции суффикс не изменяется, не должно измениться и разрешение виртуальной машины. |
| Шлюз виртуальной сети |Шлюз виртуальной сети |Свойства шлюза виртуальной сети переносятся без изменений. Виртуальный IP-адрес, связанной со шлюзом, также не меняется. |
| Сайт локальной сети |Шлюз локальной сети |Свойства сайта локальной сети переносятся без изменений в новый ресурс, Local Network Gateway. Это касается префиксов локальных адресов и IP-адреса удаленного шлюза. |
| Ссылки на подключения |Подключение |Ссылки на подключения между шлюзом и сайтом локальной сети в конфигурации сети представлены новым ресурсом Connection в Resource Manager после переноса. Все свойства ссылки на подключение в файлах конфигурации сети копируются без изменений новый ресурс Connection. Подключение между виртуальными сетями в классической модели достигается путем создания двух туннелей IPsec для сайтов локальной сети, представляющих виртуальные сети. Это преобразуется в подключение типа Vnet2Vnet в модели Resource Manager, для которого не нужны шлюзы локальной сети. |

## <a name="changes-to-your-automation-and-tooling-after-migration"></a>Изменение возможностей автоматизации и набора инструментов после миграции
При переносе ресурсов из классической модели в модель развертывания с помощью Resource Manager требуется обновить существующую службу автоматизации или набор инструментов, чтобы обеспечить их работу после миграции.
