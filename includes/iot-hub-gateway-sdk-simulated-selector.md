> [AZURE.SELECTOR]
- [Linux](../articles/iot-hub/iot-hub-linux-gateway-sdk-simulated-device.md)
- [Windows](../articles/iot-hub/iot-hub-windows-gateway-sdk-simulated-device.md)

В пошаговом руководстве [Пример отправки в облако виртуальных устройств] показано, как использовать [пакет SDK для шлюза IoT Microsoft Azure][lnk-sdk] для отправки данных телеметрии, передаваемые с устройства в облако, с виртуальных устройств в центр IoT.

В этом руководстве рассматриваются следующие темы.

1. **Архитектура**: важные данные об архитектуре в примере отправки в облако виртуальных устройств.

2. **Сборка и запуск**: шаги, необходимые для сборки и запуска примера.

## Архитектура

Пример отправки в облако виртуальных устройств показывает, как использовать пакет SDK для создания шлюза, который отправляет данные телеметрии из виртуальных устройств в центр IoT. Виртуальные устройства не могут подключаться к центру IoT напрямую, поскольку:

- Устройства не могут использовать протокол связи, понятный для центра IoT.
- Устройства не имеют достаточно возможностей для того, чтобы запомнить удостоверение, присвоенное ему центром IoT.

Шлюз решает эти проблемы виртуальных устройств следующим образом:

- Шлюз понимает протокол, используемый виртуальными устройствами, получает данные телеметрии, передаваемые с устройства в облако, с устройств и пересылает эти сообщения в центр IoT по протоколу, понятному для центра IoT.
- Шлюз хранит удостоверения центра IoT от имени виртуальных устройств и выступает в качестве прокси-сервера, когда виртуальные устройства отправляют сообщения в центр IoT.

На следующем схеме представлены основные компоненты примера, включая модули шлюза:

![][1]


> [AZURE.NOTE] Модули не передают сообщения друг другу напрямую. Модули публикуют сообщения во внутреннюю шину передачи сообщений, которая передает их в другие модули с помощью механизма подписки, как показано на представленной ниже схеме. Дополнительные сведения см. в статье [Приступая к работе с пакетом SDK для шлюза][lnk-gw-getstarted].

### Модуль получения протокола

Этот модуль является отправной точкой для получения данных с устройств через шлюз и их передачи в облако. В этом примере модуль выполняет четыре задачи:

1.  Моделирует данные температуры.
    
    Примечание. При использовании реальных устройств модуль считывает данные с физических устройств.

2.  Помещает смоделированные данные температуры в содержимое сообщения.

3.  Добавляет свойство с фиктивным MAC-адресом в сообщение, содержащее смоделированные данные температуры.

4.  Делает сообщение доступными для следующего модуля в цепочке.

> [AZURE.NOTE] Модуль с именем **получение протокола X** в представленной выше схеме называется **виртуальным устройством** в исходном коде.

### MAC & lt;-& gt; Модуль идентификатора центра IoT

Этот модуль проверяет сообщения, включающие свойство, которое содержит MAC-адрес виртуального устройства, добавленный модулем получения протокола. Если модуль обнаруживает такое свойство, он добавляет в сообщение другое свойство с ключом устройства в центре IoT и делает его доступным для следующего модуля в цепочке. Таким образом пример связывает удостоверения устройства в центре IoT с виртуальными устройствами. Разработчик вручную настраивает сопоставление между MAC-адресами и удостоверениями устройства в центре IoT в процессе настройки модуля.

> [AZURE.NOTE]  В этом примере MAC-адрес используется как уникальный идентификатор устройства и сопоставляет его с удостоверением устройства в центре IoT. В то же время вы можете написать собственный модуль, где будет использоваться другой уникальный идентификатор. Например, у вас есть устройства с уникальными серийными номерами или данные телеметрии с заложенным в них уникальным именем устройства, которое можно использовать для определения удостоверения устройства в центре IoT.

### Модуль связи центра IoT

Этот модуль получает сообщения с удостоверением устройства в центре IoT, присвоенным ему предыдущим модулем, и отправляет содержимое сообщений в центр IoT по HTTPS. HTTPS — один из трех протоколов, понятных для центра IoT.

Вместо того, чтобы открывать подключение к центру IoT для каждого виртуального устройства, этот модуль отрывает одно HTTP-подключение между шлюзом и центром IoT и использует его для установки мультиплексных подключений со всех виртуальных устройств. Таким образом, один шлюз может подключиться к большему числу устройств (виртуальных или иных), чем в случае, если бы он создавал уникальное подключение для каждого устройства.

![][2]


<!-- Images -->
[1]: media/iot-hub-gateway-sdk-simulated-selector/image1.png
[2]: media/iot-hub-gateway-sdk-simulated-selector/image2.png

<!-- Links -->
[Пример отправки в облако виртуальных устройств]: https://github.com/Azure/azure-iot-gateway-sdk/blob/master/doc/sample_simulated_device_cloud_upload.md
[lnk-sdk]: https://github.com/Azure/azure-iot-gateway-sdk
[lnk-gw-getstarted]: ../articles/iot-hub/iot-hub-linux-gateway-sdk-get-started.md

