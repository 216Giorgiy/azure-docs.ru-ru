## Получение сообщений на виртуальном устройстве
В этом разделе вы измените приложение виртуального устройства, созданное в разделе [Приступая к работе с центром IoT], для получения сообщений "из облака в устройство" от центра IoT.

1. В Visual Studio в проекте **SimulatedDevice** добавьте в класс **Program** следующий метод:
   
        private static async void ReceiveC2dAsync()
        {
            Console.WriteLine("\nReceiving cloud to device messages from service");
            while (true)
            {
                Message receivedMessage = await deviceClient.ReceiveAsync();
                if (receivedMessage == null) continue;
   
                Console.ForegroundColor = ConsoleColor.Yellow;
                Console.WriteLine("Received message: {0}", Encoding.ASCII.GetString(receivedMessage.GetBytes()));
                Console.ResetColor();
   
                await deviceClient.CompleteAsync(receivedMessage);
            }
        }
   
    Метод `ReceiveAsync` асинхронно возвращает полученное сообщение, когда устройство его получило. Он возвращает значение *NULL* после истечения заданного времени ожидания (в данном случае используется значение по умолчанию, равное 1 минуте). В этом случае необходимо, чтобы код продолжил ожидать новые сообщения. По этой причине присутствует строка `if (receivedMessage == null) continue`.
   
    Вызов `CompleteAsync()` уведомляет центр IoT об успешной обработке сообщения. Можно спокойно удалить сообщение из очереди устройства. Если что-то помешает приложению устройства завершить обработку сообщения, центр IoT доставит его снова. Поэтому важно, чтобы логика обработки сообщений в приложении устройства была *идемпотентной*, чтобы многократное получение одного и того же сообщения давало одинаковый результат. Приложение может также временно отказаться от сообщения. Тогда центр IoT будет хранить сообщение в очереди для последующей обработки. Или приложение может отклонить сообщение, и тогда оно будет окончательно удалено из очереди. Дополнительную информацию о жизненном цикле сообщений, передаваемых из облака на устройство, можно найти в [руководстве разработчика для центра IoT][IoT Hub Developer Guide - C2D].

> [!NOTE]
> При использовании HTTP/1 вместо AMQP в качестве транспорта немедленно возвращается метод `ReceiveAsync`. Схема сообщений, передаваемых из облака на устройство с помощью HTTP/1, может использоваться для периодически подключаемых устройствах, которые редко проверяют наличие новых сообщений (реже, чем раз в 25 минут). Передача большего количества получений HTTP/1 приводит к регулированию запросов в центре IoT. Дополнительную информацию о различиях между поддержкой AMQP и HTTP/1, а также регулировании центра IoT можно получить в [руководстве разработчика для центра IoT][IoT Hub Developer Guide - C2D].
> 
> 

1. Добавьте в метод **Main** непосредственно перед строкой `Console.ReadLine()` следующий метод.
   
        ReceiveC2dAsync();

> [!NOTE]
> Для упрощения в этом учебнике не реализуются какие-либо политики повтора. В рабочем коде следует реализовать политики повтора (например, экспоненциальную задержку), как указано в статье MSDN [Обработка временного сбоя].
> 
> 

<!-- Links -->
[IoT Hub Developer Guide - C2D]: ../articles/iot-hub/iot-hub-devguide.md#c2d

<!-- Images -->

<!---HONumber=AcomDC_0608_2016-->