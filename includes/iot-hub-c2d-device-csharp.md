## Получение сообщений на виртуальном устройстве

В этом разделе вы измените приложение виртуального устройства, созданное в разделе \[Приступая к работе с центром IoT\], для получения сообщений "из облака в устройство" от центра IoT.

1. В Visual Studio в проекте **SimulatedDevice** добавьте в класс **Program** следующий метод:

        private static async void ReceiveC2dAsync()
        {
            Console.WriteLine("\nReceiving cloud to device messages from service");
            while (true)
            {
                Message receivedMessage = await deviceClient.ReceiveAsync();
                if (receivedMessage == null) continue;

                Console.ForegroundColor = ConsoleColor.Yellow;
                Console.WriteLine("Received message: {0}", Encoding.ASCII.GetString(receivedMessage.GetBytes()));
                Console.ResetColor();

                await deviceClient.CompleteAsync(receivedMessage);
            }
        }

    Метод `ReceiveAsync` асинхронно возвращает полученное сообщение, когда устройство его получило. Он возвращает значение *null* после истечения заданного времени ожидания \(в данном случае используется значение по умолчанию, равное 1 минуте\). В этом случае нам необходимо, чтобы код продолжил ожидать новые сообщения. По этой причине присутствует строка `if (receivedMessage == null) continue`.

    Вызов `CompleteAsync()` уведомляет центр IoT о том, что сообщение успешно обработано и может быть безопасно удалено из очереди устройства. При возникновении события, которое не позволяет приложению устройства завершить обработку сообщения, центр IoT доставит его снова. Важно, чтобы логика обработки сообщений в приложении устройства была *идемпотентной*, т. е. многократное получение одного и того же сообщения должно приводить к одинаковому результату. Приложение также может временно отказаться \(`Abandon`\) от сообщения, из-за чего центр IoT сохранит его в очереди для последующей обработки, либо отклонить \(`Reject`\) сообщение, что приведет к окончательному удалению этого сообщения из очереди. Более подробную информацию о жизненном цикле сообщений "из облака в устройство" можно найти в [Руководстве разработчика по центру IoT][IoT Hub Developer Guide - C2D].

> [AZURE.NOTE] При использовании HTTP/1 вместо AMQP в качестве транспорта, немедленно возвращается `ReceiveAsync`. Поддерживаемый шаблон для сообщения "из облака в устройство" с HTTP/1 является периодически подключаемым устройством, которое редко проверяет сообщения \(т. е. реже, чем раз в 25 минут\). Передача большего количества получений HTTP/1 приведет к регулированию запросов в центре IoT. Более подробную информацию о различиях между поддержкой AMQP и HTTP/1, а также регулировании центра IoT можно узнать в [Руководстве разработчика по центру IoT][IoT Hub Developer Guide - C2D].

2. Добавьте в метод **Main** прямо перед строкой `Console.ReadLine()` следующий метод:

        ReceiveC2dAsync();

> [AZURE.NOTE] Для упрощения в этом учебнике не реализуются какие-либо политики повтора. В рабочем коде рекомендуется реализовать политики повтора \(например, экспоненциальную задержку\), как это указано в статье MSDN \[Обработка временного сбоя\].

<!-- Links -->
[IoT Hub Developer Guide - C2D]: ../articles/iot-hub/iot-hub-devguide.md#c2d

<!-- Images -->

<!---HONumber=AcomDC_0413_2016-->