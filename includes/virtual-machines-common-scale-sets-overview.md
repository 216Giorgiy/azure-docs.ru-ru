

Для приложений, которые нуждаются в масштабировании вычислительных ресурсов, операции масштабирования неявно распределяются между доменами сбоя и доменами обновления. Общие сведения о масштабируемых наборах ВМ см. в этой [публикации блога Azure](https://azure.microsoft.com/blog/azure-vm-scale-sets-public-preview/).

Чтобы получить дополнительные сведения о масштабируемых наборах VM, просмотрите эти видео:

* [Марк Руссинович (Mark Russinovich) рассказывает о масштабируемых наборах Azure.](https://channel9.msdn.com/Blogs/Regular-IT-Guy/Mark-Russinovich-Talks-Azure-Scale-Sets/)  
* [Масштабируемые наборы виртуальных машин с Гаем Бауэрманом (Guy Bowerman).](https://channel9.msdn.com/Shows/Cloud+Cover/Episode-191-Virtual-Machine-Scale-Sets-with-Guy-Bowerman)

## <a name="creating-and-managing-vm-scale-sets"></a>Создание масштабируемых наборов виртуальных машин и управление ими
Масштабируемые наборы ВМ можно определять и развертывать с помощью шаблонов JSON и интерфейсов [REST API](https://msdn.microsoft.com/library/mt589023.aspx) так же, как и отдельные виртуальные машины Azure Resource Manager. Поэтому можно использовать любые стандартные методы развертывания диспетчера ресурсов Azure. Дополнительную информацию о шаблонах см. в статье [Создание шаблонов диспетчера ресурсов Azure](../articles/resource-group-authoring-templates.md).

Набор примеров шаблонов для наборов масштабирования виртуальных машин можно найти в разделе шаблонов быстрого запуска Azure в репозитории GitHub здесь:

[https://github.com/Azure/azure-quickstart-templates](https://github.com/Azure/azure-quickstart-templates) (ищите шаблоны с элементом *vmss* в названии).

На страницах сведений этих шаблонов есть кнопка, связанная с функцией развертывания на портале. Чтобы развернуть масштабируемый набор виртуальных машин, нажмите кнопку, а затем укажите на портале все необходимые параметры. Если вы не уверены, поддерживает ли ресурс верхний или смешанный регистр, для надежности всегда вводите значения параметров в нижнем регистре. Вот полезный видеоролик с анализом шаблона масштабируемого набора виртуальных машин:

[Анализ шаблона масштабируемого набора виртуальных машин](https://channel9.msdn.com/Blogs/Windows-Azure/VM-Scale-Set-Template-Dissection/player)

## <a name="scaling-a-vm-scale-set-out-and-in"></a>Уменьшение или увеличение масштаба набора VM
Чтобы увеличить или уменьшить число виртуальных машин в масштабируемом наборе, достаточно изменить свойство *capacity* и повторно развернуть шаблон. Это упрощает создание собственного пользовательского уровня масштабирования, если требуется задать события пользовательского масштабирования, которые не поддерживаются автомасштабированием Azure.

При повторном развертывании шаблона для изменения емкости можно задать гораздо меньший шаблон, который будет включать только номер SKU и обновленную емкость. Пример приведен здесь: [https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-vmss-scale-in-or-out/azuredeploy.json](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-vmss-linux-nat/azuredeploy.json).

Пошаговое руководство по созданию автомасштабируемого набора см. в статье [Автоматическое масштабирование ВМ в наборе масштабирования ВМ](../articles/virtual-machines/virtual-machines-windows-vmss-powershell-creating.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

## <a name="monitoring-your-vm-scale-set"></a>Мониторинг масштабируемого набора VM
Для просмотра масштабируемых наборов ВМ рекомендуется использовать [обозреватель ресурсов Azure](https://resources.azure.com). Масштабируемые наборы VM принадлежат к ресурсам Microsoft.Compute. Чтобы просмотреть их на этом сайте, перейдите по следующим ссылкам:

    subscriptions -> your subscription -> resourceGroups -> providers -> Microsoft.Compute -> virtualMachineScaleSets -> your VM scale set -> etc.

## <a name="vm-scale-set-scenarios"></a>Сценарии масштабируемого набора VM
В этом разделе перечислены стандартные сценарии с участием масштабируемых наборов VM. Эти сценарии используются в некоторых службах Azure более высокого уровня (таких как пакетная служба, Service Fabric, служба контейнеров Azure Container Service).

* **Подключение по RDP или SSH к экземплярам масштабируемых наборов ВМ**. Масштабируемый набор ВМ создается внутри виртуальной сети, при этом отдельным виртуальным машинам не выделяются общедоступные IP-адреса. Это хорошее решение, так как оно избавляет вас от дополнительных затрат и расходов на управление, связанных с выделением отдельных IP-адресов для всех ресурсов без состояния в сетке вычислений. К этим ВМ можно легко подключиться с других ресурсов в виртуальной сети, в том числе с ресурсов с общедоступными IP-адресами, например с балансировщиков нагрузки или отдельных виртуальных машин.
* **Подключение к ВМ с помощью правил преобразования сетевых адресов (NAT).** Вы можете создать общедоступный IP-адрес, назначить его балансировщику нагрузки и определить правила для входящих подключений NAT, которые сопоставляют порт на IP-адресе с портом виртуальной машины из масштабируемого набора ВМ. Например: 
  
   Общедоступный IP-адрес -> Порт 50000 -> vmss\_0 -> Порт 22  Общедоступный IP-адрес -> Порт 50001 -> vmss\_1 -> Порт 22  Общедоступный IP-адрес -> Порт 50002 -> vmss\_2-> Порт 22
  
   В следующем примере показано создание масштабируемого набора VM, который использует правила NAT для SSH-подключения к каждой виртуальной машине из набора с помощью одного общедоступного IP-адреса: [https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-nat](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-nat)
  
   Вот пример организации такой же схемы для RDP и Windows: [https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-nat](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-nat)
* **Подключение к ВМ с помощью основной виртуальной машины.** Если в одной виртуальной сети создается масштабируемый набор ВМ и автономная виртуальная машина, эта машина и машины из набора могут подключаться друг к другу с помощью внутренних IP-адресов в соответствии с определением виртуальной сети или подсети. Если создать общедоступный IP-адрес и назначить его автономной виртуальной машине, к ней можно будет подключиться по RDP или SSH, а затем через нее подключиться к экземплярам масштабируемого набора VM. На этом этапе можно заметить, что простой масштабируемый набор ВМ надежнее, чем автономная ВМ с общедоступным IP-адресом, сконфигурированная по умолчанию.
  
   В качестве примера этот шаблон создает простой кластер Mesos с автономной главной VM, которая управляет кластером виртуальных машин на основе масштабируемого набора VM: [https://github.com/gbowerman/azure-myriad/blob/master/mesos-vmss-simple-cluster.json](https://github.com/gbowerman/azure-myriad/blob/master/mesos-vmss-simple-cluster.json)
* **Балансировка нагрузки методом циклического перебора для экземпляров масштабируемого набора ВМ**. Чтобы передавать работу в вычислительный кластер виртуальных машин с использованием циклического перебора, следует настроить балансировщик Azure Load Balancer с соответствующими правилами балансировки. Также можно настроить тестеры для проверки работы приложения с помощью проверки связи с портами с указанными протоколом, интервалом и путем запроса.
  
   В следующем примере создается масштабируемый набор ВМ с машинами, на которых запущен веб-сервер IIS и используется балансировщик нагрузки для балансировки нагрузки, получаемой каждой ВМ. В примере также используется протокол HTTP для проверки связи с определенным URL-адресом на каждой ВМ: [https://github.com/gbowerman/azure-myriad/blob/master/vmss-win-iis-vnet-storage-lb.json](https://github.com/gbowerman/azure-myriad/blob/master/vmss-win-iis-vnet-storage-lb.json). Обратите внимание на тип ресурса Microsoft.Network/loadBalancers, а также атрибуты networkProfile и extensionProfile ресурса virtualMachineScaleSet.
* **Развертывание масштабируемого набора ВМ в качестве вычислительного кластера в диспетчере кластеров PaaS.** Иногда масштабируемые наборы ВМ называют рабочими ролями следующего поколения. Это вполне допустимое название, но вместе с тем существует риск перепутать функции масштабируемого набора ВМ с функциями рабочей роли PaaS v1. В этом смысле масштабируемые наборы ВМ предоставляют настоящую «рабочую роль» или рабочий ресурс. Они являются обобщенным вычислительным ресурсом, независимым от платформ и сред выполнения, который может настраиваться и интегрироваться с диспетчером ресурсов Azure IaaS.
  
   Рабочая роль PaaS v1, ограниченная с точки зрения поддержки платформ и сред выполнения (только для образов платформы Windows), также включает такие службы: переключение виртуального IP-адреса, настраиваемые параметры обновления, определенные параметры развертывания приложения или среды выполнения. Они либо *еще* недоступны в масштабируемых наборах ВМ, либо будут предоставляться другими службами PaaS более высокого уровня, например Service Fabric. Учитывая эти факторы, масштабируемые наборы ВМ можно рассматривать как инфраструктуру, поддерживающую PaaS. Например, такие решения PaaS, как Service Fabric, или диспетчеры кластера, как Mesos, можно построить на основе масштабируемых наборов ВМ в качестве масштабируемого уровня вычислений.
  
   В следующем примере кластер Mesos развертывает масштабируемый набор ВМ в одну виртуальную сеть с автономной ВМ. Главной автономной виртуальной машиной является кластер Mesos, а масштабируемый набор VM представляет набор подчиненных узлов: [https://github.com/gbowerman/azure-myriad/blob/master/mesos-vmss-simple-cluster.json](https://github.com/gbowerman/azure-myriad/blob/master/mesos-vmss-simple-cluster.json). Будущие версии [службы контейнеров Azure](https://azure.microsoft.com/blog/azure-container-service-now-and-the-future/) будут развертывать более сложные или фиксированные версии этого сценария на основе масштабируемых наборов ВM.

## <a name="vm-scale-set-performance-and-scale-guidance"></a>Рекомендации по производительности и масштабированию набора VM
* В общедоступной предварительной версии не создавайте более 500 виртуальных машин в нескольких масштабируемых наборах ВМ одновременно.
* Планируйте не более 40 виртуальных машин на учетную запись хранения.
* Максимально распределяйте первые буквы имен учетных записей хранения.  Примеры шаблонов масштабируемых наборов VM в разделе [Шаблоны быстрого запуска Azure](https://github.com/Azure/azure-quickstart-templates/) демонстрируют, как это сделать.
* При использовании пользовательских виртуальных машин планируйте не более 40 ВМ в наборе ВМ для одной учетной записи хранения.  Прежде чем начинать развертывание масштабируемого набора ВМ, необходимо предварительно скопировать образ в учетную запись хранения. Дополнительные сведения см. в разделе часто задаваемых вопросов.
* Планируйте не более 2048 виртуальных машин в одной виртуальной сети.  В будущем это количество будет увеличено.
* Допустимое число виртуальных машин, которые можно создать, ограничивается вашей квотой для вычислительных ядер в регионе. Возможно, придется обратиться в службу поддержки, чтобы увеличить квоту вычислений, даже если сейчас у вас установлен высокий предел ядер для использования с облачными службами или IaaS v1. Запрос на квоту можно отправить с помощью команды Azure CLI *azure vm list-usage* и команды PowerShell *Get-AzureRmVMUsage* (если используется версия PowerShell ниже 1.0, используйте командлет *Get-AzureVMUsage*).

## <a name="vm-scale-set-frequently-asked-questions"></a>Масштабируемый набор VM — часто задаваемые вопросы
**Вопрос.** Сколько виртуальных машин может входить в масштабируемый набор VM?

**Ответ.** 100, если использовать образы платформы, которые можно распределить между несколькими учетными записями хранения. При использовании пользовательских образов — до 40, так как в предварительной версии они ограничены одной учетной записью хранения.

**Вопрос.** Какие еще ограничения ресурсов существуют для масштабируемых наборов VM?

**Ответ.** В предварительной версии можно создать не более 500 виртуальных машин в нескольких масштабируемых наборах VM в одном регионе. Применяются существующие [ограничения службы подписки Azure](../articles/azure-subscription-service-limits.md) .

**Вопрос.** Поддерживаются ли диски данных в масштабируемых наборах VM?

**Ответ.** В первом выпуске — нет. Ниже перечислены варианты хранения данных.

* Файлы Azure (общие диски SMB).
* Диск операционной системы.
* Временный диск (локальный, не поддерживаемый хранилищем Azure).
* Служба внешних данных (например удаленная база данных, таблицы Azure, BLOB-объекты Azure).

**Вопрос.** Какие регионы Azure поддерживают масштабируемые наборы VM?

**Ответ.** Любой регион, поддерживающий диспетчер ресурсов Azure, поддерживает масштабируемые наборы ВМ.

**Вопрос.** Как создать масштабируемый набор VM с помощью пользовательского образа?

**Ответ.** Оставьте значение свойства vhdContainers пустым:

    "storageProfile": {
        "osDisk": {
            "name": "vmssosdisk",
            "caching": "ReadOnly",
            "createOption": "FromImage",
            "image": {
                "uri": [https://mycustomimage.blob.core.windows.net/system/Microsoft.Compute/Images/mytemplates/template-osDisk.vhd](https://mycustomimage.blob.core.windows.net/system/Microsoft.Compute/Images/mytemplates/template-osDisk.vhd)
            },
            "osType": "Windows"
        }
    },


**Вопрос.** Если уменьшить емкость масштабируемого набора VM с 20 до 15, какие виртуальные машины будут удалены?

**Ответ.** Для максимальной доступности виртуальные машины удаляются из масштабируемого набора в доменах обновления и доменах сбоя равномерно.

**Вопрос.** Что будет, если затем увеличить емкость с 15 до 18?

**Ответ.** После увеличения емкости до 18 будут созданы виртуальные машины с индексами 15, 16 и 17. В обоих случаях виртуальные машины распределяются между доменами сбоя и обновления.

**Вопрос.** Можно ли указать последовательность выполнения при использовании нескольких расширений в масштабируемом наборе VM?

**Ответ.** Напрямую это сделать нельзя, но для расширения customScript скрипт может ожидать завершения другого расширения (например, отслеживая журнал расширений — см. шаблон [https://github.com/Azure/azure-quickstart-templates/blob/master/201-vmss-lapstack-autoscale/install\_lap.sh](https://github.com/Azure/azure-quickstart-templates/blob/master/201-vmss-lapstack-autoscale/install_lap.sh)).

**Вопрос.** Работают ли масштабируемые наборы VM с группами доступности Azure?

**Ответ.** Да. Масштабируемый набор VM является неявной группой доступности с тремя доменами сбоя и пятью доменами обновления. Ничего настраивать в virtualMachineProfile не нужно. В будущих выпусках масштабируемые наборы VM, скорее всего, будут охватывать несколько клиентов, но пока масштабируемый набор представляет собой одну группу доступности.



<!--HONumber=Jan17_HO3-->


