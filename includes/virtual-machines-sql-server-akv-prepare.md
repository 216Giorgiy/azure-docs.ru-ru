## <a name="prepare-for-akv-integration"></a>Подготовка к интеграции AKV
Чтобы использовать интеграцию хранилища ключей Azure для настройки виртуальной машины с SQL Server, необходимо выполнить несколько предварительных условий: 

1. [Установите Azure PowerShell](#install-azure-powershell)
2. [Создайте Azure Active Directory](#create-an-azure-active-directory)
3. [Создайте хранилище ключей.](#create-a-key-vault)

В следующих разделах описаны эти предварительные условия и представлены сведения, необходимые для использования командлетов PowerShell в дальнейшем.

### <a name="install-azure-powershell"></a>Установите Azure PowerShell
Убедитесь, что установлен последний пакет SDK Azure PowerShell. Подробнее: [Установка и настройка Azure PowerShell](/powershell/azureps-cmdlets-docs).

### <a name="register-an-application-in-your-azure-active-directory"></a>Регистрация приложения в вашем экземпляре Azure Active Directory
Во-первых, в вашей подписке должна быть служба [Azure Active Directory](https://azure.microsoft.com/trial/get-started-active-directory/) (AAD). Среди прочих преимуществ она дает возможность предоставить доступ к вашему хранилищу ключей для определенных пользователей и приложений.

Далее необходимо зарегистрировать приложение в AAD. Это позволит получить учетную запись субъекта-службы, имеющую доступ к вашему хранилищу ключей, которое потребуется виртуальной машине. Вы найдете эти действия в статье о хранилище ключей Azure в разделе [Регистрация приложения в Azure Active Directory](../articles/key-vault/key-vault-get-started.md#register), или вы можете просмотреть действия на снимках экранов в разделе **Получение удостоверения для приложения** [этой записи блога](http://blogs.technet.com/b/kv/archive/2015/01/09/azure-key-vault-step-by-step.aspx). Перед выполнением этих шагов обратите внимание, что во время этой регистрации необходимо собрать следующие сведения, которые понадобятся в дальнейшем при включении интеграции хранилища ключей Azure на виртуальной машине с SQL.

* После добавления приложения найдите **идентификатор приложения** в колонке **Зарегистрированное приложение**.   
    Идентификатор приложения позже назначается параметру **$spName** (имя субъекта-службы) в сценарии PowerShell, чтобы обеспечить интеграцию Azure Key Vault. 
* Во время выполнения этой процедуры при создании ключа скопируйте секрет ключа, как показано на приведенном ниже снимке экрана. Этот секрет ключа позже назначается параметру **$spSecret** (секрет субъекта-службы) в сценарии PowerShell.  

* Идентификатор и секрет приложения также будут использоваться для создания учетных данных в SQL Server. 

* Необходимо авторизовать этот новый идентификатор клиента, предоставив следующие разрешения на доступ: **encrypt**, **decrypt**, **wrapKey**, **unwrapKey**, **sign** и **verify**. Это делается с помощью командлета [Set-AzureRmKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/mt603625.aspx). Дополнительные сведения см. в статье [Авторизация приложения на использование ключа или секрета](../articles/key-vault/key-vault-get-started.md#authorize).

### <a name="create-a-key-vault"></a>Создайте хранилище ключей.
Чтобы использовать хранилище ключей Azure для хранения ключей, которые будут использоваться для шифрования на виртуальной машине, необходим доступ к хранилищу ключей. Если вы еще не настроили ваше хранилище ключей, создайте его, выполнив следующие действия, описанные в разделе [Приступая к работе с хранилищем ключей Azure](../articles/key-vault/key-vault-get-started.md) . Перед выполнением этих шагов обратите внимание, что во время этой настройки необходимо собрать некоторые сведения, которые понадобятся в дальнейшем при включении интеграции хранилища ключей Azure на виртуальной машине с SQL.

    New-AzureRmKeyVault -VaultName 'ContosoKeyVault' -ResourceGroupName 'ContosoResourceGroup' -Location 'East Asia'

При создании хранилища ключей запишите возвращенное свойство **vaultUri** , которое является URL-адресом хранилища ключей. В примере, приведенном на этом шаге и показанном ниже, именем хранилища ключей является ContosoKeyVault, поэтому URL-адрес хранилища ключей — https://contosokeyvault.vault.azure.net/.

URL-адрес хранилища ключей позже назначается параметру **$akvURL** в сценарии PowerShell для включения интеграции хранилища ключей Azure.

После создания хранилища ключей нужно добавить в него ключ. На этот ключ в дальнейшем будет добавлена ссылка при создании асимметричного ключа SQL Server.
