
В этой статье показана настройка протокола HTTPS для веб-приложения в службе приложений Azure. В ней не рассматриваются вопросы аутентификации сертификата клиента. Сведения об этом можно найти в статье [Настройка взаимной аутентификации TLS для веб-приложений](../articles/app-service-web/app-service-web-configure-tls-mutual-auth.md).

По умолчанию Azure уже включает HTTPS для вашего приложения с помощью шаблонного сертификата для домена *.azurewebsites.net. Если вы не планируете настраивать пользовательский домен, можно воспользоваться сертификатом HTTPS по умолчанию. Однако, как и [все домены с подстановочными знаками](https://casecurity.org/2014/02/26/pros-and-cons-of-single-domain-multi-domain-and-wildcard-certificates/), он не так безопасен, как личный домен с собственным сертификатом.

Далее в статье содержатся подробные сведения о том, как включить протокол HTTPS для личных доменов, например **contoso.com**, **www.contoso.com** или **\\*.contoso.com**.

<a name="bkmk_domainname"></a>
## Включение SSL для личного домена

Чтобы включить протокол HTTPS для личного домена, например **contoso.com**, необходимо сначала [настроить пользовательское имя домена в службе приложений Azure](../articles/app-service-web/web-sites-custom-domain-name.md). После этого выполните описанные ниже действия.

1. [получение SSL-сертификата](#bkmk_getcert)
2. [Настройка ценовой категории "Стандартная" или "Премиум"](#bkmk_standardmode)
2. [Настройка SSL в приложении](#bkmk_configuressl)
3. [Включение SSL в приложении](#bkmk_enforce) (необязательно)

Если в любой момент при изучении этой статьи вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](https://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт службы поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Поддержка**.

<a name="bkmk_getcert"></a>
## 1\. получение SSL-сертификата

Перед запросом SSL-сертификата необходимо сначала определить, какие доменные имена будут защищены с помощью этого сертификата. От этого зависит требуемый тип сертификата. Если вам необходимо защитить одно доменное имя, например **contoso.com** или **www.contoso.com**, вам будет достаточно базового сертификата. Если необходимо защитить несколько доменных имен, таких как **contoso.com**, **www.contoso.com** и **mail.contoso.com**, то можно использовать [групповой сертификат](http://en.wikipedia.org/wiki/Wildcard_certificate) или сертификат с [альтернативным именем субъекта](http://en.wikipedia.org/wiki/SubjectAltName) (subjectAltName).

SSL-сертификаты для веб-приложений должны быть подписаны [центром сертификации](http://en.wikipedia.org/wiki/Certificate_authority) (ЦС). Если у вас еще нет сертификата, нужно получить его в компании, выпускающей SSL-сертификаты. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][cas] на портале Microsoft TechNet Wiki.

Сертификат должен отвечать следующим требованиям для SSL-сертификатов в Azure:

* Сертификат должен содержать закрытый ключ.
* Сертификат должен быть создан для обмена ключами, которые можно экспортировать в файл обмена личной информацией (PFX-файл).
* Имя субъекта сертификата должно совпадать с доменным именем, которое используется для обращения к приложению. Если сертификат должен обслуживать несколько доменов, необходимо использовать подстановочные значения или указать значения альтернативного имени субъекта (subjectAltName), как обсуждалось ранее.
* Сертификат должен использовать как минимум 2048-разрядное шифрование.
* Служба приложений Azure не поддерживает сертификаты, выданные серверами частных центров сертификации.

Чтобы получить SSL-сертификат для использования со службой приложений Azure, нужно отправить в центр сертификации запрос подписи сертификата (CSR), а затем создать из полученного сертификата PFX-файл. Для этого можно воспользоваться любым инструментом по своему выбору. Ниже приведены самые распространенные способы получения сертификата.

- [Получение сертификата с помощью Certreq.exe](#bkmk_certreq)
- [Получение сертификата с помощью диспетчера IIS](#bkmk_iismgr)
- [Получение сертификата с помощью OpenSSL](#bkmk_openssl)
- [Получение сертификата SubjectAltName с помощью OpenSSL](#bkmk_subjectaltname)
- [Создание самозаверяющих сертификатов (только для тестирования)](#bkmk_selfsigned)

> [AZURE.NOTE] Во время выполнения этих действий вам предложат ввести значение параметра **Общее имя**, например `www.contoso.com`. Для групповых сертификатов это значение должно быть \\*.domainname (например, \\*.contoso.com). Если вам необходима поддержка как групповых имен, например \\*.contoso.com, так и имени корневого домена, такого как contoso.com, можно использовать групповой сертификат с альтернативным именем субъекта (subjectAltName).
>
> Сертификаты на основе шифрования эллиптических кривых (ECC) поддерживаются службой приложений Azure, однако они относительно новые и нужно работать с центром сертификации по конкретным действиям для создания CSR.

Возможно, вам также понадобятся **[промежуточные сертификаты](http://en.wikipedia.org/wiki/Intermediate_certificate_authorities)** (также известные как сертификаты цепочки), если ваш центр сертификации использует их. Использование промежуточных сертификатов считается более безопасным, чем применение "сертификатов без цепочки", поэтому ЦС в большинстве случаев используют такие сертификаты. Промежуточные сертификаты зачастую нужно отдельно загружать с веб-сайта ЦС. Действия, приведенные в данном разделе, описывают процедуру объединения всех промежуточных сертификатов с сертификатом, отправленным в приложения.

<a name="bkmk_certreq"></a>
### Получение сертификата с помощью Certreq.exe (только для Windows)

CertReq.exe является служебной программой Windows для создания запросов сертификатов. Она входит в базовый установочный пакет Windows, начиная с Windows XP и Windows Server 2000, поэтому данная программа будет доступной на всех недавних версиях Windows. Далее описаны шаги для получения SSL-сертификата с помощью certreq.exe.

1. Откройте **Блокнот** и создайте новый документ со следующим содержимым. Замените **mysite.com** в строке темы на личное доменное имя вашего приложения. Например, Subject = "CN=www.contoso.com".

		[NewRequest]
		Subject = "CN=mysite.com"
		Exportable = TRUE
		KeyLength = 2048
		KeySpec = 1
		KeyUsage = 0xA0
		MachineKeySet = True
		ProviderName = "Microsoft RSA SChannel Cryptographic Provider"
		ProviderType = 12

		[EnhancedKeyUsageExtension]
		OID=1.3.6.1.5.5.7.3.1

	Для получения дополнительных сведений об указанных выше вариантах, а также о других доступных вариантах ознакомьтесь со [справочной документацией Certreq](http://technet.microsoft.com/library/cc725793.aspx).

2. Сохраните текстовый файл под именем **myrequest.txt**.

3. На **экране "Пуск"** или в **меню "Пуск"** запустите файл **cmd.exe**.

4. В командной строке для создания файла запроса сертификата используйте следующую команду:

		certreq -new \path\to\myrequest.txt \path\to\create\myrequest.csr

	Укажите путь к файлу **myrequest.txt**, созданному при выполнении шага 1, и путь, используемый при создании файла **myrequest.csr**.

5. Отправьте файл **myrequest.csr** в центр сертификации, чтобы получить SSL-сертификат. Для этого может потребоваться загрузка файла или открытие файла в Блокноте и вставка содержимого непосредственно в веб-форму.

	Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][cas] на портале Microsoft TechNet Wiki.

6. После того как центр сертификации предоставит вам файл сертификата (.CER), сохраните этот файл на компьютер, используемый для создания запроса, и выполните следующую команду, чтобы принять запрос и завершить процесс создания сертификата.

		certreq -accept -user mycert.cer

	В этом случае файл **mycert.cer**, полученный от центра сертификации, будет использоваться для подписывания сертификата. Файл создан не будет; вместо этого сертификат будет сохранен в хранилище сертификатов Windows.

6. Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в последующих шагах. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предназначена для служб Microsoft IIS.

	После загрузки сертификата щелкните на нем правой кнопкой мыши в обозревателе и выберите **Установить сертификат**. Используйте значения по умолчанию в **Мастере импорта сертификатов** и выбирайте **Далее** до завершения импорта.

7. Чтобы экспортировать сертификат из хранилища сертификатов, запустите **certmgr.msc** на **рабочем столе** или в **меню Пуск**. При появлении **диспетчера сертификатов** разверните **личную** папку, а затем выберите **Сертификаты**. В поле **Кому выдан** найдите запись с именем пользовательского домена, для которого запрашивался сертификат. В поле **Кем выдан** указывается центр сертификации, выдавший этот сертификат.

	![вставить изображение диспетчера сертификатов][certmgr]

9. Щелкните сертификат правой кнопкой мыши и выберите **Все задачи**, а затем выберите **Экспорт**. В **мастере экспорта сертификатов** нажмите **Далее**, а затем выберите **Да, экспортировать закрытый ключ**. Нажмите кнопку **Далее**.

	![Экспорт закрытого ключа][certwiz1]

10. Выберите **Обмен личной информацией — PKCS #12**, **Включить все сертификаты в цепочке сертификатов** и **Экспортировать все расширенные свойства**. Нажмите кнопку **Далее**.

	![включить все сертификаты и расширенные свойства][certwiz2]

11. Выберите **Пароль**, а затем введите пароль и подтвердите его. Нажмите кнопку **Далее**.

	![укажите пароль][certwiz3]

12. Укажите путь к файлу и имя файла, который будет содержать экспортированный сертификат. Имя файла должно иметь расширение **.pfx**. Для завершения процесса нажмите кнопку **Далее**.

	![укажите путь к файлу][certwiz4]

Теперь можно отправить экспортированный PFX-файл в приложение в службе приложений Azure.

<a name="bkmk_openssl"></a>
### Получение сертификата с помощью OpenSSL

1. Создайте закрытый ключ и запрос подписи сертификата с помощью следующей команды для командной строки, bash или сеанса терминала:

		openssl req -new -nodes -keyout myserver.key -out server.csr -newkey rsa:2048

2. При появлении запроса введите соответствующую информацию. Например:

 		Country Name (2 letter code)
        State or Province Name (full name) []: Washington
        Locality Name (eg, city) []: Redmond
        Organization Name (eg, company) []: Microsoft
        Organizational Unit Name (eg, section) []: Azure
        Common Name (eg, YOUR name) []: www.microsoft.com
        Email Address []:

		Please enter the following 'extra' attributes to be sent with your certificate request

       	A challenge password []:

	По завершении этого процесса у вас должно быть два файла; **myserver.key** и **server.csr**. Файл **server.csr** содержит запрос подписи сертификата.

3. Отправьте запрос CSR в центр сертификации, чтобы получить SSL-сертификат. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][cas] на портале Microsoft TechNet Wiki.

4. После получения сертификата от центра сертификации сохраните его в файл с именем **myserver.crt**. Если ваш центр сертификации предоставил сертификат в текстовом формате, просто вставьте текст сертификата в файл **myserver.crt**. При просмотре в текстовом редакторе файл должен иметь сходное содержимое:

		-----BEGIN CERTIFICATE-----
		MIIDJDCCAgwCCQCpCY4o1LBQuzANBgkqhkiG9w0BAQUFADBUMQswCQYDVQQGEwJV
		UzELMAkGA1UECBMCV0ExEDAOBgNVBAcTB1JlZG1vbmQxEDAOBgNVBAsTB0NvbnRv
		c28xFDASBgNVBAMTC2NvbnRvc28uY29tMB4XDTE0MDExNjE1MzIyM1oXDTE1MDEx
		NjE1MzIyM1owVDELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAldBMRAwDgYDVQQHEwdS
		ZWRtb25kMRAwDgYDVQQLEwdDb250b3NvMRQwEgYDVQQDEwtjb250b3NvLmNvbTCC
		ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAN96hBX5EDgULtWkCRK7DMM3
		enae1LT9fXqGlbA7ScFvFivGvOLEqEPD//eLGsf15OYHFOQHK1hwgyfXa9sEDPMT
		3AsF3iWyF7FiEoR/qV6LdKjeQicJ2cXjGwf3G5vPoIaYifI5r0lhgOUqBxzaBDZ4
		xMgCh2yv7NavI17BHlWyQo90gS2X5glYGRhzY/fGp10BeUEgIs3Se0kQfBQOFUYb
		ktA6802lod5K0OxlQy4Oc8kfxTDf8AF2SPQ6BL7xxWrNl/Q2DuEEemjuMnLNxmeA
		Ik2+6Z6+WdvJoRxqHhleoL8ftOpWR20ToiZXCPo+fcmLod4ejsG5qjBlztVY4qsC
		AwEAATANBgkqhkiG9w0BAQUFAAOCAQEAVcM9AeeNFv2li69qBZLGDuK0NDHD3zhK
		Y0nDkqucgjE2QKUuvVSPodz8qwHnKoPwnSrTn8CRjW1gFq5qWEO50dGWgyLR8Wy1
		F69DYsEzodG+shv/G+vHJZg9QzutsJTB/Q8OoUCSnQS1PSPZP7RbvDV9b7Gx+gtg
		7kQ55j3A5vOrpI8N9CwdPuimtu6X8Ylw9ejWZsnyy0FMeOPpK3WTkDMxwwGxkU3Y
		lCRTzkv6vnHrlYQxyBLOSafCB1RWinN/slcWSLHADB6R+HeMiVKkFpooT+ghtii1
		A9PdUQIhK9bdaFicXPBYZ6AgNVuGtfwyuS5V6ucm7RE6+qf+QjXNFg==
		-----END CERTIFICATE-----

	Сохраните файл .

5. Из сеанса командной строки, Bash или в сеансе терминала используйте следующую команду для преобразования файлов **myserver.key** и **myserver.crt** в **myserver.pfx**; для службы приложений Azure требуется файл в таком формате:

		openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt

	При появлении запроса введите пароль для защиты файла .pfx.

	> [AZURE.NOTE] Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в следующем шаге. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предоставляется как PEM-файл (расширение PEM-файла).
	>
	> Следующие команды демонстрируют процедуру создания PFX-файла, включающего в себя промежуточные сертификаты, содержащиеся в файле **intermediate-cets.pem**:
	>
	>
	`````
	openssl pkcs12 -chain -export -out myserver.pfx -inkey myserver.key -in myserver.crt -certfile intermediate-cets.pem
	`````

	После выполнения этой команды вы должны получить файл **myserver.pfx**, который можно использовать для службы приложений Azure.

<a name="bkmk_iismgr"></a>
### Получение сертификата с помощью диспетчера IIS

Если вы умеете пользоваться диспетчером IIS, можно использовать его для создания сертификата, который может использоваться со службой приложений Azure.

1. С помощью диспетчера IIS создайте файл запроса подписи сертификата (CSR) и отправьте его в центр сертификации. Дополнительные сведения о создании CSR см. в разделе [Запрос сертификата службы IIS 7][iiscsr].

2. Отправьте запрос CSR в центр сертификации, чтобы получить SSL-сертификат. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][cas] на портале Microsoft TechNet Wiki.

3. Для запроса CSR укажите сертификат, предоставленный центром сертификации. Дополнительные сведения о дополнении CSR см. в разделе [Установка служб IIS 7][installcertiis].

4. Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в следующем шаге. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предназначена для служб Microsoft IIS.

	После загрузки сертификата щелкните на нем правой кнопкой мыши в обозревателе и выберите **Установить сертификат**. Используйте значения по умолчанию в **Мастере импорта сертификатов** и выбирайте **Далее** до завершения импорта.

4. Экспортируйте сертификат из диспетчера IIS. Дополнительные сведения об экспорте сертификата см. в. разделе [Экспорт сертификата служб IIS 7][exportcertiis]. Экспортированный файл на следующих этапах будет отправляться в Azure для использования с приложением.

	> [AZURE.NOTE] Во время экспорта убедитесь, что выбран параметр <strong>Да, экспортировать закрытый ключ</strong>. Это позволит включить закрытый ключ в экспортированный сертификат.

	> [AZURE.NOTE] Во время экспорта убедитесь, что выбраны параметры **Включить все сертификаты в путь сертификации** и **Экспортировать все расширенные свойства**. Это позволит включить в экспортированный сертификат все промежуточные сертификаты.

<a name="bkmk_subjectaltname"></a>
### Получение сертификата SubjectAltName с помощью OpenSSL

OpenSSL можно использовать для создания запроса сертификата, который использует расширение SubjectAltName для поддержки нескольких имен доменов в одном сертификате, однако для этого требуется файл конфигурации. Для создания файла конфигурации выполните следующие шаги, а затем используйте этот файл для запроса сертификата.

1. Создайте новый файл с именем __sancert.cnf__, имеющий следующее содержимое:

		# -------------- BEGIN custom sancert.cnf -----
		HOME = .
		oid_section = new_oids
		[ new_oids ]
		[ req ]
		default_days = 730
		distinguished_name = req_distinguished_name
		encrypt_key = no
		string_mask = nombstr
		req_extensions = v3_req # Extensions to add to certificate request
		[ req_distinguished_name ]
		countryName = Country Name (2 letter code)
		countryName_default =
		stateOrProvinceName = State or Province Name (full name)
		stateOrProvinceName_default =
		localityName = Locality Name (eg, city)
		localityName_default =
		organizationalUnitName  = Organizational Unit Name (eg, section)
		organizationalUnitName_default  =
		commonName              = Your common name (eg, domain name)
		commonName_default      = www.mydomain.com
		commonName_max = 64
		[ v3_req ]
		subjectAltName=DNS:ftp.mydomain.com,DNS:blog.mydomain.com,DNS:*.mydomain.com
		# -------------- END custom sancert.cnf -----

	Найдите строку, которая начинается с 'subjectAltName'. Замените указанные имена доменов на те имена доменов, которые должны поддерживаться вместе с общим именем. Например:

		subjectAltName=DNS:sales.contoso.com,DNS:support.contoso.com,DNS:fabrikam.com

	Не нужно менять значение поля commonName\_default при появлении запроса на ввод общего имени на одном из следующих этапов.

2. Сохраните файл __sancert.cnf__.

1. Создайте закрытый ключ и сертификат подписи запроса с помощью файла конфигурации sancert.cnf. С использованием Bash или сеанса терминала введите следующую команду:

		openssl req -new -nodes -keyout myserver.key -out server.csr -newkey rsa:2048 -config sancert.cnf

2. При появлении запроса введите соответствующую информацию. Например:

 		Country Name (2 letter code) []: US
        State or Province Name (full name) []: Washington
        Locality Name (eg, city) []: Redmond
        Organizational Unit Name (eg, section) []: Azure
        Your common name (eg, domain name) []: www.microsoft.com


	По завершении этого процесса у вас должно быть два файла; **myserver.key** и **server.csr**. Файл **server.csr** содержит запрос подписи сертификата.

3. Отправьте запрос CSR в центр сертификации, чтобы получить SSL-сертификат. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][cas] на портале Microsoft TechNet Wiki.

4. После получения сертификата от центра сертификации сохраните его в файл с именем **myserver.crt**. Если ваш центр сертификации предоставил сертификат в текстовом формате, просто вставьте текст сертификата в файл **myserver.crt**. При просмотре в текстовом редакторе файл должен иметь сходное содержимое:

		-----BEGIN CERTIFICATE-----
		MIIDJDCCAgwCCQCpCY4o1LBQuzANBgkqhkiG9w0BAQUFADBUMQswCQYDVQQGEwJV
		UzELMAkGA1UECBMCV0ExEDAOBgNVBAcTB1JlZG1vbmQxEDAOBgNVBAsTB0NvbnRv
		c28xFDASBgNVBAMTC2NvbnRvc28uY29tMB4XDTE0MDExNjE1MzIyM1oXDTE1MDEx
		NjE1MzIyM1owVDELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAldBMRAwDgYDVQQHEwdS
		ZWRtb25kMRAwDgYDVQQLEwdDb250b3NvMRQwEgYDVQQDEwtjb250b3NvLmNvbTCC
		ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAN96hBX5EDgULtWkCRK7DMM3
		enae1LT9fXqGlbA7ScFvFivGvOLEqEPD//eLGsf15OYHFOQHK1hwgyfXa9sEDPMT
		3AsF3iWyF7FiEoR/qV6LdKjeQicJ2cXjGwf3G5vPoIaYifI5r0lhgOUqBxzaBDZ4
		xMgCh2yv7NavI17BHlWyQo90gS2X5glYGRhzY/fGp10BeUEgIs3Se0kQfBQOFUYb
		ktA6802lod5K0OxlQy4Oc8kfxTDf8AF2SPQ6BL7xxWrNl/Q2DuEEemjuMnLNxmeA
		Ik2+6Z6+WdvJoRxqHhleoL8ftOpWR20ToiZXCPo+fcmLod4ejsG5qjBlztVY4qsC
		AwEAATANBgkqhkiG9w0BAQUFAAOCAQEAVcM9AeeNFv2li69qBZLGDuK0NDHD3zhK
		Y0nDkqucgjE2QKUuvVSPodz8qwHnKoPwnSrTn8CRjW1gFq5qWEO50dGWgyLR8Wy1
		F69DYsEzodG+shv/G+vHJZg9QzutsJTB/Q8OoUCSnQS1PSPZP7RbvDV9b7Gx+gtg
		7kQ55j3A5vOrpI8N9CwdPuimtu6X8Ylw9ejWZsnyy0FMeOPpK3WTkDMxwwGxkU3Y
		lCRTzkv6vnHrlYQxyBLOSafCB1RWinN/slcWSLHADB6R+HeMiVKkFpooT+ghtii1
		A9PdUQIhK9bdaFicXPBYZ6AgNVuGtfwyuS5V6ucm7RE6+qf+QjXNFg==
		-----END CERTIFICATE-----

	Сохраните файл .

5. Из сеанса командной строки, Bash или в сеансе терминала используйте следующую команду для преобразования файлов **myserver.key** и **myserver.crt** в **myserver.pfx**; для службы приложений Azure требуется файл в таком формате:

		openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt

	При появлении запроса введите пароль для защиты файла .pfx.

	> [AZURE.NOTE] Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в следующем шаге. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предоставляется как PEM-файл (расширение PEM-файла).
	>
	> Следующие команды демонстрируют процедуру создания PFX-файла, включающего в себя промежуточные сертификаты, содержащиеся в файле **intermediate-cets.pem**:
	>
	>
	`````
	openssl pkcs12 -chain -export -out myserver.pfx -inkey myserver.key -in myserver.crt -certfile intermediate-cets.pem
	`````

	После выполнения этой команды вы должны получить файл **myserver.pfx**, который можно использовать для службы приложений Azure.

<a name="bkmk_selfsigned"></a>
### Создание самозаверяющего сертификата (только для тестирования)

В некоторых случаях может понадобиться получить сертификат для тестирования и отложить покупку сертификата у одного из доверенных ЦС до развертывания рабочей среды. В этом случае можно использовать самозаверяющие сертификаты. Самозаверяющий сертификат — это сертификат, который вы создаете и подписываете от имени центра сертификации. Несмотря на то что сертификат можно использовать для защиты приложения, большинство браузеров будут возвращать ошибки при посещении приложения, поскольку сертификат не был подписан доверенным ЦС. Некоторые браузеры могут даже отказаться отображать приложение.

- [Создание самозаверяющего сертификата с помощью makecert](#bkmk_ssmakecert)
- [Создание самозаверяющего сертификата с помощью OpenSSL](#bkmk_ssopenssl)

<a name="bkmk_ssmakecert"></a>
#### Создание самозаверяющего сертификата с помощью makecert ####

Можно создать тестовый сертификат из системы Windows с установленной программой Visual Studio. Для этого выполните следующие действия:

1. В меню **Пуск** или на экране **Пуск** найдите **командную строку разработчика**. Щелкните правой кнопкой мыши **командную строку разработчика** и выберите **Запуск от имени администратора**.

	Если появится диалоговое окно контроля учетных записей, выберите **Да** для продолжения.

2. В командной строке разработчика используйте приведенную ниже команду для создания нового самозаверяющего сертификата. Необходимо заменить **serverdnsname** службой DNS вашего веб-приложения.

		makecert -r -pe -b 01/01/2013 -e 01/01/2014 -eku 1.3.6.1.5.5.7.3.1 -ss My -n CN=serverdnsname -sky exchange -sp "Microsoft RSA SChannel Cryptographic Provider" -sy 12 -len 2048

	Эта команда создаст сертификат, который действует с 01.01.2013 по 01.01.2014, и сохранит расположение в хранилище сертификатов CurrentUser.

3. В **меню "Пуск"** или **на экране "Пуск"** найдите **Windows PowerShell** и запустите это приложение.

4. В командной строке Windows PowerShell экспортируйте созданный ранее сертификат с помощью следующих команд:

		$mypwd = ConvertTo-SecureString -String "password" -Force -AsPlainText
		get-childitem cert:\currentuser\my -dnsname serverdnsname | export-pfxcertificate -filepath file-to-export-to.pfx -password $mypwd

	При этом пароль будет сохранен в виде защищенной строки в $mypwd, затем будет найден сертификат с использованием имени DNS, указанного в параметре **dnsname**, и будет выполнен экспорт в файл, заданный параметром **filepath**. Защищенная строка, содержащая пароль, используется для защиты экспортируемого файла.

<a name="bkmk_ssopenssl"></a>
####Создание самозаверяющего сертификата с помощью OpenSSL ####

1. Создайте новый документ с именем **serverauth.cnf** и со следующим содержимым:

        [ req ]
        default_bits           = 2048
        default_keyfile        = privkey.pem
        distinguished_name     = req_distinguished_name
        attributes             = req_attributes
        x509_extensions        = v3_ca

        [ req_distinguished_name ]
        countryName			= Country Name (2 letter code)
        countryName_min			= 2
        countryName_max			= 2
        stateOrProvinceName		= State or Province Name (full name)
        localityName			= Locality Name (eg, city)
        0.organizationName		= Organization Name (eg, company)
        organizationalUnitName		= Organizational Unit Name (eg, section)
        commonName			= Common Name (eg, your app's domain name)
        commonName_max			= 64
        emailAddress			= Email Address
        emailAddress_max		= 40

        [ req_attributes ]
        challengePassword		= A challenge password
        challengePassword_min		= 4
        challengePassword_max		= 20

        [ v3_ca ]
         subjectKeyIdentifier=hash
         authorityKeyIdentifier=keyid:always,issuer:always
         basicConstraints = CA:false
         keyUsage=nonRepudiation, digitalSignature, keyEncipherment
         extendedKeyUsage = serverAuth

	Это позволит указать параметры конфигурации, необходимые для создания SSL-сертификата, который может использоваться службой приложений Azure.

2. Создайте новый самозаверяющий сертификат с помощью следующей команды для командной строки, bash или сеанса терминала:

		openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout myserver.key -out myserver.crt -config serverauth.cnf

	При этом создается новый сертификат с использованием параметров конфигурации, указанных в файле **serverauth.cnf**.

3. Воспользуйтесь следующей командой, чтобы экспортировать сертификат в PFX-файл, который можно отправить в приложение в службе приложений Azure.

		openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt

	При появлении запроса введите пароль для защиты файла .pfx.

	Созданный этой командой файл **myserver.pfx** может использоваться для защиты приложения при выполнении тестирования.

<a name="bkmk_standardmode"></a>
## 2\. Настройка ценовой категории "Стандартная" или "Премиум"

Включение HTTPS для пользовательского домена возможно только для категорий **Стандартная** и **Премиум** службы приложений Azure. Выполните следующие шаги для переключения плана службы приложений на уровень **Стандартный**.

> [AZURE.NOTE] Прежде чем перевести приложение с уровня **Бесплатный** на уровень **Стандартный**, необходимо снять существующие ограничения расходов, установленные для вашей подписки. В противном случае существует риск недоступности приложения при превышении ограничений до завершения расчетного периода. Дополнительные сведения о стоимости общего и **стандартного** уровней см. в разделе [Сведения о ценах][pricing].

1.	В браузере откройте [портал Azure](http://go.microsoft.com/fwlink/?LinkId=529715).
2.	Щелкните **Обзор** в левой части страницы.
3.	Щелкните колонку **Веб-приложения**.
4.	Щелкните имя приложения.
5.	На странице **Основные компоненты** щелкните **Параметры**.
6.	Щелкните пункт **Масштаб** ![Вкладка "Масштаб"][scale].
7.	В разделе **Масштаб** выберите режим плана для службы приложений, щелкнув **Выбрать**. ![Ценовая категория][sslreserved]

	> [AZURE.NOTE] Если появляется ошибка "Не выполнена настройка масштабирования для «имя приложения»", для получения дополнительной информации используйте кнопку "Сведения". Может появиться сообщение об ошибке "Недостаточно доступных стандартных экземпляров серверов для удовлетворения запроса". При появлении этой ошибки обратитесь в [службу поддержки Azure](/support/options/).

<a name="bkmk_configuressl"></a>
## 3\. Настройка SSL в приложении

Прежде чем выполнять действия, описанные в этом разделе, необходимо связать личное доменное имя с приложением. Дополнительные сведения см. в разделе [Настройка личного доменного имени для веб-приложения][customdomain].

1.	Откройте в браузере [портал управления Azure](https://portal.azure.com).
2.	Щелкните **Обзор** в левой части страницы.
3.	Щелкните колонку **Веб-приложения**.
4.	Щелкните имя приложения.
5.	На странице **Основные компоненты** щелкните **Параметры**.
6.	Щелкните **Личные домены и SSL**. ![Вкладка конфигурации][sslconfig]
7.	В разделе **Сертификаты** нажмите кнопку **Отправить**.
8.	С использованием диалогового окна **загрузки сертификата** выберите файл сертификата .pfx, созданный ранее с помощью диспетчера IIS или OpenSSL. Укажите пароль, используемый для защиты файла .pfx (при наличии). В конце щелкните **Сохранить** для отправки сертификата. ![Отправка SSL-сертификата][ssluploadcert]
9. В разделе **привязки ssl** вкладки **Параметры SSL** в раскрывающихся списках выберите имя домена для защиты с применением SSL, а также используемый сертификат. Можно также выбрать использование [подключения с указанием имени сервера][sni] (SNI) или SSL на основе IP.

	![привязки ssl][sslbindings]

	* SSL на основе IP связывает сертификат с именем домена, сопоставляя выделенный открытый IP-адрес сервера с именем домена. Для этого необходимо, чтобы для каждого имени домена (contoso.com, fabricam.com и т. д.), связанного с вашей службой, был доступен выделенный IP-адрес. Это традиционный метод сопоставления сертификатов SSL с веб-сервером.

	* SSL-подключения на основе SNI являются расширением SSL и [протоколом TLS][tls], которые позволяют нескольким доменам совместно использовать IP-адрес с отдельными сертификатами безопасности для каждого домена. Большинство современных браузеров (включая Internet Explorer, Chrome, Firefox и Opera) поддерживает SNI, однако более старые браузеры могут не поддерживать SNI. Дополнительные сведения о SNI см. в статье Википедии [Подключения с указанием имени сервера][sni].

10. Чтобы сохранить изменения и активировать SSL, нажмите кнопку **Сохранить**.

> [AZURE.NOTE] Если выбран **вариант SSL-подключения на основе IP** и пользовательский домен настроен с помощью записи А, необходимо выполнить следующие дополнительные шаги:
>
> 1. После настройки привязки SSL-подключения на основе IP вашему веб-приложению будет предоставлен выделенный IP-адрес. Этот IP-адрес можно найти на странице **Панель мониторинга** вашего веб-приложения в разделе **Сводка**. Он будет указан как **Виртуальный IP-адрес**:
>    
>     ![Виртуальный IP-адрес](./media/configure-ssl-web-site/staticip.png)
>    
>     Обратите внимание: этот IP-адрес будет отличаться от виртуального IP-адреса, который использовался ранее для настройки записи A для вашего домена. Если выбрано использование SSL-подключения на основе SNI или если не настроено использование SSL, для этой записи адрес указан не будет.
>
> 2. С помощью средств, предоставляемых регистратором имени домена, измените запись A для имени пользовательского домена, указав IP-адрес из предыдущего шага.


На этом этапе приложение должно открываться с использованием `HTTPS://`, а не `HTTP://`, что подтверждает правильность настройки сертификата.

<a name="bkmk_enforce"></a>
## 4\. Принудительное использование HTTPS для приложения

Служба приложений Azure принудительно *не* использует протокол HTTPS. Посетители по-прежнему могут получить доступ к вашему приложению, используя протокол HTTP, что может поставить под угрозу безопасность приложения. Если требуется принудительно обеспечить использование HTTPS для своего приложения, можно воспользоваться модулем **переопределения URL-адресов**. Модуль переопределения URL-адресов включен в службу приложений Azure и дает возможность определять правила, которые применяются к входящим запросам перед их обработкой и отправкой в приложение. **Его можно использовать для приложений, написанных на любом языке программирования, поддерживаемом Azure.**

> [AZURE.NOTE] Приложения .NET MVC вместо модуля переопределения URL-адресов должны использовать фильтр [RequireHttps](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx). Дополнительные сведения об использовании фильтра RequireHttps см. в статье [Развертывание безопасного приложения ASP.NET MVC 5 в веб-приложении](../articles/app-service-web/web-sites-dotnet-deploy-aspnet-mvc-app-membership-oauth-sql-database.md).
>
> Сведения о программном перенаправлении запросов с помощью других языков программирования и платформ см. в документации для этих технологий.

Правила модуля переопределения URL-адресов задаются в файле **web.config**, который хранится в корневом каталоге приложения. В примере ниже показано базовое правило модуля переопределения URL-адресов, которое заставляет весь входящий трафик использовать HTTPS.

<a name="example"></a>**Пример файла Web.Config модуля переопределения URL-адресов**

	<?xml version="1.0" encoding="UTF-8"?>
	<configuration>
	  <system.webServer>
	    <rewrite>
	      <rules>
	        <rule name="Force HTTPS" enabled="true">
	          <match url="(.*)" ignoreCase="false" />
	          <conditions>
	            <add input="{HTTPS}" pattern="off" />
	          </conditions>
	          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" appendQueryString="true" redirectType="Permanent" />
	        </rule>
	      </rules>
	    </rewrite>
	  </system.webServer>
	</configuration>

Это правило работает путем возврата кода состояния HTTP 301 (постоянное перенаправление), когда пользователь запрашивает страницу с помощью HTTP. Код состояния 301 перенаправляет запрос на тот же запрошенный посетителем URL-адрес, но заменяет в запросе HTTP на HTTPS. Например, HTTP://contoso.com будут перенаправлены в HTTPS://contoso.com.

> [AZURE.NOTE] Если приложение написано на **Node.js**, **PHP**, **Python Django** или **Java**, в нем скорее всего отсутствует файл web.config. Однако приложения на **Node.js**, **Python Django** и **Java** на самом деле используют web.config при размещении в службе приложений Azure, потому что Azure автоматически создает этот файл при развертывании, и вы его не видите. Если включить этот файл в приложение, он переопределит файл, автоматически создаваемый Azure.

###.NET

Для приложений .NET измените файл web.config и добавьте раздел **&lt;rewrite>** из этого [примера](#example) в раздел **&lt;system.WebServer>**.

Если файл web.config уже содержит раздел **&lt;rewrite>**, добавьте **&lt;rule>** из этого [примера](#example) в качестве первой записи раздела **&lt;rules>**.

###PHP

Для приложений на PHP просто сохраните [пример](#example) как файл web.config в корневом каталоге приложения, а затем заново разверните приложение в своем приложении.

###Node.js, Python Django и Java

Если в приложениях Node.js, Python Django и Java отсутствует файл web.config, то он создается автоматически, но существует только на сервере, поскольку создается во время развертывания. Этот автоматически созданный файл содержит параметры, указывающие Azure, как следует размещать приложение.

Чтобы получить этот автоматически созданный файл от приложения и изменить его, выполните следующие действия.

1. Загрузите файл с помощью FTP (см. статью [Отправка и загрузка файлов с помощью FTP и сбор журналов диагностики](http://blogs.msdn.com/b/avkashchauhan/archive/2012/06/19/windows-azure-website-uploading-downloading-files-over-ftp-and-collecting-diagnostics-logs.aspx)).

2. Добавьте его в корневой каталог приложения.

3. Добавьте в него правила переопределения, используя следующие сведения.

	* **Node.js и Python Django**

		В файле web.config, созданном для приложений Node.js и Python Django, уже будет раздел **&lt;rewrite>** с записями**&lt;rule>**, необходимыми для соответствующего функционирования приложения. Чтобы заставить приложение использовать HTTPS, добавьте **&lt;rule>** из примера в качестве первой записи в разделе **&lt;rules>**. Это обеспечит применение HTTPS и не повлияет на остальные правила.

	* **Java**

		Файл web.config для приложений Java, использующих Apache Tomcat, не содержит раздел **&lt;rewrite>**, поэтому необходимо добавить раздел **&lt;rewrite>** из примера в раздел **&lt;system.webServer>**.

4. Выполните повторное развертывание проекта (включая обновленный файл web.config) в Azure.

После развертывания файла web.config с правилом переопределения, заставляющим применять HTTPS, это правило вступит в действие немедленно, и все запросы начнут перенаправляться на HTTPS.

Дополнительные сведения о модуле переопределения URL-адресов IIS см. в документации по [модулю переопределения URL-адресов](http://www.iis.net/downloads/microsoft/url-rewrite).

## Дополнительные ресурсы ##
- [Центр управления безопасностью Microsoft Azure](/support/trust-center/security/)
- [Параметры конфигурации, разблокированные на веб-сайтах Azure](/blog/2014/01/28/more-to-explore-configuration-options-unlocked-in-windows-azure-web-sites/)
- [Включение ведения журналов диагностики](../articles/app-service-web/web-sites-enable-diagnostic-log.md)
- [Настройка веб-приложений в службе приложений Azure](../articles/app-service-web/web-sites-configure.md)
- [Портал управления Azure](https://manage.windowsazure.com)

>[AZURE.NOTE] Если требуется приступить к работе со службой приложений Azure до создания учетной записи Azure, перейдите к разделу [Пробное использование службы приложений](http://go.microsoft.com/fwlink/?LinkId=523751), который поможет быстро создать кратковременное приложение начального уровня в службе приложений. Никаких кредитных карт и обязательств.

## Изменения
* Указания по изменениям при переходе от веб-сайтов к службе приложений см. в разделе [Служба приложений Azure и ее влияние на существующие службы Azure](http://go.microsoft.com/fwlink/?LinkId=529714).
* Руководство по смене старого портала на новый портал см. в разделе [Справочник по навигации на предварительной версии портала](http://go.microsoft.com/fwlink/?LinkId=529715).

[customdomain]: ../articles/app-service-web/web-sites-custom-domain-name.md
[iiscsr]: http://technet.microsoft.com/library/cc732906(WS.10).aspx
[cas]: http://go.microsoft.com/fwlink/?LinkID=269988
[installcertiis]: http://technet.microsoft.com/library/cc771816(WS.10).aspx
[exportcertiis]: http://technet.microsoft.com/library/cc731386(WS.10).aspx
[openssl]: http://www.openssl.org/
[portal]: https://manage.windowsazure.com/
[tls]: http://en.wikipedia.org/wiki/Transport_Layer_Security
[staticip]: ./media/configure-ssl-web-site/staticip.png
[website]: ./media/configure-ssl-web-site/sslwebsite.png
[scale]: ./media/configure-ssl-web-site/sslscale.png
[standard]: ./media/configure-ssl-web-site/sslreserved.png
[pricing]: /pricing/details/
[configure]: ./media/configure-ssl-web-site/sslconfig.png
[uploadcert]: ./media/configure-ssl-web-site/ssluploadcert.png
[uploadcertdlg]: ./media/configure-ssl-web-site/ssluploaddlg.png
[sslbindings]: ./media/configure-ssl-web-site/sslbindings.png
[sni]: http://en.wikipedia.org/wiki/Server_Name_Indication
[certmgr]: ./media/configure-ssl-web-site/waws-certmgr.png
[certwiz1]: ./media/configure-ssl-web-site/waws-certwiz1.png
[certwiz2]: ./media/configure-ssl-web-site/waws-certwiz2.png
[certwiz3]: ./media/configure-ssl-web-site/waws-certwiz3.png
[certwiz4]: ./media/configure-ssl-web-site/waws-certwiz4.png

<!---HONumber=AcomDC_0128_2016-->