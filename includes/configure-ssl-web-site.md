# Включение HTTPS для веб-сайта Azure

Когда посетитель заходит на веб-сайт с использованием протокола HTTPS, обмен данными между веб-сайтом и браузером будет защищен с помощью шифрования Secure Socket Layer (SSL). Это наиболее часто используемый способ защиты данных, передаваемых через Интернет. Он гарантирует безопасность взаимодействия посетителя с вашим веб-сайтом. В этой статье описывается, как включить HTTPS для веб-сайта Azure.

> [WACOM.NOTE] Чтобы активировать протокол HTTPS для пользовательских доменных имен, необходимо настроить веб-сайты на стандартный режим. Если в настоящий момент используется бесплатный режим или общий режим, это может повлечь за собой дополнительные затраты. Дополнительные сведения о ценах на общий и стандартный режим см. в разделе [Сведения о ценах][]. Чтобы начать работу с Azure, см. раздел [Бесплатная пробная версия Microsoft Azure][].

[][]

## Домен \*.azurewebsites.net

</p>
Если вы не планируете использовать пользовательское доменное имя, применяя вместо него домен \*.azurewebsites.net, назначенный для вашего веб-сайта платформой Azure (например, contoso.azurewebsites.net), то ваш сайт уже защищен сертификатом, предоставляемым корпорацией Майкрософт. Для безопасного доступа к сайту можно использовать **<https://mywebsite.azurewebsites.net>**. Однако \*.azurewebsites.net является общим доменом и как все общие домены, он не так безопасен, как пользовательский домен с собственным сертификатом.

Остальная часть этого документа содержит подробные сведения о включении HTTPS для пользовательских доменных имен, таких как **contoso.com**, **www.contoso.com** или **\*.contoso.com**

[][1]

## Имена пользовательских доменов

</p>
Чтобы включить домен HTTPS для имени пользовательского домена, такого как **contoso.com**, необходимо зарегистрировать имя пользовательского домена у регистратора доменных имен. Дополнительные сведения о настройке доменного имени веб-сайта Azure см. в разделе [Настройка пользовательского доменного имени для веб-сайта Azure][]. После регистрации имени пользовательского домена и настройки пользовательского имени для веб-сайта необходимо запросить SSL-сертификат для домена.

Регистрация имени домена также позволяет создавать дочерние домены, такие как **www.contoso.com** или **mail.contoso.com**. Перед запросом сертификата SSL необходимо сначала определить, какие имена доменов будут защищены с помощью сертификата. От этого зависит требуемый тип сертификата. Если необходимо защитить одно доменное имя, например **contoso.com** или **www.contoso.com**, вам будет достаточно базового сертификата. Если необходимо защитить несколько имен доменов, таких как **contoso.com**, **www.contoso.com** и **mail.contoso.com**, вам потребуется групповой сертификат или сертификат с именем альтернативной темы (subjectAltName, SAN).

> [WACOM.NOTE] В большинстве обозревателей будет отображаться предупреждение, если имя домена, указанное в сертификате, не соответствует имени домена, которое введено в браузере. Например, если в сертификате указан только домен www.contoso.com, а для доступа к веб-сайту в Internet Explorer используется имя домена login.contoso.com, вы получите следующее предупреждение: "сертификат безопасности этого веб-сайта был выпущен для другого веб-адреса".

**Базовые сертификаты** представляют собой сертификаты, где обычное имя (CN) сертификата соответствует определенному домену или дочернему домену, который клиенты будут использовать для посещения веб-сайта. Например, **www.contoso.com**. Эти сертификаты защищают только одно имя домена, указанное в CN.

**Групповые сертификаты** — это сертификаты, в которых CN сертификата содержит подстановочный знак '"\*" на уровне поддомена. Это позволяет соотносить сертификат с одним уровнем дочерних доменов для данного домена. Например, групповой сертификат для **\*.contoso.com** будет действителен для доменов **www.contoso.com**, **payment.contoso.com** и **login.contoso.com**. Однако он будет недействительным для домена **test.login.contoso.com**, поскольку в нем присутствует дополнительный уровень дочернего домена. Также он будет недействительным для домена **contoso.com**, поскольку он является корневым, а не дочерним доменом.

Корпорация Майкрософт автоматически предоставляет групповой сертификат для доменного имени \*.azurewebsites.net, автоматически созданного для веб-сайта.

**subjectAltName** — это расширение сертификата, которое позволяет связывать с сертификатом различные значения или имена альтернативной темы. Для SSL-сертификатов это позволяет добавлять дополнительные DNS-имена, для которых будет действителен сертификат. Например, сертификат, использующий subjectAltName, может иметь CN **contoso.com**, а также альтернативные имена **www.contoso.com**, **payment.contoso.com**, **test.login.contoso.com** и даже **fabrikam.com**. Такой сертификат будет действителен для всех доменных имен, указанных в общем имени и в subjectAltName.

Сертификат может поддерживать как подстановочные знаки, так и subjectAltName.

[][2]

## Получение сертификата

</p>
SSL-сертификаты, используемые для веб-сайтов Azure, должны быть подписаны центром сертификации (ЦС), то есть доверенным сторонним поставщиком, который выдает сертификаты для этой цели. Если у вас еще нет сертификата, нужно получить его в компании, продающей SSL-сертификаты. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][] на портале Microsoft TechNet Wiki.

Сертификат должен отвечать следующим требованиям для SSL-сертификатов в Azure.

-   Сертификат должен содержать закрытый ключ.

-   Сертификат должен быть создан для обмена ключами, которые можно экспортировать в файл обмена личной информацией (PFX-файл).

-   Имя субъекта сертификата должно совпадать с именем домена, которое используется для обращения к веб-сайту. Если требуется обслуживать несколько доменов с этим сертификатом, необходимо использовать подстановочные значения или указать значения subjectAltName, как обсуждалось ранее.

    -   Сведения о настройке пользовательского доменного имени для веб-сайта Azure см. в разделе [Настройка пользовательского доменного имени для веб-сайта Azure][].

    > [WACOM.NOTE] Не пытайтесь получить или создать сертификат для домена azurewebsites.net.

-   Сертификат должен использовать как минимум 2048-разрядное шифрование.

> [WACOM.NOTE] Сертификаты, выданные серверами частных центров сертификации, не поддерживаются в веб-сайтах Azure.

Чтобы получить SSL-сертификат из центра сертификации, необходимо создать файл запроса подписи сертификата (CSR-файл), который отправляется в центр сертификации. После этого центр сертификации вернет сертификат, который используется для завершения CSR. Для создания CSR обычно используется одно из следующих двух основных приложений: certmgr.exe или [OpenSSL][]. Приложение Certmgr.exe доступно только для Windows, тогда как OpenSSL подходит для большинства платформ. Процедура использования обоих приложений описана ниже.

> [WACOM.NOTE] Сертификаты на основе шифрования эллиптических кривых (ECC) поддерживаются веб-сайтами Azure, однако они относительно новые и должны работать с центром сертификации по конкретным действиям для создания CSR. После получения сертификата ECC можно отправить его на веб-сайт, как описано в инструкциях ниже.

Возможно, вам также понадобятся **промежуточные сертификаты** (также известные как сертификаты цепочки), если ваш центр сертификации использует их. Использование промежуточных сертификатов считается более безопасным, чем применение «сертификатов без цепочки», поэтому ЦС в большинстве случаев используют такие сертификаты. Промежуточные сертификаты зачастую нужно отдельно загружать с веб-сайта ЦС. Действия, приведенные в данном разделе, описывают процедуру объединения всех промежуточных сертификатов с сертификатом, отправленным на веб-сайт Azure.

> [WACOM.NOTE] При выполнении любого набора действий вам будет предложено ввести **Общее имя**. При получении группового сертификата для использования с несколькими доменами (www.contoso.com, sales.contoso.com) должно использоваться значение \*.domainname (например, \*.contoso.com). При получении сертификата для одного доменного имени это значение должно точно совпадать с тем значением, которое пользователи будут вводить в браузере для посещения веб-сайта. Например, www.contoso.com.
>
> Если необходима поддержка как групповых имен, например \*.contoso.com, так и имени корневого домена, можно использовать групповой сертификат с альтернативным именем субъекта (SAN). Пример создания запроса сертификата с использованием расширений SubjectAltName см. в разделе [Сертификат SubjectAltName][].
>
> Дополнительные сведения о настройке доменного имени веб-сайта Azure см. в разделе [Настройка пользовательского доменного имени для веб-сайта Azure][].

### Получение сертификата с помощью Certreq.exe (только для Windows)

CertReq.exe является служебной программой Windows для создания запросов сертификатов. Она входит в базовый установочный пакет Windows, начиная с Windows XP и Windows Server 2000, поэтому данная программа будет доступной на всех недавних версиях Windows. Для получения SSL-сертификата с помощью certreq.exe выполните следующие действия.

Если вы хотите создать самозаверяющий сертификат для тестирования, см. раздел [Самозаверяющие сертификаты][] в данном документе.

Если вы хотите использовать IIS Manager для создания запроса сертификата, см. раздел [Получение сертификата с помощью диспетчера IIS][].

1.  Откройте **Блокнот** и создайте новый документ со следующим содержимым. Замените **mysite.com** в строке темы на пользовательское доменное имя вашего веб-сайта. Например, тема = "CN=www.contoso.com".

        [NewRequest]
        Subject = "CN=mysite.com"
        Exportable = TRUE
        KeyLength = 2048
        KeySpec = 1
        KeyUsage = 0xA0
        MachineKeySet = True
        ProviderName = "Microsoft RSA SChannel Cryptographic Provider"
        ProviderType = 12
        RequestType = CMC

        [EnhancedKeyUsageExtension]
        OID=1.3.6.1.5.5.7.3.1

    Для получения дополнительных сведений об указанных выше вариантах, а также о других доступных вариантах см. [справочную документацию Certreq][]

2.  Сохраните текстовый файл под именем **myrequest.txt**.

3.  На **экране "Пуск"** или в **меню "Пуск"** запустите файл **cmd.exe**.

4.  В командной строке для создания файла запроса сертификата используйте следующую команду:

        certreq -new \path\to\myrequest.txt \path\to\create\myrequest.csr

    Укажите путь к файлу **myrequest.txt**, созданному при выполнении шага 1, и путь, используемый при создании файла **myrequest.csr**.

5.  Отправьте файл **myrequest.csr** в центр сертификации, чтобы получить SSL-сертификат. Для этого может потребоваться загрузка файла или открытие файла в Блокноте и вставка содержимого непосредственно в веб-форму.

    Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][] на портале Microsoft TechNet Wiki.

6.  После того как центр сертификации предоставит вам файл сертификата (.CER), сохраните этот файл на компьютер, используемый для создания запроса, и выполните следующую команду, чтобы принять запрос и завершить процесс создания сертификата.

        certreq -accept -user mycert.cer

    В этом случае файл **mycert.cer**, полученный от центра сертификации, будет использоваться для подписывания сертификата. Файл создан не будет; вместо этого сертификат будет сохранен в хранилище сертификатов Windows.

7.  Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в последующих шагах. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предназначена для служб Microsoft IIS.

    После загрузки сертификата щелкните на нем правой кнопкой мыши в обозревателе и выберите **Установить сертификат**. Используйте значения по умолчанию в **Мастере импорта сертификатов** и выбирайте **Далее** до завершения импорта.

8.  Чтобы экспортировать сертификат из хранилища сертификатов, запустите **certmgr.msc** на **рабочем столе** или в **меню Пуск**. При появлении **диспетчера сертификатов** разверните **личную** папку, а затем выберите **Сертификаты**. В поле **Кому выдан** найдите запись с именем пользовательского домена, для которого запрашивался сертификат. В поле **Кем выдан** указывается центр сертификации, выдавший этот сертификат.

    ![вставить изображение диспетчера сертификатов][]

9.  Щелкните сертификат правой кнопкой мыши и выберите **Все задачи**, а затем выберите **Экспорт**. В **мастере экспорта сертификатов** нажмите **Далее**, а затем выберите **Да, экспортировать закрытый ключ**. Нажмите кнопку **Далее**.

    ![Экспорт закрытого ключа][]

10. Выберите **Обмен личной информацией — PKCS \#12**, **Включить все сертификаты в цепочке сертификатов** и **Экспортировать все расширенные свойства**. Нажмите кнопку **Далее**.

    ![включить все сертификаты и расширенные свойства][]

11. Выберите **Пароль**, а затем введите пароль и подтвердите его. Нажмите кнопку **Далее**.

    ![укажите пароль][]

12. Укажите путь к файлу и имя файла, который будет содержать экспортированный сертификат. Имя файла должно иметь расширение **.pfx**. Для завершения процесса нажмите кнопку **Далее**.

    ![укажите путь к файлу][]

Теперь можно отправить экспортированный PFX-файл на веб-сайт Azure.

### Получение сертификата с помощью OpenSSL

1.  Создайте закрытый ключ и запрос подписи сертификата с помощью следующей команды для командной строки, bash или сеанса терминала:

        openssl req -new -nodes -keyout myserver.key -out server.csr -newkey rsa:2048

2.  При появлении запроса введите соответствующую информацию. Например:

        Country Name (2 letter code) 
        State or Province Name (full name) []: Washington
        Locality Name (eg, city) []: Redmond
        Organization Name (eg, company) []: Microsoft
        Organizational Unit Name (eg, section) []: Azure
        Common Name (eg, YOUR name) []: www.microsoft.com
        Email Address []:

        Please enter the following 'extra' attributes to be sent with your certificate request

        A challenge password []: 

    По завершении этого процесса у вас должно быть два файла; **myserver.key** и **server.csr**. Файл **server.csr** содержит запрос подписи сертификата.

3.  Отправьте запрос CSR в центр сертификации, чтобы получить SSL-сертификат. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][] на портале Microsoft TechNet Wiki.

4.  После получения сертификата от центра сертификации сохраните его в файл с именем **myserver.crt**. Если ваш центр сертификации предоставил сертификат в текстовом формате, просто вставьте текст сертификата в файл **myserver.crt**. При просмотре в текстовом редакторе файл должен иметь следующее содержимое:

        -----BEGIN CERTIFICATE-----
        MIIDJDCCAgwCCQCpCY4o1LBQuzANBgkqhkiG9w0BAQUFADBUMQswCQYDVQQGEwJV
        UzELMAkGA1UECBMCV0ExEDAOBgNVBAcTB1JlZG1vbmQxEDAOBgNVBAsTB0NvbnRv
        c28xFDASBgNVBAMTC2NvbnRvc28uY29tMB4XDTE0MDExNjE1MzIyM1oXDTE1MDEx
        NjE1MzIyM1owVDELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAldBMRAwDgYDVQQHEwdS
        ZWRtb25kMRAwDgYDVQQLEwdDb250b3NvMRQwEgYDVQQDEwtjb250b3NvLmNvbTCC
        ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAN96hBX5EDgULtWkCRK7DMM3
        enae1LT9fXqGlbA7ScFvFivGvOLEqEPD//eLGsf15OYHFOQHK1hwgyfXa9sEDPMT
        3AsF3iWyF7FiEoR/qV6LdKjeQicJ2cXjGwf3G5vPoIaYifI5r0lhgOUqBxzaBDZ4
        xMgCh2yv7NavI17BHlWyQo90gS2X5glYGRhzY/fGp10BeUEgIs3Se0kQfBQOFUYb
        ktA6802lod5K0OxlQy4Oc8kfxTDf8AF2SPQ6BL7xxWrNl/Q2DuEEemjuMnLNxmeA
        Ik2+6Z6+WdvJoRxqHhleoL8ftOpWR20ToiZXCPo+fcmLod4ejsG5qjBlztVY4qsC
        AwEAATANBgkqhkiG9w0BAQUFAAOCAQEAVcM9AeeNFv2li69qBZLGDuK0NDHD3zhK
        Y0nDkqucgjE2QKUuvVSPodz8qwHnKoPwnSrTn8CRjW1gFq5qWEO50dGWgyLR8Wy1
        F69DYsEzodG+shv/G+vHJZg9QzutsJTB/Q8OoUCSnQS1PSPZP7RbvDV9b7Gx+gtg
        7kQ55j3A5vOrpI8N9CwdPuimtu6X8Ylw9ejWZsnyy0FMeOPpK3WTkDMxwwGxkU3Y
        lCRTzkv6vnHrlYQxyBLOSafCB1RWinN/slcWSLHADB6R+HeMiVKkFpooT+ghtii1
        A9PdUQIhK9bdaFicXPBYZ6AgNVuGtfwyuS5V6ucm7RE6+qf+QjXNFg==
        -----END CERTIFICATE-----

    Сохраните файл.

5.  В командной строке, сеансе Bash или сеансе терминала используйте для преобразования файлов **myserver.key** и **myserver.crt** в **myserver.pfx** (этот формат требуется для веб-сайтов Azure) следующую команду:

        openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt

    При появлении запроса введите пароль для защиты файла .pfx.

    <div class="dev-callout"> 
<b>Примечание.</b>
<p>Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в следующем шаге. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предоставляется как PEM-файл (расширение PEM-файла).</p>
<p>Следующие команды демонстрируют процедуру создания PFX-файла, включающего в себя промежуточные сертификаты, содержащиеся в файле <b>intermediate-cets.pem</b>:</p>
<pre><code>
openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt -certfile intermediate-cets.pem
</code></pre>
</div>

    После выполнения этой команды вы должны получить файл **myserver.pfx**, который можно использовать для веб-сайтов Azure.

[][3]

## Настройка стандартного режима

</p>
Включение HTTPS для пользовательского домена возможно только в стандартном режиме веб-сайтов Azure. Чтобы перейти в стандартный режим, выполните следующие действия.

> [WACOM.NOTE] Прежде чем перевести веб-сайт с бесплатного режима на стандартный, необходимо снять существующие ограничения расходов, установленные для вашей подписки на веб-сайт; в противном случае сайт может оказаться недоступным при превышении ограничений до завершения расчетного периода. Дополнительные сведения о ценах на общий и стандартный режим см. в разделе [Сведения о ценах][].

1.  Откройте в браузере [портал управления][]

2.  Во вкладке **Веб-сайты** щелкните имя вашего веб-сайта.

    ![выбор веб-сайта][]

3.  Щелкните вкладку **МАСШТАБ**.

    ![Вкладка "Масштаб"][]

4.  В разделе **Общие** установите режим веб-сайта, щелкнув **СТАНДАРТНЫЙ**

    ![выбран стандартный режим][]

5.  Щелкните **Сохранить**. При появлении запроса нажмите кнопку **Да**.

    > [WACOM.NOTE] Если появляется ошибка «Сбой настройки масштабирования для веб-сайта «\<имя веб-сайта\>», для получения дополнительных сведений можно использовать кнопку «Сведения». Может появиться сообщение об ошибке "Недостаточно доступных стандартных экземпляров серверов для удовлетворения запроса". При появлении этой ошибки обратитесь в [службу поддержки Azure][].

[][4]

## Настройка SSL

</p>
Перед выполнением действий, описанных в этом разделе, необходимо связать пользовательское доменное имя с веб-сайтом Azure. Дополнительные сведения см. в разделе [Настройка пользовательского доменного имени для веб-сайта Azure][].

1.  Откройте в браузере [портал управления Azure][портал управления].

2.  Во вкладке **Веб-сайты** щелкните имя веб-сайта и выберите вкладку **НАСТРОЙКА**.

    ![вкладка "Настройка"][]

3.  В разделе **Сертификаты** нажмите кнопку **загрузить сертификат**

    ![загрузить сертификат][]

4.  С использованием диалогового окна **загрузки сертификата** выберите файл сертификата .pfx, созданный ранее с помощью диспетчера IIS или OpenSSL. Укажите пароль, используемый для защиты файла .pfx (при наличии). В конце нажмите кнопку **проверить** для загрузки сертификата.

    ![диалоговое окно загрузки сертификата][]

5.  В разделе **привязки ssl** вкладки **НАСТРОЙКА** в раскрывающихся списках выберите имя домена для защиты с применением SSL, а также используемый сертификат. Можно также выбрать использование [подключения с указанием имени сервера][] (SNI) или SSL на основе IP.

    ![привязки ssl][]

    -   SSL на основе IP-адреса связывает сертификат с доменным именем, сопоставляя выделенный открытый IP-адрес сервера с доменным именем. Для этого необходимо, чтобы для каждого имени домена (contoso.com, fabricam.com и т. д.), связанного с вашей службой, был доступен выделенный IP-адрес. Это традиционный метод сопоставления сертификатов SSL с веб-сервером.

    -   SSL-подключения на основе SNI являются расширением SSL и [протоколом TLS][], которые позволяют нескольким доменам совместно использовать IP-адрес с отдельными сертификатами безопасности для каждого домена. Большинство современных браузеров (включая Internet Explorer, Chrome, Firefox и Opera) поддерживает SNI, однако более старые браузеры могут не поддерживать SNI. Дополнительные сведения о SNI см. в статье Википедии [Подключения с указанием имени сервера][подключения с указанием имени сервера].

6.  Чтобы сохранить изменения и активировать SSL, нажмите кнопку **Сохранить**.

> [WACOM.NOTE] Если вы выбрали вариант **SSL-подключения на основе IP-адреса** и пользовательский домен настроен с помощью записи A, необходимо выполнить следующие дополнительные действия.
>
> 1.  После настройки привязки SSL-подключения на основе IP-адреса вашему веб-сайту будет предоставлен выделенный IP-адрес. Этот IP-адрес можно найти на странице **Панель мониторинга** вашего веб-сайта в разделе **Сводка**. Он будет указан как **Виртуальный IP-адрес**:
>
>     ![Виртуальный IP-адрес][]
>
>     Обратите внимание, что этот IP-адрес будет отличаться от виртуального IP-адреса, который использовался ранее для настройки записи A для вашего домена. Если выбрано использование SSL-подключения на основе SNI или если не настроено использование SSL, для этой записи адрес указан не будет.
>
> 2.  С помощью средств, предоставляемых регистратором имени домена, измените запись A для имени пользовательского домена, указав IP-адрес из предыдущего шага.
>
На этом этапе веб-сайт должен открываться с использованием HTTPS, что подтверждает правильность настройки сертификата.

[][5]

## Сертификаты SubjectAltName (дополнительно)

</p>
OpenSSL можно использовать для создания запроса сертификата, который использует расширение SubjectAltName для поддержки нескольких имен доменов в одном сертификате, однако для этого требуется файл конфигурации. Для создания файла конфигурации выполните следующие шаги, а затем используйте этот файл для запроса сертификата.

1.  Создайте новый файл с именем **sancert.cnf**, имеющий следующее содержимое:

        # -------------- BEGIN custom sancert.cnf -----
        HOME = .
        oid_section = new_oids
        [ new_oids ]
        [ req ]
        default_days = 730
        distinguished_name = req_distinguished_name
        encrypt_key = no
        string_mask = nombstr
        req_extensions = v3_req # Extensions to add to certificate request
        [ req_distinguished_name ]
        countryName = Country Name (2 letter code)
        countryName_default = 
        stateOrProvinceName = State or Province Name (full name)
        stateOrProvinceName_default = 
        localityName = Locality Name (eg, city)
        localityName_default = 
        organizationalUnitName  = Organizational Unit Name (eg, section)
        organizationalUnitName_default  = 
        commonName              = Your common name (eg, domain name)
        commonName_default      = www.mydomain.com
        commonName_max = 64
        [ v3_req ]
        subjectAltName=DNS:ftp.mydomain.com,DNS:blog.mydomain.com,DNS:*.mydomain.com
        # -------------- END custom sancert.cnf -----

    Найдите строку, которая начинается с 'subjectAltName'. Замените указанные имена доменов на те имена доменов, которые должны поддерживаться вместе с общим именем. Например:

        subjectAltName=DNS:sales.contoso.com,DNS:support.contoso.com,DNS:fabrikam.com

    Не нужно менять значение поля commonName\_default при появлении запроса на ввод общего имени на одном из следующих этапов.

2.  Сохраните файл **sancert.cnf**.

3.  Создайте закрытый ключ и сертификат подписи запроса с помощью файла конфигурации sancert.cnf. С использованием Bash или сеанса терминала введите следующую команду:

        openssl req -new -nodes -keyout myserver.key -out server.csr -newkey rsa:2048 -config sancert.cnf

4.  При появлении запроса введите соответствующую информацию. Например:

        Country Name (2 letter code) []: US
        State or Province Name (full name) []: Washington
        Locality Name (eg, city) []: Redmond
        Organizational Unit Name (eg, section) []: Azure
        Your common name (eg, domain name) []: www.microsoft.com

    По завершении этого процесса у вас должно быть два файла; **myserver.key** и **server.csr**. Файл **server.csr** содержит запрос подписи сертификата.

5.  Отправьте запрос CSR в центр сертификации, чтобы получить SSL-сертификат. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][] на портале Microsoft TechNet Wiki.

6.  После получения сертификата от центра сертификации сохраните его в файл с именем **myserver.crt**. Если ваш центр сертификации предоставил сертификат в текстовом формате, просто вставьте текст сертификата в файл **myserver.crt**. При просмотре в текстовом редакторе файл должен иметь следующее содержимое:

        -----BEGIN CERTIFICATE-----
        MIIDJDCCAgwCCQCpCY4o1LBQuzANBgkqhkiG9w0BAQUFADBUMQswCQYDVQQGEwJV
        UzELMAkGA1UECBMCV0ExEDAOBgNVBAcTB1JlZG1vbmQxEDAOBgNVBAsTB0NvbnRv
        c28xFDASBgNVBAMTC2NvbnRvc28uY29tMB4XDTE0MDExNjE1MzIyM1oXDTE1MDEx
        NjE1MzIyM1owVDELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAldBMRAwDgYDVQQHEwdS
        ZWRtb25kMRAwDgYDVQQLEwdDb250b3NvMRQwEgYDVQQDEwtjb250b3NvLmNvbTCC
        ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAN96hBX5EDgULtWkCRK7DMM3
        enae1LT9fXqGlbA7ScFvFivGvOLEqEPD//eLGsf15OYHFOQHK1hwgyfXa9sEDPMT
        3AsF3iWyF7FiEoR/qV6LdKjeQicJ2cXjGwf3G5vPoIaYifI5r0lhgOUqBxzaBDZ4
        xMgCh2yv7NavI17BHlWyQo90gS2X5glYGRhzY/fGp10BeUEgIs3Se0kQfBQOFUYb
        ktA6802lod5K0OxlQy4Oc8kfxTDf8AF2SPQ6BL7xxWrNl/Q2DuEEemjuMnLNxmeA
        Ik2+6Z6+WdvJoRxqHhleoL8ftOpWR20ToiZXCPo+fcmLod4ejsG5qjBlztVY4qsC
        AwEAATANBgkqhkiG9w0BAQUFAAOCAQEAVcM9AeeNFv2li69qBZLGDuK0NDHD3zhK
        Y0nDkqucgjE2QKUuvVSPodz8qwHnKoPwnSrTn8CRjW1gFq5qWEO50dGWgyLR8Wy1
        F69DYsEzodG+shv/G+vHJZg9QzutsJTB/Q8OoUCSnQS1PSPZP7RbvDV9b7Gx+gtg
        7kQ55j3A5vOrpI8N9CwdPuimtu6X8Ylw9ejWZsnyy0FMeOPpK3WTkDMxwwGxkU3Y
        lCRTzkv6vnHrlYQxyBLOSafCB1RWinN/slcWSLHADB6R+HeMiVKkFpooT+ghtii1
        A9PdUQIhK9bdaFicXPBYZ6AgNVuGtfwyuS5V6ucm7RE6+qf+QjXNFg==
        -----END CERTIFICATE-----

    Сохраните файл.

7.  В командной строке, сеансе Bash или сеансе терминала используйте для преобразования файлов **myserver.key** и **myserver.crt** в **myserver.pfx** (этот формат требуется для веб-сайтов Azure) следующую команду:

        openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt

    При появлении запроса введите пароль для защиты файла .pfx.

    <div class="dev-callout"> 
<b>Примечание.</b>
<p>Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в следующем шаге. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предоставляется как PEM-файл (расширение PEM-файла).</p>
<p>Следующие команды демонстрируют процедуру создания PFX-файла, включающего в себя промежуточные сертификаты, содержащиеся в файле <b>intermediate-cets.pem</b>:</p>
<pre><code>
openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt -certfile intermediate-cets.pem
</code></pre>
</div>

    После выполнения этой команды вы должны получить файл **myserver.pfx**, который можно использовать для веб-сайтов Azure.

## <a name="bkmk_iismgr"></a>Получение сертификата с помощью диспетчера IIS (необязательно)

Если вы умеете пользоваться диспетчером IIS, можно использовать его для создания сертификата, который может использоваться с веб-сайтами Azure.

1.  Создайте запрос подписи сертификата (CSR) в диспетчере служб IIS, который будет отправлен в центр сертификации. Дополнительные сведения о создании CSR см. в разделе [Запрос сертификата службы IIS 7][].

2.  Отправьте запрос CSR в центр сертификации, чтобы получить SSL-сертификат. Список центров сертификации см. в разделе [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)][] на портале Microsoft TechNet Wiki.

3.  Для запроса CSR укажите сертификат, предоставленный центром сертификации. Дополнительные сведения о дополнении CSR см. в разделе [Установка служб IIS 7][].

4.  Если ваш центр сертификации использует промежуточные сертификаты, необходимо установить эти сертификаты перед экспортом сертификата в следующем шаге. Обычно сертификаты загружаются из центра сертификации в виде отдельных файлов и предоставляются в различных форматах для различных типов веб-серверов. Выберите версию, которая предназначена для служб Microsoft IIS.

    После загрузки сертификата щелкните на нем правой кнопкой мыши в обозревателе и выберите **Установить сертификат**. Используйте значения по умолчанию в **Мастере импорта сертификатов** и выбирайте **Далее** до завершения импорта.

5.  Экспортируйте сертификат из диспетчера IIS. Дополнительные сведения об экспорте сертификата см. в. разделе [Экспорт сертификата служб IIS 7][]. Экспортированный файл на следующих этапах будет отправляться в Azure для использования с веб-сайтом Azure.

    <div class="dev-callout"> 
<b>Примечание.</b>
<p>Во время экспорта убедитесь, что выбран параметр <strong>Да, экспортировать закрытый ключ</strong>. Это позволит включить закрытый ключ в экспортированный сертификат.</p>
</div>

    <div class="dev-callout"> 
<b>Примечание.</b>
<p>Во время экспорта убедитесь, что выбран параметр <strong>Включить все сертификаты в путь сертификации</strong> и <strong>Экспортировать все расширенные свойства</strong>. Это позволит включить в экспортированный сертификат все промежуточные сертификаты.</p>
</div>

[][6]

## Самозаверяющие сертификаты (необязательно)

</p>
В некоторых случаях может понадобиться получить сертификат для тестирования и отложить покупку сертификата у одного из доверенных ЦС до развертывания рабочей среды. В этом случае можно использовать самозаверяющие сертификаты. Самозаверяющий сертификат — это сертификат, который вы создаете и подписываете от имени центра сертификации. Хотя сертификат можно использовать для защиты веб-сайта, большинство браузеров будут возвращать ошибки при посещении сайта, поскольку сертификат не был подписан доверенным ЦС. Некоторые браузеры могут даже отказаться отображать сайт.

Существует несколько способов создания самозаверяющего сертификата. В этой статье приводится только информация об использовании способов **makecert** и **OpenSSL**.

### Создание самозаверяющего сертификата с помощью makecert

Можно создать тестовый сертификат из системы Windows с установленной программой Visual Studio. Для этого выполните следующие действия:

1.  В меню **Пуск** или на экране **Пуск** найдите **командную строку разработчика**. Щелкните правой кнопкой мыши **командную строку разработчика** и выберите **Запуск от имени администратора**.

    Если появится диалоговое окно контроля учетных записей, выберите **Да** для продолжения.

2.  В командной строке для разработчика используйте следующую команду для создания нового самозаверяющего сертификата. Необходимо заменить **serverdnsname** на DNS вашего веб-сайта.

        makecert -r -pe -b 01/01/2013 -e 01/01/2014 -eku 1.3.6.1.5.5.7.3.1 -ss My -n CN=serverdnsname -sky exchange -sp "Microsoft RSA SChannel Cryptographic Provider" -sy 12 -len 2048

    Эта команда создаст сертификат, который действует с 01.01.2013 по 01.01.2014, и сохранит расположение в хранилище сертификатов CurrentUser.

3.  В **меню "Пуск"** или **на экране "Пуск"** найдите **Windows PowerShell** и запустите это приложение.

4.  В командной строке Windows PowerShell экспортируйте созданный ранее сертификат с помощью следующих команд:

        $mypwd = ConvertTo-SecureString -String "password" -Force -AsPlainText
        get-childitem cert:\currentuser\my -dnsname serverdnsname | export-pfxcertificate -filepath file-to-export-to.pfx -password $mypwd

    При этом пароль будет сохранен в виде защищенной строки в $mypwd, затем будет найден сертификат с использованием имени DNS, указанного в параметре **dnsname**, и будет выполнен экспорт в файл, заданный параметром **filepath**. Защищенная строка, содержащая пароль, используется для защиты экспортируемого файла.

### Создание самозаверяющего сертификата с помощью OpenSSL

1.  Создайте новый документ с именем **serverauth.cnf** и со следующим содержимым:

        [ req ]
        default_bits           = 2048
        default_keyfile        = privkey.pem
        distinguished_name     = req_distinguished_name
        attributes             = req_attributes
        x509_extensions        = v3_ca

        [ req_distinguished_name ]
        countryName         = Country Name (2 letter code)
        countryName_min         = 2
        countryName_max         = 2
        stateOrProvinceName     = State or Province Name (full name)
        localityName            = Locality Name (eg, city)
        0.organizationName      = Organization Name (eg, company)
        organizationalUnitName      = Organizational Unit Name (eg, section)
        commonName          = Common Name (eg, your website's domain name)
        commonName_max          = 64
        emailAddress            = Email Address
        emailAddress_max        = 40

        [ req_attributes ]
        challengePassword       = A challenge password
        challengePassword_min       = 4
        challengePassword_max       = 20

        [ v3_ca ]
         subjectKeyIdentifier=hash
         authorityKeyIdentifier=keyid:always,issuer:always
         basicConstraints = CA:false
         keyUsage=nonRepudiation, digitalSignature, keyEncipherment
         extendedKeyUsage = serverAuth

    Это позволит указать параметры конфигурации, необходимые для создания SSL-сертификата, который может использоваться веб-сайтами Azure.

2.  Создайте новый самозаверяющий сертификат с помощью следующей команды для командной строки, bash или сеанса терминала:

        openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout myserver.key -out myserver.crt -config serverauth.cnf

    При этом создается новый сертификат с использованием параметров конфигурации, указанных в файле **serverauth.cnf**.

3.  Воспользуйтесь следующей командой, чтобы экспортировать сертификат в PFX-файл, который можно отправить на веб-сайт Azure:

        openssl pkcs12 -export -out myserver.pfx -inkey myserver.key -in myserver.crt

    При появлении запроса введите пароль для защиты файла .pfx.

    Созданный этой командой **myserver.pfx** может использоваться для защиты веб-сайта Azure при выполнении тестирования.

  [Сведения о ценах]: https://www.windowsazure.com/en-us/pricing/details/
  [Бесплатная пробная версия Microsoft Azure]: http://azure.microsoft.com/en-us/pricing/free-trial/
  []: bkmk_azurewebsites
  [1]: bkmk_domainname
  [Настройка пользовательского доменного имени для веб-сайта Azure]: /en-us/develop/net/common-tasks/custom-dns-web-site/
  [2]: bkmk_getcert
  [Программа корневого сертификата Windows и Windows Phone 8 SSL (участвующие ЦС)]: http://go.microsoft.com/fwlink/?LinkID=269988
  [OpenSSL]: http://www.openssl.org/
  [Сертификат SubjectAltName]: #bkmk_subjectaltname
  [Самозаверяющие сертификаты]: #bkmk_selfsigned
  [Получение сертификата с помощью диспетчера IIS]: #bkmk_iismgr
  [справочную документацию Certreq]: http://technet.microsoft.com/library/cc725793.aspx
  [вставить изображение диспетчера сертификатов]: ./media/configure-ssl-web-site/waws-certmgr.png
  [Экспорт закрытого ключа]: ./media/configure-ssl-web-site/waws-certwiz1.png
  [включить все сертификаты и расширенные свойства]: ./media/configure-ssl-web-site/waws-certwiz2.png
  [укажите пароль]: ./media/configure-ssl-web-site/waws-certwiz3.png
  [укажите путь к файлу]: ./media/configure-ssl-web-site/waws-certwiz4.png
  [3]: bkmk_standardmode
  [портал управления]: https://manage.windowsazure.com/
  [выбор веб-сайта]: ./media/configure-ssl-web-site/sslwebsite.png
  [Вкладка "Масштаб"]: ./media/configure-ssl-web-site/sslscale.png
  [выбран стандартный режим]: ./media/configure-ssl-web-site/sslreserved.png
  [службу поддержки Azure]: http://www.windowsazure.com/en-us/support/options/
  [4]: bkmk_configuressl
  [вкладка "Настройка"]: ./media/configure-ssl-web-site/sslconfig.png
  [загрузить сертификат]: ./media/configure-ssl-web-site/ssluploadcert.png
  [диалоговое окно загрузки сертификата]: ./media/configure-ssl-web-site/ssluploaddlg.png
  [подключения с указанием имени сервера]: http://en.wikipedia.org/wiki/Server_Name_Indication
  [привязки ssl]: ./media/configure-ssl-web-site/sslbindings.png
  [протоколом TLS]: http://en.wikipedia.org/wiki/Transport_Layer_Security
  [Виртуальный IP-адрес]: ./media/configure-ssl-web-site/staticip.png
  [5]: bkmk_subjectaltname
  [Запрос сертификата службы IIS 7]: http://technet.microsoft.com/en-us/library/cc732906(WS.10).aspx
  [Установка служб IIS 7]: http://technet.microsoft.com/en-us/library/cc771816(WS.10).aspx
  [Экспорт сертификата служб IIS 7]: http://technet.microsoft.com/en-us/library/cc731386(WS.10).aspx
  [6]: bkmk_selfsigned
