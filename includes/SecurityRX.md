#Руководство по безопасности Azure

##Аннотация

При разработке приложений для Azure, удостоверения и
доступ - это основные вопросы безопасности, о которых необходимо помнить.
В этом разделе описываются ключевые вопросы безопасности, связанные с идентификацией и доступом в облаке, а также показано, как
лучше всего защитить облачные приложения.

##Обзор

Безопасность приложения зависит от его контактной зоны. Чем она больше,
тем сложнее проблемы с безопасностью. Для
примера можно привести приложение, которое выполняется как автоматический пакетный процесс. Его
контактная зона с точки зрения безопасности меньше, чем у общедоступного веб-сайта.

При перемещении в облако можно в определенной мере не беспокоиться об
инфраструктуре и сетях, поскольку они контролируются в центрах обработки данных
с использованием рекомендаций, инструментов, технологий по обеспечению безопасности мирового уровня. С другой
стороны, облако предоставляет большую контактную зону для
приложения, которую могут использовать злоумышленники. Это связано с тем,
что многие облачные технологии и службы предоставляются как конечные точки,
а не компоненты в памяти. Хранилище Azure, Service Bus, SQL
(прежнее название - SQL Azure) и многие другие службы доступны
через их конечные точки по сети.

В облачных приложениях большая ответственность ложится на плечи
разработчиков приложений. Они должны спроектировать, разработать облачные приложения
и поддерживать их в соответствии с надежными стандартами безопасности, чтобы защититься от злоумышленников.
Рассмотрим следующую диаграмму (из PDF-документа [Примечания к безопасности
Azure](http://blogs.msdn.com/b/jmeier/archive/2010/08/03/now-available-azure-security-notes-pdf.aspx), автор Дж. Д. Майер): обратите внимание на то, как компонент инфраструктуры обрабатывается
поставщиком облака, в нашем случае Azure, оставляя больше работы
разработчикам приложений.

![Securing the application][01]

Хорошая новость состоит в том, что все рекомендации,
принципы и методы обеспечения безопасности, которые вы уже знаете, применимы при разработке
облачных приложений. Рассмотрим следующие ключевые области, которые необходимо
учитывать.

-   Для всех входных данных проверяется тип, длина, диапазон и строковые шаблоны,
    чтобы избежать атак с внедрением кода, а все данные, возвращаемые приложением,
    обрабатываются соответствующим образом.
-   Конфиденциальные данные должны быть защищены при хранении и передаче по сети,
    чтобы устранить угрозу замены данных и раскрытия информации.
-   Аудит и ведение журнала должны быть правильно реализованы для ликвидации
    угрозы неотрекаемости.
-   Проверку подлинности и авторизацию следует реализовать с помощью проверенных
    механизмов, предоставляемых платформой, для предотвращения подделки удостоверений и
    повышения привилегий злоумышленником.

Полный список угроз, атак, уязвимостей и
мер противодействия им см. в документах [Памятка: механизм
безопасности веб-приложения](http://msdn.microsoft.com/ru-ru/library/ff649461.aspx) и [Руководство по безопасности для приложений](http://msdn.microsoft.com/ru-ru/library/ff650760.aspx).

Механизмы управления доступом и проверки подлинности в облаке сильно
отличаются от тех, которые доступны для локальных приложений. В облаке
существуют многие другие варианты проверки подлинности и контроля
доступа, что может привести к путанице и в результате к неработоспособной
реализации. Еще больше путаницы возникает при определении того, что считается облачным
приложением. Например, приложение может быть развернуто в облаке, но
его механизм проверки подлинности может предоставляться службой Active Directory. С
другой стороны, приложение может быть развернуто локально, но с
механизмами проверки подлинности в облаке (например, на основе Azure
Active Directory Access Control (прежнее название - Access Control
Service или ACS)).

##Угрозы, уязвимости и атаки

Угроза - это потенциально опасный результат, которого вы хотите избежать, например
раскрытие конфиденциальной информации или недоступность службы.
Традиционно угрозы классифицируются с использованием аббревиатуры "STRIDE":

-   **С**пуфинг или кража личных данных
-   **П**одмена данных
-   **О**трицание действий
-   **Р**азглашение информации
-   **О**тказ в обслуживании
-   **П**овышение прав

Уязвимости - это ошибки, которые мы, разработчики, допускаем в коде
и из-за которых приложения могут стать жертвой злоумышленников. Например, отправка
конфиденциальных данных в виде открытого текста создает угрозу раскрытия информации
путем перехвата трафика.

Атаки - это использование таких уязвимостей для причинения вреда
приложению. Например, межсайтовые сценарии (XSS) - это
атака, использующая непроверенные выходные данные атаки. Другим примером служит
перехват данных по сети для получения учетных данных, передаваемых в незашифрованном виде. Эти
атаки также могут привести к подделке личных данных. Говоря проще,
считайте угрозы, уязвимости и атаки плохими вещами.
Рассмотрим следующие схемы как общее представление плохих вещей,
связанных с веб-приложением, развернутым в Azure (из документа
[Заметки о безопасности Windows Azure (PDF)](http://blogs.msdn.com/b/jmeier/archive/2010/08/03/now-available-azure-security-notes-pdf.aspx), автор Дж. Д. Майер (J.D. Meier)):

![Threats Vulnerabilities and Attacks][02]

Вы, как разработчик, можете контролировать уязвимости. Чем меньше
уязвимостей, тем меньше возможностей останется
у злоумышленника.

Уязвимости, связанные с удостоверениями и доступом, открывают путь ко всем
угрозам из модели STRIDE. Например, неправильно реализованный
механизм проверки подлинности может привести к подделке идентификаторов и в результате
раскрытию информации, искажению данных, повышению прав
или даже полному отключению службы. Рассмотрим следующие
вопросы, которые могут указывать на потенциальные уязвимости в реализации
доступа и удостоверений в облачном приложении:

-   Вы отправляете учетные данные службам Azure по сети в
    незашифрованном виде?
-   Вы храните учетные данные служб Azure в незашифрованном виде?
-   Ваши учетные данные служб Azure соответствуют политикам надежности
    паролей?
-   Вы полагаетесь на Azure для проверки учетных данных или
    используется собственные механизмы проверки?
-   Вы ограничиваете сеансы проверки подлинности служб Azure или срок действия токена
    для определения временного окна?
-   Вы проверяете разрешения для каждой точки входа Azure вашего
    распределенного облачного приложения?
-   Ваш механизм авторизации обрабатывает ошибки безопасно, не предоставляя
    доступа к конфиденциальным данным или неограниченного доступа?

##Меры противодействия

Лучшие меры противодействия атакам - использование механизмов идентификации
и доступа, предоставляемых платформой, вместо реализации
собственных. Рассмотрим следующие технологии идентификации и управления доступом.

**Windows Identity Foundation (WIF).** WIF - это библиотека среды выполнения .NET,
входящая в состав .NET Framework 4.5 (она доступна как отдельный
файл для загрузки для .NET 3.5 и 4.0). WIF выполняет всю тяжелую работу для обработки
протоколов, таких как WS-Federation и WS-Trust, и токенов, например
SAML, поэтому вам не потребуется писать
очень сложный код для обеспечения безопасности в приложении. Следующие
ресурсы содержат подробные сведения о WIF.

-   [Примеры Windows Identity Foundation 4.5](http://code.msdn.microsoft.com/site/search?f%5B0%5D.Type=SearchText&f%5B0%5D.Value=wif&f%5B1%5D.Type=Topic&f%5B1%5D.Value=claims-based%20authentication) в коллекции примеров кода MSDN.
-   [Средства Windows Identity Foundation 4.5 для Visual Studio 11 Beta](http://visualstudiogallery.msdn.microsoft.com/e21bf653-dfe1-4d81-b3d3-795cb104066e) в
    коллекции исходных кодов MSDN.
-   [Среда выполнения Windows Identity Foundation (.Net 3.5/4.0)](http://www.microsoft.com/ru-ru/download/details.aspx?id=17331) на портале MSDN.
-   [Примеры Windows Identity Foundation 3.5/4.0 и шаблоны Visual Studio
    2008/2010](http://www.microsoft.com/ru-ru/download/details.aspx?displaylang=en&id=4451) на портале MSDN.

**Azure AD Access Control (ранее - ACS)**. 
Azure AD Access Control - это облачная служба, которая предоставляет службу токенов безопасности
(STS) и обеспечивает федерацию с различными поставщиками удостоверений
(IdPs), такими как корпоративная служба Active Directory, или интернет-поставщиками, например
Windows Live ID или учетная запись Майкрософт, Facebook, Google, Yahoo! и Open
ID 2.0. Следующие ресурсы содержат подробные
сведения о службе Azure AD Access Control:

-   [Служба Access Control Service 2.0](http://msdn.microsoft.com/library/gg429786.aspx) 
-   [Сценарии и решения с использованием ACS](http://msdn.microsoft.com/ru-ru/library/gg185920.aspx)
-   [Практические советы по работе с сервером управления доступом](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg185939.aspx)
-   [Руководство по идентификации, основанной на утверждениях и контроле доступа](http://msdn.microsoft.com/ru-ru/library/ff423674.aspx)
-   [Учебный набор для разработчиков служб идентификации](http://www.microsoft.com/ru-ru/download/details.aspx?id=14347)
-   [Обучающий курс MSDN для разработчиков служб идентификации](http://msdn.microsoft.com/ru-ru/IdentityTrainingCourse)

**Службы федерации Active Directory (AD FS).**Active Directory
Службы федерации (AD FS) 2.0 обеспечивают поддержку решений
на основе утверждений, использующих технологии Windows Server и
Active Directory. Службы AD FS 2.0 поддерживают протоколы WS-Trust, WS-Federation
и SAML. Следующие ресурсы содержат подробные сведения о службах AD
FS:

-   [Карта содержимого AD FS 2.0](http://social.technet.microsoft.com/wiki/contents/articles/2735.ad-fs-2-0-content-map.aspx)
-   [Единый вход для интернет-решений][Единый вход для интернет-решений]
-   [Единый вход федерации для интернет-решений][Единый вход федерации для интернет-решений]

**Подписи коллективного доступа Azure.** Подписи коллективного доступа
позволяют точно настроить доступ к BLOB-объекту или контейнеру. Пример:
Следующие ресурсы содержат подробные сведения о подписях коллективного
доступа.

-   [Управление доступом к BLOB-объектам и контейнерам](http://msdn.microsoft.com/ru-ru/library/ee393343.aspx)
-   [Новые возможности хранилища: подписи коллективного доступа](http://blog.smarx.com/posts/new-storage-feature-signed-access-signatures)
-   [Подписи коллективного доступа в наши дни стали намного проще](http://blog.smarx.com/posts/shared-access-signatures-are-easy-these-days)

##Карта сценариев

В этом разделе кратко описываются ключевые сценарии, представленные в этой статье.
Используйте его как карту, чтобы определить нужное решение идентификации для вашего
приложения.

-   **Приложение веб-форм ASP.NET с федеративной проверкой подлинности.** В
    этом сценарии вы управляете доступом к приложению ASP.NET Web Forms с помощью
    интернет-удостоверения, например Live ID или учетной записи Майкрософт или
    корпоративного удостоверения, управляемого службой Windows Server Active Directory.
-   **Служба WCF (SOAP) с федеративной проверкой подлинности.**В этом
    сценарии вы управляете доступом к службе WCF (SOAP) с помощью
    Удостоверения, управляемые через контроль доступа Azure AD.
-   **Служба WCF (SOAP) с федеративной проверкой подлинности, удостоверения в
    Active Directory.** В этом сценарии вы управляете доступом к веб-службе WCF
    (SOAP) с использованием идентификаторов, управляемых корпоративной службой Windows
    Server Active Directory.
-   **Служба WCF (REST) с федеративной проверкой подлинности.**В этом
    сценарии вы управляете доступом к службе WCF (REST) с помощью
    Удостоверения, управляемые через контроль доступа Azure AD.
-   **Служба WCF (REST) с Live ID или учетной записью Майкрософт, Facebook,
    Google, Yahoo!, Open ID.** В этом сценарии вы управляете доступом к службе
    WCF (REST) с помощью интернет-удостоверения, например Live ID или
    учетной записи Майкрософт.
-   **Веб-приложение ASP.NET с REST-службой WCF с использованием общего токена SWT.** В
    этом сценарии имеется распределенное приложение с интерфейсным
    веб-приложением ASP.NET и подчиненной службой REST. При этом вы хотите передавать
    контекст пользователя через физические уровни.
-   **Авторизации доступа на основе ролей (RBAC) в приложениях и службах,
    поддерживающих утверждения.** В этом сценарии требуется реализовать
    логику авторизации в приложении на основе ролей.
-   **Авторизации на основе утверждений в приложениях и службах, поддерживающих
    утверждения.** В этом сценарии требуется реализовать логику
    авторизации в приложении на основе сложных правил авторизации.
-   **Сценарии идентификации и контроля доступа службы хранилища Azure.**В
    этом сценарии вам необходимо обеспечить безопасный общий доступ в
    BLOB-объекты и контейнеры хранилища.
-   **Сценарии идентификации и контроля доступа базы данных SQL Azure.**База
    данных SQL поддерживает только проверку подлинности SQL Server. Windows
    Проверка подлинности Windows (встроенный механизм безопасности) не поддерживается. Пользователи должны
    предоставлять учетные данные (имя входа и пароль) при каждом подключении к
    базе данных SQL.
-   **Сценарии идентификации и контроля доступа Azure Service Bus.**В этом
    сценарии требуется обеспечить безопасный доступ к очередям Azure Service Bus.
-   **Сценарии идентификации и контроля доступа для кэша в памяти.**В этом сценарии
    вам необходимо обеспечить безопасный доступ к данным, управляемым службой кэша в памяти.
-   **Сценарии идентификации и контроля доступа Azure Marketplace.**В этом
    сценарии вам необходимо обеспечить безопасный доступ к наборам данным
    Azure Marketplace.

##Сценарии идентификации и контроля доступа Azure

В этом разделе описываются распространенные сценарии идентификации и управления доступом для различных
архитектур приложений. Для быстрой ориентации используйте
карту сценариев.

###Приложение веб-форм ASP.NET с федеративной проверкой подлинности

В этом сценарии веб-приложения могут
быть развернуты в Azure или локальной среде. Требуется, чтобы
пользователи проходили проверку подлинности с помощью корпоративной службы Active Directory или
поставщиков интернет-удостоверений.

Для реализации этих сценариев используйте контроль доступа Azure AD и Windows
Identity Foundation.

![Azure Active Directory Access control][03]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Создание первого приложения ASP.NET с поддержкой утверждений с помощью ACS](http://msdn.microsoft.com/ru-ru/library/gg429779.aspx)
-   [Практическое руководство. Размещение страниц входа в веб-приложении ASP.NET](http://msdn.microsoft.com/ru-ru/library/gg185926.aspx)
-   [Практическое руководство. Реализация авторизации на основе утверждений в приложении ASP.NET с поддержкой утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185907.aspx)    
-   [Практическое руководство. Реализация доступа на основе ролей (RBAC) в приложении
    ASP.NET на основе утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185914.aspx)
-   [Практическое руководство. Настройка доверия между службой ACS и веб-приложениями ASP.NET
    с помощью сертификатов X.509](http://msdn.microsoft.com/ru-ru/library/gg185947.aspx)
-   [Пример кода: простые формы ASP.NET](http://msdn.microsoft.com/ru-ru/library/gg185938.aspx)

###Служба WCF (SOAP) с удостоверением службы

В этом сценарии может служба WCF (SOAP)
быть развернута в Azure или локальной среде. Доступ к службе осуществляется
как к подчиненной службе со стороны веб-приложения или даже другой
веб-службы. Вам необходимо контролировать доступ к службе с использованием определенного
удостоверения приложения. Это похоже на учетную запись пула приложений,
которая используется в службах IIS. Хотя технологии отличаются, эти подходы
похожи тем, что доступ к службе осуществляется на основе учетной записи области приложения,
а не учетной записи пользователя.

Используйте удостоверение службы Azure AD Access Control.
Это аналогично учетной записи пула приложений IIS, которая использовалась при
развертывании приложений на серверах Windows Server и в службах IIS. Настройте службу Azure
AD Access Control для выдачи токенов SAML, которые будут обрабатываться WIF в
службе WCF (SOAP).

![WCF (SOAP) Service][04]


Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Добавление удостоверений службы с сертификатом X.509, паролем
    или симметричным ключом](http://msdn.microsoft.com/ru-ru/library/gg185924.aspx)
-   [Практическое руководство. Проверка подлинности с помощью сертификата клиента в службе WCF
    Защищенные ACS](http://msdn.microsoft.com/ru-ru/library/hh289316.aspx)
-   [Практическое руководство. Проверка подлинности с помощью имени пользователя и пароля в службе WCF
    Защищенные ACS](http://msdn.microsoft.com/ru-ru/library/gg185954.aspx)
-   [Пример кода: проверка подлинности с использованием сертификата WCF](http://msdn.microsoft.com/ru-ru/library/gg185952.aspx)
-   [Пример кода: проверка подлинности с помощью имени пользователя WCF](http://msdn.microsoft.com/ru-ru/library/gg185927.aspx)

###Служба WCF (SOAP) с федеративной проверкой подлинности, удостоверения в Active Directory

В этом сценарии может служба WCF (SOAP)
быть развернута в Azure или локальной среде. Вам необходимо управлять доступом к
службе, используя удостоверение под управлением корпоративной службы Windows Server
Active Directory (AD).

Использование службы Azure AD Access Control, настроенной для федерации с
Windows Server AD FS. В этом случае не требуется настраивать
удостоверение службы в Azure AD Access Control. Агент, которому необходим
доступ к службе WCF (SOAP), предоставляет учетные данные службам AD FS, а после
успешной проверки подлинности выдается токен AD FS. Затем токен
передается службе Azure AD Access Control и возвращается
агенту. Агент использует токен для отправки запроса службе WCF
(SOAP).

![WCF (SOAP) Service With AD][05]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Добавление удостоверений службы с сертификатом X.509, паролем
    или симметричным ключом](http://msdn.microsoft.com/ru-ru/library/gg185924.aspx)
-   [Практическое руководство. Настройка служб AD FS 2.0 как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185961.aspx)
-   [Практическое руководство. Использование службы управления для настройки служб AD FS 2.0 как
    корпоративного поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185905.aspx)
-   [Пример кода: федеративная проверка подлинности WCF с использованием служб AD FS 2.0
](http://msdn.microsoft.com/ru-ru/library/hh127796.aspx)

###Служба WCF (REST) с удостоверениями службы

В этом сценарии ваша служба WCF (REST) может быть развернута в 
в Azure или локальной среде. Доступ к службе осуществляется как к подчиненной службе
со стороны веб-приложения или другой веб-службы. Вам необходимо управлять доступом к
службе с помощью удостоверения приложения. Это похоже на
учетную запись пула приложений, которая используется в службах IIS. Хотя технологии
различаются, подходы похожи тем, что доступ к службе осуществляется
на основе учетной записи области приложения, а не учетной записи пользователя.

Используйте удостоверение службы Azure AD Access Control.
Настройте службу Azure AD Access Control для выдачи токенов
(SWT). Для обработки токенов SWT на стороне службы REST вы можете
реализовать настраиваемый обработчик токенов и подключить его к
конвейеру WIF или можно обрабатывать их "вручную" без
инфраструктуры WIF.

Рассмотрим следующую диаграмму (WIF использовать необязательно):

![REST Service][06]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Настройка доверия между службой ACS и службой WCF с помощью симметричных
    ключей](http://msdn.microsoft.com/ru-ru/library/gg185958.aspx)
-   [Практическое руководство. Проверка подлинности REST-службы WCF, развернутой в Azure,
    с помощью ACS](http://msdn.microsoft.com/ru-ru/library/hh289317.aspx)
-   [Пример кода: веб-служба ASP.NET](http://msdn.microsoft.com/ru-ru/library/gg983271.aspx)
-   [Пример кода: приложение Windows Phone 7](http://msdn.microsoft.com/ru-ru/library/gg983271.aspx)
-   [Служба REST WCF с использованием токена SWT, выданного службой
    контроля доступа Azure (ACS)](http://code.msdn.microsoft.com/REST-WCF-With-SWT-Token-123d93c0)

###Служба WCF (REST) с Live ID или учетной записью Майкрософт, Facebook, Google, Yahoo!, Open ID

В этом сценарии ваша служба WCF (REST) может быть развернута 
в Azure или локальной среде. Вам необходимо контролировать доступ к службе с помощью общедоступного
интернет-удостоверения, например Live ID или учетной записи Майкрософт или Facebook.

Использование службы контроля доступа Azure AD для выдачи токенов SWT. Для обработки
токена SWT на стороне службы REST можно реализовать пользовательский
обработчик и подключить его к конвейеру WIF или обрабатывать его "вручную"
без инфраструктуры WIF.

Важно отметить, что для реализации этого сценария
приложение должно использовать функции управления браузера для сбора
учетных данных конечного пользователя. Это не подходит для сценариев, в которых доступ к службе REST
осуществляется со стороны веб-приложения ASP.NET. Этот вариант подходит только для
сценариев, в которых доступ к службе REST осуществляется
клиентским приложением пользователя, например приложением для Windows Phone 7 или клиентом
для настольного ПК. Главная причина для использования средств управления браузера состоит в том, что
интернет-удостоверения не поддерживают сценарии активного профиля (сценарии
веб-служб). Интернет-удостоверения в основном поддерживают сценарии пассивного профиля
(веб-приложения), зависящие от перенаправлений браузера: здесь средства управления
браузера будут полезны.

Рассмотрим следующую диаграмму (WIF использовать необязательно, поэтому она не показана):

![WIF is optional][07]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Проверка подлинности REST-службы WCF, развернутой в Azure, с помощью ACS](http://msdn.microsoft.com/ru-ru/library/hh289317.aspx)
-   [Практическое руководство. Настройка Google как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185976.aspx)
-   [Практическое руководство. Настройка Facebook как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185919.aspx)
-   [Практическое руководство. Настройка Yahoo! как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185977.aspx)
-  [Пример кода: приложение Windows Phone 7](http://msdn.microsoft.com/ru-ru/library/gg983271.aspx)
-   [Служба REST WCF с использованием токена SWT, выданного службой
    контроля доступа Azure (ACS)](http://code.msdn.microsoft.com/REST-WCF-With-SWT-Token-123d93c0)


###Веб-приложение ASP.NET с REST-службой WCF с использованием общего токена SWT

В этом сценарии имеется распределенное приложение с интерфейсным
веб-приложением ASP.NET и подчиненной службой REST. При этом вы хотите передавать
контекст пользователя через физические уровни. Это иногда требуется
при реализации логики авторизации или ведении журнала на основе
удостоверения конечного пользователя в подчиненной службе REST.

Настройка службы контроля доступа Azure AD для выдачи токенов SWT. Токен SWT
выдается интерфейсному веб-приложению ASP.NET и затем совместно используется с
подчиненной службой REST. В этом случае существует только одна проверяющая
сторона, настроенная в Azure AD Access Control. Однако есть
несколько подводных камней.

-   Поскольку WIF не предоставляет встроенный обработчик токенов SWT, вам
    необходимо реализовать пользовательский обработчик для
    веб-приложения ASP.NET. Всю тяжелую работу, связанную с
    поддержкой протокола WS-Federation на основе перенаправлений браузера, выполнит WIF,
    а не вы.
-   При реализации пользовательского обработчика токенов SWT убедитесь, что
    токен начальной загрузки сохраняется.
    В противном случае вы не сможете совместно использовать его и отправить его
    подчиненной службе REST.
-   Вам не требуется использовать WIF в службе REST. Вместо этого можно выполнить синтаксический анализ
    токена "вручную", так как нет необходимости обрабатывать
    переадресации.

![ASP.NET Web Application][08]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Настройка Google как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185976.aspx)
-   [Практическое руководство. Настройка Facebook как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185919.aspx)
-   [Практическое руководство. Настройка Yahoo! как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185977.aspx)
-   [Делегирование веб-приложения ASP.NET REST-службе WCF с использованием общего токена SWT
    токен](http://code.msdn.microsoft.com/ASPNET-Web-App-To-REST-WCF-b2b95f82)

###Управление доступом на основе ролей (RBAC) в приложениях и службах, поддерживающих утверждения

В этом сценарии необходимо реализовать авторизацию в веб-приложении
или службе на основе ролей пользователей: пользователь с требуемыми ролями получает
доступ, а пользователи без необходимых ролей - нет. Проще говоря,
ваше приложение должно ответить на простой вопрос - есть ли у пользователя роль
X?

Существует несколько способов реализации этого сценария. Вы можете использовать Azure
AD Access Control, диспетчер проверки подлинности на основе утверждений WIF,
сопоставление samlSecurityTokenRequirement или диспетчер ролей клиента.

WIF используется во всех случаях. WIF поддерживает метод IPrincipal.IsInRole(MyRole)
. В большинстве случаев главное - убедиться, что в токене есть утверждение типа роли
с URI
http://schemas.microsoft.com/ws/2008/06/identity/claims/role,
чтобы платформа WIF могла успешно проверить членство в роли при
вызове метода IsInRole.

**Контроль доступа Azure AD**. В этой реализации 
используется модуль правил преобразования утверждений AD Access Control. С помощью
модуля правил преобразования утверждений можно преобразовать любое
входящее утверждение в утверждение типа роли, чтобы после передачи токена в
приложение или службу платформа WIF могла проанализировать это утверждение роли, чтобы
успешно выполнить вызов метода IsInRole.

![][09]

**WIF ClaimsAuthenticationManager**. В этой реализации используйте
ClaimsAuthenticationManager как точку расширения WIF. С помощью этого
можно преобразовать любые входящие утверждения в тип утверждения роли
в приложении. Сложность преобразования ограничена только
написанным кодом.

![][10]

**Сопоставление samlSecurityTokenRequriement** В этой реализации используйте
конфигурацию samlSecurityTokenRequirement в файле web.config, чтобы сообщить WIF,
какие типы утверждений ведут себя как типы утверждения роли. Например, 
если токен содержит утверждение типа группы, его можно сопоставить с типом утверждения
роли. При таком подходе можно добиться только простых сопоставлений.

![][11]

**Пользовательский интерфейс RoleManager.** В этой реализации можно создать пользовательский интерфейс
RoleManger. WIF используется для проверки входящих утверждений при реализации
пользовательских методов интерфейса RoleManager, например GetAllRoles().

![][12]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Реализация доступа на основе ролей (RBAC) в приложении
    ASP.NET на основе утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185914.aspx)
-   [Практическое руководство. Реализация логики преобразования токенов с помощью правил](http://msdn.microsoft.com/ru-ru/library/gg185955.aspx)
-   [Авторизация с использованием RoleManager для веб-приложений ASP.NET (WIF)с поддержкой
    утверждений](http://blogs.msdn.com/b/alikl/archive/2010/11/18/authorization-with-rolemanager-for-claims-aware-wif-asp-net-web-applications.aspx)
-   Пример кода: использование утверждений в IsInRole в [Windows Identity Foundation
    SDK](http://www.microsoft.com/downloads/details.aspx?FamilyID=c148b2df-c7af-46bb-9162-2c9422208504)

###Авторизации на основе утверждений в приложениях и службах, поддерживающих утверждения

В этом сценарии необходимо реализовать сложную логику авторизации в
веб-приложении или службе, а метод IsInRole()
вам не подходит. Если ваш подход к авторизации
зависит от ролей, то можно реализовать управление доступом на основе ролей,
описанное в предыдущем разделе.

Использование ClaimsAuthorizationManager в качестве точки расширения WIF.
ClaimsAuthorizationManager позволяет выполнять внешние вызовы проверки доступа, чтобы
код приложения был более понятным и удобным, чем при
реализации проверки доступа в коде приложения.

![][13]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Реализация логики преобразования токенов с помощью правил](http://msdn.microsoft.com/ru-ru/library/gg185955.aspx)
-   [Практическое руководство. Реализация авторизации утверждений в веб-приложении ASP.NET
    с поддержкой утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185907.aspx)
-   Пример кода: авторизация на основе утверждений в [Windows Identity
    Foundation SDK](http://www.microsoft.com/downloads/details.aspx?FamilyID=c148b2df-c7af-46bb-9162-2c9422208504)


##Сценарии идентификации и контроля доступа службы хранилища Azure

В этом сценарии вам необходимо обеспечить безопасный общий доступ в
BLOB-объекты и контейнеры хранилища.

Использование подписей общего доступа. Для доступа к учетной записи службы хранилища
из собственного приложения используйте общий хэш, доступный через
портал Azure при настройке учетных записей службы хранилища
и управлении ими. Если требуется предоставить кому-то другому доступ к BLOB-объектам и
контейнерам в учетной записи службы хранилища, используйте
URL-адреса подписей коллективного доступа.

Особое внимание следует уделять безопасному управлению информацией, чтобы предотвратить ее
разглашение. Кроме того, обратите особое внимание на время существования
подписей общего доступа.

![][14]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Управление доступом к BLOB-объектам и контейнерам](http://msdn.microsoft.com/ru-ru/library/ee393343.aspx)
-   [Новые возможности хранилища: подписи коллективного доступа](http://blog.smarx.com/posts/new-storage-feature-signed-access-signatures)
-   [Подписи коллективного доступа в наши дни стали намного проще](http://blog.smarx.com/posts/shared-access-signatures-are-easy-these-days)


##Сценарии идентификации и контроля доступа базы данных SQL Azure

База данных SQL поддерживает только проверку подлинности SQL Server. Windows
Проверка подлинности Windows (встроенный механизм безопасности) не поддерживается. Пользователи должны
предоставлять учетные данные (имя входа и пароль) при каждом подключении к
базе данных SQL. Уделите особое внимание управлению именем пользователя и
паролем, чтобы избежать раскрытия информации.

![][15]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Рекомендации и ограничения системы безопасности (база данных SQL)](http://msdn.microsoft.com/ru-ru/library/windowsazure/ff394108.aspx#authentication)
-   [Практическое руководство. Подключение к базе данных SQL с помощью sqlcmd](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336280.aspx)
-   [Практическое руководство. Подключение к базе данных SQL с помощью ADO.NET](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336243.aspx)
-   [Практическое руководство. Подключение к базе данных SQL через ASP.NET](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee621781.aspx)
-   [Практическое руководство. Подключение к базе данных SQL через службы данных WCF](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee621789.aspx)
-  [Практическое руководство. Подключение к базе данных SQL с помощью PHP](http://msdn.microsoft.com/ru-ru/library/windowsazure/ff394110.aspx)
-   [Практическое руководство. Подключение к базе данных SQL с помощью JDBC](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg715284.aspx)
-   [Практическое руководство. Подключение к базе данных SQL с помощью ADO.NET Entity Framework](http://msdn.microsoft.com/ru-ru/library/windowsazure/ff951633.aspx)

##Сценарии идентификации и контроля доступа Azure Service Bus

Service Bus и Azure AD Access Control имеют специальную
связь, которая состоит в том, что каждое пространство имен Service Bus объединяется с
соответствующим пространством имен службы Access Control с тем же именем с
суффиксом -sb. Это вызвано тем, как
Service Bus и служба контроля доступа управляет взаимным доверием
и связанными криптографическими секретами. Дополнительные сведения
см. в ресурсах, перечисленных ниже.

![][16]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Защита Service Bus с помощью службы ACS](http://channel9.msdn.com/posts/Securing-Service-Bus-with-ACS) (видео)
-   [Защита Service Bus с помощью службы ACS](https://skydrive.live.com/view.aspx?cid=123CCD2A7AB10107&resid=123CCD2A7AB10107%211849) (слайды)
-   [Проверка подлинности и авторизация Service Bus с помощью службы контроля доступа - Access
    Control](http://msdn.microsoft.com/ru-ru/library/hh403962.aspx)

##Сценарии идентификации и контроля доступа для кэша в памяти

Служба кэша в памяти (ранее - кэш Azure) использует
Azure AD Access Control для проверки подлинности. Она использует общие ключи,
доступные на портале управления. Используйте ключи в своем коде или
в файлах конфигурации при доступе к кэшу. Храните ключи
в безопасности, чтобы избежать раскрытия информации.

![][17]


Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Настройка кэша клиента программным способом для Azure
    Caching](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg618003.aspx)
-   [Практическое руководство. Настройка клиента службы кэша с помощью файла конфигурации приложения
    для Azure Caching](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg278346.aspx)
-   [Примеры использования Azure Service Bus и Caching](http://msdn.microsoft.com/ru-ru/library/ee706741.aspx) (раздел примеров
    Caching)

##Сценарии идентификации и контроля доступа Azure Marketplace

При каждом обращении к набору данных Azure Marketplace (бесплатном или
платном) необходимо проверить подлинность пользователя перед предоставлением доступа. Если вы
создаете приложение, необходимо включить процесс проверки подлинности в
код. Рассмотрим наиболее распространенные сценарии.

###Я получаю доступ к моему набору данных

В этом сценарии вы создаете приложение, которое использует наборы данных
в подписке Marketplace. Вы являетесь пользователем приложения.
Приложение может быть развернуто в Azure, локально или в Marketplace.

Используйте общий ключ, который доступен по подписке на
Marketplace. Общий ключ можно получить с помощью портала Marketplace.

![][18]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Использование обычной проверки подлинности HTTP в приложении Marketplace](http://msdn.microsoft.com/ru-ru/library/gg193417.aspx)

###Пользователи получают доступ к моему набору данных

В этом сценарии вы создаете приложение, которое позволяет пользователям
получить доступ к набору данных. Приложение может быть развернуто в Azure,
локально или в Marketplace.

Для реализации этого сценария используйте делегирование OAuth. Пользователям будет предложено
ввести учетные данные Live ID или учетной записи Майкрософт, а затем
пройти процесс получения разрешения.

![][19]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Пример веб-клиента OAuth](http://go.microsoft.com/fwlink/?LinkId=219162)
-   [Пример полнофункционального клиента OAuth](http://go.microsoft.com/fwlink/?LinkId=219163)

###Приложение получает доступ к API Marketplace

В этом сценарии вы создаете приложение, которое получает доступ к
Marketplace API. Для успешного вызова Marketplace API требуется
проверка подлинности. Приложение развернуто в
Azure Marketplace.

![][20]

Дополнительные сведения о реализации проверки подлинности см. в комплекте публикации для
Azure Marketplace.

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Загрузка комплекта публикации приложения](http://go.microsoft.com/fwlink/?LinkId=221323)
-   [Представляем Azure Marketplace для приложений](https://datamarket.azure.com/)

##Приспособления безопасности

В этом разделе описываются механизмы безопасности для Windows Identity Foundation и
Azure AD Access Control. Используйте его в качестве базового контрольного списка
для этих технологий при разработке и развертывании приложения.

###Windows Identity Foundation

Ниже приведены основные средства безопасности WIF. Приведенные ниже сведения являются
сводкой материалов из документов [Вопросы проектирования WIF](http://msdn.microsoft.com/ru-ru/library/ee517298.aspx) и [Безопасность Windows Identity Foundation
(WIF) Security для веб-приложений ASP.NET - угрозы и меры противодействия](http://blogs.msdn.com/b/alikl/archive/2010/12/02/windows-identity-foundation-wif-security-for-asp-net-web-applications-threats-amp-countermeasures.aspx)
.

-   **IssuerNameRegistry**. Определяет доверенные службы токенов безопасности
    (STS). Убедитесь, что отображается только одна доверенная служба STS.
-   **cookieHandler requireSsl="true"**. Указывает, передаются ли
    файлы cookie сеанса по протоколу SSL.
-   **wsFederation's requireHttps="true"**. Указывает, осуществляется ли
    взаимодействие протокола федерации с поставщиком удостоверений
    по протоколу SSL.
-   **tokenReplayDetection enabled="true"**. Указывает, включена ли
    функция обнаружения воспроизведения. Помните, что эта функция
    создает сходство сервера при управлении локальными копиями используемых токенов.
-   **audienceUris**. Указывает целевую аудиторию токена. Если
    приложение получает токен, который не предназначен для приложения, оно
    будет отклонено WIF.
-   **requestValidation** и **httpRuntime requestValidationType**.
    Включает или отключает функцию проверки ASP.NET. См. инструкции
    в разделе [Интеграция с Windows Identity Foundation (WIF): обнаружено
    потенциально опасное значение Request.Form от клиента.](http://social.technet.microsoft.com/wiki/contents/articles/1725.windows-identity-foundation-wif-a-potentially-dangerous-request-form-value-was-detected-from-the-client-wresult-t-requestsecurityto.aspx)

###Контроль доступа Azure AD

Рассмотрим следующие меры безопасности в развертывании Azure AD
Access Control. Ниже приведена сводка материалов из документов [Рекомендации по безопасности службы
ACS](http://msdn.microsoft.com/ru-ru/library/gg185962.aspx) и [Рекомендации по управлению сертификатами и ключами](http://msdn.microsoft.com/ru-ru/library/hh204521.aspx).

-   **Срок действия токена STS**. Используйте портал управления Azure AD Access Control
    для установки агрессивного срока действия токена.
-   **Проверка данных при использовании URL-адреса ошибки**. Azure
    Для использования URL-адреса ошибки AD Access Control требуется анонимный доступ к
    странице приложения, на которую отправляются сообщения об ошибках. Предположим, все данные, поступающие на
    эту страницу, являются таким же опасными, как данные от ненадежного источника.
-   **Шифрование токенов для сценариев с высокой степенью конфиденциальности**. Чтобы устранить
    угрозу раскрытия информации, которые доступны в токене,
    зашифруйте токены.
-   **Шифрование файлов cookie с помощью RSA при развертывании в Azure**.
    WIF по умолчанию шифрует файлы cookie с помощью DPAPI. Платформа создает
    сходство сервера, что может привести к исключениям при развертывании в веб-ферме и
    средах Azure. Вместо этого используйте RSA для веб-ферм и 
    Azure.
-   **Сертификаты подписи токенов**. Обновляйте сертификаты подписи токенов
    периодически, чтобы предотвратить отказ в обслуживании. Azure AD Access
    подписывает все выдаваемые маркеры (токены) безопасности. Сертификаты X.509
    используются для подписи при построении приложения, которое использует токены SAML,
    выданные ACS. После истечения срока действия сертификатов подписи
    при попытке получить токен (маркер) будут возникать ошибки.
-   **Ключи подписи токенов**. Обновляйте ключи подписи токена (маркера) периодически, чтобы
    предотвратить отказ в обслуживании. Azure AD Access Control подписывает все
    выдаваемые маркеры (токены) безопасности. 256-разрядные симметричные ключи подписывания используются
    при построении приложения, которое применяет токены (маркеры) SWT, выданные
    ACS. Когда срок действия ключей подписи истекает, при попытке получить
    токен будут возникать ошибки.
-   **Сертификаты шифрования токенов**. Обновляйте
    сертификаты периодически, чтобы предотвратить отказ в обслуживании. Шифрование токенов
    необходимо, если приложение проверяющей стороны является
    веб-службой, которая использует токены доказательства владения по протоколу WS-Trust.
    В других случаях шифрование маркеров (токенов) необязательно. После истечения срока действия
    сертификатов шифрование при попытке получить токен будут возникать
    ошибки.
-   **Сертификаты расшифровки токенов**. Обновляйте
    сертификаты периодически, чтобы предотвратить отказ в обслуживании. Azure
    Служба AD Access Control может принимать зашифрованные токены от
    поставщиков удостоверений WS-Federation (например, AD FS 2.0). Для расшифровки используется сертификат X.509,
    размещенный в Azure AD Access Control.
    Когда срок действия сертификатов расшифровки истекает,
    при попытке получить токен будут возникать ошибки.
-   **Учетные данные удостоверения службы**. Обновляйте учетные данные удостоверения службы
    периодически, чтобы предотвратить отказ в обслуживании. Удостоверения службы используют
    учетные данные, настроенные глобально для пространства имен Azure AD
    Access Control, которое позволяет приложениям или клиентам
    проходить проверку подлинности непосредственно в Azure AD Access Control и
    получать токен (маркер). Существует три типа учетных данных, с которыми
    можно связать удостоверение службы Azure AD Access Control: симметричный
    ключ, пароль и сертификат X.509. Вы начнете получать
    исключения после истечения срока действия учетных данных.
-   **Учетные данные учетной записи службы управления
    Azure AD Access Control**. Обновляйте учетные данные службы управления периодически, чтобы
    предотвратить отказ в обслуживании. Служба управления Azure AD Access Control -
    это ключевой компонент, который позволяет
    программно настраивать параметры 
    пространства имен Azure AD Access Control и управлять ими. Существует три типа учетных данных,
    с которыми можно связать учетную запись службы управления. Это
    симметричный ключ, пароль и сертификат X.509. Вы начнете
    получать исключения после истечения срока действия учетных данных.
-   **Сертификаты подписи и шифрования поставщика удостоверений
    WS-Federation**. Запрашивайте сведения о сроке действия сертификата поставщика удостоверений WS-Federation,
    чтобы избежать отказа в обслуживании. Сертификат
    поставщика удостоверений WS-Federation доступен через его метаданные.
    При настройке поставщика удостоверений WS-Federation, например служб федерации Active Directory,
    сертификат подписи WS-Federation настраивается с помощью
    метаданных WS-Federation, доступных по URL-адресу или в файле. После
    настройки поставщика удостоверений WS-Federation используйте
    службу управления Azure AD Access Control для запроса сведений о действии
    сертификатов. Когда срок действия сертификата закончится, вы начнете получать
    исключения.

##Совместное размещение с помощью веб-сайтов Azure

Все сценарии и решения, описанные в этом разделе, допустимы, если
приложение размещено на веб-сайтах Azure.

##Виртуальные машины Azure

Все сценарии и решения, описанные в этом разделе, допустимы, если
приложение размещено на виртуальных машинах Azure.

##Ресурсы

-   [Учебный набор для разработчиков служб идентификации](http://go.microsoft.com/fwlink/?LinkId=214555)
-   [Обучающий курс MSDN для разработчиков служб идентификации](http://go.microsoft.com/fwlink/?LinkId=214561)
-   [Руководство по идентификации, основанной на утверждениях и контроле доступа](http://go.microsoft.com/fwlink/?LinkId=214562)
-   [Служба контроля доступа](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg429786.aspx)
-   [Практические советы по работе с сервером управления доступом](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg185939.aspx)
-   [Защита веб-приложения ASP.NET с веб-ролью Azure средствами службы управления доступом 2.0](http://social.technet.microsoft.com/wiki/contents/articles/2590.aspx)
-   [Ученые видеофильмы по серверу управления доступом (ACS) Azure AD](http://social.technet.microsoft.com/wiki/contents/articles/2777.aspx)
-   [Жизненный цикл разработки средств безопасности Майкрософт](http://www.microsoft.com/security/sdl/default.aspx)
-   [Средство моделирования угроз SDL Threat Modeling Tool 3.1.8](http://www.microsoft.com/download/en/details.aspx?displaylang=en&id=2955)
-   [Блоги, посвященные безопасности и конфиденциальности](http://www.microsoft.com/about/twc/en/us/blogs.aspx)
-   [Центр Security Response Center](http://www.microsoft.com/security/msrc/default.aspx)
-   [Отчет службы безопасности](http://www.microsoft.com/security/sir/)
-   [Жизненный цикл разработки средств безопасности](http://www.microsoft.com/security/sdl/default.aspx)
-   [Центр разработчиков средств безопасности (MSDN)](http://msdn.microsoft.com/security/)


[01]:./media/SecurityRX/01_SecuringTheApplication.gif
[02]:./media/SecurityRX/02_ThreatsVulnerabilitiesandAttacks.gif
[03]:./media/SecurityRX/03_WindowsAzureADAccesscontrol.gif
[04]:./media/SecurityRX/04_WCF(SOAP)Service.gif
[05]:./media/SecurityRX/05_AzureADAccessControl.gif
[06]:./media/SecurityRX/06_RESTService.gif
[07]:./media/SecurityRX/07_WIFisOptional.gif
[08]:./media/SecurityRX/08_ASPNETWebApptoREST.gif
[09]:./media/SecurityRX/09_RBAC.gif
[10]:./media/SecurityRX/10_WIFClaimsAuthenticationManager.gif
[11]:./media/SecurityRX/11_SecurityTokenRequriementmapping.gif
[12]:./media/SecurityRX/12_CustomRoleManager.gif
[13]:./media/SecurityRX/13_ClaimsAuthorizationManager.gif
[14]:./media/SecurityRX/14_WindowsAzurestorage.gif
[15]:./media/SecurityRX/15_SQLAzureIdentityandAccessScenarios.gif
[16]:./media/SecurityRX/16_WindowsAzureServiceBusIdentity.gif
[17]:./media/SecurityRX/17_WindowsAzureCacheIdentity.gif
[18]:./media/SecurityRX/18_IAccessMyDataset.gif
[19]:./media/SecurityRX/19_UsersAccessMyDatasets.gif
[20]:./media/SecurityRX/20_ApplicationAccessMarketplaceAPI.gif

[Проектирование единого входа в Интернете]: http://technet.microsoft.com/ru-ru/library/dd807033(WS.10).aspx
[Проектирование федеративного единого входа в Интернете]: http://technet.microsoft.com/ru-ru/library/dd807050(WS.10).aspx
