#Руководство по безопасности Azure

##Аннотация

При разработке приложений для Azure удостоверения и доступ - это основные вопросы безопасности, о которых необходимо помнить. В этом разделе описываются ключевые вопросы безопасности, связанные с идентификацией и доступом в облаке, а также способы защиты облачных приложений.

##Обзор

Безопасность приложения зависит от его контактной зоны. Чем более явно выступает поверхность приложения, тем важнее проблемы с безопасностью.. Например, приложение автоматически и неявно обрабатывает одинаковый ряд процессов на общедоступном с точки зрения безопасности веб-сайте.

При переходе в облако можно меньше беспокоиться об инфраструктуре и сетях, так как они управляются в центрах обработки данных с использованием механизмов, средств и технологий безопасности мирового уровня. С другой стороны, облако предоставляет большую контактную зону для приложения, которая может быть использована злоумышленниками. Это происходит потому, что множество облачных технологий и служб представляются как конечные точки, а не компоненты в памяти. Хранилище Azure, служебная шина, база данных SQL
(ранее SQL Azure) и многие другие службы доступны через их конечные точки по сети.

В облачных приложениях на плечи разработчиков приложений ложится больше нагрузки, связанной с проектированием, разработкой и поддержкой облачных приложений в соответствии со стандартами безопасности высокого уровня для защиты от злоумышленников. Рассмотрим следующую схему ([Заметки о безопасности Azure (PDF)](http://blogs.msdn.com/b/jmeier/archive/2010/08/03/now-available-azure-security-notes-pdf.aspx)автор Дж. Д. Майер (J.D. Meier)): обратите внимание на то, как поставщик облака обращается к части инфраструктуры (в данном случае Azure), оставляя работу с безопасностью приложений разработчикам приложений:

![Securing the application][01]

Хорошие новости: все уже известные вам рекомендации, принципы и методы по обеспечению безопасности по-прежнему применимы при разработке облачных приложений. Рассмотрим следующие ключевые области, которые необходимо учитывать.

-   Для всех входных данных проверяется тип, длина, диапазон и строковые шаблоны, чтобы предотвратить атаки с внедрением кода, а все данные, возвращаемые приложением, должны быть соответствующим образом проверены.
-   Конфиденциальные данные должны быть защищены при хранении и передаче по сети для снижения угрозы подмены данных и раскрытия информации.
-   Аудит и ведение журнала должны быть правильно реализованы для ликвидации угрозы отрицания авторства.
-   Проверка подлинности и авторизация должны быть реализованы с помощью проверенных механизмов, предоставляемых платформой, для предотвращения подделки удостоверений и повышения привилегий.

Полный список угроз, атак, уязвимостей и контрмер см. в документах [Памятка: механизм безопасности веб-приложения](http://msdn.microsoft.com/ru-ru/library/ff649461.aspx) и [Руководство по безопасности для приложений](http://msdn.microsoft.com/ru-ru/library/ff650760.aspx).

В облаке механизмы управления доступом и проверки подлинности сильно отличаются от доступных для локальных приложений. Для облачных приложений доступно гораздо больше вариантов проверки подлинности и управления доступом, что может привести к путанице и в результате изъянам реализации. Еще больше путаницы возникает при определении того, что считается облачным приложением. Например, приложение может быть развернуто в облаке, но его механизм проверки подлинности может быть предоставлен службой каталогов Active Directory. С другой стороны, приложение может быть развернуто локально, а механизмы проверки подлинности  - находиться в облаке (например, контроль доступа Azure AD, ранее служба Access Control или ACS).

##Угрозы, уязвимости и атаки

Угроза - это потенциально опасный результат, которого вы хотите избежать, например, раскрытие конфиденциальной информации или выход службы из строя. Традиционно угрозы классифицируются с использованием аббревиатуры "STRIDE":

-   **С**пуфинг или кража удостоверений
-   **П**одмена данных
-   **О**трицание действий
-   **Р**азглашение информации
-   **О**тказ в обслуживании
-   **П**овышение прав

Уязвимости - это ошибки, которые мы, как разработчики, допускаем в коде и которые позволяют злоумышленникам атаковать приложение. Например, отправка конфиденциальных данных в незашифрованном виде представляет угрозу раскрытия информации за счет перехвата трафика.

Атаки - использование таких уязвимостей для причинения вреда приложению. Например, межсайтовые сценарии (XSS) - это атаки, использующие непроверенные выходные данные. Другим примером служит перехват данных по сети для получения учетных данных, передаваемых в незашифрованном виде. Эти атаки также могут привести к подделке удостоверений. Для простоты считайте угрозы, уязвимости и атаки плохими вещами.
Рассмотрим следующие схемы как общее представление плохих вещей, связанных с веб-приложением, развернутым в Azure (из документа
[Заметки о безопасности Azure (PDF)](http://blogs.msdn.com/b/jmeier/archive/2010/08/03/now-available-azure-security-notes-pdf.aspx), автор Дж. Д. Майер (J.D. Meier)):

![Threats Vulnerabilities and Attacks][02]

Вы, как разработчик, можете контролировать уязвимости. Чем меньше уязвимостей вы вносите, тем меньше возможностей у злоумышленников.

Уязвимости, связанные с идентификацией и доступом, позволяют реализовать все угрозы из модели STRIDE. Например, неправильно реализованный механизм проверки подлинности может привести к подделке удостоверений и в результате раскрытию информации, подмене данных, выполнению операций с повышенными правами или даже полному отключению службы. Рассмотрим следующие вопросы, которые помогут определить потенциальные уязвимости в реализации механизмов удостоверений и доступа в вашем облачном приложении.

-   Вы отправляете учетные данные службам Azure по сети в незашифрованном виде?
-   Вы храните учетные данные служб Azure в незашифрованном виде?
-   Ваши учетные данные служб Azure соответствуют политикам надежности паролей?
-   Вы полагаетесь на Azure для проверки учетных данных или используете собственные механизмы проверки?
-   Вы ограничиваете срок действия сеансов проверки подлинности или токенов безопасности служб Azure приемлемым временным окном?
-   Вы проверяете разрешения для каждой точки входа Azure вашего распределенного приложения?
-   При возникновении ошибки ваш механизм авторизации не раскрывает конфиденциальную информацию и не предоставляет неограниченный доступ?

##Меры противодействия

Лучшие меры противодействия атакам - это использование механизмов удостоверений и доступа, предоставляемых платформой вместо механизмов собственной реализации. Рассмотрим следующие технологии идентификации и управления доступом:

**Windows Identity Foundation (WIF).** WIF - это библиотека среды выполнения .NET, входящая в состав .NET Framework 4.5 (также доступна отдельно для скачивания для версий .NET 3.5 и 4.0). WIF выполняет всю тяжелую работу по обработке протоколов, таких как WS-Federation и WS-Trust, и токенов, например, Security Assertion Markup Language (SAML), поэтому вам не нужно писать сложный код безопасности в приложении. Следующие ресурсы содержат подробные сведения о WIF:

-   [Примеры Windows Identity Foundation 4.5](http://code.msdn.microsoft.com/site/search?f%5B0%5D.Type=SearchText&f%5B0%5D.Value=wif&f%5B1%5D.Type=Topic&f%5B1%5D.Value=claims-based%20authentication) в коллекции примеров кода MSDN.
-   [Средства Windows Identity Foundation 4.5 для Visual Studio 11 Beta](http://visualstudiogallery.msdn.microsoft.com/e21bf653-dfe1-4d81-b3d3-795cb104066e) в коллекции примеров кода MSDN.
-   [Среда выполнения Windows Identity Foundation (.Net 3.5/4.0)](http://www.microsoft.com/ru-ru/download/details.aspx?id=17331) на портале MSDN.
-   [Примеры Windows Identity Foundation 3.5/4.0 и шаблоны Visual Studio 2008/2010 templates](http://www.microsoft.com/ru-ru/download/details.aspx?displaylang=en&id=4451) на портале MSDN.

**Контроль доступа Azure AD (ранее ACS)**. 
Контроль доступа Azure AD - это облачная служба, которая реализует службу токенов безопасности (STS) и обеспечивает федерацию с разными поставщиками удостоверений, такими как корпоративная служба Active Directory или интернет-поставщики удостоверений, например Windows Live ID, учетная запись Майкрософт, Facebook, Google, Yahoo! и Open ID 2.0. Следующие ресурсы содержат подробные сведения о контроле доступа Azure AD:

-   [Служба контроля доступа 2.0](http://msdn.microsoft.com/library/gg429786.aspx) 
-   [Сценарии и решения с использованием ACS](http://msdn.microsoft.com/ru-ru/library/gg185920.aspx)
-   [Практические советы по работе с ACS](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg185939.aspx)
-   [Руководство по удостоверениям на основе утверждений и контролю доступа](http://msdn.microsoft.com/ru-ru/library/ff423674.aspx)
-   [Учебный набор для разработчиков служб удостоверений](http://www.microsoft.com/ru-ru/download/details.aspx?id=14347)
-   [Обучающий курс MSDN для разработчиков служб удостоверений](http://msdn.microsoft.com/ru-ru/IdentityTrainingCourse)

**Службы федерации Active Directory (AD FS).**Службы федерации Active Directory (AD FS) 2.0 поддерживают решения удостоверений на основе утверждений, которые используют технологии Windows Server и Active Directory. Службы AD FS 2.0 поддерживают протоколы WS-Trust, WS-Federation и SAML. Следующие ресурсы содержат подробные сведения о службах AD FS:

-   [Карта содержимого AD FS 2.0](http://social.technet.microsoft.com/wiki/contents/articles/2735.ad-fs-2-0-content-map.aspx)
-   [Единый вход для интернет-решений][Единый вход для интернет-решений]
-   [Единый вход федерации для интернет-решений][Единый вход федерации для интернет-решений]

**Подписанные URL-адреса Azure.** Подписанные URL-адреса позволяют настроить доступ к BLOB-объекту или ресурсу контейнера. Подробные сведения о подписанных URL-адресах доступа представлены в следующих ресурсах.
доступа.

-   [Управление доступом к BLOB-объектам и контейнерам](http://msdn.microsoft.com/ru-ru/library/ee393343.aspx)
-   [Новые возможности хранилища: подписанные URL-адреса](http://blog.smarx.com/posts/new-storage-feature-signed-access-signatures)
-   [Подписанные URL-адреса в наши дни стали намного проще](http://blog.smarx.com/posts/shared-access-signatures-are-easy-these-days)

##Карта сценариев

В этом разделе кратко описываются ключевые сценарии, представленные в этой статье. Используйте его как карту, чтобы определить нужное решение удостоверения для вашего приложения.

-   **Приложение веб-форм ASP.NET с федеративной проверкой подлинности.** В этом сценарии вы управляете доступом к приложению веб-форм ASP.NET с помощью интернет-удостоверения, например Live ID или учетной записи Майкрософт, или корпоративного удостоверения, контролируемого Windows Server Active Directory.
-   **Служба WCF (SOAP) с федеративной проверкой подлинности.**В этом сценарии вы управляете доступом к службе WCF (SOAP) с помощью удостоверений службы, контролируемых службой контроля доступа Azure AD.
-   **Служба WCF (SOAP) с федеративной проверкой подлинности, удостоверения в Active Directory.** В этом сценарии вы управляете доступом к веб-службы WCF (SOAP) с помощью удостоверений, управляемых корпоративной службой Windows Server Active Directory.
-   **Служба WCF (REST) с федеративной проверкой подлинности.**В этом сценарии вы управляете доступом к службе WCF (REST) с помощью удостоверений службы, управляемых службой контроля доступа Azure AD.
-   **Служба WCF (REST) с Live ID или учетной записью Майкрософт, Facebook, Google, Yahoo!, Open ID.** В этом сценарии вы управляете доступом к службе WCF (REST) с помощью интернет-удостоверений, например Live ID или учетной записи Майкрософт.
-   **Веб-приложение ASP.NET с REST-службой WCF с использованием общего токена SWT.** В этом сценарии имеется распределенное приложение, состоящее из интерфейсного веб-приложения ASP.NET и подчиненной службы REST. Вам требуется передавать контекст пользователя через физические уровни.
-   **Управление доступом на основе ролей (RBAC) в приложениях и службах, поддерживающих утверждения.** В этом сценарии вы можете реализовать логику авторизации в приложении на основе правил авторизации.
-   **Авторизации на основе утверждений в приложениях и службах, поддерживающих утверждения.** В этом сценарии вы можете реализовать логику авторизации в приложении на основе комплексных правил авторизации.
-   **Сценарии удостоверений и контроля доступа для службы хранилища Azure.**В этом сценарии вы должны реализовать безопасный общий доступ к контейнерам и BLOB-объектам хранилища Azure.
-   **Сценарии удостоверений и контроля доступа базы данных SQL Azure.**База данных SQL поддерживает только проверку подлинности SQL Server. Проверка подлинности Windows (встроенный механизм безопасности) не поддерживается. Пользователи должны предоставлять учетные данные (имя входа и пароль) при каждом подключении к базе данных SQL.
-   **Сценарии удостоверений и контроля доступа служебной шины Azure.**В этом сценарии вы должны предоставлять безопасный доступ к очередям служебной шины Azure.
-   **Сценарии удостоверений и контроля доступа для кэша в памяти.**В этом сценарии необходимо предоставлять безопасный доступ к данным, управляемым службой кэша в памяти.
-   **Сценарии удостоверений и контроля доступа Azure Marketplace.**В этом сценарии вы должны предоставлять безопасный доступ к наборам данных Azure Marketplace.

##Сценарии идентификации и контроля доступа Azure

В этом разделе описываются распространенные сценарии удостоверений и управления доступом для различных архитектур приложений. Для быстрой ориентации используйте карту сценариев.

###Приложение веб-форм ASP.NET с федеративной проверкой подлинности

В этом варианте архитектуры ваше веб-приложение может быть развернуто в Azure или локально. Пользователи приложения должны проходить проверку подлинности корпоративной службы Active Directory или
поставщиков интернет-удостоверений.

Для реализации этих сценариев используйте контроль доступа Azure AD и Windows Identity Foundation.

![Azure Active Directory Access control][03]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Создание первого приложения ASP.NET с поддержкой утверждений с помощью ACS](http://msdn.microsoft.com/ru-ru/library/gg429779.aspx)
-   [Практическое руководство. Размещение страниц входа в веб-приложении ASP.NET](http://msdn.microsoft.com/ru-ru/library/gg185926.aspx)
-   [Практическое руководство. Реализация авторизации на основе утверждений в приложении ASP.NET с поддержкой утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185907.aspx)    
-   [Практическое руководство. Реализация управления доступом на основе ролей (RBAC) в приложении ASP.NET с поддержкой утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185914.aspx)
-   [Практическое руководство. Настройка доверия между службой ACS и веб-приложениями ASP.NET с помощью сертификатов X.509](http://msdn.microsoft.com/ru-ru/library/gg185947.aspx)
-   [Пример кода: простые формы ASP.NET](http://msdn.microsoft.com/ru-ru/library/gg185938.aspx)

###Служба WCF (SOAP) с удостоверением службы

В этом сценарии ваша служба WCF (SOAP) может быть развернута в Azure или локально. Доступ к службе осуществляется как к подчиненной службе через веб-приложение или другую веб-службу. Вам необходимо контролировать доступ к службе с использованием определенного удостоверения приложения. Его можно сравнить с учетной записью пула приложений, используемой в службах IIS. Хотя технологии различаются, подходы схожи в том, что доступ к службе осуществляется с помощью учетной записи приложения, а не учетной записи конечного пользователя.

Используйте удостоверение службы Azure AD Access Control. Это похоже на учетную запись пула приложений IIS, которая используется при развертывании приложений в Windows Server и службах IIS. Настройте службу контроля доступа Azure
AD для выдачи токенов SAML, которые будут обрабатываться WIF в службе WCF (SOAP).

![WCF (SOAP) Service][04]


Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Добавление удостоверений службы с сертификатом X.509, паролем или симметричным ключом](http://msdn.microsoft.com/ru-ru/library/gg185924.aspx)
-   [Практическое руководство. Проверка подлинности с помощью сертификата клиента в службе WCF, защищенной ACS](http://msdn.microsoft.com/ru-ru/library/hh289316.aspx)
-   [Практическое руководство. Проверка подлинности с помощью имени пользователя и пароля в службе WCF, защищенной ACS](http://msdn.microsoft.com/ru-ru/library/gg185954.aspx)
-   [Пример кода: проверка подлинности с помощью сертификата WCF](http://msdn.microsoft.com/ru-ru/library/gg185952.aspx)
-   [Пример кода: проверка подлинности с помощью имени пользователя WCF](http://msdn.microsoft.com/ru-ru/library/gg185927.aspx)

###Служба WCF (SOAP) с федеративной проверкой подлинности, удостоверения в Active Directory

В этом сценарии ваша служба WCF (SOAP) может быть развернута в Azure или локально. Вам необходимо управлять доступом к ней, используя удостоверение, контролируемое корпоративной службой Windows Server
Active Directory (AD).

Использование службы Azure AD Access Control, настроенной для федерации с
Windows Server AD FS. В этом случае не требуется настраивать
удостоверение службы в Azure AD Access Control. Агент, которому необходим доступ к службе WCF (SOAP), предоставляет учетные данные службам AD FS и после успешной проверки подлинности получает от AD FS токен. Затем токен отправляется службе контроля доступа Azure AD и возвращается агенту. Агент использует токен для отправки запроса службе WCF (SOAP).

![WCF (SOAP) Service With AD][05]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Добавление удостоверений службы с сертификатом X.509, паролем или симметричным ключом](http://msdn.microsoft.com/ru-ru/library/gg185924.aspx)
-   [Практическое руководство. Настройка служб AD FS 2.0 как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185961.aspx)
-   [Практическое руководство. Использование службы управления для настройки служб AD FS 2.0 как корпоративного поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185905.aspx)
-   [Пример кода: федеративная проверка подлинности WCF с использованием служб AD FS 2.0
](http://msdn.microsoft.com/ru-ru/library/hh127796.aspx)

###Служба WCF (REST) с удостоверениями службы

В этом сценарии ваша служба WCF (REST) может быть развернута в Azure или локально. Доступ к службе осуществляется как к подчиненной службе через веб-приложение или другую веб-службу. Вам необходимо управлять доступом к ней с помощью удостоверения приложения. Его можно сравнить с учетной записью пула приложений, используемой в службах IIS. Хотя технологии различаются, подходы схожи в том, что доступ к службе осуществляется с помощью учетной записи приложения, а не учетной записи пользователя.

Используйте удостоверение службы Azure AD Access Control. Настройка контроля доступа Azure AD для выдачи токенов SWT. Для обработки токенов SWT на стороне службы REST можно реализовать настраиваемый обработчик токенов и подключить его к конвейеру WIF или "вручную" проанализировать его без использования инфраструктуры WIF.

Рассмотрим следующую диаграмму (WIF использовать необязательно):

![REST Service][06]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Настройка доверия между службой ACS и службой WCF с помощью симметричных ключей](http://msdn.microsoft.com/ru-ru/library/gg185958.aspx)
-   [Практическое руководство. Проверка подлинности REST-службы WCF, развернутой в Azure, с помощью ACS](http://msdn.microsoft.com/ru-ru/library/hh289317.aspx)
-   [Пример кода: веб-служба ASP.NET](http://msdn.microsoft.com/ru-ru/library/gg983271.aspx)
-   [Пример кода: приложение Windows Phone 7](http://msdn.microsoft.com/ru-ru/library/gg983271.aspx)
-   [Служба REST WCF с токеном SWT, выданным службой контроля доступа Azure (ACS)](http://code.msdn.microsoft.com/REST-WCF-With-SWT-Token-123d93c0)

###Служба WCF (REST) с Live ID или учетной записью Майкрософт, Facebook, Google, Yahoo!, Open ID

В этом сценарии ваша служба WCF (REST) может быть развернута в Azure или локально. Вам необходимо управлять доступом к ней, используя общедоступное интернет-удостоверение, например Live ID, учетную запись Майкрософт или Facebook.

Используйте службу контроля доступа Azure AD для выдачи токенов SWT. Для обработки
токенов SWT на стороне службы REST можно реализовать настраиваемый обработчик токенов и подключить его к конвейеру WIF или "вручную" проанализировать его без использования инфраструктуры WIF.

Важно отметить, что для реализации этого сценария приложение должно использовать функции управления браузером для получения учетных данных конечного пользователя. Из-за этого сценарии, в которых доступ к службе REST осуществляется из веб-приложения ASP.NET, не поддерживаются. Такой подход применим только для сценариев, в которых доступ к службе REST осуществляется клиентским приложением пользователя, например, приложением Windows Phone 7 или полнофункциональным клиентом для настольных ПК. Главная причина для использования средств управления браузера в том, что интернет-удостоверения не поддерживают сценарии с активным профилем (сценарии веб-служб). Интернет-удостоверения, в основном, поддерживают сценарии пассивного профиля (веб-приложения), зависящие от перенаправлений браузера: здесь средства управления браузера могут пригодиться.

Рассмотрим следующую диаграмму (WIF использовать необязательно, поэтому она не показана):

![WIF is optional][07]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Проверка подлинности REST-службы WCF, развернутой в Azure, с помощью ACS](http://msdn.microsoft.com/ru-ru/library/hh289317.aspx)
-   [Практическое руководство. Настройка Google как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185976.aspx)
-   [Практическое руководство. Настройка Facebook как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185919.aspx)
-   [Практическое руководство. Настройка Yahoo! как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185977.aspx)
-  [ Пример кода: приложение Windows Phone 7](http://msdn.microsoft.com/ru-ru/library/gg983271.aspx)
-   [Служба REST WCF с токеном SWT, выданным службой контроля доступа Azure (ACS)](http://code.msdn.microsoft.com/REST-WCF-With-SWT-Token-123d93c0)


###Веб-приложение ASP.NET с REST-службой WCF с использованием общего токена SWT

В этом сценарии имеется распределенное приложение с интерфейсным
Веб-приложению ASP.NET и подчиненной службе REST, как и вам, требуется сохранить контекст пользователя на физических уровнях. Иногда это необходимо при реализации логики авторизации или ведения журнала на основе удостоверения конечного пользователя в подчиненной службе REST.

Настройка службы контроля доступа Azure AD для выдачи токенов SWT. Токен SWT выдается интерфейсному веб-приложению ASP.NET, а затем предоставляется подчиненной службе REST. В этом случае в службе контроля доступа Azure AD настраивается только одна проверяющая сторона. Однако существует ряд особенностей.

-   Так как WIF не предоставляет встроенный обработчик токенов SWT, необходимо реализовать пользовательский обработчик для веб-приложения ASP.NET. Воспользуйтесь встроенными возможностями поддержки протокола WS-Federation в WIF, которые основаны на перенаправлениях браузера, а не взваливайте всю тяжелую работу на себя.
-   При реализации пользовательского обработчика токенов SWT, убедитесь, что токен начальной загрузки обрабатывается и сохраняется. В противном случае вы не сможете совместно использовать его и отправить его подчиненной службе REST.
-   Не нужно использовать WIF в службе REST. Вместо этого можно проанализировать токен "вручную", так как в данном случае нет необходимости обрабатывать перенаправления.

![ASP.NET Web Application][08]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Настройка Google как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185976.aspx)
-   [Практическое руководство. Настройка Facebook как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185919.aspx)
-   [Практическое руководство. Настройка Yahoo! как поставщика удостоверений](http://msdn.microsoft.com/ru-ru/library/gg185977.aspx)
-   [Делегирование веб-приложения ASP.NET REST-службе WCF с использованием общего токена SWT](http://code.msdn.microsoft.com/ASPNET-Web-App-To-REST-WCF-b2b95f82)

###Управление доступом на основе ролей (RBAC) в приложениях и службах, поддерживающих утверждения

В этом сценарии необходимо реализовать авторизацию в веб-приложении или службе на основе ролей пользователей: пользователи с необходимыми ролями получают доступ, а пользователи без нужных ролей - нет. Проще говоря, ваше приложение должно ответить на простой вопрос. Есть ли у пользователя роль
X?

Существует несколько способов реализации этого сценария. Можно использовать службу контроля доступа Azure AD, диспетчер проверки подлинности утверждений WIF, сопоставление samlSecurityTokenRequirement или диспетчер ролей клиента.

WIF используется во всех случаях. WIF поддерживает метод IPrincipal.IsInRole("MyRole"). В большинстве случаев необходимо убедиться, что в токене есть утверждение о типе роли с универсальным кодом ресурса http://schemas.microsoft.com/ws/2008/06/identity/claims/role, чтобы служба WIF могла успешно проверить членство в роли при вызове метода IsInRole.

**Контроль доступа Azure AD**. В этой реализации используется модуль правил преобразования утверждений службы контроля доступа Azure AD. С помощью этого модуля можно преобразовать любое входящее утверждение в утверждение типа роли, чтобы после поступления токена в приложение или службу WIF могла проанализировать это утверждение роли для успешного вызова метода IsInRole.

![][09]

**WIF ClaimsAuthenticationManager**. Эта реализация использует ClaimsAuthenticationManager как точку расширения WIF. При таком подходе вы преобразуете все входящие утверждения в тип утверждения роли в приложении. Сложность преобразования ограничивается только написанным кодом.

![][10]

**Сопоставление samlSecurityTokenRequriement**. В этой реализации конфигурация samlSecurityTokenRequirement в файле web.config используется, чтобы сообщить WIF, какие типы утверждений действуют как типы утверждения роли. Например, если токен содержит утверждение типа группы, его можно сопоставить с типом утверждения роли. При таком подходе можно добиться только простых сопоставлений.

![][11]

**Пользовательский интерфейс RoleManager.** В этой реализации внедряется пользовательский интерфейс RoleManger. WIF используется для проверки входящих утверждений при реализации методов пользовательского интерфейса RoleManager, например, GetAllRoles().

![][12]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Реализация управления доступом на основе ролей (RBAC) в приложении ASP.NET с поддержкой утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185914.aspx)
-   [Практическое руководство. Реализация логики преобразования токенов с помощью правил](http://msdn.microsoft.com/ru-ru/library/gg185955.aspx)
-   [Авторизация с использованием RoleManager для веб-приложений ASP.NET (WIF) с поддержкой утверждений](http://blogs.msdn.com/b/alikl/archive/2010/11/18/authorization-with-rolemanager-for-claims-aware-wif-asp-net-web-applications.aspx)
-   Пример кода: использование утверждений в IsInRole в [Windows Identity Foundation SDK](http://www.microsoft.com/downloads/details.aspx?FamilyID=c148b2df-c7af-46bb-9162-2c9422208504)

###Авторизации на основе утверждений в приложениях и службах, поддерживающих утверждения

В этом сценарии вам необходимо реализовать сложную логику авторизации в веб-приложении или службе, а метод IsInRole() для авторизации не подходит. Если ваш подход к авторизации зависит от ролей, следует реализовать управление доступом на основе ролей, описанное в предыдущем разделе.

Использование ClaimsAuthorizationManager в качестве точки расширения WIF.
ClaimsAuthorizationManager позволяет выполнять вызовы проверки внешнего доступа, поэтому код приложения будет более понятным, чем при реализации проверки доступа в коде приложения.

![][13]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Реализация логики преобразования токенов с помощью правил](http://msdn.microsoft.com/ru-ru/library/gg185955.aspx)
-   [Практическое руководство. Реализация авторизации на основе утверждений в приложении ASP.NET с поддержкой утверждений с помощью WIF и ACS](http://msdn.microsoft.com/ru-ru/library/gg185907.aspx)
-   Пример кода: авторизация на основе утверждений в [Windows Identity Foundation SDK](http://www.microsoft.com/downloads/details.aspx?FamilyID=c148b2df-c7af-46bb-9162-2c9422208504)


##Сценарии идентификации и контроля доступа службы хранилища Azure

В этом сценарии вам необходимо обеспечить безопасный общий доступ к хранилищу BLOB-объектов и контейнеров Azure.

Использование подписанных URL-адресов. Для доступа к учетной записи хранения из собственного приложения используйте общий хэш, доступный на
портале Azure при настройке учетных записей хранения и управления ими. Если необходимо предоставить другому пользователю доступ к BLOB-объектам и контейнерам в вашей учетной записи службы хранилища, используйте подписанные
URL-адреса подписей коллективного доступа.

Особое внимание следует уделить безопасному управлению информацией, чтобы предотвратить ее разглашение. Также уделите внимание сроку действия подписанных URL-адресов.
подписей общего доступа.

![][14]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Управление доступом к BLOB-объектам и контейнерам](http://msdn.microsoft.com/ru-ru/library/ee393343.aspx)
-   [Новые возможности хранилища: подписанные URL-адреса](http://blog.smarx.com/posts/new-storage-feature-signed-access-signatures)
-   [Подписанные URL-адреса в наши дни стали намного проще](http://blog.smarx.com/posts/shared-access-signatures-are-easy-these-days)


##Сценарии идентификации и контроля доступа базы данных SQL Azure

База данных SQL поддерживает только проверку подлинности SQL Server. Windows
Проверка подлинности Windows (встроенный механизм безопасности) не поддерживается. Пользователи должны предоставлять учетные данные (имя входа и пароль) при каждом подключении к
базе данных SQL. Уделите особое внимание управлению именами пользователей и паролями, чтобы избежать раскрытия информации.

![][15]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Рекомендации и ограничения системы безопасности (база данных SQL)](http://msdn.microsoft.com/ru-ru/library/windowsazure/ff394108.aspx#authentication)
-   [Практическое руководство. Подключение к базе данных SQL с помощью sqlcmd](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336280.aspx)
-   [Практическое руководство. Подключение к базе данных SQL с помощью ADO.NET](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336243.aspx)
-   [Практическое руководство. Подключение к базе данных SQL через ASP.NET](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee621781.aspx)
-   [Практическое руководство. Подключение к базе данных SQL через службы данных WCF](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee621789.aspx)
-  [ Практическое руководство. Подключение к базе данных SQL с помощью PHP](http://msdn.microsoft.com/ru-ru/library/windowsazure/ff394110.aspx)
-   [Практическое руководство. Подключение к базе данных SQL с помощью JDBC](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg715284.aspx)
-   [Практическое руководство. Подключение к базе данных SQL с помощью ADO.NET Entity Framework](http://msdn.microsoft.com/ru-ru/library/windowsazure/ff951633.aspx)

##Сценарии идентификации и контроля доступа Azure Service Bus

У служебной шины и контроля доступа Azure AD есть особая связь. Она состоит в том, что каждое пространство имен служебной шины объединяется с соответствующим пространством имен службы контроля доступа с таким же именем с помощью суффикса "-sb". Причина такой связи в том, что служебная шина и служба контроля доступа управляют отношением взаимного доверия и связанной секретной информацией шифрования. Дополнительные сведения см. в следующих ресурсах.

![][16]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Защита служебной шины с помощью службы ACS](http://channel9.msdn.com/posts/Securing-Service-Bus-with-ACS) (видео)
-   [Защита служебной шины с помощью службы ACS](https://skydrive.live.com/view.aspx?cid=123CCD2A7AB10107&resid=123CCD2A7AB10107%211849) (презентация)
-   [Проверка подлинности и авторизация служебной шины с помощью службы контроля доступа](http://msdn.microsoft.com/ru-ru/library/hh403962.aspx)

##Сценарии идентификации и контроля доступа для кэша в памяти

Кэш в памяти (ранее известный как кэш Azure) использует для проверки подлинности контроль доступа Azure AD. Он использует общие ключи, доступные через портал управления. Используйте ключи в коде или файлах конфигурации при обращении к кэшу. Обязательно храните ключи в безопасном расположении, чтобы избежать раскрытия информации.

![][17]


Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Практическое руководство. Настройка кэша клиента программным способом для службы кэша Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg618003.aspx)
-   [Практическое руководство. Настройка клиента кэша с помощью файла конфигурации приложения для службы кэша Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg278346.aspx)
-   [Примеры использования служебной шины и службы кэша Azure](http://msdn.microsoft.com/ru-ru/library/ee706741.aspx) (раздел "Примеры службы кэша")

##Сценарии идентификации и контроля доступа Azure Marketplace

При каждом обращении к набору данных Azure Marketplace, бесплатном или платном, необходимо проверить подлинность пользователя перед предоставлением доступа. При создании приложения в код необходимо добавить процесс проверки подлинности. Рассмотрим наиболее распространенные сценарии:

###Я получаю доступ к моему набору данных

В этом сценарии вы создаете приложение, которое использует наборы данных вашей подписки на Marketplace. Вы являетесь пользователем приложения. Приложение может быть развернуто в Azure, локально или в Marketplace.

Используйте общий ключ, который доступен по подписке на Marketplace. Общий ключ можно получить с помощью портала Магазина.

![][18]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Использование обычной проверки подлинности HTTP в приложении Marketplace](http://msdn.microsoft.com/ru-ru/library/gg193417.aspx)

###Пользователи получают доступ к моему набору данных

В этом сценарии создается приложение, которое позволяет пользователям получить доступ к вашему набору данных. Приложение может быть развернуто в Azure, локально или в Marketplace.

Для реализации этого сценария используйте делегирование OAuth. Пользователям будет предложено ввести их учетные данные Live ID или учетной записи Майкрософт, после чего реализуется процесс согласия.

![][19]

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Пример веб-клиента OAuth](http://go.microsoft.com/fwlink/?LinkId=219162)
-   [Пример полнофункционального клиента OAuth](http://go.microsoft.com/fwlink/?LinkId=219163)

###Приложение получает доступ к API Marketplace

В этом сценарии создается приложение, которое обращается к API Marketplace. Для успешного выполнения вызовов к API Marketplace необходимо пройти проверку подлинности. Приложение развертывается в Azure Marketplace.

![][20]

Дополнительные сведения о реализации проверки подлинности см. в комплекте публикации для Marketplace.

Для реализации этого сценария обратитесь к следующим ресурсам:

-   [Скачивание комплекта публикации приложения](http://go.microsoft.com/fwlink/?LinkId=221323)
-   [Общие сведения об Azure Marketplace для приложений](https://datamarket.azure.com/)

##Приспособления безопасности

В этом разделе описываются механизмы безопасности для Windows Identity Foundation и
Azure AD Access Control. Используйте его как базовый контрольный список для этих технологий при разработке и развертывании приложения.

###Windows Identity Foundation

Ниже приведены основные средства безопасности WIF. Приведенные ниже сведения являются выдержкой из документов [Вопросы проектирования WIF](http://msdn.microsoft.com/ru-ru/library/ee517298.aspx) и [Безопасность Windows Identity Foundation (WIF) для веб-приложений ASP.NET - угрозы и контрмеры](http://blogs.msdn.com/b/alikl/archive/2010/12/02/windows-identity-foundation-wif-security-for-asp-net-web-applications-threats-amp-countermeasures.aspx)
.

-   **IssuerNameRegistry**. Определяет доверенные службы токенов безопасности (STS). Убедитесь, что отображается только одна доверенная служба STS.
-   **cookieHandler requireSsl="true"**. Указывает, переданы ли файлы cookie сеанса по протоколу SSL.
-   **wsFederation's requireHttps="true"**. Указывает, было ли взаимодействие протокола федерации с поставщиком удостоверений выполнено по протоколу SSL.
-   **tokenReplayDetection enabled="true"**. Указывает, включена ли функция обнаружения воспроизведения токенов. Помните, что эта функция создает сходство сервера при управлении локальными копиями используемых токенов.
-   **audienceUris**. Указывает целевую аудиторию токена. Если приложение получает токен, который не предназначен для него, токен будет отклонен WIF.
-   **requestValidation** и **httpRuntime requestValidationType**. Включает или отключает функцию проверки ASP.NET. См. инструкции в документе [Windows Identity Foundation (WIF): обнаружено потенциально опасное значение Request.Form от клиента](http://social.technet.microsoft.com/wiki/contents/articles/1725.windows-identity-foundation-wif-a-potentially-dangerous-request-form-value-was-detected-from-the-client-wresult-t-requestsecurityto.aspx)

###Контроль доступа Azure AD

Рассмотрим следующие меры безопасности в развертывании контроля доступа Azure AD. Ниже приведена сводка материалов из документов [Рекомендации по безопасности службы
](http://msdn.microsoft.com/ru-ru/library/gg185962.aspx) и [Рекомендации по управлению сертификатами и ключами](http://msdn.microsoft.com/ru-ru/library/hh204521.aspx).

-   **Срок действия токена STS**. Используйте портал контроля доступа Azure AD для настройки агрессивного срока действия маркеров.
-   **Проверка данных при использовании URL-адреса ошибки**. Для использования URL-адреса ошибки контроля доступа Azure AD требуется анонимный доступ к странице приложения, с которой отправляются сообщения об ошибках. Считайте все данные, поступающие на эту страницу, опасными и полученными из ненадежного источника.
-   **Шифрование токенов для сценариев с высокой степенью конфиденциальности**. Шифруйте токены, чтобы устранить угрозу раскрытия информации в токене.
-   **Шифрование файлов cookie с помощью RSA при развертывании в Azure**. WIF по умолчанию шифрует файлы cookie с помощью DPAPI. Служба создает сходство сервера, что может привести к исключениям при развертывании в веб-ферме и средах Azure. Вместо этого используйте RSA для веб-ферм и Azure.
-   **Сертификаты подписи токенов**. Периодически обновляйте сертификаты подписи токенов, чтобы предотвратить атаки "отказ в обслуживании". Служба контроля доступа Azure AD подписывает все выдаваемые токены безопасности. Сертификаты X.509 используются для подписи при создании приложения, которое применяет маркеры SAML, выданные ACS. Когда срок действия сертификатов подписи истекает, при попытке получить токен будут возникать ошибки.
-   **Ключи подписи токенов**. Периодически обновляйте ключи подписи токенов, чтобы предотвратить атаки "отказ в обслуживании". Служба контроля доступа Azure AD подписывает все выдаваемые токены безопасности. 256-разрядные симметричные ключи используются для подписи при создании приложения, которое применяет маркеры SWT, выданные ACS. Когда срок действия ключей подписи истекает, при попытке получить токен будут возникать ошибки.
-   **Сертификаты шифрования токенов**. Периодически обновляйте сертификаты шифрования токенов, чтобы предотвратить атаки "отказ в обслуживании". Маркер шифрования необходим, если приложение проверяющей стороны является веб-службой, использующей маркеры подтверждения владения по протоколу WS-Trust. В других случаях шифрование маркеров не является обязательным. Когда срок действия сертификатов шифрования истекает, при попытке получить токен будут возникать ошибки.
-   **Сертификаты расшифровки токенов**. Периодически обновляйте сертификаты расшифровки токенов, чтобы предотвратить атаки "отказ в обслуживании". Служба контроля доступа Azure AD может принимать зашифрованные токены поставщиков удостоверений WS-Federation (например, служб федерации Active Directory 2.0). Для расшифровки используется сертификат X.509, размещенный в службе контроля доступа Azure AD. Когда срок действия сертификатов расшифровки истекает, при попытке получить токен будут возникать ошибки.
-   **Учетные данные удостоверения службы**. Периодически обновляйте учетные данные удостоверения службы, чтобы предотвратить атаки "отказ в обслуживании". Удостоверения службы используют глобально настроенные учетные данные для пространства имен службы контроля доступа Azure AD, которое позволяет приложениям или клиентам проходить проверку подлинности непосредственно в службе контроля доступа Azure AD и получать токен. Существует три типа учетных данных, с которыми можно связать идентификатор службы контроля доступа Azure AD: симметричный ключ, пароль и сертификат X.509. Когда срок действия учетных данных закончится, вы начнете получать исключения.
-   **Учетные данные учетной записи службы контроля доступа Azure AD**. Периодически обновляйте учетные данные службы управления, чтобы предотвратить атаки "отказ в обслуживании". Служба контроля доступа Azure AD является ключевым компонентом, который позволяет программно настраивать параметры пространства имен службы контроля доступа Azure AD и управлять ими. Существует три типа учетных данных, с которыми можно связать учетную запись службы управления. Это симметричный ключ, пароль и сертификат X.509. Когда срок действия учетных данных закончится, вы начнете получать исключения.
-   **Сертификаты подписи и шифрования поставщика удостоверений WS-Federation**. Проверяйте действительность сертификата поставщика удостоверений WS-Federation, чтобы предотвратить атаки "отказ в обслуживании". Сертификат поставщика удостоверений WS-Federation доступен через его метаданные. При настройке поставщика удостоверений WS-Federation, например служб федерации Active Directory, сертификат подписи WS-Federation настраивается с помощью метаданных WS-Federation, доступных через URL-адрес или файл. После настройки поставщика удостоверений WS-Federation используйте службу контроля доступа Azure AD для запроса действительности сертификатов. Когда срок действия сертификата закончится, вы начнете получать исключения.

##Совместное размещение с помощью веб-сайтов Azure

Все сценарии и решения, описанные в этой статье, допустимы, если приложение размещено на веб-сайтах Azure.

##Виртуальные машины Azure

Все сценарии и решения, описанные в этой статье, допустимы, если приложение размещено на виртуальных машинах Azure.

##Ресурсы

-   [Учебный набор для разработчиков служб удостоверений](http://go.microsoft.com/fwlink/?LinkId=214555)
-   [Обучающий курс MSDN для разработчиков служб удостоверений](http://go.microsoft.com/fwlink/?LinkId=214561)
-   [Руководство по удостоверениям на основе утверждений и контролю доступа](http://go.microsoft.com/fwlink/?LinkId=214562)
-   [Служба контроля доступа](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg429786.aspx)
-   [Практические советы по работе с ACS](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg185939.aspx)
-   [Защита веб-приложения ASP.NET с веб-ролью Azure средствами службы управления доступом 2.0](http://social.technet.microsoft.com/wiki/contents/articles/2590.aspx)
-   [Учебные видео по службе контроля доступа (ACS) Azure AD](http://social.technet.microsoft.com/wiki/contents/articles/2777.aspx)
-   [Жизненный цикл разработки средств безопасности Майкрософт](http://www.microsoft.com/security/sdl/default.aspx)
-   [Средство моделирования угроз SDL Threat Modeling Tool 3.1.8](http://www.microsoft.com/download/en/details.aspx?displaylang=en&id=2955)
-   [Блоги, посвященные безопасности и конфиденциальности](http://www.microsoft.com/about/twc/en/us/blogs.aspx)
-   [Центр Security Response Center](http://www.microsoft.com/security/msrc/default.aspx)
-   [Отчет службы безопасности](http://www.microsoft.com/security/sir/)
-   [Жизненный цикл разработки средств безопасности](http://www.microsoft.com/security/sdl/default.aspx)
-   [Центр разработчиков средств безопасности (MSDN)](http://msdn.microsoft.com/security/)


[01]:./media/SecurityRX/01_SecuringTheApplication.gif
[02]:./media/SecurityRX/02_ThreatsVulnerabilitiesandAttacks.gif
[03]:./media/SecurityRX/03_WindowsAzureADAccesscontrol.gif
[04]:./media/SecurityRX/04_WCF(SOAP)Service.gif
[05]:./media/SecurityRX/05_AzureADAccessControl.gif
[06]:./media/SecurityRX/06_RESTService.gif
[07]:./media/SecurityRX/07_WIFisOptional.gif
[08]:./media/SecurityRX/08_ASPNETWebApptoREST.gif
[09]:./media/SecurityRX/09_RBAC.gif
[10]:./media/SecurityRX/10_WIFClaimsAuthenticationManager.gif
[11]:./media/SecurityRX/11_SecurityTokenRequriementmapping.gif
[12]:./media/SecurityRX/12_CustomRoleManager.gif
[13]:./media/SecurityRX/13_ClaimsAuthorizationManager.gif
[14]:./media/SecurityRX/14_WindowsAzurestorage.gif
[15]:./media/SecurityRX/15_SQLAzureIdentityandAccessScenarios.gif
[16]:./media/SecurityRX/16_WindowsAzureServiceBusIdentity.gif
[17]:./media/SecurityRX/17_WindowsAzureCacheIdentity.gif
[18]:./media/SecurityRX/18_IAccessMyDataset.gif
[19]:./media/SecurityRX/19_UsersAccessMyDatasets.gif
[20]:./media/SecurityRX/20_ApplicationAccessMarketplaceAPI.gif

[Проектирование единого входа в Интернете]: http://technet.microsoft.com/ru-ru/library/dd807033(WS.10).aspx
[Проектирование федеративного единого входа в Интернете]: http://technet.microsoft.com/ru-ru/library/dd807050(WS.10).aspx
<!--HONumber=42-->
