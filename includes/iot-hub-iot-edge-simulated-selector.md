> [!div class="op_single_selector"]
> * [Linux](../articles/iot-hub/iot-hub-linux-iot-edge-simulated-device.md)
> * [Windows](../articles/iot-hub/iot-hub-windows-iot-edge-simulated-device.md)

В пошаговом руководстве с [примером отправки в облако виртуальных устройств] показано, как с помощью [Azure IoT Edge][lnk-sdk] отправлять данные телеметрии, передаваемые с виртуальных устройств в облако, в Центр Интернета вещей.

В этом руководстве рассматриваются следующие темы.

* **Архитектура**: данные об архитектуре в [примером отправки в облако виртуальных устройств].
* **Сборка и запуск**: шаги, необходимые для сборки и запуска примера.

## <a name="architecture"></a>Архитектура

[примером отправки в облако виртуальных устройств] показывает, как создать шлюз, который отправляет данные телеметрии из виртуальных устройств в Центр Интернета вещей. Возможно, устройству не удастся подключиться непосредственно к Центру Интернета вещей, так как устройство:

* не использует протокол связи, поддерживаемый Центром Интернета вещей;
* не имеет достаточно возможностей, чтобы запомнить удостоверение, присвоенное ему Центром Интернета вещей.

Шлюз IoT Edge позволяет решить эти проблемы одним из указанных ниже способов.

* Шлюз распознает протокол, используемый устройством, получает данные телеметрии, передаваемые с устройства в облако, и пересылает эти сообщения в Центр Интернета вещей по протоколу, поддерживаемому этим центром.

* Шлюз сопоставляет удостоверения Центра Интернета вещей и действует как прокси-сервер, когда устройство отправляет сообщения в Центр Интернета вещей.

На следующей схеме представлены основные компоненты примера, включая модули Edge Интернета вещей:

![Схема. Сообщение виртуального устройства передается через шлюз в Центр Интернета вещей][1]

Этот образец содержит три модуля, которые составляют шлюз:
1. Модуль получения протокола
1. MAC &lt;-&gt; Модуль идентификатора центра Интернета вещей
1. Модуль связи центра IoT

Модули не передают сообщения друг другу напрямую. Модули публикуют сообщения во внутренний брокер передачи сообщений, который передает их в другие модули с помощью механизма подписки. Дополнительные сведения см. в статье [Explore Azure IoT Edge architecture on Linux][lnk-gw-getstarted] (Обзор архитектуры Edge Интернета вещей в Linux).

![Схема. Обмен данными между модулями шлюза и брокером][2]

### <a name="protocol-ingestion-module"></a>Модуль получения протокола

Модуль получения протокола является отправной точкой для процесса приема данных с устройств через шлюз и их передачи в облако. 

В примере этот модуль:

1. моделирует данные температуры (при использовании физических устройств модуль считывает данные с физических устройств);
1. создает сообщение;
1. помещает смоделированные данные температуры в содержимое сообщения;
1. добавляет в сообщение свойство с фиктивным MAC-адресом;
1. делает сообщение доступными для следующего модуля в цепочке.

Модуль получения протокола — **simulated_device.c** в исходном коде.

### <a name="mac-lt-gt-iot-hub-id-module"></a>MAC &lt;-&gt; Модуль идентификатора центра Интернета вещей

Модуль "MAC &lt;-&gt; Идентификатор Центра Интернета вещей" работает как преобразователь. В этом примере MAC-адрес используется как уникальный идентификатор устройства и сопоставляет его с удостоверением устройства в центре IoT. В то же время вы можете написать собственный модуль, где будет использоваться другой уникальный идентификатор. Например, устройства могут иметь уникальные серийные номера или данные телеметрии могут содержать уникальное внедренные имена устройств.

В примере этот модуль:

1. Проверяет сообщения, которые содержат свойства MAC-адреса.
1. Если MAC–адрес существует, он добавляет в сообщение другое свойство с ключом устройства Центра Интернета вещей. 
1. делает сообщение доступными для следующего модуля в цепочке.

Разработчик устанавливает сопоставление MAC-адресов с удостоверениями Центра Интернета вещей, чтобы связать виртуальные устройства с удостоверениями. Разработчик добавляет сопоставление вручную как часть конфигурации модуля.

Модуль "MAC &lt;-&gt; Идентификатор Центра Интернета вещей" — **identitymap.c** в исходном коде. 

### <a name="iot-hub-communication-module"></a>Модуль связи центра IoT

Модуль связи Центра Интернета вещей открывает одиночное HTTPS-подключение от шлюза к Центру Интернета вещей. HTTPS — один из трех протоколов, понятных для центра IoT. Этот модуль позволяет избежать открытия отдельного подключения для каждого устройства путем мультиплексирования подключений со всех устройств через одно подключение. Такой подход позволяет подключить много устройств при помощи одного шлюза. 

В примере этот модуль:

1. Принимает сообщения со свойством ключа устройства Центра Интернета вещей, назначенным предыдущим модулем. 
1. Отправляет содержимое сообщения в Центр Интернета вещей при помощи протокола HTTPS. 

Модуль связи Центра Интернета вещей — **iothub.c** в исходном коде.

## <a name="before-you-get-started"></a>Необходимые условия

Перед началом работы необходимо выполнить следующие действия:

* [Создайте Центр Интернета вещей][lnk-create-hub] в своей подписке Azure. В этом пошаговом руководстве центру следует присвоить имя. Если у вас нет учетной записи, можно создать [бесплатную учетную запись][lnk-free-trial] всего за несколько минут.
* Добавьте в Центр Интернета вещей два устройства и запишите их идентификаторы и ключи устройств. Чтобы добавить устройства в Центр Интернета вещей и получить их ключи, можно использовать [обозреватель устройств][lnk-device-explorer] или [iothub-explorer][lnk-iothub-explorer].


<!-- Images -->
[1]: media/iot-hub-iot-edge-simulated-selector/image1.png
[2]: media/iot-hub-iot-edge-simulated-selector/image2.png

<!-- Links -->
[примером отправки в облако виртуальных устройств]: https://github.com/Azure/iot-edge/blob/master/samples/simulated_device_cloud_upload/README.md
[lnk-sdk]: https://github.com/Azure/iot-edge
[lnk-gw-getstarted]: ../articles/iot-hub/iot-hub-linux-iot-edge-get-started.md
[lnk-free-trial]: https://azure.microsoft.com/pricing/free-trial/
[lnk-device-explorer]: https://github.com/Azure/azure-iot-sdk-csharp/tree/master/tools/DeviceExplorer
[lnk-iothub-explorer]: https://github.com/Azure/iothub-explorer/blob/master/readme.md
[lnk-create-hub]: ../articles/iot-hub/iot-hub-create-through-portal.md