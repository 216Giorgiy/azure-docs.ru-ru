#Создание виртуальной машины с ОС Linux 

Вы можете легко создать виртуальную машину, работающую под управлением ОС Linux, с помощью коллекции образов на портале управления Windows Azure. Это руководство разработано для читателей, не имеющих опыта использования платформы Windows Azure. Вы сможете создать виртуальную машину под управлением ОС Linux в облаке, к которой также сможете получать доступ и настраивать ее.

Вы узнаете о:

- [виртуальных машинах в Windows Azure] []
- [создании виртуальной машины] []
- [входе на виртуальную машину после ее создания] []
- [присоединении диска данных к новой виртуальной машине] []

**Примечание**. В этом руководстве рассматривается создание виртуальной машины, не подключенной к виртуальной сети. Если требуется использовать виртуальную машину по виртуальной сети, при создании виртуальной машины обязательно укажите виртуальную сеть. Дополнительные сведения о виртуальных сетях см. в разделе [Обзор виртуальных сетей Windows Azure](http://go.microsoft.com/fwlink/p/?LinkID=294063).

## <a id="virtualmachine"> </a>Виртуальные машины в Windows Azure ##

Виртуальная машина в Windows Azure — это сервер в облаке, которым вы можете управлять. После создания виртуальной машины в Windows Azure ее можно удалять и создавать заново каждый раз, при необходимости. Доступ к виртуальной машине осуществляется так же, как к серверу в вашем офисе. Файлы виртуального жесткого диска (VHD) используются для создания виртуальной машины. Для виртуальной машины используются следующие типы виртуальных жестких дисков:

- **Образ** — это виртуальный жесткий диск, используемый в качестве шаблона для создания новой виртуальной машины. Образ — это шаблон, так как в отличие от работающей виртуальной машины, у него нет определенных параметров, таких как имя компьютера и параметры учетной записи пользователя. При создании виртуальной машины из образа диск операционной системы для новой виртуальной машины создается автоматически.
- **Диск** — это виртуальный жесткий диск, который можно установить и использовать как диск с установленной операционной системой. После подготовки образ становится диском. Диск всегда создается при использовании образа для создания виртуальной машины. Любой виртуальный жесткий диск, присоединенный к виртуальному оборудованию и работающий как служба, является диском

Для создания виртуальной машины с помощью образа доступны следующие параметры:

- Создание виртуальной машины с помощью образа, который предоставляется в коллекции образов на портале управления Windows Azure.
- Создание и передача VHD-файла с образом на Windows Azure и затем создание виртуальной машины с помощью образа. Дополнительные сведения о создании и передаче пользовательского образа см. в разделе [Создание и передача виртуального жесткого диска, содержащего операционную систему Linux](/ru-ru/manage/linux/common-tasks/upload-a-vhd/).

Каждая виртуальная машина находится в облачной службе либо сама по себе, либо сгруппирована с другими виртуальными машинами. Виртуальные машины можно разместить в одной облачной службе для обеспечения связи между виртуальными машинами, для балансировки нагрузки трафика между виртуальными машинами и поддержки высокой доступности машин. Дополнительные сведения об облачных службах и виртуальных машинах см. в разделе "Модели выполнения" руководства [Знакомство с Windows Azure](http://go.microsoft.com/fwlink/p/?LinkId=311926).

## <a id="custommachine"> </a>Создание виртуальной машины ##

Для быстрого создания настраиваемой виртуальной машины на портале управления можно использовать метод **Из коллекции**. Этот метод предоставляет дополнительные параметры для настройки виртуальной машины при ее создании, такие как связанные ресурсы, DNS-имя и при необходимости подключение к сети.

1. Войдите на [портал управления](http://manage.windowsazure.com) Windows Azure.
На панели команд щелкните **Создать**.

2. Щелкните **Виртуальная машина** и **Из коллекции**.

3. В окне **Выберите образ** выберите образ в одном из списков. (Доступные образы могут отличаться в зависимости от используемой подписки). Щелкните стрелку для продолжения.

4. Если в окне **Дата выпуска версии** доступны образы нескольких версий, выберите необходимую версию.

5. В поле **Имя виртуальной машины** введите имя, которое вы хотите использовать. Для данной виртуальной машины введите **MyTestVM1**.

6. В поле **Размер** выберите размер, который вы хотите использовать для виртуальной машины. Выбранный размер зависит от числа ядер, которые необходимы для приложения.  Для данной виртуальной машины выберите самый маленький размер.

7. В поле **Новое имя пользователя** введите имя учетной записи, которую требуется использовать для управления виртуальной машиной. Для имени пользователя нельзя использовать корневой каталог. Для данной виртуальной машины введите **NewUser1**.

8. В разделе "Аутентификация" установите флажок **Предоставьте пароль**. Затем введите требуемые сведения и нажмите стрелку для продолжения.

9. Можно поместить виртуальные машины в облачную службу, но в этом руководстве вы только создаете одну виртуальную машину. Чтобы сделать это, выберите **Создать новую облачную службу**.

10. В поле **DNS-имя облачной службы** введите имя, состоящее из 3—24 строчных букв и цифр. Это имя становится частью URI, который используется для связи с виртуальной машиной в облачной службе. Для данной виртуальной машины введите **MyService1**.

11. В поле **Регион, территориальная группа, виртуальная сеть** выберите, где будет располагаться виртуальная машина.

12. Вы можете выбрать учетную запись хранения, где хранится файл виртуального жесткого диска. В данном руководстве примите значение по умолчанию **Использовать автоматически созданную учетную запись хранения**.

13. В разделе **Группа доступности** для целей данного руководства используйте значение по умолчанию **Нет**. Снимите флажок, чтобы создать виртуальную машину, и нажмите стрелку, чтобы продолжить.

14.  В разделе **Агент ВМ** укажите, следует ли установить агент ВМ. Этот агент предоставляет среду для установки расширений, которые помогут вам взаимодействовать с виртуальной машиной. Дополнительные сведения см. в разделе [Использование расширений](http://go.microsoft.com/FWLink/p/?LinkID=394093). **Важно**. Агент ВМ можно устанавливать только при создании виртуальной машины. 

15. В разделе **Конечные точки** проверьте конечную точку, созданную автоматически, чтобы разрешить подключения Secure Shell (SSH) к виртуальной машине. (Конечные точки позволяют ресурсам в Интернете или других виртуальных сетях связываться с виртуальной машиной). Вы можете добавить конечные точки сейчас или создать их позже. Инструкции по их созданию см. в разделе [Настройка связи с виртуальной машиной](http://www.windowsazure.com/ru-ru/manage/linux/how-to-guides/setup-endpoints/).
  
После создания виртуальной машины и облачной службы на портале управления отображаются новая виртуальная машина в разделе **Виртуальные машины** и облачная служба в разделе **Облачные службы**. Виртуальная машина и облачная служба запускаются автоматически.

## <a id="logon"> </a>Как войти в систему на виртуальной машине после ее создания ##

Для управления параметрами виртуальной машины и приложениями, выполняющимися на компьютере, можно использовать SSH-клиент. Для этого необходимо установить клиент SSH на компьютер, который будет использоваться для входа на виртуальную машину. Существует множество клиентских программ SSH. Вы можете выбрать один из следующих вариантов.

- При использовании компьютера под управлением Windows вы можете использовать такой клиент SSH, как PuTTY. Дополнительные сведения см. на [странице загрузки PuTTY](http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html).
- При использовании компьютера под управлением Linux вы можете использовать такой клиент SSH, как OpenSSH. Дополнительные сведения см. на странице [OpenSSH](http://www.openssh.org/).

В этом руководстве рассматривается использование программы PuTTY для доступа к виртуальной машине.

1. Найдите **Имя узла** и **Данные порта** с портала управления. Необходимые сведения можно найти на панели мониторинга виртуальной машины. Щелкните имя виртуальной машины и найдите **Сведения об SSH** в разделе **Сводка** панели мониторинга.

	![Найдите сведения об SSH](./media/CreateVirtualMachineLinuxTutorial/SSHdetails.png)

2. Откройте программу PuTTY.

3. Введите **Имя узла** и **Данные порта** с панели мониторинга и щелкните **Открыть**.

	![Введите имя узла и данные порта](./media/CreateVirtualMachineLinuxTutorial/putty.png)

4. Войдите в систему на виртуальной машине с помощью учетной записи NewUser1, указанной при создании машины.

	![Войдите на новую виртуальную машину](./media/CreateVirtualMachineLinuxTutorial/sshlogin.png)

	Теперь вы сможете работать с виртуальной машиной, так же как и с любым сервером.


## <a id="attachdisk"> </a>Как присоединить диск данных к новой виртуальной машине ##

Приложение может сохранять данные. Чтобы выполнить такую настройку, подключите диск данных к ранее созданной виртуальной машине. Для этого проще всего подключить пустой диск данных к машине.

**Примечание. Диск данных и диск ресурсов**  
Диски с данными хранятся в хранилище Windows Azure и могут использоваться для постоянного хранения файлов и данных приложений.

Каждая созданная виртуальная машина также имеет присоединенный временный локальный *Диск ресурсов*. Так как данные на диске ресурсов могут плохо переносить перезагрузки, его часто используют приложения и процессы, выполняющиеся на виртуальной машине, для временного хранения данных. Он также используется для хранения страниц или замены файлов операционной системы.

В системе Linux диск ресурсов обычно управляется агентом Linux Windows Azure, и он автоматически подключается к **/mnt/resource** (или **/mnt** на образах Ubuntu). Дополнительные сведения см. в [руководстве пользователя агента Linux Windows Azure](http://www.windowsazure.com/ru-ru/manage/linux/how-to-guides/linux-agent-guide/).


1. Войдите на портал управления Windows Azure, если вы еще этого не сделали.

2. Щелкните **Виртуальные машины**, а затем выберите предварительно созданную виртуальную машину **MyTestVM1**.

3. На панели команд нажмите кнопку **Присоединить**, а затем — **Присоединить пустой диск**.
	
	Откроется диалоговое окно **Присоединение пустого диска**.

	![Определение сведений о диске](./media/CreateVirtualMachineLinuxTutorial/attachnewdisklinux.png)

4. Значения **Имя виртуальной машины**, **Расположение хранилища** и **Имя файла** уже определены. Достаточно ввести размер диска. Введите **5** в поле **Размер**.

	**Примечание.** Все диски создаются из файла виртуального жесткого диска в хранилище Windows Azure. Можно ввести имя для добавляемого в хранилище файла виртуального жесткого диска, однако имя диска будет создано автоматически.

5. Установите флажок, чтобы присоединить диск данных к виртуальной машине.

6. Проверить присоединение диска данных к виртуальной машине можно с помощью панели мониторинга. Щелкните имя виртуальной машины для отображения панели мониторинга.

	Для виртуальной машины число дисков теперь 2. Присоединенный диск отображается в таблице **Диски**.

	![Присоединение диска выполнено](./media/CreateVirtualMachineLinuxTutorial/attachemptysuccess.png)

После присоединения диска данных к виртуальной машине диск будет отключен и не инициализирован. Чтобы использовать этот диск для хранения данных, необходимо предварительно войти в систему на данном компьютере и инициализировать диск.

1. Подключитесь к виртуальной машине, выполнив действия, описанные выше в разделе **Как войти в систему на виртуальной машине после ее создания**.

2. В окне SSH введите следующую команду, а затем введите пароль **MyPassword1** для учетной записи:

	`sudo grep SCSI /var/log/messages`

	Идентификатор последнего добавленного диска данных можно найти в отображаемых сообщениях.

	![Идентификация диска](./media/CreateVirtualMachineLinuxTutorial/diskmessages.png)

3. В окне SSH введите следующую команду для создания нового устройства, а затем введите пароль **MyPassword1** для учетной записи:

	`sudo fdisk /dev/sdc`

4. Введите **n** для создания нового раздела.

	![Создание нового устройства](./media/CreateVirtualMachineLinuxTutorial/diskpartition.png)

5. Введите **p**, чтобы сделать раздел основным, введите **1**, чтобы сделать его первым разделом, а затем нажмите клавишу ВВОД, чтобы принять значение по умолчанию для цилиндра.

	![Создание раздела](./media/CreateVirtualMachineLinuxTutorial/diskcylinder.png)

6. Введите **p**, чтобы просмотреть сведения о диске, на котором создаются разделы.

	![Просмотр сведений о диске](./media/CreateVirtualMachineLinuxTutorial/diskinfo.png)

7. Введите **w**, чтобы записать параметры данного диска.

	![Запись изменений на диске](./media/CreateVirtualMachineLinuxTutorial/diskwrite.png)

8. Необходимо создать файловую систему в новом разделе. Введите следующую команду для создания новой файловой системы, а затем введите пароль MyPassword1 для учетной записи:

	`sudo mkfs -t ext4 /dev/sdc1`

	![Создание файловой системы](./media/CreateVirtualMachineLinuxTutorial/diskfilesystem.png)

9. Введите следующую команду, чтобы создать каталог для установки диска, а затем введите пароль **MyPassword1** для учетной записи:

	`sudo mkdir /mnt/datadrive`

10. Введите следующую команду, чтобы установить диск:

	`sudo mount /dev/sdc1 /mnt/datadrive`

	Диск данных теперь готов для использования как **/mnt/datadrive**.

11. Добавьте новый диск в /etc/fstab:

	Чтобы обеспечить автоматическую переустановку диска после перезагрузки, его необходимо добавить в файл /etc/fstab. Кроме того, для ссылки на диск настоятельно рекомендуется использовать идентификатор UUID (глобально уникальный идентификатор) в /etc/fstab, а не просто имя устройства (т. е. /dev/sdc1). Чтобы найти идентификатор UUID нового диска, можно использовать программу **blkid**:
	
	`sudo -i blkid`

	Вывод будет выглядеть примерно следующим образом:

		`/dev/sda1: UUID="11111111-1b1b-1c1c-1d1d-1e1e1e1e1e1e" TYPE="ext4"`
		`/dev/sdb1: UUID="22222222-2b2b-2c2c-2d2d-2e2e2e2e2e2e" TYPE="ext4"`
		`/dev/sdc1: UUID="33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e" TYPE="ext4"`

	**Примечание.** blkid может не требоваться доступ sudo во всех случаях, однако может быть проще выполнить "sudo -i" на некоторых дистрибутивах, если /sbin или /usr/sbin не в вашем "$PATH".

	**Внимание!** Неправильное редактирование файла /etc/fstab может привести к невозможности загрузить систему. Если не уверены, обратитесь к документации дистрибутива за сведениями о том, как правильно изменить этот файл. Также рекомендуется перед внесением изменений создать резервную копию файла /etc/fstab.

	С помощью текстового редактора введите сведения о новой файловой системе в конце файла /etc/fstab.  В этом примере мы используем значение UUID для нового устройства **/dev/sdc1**, созданного в предыдущих шагах, и точку установки **/mnt/datadrive**:

	`UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e    /mnt/datadrive    ext4    defaults    1    1`

	При создании дополнительных дисков с данными и разделов нужно будет также ввести их в файл /etc/fstab.

	Теперь можно проверить, правильно ли установлена файловая система, просто отключив и повторно установив файловую систему, т. е. используя типовую точку установки "/mnt/datadrive", созданную на предыдущих этапах: 

		`sudo umount /mnt/datadrive`
		`sudo mount /mnt/datadrive`

	Если вторая команда приводит к ошибке, проверьте правильность синтаксиса в файле /etc/fstab.

##Дальнейшие действия 

Чтобы узнать больше о Linux на Windows Azure, см. следующие статьи:

- [Знакомство с Linux на Windows Azure](http://www.windowsazure.com/ru-ru/documentation/articles/introduction-linux/)

- [Использование средств командной строки Windows Azure для Mac и Linux](http://www.windowsazure.com/ru-ru/documentation/articles/xplat-cli/)


[Дальнейшие действия]: #next
[Виртуальные машины в Windows Azure]: #virtualmachine
[Создание виртуальной машины] #custommachine
[Как войти в систему на виртуальной машине после ее создания]: #logon
[Как присоединить диск данных к новой виртуальной машине]: #attachdisk

