
Если эта статья не помогла устранить проблему вашу с Azure, посетите [форумы по Azure на сайтах MSDN и Stack Overflow](https://azure.microsoft.com/support/forums/). Проблему можно разместить на этих форумах или отправить по адресу @AzureSupport в Twitter. Кроме того, можно отправить запрос в службу поддержки Azure, выбрав **Получить поддержку** на сайте [службы поддержки Azure](https://azure.microsoft.com/support/options/) .

## <a name="general-troubleshooting-steps"></a>Общие действия по устранению неполадок
### <a name="troubleshoot-common-allocation-failures-in-the-classic-deployment-model"></a>Устранение распространенных ошибок выделения ресурсов в классической модели развертывания
Выполнение этих шагов позволяет устранить многие ошибки выделения ресурсов в виртуальных машинах:

* Измените размер виртуальной машины.<br>
    Выберите **Просмотреть все** > **Виртуальные машины (классические)** > имя виртуальной машины > **Параметры** > **Размер**. Подробные инструкции см. в статье [Перезапуск виртуальной машины](https://msdn.microsoft.com/library/dn168976.aspx).
* Удалите из облачной службы все виртуальные машины и создайте их заново.<br>
    Выберите **Просмотреть все** > **Виртуальные машины (классические)** > имя виртуальной машины > **Удалить**. Нажмите кнопку **Создать ресурс** > **Вычисление** > [образ виртуальной машины].

### <a name="troubleshoot-common-allocation-failures-in-the-azure-resource-manager-deployment-model"></a>Устранение распространенных ошибок выделения ресурсов в модели развертывания диспетчера ресурсов Azure
Выполнение этих шагов позволяет устранить многие ошибки выделения ресурсов в виртуальных машинах:

* Остановите или освободите все виртуальные машины в пределах одной группы доступности, а затем перезапустите каждую из них.<br>
    Остановка: выберите **Группы ресурсов** > имя группы ресурсов > **Ресурсы** > имя группы доступности > **Виртуальные машины** > имя виртуальной машины > **Остановить**.
  
    После остановки всех виртуальных машин выберите первую из них и щелкните **Запустить**.

## <a name="background-information"></a>Справочная информация
### <a name="how-allocation-works"></a>Как выделяются ресурсы
Серверы в центрах обработки данных Azure разделены на кластеры. Как правило, попытка выполнить запрос на выделение ресурсов происходит в нескольких кластерах. Однако возможен вариант, когда при наличии определенных ограничений в запросах на выделение на платформе Azure произойдет принудительная попытка выполнения запроса только в одном кластере. В этой статье мы будем называть этот процесс прикреплением к кластеру. На схеме 1 ниже показан случай обычного выделения при попытке выполнения в нескольких кластерах. На схеме 2 показано выделение ресурсов, прикрепленных к кластеру 2, так как в нем размещена имеющаяся облачная служба CS_1 или группа доступности.
![Схема выделения ресурсов](./media/virtual-machines-common-allocation-failure/Allocation1.png)

### <a name="why-allocation-failures-happen"></a>Причины возникновения ошибок выделения ресурсов
Если запрос на выделение прикреплен к одному кластеру, возрастает вероятность того, что не удастся найти свободные ресурсы, так как пул доступных ресурсов имеет меньший размер. Кроме того, если запрос на выделение прикреплен к одному кластеру, а тип запрошенного ресурса не поддерживается, запрос завершится ошибкой, даже если в кластере есть свободные ресурсы. На схеме 3 ниже показан случай, когда ошибка выделения прикрепленных ресурсов произошла из-за отсутствия свободных ресурсов в единственном подходящем кластере. На схеме 4 показан случай, когда ошибка выделения прикрепленных ресурсов произошла потому, что единственный подходящий кластер не поддерживает запрошенный размер виртуальной машины, несмотря на наличие свободных ресурсов в кластере.

![Ошибка выделения прикрепленных ресурсов](./media/virtual-machines-common-allocation-failure/Allocation2.png)

## <a name="detailed-troubleshoot-steps-specific-allocation-failure-scenarios-in-the-classic-deployment-model"></a>Подробные инструкции по устранению конкретных ошибок выделения ресурсов в классической модели развертывания.
В этом разделе описаны распространенные сценарии выделения ресурсов, которые приводят к прикреплению запросов на выделение. Каждый сценарий мы более подробно рассмотрим ниже.

* Изменение размера виртуальной машины или добавление дополнительных виртуальных машин или экземпляров ролей в существующую облачную службу
* Перезапустите частично остановленные (освобожденные) виртуальные машины
* Перезапустите полностью остановленные (освобожденные) виртуальные машины
* Промежуточное и рабочее развертывание (только для "платформы как услуги")
* Территориальная группа (взаимодействие с виртуальными машинами или службами)
* Виртуальная сеть на основе группы сходства

При возникновении ошибки выделения ресурсов проверьте, не соответствует ли ваша ситуация одному из этих сценариев. Используйте ошибку выделения, возвращенную платформой Azure, чтобы определить соответствующий сценарий. Если выполненный запрос прикреплен, попробуйте удалить некоторые ограничения этого прикрепления, чтобы распространить запрос на большее количество кластеров и тем самым повысить вероятность успешного выделения.

Как правило, если в сообщении об ошибке не сказано о том, что запрошенный размер виртуальной машины не поддерживается, можно повторить попытку позже, так как в кластере может быть освобождено достаточно ресурсов, чтобы выполнить запрос. Если проблема заключается в том, что запрошенный размер виртуальной машины не поддерживается, попробуйте выбрать другой размер виртуальной машины. В противном случае единственная возможность — удалить соответствующее ограничение.

Два самых распространенных сценариев возникновения ошибок связаны с территориальными группами. Ранее территориальные группы использовались для обеспечения сильного взаимодействия с экземплярами виртуальных машин или служб либо для создания виртуальной сети. С появлением региональных виртуальных сетей территориальные группы больше не используются для создания виртуальной сети. Ввиду сокращения задержки в сети инфраструктуры Azure изменились рекомендации по использованию территориальных групп для взаимодействия с виртуальными машинами или службами.

На схеме 5 показана таксономия сценариев выделения (закрепленных) ресурсов.
![Таксономия выделения прикрепленных ресурсов](./media/virtual-machines-common-allocation-failure/Allocation3.png)

> [!NOTE]
> Ошибки, перечисленные в каждом сценарии выделения, приведены в короткой форме. Дополнительные сведения о строках ошибок см. в разделе [Значение строк ошибок](#Error string lookup).
> 
> 

## <a name="allocation-scenario-resize-a-vm-or-add-vms-or-role-instances-to-an-existing-cloud-service"></a>Сценарий выделения: изменение размера виртуальной машины либо добавление дополнительных виртуальных машин или экземпляров ролей в существующую облачную службу
**Ошибка**

Upgrade_VMSizeNotSupported или GeneralError

**Причина прикрепления к кластеру**

Попытка выполнить запрос на изменение размера виртуальной машины или ее добавление, а также добавление экземпляра роли в существующую облачную службу должна осуществляться в исходном кластере, в котором размещена существующая облачная служба. Если создать новую облачную службу, платформа Azure сможет найти другой кластер, в котором есть свободные ресурсы или который поддерживает запрошенный размер виртуальных машин.

**Возможное решение**

При возникновении ошибки Upgrade_VMSizeNotSupported* попробуйте изменить размер виртуальной машины. Если использовать другой размер виртуальной машины нецелесообразно, но допускается использование другого виртуального IP-адреса, создайте облачную службу, где будет размещена новая виртуальная машина, и добавьте новую облачную службу в региональную виртуальную сеть, в которой запущены виртуальные машины. Если существующая облачная служба не использует региональную виртуальную сеть, вы по-прежнему можете создать виртуальную сеть для новой облачной службы и подключить [имеющуюся виртуальную сеть к новой](https://azure.microsoft.com/blog/vnet-to-vnet-connecting-virtual-networks-in-azure-across-different-regions/). См. дополнительные сведения о [региональных виртуальных сетях](https://azure.microsoft.com/blog/2014/05/14/regional-virtual-networks/).

Если возникла ошибка GeneralError*, это означает, что кластер, скорее всего, поддерживает этот тип ресурса (например виртуальные машины определенного размера), но сейчас в нем нет свободных ресурсов. По аналогии с использованным выше сценарием попробуйте добавить необходимый вычислительный ресурс, создав облачную службу (обратите внимание, что новая облачная служба должна использовать другой виртуальный IP-адрес) и используя региональную виртуальную сеть для подключения к облачным службам.

## <a name="allocation-scenario-restart-partially-stopped-deallocated-vms"></a>Сценарий выделения: перезапустите частично остановленные (освобожденные) виртуальные машины
**Ошибка**

GeneralError*

**Причина прикрепления к кластеру**

Частичное освобождение означает, что в облачной службе будут остановлены (освобождены) одна или несколько виртуальных машин, но не все. При остановке (освобождении) виртуальной машины происходит освобождение связанных с ней ресурсов. Таким образом, перезагрузка остановленной (освобожденной) виртуальной машины предусматривает выполнение нового запроса. Перезапуск виртуальных машин в частично освобожденной облачной службе эквивалентен добавлению виртуальных машин к существующей облачной службе. Попытка выполнения запроса должна осуществляться в исходном кластере, в котором размещена существующая облачная служба. Если создать новую облачную службу, платформа Azure сможет найти другой кластер, в котором есть свободные ресурсы или который поддерживает запрошенный размер виртуальной машины.

**Возможное решение**

Если допускается использование различных виртуальных IP-адресов, удалите остановленные (освобожденные) виртуальные машины (но сохраните связанные диски) и добавьте виртуальные машины обратно, используя другую облачную службу. Используйте региональную виртуальную сеть для подключения к облачным службам:

* Если существующая облачная служба использует региональную виртуальную сеть, просто добавьте новую облачную службу в ту же виртуальную сеть.
* Если существующая облачная служба не использует региональную виртуальную сеть, создайте виртуальную сеть для новой облачной службы и [подключите имеющуюся виртуальную сеть к новой](https://azure.microsoft.com/blog/vnet-to-vnet-connecting-virtual-networks-in-azure-across-different-regions/). См. дополнительные сведения о [региональных виртуальных сетях](https://azure.microsoft.com/blog/2014/05/14/regional-virtual-networks/).

## <a name="allocation-scenario-restart-fully-stopped-deallocated-vms"></a>Сценарий выделения: перезапустите полностью остановленные (освобожденные) виртуальные машины
**Ошибка**

GeneralError*

**Причина прикрепления к кластеру**

Полное освобождение означает, что в облачной службе остановлены (освобождены) все виртуальные машины. Попытка выполнения запроса для перезапуска этих виртуальных машин должна осуществляться в исходном кластере, в котором размещена облачная служба. Если создать новую облачную службу, платформа Azure сможет найти другой кластер, в котором есть свободные ресурсы или который поддерживает запрошенный размер виртуальных машин.

**Возможное решение**

Если допускается использование другого виртуального IP-адреса, удалите исходные остановленные (освобожденные) виртуальные машины (но сохраните связанные диски) и соответствующие облачные службы (связанные вычислительные ресурсы уже освобождены при остановке (освобождении) виртуальных машин)). Создайте облачную службу для повторного добавления виртуальных машин.

## <a name="allocation-scenario-stagingproduction-deployments-platform-as-a-service-only"></a>Сценарий выделения: промежуточное и рабочее развертывание (только для "платформы как услуги")
**Ошибка**

New_General* или New_VMSizeNotSupported*

**Причина прикрепления к кластеру**

Промежуточное и рабочее развертывания облачной службы размещаются в одном кластере. При добавлении второго развертывания соответствующий запрос на выделение будет выполнен в том же кластере, в котором размещено первое.

**Возможное решение**

Удалите первое развертывание и исходную облачную службу и разверните облачную службу повторно. Выполнив это действие, можно разместить первое развертывание в кластере, в котором достаточно свободных ресурсов для обоих развертываний, или в кластере, который поддерживает запрошенный размер виртуальной машины.

## <a name="allocation-scenario-affinity-group-vmservice-proximity"></a>Сценарий выделения: территориальная группа (взаимодействие с виртуальными машинами или службами)
**Ошибка**

New_General* или New_VMSizeNotSupported*

**Причина прикрепления к кластеру**

Все вычислительные ресурсы, назначенные территориальной группе, привязываются к одному кластеру. Попытки выполнения запросов на новые вычислительные ресурсы в этой территориальной группе должны осуществляться в том же кластере, в котором размещены существующие ресурсы. Это не зависит от того, создаются ли новые ресурсы на основе новой облачной службы или существующей облачной службы.

**Возможное решение**

Если территориальная группа не нужна, не используйте ее или сгруппируйте вычислительные ресурсы в нескольких территориальных группах.

## <a name="allocation-scenario-affinity-group-based-virtual-network"></a>Сценарий выделения: виртуальная сеть на основе территориальной группы
**Ошибка**

New_General* или New_VMSizeNotSupported*

**Причина прикрепления к кластеру**

Прежде чем объявить региональную виртуальную сеть, необходимо связать виртуальную сеть с территориальной группой. В результате к вычислительным ресурсам, помещенным в территориальную группу, будут применены ограничения, описанные в разделе "Сценарий выделения: территориальная группа (взаимодействие с виртуальными машинами или службами)" выше. Вычислительные ресурсы будут привязаны к одному кластеру.

**Возможное решение**

Если территориальная группа не нужна, создайте региональную виртуальную сеть для новых ресурсов, которые вы собираетесь добавить, а затем [подключите имеющуюся виртуальную сеть к новой виртуальной сети](https://azure.microsoft.com/blog/vnet-to-vnet-connecting-virtual-networks-in-azure-across-different-regions/). См. дополнительные сведения о [региональных виртуальных сетях](https://azure.microsoft.com/blog/2014/05/14/regional-virtual-networks/).

Кроме того, можно [перенести виртуальную сеть на основе территориальной группы в региональную виртуальную сеть](https://azure.microsoft.com/blog/2014/11/26/migrating-existing-services-to-regional-scope/), а затем снова добавить необходимые ресурсы.

## <a name="detailed-troubleshooting-steps-specific-allocation-failure-scenarios-in-the-azure-resource-manager-deployment-model"></a>Подробные инструкции по устранению конкретных ошибок выделения ресурсов в модели развертывания Azure Resource Manager.
В этом разделе описаны распространенные сценарии выделения ресурсов, которые приводят к прикреплению запросов на выделение. Каждый сценарий мы более подробно рассмотрим ниже.

* Изменение размера виртуальной машины или добавление дополнительных виртуальных машин или экземпляров ролей в существующую облачную службу
* Перезапустите частично остановленные (освобожденные) виртуальные машины
* Перезапустите полностью остановленные (освобожденные) виртуальные машины

При возникновении ошибки выделения ресурсов проверьте, не соответствует ли ваша ситуация одному из этих сценариев. Используйте ошибку выделения, возвращенную платформой Azure, чтобы определить соответствующий сценарий. Если выполненный запрос прикреплен к существующему кластеру, попробуйте удалить некоторые ограничения этого прикрепления, чтобы распространить запрос на большее количество кластеров и тем самым повысить вероятность успешного выделения.

Как правило, если в сообщении об ошибке не сказано о том, что запрошенный размер виртуальной машины не поддерживается, можно повторить попытку позже, так как в кластере может быть освобождено достаточно ресурсов, чтобы выполнить запрос. Если проблема заключается в том, что запрошенный размер виртуальной машины не поддерживается, см. способы решения ниже.

## <a name="allocation-scenario-resize-a-vm-or-add-vms-to-an-existing-availability-set"></a>Сценарий выделения: изменение размера виртуальной машины или добавление виртуальных машин в существующую группу доступности
**Ошибка**

Upgrade_VMSizeNotSupported* или GeneralError*

**Причина прикрепления к кластеру**

Попытка выполнить запрос на изменение размера виртуальной машины или ее добавление в существующую группу доступности должна осуществляться в исходном кластере, в котором размещена существующая группа доступности. Если создать новую группу доступности, платформа Azure сможет найти другой кластер, в котором есть свободные ресурсы или который поддерживает запрошенный размер виртуальной машины.

**Возможное решение**

При возникновении ошибки Upgrade_VMSizeNotSupported* попробуйте изменить размер виртуальной машины. Если использовать другой размер для виртуальной машины нецелесообразно, остановите все виртуальные машины, входящие в эту группу доступности. После этого вы сможете изменить размер виртуальной машины, чтобы выделить ее для кластера, который поддерживает виртуальные машины необходимого размера.

Если возникла ошибка GeneralError*, это означает, что кластер, скорее всего, поддерживает этот тип ресурса (например виртуальные машины определенного размера), но сейчас в нем нет свободных ресурсов. Если виртуальная машина может быть частью другой группы доступности, создайте новую виртуальную машину в другой группе доступности (в том же регионе). Затем новую виртуальную машину можно добавить в ту же виртуальную сеть.  

## <a name="allocation-scenario-restart-partially-stopped-deallocated-vms"></a>Сценарий выделения: перезапустите частично остановленные (освобожденные) виртуальные машины
**Ошибка**

GeneralError*

**Причина прикрепления к кластеру**

Частичное освобождение означает, что в группе доступности будут остановлены (освобождены) одна или несколько виртуальных машин, но не все. При остановке (освобождении) виртуальной машины происходит освобождение связанных с ней ресурсов. Таким образом, перезагрузка остановленной (освобожденной) виртуальной машины предусматривает выполнение нового запроса. Перезапуск виртуальных машин в частично освобожденной группе доступности эквивалентен добавлению виртуальных машин к существующей группе доступности. Попытка выполнения запроса должна осуществляться в исходном кластере, в котором размещена существующая группа доступности.

**Возможное решение**

Прежде чем перезагрузить первую виртуальную машину, попробуйте остановить работу всех виртуальных машин в группе доступности. Это обеспечит выполнение новой попытки выделения и возможность выбора нового кластера с доступной емкостью.

## <a name="allocation-scenario-restart-fully-stopped-deallocated"></a>Сценарий выделения: перезапустите полностью остановленные (освобожденные) виртуальные машины
**Ошибка**

GeneralError*

**Причина прикрепления к кластеру**

Полное освобождение означает, что в группе доступности остановлены (освобождены) все виртуальные машины. Запрос на выделение ресурсов для перезагрузки этих виртуальных машин будет ориентирован на все кластеры, которые поддерживают машины нужного размера.

**Возможное решение**

Попробуйте выбрать другой размер виртуальной машины для выделения. Если это не сработает, повторите попытку позже.

<a name="Error string lookup"></a>

## <a name="error-string-lookup"></a>Значение строк ошибок
**New_VMSizeNotSupported***

"Нельзя выделить память, требуемую для этого развертывания, в соответствии с указанным размером виртуальной машины (или сочетанием размеров нескольких виртуальных машин) из-за ограничений в запросе на развертывание. Если возможно, попробуйте уменьшить ограничения в отношении привязок к виртуальной сети, выполнить развертывание в размещенной службе, в которой больше нет развертываний, и в другой территориальной группе или без использования территориальной группы либо выполнить развертывание в другом регионе."

**New_General***

"Произошла ошибка выделения. Не удалось установить соответствие ограничениям в запросе. Запрошенное новое развертывание службы привязано к территориальной группе, предназначено для выполнения в виртуальной сети, или в этой размещенной службе уже существует развертывание. Любое из этих условий ограничивает новое развертывание использованием определенных ресурсов Azure. Повторите попытку позже или попробуйте уменьшить размер виртуальной машины или количество экземпляров ролей. Кроме того, по возможности удалите вышеупомянутые ограничения или попробуйте выполнить развертывание в другом регионе".

**Upgrade_VMSizeNotSupported***

"Не удалось обновить развертывание. Возможно, запрошенный размер виртуальной машины XXX недоступен в ресурсах, которые поддерживают существующее развертывание. Повторите попытку позже, попробуйте использовать другой размер виртуальной машины или меньше экземпляров ролей либо создать развертывание в пустой размещенной службе с новой территориальной группой или без использования привязки к территориальной группе".

**GeneralError***

"Сервер обнаружил внутреннюю ошибку. Пожалуйста, повторите запрос". Или "Не удалось выполнить выделение ресурсов для службы".

