# Публикация на веб-сайтах Azure с использованием репозитория Git

Веб-сайты Azure поддерживают непрерывное развертывание из систем управления исходным кодом и таких репозиториев, как BitBucket, CodePlex, Dropbox, Git, GitHub, Mercurial и TFS. В этих репозиториях можно хранить содержание и код для вашего веб-сайта, а затем, когда это необходимо, быстро и просто передавать изменения на сайт.

В этой статье описывается использование Git для выполнения публикации непосредственно с локального компьютера на веб-сайт Azure (в Azure такой способ публикации называется **Локальный репозиторий Git**). Вы также узнаете, как включить непрерывное развертывание с таких веб-сайтов репозиториев, как BitBucket, CodePlex, Dropbox, GitHub или Mercurial. Информацию об использовании TFS для непрерывного развертывания см. в разделе [Непрерывная доставка в Azure с помощью Visual Studio Online].

> [WACOM.NOTE] Многие команды Git, описанные в этой статье, автоматически выполняются при создании веб-сайта с помощью <a href="/ru-ru/develop/nodejs/how-to-guides/command-line-tools/">средств командной строки Azure для Mac и Linux</a>.

Эта задача включает следующие шаги:

* [Установка Git](#Step1)
* [Создание локального репозитория](#Step2)
* [Добавление веб-страницы](#Step3)
* [Включение репозитория веб-сайта](#Step4)
* [Развертывание проекта](#Step5)
	* [Принудительная отправка локальных файлов в Azure (локальный репозиторий Git)](#Step6)
	* [Развертывание файлов с веб-сайта репозиториев, например BitBucket, CodePlex, Dropbox, GitHub или Mercurial](#Step7)
	* [Развертывание решения Visual Studio из BitBucket, CodePlex, Dropbox, GitHub или Mercurial](#Step75)
* [Устранение неполадок](#Step8)

<h2><a id="Step2"></a>Установка Git</h2>

Действия, необходимые для установки Git, отличаются в разных операционных системах. Сведения о дистрибутивах для разных операционных систем и руководство по установке см. в разделе [Установка Git].

> [WACOM.NOTE] В некоторых операционных системах будут доступны обе версии Git - для командной строки и с графическим интерфейсом. В инструкциях, приведенных в данной статье, используется версия для командной строки.

<h2><a id="Step2"></a>Создание локального репозитория</h2>

Чтобы создать новый репозиторий Git, выполните следующие задачи.

1. Создайте каталог с именем MyGitRepository для хранения файлов из репозитория Git и файлов веб-сайта.

2. Откройте окно командной строки, например **GitBash** (Windows) или **Bash** (оболочка Unix). На компьютерах с OS X доступ к командной строке можно получить через приложение **Terminal**.

3. В командной строке откройте каталог MyGitRepository.

		cd MyGitRepository

4. Используйте следующую команду, чтобы инициализировать новый репозиторий Git:

		git init

	При этом должно появиться сообщение **Initialized empty Git repository in [path]** (Инициализирован пустой репозиторий Git в [путь]).

<h2><a id="Step3"></a>Добавление веб-страницы</h2>

Веб-сайты Azure поддерживают приложения, созданные с использованием различных языков программирования. В этом примере будет использоваться статический HTML-файл. Сведения о публикации веб-сайтов, созданных с использованием других языков программирования в Azure, см. в [Центре разработчиков Azure].

1. С помощью текстового редактора создайте новый файл с именем **index.html** в корневой папке репозитория Git (каталоге MyGitRepository, созданном ранее).

2. Добавьте следующий текст в качестве содержимого файла index.html и сохраните его.

		Hello Git!

3. В командной строке убедитесь, что вы находитесь в корневом репозитории Git. Затем выполните следующую команду для добавления файла **index.html** в репозиторий:

		git add index.html 

	> [WACOM.NOTE] Справку по любой команде Git можно найти, введя-help или --help после команды. Например, для получения справочных сведений о параметрах для команды add введите "git add -help" для вызова справки в командной строке или "git add --help" для подробной справки.

4. Затем примените эти изменения к репозиторию с помощью следующей команды:

		git commit -m "Adding index.html to the repository"

	Вы должны увидеть результат, аналогичный приведенному ниже:

		[master (root-commit) 369a79c] Adding index.html to the repository
		 1 file changed, 1 insertion(+)
		 create mode 100644 index.html

<h2><a id="Step4"></a>Включение репозитория веб-сайта</h2>

Чтобы включить репозиторий Git для вашего веб-сайта с использованием портала Azure, выполните следующие действия.

1. Войдите на [портал Azure].

2. Нажмите кнопку "СОЗДАТЬ", чтобы создать новый веб-сайт, для которого будет включен репозиторий.

2. Дождитесь окончания процесса создания веб-сайта в представлении **Веб-сайты** и выберите этот веб-сайт.

	![An image displaying a selected web site][portal-select-website]

3. Перейдите на вкладку **ПАНЕЛЬ МОНИТОРИНГА**.

4. В разделе **Сводка** выберите **Настроить развертывания в системе управления версиями**.  Появится диалоговое окно **НАСТРОЙКА РАЗВЕРТЫВАНИЯ**.

	![git-WhereIsYourSourceCode][git-WhereIsYourSourceCode]

4. Выберите **Локальный репозиторий Git**, а затем щелкните стрелку **Далее**.

4. Если репозиторий в Azure настраивается вами впервые, потребуется создать для него учетную запись. Вы будете использовать данные этой учетной записи для входа в репозиторий Azure и отправки изменений из локального репозитория Git. 

	![](./media/publishing-with-git/git_credentials.png)
	
5. После небольшой задержки должно появиться сообщение о том, что ваш репозиторий готов. 

	![git-instructions][git-instructions]

<h2><a id="Step5"></a>Развертывание проекта</h2>

<h3><a id="Step6"></a>Принудительная отправка локальных файлов в Azure (локальный репозиторий Git)</h3>

На этом этапе на портале отображаются инструкции для инициализации локального репозитория и добавления файлов. Вы уже сделали это на предыдущем шаге в этом разделе. Тем не менее, если вы не настроили учетные данные развертывания, вернитесь на вкладку **ПАНЕЛЬ МОНИТОРИНГА** на портале и щелкните **Сброс учетных данных развертывания**.

Выполните следующие действия для публикации веб-сайта в Azure с помощью локального репозитория Git.

1. В командной строке убедитесь, что находитесь в корневой папке локального репозитория Git, которая содержит ранее созданный файл index.html.

2. Скопируйте команду git remote add, указанную на шаге 3 инструкций на портале. Она будет похожа на следующую команду:

		git remote add azure https://username@needsmoregit.scm.azurewebsites.net:443/NeedsMoreGit.git

    > [WACOM.NOTE]  Команда **remote** добавляет именованную ссылку на удаленный репозиторий. В этом примере создается ссылка с именем azure для репозитория веб-сайта Azure.

1. Введите следующую команду в командной строке для передачи содержимого текущего репозитория из локального репозитория в удаленный репозиторий "azure":

		git push azure master

	Вам будет предложено ввести пароль, созданный ранее при сбросе учетных данных развертывания на портале. Введите пароль (обратите внимание, что при вводе пароля Gitbash не выводит звездочки на консоль). Вы должны увидеть результат, аналогичный приведенному ниже.

		Counting objects: 6, done.
		Compressing objects: 100% (2/2), done.
		Writing objects: 100% (6/6), 486 bytes, done.
		Total 6 (delta 0), reused 0 (delta 0)
		remote: New deployment received.
		remote: Updating branch 'master'.
		remote: Preparing deployment for commit id '369a79c929'.
		remote: Preparing files for deployment.
		remote: Deployment successful.
		To https://username@needsmoregit.scm.azurewebsites.net:443/NeedsMoreGit.git
		* [new branch]		master -> master

	> [WACOM.NOTE] Репозиторий, созданный для вашего веб-сайта Azure, ожидает push-запросы для <strong>главной</strong> ветви репозитория, используемой далее в качестве содержимого данного веб-сайта.

2. На портале щелкните ссылку **ОБЗОР** в нижней части портала, чтобы убедиться, что файл **index.html** был развернут. Появится страница с текстом "Hello Git!".

	![A webpage containing 'Hello Git!'][hello-git]

3. С помощью текстового редактора измените файл **index.html**, чтобы он содержал текст "Yay!", а затем сохраните его.

4. Используйте следующие команды в командной строке, чтобы **добавить** и **применить** изменения, а затем **передать** эти изменения в удаленный репозиторий:

		git add index.html
		git commit -m "Celebration"
		git push azure master

	После выполнения команды **push** обновите страницу в браузере (для правильного обновления страницы в браузере может потребоваться нажать Ctrl+F5) и обратите внимание, что содержимое страницы теперь соответствует новейшему примененному изменению.

	![A webpage containing 'Yay!'][yay]

<h3><a id="Step7"></a>Развертывание файлов с веб-сайта репозиториев, например BitBucket, CodePlex, Dropbox, GitHub или Mercurial</h3>

Передача локальных файлов в Azure с использованием локального репозитория Git позволяет вручную переносить обновления из локального проекта на веб-сайт Azure, тогда как развертывание из BitBucket, CodePlex, Dropbox, GitHub или Mercurial приводит к формированию непрерывного процесса развертывания, в котором Azure будет получать самые последние обновления по мере развития вашего проекта.

Хотя оба способа обеспечивают развертывание вашего проекта на веб-сайте Azure, однако непрерывное развертывание лучше, когда в работе в проекте участвуют несколько человек и требуется поддержка последней версии независимо от того, кто внес последнее обновление. Непрерывное развертывание удобно также при использовании одного из вышеупомянутых средств в качестве центрального репозитория для вашего приложения.

При развертывании файлов из GitHub, CodePlex или BitBucket локальный проект должен быть опубликован в одной из этих служб. Дополнительные сведения о публикации проекта в этих службах см. в разделах [Создание репозитория (GitHub)], [Использование Git с CodePlex], [Создание репозитория (BitBucket)], [Использование Dropbox для общего доступа к репозиториям Git] или [Краткое руководство - Mercurial].

1. Сначала поместите файлы веб-сайта в выбранный репозиторий, который будет использоваться для непрерывного развертывания.

2. На портале управления Azure вашего веб-сайта перейдите на вкладку **ПАНЕЛЬ МОНИТОРИНГА**. В разделе **Сводка** выберите **Настроить развертывания в системе управления версиями**.  Появится диалоговое окно **Настроить развертывание** с запросом **Где исходный код?**. 

2. Выберите метод управления версиями, который будет использоваться для непрерывного развертывания.
	
3. В ответ на запрос введите ваши учетные данные для выбранной службы.

4. После авторизации Azure для доступа к вашей учетной записи появится запрос со списком репозиториев. 

	![git-ChooseARepositoryToDeploy][git-ChooseARepositoryToDeploy]
  
5. Выберите репозиторий, который требуется связать с вашим веб-сайтом Azure. Щелкните значок галочки для продолжения.

	> [WACOM.NOTE] При включении непрерывного развертывания с использованием GitHub или BitBucket будут отображаться и открытые, и закрытые проекты.

6. Azure создаст связь с выбранным репозиторием и получит файлы из главной ветви. После завершения этого процесса в **истории развертывания** на странице **Развертывания** будет отображено сообщение **Активное развертывание**, аналогичное следующему:

	![git-githubdeployed][git-githubdeployed]

7. Теперь ваш проект развернут из выбранного репозитория на вашем веб-сайте Azure. Чтобы убедиться, что веб-сайт активен, щелкните ссылку **Обзор** в нижней части портала. Браузер должен перейти на этот веб-сайт.

8. Для проверки непрерывного развертывания внесите изменение в проект, а затем передайте это обновление в репозиторий, связанный с данным веб-сайтом. Ваш веб-сайт должен обновиться в соответствии с этими изменениями вскоре после их пересылки в репозиторий. Проверить получение сайтом данного обновления можно на странице **Развертывания** вашего веб-сайта.

	![git-GitHubDeployed-Updated][git-GitHubDeployed-Updated]

<h3><a id="Step75"></a>Развертывание решения Visual Studio из BitBucket, CodePlex, Dropbox, GitHub или Mercurial</h3>

Передать решение Visual Studio на веб-сайт Azure так же просто, как отправить файл index.html. Процесс развертывания веб-сайтов Azure упрощает выполнение всех операций, включая восстановление зависимостей NuGet и создание двоичных файлов приложения. Вы можете воспользоваться практическими рекомендациями по управлению версиями в репозитории Git, оставив все остальные операции средствам развертывания веб-сайтов Azure.

Операции по передаче решения Visual Studio на веб-сайт Azure такие же, как и описанные в [предыдущем разделе](#Step7), при условии, что решение и репозиторий настроены следующим образом.

-	В корневую папку репозитория добавьте файл .gitignore, а затем укажите все файлы и папки, которые нужно исключить из репозитория, например папки Obj, Bin и packages (см. информацию о формате в [документации по gitignore](http://git-scm.com/docs/gitignore)). Например: 

		[Oo]bj/
		[Bb]in/
		*.user
		/TestResults
		*.vspscc
		*.vssscc
		*.suo
		*.cache
		*.csproj.user
		packages/*
		App_Data/
		/apps
		msbuild.log
		_app/
		nuget.exe

	>[WACOM.NOTE] В случае использования GitHub при создании репозитория по необходимости можно создать файл .gitignore для Visual Studio, куда будут включены все обычные временные файлы, результаты построения и т. д. Этот файл можно будет изменить, приспособив под конкретные нужды.

-	Добавьте в репозиторий все дерево каталогов решения с файлом .sln в корневой папке репозитория.

-	В решении Visual Studio [включите восстановление пакетов NuGet](http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages), чтобы Visual Studio автоматически восстанавливала недостающие пакеты.

После настройки репозитория согласно описанию и настройке веб-сайта Azure для непрерывной публикации из одного из сетевых репозиториев Git можно разрабатывать приложение ASP.NET локально в Visual Studio и непрерывно развертывать свой код путем простой отправки изменений в сетевой репозиторий Git.

<h4>Как реализуется непрерывное развертывание</h4>
Непрерывное развертывание реализуется посредством предоставления **URL-АДРЕСА ДЛЯ ЗАПУСКА РАЗВЕРТЫВАНИЯ** в разделе **развертывания** на вкладке **Настройка** вашего веб-сайта.

![git-DeploymentTrigger][git-DeploymentTrigger]

При обновлении вашего репозитория по этому URL-адресу отправляется запрос POST с уведомлением в адрес вашего веб-сайта Azure об обновлении репозитория. После этого обновление извлекается и развертывается на вашем веб-сайте.

Дополнительные сведения о механизме процесса развертывания Git для веб-сайтов Azure см. на сайте [Project Kudu](https://github.com/projectkudu/kudu/wiki).

<h4>Указание используемой ветви</h4>

При включении непрерывного развертывания по умолчанию будет использоваться **главная** ветвь репозитория. Если требуется другая ветвь, выполните следующие действия.

1. На портале выберите ваш веб-сайт, а затем щелкните **НАСТРОИТЬ**.

2. В разделе **Развертывания** страницы укажите ветвь, которую требуется использовать, в поле **ВЕТВЬ ДЛЯ РАЗВЕРТЫВАНИЯ**, а затем нажмите клавишу ВВОД. Наконец, нажмите кнопку **СОХРАНИТЬ**.

	Azure немедленно начнет выполнять обновление на основе изменений новой ветви.

<h4>Отключение непрерывного развертывания</h4>

Непрерывное развертывание можно отключить на **панели мониторинга** Azure. В разделе **Сводка** выберите вариант отключения от используемого репозитория.

![git-DisconnectFromGitHub][git-DisconnectFromGitHub]	

Ответив **Да** на сообщение о подтверждении, вы можете вернуться к разделу **Сводка** и щелкнуть **Настроить развертывания в системе управления версиями**, если требуется настроить публикацию из другого источника.

<h2><a id="Step8"></a>Устранение неполадок</h2>

Ниже перечислены ошибки и проблемы, обычно возникающие при использовании Git для публикации на веб-сайте Azure.

****

**Симптом**. Unable to access '[siteURL]':Failed to connect to [scmAddress]

**Причина**. Эта ошибка возникает, если веб-сайт не работает.

**Способы устранения**. Запустите веб-сайт на портале Azure. Развертывание Git не будет работать, пока веб-сайт не запущен. 


****

**Симптом**. Couldn't resolve host 'hostname'

**Причина**. Эта ошибка может возникнуть, если при создании удаленного репозитория azure был введен неправильный адрес.

**Способы устранения**. Используйте команду "git remote -v", чтобы вывести список всех удаленных репозиториев с соответствующими URL-адресами. Проверьте правильность URL-адреса удаленного репозитория "azure". При необходимости удалите и повторно создайте этот удаленный репозиторий, используя правильный URL-адрес.

****

**Симптом**. No refs in common and none specified; doing nothing. Perhaps you should specify a branch such as 'master'.

**Причина**. Эта ошибка может возникать, если не указана ветвь при выполнении операции git push и не задано значение push.default, используемое Git.

**Способы устранения**. Снова выполните операцию принудительной отправки, указав главную ветвь (master). Например: 

	git push azure master

****

**Симптом**. src refspec [branchname] does not match any.

**Причина**. Эта ошибка может возникнуть при попытке принудительно отправить данные в ветвь, отличную от главной, в удаленном репозитории azure.

**Способы устранения**. Снова выполните операцию принудительной отправки, указав главную ветвь (master). Например: 

	git push azure master

****

**Симптом**. Error - Changes commited to remote repository but your website not updated.

**Причина**. Эта ошибка может возникнуть при развертывании приложения Node.js, содержащего файл package.json, в котором указаны дополнительные необходимые модули.

**Способы устранения**. До этой ошибки должны быть записаны в журнал дополнительные сообщения, содержащие "npm ERR!", и они могут предоставлять дополнительный контекст для данного сбоя. Ниже перечислены известные причины этой ошибки и соответствующее сообщение "npm ERR!".

* **Неправильно сформированный файл package.json**: npm ERR! Не удалось прочитать зависимости.

* **Собственный модуль, не имеющий двоичного дистрибутива для Windows**:

	* npm ERR! \`cmd "/c" "node-gyp rebuild"\` failed with 1

		ИЛИ

	* npm ERR! [modulename@version] preinstall: \`make || gmake\`


## Дополнительные ресурсы

* [Использование PowerShell для Azure]
* [Использование средств командной строки Azure для Mac и Linux]
* [Документация по Git]
* [Project Kudu](https://github.com/projectkudu/kudu/wiki)

[Центр разработчиков Azure]: http://www.windowsazure.com/ru-ru/develop/overview/
[Портал Azure]: http://manage.windowsazure.com
[Веб-сайт Git]: http://git-scm.com
[Установка Git]: http://git-scm.com/book/en/Getting-Started-Installing-Git
[Использование PowerShell для Azure]: http://www.windowsazure.com/ru-ru/develop/nodejs/how-to-guides/powershell-cmdlets/
[Использование средств командной строки Azure для Mac и Linux]: /ru-ru/develop/nodejs/how-to-guides/command-line-tools/
[Документация по Git]: http://git-scm.com/documentation

[portal-select-website]: ./media/publishing-with-git/git-select-website.png
[git-WhereIsYourSourceCode]: ./media/publishing-with-git/git-WhereIsYourSourceCode.png
[git-instructions]: ./media/publishing-with-git/git-instructions.png
[portal-deployment-credentials]: ./media/publishing-with-git/git-deployment-credentials.png

[git-ChooseARepositoryToDeploy]: ./media/publishing-with-git/git-ChooseARepositoryToDeploy.png
[hello-git]: ./media/publishing-with-git/git-hello-git.png
[yay]: ./media/publishing-with-git/git-yay.png
[git-githubdeployed]: ./media/publishing-with-git/git-GitHubDeployed.png
[git-GitHubDeployed-Updated]: ./media/publishing-with-git/git-GitHubDeployed-Updated.png
[git-DisconnectFromGitHub]: ./media/publishing-with-git/git-DisconnectFromGitHub.png
[git-DeploymentTrigger]: ./media/publishing-with-git/git-DeploymentTrigger.png
[Создание репозитория (GitHub)]: https://help.github.com/articles/create-a-repo
[Использование Git с CodePlex]: http://codeplex.codeplex.com/wikipage?title=Using%20Git%20with%20CodePlex&referringTitle=Source%20control%20clients&ProjectName=codeplex
[Создание репозитория (BitBucket)]: https://confluence.atlassian.com/display/BITBUCKET/Create+an+Account+and+a+Git+Repo
[Краткое руководство - Mercurial]: http://mercurial.selenic.com/wiki/QuickStart
[Использование Dropbox для общего доступа к репозиториям Git]: https://gist.github.com/trey/2722927
[Непрерывная доставка в Azure с использованием Visual Studio Online]: http://www.windowsazure.com/ru-ru/develop/net/common-tasks/publishing-with-tfs/
