# Непрерывное развертывание с использованием GIT в службе приложений Azure

[Служба приложений Azure](http://go.microsoft.com/fwlink/?LinkId=529714) поддерживает непрерывное развертывание в веб-приложениях из таких инструментов управления исходным кодом и репозиториев, как BitBucket, CodePlex, Dropbox, Git, GitHub, Mercurial и TFS. Вы можете использовать эти средства для хранения содержимого и кода для вашего приложения, а затем быстро и легко принудительно отправлять изменения в веб-приложение, когда это требуется.

В этой статье описывается использование Git для выполнения публикации непосредственно с локального компьютера в веб-приложения (в Azure такой способ публикации называется **локальным репозиторием Git**). Вы также узнаете, как включить непрерывное развертывание с таких сайтов репозиториев, как BitBucket, CodePlex, Dropbox, GitHub или Mercurial. Информацию об использовании TFS для непрерывного развертывания см. в разделе [Непрерывная доставка в Azure с помощью Visual Studio Online].

> [AZURE.NOTE]Многие команды Git, описанные в этой статье, автоматически выполняются при создании веб-приложения с помощью [программ командной строки Azure для Mac и Linux](/develop/nodejs/how-to-guides/command-line-tools/).

## <a id="Step1"></a>Шаг 1. Установка Git

Действия, необходимые для установки Git, отличаются в разных операционных системах. Сведения о дистрибутивах для разных операционных систем и руководство по установке см. в разделе [Установка Git].

> [AZURE.NOTE]В некоторых операционных системах доступны обе версии Git — для командной строки и с графическим интерфейсом. В инструкциях, приведенных в данной статье, используется версия для командной строки.

## <a id="Step2"></a>Шаг 2. Создание локального репозитория

Чтобы создать новый репозиторий Git, выполните следующие задачи.

1. Создайте каталог с именем MyGitRepository для хранения файлов из репозитория Git и файлов веб-приложения.

2. Откройте окно программы командной строки, например **GitBash** (Windows) или **Bash** (оболочка Unix). На компьютерах с OS X доступ к командной строке можно получить через приложение **Terminal**.

3. В командной строке откройте каталог MyGitRepository.

		cd MyGitRepository

4. Используйте следующую команду, чтобы инициализировать новый репозиторий Git:

		git init

	При этом должно появиться сообщение **Initialized empty Git repository in [path]** (Инициализирован пустой репозиторий Git в [папке]).

## <a id="Step3"></a>Шаг 3. Добавление веб-страницы

Веб-приложения поддерживают приложения, созданные с использованием различных языков программирования. В этом примере будет использоваться статический HTML-файл.

1. С помощью текстового редактора создайте новый файл с именем **index.html** в корневой папке репозитория Git (в созданной ранее папке MyGitRepository).

2. Добавьте следующий текст в качестве содержимого файла index.html и сохраните его.

		Hello Git!

3. Проверьте в командной строке свое нахождение в корневой папке репозитория Git. Затем выполните следующую команду для добавления файла **index.html** в репозиторий:

		git add index.html 

	> [AZURE.NOTE]Справку по любой команде Git можно найти, введя "-help" или "--help" после команды. Например, для получения справочных сведений о параметрах для команды add введите "git add -help" для вызова справки в командной строке или "git add --help" для подробной справки.

4. Затем примените эти изменения к репозиторию с помощью следующей команды:

		git commit -m "Adding index.html to the repository"

	Вы должны увидеть результат, аналогичный приведенному ниже:

		[master (root-commit) 369a79c] Adding index.html to the repository
		 1 file changed, 1 insertion(+)
		 create mode 100644 index.html

## <a id="Step4"></a>Включение репозитория веб-приложения

Чтобы включить репозиторий Git для веб-приложения, сделайте следующее:

1. Выполните вход на [портал предварительной версии Azure].

2. В колонке веб-приложения прокрутите вниз, чтобы перейти к разделу **Развертывание**, и щелкните пункт **Настройка непрерывного развертывания**. Щелкните **Выбор источника**, затем щелкните **Локальный репозиторий Git** и нажмите кнопку **OK**.

	![Локальный репозиторий Git](./media/publishing-with-git/azure1-local-git.png)

4. Если репозиторий в Azure настраивается вами впервые, потребуется создать для него учетную запись. Вы будете использовать данные этой учетной записи для входа в репозиторий Azure и отправки изменений из локального репозитория Git. В колонке веб-приложения щелкните **Параметры > Учетные данные развертывания**, а затем настройте имя пользователя и пароль развертывания. Закончив, нажмите кнопку **OK**.

	![](./media/publishing-with-git/azure2-credentials.png)

## <a id="Step5"></a>Развертывание проекта

* [Принудительная отправка локальных файлов в Azure (локальный репозиторий Git)](#Step6)
* [Развертывание файлов с веб-сайта репозиториев, например BitBucket, CodePlex, Dropbox, GitHub или Mercurial](#Step7)
* [Развертывание решения Visual Studio из BitBucket, CodePlex, Dropbox, GitHub или Mercurial](#Step75)

Чтобы опубликовать веб-приложение в Azure с помощью локального репозитория Git, сделайте следующее.

1. В колонке веб-приложения в разделе «Развертывание» щелкните **Развертывание не найдено**.

	![](./media/publishing-with-git/azure3-repo-details.png)

	**URL-адрес Git** содержит внешнюю ссылку для развертывания из вашего локального репозитория. Этот URL-адрес будет использоваться на следующих шагах.

1. В командной строке убедитесь, что находитесь в корневой папке локального репозитория Git, которая содержит ранее созданный файл index.html.

2. Используйте `git remote` для добавления внешней ссылки, указанной в пункте **URL-адрес Git** на шаге 1. Команда будет выглядеть примерно следующим образом:

		git remote add azure https://username@needsmoregit.scm.azurewebsites.net:443/NeedsMoreGit.git

    > [AZURE.NOTE]Команда **remote** добавляет именованную ссылку на удаленный репозиторий. В этом примере создается ссылка с именем azure для репозитория вашего веб-приложения.

1. Введите следующую команду в командной строке для передачи содержимого текущего репозитория из локального репозитория в удаленный репозиторий "azure":

		git push azure master

	Вам предложат ввести пароль, созданный ранее при сбросе учетных данных развертывания на портале. Введите пароль (обратите внимание, что при вводе пароля Gitbash не выводит звездочки на консоль). Вы должны увидеть результат, аналогичный приведенному ниже:

		Counting objects: 6, done.
		Compressing objects: 100% (2/2), done.
		Writing objects: 100% (6/6), 486 bytes, done.
		Total 6 (delta 0), reused 0 (delta 0)
		remote: New deployment received.
		remote: Updating branch 'master'.
		remote: Preparing deployment for commit id '369a79c929'.
		remote: Preparing files for deployment.
		remote: Deployment successful.
		To https://username@needsmoregit.scm.azurewebsites.net:443/NeedsMoreGit.git
		* [new branch]		master -> master

	> [AZURE.NOTE]Репозиторий, созданный для вашего веб-приложения, ожидает push-запросы к <strong>главной</strong> ветви репозитория, которая затем будет использоваться в качестве содержимого данного веб-сайта.

2. Перейдите к колонке вашего веб-приложения на портале Azure. Вместо сообщения **Развертывание не найдено** должно отображаться сообщение **Активное развертывание **и запись журнала с последним push-запросом.

	![](./media/publishing-with-git/azure4-deployed.png)

2. В верхней части колонки веб-приложения щелкните ссылку под пунктом **URL-адрес**, чтобы убедиться, что **index.html** был развернут. Появится страница с текстом "Hello Git!".

	![Веб-страница с текстом "Hello Git!"][hello-git]

3. С помощью текстового редактора измените файл **index.html**, чтобы он содержал текст "Yay!", а затем сохраните его.

4. Используйте следующие команды в командной строке, чтобы **добавить** и **применить** изменения, а затем **передать** эти изменения в удаленный репозиторий:

		git add index.html
		git commit -m "Celebration"
		git push azure master

	После выполнения команды **push** обновите страницу в браузере (для правильного обновления страницы в браузере может потребоваться нажать Ctrl+F5) и обратите внимание, что контент страницы теперь соответствует новейшему примененному изменению.

### <a id="Step7"></a>Развертывание файлов с сайта репозиториев, например BitBucket, CodePlex, Dropbox, GitHub или Mercurial

Передача локальных файлов в Azure с использованием локального репозитория Git позволяет вручную переносить обновления из локального проекта в веб-приложение в Azure, тогда как развертывание из BitBucket, CodePlex, Dropbox, GitHub или Mercurial приводит к формированию непрерывного процесса развертывания, в котором Azure будет получать самые последние обновления по мере развития вашего проекта.

Хотя оба способа обеспечивают развертывание вашего проекта в веб-приложения, однако непрерывное развертывание лучше, когда в работе в проекте участвуют несколько человек и требуется поддержка последней версии независимо от того, кто внес последнее обновление. Непрерывное развертывание удобно также при использовании одного из вышеупомянутых средств в качестве центрального репозитория для вашего приложения.

Развертывание файлов из GitHub, CodePlex или BitBucket требует, чтобы локальный проект был опубликован в одной из этих служб. Дополнительные сведения о публикации проекта в этих службах см. в разделах [Создание репозитория (GitHub)], [Использование Git с CodePlex], [Создание репозитория (BitBucket)], [Использование Dropbox для общего доступа к репозиториям Git] или [Краткое руководство — Mercurial]

1. Сначала поместите файлы веб-приложения в выбранный репозиторий, который будет использоваться для непрерывного развертывания.

2. В колонке веб-приложения на портале прокрутите вниз, чтобы перейти к разделу **Развертывание**, и щелкните **Настройка непрерывного развертывания**. Щелкните **Выбор источника** и выберите, например, источник **GitHub**.

	![](./media/publishing-with-git/azure6-setup-github.png)
	
2. В колонке **Непрерывное развертывание** последовательно щелкните **Авторизация** и **Авторизовать**. Вы будете перенаправлены с портала Azure на сайт репозитория для завершения авторизации.

4. После этого вернитесь на портал Azure и нажмите кнопку **OK** в колонке **Авторизация**.

5. В колонке **Непрерывное развертывание** выберите организацию, проект и ветвь, из которой необходимо выполнить развертывание. Закончив, нажмите кнопку **OK**.
  
	![](./media/publishing-with-git/azure7-setup-github-configure.png)

	> [AZURE.NOTE]При включении непрерывного развертывания с использованием GitHub или BitBucket будут отображаться и открытые, и закрытые проекты.

Azure создаст связь с выбранным репозиторием и получит файлы из указанной ветви. После завершения процесса в разделе **Развертывание** колонки вашего веб-приложения появится сообщение **Активное развертывание**, что означает успешное завершение развертывания.

7. Теперь ваш проект развернут из выбранного репозитория в вашем веб-приложении. Чтобы убедиться, что веб-приложение активно, щелкните **URL-адрес** в верхней части портала. Браузер должен перейти на это веб-приложение.

8. Чтобы убедиться, что непрерывное развертывание выполняется из выбранного репозитория, отправьте в этот репозиторий изменения. Ваше веб-приложение должно обновиться в соответствии с этим изменением вскоре после выполнения его отправки в репозиторий. Вы можете убедиться в том, что данное обновление получено приложением, в колонке **Развертывания** веб-приложения.

### <a id="Step75"></a>Развертывание решения Visual Studio из BitBucket, CodePlex, Dropbox, GitHub или Mercurial

Передать решение Visual Studio в веб-приложения в службе приложений Azure так же просто, как и отправить файл index.html. Процесс развертывания веб-приложений Azure упрощает выполнение всех операций, включая восстановление зависимостей NuGet и создание двоичных файлов приложения. Вы можете воспользоваться практическими рекомендациями по управлению версиями в репозитории Git, оставив все остальные операции средствам развертывания веб-приложений Azure.

Операции по передаче решения Visual Studio на веб-сайт Azure такие же, как и описанные в [предыдущем разделе](#Step7), при условии, что решение и репозиторий настроены следующим образом.

-	В корневую папку репозитория добавьте файл `.gitignore`, а затем укажите все файлы и папки, которые нужно исключить из репозитория, например папки `Obj`, `Bin` и `packages` (см. информацию о формате в [документации по gitignore](http://git-scm.com/docs/gitignore)). Например:

		[Oo]bj/
		[Bb]in/
		*.user
		/TestResults
		*.vspscc
		*.vssscc
		*.suo
		*.cache
		*.csproj.user
		packages/*
		App_Data/
		/apps
		msbuild.log
		_app/
		nuget.exe

	>[AZURE.NOTE]В случае использования GitHub при создании репозитория при необходимости можно создать GITIGNORE-файл для Visual Studio, куда будут включены все обычные временные файлы, результаты сборки и т. д. Этот файл можно будет изменить, приспособив под конкретные нужды.

-	Добавьте в репозиторий все дерево каталогов решения с файлом .sln в корневой папке репозитория.

-	В решении Visual Studio [включите восстановление пакетов NuGet](http://docs.nuget.org/Consume/Package-Restore), чтобы Visual Studio автоматически восстанавливала недостающие пакеты.

После настройки репозитория согласно описанию и настройке веб-приложения Azure для непрерывной публикации из одного из сетевых репозиториев Git можно разрабатывать приложение ASP.NET локально в Visual Studio и непрерывно развертывать свой код путем простой отправки изменений в сетевой репозиторий Git.

## Отключение непрерывного развертывания

Непрерывное развертывание можно отключить в колонке **Развертывания**. В колонке веб-приложения в разделе **Развертывание** щелкните **Активное развертывание**. Нажмите кнопку **Отключить**.

![git-DisconnectFromGitHub](./media/publishing-with-git/azure5-disconnect.png)

Ответив **Да** на сообщение о подтверждении, вы можете вернуться к колонке веб-приложения и щелкнуть **Настройка непрерывного развертывания**, если требуется настроить публикацию из другого источника.

## <a id="Step8"></a>Устранение неполадок

Ниже перечислены ошибки или проблемы, обычно возникающие при использовании Git для публикации в веб-приложении в Azure.

****

**Симптом**: Не удалось подключиться к [scmAddress]: Нет доступа к [siteURL]:

**Причина**: эта ошибка выдается, если веб-приложение не работает.

**Устранение**: запустите веб-приложение на портале Azure. Развертывание Git не будет работать, пока веб-приложение не запущено.


****

**Симптом**: не удается разрешить hostname узла.

**Причина**: эта ошибка может возникнуть, если при создании удаленного репозитория azure был введен неправильный адрес.

**Устранение**: используйте команду `git remote -v`, чтобы вывести список всех удаленных репозиториев с соответствующими URL-адресами. Проверьте правильность URL-адреса удаленного репозитория "azure". При необходимости удалите и повторно создайте этот удаленный репозиторий, используя правильный URL-адрес.

****

**Симптом**: нет ссылок и ничего не указано; ничего не выполняется. Возможно, следует указать ветвь, например master.

**Причина**: эта ошибка может возникать, если не указана ветвь при выполнении операции принудительной отправки git и не задано значение push.default, используемое Git.

**Устранение**: снова выполните операцию принудительной отправки, указав главную ветвь. Например:

	git push azure master

****

**Симптом**: src refspec [имя_ветви] не соответствует никакой ветви.

**Причина**: эта ошибка может возникнуть при попытке принудительно отправить данные в ветвь, отличную от главной, в удаленном репозитории azure.

**Устранение**: снова выполните операцию принудительной отправки, указав главную ветвь. Например:

	git push azure master

****

**Симптом**: ошибка — изменения в удаленном репозитории внесены, но веб-приложение не обновилось.

**Причина**: эта ошибка может возникнуть при развертывании приложения Node.js, содержащего файл package.json, в котором указаны дополнительные необходимые модули.

**Устранение**: до этой ошибки должны быть зарегистрированы дополнительные сообщения, содержащие «npm ERR!»; они могут предоставить дополнительный контекст для данного сбоя. Ниже перечислены известные причины этой ошибки и соответствующее сообщение "npm ERR!".

* **Malformed package.json file**: npm ERR! Couldn't read dependencies (не удалось прочитать зависимости).

* **Собственный модуль, не имеющий двоичного дистрибутива для Windows**:

	* npm ERR! `cmd "/c" "node-gyp rebuild"` failed with 1

		ИЛИ

	* npm ERR! [имя_модуля@версия] preinstall: `make || gmake`


## Дополнительные ресурсы

* [Использование PowerShell для Azure]
* [Использование программ командной строки Azure для Mac и Linux]
* [Документация по Git]
* [Project Kudu](https://github.com/projectkudu/kudu/wiki)

>[AZURE.NOTE]Если вы хотите приступить к работе со службой приложений Azure до создания учетной записи Azure, перейдите к разделу [Пробное использование службы приложений](http://go.microsoft.com/fwlink/?LinkId=523751), где вы можете быстро создать кратковременное веб-приложение начального уровня в службе приложений. Никаких кредитных карт и обязательств.

## Изменения
* Указания по изменениям при переходе от веб-сайтов к службе приложений см. в разделе [Служба приложений Azure и ее влияние на существующие службы Azure](http://go.microsoft.com/fwlink/?LinkId=529714).
* Руководство по смене старого портала на новый портал см. в разделе [Справочник по навигации на предварительной версии портала](http://go.microsoft.com/fwlink/?LinkId=529715).

[Azure Developer Center]: http://azure.microsoft.com/develop/overview/
[портал предварительной версии Azure]: https://portal.azure.com
[Git website]: http://git-scm.com
[Установка Git]: http://git-scm.com/book/en/Getting-Started-Installing-Git
[Использование PowerShell для Azure]: ../articles/install-configure-powershell.md
[Использование программ командной строки Azure для Mac и Linux]: ../articles/xplat-cli.md
[Документация по Git]: http://git-scm.com/documentation

[portal-select-website]: ./media/publishing-with-git/git-select-website.png
[git-WhereIsYourSourceCode]: ./media/publishing-with-git/git-WhereIsYourSourceCode.png
[git-instructions]: ./media/publishing-with-git/git-instructions.png
[portal-deployment-credentials]: ./media/publishing-with-git/git-deployment-credentials.png

[git-ChooseARepositoryToDeploy]: ./media/publishing-with-git/git-ChooseARepositoryToDeploy.png
[hello-git]: ./media/publishing-with-git/git-hello-git.png
[yay]: ./media/publishing-with-git/git-yay.png
[git-githubdeployed]: ./media/publishing-with-git/git-GitHubDeployed.png
[git-GitHubDeployed-Updated]: ./media/publishing-with-git/git-GitHubDeployed-Updated.png
[git-DisconnectFromGitHub]: ./media/publishing-with-git/git-DisconnectFromGitHub.png
[git-DeploymentTrigger]: ./media/publishing-with-git/git-DeploymentTrigger.png
[Создание репозитория (GitHub)]: https://help.github.com/articles/create-a-repo
[Использование Git с CodePlex]: http://codeplex.codeplex.com/wikipage?title=Using%20Git%20with%20CodePlex&referringTitle=Source%20control%20clients&ProjectName=codeplex
[Создание репозитория (BitBucket)]: https://confluence.atlassian.com/display/BITBUCKET/Create+an+Account+and+a+Git+Repo
[Краткое руководство — Mercurial]: http://mercurial.selenic.com/wiki/QuickStart
[Использование Dropbox для общего доступа к репозиториям Git]: https://gist.github.com/trey/2722927
[Непрерывная доставка в Azure с помощью Visual Studio Online]: ../articles/cloud-services/cloud-services-continuous-delivery-use-vso.md

<!---HONumber=July15_HO3-->