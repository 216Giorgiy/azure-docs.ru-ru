# Публикация из системы управления версиями на веб-сайты Windows Azure

Веб-сайты Windows Azure поддерживают непрерывное развертывание из системы управления версиями и таких средств поддержки репозиториев, как BitBucket, CodePlex, Dropbox, Git, GitHub, Mercurial и TFS. Вы можете использовать эти средства для хранения контента и кода для вашего веб-сайта, а затем быстро и легко принудительно отправлять изменения на веб-сайт, когда это требуется.

Из этой статьи вы узнаете, как использовать Git для выполнения публикации непосредственно с локального компьютера на веб-сайт Windows Azure (в Windows Azure такой способ публикации называется **Локальный репозиторий Git**). Вы также узнаете, как включить непрерывное развертывание с таких веб-сайтов репозиториев, как BitBucket, CodePlex, DropBox, GitHub или Mercurial. Информацию об использовании TFS для непрерывного развертывания см. в разделе [Непрерывная доставка в Windows Azure с помощью Team Foundation Service].

<div class="dev-callout">
<strong>Примечание.</strong>
<p>Многие команды Git, описанные в этой статье, автоматически выполняются при создании веб-сайта с помощью <a href="/ru-ru/develop/nodejs/how-to-guides/command-line-tools/">средств командной строки Windows Azure для Mac и Linux</a>.</p>
</div>

Эта задача включает следующие шаги:

* [Установка Git](#Step1)
* [Создание локального репозитория](#Step2)
* [Добавление веб-страницы](#Step3)
* [Включение репозитория веб-сайта](#Step4)
* [Развертывание проекта](#Step5)
	* [Принудительная отправка локальных файлов в Windows Azure (Локальный репозиторий Git)](#Step6)
	* [Развертывание файлов с веб-сайта репозиториев, например BitBucket, CodePlex, Dropbox, GitHub или Mercurial](#Step7)
* [Устранение неполадок](#Step8)

<h2><a id="Step2"></a>Установка Git</h2>

Действия, необходимые для установки Git, отличаются в разных операционных системах. Сведения о дистрибутивах для разных операционных систем и руководство по установке см. в разделе [Установка Git].

<div class="dev-callout">
<strong>Примечание.</strong>
<p>В некоторых операционных системах будут доступны обе версии Git — для командной строки и с графическим интерфейсом. В инструкциях, приведенных в данной статье, используется версия для командной строки.</p>
</div>

<h2><a id="Step2"></a>Создание локального репозитория</h2>

Чтобы создать новый репозиторий Git, выполните следующие задачи.

1. Откройте окно командной строки, например **GitBash** (Windows) или **Bash** (оболочка Unix). На компьютерах с OS X доступ к командной строке можно получить через приложение **Terminal**.

2. В командной строке перейдите в каталог, в котором будет создан ваш веб-сайт. Например, "cd needsmoregit".

3. Используйте следующую команду, чтобы инициализировать новый репозиторий Git:

		git init

	При этом должно появиться сообщение **Initialized empty Git repository in [path]** (инициализирован пустой репозиторий Git в [папке]).

<h2><a id="Step3"></a>Добавление веб-страницы</h2>

Веб-сайты Windows Azure поддерживают приложения, созданные с использованием различных языков программирования. В этом примере будет использоваться статический HTML-файл. Сведения о публикации веб-сайтов, созданных с использованием других языков программирования, в Windows Azure см. в [Центре разработчиков Windows Azure].

1. С помощью текстового редактора создайте новый файл с именем **index.html** в корневой папке репозитория Git. Добавьте в качестве контента слова "Hello Git!", а затем сохраните файл.

2. В командной строке убедитесь, что вы находитесь в каталоге, в котором был создан репозиторий, и введите следующую команду, чтобы добавить файл **index.html** в этот репозиторий:

		git add index.html 

3. Затем примените эти изменения к репозиторию с помощью следующей команды:

		git commit -m "Adding index.html to the repository"

	Вы должны увидеть результат, аналогичный приведенному ниже:

		[master (root-commit) 369a79c] Adding index.html to the repository
		 1 file changed, 1 insertion(+)
		 create mode 100644 index.html

<h2><a id="Step4"></a>Включение репозитория веб-сайта</h2>

Чтобы включить репозиторий Git для вашего веб-сайта с использованием портала Windows Azure, выполните следующие действия:

1. Войдите на [портал Windows Azure].

2. В левой части страницы выберите **Веб-сайты**, а затем выберите веб-сайт, для которого требуется включить репозиторий.

	![Изображение, на котором показан выбранный веб-сайт][portal-select-website]

3. В разделе **Сводка** выберите **Настроить развертывания в системе управления версиями**.  Появится диалоговое окно **Настроить развертывание** с запросом **Где исходный код?**.

	![git-WhereIsYourSourceCode][git-WhereIsYourSourceCode]

4. Выберите **Локальный репозиторий Git**, а затем щелкните стрелку **Далее**.

	
5. После небольшой задержки должно появиться сообщение о том, что ваш репозиторий готов. 
	![git-instructions][git-instructions]

<h2><a id="Step5"></a>Развертывание проекта</h2>

<h3><a id="Step6"></a>Принудительная отправка локальных файлов в Windows Azure (Локальный репозиторий Git)</h3>

Поскольку вы уже инициализировали локальный репозиторий и добавили в него файлы, пропустите шаги 1 и 2 из инструкций, отображаемых на портале. В командной строке перейдите в каталог вашего веб-сайта и используйте команды, перечисленные в шаге 3 инструкций на портале. Например:

		git remote add azure http://username@needsmoregit.windowsazure.net/NeedsMoreGit.git


Команда **remote** добавляет именованную ссылку на удаленный репозиторий, в этом случае она создает ссылку с именем "azure" для вашего хранилища веб-сайта Windows Azure.

<h4>Публикация и повторная публикация веб-сайта</h4>

1. Введите следующую команду в командной строке для передачи содержимого текущего репозитория из локального репозитория в удаленный репозиторий "azure":

		git push azure master

	Вам предложат ввести пароль, созданный ранее при настройке репозитория. Введите пароль (обратите внимание, что при вводе пароля Gitbash не выводит звездочки на консоль), и вы увидите результат, аналогичный следующему:

		Подсчет объектов: 6, выполнено.
		Сжатие объектов: 100% (2/2), выполнено.
		Запись объектов: 100% (6/6), 486 байт, выполнено.
		Всего 6 (дельта 0), повторно использовано 0 (дельта 0)
		удаленный: получено новое развертывание.
		удаленный: обновление ветви "master".
		удаленный: подготовка развертывания для идентификатора фиксации "369a79c929".
		удаленный: подготовка файлов для развертывания.
		удаленный: успешное развертывание.
		Для http://username@needsmoregit.windowsauzre.net/NeedsMoreGit.git
		* [новая ветвь]		главный -> главный

	<div class="dev-callout">
	<strong>Примечание.</strong>
	<p>Репозиторий, созданный для вашего веб-сайта Windows Azure, ожидает push-запросы для <strong>главной</strong> ветви репозитория, который затем будет использоваться в качестве контента данного веб-сайта.</p>
	</div>

2. На портале щелкните ссылку **ОБЗОР** в нижней части портала, чтобы убедиться, что файл **index.html** был развернут. Появится страница с текстом "Hello Git!".

	![Веб-страница с текстом "Hello Git!"][hello-git]

3. С помощью текстового редактора измените файл **index.html**, чтобы он содержал текст "Yay!", а затем сохраните его.

4. Используйте следующие команды в командной строке, чтобы **добавить** и **применить** изменения, а затем **передать** эти изменения в удаленный репозиторий:

		git add index.html
		git commit -m "Celebration"
		git push azure master

	После выполнения команды **push** обновите страницу в браузере (для правильного обновления страницы в браузере может потребоваться нажать Ctrl+F5) и обратите внимание, что контент страницы теперь соответствует новейшему примененному изменению.

	![Веб-страница с текстом "Yay!"][yay]

<h3><a id="Step7"></a>Развертывание файлов с веб-сайта репозиториев, например BitBucket, CodePlex, Dropbox, GitHub или Mercurial</h3>

Помещение локальных файлов в Windows Azure с использованием локального репозитория Git позволяет вручную переносить обновления из локального проекта на веб-сайт Windows Azure, тогда как развертывание из BitBucket, CodePlex, Dropbox, GitHub или Mercurial приводит к формированию непрерывного процесса развертывания, в котором Windows Azure будет получать самые последние обновления из вашего проекта.

Хотя оба способа приводят к развертыванию вашего проекта на веб-сайте Windows Azure, непрерывное развертывание полезно, когда в работе над проектом участвуют несколько человек и требуется, чтобы новейшая версия всегда была опубликована независимо от того, кто внес последнее обновление. Непрерывное развертывание удобно также при использовании одного из вышеупомянутых средств в качестве центрального репозитория для вашего приложения.

Развертывание файлов из GitHub, CodePlex или BitBucket требует, чтобы локальный проект был опубликован в одной из этих служб. Дополнительные сведения о публикации проекта в этих службах см. в разделах [Создание репозитория (GitHub)], [Использование Git с CodePlex], [Создание репозитория (BitBucket)], [Использование Dropbox для общего доступа к репозиториям Git] или [Краткое руководство — Mercurial]

1. После того как проект веб-сайта принудительно отправлен на веб-сайт репозитория, в разделе **Сводка** портала Windows Azure выберите **Настроить развертывания в системе управления версиями**.  Появится диалоговое окно **Настроить развертывание** с запросом **Где исходный код?**. 

2. Выберите используемый вами метод управления версиями.
	
3. В ответ на запрос введите ваши учетные данные для выбранной службы.

4. После авторизации Windows Azure для доступа к вашей учетной записи появится запрос со списком репозиториев. 

	![git-ChooseARepositoryToDeploy][git-ChooseARepositoryToDeploy]
  
5. Выберите репозиторий, который требуется связать с вашим веб-сайтом Windows Azure. Снимите флажок для продолжения.

	<div class="dev-callout">
	<strong>Примечание.</strong>
	<p>При включении непрерывного развертывания с использованием GitHub или BitBucket будут отображаться и открытые, и закрытые проекты.</p>
</div>

6. Windows Azure создаст связь с выбранным репозиторием и получит файлы из главной ветви. После завершения этого процесса в **истории развертывания** на странице **Развертывания** будет отображено сообщение **Активное развертывание**, аналогичное следующему:

	![git-githubdeployed][git-githubdeployed]

7. На этом этапе ваш проект развернут из выбранного репозитория на вашем веб-сайте Windows Azure. Чтобы убедиться, что веб-сайт активен, щелкните ссылку **Обзор** в нижней части портала. Браузер должен перейти на этот веб-сайт.

8. Чтобы убедиться в том, что выполняется непрерывное развертывание, внесите изменение в проект, а затем принудительно отправьте это обновление в репозиторий, связанный с этим веб-сайтом. Ваш веб-сайт должен обновиться в соответствии с этими изменениями вскоре после выполнения их принудительной отправки в репозиторий. Вы можете убедиться в том, что данное обновление получено сайтом, на странице **Развертывания** вашего веб-сайта.

	![git-GitHubDeployed-Updated][git-GitHubDeployed-Updated]


<h4>Как реализуется непрерывное развертывание</h4>
Непрерывное развертывание реализуется посредством предоставления **URL-АДРЕСА ДЛЯ ЗАПУСКА РАЗВЕРТЫВАНИЯ** в разделе **развертывания** на вкладке **Настройка** вашего веб-сайта.

![git-DeploymentTrigger][git-DeploymentTrigger]

При обновлении вашего репозитория по этому URL-адресу отправляется запрос POST, уведомляющий ваш веб-сайт Windows Azure об обновлении репозитория. На этом этапе обновление извлекается и развертывается на вашем веб-сайте.

<h4>Указание ветви для использования</h4>

При включении непрерывного развертывания по умолчанию будет использоваться **главная** ветвь репозитория. Если требуется использовать другую ветвь, выполните следующие действия:

1. На портале выберите ваш веб-сайт, а затем выберите **НАСТРОИТЬ**.

2. В разделе **развертывания** страницы укажите ветвь, которую требуется использовать, в поле **ВЕТВЬ ДЛЯ РАЗВЕРТЫВАНИЯ**, а затем нажмите клавишу ВВОД. Наконец, нажмите кнопку **СОХРАНИТЬ**.

	Windows Azure немедленно начнет выполнять обновление на основе изменений новой ветви.

<h4>Отключение непрерывного развертывания</h4>

Непрерывное развертывание можно отключить на **панели мониторинга** Windows Azure. В разделе **Сводка** выберите вариант отключения от используемого репозитория:

![git-DisconnectFromGitHub][git-DisconnectFromGitHub]	

Ответив **Да** на сообщение о подтверждении, вы можете вернуться к разделу **Сводка** и щелкнуть **Настроить развертывания в системе управления версиями**, если требуется настроить публикацию из другого источника.

<h2><a id="Step8"></a>Устранение неполадок</h2>

Ниже перечислены ошибки или проблемы, обычно возникающие при использовании Git для публикации на веб-сайте Windows Azure.

****

**Симптом**: не удается разрешить "имя_узла"

**Причина**: эта ошибка может возникнуть, если при создании удаленного репозитория "azure" был введен неправильный адрес.

**Способы устранения**: используйте команду "git remote -v", чтобы вывести список всех удаленных репозиториев с соответствующими URL-адресами. Проверьте правильность URL-адреса удаленного репозитория "azure". При необходимости удалите и повторно создайте этот удаленный репозиторий, используя правильный URL-адрес.

****

**Симптом**: нет ссылок и ничего не указано; ничего не выполняется. Возможно, следует указать ветвь, например "master".

**Причина**: эта ошибка может возникать, если не указана ветвь при выполнении операции git push и не задано значение push.default, используемое Git.

**Способы устранения**: снова выполните операцию принудительной отправки, указав главную ветвь (master). Например:

	git push azure master

****

**Симптом**: src refspec [имя_ветви] не соответствует никакой ветви.

**Причина**: эта ошибка может возникнуть при попытке принудительно отправить данные в ветвь, отличную от главной, в удаленном репозитории "azure".

**Способы устранения**: снова выполните операцию принудительной отправки, указав главную ветвь (master). Например:

	git push azure master

****

**Симптом**: ошибка — изменения применены в удаленном репозитории, но веб-сайт не обновлен.

**Причина**: эта ошибка может возникнуть при развертывании приложения Node.js, содержащего файл package.json, в котором указаны дополнительные необходимые модули.

**Способы устранения**: до этой ошибки должны быть зарегистрированы дополнительные сообщения, содержащие "npm ERR!"; они могут предоставлять дополнительный контекст для данного сбоя. Ниже перечислены известные причины этой ошибки и соответствующие сообщения "npm ERR!".

* **Неправильно сформированный файл Package.json**. npm ERR! Couldn't read dependencies (не удалось прочитать зависимости).

* **Собственный модуль, не имеющий двоичного дистрибутива для Windows**.

	* npm ERR! \`cmd "/c" "node-gyp rebuild"\` failed with 1 (команда \`cmd "/c" "node-gyp rebuild"\` привела к сбою с 1)

		ИЛИ

	* npm ERR! [modulename@version] preinstall: \`make || gmake\` (предустановка имя_модуля@версия: \`make || gmake\`)


## Дополнительные ресурсы

* [Использование PowerShell для Windows Azure]
* [Использование средств командной строки Windows Azure для Mac и Linux]
* [Документация по Git]

[Центр разработчиков Windows Azure]: http://www.windowsazure.com/ru-ru/develop/overview/
[Портал Windows Azure]: http://manage.windowsazure.com
[Веб-сайт Git]: http://git-scm.com
[Установка Git]: http://git-scm.com/book/en/Getting-Started-Installing-Git
[Использование PowerShell для Windows Azure]: http://www.windowsazure.com/ru-ru/develop/nodejs/how-to-guides/powershell-cmdlets/
[Использование средств командной строки Windows Azure для Mac и Linux]: /ru-ru/develop/nodejs/how-to-guides/command-line-tools/
[Документация по Git]: http://git-scm.com/documentation

[portal-select-website]: ./media/publishing-with-git/git-select-website.png
[git-WhereIsYourSourceCode]: ./media/publishing-with-git/git-WhereIsYourSourceCode.png
[git-instructions]: ./media/publishing-with-git/git-instructions.png
[portal-deployment-credentials]: ./media/publishing-with-git/git-deployment-credentials.png

[git-ChooseARepositoryToDeploy]: ./media/publishing-with-git/git-ChooseARepositoryToDeploy.png
[hello-git]: ./media/publishing-with-git/git-hello-git.png
[yay]: ./media/publishing-with-git/git-yay.png
[git-githubdeployed]: ./media/publishing-with-git/git-GitHubDeployed.png
[git-GitHubDeployed-Updated]: ./media/publishing-with-git/git-GitHubDeployed-Updated.png
[git-DisconnectFromGitHub]: ./media/publishing-with-git/git-DisconnectFromGitHub.png
[git-DeploymentTrigger]: ./media/publishing-with-git/git-DeploymentTrigger.png
[Создание репозитория (GitHub)]: https://help.github.com/articles/create-a-repo
[Использование Git с CodePlex]: http://codeplex.codeplex.com/wikipage?title=Using%20Git%20with%20CodePlex&referringTitle=Source%20control%20clients&ProjectName=codeplex
[Создание репозитория (BitBucket)]: https://confluence.atlassian.com/display/BITBUCKET/Create+an+Account+and+a+Git+Repo
[Краткое руководство — Mercurial]: http://mercurial.selenic.com/wiki/QuickStart
[Использование Dropbox для общего доступа к репозиториям Git]: https://gist.github.com/trey/2722927
[Непрерывная доставка в Windows Azure с помощью Team Foundation Service]: http://www.windowsazure.com/ru-ru/develop/net/common-tasks/publishing-with-tfs/

