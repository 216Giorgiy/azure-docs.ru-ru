В разных моделях развертывания (классической и Resource Manager) подход к использованию конечных точек Azure будет немного отличаться. Вы можете создать фильтры сети, которые управляют потоком входящего и исходящего трафика виртуальной машины. Такой подход позволяет создавать очень сложные сетевые среды, а не простую конечную точку, как в классической модели развертывания. Эта статья содержит общие сведения о группах безопасности сети и их отличии от конечных точек в рамках классической модели, а также инструкции по созданию правил фильтрации и примеры сценариев развертывания.


## Обзор развертываний в рамках модели Resource Manager
Конечные точки в классической модели развертывания заменяются группами безопасности сети и правилами списка управления доступом (ACL). Ниже перечислены быстрые действия для реализации правил ACL группы безопасности сети.

- Создание группы безопасности сети
- Определение правил ACL группы безопасности сети для разрешения или запрещения трафика.
- Назначение группы безопасности сети сетевому интерфейсу или подсети виртуальной сети.

Если вы хотите реализовать перенаправление портов, поместите балансировщик нагрузки перед виртуальной машиной и используйте правила преобразования сетевых адресов (NAT). Ниже перечислены быстрые действия для реализации балансировщика нагрузки и правил NAT.

- Создание балансировщика нагрузки
- Создание серверного пула и добавление в него виртуальных машин.
- Определение правил NAT для требуемого перенаправления порта.
- Назначение правил NAT виртуальным машинам.


## Обзор группы безопасности сети
Группы безопасности сети — это новая функция. Она обеспечивает слой безопасности, благодаря которому вы можете разрешить доступ к своей виртуальной машине с определенных портов и подсетей. Обычно группа безопасности сети используется для обеспечения этого слоя безопасности между виртуальными машинами и внешним миром. Группы безопасности сети можно применять к подсети виртуальной сети или определенному сетевому интерфейсу виртуальной машины. Вместо правил ACL для конечной точки вы создаете правила ACL для группы безопасности сети. Эти правила ACL обеспечивают больше возможностей контроля, чем просто создание конечной точки для перенаправления на данный порт. Дополнительную информацию см. в статье [Группа безопасности сети](../articles/virtual-network/virtual-networks-nsg.md).

> [AZURE.TIP] Вы можете назначить группы безопасности сети нескольким подсетям или сетевым интерфейсам. Здесь не действует сопоставление 1:1. Это означает, что вы можете создать группу безопасности сети с общим набором правил ACL и применить ее к нескольким подсетям и сетевым интерфейсам. Кроме того, вы можете применить группу безопасности сети к различным ресурсам в своей подписке (с помощью [управления доступом на основе ролей](../articles/active-directory/role-based-access-control-what-is.md)).


## Общие сведения о балансировщиках нагрузки
В классической модели развертывания платформа Azure выполнила бы все преобразования сетевых адресов и перенаправления портов в облачной службе. При создании конечной точки вы можете указать внешний порт, который будет открыт для доступа вместе с внутренним портом, в который направляется трафик. Группы безопасности сети не выполняют это преобразование сетевых адресов и перенаправление портов самостоятельно.

В группе ресурсов необходимо создать балансировщик нагрузки Azure Load Balancer, который позволит создавать правила преобразования сетевых адресов для перенаправления портов. Напоминаем, эта схема достаточно детализирована, чтобы при необходимости применять ее только к конкретной виртуальной машине. Правила преобразования сетевых адресов балансировщика нагрузки Azure работают вместе с правилами ACL группы безопасности сети, обеспечивая более гибкие возможности управления, чем при использовании конечных точек облачной службы. Дополнительные сведения см. в статье [Обзор балансировщика нагрузки Azure](../articles/load-balancer/load-balancer-overview.md).


## Правила ACL сетевой группы безопасности
Правила ACL позволяют определить с помощью конкретных портов, диапазонов портов или протоколов входящий и исходящий трафик для виртуальных машин. Вы можете назначать эти правила отдельным виртуальным машинам или подсети. На снимке экрана ниже показан пример правил ACL для общего веб-сервера.

![Список правил ACL группы безопасности сети](./media/virtual-machines-common-endpoints-in-resource-manager/example-acl-rules.png)

Правила ACL применяются в зависимости от указанного значения приоритета: чем выше значение, тем ниже приоритет. Каждая группа безопасности сети имеет три стандартных правила, которые предназначены для обработки потока сетевого трафика Azure, и явное правило `DenyAllInbound` в качестве окончательного правила. Стандартные правила ACL имеют очень низкий приоритет, чтобы они не вступали в конфликт с правилами, которые создаете вы.


## Назначение групп безопасности сети
Группа безопасности сети назначается подсети или сетевому интерфейсу. Такой подход позволяет детализировать назначение при необходимости. Например, если вы хотите применить правила ACL к определенной виртуальной машине или использовать общий набор правил ACL ко всем виртуальным машинам в подсети.

![Применение групп безопасности сети к сетевым интерфейсам или подсетям](./media/virtual-machines-common-endpoints-in-resource-manager/apply-nsg-to-resources.png)

Поведение группы безопасности сети не меняется в зависимости от ее назначения подсети или сетевому интерфейсу. В стандартном сценарии развертывания группа безопасности сети назначается подсети, чтобы обеспечить соответствие всех виртуальных машин, подключенных к подсети. Дополнительную информацию см. в разделе [Связывание групп NSG](../virtual-nework/virtual-networks-nsg.md#associating-nsgs).


## Стандартное поведение групп безопасности сети
В зависимости от способа и времени создания группы безопасности сети вы можете создать стандартные правила, которые разрешают доступ с помощью протокола удаленного рабочего стола (RDP) через TCP-порт 3389 (виртуальные машины Linux разрешают доступ через TCP-порт 22). Эти автоматические правила ACL будут созданы при следующих условиях.

- Если вы создаете виртуальную машину Windows на портале и принимаете действие по умолчанию, чтобы создать новую группу безопасности сети, будет создано правило ACL, разрешающее доступ через TCP-порт 3389 (RDP).
- Если вы создаете виртуальную машину Linux на портале и принимаете действие по умолчанию, чтобы создать новую группу безопасности сети, будет создано правило ACL, разрешающее доступ через TCP-порт 22 (SSH).

При других условиях эти стандартные правила ACL не создаются. Поэтому вы не сможете подключиться к виртуальной машине, создав соответствующие правила ACL. Чтобы подключиться к виртуальной машине, выполните следующие действия.

- Создайте группу безопасности сети на портале. Это действие должно быть отделено от создания виртуальной машины.
- Создайте группу безопасности сети программным способом с помощью PowerShell, интерфейса командной строки Azure, интерфейсов REST API и т. д.
- Создайте виртуальную машину и назначьте ей существующую группу безопасности сети, для которой уже определены соответствующие правила ACL.

Во всех указанных случаях необходимо создать правила ACL для виртуальной машины, чтобы разрешить соответствующие подключения удаленного управления.


## Стандартное поведение виртуальной машины без группы безопасности сети
Вы можете создать виртуальную машину, не создавая группу безопасности сети. В этом случае вы можете подключиться к виртуальной машине с помощью RDP или SSH, не создавая правила ACL. Точно так же, если вы установили веб-службу на порт 80, эта служба автоматически станет доступна удаленно. На виртуальной машине открыты все порты.

> [AZURE.NOTE] Тем не менее для любых удаленных соединений необходимо назначить виртуальной машине общедоступный IP-адрес. Если вы не создали группу безопасности сети для подсети или сетевого интерфейса, виртуальная машина не сможет принимать внешний трафик. Новый общедоступный IP-адрес по умолчанию создается при создании виртуальной машины на портале. Если вы создаете виртуальную машину любым другим способом (например, с помощью PowerShell, интерфейса командной строки Azure или шаблона Resource Manager), общедоступный IP-адрес не будет создан автоматически, пока вы не отправите явный запрос. Обратите внимание, что по умолчанию на портале также создается группа безопасности сети, чтобы виртуальная машина не оставалась общедоступной для сети без фильтрации.


## Общее представление о балансировщиках нагрузки и правилах преобразования сетевых адресов
В классической модели развертывания вы можете создавать конечные точки, которые также выполняют перенаправление портов. При создании виртуальной машины в классической модели развертывания правила ACL для RDP или SSH будут созданы автоматически, но они не откроют TCP-порты 3389 или 22 для внешнего мира. Вместо этого важный TCP-порт будет сопоставлен с соответствующим внутренним портом. Вы можете таким же образом создать собственные правила ACL, которые откроют для внешнего мира веб-сервер на TCP-порте 4280. Ниже вы можете увидеть эти правила ACL и сопоставления портов на снимке экрана классического портала.

![Перенаправление портов с использованием конечных точек в рамках классической модели](./media/virtual-machines-common-endpoints-in-resource-manager/classic-endpoints-port-forwarding.png)

Если вы создали группы безопасности сети, эту функцию перенаправления портов выполняет балансировщик нагрузки. Дополнительные сведения см. в статье [Обзор балансировщика нагрузки Azure](../articles/load-balancer/load-balancer-overview.md). На следующем снимке экрана портала показан пример балансировщика нагрузки с правилом преобразования сетевых адресов, согласно которому TCP-порт 4222 перенаправляется на внутренний TCP-порт 22 виртуальной машины.

![Правила NAT балансировщика нагрузки для перенаправления портов](./media/virtual-machines-common-endpoints-in-resource-manager/load-balancer-nat-rules.png)

> [AZURE.NOTE] Если вы используете балансировщик нагрузки, обычно не нужно назначать общедоступный IP-адрес виртуальной машине. Вместо этого общедоступный IP-адрес будет назначен балансировщику нагрузки. Но все равно необходимо создать правила ACL и группу безопасности сети, чтобы определить поток входящего и исходящего трафика для виртуальной машины. Правила преобразования сетевых адресов балансировщика нагрузки просто определяют, какие порты разрешает балансировщик нагрузки и как они распределяются между серверными виртуальными машинами. Поэтому необходимо создать правило преобразования сетевых адресов, чтобы трафик проходил через балансировщик нагрузки, а затем создать правило ACL группы безопасности сети, разрешающее трафик на виртуальную машину.

<!---HONumber=AcomDC_0608_2016-->