В разных моделях развертывания (классической и Resource Manager) подход к использованию конечных точек Azure будет немного отличаться. В модели развертывания Resource Manager вы можете гибко создавать сетевые фильтры, которые управляют потоками входящего и исходящего трафика виртуальных машин. Эти фильтры позволяют создавать сложные сетевые среды, а не только простые конечные точки, как в классической модели развертывания. Эта статья содержит общие сведения о группах безопасности сети, об их отличии от конечных точек в классической модели и о создании правил фильтрации, а также примеры сценариев развертывания.

## <a name="overview-of-resource-manager-deployments"></a>Обзор развертываний в рамках модели Resource Manager
Конечные точки в классической модели развертывания заменяются группами безопасности сети и правилами списка управления доступом (ACL). Ниже перечислены быстрые действия для реализации правил ACL группы безопасности сети.

* Создайте группу безопасности сети.
* Определение правил списка управления доступом группы безопасности сети для разрешения или запрещения трафика.
* Назначение группы безопасности сети сетевому интерфейсу или подсети виртуальной сети.

Если вы хотите реализовать перенаправление портов, поместите балансировщик нагрузки перед виртуальной машиной и используйте правила преобразования сетевых адресов (NAT). Ниже перечислены быстрые действия для реализации балансировщика нагрузки и правил NAT.

* Создание балансировщика нагрузки.
* Создание серверного пула и добавление в него виртуальных машин.
* Определение правил преобразования сетевых адресов (NAT) для требуемого перенаправления портов.
* Назначение правил преобразования сетевых адресов (NAT) виртуальным машинам.

## <a name="network-security-group-overview"></a>Обзор группы безопасности сети
Группы безопасности сети — это новая функция, которая создает дополнительный уровень безопасности и позволяет предоставлять доступ к виртуальной машине только с определенных портов и подсетей. Обычно группа безопасности сети используется для обеспечения этого слоя безопасности между виртуальными машинами и внешним миром. Группы безопасности сети можно применять к подсети виртуальной сети или определенному сетевому интерфейсу виртуальной машины. Вместо правил ACL для конечной точки вы создаете правила ACL для группы безопасности сети. Эти правила ACL обеспечивают больше возможностей контроля, чем просто создание конечной точки для перенаправления на данный порт. Дополнительные сведения см. в статье [Группа безопасности сети](../articles/virtual-network/virtual-networks-nsg.md).

> [!TIP]
> Вы можете назначить группы безопасности сети нескольким подсетям или сетевым интерфейсам. Здесь не действует сопоставление 1:1. Это означает, что вы можете создать группу безопасности сети с общим набором правил ACL и применить ее к нескольким подсетям и сетевым интерфейсам. Кроме того, группу безопасности сети можно применить к различным ресурсам в подписке (с помощью [управления доступом на основе ролей](../articles/active-directory/role-based-access-control-what-is.md)).

## <a name="load-balancers-overview"></a>Общие сведения о балансировщиках нагрузки
В классической модели развертывания платформа Azure выполнила бы все преобразования сетевых адресов и перенаправления портов в облачной службе. При создании конечной точки вы можете указать внешний порт, который будет открыт для доступа вместе с внутренним портом, в который направляется трафик. Группы безопасности сети не выполняют это преобразование сетевых адресов и перенаправление портов самостоятельно. 

Чтобы создавать правила преобразования сетевых адресов (NAT) для перенаправления портов, создайте в группе ресурсов балансировщик нагрузки Azure Load Balancer. Балансировщик нагрузки также достаточно детализирован и может применяться только к конкретной виртуальной машине. Правила преобразования сетевых адресов Azure Load Balancer работают совместно с правилами ACL группы безопасности сети, что дает более гибкие возможности управления, чем при использовании конечных точек облачной службы. Дополнительные сведения см. в статье [Обзор балансировщика нагрузки Azure](../articles/load-balancer/load-balancer-overview.md).

## <a name="network-security-group-acl-rules"></a>Правила ACL сетевой группы безопасности
Правила ACL позволяют пропускать входящий и исходящий трафик виртуальных машин для конкретных портов, диапазонов портов или протоколов. Вы можете назначать эти правила отдельным виртуальным машинам или конкретной подсети. На снимке экрана ниже показан пример правил ACL для общего веб-сервера.

![Список правил ACL группы безопасности сети](./media/virtual-machines-common-endpoints-in-resource-manager/example-acl-rules.png)

Правила ACL применяются в зависимости от указанного значения приоритета: чем выше значение, тем ниже приоритет. Каждая группа безопасности сети имеет три стандартных правила, которые предназначены для обработки потока сетевого трафика Azure, и явное правило `DenyAllInbound` в качестве окончательного правила. Стандартные правила ACL имеют низкий приоритет, чтобы они не вступали в конфликт с правилами, которые создаете вы.

## <a name="assigning-network-security-groups"></a>Назначение групп безопасности сети
Группа безопасности сети назначается подсети или сетевому интерфейсу. Такой подход позволяет детализировать назначение при необходимости. Например, если вы хотите применить правила ACL к определенной виртуальной машине или использовать общий набор правил ACL ко всем виртуальным машинам в подсети.

![Применение групп безопасности сети к сетевым интерфейсам или подсетям](./media/virtual-machines-common-endpoints-in-resource-manager/apply-nsg-to-resources.png)

Поведение группы безопасности сети не меняется в зависимости от ее назначения подсети или сетевому интерфейсу. В стандартном сценарии развертывания группа безопасности сети назначается подсети, чтобы обеспечить соответствие всех виртуальных машин, подключенных к подсети. Дополнительные сведения см. в разделе [о применении групп безопасности сети к ресурсам](../articles/virtual-network/virtual-networks-nsg.md#associating-nsgs).

## <a name="default-behavior-of-network-security-groups"></a>Стандартное поведение групп безопасности сети
В зависимости от способа и времени создания группы безопасности сети вы можете создать правила по умолчанию для виртуальных машин Windows, которые разрешают доступ по протоколу RDP через TCP-порт 3389. Правила по умолчанию для виртуальных машин Linux разрешают доступ по протоколу SSH через TCP-порт 22. Эти автоматические правила ACL будут созданы при следующих условиях.

* Если вы создаете виртуальную машину Windows на портале и принимаете действие по умолчанию, чтобы создать группу безопасности сети, будет создано правило ACL, разрешающее доступ через TCP-порт 3389 (RDP).
* Если вы создаете виртуальную машину Linux на портале и принимаете действие по умолчанию, чтобы создать группу безопасности сети, будет создано правило ACL, разрешающее доступ через TCP-порт 22 (SSH).

При других условиях эти стандартные правила ACL не создаются. Вы не сможете подключиться к виртуальной машине, если не создадите соответствующие правила списка управления доступом. Эти условия включают в себя следующие стандартные действия:

* Создайте группу безопасности сети на портале. Это действие должно быть отделено от создания виртуальной машины.
* Создайте группу безопасности сети программным способом с помощью PowerShell, интерфейса командной строки Azure, интерфейсов REST API и т. д.
* Создайте виртуальную машину и назначьте ей существующую группу безопасности сети, для которой уже определены соответствующие правила ACL.

Во всех указанных выше случаях необходимо создать правила ACL для виртуальной машины, чтобы разрешить соответствующие подключения для удаленного управления.

## <a name="default-behavior-of-a-vm-without-a-network-security-group"></a>Стандартное поведение виртуальной машины без группы безопасности сети
Вы можете создать виртуальную машину, не создавая группу безопасности сети. В этом случае вы можете подключиться к виртуальной машине с помощью RDP или SSH, не создавая правила ACL. Точно так же, когда вы устанавливаете веб-службу на порт 80, эта служба автоматически становится доступна удаленно. На виртуальной машине открыты все порты.

> [!NOTE]
> Тем не менее для любых удаленных соединений необходимо назначить виртуальной машине общедоступный IP-адрес. Если вы не создали группу безопасности сети для подсети или сетевого интерфейса, виртуальная машина не сможет принимать внешний трафик. Новый общедоступный IP-адрес по умолчанию создается при создании виртуальной машины на портале. Если вы создаете виртуальную машину любым другим способом (например, с помощью PowerShell, интерфейса командной строки Azure или шаблона Resource Manager), общедоступный IP-адрес не будет создан автоматически, если вы не отправите явный запрос. Обратите внимание, что в ходе выполнения действия по умолчанию на портале также создается группа безопасности сети. Это действие выполняется, чтобы виртуальная машина не оставалась общедоступной без сетевой фильтрации.

## <a name="understanding-load-balancers-and-nat-rules"></a>Общее представление о балансировщиках нагрузки и правилах преобразования сетевых адресов
В классической модели развертывания вы можете создавать конечные точки, которые также выполняют перенаправление портов. При создании виртуальной машины в классической модели развертывания будут автоматически созданы правила ACL для протокола RDP или SSH. Благодаря им TCP-порты (3389 или 22 соответственно) не будут открыты для внешнего доступа. Вместо этого важный TCP-порт будет сопоставлен с соответствующим внутренним портом. Вы можете таким же образом создать собственные правила ACL, которые откроют для внешнего мира веб-сервер на TCP-порте 4280. Ниже вы можете увидеть эти правила ACL и сопоставления портов на снимке экрана классического портала.

![Перенаправление портов с использованием конечных точек в рамках классической модели](./media/virtual-machines-common-endpoints-in-resource-manager/classic-endpoints-port-forwarding.png)

Если вы создали группы безопасности сети, эту функцию перенаправления портов выполняет балансировщик нагрузки. Дополнительные сведения см. в статье о [балансировщиках нагрузки в Azure](../articles/load-balancer/load-balancer-overview.md). В следующем примере показан балансировщик нагрузки с правилом преобразования сетевых адресов (NAT), согласно которому TCP-порт 4222 перенаправляется на внутренний TCP-порт 22 виртуальной машины.

![Правила NAT балансировщика нагрузки для перенаправления портов](./media/virtual-machines-common-endpoints-in-resource-manager/load-balancer-nat-rules.png)

> [!NOTE]
> При использовании балансировщика нагрузки самой виртуальной машине обычно не назначается общедоступный IP-адрес. Вместо этого общедоступный IP-адрес будет назначен балансировщику нагрузки. Но все равно необходимо создать правила ACL и группу безопасности сети, чтобы определить поток входящего и исходящего трафика для виртуальной машины. Правила преобразования сетевых адресов балансировщика нагрузки просто определяют, какие порты разрешает балансировщик нагрузки и как они распределяются между серверными виртуальными машинами. Поэтому необходимо создать правило преобразования сетевых адресов, чтобы трафик проходил через балансировщик нагрузки. Чтобы разрешить передачу трафика на виртуальную машину, создайте правило списка управления доступом группы безопасности сети.


<!--HONumber=Nov16_HO3-->


