##Параметры TCP для виртуальных машин Azure

В виртуальных машинах Azure для передачи данных через Интернет используется функция [преобразования сетевых адресов (NAT)][nat]. NAT-устройства назначают виртуальной машине Azure общедоступный IP-адрес и порт, позволяя тем самым устанавливать подключение к другим устройствам через сокет. Если через некоторое время передача пакетов через сокет останавливается, NAT-устройство прерывает сопоставление, и этот сокет может использоваться другими виртуальными машинами.

Это обычное поведение NAT-устройства, из-за которого возникают проблемы со связью в приложениях на основе протокола TCP, ожидающих, что проблема с сокетом будет решена в течение времени ожидания. Существует два параметра времени ожидания в режиме простоя для сеансов с *установленным подключением*.

- **Входящее** через [Azure Load Balancer][azure-lb-timeout]. Время ожидания по умолчанию составляет 4 минуты. Максимально возможное значение, которое можно задать, — 30 минут.
- **Исходящее** с помощью [исходящего преобразования сетевых адресов (SNAT)][snat]. Время ожидания составляет 4 минуты, и его не возможно изменить.

Чтобы в течение времени ожидания подключения не были потеряны, необходимо настроить приложение так, чтобы оно поддерживало активность сеанса, или настроить для этого основную операционную систему. Параметры, используемые для настройки операционных систем Linux и Windows, отличаются.

Для [Linux][linux] следует изменить переменные ядра: net.ipv4.tcp\_keepalive\_time = 120; net.ipv4.tcp\_keepalive\_intvl = 30; net.ipv4.tcp\_keepalive\_probes = 8.
 
А для [Windows][windows] следует изменить значения реестра: KeepAliveInterval = 30; KeepAliveTime = 120; TcpMaxDataRetransmissions = 8.


Указанные выше параметры поддерживают активность сеанса, отправляя первый пакет через 2 минуты (120 секунд) времени простоя, а дальше пакеты отправляются каждые 30 секунд. Если не удалось выполнить передачу 8 пакетов, сеанс прерывается.

<!-- links -->
[nat]: http://computer.howstuffworks.com/nat.htm
[snat]: ../load-balancer/load-balancer-overview.md/#source-nat
[linux]: http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/usingkeepalive.html
[windows]: http://blogs.technet.com/b/nettracer/archive/2010/06/03/things-that-you-may-want-to-know-about-tcp-keepalives.aspx
[azure-lb-timeout]: ../load-balancer/load-balancer-tcp-idle-timeout.md