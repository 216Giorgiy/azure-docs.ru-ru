
# Управление базой данных SQL Azure с помощью SQL Server Management Studio 

Вы можете использовать портал управления базой данных SQL Azure или клиентское приложение SQL Server Management Studio (SSMS) для управления вашими подписками базы данных SQL, создавать связанные логические серверы и базы данных и управлять ими. В приведенном ниже руководстве описывается, как использовать среду Management Studio для управления логическими серверами баз данных SQL и базами данных.

<div class="dev-callout-new-collapsed">
<strong>Примечание. <span>Click to collapse</span></strong>
<div class="dev-callout-content">
<p>Вы можете использовать версию SQL Server 2014, SQL Server 2012 или SQL Server 2008, выпуск 2 среды SSMS. Более ранние версии не поддерживаются.</p>
</div>
</div>

Этот раздел включает следующие шаги:

-   [Шаг 1: Получение среды SQL Server Management Studio][]
-   [Шаг 2: Подключение к базе данных SQL][]
-   [Шаг 3: Создание баз данных и управление ими][]
-   [Шаг 4: Создание имен входа и управление ими][]
-   [Шаг 5: Мониторинг базы данных SQL с помощью динамических представлений управления][]

<h2><a id="Step1" name="Step1"> </a>Шаг 1. Получить среду Management Studio</h2>

Среда Management Studio - это интегрированная среда для
управления базами данных SQL. При управлении
базами данных на платформе Azure вы можете использовать приложение Management Studio, установленное с
SQL Server, или загрузить бесплатную версию SQL Server 2012 Management Studio Express (SSMSE). В следующих шагах описывается,
как установить среду SSMSE.

1.  На странице [Microsoft SQL Server 2012 Express][] выберите версию x86 среды Management Studio, если вы работаете в 32-разрядной операционной системе, или версию x64 при использовании 64-разрядной операционной системы. Нажмите **Загрузить** и при появлении запроса запустите программу установки Setup.

2.  Нажмите **Новая автономная установка SQL Server или добавление функций в
    уже имеющуюся установку**, после чего нажмите кнопку **OK**.

3.  Примите условия лицензионного соглашения и нажмите кнопку **Далее**.

4. Нажмите **Установить**, чтобы установить файлы, необходимые программе установки SQL Server Setup.

5.  На экране **Выбор функций** **Инструменты управления 
изначально выбран     Базовый** набор. Это вызвано использованием программы установки для среды Management Studio. Если вы запускаете программу установки Setup для всех SQL Server Express, выберите **Средства управления - базовый** вариант и нажмите **Далее**.

6.   На экране **Сообщения об ошибках** вы можете дополнительно выбрать, отправлять ли
отчеты об ошибках в Microsoft. Это не требуется для использования среды SSMSE. Нажмите
    **Далее**, чтобы начать установку.

7.  Когда установка будет завершена, вы увидите страницу **Завершено**
. Нажмите кнопку **Закрыть** 


<h2><a id="Step2" name="Step2"> </a>Шаг 2: Подключение к базе данных SQL</h2>

Для подключения к базе данных SQL необходимо знать имя сервера в Azure. Вам может потребоваться зайти на портал, чтобы получить эту информацию.

1.  Выполните вход на [портал управления Azure][].

2.  На левой панели нажмите **Базы данных SQL**.

3.  На домашней странице "Базы данных SQL" откройте раздел **СЕРВЕРЫ** в верхней части страницы, чтобы вывести список всех серверов, связанных с вашей подпиской. Найдите имя сервера, к которому вы хотите подключиться и скопируйте его в буфер обмена.

	Затем настройте брандмауэр своей базы данных SQL так, чтобы
разрешить соединения с вашего локального компьютера. Вы можете сделать это, добавив IP-адрес своего локального компьютера в список исключений брандмауэра.

1.  На домашней странице "Базы данных SQL" откройте раздел **СЕРВЕРЫ** и затем выберите тот сервер, к которому нужно подключиться.

2.  Нажмите **Настроить** в верхней части страницы.

3.  Скопируйте в IP-адрес в ТЕКУЩИЙ IP-АДРЕС КЛИЕНТА.

4.  На странице "Настройка" раздел **Разрешенные IP-адреса** содержит три поля, в которых можно задать имя правила и диапазон IP-адресов в качестве начального и конечного значения. В качестве имени правила можно ввести имя компьютера. В качестве начала и окончания диапазона вставьте IP-адрес вашего компьютера в оба поля, а затем установите появившийся флажок.

Это имя должно быть уникальным. Если используется компьютер разработчика, можно ввести IP-адрес и в поле начало диапазона IP-адресов, и в поле конца этого диапазона. В противном случае может потребоваться ввести более широкий диапазон IP-адресов для разрешения подключений и с других компьютеров в вашей организации.
 
5. В нижней части страницы нажмите **SAVE (Сохранить)**.

    **Примечание.** Может быть задержка как минимум в пять минут, прежде чем изменения
    настроек брандмауэра вступят в силу.

	Теперь все готово для подключения к базе данных SQL с помощью среды Management Studio.

1.  На панели задач нажмите **Start (Пуск)**, укажите **All Programs (Все программы)**, укажите
    **Microsoft SQL Server 2012 **, после чего нажмите **SQL Server
    Management Studio**.

2.  В поле **Подключение к серверу** укажите полное
    имя сервера, например "имя_сервера.database.windows.net". В Azure имя сервера представляет собой автоматически сгенерированную строку, состоящую из буквенно-цифровых символов.

3.  Выберите **Проверка подлинности SQL Server**.

4.  В поле **Имя входа** введите логин администратора SQL-сервера, который вы
    задали на портале при создании сервера в формате
    *имя_входа*@*имяВашегоСервера*.

5.  В поле **Пароль** введите тот пароль, который вы указали на
    портале при создании сервера.

8.  Нажмите **Подключиться**, чтобы установить соединение.

На платформе Azure каждый логический сервер базы данных SQL - это абстракция, которая определяет группу баз данных. Физически любая база данных может находиться на любом компьютере в центре обработки данных. 

В предыдущих версиях при настройке подключения в среде Management Studio приходилось подключиться непосредственно к **master**. Этот шаг больше не требуется. Соединения теперь устанавливаются исходя из имени сервера, типа проверки подлинности и учетных данных администратора.

Многие из мастеров SSMS могут использоваться для таких задач, как
создание и изменение имен входа и баз данных в базе данных SQL Server, которые
недоступны для баз данных SQL в Azure, поэтому вам придется использовать
инструкции Transact-SQL для выполнения этих задач. В следующих шагах
приводятся примеры этих команд. Для получения дополнительной информации об использовании
Transact-SQL с базой данных SQL, в том числе и подробных сведений о том, какие команды
поддерживаются, см. [Справочник по Transact-SQL (база данных SQL)][].

<h2><a id="Step3" name="Step3"> </a>Шаг 3. Создание баз данных и управление ими</h2>

После подключения к базе данных **master** можно создать новые
базы данных на сервере и изменить или удалить существующие базы данных. Шаги, приведенные
ниже, описывают, как выполняются несколько общих задач управления базами данных
в среде Management Studio. Для выполнения этих задач убедитесь, что вы подключены к
базе данных **master** под основным именем входа на уровне сервера, который вы
создали при настройке сервера.

Чтобы открыть окно запроса в среде Management Studio, откройте папку Databases, разверните папку **System Databases**, щелкните правой кнопкой мыши **master**, а затем выберите команду **Новый запрос**.

-   Используйте команду **CREATE DATABASE**, чтобы создать новую базу данных. Для
    получения дополнительных сведений см. статью [CREATE DATABASE (команда SQL)][]. Команда, приведенная ниже, создает новую базу данных с именем
    **myTestDB** и указывает, что это БД выпуска Web Edition
    с максимальным размером 1 ГБ.

        CREATE DATABASE myTestDB
        (MAXSIZE=1GB,
         EDITION='web');

Нажмите **Выполнить**, чтобы запустить запрос.

-   Используйте команду **ALTER DATABASE**, чтобы изменить существующую базу данных,
    если, например, вы хотите изменить имя, максимальный размер, или версию
(бизнес или веб) этой базы данных. Дополнительные сведения см. в разделе [ALTER DATABASE (база данных SQL)][]. Пример:
    Команда, приведенная ниже, изменяет базу данных, которую вы создали на предыдущем
    шаге, изменяя максимальный размер до 5 ГБ.

        ALTER DATABASE myTestDB
        MODIFY
        (MAXSIZE=5GB,
         EDITION='web');

-   Используйте команду **DROP DATABASE**, чтобы удалить существующую базу данных.
    Для получения более подробных сведений см. статью [DROP DATABASE (команда SQL Database)][]. Команда, приведенная ниже, удаляет базу данных **myTestDB**,
    но не удаляйте ее сейчас, потому что эта база будет использоваться для создания учетных записей на следующем шаге.

        DROP DATABASE myTestBase;

-   В базе данных master есть представление **sys.databases**, которое вы можете использовать
для просмотра информации обо всех базах данных. Для просмотра всех существующих баз данных
    выполните следующую команду:

        SELECT * FROM sys.databases;

-   В SQL Database команда **USE** не применяется для переключения
между базами данных. Вместо этого нужно установить соединение
    непосредственно с целевой базой данных.

<div class="dev-callout-new">
 <strong>Примечание. <span>Click to collapse</span></strong>
 <div class="dev-callout-content">
   <p>Часть инструкций Transact-SQL для создания и изменения
базы данных должны выполняться в своем собственном пакете и не могут группироваться с
другими инструкциями Transact-SQL. Для получения дополнительной информации см. описание команд, доступные по вышеприведенным ссылкам.</p>
</div>
</div>

<h2><a id="Step4" name="Step4"> </a>Шаг 4. Создание имен входа и управление ими</h2>

База данных **master** отслеживает имена входа и то, какие из них имеют
разрешение на создание баз данных или других имен входа. Управление именами входа выполняется
посредством подключения к базе данных **master** с именем входа уровня сервера,
которое вы создали, когда настроили свой сервер. Вы можете использовать инструкции
**CREATE LOGIN**, **ALTER LOGIN** или **DROP LOGIN**, чтобы
выполнять запросы к базе данных master, которая будет управлять именами входа
по всему серверу. Дополнительные сведения см. в разделе [Управление базами данных и учетными записями в базе данных SQL][] 


-   Используйте инструкцию **CREATE LOGIN** для создания имени входа 
на уровне сервера. Дополнительные сведения см. в разделе [CREATE LOGIN (база данных SQL)][]. Инструкция, приведенная ниже, создает новое имя входа
 под названием **login1**. Замените **password1** на пароль, который вы
    выберете сами.

        CREATE LOGIN login1 WITH password='password1';

-   Используйте инструкцию **CREATE USER** для предоставления БД-уровня
    разрешения. Все имена входа должны быть созданы в базе данных **master**,
    но, чтобы с помощью имени входа можно было подключиться к другой базе данных, вам
    потребуется предоставить ему разрешения на уровне базы данных с помощью инструкции **CREATE USER**
для этой базы данных. Дополнительные сведения см. в разделе [CREATE USER (база данных SQL)][]. 

-   Чтобы предоставить login1
    разрешения доступа к базе данных под названием **myTestDB**, выполните следующие
    шаги.

 1.  Обновите обозреватель объектов, чтобы увидеть базу данных **myTestDB**, которую вы только что создали, щелкните правой кнопкой мыши имя сервера в обозревателе объектов, затем выберите команду **Обновить**.  

     Если вы закрыли соединение, можете повторно подключиться, выбрав команду **Подключить обозреватель объектов** из меню "Файл". Повторите инструкции, приведенные в разделе [Шаг 2. Подключитесь к SQL Database][], чтобы соединиться с базой данных.

 2. Щелкните правой кнопкой мыши базу данных **myTestDB** и выберите пункт **Новый запрос**.

    3.  Выполните следующую инструкцию в базе данных myTestDB, чтобы создать
        пользователя базы данных с именем **login1User**, которое соответствует
        имени входа уровня сервера **login1**.

            CREATE USER login1User FROM LOGIN login1;

-   Воспользуйтесь сохраненной процедурой **sp\_addrolemember**, чтобы предоставить учетной записи
пользователя соответствующий уровень полномочий в базе данных. Для
    получения более подробной информации см. статью [sp_addrolemember (Transact-SQL)][]. Приведенная ниже инструкция дает **login1User**
    полномочия только на чтение из базы данных, добавляя **login1User** к
    роли **db\_datareader**.

        exec sp_addrolemember 'db_datareader', 'login1User';    

-   Используйте команду **ALTER LOGIN**, чтобы изменить существующее имя входа,
если, например, вы хотите изменить пароль для него. Для
    получения дополнительных сведений см. статью [ALTER LOGIN (SQL Database)][]. Инструкция **ALTER LOGIN** должна выполняться в
   базе данных **master**. Переключитесь в окно запроса, подключенного к этой базе данных. 

    Приведенная ниже инструкция изменяет имя входа **login1**, сбрасывая пароль.
    Замените **newPassword** на свой собственный пароль, а старый пароль
    **oldPassword** замените на текущий пароль для данного имени входа.

        ALTER LOGIN login1
        WITH PASSWORD = 'newPassword'
        OLD_PASSWORD = 'oldPassword';

-   Воспользуйтесь инструкцией **DROP LOGIN**, чтобы удалить существующее имя входа.
    Удаление имени входа на уровне сервера также удаляет и связанные с ним
учетные записи пользователей базы данных. Для получения дополнительной информации
    см. статью [DROP DATABASE (SQL Database)][]. Инструкция **DROP LOGIN**
    должна выполняться для базы данных **master**. Пример:
    следующая инструкция удаляет имя входа **login1**.

        DROP LOGIN login1;

-   В базе данных master предусмотрено представление **sys.sql\_logins**, которое вы можете
использовать для просмотра имен входа. Для просмотра всех существующих имен выполните
    следующую инструкцию:

        SELECT * FROM sys.sql_logins;

<h2><a id="Step5" name="Step5"> </a>Шаг 5: Мониторинг базы данных SQL с помощью динамических представлений управления</h2>

База данных SQL поддерживает несколько динамических административных представлений, которые вы
можете использовать для мониторинга отдельной базы данных. Ниже приведено несколько примеров
типов данных мониторинга, которые можно получить с помощью этих представлений. Для
получения более подробных сведений и дополнительных примеров использования см. статью [Мониторинг базы данных SQL с использованием динамических представлений управления][].

-   Запрос динамических административных представлений требует наличия разрешений **VIEW DATABASE STATE**
. Чтобы предоставить разрешение **VIEW DATABASE STATE** для
    определенного пользователя базы данных, подключитесь к базе данных, которой вы хотите управлять,
    введя основное имя входа уровня сервера, и выполните следующую
    инструкцию в базе данных:

        GRANT VIEW DATABASE STATE TO login1User;

-   Рассчитайте размер базы данных с помощью представления **sys.dm\_db\_partition\_stats**
. Представление **sys.dm\_db\_partition\_stats** возвращает информацию о странице и
    количестве строк для каждого раздела в базе данных, которые вы
можете использовать для расчета размера базы данных. Следующий запрос возвращает
    размер вашей базы данных в мегабайтах:

        SELECT SUM(reserved_page_count)*8.0/1024
        FROM sys.dm_db_partition_stats;   

-   Используйте представления **sys.dm\_exec\_connections** и **sys.dm\_exec\_sessions**
    для получения информации о текущих подключениях пользователей и
внутренних задачах, связанных с базой данных. Следующий запрос
    возвращает сведения о текущем соединении:

        SELECT
            e.connection_id,
            s.session_id,
            s.login_name,
            s.last_request_end_time,
            s.cpu_time
        FROM
            sys.dm_exec_sessions s
            INNER JOIN sys.dm_exec_connections e
              ON s.session_id = e.session_id;

-   Используйте представление **sys.dm\_exec\_query\_stats** для получения общей
статистики производительности для кэшированных планов запросов. Следующий запрос
    возвращает сведения о пяти первых запросах в списке, упорядоченном по среднему затраченному ЦП
    времени.

        SELECT TOP 5 query_stats.query_hash AS "Query Hash",
            SUM(query_stats.total_worker_time), SUM(query_stats.execution_count) AS "Avg CPU Time",
            MIN(query_stats.statement_text) AS "Statement Text"
        FROM
            (SELECT QS.*,
            SUBSTRING(ST.text, (QS.statement_start_offset/2) + 1,
            ((CASE statement_end_offset
                WHEN -1 THEN DATALENGTH(ST.text)
                ELSE QS.statement_end_offset END
                    - QS.statement_start_offset)/2) + 1) AS statement_text
             FROM sys.dm_exec_query_stats AS QS
             CROSS APPLY sys.dm_exec_sql_text(QS.sql_handle) as ST) as query_stats
        GROUP BY query_stats.query_hash
        ORDER BY 2 DESC;

<h2>Дополнительные ресурсы</h2>

* [Знакомство с базой данных SQL][]   
* [Управление базами данных и именами входа в базе данных SQL][]   
* [Мониторинг базы данных SQL с использованием динамических представлений управления][]   
* [Модель подготовки базы данных SQL][]   
* [Добавление пользователей в базу данных SQL][]   
* [Справочник по Transact-SQL (база данных SQL)][]

  [Использование базы данных SQL Azure]: http://www.windowsazure.com/ru-ru/develop/net/how-to-guides/sql-azure/
  [Шаг 1: Получение среды SQL Server Management Studio]: #Step1
  [Шаг 2: Подключение к базе данных SQL]: #Step2
  [Шаг 3: Создание баз данных и управление ими]: #Step3
  [Шаг 4: Создание имен входа и управление ими]: #Step4
  [Шаг 5: Мониторинг базы данных SQL с помощью динамических административных представлений]:
    #Шаг5
  [Microsoft SQL Server 2012 Express]: http://www.microsoft.com/ru-ru/download/details.aspx?id=29062
  [Программа установки SSMS - выберите тип установки]: /media/installer_installation_type.png
  [Программа установки SSMS - выберите функции]: /media/installer_feature_selection.png
  [Программа установки SSMS - установка завершена]: /media/installer_completed.png
  [Портал управления Azure]: http://manage.windowsazure.com/
  [Получите имя сервера базы данных SQL на портале управления]: /media/portal_get_database_name.png
  [Подключение к SSMS]: /media/ssms_connect.png
  [Подключение к SSMS - свойства]: /media/ssms_connect_properties.png
  [Справочник по Transact-SQL (база данных SQL)]: http://msdn.microsoft.com/ru-ru/library/bb510741(v=sql.120).aspx
  [CREATE DATABASE (база данных SQL)]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336274.aspx
  [ALTER DATABASE (база данных SQL)]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ff394109.aspx
  [DROP DATABASE (база данных SQL)]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336259.aspx
  [Управление базами данных и учетными записями в базе данных SQL]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336235.aspx
  [CREATE LOGIN (база данных SQL)]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336268.aspx
  [CREATE USER (база данных SQL)]: http://msdn.microsoft.com/ru-ru/library/ee336277.aspx
  [sp_addrolemember (Transact-SQL)]: http://msdn.microsoft.com/ru-ru/library/ms187750.aspx
  [ALTER LOGIN (база данных SQL)]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336254.aspx
  [Мониторинг базы данных SQL с помощью динамических представлений управления]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ff394114.aspx
  [Введение в базы данных SQL]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336230.aspx
  [Модель подготовки базы данных SQL]: http://msdn.microsoft.com/ru-ru/library/ee336227.aspx
  [Добавление пользователей в базу данных SQL]: http://blogs.msdn.com/b/sqlazure/archive/2010/06/21/10028038.aspx
