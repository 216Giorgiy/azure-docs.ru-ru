
# Управление базой данных SQL Azure с помощью SQL Server Management Studio 

Для управления подписками базы данных SQL, для создания соответствующих логических серверов и баз данных, а также для управления ими можно использовать портал управления базой данных SQL Azure или клиентское приложение среды SQL Server Management Studio (SSMS). В приведенном ниже руководстве описывается, как использовать среду Management Studio для управления логическими серверами баз данных SQL и базами данных.

>[AZURE.NOTE]Следует использовать SQL Server 2014 Management Studio и установить последние обновления (CU5 или более поздней версии) для управления базой данных SQL Azure, включая последнюю версию (12) обновления базы данных SQL. Можно также использовать SQL Server 2012 или версию SSMS для SQL Server 2008 R2. Более ранние версии не поддерживаются.

Этот раздел включает следующие шаги:

-   [Шаг 1. Получение среды SQL Server 2014 Management Studio][]
-   [Шаг 2. Подключение к базе данных SQL][]
-   [Шаг 3. Создание баз данных и управление ими][]
-   [Шаг 4. Создание учетных записей и управление ими][]
-   [Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления][]

<h2><a id="Step1" name="Step1"> </a>Шаг 1. Получение среды SQL Server 2014 Management Studio</h2>

Среда Management Studio — это интегрированная среда для управления базами данных SQL. При управлении базами данных на платформе Azure вы можете использовать приложение Management Studio, установленное с SQL Server, или загрузить бесплатное приложение SQL Server 2014 Management Studio (SSMS). В следующих шагах описывается, как установить среду SSMS.

1.  Чтобы открыть окно выбора файла, на странице [Microsoft SQL Server 2014 Express][] щелкните **Загрузить**.

2.  Выберите **MgmtStudio 32BIT\SQLManagementStudio_x86_ENU.exe**, если вы используете 32-разрядную операционную систему, или **MgmtStudio 64BIT\SQLManagementStudio_x64_ENU.exe**, если вы используете 64-разрядную операционную систему.

3.  Нажмите кнопку **Далее**, и в ответ на запрос запустите программу установки.

2.  Щелкните **Новая изолированная установка SQL Server или добавление компонентов к существующей установке** и нажмите кнопку **ОК**.

3.  Примите условия лицензионного соглашения и нажмите кнопку **Далее**.

4. Нажмите кнопку **Установить** для установки файлов, используемых программой установки SQL Server.

5.  На экране **Выбор компонентов** предварительно выбраны значения **Средства управления — основные** и **Средства управления — полный набор**. Нажмите кнопку **Далее**.

6.  На экране **Отчеты об ошибках** вы можете дополнительно указать, следует ли отправлять сообщения об ошибках в корпорацию Майкрософт.

7.  Когда установка будет завершена, вы увидите страницу **Завершено**. Нажмите кнопку **Закрыть**

8. Установите последние обновления на странице [Накопительный пакет обновления 5 для SQL Server 2014][].

<h2><a id="Step2" name="Step2"> </a>Шаг 2. Подключение к базе данных SQL</h2>

Для подключения к базе данных SQL необходимо знать имя сервера в Azure. Для получения этой информации может понадобиться войти на портал.

1.  Выполните вход на [портал управления Azure][].

2.  В левой области щелкните **Базы данных SQL**.

3.  На домашней странице базы данных SQL щелкните **СЕРВЕРЫ** в верхней части страницы, чтобы вывести список всех серверов, связанных с подпиской. Найдите имя сервера, к которому вы хотите подключиться и скопируйте его в буфер обмена.

	Затем настройте брандмауэр базы данных SQL так, чтобы разрешить подключения с локального компьютера. Вы можете сделать это, добавив IP-адрес своего локального компьютера в список исключений брандмауэра.

1.  На домашней странице базы данных SQL щелкните **СЕРВЕРЫ** и выберите сервер, к которому нужно подключиться.

2.  В верхней части страницы щелкните **Настроить**.

3.  Скопируйте в IP-адрес в ТЕКУЩИЙ IP-АДРЕС КЛИЕНТА.

4.  На странице "Настройка" группа **Разрешенные IP-адреса** содержит три поля, в которых можно задать имя правила и диапазон IP-адресов как начальное и конечное значения. В качестве имени правила можно ввести имя компьютера. Для определения начала и конца диапазона вставьте IP-адрес своего компьютера в оба полях, а затем установите появившийся флажок.

	Имя правила должно быть уникальным. Если используется компьютер разработчика, можно ввести IP-адрес и в поле начало диапазона IP-адресов, и в поле конца этого диапазона. В противном случае необходимо ввести более широкий диапазон IP-адресов, чтобы разрешить подключения других компьютеров организации.
 
5. В нижней части страницы нажмите кнопку **СОХРАНИТЬ**.

    **Примечание.** Задержка вступления в силу новых настроек брандмауэра может составить до пяти минут.

	Теперь все готово для подключения к базе данных SQL с помощью среды Management Studio.

1.  На панели задач нажмите кнопку **Пуск**, откройте **Все программы**, **Microsoft SQL Server 2014**, а затем выберите **SQL Server Management Studio**.

2.  В поле **Подключение к серверу** укажите полное имя сервера в виде *serverName*. database.windows.net. В Azure имя сервера представляет собой автоматически формируемую строку, состоящую из буквенно-цифровых символов.

3.  Выберите **Аутентификация на SQL-сервере**.

4.  В поле **Вход** введите имя администратора SQL Server, которое вы указали на портале при создании своего сервера.

5.  В поле **Пароль** введите тот пароль, который вы указали на портале при создании своего сервера.

8.  Для подключения нажмите кнопку **Подключиться**.

SQL Server 2014 SSMS с последними обновлениями предлагает расширенную поддержку для таких задач, как создание и изменение баз данных Azure SQL. Кроме того, вы можете использовать инструкции Transact-SQL для выполнения этих задач. Примерами этих инструкций являются следующие действия. Для получения дополнительной информации об использовании Transact-SQL с базой данных SQL, в том числе и подробных сведений о том, какие инструкции поддерживаются, см. [Справочник по Transact-SQL (база данных SQL)][].

<h2><a id="Step3" name="Step3"> </a>Шаг 3. Создание баз данных и управление ими</h2>

После подключения к базе данных **master** вы можете создать новые базы данных на сервере и изменить или удалить существующие базы данных. Следующие действия описывают выполнение ряда типовых задач управления базами данных в среде Management Studio. Для выполнения этих задач убедитесь, что вы подключены к базе данных **master** под основной учетной записью на уровне сервера, которую вы создали при настройке сервера.

Для открытия окна запроса в среде Management Studio откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и нажмите кнопку **Создать запрос**.

-   Для создания новой базы данных используйте инструкцию **CREATE DATABASE**. Для получения дополнительных сведений см. статью [CREATE DATABASE (база данных SQL)][]. Инструкция, приведенная ниже, позволяет создать новую базу данных с именем **myTestDB** и указывает, что это выпуск базы данных Standard S0 с максимальным размером по умолчанию, равным 250 ГБ.

        CREATE DATABASE myTestDB
        (EDITION='Standard',
         SERVICE_OBJECTIVE='S0');

Нажмите кнопку **Выполнить** для выполнения запроса.

-   Используйте инструкцию **ALTER DATABASE**, чтобы изменить существующую базу данных, если, например, вы хотите изменить имя или выпуск базы данных. Дополнительные сведения см. в разделе [ALTER DATABASE (база данных SQL)][]. Приведенная ниже инструкция позволяет модифицировать базу данных, которую вы создали на предыдущем шаге, чтобы изменить выпуск на Standard S1.

        ALTER DATABASE myTestDB
        MODIFY
        (SERVICE_OBJECTIVE='S1');

-   Используйте инструкцию **DROP DATABASE**, чтобы удалить существующую базу данных. Дополнительные сведения см. в разделе [DROP DATABASE (база данных SQL)][]. Приведенная ниже инструкция позволяет удалить базу данных **myTestDB**, но не удаляйте ее сейчас, потому что эта база будет использоваться для создания учетных записей на следующем шаге.

        DROP DATABASE myTestBase;

-   У главной базы данных есть представление **sys.databases**, которое можно использовать для просмотра сведений обо всех базах данных. Чтобы просмотреть все существующие базы данных, выполните следующую инструкцию:

        SELECT * FROM sys.databases;

-   В базе данных SQL инструкция **USE** не поддерживается для переключения между базами данных. Вместо нее необходимо установить подключение непосредственно к целевой базе данных.

>[AZURE.NOTE]Многие инструкции Transact-SQL, позволяющие создавать и изменять базы данных, должны выполняться в своем собственном пакете и не могут быть сгруппированы с другими инструкциями Transact-SQL. Дополнительные сведения см. в описании конкретной инструкции по приведенным ниже ссылкам.

<h2><a id="Step4" name="Step4"> </a>Шаг 4. Создание учетных записей и управление ими</h2>

База данных **master** отслеживает учетные записи и то, какие из них имеют разрешение на создание баз данных или других учетных записей. Управление учетными записями выполняется посредством подключения к базе данных **master** под основной учетной записью на уровне сервера, которую вы создали, когда настраивали свой сервер. Вы можете использовать инструкции **CREATE LOGIN**, **ALTER LOGIN** или **DROP LOGIN**, чтобы выполнять запросы к базе данных «master», которая будет управлять учетными записями по всему серверу. Дополнительные сведения см. в разделе [Управление базами данных и учетными записями в базе данных SQL][]


-   Чтобы создать новую учетную запись на уровне сервера, используйте инструкцию **CREATE LOGIN**. Дополнительные сведения см. в разделе [CREATE LOGIN (база данных SQL)][]. Приведенная ниже инструкция создает новую учетную запись с именем **login1**. Замените **password1** на пароль по вашему выбору.

        CREATE LOGIN login1 WITH password='password1';

-   Для предоставления разрешений на уровне базы данных используйте инструкцию **CREATE USER**. Все учетные записи должны быть созданы в главной базе данных **master**, но для подключения по учетной записи к другой базе данных необходимо предоставить соответствующие разрешения на уровне базы данных с помощью инструкции **CREATE USER**. Дополнительные сведения см. в разделе [CREATE USER (база данных SQL)][].

-   Чтобы разрешить учетной записи «login1» подключение к базе данных **myTestDB**, выполните следующие действия:

 1.  Для обновления показа вновь созданной базы данных обозревателем объектов **myTestDB** щелкните правой кнопкой мыши по имени сервера в обозревателе объектов, а затем выберите пункт **Обновить**.  

     Если подключение закрыто, можно подключиться повторно, выбрав **Подключить обозреватель объектов** в меню "Файл". Для подключения к базе данных повторите инструкции, приведенные в разделе [Шаг 2. Подключение к базе данных SQL][].

 2. Щелкните правой кнопкой мыши по базе данных **myTestDB** и выберите пункт **Создать запрос**.

    3.  Выполните следующую инструкцию в базе данных «myTestDB», чтобы создать пользователя базы данных с именем **login1User**, которое соответствует учетной записи уровня сервера **login1**.

            CREATE USER login1User FROM LOGIN login1;

-   Воспользуйтесь хранимой процедурой **sp_addrolemember**, чтобы предоставить учетной записи пользователя соответствующий уровень полномочий в базе данных. Для получения более подробной информации см. [sp_addrolemember (Transact-SQL)][]. Приведенная ниже инструкция дает **login1User** разрешение только на чтение из базы данных, добавляя **login1User** к роли **db_datareader**.

        exec sp_addrolemember 'db_datareader', 'login1User';    

-   Используйте инструкцию **ALTER LOGIN**, чтобы изменить существующую учетную запись, если, например, вы хотите изменить пароль для нее. Для получения дополнительных сведений см. [ALTER LOGIN (база данных SQL)][]. Инструкция **ALTER LOGIN** должна выполняться в базе данных **master**. Переключитесь в окно запроса, подключенного к этой базе данных.

    Приведенная ниже инструкция изменяет учетную запись **login1**, сбрасывая пароль. Замените **newPassword** на пароль по своему выбору, а старый пароль **oldPassword** замените на текущий пароль для учетной записи.

        ALTER LOGIN login1
        WITH PASSWORD = 'newPassword'
        OLD_PASSWORD = 'oldPassword';

-   Воспользуйтесь инструкцией **DROP LOGIN**, чтобы удалить существующую учетную запись. При удалении учетной записи на уровне сервера удаляются и все связанные учетные записи пользователей баз данных. Дополнительные сведения см. в разделе [DROP DATABASE (база данных SQL)][]. Инструкция **DROP LOGIN** должна выполняться для базы данных **master**. Приведенная ниже инструкция удаляет учетную запись **login1**.

        DROP LOGIN login1;

-   В базе данных «master» предусмотрено представление **sys.sql_logins**, которое можно использовать для просмотра учетных записей. Чтобы просмотреть все существующие учетные записи, выполните следующую инструкцию:

        SELECT * FROM sys.sql_logins;

<h2><a id="Step5" name="Step5"></a>Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления</h2>

База данных SQL поддерживает несколько динамических представлений управления, которые можно использовать для мониторинга отдельных баз данных. Ниже приведен ряд примеров типов контролируемых данных, которые можно получить с помощью этих представлений. Подробные сведения и дополнительные примеры см. в разделе [Мониторинг базы данных SQL с помощью динамических представлений управления][].

-   Запрос динамического представления управления требует наличия разрешений **VIEW DATABASE STATE**. Чтобы предоставить разрешение **VIEW DATABASE STATE** для определенного пользователя базы данных, подключитесь к базе данных, которой вы хотите управлять, под основной учетной записью на уровне сервера и выполните следующую инструкцию в базе данных:

        GRANT VIEW DATABASE STATE TO login1User;

-   Рассчитайте размер базы данных с помощью представления **sys.dm_db_partition_stats**. Представление **sys.dm_db_partition_stats** возвращает информацию о странице и числе строк для каждого раздела в базе данных, позволяя рассчитать размер базы данных. Следующий запрос возвращает размер базы данных в мегабайтах:

        SELECT SUM(reserved_page_count)*8.0/1024
        FROM sys.dm_db_partition_stats;   

-   Используйте представления **sys.dm_exec_connections** и **sys.dm_exec_sessions** для получения информации о текущих пользовательских подключениях и внутренних задачах, связанных с базой данных. Следующий запрос возвращает сведения о текущем подключении:

        SELECT
            e.connection_id,
            s.session_id,
            s.login_name,
            s.last_request_end_time,
            s.cpu_time
        FROM
            sys.dm_exec_sessions s
            INNER JOIN sys.dm_exec_connections e
              ON s.session_id = e.session_id;

-   Используйте представление **sys.dm_exec_query_stats** для получения объединенной статистики производительности для кэшированных планов запросов. Следующий запрос возвращает сведения о пяти первых запросах, упорядоченных по среднему времени ЦП.

        SELECT TOP 5 query_stats.query_hash AS "Query Hash",
            SUM(query_stats.total_worker_time), SUM(query_stats.execution_count) AS "Avg CPU Time",
            MIN(query_stats.statement_text) AS "Statement Text"
        FROM
            (SELECT QS.*,
            SUBSTRING(ST.text, (QS.statement_start_offset/2) + 1,
            ((CASE statement_end_offset
                WHEN -1 THEN DATALENGTH(ST.text)
                ELSE QS.statement_end_offset END
                    - QS.statement_start_offset)/2) + 1) AS statement_text
             FROM sys.dm_exec_query_stats AS QS
             CROSS APPLY sys.dm_exec_sql_text(QS.sql_handle) as ST) as query_stats
        GROUP BY query_stats.query_hash
        ORDER BY 2 DESC;

<h2>Дополнительные ресурсы</h2>

* [Введение в базы данных SQL][]   
* [Управление базами данных и учетными записями в базе данных SQL][]   
* [Мониторинг базы данных SQL с помощью динамических представлений управления][]   
* [Справочник по Transact-SQL (база данных SQL)][]

  [How to use Azure SQL Database]: http://www.windowsazure.com/develop/net/how-to-guides/sql-azure/
  [Шаг 1. Получение среды SQL Server 2014 Management Studio]: #Step1
  [Шаг 2. Подключение к базе данных SQL]: #Step2
  [Шаг 3. Создание баз данных и управление ими]: #Step3
  [Шаг 4. Создание учетных записей и управление ими]: #Step4
  [Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления]: #Step5
  [Microsoft SQL Server 2014 Express]: http://www.microsoft.com/download/details.aspx?id=42299
  [Накопительный пакет обновления 5 для SQL Server 2014]: http://support2.microsoft.com/kb/3011055
  [SSMS Installer - Select installation type]: /media/installer_installation_type.png
  [SSMS Installer - Select features]: /media/installer_feature_selection.png
  [SSMS Installer - Installation complete]: /media/installer_completed.png
  [портал управления Azure]: http://manage.windowsazure.com/
  [Get SQL Database server name from Management Portal]: /media/portal_get_database_name.png
  [Connect to SSMS]: /media/ssms_connect.png
  [Connect to SSMS -- properties]: /media/ssms_connect_properties.png
  [Справочник по Transact-SQL (база данных SQL)]: http://msdn.microsoft.com/library/bb510741(v=sql.120).aspx
  [CREATE DATABASE (база данных SQL)]: https://msdn.microsoft.com/library/dn268335.aspx
  [ALTER DATABASE (база данных SQL)]: https://msdn.microsoft.com/library/ms174269.aspx
  [DROP DATABASE (база данных SQL)]: https://msdn.microsoft.com/library/ms178613.aspx
  [Управление базами данных и учетными записями в базе данных SQL]: http://msdn.microsoft.com/library/windowsazure/ee336235.aspx
  [CREATE LOGIN (база данных SQL)]: https://msdn.microsoft.com/library/ms189751.aspx
  [CREATE USER (база данных SQL)]: https://msdn.microsoft.com/library/ms173463.aspx
  [sp_addrolemember (Transact-SQL)]: http://msdn.microsoft.com/library/ms187750.aspx
  [ALTER LOGIN (база данных SQL)]: https://msdn.microsoft.com/library/ms189828.aspx
  [Мониторинг базы данных SQL с помощью динамических представлений управления]: http://msdn.microsoft.com/library/windowsazure/ff394114.aspx
  [Введение в базы данных SQL]: http://azure.microsoft.com/services/sql-database/
 

<!---HONumber=62-->