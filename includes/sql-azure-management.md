
# Управление базой данных SQL Azure с помощью SQL Server Management Studio 

Вы можете использовать портал управления базой данных SQL Azure или клиентское приложение SQL Server Management Studio (SSMS) для управления вашими подписками базы данных SQL, создавать связанные логические серверы и базы данных и управлять ими. В приведенном ниже руководстве описывается, как использовать среду Management Studio для управления логическими серверами баз данных SQL и базами данных.

<div class="dev-callout-new-collapsed">
<strong>Примечание. <span>Щелкните, чтобы свернуть</span></strong>
<div class="dev-callout-content">
<p>Можно использовать версии SSMS из SQL Server 2014, SQL Server 2012 и SQL Server 2008 R2. Более ранние версии не поддерживаются.</p>
</div>
</div>

Этот раздел включает следующие шаги:

-   [Шаг 1. Получение среды SQL Server Management Studio][]
-   [Шаг 2. Подключение к базе данных SQL][]
-   [Шаг 3. Создание баз данных и управление ими][]
-   [Шаг 4. Создание имен входа и управление ими][]
-   [Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления][]

<h2><a id="Step1" name="Step1"> </a>Шаг 1. Получение среды SQL Server Management Studio</h2>

Среда Management Studio - это интегрированная среда для управления базами данных SQL. При управлении базами данных Azure можно использовать приложение Management Studio, установленное с
SQL Server, или загрузить бесплатную версию SQL Server 2012 Management Studio Express (SSMSE). Следующие шаги описывают последовательность действий при установке среды SSMSE.

1.  На странице [Microsoft SQL Server 2012 Express][] выберите версию x86 среды Management Studio при использовании 32-разрядной операционной системы или версию x64 при использовании 64-разрядной операционной системы. Нажмите кнопку **Загрузить**, и в ответ на запрос запустите программу установки.

2.  Щелкните **Новая изолированная установка SQL Server или добавление компонентов к существующему экземпляру** и нажмите кнопку **ОК**.

3.  Примите условия лицензионного соглашения и нажмите кнопку **Далее**.

4. Нажмите кнопку **Установить** для установки файлов, используемых программой установки SQL Server.

5.  На экране **Выбор компонентов** уже выбран вариант **Средства управления - основные**. Это вызвано использованием программы установки для среды Management Studio. При использовании программы установки для всего ПО SQL Server Express выберите вариант **Средства управления - основные**, а затем нажмите кнопку **Далее**

6.  С помощью экрана **Сообщения об ошибках** при необходимости можно отправить отчеты об ошибках в корпорацию Майкрософт. Это не требуется для использования среды SSMSE. Нажмите кнопку **Далее**, чтобы начать установку.

7.  После завершения установки появится страница **Выполнено**. Нажмите кнопку **Закрыть** 


<h2><a id="Step2" name="Step2"> </a>Шаг 2. Подключение к базе данных SQL</h2>

Для подключения к базе данных SQL необходимо знать имя сервера в Azure. Вам может потребоваться зайти на портал, чтобы получить эту информацию.

1.  Войдите на [портал управления Azure][].

2.  В левой области щелкните **Базы данных SQL**.

3.  На домашней странице базы данных SQL щелкните **СЕРВЕРЫ** в верхней части страницы, чтобы вывести список всех серверов, связанных с подпиской. Найдите имя сервера, к которому вы хотите подключиться и скопируйте его в буфер обмена.

	Затем настройте брандмауэр базы данных SQL так, чтобы разрешить подключения с локального компьютера. Вы можете сделать это, добавив IP-адрес своего локального компьютера в список исключений брандмауэра.

1.  На домашней странице базы данных SQL щелкните **СЕРВЕРЫ** и выберите сервер, к которому нужно подключиться.

2.  В верхней части страницы щелкните **Настроить**.

3.  Скопируйте в IP-адрес в ТЕКУЩИЙ IP-АДРЕС КЛИЕНТА.

4.  На странице "Настройка" группа **Разрешенные IP-адреса** содержит три поля, в которых можно задать имя правила и диапазон IP-адресов как начальное и конечное значения. В качестве имени правила можно ввести имя компьютера. В качестве начала и окончания диапазона вставьте IP-адрес вашего компьютера в оба поля, а затем установите появившийся флажок.

	Имя правила должно быть уникальным. Если используется компьютер разработчика, можно ввести IP-адрес и в поле начало диапазона IP-адресов, и в поле конца этого диапазона. В противном случае может потребоваться ввести более широкий диапазон IP-адресов для разрешения подключений и с других компьютеров в вашей организации.
 
5. В нижней части страницы нажмите кнопку **СОХРАНИТЬ**.
 **Примечание.** Задержка вступления в силу новых настроек брандмауэра может составить до пяти минут.

	Теперь все готово для подключения к базе данных SQL с помощью среды Management Studio.

1.  На панели задач нажмите кнопку **Пуск**, откройте **Все программы**, **Microsoft SQL Server 2012** и выберите **SQL Server Management Studio**.

2.  В окне **Подключение к серверу**, укажите полное имя сервера как *serverName*.database.windows.net. В Azure имя сервера представляет собой автоматически формируемую строку, состоящую из буквенно-цифровых символов.

3.  Выберите **Аутентификация на SQL-сервере**.

4.  В поле **Вход** введите имя администратора SQL Server, заданное на портале при создании сервера, в формате
    *login*@*имя_сервера*.

5.  В поле **Пароль** введите пароль, заданный на портале при создании сервера.

8.  Для подключения нажмите кнопку **Подключиться**.

На платформе Azure каждый логический сервер базы данных SQL - это абстракция, которая определяет группу баз данных. Физически любая база данных может находиться на любом компьютере в центре обработки данных. 

В предыдущих версиях при настройке подключения в среде Management Studio приходилось подключаться непосредственно к **главной** базе данных. Этот шаг больше не требуется. Соединения теперь устанавливаются исходя из имени сервера, типа проверки подлинности и учетных данных администратора.

Ряд мастеров SSMS, которые можно использовать для таких задач, как создание и изменение учетных данных и баз данных в базе данных SQL Server, недоступны для баз данных SQL в Azure, поэтому для выполнения этих задач требуется применять
инструкции Transact-SQL для выполнения этих задач. Примерами этих инструкций являются следующие действия. Для получения дополнительной информации об использовании
Transact-SQL с базой данных SQL, включая сведения о поддерживаемых командах, см. [Справочник по Transact-SQL (база данных SQL)][].

<h2><a id="Step3" name="Step3"> </a>Шаг 3. Создание баз данных и управление ими</h2>

После подключения к **главной** базе данных можно создавать на сервере новые базы данных, а также изменять и удалять уже имеющиеся. Следующие действия описывают выполнение ряда типовых задач управления базами данных в среде Management Studio. Для выполнения этих задач убедитесь, что вы подключены к
**главной** базе данных, используя имя участника уровня сервера, созданное при установке сервера.

Для открытия окна запроса в среде Management Studio следует открыть папку "Базы данных", развернуть папку **Системные базы данных**, щелкнуть правой кнопкой мыши **главную** базу данных и нажать кнопку **Создать запрос**.

-   Для создания новой базы данных используйте инструкцию **CREATE DATABASE**. Дополнительные сведения см. в разделе [CREATE DATABASE (база данных SQL)][]. Приведенная ниже инструкция создает новую базу данных с именем **myTestDB** и определяет, что она является базой данных Web Edition с максимальным размером 1 ГБ.

        CREATE DATABASE myTestDB
        (MAXSIZE=1GB,
         EDITION='web');

Нажмите кнопку **Выполнить** для выполнения запроса.

-   Используйте инструкцию **ALTER DATABASE** для изменения существующей базы данных, например если нужно изменить имя, максимальный размер или выпуск базы данных (Business или Web). Дополнительные сведения см. в разделе [ALTER DATABASE (база данных SQL)][]. Приведенная ниже инструкция изменяет базу данных, созданную на предыдущем шаге, чтобы увеличить ее максимальный размер до 5 ГБ.

        ALTER DATABASE myTestDB
        MODIFY
        (MAXSIZE=5GB,
         EDITION='web');

-   Используйте команду **DROP DATABASE**, чтобы удалить существующую базу данных. Дополнительные сведения см. в разделе [DROP DATABASE (база данных SQL)][]. Следующая инструкция удаляет базу данных **myTestDB**, но не уничтожает ее в этот момент, так как созданные для нее имена пользователей будут использоваться на следующем шаге.

        DROP DATABASE myTestBase;

-   У главной базы данных есть представление **sys.databases**, которое можно использовать для просмотра сведений обо всех базах данных. Чтобы просмотреть все существующие базы данных, выполните следующую инструкцию:

        SELECT * FROM sys.databases;

-   В базе данных SQL инструкция **USE** для переключения между базами данных не поддерживается. Вместо нее необходимо установить подключение непосредственно к целевой базе данных.

<div class="dev-callout-new">
 <strong>Примечание. <span>Щелкните, чтобы свернуть</span></strong>
 <div class="dev-callout-content">
   <p>Многие инструкции Transact-SQL, позволяющие создавать и изменять базы данных, должны выполняться в своем собственном пакете и не могут быть сгруппированы с другими инструкциями Transact-SQL. Дополнительные сведения см. в описании конкретной инструкции по приведенным ниже ссылкам.</p>
</div>
</div>

<h2><a id="Step4" name="Step4"> </a>Шаг 4. Создание учетных записей и управление ими</h2>

В **главной** базе данных отслеживаются учетные данные и их права на создание баз данных или других учетных данных. Для управления учетными данными необходимо подключиться к **главной** базе данных, используя имя участника уровня сервера, созданное при установке сервера. Вы можете использовать инструкции
**CREATE LOGIN**, **ALTER LOGIN** или **DROP LOGIN** для выполнения запросов к главной базе данных, позволяющей управлять учетными записями по всему серверу. Дополнительные сведения см. в разделе [Управление базами данных и учетными записями в базе данных SQL][]. 


-   Для создания новой учетной записи на уровне сервера следует использовать инструкцию **CREATE LOGIN**. Дополнительные сведения см. в разделе [CREATE LOGIN (база данных SQL)][]. Следующая инструкция создает новую учетную запись с именем **login1**. Замените **password1** на пароль по вашему выбору.

        CREATE LOGIN login1 WITH password='password1';

-   Инструкция **CREATE USER** используется, чтобы предоставить разрешения на уровне базы данных. Все учетные записи должны быть созданы в **главной** базе данных. Но для подключения по учетной записи к другой базе данных необходимо предоставить соответствующие разрешения на уровне базы данных с помощью инструкции **CREATE USER**. Дополнительные сведения см. в разделе [CREATE USER (база данных SQL)][]. 

-   Для предоставления учетной записи login1 разрешения на подключения к базе данных **myTestDB** выполните следующие действия.

 1.  Для обновления показа вновь созданной базы данных обозревателем объектов **myTestDB** щелкните правой кнопкой мыши имя сервера в обозревателе объектов, а затем выберите пункт **Обновить**.  
  Если подключение закрыто, можно подключиться повторно, выбрав **Подключить обозреватель объектов** в меню "Файл". Повторите инструкции, приведенные в разделе [Шаг 2. Подключение к базе данных SQL][], чтобы подключиться к базе данных.

 2. Щелкните правой кнопкой мыши базу данных **myTestDB** и выберите пункт **Создать запрос**.

    3.  Выполните для базы данных myTestDB следующую инструкцию, чтобы создать пользователя базы данных с именем **login1User**, соответствующего учетной записи уровня сервера **login1**.
         CREATE USER login1User FROM LOGIN login1;

-   Для предоставления учетной записи пользователя соответствующего уровня разрешений для работы с базой данных следует применить хранимую процедуру **sp\_addrolemember**. Дополнительные сведения см. в разделе [sp_addrolemember (Transact-SQL)][]. Следующая инструкция предоставляет учетной записи **login1User** разрешения для базы данных "только чтение", добавляя **login1User** в роль **db\_datareader**.

        exec sp_addrolemember 'db_datareader', 'login1User';    

-   Для изменения существующей учетной записи (например, для изменения пароля) используйте инструкцию **ALTER LOGIN**. Дополнительные сведения см. в разделе [ALTER LOGIN (база данных SQL)][]. Инструкция **ALTER LOGIN** должна выполняться для **главной** базы данных. Переключитесь в окно запроса, подключенного к этой базе данных. 
 Приведенная ниже инструкция изменяет имя входа **login1**, сбрасывая пароль. Замените **newPassword** на пароль по вашему выбору и введите для **oldPassword** текущий пароль учетной записи.

        ALTER LOGIN login1
        WITH PASSWORD = 'newPassword'
        OLD_PASSWORD = 'oldPassword';

-   Воспользуйтесь инструкцией **DROP LOGIN**, чтобы удалить существующее имя входа. При удалении учетной записи на уровне сервера удаляются и все связанные учетные записи пользователей баз данных. Дополнительные сведения см. в разделе [DROP DATABASE (база данных SQL)][]. Инструкция **DROP LOGIN** должна выполняться для **главной** базы данных. Следующая инструкция удаляет учетную запись **login1**.
     DROP LOGIN login1;

-   У главной базы данных есть представление **sys.sql\_logins**, которое можно использовать для просмотра учетных записей. Чтобы просмотреть все существующие учетные записи, выполните следующую инструкцию:

        SELECT * FROM sys.sql_logins;

<h2><a id="Step5" name="Step5"> </a>Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления</h2>

База данных SQL поддерживает несколько динамических представлений управления, которые можно использовать для мониторинга отдельных баз данных. Ниже приведен ряд примеров типов контролируемых данных, которые можно получить с помощью этих представлений. Подробные сведения и дополнительные примеры см. в разделе [Мониторинг базы данных SQL с помощью динамических представлений управления][].

-   Запрос динамического представления управления требует разрешения **VIEW DATABASE STATE**. Для предоставления конкретному пользователю базы данных разрешения на **VIEW DATABASE STATE** подключитесь к базе данных, которой нужно управлять, используя учетную запись участника на уровне сервера, и выполните следующую инструкцию для базы данных:

        GRANT VIEW DATABASE STATE TO login1User;

-   Рассчитайте размер базы данных с помощью представления **sys.dm\_db\_partition\_stats**. Представление **sys.dm\_db\_partition\_stats** возвращает информацию о    странице и числе строк для каждого раздела в базе данных, позволяя рассчитать размер базы данных. Следующий запрос возвращает размер базы данных в мегабайтах:

        SELECT SUM(reserved_page_count)*8.0/1024
        FROM sys.dm_db_partition_stats;   

-   Используйте представления **sys.dm\_exec\_connections** и **sys.dm\_exec\_sessions** для получения информации о текущих пользовательских подключениях и внутренних задачах, связанных с базой данных. Следующий запрос возвращает сведения о текущем подключении:

        SELECT
            e.connection_id,
            s.session_id,
            s.login_name,
            s.last_request_end_time,
            s.cpu_time
        FROM
            sys.dm_exec_sessions s
            INNER JOIN sys.dm_exec_connections e
              ON s.session_id = e.session_id;

-   Используйте представление **sys.dm\_exec\_query\_stats** для получения объединенной статистики производительности для кэшированных планов запросов. Следующий запрос возвращает сведения о пяти первых запросах, упорядоченных по среднему времени ЦП.

        SELECT TOP 5 query_stats.query_hash AS "Query Hash",
            SUM(query_stats.total_worker_time), SUM(query_stats.execution_count) AS "Avg CPU Time",
            MIN(query_stats.statement_text) AS "Statement Text"
        FROM
            (SELECT QS.*,
            SUBSTRING(ST.text, (QS.statement_start_offset/2) + 1,
            ((CASE statement_end_offset
                WHEN -1 THEN DATALENGTH(ST.text)
                ELSE QS.statement_end_offset END
                    - QS.statement_start_offset)/2) + 1) AS statement_text
             FROM sys.dm_exec_query_stats AS QS
             CROSS APPLY sys.dm_exec_sql_text(QS.sql_handle) as ST) as query_stats
        GROUP BY query_stats.query_hash
        ORDER BY 2 DESC;

<h2>Дополнительные ресурсы</h2>

* [Введение в базы данных SQL][]   
* [Управление базами данных и учетными записями в базе данных SQL][]   
* [Мониторинг базы данных SQL с помощью динамических административных представлений][]   
* [Модель подготовки базы данных SQL][]   
* [Добавление пользователей в базу данных SQL][]   
* [Справочник по Transact-SQL (база данных SQL)][]

  [Использование базы данных SQL Azure]: http://azure.microsoft.com/develop/net/how-to-guides/sql-azure/
  [Шаг 1. Получение среды SQL Server Management Studio]: #Step1
  [Шаг 2. Подключение к базе данных SQL]: #Step2
  [Шаг 3. Создание баз данных и управление ими]: #Step3
  [Шаг 4. Создание имен входа и управление ими]: #Step4
  [Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления]: #Шаг5
  [Microsoft SQL Server 2012 Express]: http://www.microsoft.com/ru-ru/download/details.aspx?id=29062
  [Установщик SSMS - выбор типа установки]: /media/installer_installation_type.png
  [Установщик SSMS - выбор компонентов]: /media/installer_feature_selection.png
  [Установщик SSMS - завершение установки]: /media/installer_completed.png
  [Портал управления Azure]: http://manage.windowsazure.com/
  [Получение имени сервера баз данных SQL из портала управления]: /media/portal_get_database_name.png
  [Подключение к SSMS]: /media/ssms_connect.png
  [Подключение к SSMS - свойства]: /media/ssms_connect_properties.png
  [Справочник по Transact-SQL (база данных SQL)]: http://msdn.microsoft.com/library/bb510741(v=sql.120).aspx
  [CREATE DATABASE (база данных SQL)]: http://msdn.microsoft.com/library/windowsazure/ee336274.aspx
  [ALTER DATABASE (база данных SQL)]: http://msdn.microsoft.com/library/windowsazure/ff394109.aspx
  [DROP DATABASE (база данных SQL)]: http://msdn.microsoft.com/library/windowsazure/ee336259.aspx
  [Управление базами данных и учетными записями в базе данных SQL]: http://msdn.microsoft.com/library/windowsazure/ee336235.aspx
  [CREATE LOGIN (база данных SQL)]: http://msdn.microsoft.com/library/windowsazure/ee336268.aspx
  [CREATE USER (база данных SQL)]: http://msdn.microsoft.com/library/ee336277.aspx
  [sp_addrolemember (Transact-SQL)]: http://msdn.microsoft.com/library/ms187750.aspx
  [CREATE USER (база данных SQL)]: http://msdn.microsoft.com/library/windowsazure/ee336254.aspx
  [Мониторинг базы данных SQL с помощью динамических административных представлений]: http://msdn.microsoft.com/library/windowsazure/ff394114.aspx
  [Введение в базы данных SQL]: http://msdn.microsoft.com/library/windowsazure/ee336230.aspx
  [Модель подготовки базы данных SQL]: http://msdn.microsoft.com/library/ee336227.aspx
  [Добавление пользователей в базу данных SQL]: http://blogs.msdn.com/b/sqlazure/archive/2010/06/21/10028038.aspx
<!--HONumber=42-->
