
# Управление базой данных SQL Azure с помощью SQL Server Management Studio 

Вы можете использовать портал управления базой данных SQL Azure или клиентское приложение SQL Server Management Studio (SSMS) для управления вашими подписками базы данных SQL, создавать связанные логические серверы и базы данных и управлять ими. В приведенном ниже руководстве описывается, как использовать среду Management Studio для управления логическими серверами баз данных SQL и базами данных.

>[AZURE.NOTE] Следует использовать SQL Server 2014 Management Studio и установить последние обновления (CU5 или более поздней версии) для управления базой данных SQL Azure, включая последнюю версию (12) обновления базы данных SQL. Можно также использовать SQL Server 2012 или версию SSMS для SQL Server 2008 R2. Более ранние версии не поддерживаются. 

Этот раздел включает следующие шаги:

-   [Шаг 1. Получение среды SQL Server 2014 Management Studio][]
-   [Шаг 2. Подключение к базе данных SQL][]
-   [Шаг 3. Создание баз данных и управление ими.][]
-   [Шаг 4. Создание имен входа и управление ими.][]
-   [Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления.][]

<h2><a id="Step1" name="Step1"> </a>Шаг 1. Получение среды SQL Server 2014 Management Studio</h2>

Среда Management Studio - это интегрированная среда для управления базами данных SQL. При управлении базами данных на платформе Azure вы можете использовать приложение Management Studio, установленное с SQL Server, или загрузить бесплатное приложение SQL Server 2014 Management Studio (SSMS). В следующих шагах описывается, как установить среду SSMS.

1.  На странице [SQL Server 2014 Express][] выполните прокрутку вниз и выберите **MgmtStudio 32BIT\SQLManagementStudio_x86_ENU.exe**, если используете 32-разрядную операционную систему, или **MgmtStudio 64BIT\SQLManagementStudio_x64_ENU.exe**, если используете 64-разрядную операционную систему. Нажмите кнопку **Далее**, и в ответ на запрос запустите программу установки.

2.  Нажмите **Новая автономная установка SQL Server или добавление функций в уже имеющуюся установку**, после чего нажмите кнопку **ОК**.

3.  Примите условия лицензионного соглашения и нажмите кнопку **Далее**.

4. Нажмите кнопку **Установить** для установки файлов, используемых программой установки SQL Server.

5.  на экране **Выбор компонентов** предварительно выбраны значения **Средства управления - основные** и **Средства управления - полный набор**. Нажмите кнопку **Далее**.

6.  На экране **Сообщения об ошибках** вы можете дополнительно указать, следует ли отправлять отчеты об ошибках в Microsoft.

7.  Когда установка будет завершена, вы увидите страницу **Завершено**. Нажмите кнопку **Закрыть** 

8. Установите последние обновления на странице [Накопительный пакет обновления 5 для SQL Server 2014][].

<h2><a id="Step2" name="Step2"> </a>Шаг 2. Подключение к базе данных SQL</h2>

Для подключения к базе данных SQL необходимо знать имя сервера в Azure. Вам может потребоваться зайти на портал, чтобы получить эту информацию.

1.  Войдите на [портал управления Azure][].

2.  В левой области щелкните **Базы данных SQL**.

3.  На домашней странице базы данных SQL щелкните **СЕРВЕРЫ** в верхней части страницы, чтобы вывести список всех серверов, связанных с подпиской. Найдите имя сервера, к которому вы хотите подключиться и скопируйте его в буфер обмена.

	Затем настройте брандмауэр своей базы данных SQL так, чтобы разрешить соединения с вашего локального компьютера. Вы можете сделать это, добавив IP-адрес своего локального компьютера в список исключений брандмауэра.

1.  На домашней странице базы данных SQL щелкните **СЕРВЕРЫ** и выберите сервер, к которому нужно подключиться.

2.  В верхней части страницы щелкните **Настроить**.

3.  Скопируйте в IP-адрес в ТЕКУЩИЙ IP-АДРЕС КЛИЕНТА.

4.  На странице "Настройка" группа **Разрешенные IP-адреса** содержит три поля, в которых можно задать имя правила и диапазон IP-адресов как начальное и конечное значения. В качестве имени правила можно ввести имя компьютера. В качестве начала и окончания диапазона вставьте IP-адрес вашего компьютера в оба поля, а затем установите появившийся флажок.

	Имя правила должно быть уникальным. Если используется компьютер разработчика, можно ввести IP-адрес и в поле начало диапазона IP-адресов, и в поле конца этого диапазона. В противном случае может потребоваться ввести более широкий диапазон IP-адресов для разрешения подключений и с других компьютеров в вашей организации.
 
5. В нижней части страницы нажмите кнопку **СОХРАНИТЬ**.

    **Примечание.** Может быть задержка как минимум в пять минут, прежде чем изменения настроек брандмауэра вступят в силу.

	Теперь все готово для подключения к базе данных SQL с помощью среды Management Studio.

1.  На панели задач нажмите **Пуск**, щелкните элементы **Все программы**, **Microsoft SQL Server 2014**, а затем выберите **SQL Server Management Studio**.

2.  В поле **Подключение к серверу** укажите полное имя сервера в виде  *serverName*.database.windows.net. В Azure имя сервера представляет собой автоматически формируемую строку, состоящую из буквенно-цифровых символов.

3.  Выберите **Аутентификация на SQL-сервере**.

4.  В поле **Имя входа** введите имя входа администратора SQL Server, который вы указали на портал при создании сервера.

5.  В поле **Пароль** введите тот пароль, который вы указали на портале при создании сервера.

8.  Для подключения нажмите кнопку **Подключиться**.

SQL Server 2014 SSMS с последними обновлениями предлагает расширенную поддержку для таких задач, как создание и изменение баз данных Azure SQL. Кроме того, можно также использовать инструкции Transact-SQL для выполнения этих задач. В следующих шагах приводятся примеры этих команд. Для получения дополнительной информации об использовании Transact-SQL с базой данных SQL, в том числе и подробных сведений о том, какие команды поддерживаются, см. [Справочник по Transact-SQL (база данных SQL)][].

<h2><a id="Step3" name="Step3"> </a>Шаг 3. Создание баз данных и управление ими</h2>

После подключения к базе данных **master** можно создать новые базы данных на сервере и изменить или удалить существующие базы данных. Шаги, приведенные ниже, описывают, как выполняются несколько общих задач управления базами данных в среде Management Studio. Для выполнения этих задач убедитесь, что вы подключены к базе данных **master** под именем входа субъекта на уровне сервера, которое вы создали при настройке сервера.

Для открытия окна запроса в среде Management Studio следует открыть папку "Базы данных", развернуть папку **Системные базы данных**, щелкнуть правой кнопкой мыши базу данных **master** и нажать кнопку **Создать запрос**.

-   Для создания новой базы данных используйте инструкцию **CREATE DATABASE**. Для получения дополнительных сведений см. статью [CREATE DATABASE (база данных SQL)][]. Команда, приведенная ниже, создает новую базу данных с именем **myTestDB** и указывает, что это выпуск базы данных Standard S0 с максимальным размером по умолчанию, равным 250 ГБ.

        CREATE DATABASE myTestDB
        (EDITION='Standard',
         SERVICE_OBJECTIVE='S0');

Нажмите кнопку **Выполнить** для выполнения запроса.

-   Используйте инструкцию **ALTER DATABASE**, чтобы изменить существующую базу данных, если, например, вы хотите изменить имя или выпуск базы данных. Дополнительные сведения см. в разделе [ALTER DATABASE (база данных SQL)][]. Команда, приведенная ниже, изменяет базу данных, которую вы создали на предыдущем шаге, чтобы изменить выпуск на Standard S1.

        ALTER DATABASE myTestDB
        MODIFY
        (SERVICE_OBJECTIVE='S1');

-   Используйте команду **DROP DATABASE**, чтобы удалить существующую базу данных. Дополнительные сведения см. в разделе [DROP DATABASE (база данных SQL)][]. Приведенная ниже инструкция удаляет базу данных **myTestDB**, но не удаляйте ее сейчас, потому что эта база будет использоваться для создания учетных записей на следующем шаге.

        DROP DATABASE myTestBase;

-   В базе данных master есть представление **sys.databases**, которое вы можете использовать для просмотра информации обо всех базах данных. Для просмотра всех существующих баз данных выполните следующую команду:

        SELECT * FROM sys.databases;

-   В базе данных SQL инструкция **USE** не применяется для переключения между базами данных. Вместо этого нужно установить соединение непосредственно с целевой базой данных.

>[AZURE.NOTE] Многие инструкции Transact-SQL, позволяющие создавать и изменять базы данных, должны выполняться в своем собственном пакете и не могут быть сгруппированы с другими инструкциями Transact-SQL. Дополнительные сведения см. в описании конкретной инструкции по приведенным ниже ссылкам.

<h2><a id="Step4" name="Step4"> </a>Шаг 4. Создание учетных записей и управление ими</h2>

База данных **master** отслеживает имена входа и то, какие из них имеют разрешение на создание баз данных или других имен входа. Управление именами входа выполняется посредством подключения к базе данных **master** с именем входа уровня сервера, которое вы создали, когда настроили свой сервер. Вы можете использовать инструкции **CREATE LOGIN**, **ALTER LOGIN** или **DROP LOGIN**, чтобы выполнять запросы к базе данных master, которая будет управлять именами входа по всему серверу. Дополнительные сведения см. в разделе [Управление базами данных и учетными записями в базе данных SQL][] 


-   Используйте инструкцию **CREATE LOGIN** для создания имени входа на уровне сервера. Дополнительные сведения см. в разделе [CREATE LOGIN (база данных SQL)][]. Инструкция, приведенная ниже, создает новое имя входа под названием **login1**. Замените **password1** на пароль, который вы выберете сами.

        CREATE LOGIN login1 WITH password='password1';

-   Используйте инструкцию **CREATE USER** для предоставления разрешений уровня базы данных. Все имена входа должны быть созданы в базе данных **master**, но, чтобы с помощью имени входа можно было подключиться к другой базе данных, вам потребуется предоставить ему разрешения на уровне базы данных с помощью инструкции **CREATE USER** для этой базы данных. Дополнительные сведения см. в разделе [CREATE USER (база данных SQL)][]. 

-   Чтобы предоставить login1 разрешения доступа к базе данных под названием **myTestDB**, выполните следующие шаги.

 1.  Для обновления показа вновь созданной базы данных обозревателем объектов **myTestDB** щелкните правой кнопкой мыши имя сервера в обозревателе объектов, а затем выберите пункт **Обновить**.  

     Если подключение закрыто, можно подключиться повторно, выбрав **Подключить обозреватель объектов** в меню "Файл". Повторите инструкции, приведенные в разделе [Шаг 2. Подключение к базе данных SQL][], чтобы подключиться к базе данных.

 2. Щелкните правой кнопкой мыши базу данных **myTestDB** и выберите пункт **Создать запрос**.

    3.  Выполните следующую инструкцию в базе данных myTestDB, чтобы создать пользователя базы данных с именем **login1User**, которое соответствует имени входа уровня сервера **login1**.

            CREATE USER login1User FROM LOGIN login1;

-   Воспользуйтесь хранимой процедурой **sp_addrolemember**, чтобы предоставить учетной записи пользователя соответствующий уровень полномочий в базе данных. Для получения более подробной информации см. статью [sp_addrolemember (Transact-SQL)][]. Приведенная ниже инструкция дает **login1User** разрешения только на чтение из базы данных, добавляя **login1User** к роли **db_datareader**.

        exec sp_addrolemember 'db_datareader', 'login1User';    

-   Используйте инструкцию **ALTER LOGIN**, чтобы изменить существующее имя входа, если, например, вы хотите изменить пароль для него. Для получения дополнительных сведений см. статью [ALTER LOGIN (база данных SQL)][]. Инструкция **ALTER LOGIN** должна выполняться в базе данных **master**. Переключитесь в окно запроса, подключенного к этой базе данных. 

    Приведенная ниже инструкция изменяет имя входа **login1**, сбрасывая пароль. Замените **newPassword** на свой собственный пароль, а старый пароль **oldPassword** замените на текущий пароль для данного имени входа.

        ALTER LOGIN login1
        WITH PASSWORD = 'newPassword'
        OLD_PASSWORD = 'oldPassword';

-   Воспользуйтесь инструкцией **DROP LOGIN**, чтобы удалить существующее имя входа. Удаление имени входа на уровне сервера также удаляет и связанные с ним учетные записи пользователей базы данных. Для получения дополнительной информации см. статью [DROP DATABASE (база данных SQL)][]. Инструкция **DROP LOGIN** должна выполняться для базы данных **master**. Следующая инструкция удаляет имя входа **login1**.

        DROP LOGIN login1;

-   В базе данных master предусмотрено представление **sys.sql_logins**, которое вы можете использовать для просмотра имен входа. Для просмотра всех существующих имен выполните следующую инструкцию:

        SELECT * FROM sys.sql_logins;

<h2><a id="Step5" name="Step5"> </a>Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления</h2>

База данных SQL поддерживает несколько динамических административных представлений, которые вы можете использовать для мониторинга отдельной базы данных. Ниже приведено несколько примеров типов данных мониторинга, которые можно получить с помощью этих представлений. Для получения более подробных сведений и дополнительных примеров использования см. статью [Мониторинг базы данных SQL с использованием динамических административных представлений][].

-   Запрос динамических административных представлений требует наличия разрешений **VIEW DATABASE STATE**. Чтобы предоставить разрешение **VIEW DATABASE STATE** для определенного пользователя базы данных, подключитесь к базе данных, которой вы хотите управлять, введя основное имя входа уровня сервера, и выполните следующую инструкцию в базе данных:

        GRANT VIEW DATABASE STATE TO login1User;

-   Рассчитайте размер базы данных с помощью представления **sys.dm_db_partition_stats**. Представление **sys.dm_db_partition_stats** возвращает информацию о странице и количестве строк для каждого раздела в базе данных, которые вы можете использовать для расчета размера базы данных. Следующий запрос возвращает размер вашей базы данных в мегабайтах:

        SELECT SUM(reserved_page_count)*8.0/1024
        FROM sys.dm_db_partition_stats;   

-   Используйте представления **sys.dm_exec_connections** и **sys.dm_exec_sessions** для получения информации о текущих подключениях пользователей и внутренних задачах, связанных с базой данных. Следующий запрос возвращает сведения о текущем соединении:

        SELECT
            e.connection_id,
            s.session_id,
            s.login_name,
            s.last_request_end_time,
            s.cpu_time
        FROM
            sys.dm_exec_sessions s
            INNER JOIN sys.dm_exec_connections e
              ON s.session_id = e.session_id;

-   Используйте представление **sys.dm_exec_query_stats** для получения общей статистики производительности для кэшированных планов запросов. Следующий запрос возвращает сведения о пяти первых запросах в списке, упорядоченном по среднему затраченному ЦП времени.

        SELECT TOP 5 query_stats.query_hash AS "Query Hash",
            SUM(query_stats.total_worker_time), SUM(query_stats.execution_count) AS "Avg CPU Time",
            MIN(query_stats.statement_text) AS "Statement Text"
        FROM
            (SELECT QS.*,
            SUBSTRING(ST.text, (QS.statement_start_offset/2) + 1,
            ((CASE statement_end_offset
                WHEN -1 THEN DATALENGTH(ST.text)
                ELSE QS.statement_end_offset END
                    - QS.statement_start_offset)/2) + 1) AS statement_text
             FROM sys.dm_exec_query_stats AS QS
             CROSS APPLY sys.dm_exec_sql_text(QS.sql_handle) as ST) as query_stats
        GROUP BY query_stats.query_hash
        ORDER BY 2 DESC;

<h2>Дополнительные ресурсы</h2>

* [Введение в базы данных SQL][]   
* [Управление базами данных и учетными записями в базе данных SQL][]   
* [Мониторинг базы данных SQL с использованием динамических административных представлений][]   
* [Справочник по Transact-SQL (база данных SQL)][]

  [Использование базы данных SQL Azure]: http://www.windowsazure.com/develop/net/how-to-guides/sql-azure/
  [Шаг 1. Получение среды SQL Server 2014 Management Studio]: #Step1
  [Шаг 2. Подключение к базе данных SQL]: #Step2
  [Шаг 3. Создание баз данных и управление ими.]: #Step3
  [Шаг 4. Создание имен входа и управление ими.]: #Step4
  [Шаг 5. Мониторинг базы данных SQL с помощью динамических представлений управления.]: #Step5
  [Microsoft SQL Server 2014 Express]: http://www.microsoft.com/download/details.aspx?id=42299
  [Накопительный пакет обновления 5 для SQL Server 2014]: http://support2.microsoft.com/kb/3011055
  [Установщик SSMS - выбор типа установки]: /media/installer_installation_type.png
  [Установщик SSMS - выбор компонентов]: /media/installer_feature_selection.png
  [Установщик SSMS - завершение установки]: /media/installer_completed.png
  [портал управления Azure]: http://manage.windowsazure.com/
  [Получение имени сервера баз данных SQL из портала управления]: /media/portal_get_database_name.png
  [Подключение к SSMS]: /media/ssms_connect.png
  [Подключение к SSMS - свойства]: /media/ssms_connect_properties.png
  [Справочник по Transact-SQL (база данных SQL)]: http://msdn.microsoft.com/library/bb510741(v=sql.120).aspx
  [CREATE DATABASE (база данных SQL)]: https://msdn.microsoft.com/library/dn268335.aspx
  [ALTER DATABASE (база данных SQL)]: https://msdn.microsoft.com/library/ms174269.aspx
  [DROP DATABASE (база данных SQL)]: https://msdn.microsoft.com/library/ms178613.aspx
  [Управление базами данных и учетными записями в базе данных SQL]: http://msdn.microsoft.com/library/windowsazure/ee336235.aspx
  [CREATE LOGIN (база данных SQL)]: https://msdn.microsoft.com/library/ms189751.aspx
  [CREATE USER (база данных SQL)]: https://msdn.microsoft.com/library/ms173463.aspx
  [sp_addrolemember (Transact-SQL)]: http://msdn.microsoft.com/library/ms187750.aspx
  [ALTER LOGIN (база данных SQL)]: https://msdn.microsoft.com/library/ms189828.aspx
  [Мониторинг базы данных SQL с использованием динамических административных представлений]: http://msdn.microsoft.com/library/windowsazure/ff394114.aspx
  [Введение в базы данных SQL]: http://azure.microsoft.com/services/sql-database/
 

<!--HONumber=47-->
