<properties writer="josephd" editor="tysonn" manager="dongill" />

#Балансировка нагрузки виртуальных машин#

Все виртуальные машины, созданные в Windows Azure, могут автоматически взаимодействовать с другими виртуальными машинами в той же облачной службе или виртуальной сети, используя канал частной сети. Все другие входящие связи, таких как трафик от узлов Интернета или виртуальные машины в других облачных службах или виртуальных сетях, требуют конечной точки.

Конечные точки могут использоваться для различных целей. Конечные точки на виртуальной машине, создаваемой в портале управления Windows Azure, по умолчанию используются и настраиваются для протокола удаленного рабочего стола (RDP) и трафика удаленного сеанса Windows PowerShell. Эти конечные точки позволяют удаленно управлять виртуальной машиной через Интернет. 

Другое применение конечных точек — конфигурация средства балансировки нагрузки Windows Azure для распределения определенного типа трафика между несколькими виртуальными машинами или службами. Например, можно распределить нагрузку от трафика веб-запросов на несколько веб-серверов или веб-ролей.

Каждой конечной точке, заданной для виртуальной машины, назначается общий или частный порт для связи, TCP или UDP. Узлы Интернета отправляют свой входящий трафик на открытый IP-адрес облачной службы и открытый порт. Виртуальные машины и службы в облачной службы прослушивают свой частный IP-адрес и частный порт. Подсистема балансировки нагрузки сопоставляет открытый IP-адрес и номер порта для входящего трафика с закрытым IP-адресом и номером порта виртуальной машины и наоборот для ответного трафика из виртуальной машины.

При настройке балансировки нагрузки трафика среди нескольких виртуальных машин или служб Windows Azure предоставляет случайное распределение входящего трафика.

Для облачной службы, которая содержит экземпляры веб-ролей или рабочих ролей, в определении службы можно определить открытую конечную точку. Для облачной службы, содержащей виртуальные машины, можно добавить конечную точку для виртуальной машины при ее создании или позже. 

На следующем рисунке показана конечная точка с балансировкой нагрузки для стандартного (незашифрованного) веб-трафика, являющаяся общей для трех виртуальных машин для открытых и закрытых TCP-портов 80. Эти три виртуальные машины находятся в наборе балансировки нагрузки.

![loadbalancing](./media/load-balancing-vms/LoadBalancing.png)

Когда интернет-клиенты отправляют запросы веб-страниц на публичный IP-адрес облачной службы и TCP-порт 80, подсистема балансировки нагрузки выполняет случайную балансировку этих запросов между тремя виртуальными машинами в наборе балансировки нагрузки.

Чтобы создать набор балансировки нагрузки из виртуальных машин Windows Azure, выполните следующие действия:


- [Шаг 1. Создайте первую виртуальную машину] []
- [Шаг 2. Создайте дополнительные виртуальные машины в одной и той же облачной службе] []
- [Шаг 3. Создайте набор балансировки нагрузки с первой виртуальной машиной] []
- [Шаг 4. Добавьте виртуальные машины в набор балансировки нагрузки] []

## <a id="firstmachine"> </a>Шаг 1. Создайте первую виртуальную машину ##

Войдите на [портал управления Windows Azure](http://manage.windowsazure.com), если вы еще этого не сделали. Можно создать первую виртуальную машину из коллекции или методом быстрого создания. 

- **Из коллекции** - Метод **из коллекции** позволяет создавать конечные точки при создании виртуальной машины. Он позволяет указать имя для облачной службы, которая создается при создании виртуальной машины. Дополнительные инструкции см. в разделе [Создание виртуальной машины с ОС Linux] или [Создание виртуальной машины под управлением Windows Server].

- **Быстрое создание** - Создание виртуальной машины путем выбора изображения из коллекции изображений и предоставления основной информации. При использовании этого метода необходимо добавить конечную точку после создания виртуальной машины. Этот метод также создает облачную службу, используя имя по умолчанию. Дополнительные сведения см. в разделе [Быстрое создание виртуальной машины] []. 

**Примечание**. После создания виртуальной машины путем быстрого создания на странице облачных служб в портале управления отображается имя новой облачной службы, а также другие сведения о ней.

## <a id="addmachines"> </a>Шаг 2. Создайте дополнительные виртуальные машины в одной и той же облачной службе ##

Создайте дополнительные виртуальные машины в одной и той же облачной службе как первую виртуальную машину с помощью метода "из коллекции".

## <a id="loadbalance"> </a>Шаг 3. Создайте набор балансировки нагрузки с первой виртуальной машиной ##

1. В портале управления Windows Azure нажмите **Виртуальные машины** и выберите имя первой виртуальной машины.
	
2. Нажмите **Конечные точки**, а затем выберите **Добавить**.

3. На странице виртуальной машины нажмите стрелку вправо в разделе "Добавить конечную точку".
	
4. В разделе "Укажите подробные сведения" на странице конечной точки:

	- В поле **Имя** введите имя конечной точки или выберите из списка предварительно определенных конечных точек для распространенных протоколов.
	- В поле **Протокол** выберите при необходимости протокол, необходимый для этого типа конечной точки, TCP или UDP.
	- В полях **Открытый порт** и **Закрытый порт** введите при необходимости номера портов, которые требуется использовать. На виртуальной машине можно использовать частный порт и правила брандмауэра, чтобы перенаправить трафик способом, который подходит для вашего приложения. Частный порт может быть таким же, как общий порт. Например, для конечной точки для веб-трафика (HTTP) для общего и частного порта можно назначить порт 80.

5. Выберите **Создать набор балансировки нагрузки**и нажмите стрелку вправо. 

6. На странице "Настроить набор балансировки нагрузки" введите имя для набора балансировки нагрузки, а затем присвойте значения для пробного поведения подсистемы балансировки нагрузки Windows Azure. Подсистема балансировки нагрузки использует пробы для определения, доступны ли виртуальные машины в наборе балансировки нагрузки для приема входящего трафика.

7. Чтобы создать конечную точку балансировки нагрузки, поставьте галочку. Вы увидите **Да** в столбце **Имя набора балансировки нагрузки** на странице **Конечные точки** виртуальной машины.


## <a id="addtoset"> </a>Шаг 4. Добавьте виртуальные машины в набор балансировки нагрузки ##
После создания набора балансировки нагрузки добавьте в него другие виртуальные машины. Для каждой виртуальной машины в одной и той же облачной службе:

1. На портале управления нажмите **Виртуальные машины** и выберите имя новой виртуальной машины, а затем нажмите **Конечные точки** и выберите **Добавить**.
	
2. На странице виртуальной машины в разделе "Добавить конечную точку" нажмите **Добавить конечную точку в существующий набор балансировки нагрузки**, выберите имя набора балансировки нагрузки и нажмите стрелку вправо.
	
3. На странице конечной точки в разделе "Укажите подробные сведения" введите имя конечной точки и щелкните флажок.

[Шаг 1. Создайте первую виртуальную машину]: #firstmachine
[Шаг 2. Создайте дополнительные виртуальные машины в одной и той же облачной службе]: #addmachines
[Шаг 3. Создайте набор балансировки нагрузки с первой виртуальной машиной]: #loadbalance
[Шаг 4. Добавьте виртуальные машины в набор балансировки нагрузки]: #addtoset


<!-- LINKS -->

[Создание виртуальной машины с ОС Linux]: ../virtual-machines-linux-tutorial

[Создание виртуальной машины под управлением Windows Server]: ../virtual-machines-windows-tutorial

[Быстрое создание виртуальной машины]: ../virtual-machines-quick-create

[Подключение к виртуальным машинам в облачной службе]: ../virtual-machines-connect-cloud-service

[Начало работы с Windows Azure PowerShell]:http://msdn.microsoft.com/ru-ru/library/jj156055.aspx

[Обзор виртуальной сети Windows Azure]: http://go.microsoft.com/fwlink/p/?LinkID=294063

