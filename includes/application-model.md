# <a name="compute"></a>Среда выполнения приложений
Платформа Azure позволяет развертывать и отслеживать работу кода приложения в центре обработки данных корпорации Майкрософт. При создании приложения и его запуске в службе Azure код и настройки вместе называются размещенной службой Azure. Размещенными службами можно легко управлять, увеличивать и уменьшать масштаб, перенастраивать их и обновлять с использованием новых версий кода приложения. В этой статье описана модель приложения размещенной службы Azure.<a id="compare" name="compare"></a>

## <a name="table-of-contentsa-idgoback-namegobacka"></a>Оглавление<a id="_GoBack" name="_GoBack"></a>
* [Преимущества модели приложения Azure][Azure Application Model Benefits]
* [Основные понятия размещенной службы][Hosted Service Core Concepts]
* [Вопросы проектирования размещенной службы][Hosted Service Design Considerations]
* [Разработка приложения для масштабирования][Designing your Application for Scale]
* [Определение и настройка размещенной службы][Hosted Service Definition and Configuration]
* [Файл определения службы][The Service Definition File]
* [Файл конфигурации службы][The Service Configuration File]
* [Создание и развертывание размещенной службы][Creating and Deploying a Hosted Service]
* [Справочные материалы][References]

## <a id="benefits"> </a>Преимущества модели приложения Azure
При развертывании приложения в качестве размещенной службы Azure создает одну или несколько виртуальных машин (ВМ), содержащих код приложения, и загружает виртуальные машины на физических компьютерах, находящихся в одном из центров обработки данных Azure. После получении в центре обработки данных запросов от клиента к размещенной службе средство балансировки нагрузки равномерно распределяет эти запросы между виртуальными машинами. Размещение приложения в службе Azure дает три ключевых преимущества.

* **Высокая доступность.** Высокая доступность означает, что Azure гарантирует максимальную эффективность выполнения приложения и реагирование на запросы клиентов. Если приложение завершает работу (например, из-за необработанного исключения), служба Azure обнаружит такую ситуацию и автоматически перезапустит приложение. Если на компьютере, на котором выполняется приложение, происходит сбой оборудования, Azure также обнаруживает это и автоматически создает новую виртуальную машину на другой рабочей физической машине и выполняет ваш код уже с этой машины. ПРИМЕЧАНИЕ. Для того чтобы обеспечить соглашение об обслуживании корпорации Майкрософт на уровне 99,95 %, необходимо иметь по крайней мере две виртуальных машины, на которых запущен код приложения. Это позволит одной виртуальной машине обрабатывать запросы клиентов, пока служба Azure перемещает код с неисправной виртуальной машины на новую работающую ВМ.
* **Масштабируемость.** С помощью службы Azure вы можете легко и динамически изменять количество виртуальных машин, на которых запущен код приложения, для обработки фактических рабочих нагрузок приложения. Это позволяет настраивать приложения с учетом рабочих нагрузок, размещаемых клиентами, а также оплачивать только фактически используемые ВМ. Если вы хотите изменить количество виртуальных машин, служба Azure реагирует в течение нескольких минут, что позволяет динамически изменять количество запущенных виртуальных машин так часто, как вам нужно.
* **Управляемость.** Так как Azure — это платформа как услуга (PaaS), она управляет инфраструктурой (самим оборудованием,энергопотреблением и сетевой активностью), необходимой для поддержания работы этих машин. Azure также управляет платформой, поддерживая операционную систему в актуальном состоянии, устанавливая все необходимые пакеты исправлений и обновлений для системы безопасности, а также обновляет компоненты, например .NET Framework и Internet Information Server. Так как все виртуальные машины работают под управлением Windows Server 2008, служба Azure предоставляет такие дополнительные функции, как контроль диагностики, поддержка удаленного рабочего стола, настройка брандмауэров и хранилища сертификатов. Все эти функции не требуют дополнительной оплаты. Когда вы запускаете приложение в Azure, включается лицензия операционной системы (ОС) Windows Server 2008. Так как все виртуальные машины работают под управлением Windows Server 2008, любой код, работающий на Windows Server 2008, будет правильно выполняться в службе Azure.

## <a id="concepts"> </a>Основные понятия размещенной службы
Приложение, развернутое в качестве размещенной службы в Azure, выполняется как одна или несколько *ролей*. *Роль* — это, по сути, просто файлы и конфигурация приложения. Для приложения можно определить одну или несколько ролей, каждая из которых имеет свой собственный набор файлов приложения и настроек. Для каждой роли в приложении можно указать число запускаемых виртуальных машин или *экземпляров роли*. На следующем рисунке показаны два простых примера моделирования размещенной службы с использованием ролей и экземпляров ролей.

##### <a name="figure-1-a-single-role-with-three-instances-vms-running-in-an-azure-data-center"></a>Рисунок 1: одна роль с тремя экземплярами (ВМ), выполняемая в центре обработки данных Azure
![изображение][0]

##### <a name="figure-2-two-roles-each-with-two-instances-vms-running-in-an-azure-data-center"></a>Рисунок 2: две роли с двумя экземплярами (ВМ) на каждую, выполняемые в центре обработки данных Azure
![изображение][1]

Экземпляры ролей обычно обрабатывают интернет-запросы клиентов, попадающие в центр обработки данных через так называемую *входную конечную точку*. Одна роль может иметь 0 или более входных конечных точек. Для каждой конечной точки указывается протокол (HTTP, HTTPS или TCP) и номер порта. Часто для роли настраивается две конечные точки ввода: HTTP, прослушивающая порт 80 и HTTPS, прослушивающая порт 443. На следующем рисунке приведен пример двух различных ролей с различными входными конечными точками, передающими в эти роли запросы клиентов.

![изображение][2]

После создания размещенной службы в Azure для нее назначается общедоступный IP-адрес, который клиенты могут использовать для доступа к службе. После создания размещенной службы нужно выбрать префикс URL-адреса, который сопоставляется с этим IP-адресом. Этот префикс должен быть уникальным, так как URL-адрес *префикс*.cloudapp.net резервируется для того, чтобы другие лица не могли его использовать. Клиенты обмениваются данными с экземплярами роли с помощью этого URL-адреса. Как правило, URL-адрес Azure *префикс*.cloudapp.net не распространяется и не публикуется. Вместо этого у регистратора DNS приобретается DNS-имя на выбор и настраивается для перенаправления запросов клиента на URL-адрес Azure. См. дополнительные сведения о [настройке имени личного домена в Azure][Configuring a Custom Domain Name in Azure].

## <a id="considerations"> </a>Вопросы проектирования размещенной службы
При разработке приложений для работы в облачной среде следует учитывать несколько факторов, в частности время задержки, высокую доступность и масштабируемость.

При выполнении размещенной службы в Azure важно принять правильное решение о том, где лучше размещать код приложения. Обычно приложения развертываются в центрах обработки данных, находящихся ближе всего к клиентам. Это позволяет уменьшить время задержки и обеспечить максимальную производительность.
Тем не менее, при наличии вопросов, связанных с юрисдикцией или правовыми аспектами, можно также выбрать центр обработки данных, находящийся ближе всего к вашей компании или к данным. Код приложения можно разместить в шести центрах обработки данных по всему миру. В следующей таблице показаны доступные местоположения.

<table border="2" cellspacing="0" cellpadding="5" style="border: 2px solid #000000;">

<tbody>

<tr>

<td style="width: 100px;">
**Страна или регион**

</td>

<td style="width: 200px;">
**Субрегионы**

</td>
</tr>

<tr>

<td>
США

</td>

<td>
Южно-центральный и Северо-центральный регионы

</td>
</tr>

<tr>

<td>
Европа

</td>

<td>
Северный и Западный регионы

</td>
</tr>

<tr>

<td>
Азия

</td>

<td>
Юго-восточный и Восточный регионы

</td>
</tr>
</tbody>
</table>
При создании размещенной службы следует выбрать субрегион, в котором будет выполняться код.

Для достижения высокой доступности и масштабируемости очень важно, чтобы данные вашего приложения хранились в центральном репозитории, доступном для нескольких экземпляров ролей. Для этого Azure предлагает несколько различных вариантов хранения, включая BLOB-объекты, таблицы и базы данных SQL. См. дополнительные сведения о [предложениях по хранению данных для платформы Azure][Data Storage Offerings in Azure]. На следующем рисунке показано, как система балансировки нагрузки внутри центра обработки данных Azure распределяет клиентские запросы на другие экземпляры ролей, каждый из которых имеет доступ к одному и тому же хранилищу данных.

![изображение][3]

Как правило, код приложения и данные размещаются в одном центре обработки данных, так как это уменьшает время задержки (повышает производительность) при обращении кода приложения к данным. Кроме того, при перемещении данных в пределах одного центра данных плата за полосу пропускания не взимается.

## <a id="scale"> </a>Разработка приложения для масштабирования
В некоторых случаях вам может потребоваться разместить в Azure одно приложение (например, простой веб-сайт). Но часто приложение может состоять из нескольких ролей, работающих совместно друг с другом. Например, на рисунке ниже представлены два экземпляра роли веб-сайта, три экземпляра роли обработки заказов и один экземпляр роли генератора отчетов. Все эти роли взаимодействуют между собой, и для них можно упаковать и развернуть единый код под Azure.

![изображение][4]

Главной причиной для разделения приложения на различные роли, каждая из которых работает на собственном наборе экземпляров ролей (т. е. ВМ), является возможность масштабирования ролей независимо друг от друга. Например, во время праздников может возрасти количество заказчиков, приобретающих продукты вашей компании, поэтому может потребоваться увеличить число экземпляров ролей для веб-сайта, а также количество экземпляров ролей для системы обработки заказов. После завершения праздников может возрасти количество возвратов продукции, поэтому вам по-прежнему может потребоваться большое количество экземпляров веб-сайта, но число экземпляров для системы обработки заказов нужно будет уменьшить. В другие периоды года требуется лишь несколько экземпляров веб-сайта и системы обработки заказов. На протяжении любого из этих периодов вам может понадобиться только один экземпляр генератора отчетов. Гибкое развертывание на основе ролей в Azure позволяет легко адаптировать приложение к потребностям бизнеса.

Обычно роли экземпляров в размещенной службе взаимодействуют друг с другом. Например, роль веб-сайта принимает заказ клиента, а затем функция обработки заказа передается экземплярам системы обработки заказов. Лучший способ передачи заданий от одного набора экземпляров ролей к другому — это использование одной из технологий организации очереди, реализованной в Azure (служба очередей или очереди Service Bus). Использование очереди — это критически важная часть. Очередь позволяет размещенной службе масштабировать роли независимо друг от друга, что дает возможность балансировать нагрузки и затраты. Если со временем количество сообщений в очереди возрастает, можно увеличить количество экземпляров роли обработки заказов. Если количество сообщений в очереди со временем уменьшается, можно уменьшить количество экземпляров роли обработки заказов. Так, вы платите только за те экземпляры, которые нужны для обработки фактических рабочих нагрузок.

Использование очереди также повышает надежность. При уменьшении числа экземпляров роли обработки заказов Azure решает, какие экземпляры нужно остановить. Может быть принято решение остановить экземпляр, находящийся в процессе обработки сообщения из очереди. Но так как обработка сообщения не завершится успешно, сообщение снова становится видимым для другого экземпляра роли обработки заказов, который принимает сообщение и обрабатывает его. Сообщения в очереди видны, поэтому в конце концов они обязательно будут обработаны. Очередь также выступает как система балансировки нагрузки, эффективно распределяя сообщения между всеми экземплярами ролей, запрашивающими сообщения из очереди.

Для экземпляров ролей веб-сайта можно отслеживать поступающий трафик и принимать решение об увеличении или уменьшении их количества. Очередь позволяет масштабировать число экземпляров роли веб-сайта независимо от экземпляров роли обработки заказов. Это очень мощная функция, которая обеспечивает большую гибкость. Конечно, если приложение содержит дополнительные роли, можно добавить дополнительные очереди для связи между ними, что даст аналогичные преимущества с точки зрения масштабируемости и экономичности.

## <a id="defandcfg"> </a>Определение и настройка размещенной службы
Для развертывания размещенной службы в Azure вам необходимо также иметь файл определения службы и файл настройки службы. Оба эти файла являются файлами XML и позволяют декларативно указывать параметры развертывания для вашей размещенной службы. Файл определения службы описывает все роли, из которых складывается размещенная служба, а также способ их взаимодействия. Файл настройки службы описывает число экземпляров для каждой роли и параметры, используемые для настройки каждого экземпляра роли.

## <a id="def"> </a>Файл определения службы
Как упоминалось ранее, файл определения службы (CSDEF) является XML-файлом, содержащим описание различных ролей, из которых состоит приложение. Полную схему XML-файла см. здесь: [http://msdn.microsoft.com/library/windowsazure/ee758711.aspx][].
Файл CSDEF содержит элемент WebRole или WorkerRole для каждой роли в приложении. Развертывание ролей в качестве веб-ролей (с помощью элемента WebRole) означает, что код будет выполняться в экземпляре роли, содержащем Windows Server 2008 и Internet Information Server (IIS).
Развертывание роли в качестве рабочей роли (с помощью элемента WorkerRole) означает, что экземпляр роли будет использовать Windows Server 2008 на нем (без установки IIS).

Конечно, вы можете создать и развернуть рабочую роль, которая использует другой механизм для прослушивания входящих веб-запросов (например, код может создать и использовать .NET HttpListener). Так как экземпляры ролей работают на платформе Windows Server 2008, код может выполнять любые стандартные операции, доступные для приложений, запущенных на платформе Windows Server.
2008.

Для каждой роли вам следует указать желаемый размер виртуальных машин, используемых экземплярами такой роли. В следующей таблице показаны доступные на сегодня размеры ВМ и их характеристики.

<table border="2" cellspacing="0" cellpadding="5" style="border: 2px solid #000000;">

<tbody>

<tr align="left" valign="top">

<td>
**Размер виртуальной машины**

</td>

<td>
**ЦП**

</td>

<td>
**ОЗУ**

</td>

<td>
**Диск**

</td>

<td>
**Пиковая производительность сетевых операций ввода-вывода**

</td>
</tr>

<tr align="left" valign="top">

<td>
**Очень малый**

</td>

<td>
1 x 1,0 ГГц

</td>

<td>
768 MB

</td>

<td>
20GB

</td>

<td>
\~5 Мбит/с

</td>
</tr>

<tr align="left" valign="top">

<td>
**Малый**

</td>

<td>
1 x 1,6 ГГц

</td>

<td>
1,75 GB

</td>

<td>
225GB

</td>

<td>
\~100 Мбит/с

</td>
</tr>

<tr align="left" valign="top">

<td>
**Средний**

</td>

<td>
2 x 1,6 ГГц

</td>

<td>
3,5 ГБ

</td>

<td>
490GB

</td>

<td>
\~200 Мбит/с

</td>
</tr>

<tr align="left" valign="top">

<td>
**Крупный**

</td>

<td>
4 x 1,6 ГГц

</td>

<td>
7 ГБ

</td>

<td>
1 ТБ

</td>

<td>
\~400 Мбит/с

</td>
</tr>

<tr align="left" valign="top">

<td>
**Очень крупный**

</td>

<td>
8 x 1,6 ГГц

</td>

<td>
14 GB

</td>

<td>
2 ТБ

</td>

<td>
\~800 Мбит/с

</td>
</tr>
</tbody>
</table>
Вам начисляется оплата за каждый час использования виртуальной машины в качестве экземпляра роли, а также за все данные, которые экземпляры роли отправляют за пределы центра обработки данных. Не взимается оплата за данные, поступающие в центр обработки данных. Дополнительные сведения см. на странице [цен на Azure][цен на Azure]. В общем случае вместо нескольких крупных экземпляров рекомендуется использовать много мелких с небольшими ролями. Благодаря этому ваше приложение будет более устойчивым к сбоям. В итоге чем меньше экземпляров ролей вы используете, тем более пагубными будут последствия после сбоя одного из них. Кроме того, как упоминалось ранее, вам нужно развернуть по крайней мере два экземпляра для каждой роли, чтобы обеспечить соглашение об уровне обслуживания на 99,95 %, предлагаемое корпорацией Майкрософт.

В файле определений службы (CSDEF) указываются различные атрибуты для каждой из ролей, используемых в приложении. Вот несколько элементов, которые могут быть полезны для вас.

* **Сертификаты.** Сертификаты используются для шифрования данных или если используемая веб-служба поддерживает SSL. Все сертификаты необходимо загрузить в Azure. См. дополнительные сведения об [управлении сертификатами в Azure][Managing Certificates in Azure]. Этот параметр XML устанавливает ранее загруженные сертификаты в хранилище сертификатов экземпляра роли, чтобы код приложения мог использовать такие сертификаты.
* **Имена параметров конфигурации.** Для значений, которые приложения должны считывать во время работы экземпляра роли. Фактическое значение параметра конфигурации задается в файле конфигурации службы (CSCFG), который можно обновлять в любое время без необходимости повторного развертывания кода. По сути можно составить код приложения таким образом, чтобы он определял изменения значений конфигурации без возникновения простоев.
* **Входные конечные точки.** Здесь вы можете задать любые конечные точки HTTP, HTTPS или TCP (с портами), которым нужно предоставить доступ к внешнему миру через ваш URL-адрес *префикс*.cloudapp.net. Когда Azure развертывает вашу роль, она автоматически настроит брандмауэр на экземпляр роли.
* **Внутренние конечные точки.** Здесь можно указать любые конечные точки HTTP или TCP, которые нужны для других экземпляров роли, развертываемых как часть приложения. Внутренние конечные точки позволяют всем экземплярам роли в приложении обмениваться данными друг с другом, при этом они не доступны для экземпляров роли, находящихся за пределами вашего приложения.
* **Модули импорта.** Позволяют дополнительно устанавливать полезные компоненты на экземпляры роли. Существуют компоненты для диагностического мониторинга, удаленного рабочего стола и Azure Connect (что позволяет экземпляру роли получать доступ к локальным ресурсам через безопасный канал).
* **Локальное хранилище.** Выделяет подкаталог на экземпляре роли, используемый вашим приложением. См. дополнительные сведения о [предложениях по хранению данных для платформы Azure][Data Storage Offerings in Azure].
* **Задачи при запуске.** Задачи при запуске позволяют устанавливать необходимые компоненты на экземпляре роли при его загрузке. При необходимости задачи могут запускаться с расширенными правами администратора.

## <a id="cfg"> </a>Файл настройки службы
Файл настройки службы (CSCFG) является XML-файлом, описывающим параметры, которые можно изменить без повторного развертывания приложения. Полную схему XML-файла см. здесь: [http://msdn.microsoft.com/library/windowsazure/ee758710.aspx][http://msdn.microsoft.com/library/windowsazure/ee758710.aspx].
Файл CSCFG содержит элемент "Роль" для каждой роли в приложении. Ниже приведены некоторые элементы, которые можно указать в файле CSCFG:

* **Версия ОС.** Этот атрибут позволяет выбрать версию операционной системы (ОС), которую нужно использовать для всех экземпляров ролей, на которых выполняется код приложения. Эта операционная система называется *гостевой ОС*. В каждую новую версию включаются последние исправления безопасности и обновления, доступные на момент выпуска такой ОС. Если для атрибута osVersion установить значение "\*", Azure будет автоматически обновлять гостевую ОС для каждого из экземпляров роли по мере появления новых версий таких ОС. При этом можно отказаться от автоматического обновления, выбрав конкретную версию гостевой ОС. Например, если для атрибута osVersion установить значение WA-GUEST-OS-2.8\_201109-01, все экземпляры роли получат компоненты, описанные на следующей веб-странице: [http://msdn.microsoft.com/library/hh560567.aspx][http://msdn.microsoft.com/library/hh560567.aspx]. См. дополнительные сведения об [управлении обновлениями гостевых ОС Azure].
* **Экземпляры.** Значение этого элемента указывает на количество экземпляров роли, выполняющих код для определенной роли. Так как в Azure можно загрузить новый файл CSCFG (без повторного развертывания приложения), вы можете максимально просто изменить значение этого элемента и загрузить новый файл CSCFG для динамического увеличения или уменьшения количества экземпляров роли, выполняющих код приложения. Это позволяет легко масштабировать приложения в сторону увеличения или в сторону уменьшения для обеспечения требований, выдвигаемых фактическими рабочими нагрузками, а также для управления платежами, начисляемыми за выполнение экземпляров роли.
* **Значения параметров конфигурации.** Этот элемент определяет значения параметров (как определено в файле CSDEF). Роль может прочитать эти значения во время ее выполнения. Обычно значения этих параметров конфигурации используются для строки подключения к базе данных SQL или к хранилищу Azure, но их также можно использовать для любых требуемых целей.

## <a id="hostedservices"> </a>Создание и развертывание размещенной службы
Для создания размещенной службы нужно сначала перейти на [портал управления Azure] и подготовить размещенную службу, указав префикс DNS и центр данных, в котором будет выполняться код. Затем в своей среде разработки создайте файл определения службы (CSDEF), постройте код приложения и упакуйте (zip) все файлы в файл пакета службы (CSPKG). Также необходимо подготовить файл конфигурации службы (CSCFG). Чтобы развернуть роль, загрузите файлы CSCFG и CSPKG с помощью API управления службами Azure. После развертывания Azure предоставит экземпляры роли в центре обработки данных (на основе данных конфигурации), достанет код приложения из пакета, скопирует его в экземпляры роли и загрузит экземпляры. Теперь код запущен и работает.

На рисунке ниже показаны файлы CSPKG и CSCFG, созданные на компьютере разработчика. Файл CSPKG содержит файл CSDEF и код для двух ролей. После загрузки файлов CSPKG и CSCFG с помощью API управления службами Azure, Azure создает экземпляры роли в центре обработки данных. В этом примере в CSCFG-файле указано, что Azure нужно создать три экземпляра роли \#1 и два экземпляра роли \#2.

![изображение][5]

Чтобы узнать, как развертывать, обновлять и повторно настраивать роли, см. статью о [развертывании и обновлении приложений Azure][Deploying and Updating Azure Applications]<a id="Ref" name="Ref"></a>.

## <a id="references"> </a>Справочные материалы
* [Создание размещенной службы для Azure][Creating a Hosted Service for Azure]
* [Управление размещенными службами в Azure][Managing Hosted Services in Azure]
* [Перенос приложений в Azure][Migrating Applications to Azure]
* [Настройка приложения в Azure][Configuring an Azure Application]

<div style="width: 700px; border-top: solid; margin-top: 5px; padding-top: 5px; border-top-width: 1px;">

<p>Автор: Джеффри Рихтер (Wintellect)</p>

</div>

[Azure Application Model Benefits]: #benefits
[Hosted Service Core Concepts]: #concepts
[Hosted Service Design Considerations]: #considerations
[Designing your Application for Scale]: #scale
[Hosted Service Definition and Configuration]: #defandcfg
[The Service Definition File]: #def
[The Service Configuration File]: #cfg
[Creating and Deploying a Hosted Service]: #hostedservices
[References]: #references
[0]: ./media/application-model/application-model-3.jpg
[1]: ./media/application-model/application-model-4.jpg
[2]: ./media/application-model/application-model-5.jpg
[Configuring a Custom Domain Name in Azure]: http://www.windowsazure.com/develop/net/common-tasks/custom-dns/
[Data Storage Offerings in Azure]: http://www.windowsazure.com/develop/net/fundamentals/cloud-storage/
[3]: ./media/application-model/application-model-6.jpg
[4]: ./media/application-model/application-model-7.jpg

[Azure Pricing]: http://www.windowsazure.com/pricing/calculator/
[Managing Certificates in Azure]: http://msdn.microsoft.com/library/windowsazure/gg981929.aspx
[http://msdn.microsoft.com/library/windowsazure/ee758710.aspx]: http://msdn.microsoft.com/library/windowsazure/ee758710.aspx
[http://msdn.microsoft.com/library/hh560567.aspx]: http://msdn.microsoft.com/library/hh560567.aspx
[управлении обновлениями гостевых ОС Azure]: http://msdn.microsoft.com/library/ee924680.aspx
[портал управления Azure]: http://manage.windowsazure.com/
[5]: ./media/application-model/application-model-8.jpg
[Deploying and Updating Azure Applications]: http://www.windowsazure.com/develop/net/fundamentals/deploying-applications/
[Creating a Hosted Service for Azure]: http://msdn.microsoft.com/library/gg432967.aspx
[Managing Hosted Services in Azure]: http://msdn.microsoft.com/library/gg433038.aspx
[Migrating Applications to Azure]: http://msdn.microsoft.com/library/gg186051.aspx
[Configuring an Azure Application]: http://msdn.microsoft.com/library/windowsazure/ee405486.aspx


<!--HONumber=Jan17_HO3-->


