# Среда выполнения приложений

Azure позволяет развертывать и отслеживать работу кода приложения в центре обработки данных корпорации Майкрософт. При создании и запуске приложения в Azure код и настройка совместно называются размещенной службой Azure. Размещенными службами можно легко управлять, масштабировать в сторону увеличения и уменьшения, выполнять перенастройку и обновлять с использованием новых версий кода приложения. В данной статье рассматривается модель приложения размещенной службы Azure.<a id="compare" name="compare"></a>

## Оглавление<a id="_GoBack" name="_GoBack"></a>

-   [Преимущества модели приложения Azure][]
-   [Основные понятия размещенной службы][]
-   [Вопросы проектирования размещенной службы][]
-   [Разработка приложения для масштабирования][]
-   [Определение и конфигурирование размещенной службы][]
-   [Файл определения службы][]
-   [Файл конфигурации службы][]
-   [Создание и развертывание размещенной службы][]
-   [Ссылки][]

## <a id="benefits"> </a>Преимущества модели приложения Azure

При развертывании приложения в качестве размещенной службы Azure создает одну или несколько виртуальных машин (ВМ), содержащих код приложения, и загружает виртуальные машины на физических компьютерах, находящихся в одном из центров обработки данных Azure. При получении в центре обработки данных запросов от клиента к размещенной службе средство балансировки нагрузки равномерно распределяет эти запросы между виртуальными машинами. Размещение приложения в Azure обеспечивает три ключевых преимущества:

-   **Высокая доступность.** Высокая доступность означает, что Azure гарантирует максимальную эффективность выполнения приложения и реагирование на запросы клиентов. Если приложение завершает работу (например, из-за необработанного исключения), Azure обнаружит такую ситуацию и автоматически перезапустит приложение. Если на компьютере, на котором выполняется приложение, происходит сбой оборудования, Azure также обнаруживает такую ситуацию и автоматически создает новую виртуальную машину на другой рабочей физической машине и выполняет ваш код уже с этой машины. ПРИМЕЧАНИЕ. Для того чтобы обеспечить соглашение об обслуживании корпорации Майкрософт на уровне 99,95 %, необходимо иметь по крайней мере две виртуальных машины, на которых запущен код приложения. Это позволит одной виртуальной машине обрабатывать запросы клиентов, пока Azure перемещает код с неисправной виртуальной машины на новую работающую ВМ.

-   **Масштабируемость.** Azure позволяет легко и динамически изменять количество виртуальных машин, на которых запущен код приложения, для обработки фактических рабочих нагрузок приложения. Это позволяет настраивать приложения с учетом рабочих нагрузок, размещаемых клиентами, а также оплачивать только фактически используемые ВМ. Если требуется изменить количество виртуальных машин, Azure реагирует в течение нескольких минут, что дает возможность динамически изменять количество запущенных виртуальных машин по мере необходимости.

-   **Управляемость.** Поскольку Azure — это платформа как услуга (PaaS), она управляет инфраструктурой (самим оборудованием, энергопотреблением и сетевой активностью), необходимой для поддержания работы этих машин. Azure также управляет платформой, обеспечивая поддержание операционной системы в актуальном состоянии, установку всех необходимых пакетов исправлений и обновлений для системы безопасности, а также обновление компонентов, таких как .NET Framework и Internet Information Server. Поскольку все виртуальные машины работают под управлением Windows Server 2008, Azure предоставляет дополнительные функции, такие как контроль диагностики, поддержка удаленного рабочего стола, настройка брандмауэров и хранилища сертификатов. Все эти функции не требуют дополнительной оплаты. Фактически при выполнении приложения в Azure включается лицензия операционной системы (ОС) Windows Server 2008. Поскольку все виртуальные машины работают под управлением Windows Server 2008, любой код, работающий на Windows Server 2008, будет правильно выполняться в Azure.

## <a id="concepts"> </a>Основные понятия размещенной службы

При развертывании приложения в качестве размещенной службы в Azure оно выполняется в виде одной или нескольких *ролей.* Понятие *Роль* относится к файлам и конфигурации приложения. Можно определить одну или несколько ролей для приложения, каждая из которых имеет свой собственный набор файлов приложения и конфигураций. Для каждой из ролей приложения можно указывать количество запускаемых ВМ, или *экземпляров роли*. На следующем рисунке показаны два простых примера моделирования размещенной службы с использованием ролей и экземпляров ролей.

##### Рисунок 1. Одна роль с тремя экземплярами (ВМ), выполняемая в центре обработки данных Azure

![image][0]

##### Рисунок 2. Две роли с двумя экземплярами (ВМ) на каждую, выполняемые в центре обработки данных Azure

![image][1]

Экземпляры ролей обычно обрабатывают интернет-запросы клиентов, попадающие в центр обработки данных через так называемую *входную конечную точку*. Одна роль может иметь 0 или более входных конечных точек. Для каждой конечной точки указывается протокол (HTTP, HTTPS или TCP) и номер порта. Обычно для роли настраиваются две входные конечные точки: HTTP прослушивает порт 80, а HTTPS прослушивает порт 443. На следующем рисунке показан пример двух различных ролей с разными входными конечными точками, направляющими к ним запросы клиентов.

![image][2]

При создании размещенной службы в Azure для нее назначается общедоступный IP-адрес, который клиенты могут использовать для доступа к службе. После создания размещенной службы необходимо выбрать префикс URL-адреса, который сопоставляется с этим IP-адресом. Этот префикс должен быть уникальным, поскольку по сути выполняется резервирование *префикса*.cloudapp.net URL, чтобы предотвратить его использование другими лицами. Клиенты взаимодействуют с экземплярами роли с помощью URL-адреса. Как правило распространение или публикация
*префикса*.cloudapp.net URL Azure не выполняется. Вместо этого приобретается DNS-имя у регистратора DNS или производится выбор и настройка DNS-имени для перенаправления запросов клиента к URL-адресу Azure. Дополнительные сведения см. в разделе
[Настройка пользовательского имени домена в Azure][].

## <a id="considerations"> </a>Вопросы проектирования размещенной службы

При разработке приложений для выполнения в облачной среде следует учитывать несколько факторов, включая время задержки, высокую доступность и масштабируемость.

При выполнении размещенной службы в Azure важно принять правильное решение о том, где лучше размещать код приложения. Обычно приложения развертываются в центрах обработки данных, находящихся ближе всего к клиентам. Это позволяет уменьшить время задержки и обеспечить максимальную производительность.
Тем не менее, при наличии вопросов, связанных с юрисдикцией или правовыми аспектами, можно также выбрать центр обработки данных, находящийся ближе всего к вашей компании или к данным. Разместить код приложения можно в шести центрах обработки данных по всему миру. В приведенной ниже таблице показаны доступные местоположения:

<table border="2" cellspacing="0" cellpadding="5" style="border: 2px solid #000000;">
<tbody>
<tr>
<td style="width: 100px;">
**Страна/регион**

</td>
<td style="width: 200px;">
**Субрегионы**

</td>
</tr>
<tr>
<td>
США

</td>
<td>
Южно-центральный и Северо-центральный регионы

</td>
</tr>
<tr>
<td>
Европа

</td>
<td>
Северный и Западный регионы

</td>
</tr>
<tr>
<td>
Азия

</td>
<td>
Юго-восточный и Восточный регионы

</td>
</tr>
</tbody>
</table>
При создании размещенной службы следует выбрать субрегион, в котором будет выполняться код.

Для достижения высокой доступности и масштабируемости очень важно, чтобы данные вашего приложения хранились в центральном репозитории, доступном для нескольких экземпляров ролей. Чтобы помочь в этом, Azure предоставляет несколько различных вариантов хранения, включая BLOB-объекты, таблицы и базы данных SQL. Для получения дополнительных сведений об этих технологиях хранения см. раздел [Предлагаемые варианты хранения данных для платформы Azure][]. На рисунке ниже показано, как система балансировки нагрузки внутри центра обработки данных Azure распределяет клиентские запросы на другие экземпляры ролей, каждый из которых имеет доступ к одному и тому же хранилищу данных.

![image][3]

Как правило, код приложения и данных размещаются в одном центре обработки данных, так как это уменьшает время задержки (повышает производительность) при обращении кода приложения к данным. Кроме того, при перемещении данных в пределах одного центра данных плата за полосу пропускания не взимается.

## <a id="scale"> </a>Разработка приложения для масштабирования

В некоторых случаях может потребоваться размещение в Azure одного приложения (например, простого веб-сайта). Однако зачастую приложение может состоять из нескольких ролей, работающих совместно друг с другом. Например, на рисунке ниже представлены два экземпляра роли веб-сайта, три экземпляра роли обработки заказов и один экземпляр роли генератора отчетов. Все эти роли взаимодействуют между собой, и для них можно упаковать и развернуть единый код под Azure.

![image][4]

Главной причиной для разделения приложения на различные роли, каждая из которых работает на собственном наборе экземпляров ролей (т. е. ВМ), является возможность масштабирования ролей независимо друг от друга. Например, во время праздников может возрасти количество заказчиков, приобретающих продукты вашей компании, поэтому может потребоваться увеличить число экземпляров ролей для веб-сайта, а также количество экземпляров ролей для системы обработки заказов. После завершения праздников может возрасти количество возвратов продукции, поэтому по-прежнему может потребоваться большое количество экземпляров веб-сайта, но число экземпляров для системы обработки заказов нужно будет уменьшить. В другие периоды года требуется лишь несколько экземпляров веб-сайтов и системы обработки заказов. На протяжении любого из этих периодов вам может понадобиться только один экземпляр генератора отчетов. Гибкое развертывание на основе ролей в Azure позволяет легко адаптировать приложение к потребностям бизнеса.

Обычно роли экземпляров в размещенной службе взаимодействуют друг с другом. Например, роль веб-сайта принимает заказ клиента, а затем функция обработки заказа передается экземплярам системы обработки заказов. Лучший способ передачи заданий от одного набора экземпляров ролей к другому — это использование одной из технологий организации очереди, реализованной в Azure (служба очередей или очереди
Service Bus). Использование очереди является очень важной частью процесса. Очередь позволяет размещенной службе масштабировать роли независимо друг от друга, что дает возможность балансировать нагрузки и затраты. Если со временем увеличивается количество сообщений в очереди, можно выполнить масштабирование количества экземпляров роли обработки заказов в сторону увеличения. Если количество сообщений в очереди со временем уменьшается, можно выполнить масштабирование количества экземпляров роли обработки заказов в сторону уменьшения. Таким образом, вы платите только за те экземпляры, которые требуются для обработки фактических рабочих нагрузок.

Использование очереди также повышает надежность. При масштабировании числа экземпляров роли обработки заказов в сторону уменьшения Azure решает, какие экземпляры нужно остановить. Может быть принято решение остановить экземпляр, находящийся в процессе обработки сообщения из очереди. Однако поскольку обработка сообщения не будет успешно завершена, сообщение снова становится видимым для другого экземпляра роли обработки заказов, который принимает сообщение и обрабатывает его. Сообщения видны в очереди, поэтому в конечном итоге гарантируется их обработка. Очередь также выступает как система балансировки нагрузки, эффективно распределяя сообщения между всеми экземплярами ролей, запрашивающими сообщения из очереди.

Для экземпляров ролей веб-сайта можно отслеживать поступающий трафик и принимать решение о масштабировании в сторону увеличения или уменьшения. Очередь позволяет масштабировать число экземпляров роли веб-сайта независимо от экземпляров роли обработки заказов. Это очень мощная функция, которая обеспечивает большую гибкость. Конечно, если приложение содержит дополнительные роли, можно добавить дополнительные очереди для связи между ними, чтобы получить аналогичные преимущества с точки зрения масштабируемости и экономичности.

## <a id="defandcfg"> </a>Определение и конфигурирование размещенной службы

Для развертывания размещенной службы в Azure необходимо также иметь файл определения службы и файл конфигурации службы. Оба эти файла являются файлами XML и позволяют декларативно указывать параметры развертывания для вашей размещенной службы. Файл определения службы описывает все роли, из которых складывается размещенная служба, а также способ их взаимодействия. Файл конфигурации службы описывает число экземпляров для каждой роли и параметры, используемые для настройки каждого экземпляра роли.

## <a id="def"> </a>Файл определения службы

Как упоминалось ранее, файл определения службы (CSDEF) является XML-файлом, содержащим описание различных ролей, из которых состоит приложение. Полную схему XML-файла можно найти здесь:
[http://msdn.microsoft.com/ru-ru/library/windowsazure/ee758711.aspx][].
Файл CSDEF содержит элемент WebRole или WorkerRole для каждой роли в приложении. Развертывание ролей в качестве веб-ролей (с помощью элемента WebRole) означает, что код будет выполняться в экземпляре роли, содержащем Windows Server 2008 и Internet Information Server (IIS).
Развертывание роли в качестве рабочей роли (с помощью элемента WorkerRole) означает, что экземпляр роли будет использовать Windows Server 2008 на нем (без установки IIS).

Конечно, можно создать и развернуть рабочую роль, которая использует другой механизм для прослушивания входящих веб-запросов (например, код может создать и использовать .NET HttpListener). Поскольку роли экземпляров работают на Windows Server 2008, код может совершать любые действия, которые обычно доступны для приложения, работающего на Windows Server 2008.

Для каждой роли указывается желаемый размер виртуальных машин, используемых экземплярами такой роли. В приведенной ниже таблице показаны доступные на сегодня размеры ВМ, а также характеристики каждого из размеров:

<table border="2" cellspacing="0" cellpadding="5" style="border: 2px solid #000000;">
<tbody>
<tr align="left" valign="top">
<td>
**Размер виртуальной машины**

</td>
<td>
**ЦП**

</td>
<td>
**ОЗУ**

</td>
<td>
**Диск**

</td>
<td>
**Пиковая производительность сетевых вводов/выводов**

</td>
</tr>
<tr align="left" valign="top">
<td>
**Очень мелкий**

</td>
<td>
1 x 1,0 ГГц

</td>
<td>
768 МБ

</td>
<td>
20 ГБ

</td>
<td>
\~ 5 Мбит/с

</td>
</tr>
<tr align="left" valign="top">
<td>
**Мелкий**

</td>
<td>
1 x 1,6 ГГц

</td>
<td>
1,75 ГБ

</td>
<td>
225 ГБ

</td>
<td>
\~ 100 Мбит/с

</td>
</tr>
<tr align="left" valign="top">
<td>
**Средний**

</td>
<td>
2 x 1,6 ГГц

</td>
<td>
3,5 ГБ

</td>
<td>
490 ГБ

</td>
<td>
\~ 200 Мбит/с

</td>
</tr>
<tr align="left" valign="top">
<td>
**Крупный**

</td>
<td>
4 x 1,6 ГГц

</td>
<td>
7 ГБ

</td>
<td>
1 ТБ

</td>
<td>
\~ 400 Мбит/с

</td>
</tr>
<tr align="left" valign="top">
<td>
**Очень крупный**

</td>
<td>
8 x 1,6 ГГц

</td>
<td>
14 ГБ

</td>
<td>
2 ТБ

</td>
<td>
\~ 800 Мбит/с

</td>
</tr>
</tbody>
</table>
Оплата начисляется за каждый час использования виртуальной машины в качестве экземпляра роли; также начисляется оплата за все данные, которые экземпляры роли отправляют за пределы центра обработки данных. Не взимается оплата за данные, поступающие в центр обработки данных. Дополнительные сведения см. в разделе [Ценообразование в Azure][]. В общем случае рекомендуется использовать множество мелких экземпляров с небольшими ролями вместо нескольких крупных экземпляров. Благодаря этому приложение будет более устойчивым к сбоям. В итоге чем меньше используется экземпляров ролей, тем более катастрофические последствия будет иметь сбой одного из них. Кроме того, как упоминалось ранее, необходимо развернуть по крайней мере два экземпляра для каждой роли для обеспечения соглашения об уровне обслуживания на уровне 99,95 %, предлагаемого корпорацией Майкрософт.

В файле определений службы (CSDEF) указываются различные атрибуты для каждой из ролей, используемых в приложении. Вот несколько элементов, которые могут быть полезны для вас:

-   **Сертификаты**. Сертификаты используются для шифрования данных или если используемая веб-служба поддерживает SSL. Все сертификаты необходимо загрузить в Azure. Дополнительные сведения см. в разделе [Управление сертификатами в Azure][]. Этот параметр XML устанавливает ранее загруженные сертификаты в хранилище сертификатов экземпляра роли, чтобы код приложения мог использовать такие сертификаты.

-   **Имена параметров конфигурации**. Для значений, которые приложения должны считывать во время работы экземпляра роли. Фактическое значение параметра конфигурации задается в файле конфигурации службы (CSCFG), который можно обновлять в любое время без необходимости повторного развертывания кода. По сути можно составить код приложения таким образом, чтобы он определял изменения значений конфигурации без возникновения простоев.

-   **Конечные точки ввода**. Здесь можно задать любые конечные точки HTTP, HTTPS или TCP (с портами), которым требуется предоставить доступ к внешнему миру через свой *префикс*. cloadapp.net URL. Когда система Azure развертывает вашу роль, она автоматически настроит брандмауэр на экземпляр роли.

-   **Внутренние конечные точки**. Здесь можно указать любые конечные точки HTTP или TCP, которые нужны для других экземпляров роли, развертываемых как часть приложения. Внутренние конечные точки позволяют всем экземплярам роли в приложении обмениваться данными друг с другом, при этом они не доступны для экземпляров роли, находящихся за пределами вашего приложения.

-   **Модули импорта**. Позволяют дополнительно устанавливать полезные компоненты на экземпляры роли. Существуют компоненты для диагностического мониторинга, удаленного рабочего стола и Azure Connect (что позволяет экземпляру роли получать доступ к локальным ресурсам через безопасный канал).

-   **Локальное хранилище**. Выделяет подкаталог на экземпляре роли, используемый вашим приложением. Более подробное описание см. в разделе [Предлагаемые варианты хранения данных для платформы Azure][].

-   **Задачи при запуске**. Задачи при запуске позволяют устанавливать необходимые компоненты на экземпляре роли при его загрузке. При необходимости задачи могут запускаться с расширенными правами администратора.

## <a id="cfg"> </a>Файл конфигурации службы

Файл конфигурации службы (CSCFG) является XML-файлом, описывающим параметры, которые могут быть изменены без повторного развертывания приложения. Полную схему XML-файла можно найти здесь:
[http://msdn.microsoft.com/ru-ru/library/windowsazure/ee758710.aspx][].
Файл CSCFG содержит элемент роли для каждой роли в приложении. Ниже приведены некоторые элементы, которые можно указать в файле CSCFG:

-   **Версия ОС**. Этот атрибут позволяет выбрать версию операционной системы (ОС), которую нужно использовать для всех экземпляров ролей, на которых выполняется код приложения. Эта операционная система называется *гостевой ОС*; в каждую новую версию включены последние исправления безопасности и обновления, доступные на момент выпуска гостевой ОС. Если установить значение атрибута osVersion "\*", то Azure будет автоматически обновлять гостевую ОС для каждого из экземпляров роли по мере появления новых версий гостевых OS. При этом можно отказаться от автоматического обновления, выбрав конкретную версию гостевой ОС. Например, если для атрибута osVersion установить значение
    "WA-GUEST-OS-2.8\_201109-01", то все экземпляры роли получат компоненты, описанные на следующей веб-странице:
    [http://msdn.microsoft.com/ru-ru/library/hh560567.aspx][]. Дополнительные сведения о версиях гостевой ОС см. в разделе [Управление обновлениями гостевой ОС Azure].

-   **Экземпляры**. Значение этого элемента указывает на количество экземпляров роли, выполняющих код для определенной роли. Поскольку в Azure можно загрузить новый файл CSCFG (без повторного развертывания приложения), вы можете максимально просто изменить значение этого элемента и загрузить новый файл CSCFG для динамического увеличения или уменьшения количества экземпляров роли, выполняющих код приложения. Это позволяет легко масштабировать приложения в сторону увеличения или в сторону уменьшения для обеспечения требований, выдвигаемых фактическими рабочими нагрузками, а также для управления платежами, начисляемыми за выполнение экземпляров роли.

-   **Значения параметров конфигурации**. Этот элемент определяет значения параметров (как определено в файле CSDEF). Роль может прочитать эти значения во время ее выполнения. Обычно значения этих параметров конфигурации используются для строки подключения к базе данных SQL или к хранилищу Azure, однако их также можно использовать для любых требуемых целей.

## <a id="hostedservices"> </a>Создание и развертывание размещенной службы

Для создания размещенной службы необходимо перейти на [Портал управления Azure] и подготовить размещенную службу путем указания префикса DNS и центра обработки данных, в котором должен выполняться код. Затем в среде разработки создайте файл определения службы (CSDEF), соберите код приложения и упакуйте все эти файлы в файл пакета службы (CSPKG). Также необходимо подготовить файл конфигурации службы (CSCFG). Чтобы развернуть роль, загрузите файлы CSCFG и CSPKG с помощью API управления службами Azure. После развертывания Azure предоставит экземпляры роли в центре обработки данных (на основе данных конфигурации), извлечет код приложения из пакета, скопирует его в экземпляры роли и выполнит загрузку экземпляров. Теперь код запущен и работает.

На рисунке ниже показаны файлы CSPKG и CSCFG, созданные на компьютере разработчика. Файл CSPKG содержит файл CSDEF и код для двух ролей. После того как файлы CSPKG и CSCFG загружены с помощью API управления службами Azure, Azure создает экземпляры роли в центре обработки данных. В этом примере в файле CSCFG указано, что Azure необходимо создать три экземпляра роли \#1 и два экземпляра роли \#2.

![image][5]

Дополнительные сведения о развертывании, обновлении и повторной настройке ролей см. в разделе [Развертывание и обновление приложений Azure][]
article.<a id="Ref" name="Ref"></a>

## <a id="references"> </a>References

-   [Создание размещенной службы для Azure][]

-   [Управление размещенными службами в Azure][]

-   [Миграция приложений в Azure][]

-   [Настройка приложения в Azure][]

<div style="width: 700px; border-top: solid; margin-top: 5px; padding-top: 5px; border-top-width: 1px;">

<p>Автор: Джеффри Рихтер (Wintellect)</p>

</div>

  [Преимущества модели приложения Azure]: #benefits
  [Основные понятия размещенной службы]: #concepts
  [Вопросы проектирования размещенной службы]: #considerations
  [Разработка приложения для масштабирования]: #scale
  [Определение и конфигурирование размещенной службы]: #defandcfg
  [Файл определения службы]: #def
  [Файл конфигурации службы]: #cfg
  [Создание и развертывание размещенной службы]: #hostedservices
  [Ссылки]: #references
  [0]: ./media/application-model/application-model-3.jpg
  [1]: ./media/application-model/application-model-4.jpg
  [2]: ./media/application-model/application-model-5.jpg
  [Настройка пользовательского имени домена в Azure]: http://www.windowsazure.com/ru-ru/develop/net/common-tasks/custom-dns/
  [Предлагаемые варианты хранения данных для платформы Azure]: http://www.windowsazure.com/ru-ru/develop/net/fundamentals/cloud-storage/
  [3]: ./media/application-model/application-model-6.jpg
  [4]: ./media/application-model/application-model-7.jpg
  
  [Ценообразование в Azure]: http://www.windowsazure.com/ru-ru/pricing/calculator/
  [Управление сертификатами в Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/gg981929.aspx
  [http://msdn.microsoft.com/ru-ru/library/windowsazure/ee758710.aspx]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee758710.aspx
  [http://msdn.microsoft.com/ru-ru/library/hh560567.aspx]: http://msdn.microsoft.com/ru-ru/library/hh560567.aspx
  [Управление обновлениями гостевой ОС Azure]: http://msdn.microsoft.com/ru-ru/library/ee924680.aspx
  [Портал управления Azure]: http://manage.windowsazure.com/
  [5]: ./media/application-model/application-model-8.jpg
  [Развертывание и обновление приложений Azure]: http://www.windowsazure.com/ru-ru/develop/net/fundamentals/deploying-applications/
  [Создание размещенной службы для Azure]: http://msdn.microsoft.com/ru-ru/library/gg432967.aspx
  [Управление размещенными службами в Azure]: http://msdn.microsoft.com/ru-ru/library/gg433038.aspx
  [Миграция приложений в Azure]: http://msdn.microsoft.com/ru-ru/library/gg186051.aspx
  [Настройка приложения в Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee405486.aspx


