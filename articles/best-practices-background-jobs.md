<properties
   pageTitle="Руководство по фоновым заданиям | Microsoft Azure"
   description="Руководство по использованию фоновых задач, выполняемых независимо от пользовательского интерфейса."
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="christb"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="07/21/2016"
   ms.author="masashin"/>

# Руководство по фоновым заданиям

[AZURE.INCLUDE [pnp-header](../includes/guidance-pnp-header-include.md)]

## Обзор

Многим типам приложений требуются фоновые задачи, которые выполняются независимо от пользовательского интерфейса. К примерам относятся пакетные задания, ресурсоемкие задачи обработки и длительные процессы, например рабочие процессы. Фоновые задания могут выполняться без вмешательства пользователя. Приложение может запустить задание, а затем продолжить обработку интерактивных запросов пользователей. Это поможет свести к минимуму нагрузку на пользовательский интерфейс приложения, что может увеличить доступность и сократить время интерактивного отклика приложения.

Например, если приложению требуется создавать эскизы рисунков, передаваемых пользователями, оно может делать это как фоновое задание, после чего сохранять эскизы в хранилище, не вынуждая пользователя ожидать, пока процесс будет завершен. Точно так же пользователь, размещающий заказ, может запустить фоновый рабочий процесс, который обрабатывает заказ, а с помощью пользовательского интерфейса пользователь может продолжить просмотр веб-приложения. По завершении фонового задания оно может обновить хранимые данные заказов и отправить пользователю электронное сообщение, подтверждающее заказ.

При выборе реализации в виде задачи или фонового задания основной критерий — может ли задача выполняться без взаимодействия с пользователем и должен ли пользовательский интерфейс ожидать завершения задания. Задачи, требующие, чтобы пользователь или пользовательский интерфейс ожидал, пока они выполняются, не подходят для фоновых заданий.

## Типы фоновых заданий

Фоновые задания обычно включают одно или несколько заданий следующих типов:

- Задания, интенсивно использующие ЦП, например математические вычисления или анализ структурных моделей.
- Задания с большим объемом операций ввода-вывода, например, выполняющие циклы транзакций с хранилищем или индексирование файлов.
- Пакетные задания, например обновление данных каждую ночь или обработка по расписанию.
- Продолжительные рабочие процессы, например выполнение заказов или подготовка служб и систем.
- Обработка конфиденциальных данных, при которой задача для обработки передается в более безопасное место. Например, вы можете не желать обрабатывать конфиденциальные данные в веб-приложении, а вместо этого использовать шаблон, например шаблон [привратника](http://msdn.microsoft.com/library/dn589793.aspx), чтобы передавать данные в изолированный фоновый процесс, имеющий доступ к защищенному хранилищу.

## триггеры;

Фоновые задания могут запускаться несколькими различными способами. Каждый из них можно отнести к одной из следующих категорий:

- [**Триггеры, управляемые событиями**](#event-driven-triggers). Задача запускается в ответ на событие — обычно действие, выполненное пользователем, или шаг в рабочем процессе.
- [**Триггеры, управляемые расписанием**](#schedule-driven-triggers). Задача вызывается по расписанию на основе таймера. Это может быть повторяющееся расписание или одноразовый вызов, указанный на более позднее время.

### Запуск при определенном событии

При управляемом событиями вызове для запуска фоновой задачи используется триггер. Примеры использования триггеров, управляемых событиями:

- Пользовательский интерфейс или другое задание помещает сообщение в очередь. Сообщение содержит данные о действии, которое было выполнено, например: пользователь разместил заказ. Фоновая задача прослушивает эту очередь и обнаруживает поступление нового сообщения. Она считывает сообщение и использует его в качестве входных данных для фонового задания.
- Пользовательский интерфейс или другое задание сохраняет или обновляет значение в хранилище. Фоновая задача отслеживает хранилище и обнаруживает изменения. Она считывает данные и использует их в качестве входных данных для фонового задания.
- Пользовательский интерфейс или другое задание выполняет запрос к конечной точке (по универсальному коду ресурса (URI) HTTPS) или API, предоставляемому как веб-служба. В запросе передаются данные, необходимые для выполнения фоновой задачи. Конечная точка или веб-служба вызывает фоновую задачу, которая использует эти данные в качестве входных.

Типичные примеры задач, подходящих для управляемого событиями вызовами: обработка изображений, рабочие процессы, отправка информации в удаленные службы, отправка электронных сообщений и подготовка новых пользователей в многопользовательских приложениях.

### Триггеры, управляемые расписанием

При управляемом расписанием вызове для запуска фоновой задачи используется таймер. Примеры использования управляемых расписанием триггеров:

- Таймер, выполняемый локально в приложении или в его операционной системе, вызывает фоновую задачу на регулярной основе.
- Таймер, выполняемый в другом приложении, или служба таймера, например планировщик Azure, отправляет запрос к API или веб-службе на регулярной основе. API или веб-служба вызывает фоновую задачу.
- Отдельный процесс или приложение запускает таймер, который вызывает фоновую задачу по истечении указанного времени задержки или в определенное время.

Типичные примеры задач, подходящих для управляемого расписанием вызова: подпрограммы пакетной обработки, например обновление списков связанных продуктов для пользователей на основе их последнего поведения, стандартные задачи обработки данных, например обновление индексов или формирование накопленных результатов, анализ данных для ежедневных отчетов, очистка хранения данных и проверка согласованности данных.

При использовании управляемой расписанием задачи, которая должна выполняться как единственный экземпляр, надо учитывать следующее:

- Если вычислительный экземпляр, в котором выполняется планировщик (например виртуальная машина с планировщиком заданий Windows), масштабируется, у вас будет выполняться несколько экземпляров планировщика, что может привести к запуску нескольких экземпляров задачи.
- Если длительность выполнения задач превышает период между событиями планировщика, планировщик может запустить еще один экземпляр задачи, когда предыдущий еще выполняется.

## Возвращение результатов

Фоновые задания выполняются асинхронно в отдельном процессе или даже отдельном расположении, из пользовательского интерфейса или процесса, который вызывает фоновое задание. В идеальном случае фоновые задачи — это операции типа «отправить и забыть», и их выполнение не оказывает влияния на пользовательский интерфейс или вызывающий процесс. Это означает, что вызывающий процесс не ждет завершения задач и, следовательно, не может обнаружить автоматически, когда задача завершена.

Если требуется связать фоновую задачу с вызывающей задачей, чтобы она сообщала о ходе выполнения или завершении, для этого необходимо реализовать механизм. Ниже приведены некоторые примеры.

- Значение индикатора состояния записи в хранилище, доступное в пользовательском интерфейсе или вызывающей задаче, которая может отслеживать или проверять это значение при необходимости. Другие данные, которые фоновая задача должна возвращать вызывающей стороне, могут помещаться в то же хранилище.
- Создание очереди ответов, которую прослушивает пользовательский интерфейс или вызывающая задача. Фоновая задача может отправлять сообщения в очередь, сообщая о состоянии и завершении. Данные, которые фоновая задача должна возвращать вызывающей стороне, могут содержаться в сообщениях. Если вы используете служебную шину Azure, для реализации этой возможности можно использовать свойства **ReplyTo** и **CorrelationId**. Дополнительную информацию см. в статье [Корреляции при обмене сообщениями через посредника служебной шины](http://www.cloudcasts.net/devguide/Default.aspx?id=13029).
- Предоставление из фоновой задачи API или конечной точки, к которой может обратиться пользовательский интерфейс или вызывающая задача, чтобы получить информацию о состоянии. Данные, которые фоновая задача должна возвращать вызывающей стороне, могут содержаться в ответе.
- Фоновая задача выполняет обратный вызов пользовательского интерфейса или вызывающей задачи через API, чтобы сообщить о состоянии в предопределенных точках или о завершении. Это может быть реализовано через локальные события или с помощью механизма публикации и подписки. Данные, которые фоновая задача должна возвращать вызывающей стороне, могут содержаться в запросе или полезных данных событий.

## Среда размещения

Вы можете размещать фоновые задачи с помощью ряда разных служб платформы Azure:

- [**Веб-приложения Azure и веб-задания**](#azure-web-apps-and-webjobs). Вы можете использовать веб-задания, чтобы выполнять пользовательские задания на основе диапазона различных типов сценариев или исполняемых файлов в контексте веб-приложения.
- [**Рабочие и веб-роли облачных служб Azure**](#azure-cloud-services-web-and-worker-roles). Можно написать код в роли, которая выполняется как фоновая задача.
- [**Виртуальные машины Azure**](#azure-virtual-machines). Если вы используете службу Windows или хотите использовать планировщик заданий Windows, обычно для размещения фоновых задач используется выделенная виртуальная машина.
- [**Пакетная служба Azure**](./batch/batch-technical-overview.md). Это служба платформы, которая планирует запуск ресурсоемких вычислительных задач в управляемой коллекции виртуальных машин и автоматически масштабирует вычислительные ресурсы в соответствии с требованиями задания.

В следующих разделах более подробно описан каждый из этих вариантов, а также приведены рекомендации по их выбору.

## Веб-приложения Azure и веб-задания

Вы можете использовать веб-задания Azure для выполнения пользовательских заданий как фоновых задач в веб-приложении Azure. Веб-задания выполняются в контексте веб-приложения непрерывно или в ответ на событие триггера из планировщика Azure либо на какие-либо внешние факторы, например изменения в хранилище больших двоичных объектов и очередях сообщений. Задания можно запускать и останавливать по запросу, а также корректно завершать. При сбое непрерывно выполняемого веб-задания оно автоматически перезапускается. Действия при повторной попытке и ошибке можно настраивать.

При настройке веб-задания:

- Если требуется, чтобы задание реагировало на управляемый событиями триггер, необходимо выбрать параметр **Выполнять непрерывно**. Сценарий или программа хранится в папке site/wwwroot/app\_data/jobs/continuous.
- Если требуется, чтобы задание реагировало на триггер, управляемый событиями, необходимо выбрать параметр **Выполнять по расписанию**. Сценарий или программа хранится в папке site/wwwroot/app\_data/jobs/triggered.
- Если при настройке задания выбрать параметр **Выполнять по требованию**, оно будет выполнять тот же код, что и **Выполнять по расписанию**, когда вы его запустите.

Веб-задания Azure выполняются в песочнице веб-приложения, а значит, они могут обращаться к переменным среды и обмениваться с веб-приложением такой информацией, как строки подключения. Задание имеет доступ к уникальному идентификатору компьютера, на котором оно выполняется. Строка подключения с именем **AzureWebJobsStorage** предоставляет доступ к очередям, большим двоичным объектам и таблицам службы хранилища Azure для обращения к данным приложений, а также к служебной шине для обмена данными и сообщениями. Строка подключения с именем **AzureWebJobsStorage** обеспечивает доступ к файлам журнала действий задания.

Веб-задания Azure обладают следующими характеристиками:

- **Безопасность**: веб-задания защищены с помощью учетных данных развертывания веб-приложения.
- **Поддерживаемые типы файлов**: веб-задания можно определять с помощью командных скриптов (CMD-файлы), пакетных файлов (BAT-файлы), сценариев PowerShell (PS1-файлы), скриптов оболочки Bash (SH-файлы), скриптов PHP (PHP-файлы), скриптов Python (PY-файлы), кода JavaScript (JS-файлы) и исполняемых программ (EXE-, JAR-файлы и многие другие).
- **Развертывание**: скрипты и исполняемые файлы можно развертывать с помощью портала Azure, с помощью надстройки [WebJobsVs](https://visualstudiogallery.msdn.microsoft.com/f4824551-2660-4afa-aba1-1fcc1673c3d0) для Visual Studio или [Visual Studio 2013 с обновлением 4](http://www.visualstudio.com/news/vs2013-update4-rc-vs) (этот вариант позволяет создавать и развертывать данные элементы), с помощью [пакета SDK для Azure для веб-заданий](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md) или копируя их непосредственно в следующие расположения:
  - Для выполнения по триггеру: site/wwwroot/app\_data/jobs/triggered/{имя задания}
  - Для непрерывного выполнения: site/wwwroot/app\_data/jobs/continuous/{имя задания}
- **Ведение журнала**: Console.Out обрабатывается (помечается) как информация, а Console.Error — как ошибка. К данным наблюдения и диагностики можно обратиться с помощью портала Azure, а файлы журнала скачать непосредственно с сайта. Они сохраняются в следующих расположениях:
  - Для выполнения по триггеру: Vfs/data/jobs/triggered/jobName
  - Для непрерывного выполнения: Vfs/data/jobs/continuous/jobName
- **Конфигурация**: веб-задания можно настраивать с помощью портала, REST API и PowerShell. Файл конфигурации settings.job, находящийся в том же корневом каталоге, что и сценарий задания, можно использовать для предоставления данных о конфигурации задания. Например:
  - { "stopping\_wait\_time": 60 }
  - { "is\_singleton": true }

### Рекомендации

- По умолчанию веб-задания масштабируются вместе с веб-приложением. Однако задания можно настроить для запуска на одном экземпляре, задав для свойства конфигурации **is\_singleton** значение **true**. Одноэкземплярные веб-задания удобны для задач, которые не требуется масштабировать или выполнять одновременно в виде нескольких экземпляров: это может быть повторная индексация, анализ данных и схожие задачи.
- Чтобы свести к минимуму влияние заданий на производительность веб-приложения, рассмотрите возможность создания пустого экземпляра веб-приложения Azure в новом плане службы приложений, чтобы размещать веб-задания, которые могут долго выполняться или потреблять много ресурсов.

### Дополнительные сведения

- В [рекомендуемых ресурсах по веб-заданиям Azure](./app-service-web/websites-webjobs-resources.md) перечислены многие полезные ресурсы, файлы для скачивания и примеры для веб-заданий.

## Рабочие и веб-роли облачных служб Azure

Фоновые задачи могут выполняться в веб-роли или в отдельной рабочей роли. Выбирая рабочую роль, необходимо учитывать требования к масштабируемости и гибкости, время существования задачи, периодичность выпуска, безопасность, отказоустойчивость, конфликты, сложность и логическую архитектуру. Дополнительную информацию см. в статье [Шаблон консолидации вычислительных ресурсов](http://msdn.microsoft.com/library/dn589778.aspx).

Существует несколько способов реализовать фоновые задачи в роли облачных служб:

- Создание реализации класса **RoleEntryPoint** в роли и использование его методов для выполнения фоновых задач. Задачи выполняются в контексте WaIISHost.exe Они могут использовать метод **GetSetting** класса **CloudConfigurationManager** для загрузки параметров конфигурации. Дополнительную информацию см. в разделе [Жизненный цикл (облачные службы)](#lifecycle-cloud-services).
- Использование задач запуска для выполнения фоновых задач при запуске приложения. Чтобы задачи продолжали принудительно запускаться в фоновом режиме, для свойства **taskType** задайте значение **background** (если этого не сделать, процесс запуска приложения остановится и будет ожидать завершения задачи). Дополнительные сведения см. в статье [Как настроить и выполнить задачи запуска для облачной службы](./cloud-services/cloud-services-startup-tasks.md).
- Использование пакета SDK для веб-заданий для реализации фоновых задач как веб-заданий, которые инициируются как задачи запуска. Дополнительную информацию см. в статье [Создание веб-задания .NET в службе приложений Azure](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md).
- Использование задачи запуска для установки службы Windows, которая выполняет одну или несколько фоновых задач. Чтобы эта служба выполнялась в фоновом режиме, необходимо для свойства **taskType** задать значение **background**. Дополнительные сведения см. в статье [Как настроить и выполнить задачи запуска для облачной службы](./cloud-services/cloud-services-startup-tasks.md).

### Запуск фоновых задач в веб-роли

Основным преимуществом выполнения фоновых задач в веб-роли является сокращение затрат на размещение, так как не требуется развертывать дополнительные роли.

### Запуск фоновых задач в рабочей роли

Запуск фоновых задач в рабочей роли имеет несколько преимуществ:

- Позволяет управлять масштабированием отдельно для каждого типа роли. Например, может потребоваться несколько экземпляров веб-роли для обслуживания текущей нагрузки, но меньше экземпляров рабочей роли для выполнения фоновых задач. Масштабирование вычислительных экземпляров фоновых задач отдельно от ролей пользовательского интерфейса может уменьшить стоимость размещения, сохраняя при этом приемлемую производительность.
- Освобождает веб-роль от дополнительной обработки фоновых задач. Веб-роль, которая предоставляет пользовательский интерфейс, может оставаться работоспособной, что может означать меньшее количество экземпляров, необходимых для обслуживания заданного объема запросов от пользователей.
- Позволяет реализовать разделение областей ответственности. Каждый тип роли может реализовать ряд четко определенных и связанных задач. Это упрощает проектирование и обслуживание кода, так как уменьшается взаимозависимость кода и функциональных возможностей между ролями.
- Позволяет изолировать конфиденциальные процессы и данные. Например, веб-ролям, которые реализуют интерфейс пользователя, не требуется доступ к данным, управляемых и контролируемых рабочей ролью. Это может быть удобно для повышения уровня безопасности, особенно в том случае, если используется такой шаблон, как [шаблон привратника](http://msdn.microsoft.com/library/dn589793.aspx).

### Рекомендации

При выборе как и где развертывать фоновые задачи при использовании рабочих и веб-ролей облачных служб следует учитывать следующие моменты:

- Размещение фоновых задач в существующей веб-роли может снизить расходы на стоимость выполнения отдельной рабочей роли для этих задач, но это может повлиять на производительность и доступность приложения в случае конфликтов за использование обрабатывающих и других ресурсов. Использование отдельной рабочей роли защищает веб-роль от влияния долго выполняющихся или ресурсоемких фоновых задач.
- При размещении фоновых задач с помощью класса **RoleEntryPoint** вы можете легко переместить его в другую роль. Например, если вы создали класс в веб-роли, а позже решили, что задачи необходимо выполнять в рабочей роли, вы можете переместить реализацию класса **RoleEntryPoint** в рабочую роль.
- Задачи запуска предназначены для выполнения программы или сценария. Развернуть фоновое задание как исполняемую программу может оказаться сложнее, особенно если также требуется развертывать зависимые сборки. Возможно, проще будет развернуть и использовать сценарий для определения фонового задания с помощью задач запуска.
- Исключения, которые вызывают сбой фоновой задачи, по-разному оказывают влияние. Это зависит от способа их размещения:
  - Если вы используете метод на основе класса **RoleEntryPoint**, завершенная сбоем задача приведет к перезапуску роли, чтобы задача могла быть автоматически перезапущена. Это может повлиять на доступность приложения. Чтобы избежать этого, обязательно добавьте надежную обработку исключений в класс **RoleEntryPoint** и все фоновые задачи. Используйте код для перезапуска завершенных сбоем задач, где это целесообразно, и порождайте исключение для перезапуска роли только в том случае, если нельзя корректно выполнить восстановление после сбоя в коде.
  - При использовании задач запуска вы несете ответственность за управление выполнением задач и проверку на наличие сбоя.
- Управление задачами запуска и наблюдение за ними сложнее, чем использование класса **RoleEntryPoint**. Тем не менее, пакет SDK для Azure для веб-заданий содержит панель мониторинга, чтобы упростить управление веб-заданиями, инициируемыми с помощью задач запуска.

### Дополнительные сведения

- [Шаблон консолидации вычислительных ресурсов](http://msdn.microsoft.com/library/dn589778.aspx)
- [Начало работы с пакетом SDK для Azure для веб-заданий](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)

## Виртуальные машины Azure

Фоновые задачи могут быть реализованы таким способом, который препятствует развертыванию в веб-приложениях или в облачных службах Azure, или это может быть неудобно. Типичные примеры — службы Windows, служебные программы и исполняемые программы сторонних производителей. Другим примером могут служить программы, написанные для среды выполнения, отличной от среды, в которой размещено приложение. Например, это может быть программа Unix или Linux, которую необходимо выполнить из приложения Windows или .NET. Вы можете выбрать из диапазона операционных систем для виртуальной машины Azure и запустить свою службу или исполняемый файл на этой виртуальной машине.

Чтобы решить, когда следует использовать виртуальные машины, см. статью [Сравнение служб приложений, облачных служб и виртуальных машин Azure](./app-service-web/choose-web-site-cloud-service-vm.md). Дополнительные сведения о параметрах виртуальных машин см. в статье [Размеры для облачных служб](http://msdn.microsoft.com/library/azure/dn197896.aspx). Дополнительные сведения об операционных системах и готовых образах, доступных для виртуальных машин, см. в [магазине виртуальных машин Azure](https://azure.microsoft.com/gallery/virtual-machines/).

Для запуска фоновой задачи в отдельной виртуальной машине имеется целый ряд возможностей:

- Задачу можно выполнять по запросу непосредственно из приложения, отправляя запрос к конечной точке, которую предоставляет задача. При этом передаются все необходимые задаче данные. Эта конечная точка вызывает задачу.
- Можно настроить задачу для запуска по расписанию с помощью планировщика или таймера, доступных в выбранной операционной системе. Например, в Windows для выполнения сценариев и задач можно использовать планировщик заданий Windows. Если на виртуальной машине установлен SQL Server, для этой цели можно также использовать агент SQL Server.
- Запустить задачу с помощью планировщика Azure можно, добавив сообщение в очередь, которую задача прослушивает, или отправив запрос к API, предоставляемому задачей.

В предыдущем разделе [Триггеры](#triggers) вы можете ознакомиться с дополнительной информацией о том, как можно инициировать фоновые задачи.

### Рекомендации

Принимая решение о развертывании фоновых задач в виртуальной машине Azure, необходимо учитывать следующее:

- Размещение фоновых задач в отдельной виртуальной машине Azure обеспечивает гибкость и позволяет точно контролировать запуск, выполнение, планирование и распределение ресурсов. Тем не менее это увеличивает затраты времени выполнения, если виртуальную машину необходимо разворачивать только для фоновых задач.
- На портале Azure нет средств мониторинга задач и возможности автоматического перезапуска невыполненных задач, хотя можно отслеживать основные данные состояния виртуальной машины и управлять ею с помощью [командлетов управления службами Azure](http://msdn.microsoft.com/library/azure/dn495240.aspx). Однако не существует средств для управления процессами и потоками в вычислительных узлах. Как правило, использование виртуальной машины требует дополнительных усилий, чтобы реализовать механизм, который собирает данные из инструментария в задаче, а также из операционной системы в виртуальной машине. Одно из решений, которое может подойти, — использовать [пакет управления System Center для Azure](http://technet.microsoft.com/library/gg276383.aspx).
- Вы можете рассмотреть создание зондов мониторинга, предоставляемых через конечные точки HTTP. Код этих зондов может проверять работоспособность, собирать информацию об операциях и статистические данные или сопоставлять информацию об ошибках и возвращать ее в приложение управления. Дополнительную информацию см. в разделе [Шаблон мониторинга конечной точки работоспособности](http://msdn.microsoft.com/library/dn589789.aspx).

### Дополнительные сведения

- [Виртуальные машины в Azure](https://azure.microsoft.com/services/virtual-machines/)
- [Виртуальные машины Azure. Вопросы и ответы](virtual-machines/virtual-machines-linux-classic-faq.md)

## Рекомендации по проектированию

Существует несколько основных факторов, которые следует учитывать при проектировании фоновых задач. В следующих разделах рассматривается секционирование, конфликты и координация.

## Секционирование

Если вы решили включить фоновые задачи в существующий вычислительный экземпляр (например, веб-приложение, веб-роль, существующую рабочую роль или виртуальную машину), необходимо учесть, как это повлияет на атрибуты качества вычислительного экземпляра и саму фоновую задачу. Эти факторы помогут решить, следует ли совместно размещать задачи с существующим вычислительным экземпляром или выделить им отдельный вычислительный экземпляр:

- **Доступность**: фоновым задачам может не требоваться такой же уровень доступности, что и другим частям приложения, в частности, пользовательскому интерфейсу и другим частям, непосредственно участвующим во взаимодействии с пользователем. Фоновые задачи могут быть менее чувствительны к задержкам, сбоям при повторных подключениях и другим факторам, влияющим на доступность, так как операции могут быть поставлены в очередь. Однако требуются достаточные ресурсы, чтобы предотвратить накопление запросов, которые могут блокировать очереди и влиять на приложение в целом.
- **Масштабируемость**: вероятно, у фоновых задач будут разные требования к масштабируемости пользовательского интерфейса и интерактивных частей приложения. Масштабирование пользовательского интерфейса может потребоваться для обработки всплесков нагрузки по запросу, тогда как невыполненные фоновые задачи могут быть осуществлены в периоды меньшей загруженности меньшим числом вычислительных экземпляров.
- **Устойчивость**: сбой вычислительного экземпляра, в котором просто размещены фоновые задачи, может не привести к неустранимым последствиям для приложения в целом, если запросы на выполнение этих задач можно поставить в очередь или отложить, пока задача снова не будет доступна. Если за соответствующий интервал времени можно перезапустить вычислительный экземпляр и (или) задачи, на работе пользователей приложения это не отразится.
- **Безопасность**: у фоновых задач могут быть иные требования к безопасности или ограничения, чем у пользовательского интерфейса или других частей приложения. Используя отдельный вычислительный экземпляр, можно указать другую среду безопасности для задач. Также можно использовать шаблоны, например шаблон привратника, чтобы изолировать фоновые вычислительные экземпляры от пользовательского интерфейса. Это обеспечит максимальную безопасность и разделение.
- **Производительность**: можно выбрать тип вычислительного экземпляра для фоновых задач, соответствующий требованиям к производительности задач. Это может означать использование более дешевого варианта вычислений, если задачи не требуют таких же возможностей обработки, что и пользовательский интерфейс, либо использование более крупного экземпляра, если они требуют дополнительной емкости и ресурсов.
- **Управляемость**: у фоновых задач может быть иной темп разработки и развертывания, чем у кода или пользовательского интерфейса основного приложения. Их развертывание в отдельном вычислительном экземпляре может упростить обновление и управление версиями.
- **Стоимость**: добавление вычислительных экземпляров для выполнения фоновых задач увеличивает расходы на размещение. Необходимо тщательно обдумать компромисс между дополнительной емкостью и этими дополнительными затратами.

Дополнительные сведения см. в статье [Leader Election Pattern](http://msdn.microsoft.com/library/dn568104.aspx) (Шаблон выбора лидера) и [Competing Consumers Pattern](http://msdn.microsoft.com/library/dn568101.aspx) (Шаблон конкурирующих клиентов).

## Конфликты

Если имеется несколько экземпляров фонового задания, возможно, они будут конкурировать за доступ к ресурсам и службам, например базам данных и хранилищу. Такой одновременный доступ может привести к состязанию за ресурсы, что в состоянии вызвать конфликты доступности служб и целостности данных в хранилище. Состязание за ресурсы можно разрешить по принципу пессимистической блокировки, чтобы предотвратить одновременный доступ к службе конкурирующих экземпляров задачи или повреждение данных.

Другой метод разрешения конфликтов — определить фоновые задачи как единственный экземпляр, тогда в любой момент выполняться будет только один экземпляр. Однако это устраняет надежность и преимущества производительности, свойственные конфигурации с несколькими экземплярами, особенно в том случае, если пользовательский интерфейс может предоставить достаточный объем работы, чтобы загрузить несколько фоновых задач.

Крайне важно обеспечить, чтобы фоновая задача могла быть автоматически перезапущена и имела достаточно ресурсов, чтобы по запросу справиться со всплесками нагрузки. Этого можно достигнуть, выделив вычислительный экземпляр с достаточными ресурсами, реализовав механизм очередей, который может сохранять запросы для последующего выполнения, когда потребность уменьшится, или совместив эти методы.

## Координация

Фоновые задачи могут быть сложными и требовать выполнения нескольких отдельных задач для получения результата или для осуществления всех требований. Чаще всего в этих сценариях задача разделяется на более мелкие скрытые действия или подзадачи, которые могут быть выполнены несколькими объектами-получателями. Многошаговые задания могут быть более эффективными и гибкими, так как отдельные шаги можно многократно использовать в нескольких заданиях. Также можно легко добавлять и удалять шаги или изменять их порядок.

Координирование нескольких задач и шагов может оказаться сложной задачей, но существует три общих схемы, которые дозволено использовать для реализации решения:

- **Разложение задачи на несколько шагов, которые можно повторно использовать**. От приложения может потребоваться выполнение различных задач разной сложности с информацией, которую оно обрабатывает. Для осуществления такой обработки в виде неделимого модуля может применяться простой, но гибкий способ реализации этого приложения. Однако этот метод, вероятно, сократит возможности для рефакторинга кода, его оптимизации или повторного использования, если части одной и той же обработки потребуются в другом месте приложения. Дополнительную информацию см. в разделе [Шаблон каналов и фильтров](http://msdn.microsoft.com/library/dn568100.aspx).
- **Управление выполнением шагов для задачи**. Приложение может выполнять задачи, которые образуют ряд шагов, некоторые из которых в состоянии вызывать удаленные службы или обращаться к удаленным ресурсам. Отдельные шаги могут быть независимы друг от друга, но они подчиняются логике приложения, которая реализует задачу. Дополнительную информацию см. в разделе [Шаблон супервизора агента планировщика](http://msdn.microsoft.com/library/dn589780.aspx).
- **Управление восстановлением для шагов задания, завершившихся сбоем**. Приложению может потребоваться отменить работу, выполненную рядом шагов, которые вместе образуют согласованную операцию, если один или несколько шагов завершаются сбоем. Дополнительную информацию см. в разделе [Шаблон компенсации транзакций](http://msdn.microsoft.com/library/dn589804.aspx).

## Жизненный цикл (облачные службы)

 Если вы решили реализовать фоновые задания для приложений облачных служб, использующих веб-роли и рабочие роли, с помощью класса **RoleEntryPoint**, важно понимать жизненный цикл этого класса, чтобы правильно его использовать.

От запуска, выполнения и до остановки веб-роли и рабочие роли проходят ряд различных этапов. Класс **RoleEntryPoint** предоставляет ряд событий, указывающих, когда выполняются эти этапы. Они используются для инициализации, выполнения и остановки ваших настраиваемых фоновых задач. Ниже приведен полный цикл:

- Azure загружает сборку роли и ищет в ней класс, производный от **RoleEntryPoint**.
- При обнаружении данного класса вызывается **RoleEntryPoint.OnStart()**. Можно переопределить этот метод для инициализации своих фоновых задач.
- После завершения метода **OnStart** Azure вызывает **Application\_Start()** в глобальном файле приложения, если он присутствует (например Global.asax в веб-роли под управлением ASP.NET).
- Azure вызывает **RoleEntryPoint.Run()** для нового потока переднего плана, выполняющегося параллельно с **OnStart()**. Можно переопределить этот метод для запуска своих фоновых задач.
- После завершения метода Run Azure сначала вызывает **Application\_End()** в глобальном файле приложения, если он присутствует, а затем вызывает **RoleEntryPoint.OnStop()**. Вы можете переопределить метод **OnStop**, чтобы останавливать свои фоновые задачи, высвобождать ресурсы, удалять объекты и закрывать подключения, которые использовали задачи.
- Хост-процесс рабочей роли Azure останавливается. На этом этапе роль будет перезапущена.

Дополнительную информацию и примеры использования методов класса **RoleEntryPoint** см. в разделе [Шаблон консолидации вычислительных ресурсов](http://msdn.microsoft.com/library/dn589778.aspx).

## Рекомендации

При планировании способа выполнения фоновых задач в рабочей или веб-роли необходимо учитывать следующее:

- Используемая по умолчанию реализация метода **Run** в классе **RoleEntryPoint** содержит вызов **Thread.Sleep(Timeout.Infinite)**, который бесконечно проверяет активность роли. Если вы переопределяете метод **Run** (что обычно необходимо для выполнения фоновых задач), вы не должны допускать в коде выход из метода, если только не требуется перезапустить экземпляр роли.
- Типичная реализация метода **Run** содержит код для запуска каждой из фоновых задач и конструкцию цикла, которая периодически проверяет состояние всех фоновых задач. Она может перезапустить любую задачу, завершенную сбоем, или наблюдать за токенами отмены, свидетельствующими о завершении заданий.
- Если фоновая задача порождает необработанное исключение, она должна быть перезапущена, не мешая другим фоновым задачам в роли продолжать работу. Тем не менее, если исключение вызвано повреждением объектов вне задачи, например общего хранилища, оно должно быть обработано вашим классом **RoleEntryPoint**, все задачи должны быть отменены, а методу **Run** — разрешено завершение. После этого Azure перезапустит роль.
- Используйте метод **OnStop** для приостановки или уничтожения фоновых задач и высвобождения ресурсов. Для этого может потребоваться остановить продолжительные или многошаговые задания и как следует обдумать, как сделать это так, чтобы избежать несогласованности данных. Если экземпляр роли останавливается по любой причине, кроме инициированного пользователем завершения работы, код, выполняемый в методе **OnStop**, должен быть завершен в течение пяти минут, прежде чем это будет сделано принудительно. Убедитесь, что код может быть выполнен за это время он может не быть выполнен до завершения.
- Балансировщик нагрузки Azure начинает направлять трафик в экземпляр роли, когда метод **RoleEntryPoint.OnStart** возвращает значение **true**. Поэтому рекомендуется поместить весь код инициализации в метод **OnStart**, чтобы экземпляры роли, которые не инициализировались успешно, не получали никакого входящего трафика.
- В дополнение к методам класса **RoleEntryPoint** можно использовать задачи запуска. Задачи запуска следует использовать для инициализации любых параметров, которые необходимо изменить в балансировщике нагрузки Azure, так как эти задачи будут выполнены прежде, чем роль получит какие-либо запросы. Дополнительные сведения см. в статье [Как настроить и выполнить задачи запуска для облачной службы](./cloud-services/cloud-services-startup-tasks.md).
- Если в задаче запуска имеется ошибка, она вынудит роль постоянно перезапускаться. Это может помешать обратному переключению виртуального IP-адреса на предыдущую промежуточную версию, так как для переключения требуется монопольный доступ к роли, а это невозможно, пока роль перезапускается. Чтобы устранить эту проблему:
	-  Добавьте следующий код в начало методов **OnStart** и **Run** в роли:

	```C#
	var freeze = CloudConfigurationManager.GetSetting("Freeze");
	if (freeze != null)
	{
		if (Boolean.Parse(freeze))
	  	{
		    Thread.Sleep(System.Threading.Timeout.Infinite);
		}
	}
	```

   - Добавьте определение параметра **Freeze** как логическое значение в файлы ServiceDefinition.csdef и ServiceConfiguration.*.cscfg роли. Присвойте ему значение **false**. Если роль переходит в режим повторного перезапуска, можно изменить значение параметра на **true**, чтобы заморозить выполнение роли и позволить переключить ее на предыдущую версию.

## Рекомендации по обеспечению устойчивости

Фоновые задачи должны быть устойчивыми, чтобы предоставлять надежные службы для приложения. При планировании и проектировании фоновых задач необходимо учитывать следующее:

- Фоновые задачи должны иметь возможность корректно обрабатывать перезапуск службы или роли, не повреждая данные или внося несогласованность в приложение. Для длительных или многошаговых задач рассмотрите возможность использования _контрольных точек_: можно сохранять состояния заданий в постоянном хранилище или в виде сообщений в очереди, если это целесообразно. Например, можно сохранить сведения о состоянии в сообщении в очереди и постепенно обновлять их по мере выполнения задачи, чтобы задачу можно было обработать с последней известной корректной контрольной точки, а не перезапускать с самого начала. При использовании очередей служебной шины Azure этот сценарий реализуется с использованием сеансов обмена сообщениями. Сеансы позволяют сохранять и извлекать состояние обработки приложения с помощью методов [SetState](http://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.setstate.aspx) и [GetState](http://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.getstate.aspx). Дополнительные сведения о проектировании надежных многошаговых процессов и рабочих процессов см. в статье [Scheduler Agent Supervisor Pattern](http://msdn.microsoft.com/library/dn589780.aspx) (Шаблон супервизора агента планировщика).
- При использовании веб-ролей или рабочих ролей для размещения нескольких фоновых задач спроектируйте переопределение метода **Run**, чтобы наблюдать за завершенным сбоем или остановленными задачами и перезапускать их. Где это неудобно (и вы используете рабочую роль), принудительно перезапускайте рабочую роль с помощью выхода из метода **Run**.
- Если для взаимодействия с фоновыми задачами используются очереди, они могут выполнять роль буфера для хранения запросов, отправленных к задачам, когда нагрузка на приложение выше, чем обычно. Это позволяет задачам перехватывать пользовательский интерфейс во время периодов снижения загруженности. Также это означает, что перезапуск роли не будет блокировать пользовательский интерфейс. Дополнительную информацию см. в разделе [Шаблон балансировки нагрузки на основе очередей](http://msdn.microsoft.com/library/dn589783.aspx). Если некоторые задачи важнее, чем другие, рассмотрите возможность реализации [шаблона очереди с приоритетом](http://msdn.microsoft.com/library/dn589794.aspx), чтобы гарантировать выполнение этих задач раньше менее важных задач.
- В фоновых задачах, которые инициируются сообщениями или обрабатывают их, необходимо реализовать обработку несогласованностей, например сообщений, поступающих не по порядку, сообщений, повторно вызывающих ошибку (часто их называют _сообщениями о сбое_) и сообщений, доставляемых более одного раза. Рассмотрим следующее:
  - Сообщения, которые должны быть обработаны в определенном порядке, например те, что изменяют данные с учетом их существующего значения (например, добавляют значение к существующему значению), могут не поступить в первоначальном порядке, в котором были отправлены. Кроме того, они могут быть обработаны разными экземплярами фоновой задачи в другом порядке из-за различной нагрузки каждого экземпляра. Сообщения, которые должны быть обработаны в определенном порядке, должны содержать порядковый номер, ключ или другой индикатор, который фоновые задачи могут использовать, чтобы убедиться, что они обрабатываются в правильном порядке. При использовании служебной шины Azure, чтобы гарантировать порядок доставки, можно использовать сеансы обмена сообщениями. Однако обычно бывает целесообразнее спроектировать процесс таким образом, чтобы порядок сообщений не был важен.
  - Обычно фоновая задача считывает сообщения из очереди, которая временно скрывает их от других объектов-получателей сообщений и удаляет после успешной обработки. Если при обработке сообщения фоновой задачей произошел сбой, по истечении времени ожидания считывания оно снова появится в очереди и будет обработано другим экземпляром задачи или во время следующего цикла обработки данного экземпляра. Если сообщение постоянно приводит к ошибке в объекте-получателе, оно заблокирует задачу, очередь и, в конечном счете, само приложение, когда очередь заполнится. Поэтому крайне важно выявлять и удалять из очереди сообщения о сбое. При использовании служебной шины Azure сообщения, вызвавшие ошибку, можно автоматически или вручную перемещать в связанную очередь недоставленных сообщений.
  - Очереди регулируются механизмами доставки _хотя бы один раз_, но они могут доставлять одно и то же сообщение несколько раз. Кроме того, если сбой происходит после обработки сообщения фоновой задачей, но перед его удалением из очереди, сообщение станет доступным для повторной обработки. Фоновые задачи должны быть идемпотентными. Это означает, что повторная обработка одного и того же сообщения не вызывает ошибку или несогласованность в данных приложения. Некоторые операции идемпотентны по своему характеру. Например, задание определенного нового значения для сохраненного значения. Однако такие операции, как добавление значения к существующему хранимому значению без проверки, осталось ли сохраненное значение таким же, как при изначальной отправке сообщения, приведут к несогласованности. Очереди служебной шины Azure можно настроить для автоматического удаления повторяющихся сообщений.
  - Некоторые системы обмена сообщениями, например очереди хранилища Azure и очереди служебной шины Azure, поддерживают свойство количества выводов из очереди, указывающее, сколько раз сообщение было считано из очереди. Это может быть удобно для обработки повторяющихся сообщений и сообщений о сбое. Дополнительную информацию см. в разделах [Учебник по асинхронному обмену сообщениями](http://msdn.microsoft.com/library/dn589781.aspx) и [Шаблоны идемпотентности](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/).

## Рекомендации по производительности и масштабированию

Фоновые задачи должны обеспечивать достаточную производительность, чтобы не блокировать работу приложения и не приводить к несогласованности из-за отложенных операций, когда система находится под нагрузкой. Как правило, производительность повышается за счет масштабирования вычислительных экземпляров, в которых размещены фоновые задачи. При планировании и проектировании фоновых задач необходимо учитывать следующие моменты, связанные с масштабируемостью и производительностью:

- Azure поддерживает автоматическое масштабирование (увеличение масштаба, а затем его уменьшение) на основе текущих запросов и загрузки или на основе предопределенного расписания для веб-приложений, веб-ролей и рабочих ролей облачных служб, а также развертываний, размещенных на виртуальных машинах. Эту функцию можно использовать, чтобы обеспечить приложение в целом достаточными возможностями производительности, минимизируя затрачиваемое время выполнения.
- Когда у фоновых задач иные возможности производительности, чем у других частей приложения облачных служб (например, пользовательского интерфейса или таких компонентов, как уровень доступа к данным), размещение фоновых задач вместе в отдельной рабочей роли позволяет независимо масштабировать роли пользовательского интерфейса и фоновых задач, чтобы управлять нагрузкой. Если возможности производительности нескольких фоновых задач значительно отличаются друг от друга, рекомендуется выделить их в отдельные рабочие роли и масштабировать независимо друг от друга. Однако обратите внимание, что это может увеличить затрачиваемое время выполнения по сравнению с объединением всех задач в меньшее число ролей.
- Просто масштабировать роли может оказаться недостаточно, чтобы предотвратить потерю производительности под нагрузкой. Также может потребоваться масштабировать очереди хранилища и другие ресурсы, чтобы не дать одной точке в общей цепочке обработки стать узким местом. Также рассмотрите другие ограничения, например максимальную пропускную способность хранилища и других служб, от которых зависит приложение и фоновые задачи.
- Фоновые задачи должен быть предназначены для масштабирования. Например, они должны иметь возможность динамически определять количество используемых очередей хранилища, чтобы прослушивать или отправлять сообщения в соответствующую очередь.
- По умолчанию веб-задания масштабируются вместе с соответствующим экземпляром веб-приложений Azure. Тем не менее, если требуется, чтобы веб-задание выполнялось только в одном экземпляре, можно создать файл Settings.job, содержащий данные JSON **{ "is\_singleton": true }**. Это заставит Azure запускать только один экземпляр веб-задания, даже если имеется несколько экземпляров связанного веб-приложения. Этот метод удобно использовать для запланированных заданий, которые должны выполняться только в одном экземпляре.

## Связанные шаблоны

- [Учебник по асинхронному обмену сообщениями](http://msdn.microsoft.com/library/dn589781.aspx)
- [Руководство по автоматическому масштабированию](http://msdn.microsoft.com/library/dn589774.aspx)
- [Шаблон компенсации транзакций](http://msdn.microsoft.com/library/dn589804.aspx)
- [Шаблон конкурирующих потребителей](http://msdn.microsoft.com/library/dn568101.aspx)
- [Рекомендации по разделению вычислений](http://msdn.microsoft.com/library/dn589773.aspx)
- [Шаблон консолидации вычислительных ресурсов](http://msdn.microsoft.com/library/dn589778.aspx)
- [Шаблон привратника](http://msdn.microsoft.com/library/dn589793.aspx)
- [Шаблон выбора лидера](http://msdn.microsoft.com/library/dn568104.aspx)
- [Шаблон каналов и фильтров](http://msdn.microsoft.com/library/dn568100.aspx)
- [Шаблон очереди с приоритетом](http://msdn.microsoft.com/library/dn589794.aspx)
- [Шаблон балансировки нагрузки на основе очередей](http://msdn.microsoft.com/library/dn589783.aspx)
- [Шаблон супервизора агента планировщика](http://msdn.microsoft.com/library/dn589780.aspx)

## Дополнительные сведения

- [Масштабирование приложений Microsoft Azure с использованием рабочих ролей](http://msdn.microsoft.com/library/hh534484.aspx#sec8)
- [Выполнение фоновых задач](http://msdn.microsoft.com/library/ff803365.aspx)
- [Жизненный цикл запуска роли Azure](http://blog.syntaxc4.net/post/2011/04/13/windows-azure-role-startup-life-cycle.aspx) (запись блога)
- [Жизненный цикл роли облачных служб Azure](http://channel9.msdn.com/Series/Windows-Azure-Cloud-Services-Tutorials/Windows-Azure-Cloud-Services-Role-Lifecycle) (видео)
- [Начало работы с пакетом SDK для Azure для веб-заданий](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)
- [Очереди Azure и очереди служебной шины: сходства и различия](./service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted.md)
- [Включение диагностики в облачной службе](./cloud-services/cloud-services-dotnet-diagnostics.md)

<!---HONumber=AcomDC_0928_2016-->