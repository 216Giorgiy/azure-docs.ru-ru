

<properties linkid="develop-mobile-tutorials-handle-conflcits-offline-data-dotnet" urlDisplayName="Обработка конфликтов с автономными данными" pageTitle="Обработка конфликтов с автономными данными в мобильных службах (Магазин Windows) | Центр разработчиков для мобильных служб" metaKeywords="" description="Узнайте, как обрабатывать конфликты с автономными данными в приложении Магазина Windows" metaCanonical="" disqusComments="1" umbracoNaviHide="1" documentationCenter="Mobile" title="Обработка конфликтов с автономными данными в мобильных службах" authors="wesmc" />


# Обработка конфликтов с автономными данными в мобильных службах

<div class="dev-center-tutorial-selector sublanding">
<a href="/ru-ru/documentation/articles/mobile-services-windows-store-dotnet-handling-conflicts-offline-data" title="Магазин Windows C#" class="current">Магазин Windows C#</a>
</div>


<p>В этом разделе показано, как синхронизировать данные и обрабатывать конфликты при использовании возможностей автономной работы мобильных служб Windows Azure. В этом учебнике вам предстоит загрузить приложение, которое поддерживает автономные и оперативные данные, интегрировать мобильную службу с приложением, а затем выполнить вход на портал управления Windows Azure для просмотра и обновления базы данных в ходе выполнения приложения.
</p>

Этот учебник основан на инструкциях и примере приложения предыдущего учебника [Приступая к работе с автономными данными]. Перед началом работы с учебником необходимо пройти задания учебника [Приступая к работе с автономными данными].


В этом учебнике рассматриваются следующие основные действия:

1. [Загрузка проекта приложения для Магазина Windows] 
2. [Добавление столбца даты выполнения для базы данных]
  * [Обновление базы данных для серверных мобильных служб .NET]  
  * [Обновление базы данных для мобильных служб JavaScript]  
3. [Тестирование приложения с мобильной службой]
4. [Ручное обновление данных в серверной части для создания конфликта]

Для этого учебника требуется среда Visual Studio 2013 в Windows 8.1.


## <a name="download-app"></a>Загрузить пример проекта

Этот учебник построен на [примере кода обработки конфликтов], который является проектом приложения Магазина Windows в Visual Studio 2013. Пользовательский интерфейс этого приложения аналогичен приложению в учебнике [Приступая к работе с автономными данными] за исключением того, что для каждого элемента TodoItem существует новый столбец даты. 

1. Загрузите [примере кода обработки конфликтов] на C#. 

2. Установите [решение SQLite для Windows 8.1], если оно не установлено.

3. В Visual Studio 2013 откройте загруженный проект. Нажмите клавишу **F5** для повторного построения проекта, после чего запустите приложение.

4. В приложении введите какой-либо текст в поле **Вставить в TodoItem**, а затем нажмите кнопку **Сохранить**. Вы также можете изменить дату выполнения добавляемых элементов списка дел.

Обратите внимание, что приложение еще не подключено к мобильной службе, поэтому кнопки **Push** и **Pull** будут вызывать исключения.


## <a name="add-column"></a>Добавление столбца в модель данных

В этом разделе вы обновите базу данных, чтобы добавить таблицу TodoItem со столбцом даты выполнения в мобильную службу. Приложение позволяет изменить дату выполнения для элемента во время выполнения, чтобы создавать конфликты синхронизации в следующем разделе данного учебника. 

Класс `TodoItem` в этом примере определяется в файле MainPage.xaml.cs. Обратите внимание, что класс содержит следующий атрибут, который используется для операций синхронизации для этой таблицы.

        [DataTable("TodoWithDate")]

Добавьте эту таблицу в базу данных.

### <a name="dotnet-backend"></a>Обновление базы данных для серверных мобильных служб .NET 

Если вы используете серверную часть .NET для мобильной службы, выполните следующие действия для обновления схемы базы данных.

1. Откройте проект мобильной службы для .NET в Visual Studio.
2. В обозревателе решений в Visual Studio в проекте службы разверните папку **Модели** и откройте файл ToDoItem.cs. Добавьте свойство `DueDate`, как показано ниже.

          public class TodoItem : EntityData
          {
            public string Text { get; set; }
            public bool Complete { get; set; }
            public System.DateTime DueDate { get; set; }
          }


3. В обозревателе решений в Visual Studio разверните папку **App_Start**, а затем откройте файл WebApiConfig.cs. 

    В файле WebApiConfig.cs обратите внимание, что класс инициализатора базы данных по умолчанию является производным от класса `DropCreateDatabaseIfModelChanges`. Это означает, что любое изменение модели приведет в таблице к его удалению и повторному созданию в соответствии с новой моделью. Таким образом данные в таблице будут потеряны, а таблица будет повторно заполнена. Измените метод Seed инициализатора базы данных таким образом, чтобы функция инициализации `Seed()` инициализировала новый столбец DueDate, как показано ниже. Сохраните файл WebApiConfig.cs.

    >[WACOM.NOTE] Когда используется инициализатор базы данных по умолчанию, Entity Framework будет удалять и заново создавать базу данных всякий раз при обнаружении изменения модели данных в определении модели Code First. Чтобы сделать это изменение модели данных и сохранить существующие данные в базе данных, необходимо использовать Code First Migrations. Дополнительные сведения см. в разделе [Как использовать Code First Migrations для обновления модели данных](./articles/mobile-services-dotnet-backend-use-code-first-migrations).


        new TodoItem { Id = "1", Text = "First item", Complete = false, DueDate = DateTime.Today },
        new TodoItem { Id = "2", Text = "Second item", Complete = false, DueDate = DateTime.Today },

          

4. В обозревателе решений в Visual Studio разверните папку **Контроллеры** и откройте файл ToDoItemController.cs. Переименуйте класс `TodoItemController` в `TodoWithDateController`. Это приведет к изменению конечной точки REST для табличных операций. 

        public class TodoWithDateController : TableController<TodoItem>
    

5. В обозревателе решений в Visual Studio щелкните правой кнопкой мыши проект мобильной службы для .NET и выберите пункт **Опубликовать** для публикации изменений.


### <a name="javascript-backend"></a>Обновление базы данных для серверных мобильных служб JavaScript

Для мобильных служб, использующих серверную часть JavaScript, вы добавите новую таблицу с именем **TodoWithDate**. Для добавления таблицы **TodoWithDate** для мобильных служб, использующих серверную часть JavaScript, выполните следующие действия.

  1. Выполните вход на [портал управления Azure]. 

  2. Перейдите на вкладку **Данные** мобильной службы. 

  3. Щелкните **Создать** в нижней части страницы, а затем создайте таблицу с именем **TodoWithDate**. 


## <a name="test-app"></a>Тестирование приложения с мобильной службой

Теперь пришло время проверить работу приложения с мобильными службами.

1. На портале управления Azure найдите ключ приложения мобильной службы, нажав кнопку **Управление ключами** на панели команд. Скопируйте **ключ приложения**.

2. В обозревателе решений в Visual Studio откройте файл App.xaml.cs в проекте примера клиентского приложения. Добавьте в инициализацию **MobileServiceClient** URL-адрес вашей мобильной службы и ключ приложения:

         public static MobileServiceClient MobileService = new MobileServiceClient(
            "https://your-mobile-service.azure-mobile.net/",
            "Your AppKey"
        );

3. В Visual Studio нажмите клавишу **F5**, чтобы построить и запустить приложение..

4. Как и ранее, введите текст в текстовом поле и нажмите кнопку **Сохранить**. При этом данные сохраняются в локальной таблице синхронизации, но не на сервере.

    ![][0]

5. Для просмотра текущего состояния базы данных войдите на [портал управления Azure], щелкните **Мобильные службы** и выберите вашу мобильную службу.

  * Если вы используете серверную часть JavaScript для мобильной службы, откройте вкладку **Данные**, а затем щелкните таблицу **TodoWithDate**. Нажмите кнопку **Обзор** чтобы убедиться, что таблица по-прежнему пуста, так как мы не передали изменения из приложения на сервер.

        ![][1]

  *  Если вы используете серверную часть .NET для мобильной службы, откройте вкладку **Настройка**, а затем щелкните базу данных SQL. Нажмите кнопку **Управление** в нижней части экрана, чтобы войти на портал управления SQL Azure для просмотра базы данных.  

        ![][2]
   	 

7. Вернитесь в приложение и нажмите кнопку **Push**.

8. На портале управления щелкните **Обновить** для таблицы **TodoItem**. Теперь вы увидите данные, введенные в приложении.

   	![][3]

## <a name="handle-conflict"></a>Обновление данных в серверной части для создания конфликта

В реальной ситуации конфликт синхронизации происходит, когда одно приложение передает обновления записи в базе данных, при этом другое приложение пытается изменить ту же запись на основе устаревшей версии записи. Если экземпляр приложения пытается обновить ту же запись без извлечения обновленной записи, возникает конфликт, который будет зафиксирован в приложении как исключение `MobileServicePreconditionFailedException`.  

Чтобы развернуть приложение на другом компьютере для запуска двух экземпляров приложения и создания конфликта, необходимо выполнить инструкции по развертыванию в учебнике [Обработка конфликтов базы данных].

Ниже показано, как обновить базу данных в Visual Studio, чтобы вызвать конфликт.

1. В Visual Studio запустите обозреватель серверов и подключитесь к учетной записи Azure. Разверните узел **Базы данных SQL** для учетной записи Azure.
 
    ![][5]
 
   
2. Щелкните базу данных SQL правой кнопкой и выберите пункт **Открыть в обозревателе объектов SQL Server**.
3. В обозревателе объектов SQL Server разверните базу данных и узел **Таблицы**. Щелкните правой кнопкой мыши таблицу **TodoWithDate** и выберите **Просмотреть данные**. 


4. Задайте в поле **complete** для одного из элементов значение True.

    ![][6]

5. Вернитесь в приложение Todo и измените тот же элемент, который вы изменили в базе данных.

    ![][7]

6. Нажмите кнопку **Push**. Появится диалоговое окно с вопросом о том, как разрешить конфликт. Выберите один из способов разрешения конфликта.

    ![][8]

## Проверка кода для обработки конфликтов синхронизации

Чтобы настроить автономный компонент для обнаружения конфликтов, необходимо добавить столбец версии в локальную базу данных и в объект передачи данных. Класс `TodoItem` содержит следующий элемент:

        [Version]
        public string Version { get; set; }

Столбец `__version` также указан в локальной базе данных в методе `OnNavigatedTo()`.

Для обработки конфликтов автономной синхронизации в коде создайте класс, реализующий интерфейс `IMobileServiceSyncHandler`. Передайте объект данного типа в вызове метода `InitializeAsync`:

     await App.MobileService.SyncContext.InitializeAsync(store, new SyncHandler(App.MobileService));

Класс `SyncHandler` в файле **MainPage.xaml.cs** реализует интерфейс `IMobileServiceSyncHandler`. Метод `ExecuteTableOperationAsync` вызывается при каждой отправке операции push на сервер. Если возникает исключение типа `MobileServicePreconditionFailedException`, возник конфликт между локальной и удаленной версиями элемента.

Для разрешения конфликта в пользу локального элемента следует просто повторить операцию. После возникновения конфликта локальная версия элемента будет обновлена в соответствии с версией на сервере, поэтому повторное выполнение операции приведет к замене изменений на сервере на локальные изменения:

    await operation.ExecuteAsync(); 

Для разрешения конфликта в пользу серверного элемента следует просто выйти из метода `ExecuteTableOperationAsync`. Локальная версия объекта будет удалена и заменена значением с сервера.

Чтобы остановить операцию push (но сохранить изменения в очереди), используйте метод `AbortPush()`:

    operation.AbortPush();

При этом текущая операция push будет остановлена, но все ожидающие изменения будут сохранены, в том числе текущая операция, если метод `AbortPush` вызывается из `ExecuteTableOperationAsync`. При следующем вызове метода `PushAsync()` эти изменения будут отправлены на сервер. 

При отмене операции push метод `PushAsync` создаст исключение `MobileServicePushFailedException`, а у свойства `PushResult.Status` исключения будет значение `MobileServicePushStatus.CancelledByOperation`. 


<!-- Anchors. -->
[Загрузка проекта приложения для Магазина Windows]: #download-app
[Создание мобильной службы]: #create-service
[Добавление столбца даты выполнения для базы данных]: #add-column
[Обновление базы данных для серверных мобильных служб .NET]: #dotnet-backend  
[Обновление базы данных для мобильных служб JavaScript]: #javascript-backend
[Тестирование приложения с мобильной службой]: #test-app
[Ручное обновление данных в серверной части для создания конфликта]: #handle-conflict
[Дальнейшие действия]:#next-steps

<!-- Images -->
[0]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-handling-conflicts-app-run1.png
[1]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-todowithdate-empty.png
[2]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-todowithdate-empty-sql.png
[3]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-todowithdate-push1.png
[4]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-todowithdate-design-edit.png
[5]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-server-explorer.png
[6]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-sql-server-object-explorer-update-data.png
[7]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-handling-conflicts-app-run2.png
[8]: ./media/mobile-services-windows-store-dotnet-handling-conflicts-offline-data/mobile-services-handling-conflicts-app-run3.png




<!-- URLs -->
[примере кода обработки конфликтов]: http://go.microsoft.com/fwlink/?LinkId=394787
[Приступая к работе с мобильными службами]: /ru-ru/documentation/articles/mobile-services-windows-store-get-started/
[Приступая к работе с автономными данными]: /ru-ru/documentation/articles/mobile-services-windows-store-dotnet-get-started-offline-data
[решение SQLite для Windows 8.1]: http://go.microsoft.com/fwlink/?LinkId=394776
[Портал управления Azure]: https://manage.windowsazure.com/
[Обработка конфликтов базы данных]: /ru-ru/documentation/articles/mobile-services-windows-store-dotnet-handle-database-conflicts/#test-app

