<properties
	pageTitle="Резервное копирование виртуальной машины Azure — резервное копирование"
	description="Узнайте, как создать резервную копию виртуальной машины Azure после регистрации"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="04/30/2015"
	ms.author="aashishr"/>


# Резервное копирование виртуальной машины Azure

Эта статья представляет собой базовое руководство по резервному копированию виртуальных машин Azure. Перед тем как продолжить, убедитесь в выполнении всех [необходимых условий][prereq].

Резервное копирование виртуальных машин Azure состоит из трех основных шагов.

![Три шага для резервного копирования виртуальной машины Azure][three-steps]

## Обнаружение виртуальных машин Azure
В ходе процесса обнаружения в Azure запрашивается список виртуальных машин в подписке, а также дополнительные сведения, например имя облачной службы и регион.

> [AZURE.NOTE]Процесс обнаружения всегда должен выполняться на первом шаге. Это гарантирует идентификацию всех новых виртуальных машин, добавленных в подписку.

Для запуска процесса обнаружения выполните следующие действия.

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.

2. Выберите тип рабочей нагрузки в выпадающем меню как **Виртуальная машина Azure** и нажмите кнопку **Выбрать**. ![выбор рабочей нагрузки][select-workload]

3. Нажмите кнопку **Обнаружить**, расположенную в нижней части страницы. ![кнопка обнаружения][discover-button]

4. Процесс обнаружения может занять несколько минут, в это время виртуальные машины будут заноситься в таблицу. Во время процесса обнаружения в нижней части экрана отображается всплывающее уведомление. ![обнаружение виртуальных машин][discover-vms]

5. После завершения процесса обнаружения появляется всплывающее уведомление. ![обнаружение выполнено][discover-done]

<br><br>
## Регистрация виртуальных машин Azure
Для того чтобы защитить виртуальную машину, ее необходимо предварительно зарегистрировать в службе резервного копирования Azure. Процесс регистрации преследует две главные цели:

1. подключение расширения резервного копирования к агенту ВМ в виртуальной машине;

2. связывание виртуальной машины со службой резервного копирования Azure.

Регистрация обычно выполняется однократно. Служба резервного копирования Azure легко обрабатывает обновления и исправления расширения резервного копирования без необходимости трудоемкого вмешательства пользователя. Это освобождает пользователя от расходов по управлению агентом, которые обыкновенно сопровождают продукты для резервного копирования.

### Регистрация виртуальных машин

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**. 

2. Выберите тип рабочей нагрузки в выпадающем меню как **Виртуальная машина Azure** и нажмите кнопку "Выбрать". ![выбор рабочей нагрузки][select-workload]

3. Нажмите кнопку **Зарегистрировать**, расположенную в нижней части страницы. ![кнопка регистрации][register-button]

4. Во всплывающем окне **Регистрация элементов** выберите виртуальные машины, которые необходимо зарегистрировать. При наличии двух или нескольких виртуальных машин с одинаковым именем используйте облачную службу, чтобы их различить.

  	Операция **регистрации** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно сокращает однократные усилия, которые затрачиваются на подготовку виртуальных машин для резервного копирования.

  	> [AZURE.NOTE]Здесь будут отображаться только незарегистрированные виртуальные машины, которые находятся в одном регионе с резервным хранилищем.

  	![Список виртуальных машин для регистрации][register-vms]

5. Задание создается для каждой виртуальной машины, которую необходимо зарегистрировать. Всплывающее уведомление отображает состояние этого действия. Щелкните **Просмотр задания**, чтобы перейти на страницу **Задания**. ![задание регистрации][register-job]

6. Виртуальная машина также появляется в списке зарегистрированных элементов, и отображается состояние операции регистрации. ![Состояние регистрации 1][register-status1]

7. После завершения операции состояние на портале изменяется, чтобы отразить зарегистрированное состояние. ![Состояние регистрации 2][register-status2]

<br><br>
## Резервное копирование виртуальной машины Azure
Этот шаг включает в себя настройку политики резервного копирования и хранения для виртуальной машины. Чтобы защитить виртуальную машину, выполните следующие действия.

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.  

2. Выберите тип рабочей нагрузки в выпадающем меню как **Виртуальная машина Azure** и нажмите кнопку "Выбрать". ![Выберите рабочую нагрузку на портале][select-workload]

3. Нажмите кнопку **Защита**, расположенную в нижней части страницы.

4. Появится мастер **защиты элементов**, где можно выбрать виртуальные машины, которые необходимо защитить. При наличии двух или нескольких виртуальных машин с одинаковым именем используйте облачную службу, чтобы их различить. Операция **защиты** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно уменьшает усилия, затраченные на защиту виртуальных машин.

	> [AZURE.NOTE]Здесь будут отображаться только виртуальные машины, которые были правильно зарегистрированы в службе резервного копирования Azure и находятся в одном регионе с резервным хранилищем.

	![Выберите элементы для защиты][protect-wizard1]

5. На втором экране мастера **защиты элементов** выберите политику резервного копирования и хранения для резервного копирования выбранных виртуальных машин. Выберите политику из существующего набора или создайте новую.

	> [AZURE.NOTE]В предварительной версии поддерживается хранение в течение 30 дней и максимум одно резервное копирование в день.

	![Выберите политику защиты][protect-wizard2]

	В каждом резервном хранилище можно иметь несколько политик резервного копирования. Политики отражают сведения о том, как должно планироваться выполнение резервных копий и обеспечиваться их сохранение. Например, одна политика резервного копирования может использоваться для ежедневного резервного копирования в 10:00 вечера, в то время как другая политика может обеспечивать еженедельное резервное копирование в 6:00 утра. Несколько политик резервного копирования обеспечивают гибкость при планировании создания резервных копий для инфраструктуры виртуальных машин. Каждая политика резервного копирования может иметь несколько связанных с ней виртуальных машин. В каждый данный момент времени виртуальная машина может быть связана только с одной политикой.

6. Чтобы настроить политику защиты и связать виртуальные машины с этой политикой, для каждой виртуальной машины  создается задание. Щелкните вкладку **Задания** и выберите необходимый фильтр для просмотра списка заданий **настройки защиты**. ![Настройка задания защиты][protect-configure]

7. После завершения операции виртуальные машины защищены с помощью политики и должны ожидать запланированное время резервного копирования для создания начальной резервной копии. Виртуальная машина теперь появится в списке на вкладке **Защищенные элементы** и будет иметь состояние защиты со значением *защищена* \(ожидание начальной резервной копии\).

	> [AZURE.NOTE]Параметр запуска начального  резервного копирования сразу после настройки защиты в настоящее время недоступен.

8. В запланированное время служба резервного копирования Azure создает задание резервного копирования для каждой виртуальной машины, для которой необходимо создать резервную копию. Щелкните вкладку **Задания**, чтобы просмотреть список заданий **резервного копирования**. В качестве части операции резервного копирования служба резервного копирования Azure выдает команду расширению резервного копирования в каждой виртуальной машине, чтобы сохранить на диск все данные операций записи и сделать согласованный моментальный снимок. ![Выполняется резервное копирование][protect-inprogress]

9. После завершения операции состояние защиты виртуальной машины на вкладке **Защищенные элементы** отображается как *Защищена*. ![Резервное копирование виртуальной машины с точкой восстановления][protect-backedup]


## Просмотр состояния резервного копирования и сведений
После обеспечения защиты число виртуальных машин также увеличивается на странице сводки **Панели мониторинга**. Кроме того, на странице панели мониторинга отображается количество успешных, завершившихся сбоем и все еще выполняемых заданий за последние 24 часа. Щелчок любой из категорий позволяет получить детальные сведения о ней на странице **Задания**. ![Состояние резервного копирования на странице панели мониторинга][dashboard]


## Устранение ошибок
Для устранения проблем обнаружения и регистрации можно использовать следующие сведения.

| Операция резервного копирования | Сведения об ошибке | Возможное решение |
| -------- | -------- | -------|
| Обнаружение | Не удалось обнаружить новые элементы — в службе резервного копирования Microsoft Azure произошла внутренняя ошибка. Подождите несколько минут и повторите попытку. | Повторите процесс обнаружения через 15 минут.
| Обнаружение | Не удалось обнаружить новые элементы — уже выполняется другая операция обнаружения. Дождитесь завершения текущей операции обнаружения. | Дождитесь завершения выполняющейся операции обнаружения. |
| Зарегистрировать | Роль ВМ Azure не находится в состоянии для установки расширения — убедитесь, что виртуальная машина находится в состоянии выполнения. Расширение служб восстановления Azure требует, чтобы виртуальная машина работала. | Запустите виртуальную машину и после ее перехода в состояние выполнения повторите попытку регистрации.|


## Целостность данных в точках восстановления
При работе с резервной копией данных клиентов волнует поведение виртуальной машины после ее восстановления. Ниже приведены типичные вопросы, которые задают клиенты.

+ Будет ли виртуальная машина загружаться?

+ Будут ли данные доступны на диске? Какие-либо данные потеряны?

+ Сможет ли приложение считывать данные? Какие-либо данные повреждены?

+ Будут ли данные иметь смысл для приложения? Будут ли данные являться согласованными при чтении их приложением?

В следующей таблице описываются типы целостности и согласованности данных, встречающиеся во время резервного копирования и восстановления ВМ Azure:

| Целостность | На базе службы VSS | Подробное объяснение |
|-------------|-----------|---------|
| Целостность на уровне приложения | Да | Это идеальное место для рабочих нагрузок Майкрософт, которое гарантирует следующее:<ol><li> ВМ *загружается*; <li>нет *повреждений данных*; <li>нет *потери данных*; <li> данные являются согласованными с приложением, которое их использует, за счет привлечения приложения к выполнению резервного копирования — использование VSS.</ol> Служба снимков тома \(VSS\) обеспечивает правильную запись данных в хранилище. Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных. Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных.<br><br> Для резервного копирования виртуальных машин Azure получение точки восстановления с согласованными данными означает, что расширение резервного копирования имело возможность вызвать рабочий процесс VSS и *корректно* завершить его до выполнения моментального снимка ВМ. Естественно, это означает, что модули записи VSS всех приложений на виртуальной машине Azure были также вызваны.<br><br>Познакомьтесь с [основами службы VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx), подробно изучите [принцип ее работы](https://technet.microsoft.com/ru-ru/library/cc785914%28v=ws.10%29.aspx). |
| Целостность на уровне файловой системы | Да, для компьютеров Windows | Существует два сценария, в которых целостность данных в точке восстановления может зависеть от файловой системы.<ul><li>Резервное копирование виртуальных машин Linux в Azure, поскольку Linux не имеет аналогичной платформы для VSS.<li>Сбой службы VSS во время резервного копирования для виртуальных машин Windows в Azure.</li></ul> В обоих этих случаях лучшее, что можно сделать, — это обеспечить следующее: <ol><li> ВМ *загружается*; <li>нет *повреждений данных*; <li>нет *потери данных*.</ol> Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных.|
| Отказоустойчивость | Нет | Такая ситуация аналогична сбою компьютера \(приводит к программной или аппаратной перезагрузке\). Нет никакой гарантии целостности и согласованности данных на носителях данных. Во время резервного копирования выполняется архивация только тех данных, которые уже существуют на диске. <ol><li>Однако в большинстве случаев нет гарантии, что ОС загрузится.<li>Обычно после этого выполняется процедура проверки диска \(например, chkdsk\) для исправления любых ошибок, связанных с его повреждением.<li> Будут потеряны все данные, которые не были записаны на диск.<li> В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки. </ol>В контексте резервного копирования виртуальной машины Azure отказоустойчивая точка восстановления означает, что служба резервного копирования Azure не предоставляет никаких гарантий в отношении целостности и согласованности данных в хранилище — ни с точки зрения операционной системы, ни с точки зрения приложения. Обычно это происходит при завершении работы виртуальной машины Azure во время резервного копирования.<br><br>Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до согласованных данных. При работе с данными, которые распределены между несколькими виртуальными дисками \(например, составные тома\), отказоустойчивые точки восстановления не гарантируют правильность данных.|



## Дальнейшие действия
Дополнительные сведения о начале работы с резервным копированием Azure см. в разделе:

- [Восстановление виртуальных машин](backup-azure-restore-vms.md)

[three-steps]: ./media/backup-azure-vms/3-steps-for-backup.png
[select-workload]: ./media/backup-azure-vms/discovery-select-workload.png
[discover-button]: ./media/backup-azure-vms/discover-button.png
[discover-vms]: ./media/backup-azure-vms/discovering-vms.png
[discover-done]: ./media/backup-azure-vms/discovery-complete.png
[register-button]: ./media/backup-azure-vms/register-button.png
[register-job]: ./media/backup-azure-vms/register-create-job.png
[register-vms]: ./media/backup-azure-vms/register-popup.png
[register-status1]: ./media/backup-azure-vms/register-status01.png
[register-status2]: ./media/backup-azure-vms/register-status02.png
[select-workload]: ./media/backup-azure-vms/select-workload.png
[protect-wizard1]: ./media/backup-azure-vms/protect-wizard1.png
[protect-wizard2]: ./media/backup-azure-vms/protect-wizard2.png
[protect-configure]: ./media/backup-azure-vms/protect-configureprotection.png
[protect-inprogress]: ./media/backup-azure-vms/protect-inprogress.png
[protect-backedup]: ./media/backup-azure-vms/protect-backedupvm.png
[dashboard]: ./media/backup-azure-vms/dashboard-protectedvms.png
[prereq]: http://azure.microsoft.com/documentation/articles/backup-azure-vms-introduction/#prerequisites

<!--HONumber=54-->