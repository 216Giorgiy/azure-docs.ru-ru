<properties
	pageTitle="Резервное копирование виртуальной машины Azure — резервное копирование"
	description="Узнайте, как создать резервную копию виртуальной машины Azure после регистрации"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="05/26/2015"
	ms.author="aashishr"/>


# Резервное копирование виртуальных машин Azure

Эта статья представляет собой базовое руководство по резервному копированию виртуальных машин Azure. Перед тем как продолжить, убедитесь в выполнении всех [необходимых условий](backup-azure-vms-introduction.md#prerequisites).

Резервное копирование виртуальных машин Azure состоит из трех основных шагов.

![Три шага для резервного копирования виртуальной машины Azure](./media/backup-azure-vms/3-steps-for-backup.png)

## Обнаружение виртуальных машин Azure
Запросы процесс обнаружения Azure список виртуальных машин в подписке, а также дополнительные сведения, такие как имя облачной службы и области.

> [AZURE.NOTE]Процесс обнаружения всегда должен выполняться на первом шаге. Это гарантирует идентификацию всех новых виртуальных машин, добавленных в подписку.

Для запуска процесса обнаружения выполните следующие действия.

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.

2. Выберите тип рабочей нагрузки в выпадающем меню как **Виртуальная машина Azure** и нажмите кнопку **Выбрать**. ![выбор рабочей нагрузки](./media/backup-azure-vms/discovery-select-workload.png)

3. Щелкните **DISCOVER** расположенную в нижней части страницы. ![кнопка обнаружения](./media/backup-azure-vms/discover-button.png)

4. Процесс обнаружения может занять несколько минут, в это время виртуальные машины будут заноситься в таблицу. Во время процесса обнаружения в нижней части экрана отображается всплывающее уведомление. ![обнаружение виртуальных машин](./media/backup-azure-vms/discovering-vms.png)

5. После завершения процесса обнаружения появляется всплывающее уведомление. ![обнаружение выполнено](./media/backup-azure-vms/discovery-complete.png)


## Регистрация виртуальных машинах Azure
Перед может обеспечить защиту виртуальной машины необходимо зарегистрировать в службе резервного копирования Azure. Процесс регистрации преследует две главные цели:

1. подключение расширения резервного копирования к агенту ВМ в виртуальной машине;

2. Чтобы связать виртуальную машину с служба резервного копирования Azure

Регистрация обычно выполняется однократно. Служба резервного копирования Azure легко обрабатывает обновления и исправления расширения резервного копирования без необходимости трудоемкого вмешательства пользователя. Это освобождает пользователя от расходов по управлению агентом, которые обыкновенно сопровождают продукты для резервного копирования.

### Для регистрации виртуальных машин

1. Перейдите в резервное хранилище, которую можно найти в разделе **службы восстановления** в портал Azure, а затем нажмите **зарегистрированных элементов** вкладка

2. Выберите тип рабочей нагрузки в выпадающем меню как **Виртуальная машина Azure** и нажмите кнопку "выбрать". ![выбор рабочей нагрузки](./media/backup-azure-vms/discovery-select-workload.png)

3. Щелкните **ЗАРЕГИСТРИРОВАТЬ** расположенную в нижней части страницы. ![кнопка регистрации](./media/backup-azure-vms/register-button.png)

4. Во всплывающем окне **Регистрация элементов** выберите виртуальные машины, которые необходимо зарегистрировать. При наличии двух или нескольких виртуальных машин с тем же именем позволяет различать виртуальные машины облачной службы.

    Операция **регистрации** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно сокращает однократные усилия, которые затрачиваются на подготовку виртуальных машин для резервного копирования.

    >[AZURE.NOTE]Будут отображаться только виртуальные машины, которые не регистрируются и находятся в одном регионе резервного хранилища.

5. Задание создается для каждой виртуальной машины, которую необходимо зарегистрировать. Всплывающее уведомление отображает состояние этого действия. Щелкните **Просмотр задания**, чтобы перейти на страницу **Задания**. ![задание регистрации](./media/backup-azure-vms/register-create-job.png)

6. Виртуальная машина также появляется в списке зарегистрированных элементов, и отображается состояние операции регистрации. ![Состояние регистрации 1](./media/backup-azure-vms/register-status01.png)

7. После завершения операции состояние на портале изменяется, чтобы отразить зарегистрированное состояние. ![Состояние регистрации 2](./media/backup-azure-vms/register-status02.png)

## Резервное копирование виртуальных машин Azure
Этот шаг включает в себя настройку политики резервного копирования и хранения для виртуальной машины. Чтобы защитить виртуальную машину, выполните следующие действия.

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.
2. Выберите тип рабочей нагрузки в выпадающем меню как **Виртуальная машина Azure** и нажмите кнопку **Выбрать**. ![Выберите рабочую нагрузку на портале](./media/backup-azure-vms/select-workload.png)

3. Щелкните **ЗАЩИТИТЬ** расположенную в нижней части страницы.

4. Появится мастер **защиты элементов**, где можно выбрать виртуальные машины, которые необходимо защитить. При наличии двух или нескольких виртуальных машин с тем же именем позволяет различать виртуальные машины облачной службы.

    Операция **защиты** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно уменьшает усилия, затраченные на защиту виртуальных машин.

    >[AZURE.NOTE]Здесь будут отображаться только виртуальные машины, которые были правильно зарегистрированы в службе резервного копирования Azure и находятся в одном регионе с резервным хранилищем.

5. На втором экране мастера **защиты элементов** выберите политику резервного копирования и хранения для резервного копирования выбранных виртуальных машин. Выберите политику из существующего набора или создайте новую.

    >[AZURE.NOTE]В предварительной версии поддерживается хранение в течение 30 дней и максимум одно резервное копирование в день.

    В каждом резервном хранилище можно иметь несколько политик резервного копирования. Политики отражают сведения о том, как должно планироваться выполнение резервных копий и обеспечиваться их сохранение. Например, одна политика резервного копирования может использоваться для ежедневного резервного копирования в 10:00 вечера, в то время как другая политика может обеспечивать еженедельное резервное копирование в 6:00 утра. Несколько политик резервного копирования обеспечивают гибкость при планировании создания резервных копий для инфраструктуры виртуальных машин.

    Каждая политика резервного копирования может иметь несколько связанных с ней виртуальных машин. В каждый данный момент времени виртуальная машина может быть связана только с одной политикой.

6. Чтобы настроить политику защиты и связать виртуальные машины с этой политикой, для каждой виртуальной машины  создается задание. Щелкните вкладку **Задания** и выберите необходимый фильтр для просмотра списка заданий **настройки защиты**. ![Настройка задания защиты](./media/backup-azure-vms/protect-configureprotection.png)

7. После завершения операции виртуальные машины защищены с помощью политики и должны ожидать запланированное время резервного копирования для создания начальной резервной копии. Виртуальная машина теперь появится в списке на вкладке **Защищенные элементы** и будет иметь состояние защиты со значением *защищена* (ожидание начальной резервной копии).
    >[AZURE.NOTE]Параметр запуска начального  резервного копирования сразу после настройки защиты в настоящее время недоступен.

8. В запланированное время служба резервного копирования Azure создает задание резервного копирования для каждой виртуальной машины, для которой необходимо создать резервную копию. Щелкните вкладку **Задания**, чтобы просмотреть список заданий **резервного копирования**. В качестве части операции резервного копирования служба резервного копирования Azure выдает команду расширению резервного копирования в каждой виртуальной машине, чтобы сохранить на диск все данные операций записи и сделать согласованный моментальный снимок. ![Выполняется резервное копирование](./media/backup-azure-vms/protect-inprogress.png)

9. После завершения операции состояние защиты виртуальной машины на вкладке **Защищенные элементы** отображается как *Защищена*. ![Резервное копирование виртуальной машины с точкой восстановления](./media/backup-azure-vms/protect-backedupvm.png)

## Просмотр состояния резервного копирования и сведений
После обеспечения защиты число виртуальных машин также увеличивается на странице сводки **Панели мониторинга**. Кроме того, на странице панели мониторинга отображается количество успешных, завершившихся сбоем и все еще выполняемых заданий за последние 24 часа. Щелчок любой из категорий позволяет получить детальные сведения о ней на странице **Задания**. ![Состояние резервного копирования на странице панели мониторинга](./media/backup-azure-vms/dashboard-protectedvms.png)

## Устранение ошибок
Для устранения ошибки, возникшие во время с помощью Azure Backup с информацией перечисленных в следующей таблице.

| Операция резервного копирования | Сведения об ошибке | Возможное решение |
| -------- | -------- | -------|
| Обнаружение | Не удалось обнаружить новые элементы — в службе резервного копирования Microsoft Azure произошла внутренняя ошибка. Подождите несколько минут и повторите попытку. | Повторите процесс обнаружения через 15 минут.
| Обнаружение | Не удалось обнаружить новые элементы — уже выполняется другая операция обнаружения. Дождитесь завершения текущей операции обнаружения. | None |
| Зарегистрировать | Роль ВМ Azure не находится в состоянии для установки расширения — убедитесь, что виртуальная машина находится в состоянии выполнения. Расширение служб восстановления Azure требует, чтобы виртуальная машина работала. | Запустите виртуальную машину и после ее перехода в состояние выполнения повторите попытку регистрации.|
| Зарегистрировать | Количество дисков данных, присоединенные к виртуальной машине превысило поддерживаемый предел - обратитесь отключать некоторые диски данных на эту виртуальную машину и повторите операцию. Резервное копирование Azure поддерживает до пяти дисков данных, присоединенные к виртуальной машине Azure для резервного копирования | None |
| Зарегистрировать | Архивации Microsoft Azure произошла внутренняя ошибка - Wait несколько минут и повторите попытку. Если проблема сохранится, обратитесь в службу технической поддержки Майкрософт. | Можно получить по одной из следующих конфигураций не поддерживается этой ошибки: <ol><li>Premium LRS <li>нескольких Сетевых <li>балансировки нагрузки </ol> |
| Зарегистрировать | Не найден сертификат агента гостевой виртуальной Машины | Для устранения этой ошибки выполните следующие действия: <ol><li>загрузить последнюю версию агента виртуальной Машины из [здесь](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Убедитесь, что версия агента загруженный 2.6.1198.718 или более поздней версии. <li>Установите агент виртуальной Машины в виртуальной машине.</ol> [Узнайте](#validating-vm-agent-installation) проверка версии агента ВМ. |
| Зарегистрировать | Не удалось выполнить регистрацию, время ожидания операции установки агента | Проверьте, поддерживается ли версия ОС виртуальной машины. |
| Зарегистрировать | Ошибка - команды выполнения другой операции идет в этом элементе. Подождите, пока завершится предыдущая операция | None |
| Архивация | Копирование VHD из резервного хранилища, истекло время ожидания - повторите операцию через несколько минут. Если проблема повторится, обратитесь в службу технической поддержки Майкрософт. | Это происходит, когда имеется слишком много данных для копирования. Проверьте наличие меньше 6 дисков данных. |
| Архивация | Истекло время ожидания задачи sub моментальный снимок виртуальной Машины — повторите операцию через несколько минут. Если проблема повторится, обратитесь в службу технической поддержки Майкрософт | Данная ошибка возникает в том случае, если существует проблема с агента виртуальной Машины или иным образом блокируется доступ по сети к инфраструктуре Azure. <ul><li>Дополнительные сведения о [Отладка проблем агента виртуальной Машины](#Troubleshooting-vm-agent-related-issues) <li>сведения о [сетевых проблем отладки](#troubleshooting-networking-issues) </ul> |
| Архивация | Сбой резервного копирования с внутренней ошибки - повторите операцию через несколько минут. Если проблема повторится, обратитесь в службу технической поддержки Майкрософт | Эта ошибка может возникнуть по двум причинам: <ol><li> имеется слишком много данных для копирования. Проверьте наличие меньше 6 дисков. <li>Удален исходной виртуальной Машины и поэтому не может быть выполнено резервное копирование. Чтобы сохранить данные резервной копии для удаленной виртуальной Машины, но ошибки резервного копирования, снять защиту виртуальной Машины и выберите параметр, чтобы сохранить данные. Это предотвратит расписание резервного копирования, а также повторяющиеся сообщения об ошибках. |
| Архивация | Не удалось установить службы восстановления Azure модуля на выбранный элемент - агент виртуальной Машины является обязательной для расширения служб восстановления Azure. Установите агент виртуальной Машины Azure и перезапуск операции регистрации | <ol> <li>Проверьте, был ли агент виртуальной Машины установлен правильно. <li>Убедитесь, что флаг конфигурации виртуальной Машины имеет правильное значение.</ol> [Дополнительные](#validating-vm-agent-installation) об установке агента виртуальной Машины и проверка установки агента виртуальной Машины. |
| Архивация | Ошибка - команды выполнения другой операции идет в этом элементе. Пожалуйста, подождите до завершения предыдущей операции и повторите попытку | Выполняется существующей резервной копии или задание восстановления для виртуальной Машины, а новое задание невозможен, пока выполняется существующего задания. <br><br>При желании можно отменить текущее задание ваш голос, чтобы добавить [форум отзывов Azure](http://feedback.azure.com/forums/258995-azure-backup-and-scdpm/suggestions/7941501-add-feature-to-allow-cancellation-of-backup-restor). |

### Устранение неполадок агента виртуальной Машины проблем.

#### Настройка агента виртуальной Машины
Как правило агент виртуальной Машины уже присутствует в виртуальные машины, созданные из коллекции Azure. Однако виртуальные машины, которые переносятся с локальными центрами обработки данных не будет установлен агент виртуальной Машины. Для таких виртуальных машин агент виртуальной Машины должно быть установлено явным образом. Узнайте больше о [установки агента виртуальной Машины на существующей виртуальной Машине](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).

Для виртуальных машин Windows:

- Загрузите и установите [агента MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Необходимо обладать правами администратора для завершения установки.
- [Обновления свойства виртуальной Машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) для указания, что установлен агент.


#### Обновление агента виртуальной Машины
Обновление агента виртуальной Машины сводится переустановки [двоичные файлы агента виртуальной Машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Тем не менее необходимо обеспечить выполнение без операции резервного копирования во время обновления агента виртуальной Машины.


#### Проверка установки агента виртуальной Машины
Как проверить версию агента виртуальной Машины на виртуальных машинах Windows:

- Имя входа в Azure виртуальную машину и перейдите к папке *C:\WindowsAzure\Packages*.
- Следует найти присутствует файл WaAppAgent.exe.
- Щелкните правой кнопкой мыши файл, перейдите к **Свойства**, и выберите **сведения о** вкладки.
- Версия продукта поле должно быть 2.6.1198.718 или выше

### Устранение сетевых неполадок
Как все расширения расширение резервной копии необходим доступ к Интернету для работы. Отсутствие доступа к Интернету может быть выражено в различных способов:

- Установка расширения может завершиться ошибкой
- Может произойти сбой операции резервного копирования (например, моментальный снимок диска)
- Отображение состояния операции резервного копирования может завершиться ошибкой

Потребность в разрешении общих адресов Интернета была определена [здесь](http://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). Необходимо для проверки конфигурации DNS для виртуальную сеть и убедитесь, что URL-адреса Azure можно разрешить.

После разрешения имен правильно доступ к IP-адреса Azure также требуется указать. Чтобы разблокировать доступ к инфраструктуре Azure, выполните следующие действия.

1. Получить список [центра обработки данных Azure IP-адреса]()https://msdn.microsoft.com/
2. / library/azure/dn175718.aspx) необходимо включить в утвержденный список.
2. Разблокировать IP-адресов с помощью [Нью-NetRoute](https://technet.microsoft.com/library/hh826148.aspx) номеров. Запустите этот командлетов для ВМ Azure, в окне с повышенными привилегиями PowerShell (Запуск от имени администратора).


## Целостность данных в точках восстановления
При работе с резервной копии данных, клиентов беспокоиться о поведении виртуальной машины после его восстановления. Ниже приведены типичные вопросы, которые задают клиенты.

- Будет ли виртуальная машина загружаться?
- Будут ли данные доступны на диске? Какие-либо данные потеряны?
- Сможет ли приложение считывать данные? Какие-либо данные повреждены?
- Будут ли данные иметь смысл для приложения? Будут ли данные являться согласованными при чтении их приложением?

В следующей таблице описываются типы целостности и согласованности данных, встречающиеся во время резервного копирования и восстановления ВМ Azure:

| Целостность | На базе службы VSS | Подробное объяснение |
|-------------|-----------|---------|
| Целостность на уровне приложения | Да | Это идеальное место для рабочих нагрузок Майкрософт, которое гарантирует следующее:<ol><li> ВМ *загружается*; <li>нет *повреждений данных*; <li>нет *потери данных*; <li> данные являются согласованными с приложением, которое их использует, за счет привлечения приложения к выполнению резервного копирования — использование VSS.</ol> Служба снимков тома (VSS) обеспечивает правильную запись данных в хранилище. Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных. Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных.<br><br> Для резервного копирования виртуальных машин Azure получение точки восстановления с согласованными данными означает, что расширение резервного копирования имело возможность вызвать рабочий процесс VSS и *корректно* завершить его до выполнения моментального снимка ВМ. Естественно, это означает, что модули записи VSS всех приложений на виртуальной машине Azure были также вызваны.<br><br>Познакомьтесь с [основами службы VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx), подробно изучите [принцип ее работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx). |
| Целостность на уровне файловой системы | Да, для компьютеров Windows | Существует два сценария, в которых целостность данных в точке восстановления может зависеть от файловой системы.<ul><li>Резервное копирование виртуальных машин Linux в Azure, поскольку Linux не имеет аналогичной платформы для VSS.<li>Сбой службы VSS во время резервного копирования для виртуальных машин Windows в Azure.</li></ul> В обоих этих случаях лучшее, что можно сделать, — это обеспечить следующее: <ol><li> ВМ *загружается*; <li>нет *повреждений данных*; <li>нет *потери данных*.</ol> Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных.|
| Отказоустойчивость | Нет | Такая ситуация аналогична сбою компьютера (приводит к программной или аппаратной перезагрузке). Нет никакой гарантии целостности и согласованности данных на носителях данных. Во время резервного копирования выполняется архивация только тех данных, которые уже существуют на диске. <ol><li>Однако в большинстве случаев нет гарантии, что ОС загрузится.<li>Обычно после этого выполняется процедура проверки диска (например, chkdsk) для исправления любых ошибок, связанных с его повреждением.<li> Будут потеряны все данные, которые не были записаны на диск.<li> В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки. </ol>В контексте резервного копирования виртуальной машины Azure отказоустойчивая точка восстановления означает, что служба резервного копирования Azure не предоставляет никаких гарантий в отношении целостности и согласованности данных в хранилище — ни с точки зрения операционной системы, ни с точки зрения приложения. Обычно это происходит при завершении работы виртуальной машины Azure во время резервного копирования.<br><br>Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до согласованных данных. При работе с данными, которые распределены между несколькими виртуальными дисками (например, составные тома), отказоустойчивые точки восстановления не гарантируют правильность данных.|

## Дальнейшие действия
Дополнительные сведения о начале работы с резервным копированием Azure см. в разделе:

- [Восстановление виртуальных машин](backup-azure-restore-vms.md)
- [Управление виртуальными машинами](backup-azure-manage-vms)

<!---HONumber=GIT-SubDir-->