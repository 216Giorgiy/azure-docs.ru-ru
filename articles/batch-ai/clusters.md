---
title: Работа с кластерами Azure Batch AI | Документация Майкрософт
description: Выбор конфигурации кластера Batch AI, создание кластера Batch AI и управление им
services: batch-ai
documentationcenter: ''
author: johnwu10
manager: jeconnoc
editor: ''
ms.service: batch-ai
ms.topic: article
ms.date: 08/14/2018
ms.author: danlep
ms.custom: mvc
ROBOTS: NOINDEX
ms.openlocfilehash: 9af8ce84805e48dd3c91dd7fb4fcf0b136fbfc60
ms.sourcegitcommit: c37122644eab1cc739d735077cf971edb6d428fe
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2018
ms.locfileid: "53410097"
---
# <a name="work-with-batch-ai-clusters"></a>Работа с кластерами Batch AI 

[!INCLUDE [batch-ai-retiring](../../includes/batch-ai-retiring.md)]

В этой статье описано, как работать с кластерами в Azure Batch AI. Здесь вводится понятие кластеров, допустимые типы и примеры конфигурации. В большинстве примеров этой статьи для создания кластеров и управления ими используется интерфейс командной строки Azure. Но вы можете использовать для работы с кластерами и другие средства, в том числе портал Azure и пакеты SDK для Azure Batch AI.

Кластер Batch AI — один из нескольких ресурсов в службе. См. [общие сведения о ресурсах Batch AI](resource-concepts.md) с описанием роли кластеров в этой службе.

## <a name="introduction-to-clusters"></a>Знакомство с кластерами

Кластер Batch AI содержит вычислительные ресурсы для выполнения заданий машинного обучения и искусственного интеллекта. Все узлы в кластере имеют одинаковые размеры виртуальных машин и образы ОС. Batch AI предоставляет много возможностей для создания кластеров, оптимизированных для разных целей. Обычно для каждой категории вычислительных ресурсов, необходимых для выполнения проекта, настраивается отдельный кластер. Вы можете масштабировать количество узлов в кластере с учетом потребностей и бюджетных ограничений. Кластеры можно подготовить для совместного использования в группе или отдельно для каждого пользователя. 

Каждый кластер размещается в ресурсе Batch AI, который называется *рабочей областью*. Прежде чем начинать подготовку кластера, необходимо настроить рабочую область Batch AI. Например, если вы используете интерфейс командной строки Azure, выполните команду [az batchai workspace create](/cli/azure/batchai/workspace?view=azure-cli-latest#az-batchai-workspace-create). 

В созданный кластер можно поочередно отправлять задания. Batch AI самостоятельно управляет выделением ресурсов для выполнения заданий в кластере. 

## <a name="cluster-configuration-options"></a>Параметры конфигурации кластера

При планировании кластера прежде всего определите требования к вычислениям. Batch AI имеет гибкие возможности для настройки, позволяя создать кластер под конкретные требования. Ниже приведены основные параметры, которые следует оценить при подготовке кластера.

* **Размер виртуальной машины** — выберите любой [размер виртуальной машины](../virtual-machines/linux/sizes.md), доступный для узлов кластера в [поддерживаемом регионе](https://azure.microsoft.com/global-infrastructure/services/). Каждый кластер может включать виртуальные машины только одного размера. Если для ваших вычислительных задач нужны несколько типов виртуальных машин, подготовьте отдельный кластер для каждого типа. Для обучения моделей машинного обучения или искусственного интеллекта, разработанных на платформах с поддержкой GPU, Azure предлагает [размеры виртуальных машин, оптимизированные для GPU](../virtual-machines/linux/sizes-gpu.md).
  
* **Приоритет виртуальной машины** — Batch AI предоставляет для кластера выделенные или низкоприоритетные виртуальные машины. Выделенные виртуальные машины резервируются для использования в кластере. Вариант с низким приоритетом выделяет только неиспользуемую емкость виртуальных машин Azure, позволяя добиться существенной экономии с возможностью замещения этих задач, если Azure потребуются виртуальные машины. Также на низкоприоритетных виртуальных машинах автоматически замещаются задания, которые выполняются больше 24 часов. Если бюджет для вас очень важен, попробуйте применить низкоприоритетные виртуальные машины для коротких заданий экспериментирования. Затем переключитесь на выделенные виртуальные машины, когда нужно будет выполнять более длительные задания.

* **Количество узлов** — Batch AI поддерживает ручное изменение количества узлов в кластере и автомасштабирование. Управление вручную позволяет вам контролировать процессы масштабирования кластера, а значит и затраты на вычисления. Вариант автомасштабирования гарантирует, что кластер всегда уменьшает количество узлов, когда вы его не используете, позволяя минимизировать затраты на вычисления. 

  Если вы решите выполнять масштабирование кластера вручную, определите исходную цель при создании кластера. Исходная цель определяет, сколько узлов изначально выделит Batch AI. Позднее вы сможете вручную изменить это количество.  

  Если вы выберете вариант автомасштабирования, при создании кластера нужно указать минимальное и максимальное количество узлов. Для этих параметров можно указать любое значение от 0 до максимального количества поддерживаемых узлов в соответствии с [квотой Batch AI на ядра](quota-limits.md). Значение 0 позволяет сохранить конфигурацию кластера без затрат на вычислительные ресурсы. Если вы запросите более высокое целевое значение, чем допускает ваша квота, подготовка завершится ошибкой. 

* **Образ виртуальной машины** — по умолчанию Batch AI подготавливает виртуальные машины кластера на основе стандартного образа Ubuntu Server, который поддерживает рабочие нагрузки в контейнере. Вы можете выбрать другой предварительно настроенный образ Linux из Azure Marketplace, например [Виртуальная машина для обработки и анализа данных](../machine-learning/data-science-virtual-machine/overview.md). 

* **Хранилище** — Batch AI предоставляет возможность автоматического хранения данных. Вы можете выбрать этот вариант при создании кластера с помощью Azure CLI. При этом в новой учетной записи хранения автоматически создаются общий файловый ресурс Azure и контейнер BLOB-объектов. Эти ресурсы хранилища подключаются к каждому узлу кластера во время выполнения задания, позволяя обращаться к файлам по локальному пути. Имена учетных записей хранения, имя общего файлового ресурса, имя контейнера BLOB-объектов и пути подключения имеют значения по умолчанию, которые можно изменить с помощью дополнительных параметров при создании кластера. 

  Если параметры хранилища не определены, вам нужно будет создавать ресурсы хранения отдельно и указывать их при отправке заданий. Этот вариант удобен, если кластер управляется на уровне организации, а хранилища — на уровне пользователей. Дополнительные сведения об отправке файлов в службу хранилища Azure и доступе к ним во время выполнения см. в руководстве по [хранению входных и выходных данных для заданий Batch AI в службе хранилища Azure](use-azure-storage.md).

* **Доступ пользователей** — Batch AI позволяет при создании кластера создать файлы открытого и закрытого ключей SSH или предоставить собственные ключи SSH для подключения к отдельным узлам. Вы также можете определить имя пользователя (по умолчанию устанавливается имя текущего пользователя) и пароль. Эти учетные данные позволят подключаться к узлам во время выполнения, чтобы просмотреть метрики или получить сведения о выполняемых заданиях.

* **Задача установки** — Batch AI позволяет определить аргументы командной строки, которые будут выполняться на каждом узле после его выделения. Можно также определить путь для записи выходного файла. Этот вариант удобен, если вам нужны дополнительные шаги для подготовки системы наряду с настройкой параметров базового образа.

* **Дополнительная настройка** — есть несколько нечастых сценариев, для которых требуется более специализированная настройка. В таких случаях можно подключить [файл конфигурации кластера](https://github.com/Azure/BatchAI/blob/master/documentation/using-azure-cli-20.md#using-cluster-configuration-file) с помощью команды Azure CLI, которая создает кластер. 

## <a name="create-the-cluster"></a>Создание кластера

Выбрав параметры конфигурации кластера, создайте этот кластер с помощью Azure CLI, портала Azure или API-интерфейсов Batch AI. Например, для создания кластера с помощью Azure CLI изучите документацию по команде [az batchai cluster create](/cli/azure/batchai/cluster?view=azure-cli-latest#az-batchai-cluster-create) и создайте точную командную строку для настройки нужной конфигурации. 

Следующий пример команды создает самую простую конфигурацию кластера с одним узлом размера Standard_NC6 и доступом по протоколу SSH. По умолчанию этот кластер содержит выделенные виртуальные машины под управлением последней версии стандартного образа Ubuntu Server.

```azurecli-interactive
az batchai cluster create \
    --name mycluster \
    --workspace <WORKSPACE> \
    --resource-group <RESOURCE GROUP> \
    --vm-size Standard_NC6 \
    --target 1 \
    --generate-ssh-keys
```

Следующий пример подготавливает кластер Standard_NC6, который автоматически масштабируется в диапазоне от 0 до 4 узлов, с низкоприоритетными узлами и автоматически создаваемой учетной записью хранения. Эта конфигурация подходит, когда нужен недорогой и легко управляемый кластер. 

```azurecli-interactive
az batchai cluster create \
    --name mycluster \
    --workspace <WORKSPACE> \
    --resource-group <RESOURCE GROUP> \
    --vm-size Standard_NC6 \
    --vm-priority lowpriority \
    --max 4 \
    --min 0 \
    --use-auto-storage 
```

Следующий пример подготавливает кластер Standard_NC6 на основе образа Виртуальной машины для обработки и анализа данных с пользовательскими вариантами хранилища и подключения, пользовательскими учетными данными для SSH, задачей установки для настройки пакета *unzip* и файлом конфигурации кластера с дополнительными параметрами настройки. Это пример более персонализированной конфигурации кластера для определенных потребностей.

```azurecli-interactive
az batchai cluster create \
    --name mycluster \
    --workspace <WORKSPACE> \
    --resource-group <RESOURCE GROUP> \
    --vm-size Standard_NC6 \
    --image UbuntuDSVM \ 
    --config-file cluster.json \
    --setup-task 'apt install unzip -y'
    --storage-account-name <STORAGE ACCOUNT NAME> \
    --nfs-name nfsmount \
    --afs-name afsmount \
    --bfs-name bfsmount \
    --user-name adminuser \
    --ssh-key id_rsa.pub \
    --password secretpassword 
```

## <a name="monitor-the-cluster"></a>Мониторинг кластера

Команды [az batchai cluster list](/cli/azure/batchai/cluster?view=azure-cli-latest#az-batchai-cluster-list), [az batchai cluster show](/cli/azure/batchai/cluster?view=azure-cli-latest#az-batchai-cluster-show) и [az batchai cluster node list](/cli/azure/batchai/cluster/node?view=azure-cli-latest#az-batchai-cluster-node-list) позволяют отслеживать сведения о каждом из кластеров.

### <a name="list-all-clusters"></a>Полный список кластеров

Следующая команда перечисляет все кластеры в рабочей области.

```azurecli-interactive
az batchai cluster list \
    --workspace <WORKSPACE> \
    --resource-group <RESOURCE GROUP> 
```

### <a name="show-information-about-a-cluster"></a>Отображение информации о кластере

Следующая команда отображает полные сведения об указанном кластере в табличном формате.

```azurecli-interactive
az batchai cluster show \
    --name <CLUSTER NAME> \
    --workspace <WORKSPACE> \
    --resource-group <RESOURCE GROUP> \
    --output table
```

Если кластер подготовлен с автоматически создаваемым хранилищем, вам нужно получить имя учетной записи хранения для использования при отправке скриптов и заданий обучения. Используйте следующую команду:

```azurecli-interactive
az batchai cluster show \
    --name <CLUSTER NAME> \
    --workspace <WORKSPACE> \
    --resource-group <RESOURCE GROUP> \
    --query "nodeSetup.mountVolumes.azureFileShares[0].{storageAccountName:accountName}"
```

Должен быть получен приметно такой результат:

```JSON
{
  "storageAccountName": "baixxxxxxxxx"
}
```

### <a name="list-cluster-nodes"></a>Список узлов кластера

Если вам нужно подключиться к узлам кластера, следующая команда предоставит вам список узлов и сведения о подключении к ним.  

```azurecli-interactive
az batchai cluster node list \
    --name <CLUSTER NAME> \
    --workspace <WORKSPACE> \
    --resource-group <RESOURCE GROUP> 
 ```

Результат для каждого узла будет выглядеть примерно так:

```JSON
[
  {
    "ipAddress": "40.68.xxx.xxx",
    "nodeId": "tvm-xxxxxxxxxx-xxxxxxxx",
    "port": 50000.0
  }
]
```
Эти сведения можно использовать для создания SSH-подключения к узлу с помощью указанной ниже команды.

```bash
ssh myusername@40.68.xxx.xxx -p 50000
``` 

## <a name="submit-jobs-to-the-cluster"></a>Отправка заданий в кластер

После подготовки кластера вы можете отправлять задания для выполнения на его узлах. В документации по команде [az batchai job](/cli/azure/batchai/job?view=azure-cli-latest) указаны несколько способов подготовки, отправки и мониторинга заданий с помощью Azure CLI. 

## <a name="downscale-cluster-for-later-use"></a>Уменьшение размера кластера для последующего использования

Когда завершатся все запущенные задания, вам следует уменьшить размер кластера. Мы рекомендуем всегда уменьшать размер неиспользуемых кластеров, чтобы сократить затраты на вычисления. Уменьшение размера кластера до 0 узлов исключит тарификацию и избавит от необходимости заново создавать кластер, когда он потребуется в следующий раз. Если при создании кластера выбрано автомасштабирование, размер кластера будет автоматически уменьшаться до минимального целевого значения. Если выбрано масштабирование вручную, используйте следующую команду для уменьшения размера.

```azurecli-interactive
az batchai cluster resize \
    --name <CLUSTER NAME> \
    --resource-group <RESOURCE GROUP> \
    --workspace <WORKSPACE> \
    --target 0
```

## <a name="delete-a-cluster"></a>Удаление кластера

Когда вы завершите работу с кластером, удалите его с помощью команды [az batchai cluster delete](/cli/azure/batchai/cluster?view=azure-cli-latest#az-batchai-cluster-delete).

```azurecli-interactive
az batchai cluster delete \
    --name <CLUSTER NAME> \
    --resource-group <RESOURCE GROUP> \
    --workspace <WORKSPACE>
```

При удалении группы ресурсов также автоматически удаляются все кластеры, которые подготовлены в этой группе ресурсов.

```azurecli-interactive
az group delete --name <RESOURCE GROUP>
```

## <a name="next-steps"></a>Дополнительная информация

Дополнительные примеры создания кластера Batch AI вы найдете в кратких руководствах по использованию [портала](quickstart-create-cluster-portal.md) и [Azure CLI](quickstart-create-cluster-cli.md), а также в руководстве по [работе с Batch AI](https://github.com/Azure/BatchAI/tree/master/recipes) на сайте GitHub.
