<properties 
	pageTitle="Обновление приложения мобильных служб до службы приложений Azure" 
	description="Простое обновление приложения мобильных служб до мобильного приложения службы приложений" 
	services="app-service\mobile" 
	documentationCenter="" 
	authors="mattchenderson" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="app-service-mobile" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile" 
	ms.devlang="dotnet" 
	ms.topic="article" 
	ms.date="11/03/2015" 
	ms.author="mahender"/>

# Обновление существующего приложения мобильной службы Azure .NET до службы приложений

Мобильное приложение службы приложений — это новый способ сборки мобильных приложений с помощью Microsoft Azure. Дополнительные сведения см. в разделе [Что такое мобильные приложения?].

В этом разделе приводится процедура обновления существующего внутреннего приложения .NET мобильных служб Azure до нового мобильного приложения службы приложений. Во время обновления существующее приложение мобильных служб может продолжать работать.

При обновлении мобильного внутреннего приложения до службы приложений Azure оно получает доступ ко всем возможностям службы приложений. Тарификация при этом будет осуществляться в соответствии с [ценами службы приложений], а не мобильных служб.

##Миграция или обновление

[AZURE.INCLUDE [app-service-mobile-migrate-vs-upgrade](../../includes/app-service-mobile-migrate-vs-upgrade.md)]

###Улучшения в пакете SDK сервера .NET мобильных приложений

Обновление до новой версии [пакетов NuGet пакета SDK мобильных приложений](https://www.nuget.org/packages/Microsoft.Azure.Mobile.Server/) обеспечивает перечисленные ниже преимущества.

- Дополнительная гибкость для зависимостей NuGet. Среда размещения больше не предоставляет собственные версии пакетов NuGet, позволяя вам использовать альтернативные совместимые версии. Однако при наличии новых критических исправлений или обновлений для системы безопасности для пакета SDK мобильного сервера или зависимостей службу потребуется обновить вручную.

- Поддержка новых функций проверки подлинности службы приложений, которые позволяют использовать общую конфигурацию проверки подлинности для веб- и мобильных приложений. Функции проверки подлинности теперь размещаются в собственном компоненте ПО промежуточного слоя OWIN. Это означает, что можно использовать одинаковую настройку проверки подлинности для мобильных и веб-маршрутов.

- Поддержка других маршрутов и типов проектов ASP.NET. Теперь вы можете размещать контроллеры MVC и веб-API в том же проекте, что и проект мобильного внутреннего сервера.

- Дополнительная гибкость пакета SDK мобильных приложений. Можно явно управлять настройкой конкретных компонентов и маршрутов, таких как проверка подлинности, API таблиц и конечная точка регистрации push-уведомлений. Дополнительные сведения см. в разделе [Использование пакета SDK сервера .NET для мобильных приложений Azure](app-service-mobile-net-upgrading-from-mobile-services.md#server-project-setup).

- Дополнительные возможности для платформ DI. Пакет SDK сервера .NET для мобильных служб включал зависимость от Autofac, однако пакет SDK сервера мобильных приложений позволяет использовать другие платформы, такие как [Unity](https://unity.codeplex.com/).

>[AZURE.NOTE]Пакеты SDK для клиента мобильных служб **не совместимы** с новым пакетом SDK сервера мобильных приложений. При наличии приложений мобильных клиентов, подключающихся к существующей мобильной службе, не следует останавливать службу до тех пор, пока все мобильные клиенты не будут обновлены до **пакета SDK для клиента** мобильных приложений.
> 
> Существующую мобильную службу можно автоматически *перенести* в службу приложений без внесения изменений в существующие клиентские приложения. Дополнительные сведения о миграции см. в разделе [Перенос существующего приложения мобильной службы в службу приложений].


##<a name="overview"></a>Общие сведения об обновлении
Самый простой способ обновления — это создание нового экземпляра мобильного приложения службы приложений. Во многих случаях обновление будет представлять собой просто переход на новый пакет SDK сервера мобильных приложений и повторную публикацию кода в новом мобильном приложении. Однако существует несколько сценариев, в которых потребуется дополнительная настройка, например расширенные сценарии проверки подлинности и работа с запланированными заданиями. Все они описываются в следующих разделах.

>[AZURE.NOTE]Перед началом обновления рекомендуется полностью ознакомиться с остальной частью этого раздела. Запишите все используемые функции, которые вызываются ниже.

Вы можете перемещать и тестировать код с удобной для вас скоростью. По готовности внутреннего сервера мобильных приложений вы можете выпустить новую версию клиентского приложения. На этом этапе вы получите две копии серверной части приложения, выполняющиеся одновременно. Необходимо убедиться, что вносимые исправления ошибок применяются к обеим копиям. Наконец, после обновления до последней версии вы можете удалить исходную мобильную службу.

Далее приводится полный набор этапов этого обновления.

1. Создание и настройка новой мобильной службы.
2. Устранение проблем с проверкой подлинности.
3. Выпуск новой версии клиентского приложения.
4. Удаление исходного экземпляра мобильных служб.


##<a name="mobile-app-version"></a>Настройка версии мобильного приложения для вашего приложения
Первый этап обновления — создание ресурса мобильного приложения, в котором будет размещаться новая версия вашего приложения. Вы можете создать новое мобильное приложение на [портале предварительной версии Azure]. Дополнительные сведения см. в разделе [Создание мобильного приложения].

Скорее всего, вы захотите использовать ту же базу данных и концентратор уведомлений, которые использовали в мобильных службах. Вы можете скопировать эти значения с вкладки **Настройка** раздела мобильных служб на [портале управления Azure]. В разделе **Строки подключения** скопируйте `MS_NotificationHubConnectionString` и `MS_TableConnectionString`. Перейдите на сайт мобильного приложения, последовательно выберите **Параметры** и **Параметры приложения**, а затем добавьте эти значения в раздел **Строки подключения**, перезаписав существующие значения.

Мобильные приложения предоставляют новый [пакет SDK для сервера мобильных приложений], который предоставляет практически те же функции, что и среда выполнения мобильных служб. Сначала следует удалить пакет NuGet мобильных служб из существующего проекта и включить вместо него пакет SDK для сервера. Для данного обновления большинство разработчиков будет скачивать пакет `Microsoft.Azure.Mobile.Server.Quickstart`, тем самым извлекая необходимый набор. Затем в файле WebApiConfig.cs можно заменить

    // Use this class to set configuration options for your mobile service
    ConfigOptions options = new ConfigOptions();
    
    // Use this class to set WebAPI configuration options
    HttpConfiguration config = ServiceConfig.Initialize(new ConfigBuilder(options));

на

    HttpConfiguration config = new HttpConfiguration();

    new MobileAppConfiguration()
	    .UseDefaultConfiguration()
	    .ApplyTo(config);


>[AZURE.NOTE]Если вы хотите узнать больше о новом пакете SDK сервера .NET и о том, как добавить или удалить компоненты из приложения, см. раздел [Как использовать пакет SDK для сервера .NET].

Существует несколько других отличий между пакетами SDK для мобильных служб и мобильных приложений, но с ними все просто. Возможно, во всем проекте потребуется изменить некоторые инструкции using с помощью Visual Studio.

Необходимо добавить атрибут `[MobileAppController]` во все классы ApiController, просто поместив этот декоратор непосредственно перед определением класса.

Больше нет атрибута `[AuthorizeLevel]`, вместо него контроллеры и методы следует декорировать с помощью стандартного атрибута `[Authorize]` ASP.NET. Обратите внимание, что любой контроллер без `[AuthorizeLevel]` больше не защищен ключом приложения. Он будет рассматриваться как общедоступный. Новый пакет SDK больше использует ключ приложения и главный ключ.

Для отправки основной элемент, который может отсутствовать в пакете SDK для сервера, — это класс PushRegistrationHandler. Регистрации в мобильных приложениях обрабатываются немного по-другому, и способы регистрации без тегов включены по умолчанию. Управление тегами осуществляется с помощью пользовательских API. Дополнительные сведения см. в разделе [Добавление push-уведомлений в мобильное приложение].

Запланированные задания не встраиваются в мобильные приложения, поэтому все существующие задания на внутреннем сервере .NET потребуется обновлять по отдельности. Один из вариантов — создать запланированное [веб-задание] на сайте кода мобильных приложений. Можно также настроить контроллер, содержащий код задания, и задать в [планировщике Azure] вызов конечной точки по ожидаемому расписанию.

Объект `ApiServices` больше не является частью пакета SDK. Для доступа к параметрам мобильного приложения можно использовать следующее:

    MobileAppSettingsDictionary settings = this.Configuration.GetMobileAppSettingsProvider().GetMobileAppSettings(); 

Аналогично, теперь ведение журнала выполняется с помощью стандартной записи трассировки ASP.NET:

    ITraceWriter traceWriter = this.Configuration.Services.GetTraceWriter();
    traceWriter.Info("Hello, World");  

##<a name="authentication"></a>Рекомендации по проверке подлинности
Одно из основных различий между мобильными приложениями и мобильными службами — то, что теперь вход в мобильные приложения обрабатывается шлюзом службы приложений службы приложений, а не сайтом, на котором выполняется ваш код. Если шлюза еще нет в группе ресурсов, вы можете подготовить его, перейдя в мобильное приложение Azure на портале управления. Выберите **Параметры**, а затем **Проверка подлинности пользователя** в разделе **Мобильный**. Щелкните **Создать**, чтобы связать шлюз с мобильным приложением.

Кроме того, для большинства приложений дополнительных действий не потребуется, но существует несколько расширенных сценариев, которые следует учитывать.

Для большинства приложений достаточно просто использовать новый способ регистрации с целевым поставщиком удостоверений; дополнительные сведения о добавлении удостоверения в приложение службы приложений см. в учебнике [Добавление проверки подлинности в мобильное приложение].

Если приложение получает зависимости в идентификаторах пользователей, например сохраняет их в базе данных, важно обратить внимание на то, что идентификаторы пользователей в мобильных службах и мобильных приложениях служб приложений отличаются. Однако можно получить идентификатор пользователя мобильных служб в мобильном приложении службы приложений следующим образом (в качестве примера используется Facebook):

    MobileAppUser = (MobileAppUser) this.User;
    FacebookCredentials creds = await user.GetIdentityAsync<FacebookCredentials>();
    string mobileServicesUserId = creds.Provider + ":" + creds.UserId;

Дополнительно, если вы получаете зависимости для идентификаторов пользователей, важно использовать тот же способ регистрации и того же поставщика удостоверений, если это возможно. Идентификаторы пользователей обычно относятся к использованному способу регистрации приложений, поэтому новый способ регистрации может вызвать проблемы с сопоставлением пользователей с их данными. Если приложению по какой-либо причине нужно использовать тот же способ регистрации поставщика удостоверений, выполните следующие действия:

1. Скопируйте сведения о подключении идентификатора и секрета клиента для каждого поставщика, использованного в приложении.
2. Добавьте конечные точки шлюза или входа* в качестве дополнительных URI перенаправления для каждого поставщика. 

>[AZURE.NOTE]Некоторые поставщики, например Twitter и учетная запись Майкрософт, не позволяют указать несколько URI перенаправления в разных доменах. Если приложение использует один из этих поставщиков и получает зависимость для идентификаторов пользователей, рекомендуется не выполнять обновление на данном этапе.

##<a name="updating-clients"></a>Обновление клиентов
После получения рабочего внутреннего сервера мобильных приложений вы можете обновить клиентское приложение, чтобы оно использовало новое мобильное приложение. В мобильные приложения будет также входить новая версия пакетов SDK для клиента мобильных служб, которая позволит разработчикам получить преимущество использования новых функций службы приложений. После получения версии мобильного приложения внутреннего сервера вы можете выпустить новую версию клиентского приложения, которая использует новую версию пакета SDK.

Основное изменение, которое потребуется внести в код клиента, находится в конструкторе. Кроме URL-адреса сайта мобильного приложения, необходимо предоставить URL-адрес шлюза службы приложений, на котором размещаются параметры аутентификации:

    public static MobileServiceClient MobileService = new MobileServiceClient(
        "https://contoso.azurewebsites.net", // URL of the Mobile App
        "https://contoso-gateway.azurewebsites.net", // URL of the App Service Gateway
        "" // Formerly app key. To be removed in future client SDK update
    );

Это позволит клиенту перенаправлять запросы в компоненты мобильного приложения. Дополнительные сведения по конкретной целевой платформе см. в соответствующем разделе [Создание мобильного приложения].

В том же обновлении вам потребуется настроить все выполняемые вызовы регистрации push-уведомлений. Существуют новые API, которые вносят усовершенствования в процесс регистрации (в качестве примера используется Windows):

    var channel = await PushNotificationChannelManager.CreatePushNotificationChannelForApplicationAsync();
    await MobileService.GetPush().Register(channel.Uri); 

Дополнительные сведения о конкретной целевой платформе см. в разделах [Добавление push-уведомлений в мобильное приложение] и [Отправка кроссплатформенных push-уведомлений].

После того как клиенты смогут получить эти обновления, вы можете удалить версию мобильных служб приложения. Этот шаг завершает обновление до мобильного приложения службы приложений с помощью последнего пакета SDK сервера мобильных приложений.

<!-- URLs. -->

[портале предварительной версии Azure]: https://portal.azure.com/
[портале управления Azure]: https://manage.windowsazure.com/
[Что такое мобильные приложения?]: app-service-mobile-value-prop.md
[I already use web sites and mobile services – how does App Service help me?]: /ru-RU/documentation/articles/app-service-mobile-value-prop-migration-from-mobile-services
[пакет SDK для сервера мобильных приложений]: http://www.nuget.org/packages/microsoft.azure.mobile.server
[Создание мобильного приложения]: app-service-mobile-xamarin-ios-get-started.md
[Добавление push-уведомлений в мобильное приложение]: app-service-mobile-xamarin-ios-get-started-push.md
[Добавление проверки подлинности в мобильное приложение]: app-service-mobile-xamarin-ios-get-started-users.md
[планировщике Azure]: /ru-RU/documentation/services/scheduler/
[веб-задание]: ../app-service-web/websites-webjobs-resources.md
[Отправка кроссплатформенных push-уведомлений]: app-service-mobile-xamarin-ios-push-notifications-to-user.md
[Как использовать пакет SDK для сервера .NET]: app-service-mobile-dotnet-backend-how-to-use-server-sdk.md
[Migrate from Mobile Services to an App Service Mobile App]: app-service-mobile-dotnet-backend-migrating-from-mobile-services.md
[Перенос существующего приложения мобильной службы в службу приложений]: app-service-mobile-dotnet-backend-migrating-from-mobile-services.md
[ценами службы приложений]: https://azure.microsoft.com/ru-RU/pricing/details/app-service/

<!---HONumber=Nov15_HO3-->