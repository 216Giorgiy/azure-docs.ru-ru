<properties
	pageTitle="Подключение мобильного приложения Azure к локальному серверу SQL Server с помощью гибридных подключений | Microsoft Azure"
	description="Узнайте, как подключиться к локальному серверу SQL Server из мобильного приложения службы приложений с помощью гибридных подключений"
	services="app-service\mobile"
	documentationCenter=""
	authors="ggailey777"
	manager="dwrede"
	editor=""/>

<tags
	ms.service="app-service-mobile"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="multiple"
	ms.topic="get-started-article"
	ms.date="07/30/2015"
	ms.author="glenga"/>


# Подключение к локальному серверу SQL Server из мобильных приложений с помощью гибридных подключений

При переходе на облачную платформу предприятию не всегда удается сразу перенести все свои ресурсы в среду Azure. С помощью гибридных подключений мобильные приложения в службы приложений Azure могут безопасно подключаться к локальным ресурсам. Благодаря этому ваши локальные данные будут доступны мобильным клиентам, использующим Azure. К поддерживаемым активам относятся любые ресурсы, работающие на статическом TCP-порту, в том числе Microsoft SQL Server, MySQL, веб-API HTTP и большинство настраиваемых веб-служб. Гибридные подключения используют авторизацию на основе подписанного URL-адреса (SAS), чтобы гарантировать безопасность подключений из службы мобильных приложений и локального диспетчера гибридных подключений к гибридному подключению. Подробнее см. [обзоре гибридных подключений](../integration-hybrid-connection-overview.md).

В этом руководстве мы покажем, как изменить серверную часть .NET мобильных приложений таким образом, чтобы она использовала локальную базу данных SQL Server вместо базы данных SQL Azure по умолчанию, подготовленной с помощью вашей службы.

[AZURE.INCLUDE [app-service-mobile-to-web-and-api](../../includes/app-service-mobile-to-web-and-api.md)]

## Предварительные требования ##

Для работы с данным учебником необходимы перечисленные ниже компоненты и сведения.

- **Существующая серверная часть мобильных приложений** <br/>С помощью этого [руководства по быстрому началу работы](app-service-mobile-dotnet-backend-windows-store-dotnet-get-started-preview.md) вы можете создать и загрузить новое мобильное приложение серверной части .NET с [портала Azure].

[AZURE.INCLUDE [hybrid-connections-prerequisites](../../includes/hybrid-connections-prerequisites.md)]

## Установка экспресс-выпуска SQL Server, включение TCP/IP и создание локальной базы данных SQL Server

[AZURE.INCLUDE [hybrid-connections-create-on-premises-database](../../includes/hybrid-connections-create-on-premises-database.md)]

## Создание гибридного подключения

Для кода серверной части мобильного приложения (веб-приложения) потребуется создать новое гибридное подключение и службу BizTalk.

1. На [портале Azure] найдите свое мобильное приложение и нажмите кнопку серверной части веб-приложения.

	![Перейти к веб-приложению](./media/app-service-mobile-dotnet-backend-hybrid-connections-get-started-preview/mobile-app-link-to-web-app-backend.png)

	В результате откроется веб-приложение, в котором реализован код серверной части мобильного приложения (его название совпадает с именем мобильного приложения, за которым следует строка `-code`).

2. Прокрутите вниз колонку веб-приложения и нажмите кнопку **Гибридные подключения**.

	![Гибридные подключения](./media/app-service-mobile-dotnet-backend-hybrid-connections-get-started-preview/start-hybrid-connection.png)

2. В колонке "Гибридные подключения" щелкните **Добавить** > **Создать гибридное подключение**.

3. В **колонке создания гибридного подключения** укажите для него **имя** и **имя узла**, а также задайте для **порта** значение `1433`.

	![Создание гибридного подключения](./media/app-service-mobile-dotnet-backend-hybrid-connections-get-started-preview/create-hybrid-connection.png)

4. Нажмите **Служба Biz Talk**, введите имя для службы и дважды нажмите кнопку **ОК**.

	В этом руководстве используется имя **mobile1**. Укажите уникальное имя для своей службы BizTalk.

	После завершения этой процедуры в области **Уведомления** будет мигать зеленым надпись **УСПЕШНО**, а в колонке **Гибридное подключение** появится новое гибридное подключение с состоянием **Не подключено**.

	![Создано одно гибридное подключение](./media/app-service-mobile-dotnet-backend-hybrid-connections-get-started-preview/hybrid-connection-created.png)

На этот момент вы завершили важную часть облачной инфраструктуры гибридных подключений. Далее вы создадите соответствующую локальную часть.

## Установка локального диспетчера гибридных подключений для выполнения подключения

[AZURE.INCLUDE [app-service-hybrid-connections-manager-install](../../includes/app-service-hybrid-connections-manager-install.md)]

## Настройка проекта серверной части мобильного приложения для подключения к базе данных сервера SQL Server

На этом этапе задается строка подключения для локальной базы данных, после чего в серверную часть мобильного приложения вносятся изменения, чтобы она использовала это подключение.

1. В Visual Studio 2013 откройте проект для серверной части вашего мобильного приложения.

	Инструкции по загрузке проекта серверной части .NET см. в [руководстве по быстрому началу работы](app-service-mobile-dotnet-backend-windows-store-dotnet-get-started-preview.md).

2. В обозревателе решений откройте файл Web.config, найдите раздел **connectionStrings** и добавьте новую запись SqlClient (см. пример ниже), которая указывает на локальную базу данных SQL Server:

	    <add name="OnPremisesDBConnection"
         connectionString="Data Source=OnPremisesServer,1433;
         Initial Catalog=OnPremisesDB;
         User ID=HybridConnectionLogin;
         Password=<**secure_password**>;
         MultipleActiveResultSets=True"
         providerName="System.Data.SqlClient" />

	Не забудьте заменить `<**secure_password**>` в этой строке паролем, созданным для объекта *HbyridConnectionLogin*.

3. Щелкните кнопку **Сохранить** в Visual Studio, чтобы сохранить файл Web.config.

	> [AZURE.NOTE]Эти параметры подключения используются при запуске на локальном компьютере. При запуске в среде Azure они заменяются строкой подключения, определенной на портале.

4. Разверните папку **Модели** и откройте файл модели данных, заканчивающийся на *Context.cs*.

6. Измените конструктор экземпляра **DbContext** таким образом, чтобы он передавал значение `OnPremisesDBConnection` в базовый конструктор **DbContext**, с помощью кода наподобие следующего:

        public class hybridService1Context : DbContext
        {
            public hybridService1Context()
                : base("OnPremisesDBConnection")
            {
            }
        }

	Теперь служба будет использовать новую строку подключения для базы данных SQL Server.

## Внесение изменений в среду Azure для использования локальной строки подключения

Далее, чтобы использовать новую строку подключения среды Azure, вам нужно добавить в нее параметр приложения.

1. На [портале Azure] в коде серверной части веб-приложения для своего мобильного приложения щелкните **Все параметры** и выберите **Параметры приложения**.

3. В колонке **Параметры веб-приложения** прокрутите содержимое до раздела **Строки подключения** и добавьте новую строку **SQL Server** с названием `OnPremisesDBConnection` и значением наподобие `Server=OnPremisesServer,1433;Database=OnPremisesDB;User ID=HybridConnectionsLogin;Password=<**secure_password**>`.

	Замените `<**secure_password**>` надежным паролем для локальной базы данных.

	![Строка подключения для локальной базы данных](./media/app-service-mobile-dotnet-backend-hybrid-connections-get-started-preview/set-sql-server-database-connection.png)

2. Нажмите кнопку **Сохранить**, чтобы сохранить созданное гибридное подключение и строку подключения.

## Публикация и тестирование серверной части мобильного приложения в среде Azure

Теперь необходимо опубликовать серверную часть мобильного приложения в среде Azure и убедиться в том, что оно использует гибридное подключение для хранения данных в локальной базе.

3. В Visual Studio щелкните правой кнопкой мыши проект и выберите **Опубликовать** > **Опубликовать веб-сайт** > **Веб-сайты Microsoft Azure**.

	Вместо Visual Studio для публикации серверной части также можно [использовать Git](mobile-services-dotnet-backend-store-code-source-control.md).

2. Войдите с помощью учетных данных Azure и выберите свою службу в списке **Выберите существующие веб-сайты**.

	Visual Studio загрузит параметры публикации прямо из Azure.

3. Чтобы завершить, нажмите кнопку **Опубликовать**.

	После завершения публикации служба будет перезапущена и появится начальная страница серверной части.

4. С помощью кнопки **Попробовать сейчас** на начальной странице или клиентского приложения, подключенного к вашему мобильному приложению, выполните несколько операций, которые вносят изменения в базу данных.

	>[AZURE.NOTE]При вызове страниц API справки с помощью кнопки **Попробовать сейчас** не забудьте указать в качестве пароля (с пустым именем пользователя) свой ключ приложения.

4. В SQL Server Management Studio подключитесь к своему экземпляру SQL Server, а затем в обозревателе объектов разверните базу данных **OnPremisesDB** и узел **Таблицы**.

5. Щелкните правой кнопкой мыши таблицу **hybridService1.TodoItems** и выберите команду **Выбрать первые 1000 строк**, чтобы просмотреть результаты.

	Обратите внимание на то, что изменения, созданные в клиентском приложении, были сохранены серверной частью вашего мобильного приложения в локальной базе данных с помощью гибридного подключения.

## См. также ##

+ [Веб-сайт гибридных подключений](../../services/biztalk-services/)
+ [Обзор гибридных подключений](../integration-hybrid-connection-overview.md)
+ [Службы BizTalk: вкладки "Панель мониторинга", "Монитор", "Масштаб", "Настройка" и "Гибридные подключения"](../biztalk-dashboard-monitor-scale-tabs.md)
+ [Изменение модели данных в серверной мобильной службе для .NET](../mobile-services-dotnet-backend-how-to-use-code-first-migrations.md)

<!-- IMAGES -->


<!-- Links -->
[портала Azure]: https://portal.azure.com/
[портале Azure]: https://portal.azure.com/
[Azure Management Portal]: http://go.microsoft.com/fwlink/p/?linkid=213885
[Get started with Mobile Services]: ../mobile-services-dotnet-backend-windows-store-dotnet-get-started.md

<!---HONumber=Oct15_HO4-->