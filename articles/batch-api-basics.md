<properties 
	pageTitle="Основные сведения об API Пакетной службы Azure" 
	description="Основные понятия для ознакомления разработчиков с API Пакетной службы Azure и Пакетной службой" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="03/19/2015" 
	ms.author="yidingz"/>

<!--The next line, with one pound sign at the beginning, is the page title-->
# Основные сведения об API Пакетной службы Azure

Пакетная служба Azure предоставляет платформу планирования заданий для масштабируемых и распределенных вычислений. Пакетная служба обслуживает набор виртуальных машин, расположенных в разных кластерах и центрах обработки данных Microsoft Azure. Пакетная служба выполняет распределенные вычисления путем запуска одной или нескольких программ на указанном наборе виртуальных машин по требованию или запланированных на определенное время. Пакетная служба управляет виртуальными машинами для выполнения вычислительных задач в соответствии с потребностями в ресурсах, спецификациями и указанными ограничениями.

Пакетная служба позволяет избавиться от необходимости писать код для организации очереди, планирования, выделения вычислительных ресурсов и управления ими. Это дает возможность сосредоточиться на конкретном приложении и не беспокоиться о сложности планирования заданий и управления ресурсами базовой платформы. Это также позволяет Пакетной службе оптимизировать расположение заданий и их доступ к данным, которые необходимо обработать.

Ниже приведены некоторые сценарии, которые можно реализовать с помощью Пакетной службы:

- Параллельная обработка больших объемов вычислений.

- Ежедневная очистка файлов.

- Пакетная обработка.

## <a name="resource"></a> Ресурсы пакета службы

При использовании Пакетной службы можно воспользоваться следующими ресурсами:

- [Учетная запись](#account)

- [Задача виртуальной машины](#taskvm)

- [Пул](#pool)

- [Рабочий элемент](#workitem)

- [Задание](#job)

- [Задача](#task)

	- [Запустить задачу](#starttask)
	
	- [Задание ManagerTask](#jobmanagertask)

### <a name="account"></a>Учетная запись

Учетная запись Пакетной службы — это уникально идентифицируемая сущность в Пакетной службе. Вся обработка данных осуществляется через учетную запись Пакетной службы. Для выполнения операций с помощью Пакетной службы нужно знать имя учетной записи и ее ключ. Создание пакета учетной записи, обратитесь к пакета учетной записи [Обзор пакета Azure][].


### <a name="taskvm"></a>Задача виртуальной машины

Виртуальная машина задач (ВМЗ) — это виртуальная машина Microsoft Azure, выделенная вашему приложению для определенной рабочей нагрузки. Размер ВМЗ определяет количество ядер ЦП, объем памяти и размер локальной файловой системы, которые выделяются для ВМЗ. TVM может быть небольшой, большие или extralarge виртуальной машины, как описано в [виртуальной машины размеры и облачных служб для Azure](http://msdn.microsoft.com/library/dn197896.aspx).

Типы программ, которые могут выполняться на ВМЗ, включают в себя исполняемые файлы (EXE-файлы), командные файлы (CMD-файлы), пакетные файлы (BAT-файлы) и файлы сценариев. ВМЗ также имеет следующие атрибуты:

- Папки файловой системы, связанные с задачами и Общие. На каждый пул виртуальных Машин создаются папки структуры и переменных среды. Следующая структура папок создается в папке «общий» для приложений и данных, общим для задачи, а также папки для каждой задачи.

![][1]

- Файлы stdout.txt и stderr.txt, которые записываются в папку задачи.

- Переменные среды для обработки.

- Параметры брандмауэра, настроенные для управления доступом.

>Доступ к ВМ
>
>Если для отладки, например необходим доступ к виртуальной машине, RDP-файл можно получить, который затем может использоваться для доступа к виртуальной Машине через удаленный рабочий стол.


### <a name="pool"></a>Пул

Пул — это коллекция ВМЗ, на которых выполняется приложение. Пул может быть создан как вами, так и автоматически Пакетной службой при указании выполняемых работ. Вы можете создать и настроить пул таким образом, чтобы он удовлетворял требованиям вашего приложения. Пул может использоваться только той учетной записью Пакетной службы, с помощью которой он был создан. Учетная запись Пакетной службы может содержать более одного пула.

Пулы Azure пакета сборки на платформе Azure вычислительные ядра; Пакет пулы обеспечивают крупномасштабных распределения, приложения и установки данных, перемещения данных, наблюдение за работоспособностью и гибкое масштабирование Виртуальной машины.

Каждой добавляемой к пулу ВМЗ присваивается уникальное имя и IP-адрес. При удалении ВМЗ из пула она теряет все изменения, внесенные в операционную систему, все локальных файлы, свое имя и IP-адрес. Когда ВМЗ покидает пул, она перестает существовать.

Пул можно настроить, чтобы обеспечивать обмен данными между ВМЗ внутри него. Если для пула был затребован внутренний обмен данными, Пакетная служба для всех ВМЗ пула сделает доступными порты с номерами больше 1100. Каждая ВМЗ пула настраивается таким образом, чтобы ограничить входящие подключения только данным диапазоном портов и принимать подключения только от других ВМЗ пула. Если приложению не требуется обмен данными с другими ВМЗ, Пакетная служба потенциально может выделить для пула большое количество ВМЗ из различных кластеров и центров обработки данных, чтобы еще больше распараллелить обработку.

При создании пула можно указать следующие атрибуты:

-  **Размер виртуальных машин** в пуле.
	- Соответствующий размер виртуальной Машины необходимо выбрать, в зависимости от характеристик и требований приложений или приложений, которые будут использоваться на виртуальной Машине. Обычно размер виртуальной Машины будет получено при условии, что одна задача будет выполняться одновременно виртуальной машины; Например, является ли приложение многопоточного и объем памяти, которую требуется определит размер виртуальной Машины наиболее подходящий и экономичный. Можно иметь несколько назначенных задач и несколько экземпляров приложения, которые выполняются параллельно, в этом случае большего размера виртуальной Машины обычно выбирается — см. ниже «максимальное задачи на виртуальную Машину». 
	- Все ВМ в пуле должны быть одного размера. Для выполнения требований к другой системы или с другой нагрузки при различных приложений следует создать отдельные пулы.
	- Все размеры виртуальной Машины облачной службы можно настроить для пула, за исключением A0.

- Семейство операционных систем и версии, работающей на виртуальных машинах.
	- Как и рабочих ролей, можно настроить ОС семейства и версии ОС.
	- Семейство ОС также определяет, какие версии .NET устанавливаются вместе с операционной Системой.
	- Как с рабочих ролей для версии операционной системы рекомендуется "*" использовать таким образом, являются Виртуальной машины автоматически обновленных и нет нет работы, необходимой для адаптации новых версий. Чтобы убедиться, что сохраняется совместимость приложений, что обеспечивает обратную совместимость, проверка выполняется перед предоставлением версии обновляемого — основного варианта использования для выбора конкретной версии ОС. После проверки версии операционной системы для пула могут быть обновлены и установки нового образа ОС — любой работающей задачи будет прервана и повторно в очереди.

- Число целевых виртуальных машин, которые должны быть доступны для пула.

- Политика масштабирования для пула. Помимо число виртуальных машин можно также указать формулу автоматическое масштабирование для каждого пула. Пакет обновления будет выполняться формулу, измените число виртуальных Машин на основе статистики пула и рабочих элементов.

- Планирование конфигурации
	- В конфигурации по умолчанию для одной задачи для выполнения в любое время в пуле виртуальных Машин, но существуют сценарии, где полезно иметь более одной задачи, которые смогут запускать одновременно на виртуальной Машине. Примером может послужить увеличить использование виртуальной Машины, если приложение должно ожидать ввода-вывода; наличие более одного приложения выполнение приведет к увеличению загрузки ЦП. Другой пример — чтобы уменьшить число Виртуальных машин в пул; Это может уменьшить количество копий данных, необходимые для ссылки на большие наборы данных. A1 ли требуемый размер для приложения, может быть выбрана A4, и настройки для запуска до 8 задач за один раз, каждый использует ядро.
	- Конфигурация «max задачи на виртуальную Машину» определяет максимальное число задач, которые могут выполняться параллельно.
	- «Fill политики» можно также задать определяют ли пакет заполняет первой Виртуальной машины или ли задачи находятся на ВМ.
 
- Состояние связи ВМ в пуле.
 	- Большая часть сценариев задачи работают независимо друг от друга и не требуется взаимодействие с другими задачами, но существуют некоторые приложения, где задачи будут обмениваться данными (например, приложения с помощью MPI).
	- Нет конфигурации, управляет ли Виртуальной машины смогут обмениваться данными, которая используется для настройки базовой сетевой инфраструктуры и влияет на размещение Виртуальной машины.

- Задача запуска для ВМЗ в пуле.

При создании пула можно указать учетную запись хранения, с которой необходимо связать пул. Пакетная служба выделяет ВМЗ в центрах обработки данных с наилучшим сетевым соединением и пропускной способностью сети для указанной учетной записи хранения. Это обеспечивает рабочим нагрузкам более эффективный доступ к данным.

### <a name="workitem"></a>Рабочий элемент

Рабочий элемент указывает, как следует выполнять вычисления на ВМЗ в пуле.

- Рабочий элемент может иметь один или несколько заданий, связанных с ним. Необязательный расписания можно задать для рабочего элемента в этом случае одно задание создается для каждого вхождения расписания. Если расписание не задано, для работы по требованию, задание создается немедленно.
- Рабочий элемент указывает пула, на которой будет выполняться работа. Пул может быть существующим, уже создан пул, используется множество рабочих элементов, но пул могут также создаваться для каждого задания, связанные с рабочим элементом, или для всех заданий, связанных с рабочим элементом.
- Можно указать необязательные приоритеты. При отправке рабочего элемента с более высоким приоритетом от других рабочих элементов по-прежнему идет высокий приоритет задачи вставляется в очередь до нижней приоритет задачи. Не будет pre-empted задачи более низким приоритетом, которые уже запущены.
- Ограничения можно указать которой будет применяться для задания или задания.
	- Можно задать время максимальное wallclock заданий. Если задания выполняется дольше, чем указанное максимальное wallclock время, будет завершено задания и все связанные задачи.
	- Пакет Azure можно определить задачи, ошибкой и повторить выполнение задач. Максимальное количество повторов задачи может быть указан как ограничение по умолчанию, включая задание, задача всегда Повторено или никогда не повторять. Повторные попытки выполнения задач означает, что задача повторно в очереди и снова будет запущен.
- Таким же образом, рабочий элемент будет создан, но задача диспетчер заданий можно указать, должна быть выполнена для задания рабочего элемента можно указать клиентом. Задачи диспетчера заданий использует API пакета и содержит код для создания необходимых задач для задания с задачей, выполняются на одном из пула виртуальных Машин. Задачи диспетчера заданий обрабатывается особым образом пакета — в очереди сразу после задания создается и перезапускается, если происходит сбой по любой причине. Диспетчер заданий является обязательным для рабочих элементов с помощью связанное расписание является единственным способом определить, какие задачи перед созданием экземпляра задания.

### <a name="job"></a>Задание

Задание является запущенным экземпляром рабочего элемента и представляет собой набор задач. Пакетная служба создает экземпляр задания на основе конфигурации рабочего элемента. Задание использует ВМЗ из пула, который связан с рабочим элементом.

### <a name="task"></a>Задача

Задача — это единица вычисления, которая связана с заданием и выполняется на ВМЗ. Задачи, назначенные виртуальной Машины для выполнения или помещаются в очередь, пока не освободится виртуальной Машины. Задача использует следующие ресурсы:

- Программа, указанная в рабочем элементе.

- Файлы ресурсов, которые содержат данные для обработки. Эти файлы автоматически копируются на ВМЗ из хранилища больших двоичных объектов. Дополнительную информацию см. в разделе «Файлы и каталоги».

- Необходимые программе параметры среды. Дополнительную информацию см. в разделе «Параметры среды для задач».

- Ограничения, в рамках которых должны выполняться вычисления. Например — максимальное время, в рамках которого задаче разрешено выполняться; максимальное количество попыток выполнить задачу в случае сбоя; максимальное время хранения файлов в рабочем каталоге.

В дополнение к задачам, которые выполняют вычисления на ВМЗ, можно использовать следующие специальные задачи, предоставляемые Пакетной службой:

- [Запустить задачу](#starttask)

- [Диспетчер рабочего задания](#jobmanagertask)

#### <a name="starttask"></a>Запустить задачу

Можно настроить операционную систему виртуальных машин в пуле, связав задачу запуска с пулом. Задача запуска может выполнять такие действия, как установка программного обеспечения или запуск фоновых процессов. Задача запуска выполняется при каждом запуске виртуальной Машины для при условии, что он остается в пуле.

Как с любой задачи пакета список файлов в хранилище Azure можно указать в дополнение к командной строки, который выполняется путем пакета. Пакет Azure будет сначала скопируйте файлы из хранилища Azure и запустите из командной строки. Для запуска задачи пула обычно содержит список файлов, файлов приложения или пакета, но она также может включать справочные данные, которые будут использоваться все задачи, выполняемые на пула виртуальных Машин. В командной строке может выполнить сценарий PowerShell или robocopy, например, чтобы скопировать файлы приложения в папку «общий»; Он также может запустить MSI.

Обычно желательно для пакета Ожидание начала задачи и готов к назначению задачи ВМ, следует, но это можно изменить.

При сбое задачи запуска виртуальной Машины в пуле, состояние виртуальной машины обновляется для отражения сбоя, и виртуальной Машины не будут доступны для задач должно быть присвоено. Задача запуска может завершиться ошибкой, если неполадка копирование файлов, указанных для запуска задачи или процесса запуска задачи возвращает ненулевое.

Тот факт, что объявлен все сведения, необходимые для настройки Виртуальной машины и устанавливать приложения, означает, что простыми, как указать новый номер требуется; увеличение числа Виртуальных машин в пул Пакет содержит все сведения, необходимые для настройки Виртуальной машины и подготовить их принимает задачи.

Задача запуска определяется путем добавления раздела JSON в тексте запроса для операции добавления пула. В следующем примере показано базовое определение задачи запуска:

	{
		“commandLine”:”mypoolsetup.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”mypoolsetup.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“maxTaskRetryCount”:0
	}

Интерфейс C# выглядит следующим образом:

	ICloudPool pool = pm.CreatePool(poolName, targetDedicated: 3, vmSize: "small", osFamily: "3");
	pool.StartTask = new StartTask();
	pool.StartTask.CommandLine = "mypoolsetup.exe";
	pool.StartTask.ResourceFiles = new List<IResourceFile>();
	pool.StartTask.ResourceFiles.Add(new ResourceFile("http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d", "mypoolsetup.exe"));
	pool.Commit();


#### <a name="jobmanagertask"></a>Диспетчер рабочего задания

Задача диспетчера заданий запускается перед выполнением всех других задач. Задача диспетчера заданий предоставляет следующие преимущества:

- Автоматически создается Пакетной службой при создании задания.

- Запускается перед выполнением других задач в задании.

- Связанная с ней ВМЗ будет удалена из пула в последнюю очередь при уменьшении размера пула.

- При перезапуске данной задаче присваивается наивысший приоритет. Если неактивная ВМЗ недоступна, Пакетная служба может завершить одну из задач, которые выполняются в пуле, чтобы освободить ресурсы для запуска задачи диспетчера заданий.

- Такое завершение задачи может привести к завершению всех задач данного задания.

Задача диспетчера заданий в задании не имеет приоритета над задачами других заданий. Приоритеты применяются только на уровне заданий. Задача диспетчера заданий определяется путем добавления раздела XML в текст запроса для операции добавления рабочего элемента. В следующем примере показано базовое определение задачи диспетчера заданий:

	{
		“name”:”jmTask”,
		“commandLine”:”myapp1.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp1.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“taskConstraints”:
		{
			“maxWallClockTime”:”PT1H”,
			“maxTaskRetryCount”:0,
			“retentionTime”:”PT1H”
		},
		“killJobOnCompletion”:true,
		“runElevated”:false,
		“runExclusive”:true
	}




## <a name="workflow"></a>Рабочий процесс службы пакета

Чтобы воспользоваться Пакетной службой и ее ресурсами для планирования вычислений, необходимо иметь учетную запись Пакетной службы. При создании сценария распределенных вычислений с помощью Пакетной службы используется следующий базовый рабочий процесс:

1. Передача файлов, которые вы хотите использовать в распределенных вычислительных сценария в учетную запись хранилища Azure. Чтобы Пакетная служба имела к ним доступ, они должны находиться в учетной записи хранения. Пакетная служба передаст их в ВМЗ при выполнении задачи.

2. Передача зависимых двоичные файлы в учетную запись хранилища. Двоичные файлы включают в себя программу, которая выполняется задачей, и зависимые сборки. Эти файлы также должны быть доступны из службы хранения и загружены в ВМЗ.

3. Создайте пул TVMs. При создании пула можно указать размер виртуальной машины задач. Когда задача запускается, ей назначается ВМЗ из этого пула.

4. Создайте рабочий элемент. Задание создается автоматически при создании рабочего элемента. Рабочий элемент позволяет управлять заданием, которое содержит задачи.

5. Добавление задачи к рабочему элементу. Каждая задача использует переданную вами программу для обработки информации из переданного вами файла.

6. отслеживать результаты вывода.

## <a name="files"></a>Файлы и каталоги

У каждой задачи есть рабочий каталог, в котором она может создавать дополнительные файлы и каталоги для хранения программы, выполняемой задачей, обрабатываемых задачей данных, а также выходных данных. Эти каталоги и файлы будут доступными для использования другим задачам во время выполнения задания. Все задачи, файлы и каталоги в ВМЗ принадлежат одной учетной записи.

Пакетная служба предоставляет часть файловой системы ВМЗ в качестве корневого каталога. Корневой каталог TVM доступен в задачу через переменную среды WATASK_TVM_ROOT_DIR. Дополнительную информацию об использовании переменных среды см. в разделе «Параметры среды для задач».

Корневой каталог содержит следующие подкаталоги:

- **Задачи** — это расположение, где все файлы хранятся, которому принадлежат задач, выполняемых на TVM. Для каждой задачи пакета службы создает рабочий каталог с уникальный путь в форме % WATASK_TVM_ROOT_DIR%/tasks/workitemName/jobName/taskName/. Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Время существования каталога определяется указанным для задачи ограничением RetentionTime.

- **Shared** — это расположение, общий каталог для всех задач в учетной записи. На TVM общий каталог находится на % WATASK_TVM_ROOT_DIR%/shared. Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в данном каталоге.

- **Запуск** — это расположение используется задачей запуска в рабочем каталоге. В этом каталоге также хранятся все файлы, скачанные Пакетной службой для выполнения задачи запуска. На TVM начального каталога является % WATASK_TVM_ROOT_DIR%/start. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Также данный каталог может использоваться задачами запуска для настройки операционной системы.

При удалении ВМЗ из пула также удаляются все хранимые на ней файлы.

## <a name="lifetime"></a>Пул и временем существования виртуальной Машины

Фундаментальные решение — при создании пулов и как долго сохраняются доступных Виртуальной машины.

С одной стороны пул может создаваться для каждого задания, при отправке задания и Виртуальной машины удаляются по мере выполнения завершения задачи. Это обеспечит максимальную использования Виртуальной машины выделяются только при крайней необходимости и завершения работы, как только они становятся простоя. Это означает, что задание необходимо подождать выделенной Виртуальной машины для выделения, несмотря на то, что важно отметить, что задачи будут планироваться для Виртуальной машины, как только они доступны по отдельности, а начальная задача завершена. т. е. пакет не ждать всех Виртуальных машин в пул доступных как это приведет к снижению использования.

При необходимости запуска задания непосредственного выполнения является приоритетом, то должен быть создан пул и виртуальной Машины доступны перед отправкой задания. Задачи можно запустить немедленно, но может быть занят и ожидает задачи задания, в зависимости от нагрузки Виртуальной машины.

Один общий шаблон для, когда существует переменный объем постоянной нагрузки должен иметь пула, в который отправляются несколько заданий, но масштабирования вверх или вниз число Виртуальной машины, в зависимости от нагрузки; Это можно сделать факту или профессиональных активно Если может быть спрогнозирован нагрузки.

## <a name="scaling"></a>Масштабирование приложений

Приложение может легко автоматически масштабироваться, подстраиваясь под потребности в вычислениях. Вы можете динамически настраивать количество ВМЗ в пуле в соответствии с текущей рабочей нагрузкой и статистикой использования ресурсов. Также вы можете оптимизировать общую стоимость выполнения приложения, настроив для него автоматическое масштабирование. Параметры масштабирования можно указать при создании пула, при этом конфигурацию можно будет обновить в любое время.

Для снижения числа Виртуальных машин может быть задачи, выполняемые на Виртуальных машинах, который необходимо учитывать. Отмена выделения политики задается которого определяет, остановлена ли выполнение задачи для удаления виртуальной Машины немедленно или задачи, разрешается ли завершить до удаления Виртуальной машины. Установка целевое количество Виртуальных машин вниз до нуля в конце задания, но разрешение на выполнение задач для завершения, максимальную эффективность использования.

Автоматическое масштабирование приложения указывается с помощью набора формул масштабирования. C помощью формул определяется количество ВМЗ в пуле для следующего интервала масштабирования. Например, вам нужно запланировать для пула большое количество задач. Вы можете назначить для пула формулу масштабирования, которая будет определять размер пула на основе текущего числа ожидающих задач и скорости их выполнения. Пакетная служба периодически вычисляет формулу и изменяет размер пула в зависимости от рабочей нагрузки.

Формула может основываться на следующих метриках:

- **Метрик времени** — на основе статистических данных собираются каждые 5 минут в указанное число часов.

- **Метрики ресурсов** – на использование ЦП, использование пропускной способности, использование памяти и количество TVMs основе.

- **Задач метрики** — на основе состояния задачи, как активных, ожидающих и завершения.

Дополнительную информацию об автоматическом масштабировании приложения см. в разделе «Настройка автоматического масштабирования виртуальных машин задач».

>Удаление Виртуальной машины
>
>Это часто не обязательно, но можно указать отдельные Виртуальной машины для удаления из пула. Если виртуальная машина, если есть подозрения, что меньше надежный он может быть удален, например.

## <a name="cert"></a>Сертификаты для приложений

При шифровании секретных данных обычно требуется использовать сертификаты. Сертификаты могут быть установлены на ВМЗ. Зашифрованные данные передаются задачам через параметры командной строки или внедряются в один из ресурсов, а установленные сертификаты могут использоваться для их расшифровки. Примером секретных данных может быть ключ для учетной записи хранения.

Чтобы добавить сертификат в учетную запись Пакетной службы, необходимо выполнить операцию добавления сертификата. Затем можно будет связать сертификат с новым или существующим пулом. После того, как сертификат будет связан с пулом, Пакетная служба установит сертификат на каждую ВМЗ в пуле. Пакетная служба установит соответствующие сертификаты при запуске ВМЗ до начала выполнения каких-либо задач, включая задачи запуска и задачи диспетчера заданий.

## <a name="scheduling"></a>Приоритет планирования

При создании рабочего элемента ему можно назначить приоритет. Все задания, которые создаются в рамках рабочего элемента, будут иметь одинаковый приоритет. Пакетная служба использует значения приоритетов задания, чтобы определять порядок выполнения заданий в рамках учетной записи при планировании. Значения приоритетов находятся в диапазоне от -1000 до 1000, при этом значение -1000 является наименьшим приоритетом, а 1000 — наивысшим. Приоритет задания можно обновить с помощью операции обновления задания.

В рамках одной учетной записи задания с высоким приоритетом имеют приоритет при планировании относительно заданий с низким приоритетом. Задания с более высоким приоритетом, относящиеся к одной учетной записи, не имеют приоритета при планировании относительно других заданий с более низким приоритетом, относящихся к другой учетной записи.

Задания из разных пулов планируются независимо. В разных пулах не гарантируется, что задание с более высоким приоритетом будет запланировано в первую очередь, если связанный с ним пул не имеет достаточно неактивных ВМЗ. В одном пуле задания с одинаковым приоритетом имеют одинаковую вероятность добавления в расписание.

## <a name="environment"></a>Параметры среды для задач

Вы можете указать параметры среды, которые будут использоваться в контексте задачи. Параметры среды для задачи запуска и задач, выполняемых в рамках задания, определяются путем добавления раздела XML в текст запроса операций добавления или обновления задачи.

В следующем примере показано, как определяются параметры среды:

Для каждой задачи, запланированной в задании, Пакетная служба определяет набор переменных среды. В следующей таблице перечислены переменные среды, которые устанавливаются Пакетной службой для всех задач.

<table>
  <tr>
   <th>Имя переменной среды
   </th>
   <th>
   Описание
   </th>
  </tr>
 <tr>
  <td>
  WATASK_ ACCOUNT_NAME
  </td>
  <td>
  Имя учетной записи, которой принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_WORKITEM_NAME
  </td>
  <td >Имя рабочего элемента, которому принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_JOB_NAME
  </td>
  <td >Имя задания, которому принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TASK_NAME
  </td>
  <td >Имя текущей задачи.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_POOL_NAME
  </td>
  <td >Имя пула, в котором выполняется задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_NAME
  </td>
  <td >Имя ВМЗ, на которой выполняется задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_ROOT_DIR
  </td>
  <td >Полный путь к корневому каталогу на ВМЗ.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_PORTRANGE_LOW WATASK_PORTRANGE_HIGH
</td>
<td>
  Диапазон портов (включая граничные порты), которые задача может использовать для обмена данными внутри пула (если обмен данными внутри пула включен).
</td>
</table>

**Примечание**

Эти переменные определяются системой и их нельзя переопределить.

Значения параметров среды можно получить с помощью операции получения задачи.

## <a name="errorhandling"></a>Обработка ошибок

###Обработка сбоев задач
Сбои задачи делятся на следующие категории:

- Планирование ошибок:
	- Если файлы, указанные для задачи, сбой копирования одного или нескольких файлов. Возможно, файлы были перемещены, учетной записи хранилища больше не доступен, и т.д.
	- В этом случае «Планирования ошибка» имеет значение для задачи.
- Ошибки приложений:
	- Рабочий процесс, указанный с помощью командной строки может завершиться неудачно. Процесс будет учтен как ошибочный при возврате кода выхода ненулевой длины.
	- Об ошибках в приложении можно настроить пакет автоматически повторить задачи до указанное число раз. 
- Нарушение ограничения:
	- Ограничение можно задать для максимальное количество времени, можно выполнять задания или задачи. Можно использовать для завершения задачи, произошло зависание.
	- Когда превышено максимальное количество времени затем задача помечается как завершенная, но выход код будет помечен как `0xC000013A` и schedulingError поля будут помечены как `{ category:“ServerError”, code=“TaskEnded”}`.

###Отладка ошибок приложения

Приложение может создавать диагностики, который может использоваться для устранения неполадок. Часто приложения будет записывать информацию в stdout и stderr файлы или выходных данных пользовательских файлов. В этих случаях API предоставляется для получения файлов, указав задачи или виртуальной Машины.

Можно также войти в пул виртуальных Машин. API-Интерфейс возвращает RDP-файл для виртуальной Машины, который можно использовать для входа на виртуальную машину.

###Поставка продуктов для сбоев и проблемы

Задачи может завершиться ошибкой или прерван по нескольким причинам. Само приложение задач может завершиться ошибкой, получает перезагрузка виртуальной Машины, на котором выполняется задача или удаления виртуальной Машины, изменение размера пула с политикой Отмена выделения немедленно удалить виртуальную Машину без ожидания завершения выполнения задачи. Во всех случаях задача может быть автоматически повторно в очереди пакета и выполнение на другой виртуальной Машины.

Можно также периодически возникающие проблемы приводит к зависанию или слишком много времени для выполнения задачи. Максимальное время выполнения может быть набор для задачи, и если превышен пакет приведет к прерыванию задач приложения. В настоящее время автоматическое повторное очереди не поддерживается для этого случая, но регистр могут определяться с помощью клиента, который можно отправить новую задачу.

###Поставка продуктов для «Плохое» виртуальной Машины

Каждая виртуальная машина в пуле присваивается уникальное имя и ВМ, на котором выполняется задача включены в метаданных задачи. В случае, где нет виртуальной Машины, которая по некоторым причинам вызывает сбой задачи, а затем может определяться клиентом и подозрительная виртуальной Машины, удаленные из пула. Если задача выполняется на виртуальной Машине, которая была удалена, затем он будет автоматически повторно очередь и выполнять их на другой виртуальной Машины.


<!--Image references-->
[1]: ./media/batch-api-basics/batch-api-basics-01.png

[Обзор пакета Azure]: batch-technical-overview.md

<!---HONumber=GIT-SubDir-->