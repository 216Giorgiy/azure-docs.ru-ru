<properties 
	pageTitle="Основные сведения об API Пакетной службы Azure" 
	description="Основные понятия для ознакомления разработчиков с API Пакетной службы Azure и Пакетной службой" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="02/02/2015" 
	ms.author="yidingz, kabatta"/>


<!--The next line, with one pound sign at the beginning, is the page title--> 
# Основные сведения об API Пакетной службы Azure

Пакетная служба Azure предоставляет платформу планирования заданий для масштабируемых и распределенных вычислений. Пакетная служба обслуживает набор виртуальных машин, расположенных в разных кластерах и центрах обработки данных Microsoft Azure. Пакетная служба выполняет распределенные вычисления путем запуска одной или нескольких программ на указанном наборе виртуальных машин по требованию или запланированных на определенное время. Пакетная служба управляет виртуальными машинами для выполнения вычислительных задач в соответствии с потребностями в ресурсах, спецификациями и указанными ограничениями.

Пакетная служба позволяет избавиться от необходимости писать код для организации очереди, планирования, выделения вычислительных ресурсов и управления ими. Это дает возможность сосредоточиться на конкретном приложении и не беспокоиться о сложности планирования заданий и управления ресурсами базовой платформы. Это также позволяет Пакетной службе оптимизировать расположение заданий и их доступ к данным, которые необходимо обработать.

Ниже приведены некоторые сценарии, которые можно реализовать с помощью Пакетной службы:

- Параллельная обработка больших объемов вычислений.

- Ежедневная очистка файлов.

- Пакетная обработка.

Дополнительную информацию о Пакетной службе можно получить, ознакомившись со следующими разделами:

- [Ресурсы Пакетной службы](#resource)

- [Рабочий процесс Пакетной службы](#workflow)

- [Файлы и каталоги](#file)

- [Масштабирование приложений](#scaling)

- [Сертификаты для приложений](#cert)

- [Приоритеты планирования](#scheduling)

- [Параметры среды для задач](#environment)

## <a name="resource"></a> Ресурсы Пакетной службы

При использовании Пакетной службы можно воспользоваться следующими ресурсами:

- [Учетная запись](#account)

- [Виртуальная машина задач](#taskvm)

- [Пул](#pool)

- [Рабочий элемент](#workitem)

- [Job](#job)

- [Задача](#task)

### <a name="account"></a>Учетная запись

Учетная запись Пакетной службы - это уникально идентифицируемая сущность в Пакетной службе. Вся обработка данных осуществляется через учетную запись Пакетной службы. Для выполнения операций с помощью Пакетной службы нужно знать имя учетной записи и ее ключ. В настоящее время для создания новой учетной записи необходимо обратиться к рабочей группе Пакетной службы Azure. После создания учетной записи вам будет предоставлен ключ.

### <a name="taskvm"></a>Виртуальная машина задач

Виртуальная машина задач (ВМЗ) - это виртуальная машина Microsoft Azure, выделенная вашему приложению для определенной рабочей нагрузки. Размер ВМЗ определяет количество ядер ЦП, объем памяти и размер локальной файловой системы, которые выделяются для ВМЗ. Значение размера ВМЗ может быть Small, Large и ExtraLarge. Дополнительную информацию см. в разделе [Размеры виртуальных машин и облачных служб Microsoft Azure](http://msdn.microsoft.com/library/dn197896.aspx).

Типы программ, которые могут выполняться на ВМЗ, включают в себя исполняемые файлы (EXE-файлы), командные файлы (CMD-файлы), пакетные файлы (BAT-файлы) и файлы сценариев. ВМЗ также имеет следующие атрибуты:

- Связанные с задачей папки файловой системы, которые также являются общими.

- Файлы stdout.txt и stderr.txt, которые записываются в папку задачи.

- Переменные среды для обработки.

- Параметры брандмауэра, настроенные для управления доступом.

### <a name="pool"></a>Пул

Пул - это коллекция ВМЗ, на которых выполняется приложение. Пул может быть создан как вами, так и автоматически Пакетной службой при указании выполняемых работ. Вы можете создать и настроить пул таким образом, чтобы он удовлетворял требованиям вашего приложения. Пул может использоваться только той учетной записью Пакетной службы, с помощью которой он был создан. Учетная запись Пакетной службы может содержать более одного пула.

Каждой добавляемой к пулу ВМЗ присваивается уникальное имя и IP-адрес. При удалении ВМЗ из пула она теряет все изменения, внесенные в операционную систему, все локальных файлы, свое имя и IP-адрес. Когда ВМЗ покидает пул, она перестает существовать.

Пул можно настроить, чтобы обеспечивать обмен данными между ВМЗ внутри него. Если для пула был затребован внутренний обмен данными, Пакетная служба для всех ВМЗ пула сделает доступными порты с номерами больше 1100. Каждая ВМЗ пула настраивается таким образом, чтобы ограничить входящие подключения только данным диапазоном портов и принимать подключения только от других ВМЗ пула. Если приложению не требуется обмен данными с другими ВМЗ, Пакетная служба потенциально может выделить для пула большое количество ВМЗ из различных кластеров и центров обработки данных, чтобы еще больше распараллелить обработку.

При создании пула можно указать следующие атрибуты:

- Размер ВМЗ в пуле.

- Семейство и версию операционных систем, выполняемых на ВМЗ.

- Количество доступных для пула ВМЗ.

- Политика масштабирования для пула.

- Состояние обмена данными ВМЗ внутри пула.

- Задача запуска для ВМЗ в пуле.

При создании пула можно указать учетную запись хранения, с которой необходимо связать пул. Пакетная служба выделяет ВМЗ в центрах обработки данных с наилучшим сетевым соединением и пропускной способностью сети для указанной учетной записи хранения. Это обеспечивает рабочим нагрузкам более эффективный доступ к данным.

### <a name="workitem"></a>Рабочий элемент

Рабочий элемент указывает, как следует выполнять вычисления на ВМЗ в пуле. Рабочий элемент включает в себя следующие элементы конфигурации:

1.Программа, которая выполняет обработку на ВМЗ.

2.Параметры командной строки для программы.

3.Приоритет вычислений.

4.Расписание вычислений, включая определение параметров для повторяющихся вычислений.

Рабочий элемент всегда связан с пулом (уже существующим или созданным автоматически при создании рабочего элемента).

### <a name="job"></a>Job

Задание является запущенным экземпляром рабочего элемента и представляет собой набор задач. Пакетная служба создает экземпляр задания на основе конфигурации рабочего элемента. Задание использует ВМЗ из пула, который связан с рабочим элементом.

### <a name="task"></a>Задача

Задача - это единица вычисления, которая связана с заданием и выполняется на ВМЗ. Задача использует следующие ресурсы:

- Программа, указанная в рабочем элементе.

- Файлы ресурсов, которые содержат данные для обработки. Эти файлы автоматически копируются на ВМЗ из хранилища больших двоичных объектов. Дополнительную информацию см. в разделе "Файлы и каталоги".

- Необходимые программе параметры среды. Дополнительную информацию см. в разделе "Параметры среды для задач".

- Ограничения, в рамках которых должны выполняться вычисления. Например - максимальное время, в рамках которого задаче разрешено выполняться; максимальное количество попыток выполнить задачу в случае сбоя; максимальное время хранения файлов в рабочем каталоге.

В дополнение к задачам, которые выполняют вычисления на ВМЗ, можно использовать следующие специальные задачи, предоставляемые Пакетной службой:

- [Задача запуска.](#starttask)

- [Задача диспетчера заданий.](#jobmanagertask)

#### <a name="starttask"></a>Задача запуска

Операционную систему ВМЗ можно настроить, связав задачу запуска с пулом. Задача запуска может выполнять такие действия, как установка программного обеспечения или запуск фоновых процессов. Задача запуска выполняется каждый раз при запуске ВМЗ при условии, что ВМЗ остается в пуле.

Задача запуска определяется путем добавления раздела XML в текст запроса для операции добавления пула. В следующем примере показано базовое определение задачи запуска:

	{
		"commandLine":"mypoolsetup.exe",
		"resourceFiles":
		[
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"mypoolsetup.exe"
			},
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp2.exe"
			}
		],
		"maxTaskRetryCount":0
	}


#### <a name="jobmanagertask"></a>Задача диспетчера заданий

Задача диспетчера заданий запускается перед выполнением всех других задач. Задача диспетчера заданий предоставляет следующие преимущества:

- Автоматически создается Пакетной службой при создании задания.

- Запускается перед выполнением других задач в задании.

- Связанная с ней ВМЗ будет удалена из пула в последнюю очередь при уменьшении размера пула.

- При перезапуске данной задаче присваивается наивысший приоритет. Если неактивная ВМЗ недоступна, Пакетная служба может завершить одну из задач, которые выполняются в пуле, чтобы освободить ресурсы для запуска задачи диспетчера заданий.

- Такое завершение задачи может привести к завершению всех задач данного задания.

Задача диспетчера заданий в задании не имеет приоритета над задачами других заданий. Приоритеты применяются только на уровне заданий. Задача диспетчера заданий определяется путем добавления раздела XML в текст запроса для операции добавления рабочего элемента. В следующем примере показано базовое определение задачи диспетчера заданий:

	{
		"name":"jmTask",
		"commandLine":"myapp1.exe",
		"resourceFiles":
		[
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp1.exe"
			},
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp2.exe"
			}
		],
		"taskConstraints":
		{
			"maxWallClockTime":"PT1H",
			"maxTaskRetryCount":0,
			"retentionTime":"PT1H"
		},
		"killJobOnCompletion":true,
		"runElevated":false,
		"runExclusive":true
	}




## <a name="workflow"></a>Рабочий процесс Пакетной службы

Чтобы воспользоваться Пакетной службой и ее ресурсами для планирования вычислений, необходимо иметь учетную запись Пакетной службы. При создании сценария распределенных вычислений с помощью Пакетной службы используется следующий базовый рабочий процесс:

1.Передайте файлы, которые необходимо использовать в сценарии распределенных вычислений, в учетную запись хранения Azure. Чтобы Пакетная служба имела к ним доступ, они должны находиться в учетной записи хранения. Пакетная служба передаст их в ВМЗ при выполнении задачи.

2.Передайте зависимые двоичные файлы в учетную запись хранения. Двоичные файлы включают в себя программу, которая выполняется задачей, и зависимые сборки. Эти файлы также должны быть доступны из службы хранения и загружены в ВМЗ.

3.Создайте пул ВМЗ. При создании пула можно указать размер виртуальной машины задач. Когда задача запускается, ей назначается ВМЗ из этого пула.

4.Создайте рабочий элемент. Задание создается автоматически при создании рабочего элемента. Рабочий элемент позволяет управлять заданием, которое содержит задачи.

5.Добавьте задачи в рабочий элемент. Каждая задача использует переданную программу для обработки информации из переданного вами файла.

6.Отслеживайте выходные данные.

## <a name="files"></a>Файлы и каталоги

У каждой задачи есть рабочий каталог, в котором она может создавать дополнительные файлы и каталоги для хранения программы, выполняемой задачей, обрабатываемых задачей данных, а также выходных данных. Эти каталоги и файлы будут доступными для использования другим задачам во время выполнения задания. Все задачи, файлы и каталоги в ВМЗ принадлежат одной учетной записи.

Пакетная служба предоставляет часть файловой системы ВМЗ в качестве корневого каталога. Корневой каталог ВМЗ доступен для задачи через переменную среды WATASK_TVM_ROOT_DIR. Дополнительную информацию об использовании переменных среды см. в разделе "Параметры среды для задач".

Корневой каталог содержит следующие подкаталоги:

- **Tasks** - в этом расположении хранятся все файлы выполняемых на ВМЗ задач. Для каждой задачи Пакетная служба создает рабочий каталог, который умеет уникальный путь вида %WATASK_TVM_ROOT_DIR%/tasks/workitemName/jobName/taskName/. Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Время существования каталога определяется указанным для задачи ограничением RetentionTime.

- **Shared** - это общий каталог для всех задач учетной записи. На ВМЗ этот каталог имеет путь вида %WATASK_TVM_ROOT_DIR%/shared. Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в данном каталоге.

- **Start** - это расположение используется задачей запуска в качестве рабочего каталога. В этом каталоге также хранятся все файлы, скачанные Пакетной службой для выполнения задачи запуска. На ВМЗ каталог запуска расположен по пути вида %WATASK_TVM_ROOT_DIR%/start. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Также данный каталог может использоваться задачами запуска для настройки операционной системы.

При удалении ВМЗ из пула также удаляются все хранимые на ней файлы.

## <a name="scaling"></a>Масштабирование приложений

Приложение может легко автоматически масштабироваться, подстраиваясь под потребности в вычислениях. Вы можете динамически настраивать количество ВМЗ в пуле в соответствии с текущей рабочей нагрузкой и статистикой использования ресурсов. Также вы можете оптимизировать общую стоимость выполнения приложения, настроив для него автоматическое масштабирование. Параметры масштабирования можно указать при создании пула, при этом конфигурацию можно будет обновить в любое время.

Автоматическое масштабирование приложения указывается с помощью набора формул масштабирования. C помощью формул определяется количество ВМЗ в пуле для следующего интервала масштабирования. Например, вам нужно запланировать для пула большое количество задач. Вы можете назначить для пула формулу масштабирования, которая будет определять размер пула на основе текущего числа ожидающих задач и скорости их выполнения. Пакетная служба периодически вычисляет формулу и изменяет размер пула в зависимости от рабочей нагрузки.

Формула может основываться на следующих метриках:

- **Метрики времени** - основываются на статистических данных, которые собираются каждые 5 минут за указанное число часов.

- **Метрики ресурсов** - основываются на загрузке ЦП, уровне использования пропускной способности, использования памяти и количестве ВМЗ.

- **Метрики задач** - основываются на состоянии задач (активных, ожидающих и завершенных).

Дополнительную информацию об автоматическом масштабировании приложения см. в разделе "Настройка автоматического масштабирования виртуальных машин задач".

## <a name="cert"></a>Сертификаты для приложений

При шифровании секретных данных обычно требуется использовать сертификаты. Сертификаты могут быть установлены на ВМЗ. Зашифрованные данные передаются задачам через параметры командной строки или внедряются в один из ресурсов, а установленные сертификаты могут использоваться для их расшифровки. Примером секретных данных может быть ключ для учетной записи хранения.

Чтобы добавить сертификат в учетную запись Пакетной службы, необходимо выполнить операцию добавления сертификата. Затем можно будет связать сертификат с новым или существующим пулом. После того, как сертификат будет связан с пулом, Пакетная служба установит сертификат на каждую ВМЗ в пуле. Пакетная служба установит соответствующие сертификаты при запуске ВМЗ до начала выполнения каких-либо задач, включая задачи запуска и задачи диспетчера заданий.

## <a name="scheduling"></a>Приоритеты планирования

При создании рабочего элемента ему можно назначить приоритет. Все задания, которые создаются в рамках рабочего элемента, будут иметь одинаковый приоритет. Пакетная служба использует значения приоритетов задания, чтобы определять порядок выполнения заданий в рамках учетной записи при планировании. Значения приоритетов находятся в диапазоне от -1000 до 1000, при этом значение -1000 является наименьшим приоритетом, а 1000 - наивысшим. Приоритет задания можно обновить с помощью операции обновления задания.

В рамках одной учетной записи задания с высоким приоритетом имеют приоритет при планировании относительно заданий с низким приоритетом. Задания с более высоким приоритетом, относящиеся к одной учетной записи, не имеют приоритета при планировании относительно других заданий с более низким приоритетом, относящихся к другой учетной записи.

Задания из разных пулов планируются независимо. В разных пулах не гарантируется, что задание с более высоким приоритетом будет запланировано в первую очередь, если связанный с ним пул не имеет достаточно неактивных ВМЗ. В одном пуле задания с одинаковым приоритетом имеют одинаковую вероятность добавления в расписание.

## <a name="environment"></a>Параметры среды для задач

Вы можете указать параметры среды, которые будут использоваться в контексте задачи. Параметры среды для задачи запуска и задач, выполняемых в рамках задания, определяются путем добавления раздела XML в текст запроса операций добавления или обновления задачи.

В следующем примере показано, как определяются параметры среды:

Для каждой задачи, запланированной в задании, Пакетная служба определяет набор переменных среды. В следующей таблице перечислены переменные среды, которые устанавливаются Пакетной службой для всех задач.

<table>
  <tr>
   <th>Имя переменной среды
   </th>
   <th>
   Описание
   </th>
  </tr>
 <tr>
  <td>
  WATASK_ ACCOUNT_NAME
  </td>
  <td>
  Имя учетной записи, которой принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_WORKITEM_NAME
  </td>
  <td >Имя рабочего элемента, которому принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_JOB_NAME
  </td>
  <td >Имя задания, которому принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TASK_NAME
  </td>
  <td >Имя текущей задачи.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_POOL_NAME
  </td>
  <td >Имя пула, в котором выполняется задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_NAME
  </td>
  <td >Имя ВМЗ, на которой выполняется задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_ROOT_DIR
  </td>
  <td >Полный путь к корневому каталогу на ВМЗ.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_PORTRANGE_LOW
  WATASK_PORTRANGE_HIGH
</td>
<td>
  Диапазон портов (включая граничные порты), которые задача может использовать для обмена данными внутри пула (если обмен данными внутри пула включен).
</td>
</table>


**Примечание.** 

Эти переменные определяются системой и их нельзя переопределить.

Значения параметров среды можно получить с помощью операции получения задачи.

<!--HONumber=46--> 
