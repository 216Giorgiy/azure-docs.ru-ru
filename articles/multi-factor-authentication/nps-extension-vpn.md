---
title: "Интеграция VPN с Azure MFA с помощью расширения NPS | Документация Майкрософт"
description: "В этой статье рассматривается интеграция инфраструктуры VPN с Azure MFA с помощью расширения сервера политики сети (NPS) для Microsoft Azure."
services: active-directory
keywords: "Azure MFA, интеграция удаленных рабочих столов, Azure Active Directory, расширение сервера политики сети"
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/15/2017
ms.author: kgremban
ms.reviewer: jsnow
ms.custom: it-pro
ms.translationtype: HT
ms.sourcegitcommit: 5b6c261c3439e33f4d16750e73618c72db4bcd7d
ms.openlocfilehash: 3dfcf25856ede50266336c2ebb057dd3f7b8897e
ms.contentlocale: ru-ru
ms.lasthandoff: 08/28/2017

---

# <a name="integrate-your-vpn-infrastructure-with-azure-multi-factor-authentication-mfa-using-the-network-policy-server-nps-extension-for-azure"></a>Интеграция инфраструктуры VPN с Многофакторной идентификацией Azure (MFA) с помощью расширения сервера политики сети (NPS) для Azure

## <a name="overview"></a>Обзор

Расширение сервера политики сети (NPS) для Azure позволяет организациям защитить аутентификацию клиентов RADIUS с помощью облачной [Многофакторной идентификации (MFA) Azure](multi-factor-authentication-get-started-server-rdg.md), обеспечивающей двухфакторную проверку подлинности.

Эта статья содержит инструкции по интеграции инфраструктуры сервера политики сети с Azure MFA с помощью расширения NPS для Azure, что позволяет применить безопасную двухфакторную проверку подлинности пользователей, пытающихся подключиться к сети с помощью VPN. 

Службы политики сети и доступа (NPS) дают организациям следующие возможности.

* Можно задать центральные расположения для управления сетевыми запросами и их контроля, чтобы указать, кто может подключаться, в какое время дня подключения разрешены, продолжительность подключений, уровень безопасности, который клиенты должны использовать для подключения, и так далее. Вместо того, чтобы задавать эти политики на каждом VPN-сервере или сервере шлюза удаленных рабочих столов, их можно указать один раз в центральном расположении. Протокол RADIUS обеспечивает централизованную аутентификацию, авторизацию и учет. 
* Можно устанавливать и применять политики работоспособности клиента защиты доступа к сети (NAP), которые определяют, предоставляется ли устройствам неограниченный или ограниченный доступ к сетевым ресурсам.
* Можно внедрить средства аутентификации и авторизации для доступа к точкам беспроводного доступа и коммутаторам Ethernet, поддерживающим протокол 802.1x.    

Дополнительную информацию см. в разделе [Сервер политики сети (NPS)](https://docs.microsoft.com/windows-server/networking/technologies/nps/nps-top). 

Чтобы повысить безопасность и обеспечить высокий уровень соответствия, организации могут интегрировать сервер политики сети с Azure MFA, чтобы применять двухфакторную проверку подлинности для пользователей, подключающихся к виртуальному порту на VPN-сервере. Чтобы получить доступ, пользователю необходимо предоставить свои имя пользователя и пароль, а также сведения, которыми он управляет. Эта информация должна быть надежной, и ее копирование должно быть затруднено. Например, это может быть номер мобильного телефона, номер стационарного телефона, приложение на мобильном устройстве и т. д.

До появления расширения NPS для Azure клиентам, желавшим внедрить двухфакторную проверку подлинности для интегрированных сред NPS и Azure MFA, приходилось настраивать и обслуживать отдельный сервер MFA в локальной среде, как описано в разделе "Шлюз удаленных рабочих столов и сервер Azure Multi-Factor Authentication, использующие проверку подлинности RADIUS".

Теперь, когда доступно расширение NPS для Azure, организации имеют возможность развернуть локальное или облачное решение MFA для защиты аутентификации клиентов RADIUS.
 
## <a name="authentication-flow"></a>Последовательность аутентификации
Когда пользователь подключается к виртуальному порту на VPN-сервере, он должен сначала пройти аутентификацию с помощью различных протоколов. Это позволяют сочетать имя пользователя и пароль с методами аутентификации на основе сертификата. 

Помимо аутентификации и проверки удостоверения, пользователи должны иметь соответствующие разрешения. В простых реализациях эти разрешения на входящее подключение, которые обеспечивают доступ, задаются непосредственно в объектах-пользователях Active Directory. 

 ![Свойства пользователя](./media/nps-extension-vpn/image1.png)

В простых реализациях каждый VPN-сервер предоставляет или запрещает доступ на основе политик, определенных на каждом локальном VPN-сервере.

В крупных и более масштабных реализациях политики, предоставляющие или запрещающие доступ через VPN, сосредоточены на серверах RADIUS. В этом случае VPN-сервер действует как сервер доступа (клиент RADIUS), который перенаправляет запросы на подключение и сообщения учетной записи на сервер RADIUS. Чтобы подключиться к виртуальному порту на VPN-сервере, пользователи должны пройти аутентификацию и выполнить условия, определенные централизованно на серверах RADIUS. 

Когда расширение NPS для Azure интегрировано с сервером политики сети, последовательность успешной аутентификации выглядит следующим образом.

1. VPN-сервер получает запрос на аутентификацию от пользователя VPN, содержащий имя пользователя и пароль, для подключения к ресурсу (например, к сеансу удаленного рабочего стола). 
2. Выступая в качестве клиента RADIUS, VPN-сервер преобразовывает запрос в сообщение Access-Request RADIUS (пароль при этом шифруется) и отправляет его на сервер RADIUS (NPS), на котором установлено расширение NPS. 
3. Сочетание имени пользователя и пароля проверяется в Active Directory. Если имя пользователя и пароль указаны неправильно, сервер RADIUS отправляет сообщение Access-Reject. 
4. Если выполнены все условия, указанные в запросе на подключение NPS и политиках сети (например, ограничение времени дня или членства в группах), расширение NPS активирует запрос дополнительной аутентификации с помощью Azure MFA. 
5. Azure MFA обращается к Azure Active Directory, получает сведения о пользователе и выполняет дополнительную аутентификацию по тому методу, который настроен пользователем (текстовое сообщение, мобильное приложение и так далее). 
6. После успешного прохождения Многофакторной идентификации служба Azure MFA передает результат в расширение NPS.
7. После аутентификации и авторизации подключения NPS-сервер, на котором установлено расширение NPS, отправляет сообщение Access-Accept RADIUS на VPN-сервер (клиент RADIUS).
8. Пользователю предоставляется доступ к виртуальному порту на VPN-сервере, и создается зашифрованный туннель VPN.

## <a name="prerequisites"></a>Предварительные требования
В этом разделе описаны предварительные условия, которые необходимо выполнить для интеграции Azure MFA и шлюза удаленных рабочих столов. Прежде чем приступить к работе, следует подготовить приведенные ниже необходимые компоненты:

* инфраструктура VPN;
* роль "Службы политики сети и доступа" (NPS);
* лицензия Azure MFA;
* программное обеспечение Windows Server;
* Библиотеки
* служба Azure AD должна быть синхронизирована с локальной службой AD; 
* идентификатор GUID Azure Active Directory.

### <a name="vpn-infrastructure"></a>Инфраструктура VPN
В этой статье предполагается наличие рабочей инфраструктуры VPN на основе Microsoft Windows Server 2016. Также предполагается, что VPN-сервер не настроен для пересылки запросов на подключение на сервер RADIUS. Вы настроите инфраструктуру VPN для использования центрального сервера RADIUS в данном руководстве.

Если у вас нет рабочей инфраструктуры VPN, можно быстро создать ее, следуя инструкциям в многочисленных руководствах по установке VPN, которые можно найти на сайтах корпорации Майкрософт и сайтах сторонних поставщиков. 

### <a name="network-policy-and-access-services-nps-role"></a>Роль "Службы политики сети и доступа" (NPS)

Служба роли NPS обеспечивает функциональные возможности сервера и клиента RADIUS. В этой статье предполагается, что вы установили роль NPS на рядовой сервер или контроллер домена в своей среде. Вы настроите RADIUS для конфигурации VPN в данном руководстве. Установите роль NPS не на VPN-сервере, а на _другом_ сервере.

Дополнительные сведения об установке службы роли NPS на компьютер под управлением Windows Server 2012 или более ранней версии см. в разделе [Install a NAP Health Policy Server](https://technet.microsoft.com/library/dd296890.aspx) (Установка сервера политики работоспособности NAP). Политика доступа к сети (NAP) объявлена устаревшей в Windows Server 2016. Описание рекомендаций для сервера политики сети, включая рекомендации по установке сервера политики сети на контроллер домена, см. в разделе [Best Practices for NPS](https://technet.microsoft.com/library/cc771746) (Рекомендации для сервера политики сети).

### <a name="licenses"></a>Лицензии

Требуется лицензия Azure MFA, которая предоставляется для подписки Azure AD Premium, Enterprise Mobility + Security (EMS) или MFA. Дополнительные сведения см. в разделе [Как получить службу Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md). Для тестирования можно использовать пробную подписку.

### <a name="software"></a>Программное обеспечение

Для работы расширения NPS требуется Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздней версии с установленной службой роли NPS. Все действия в этом руководстве были выполнены с помощью Windows Server 2016.

### <a name="libraries"></a>Библиотеки

Необходимы следующие две библиотеки:

* [Распространяемые пакеты Visual C++ для Visual Studio 2013 (X64)](https://www.microsoft.com/download/details.aspx?id=40784)
* _модуль Microsoft Azure Active Directory для Windows PowerShell версии 1.1.166.0_ или более поздней версии. Последний выпуск и инструкции по установке см. в разделе [Microsoft Azure Active Directory PowerShell Module Version Release History](https://social.technet.microsoft.com/wiki/contents/articles/28552.microsoft-azure-active-directory-powershell-module-version-release-history.aspx) (Журнал выпуска версий модуля Microsoft Azure Active Directory для PowerShell).

Эти библиотеки не укомплектованы файлами установки расширения NPS (версии 0.9.1.2), хотя в существующей документации указано обратное. Как минимум необходимо установить распространяемые пакеты Visual C++ для Visual Studio 2013. Если модуль Microsoft Azure Active Directory для Windows PowerShell отсутствует, то он устанавливается с помощью сценария настройки, который запускается в процессе установки. Нет необходимости устанавливать этот модуль заранее.

### <a name="azure-active-directory-synched-with-on-premises-active-directory"></a>Синхронизация Azure Active Directory с локальной службой Active Directory 

Для использования расширения NPS локальные пользователи должны быть синхронизированы с Azure Active Directory и настроены для использования Многофакторной идентификации. В этом руководстве предполагается, что синхронизация локальных пользователей с Azure Active Directory выполнена с помощью AD Connect. Ниже приведены инструкции по включению Многофакторной идентификации для пользователей.
Дополнительные сведения про Azure AD Connect см. в статье [Выборочная установка Azure AD Connect](../active-directory/connect/active-directory-aadconnect.md). 

### <a name="azure-active-directory-guid-id"></a>идентификатор GUID Azure Active Directory. 
Чтобы установить сервер политики сети, необходимо знать идентификатор GUID Azure Active Directory. Инструкции по поиску идентификатора GUID Azure Active Directory приведены в следующем разделе.

## <a name="configure-radius-for-vpn-connections"></a>Настройка RADIUS для VPN-подключений

Если вы установили роль сервера NPS на рядовой сервер, ее необходимо настроить для аутентификации и авторизации VPN-клиента, запрашивающего VPN-подключение. 

В этом разделе предполагается, вы установили роль сервера политики сети, но еще не настроили ее для использования в инфраструктуре.

>[!NOTE]
>Если у вас уже имеется рабочий VPN-сервер, использующий центральный сервер RADIUS для аутентификации, то этот раздел можно пропустить.
>

### <a name="register-server-in-active-directory"></a>Регистрация сервера в Active Directory
Для правильной работы в этом сценарии NPS-сервер должен быть зарегистрирован в Active Directory.

1. Откройте диспетчер сервера.
2. В диспетчере сервера щелкните **Средства**, а затем щелкните **Сервер политики сети**. 
3. В консоли сервера политики сети щелкните правой кнопкой мыши **Сервер сетевых политик (локальный)**, а затем щелкните **Зарегистрировать сервер в Active Directory**. Дважды нажмите кнопку **ОК**.

 ![Сервер политики сети](./media/nps-extension-vpn/image2.png)

4. Оставьте консоль открытой для выполнения следующей процедуры.

### <a name="use-wizard-to-configure-radius-server"></a>Использование мастера для настройки сервера RADIUS
Для настройки сервера RADIUS можно использовать стандартную (с помощью мастера) или расширенную настройку. В этом разделе предполагается использование стандартной настройки с помощью мастера.

1. В консоли сервера политики сети щелкните **Сервер сетевых политик (локальный)**.
2. В разделе "Стандартная конфигурация" выберите **RADIUS-сервер для подключений удаленного доступа или VPN**, а затем щелкните **Настройка VPN или удаленного доступа**.

 ![Настройка VPN](./media/nps-extension-vpn/image3.png)

3. На странице "Выберите тип подключения - удаленный доступ или виртуальная частная сеть" выберите **Virtual Private Network Connections** (Подключения к виртуальной частной сети) и нажмите кнопку **Далее**.

 ![Виртуальная частная сеть](./media/nps-extension-vpn/image4.png)

4. На странице "Укажите сервер удаленного доступа или VPN-сервер" щелкните **Добавить**.
5. В диалоговом окне **Новый RADIUS-клиент** введите понятное имя, разрешаемое имя или IP-адрес VPN-сервера и общий секретный пароль. Этот секретный пароль должен быть длинным и сложным. Запишите его, так как он нужен для выполнения действий в следующем разделе.

 ![Новый клиент RADIUS](./media/nps-extension-vpn/image5.png)

6. Нажмите кнопку **ОК**, а затем — кнопку **Далее**.
7. На странице **Настройка методов проверки подлинности** примите параметр по умолчанию (Шифрованная проверка (Microsoft, версия 2, MS-CHAP v2)) или выберите другой параметр, после чего нажмите кнопку **Далее**.

  >[!NOTE]
  >При настройке протокола EAP необходимо использовать MS-CHAP версии 2 или PEAP. Другие варианты EAP не поддерживаются.
 
8. На странице "Настройка групп пользователей" щелкните **Добавить** и выберите соответствующую группу, если она существует. В противном случае оставьте поле пустым, чтобы предоставить доступ всем пользователям.

 ![Настройка групп пользователей](./media/nps-extension-vpn/image7.png)

9. Щелкните **Далее**.
10. На странице "Задайте IP-фильтры" нажмите кнопку **Далее**.
11. На странице "Задайте параметры шифрования" примите параметры по умолчанию и нажмите кнопку **Далее**.

 ![Настройка параметров шифрования](./media/nps-extension-vpn/image8.png)

12. На странице "Укажите имя сферы" не указывайте имя, примите параметр по умолчанию и нажмите кнопку **Далее**.

 ![Указание имени области](./media/nps-extension-vpn/image9.png)

13. На странице "Завершение создания подключений удаленного доступа или виртуальной частной сети и RADIUS-клиентов" нажмите кнопку **Готово**.

 ![Завершение настройки подключений](./media/nps-extension-vpn/image10.png)

### <a name="verify-radius-configuration"></a>Проверка конфигурации RADIUS
В этом разделе описана конфигурация, созданная с помощью мастера.

1. На NPS-сервере в консоли "Сервер сетевых политик (локальный)" разверните элемент "RADIUS-клиенты" и выберите **RADIUS-клиенты**.
2. В области сведений щелкните правой кнопкой мыши клиент RADIUS, созданный с помощью мастера, и выберите **Свойства**. Свойства клиента RADIUS (VPN-сервера) должны быть аналогичны показанным ниже.

 ![Свойства VPN](./media/nps-extension-vpn/image11.png)

3. Нажмите кнопку **Отмена**.
4. На NPS-сервере в консоли "Сервер сетевых политик (локальный)" разверните элемент **Политики** и выберите **Политики запросов на подключение**. Вы увидите политику VPN-подключений, как на рисунке ниже.

 ![Запросы на подключение](./media/nps-extension-vpn/image12.png)

5. В разделе "Политики" выберите **Сетевые политики**. Вы должны увидеть политику VPN-подключений, напоминающую политику на рисунке ниже.

 ![Свойства сети](./media/nps-extension-vpn/image13.png)

## <a name="configure-vpn-server-to-use-radius-authentication"></a>Настройка VPN-сервера для использования аутентификации RADIUS
В этом разделе вы настроите VPN-сервер для использования аутентификации RADIUS. В этом разделе предполагается, что у вас имеется рабочая конфигурация VPN-сервера, но вы не настроили VPN-сервер для использования аутентификации RADIUS. После настройки VPN-сервера убедитесь, что конфигурация работает надлежащим образом.

>[!NOTE]
>Если у вас уже имеется рабочая конфигурация VPN-сервера, использующего аутентификацию RADIUS, то этот раздел можно пропустить.
>

### <a name="configure-authentication-provider"></a>Настройка поставщика проверки подлинности
1. На VPN-сервере откройте диспетчер сервера.
2. В диспетчере сервера выберите **Средства**, а затем — **Маршрутизация и удаленный доступ**.
3. В консоли "Маршрутизация и удаленный доступ" щелкните правой кнопкой мыши **\[имя сервера\] (локальный)**, а затем выберите **Свойства**.

 ![Маршрутизация и удаленный доступ](./media/nps-extension-vpn/image14.png)
 
4. В диалоговом окне **[имя_сервера] (локальный) - свойства** щелкните вкладку **Безопасность**. 
5. На вкладке **Безопасность** в разделе "Поставщик проверки подлинности" щелкните **Проверка подлинности RADIUS**, а затем — **Настройка**.

 ![Проверка подлинности RADIUS](./media/nps-extension-vpn/image15.png)
 
6. В диалоговом окне "Проверка подлинности RADIUS" щелкните **Добавить**.
7. В диалоговом окне "Добавление сервера RADIUS" в поле "Имя сервера" добавьте имя или IP-адрес сервера RADIUS, настроенного в предыдущем разделе.
8. В разделе "Общий секрет" щелкните **Изменить** и добавьте общий секретный пароль, который вы создали и записали ранее.
9. Измените значение "Время ожидания (с)", указав новое значение в диапазоне от **30** до **60** секунд. Это необходимо, чтобы предоставить достаточно времени для второго фактора аутентификации.
 
 ![Добавление сервера RADIUS](./media/nps-extension-vpn/image16.png)
 
10. Нажимайте кнопку **ОК**, пока не закроете все диалоговые окна.

### <a name="test-vpn-connectivity"></a>Проверка VPN-подключения
В этом разделе вы убедитесь, что VPN-клиент проходит аутентификацию и авторизацию на сервере RADIUS при попытке подключения к виртуальному порту VPN. В этом разделе предполагается, что в качестве VPN-клиента вы используете Windows 10. 

>[!NOTE]
>Если вы настроили VPN-клиент для подключения к VPN-серверу и сохранили параметры, то можете пропустить шаги, относящиеся к настройке и сохранению объекта VPN-подключения.
>

1. На компьютере VPN-клиента нажмите кнопку **Пуск** и щелкните **Параметры** (значок шестеренки).
2. В окне "Параметры Windows" щелкните **Сеть и Интернет**.
3. Щелкните **VPN**.
4. Щелкните **Добавить VPN-подключение**.
5. В диалоговом окне "Добавление VPN-подключения" укажите параметр "Windows (встроенная)" для поставщика VPN, а затем заполните оставшиеся поля соответствующим образом и нажмите кнопку **Сохранить**. 

 ![Добавление VPN-подключения](./media/nps-extension-vpn/image17.png)
 
6. Откройте **Центр управления сетями и общим доступом**  на панели управления.
7. Щелкните **Изменение параметров адаптера**.

 ![Изменение параметров адаптера](./media/nps-extension-vpn/image18.png)

8. Щелкните правой кнопкой мыши VPN-подключение и выберите "Свойства". 

 ![Свойства сети VPN](./media/nps-extension-vpn/image19.png)

9. В диалоговом окне "Свойства VPN" щелкните вкладку **Безопасность**. 
10. На вкладке "Безопасность" убедитесь, что установлен только флажок **Протокол MS-CHAP, версия 2**, и нажмите кнопку "ОК".

 ![Разрешение протоколов](./media/nps-extension-vpn/image20.png)

11. Щелкните правой кнопкой мыши VPN-подключение и выберите **Подключить**.
12. На странице "Параметры" щелкните **Подключить**.

Успешное подключение отобразится в журнале безопасности на сервере RADIUS в виде события с идентификатором 6272, как показано ниже.

 ![Свойства события](./media/nps-extension-vpn/image21.png)

## <a name="troubleshoot-guide"></a>Руководство по устранению неполадок
Предположим, конфигурация VPN работала до того, как вы настроили VPN-сервер для использования центрального сервера RADIUS для аутентификации и авторизации. В этом случае, вероятнее всего, проблема заключается в неправильной конфигурации сервера RADIUS или использовании недействительного имени пользователя или пароля. Например, если в имени пользователя используется альтернативный суффикс имени участника-пользователя, то попытка входа может завершиться сбоем (следует использовать одно и то же имя учетной записи, чтобы добиться наилучших результатов). 

Чтобы устранить эти неполадки, лучше всего начать с проверки журналов событий безопасности на сервере RADIUS. Чтобы сэкономить время при поиске событий, можно использовать настраиваемое представление политик сети и сервера доступа в службе "Просмотр событий", как показано на следующем рисунке. Идентификатор события 6273 обозначает события, в которых сервер политики сети отказал пользователю в доступе. 

 ![Средство просмотра событий](./media/nps-extension-vpn/image22.png)
 
## <a name="configure-multi-factor-authentication"></a>Настройка Многофакторной идентификации
Этот раздел содержит инструкции по включению Многофакторной идентификации для пользователей и настройке учетных записей для двухфакторной проверки подлинности. 

### <a name="enable-multi-factor-authentication"></a>Включение Многофакторной идентификации
В этом разделе вы включите Многофакторную идентификацию для учетных записей Azure AD. Используйте **классический портал**, чтобы включить Многофакторную идентификацию для пользователей. 

1. Откройте страницу [https://manage.windowsazure.com](https://manage.windowsazure.com) в браузере. 
2. Войдите в систему как администратор.
3. На портале в области навигации слева щелкните **Active Directory**.

 ![Каталог по умолчанию](./media/nps-extension-vpn/image23.png)

4. В столбце "Имя" щелкните **Каталог по умолчанию** (или другой каталог, если необходимо).
5. На странице "Быстрый запуск" щелкните **Настроить**.

 ![Настройка каталога по умолчанию](./media/nps-extension-vpn/image24.png)

6. Прокрутите страницу "Настройка" вниз. В разделе "Многофакторная идентификация" щелкните **Управление параметрами службы**.

 ![Управление параметрами Многофакторной идентификации](./media/nps-extension-vpn/image25.png)
 
7. На странице "Многофакторная идентификация" просмотрите параметры по умолчанию для службы и щелкните **Пользователи**. 

 ![Пользователи Многофакторной идентификации](./media/nps-extension-vpn/image26.png)
 
8. На странице "Пользователи" выберите пользователей, для которых вы хотите включить Многофакторную идентификацию, и щелкните **Включить**.

 ![Свойства](./media/nps-extension-vpn/image27.png)
 
9. При появлении запроса щелкните **Включить проверку Multi-Factor Auth**.

 ![Включение MFA](./media/nps-extension-vpn/image28.png)
 
10. Нажмите кнопку **Закрыть** 
11. Обновите страницу. Состояние Многофакторной идентификации изменится на "Включено".

Дополнительные сведения о том, как включить Многофакторную идентификации для пользователей, см. в разделе [Приступая к работе со службой "Многофакторная идентификация Microsoft Azure" в облаке](multi-factor-authentication-get-started-cloud.md). 

### <a name="configure-accounts-for-two-step-verification"></a>Настройка учетных записей для двухфакторной проверки подлинности
После включения Многофакторной идентификации для учетной записи пользователь не сможет выполнить вход для доступа к ресурсам, управляемым политикой MFA, пока не настроит доверенное устройство для второго фактора аутентификации и не пройдет двухфакторную проверку подлинности.

В этом разделе вы настроите доверенное устройство для двухфакторной проверки подлинности. Выполнить эту настройку можно несколькими способами, включая следующие.

* **Мобильное приложение.** Установите приложение Microsoft Authenticator на устройство Windows Phone, Android или iOS. В зависимости от политик организации необходимо использовать это приложение в одном из двух режимов: получать уведомления для проверки (уведомление отправляется на устройство) или использовать код проверки (необходимо ввести код проверки, который обновляется каждые 30 секунд). 
* **Звонок или отправка SMS на мобильный телефон**. Можно получать автоматический телефонный звонок или текстовое сообщение. Если выбран телефонный звонок, то вы отвечаете на звонок и нажимаете клавишу "#" для аутентификации. Если выбрано текстовое сообщение, то вы можете отправить ответ на текстовое сообщение или ввести указанный в нем код проверки в интерфейсе входа.
* **Звонок на рабочий телефон**. Этот процесс аналогичен автоматическим телефонным звонкам, описанным выше.

Выполните приведенные ниже инструкции, чтобы настроить устройство для использования мобильного приложения для получения push-уведомления для проверки.

1. Выполните вход на сайт [https://aka.ms/mfasetup](https://aka.ms/mfasetup) или любой сайт, например [https://portal.azure.com](https://portal.azure.com), на котором для аутентификации требуются учетные данные с поддержкой MFA. 
2. После входа с именем пользователя и паролем появится экран, на котором предлагается настроить учетную запись для дополнительной проверки безопасности.

 ![Дополнительная безопасность](./media/nps-extension-vpn/image29.png)

3. Щелкните **Настроить сейчас**.
4. На странице "Дополнительная проверка безопасности" выберите способ связи (телефон для аутентификации, рабочий телефон или мобильное приложение). Затем выберите страну или регион, а также метод. Метод зависит от выбранного способа связи. Например, если выбрать мобильное приложение, то для выбора доступно получение уведомлений для проверки и использование кода проверки. В следующих действиях предполагается, что вы выбрали способ связи **Мобильное приложение**.

 ![Аутентификация по телефону](./media/nps-extension-vpn/image30.png)

5. Выберите "Мобильное приложение", щелкните **Получить уведомления для проверки**, а затем щелкните **Настройка**. 

 ![Проверка с помощью мобильного приложения](./media/nps-extension-vpn/image31.png)
 
6. Если вы еще не сделали этого, установите мобильное приложение для проверки подлинности на устройство. 
7. Следуйте инструкциям в мобильном приложении, чтобы сосканировать полученный штрихкод или ввести информацию вручную, после чего нажмите кнопку **Готово**.

 ![Настройка мобильного приложения](./media/nps-extension-vpn/image32.png)

8. На странице "Дополнительная проверка безопасности" щелкните **Свяжитесь со мной** и отправьте ответ на уведомление, отправленное на ваше устройство.
9. На странице "Дополнительная проверка безопасности" введите контактный номер на случай потери доступа к мобильному приложению, после чего нажмите кнопку **Далее**.

 ![Номер мобильного телефона](./media/nps-extension-vpn/image33.png)
 
10. На странице "Дополнительная проверка безопасности" нажмите кнопку **Готово**.

Теперь устройство настроено для использования во втором методе проверки. Сведения о настройке учетных записей для двухфакторной проверки подлинности см. в разделе [Настройка учетной записи для двухфакторной проверки подлинности](./end-user/multi-factor-authentication-end-user-first-time.md).

## <a name="install-and-configure-nps-extension"></a>Установка и настройка расширения NPS

Этот раздел содержит инструкции по настройке инфраструктуры VPN для использования Azure MFA для аутентификации клиентов с помощью VPN-сервера.

После установки и настройки расширения NPS во всех операциях аутентификации клиентов RADIUS, обрабатываемых этим сервером, будет обязательно использование Azure MFA. Если все пользователи VPN зарегистрированы в службе Azure MFA, то можно настроить другой сервер RADIUS для аутентификации пользователей, для которых не настроено использование Многофакторной идентификации. Или можно создать запись реестра, позволяющую проверяемым пользователям проходить второй фактор аутентификации только в том случае, если они зарегистрированы в службе MFA. 

Создайте новый строковый параметр _REQUIRE_USER_MATCH в разделе HKLM\SOFTWARE\Microsoft\AzureMfa_ и задайте для него значение TRUE или FALSE. 

 ![Требование сопоставления пользователей](./media/nps-extension-vpn/image34.png)
 
Если задано значение TRUE или значение не указано, то все запросы на аутентификацию обрабатываются с помощью запроса защиты MFA. Если задано значение FALSE, то запросы защиты MFA выдаются только для пользователей, зарегистрированных в службе MFA. Используйте параметр со значением FALSE в тестовой или рабочей средах только в период подключения.

### <a name="acquire-azure-active-directory-guid-id"></a>Получение идентификатора GUID Azure Active Directory

При настройке расширения NPS необходимо ввести учетные данные администратора и идентификатор Azure Active Directory для клиента Azure AD. Ниже описывается, как получить идентификатор клиента.

1. Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com) как глобальный администратор клиента Azure.
2. В области навигации слева щелкните значок **Azure Active Directory**.
3. Щелкните **Свойства**.
4. Чтобы скопировать идентификатор каталога в буфер обмена, щелкните значок **Копировать**.
 
 ![Идентификатор каталога](./media/nps-extension-vpn/image35.png)

### <a name="install-the-nps-extension"></a>Установка расширения NPS
Расширение NPS должно быть установлено на сервере, на котором установлена роль "Службы политики сети и доступа" (NPS) и который действует как сервер RADIUS в инфраструктуре. Не следует устанавливать расширение NPS на сервер удаленных рабочих столов.

1. Скачайте расширение NPS со страницы [https://aka.ms/npsmfa](https://aka.ms/npsmfa). 
2. Скопируйте исполняемый установочный файл (NpsExtnForAzureMfaInstaller.exe) на NPS-сервер.
3. На NPS-сервере дважды щелкните файл **NpsExtnForAzureMfaInstaller.exe**. При появлении запроса щелкните **Запустить**.
4. В диалоговом окне "NPS Extension for Azure MFA" (Расширение NPS для Azure MFA) ознакомьтесь с условиями лицензии на программное обеспечение, установите флажок **Я подтверждаю согласие с условиями лицензии** и нажмите кнопку **Установить**.

 ![Расширение NPS](./media/nps-extension-vpn/image36.png)
 
5. В диалоговом окне "NPS Extension for Azure MFA" (Расширение NPS для Azure MFA) нажмите кнопку **Закрыть**.  

 ![Установка успешно завершена](./media/nps-extension-vpn/image37.png) 
 
### <a name="configure-certificates-for-use-with-the-nps-extension-using-a-powershell-script"></a>Настройка сертификатов для расширения NPS с помощью сценария PowerShell
Чтобы обеспечить безопасную связь и контроль, необходимо настроить сертификаты для расширения NPS. Компоненты NPS включают в себя сценарий Windows PowerShell, предназначенный для настройки самозаверяющего сертификата для сервера политики сети. 

Этот сценарий выполняет следующие действия:

* создает самозаверяющий сертификат;
* связывает открытый ключ сертификата с субъектом-службой в Azure AD;
* сохраняет сертификат в хранилище на локальном компьютере;
* предоставляет сетевому пользователю доступ к закрытому ключу сертификата;
* перезапускает службу сервера политики сети.

Если вы хотите использовать собственные сертификаты, необходимо привязать открытый ключ сертификата к субъекту-службе в Azure AD и т. д.
Чтобы использовать этот сценарий, укажите в расширении свои учетные данные администратора Azure Active Directory и идентификатор клиента Azure Active Directory, скопированный ранее. Запустите сценарий на каждом NPS-сервере, на котором установлено расширение NPS.

1. Откройте командную строку Windows PowerShell с правами администратора.
2. В командной строке PowerShell введите команду _cd ‘c:\Program Files\Microsoft\AzureMfa\Config’_ и нажмите клавишу **ВВОД**.
3. Введите _.\AzureMfsNpsExtnConfigSetup.ps1_ и нажмите клавишу **ВВОД**. 
 * Сценарий проверяет, установлен ли модуль Azure Active Directory для PowerShell. Если он не установлен, сценарий автоматически установит этот модуль.
 
 ![PowerShell](./media/nps-extension-vpn/image38.png)
 
4. Проверив установку модуля PowerShell, сценарий отображает диалоговое окно модуля Azure Active Directory для PowerShell. В этом диалоговом окне введите учетные данные администратора Azure AD и пароль, затем щелкните **Вход**. 
 
 ![Вход в PowerShell](./media/nps-extension-vpn/image39.png)
 
5. При появлении запроса вставьте идентификатор клиента, скопированный в буфер обмена ранее, и нажмите клавишу **ВВОД**. 

 ![Tenant ID](./media/nps-extension-vpn/image40.png)

6. Этот сценарий создает самозаверяющий сертификат и выполняет другие изменения конфигурация. На рисунке ниже показан пример выходных данных.

 ![Самозаверяющий сертификат](./media/nps-extension-vpn/image41.png)

7. Перезагрузите сервер.
 
### <a name="verify-configuration"></a>Проверка конфигурации
Чтобы проверить конфигурацию, необходимо установить новое VPN-подключение к VPN-серверу. После успешного ввода учетных данных для основной аутентификации VPN-подключение ожидает прохождения дополнительной аутентификации, прежде чем подключение будет установлено, как показано ниже. 

 ![Проверка конфигурации](./media/nps-extension-vpn/image42.png)

После успешного прохождения дополнительной проверки, настроенной ранее в Azure MFA, вы будете подключены к ресурсу. Однако если вы не пройдете дополнительную аутентификацию, доступ к ресурсу будет запрещен. 

В следующем примере приложение Authenticator в Windows Phone используется для дополнительной аутентификации.

 ![Проверка учетной записи](./media/nps-extension-vpn/image43.png)

После успешного прохождения аутентификации с помощью дополнительного метода вам предоставляется доступ к виртуальному порту на VPN-сервере. Тем не менее, так как вы должны были пройти дополнительную аутентификацию с помощью мобильного приложения на доверенном устройстве, процесс входа защищен лучше, чем при использовании только имени пользователя и пароля.

### <a name="view-event-viewer-logs-for-successful-logon-events"></a>Просмотр событий успешного входа в журналах службы "Просмотр событий"
Чтобы просмотреть события успешного входа в журналах службы "Просмотр событий" Windows, можно выполнить приведенную команду Windows PowerShell, которая запрашивает журнал безопасности Windows на NPS-сервере.

Чтобы запросить события успешного входа из журналов безопасности службы "Просмотр событий", используйте следующую команду.
* _Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL 

 ![Журнал безопасности из службы "Просмотр событий"](./media/nps-extension-vpn/image44.png)
 
Можно также просмотреть настраиваемое представление журналов безопасности или служб политики сети и доступа, как показано ниже.

 ![Доступ на основе политики сети](./media/nps-extension-vpn/image45.png)

На сервере с расширением NPS для Azure MFA можно найти журналы приложений службы "Просмотр событий", относящиеся к расширению: **Application and Services Logs\Microsoft\AzureMfa**. 

* _Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL

 ![Количество событий](./media/nps-extension-vpn/image46.png)

## <a name="troubleshoot-guide"></a>Руководство по устранению неполадок
Если конфигурация не работает должным образом, то в первую очередь следует убедиться, что пользователь настроен для использования Azure MFA. Подключите пользователя к порталу по адресу [https://portal.azure.com](https://portal.azure.com). Если ему предлагается дополнительная аутентификация и он может успешно пройти ее, то можно исключить ошибку в конфигурации Azure MFA.

Если пользователи успешно используют Azure MFA, следует изучить соответствующие журналы событий. К ним относятся журналы событий безопасности, операционные журналы шлюза и журналы Azure MFA, рассмотренные в предыдущем разделе. 

Ниже приведен пример выходных данных журнала безопасности, содержащих событие неудачного входа (идентификатор события 6273).

 ![Журнал безопасности](./media/nps-extension-vpn/image47.png)

Ниже приведено связанное событие из журналов Azure MFA.

 ![Журналы Azure MFA](./media/nps-extension-vpn/image48.png)

Чтобы расширить возможности устранения неполадок, просмотрите файлы журнала в формате базы данных NPS в расположении, в котором установлена служба NPS. Эти файлы журнала создаются в папке _%SystemRoot%\System32\Logs_ в виде файлов с разделителями-запятыми. Описание этих файлов журнала см. в разделе [Interpret NPS Database Format Log Files](https://technet.microsoft.com/library/cc771748.aspx) (Интерпретация файлов журнала в формате базы данных NPS). 

Записи в этих файлах журнала сложно интерпретировать, не импортировав их в электронную таблицу или базу данных. Помочь в интерпретации файлов журнала могут несколько средств синтаксического анализа IAS в Интернете. Ниже показаны выходные данные одной из таких скачиваемых [условно бесплатных программ](http://www.deepsoftware.com/iasviewer). 

 ![Условно бесплатная программа](./media/nps-extension-vpn/image49.png)

Наконец, чтобы еще больше расширить возможности устранения неполадок, можно использовать анализатор протокола, например Wireshark или [Microsoft Message Analyzer](https://technet.microsoft.com/library/jj649776.aspx). На следующем снимке экрана Wireshark показаны сообщения RADIUS, передаваемые между VPN-сервером и NPS-сервером.

 ![Microsoft Message Analyzer](./media/nps-extension-vpn/image50.png)

Дополнительные сведения см. в разделе [Интеграция существующей инфраструктуры NPS с Многофакторной идентификацией Azure](multi-factor-authentication-nps-extension.md).  

## <a name="next-steps"></a>Дальнейшие действия
[Как получить службу Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md)

[Шлюз удаленных рабочих столов и сервер Azure Multi-Factor Authentication, использующие проверку подлинности RADIUS](multi-factor-authentication-get-started-server-rdg.md)

[Интеграция локальных каталогов с Azure Active Directory](../active-directory/connect/active-directory-aadconnect.md)


