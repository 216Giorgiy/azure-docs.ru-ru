---
title: "Сервер MFA со службами AD FS в Windows Server 2012 R2 | Документация Майкрософт"
description: "В этой статье объясняется, как начать работу с Azure Multi-Factor Authentication и AD FS в Windows Server 2012 R2."
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
editor: yossib
ms.assetid: 57208068-1e55-45b6-840f-fdcd13723074
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 10/14/2016
ms.author: kgremban
translationtype: Human Translation
ms.sourcegitcommit: 2ea002938d69ad34aff421fa0eb753e449724a8f
ms.openlocfilehash: 86a4bc7ea89416f2c67626439f08fa615a2e6511


---
# <a name="secure-your-cloud-and-onpremises-resources-using-azure-multifactor-authentication-server-with-ad-fs-in-windows-server-2012-r2"></a>Защита облачных и локальных ресурсов с помощью сервера многофакторной идентификации Azure со службами федерации Active Directory в Windows Server 2012 R2
Если вы используете службы федерации Active Directory (AD FS) и хотите защитить облачные или локальные ресурсы, вы можете настроить сервер многофакторной идентификации Azure для работы с AD FS. Эта конфигурация активирует двухфакторную проверку подлинности для важных конечных точек.

Эта статья содержит информацию об использовании сервера Azure Multi-Factor Authentication вместе с AD FS на сервере Windows Server 2012 R2. Дополнительные сведения см. в статье [Защита облачных и локальных ресурсов с помощью сервера многофакторной идентификации Azure и AD FS 2.0](multi-factor-authentication-get-started-adfs-adfs2.md).

## <a name="secure-windows-server-2012-r2-ad-fs-with-azure-multifactor-authentication-server"></a>Защита AD FS в Windows Server 2012 R2 с помощью сервера Azure Multi-Factor Authentication
Для установки сервера Azure Multi-Factor Authentication вы можете выбрать один из следующих вариантов.

* Установка сервера Azure Multi-Factor Authentication локально на том же сервере, на котором находятся службы AD FS.
* Установка адаптера Azure Multi-Factor Authentication локально на сервере AD FS и установка сервера Multi-Factor Authentication на другом компьютере.

Прежде чем начать, ознакомьтесь с приведенной ниже информацией.

* Не обязательно устанавливать сервер Azure Multi-Factor Authentication на сервере AD FS. Но необходимо установить адаптер Multi-Factor Authentication для AD FS на сервере Windows Server 2012 R2, на котором работают службы федерации AD FS. Вы можете установить сервер на другом компьютере, если он работает под управлением ОС поддерживаемой версии, и установить адаптер AD FS отдельно на сервере федерации AD FS. Чтобы узнать, как установить адаптер отдельно, см. следующие процедуры.
* При проектировании адаптера AD FS сервера многофакторной идентификации предполагалось, что службы AD FS могут передавать имя проверяющей стороны адаптеру, которое затем может использоваться как имя приложения. Но получилось не так, как ожидалось. Если в вашей организации используется проверка подлинности с помощью текстового сообщения или мобильного приложения, строки, определенные в разделе "Параметры компании", содержат заполнитель <$*application_name*$> (имя приложения). Этот заполнитель не заменяется автоматически при использовании адаптера AD FS. Рекомендуем удалить заполнитель из соответствующих строк, если вы защищаете AD FS.
* Учетная запись, которую вы используете для входа, должна иметь права на создание групп безопасности в службе Active Directory.
* Мастер установки адаптера AD FS многофакторной идентификации создает группу безопасности с именем PhoneFactor Admins в вашем экземпляре Active Directory, а затем добавляет учетную запись службы AD FS в эту группу. Рекомендуем убедиться с помощью контроллера домена, что группа PhoneFactor Admins действительно создана и учетная запись службы AD FS является участником этой группы. При необходимости добавьте вручную учетную запись службы AD FS в группу PhoneFactor Admins в контроллере домена.
* Сведения об установке пакета SDK веб-службы с помощью пользовательского портала см. в статье [Развертывание пользовательского портала для сервера многофакторной идентификации Azure](multi-factor-authentication-get-started-portal.md).

### <a name="install-azure-multifactor-authentication-server-locally-on-the-ad-fs-server"></a>Установка сервера Azure Multi-Factor Authentication локально на сервере, на котором находятся службы AD FS
1. Скачайте и установите сервер многофакторной идентификации Azure на сервере AD FS. Сведения об установке см. в статье [Приступая к работе с сервером многофакторной идентификации Azure](multi-factor-authentication-get-started-server.md).
2. В консоли управления сервером многофакторной идентификации Azure щелкните значок **AD FS**, а затем выберите параметры **Разрешить регистрацию пользователей** и **Разрешить пользователям выбирать метод**.
3. Выберите дополнительные параметры, которые вы хотите указать для своей организации.
4. Щелкните **Установить AD FS-адаптер**.
   <center>![Облако](./media/multi-factor-authentication-get-started-adfs-w2k12/server.png)</center>
5. Запрос на настройку Active Directory может отобразиться по двум причинам. Компьютер присоединен к домену, и в Active Directory не закончена настройка защиты подключений между адаптером AD FS и службой многофакторной идентификации. Нажмите кнопку **Далее**, чтобы автоматически завершить настройку, или установите флажок **Пропустить автоматическую настройку Active Directory и настроить параметры вручную** и нажмите кнопку **Далее**.
6. Запрос на настройку локальной группы может отобразиться по двум причинам. Компьютер не присоединен к домену, и в локальной группе не закончена настройка защиты подключений между адаптером AD FS и службой многофакторной идентификации. Нажмите кнопку **Далее**, чтобы автоматически завершить настройку, или установите флажок **Пропустить автоматическую настройку локальной группы и настроить параметры вручную** и нажмите кнопку **Далее**.
7. В мастере установки нажмите кнопку **Далее**. Сервер Azure Multi-Factor Authentication создаст группу PhoneFactor Admins и добавит в эту группу учетную запись службы AD FS.
   <center>![Облако](./media/multi-factor-authentication-get-started-adfs-w2k12/adapter.png)</center>
8. На странице **Запуск установщика** нажмите кнопку **Далее**.
9. В установщике адаптера Multi-Factor Authentication AD FS нажмите кнопку **Далее**.
10. По завершении установки нажмите кнопку **Закрыть** .
11. После установки адаптера необходимо зарегистрировать его в AD FS. Откройте Windows PowerShell и выполните следующую команду:<br>
    `C:\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`
    <center>![Облако](./media/multi-factor-authentication-get-started-adfs-w2k12/pshell.png)</center>
12. Чтобы использовать только что зарегистрированный адаптер, измените глобальную политику проверки подлинности в AD FS. В консоли управления AD FS откройте узел **Authentication Policies** (Политики проверки подлинности). В разделе **Многофакторная идентификация** щелкните ссылку **Изменить** рядом с разделом **Глобальные параметры**. В окне **Изменить глобальную политику проверки подлинности** выберите **Многофакторная идентификация** в качестве дополнительного метода проверки подлинности и нажмите кнопку **ОК**. Адаптер регистрируется как WindowsAzureMultiFactorAuthentication. Для завершения регистрации нужно перезапустить службу AD FS.

<center>![Облако](./media/multi-factor-authentication-get-started-adfs-w2k12/global.png)</center>

На этом этапе сервер Multi-Factor Authentication уже настроен в качестве дополнительного поставщика проверки подлинности, который можно использовать с AD FS.

## <a name="install-a-standalone-instance-of-the-ad-fs-adapter-by-using-the-web-service-sdk"></a>Установка изолированного экземпляра адаптера AD FS с помощью пакета SDK веб-службы
1. Установите пакет SDK веб-службы на сервере, на котором запущен сервер Multi-Factor Authentication.
2. Скопируйте следующие файлы из папки \Program Files\Multi-Factor Authentication Server на сервер, на котором вы планируете установить адаптер AD FS:
   * MultiFactorAuthenticationAdfsAdapterSetup64.msi
   * Register-MultiFactorAuthenticationAdfsAdapter.ps1
   * Unregister-MultiFactorAuthenticationAdfsAdapter.ps1
   * MultiFactorAuthenticationAdfsAdapter.config
3. Запустите файл установки MultiFactorAuthenticationAdfsAdapterSetup64.msi.
4. Чтобы начать установку, в установщике адаптера многофакторной идентификации AD FS нажмите кнопку **Далее**.
5. По завершении установки нажмите кнопку **Закрыть** .

## <a name="edit-the-multifactorauthenticationadfsadapterconfig-file"></a>Изменение файла MultiFactorAuthenticationAdfsAdapter.config
Чтобы изменить файл MultiFactorAuthenticationAdfsAdapter.config, выполните следующие действия.

1. Задайте для узла **UseWebServiceSdk** значение **true**.  
2. В поле **WebServiceSdkUrl** укажите URL-адрес пакета SDK веб-службы многофакторной идентификации. Например, *https://contoso.com/&lt;certificatename&gt;/MultiFactorAuthWebServicesSdk/PfWsSdk.asmx*, где certificatename — это имя сертификата.  
3. Измените скрипт Register-MultiFactorAuthenticationAdfsAdapter.ps1. Для этого добавьте *-ConfigurationFilePath &lt;path&gt;* в конец команды `Register-AdfsAuthenticationProvider`, где *&lt;path&gt;* — это полный путь к файлу MultiFactorAuthenticationAdfsAdapter.config.

### <a name="configure-the-web-service-sdk-with-a-username-and-password"></a>Настройка пакета SDK веб-службы с помощью имени пользователя и пароля
Настройку пакета SDK веб-службы можно выполнить двумя способами. В первом случае используется имя пользователя и пароль, а во втором — сертификат клиента. Выполните следующие действия, чтобы настроить пакет SDK первым способом, или перейдите к инструкции для второго способа.  

1. Для параметра **WebServiceSdkUsername** укажите учетную запись, которая является участником группы безопасности PhoneFactor Admins. Используйте формат &lt;домен&gt;&#92;&lt;имя_пользователя&gt;.  
2. Для параметра **WebServiceSdkPassword** укажите пароль соответствующей учетной записи.

### <a name="configure-the-web-service-sdk-with-a-client-certificate"></a>Настройка пакета SDK веб-службы с помощью сертификата клиента
Если вы не хотите использовать имя пользователя и пароль для настройки пакета SDK веб-службы, выполните следующие действия для настройки с помощью сертификата клиента.

1. Получите в центре сертификации сертификат клиента для сервера, на котором запущен пакет SDK веб-службы. Дополнительные сведения см. в статье [о получении сертификатов клиента](https://technet.microsoft.com/library/cc770328.aspx).  
2. Импортируйте сертификат клиента в хранилище личных сертификатов локального компьютера на сервере, на котором запущен пакет SDK веб-службы. Убедитесь, что открытый сертификат центра сертификации находится в хранилище доверенных корневых сертификатов.  
3. Экспортируйте открытый и закрытый ключи сертификата клиента в PFX-файл.  
4. Экспортируйте открытый ключ в формате Base64 в CER-файл.  
5. Откройте диспетчер серверов и убедитесь, что компонент проверки подлинности с сопоставлением сертификата клиента установлен в папке Web Server (IIS)\Web Server\Security\IIS. Если этот компонент не установлен, добавьте его, щелкнув **Добавить роли и компоненты** .  
6. Откройте диспетчер служб IIS и дважды щелкните **Редактор конфигураций** на веб-сайте, который содержит виртуальный каталог пакета SDK веб-службы. Важно выполнить это действие на уровне веб-сайта, а не на уровне виртуального каталога.  
7. Перейдите в раздел **system.webServer/security/authentication/iisClientCertificateMappingAuthentication** .  
8. Присвойте параметру enabled значение **true**.  
9. Задайте для параметра oneToOneCertificateMappingsEnabled значение **true**.  
10. Нажмите кнопку **…** рядом с neToOneMappings, а затем щелкните ссылку **Добавить**.  
11. Откройте предварительно экспортированный CER-файл в формате Base64. Удалите *-----BEGIN CERTIFICATE-----*, *-----END CERTIFICATE-----* и все разрывы строк. Скопируйте получившуюся строку.  
12. Укажите скопированную строку как значение параметра certificate.  
13. Присвойте параметру enabled значение **true**.  
14. Для параметра userName укажите учетную запись, которая входит в группу безопасности PhoneFactor Admins. Используйте формат &lt;домен&gt;&#92;&lt;имя_пользователя&gt;.  
15. Укажите пароль для соответствующей учетной записи, а затем закройте редактор конфигураций.  
16. Щелкните ссылку **Применить** .  
17. В виртуальном каталоге пакета SDK веб-службы дважды щелкните **Проверка подлинности**.  
18. Убедитесь, что параметры "Олицетворение ASP.NET" и "Обычная проверка подлинности" имеют значение **Включено**, а все остальные — **Отключено**.  
19. В виртуальном каталоге пакета SDK веб-службы дважды щелкните **Параметры SSL**.  
20. Чтобы настроить параметр "Сертификаты клиентов" выберите значение **Принять**, а затем щелкните **Применить**.  
21. Скопируйте предварительно экспортированный PFX-файл на сервер, на котором работает адаптер AD FS.  
22. Импортируйте PFX-файл в хранилище личных сертификатов на локальном компьютере.  
23. Щелкните правой кнопкой мыши и выберите **Управление закрытыми ключами**, а затем предоставьте разрешение на чтение учетной записи, используемой для входа в службу AD FS.  
24. Откройте сертификат клиента и скопируйте отпечаток на вкладке **Сведения** .  
25. В файле MultiFactorAuthenticationAdfsAdapter.config для параметра **WebServiceSdkCertificateThumbprint** укажите строку, скопированную на предыдущем этапе.  

Чтобы зарегистрировать адаптер, выполните в PowerShell сценарий \Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1. Адаптер регистрируется как WindowsAzureMultiFactorAuthentication. Для завершения регистрации нужно перезапустить службу AD FS.

## <a name="related-topics"></a>Связанные разделы
Дополнительные сведения по поиску и устранению ошибок см. в статье [Часто задаваемые вопросы о службе многофакторной идентификации Azure](multi-factor-authentication-faq.md).




<!--HONumber=Nov16_HO2-->


