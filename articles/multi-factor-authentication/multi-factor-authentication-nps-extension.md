---
title: "Использование существующих серверов NPS для реализации возможностей MFA Azure | Документация Майкрософт"
description: "Расширение сервера политики сети для многофакторной идентификации Azure — это простое решение, позволяющее добавить двухэтапную облачную проверку пользователей в существующую инфраструктуру проверки подлинности."
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
editor: yossib
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/23/2017
ms.author: kgremban
ms.custom: H1Hack27Feb2017
translationtype: Human Translation
ms.sourcegitcommit: e4ef137656c12cf6495a00450eed308ac6a8a872
ms.openlocfilehash: 804e811c0db5f72b6764b3cb120eb5ec8898baac
ms.lasthandoff: 02/28/2017

---
# <a name="integrate-your-existing-nps-infrastructure-with-azure-multi-factor-authentication---public-preview"></a>Интеграция имеющейся инфраструктуры NPS со службой Многофакторной идентификации Azure (общедоступная предварительная версия)

Расширение сервера политики сети (NPS) для MFA Azure добавляет облачные функции многофакторной идентификации в инфраструктуру проверки подлинности на базе существующих серверов. Расширение NPS позволяет добавить телефонный звонок, текстовое сообщение или запрос на подтверждение в мобильном приложении в существующий процесс проверки подлинности, позволяя обойтись без установки, настройки и поддержания новых серверов. 
 
Если вы используете расширение NPS для многофакторной идентификации Azure, процесс проверки подлинности состоит из следующих компонентов. 

1. **NAS или VPN-сервер** получает запросы от клиентов, использующих VPN-подключение, и преобразует их в запросы RADIUS, направляемые на серверы политики сети. 
2. **Сервер политики сети** подключается к Active Directory и выполняет первичную проверку подлинности по запросам RADIUS. В случае успеха он передает запрос в установленные расширения.  
3. **Расширение NPS** активирует запрос к MFA Azure для проведения дополнительной проверки подлинности. Когда расширение получает ответ (при условии, что запрос MFA выполнен успешно), расширение завершает процесс проверки подлинности, возвращая серверу NPS маркеры безопасности, которые включают утверждение многофакторной идентификации, выданное службой маркеров безопасности Azure.  
4. **Azure MFA** обращается к Azure Active Directory для получения сведений о пользователе и выполняет дополнительную проверку подлинности по тому методу, который настроен для этого пользователя.

На следующей схеме обобщенно представлена последовательность запросов на проверку подлинности. 

![Схема последовательности проверки подлинности](./media/multi-factor-authentication-nps-extension/auth-flow.png)

## <a name="prerequisites"></a>Предварительные требования

Расширение NPS предназначено для работы с существующей инфраструктурой. Прежде чем приступить к работе, убедитесь, что у вас есть следующие необходимые компоненты.

### <a name="licenses"></a>Лицензии

Расширение NPS для многофакторной проверки подлинности Azure доступно для клиентов с [лицензией на MFA Azure](multi-factor-authentication.md) (входит в состав подписок Azure AD Premium, EMS и MFA).

### <a name="software"></a>Программное обеспечение

Windows Server 2008 R2 SP1 или более поздней версии, в котором активирован компонент NPS.

### <a name="libraries"></a>Библиотеки

-    [Распространяемые пакеты Visual C++ для Visual Studio 2013 (X64)](https://www.microsoft.com/download/details.aspx?id=40784)
-    [Модуль Microsoft Azure Active Directory для Windows PowerShell, версия 1.1.166](https://connect.microsoft.com/site1164/Downloads/DownloadDetails.aspx?DownloadID=59185)

### <a name="azure-active-directory"></a>Azure Active Directory

Все пользователи, использующие расширение NPS, должны синхронизироваться с Azure Active Directory с помощью Azure AD Connect, и для них должна быть включена многофакторная идентификация.

Для установки расширения потребуются учетные данные администратора и идентификатор каталога для вашего клиента Azure AD. Идентификатор каталога вы можете найти на [портале Azure](https://portal.azure.com). Войдите с учетными данными администратора, выберите значок **Azure Active Directory** слева, а затем выберите **Свойства**. Скопируйте значение GUID в поле **Directory ID** (Идентификатор каталога) и сохраните изменения.

![Поиск идентификатора каталога в разделе свойств для Azure Active Directory](./media/multi-factor-authentication-nps-extension/find-directory-id.png)

## <a name="install-the-nps-extension"></a>Установка расширения NPS

> [!IMPORTANT]
> Установите расширение NPS на другом сервере, который не является точкой доступа VPN. 

Чтобы установить расширение NPS для MFA Azure, сделайте следующее.

1.    [Скачайте расширение NPS](https://aka.ms/npsmfa) из Центра загрузки Microsoft.
2.    Скопируйте этот двоичный файл на сервер политики сети, который требуется настроить.
3.    Запустите файл *setup.exe* и следуйте инструкциям по установке.

После завершения установки программа установки создаст скрипт PowerShell в этом расположении: `C:\Program Files\Microsoft\AzureMfa\Config` (где C:\ — диск установки). Скрипт PowerShell выполняет следующие действия.

-    Создать самозаверяющий сертификат.
-    Связывает открытый ключ сертификата с субъектом-службой в Azure AD.
-    Сохраняет сертификат в хранилище сертификатов на локальном компьютере.
-    Предоставляет пользователю в сети доступ к закрытому ключу сертификата.
-    Перезапускает расширение NPS.

Если вы не намерены использовать собственные сертификаты (вместо самозаверяющих сертификатов, которые создает скрипт PowerShell), запустите скрипт PowerShell для завершения установки.

## <a name="configure-your-nps-extension"></a>Настройка расширения NPS

Этот раздел содержит рекомендации по проектированию и успешному развертыванию расширения NPS.

### <a name="configurations-limitations"></a>Ограничения конфигурации

- Расширение NPS предназначено для работы с существующим развертыванием, а не для новых развертываний. По этой причине расширение NPS для MFA Azure не включает средства для переноса пользователей и настроек с сервера MFA в облако.

- Расширение NPS использует имя участника-пользователя из локального каталога Active Directory и по нему определяет пользователя MFA Azure, для которого будет выполняться дополнительная проверка подлинности. Расширение не может использовать другие идентификаторы, например альтернативное имя для входа или настраиваемые поля AD.  

### <a name="control-radius-clients-that-require-mfa"></a>Управление клиентами RADIUS, для которых требуется MFA

Когда вы включаете для клиента RADIUS поддержку MFA с помощью расширения NPS, все сеансы проверки подлинности для этого клиента могут выполняться только с использованием MFA. Если вы хотите включить MFA только для отдельных клиентов RADIUS, настройте два сервера NPS и установите расширение только на один из них. Затем настройте для клиентов RADIUS, которые должны использовать MFA, отправку запросов на сервер NPS, на котором установлено это расширение. Всех остальных клиентов RADIUS направьте на другой сервер NPS, для которого расширение не используется.

### <a name="prepare-for-users-that-arent-enrolled-for-mfa"></a>Подготовка к входу пользователей, не зарегистрированных для MFA

Если у вас есть пользователи, не зарегистрированные для MFA, вы можете выбрать действие, которое будет выполняться при попытке проверки подлинности. Для управления этим поведением используйте параметр реестра *REQUIRE_USER_MATCH*, расположенный в пути *HKLM\Software\Microsoft\AzureMFA*. Здесь есть только один параметр конфигурации:

| Ключ | Значение | значение по умолчанию |
| --- | ----- | ------- |
| REQUIRE_USER_MATCH | True или false | Не задано (эквивалентно значению True) |

Этот параметр определяет, что нужно делать при проверке подлинности пользователя, не зарегистрированного для MFA. Если этот ключ не существует, не задан или имеет значение True, то для незарегистрированного пользователя проверка MFA считается не пройденной. Если этот ключ имеет значение False, то для незарегистрированного пользователя проверка подлинности выполняется без MFA.

Вы можете создать этот ключ и присвоить ему значение False при добавлении пользователей. Такая настройка разрешает вход без дополнительной проверки всем пользователям, которые не зарегистрированы для MFA, поэтому этот ключ следует удалить до начала использования в рабочей среде.

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="how-do-i-verify-that-the-client-cert-is-installed-as-expected"></a>Как проверить, правильно ли установлен сертификат клиента?

Найдите самозаверяющий сертификат, созданный установщиком в хранилище сертификатов, и убедитесь, что его закрытый ключ имеет разрешения, предоставленные пользователю **NETWORK SERVICE**. У этого сертификата имя субъекта-службы будет иметь значение **CN \<tenantid\>, а OU = Microsoft NPS Extension**

-------------------------------------------------------------

### <a name="how-can-i-verify-that-my-client-cert-is-associated-to-my-tenant-in-azure-active-directory"></a>Как проверить, связан ли сертификат клиента с правильным клиентом в Azure Active Directory?

Откройте командную строку PowerShell и выполните следующие команды:

```
> import-module MSOnline
> Connect-MsolService
> Get-MsolServicePrincipalCredential -AppPrincipalId "981f26a1-7f43-403b-a875-f8b09b8cd720" -ReturnKeyValues 1 
```

Эти команды выводят в сеанс PowerShell все сертификаты, благодаря которым ваш клиент связывается с экземпляром расширения NPS. Экспортируйте сертификат клиента в файл в кодировке Base-64 X.509 (CER) без закрытого ключа и сравните его со списком в PowerShell, чтобы найти соответствие.

Метки времени Valid-From и Valid-Until, которые имеют понятный для человека формат, позволят отфильтровать очевидные несоответствия, если команда возвращает более одного сертификата.

-------------------------------------------------------------

### <a name="why-are-my-requests-failing-with-adal-token-error"></a>Почему запросы завершаются сбоем с ошибкой маркера ADAL?

Эта ошибка может быть вызвана одной из нескольких причин. Выполните следующие действия для устранения неполадок.

1. Перезагрузите сервер политики сети.
2. Убедитесь, что сертификат клиента установлен правильно.
3. Убедитесь, что сертификат связан с клиентом в Azure AD.
4. Убедитесь, что адрес https://login.windows.net/ доступен с сервера, на котором выполняется расширение.

-------------------------------------------------------------

### <a name="why-does-authentication-fail-with-an-error-in-http-logs-stating-that-the-user-is-not-found"></a>Почему проверка подлинности завершается ошибкой, а в журнал HTTP заносится ошибка с сообщением о том, что пользователь не найден?

Убедитесь, что служба AD Connect работает, а нужный пользователь присутствует как в Windows Active Directory, так и в Azure Active Directory.

------------------------------------------------------------

### <a name="why-do-i-see-http-connect-errors-in-logs-with-all-my-authentications-failing"></a>Почему в журналах отображаются ошибки подключения HTTP для всех попыток проверки подлинности?

Убедитесь, что адрес https://adnotifications.windowsazure.com доступен с сервера, на котором выполняется расширение NPS.

## <a name="next-steps"></a>Дальнейшие действия

Научитесь интегрировать MFA Azure с [Active Directory](multi-factor-authentication-get-started-server-dirint.md), [проверкой подлинности RADIUS](multi-factor-authentication-get-started-server-radius.md) и [проверкой подлинности LDAP](multi-factor-authentication-get-started-server-ldap.md).

