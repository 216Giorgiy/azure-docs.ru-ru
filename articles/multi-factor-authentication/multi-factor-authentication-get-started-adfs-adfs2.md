<properties 
	pageTitle="Защита облачных и локальных ресурсов с помощью сервера Azure Multi-Factor Authentication и AD FS 2.0" 
	description="Эта страница посвящена Azure Multi-Factor Authentication. Она содержит сведения по началу работы с Azure MFA и AD FS 2.0." 
	services="multi-factor-authentication" 
	documentationCenter="" 
	authors="billmath" 
	manager="stevenpo" 
	editor="curtland"/>

<tags 
	ms.service="multi-factor-authentication" 
	ms.workload="identity" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="11/17/2015" 
	ms.author="billmath"/>
# Защита облачных и локальных ресурсов с помощью сервера Azure Multi-Factor Authentication и AD FS 2.0

Если в организации настроена федерация с Azure Active Directory и существуют локальные или облачные ресурсы, которые нужно защитить, вы можете это сделать с помощью сервера Azure Multi-Factor Authentication. Его нужно настроить для работы с AD FS, чтобы многофакторная проверка подлинности запускалась для конечных точек с самым большим значением.

Эта статья содержит информацию об использовании сервера Azure Multi-Factor Authentication с AD FS 2.0. Сведения об использовании Azure Multi-Factor Authentication с Windows Server 2012 R2 AD FS см. в статье [Защита облачных и локальных ресурсов с помощью сервера Azure Multi-Factor Authentication и сервера Windows Server 2012 R2 AD FS](multi-factor-authentication-get-started-adfs-w2k12.md).


## Прокси-сервер AD FS 2.0
Чтобы обезопасить AD FS 2.0 с помощью прокси-сервера, установите сервер Azure Multi-Factor Authentication на прокси-сервере ADFS и настройте сервер Azure согласно приведенным ниже инструкциям.

### Защита AD FS 2.0 с помощью прокси-сервера

1. На сервере Azure Multi-Factor Authentication щелкните значок проверки подлинности IIS в левом меню.
2. Щелкните вкладку «На основе форм».
3. Нажмите кнопку «Добавить».
<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/setup1.png)</center>
4. Чтобы автоматически определить такие параметры, как имя пользователя, пароль и домен, введите URL-адрес входа (например, https://sso.contoso.com/adfs/ls) в диалоговом окне «Автоматическая настройка веб-сайта на основе форм» и нажмите кнопку «ОК».
5. Установите флажок «Требуется сопоставление пользователей Multi-Factor Authentication», если все пользователи были или будут импортированы на сервер, а также подвергнуты многофакторной проверке подлинности. Если значительное число пользователей еще не импортировано на сервер и/или будет исключено из многофакторной проверки подлинности, не устанавливайте флажок. Дополнительные сведения об этом параметре см. в файле справки.
6. Если переменные страницы не удается обнаружить автоматически, нажмите кнопку «Указать вручную...» в диалоговом окне «Автоматическая настройка веб-сайта на основе форм».
7. В диалоговом окне «Добавление веб-сайта на основе форм» введите URL-адрес страницы входа ADFS в поле «URL-адрес для отправки» (например, https://sso.contoso.com/adfs/ls) и укажите имя приложения (необязательно). Имя приложения отображается в отчетах сервера Azure Multi-Factor Authentication. Кроме того, оно может отображаться в SMS-сообщениях и сообщениях о проверке подлинности мобильного приложения. Дополнительные сведения о поле «URL-адрес для отправки» см. в файле справки.
8. В качестве формата запроса укажите «POST или GET».
9. Введите переменную для имени пользователя (ctl00$ContentPlaceHolder1$UsernameTextBox) и переменную для пароля (ctl00$ContentPlaceHolder1$PasswordTextBox). Если на странице входа на основе форм отображается текстовое поле для домена, введите также переменную для домена. Чтобы найти имена полей ввода на странице входа, вам может потребоваться перейти на страницу входа в веб-браузере, щелкнуть страницу правой кнопкой мыши и выбрать пункт «Просмотр источника».
10. Установите флажок «Требуется сопоставление пользователей Multi-Factor Authentication», если все пользователи были или будут импортированы на сервер, а также подвергнуты многофакторной проверке подлинности. Если значительное число пользователей еще не импортировано на сервер и/или будет исключено из многофакторной проверки подлинности, не устанавливайте флажок.
<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/manual.png)</center>
11. Чтобы просмотреть дополнительные параметры, нажмите кнопку «Дополнительно». Здесь вы также можете выбрать специальный файл страницы отказа, с помощью файлов cookie на определенное время поместить в кэш успешные проверки подлинности, выбрать способ проверки подлинности основных учетных данных и т. д.
12. Так как прокси-сервер ADFS, скорее всего, не будет присоединен к домену, вам нужно будет использовать протокол LDAP, чтобы подключиться к контроллеру домена для импорта пользователей и предварительной проверки подлинности. В диалоговом окне «Расширенный веб-сайт на основе форм» щелкните вкладку «Основная проверка подлинности» и в качестве типа предварительной проверки подлинности выберите «Привязка LDAP».
13. Чтобы после этого вернуться в диалоговое окно «Добавление веб-сайта на основе форм», нажмите кнопку «ОК». Дополнительные сведения о разделе дополнительных параметров см. в файле справки.
14. Чтобы закрыть диалоговое окно, нажмите кнопку «ОК».
15. Когда переменные для URL-адреса и страницы будут введены или обнаружены, данные веб-сайта отобразятся на панели «На основе форм».
16. Чтобы включить подключаемый модуль IIS на нужном уровне, перейдите на вкладку «Собственный модуль» и выберите сервер, а также веб-сайт, с которым работает прокси-сервер ADFS (например, «Веб-сайт по умолчанию») или приложение прокси-сервера ADFS (например, ls после adfs).
17. Установите флажок «Включить проверку подлинности IIS» в верхней части экрана.
18. Проверка подлинности IIS включена. Чтобы выполнять предварительную проверку подлинности для Active Directory (AD) с помощью протокола LDAP, нужно настроить LDAP-подключение к контроллеру домена. Вот как вы можете это сделать. Щелкните значок «Интеграция каталогов».
19. На вкладке «Параметры» щелкните переключатель «Использовать определенную конфигурацию LDAP».
<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/ldap1.png)</center>
20. Нажмите кнопку «Изменить…».
21. В диалоговом окне «Изменение конфигурации LDAP» заполните поля сведениями, нужными для подключения к контроллеру домена AD. Поля описаны в приведенной ниже таблице. Примечание. Эта информация есть также в файле справки по серверу Azure Multi-Factor Authentication.
22. Проверьте LDAP-подключение. Для этого нажмите кнопку «Тест».
<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/ldap2.png)</center>
23. Если проверка LDAP-подключения оказалась успешной, нажмите кнопку «ОК».
24. После этого щелкните значок «Параметры компании» и перейдите на вкладку «Разрешение имени пользователя».
25. Щелкните переключатель «Для сопоставления имен пользователей использовать атрибут уникального идентификатора LDAP».
26. Если в форму входа прокси-сервера ADFS введено имя пользователя в формате «домен\\имя пользователя», то при создании запроса LDAP серверу нужно разделить домен от имени пользователя. Это можно сделать с помощью параметра реестра.
27. Откройте редактор реестра и перейдите в раздел HKEY\_LOCAL\_MACHINE/SOFTWARE/Wow6432Node/Positive Networks/PhoneFactor на 64-разрядном сервере. При использовании 32-разрядного сервера удалите из этого пути текст Wow6432Node. Создайте раздел реестра DWORD с именем «UsernameCxz\_stripPrefixDomain» и задайте значение 1. После этого служба Azure Multi-Factor Authentication будет защищать прокси-сервер ADFS. Убедитесь, что пользователи импортированы из Active Directory на сервер Azure Multi-Factor Authentication. Если нужно внести некоторые внутренние IP-адреса в список разрешений, чтобы при входе на веб-сайт с этих расположений не требовалась двухфакторная проверка подлинности, см. раздел «Надежные IP-адреса» ниже.

<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/reg.png)</center>

## AD FS 2.0 без прокси-сервера (напрямую)

Чтобы обезопасить AD FS, не используя прокси-сервер, установите сервер Azure Multi-Factor Authentication на сервере AD FS и настройте сервер Azure согласно приведенным ниже инструкциям.

### Безопасность AD FS 2.0 без прокси-сервера
1. На сервере Azure Multi-Factor Authentication щелкните значок проверки подлинности IIS в левом меню.
2. Перейдите на вкладку HTTP.
3. Нажмите кнопку «Добавить».
4. В диалоговом окне «Добавление базового URL-адреса» введите URL-адрес веб-сайта ADFS, на котором выполняется проверка подлинности HTTP (например, https://sso.domain.com/adfs/ls/auth/integrated), в поле «Базовый URL-адрес» и укажите имя приложения (необязательно). Имя приложения отображается в отчетах сервера Azure Multi-Factor Authentication. Кроме того, оно может отображаться в SMS-сообщениях и сообщениях о проверке подлинности мобильного приложения.
5. При необходимости задайте время ожидания простоя и максимальное время сеанса.
6. Установите флажок «Требуется сопоставление пользователей Multi-Factor Authentication», если все пользователи были или будут импортированы на сервер, а также подвергнуты многофакторной проверке подлинности. Если значительное число пользователей еще не импортировано на сервер и/или будет исключено из многофакторной проверки подлинности, не устанавливайте флажок. Дополнительные сведения об этом параметре см. в файле справки.
7. При необходимости установите флажок использования файлов cookie для помещения в кэш.
<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/noproxy.png)</center>
8. Нажмите кнопку «ОК».
9. Чтобы включить подключаемый модуль IIS на нужном уровне, перейдите на вкладку «Собственный модуль» и выберите сервер, а также веб-сайт, на котором запущены службы ADFS (например, «Веб-сайт по умолчанию») или приложение ADFS (например, ls после adfs).
10. Установите флажок «Включить проверку подлинности IIS» в верхней части экрана. После этого служба Azure Multi-Factor Authentication будет защищать ADFS. Убедитесь, что пользователи импортированы из Active Directory на сервер Azure Multi-Factor Authentication. Если нужно внести некоторые внутренние IP-адреса в список разрешений, чтобы при входе на веб-сайт с этих расположений не требовалась двухфакторная проверка подлинности, см. раздел «Надежные IP-адреса» ниже.


## Надежные IP-адреса
Список «Надежные IP-адреса» позволяет обойти службу Azure Multi-Factor Authentication при обработке таких запросов на веб-сайты, которые исходят от определенных IP-адресов или подсетей. Например, вам может понадобиться исключить пользователей из проверки Azure Multi-Factor Authentication, если они входят с офисного компьютера. Для этого нужно внести офисную подсеть в список «Надежные IP-адреса».

### Настройка надежных IP-адресов


1. В разделе проверки подлинности IIS перейдите на вкладку «Надежные IP-адреса».
1. Нажмите кнопку «Добавить».
1. Когда появится диалоговое окно «Добавление надежных IP-адресов», с помощью переключателя выберите один IP-адрес, диапазон IP-адресов или подсеть.
1. Укажите IP-адрес, диапазон IP-адресов или подсеть, которые следует внести в список разрешений. При указании подсети выберите соответствующую маску сети и нажмите кнопку «ОК». Надежный IP-адрес добавлен.


<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/trusted.png)</center>

<!---HONumber=Nov15_HO4-->