<properties 
	pageTitle="Защита облачных и локальных ресурсов с помощью сервера Azure Multi-Factor Authentication и AD FS 2.0" 
	description="Эта страница посвящена Azure Multi-Factor Authentication. Она содержит сведения по началу работы с Azure MFA и AD FS 2.0." 
	services="multi-factor-authentication" 
	documentationCenter="" 
	authors="billmath" 
	manager="terrylan" 
	editor="bryanla"/>

<tags 
	ms.service="multi-factor-authentication" 
	ms.workload="identity" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="06/02/2015" 
	ms.author="billmath"/>
# Защита облачных и локальных ресурсов с помощью сервера Azure Multi-Factor Authentication и AD FS 2.0

Если в организации настроена федерация с Azure Active Directory и существуют локальные или облачные ресурсы, которые нужно защитить, вы можете это сделать с помощью сервера Azure Multi-Factor Authentication. Его нужно настроить для работы с AD FS, чтобы многофакторная проверка подлинности запускалась для конечных точек с самым большим значением.

Эта статья содержит информацию об использовании сервера Azure Multi-Factor Authentication с AD FS 2.0. Сведения об использовании Azure Multi-Factor Authentication с Windows Server 2012 R2 AD FS см. в статье [Защита облачных и локальных ресурсов с помощью сервера Azure Multi-Factor Authentication и сервера Windows Server 2012 R2 AD FS](multi-factor-authentication-get-started-adfs-w2k12.md).


## Прокси-сервер AD FS 2.0
Чтобы обезопасить AD FS 2.0 с помощью прокси-сервера, установите сервер Azure Multi-Factor Authentication на прокси-сервере ADFS и настройте сервер Azure согласно приведенным ниже инструкциям.

### Защита AD FS 2.0 с помощью прокси-сервера
<ol>
<li>На сервере Azure Multi-Factor Authentication щелкните значок проверки подлинности IIS в левом меню.</li>
<li>Щелкните вкладку «На основе форм».</li>
<li>Нажмите кнопку «Добавить».</li>

<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/setup1.png)</center>

<li>Чтобы автоматически определить такие переменные, как имя пользователя, пароль и домен, введите URL-адрес входа (например, https://sso.contoso.com/adfs/ls) в диалоговом окне «Автоматическая настройка веб-сайта на основе форм» и нажмите кнопку «ОК».</li>
<li>Установите флажок «Требуется сопоставление пользователей Multi-Factor Authentication», если все пользователи были или будут импортированы на сервер, а также подвергнуты многофакторной проверке подлинности. Если значительное число пользователей еще не импортировано на сервер и/или будет исключено из многофакторной проверки подлинности, не устанавливайте флажок. Дополнительные сведения об этом параметре см. в файле справки.</li>
<li>Если переменные страницы не удается обнаружить автоматически, нажмите кнопку «Указать вручную...» в диалоговом окне «Автоматическая настройка веб-сайта на основе форм».</li>
<li>В диалоговом окне «Добавление веб-сайта на основе форм» введите URL-адрес страницы входа ADFS в поле «URL-адрес для отправки» (например, https://sso.contoso.com/adfs/ls) и укажите имя приложения (необязательно). Имя приложения отображается в отчетах сервера Azure Multi-Factor Authentication. Кроме того, оно может отображаться в SMS-сообщениях и сообщениях о проверке подлинности мобильного приложения. Дополнительные сведения о поле «URL-адрес для отправки» см. в файле справки.</li>
<li>В качестве формата запроса укажите «POST или GET».</li>
<li>Введите переменную для имени пользователя (ctl00$ContentPlaceHolder1$UsernameTextBox) и переменную для пароля (ctl00$ContentPlaceHolder1$PasswordTextBox). Если на странице входа на основе форм отображается текстовое поле для домена, введите также переменную для домена. Чтобы найти имена полей ввода на странице входа, вам может потребоваться перейти на страницу входа в веб-браузере, щелкнуть страницу правой кнопкой мыши и выбрать пункт «Просмотр источника».</li>
<li>Установите флажок «Требуется сопоставление пользователей Multi-Factor Authentication», если все пользователи были или будут импортированы на сервер, а также подвергнуты многофакторной проверке подлинности. Если значительное число пользователей еще не импортировано на сервер и/или будет исключено из многофакторной проверки подлинности, не устанавливайте флажок.</li>

<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/manual.png)</center>

<li>Чтобы просмотреть дополнительные параметры, нажмите кнопку «Дополнительно». Здесь вы также можете выбрать специальный файл страницы отказа, с помощью файлов cookie на определенное время поместить в кэш успешные проверки подлинности, выбрать способ проверки подлинности основных учетных данных и т.&#160;д.</li>
<li>Так как прокси-сервер ADFS, скорее всего, не будет присоединен к домену, вам нужно будет использовать протокол LDAP, чтобы подключиться к контроллеру домена для импорта пользователей и предварительной проверки подлинности. В диалоговом окне «Расширенный веб-сайт на основе форм» щелкните вкладку «Основная проверка подлинности» и в качестве типа предварительной проверки подлинности выберите «Привязка LDAP».</li>
<li>Чтобы после этого вернуться в диалоговое окно «Добавление веб-сайта на основе форм», нажмите кнопку «ОК». Дополнительные сведения о разделе дополнительных параметров см. в файле справки.</li>
<li>Чтобы закрыть диалоговое окно, нажмите кнопку «ОК».</li>
<li>Когда переменные для URL-адреса и страницы будут введены или обнаружены, данные веб-сайта отобразятся на панели «На основе форм».</li>
<li>Чтобы включить подключаемый модуль IIS на нужном уровне, перейдите на вкладку «Собственный модуль» и выберите сервер, а также веб-сайт, с которым работает прокси-сервер ADFS (например, «Веб-сайт по умолчанию») или приложение прокси-сервера ADFS (например, ls после adfs).</li>
<li>Установите флажок «Включить проверку подлинности IIS» в верхней части экрана.</li>
<li>Проверка подлинности IIS включена. Чтобы выполнять предварительную проверку подлинности для Active Directory (AD) с помощью протокола LDAP, нужно настроить LDAP-подключение к контроллеру домена. Вот как вы можете это сделать. Щелкните значок «Интеграция каталогов».</li>
<li>На вкладке «Параметры» щелкните переключатель «Использовать определенную конфигурацию LDAP».</li>

<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/ldap1.png)</center>

<li>Нажмите кнопку «Изменить…».</li>
<li>В диалоговом окне «Изменение конфигурации LDAP» заполните поля сведениями, нужными для подключения к контроллеру домена AD. Поля описаны в приведенной ниже таблице. Примечание. Эта информация есть также в файле справки по серверу Azure Multi-Factor Authentication.</li>

Поле| Описание
:------------- | :-------------
сервер;|Укажите имя узла или IP-адрес сервера, содержащего каталог LDAP. После этих данных вы также можете указать через точку с запятой резервный сервер.<br> **Примечание.** Если в качестве типа привязки выбран тип SSL, обычно требуется указать полное имя узла. Оно должно совпадать с именем на SSL-сертификате, который установлен в сервере каталогов LDAP. 
Базовое DN|Введите различающееся имя объекта базового каталога (с этого объекта будет начинаться выполнение всех запросов по каталогу). Например, dc=contoso,dc=com.
Тип привязки|Выберите тип привязки, подходящий для поиска в каталоге LDAP. Это нужно для импорта, синхронизации и разрешения имен пользователей.<ul><li>**Анонимная** — выполняется анонимная привязка. Привязка DN и привязка пароля не используются. Это возможно, только если каталог LDAP позволяет выполнять анонимную привязку и есть разрешения на обработку запросов, касающихся соответствующих записей и атрибутов.</li><li>**Простая** — для привязки к каталогу LDAP привязка DN и привязка пароля передаются в качестве обычного текста. Этот вариант следует использовать только тогда, когда нужно проверить, есть ли связь с сервером и есть ли у учетной записи привязки соответствующий доступ. После установки соответствующего сертификата рекомендуется использовать тип SSL вместо типа «Простая».</li><li>**SSL** — для привязки к каталогу LDAP привязка DN и привязка пароля зашифровываются с помощью протокола SSL. Для этого нужно, чтобы на сервере каталогов LDAP, которому доверяет сервер Azure Multi-Factor Authentication, был установлен сертификат.</li><li>**Windows** — для безопасного подключения к контроллеру домена Active Directory или каталогу ADAM используются привязка имени пользователя и привязка пароля. Если поле «Привязка имени пользователя» остается пустым, то для привязки используется учетная запись вошедшего пользователя.</li></ul> 
Привязка имени пользователя|Введите различающееся имя записи пользователя для учетной записи, используемой при привязке к каталогу LDAP. Привязка различающегося имени используется только в том случае, если в качестве типа привязки выбран тип «Простая» или SSL.    
Привязка пароля|Введите пароль для DN или имени пользователя, которые используются для привязки к каталогу LDAP. Чтобы настроить пароль для службы AdSync сервера Multi-Factor Authentication, нужно включить синхронизацию и запустить службу на локальном компьютере. Пароль сохраняется в списке хранимых имен пользователей и паролей Windows под учетной записью, от имени которой запускается служба AdSync сервера Azure Multi-Factor Authentication. Пароль сохраняется также под учетной записью, от имени которой запускаются пользовательский интерфейс и служба сервера Azure Multi-Factor Authentication. Примечание. Так как пароль хранится только в списке хранимых имен пользователей и паролей Windows, который находится на локальном сервере, описываемое здесь действие нужно выполнить для каждого сервера Azure Multi-Factor Authentication, которому нужен доступ к паролю. 
Предельный размер запроса|Укажите предельный размер, то есть максимальное число пользователей, которое отображается как результат после поиска по каталогу. Это ограничение должно соответствовать конфигурации в каталоге LDAP. Если выполняется масштабный поиск, для которого не поддерживается подкачка, процессы импорта и синхронизации пытаются получить пользователей в пакетах. Если указанный предельный размер превышает ограничение, заданное в каталоге LDAP, некоторые пользователи могут быть пропущены. 



<li>Проверьте LDAP-подключение. Для этого нажмите кнопку «Тест».</li>

<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/ldap2.png)</center>
<li>Если проверка LDAP-подключения оказалась успешной, нажмите кнопку «ОК».</li>
<li>После этого щелкните значок «Параметры компании» и перейдите на вкладку «Разрешение имени пользователя».</li>
<li>Щелкните переключатель «Для сопоставления имен пользователей использовать атрибут уникального идентификатора LDAP».</li>
<li>Если в форму входа прокси-сервера ADFS введено имя пользователя в формате «домен\имя пользователя», то при создании запроса LDAP серверу нужно разделить домен от имени пользователя. Это можно сделать с помощью параметра реестра.</li>
<li>Откройте редактор реестра и перейдите в раздел HKEY_LOCAL_MACHINE/SOFTWARE/Wow6432Node/Positive Networks/PhoneFactor на 64-разрядном сервере. При использовании 32-разрядного сервера удалите из этого пути текст Wow6432Node. Создайте раздел реестра DWORD с именем «UsernameCxz_stripPrefixDomain» и задайте значение 1. После этого служба Azure Multi-Factor Authentication будет защищать прокси-сервер ADFS. Убедитесь, что пользователи импортированы из Active Directory на сервер Azure Multi-Factor Authentication. Если нужно внести некоторые внутренние IP-адреса в список разрешений, чтобы при входе на веб-сайт с этих расположений не требовалась двухфакторная проверка подлинности, см. раздел «Надежные IP-адреса» ниже.</li>

<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/reg.png)</center>

## AD FS 2.0 без прокси-сервера (напрямую)

Чтобы обезопасить AD FS, не используя прокси-сервер, установите сервер Azure Multi-Factor Authentication на сервере AD FS и настройте сервер Azure согласно приведенным ниже инструкциям.

### Безопасность AD FS 2.0 без прокси-сервера
<ol>
<li>На сервере Azure Multi-Factor Authentication щелкните значок проверки подлинности IIS в левом меню.</li>
<li>Перейдите на вкладку HTTP.</li>
<li>Нажмите кнопку «Добавить».</li>
<li>В диалоговом окне «Добавление базового URL-адреса» введите URL-адрес веб-сайта ADFS, на котором выполняется проверка подлинности HTTP (например, https://sso.domain.com/adfs/ls/auth/integrated), в поле «Базовый URL-адрес» и укажите имя приложения (необязательно). Имя приложения отображается в отчетах сервера Azure Multi-Factor Authentication. Кроме того, оно может отображаться в SMS-сообщениях и сообщениях о проверке подлинности мобильного приложения.</li>
<li>При необходимости задайте время ожидания простоя и максимальное время сеанса.</li>
<li>Установите флажок «Требуется сопоставление пользователей Multi-Factor Authentication», если все пользователи были или будут импортированы на сервер, а также подвергнуты многофакторной проверке подлинности. Если значительное число пользователей еще не импортировано на сервер и/или будет исключено из многофакторной проверки подлинности, не устанавливайте флажок. Дополнительные сведения об этом параметре см. в файле справки.</li>
<li>При необходимости установите флажок использования файлов cookie для помещения в кэш.</li>

<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/noproxy.png)</center>

<li>Нажмите кнопку «ОК».</li>
<li>Чтобы включить подключаемый модуль IIS на нужном уровне, перейдите на вкладку «Собственный модуль» и выберите сервер, а также веб-сайт, на котором запущены службы ADFS (например, «Веб-сайт по умолчанию») или приложение ADFS (например, ls после adfs).</li>
<li>Установите флажок «Включить проверку подлинности IIS» в верхней части экрана. После этого служба Azure Multi-Factor Authentication будет защищать ADFS. Убедитесь, что пользователи импортированы из Active Directory на сервер Azure Multi-Factor Authentication. Если нужно внести некоторые внутренние IP-адреса в список разрешений, чтобы при входе на веб-сайт с этих расположений не требовалась двухфакторная проверка подлинности, см. раздел «Надежные IP-адреса» ниже.</li>

## Надежные IP-адреса
Список «Надежные IP-адреса» позволяет обойти службу Azure Multi-Factor Authentication при обработке таких запросов на веб-сайты, которые исходят от определенных IP-адресов или подсетей. Например, вам может понадобиться исключить пользователей из проверки Azure Multi-Factor Authentication, если они входят с офисного компьютера. Для этого нужно внести офисную подсеть в список «Надежные IP-адреса».

### Настройка надежных IP-адресов

<ol>
<li>В разделе проверки подлинности IIS перейдите на вкладку «Надежные IP-адреса».</li>
<li>Нажмите кнопку «Добавить».</li>
<li>Когда появится диалоговое окно «Добавление надежных IP-адресов», с помощью переключателя выберите один IP-адрес, диапазон IP-адресов или подсеть.</li>
<li>Укажите IP-адрес, диапазон IP-адресов или подсеть, которые следует внести в список разрешений. При указании подсети выберите соответствующую маску сети и нажмите кнопку «ОК». После этого список разрешений будет добавлен.</li>


<center>![Setup](./media/multi-factor-authentication-get-started-adfs-adfs2/trusted.png)</center>

<!---HONumber=July15_HO2-->