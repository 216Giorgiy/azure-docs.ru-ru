<properties
   pageTitle="Настройка подключения между виртуальными сетями с помощью диспетчера ресурсов Azure и PowerShell | Microsoft Azure"
	description="Эта статья описывает этапы настройки подключения между виртуальными сетями с помощью диспетчера ресурсов Azure и PowerShell."
	services="vpn-gateway"
	documentationCenter="na"
	authors="cherylmc"
	manager="carolz"
	editor=""/>

<tags
   ms.service="vpn-gateway"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="infrastructure-services"
	ms.date="08/20/2015"
	ms.author="cherylmc"/>

# Настройка подключения между виртуальными сетями с помощью диспетчера ресурсов Azure и PowerShell

> [AZURE.SELECTOR]
- [Azure Portal](virtual-networks-configure-vnet-to-vnet-connection.md)
- [PowerShell - Azure Resource Manager](vpn-gateway-vnet-vnet-rm-ps.md)


Подключение одной виртуальной сети к другой (подключение типа VNet-to-VNet) очень похоже на подключение виртуальной сети к локальному сайту. В обоих типах подключений используется VPN-шлюз для создания защищенного туннеля, использующего IPsec/IKE. Подключаемые виртуальные сети могут находиться в разных регионах. Можно даже комбинировать подключение виртуальных сетей с многосайтовыми конфигурациями. Это позволяет устанавливать сетевые топологии, совмещающие подключения между организациями с подключениями между виртуальными сетями, как показано на схеме ниже.


![Схема подключения между виртуальными сетями](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727360.png)

 

>[AZURE.NOTE]Azure в настоящее время поддерживает два режима развертывания: классический и режим развертывания диспетчера ресурсов Azure. Командлеты конфигурации и действий различаются в зависимости от режима развертывания. Этот раздел поможет выполнить подключение виртуальных сетей, созданных в режиме диспетчера ресурсов Azure. Если вы хотите создать подключение между виртуальными сетями в режиме классического развертывания, см. [Настройка подключения между виртуальными сетями с помощью портала Azure](virtual-networks-configure-vnet-to-vnet-connection.md). Если вы хотите подключить виртуальную сеть, которая была создана в классическом режиме, к виртуальной сети, созданной в диспетчере ресурсов, см. [Подключение классических виртуальных сетей к новым виртуальным сетям](../virtual-network/virtual-networks-arm-asm-s2s.md).

## Что может дать связь между виртуальными сетями

Вам может потребоваться подключить виртуальные сети по следующим причинам.

- **Межрегиональная географическая избыточность и географическое присутствие**
	- Вы можете настроить собственную георепликацию или синхронизацию с безопасной связью, без прохождения трафика через конечные точки с выходом в Интернет.
	- С помощью балансировщика нагрузки Azure и технологий кластеризации корпорации Майкрософт или сторонних производителей можно настроить высокодоступную рабочую нагрузку с геоизбыточностью в нескольких регионах Azure. Одним из важных примеров является настройка SQL Always On с группами доступности, распределенными по нескольким регионам Azure.

- **Региональные многоуровневые приложения с четкой границей изоляции**
	- В одном регионе можно настроить многоуровневые приложения с использованием нескольких связанных друг с другом виртуальных сетей с сильной изоляцией и защищенной связью между уровнями.



### Примечания

В этой статье будут описаны этапы настройки подключения между двумя виртуальными сетями VNet1 и VNet2. Необходим удобный способ настройки сетей, чтобы подставить диапазоны IP-адресов, которые соответствуют вашим требованиям по проектированию сети.


![Подключение между виртуальными сетями](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727361.png)



- Виртуальные сети могут быть в одном или разных регионах (расположениях) Azure.

- Облачная служба или конечная точка с балансировкой нагрузки НЕ МОЖЕТ распространяться на виртуальные сети, даже если они соединены друг с другом.

- Для подключения нескольких виртуальных сетей Azure друг к другу не требуются локальные VPN-шлюзы, если только не требуется распределенное подключение.

- Подключения между виртуальными сетями поддерживают подключение нескольких виртуальных сетей. Не поддерживается подключение виртуальных машин или облачных служб, размещенных НЕ в виртуальной сети.

- Для подключения между виртуальными сетями необходимы VPN-шлюзы Azure с VPN типа RouteBased (этот тип ранее назывался динамическим).

- Подключение к виртуальной сети может использоваться одновременно с многосайтовыми сетями VPN, использующими до 10 туннелей VPN для подключения VPN-шлюза виртуальной сети к другим виртуальным сетям или локальным сайтам.

- Адресные пространства виртуальных сетей и местных сайтов локальных сетей не должны перекрываться. Перекрытие адресных пространств приведет к сбою при создании виртуальных сетей.

- Избыточные туннели между парой виртуальных сетей не поддерживаются.

- Все туннели VPN виртуальной сети совместно используют доступную пропускную способность VPN-шлюза Azure и одно соглашение об уровне обслуживания VPN-шлюзов в Azure.

- Трафик между виртуальными сетями проходит через магистральную сеть Azure.


## Подготовка


Перед началом работы убедитесь, что у вас есть следующие компоненты.


- Последняя версия командлетов Azure PowerShell. Загрузить и установить последнюю версию можно в разделе Windows PowerShell на [странице загрузки](http://azure.microsoft.com/downloads/). 
- Подписка Azure. Если у вас нет подписки Azure, вы можете [активировать преимущества для подписчиков MSDN](http://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрироваться в бесплатной пробной версии](http://azure.microsoft.com/pricing/free-trial/).
- Если ваши виртуальные сети уже созданы, см. [Подключение существующих виртуальных сетей](#connecting-existing-vnets).
	


Для создания и настройки подключения между виртуальными сетями необходимо выполнить несколько действий. Настройте каждый раздел в указанном ниже порядке.


1. [Планирование диапазонов IP-адресов](#plan-your-ip-address-ranges)
2. [Подключение к подписке](#connect-to-your-subscription)
3. [Создать виртуальную сеть](#create-a-virtual-network)
4. [Запрос общедоступного IP-адреса для шлюза](#request-a-public-ip-address)
5. [Создание конфигурации шлюза](#create-the-gateway-configuration)
6. [Создание шлюза](#create-the-gateway)
7. [Повтор этих действий для настройки сети VNet2](#create-vnet2)
8. [Подключите шлюзы VPN.](#connect-the-gateways)


## Планирование диапазонов IP-адресов

### Шаг 1

Важно определить диапазоны адресов, которые будут использоваться при настройке сети. С точки зрения сети VNet1 сеть VNet2 представляет собой просто другое VPN-подключение, определенное на платформе Azure. И из сети VNet2 сеть VNet1 является просто еще одним VPN-подключением. Имейте в виду, необходимо убедиться в том, что ни один из диапазонов виртуальных сетей или диапазонов локальных сетей никак не перекрываются.


Далее мы создадим две виртуальные сети с соответствующими шлюзами подсетей и конфигурациями. Затем мы создадим подключение VPN-шлюза между двумя виртуальными сетями.

В этом упражнении используйте следующие параметры виртуальных сетей.

Параметры для сети VNet1

- Имя виртуальной сети = VNet1
- Группа ресурсов = testrg1
- Адресное пространство = 10.1.0.0/16 
- Регион = US West
- Подсеть шлюза = 10.1.0.0/28
- Подсеть 1 = 10.1.1.0/28

Параметры для сети VNet2

- Имя виртуальной сети = VNet2
- Группа ресурсов = testrg2
- Адресное пространство = 10.2.0.0/16
- Регион = Japan East
- Подсеть шлюза = 10.2.0.0/28
- Подсеть 1 = 10.2.1.0/28

## Подключение к подписке 

### Шаг 2


Откройте консоль PowerShell и переключитесь в режим диспетчера ресурсов Azure. Для подключения используйте следующий пример.

		Add-AzureAccount

Выполните командлет Select-AzureSubscription, чтобы подключиться к необходимой подписке.

		Select-AzureSubscription "yoursubscription"

Затем переключитесь в режим ARM. Переключение режима позволит использовать командлеты ARM.

		Switch-AzureMode -Name AzureResourceManager

## Создать виртуальную сеть

### Шаг 3


Используйте приведенный ниже пример, чтобы создать виртуальную сеть и подсеть шлюза. Подставьте собственные значения. В этом примере мы создадим VNet1. Повторите эти действия позже для создания сети VNet2.

Сначала создайте группу ресурсов.

			New-AzureResourceGroup -Name testrg1 -Location 'West US'

Затем создайте виртуальную сеть. В следующем примере создается виртуальная сеть с именем *VNet1* и две подсети с именами *GatewaySubnet* и *Subnet1*. Важно, чтобы одна из подсетей имела имя *GatewaySubnet*. Если вы используете другое имя, подключение не будет настроено. В приведенном ниже примере используется подсеть шлюза /28. При этом для подсети шлюза можно выбрать сеть меньшего размера до /29. Обратите внимание, что для некоторых функций (такие как существующие одновременно соединения ExpressRoute и соединения типа "сеть — сеть") требуется подсеть большего размера /27, поэтому может потребоваться создать собственную подсеть шлюза для размещения дополнительных функций, которые могут потребоваться в будущем.

 		$subnet = New-AzureVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix 10.1.0.0/28
		$subnet1 = New-AzureVirtualNetworkSubnetConfig -Name 'Subnet1' -AddressPrefix '10.1.1.0/28'
		New-AzurevirtualNetwork -Name VNet1 -ResourceGroupName testrg1 -Location 'West US' -AddressPrefix 10.1.0.0/16 -Subnet $subnet, $subnet1

## Запрос общедоступного IP-адреса

### Шаг 4.

Затем вы должны запросить общедоступный IP-адрес, который нужно выделить для шлюза, создаваемого для виртуальной сети. Указать необходимый IP-адрес нельзя; он выделяется для шлюза динамически. Этот IP-адрес будет использоваться на следующем этапе конфигурации.

Используйте следующий пример. Для этого адреса нужно использовать метод динамического распределения (Dynamic).


		$gwpip= New-AzurePublicIpAddress -Name gwpip1 -ResourceGroupName testrg1 -Location 'West US' -AllocationMethod Dynamic


## Создание конфигурации шлюза

### Шаг 5

Конфигурация шлюза определяет используемые подсеть и общедоступный IP-адрес. Используйте следующий пример, чтобы создать конфигурацию шлюза.


		$vnet = Get-AzureVirtualNetwork -Name VNet1 -ResourceGroupName testrg1
		$subnet = Get-AzureVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -VirtualNetwork $vnet
		$gwipconfig = New-AzureVirtualNetworkGatewayIpConfig -Name gwipconfig1 -SubnetId $subnet.Id -PublicIpAddressId $gwpip.Id 


## Создание шлюза

### Шаг 6

На этом шаге вы создадите шлюз для своей виртуальной сети. Для подключений типа VNet-to-VNet необходимо использовать тип VPN RouteBased. Создание шлюза может занять некоторое время, поэтому проявите терпение.

		New-AzureVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg1 -Location 'West US' -IpConfigurations $gwipconfig -GatewayType Vpn -VpnType RouteBased

## Создание сети VNet2

### Шаг 7

После настройки сети VNet1 повторите предыдущие шаги для настройки сети VNet2 и ее шлюза. После завершения настройки обеих виртуальных сетей и их шлюзов перейдите к разделу [Подключение шлюзов](#connect-the-gateways).


## Подключение шлюзов

### Шаг 8

На этом шаге вы создадите подключения VPN-шлюзов между шлюзами двух виртуальных сетей. Вы увидите ссылки на общий ключ в примерах. Можно использовать собственные значения для общего ключа. Важно, чтобы общий ключ в обеих конфигурациях был одинаковым.

Учтите, что на создание конфигураций потребуется некоторое время.

**От сети VNet1 к сети VNet2**
    
    $vnetgw1 = Get-AzureVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg1
    $vnetgw2 = Get-AzureVirtualNetworkGateway -Name vnetgw2 -ResourceGroupName testrg2
    
    New-AzureVirtualNetworkGatewayConnection -Name conn1 -ResourceGroupName testrg1 -VirtualNetworkGateway1 $vnetgw1 -VirtualNetworkGateway2 $vnetgw2 -Location 'West US' -ConnectionType Vnet2Vnet -SharedKey 'abc123'


**От сети VNet2 к сети VNet1**
    
    $vnetgw1 = Get-AzureVirtualNetworkGateway -Name vnetgw2 -ResourceGroupName testrg2
    $vnetgw2 = Get-AzureVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg1
    
    New-AzureVirtualNetworkGatewayConnection -Name conn2 -ResourceGroupName testrg2 -VirtualNetworkGateway1 $vnetgw1 -VirtualNetworkGateway2 $vnetgw2 -Location 'Japan East' -ConnectionType Vnet2Vnet -SharedKey 'abc123'
    


Подключение должно установиться через несколько минут. Обратите внимание, что на данный момент шлюзы и подключения, создаваемые с помощью диспетчера ресурсов Azure, не отображаются на портале предварительной версии.

## Подключение существующих виртуальных сетей

Если вы уже создали виртуальные сети в режиме диспетчера ресурсов Azure и хотите настроить подключение между ними, проверьте следующее.

- Для каждой виртуальной сети имеется подсеть шлюза размером /29 или больше.
- Диапазоны адресов для виртуальных сетей не перекрываются.

Если требуется добавить подсети шлюза в собственные виртуальные сети, воспользуйтесь образцом ниже, заменив значения на свои. Обязательно присвойте подсети шлюза имя "GatewaySubnet". Если вы используете другое имя, VPN-подключение не будет работать должным образом.

	
		$vnet = Get-AzureVirtualNetwork -ResourceGroupName testrg -Name testvnet
		Add-AzureVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix 10.0.3.0/28 -VirtualNetwork $vnet
		Set-AzureVirtualNetwork -VirtualNetwork $vnet

Проверив правильность настройки подсетей шлюзов, перейдите к шагу [Запрос общедоступного IP-адреса](#request-a-public-ip-address) и выполните дальнейшие шаги.

## Дальнейшие действия

В виртуальные сети можно добавлять виртуальные машины. [Создание виртуальной машины](../virtual-machines/virtual-machines-windows-tutorial.md).

<!---HONumber=August15_HO9-->