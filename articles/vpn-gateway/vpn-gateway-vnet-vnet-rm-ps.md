<properties
   pageTitle="Настройка подключения через VPN-шлюз между виртуальными сетями, входящими в одну и ту же подписку, с помощью диспетчера ресурсов Azure и PowerShell | Microsoft Azure"
   description="Эта статья описывает этапы настройки подключения между виртуальными сетями с помощью диспетчера ресурсов Azure и PowerShell."
   services="vpn-gateway"
   documentationCenter="na"
   authors="cherylmc"
   manager="carmonm"
   editor=""
   tags="azure-resource-manager"/>

<tags
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="12/18/2015"
   ms.author="cherylmc"/>

# Настройка подключения между виртуальными сетями, входящими в одну и ту же подписку, с помощью диспетчера ресурсов Azure и PowerShell

> [AZURE.SELECTOR]
- [Azure Classic Portal](virtual-networks-configure-vnet-to-vnet-connection.md)
- [PowerShell - Azure Resource Manager](vpn-gateway-vnet-vnet-rm-ps.md)

Эта статья поможет выполнить действия по созданию подключения между виртуальными сетями с помощью модели развертывания **диспетчера ресурсов** и PowerShell. В настоящее время документации для взаимного подключения виртуальных сетей, не входящих в одну и ту же подписку, а также для подключения, созданного с помощью модели развертывания диспетчера ресурсов, не существует. Команда работает над решением этой задачи. Новые инструкции будут добавлены в эту статью. Приведенные ниже инструкции предназначены для виртуальных сетей, которые входят в одну и ту же подписку.

**О моделях развертывания Azure**

[AZURE.INCLUDE [vpn-gateway-clasic-rm](../../includes/vpn-gateway-classic-rm-include.md)]
	
- Если ваши виртуальные сети были созданы с помощью классической модели развертывания, см. статью [Создание подключения виртуальной сети к виртуальной сети](virtual-networks-configure-vnet-to-vnet-connection.md). Классическая модель развертывания поддерживает подключение виртуальных сетей, которые находятся в разных подписках.
	
- Если вы хотите подключить виртуальную сеть, созданную по классической модели развертывания, к виртуальной сети, созданной с помощью модели диспетчера ресурсов Azure, см. статью [Подключение классических виртуальных сетей к новым виртуальным сетям](../virtual-network/virtual-networks-arm-asm-s2s.md).

## О подключениях "виртуальная сеть — виртуальная сеть"

Подключение одной виртуальной сети к другой (подключение типа VNet-to-VNet) очень похоже на подключение виртуальной сети к локальному сайту. В обоих типах подключений используется VPN-шлюз для создания защищенного туннеля, использующего IPsec/IKE. Подключаемые виртуальные сети могут находиться в разных регионах. Можно даже комбинировать подключение виртуальных сетей с многосайтовыми конфигурациями. Это позволяет устанавливать сетевые топологии, совмещающие подключения между организациями с подключениями между виртуальными сетями, как показано на схеме ниже.

![Схема подключения между виртуальными сетями](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727360.png)
 
### Что может дать связь между виртуальными сетями

Вам может потребоваться подключить виртуальные сети по следующим причинам.

- **Межрегиональная географическая избыточность и географическое присутствие**
	- Вы можете настроить собственную георепликацию или синхронизацию с безопасной связью, без прохождения трафика через конечные точки с выходом в Интернет.
	- С помощью балансировщика нагрузки Azure и технологий кластеризации корпорации Майкрософт или сторонних производителей можно настроить высокодоступную рабочую нагрузку с геоизбыточностью в нескольких регионах Azure. Одним из важных примеров является настройка SQL Always On с группами доступности, распределенными по нескольким регионам Azure.

- **Региональные многоуровневые приложения с четкой границей изоляции**
	- В одном регионе можно настроить многоуровневые приложения с использованием нескольких связанных друг с другом виртуальных сетей с сильной изоляцией и защищенной связью между уровнями.


### Часто задаваемые вопросы о подключениях VNet-VNet

- Виртуальные сети могут быть в одном или разных регионах (расположениях) Azure.

- Облачная служба или конечная точка с балансировкой нагрузки НЕ МОЖЕТ распространяться на виртуальные сети, даже если они соединены друг с другом.

- Для подключения нескольких виртуальных сетей Azure друг к другу не требуются локальные VPN-шлюзы, если только не требуется распределенное подключение.

- Подключения между виртуальными сетями поддерживают подключение нескольких виртуальных сетей. Не поддерживается подключение виртуальных машин или облачных служб, размещенных НЕ в виртуальной сети.

- Для подключения между виртуальными сетями необходимы VPN-шлюзы Azure с VPN типа RouteBased (этот тип ранее назывался динамическим).

- Подключение к виртуальной сети может использоваться одновременно с многосайтовыми сетями VPN, использующими до 10 туннелей VPN для подключения VPN-шлюза виртуальной сети к другим виртуальным сетям или локальным сайтам.

- Адресные пространства виртуальных сетей и местных сайтов локальных сетей не должны перекрываться. Перекрытие адресных пространств приведет к сбою при создании виртуальных сетей.

- Избыточные туннели между парой виртуальных сетей не поддерживаются.

- Все туннели VPN виртуальной сети совместно используют доступную пропускную способность VPN-шлюза Azure и одно соглашение об уровне обслуживания VPN-шлюзов в Azure.

- Трафик между виртуальными сетями проходит через магистральную сеть Azure.

## Настройка подключения между виртуальными сетями

В этой статье будут описаны этапы настройки подключения между двумя виртуальными сетями VNet1 и VNet2. Необходим удобный способ настройки сетей, чтобы подставить диапазоны IP-адресов, которые соответствуют вашим требованиям по проектированию сети.

![Подключение между виртуальными сетями](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727361.png)

### Перед началом работы


- Убедитесь в том, что у вас уже есть подписка Azure. Если у вас нет подписки Azure, вы можете [активировать преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрироваться в бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/).

- Установите модули PowerShell. Вам потребуется последняя версия командлетов диспетчера ресурсов PowerShell Azure для настройки подключения.[AZURE.INCLUDE [vpn-gateway-ps-rm-howto](../../includes/vpn-gateway-ps-rm-howto-include.md)]


## Шаг 1. Планирование диапазонов IP-адресов


Важно определить диапазоны адресов, которые будут использоваться при настройке сети. С точки зрения сети VNet1 сеть VNet2 представляет собой просто другое VPN-подключение, определенное на платформе Azure. И из сети VNet2 сеть VNet1 является просто еще одним VPN-подключением. Имейте в виду, необходимо убедиться в том, что ни один из диапазонов виртуальных сетей или диапазонов локальных сетей никак не перекрываются.


Далее мы создадим две виртуальные сети с соответствующими шлюзами подсетей и конфигурациями. Затем мы создадим подключение VPN-шлюза между двумя виртуальными сетями.

В этом упражнении используйте следующие параметры виртуальных сетей.

Параметры для сети VNet1

- Имя виртуальной сети = VNet1
- Группа ресурсов = testrg1
- Адресное пространство = 10.1.0.0/16 
- Регион = US West
- Подсеть шлюза = 10.1.0.0/28
- Подсеть 1 = 10.1.1.0/28

Параметры для сети VNet2

- Имя виртуальной сети = VNet2
- Группа ресурсов = testrg2
- Адресное пространство = 10.2.0.0/16
- Регион = Japan East
- Подсеть шлюза = 10.2.0.0/28
- Подсеть 1 = 10.2.1.0/28

## Шаг 2. Подключение к подписке 

Для работы с командлетами диспетчера ресурсов необходимо перейти в режим PowerShell. Дополнительную информацию см. в разделе [Использование Windows PowerShell с диспетчером ресурсов](../powershell-azure-resource-manager.md).

Откройте консоль PowerShell и подключитесь к своей учетной записи. Для подключения используйте следующий пример.

	Login-AzureRmAccount

Просмотрите подписки учетной записи.

	Get-AzureRmSubscription 

Укажите подписку, которую нужно использовать.

	Select-AzureRmSubscription -Subscriptionid "GUID of subscription"


## Шаг 3. Создание виртуальной сети


Используйте приведенный ниже пример, чтобы создать виртуальную сеть и подсеть шлюза. Подставьте собственные значения. В этом примере мы создадим VNet1. Повторите эти действия позже для создания сети VNet2.

Сначала создайте группу ресурсов.

	New-AzureRmResourceGroup -Name testrg1 -Location 'West US'

Затем создайте виртуальную сеть. В следующем примере создается виртуальная сеть с именем *VNet1* и две подсети с именами *GatewaySubnet* и *Subnet1*. Важно, чтобы одна из подсетей имела имя *GatewaySubnet*. Если вы используете другое имя, подключение не будет настроено. В приведенном ниже примере используется подсеть шлюза /28. При этом для подсети шлюза можно выбрать сеть меньшего размера до /29. Обратите внимание, что для некоторых функций (такие как существующие одновременно соединения ExpressRoute и соединения типа "сеть — сеть") требуется подсеть большего размера /27, поэтому может потребоваться создать собственную подсеть шлюза для размещения дополнительных функций, которые могут потребоваться в будущем.

 	$subnet = New-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix 10.1.0.0/28
	$subnet1 = New-AzureRmVirtualNetworkSubnetConfig -Name 'Subnet1' -AddressPrefix '10.1.1.0/28'
	New-AzureRmVirtualNetwork -Name VNet1 -ResourceGroupName testrg1 -Location 'West US' -AddressPrefix 10.1.0.0/16
	-Subnet $subnet, $subnet1

## Шаг 4. Запрос общедоступного IP-адреса


Затем вы должны запросить общедоступный IP-адрес, который нужно выделить для шлюза, создаваемого для виртуальной сети. Указать необходимый IP-адрес нельзя; он выделяется для шлюза динамически. Этот IP-адрес будет использоваться на следующем этапе конфигурации.

Используйте следующий пример. Для этого адреса нужно использовать метод динамического распределения (Dynamic).


	$gwpip= New-AzureRmPublicIpAddress -Name gwpip1 -ResourceGroupName testrg1 -Location 'West US' -AllocationMethod Dynamic

## Шаг 5. Создание конфигурации шлюза


Конфигурация шлюза определяет используемые подсеть и общедоступный IP-адрес. Используйте следующий пример, чтобы создать конфигурацию шлюза.


	$vnet = Get-AzureRmVirtualNetwork -Name VNet1 -ResourceGroupName testrg1
	$subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -VirtualNetwork $vnet
	$gwipconfig = New-AzureRmVirtualNetworkGatewayIpConfig -Name gwipconfig1 -SubnetId $subnet.Id -PublicIpAddressId $gwpip.Id 

## Шаг 6. Создание шлюза


На этом шаге вы создадите шлюз для своей виртуальной сети. Для подключений типа VNet-to-VNet необходимо использовать тип VPN RouteBased. Создание шлюза может занять некоторое время, поэтому проявите терпение.

	New-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg1 -Location 'West US' -IpConfigurations $gwipconfig -GatewayType Vpn -VpnType RouteBased

## Шаг 7. Создание сети VNet2


После настройки сети VNet1 повторите предыдущие шаги для настройки сети VNet2 и ее шлюза. После завершения настройки обеих виртуальных сетей и их шлюзов перейдите к разделу **Шаг 8. Подключение шлюзов**.

## Шаг 8. Подключение шлюзов

На этом шаге вы создадите подключения VPN-шлюзов между шлюзами двух виртуальных сетей. Вы увидите ссылки на общий ключ в примерах. Можно использовать собственные значения для общего ключа. Важно, чтобы общий ключ в обеих конфигурациях был одинаковым.

Учтите, что на создание конфигураций потребуется некоторое время.

**От сети VNet1 к сети VNet2**
    
    $vnetgw1 = Get-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg1
    $vnetgw2 = Get-AzureRmVirtualNetworkGateway -Name vnetgw2 -ResourceGroupName testrg2
    
    New-AzureRmVirtualNetworkGatewayConnection -Name conn1 -ResourceGroupName testrg1 -VirtualNetworkGateway1 $vnetgw1 -VirtualNetworkGateway2 $vnetgw2 -Location 'West US' -ConnectionType Vnet2Vnet -SharedKey 'abc123'


**От сети VNet2 к сети VNet1**
    
    $vnetgw1 = Get-AzureRmVirtualNetworkGateway -Name vnetgw2 -ResourceGroupName testrg2
    $vnetgw2 = Get-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg1
    
    New-AzureRmVirtualNetworkGatewayConnection -Name conn2 -ResourceGroupName testrg2 -VirtualNetworkGateway1 $vnetgw1 -VirtualNetworkGateway2 $vnetgw2 -Location 'Japan East' -ConnectionType Vnet2Vnet -SharedKey 'abc123'
    

Подключение должно установиться через несколько минут. Обратите внимание, что на данный момент шлюзы и подключения, создаваемые с помощью диспетчера ресурсов Azure, не отображаются на портале предварительной версии.

## Проверка подключений

Сейчас VPN-подключения, созданные с помощью диспетчера ресурсов, не отображаются на портале предварительной версии. Чтобы проверить успешность подключения, используйте команду *Get-AzureRmVirtualNetworkGatewayConnection –Debug*. Позднее мы предоставим отдельный командлет для этого, а также возможность просматривать подключения на портале предварительной версии.

Можно использовать следующий пример командлета. Обязательно измените значения в соответствии с подключением, которое требуется проверить. При появлении запроса выберите ответ *A*, то есть «Все».

	Get-AzureRmVirtualNetworkGatewayConnection -Name vnet2connection -ResourceGroupName vnet2vnetrg -Debug 

 После завершения работы командлета просмотрите результаты, которые он выдал. В следующем примере показано, что подключение установлено (состояние *Connected*), а также указан объем полученных и отправленных данных в байтах.

	Body:
	{
	  "name": "Vnet2Connection",
	  "id": "/subscriptions/a932c0e6-b5cb-4e68-b23d-5064372c8a3cdef/resourceGroups/Vnet2VnetRG/providers/Microsoft.Network/connections/Vnet2Connection",
	  "properties": {
	    "provisioningState": "Succeeded",
	    "resourceGuid": "3c0bc049-860d-46ea-9909-e08098680a8bdef",
	    "virtualNetworkGateway1": {
	      "id": "/subscriptions/a932c0e6-b5cb-4e68-b23d-5064372c8a3cdef/resourceGroups/Vnet2VnetRG/providers/Microsoft.Network/virtualNetworkGateways/Vnet2Gw"
	    },
	    "virtualNetworkGateway2": {
	      "id": "/subscriptions/a932c0e6-b5cb-4e68-b23d-5064372c8a3cdef/resourceGroups/Vnet2VnetRG/providers/Microsoft.Network/virtualNetworkGateways/Vnet1Gw"
	    },
	    "connectionType": "Vnet2Vnet",
	    "routingWeight": 3,
	    "sharedKey": "abc123",
	    "connectionStatus": "Connected",
	    "ingressBytesTransferred": 3359044,
	    "egressBytesTransferred": 4142451
	  }
	} 

[AZURE.INCLUDE [vpn-gateway-no-nsg-include](../../includes/vpn-gateway-no-nsg-include.md)]

## Подключение существующих виртуальных сетей

Если вы уже создали виртуальные сети в режиме диспетчера ресурсов Azure и хотите настроить подключение между ними, проверьте следующее.

- Для каждой виртуальной сети имеется подсеть шлюза размером /29 или больше.
- Диапазоны адресов для виртуальных сетей не перекрываются.
- Ваши виртуальные сети входят в одну и ту же подписку.

Если требуется добавить подсети шлюза в собственные виртуальные сети, воспользуйтесь образцом ниже, заменив значения на свои. Обязательно присвойте подсети шлюза имя "GatewaySubnet". Если вы используете другое имя, VPN-подключение не будет работать должным образом.

	
	$vnet = Get-AzureRmVirtualNetwork -ResourceGroupName testrg -Name testvnet
	Add-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix 10.0.3.0/28 -VirtualNetwork $vnet
	Set-AzureRmVirtualNetwork -VirtualNetwork $vnet

Проверив правильность настройки подсетей шлюзов, перейдите к разделу **Шаг 4. Запрос общедоступного IP-адреса** и следуйте указаниям.


## Дальнейшие действия

Установив подключение, можно добавить виртуальные машины в виртуальные сети. Инструкции см. в разделе [Создание виртуальной машины](../virtual-machines/virtual-machines-windows-tutorial.md).

<!---HONumber=AcomDC_0211_2016-->