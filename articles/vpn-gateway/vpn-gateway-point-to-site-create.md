<properties
   pageTitle="Настройка VPN-подключения «точка-сеть» к виртуальной сети Azure"
   description="Безопасное подключение к виртуальной сети с помощью VPN-подключения типа «точка-сеть»."
   services="vpn-gateway"
   documentationCenter="na"
   authors="cherylmc"
   manager="adinah"
   editor="tysonn"/>

<tags
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="hero-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/12/2015"
   ms.author="cherylmc"/>

# Настройка VPN-подключения «точка-сеть» к виртуальной сети Azure

Настройка подключения «точка-сеть» состоит из нескольких этапов, однако эта процедура позволяет создать защищенное подключение с компьютера к виртуальной сети без покупки и настройки VPN-устройства. Для создания такого VPN-подключения необходимы три основных компонента: виртуальная сеть со шлюзом, сертификаты, используемые для проверки подлинности, и VPN-клиент, который нужен для подключения к виртуальной сети. Порядок настройки этих компонентов играет важную роль, поэтому не пропускайте эти этапы и не меняйте их последовательность.

1. [Настройка виртуальной сети и шлюза динамической маршрутизации](#configure-a-virtual-network-and-a-dynamic-routing-gateway)
2. [Создание сертификатов](#create-your-certificates)
3. [Настройка VPN-клиента](#configure-your-VPN-client)

## Настройка виртуальной сети и шлюза динамической маршрутизации

Для подключения «точка-сеть» необходима виртуальная сеть со шлюзом динамической маршрутизации. Ниже приведены инструкции для их создания.

### Создать виртуальную сеть

1. Выполните вход в **портал управления**.
1. В нижнем левом углу экрана нажмите кнопку **Создать**. В области навигации щелкните **Сети**, а затем — **Виртуальная сеть**. Нажмите кнопку **Настраиваемое создание** для запуска мастера настройки.
1. На странице **Сведения о виртуальной сети** укажите следующие сведения и нажмите кнопку "Далее" в правом нижнем углу. Дополнительную информацию о параметрах на этой странице см. на [странице сведений о виртуальной сети](https://msdn.microsoft.com/library/azure/09926218-92ab-4f43-aa99-83ab4d355555#BKMK_VNetDetails).
	- **Имя**: название виртуальной сети. Например, VNetEast. Это имя используется при развертывании виртуальных машин и экземпляров PaaS в виртуальной сети.
	- **Расположение**: непосредственно связано с физическим расположением (регионом) ресурсов (виртуальных машин). Например, если вы хотите, чтобы виртуальные машины находились в виртуальной сети, которая физически расположена в восточной части США, выберите соответствующий регион. После создания виртуальной сети изменить связанное с ней расположение нельзя.
1. На странице **DNS-серверы и подключение VPN** укажите следующие сведения и щелкните стрелку «Далее» в правом нижнем углу. Дополнительные сведения см. в разделе [Страница «DNS-серверы и подключение VPN»](https://msdn.microsoft.com/library/azure/09926218-92ab-4f43-aa99-83ab4d355555#BKMK_VNETDNS).
	- **DNS-серверы**: введите имя и IP-адрес DNS-сервера или выберите ранее зарегистрированный DNS-сервер из раскрывающегося списка. Этот параметр не создает DNS-сервер, он позволяет указать DNS-серверы, которые вы хотите использовать для разрешения имен в этой виртуальной сети. Чтобы использовать службу разрешения имен Azure по умолчанию, не заполняйте этот раздел.
	- **Настройка VPN «точка-сеть»**: установите флажок.
1. На странице **Подключение «точка-сеть»** укажите диапазон IP-адресов, из которого VPN-клиенты будут получать адреса при подключении. При выборе диапазона адресов необходимо руководствоваться определенными правилами. Диапазон не должен пересекаться с другими диапазонами, расположенными в вашей локальной сети. Дополнительные сведения см. в статье [Страница «Подключение "точка-сеть"»](https://msdn.microsoft.com/library/azure/09926218-92ab-4f43-aa99-83ab4d355555#BKMK_VNETPT).
1. Укажите следующие сведения и нажмите кнопку «Далее».
 - **Адресное пространство**: начальный IP-адрес и значение CIDR (количество адресов).
 - **Добавить адресное пространство**: используйте эту функцию, только если это соответствует топологии вашей сети.
1. На странице **Адресное пространство виртуальной сети** укажите диапазон адресов, который вы хотите использовать для виртуальной сети. Это динамические IP-адреса (DIP), которые будут назначаться виртуальным машинам и другим экземплярам ролей, развертываемым в этой виртуальной сети. В отношении адресного пространства виртуальной сети действует целый ряд правил, поэтому рекомендуем вам ознакомиться с разделом «Страница "Адресное пространство виртуальной сети"», который содержит дополнительную информацию. Особенно важно выбрать диапазон, который не пересекается с другими диапазонами, используемыми в локальной сети. Этот момент необходимо согласовать с администратором, который может выделить для вашей виртуальной сети диапазон IP-адресов из адресного пространства локальной сети.
1. Введите указанную ниже информацию и установите флажок, чтобы приступить к созданию виртуальной сети.
 - **Адресное пространство**: задайте внутренний диапазон IP-адресов для своей виртуальной сети, включая начальный IP-адрес и количество. В отношении адресного пространства виртуальной сети действует целый ряд правил, поэтому рекомендуем вам ознакомиться с разделом [Страница «Адресное пространство виртуальной сети»](https://msdn.microsoft.com/library/azure/09926218-92ab-4f43-aa99-83ab4d355555#BKMK_VNET_ADDRESS), который содержит дополнительную информацию. Особенно важно выбрать диапазон, который не пересекается с другими диапазонами, используемыми в локальной сети. Этот момент необходимо согласовать с администратором, который может выделить для вашей виртуальной сети диапазон IP-адресов из адресного пространства локальной сети.
 - **Добавить подсеть**: дополнительные подсети не обязательны, однако вам может понадобиться создать отдельную подсеть для виртуальных машин со статическими адресами DIPS. Кроме того, вы можете захотеть разместить виртуальные машины в подсети отдельно от других экземпляров ролей.
 - **Добавить подсеть шлюза**: подсеть шлюза необходима для VPN-подключения «точка-сеть». Нажмите эту кнопку, чтобы добавить ее. Подсеть шлюза используется только для шлюза виртуальной сети.
1. После создания виртуальной сети на странице "Сети" портала управления в поле **Состояние** появится значение **Создано**. После создания виртуальной сети можно приступать к созданию шлюза динамической маршрутизации.

### Создание шлюза динамической маршрутизации

1. На **портале управления** на странице **Сети** щелкните только что созданную виртуальную сеть и откройте страницу **Панель мониторинга**.
1. В нижней части страницы панели мониторинга нажмите кнопку **Создать шлюз**. Появится сообщение **Создать шлюз для виртуальной сети «ваша сеть»?** Нажмите кнопку **Да**, чтобы начать создание шлюза. Создание шлюза может занять около 15 минут.

## Создание сертификатов

Сертификаты используются для проверки подлинности VPN-клиентов в VPN-подключениях «точка-сеть». Эта процедура состоит из нескольких этапов. Для перехода к соответствующим разделам используйте ссылки ниже.

1. [Создание самозаверяющего корневого сертификата](#generate-a-self-signed-root-certificate) (в настоящее время поддерживаются только самозаверяющие корневые сертификаты).
2. [Загрузка файла корневого сертификата на портал управления](#upload-the-root-certificate-file-to-the-Management-Portal)
3. [Создание сертификата клиента](#generate-a-client-certificate)
4. [Экспорт и установка сертификата клиента](#export-and-install-the-client-certificate)

### Создание самозаверяющего корневого сертификата

1. Создать сертификат X.509 можно с помощью средства создания сертификатов (makecert.exe). Чтобы воспользоваться этим инструментом, загрузите и установите бесплатное приложение [Microsoft Visual Studio Express 2013 для Windows Desktop](https://www.visualstudio.com/products/visual-studio-express-vs.aspx).
2. Откройте папку **Инструменты Visual Studio** и запустите окно командной строки от имени администратора.
3. Команда в приведенном ниже примере создаст и установит корневой сертификат в хранилище личных сертификатов на компьютере, а также сформирует соответствующий *CER*-файл, который вы затем загрузите на портал управления.
4. Перейдите в каталог, в котором должен располагаться CER-файл, и выполните указанную ниже команду, где *RootCertificateName* — имя, которое следует использовать для сертификата. Если выполнить команду без изменений, она сформирует корневой сертификат и соответствующий файл *RootCertificateName.cer*.

>[AZURE.NOTE]Поскольку был создан корневой сертификат, из которого будут создаваться клиентские сертификаты, вы можете экспортировать этот сертификат вместе с его закрытым ключом и сохранить в безопасном месте, где его можно будет восстановить.

    makecert -sky exchange -r -n "CN=RootCertificateName" -pe -a sha1 -len 2048 -ss My "RootCertificateName.cer"

### Загрузка файла корневого сертификата на портал управления

1. При создании самозаверяющего корневого сертификата на предыдущем этапе также создается *CER*-файл. Теперь его необходимо загрузить на портал управления. Обратите внимание на то, что CER-файл не содержит закрытый ключ корневого сертификата.
1. На портале управления на странице **Сертификаты** для вашей виртуальной сети щелкните **Загрузить корневой сертификат**.
1. На странице **Загрузка сертификата** найдите CER-файл корневого сертификата и установите флажок.

### Создание сертификата клиента

1. На компьютере, на котором вы создали самозаверяющий корневой сертификат, откройте окно командной строки Visual Studio от имени администратора.
2. Смените каталог, выбрав папку, в которую хотите сохранить файл сертификата клиента. Имя *RootCertificateName* обозначает созданный вами самозаверяющий корневой сертификат. Если выполнить приведенную ниже команду (заменив строку RootCertificateName названием вашего корневого сертификата), в ваше хранилище личных сертификатов будет добавлен сертификат клиента под названием ClientCertificateName.
3. Введите следующую команду:

    makecert.exe -n "CN=ClientCertificateName" -pe -sky exchange -m 96 -ss My -in "RootCertificateName" -is my -a sha1

4. Все сертификаты находятся в хранилище личных сертификатов на вашем компьютере. Выполните команду *certmgr*, чтобы проверить результат. С помощью этой процедуры можно создать любое количество сертификатов. Рекомендуем создавать уникальные сертификаты клиентов для всех компьютеров, которые будут подключаться к виртуальной сети.

### Экспорт и установка сертификата клиента

1. Сертификат клиента необходимо установить на каждый компьютер, который будет подключаться к виртуальной сети. Это означает, что вам, скорее всего, потребуется создать несколько сертификатов, которые затем нужно будет экспортировать. Для экспорта сертификатов клиента используйте команду *certmgr.msc*. Щелкните правой кнопкой мыши сертификат, который нужно экспортировать, выберите **все задачи** и щелкните **экспорт**.
2. Экспортируйте *сертификат клиента* с закрытым ключом. Он сохраняется в *PFX*-файле. Обязательно запишите или запомните пароль (ключ), который задали для этого сертификата.
3. Скопируйте *PFX*-файл на клиентский компьютер. На клиентском компьютере дважды щелкните *PFX*-файл, чтобы установить его. В окне запроса введите пароль. Не меняйте место установки.

## Настройка VPN-клиента

Для подключения к виртуальной сети также потребуется настроить VPN-клиент. Для подключения ему необходим как сертификат клиента, так и правильные настройки.

### Создание пакета конфигурации VPN-клиента

1. На портале управления на странице панели мониторинга своей виртуальной сети перейдите к **быстрому меню** в правом углу и щелкните пакет VPN для клиента, который требуется подключить к виртуальной сети. Поддерживаются перечисленные ниже операционные системы.
 - Windows 7 (32-разрядная и 64-разрядная версии)
 - Windows Server 2008 R2 (только 64-разрядная версия)
 - Windows 8 (32-разрядная и 64-разрядная версии)
 - Windows 8.1 (32-разрядная и 64-разрядная версии)
 - Windows Server 2012 (только 64-разрядная версия)
 - Windows Server 2012 R2 (только 64-разрядная версия)

1. Выберите пакет загрузки для операционной системы, в которой требуется установить клиент.
 - Для 32-разрядных клиентов выбирайте вариант **Загрузить пакет VPN-клиента (32-разрядная версия)**.
 - Для 64-разрядных клиентов выбирайте вариант **Загрузить пакет VPN-клиента (64-разрядная версия)**.
1. Создание пакета занимает несколько минут. После завершения этой процедуры вы сможете скачать файл. Загруженный *EXE*-файл можно сохранить на локальном компьютере.
1. Создав и загрузив пакет VPN-клиента с портала управления, вы можете установить его на клиентском компьютере, с которого планируете подключаться к виртуальной сети. Если вы собираетесь установить пакет на несколько компьютеров, на каждом из них также должен быть установлен сертификат клиента. Пакет VPN-клиента содержит данные конфигурации для настройки VPN-клиента, встроенного в систему Windows. Пакет не устанавливает никакого дополнительного программного обеспечения.

### Установка пакета конфигурации VPN на клиенте и запуск подключения

1. Скопируйте файл конфигурации на локальный компьютер, который хотите подключить к виртуальной сети, и дважды щелкните EXE-файл. После установки пакета можно запускать VPN-подключение. Обратите внимание на то, что пакет конфигурации не подписан компанией Майкрософт. Вы можете подписать его с помощью службы подписей вашей организации либо собственной подписью с помощью инструмента [SignTool](https://msdn.microsoft.com/library/windows/desktop/aa387764(v=vs.85).aspx). Пакет можно использовать и без подписи. Однако если он не подписан, при его установке появится предупреждение.
2. На клиентском компьютере откройте VPN-подключения и найдите только что созданное. Его имя совпадает с названием вашей виртуальной сети. Щелкните **Подключить**.
3. Появится всплывающее сообщение, с помощью которого создается самозаверяющий сертификат для конечной точки шлюза. Нажмите кнопку **Продолжить**, чтобы использовать повышенные привилегии.
4. На странице состояния **Подключение** щелкните **Подключить**.
5. Если появится окно **Выбор сертификата**, убедитесь в том, что отображается сертификат клиента, с помощью которого вы хотите подключиться к сети. В противном случае выберите нужный сертификат из раскрывающегося списка и нажмите кнопку **ОК**.
6. Теперь вы подключены к своей виртуальной сети и имеете полный доступ ко всем службам и виртуальным машинам, которые в ней расположены.

### Проверка VPN-подключения

1. Чтобы проверить, активно ли VPN-подключение, откройте окно командной строки от имени администратора и выполните команду *ipconfig/all*.
2. Просмотрите результаты. Обратите внимание на то, что полученный вами IP-адрес — это один из адресов в адресном пространстве подключения «точка-сеть», которое вы указали при создании виртуальной сети. Результаты должны выглядеть примерно так:

Пример:



    PPP adapter VNetEast:
		Connection-specific DNS Suffix .:
		Description.....................: VNetEast
		Physical Address................:
		DHCP Enabled....................: No
		Autoconfiguration Enabled.......: Yes
		IPv4 Address....................: 192.168.130.2(Preferred)
		Subnet Mask.....................: 255.255.255.255
		Default Gateway.................:
		NetBIOS over Tcpip..............: Enabled



## См. также


Дополнительные сведения о подключении к виртуальным сетям между организациями см. в статье [Сведения о безопасной виртуальной сети между несколькими организациями](https://msdn.microsoft.com/library/azure/dn133798.aspx).

Сведения о настройке VPN-подключений типа «сеть-есть» см. в статье [Настройка VPN-подключения «сеть-сеть»](vpn-gateway-site-to-site-create.md).

В виртуальную сеть можно добавлять виртуальные машины. Соответствующие инструкции см. в статье [Как создать настраиваемую виртуальную машину](../virtual-machines/virtual-machines-create-custom.md).

Настройка подключения к виртуальной сети с помощью RRAS описана в статье [Организация виртуальной частной сети типа «сеть-сеть» в виртуальной сети Azure с помощью службы маршрутизации и удаленного доступа (RRAS) Windows Server 2012](https://msdn.microsoft.com/library/dn636917.aspx).
 

<!---HONumber=58_postMigration-->