<properties
   pageTitle="Настройка VPN-подключения «точка-сеть» к виртуальной сети Azure | Microsoft Azure"
   description="Безопасно подключайтесь к своей виртуальной сети Azure, создав VPN-подключение типа «точка-сеть». Инструкции для виртуальных сетей, созданных с помощью модели развертывания службы управления (классическая модель)."
   services="vpn-gateway"
   documentationCenter="na"
   authors="cherylmc"
   manager="carolz"
   editor=""
   tags="azure-service-management"/>

<tags
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="hero-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="11/09/2015"
   ms.author="cherylmc"/>

# Настройка VPN-подключения типа «точка — сеть» к виртуальной сети


Это статья о подключениях типа «точка — сеть» для виртуальных сетей, созданных с помощью классической модели развертывания (Service Management).

**На данный момент подключения типа «точка —сеть» к виртуальной сети, созданной с помощью модели развертывания диспетчера ресурсов Azure, не поддерживаются.** Эта страница будет обновлена, как только мы включим поддержку этой функции для модели развертывания диспетчера ресурсов.

[AZURE.INCLUDE [vpn-gateway-sm-rm](../../includes/vpn-gateway-sm-rm-include.md)]

Следующая процедура поможет пошагово выполнить создание безопасного подключения типа «точка-сеть» к виртуальной сети. Хотя настройка подключения типа «точка-сеть» состоит из нескольких этапов, это отличный способ создать безопасное подключение компьютера к виртуальной сети без покупки и настройки VPN-устройства. Для создания такого VPN-подключения необходимы три основных компонента: виртуальная сеть и VPN-шлюз, сертификаты, используемые для аутентификации, и VPN-клиент, который используется для подключения к виртуальной сети. Порядок настройки этих компонентов играет важную роль, поэтому не пропускайте эти этапы и не меняйте их последовательность.


1. Создание виртуальной сети и VPN-шлюза
2. Создание и отправка сертификатов
3. Настройка VPN-клиента

## 1\. Создание виртуальной сети и VPN-шлюза


Для подключения «точка-сеть» необходима виртуальная сеть со шлюзом динамической маршрутизации. Следующие действия помогут вам создать их.

Шаг 1. Создание виртуальной сети.

Шаг 2. Создание шлюза с динамической маршрутизацией.

### Шаг 1. Создание виртуальной сети

1. Войдите на **портал Azure** (не на портал предварительной версии).
1. В нижнем левом углу экрана нажмите кнопку **Создать**. В области навигации щелкните **Сети**, а затем — **Виртуальная сеть**. Нажмите кнопку **Настраиваемое создание** для запуска мастера настройки.
1. На странице **Сведения о виртуальной сети** укажите следующие сведения и нажмите кнопку "Далее" в правом нижнем углу.
	- **Имя**: название виртуальной сети. Например, VNetEast. Это имя используется при развертывании виртуальных машин и экземпляров PaaS в виртуальной сети.
	- **Расположение**: непосредственно связано с физическим расположением (регионом) ресурсов (виртуальных машин). Например, если вы хотите, чтобы виртуальные машины находились в виртуальной сети, которая физически расположена в восточной части США, выберите соответствующий регион. После создания виртуальной сети изменить связанное с ней расположение нельзя.
1. На странице **DNS-серверы и подключение VPN** укажите следующие сведения и щелкните стрелку «Далее» в правом нижнем углу.
	- **DNS-серверы**: введите имя и IP-адрес DNS-сервера или выберите ранее зарегистрированный DNS-сервер в контекстном меню. Этот параметр не создает DNS-сервер, он позволяет указать DNS-серверы, которые вы хотите использовать для разрешения имен в этой виртуальной сети. Чтобы использовать службу разрешения имен Azure по умолчанию, не заполняйте этот раздел.
	- **Настройка VPN «точка-сеть»**: установите флажок.
1. На странице **Подключение «точка-сеть»** укажите диапазон IP-адресов, из которого VPN-клиенты будут получать адреса при подключении. При выборе диапазона адресов необходимо руководствоваться определенными правилами. Диапазон не должен пересекаться с другими диапазонами, расположенными в вашей локальной сети.
1. Укажите следующие сведения и нажмите кнопку «Далее».
 - **Адресное пространство**: начальный IP-адрес и значение CIDR (количество адресов).
 - **Добавить адресное пространство**: используйте эту функцию, только если это соответствует топологии вашей сети.
1. На странице **Адресное пространство виртуальной сети** укажите диапазон адресов, который вы хотите использовать для виртуальной сети. Это динамические IP-адреса (DIP), которые будут назначаться виртуальным машинам и другим экземплярам ролей, развертываемым в этой виртуальной сети. Особенно важно выбрать диапазон, который не пересекается с другими диапазонами, используемыми в локальной сети. Этот момент необходимо согласовать с администратором, который может выделить для вашей виртуальной сети диапазон IP-адресов из адресного пространства локальной сети.
1. Введите указанную ниже информацию и установите флажок, чтобы приступить к созданию виртуальной сети.
 - **Адресное пространство**: задайте внутренний диапазон IP-адресов для своей виртуальной сети, включая начальный IP-адрес и количество. Важно выбрать диапазон, который не пересекается с другими диапазонами, используемыми в локальной сети. Этот момент необходимо согласовать с администратором, который может выделить для вашей виртуальной сети диапазон IP-адресов из адресного пространства локальной сети.
 - **Добавить подсеть**: дополнительные подсети не обязательны, однако вам может понадобиться создать отдельную подсеть для виртуальных машин со статическими адресами DIPS. Кроме того, вы можете захотеть разместить виртуальные машины в подсети отдельно от других экземпляров ролей.
 - **Добавить подсеть шлюза**: подсеть шлюза необходима для VPN-подключения «точка-сеть». Нажмите эту кнопку, чтобы добавить ее. Подсеть шлюза используется только для шлюза виртуальной сети.
1. После создания виртуальной сети на портале Azure на странице «Сети» в поле **Состояние** появится значение **Создано**. После создания виртуальной сети можно приступать к созданию шлюза динамической маршрутизации.

### Шаг 2. Создание шлюза с динамической маршрутизацией

Тип шлюза должен быть динамическим. Эта функция не поддерживает шлюзы со статической маршрутизацией.

1. На портале Azure на странице **Сети** щелкните созданную виртуальную сеть и откройте страницу **Панель мониторинга**.
1. В нижней части страницы **Панель мониторинга** нажмите кнопку **Создать шлюз**. Появится сообщение **Создать шлюз для виртуальной сети «ваша сеть»?** Нажмите кнопку **Да**, чтобы начать создание шлюза. Создание шлюза может занять около 15 минут.

## 2\. Создание и отправка сертификатов

Сертификаты используются для проверки подлинности VPN-клиентов в VPN-подключениях «точка-сеть». Раньше необходимо было создавать собственный самозаверяющий сертификат. Теперь вы можете использовать сертификаты, созданные с помощью корпоративного решения. Вы можете отправить на портал Azure до 20 корневых сертификатов.

Сведения о том, как использовать самозаверяющий сертификат, приведены ниже. Процесс использования сертификата, созданного с помощью корпоративного решения, будет отличаться. Кроме того, вам нужно будет сделать следующее.


Шаг 1. Определение или создание корневого сертификата.

Шаг 2. Отправка CER-файла корневого сертификата на портал Azure.

Шаг 3. Создание сертификата клиента.

Шаг 4. Экспорт и установка сертификата клиента.


### Шаг 1. Определение или создание корневого сертификата

Если вы не планируете использовать сертификат, созданный с помощью корпоративного решения, вам нужно создать самозаверяющий корневой сертификат. В описанных ниже шагах используется ОС Windows 8. Сейчас мы обновляем этот процесс, делая возможным использование Windows 10.

1. Создать сертификат X.509 можно с помощью средства создания сертификатов (makecert.exe). Чтобы воспользоваться этим средством, загрузите и установите бесплатное приложение [Microsoft Visual Studio Express](https://www.visualstudio.com/products/visual-studio-express-vs.aspx).
2. Откройте папку «Инструменты Visual Studio» и запустите окно командной строки от имени администратора.
3. Команда в приведенном ниже примере создаст и установит корневой сертификат в хранилище личных сертификатов на компьютере, а также создаст соответствующий *CER*-файл, который вы затем отправите на портал Azure.
4. Перейдите в каталог, в котором будет размещен CER-файл, и выполните указанную ниже команду, где *RootCertificateName* — имя сертификата. Если выполнить команду без изменений, будет создан корневой сертификат и соответствующий файл *RootCertificateName.cer*.

>[AZURE.NOTE]Поскольку был создан корневой сертификат, из которого будут создаваться клиентские сертификаты, вы можете экспортировать этот сертификат вместе с его закрытым ключом и сохранить в безопасном месте, где его можно будет восстановить.

    makecert -sky exchange -r -n "CN=RootCertificateName" -pe -a sha1 -len 2048 -ss My "RootCertificateName.cer"

### Шаг 2. Отправка CER-файла корневого сертификата на портал Azure

Вам нужно будет отправить на портал Azure соответствующий CER-файл для каждого корневого сертификата. Вы можете отправить до 20 сертификатов.

1. При создании корневого сертификата (на предыдущем этапе) также создается *CER*-файл. Теперь его необходимо передать на портал Azure. Обратите внимание на то, что CER-файл не содержит закрытый ключ корневого сертификата. Вы можете отправить до 20 корневых сертификатов.
1. На портале Azure на странице **Сертификаты** своей виртуальной сети щелкните **Загрузить корневой сертификат**.
1. На странице **Загрузка сертификата** найдите CER-файл корневого сертификата и установите флажок.

### Шаг 3. Создание сертификата клиента

Описанные ниже шаги помогут вам создать сертификат клиента из корневого самозаверяющего сертификата. Если вы используете сертификат, созданный с помощью корпоративного решения, придерживайтесь следующих правил.

1. На компьютере, на котором вы создали самозаверяющий корневой сертификат, откройте окно командной строки Visual Studio от имени администратора.
2. Смените каталог, выбрав папку, в которую хотите сохранить файл сертификата клиента. Имя *RootCertificateName* обозначает созданный вами самозаверяющий корневой сертификат. Если выполнить приведенную ниже команду (заменив строку RootCertificateName именем вашего корневого сертификата), в ваше хранилище личных сертификатов будет добавлен сертификат клиента ClientCertificateName.
3. Введите следующую команду:

    makecert.exe -n "CN=ClientCertificateName" -pe -sky exchange -m 96 -ss My -in "RootCertificateName" -is my -a sha1

4. Все сертификаты находятся в хранилище личных сертификатов на вашем компьютере. Выполните команду *certmgr*, чтобы проверить результат. С помощью этой процедуры можно создать любое количество сертификатов. Рекомендуем создавать уникальные сертификаты клиентов для всех компьютеров, которые будут подключаться к виртуальной сети.

### Шаг 4. Экспорт и установка сертификата клиента

Установка сертификата клиента на каждый компьютер, который будет подключен к виртуальной сети, является обязательным шагом. Описанные ниже шаги помогут вам установить сертификат клиента вручную.

1. Сертификат клиента необходимо установить на каждый компьютер, который будет подключаться к виртуальной сети. Это означает, что вам, скорее всего, потребуется создать несколько сертификатов, которые затем нужно будет экспортировать. Для экспорта сертификатов клиента используйте команду *certmgr.msc*. Щелкните правой кнопкой мыши сертификат, который нужно экспортировать, выберите элемент **Все задачи** и нажмите кнопку **Экспорт**.
2. Экспортируйте *сертификат клиента* с закрытым ключом. Он сохраняется в *PFX*-файле. Обязательно запишите или запомните пароль (ключ), который задали для этого сертификата.
3. Скопируйте *PFX*-файл на клиентский компьютер. На клиентском компьютере дважды щелкните *PFX*-файл, чтобы установить его. В окне запроса введите пароль. Не меняйте место установки.

## 3\. Настройка VPN-клиента

Для подключения к виртуальной сети также потребуется настроить VPN-клиент. Для подключения ему необходим как сертификат клиента, так и правильные настройки.

Настройка VPN-клиента включает три этапа.

Шаг 1. Создание пакета конфигурации VPN-клиента.

Шаг 2. Установка пакета конфигурации VPN на клиенте и запуск подключения.

Шаг 3. Проверка подключения.

### Шаг 1. Создание пакета конфигурации VPN-клиента

1. На портале Azure в правом углу страницы **Панель мониторинга** своей виртуальной сети в меню сводки щелкните пакет VPN для клиента, который нужно подключить к виртуальной сети.
2. 
Поддерживаются перечисленные ниже операционные системы.
 - Windows 7 (32-разрядная и 64-разрядная версии)
 - Windows Server 2008 R2 (только 64-разрядная версия)
 - Windows 8 (32-разрядная и 64-разрядная версии)
 - Windows 8.1 (32-разрядная и 64-разрядная версии)
 - Windows Server 2012 (только 64-разрядная версия)
 - Windows Server 2012 R2 (только 64-разрядная версия)
 - Windows 10 (сейчас проверяется)

1. Выберите пакет загрузки для операционной системы, в которой требуется установить клиент.
 - Для 32-разрядных клиентов выберите вариант **Загрузить пакет VPN-клиента (32-разрядная версия)**.
 - Для 64-разрядных клиентов выберите вариант **Загрузить пакет VPN-клиента (64-разрядная версия)**.
1. Создание пакета занимает несколько минут. После завершения этой процедуры вы сможете скачать файл. Загруженный *EXE*-файл можно сохранить на локальном компьютере.
1. Создав и скачав пакет VPN-клиента с портала Azure, вы можете установить его на клиентском компьютере, с которого планируете подключаться к виртуальной сети. Если вы планируете установить пакет VPN-клиента на нескольких клиентских компьютерах, убедитесь, что на каждом из них также установлен сертификат клиента. Пакет VPN-клиента содержит данные конфигурации для настройки программного обеспечения VPN-клиента, встроенного в Windows. Пакет не устанавливает никакого дополнительного программного обеспечения.

### Шаг 2. Установка пакета конфигурации VPN на клиенте и запуск подключения

1. Скопируйте файл конфигурации на локальный компьютер, который хотите подключить к виртуальной сети, и дважды щелкните EXE-файл. После установки пакета можно запускать VPN-подключение. Обратите внимание на то, что пакет конфигурации не подписан компанией Майкрософт. Вы можете подписать его с помощью корпоративной службы подписей или инструмента [SignTool](http://go.microsoft.com/fwlink/p/?LinkId=699327) (используя собственную подпись). Пакет можно использовать и без подписи. Однако если он не подписан, при его установке появится предупреждение.
2. На клиентском компьютере откройте VPN-подключения и найдите только что созданное. Его имя совпадает с названием вашей виртуальной сети. Щелкните **Подключить**.
3. Появится всплывающее сообщение, с помощью которого создается самозаверяющий сертификат для конечной точки шлюза. Нажмите кнопку **Продолжить**, чтобы использовать повышенные привилегии.
4. На странице состояния **Подключение** щелкните **Подключить**.
5. Если появится окно **Выбор сертификата**, убедитесь в том, что отображается сертификат клиента, с помощью которого вы хотите подключиться к сети. В противном случае выберите нужный сертификат из раскрывающегося списка и нажмите кнопку **ОК**.
6. Теперь вы подключены к своей виртуальной сети и имеете полный доступ ко всем службам и виртуальным машинам, которые в ней расположены.

### Шаг 3. Проверка VPN-подключения

1. Чтобы проверить, активно ли VPN-подключение, откройте окно командной строки от имени администратора и выполните команду *ipconfig/all*.
2. Просмотрите результаты. Обратите внимание на то, что полученный вами IP-адрес — это один из адресов в адресном пространстве подключения «точка-сеть», которое вы указали при создании виртуальной сети. Результаты должны выглядеть примерно так:

Пример:



    PPP adapter VNetEast:
		Connection-specific DNS Suffix .:
		Description.....................: VNetEast
		Physical Address................:
		DHCP Enabled....................: No
		Autoconfiguration Enabled.......: Yes
		IPv4 Address....................: 192.168.130.2(Preferred)
		Subnet Mask.....................: 255.255.255.255
		Default Gateway.................:
		NetBIOS over Tcpip..............: Enabled

## Дальнейшие действия

Дополнительную информацию о распределенных подключениях к виртуальным сетям см. в статье [О безопасном распределенном подключении виртуальной сети](vpn-gateway-cross-premises-options.md).

Если вы хотите настроить VPN-подключение типа «сеть-сеть», см. раздел [Настройка виртуальной сети с VPN-подключением шлюза типа «сеть-сеть»](vpn-gateway-site-to-site-create.md).

В виртуальную сеть можно добавлять виртуальные машины. См. раздел [Создание настраиваемой виртуальной машины](../virtual-machines/virtual-machines-create-custom.md).

Дополнительные сведения о виртуальных сетях см. на странице [Документация по виртуальным сетям](https://azure.microsoft.com/documentation/services/virtual-network/).

<!---HONumber=Nov15_HO3-->