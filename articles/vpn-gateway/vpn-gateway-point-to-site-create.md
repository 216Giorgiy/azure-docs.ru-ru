<properties
   pageTitle="Настройка VPN-подключения типа ";точка — сеть"; к виртуальной сети | Microsoft Azure"
   description="Безопасно подключайтесь к своей виртуальной сети Azure, создав VPN-подключение типа ";точка — сеть";. Инструкции для виртуальных сетей, созданных с помощью модели развертывания службы управления (классическая модель)."
   services="vpn-gateway"
   documentationCenter="na"
   authors="cherylmc"
   manager="carolz"
   editor=""
   tags="azure-service-management"/>

<tags
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="hero-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="01/11/2016"
   ms.author="cherylmc"/>

# Настройка VPN-подключения типа "точка — сеть" к виртуальной сети

> [AZURE.SELECTOR]
- [PowerShell - Resource Manager](vpn-gateway-howto-point-to-site-rm-ps.md)
- [Portal - Classic](vpn-gateway-point-to-site-create.md)

Конфигурация типа "точка — сеть" позволяет создать отдельное безопасное подключение к виртуальной сети с клиентского компьютера. VPN-подключение сначала устанавливается с локального клиентского компьютера. Это идеальное решение для подключения к виртуальной сети из удаленного расположения, например, если вы находитесь дома или на конференции либо если подключение к виртуальной сети требуется всего нескольким клиентам. Для подключения типа "точка — сеть" не требуется VPN-устройство или общедоступный IP-адрес. Дополнительные сведения о подключениях типа "точка — сеть" см. в статьях [VPN-шлюз: вопросы и ответы](vpn-gateway-vpn-faq.md#point-to-site-connections) и [О безопасных распределенных подключениях для виртуальных сетей](vpn-gateway-cross-premises-options.md).

Это статья о подключениях типа "точка — сеть" через VPN-шлюз к виртуальным сетям, созданным с помощью **классической модели развертывания** (Service Management). Если вы хотите настроить подключение типа "точка — сеть" для виртуальной сети, созданной с помощью диспетчера ресурсов, см. статью [Configure a Point-to-Site connection to a virtual network using PowerShell](vpn-gateway-howto-point-to-site-rm-ps.md) (Настройка подключения типа "точка — сеть" к виртуальной сети с помощью PowerShell).

[AZURE.INCLUDE [vpn-gateway-classic-rm](../../includes/vpn-gateway-classic-rm-include.md)]


## О подключении типа "точка — сеть"
 
Следующие инструкции помогут поэтапно выполнить создание безопасного подключения типа "точка — сеть" к виртуальной сети. Хотя настройка подключения типа "точка — сеть" состоит из нескольких этапов, это отличный способ создать безопасное подключение компьютера к виртуальной сети без покупки и настройки VPN-устройства.

Настройка соединения типа "точка — сеть" разбита на три раздела. **Раздел 1** содержит инструкции по созданию виртуальной сети и VPN-шлюза, **раздел 2** поможет создать сертификаты, используемые для проверки подлинности, а в **разделе 3** приводятся действия для VPN-клиента, который будет использоваться для подключения к виртуальной сети. Порядок настройки этих компонентов играет важную роль, поэтому не пропускайте эти этапы и не меняйте их последовательность.

## Раздел 1. Создание виртуальной сети и VPN-шлюза

Для подключения "точка — сеть" необходима виртуальная сеть со шлюзом динамической маршрутизации. Следующие действия помогут вам создать необходимые компоненты.

Шаг 1. Создание виртуальной сети.

Шаг 2. Создание шлюза с динамической маршрутизацией.

### Создать виртуальную сеть

1. Войдите на **классический портал Azure** (не на портал Azure).
1. В нижнем левом углу экрана нажмите кнопку **Создать**. В области навигации щелкните **Сети**, а затем — **Виртуальная сеть**. Нажмите кнопку **Настраиваемое создание** для запуска мастера настройки.
1. На странице **Сведения о виртуальной сети** укажите следующие сведения и нажмите кнопку "Далее" в правом нижнем углу.
	- **Имя**: название виртуальной сети. Например, VNetEast. Это имя используется при развертывании виртуальных машин и экземпляров PaaS в виртуальной сети.
	- **Расположение**: непосредственно связано с физическим расположением (регионом) ресурсов (виртуальных машин). Например, если вы хотите, чтобы виртуальные машины находились в виртуальной сети, которая физически расположена в восточной части США, выберите соответствующий регион. После создания виртуальной сети изменить связанное с ней расположение нельзя.
1. На странице **DNS-серверы и подключение VPN** укажите следующие сведения и щелкните стрелку "Далее" в правом нижнем углу.
	- **DNS-серверы**: введите имя и IP-адрес DNS-сервера или выберите из контекстного меню ранее зарегистрированный DNS-сервер. Этот параметр не создает DNS-сервер, он позволяет указать DNS-серверы, которые вы хотите использовать для разрешения имен в этой виртуальной сети. Чтобы использовать службу разрешения имен Azure по умолчанию, не заполняйте этот раздел.
	- **Настройка VPN "точка — сеть"**: установите флажок.
1. На странице **Подключение типа "точка-сеть"** укажите диапазон IP-адресов, из которого VPN-клиенты будут получать адреса при подключении. Здесь также есть несколько правил для диапазонов адресов. При необходимости эти правила можно задействовать. Диапазон не должен пересекаться с другими диапазонами, расположенными в вашей локальной сети.
1. Укажите следующие сведения и нажмите кнопку "Далее".
 - **Адресное пространство**: начальный IP-адрес и значение CIDR (количество адресов).
 - **Добавить адресное пространство**: добавляйте адресное пространство только в том случае, если этого требует конфигурация вашей сети.
1. На странице **Адресное пространство виртуальной сети** укажите диапазон адресов, который вы хотите использовать для виртуальной сети. Это динамические IP-адреса (DIP), которые будут назначаться виртуальным машинам и другим экземплярам ролей, развертываемым в этой виртуальной сети. Особенно важно выбрать диапазон, который не пересекается с другими диапазонами, используемыми в локальной сети. Этот момент необходимо согласовать с администратором, который может выделить для вашей виртуальной сети диапазон IP-адресов из адресного пространства локальной сети.
1. Введите указанную ниже информацию и установите флажок, чтобы приступить к созданию виртуальной сети.
 - **Адресное пространство**: задайте внутренний диапазон IP-адресов для своей виртуальной сети, включая начальный IP-адрес и количество. Важно выбрать диапазон, который не пересекается с другими диапазонами, используемыми в локальной сети. Этот момент необходимо согласовать с администратором, который может выделить для вашей виртуальной сети диапазон IP-адресов из адресного пространства локальной сети.
 - **Добавить подсеть**: дополнительные подсети не обязательны, однако вам может понадобиться создать отдельную подсеть для виртуальных машин со статическими адресами DIPS. Кроме того, вы можете захотеть разместить виртуальные машины в подсети отдельно от других экземпляров ролей.
 - **Добавить подсеть шлюза**: подсеть шлюза необходима для VPN-подключения типа "точка — сеть". Нажмите эту кнопку, чтобы добавить ее. Подсеть шлюза используется только для шлюза виртуальной сети.
1. Когда виртуальная сеть будет создана, на классическом портале Azure на странице "Сети" в столбце **Состояние** отобразится значение **Создано**. После создания виртуальной сети можно приступать к созданию шлюза динамической маршрутизации.

### Создание шлюза динамической маршрутизации

Тип шлюза должен быть динамическим. Эта функция не поддерживает шлюзы со статической маршрутизацией.

1. На классическом портале Azure на странице **Сети** щелкните только что созданную виртуальную сеть и откройте страницу **Панель мониторинга**.
1. В нижней части страницы **Панель мониторинга** нажмите кнопку **Создать шлюз**. Появится сообщение **Создать шлюз для виртуальной сети "ваша сеть"?** Нажмите кнопку **Да**, чтобы начать создание шлюза. Создание шлюза может занять около 15 минут.

## Раздел 2. Создание и отправка сертификатов

Сертификаты используются для проверки подлинности VPN-клиентов в VPN-подключениях типа "точка — сеть". Вы можете использовать как сертификаты, созданные корпоративным решением для создания сертификатов, так и самозаверяющие сертификаты. Вы можете отправить на портал Azure до 20 корневых сертификатов.

Сведения о том, как использовать самозаверяющий сертификат, приведены ниже. Процесс использования сертификата, созданного с помощью корпоративного решения, будет отличаться. Кроме того, вам нужно будет сделать следующее.


Шаг 1. Определение или создание корневого сертификата.

Шаг 2. Отправка CER-файла корневого сертификата на портал Azure.

Шаг 3. Создание сертификата клиента.

Шаг 4. Экспорт и установка сертификата клиента.


### Определение или создание корневого сертификата

Если вы не планируете использовать сертификат, созданный с помощью корпоративного решения, вам нужно создать самозаверяющий корневой сертификат. Описанные в этом разделе действия выполняются в ОС Windows 8. Действия в ОС Windows 10 см. в статье [Working with self-signed root certificates for Point-to-Site configurations](vpn-gateway-certificates-point-to-site.md) (Работа с самозаверяющими корневыми сертификатами для конфигураций типа "точка — сайт").

Создать сертификат X.509 можно с помощью средства создания сертификатов (makecert.exe). Чтобы воспользоваться этим средством, скачайте и установите бесплатное приложение [Microsoft Visual Studio Express](https://www.visualstudio.com/products/visual-studio-express-vs.aspx).

2. Откройте папку "Инструменты Visual Studio" и запустите окно командной строки от имени администратора.
3. В следующем примере команда создаст и установит корневой сертификат в хранилище личных сертификатов на компьютере, а также создаст соответствующий *CER-файл*, который вы затем отправите на классический портал Azure.
4. Перейдите в каталог, в котором должен располагаться CER-файл, и выполните указанную ниже команду, где *RootCertificateName* — имя сертификата. Если выполнить команду без изменений, будет создан корневой сертификат и соответствующий файл *RootCertificateName.cer*.

>[AZURE.NOTE]Поскольку был создан корневой сертификат, из которого будут создаваться клиентские сертификаты, вы можете экспортировать этот сертификат вместе с его закрытым ключом и сохранить в безопасном месте, где его можно будет восстановить.

    makecert -sky exchange -r -n "CN=RootCertificateName" -pe -a sha1 -len 2048 -ss My "RootCertificateName.cer"

### Отправка CER-файла корневого сертификата на классический портал Azure

Вам нужно будет отправить на портал Azure соответствующий CER-файл для каждого корневого сертификата. Вы можете отправить до 20 сертификатов.

1. При создании корневого сертификата (на предыдущем этапе) создается также *CER*-файл. Теперь его необходимо отправить на классический портал Azure. Обратите внимание на то, что CER-файл не содержит закрытый ключ корневого сертификата. Вы можете отправить до 20 корневых сертификатов.
1. На классическом портале Azure на странице **Сертификаты** вашей виртуальной сети щелкните **Загрузить корневой сертификат**.
1. На странице **Загрузка сертификата** найдите CER-файл корневого сертификата и установите флажок.

### Создание сертификата клиента

Описанные ниже шаги помогут вам создать сертификат клиента из корневого самозаверяющего сертификата. Описанные в этом разделе действия выполняются в ОС Windows 8. Действия в ОС Windows 10 см. в статье [Working with self-signed root certificates for Point-to-Site configurations](vpn-gateway-certificates-point-to-site.md) (Работа с самозаверяющими корневыми сертификатами для конфигураций типа "точка — сайт"). Если вы используете сертификат, созданный с помощью корпоративного решения, придерживайтесь следующих правил.

1. На компьютере, на котором вы создали самозаверяющий корневой сертификат, откройте окно командной строки Visual Studio от имени администратора.
2. Смените каталог, выбрав папку, в которую хотите сохранить файл сертификата клиента. Имя *RootCertificateName* обозначает созданный вами самозаверяющий корневой сертификат. Если выполнить приведенную ниже команду (заменив строку RootCertificateName именем вашего корневого сертификата), в ваше хранилище личных сертификатов будет добавлен сертификат клиента ClientCertificateName.
3. Введите следующую команду:

    	makecert.exe -n "CN=ClientCertificateName" -pe -sky exchange -m 96 -ss My -in "RootCertificateName" -is my -a sha1

4. Все сертификаты находятся в хранилище личных сертификатов на вашем компьютере. Выполните команду *certmgr*, чтобы проверить результат. С помощью этой процедуры можно создать любое количество сертификатов. Рекомендуем создавать уникальные сертификаты клиентов для всех компьютеров, которые будут подключаться к виртуальной сети.

### Экспорт и установка сертификата клиента

Установка сертификата клиента на каждый компьютер, который будет подключен к виртуальной сети, является обязательным шагом. Описанные ниже шаги помогут вам установить сертификат клиента вручную.

1. Сертификат клиента необходимо установить на каждый компьютер, который будет подключаться к виртуальной сети. Это означает, что вам, скорее всего, потребуется создать несколько сертификатов, которые затем нужно будет экспортировать. Для экспорта сертификатов клиента используйте команду *certmgr.msc*. Щелкните правой кнопкой мыши сертификат, который надо экспортировать, выберите элемент **Все задачи** и нажмите кнопку **Экспорт**.
2. Экспортируйте *сертификат клиента* с закрытым ключом. Он сохраняется в *PFX*-файле. Обязательно запишите или запомните пароль (ключ), который задали для этого сертификата.
3. Скопируйте *PFX*-файл на клиентский компьютер. На клиентском компьютере дважды щелкните *PFX*-файл, чтобы установить его. В окне запроса введите пароль. Не меняйте место установки.

## Раздел 3. Настройка VPN-клиента

Для подключения к виртуальной сети также потребуется настроить VPN-клиент. Для подключения ему необходим как сертификат клиента, так и правильные настройки.

Настройка VPN-клиента включает три этапа.

Шаг 1. Создание пакета конфигурации VPN-клиента.

Шаг 2. Установка пакета конфигурации VPN на клиенте и запуск подключения.

Шаг 3. Проверка подключения.

### Создание пакета конфигурации VPN-клиента

1. На классическом портале Azure на странице **Панель мониторинга** вашей виртуальной сети перейдите в меню сводки в правом углу и щелкните пакет VPN, относящийся к клиенту, который нужно подключить к виртуальной сети.
2. 
Поддерживаются перечисленные ниже операционные системы.
 - Windows 7 (32-разрядная и 64-разрядная версии)
 - Windows Server 2008 R2 (только 64-разрядная версия)
 - Windows 8 (32-разрядная и 64-разрядная версии)
 - Windows 8.1 (32-разрядная и 64-разрядная версии)
 - Windows Server 2012 (только 64-разрядная версия)
 - Windows Server 2012 R2 (только 64-разрядная версия)
 - Windows 10

1. Выберите пакет загрузки для операционной системы, в которой требуется установить клиент.
 - Для 32-разрядных клиентов выбирайте вариант **Загрузить пакет VPN-клиента (32-разрядная версия)**.
 - Для 64-разрядных клиентов выбирайте вариант **Загрузить пакет VPN-клиента (64-разрядная версия)**.
1. Создание пакета занимает несколько минут. После завершения этой процедуры вы сможете скачать файл. Загруженный *EXE*-файл можно сохранить на локальном компьютере.
1. Создав и скачав пакет VPN-клиента с классического портала Azure, вы можете установить его на клиентском компьютере, с которого планируете подключаться к виртуальной сети. Если вы планируете установить пакет VPN-клиента на нескольких клиентских компьютерах, убедитесь, что на каждом из них также установлен сертификат клиента. Пакет VPN-клиента содержит данные конфигурации для настройки программного обеспечения VPN-клиента, встроенного в Windows. Пакет не устанавливает никакого дополнительного программного обеспечения.

### Установка пакета конфигурации VPN на клиенте и запуск подключения

1. Скопируйте файл конфигурации на локальный компьютер, который хотите подключить к виртуальной сети, и дважды щелкните EXE-файл. После установки пакета можно запускать VPN-подключение.
Обратите внимание на то, что пакет конфигурации не подписан компанией Майкрософт. Вы можете подписать его с помощью корпоративной службы подписей или самостоятельно с помощью средства [SignTool](http://go.microsoft.com/fwlink/p/?LinkId=699327). Пакет можно использовать и без подписи. Однако если он не подписан, при его установке появится предупреждение.
2. На клиентском компьютере откройте VPN-подключения и найдите только что созданное. Его имя совпадает с названием вашей виртуальной сети. Щелкните **Подключить**.
3. Появится всплывающее сообщение, с помощью которого создается самозаверяющий сертификат для конечной точки шлюза. Нажмите кнопку **Продолжить**, чтобы использовать повышенные привилегии.
4. На странице состояния **Подключение** щелкните **Подключить**.
5. Если появится окно **Выбор сертификата**, убедитесь в том, что отображается сертификат клиента, с помощью которого вы хотите подключиться к сети. Если окно не появится, выберите нужный сертификат в раскрывающемся списке и нажмите кнопку **ОК**.
6. Теперь вы подключены к своей виртуальной сети и имеете полный доступ ко всем службам и виртуальным машинам, которые в ней расположены.

### Проверка VPN-подключения

1. Чтобы проверить, активно ли VPN-подключение, откройте окно командной строки от имени администратора и выполните команду *ipconfig/all*.
2. Просмотрите результаты. Обратите внимание, что полученный вами IP-адрес — это один из адресов в адресном пространстве подключения типа "точка — сеть", которое вы указали при создании виртуальной сети. Результаты должны выглядеть примерно так:

Пример:



    PPP adapter VNetEast:
		Connection-specific DNS Suffix .:
		Description.....................: VNetEast
		Physical Address................:
		DHCP Enabled....................: No
		Autoconfiguration Enabled.......: Yes
		IPv4 Address....................: 192.168.130.2(Preferred)
		Subnet Mask.....................: 255.255.255.255
		Default Gateway.................:
		NetBIOS over Tcpip..............: Enabled

## Дальнейшие действия

В виртуальную сеть можно добавлять виртуальные машины. См. статью [Создание настраиваемой виртуальной машины](../virtual-machines/virtual-machines-create-custom.md).

Дополнительные сведения о виртуальных сетях см. на странице [документации по виртуальным сетям](https://azure.microsoft.com/documentation/services/virtual-network/).

<!---HONumber=AcomDC_0121_2016-->