<properties
   pageTitle="Настройка подключения между виртуальными сетями | Microsoft Azure"
   description="Как подключить виртуальные сети Azure в одной подписке или одном регионе и разных подписках или регионах, используя PowerShell и классический портал Azure. Процедуры в этой статье относятся к виртуальным сетям, созданным с помощью классической модели развертывания."
   services="vpn-gateway"
   documentationCenter="na"
   authors="cherylmc"
   manager="carolz"
   editor=""/>

<tags
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="11/04/2015"
   ms.author="cherylmc"/>


# Настройка подключения между виртуальными сетями на классическом портале Azure

> [AZURE.SELECTOR]
- [Azure Classic Portal](virtual-networks-configure-vnet-to-vnet-connection.md)
- [PowerShell - Azure Resource Manager](vpn-gateway-vnet-vnet-rm-ps.md)


Данная статья поможет вам создать виртуальные сети и подключить их с помощью классической модели развертывания (которую также называют управлением службами). При этом будут использоваться классический портал Azure (не портал Azure) и командлеты PowerShell. Если вы ищете другую модель развертывания для этой конфигурации, воспользуйтесь вкладками вверху страницы для выбора нужной статьи.

**О моделях развертывания Azure**

[AZURE.INCLUDE [vpn-gateway-clasic-rm](../../includes/vpn-gateway-classic-rm-include.md)]
	
Если необходимо, виртуальную сеть, созданную по классической модели развертывания, можно также подключить к виртуальной сети, созданной с помощью модели диспетчера ресурсов. См. статью [Подключение классических виртуальных сетей к новым виртуальным сетям](../virtual-network/virtual-networks-arm-asm-s2s.md).

Подключение одной виртуальной сети к другой очень похоже на подключение виртуальной сети к локальному сайту. В обоих типах подключений используется VPN-шлюз для создания защищенного туннеля, использующего IPsec/IKE. Подключаемые виртуальные сети могут иметь разные подписки в разных регионах. Можно даже комбинировать подключение виртуальных сетей с многосайтовыми конфигурациями. Это позволяет устанавливать топологии сети, совмещающие распределенные подключения с подключениями между виртуальными сетями, как показано на схеме ниже:

![Схема подключения между виртуальными сетями](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727360.png)

## Что может дать связь между виртуальными сетями

Вам может потребоваться подключить виртуальные сети по следующим причинам.

- **Межрегиональная географическая избыточность и географическое присутствие**
	- Вы можете настроить собственную георепликацию или синхронизацию с безопасной связью, без прохождения трафика через конечные точки с выходом в Интернет.
	- С помощью балансировщика нагрузки Azure и технологий кластеризации корпорации Майкрософт или сторонних производителей можно настроить высокодоступную рабочую нагрузку с геоизбыточностью в нескольких регионах Azure. Одним из важных примеров является настройка SQL Always On с группами доступности, распределенными по нескольким регионам Azure.

- **Региональные многоуровневые приложения с четкой границей изоляции**
	- В одном регионе можно настроить многоуровневые приложения с использованием нескольких связанных друг с другом виртуальных сетей с сильной изоляцией и защищенной связью между уровнями.

- **Обмен данными между подписками и организациями в Azure**
	- Если у вас есть несколько подписок Azure, вы можете безопасно связывать рабочие нагрузки из разных подписок между виртуальными сетями.
	- Благодаря технологии защищенных сетей VPN в Azure для предприятий или поставщиков услуг возможен обмен данными между организациями.

## Часто задаваемые вопросы о подключениях VNet-VNet

- Виртуальные сети могут быть в одной или разных подписках.

- Виртуальные сети могут быть в одном или разных регионах (расположениях) Azure.

- Облачная служба или конечная точка с балансировкой нагрузки НЕ МОЖЕТ распространяться на виртуальные сети, даже если они соединены друг с другом.

- Для подключения нескольких виртуальных сетей друг к другу не требуются локальные VPN-шлюзы, если только не требуется распределенное подключение.

- Подключения между виртуальными сетями поддерживает подключение виртуальных сетей Azure. Не поддерживается подключение виртуальных машин или облачных служб, размещенных НЕ в виртуальной сети.

- Для подключения виртуальной сети к виртуальной сети требуются VPN-шлюзы Azure с сетями VPN динамической маршрутизации. VPN-шлюзы Azure со статической маршрутизацией не поддерживаются.

- Подключение к виртуальной сети может использоваться одновременно с многосайтовыми сетями VPN, использующими до 10 туннелей VPN для подключения VPN-шлюза виртуальной сети к другим виртуальным сетям или локальным сайтам.

- Адресные пространства виртуальных сетей и местных сайтов локальных сетей не должны перекрываться. Перекрытие адресных пространств приведет к сбою при создании виртуальных сетей или отправке файлов конфигурации netcfg.

- Избыточные туннели между парой виртуальных сетей не поддерживаются.

- Все туннели VPN виртуальной сети, включая VPN типа «точка-сеть», совместно используют доступную пропускную способность шлюза VPN Azure и одно соглашение об уровне обслуживания шлюзов VPN в Azure.

- Трафик между виртуальными сетями проходит через магистральную сеть Azure.

## Настройка подключения между виртуальными сетями

В этой процедуре мы рассмотрим соединение двух виртуальных сетей, VNet1 и VNet2. Необходим удобный способ настройки сетей, чтобы подставить диапазоны IP-адресов, которые соответствуют вашим требованиям по проектированию сети. Подключение из виртуальной сети Azure к другой виртуальной сети Azure осуществляется точно так же, как подключения к локальной сети через VPN типа "сеть — сеть" (S2S).

В этой процедуре главным образом используется классический портал Azure, тем не менее для подключения VPN-шлюзов необходимо использовать командлеты Microsoft Azure PowerShell.

![Подключение между виртуальными сетями](./media/virtual-networks-configure-vnet-to-vnet-connection/IC727361.png)

Существуют 5 разделов для планирования и настройки. Настройте каждый раздел в указанном ниже порядке:

1. [Планирование диапазонов IP-адресов](#plan-your-ip-address-ranges)
2. [Создание своих виртуальных сетей](#create-your-virtual-networks)
3. [Добавление локальных сетей](#add-local-networks)
4. [Создание шлюзов с динамической маршрутизацией для каждой виртуальной сети](#create-the-dynamic-routing-gateways-for-each-vnet)
5. [Подключите шлюзы VPN.](#connect-the-vpn-gateways)


## Планирование диапазонов IP-адресов

Важно выбрать диапазоны, которые вы будете использовать, чтобы настроить файл конфигурации сети (netcfg). С точки зрения сети VNet1 сеть VNet2 представляет собой просто другое VPN-подключение, определенное на платформе Azure. И из сети VNet2 сеть VNet1 является просто еще одним VPN-подключением. Они обе будут идентифицировать друг друга как сайт локальной сети. Имейте в виду, необходимо убедиться в том, что ни один из диапазонов виртуальных сетей или диапазонов локальных сетей никак не перекрываются.

В таблице 1 показан пример определения виртуальных сетей. Используйте указанные диапазоны только в качестве примера. Запишите диапазоны, что вы будете использовать для своих виртуальных сетей. Эти сведения будут необходимы для выполнения последующих действий.

**Таблица 1**

|Виртуальная сеть |Определение сайта виртуальной сети |Определение сайта локальной сети|
|:----------------|:-------------------------------|:----------------------------|
|VNet1 |VNet1 (10.1.0.0/16) |VNet2 (10.2.0.0/16) |
|VNet2 |VNet2 (10.2.0.0/16) |VNet1 (10.1.0.0/16) |

## Создание своих виртуальных сетей

В целях этого учебника мы создадим две виртуальные сети, VNet1 и VNet2. Подставьте собственные значения при создании виртуальных сетей. В целях этого учебника мы будем использовать следующие значения для виртуальных сетей:

VNet1: адресное пространство — 10.1.0.0/16; регион — западная часть США.

VNet2: адресное пространство — 10.2.0.0/16; регион — Япония, восток.

1. Войдите на **классический портал Azure** (не на портал Azure).

2. В нижнем левом углу экрана нажмите кнопку **Создать**. В области навигации щелкните **Сети**, а затем — **Виртуальная сеть**. Нажмите кнопку **Настраиваемое создание** для запуска мастера настройки.

На странице **Сведения о виртуальной сети** укажите следующую информацию.

  ![Информация о виртуальной сети](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736055.png)

  - **Имя** — имя виртуальной сети. Например, VNet1.
  - **Расположение** — при создании виртуальную сеть можно связать с расположением Azure (регионом). Например, если вы хотите, чтобы ваши виртуальные машины разворачивались в виртуальной сети, которая физически расположена в западной части США, выберите это расположение. Нельзя изменить расположение, связанное с виртуальной сетью, после ее создания.



На странице **DNS-серверы и подключение VPN** укажите следующие сведения и щелкните стрелку «Далее» в правом нижнем углу.

  ![DNS-серверы и подключение VPN](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736056.jpg)


- **DNS-серверы**: введите имя и IP-адрес DNS-сервера или выберите ранее зарегистрированный DNS-сервер из раскрывающегося списка. Этот параметр не создает DNS-сервер, он позволяет указать DNS-серверы, которые вы хотите использовать для разрешения имен в этой виртуальной сети. Если вы хотите обеспечить разрешение имен между своими виртуальными сетями, потребуется настроить DNS-сервер, а не использовать службу разрешения имен, предоставленную Azure.

  - Не устанавливайте ни один из флажков. Просто щелкните стрелку в правом нижнем углу, чтобы перейти к следующему экрану.

На странице **Адресное пространство виртуальной сети** укажите диапазон адресов, который вы хотите использовать для виртуальной сети. Это динамические IP-адреса (DIP), которые будут назначаться виртуальным машинам и другим экземплярам ролей, развертываемым в этой виртуальной сети. Особенно важно выбрать диапазон, который не пересекается с другими диапазонами, используемыми в локальной сети. Необходимо согласование с сетевым администратором, которому может потребоваться выделить диапазон IP-адресов из адресного пространства локальной сети, чтобы использовать его для виртуальной сети.


  ![Страница «Адресное пространство виртуальной сети»](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736057.jpg)

  **Введите следующую информацию** и затем установите флажок в нижнем правом углу, чтобы настроить сеть.

  - **Адресное пространство** — включает в себя начальный IP-адрес и число адресов. Убедитесь, что заданные адресные пространства не перекрываются ни с одним из адресных пространств, которые используются в локальной сети. В этом примере мы будем использовать 10.1.0.0/16 для VNet1.
  - **Добавить подсеть** — включает в себя начальный IP-адрес и число адресов. Дополнительные подсети не обязательны, но вам может понадобиться создать отдельную подсеть для виртуальных машин со статическими адресами DIPS. Или может потребоваться разместить виртуальные машины в подсети отдельно от других экземпляров ролей.

**Установите флажок** в правом нижнем углу страницы, после чего начнется создание виртуальной сети. По завершении на классическом портале Azure на странице *Сети* в разделе *Состояние* появится значение *Создано*.

## Создание еще одной виртуальной сети

Далее повторите предыдущие шаги, чтобы создать еще одну виртуальную сеть. В этом примере вы позже подключите эти две виртуальные сети. Обратите внимание, что очень важно, чтобы адресные пространства не повторялись и не перекрывали друг друга. В целях этого учебника используйте следующие значения:

- **VNet2**
- **Адресное пространство**: 10.2.0.0/16.
- **Регион**: Восточная Япония.

## Добавление локальных сетей

При создании конфигурации между двумя виртуальными сетями необходимо настроить каждую из сетей так, чтобы они идентифицировали друг друга в качестве сайта локальной сети. В этой процедуре вы настроите каждую виртуальную сеть в качестве локальной. Если вы уже настроили виртуальные сети, вот как их можно добавить в качестве локальных сетей на классическом портале Azure.

1. В нижнем левом углу экрана нажмите кнопку **Создать**. В области навигации щелкните **Сети**, а затем — **Виртуальная сеть**. Щелкните **Добавить локальную сеть**.

2. На странице **Укажите сведения о локальной сети** в поле **Имя** введите имя виртуальной сети, которая будет использоваться в конфигурации подключения между виртуальными сетями. В этом примере мы будем использовать сеть VNet1, так как мы укажем сети VNet2 на эту виртуальную сеть для нашей конфигурации.

  В качества IP-адреса VPN-устройства используйте любой IP-адрес. Как правило, для VPN-устройства используется фактический внешний IP-адрес. Для конфигураций подключений между виртуальными сетями вы воспользуетесь IP-адресом шлюза. Но, учитывая, что шлюз еще не создан, мы используем IP-адрес, который можно указать в качестве заполнителя. Позднее вы вернетесь к этим параметрам и введете соответствующий IP-адрес шлюза, после того, как Azure создаст его.

3. На странице **Укажите адрес** вы введете фактический диапазон IP-адресов и количество адресов для VNet1. Он должен точно соответствовать диапазону, который был ранее указан для VNet1.

4. После настройки VNet1 как локальной сети вернитесь к настройке VNet2. Используйте значения, соответствующие этой виртуальной сети.

5. Теперь вы укажете каждой виртуальной сети друг на друга как на локальную сеть. На классическом портале Azure перейдите на страницу **Настройка** сети VNet1. В разделе **Подключение типа «сеть-сеть»** выберите ** Подключиться к локальной сети**, а затем в качестве локальной сети выберите **VNET2**.

  ![Подключение к локальной сети](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736058.jpg)

6. В разделе **Адресное пространство виртуальной сети** на этой же странице щелкните **Добавить подсеть шлюза** и щелкните значок **Сохранить** в нижней части страницы, чтобы сохранить конфигурацию.

7. Повторите этот шаг для сети VNet2, чтобы указать VNet1 как локальную сеть.

## Создание шлюзов с динамической маршрутизацией для каждой виртуальной сети

Теперь, когда вы настроили все каждую виртуальную сеть, вы настроите шлюзы виртуальной сети.

1. На странице **Сети** убедитесь, что в столбце состояния виртуальной сети отображается значение **Создана**.

2. В столбце **Имя** щелкните имя виртуальной сети.

3. На странице **Панель мониторинга** обратите внимание, что для этой виртуальной сети шлюз еще не настроен. Вы увидите, как состояние будет изменяться в процессе настройки шлюза.

4. Щелкните **Создать шлюз** в нижней части страницы.

  Необходимо выбрать параметр **Динамическая маршрутизация**. Когда система запрашивает подтверждение создания шлюза, нажмите кнопку «Да».

  ![Тип шлюза](./media/virtual-networks-configure-vnet-to-vnet-connection/IC717026.png)

5. Обратите внимание, что во время создания шлюза его графическое представление на странице меняет цвет на желтый и содержит надпись «Создание шлюза». Обычно создание шлюза занимает около 15 минут.

6. Повторите те же действия для другой сети, обязательно выбрав параметр **Динамический шлюз**. Вам не обязательно завершать настройку шлюза первой виртуальной сети до начала создания шлюза для второй виртуальной сети.

7. Когда состояние шлюза изменится на "Подключение", IP-адрес для каждого шлюза будет отображаться на панели мониторинга. Запишите IP-адрес, соответствующий каждой виртуальной сети, стараясь не перепутать их. Это IP-адреса, которые будут использоваться при редактировании заполнителей IP-адресов для VPN-устройства в разделе **Локальные сети**.

## Изменение локальной сети

1. На странице **Локальные сети** щелкните имя локальной сети, которую требуется изменить, а затем щелкните **Изменить** в нижней части страницы. В поле **IP-адрес VPN-устройства** введите IP-адрес шлюза, который соответствует сети. Например, для VNet1 введите IP-адрес шлюза, назначенный VNet1. Щелкните стрелку в нижней части страницы.

2. На странице **Указать адресное пространство** установите флажок в нижнем правом углу без внесения изменений.

## Подключение шлюзов VPN

После завершения всех предыдущих шагов вы зададите общие ключи IPsec/IKE, которые должны совпадать. Это можно сделать с помощью REST API или командлета PowerShell. Если вы используете PowerShell, убедитесь, что у вас установлена последняя версия командлетов Microsoft Azure PowerShell. В приведенных ниже примерах командлеты PowerShell используются для задания значения ключа A1b2C3D4. Обратите внимание, что в обоих случаях используется одно и то же значение ключа. Измените представленные ниже примеры, введя свои собственные значения.

Для VNet1

	PS C:\> Set-AzureVNetGatewayKey -VNetName VNet1 -LocalNetworkSiteName VNet2 -SharedKey A1b2C3D4

Для VNet2

	PS C:\> Set-AzureVNetGatewayKey -VNetName VNet2 -LocalNetworkSiteName VNet1 -SharedKey A1b2C3D4

Ожидание подключений для инициализации. Как только шлюз будет инициализирован, он станет выглядеть как на изображении ниже, и ваши виртуальные сети будут подключены.

![Состояние шлюза — «Подключен»](./media/virtual-networks-configure-vnet-to-vnet-connection/IC736059.jpg)

[AZURE.INCLUDE [vpn-gateway-no-nsg-include](../../includes/vpn-gateway-no-nsg-include.md)]

## Дальнейшие действия

Установив подключение, можно добавить виртуальные машины в виртуальные сети. Инструкции см. в статье [Создание виртуальной машины под управлением Windows на портале Azure](../virtual-machines/virtual-machines-windows-tutorial-classic-portal.md).


[1]: ../hdinsight-hbase-geo-replication-configure-vnets.md
[2]: http://channel9.msdn.com/Series/Getting-started-with-Windows-Azure-HDInsight-Service/Configure-the-VPN-connectivity-between-two-Azure-virtual-networks
 

<!---HONumber=AcomDC_1217_2015-->