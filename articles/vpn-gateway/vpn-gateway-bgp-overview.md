<properties
   pageTitle="Особенности использования BGP с VPN-шлюзами Azure | Microsoft Azure"
   description="В статье описывается использование BGP с VPN-шлюзами Azure."
   services="vpn-gateway"
   documentationCenter="na"
   authors="yushwang"
   manager="rossort"
   editor=""
   tags=""/>

<tags
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="get-started-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="04/26/2016"
   ms.author="yushwang"/>

# Обзор использования BGP с VPN-шлюзами Azure

В этой статье описываются особенности использования протокола BGP для VPN-шлюзов Azure.

## О протоколе BGP

Стандартный протокол маршрутизации BGP обычно используется в Интернете для обмена данными о маршрутизации и доступности между двумя или несколькими сетями. В контексте виртуальных сетей Azure протокол BGP используется VPN-шлюзами Azure и локальными VPN-устройствами (так называемые узлы BGP) для обмена данными о маршрутах. Это позволяет информировать участников обмена о доступности и возможности передавать префиксы через шлюзы или маршрутизаторы. Также BGP позволяет передавать трафик транзитом через несколько сетей. Для этого шлюз BGP распространяет на все известные ему узлы BGP информацию о маршрутах, полученную от остальных узлов BGP.
 
### Почему именно BGP?

BGP не является обязательным протоколом для VPN-шлюзов Azure с использованием маршрутов. Также до включения протокола BGP следует убедиться, что ваши локальные VPN-устройства поддерживают его. Вы можете продолжать использовать VPN-шлюзы Azure и локальные VPN-устройства без протокола BGP. Для обмена данными между сетями и Azure можно использовать статические маршруты (без BGP) *или* динамическую маршрутизацию по протоколу BGP.

Преимущества и возможности протокола BGP:

#### Поддержка автоматического и гибкого обновления префиксов

Если используется протокол BGP, достаточно объявить минимальный префикс для определенного узла BGP через VPN-туннель IPsec S2S. Это может быть даже небольшой префикс узла (/32) для IP-адреса узла BGP на локальном VPN-устройстве. Вы можете выбирать, какие из локальных префиксов будут объявлены в Azure, чтобы виртуальная сеть Azure получила к ним доступ.
	
Также можно объявлять более крупные префиксы, в том числе некоторые префиксы адресов виртуальной сети, например маршрут по умолчанию (0.0.0.0/0) или все частное пространство IP-адресов (10.0.0.0/8 и т.п.). Обратите внимание, что эти префиксы не должны совпадать с префиксами виртуальной сети. Маршруты, идентичные префиксам виртуальной сети, будут отклонены.

#### Поддержка нескольких туннелей между виртуальной сетью и локальным сайтом с автоматической отработкой отказа на основе BGP

Вы можете создавать несколько подключений между виртуальной сетью Azure и локальными VPN-устройствами в одном расположении. Это позволяет использовать между двумя сетями несколько туннелей (путей) в режиме "активный — активный". Если один из туннелей отключится, BGP отзовет соответствующие маршруты и трафик автоматически переместится в действующие туннели.
	
Следующая схема содержит простой пример настройки с высокой доступностью.
	
![Несколько активных путей](./media/vpn-gateway-bgp-overview/multiple-active-tunnels.png)

#### Поддержка транзитной маршрутизации между локальными сетями и несколькими виртуальными сетями Azure

BGP позволяет нескольким шлюзам получать и распространять префиксы из разных сетей, подключенных к ним напрямую или опосредованно. Благодаря этому возможна транзитная маршрутизация через VPN-шлюзы Azure между локальными сайтами или несколькими виртуальными сетями Azure.
	
Следующая схема содержит пример многоскачковой топологии с несколькими путями, по которым трафик может проходить между двумя локальными сетями через VPN-шлюзы Azure в сети Microsoft.

![Многоскачковый транзит](./media/vpn-gateway-bgp-overview/full-mesh-transit.png)

## Часто задаваемые вопросы о протоколе BGP

#### VPN-шлюзы Azure поддерживают BGP для всех классов SKU?

Нет, Azure поддерживает BGP только для VPN-шлюзов класса **Standard** и **HighPerformance**. SKU класса **Basic** не поддерживается.

#### Можно ли использовать BGP с VPN-шлюзами Azure с управлением на основе политик?

Нет, BGP поддерживают только VPN-шлюзы с управлением на основе маршрута.

#### Можно ли использовать частные номера автономной системы (ASN)?

Да, вы можете использовать собственные общедоступные или частные ASN как для локальных сетей, так и для виртуальных сетей Azure.

#### Можно ли использовать один номер ASN одновременно для локальных VPN-сетей и виртуальных сетей Azure?

Нет, следует назначить различные ASN для локальных сетей и виртуальных сетей Azure, если они обмениваются данными с использованием BGP. VPN-шлюзы Azure по умолчанию получают значение ASN 65515, независимо от использования BGP для подключений между локальными сетями. Вы можете переопределить это значение по умолчанию, назначив другой номер ASN при создании VPN-шлюза или изменив его после создания шлюза. Номер ASN, который используется для локальной сети, нужно будет назначить соответствующему локальному сетевому шлюзу Azure.



#### Какие префиксы адресов будут объявлять для меня VPN-шлюзы Azure?

VPN-шлюз Azure объявляет следующие маршруты для локальных устройств BGP:

- префиксы адресов вашей виртуальной сети;
- префиксы адресов от каждого из локальных сетевых шлюзов, подключенных к VPN-шлюзу Azure;
- маршруты, полученные от сеансов пиринга BGP с другими устройствами, подключенными к VPN-шлюзу Azure, **за исключением маршрутов по умолчанию и маршрутов, пересекающихся с префиксами любой виртуальной сети**.

#### Можно ли использовать BGP для подключений между виртуальными сетями?

Да, вы можете использовать BGP и для подключений между организациями, и для подключений между виртуальными сетями.

#### Можно ли сочетать подключения с BGP и подключения без BGP на VPN-шлюзах Azure?

Да, вы можете использовать подключения с BGP и без BGP на одном VPN-шлюзе Azure.

#### Поддерживает ли VPN-шлюз Azure транзитную маршрутизацию BGP?

Да, транзитная маршрутизация BGP поддерживается, но с одним исключением: VPN-шлюзы Azure **не будут** объявлять маршруты по умолчанию для других узлов BGP. Чтобы включить транзитную маршрутизацию между несколькими VPN-шлюзами Azure, необходимо включить BGP на всех промежуточных подключениях между виртуальными сетями.

#### Можно ли создать несколько туннелей между VPN-шлюзом Azure и локальной сетью?

Да, вы можете создать несколько VPN-туннелей S2S между VPN-шлюзом Azure и локальной сетью. Но обратите внимание, что все такие туннели будут учитываться в общем количестве туннелей на ваших шлюзах Azure VPN. Например, если вы настроите для избыточности два туннеля между VPN-шлюзом Azure и одной из локальных сетей, они будут учтены как два туннеля в общей квоте для VPN-шлюза Azure (10 для уровня Standard или 30 для уровня HighPerformance).

#### Можно ли создать несколько туннелей между двумя виртуальными сетями Azure с использованием BGP?

Нет, избыточные туннели между парой виртуальных сетей не поддерживаются.

#### Какой адрес VPN-шлюз Azure использует в качестве IP-адреса узла BGP?

VPN-шлюз Azure выделит один IP-адрес из диапазона подсети шлюза (GatewaySubnet), определенного для виртуальной сети. По умолчанию это предпоследний адрес диапазона. Например, если ваш GatewaySubnet имеет значение 10.12.255.0.0/27, то есть сеть использует диапазон адресов от 10.42.255.0.0 до 10.42.255.31, VPN-шлюз Azure назначит узлу BGP IP-адрес 10.12.255.30. Эту информацию можно найти при выводе сведений о VPN-шлюзе Azure.

#### Каковы требования к адресам узла BGP на VPN-устройстве?

Локальный узел BGP **НЕ МОЖЕТ** иметь тот же IP-адрес, который используется как общедоступный IP-адрес VPN-устройства. Используйте в качестве IP-адреса узла BGP другой IP-адрес VPN-устройства. Можно использовать адрес интерфейса замыкания на себя. Укажите этот адрес на локальном сетевом шлюзе, который представляет это расположение.

#### Что нужно указать в качестве префикса адреса локального сетевого шлюза, если используется BGP?

Исходные префиксы адресов для локальной сети определяет локальный сетевой шлюз Azure. При использовании BGP в качестве адресного пространства локальной сети следует назначить префикс узла (префикс /32), который определен как IP-адрес узла BGP. Например, если для узла BGP установлен IP-адрес 10.52.255.254, следует указать значение 10.52.255.254/32 для параметра localNetworkAddressSpace на локальном сетевом шлюзе, который представляет эту локальную сеть. Благодаря этому VPN-шлюз Azure сможет установить сеанс BGP через VPN-туннель S2S.

#### Что следует добавить в настройки локального VPN-устройства для сеансов пиринга BGP?

Вам нужно добавить узловой маршрут для IP-адреса узла BGP Azure на VPN-устройство, которое указывает на VPN-туннель IPsec S2S. Например если IP-адрес VPN-узла Azure имеет значение 10.12.255.30, следует добавить для адреса 10.12.255.30 узловой маршрут, в котором интерфейсом следующего прыжка будет соответствующий интерфейс туннелирования IPsec на VPN-устройстве.

## Дальнейшие действия

Действия по настройке BGP для межсистемных подключений и подключений между виртуальными сетями описаны в разделе [Getting started with BGP on Azure VPN gateways](./vpn-gateway-bgp-resource-manager-ps.md) (Приступая к работе с BGP на VPN-шлюзах Azure).

<!---HONumber=AcomDC_0427_2016-->