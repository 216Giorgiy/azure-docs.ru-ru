<properties 
   pageTitle="Создание самозаверяющих сертификатов для распределенных подключений виртуальных сетей типа ";точка — сеть"; с помощью makecert | Microsoft Azure"
   description="Эта статья содержит инструкции по использованию makecert для создания самозаверяющих сертификатов в Windows 10."
   services="vpn-gateway"
   documentationCenter="na"
   authors="cherylmc"
   manager="carmonm"
   editor=""
   tags="azure-resource-manager"/>
<tags 
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="08/15/2016"
   ms.author="cherylmc" />

# Работа с самозаверяющими сертификатами для подключений типа "точка — сеть"

Эта статья поможет создать самозаверяющий сертификат с помощью makecert, а затем на его основе создать клиентские сертификаты. Все инструкции приведены для использования makeсert в Windows 10. Было проверено создание сертификатов, которые совместимы с подключениями типа "точка — сеть", с помощью makeсert.

Для подключений типа "точка — сеть" предпочтительно использовать свое корпоративное решение для сертификатов, убедившись, что клиентам выдаются сертификаты с общим именем в формате "имя@ваш\_домен.com", а не в формате "доменное\_имя\_NetBIOS\\имя\_пользователя".

Если у вас нет корпоративного решения, то чтобы разрешить клиентам P2S подключаться к виртуальной сети, потребуется самозаверяющий сертификат. Нам известно, что инструмент makecert является нерекомендуемым, но его по-прежнему можно использовать для создания самозаверяющих сертификатов, совместимых с подключениями типа "точка — сеть".

## Создание самозаверяющего сертификата

Использование makecert — один из способов создания самозаверяющего сертификата. Ниже приведены инструкции по созданию самозаверяющего сертификата с помощью makeсert. Они не зависят от модели развертывания. Они подходят как для модели с использованием диспетчера ресурсов, так и для классической модели.

### Создание самозаверяющего сертификата

1. На компьютере под управлением Windows 10 скачайте и установите [пакет средств разработки программного обеспечения (SDK) для Windows для Windows 10](https://dev.windows.com/ru-RU/downloads/windows-10-sdk).

2. После установки служебную программу makecert.exe можно найти по такому пути: C:\\Program Files (x86)\\Windows Kits\\10\\bin<arch>.
		
	Пример:
	
		C:\Program Files (x86)\Windows Kits\10\bin\x64\makecert.exe

3. Затем создайте и установите сертификат в личном хранилище сертификатов на компьютере. В следующем примере создается соответствующий *CER-файл*, передаваемый в Azure при настройке подключений типа "точка — сеть". Выполните приведенную ниже команду как администратор, где *CertificateName* — имя, которое вы хотите использовать для сертификата.<br><br>Если выполнить приведенный пример без изменений, то результатом будут сертификат и соответствующий файл *CertificateName.cer*. CER-файл можно найти в каталоге, из которого была выполнена команда. Сертификат будет расположен в хранилище сертификатов: Текущий пользователь\\Personal\\Certificates.

    	makecert -sky exchange -r -n "CN=CertificateName" -pe -a sha1 -len 2048 -ss My "CertificateName.cer"

4. Самозаверяющий сертификат используется для создания сертификатов клиента. Когда вы передаете CER-файл самозаверяющего сертификата в процессе настройки P2S, вы указываете Azure доверять сертификатам клиента, которые используют клиентские компьютеры.<br><br>Любой компьютер, на котором установлен сертификат клиента и настроены соответствующие параметры клиента VPN, может подключиться к виртуальной сети через подключение типа "точка — сеть". По этой причине необходимо, чтобы клиентские сертификаты создавались и устанавливались только тогда, когда требуется, и чтобы этот самозаверяющий сертификат был заархивирован и сохранен в надежном месте. При необходимости позднее можно будет установить этот самозаверяющий сертификат на другом компьютере и создать дополнительные сертификаты клиента или экспортировать CER-файл.
 

## Создание и установка сертификатов клиента

Самозаверяющий сертификат не следует устанавливать на клиентах. Нужно создать сертификат клиента из самозаверяющего сертификата. Затем его следует экспортировать и установить на клиентском компьютере. Приведенные ниже инструкции не зависят от модели развертывания. Они подходят как для модели с использованием диспетчера ресурсов, так и для классической модели.

### Часть 1. Создание сертификата клиента из самозаверяющего сертификата

Ниже описан один из способов создания сертификата клиента из самозаверяющего сертификата. Из одного сертификата можно создать несколько сертификатов клиента. Затем каждый сертификат клиента можно экспортировать и установить на клиентском компьютере.

1. На компьютере, на котором вы создали самозаверяющий сертификат, откройте командную строку от имени администратора.

2. Смените каталог, выбрав папку, в которую хотите сохранить файл сертификата клиента. *CertificateName* указывает созданный вами самозаверяющий сертификат. Если выполнить приведенную ниже команду (заменив строку CertificateName именем вашего сертификата), в ваше хранилище личных сертификатов будет добавлен сертификат клиента ClientCertificateName.

3. Введите следующую команду:

    	makecert.exe -n "CN=ClientCertificateName" -pe -sky exchange -m 96 -ss My -in "CertificateName" -is my -a sha1

4. Все сертификаты находятся в хранилище сертификатов на вашем компьютере в папке Текущий пользователь\\Personal\\Certificates. С помощью этой процедуры можно создать любое количество сертификатов.

### Часть 2. Экспорт сертификата клиента

1. Для экспорта сертификата клиента запустите **certmgr.msc**. Щелкните правой кнопкой мыши сертификат, который надо экспортировать, выберите элемент **Все задачи** и нажмите кнопку **Экспорт**. Откроется **мастера экспорта сертификатов**.

2. В мастере экспорта сертификатов нажмите кнопку **Далее**, выберите **Да, экспортировать закрытый ключ** и снова нажмите кнопку **Далее**.

3. На странице **Формат экспортируемого файла** оставьте настройки по умолчанию. Нажмите кнопку **Далее**.
 
4. На странице **Безопасность** следует защитить закрытый ключ. Если вы решите использовать пароль, обязательно запишите или запомните пароль, заданный для этого сертификата. Нажмите кнопку **Далее**.

5. На странице **Файл для экспорта** нажмите кнопку **Обзор**, чтобы перейти в расположение, куда нужно экспортировать сертификат. В поле **Имя файла** введите имя для файла сертификата. Нажмите кнопку **Далее**.

6. Нажмите кнопку **Готово**, чтобы экспортировать сертификат.

### Часть 3. Установка сертификата клиента

Каждый клиент, который вы хотите подключить к виртуальной сети с использованием подключения типа "точка-сеть", должен иметь установленный сертификат клиента. Этот сертификат является дополнением к обязательному пакету конфигурации VPN. Описанные ниже шаги помогут вам установить сертификат клиента вручную.

1. Найдите *PFX*-файл и скопируйте его на клиентский компьютер. На клиентском компьютере дважды щелкните *PFX*-файл, чтобы установить его. Для параметра **Расположение хранилища** оставьте значение **Текущий пользователь**, а затем нажмите кнопку **Далее**.

2. На странице **Файл для импорта** не вносите никаких изменений. Нажмите кнопку **Далее**.

3. На странице **Защита с помощью закрытого ключа** введите пароль для сертификата (если он используется) или проверьте, правильно ли выбран субъект безопасности, который устанавливает сертификат. Затем нажмите кнопку **Далее**.

4. На странице **Хранилище сертификатов** оставьте расположение по умолчанию и нажмите кнопку **Далее**.

5. Нажмите кнопку **Готово** На странице **Предупреждение системы безопасности** для установки сертификата щелкните **Да**. Сертификат успешно импортирован.

## Дальнейшие действия

Продолжайте настраивать параметры конфигурации типа "точка-сеть".

- Действия для модели развертывания с помощью **Resource Manager** см. в статье [Настройка подключения типа "точка–сеть" к виртуальной сети с помощью PowerShell](vpn-gateway-howto-point-to-site-rm-ps.md).
- Действия для **классической** модели развертывания см. в статье [Настройка VPN-подключения типа "точка–сеть" к виртуальной сети](vpn-gateway-point-to-site-create.md).

<!---HONumber=AcomDC_0824_2016-->