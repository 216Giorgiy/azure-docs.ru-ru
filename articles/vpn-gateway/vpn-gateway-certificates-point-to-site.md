---
title: "Создание и экспорт сертификатов для подключений типа &quot;точка — сеть&quot; в Azure с помощью PowerShell | Документация Майкрософт"
description: "В этой статье приведены инструкции по созданию самозаверяющего корневого сертификата, экспорту открытого ключа и созданию сертификатов клиента с помощью PowerShell в Windows 10."
services: vpn-gateway
documentationcenter: na
author: cherylmc
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 27b99f7c-50dc-4f88-8a6e-d60080819a43
ms.service: vpn-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/04/2017
ms.author: cherylmc
ms.translationtype: Human Translation
ms.sourcegitcommit: 5e92b1b234e4ceea5e0dd5d09ab3203c4a86f633
ms.openlocfilehash: 1bfcb8683669770d6dd927cbde53a683bbc1d56e
ms.contentlocale: ru-ru
ms.lasthandoff: 05/10/2017


---
# <a name="generate-and-export-certificates-for-point-to-site-connections-using-powershell"></a>Создание и экспорт сертификатов для подключений типа "точка — сеть" с помощью PowerShell

Эта статья поможет создать самозаверяющий корневой сертификат, а также сертификаты клиента. В ней нет ни инструкций, ни часто задаваемых вопросов по подключению "точка-сеть". Эти сведения можно найти, выбрав одну из статей о настройке подключения "точка — сеть" в следующем списке:

> [!div class="op_single_selector"]
> * [Создание самозаверяющих сертификатов с помощью PowerShell](vpn-gateway-certificates-point-to-site.md)
> * [Создание самозаверяющих сертификатов с помощью Makecert](vpn-gateway-certificates-point-to-site-makecert.md)
> * [Настройка подключения "точка — сеть" модели Resource Manager на портале Azure](vpn-gateway-howto-point-to-site-resource-manager-portal.md)
> * [Настройка подключения "точка-сеть" — Resource Manager — PowerShell](vpn-gateway-howto-point-to-site-rm-ps.md)
> * [Настройка подключения "точка —сеть" классической модели на портале Azure](vpn-gateway-howto-point-to-site-classic-azure-portal.md)
> 
> 

Для аутентификации подключений типа "точка — сеть" используются сертификаты. При настройке подключения типа "точка — сеть" необходимо передать в Azure открытый ключ корневого сертификата (CER-файл). Кроме того, сертификаты клиента требуется создавать из корневого сертификата и устанавливать на каждом клиентском компьютере, подключающемся к виртуальной сети. Сертификат клиента позволяет клиенту пройти проверку подлинности.


> [!NOTE]
> Выполните описанные действия на компьютере с Windows 10. Командлеты PowerShell, которые необходимы для создания сертификатов, являются частью операционной системы Windows 10 и не работают в других версиях Windows. Эти командлеты требуются только для создания сертификатов. После создания сертификатов их можно установить на любой поддерживаемой клиентской операционной системе. При отсутствии доступа к компьютеру с Windows 10 для создания сертификатов можно использовать средство makecert. Однако сертификаты, созданные с помощью makecert, будучи совместимыми с подключением типа "точка — сеть", не являются сертификатами SHA-2. Инструкции по makecert см. в статье о [создании сертификатов с помощью makecert](vpn-gateway-certificates-point-to-site-makecert.md). Сертификаты, созданные с помощью PowerShell или makecert, можно установить на любой [поддерживаемой клиентской операционной системе](vpn-gateway-howto-point-to-site-resource-manager-portal.md#faq), а не только на операционной системе, используемой для их создания.
> 
>

## <a name="rootcert"></a>Создание самозаверяющего корневого сертификата

Ниже приведены инструкции по созданию самозаверяющего корневого сертификата с помощью PowerShell в Windows 10. Командлеты и параметры, используемые в этих инструкциях, являются частью операционной системы Windows 10 и не зависят от версии PowerShell. Это не означает, что созданные сертификаты можно установить только в Windows 10. Их можно установить на любом поддерживаемом клиенте. Сведения о поддерживаемых клиентах см. в разделе [Часто задаваемые вопросы о подключении "точка-сеть"](vpn-gateway-howto-point-to-site-resource-manager-portal.md#faq).

1. На компьютере под управлением Windows 10 откройте консоль Windows PowerShell с повышенными привилегиями.
2. Используйте следующий пример для создания самозаверяющего корневого сертификата. Следующий пример создает самозаверяющий корневой сертификат P2SRootCert, который автоматически устанавливается в папку Certificates-Current User\Personal\Certificates. Этот сертификат можно просмотреть, открыв файл *certmgr.msc* или раздел *Управление сертификатами пользователей*.

  ```powershell
  $cert = New-SelfSignedCertificate -Type Custom -KeySpec Signature `
  -Subject "CN=P2SRootCert" -KeyExportPolicy Exportable `
  -HashAlgorithm sha256 -KeyLength 2048 `
  -CertStoreLocation "Cert:\CurrentUser\My" -KeyUsageProperty Sign -KeyUsage CertSign
  ```

### <a name="cer"></a>Экспорт открытого ключа (CER)

[!INCLUDE [Export public key](../../includes/vpn-gateway-certificates-export-public-key-include.md)]

Файл exported.cer необходимо отправить в Azure. Дополнительные сведения см. в разделе [Подготовка CER-файла корневого сертификата к передаче](vpn-gateway-howto-point-to-site-rm-ps.md#upload).

### <a name="export-the-self-signed-root-certificate-and-public-key-to-store-it-optional"></a>Экспорт самозаверяющего корневого сертификата и открытого ключа для его сохранения (необязательно)

Может возникнуть необходимость экспортировать самозаверяющий корневой сертификат и сохранить его в надежном месте. При необходимости позднее можно будет установить его на другом компьютере и создать дополнительные сертификаты клиента или экспортировать другой CER-файл. Чтобы экспортировать самозаверяющий корневой сертификат в формате PFX, выберите корневой сертификат и выполните те же действия, что описаны в разделе [Экспорт сертификата клиента](#clientexport).

## <a name="clientcert"></a>Создание сертификата клиента

На каждом клиентском компьютере, который подключается к виртуальной сети с помощью подключения типа "точка —сеть", должен быть установлен сертификат клиента. Вы можете создать сертификат клиента из самозаверяющего корневого сертификата, а затем экспортировать и установить его. Если сертификат клиента не установлен, произойдет сбой аутентификации. 

Ниже описан способ создания сертификата клиента из самозаверяющего корневого сертификата. Из одного корневого сертификата можно создать несколько сертификатов клиента. При создании сертификатов клиента с помощью приведенных ниже инструкций сертификат клиента автоматически устанавливается на компьютер, который использовался для его создания. Если вы хотите установить сертификат клиента на другой клиентский компьютер, его можно экспортировать.

Для создания сертификатов клиента с помощью приведенных ниже шагов PowerShell требуется Windows 10. Командлеты и параметры, используемые в этих инструкциях, являются частью операционной системы Windows 10 и не зависят от версии PowerShell. Это не означает, что созданные сертификаты можно установить только в Windows 10. Сведения о поддерживаемых клиентах см. в разделе [Часто задаваемые вопросы о подключении "точка-сеть"](vpn-gateway-howto-point-to-site-resource-manager-portal.md#faq).

### <a name="example-1"></a>Пример 1

В этом примере используется переменная $cert, объявленная в предыдущем разделе. Если вы закрыли консоль PowerShell после создания самозаверяющего корневого сертификата или создаете дополнительные сертификаты клиента в новом сеансе консоли PowerShell, выполните инструкции, описанные в [примере 2](#ex2).

Измените и запустите пример, чтобы создать сертификат клиента. Если выполнить этот пример, не изменив его, то будет создан сертификат клиента P2SChildCert.  Если требуется указать другое имя дочернего сертификата, измените значение CN. Не изменяйте TextExtension при выполнении данного примера. Сертификат клиента, который создается, автоматически устанавливается в папку Certificates - Current User\Personal\Certificates на компьютере.

```powershell
New-SelfSignedCertificate -Type Custom -KeySpec Signature `
-Subject "CN=P2SChildCert" -KeyExportPolicy Exportable `
-HashAlgorithm sha256 -KeyLength 2048 `
-CertStoreLocation "Cert:\CurrentUser\My" `
-Signer $cert -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.2")
```

### <a name="ex2"></a>Пример 2

Если вы создаете дополнительные сертификаты клиента или не используете тот же сеанс PowerShell, в котором был создан самозаверяющий корневой сертификат, выполните следующее.

1. Определите самозаверяющий корневой сертификат, установленный на компьютере. Этот командлет возвращает список сертификатов, установленных на компьютере.

  ```powershell
  Get-ChildItem -Path “Cert:\CurrentUser\My”
  ```
2. Найдите имя субъекта в полученном списке, а затем скопируйте отпечаток, расположенный рядом с ним, в текстовый файл. В следующем примере указано два сертификата. CN-имя — это имя самозаверяющего корневого сертификата, на основе которого требуется создать дочерний сертификат. В данном случае это P2SRootCert.

        Thumbprint                                Subject

        AED812AD883826FF76B4D1D5A77B3C08EFA79F3F  CN=P2SChildCert4
        7181AA8C1B4D34EEDB2F3D3BEC5839F3FE52D655  CN=P2SRootCert


3. Объявите переменную для корневого сертификата, используя отпечаток из предыдущего шага. Замените THUMBPRINT отпечатком корневого сертификата, на основе которого требуется создать дочерний сертификат.

  ```powershell
  $cert = Get-ChildItem -Path "Cert:\CurrentUser\My\THUMBPRINT"
  ```

  Например, если использовать отпечаток для P2SRootCert из предыдущего шага, то переменная будет выглядеть следующим образом.

  ```powershell
  $cert = Get-ChildItem -Path "Cert:\CurrentUser\My\7181AA8C1B4D34EEDB2F3D3BEC5839F3FE52D655"
  ```    

4.  Измените и запустите пример, чтобы создать сертификат клиента. Если выполнить этот пример, не изменив его, то будет создан сертификат клиента P2SChildCert. Если требуется указать другое имя дочернего сертификата, измените значение CN. Не изменяйте TextExtension при выполнении данного примера. Сертификат клиента, который создается, автоматически устанавливается в папку Certificates - Current User\Personal\Certificates на компьютере.

  ```powershell
  New-SelfSignedCertificate -Type Custom -KeySpec Signature `
  -Subject "CN=P2SChildCert" -KeyExportPolicy Exportable `
  -HashAlgorithm sha256 -KeyLength 2048 `
  -CertStoreLocation "Cert:\CurrentUser\My" `
  -Signer $cert -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.2")
  ```

## <a name="clientexport"></a>Экспорт сертификата клиента   

[!INCLUDE [Export client certificate](../../includes/vpn-gateway-certificates-export-client-cert-include.md)]
    

## <a name="install"></a>Установка экспортированного сертификата клиента

[!INCLUDE [Install client certificate](../../includes/vpn-gateway-certificates-install-client-cert-include.md)]

## <a name="next-steps"></a>Дальнейшие действия

Продолжайте настраивать параметры конфигурации типа "точка-сеть". 

* Инструкции для модели развертывания с помощью **Resource Manager** см. в статье [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью портала Azure](vpn-gateway-howto-point-to-site-resource-manager-portal.md). 
* Инструкции для **классической** модели развертывания см. в статье [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью портала Azure (классическая модель)](vpn-gateway-howto-point-to-site-classic-azure-portal.md).
