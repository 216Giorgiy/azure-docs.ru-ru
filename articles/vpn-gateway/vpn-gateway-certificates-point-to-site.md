---
title: 'Создание самозаверяющих сертификатов для распределенных подключений виртуальных сетей типа '
;точка: ''
—: ''
сеть";: ''
с: ''
помощью: ''
makecert: ''
'|': ''
microsoft: ''
azure": ''
description: Эта статья содержит инструкции по использованию makecert для создания самозаверяющих сертификатов в Windows 10.
services: vpn-gateway
documentationcenter: na
author: cherylmc
manager: carmonm
editor: ''
tags: azure-resource-manager

ms.service: vpn-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/22/2016
ms.author: cherylmc

---
# Работа с самозаверяющими сертификатами для подключений типа "точка — сеть"
Эта статья поможет создать самозаверяющий сертификат с помощью **makecert**, а затем на его основе создать сертификаты клиента. Все инструкции приведены для использования makeсert в Windows 10. Было проверено создание сертификатов, которые совместимы с подключениями типа "точка — сеть", с помощью makeсert.

Для подключений типа "точка — сеть" предпочтительно использовать свое корпоративное решение для сертификатов, убедившись, что клиентам выдаются сертификаты с общим именем в формате "имя@ваш\_домен.com", а не в формате "доменное\_имя\_NetBIOS\\имя\_пользователя".

Если у вас нет корпоративного решения, то чтобы разрешить клиентам P2S подключаться к виртуальной сети, потребуется самозаверяющий сертификат. Нам известно, что инструмент makecert является нерекомендуемым, но его по-прежнему можно использовать для создания самозаверяющих сертификатов, совместимых с подключениями типа "точка — сеть". Мы разрабатываем другое решение, которое будет создавать самозаверяющие сертификаты, но на данный момент предпочтительным методом является makecert.

## Создание самозаверяющего сертификата
Использование makecert — один из способов создания самозаверяющего сертификата. Ниже приведены инструкции по созданию самозаверяющего сертификата с помощью makeсert. Они не зависят от модели развертывания. Они подходят как для модели с использованием диспетчера ресурсов, так и для классической модели.

### Создание самозаверяющего сертификата
1. На компьютере под управлением Windows 10 скачайте и установите [пакет средств разработки программного обеспечения (SDK) для Windows для Windows 10](https://dev.windows.com/ru-RU/downloads/windows-10-sdk).
2. После установки служебную программу makecert.exe можно найти по такому пути: C:\\Program Files (x86)\\Windows Kits\\10\\bin<arch>.
   
    Пример: `C:\Program Files (x86)\Windows Kits\10\bin\x64`
3. Затем создайте и установите сертификат в личном хранилище сертификатов на компьютере. В следующем примере создается соответствующий *CER-файл*, передаваемый в Azure при настройке подключений типа "точка — сеть". Выполните следующую команду от имени администратора. Замените *ARMP2SRootCert* и *ARMP2SRootCert.cer* именем, которое будет использоваться для сертификата.<br><br>Сертификат будет расположен в хранилище сертификатов: Текущий пользователь\\Personal\\Certificates.
   
        makecert -sky exchange -r -n "CN=ARMP2SRootCert" -pe -a sha1 -len 2048 -ss My "ARMP2SRootCert.cer"

### <a name="rootpublickey"></a>Получение открытого ключа
Открытый ключ для корневого сертификата является частью конфигурации VPN-шлюза для подключений типа "точка — сеть" и передается в Azure.

1. Для получения из сертификата файла в формате CER откройте **certmgr.msc**. Щелкните самозаверяющий корневой сертификат правой кнопкой мыши, выберите пункт **Все задачи**, а затем нажмите кнопку **Экспорт**. Откроется **мастера экспорта сертификатов**.
2. В мастере нажмите кнопку **Далее**, выберите **Нет, не экспортировать закрытый ключ** и снова нажмите кнопку **Далее**.
3. На странице **Формат экспортируемого файла** выберите **Файлы X.509 (.CER) в кодировке Base-64**. Нажмите кнопку **Далее**.
4. На странице **Файл для экспорта** нажмите кнопку **Обзор**, чтобы перейти в расположение, куда нужно экспортировать сертификат. В поле **Имя файла** введите имя для файла сертификата. Нажмите кнопку **Далее**.
5. Нажмите кнопку **Готово**, чтобы экспортировать сертификат.

### Экспорт самозаверяющего сертификата (необязательно)
Может возникнуть необходимость экспортировать самозаверяющий сертификат и сохранить его в надежном месте. При необходимости позднее можно будет установить его на другом компьютере и создать дополнительные сертификаты клиента или экспортировать другой CER-файл. Любой компьютер, на котором установлен сертификат клиента и настроены соответствующие параметры клиента VPN, может подключиться к виртуальной сети через подключение типа "точка — сеть". По этой причине необходимо, чтобы сертификаты клиента создавались и устанавливались только тогда, когда требуется, и чтобы этот самозаверяющий сертификат был сохранен в надежном месте.

Чтобы экспортировать самозаверяющий сертификат в формате PFX, выберите корневой сертификат и выполните те же действия, что описаны в разделе [Экспорт сертификата клиента](#clientkey).

## Создание и установка сертификатов клиента
Не устанавливайте самозаверяющий сертификат непосредственно на клиентский компьютер. Нужно создать сертификат клиента из самозаверяющего сертификата. Затем его следует экспортировать и установить на клиентском компьютере. Приведенные ниже инструкции не зависят от модели развертывания. Они подходят как для модели с использованием диспетчера ресурсов, так и для классической модели.

### Часть 1. Создание сертификата клиента из самозаверяющего сертификата
Ниже описан один из способов создания сертификата клиента из самозаверяющего сертификата. Из одного сертификата можно создать несколько сертификатов клиента. Затем каждый сертификат клиента можно экспортировать и установить на клиентском компьютере.

1. На компьютере, на котором вы создали самозаверяющий сертификат, откройте командную строку от имени администратора.
2. В этом примере ARMP2SRootCert указывает на созданный вами самозаверяющий сертификат.
   
   * Замените *ARMP2SRootCert* именем самозаверяющего корня, из которого создается сертификат клиента.
   * Замените *ClientCertificateName* именем, которое следует использовать для создаваемого сертификата клиента.

    Измените и запустите пример, чтобы создать сертификат клиента. Если выполнить приведенную ниже команду без изменений, в ваше хранилище личных сертификатов будет добавлен сертификат клиента с именем ClientCertificateName, созданный из корневого сертификата ARMP2SRootCert.

        makecert.exe -n "CN=ClientCertificateName" -pe -sky exchange -m 96 -ss My -in "ARMP2SRootCert" -is my -a sha1

1. Все сертификаты находятся в хранилище сертификатов на вашем компьютере в следующем расположении: Текущий пользователь\\Personal\\Certificates. С помощью этой процедуры можно создать любое количество сертификатов.

### <a name="clientkey"></a>Часть 2. Экспорт сертификата клиента
1. Для экспорта сертификата клиента запустите **certmgr.msc**. Щелкните правой кнопкой мыши сертификат, который надо экспортировать, выберите элемент **Все задачи** и нажмите кнопку **Экспорт**. Откроется **мастера экспорта сертификатов**.
2. В мастере экспорта сертификатов нажмите кнопку **Далее**, выберите **Да, экспортировать закрытый ключ** и снова нажмите кнопку **Далее**.
3. На странице **Формат экспортируемого файла** оставьте настройки по умолчанию. Нажмите кнопку **Далее**.
4. На странице **Безопасность** следует защитить закрытый ключ. Если вы решите использовать пароль, обязательно запишите или запомните пароль, заданный для этого сертификата. Нажмите кнопку **Далее**.
5. На странице **Файл для экспорта** нажмите кнопку **Обзор**, чтобы перейти в расположение, куда нужно экспортировать сертификат. В поле **Имя файла** введите имя для файла сертификата. Нажмите кнопку **Далее**.
6. Нажмите кнопку **Готово**, чтобы экспортировать сертификат.

### Часть 3. Установка сертификата клиента
Каждый клиент, который вы хотите подключить к виртуальной сети с использованием подключения типа "точка-сеть", должен иметь установленный сертификат клиента. Этот сертификат является дополнением к обязательному пакету конфигурации VPN. Описанные ниже шаги помогут вам установить сертификат клиента вручную.

1. Найдите *PFX*-файл и скопируйте его на клиентский компьютер. На клиентском компьютере дважды щелкните *PFX*-файл, чтобы установить его. Для параметра **Расположение хранилища** оставьте значение **Текущий пользователь**, а затем нажмите кнопку **Далее**.
2. На странице **Файл для импорта** не вносите никаких изменений. Нажмите кнопку **Далее**.
3. На странице **Защита с помощью закрытого ключа** введите пароль для сертификата (если он используется) или проверьте, правильно ли выбран субъект безопасности, который устанавливает сертификат. Затем нажмите кнопку **Далее**.
4. На странице **Хранилище сертификатов** оставьте расположение по умолчанию и нажмите кнопку **Далее**.
5. Нажмите кнопку **Готово** На странице **Предупреждение системы безопасности** для установки сертификата щелкните **Да**. Сертификат успешно импортирован.

## Дальнейшие действия
Продолжайте настраивать параметры конфигурации типа "точка-сеть".

* Действия для модели развертывания с помощью **Resource Manager** см. в статье [Настройка подключения типа "точка–сеть" к виртуальной сети с помощью PowerShell](vpn-gateway-howto-point-to-site-rm-ps.md).
* Действия для **классической** модели развертывания см. в статье [Настройка VPN-подключения типа "точка — сеть" к виртуальной сети с помощью классического портала](vpn-gateway-point-to-site-create.md).

<!---HONumber=AcomDC_0831_2016-->