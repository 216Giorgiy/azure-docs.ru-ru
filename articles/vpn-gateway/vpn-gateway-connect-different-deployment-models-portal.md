---
title: Подключение классических виртуальных сетей к виртуальным сетям Resource Manager на портале | Microsoft Docs
description: Узнайте, как создать VPN-подключение между классическими виртуальными сетями и виртуальными сетями Resource Manager с помощью VPN-шлюза и портала
services: vpn-gateway
documentationcenter: na
author: cherylmc
manager: carmonm
editor: ''
tags: azure-service-management,azure-resource-manager

ms.service: vpn-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/03/2016
ms.author: cherylmc

---
# <a name="connect-virtual-networks-from-different-deployment-models-in-the-portal"></a>Создание подключения между виртуальными сетями из разных моделей развертывания с помощью портала
> [!div class="op_single_selector"]
> * [Портал](vpn-gateway-connect-different-deployment-models-portal.md)
> * [PowerShell](vpn-gateway-connect-different-deployment-models-powershell.md)
> 
> 

В настоящее время в Azure есть два режима управления: классический и Resource Manager (RM). Если вы использовали Azure какое-то время, вероятно, у вас есть виртуальные машины и роли экземпляров Azure, выполняемые в классической виртуальной сети. А более новые виртуальные машины и экземпляры ролей могут выполняться в виртуальной сети, созданной Resource Manager. В этой статье описываются этапы настройки подключения между классическими виртуальными сетями и виртуальными сетями Resource Manager, чтобы ресурсы, размещенные в разных моделях развертывания, могли взаимодействовать между собой через шлюз. 

Подключение можно создать между виртуальными сетями, которые находятся в разных подписках и разных регионах. Вы также можете создать подключение между виртуальными сетями, которые уже подключены к локальным сетям. В этом случае для них должен быть настроен динамический шлюз или шлюз на основе маршрутов. Дополнительные сведения о подключениях типа "виртуальная сеть — виртуальная сеть" см. в разделе [Часто задаваемые вопросы о подключениях типа "виртуальная сеть — виртуальная сеть"](#faq) в конце этой статьи.

### <a name="deployment-models-and-methods-for-vnet-to-vnet-connections"></a>Модели и методы развертывания для подключений между виртуальными сетями
[!INCLUDE [vpn-gateway-clasic-rm](../../includes/vpn-gateway-classic-rm-include.md)]

Мы обновляем эту таблицу по мере выпуска новых статей и дополнительных инструментов для этой конфигурации. Если статья доступна, таблица ссылается на нее напрямую.<br><br>

**Подключение между виртуальными сетями**

[!INCLUDE [vpn-gateway-table-vnet-vnet](../../includes/vpn-gateway-table-vnet-to-vnet-include.md)]

#### <a name="vnet-peering"></a>Пиринговая связь между виртуальными сетями
[!INCLUDE [vpn-gateway-vnetpeeringlink](../../includes/vpn-gateway-vnetpeeringlink-include.md)]

## <a name="before-beginning"></a>Подготовка
Далее приведены инструкции, которые помогут вам настроить динамический шлюз или шлюз на основе маршрутов для каждой виртуальной сети и создать VPN-подключение между шлюзами. Эта конфигурация не поддерживает статические шлюзы и шлюзы на основе политик. 

В этой статье мы используем классический портал, портал Azure и PowerShell. В настоящее время создать эту конфигурацию, используя только портал Azure, невозможно.

### <a name="prerequisites"></a>Предварительные требования
* Обе виртуальные сети уже созданы.
* Диапазоны адресов для виртуальных сетей не перекрываются между собой или с другими диапазонами подключений, к которым могут быть подключены шлюзы.
* В системе установлены последние командлеты Azure PowerShell (версии 1.0.2 или более поздней). Дополнительные сведения см. в статье [Как установить и настроить Azure PowerShell](../powershell-install-configure.md). Командлеты управления службой и Resource Manager должны быть установлены. 

### <a name="<a-name="values"></a>example-settings"></a><a name="values"></a>Примеры настроек
Параметры из примера можно использовать в качестве ориентира.

**Параметры классической виртуальной сети**

Имя виртуальной сети = ClassicVNet <br>
Расположение: Западная часть США <br>
Адресные пространства виртуальной сети = 10.0.0.0/24 <br>
Подсеть-1 = 10.0.0.0/27 <br>
Шлюз подсети = 10.0.0.32/29 <br>
Имя локальной сети = RMVNetLocal <br>

**Параметры виртуальной сети Resource Manager**

Имя виртуальной сети = RMVNet <br>
Группа ресурсов = RG1 <br>
Адресные пространства виртуальной сети = 192.168.0.0/16 <br>
Подсеть-1 = 192.168.1.0/24 <br>
Шлюз подсети = 192.168.0.0/26 <br>
Расположение = восточная часть США <br>
Имя шлюза виртуальной сети = RMGateway <br>
Общедоступное IP-имя шлюза: gwpip <br>
Тип шлюза: VPN <br>
Тип VPN: на основе маршрутов <br>
Шлюз локальной сети = ClassicVNetLocal <br>

## <a name="<a-name="createsmgw"></a>section-1:-configure-classic-vnet-settings"></a><a name="createsmgw"></a>Раздел 1. Настройка параметров классической виртуальной сети
В этом разделе мы создадим локальную сеть и шлюз для классической виртуальной сети. Действия, описанные в этом разделе, выполняются на классическом портале. В настоящее время на портале Azure не предоставляются все параметры, которые относятся к классической виртуальной сети.

### <a name="part-1---create-a-new-local-network"></a>Часть 1. Создание локальной сети
Откройте [классический портал](https://manage.windowsazure.com) и войдите в систему, используя свою учетную запись Azure.

1. В левом нижнем углу экрана выберите **Создать** > **Сетевые службы** > **Виртуальная сеть** > **Добавить локальную сеть**.
2. В окне **Укажите сведения о локальной сети** введите имя виртуальной сети RM, к которой необходимо подключиться. В поле **IP-адрес устройства VPN (необязательно)** введите любой допустимый общедоступный IP-адрес. Это только временный заполнитель. Позже вы измените этот IP-адрес. В нижнем правом углу окна нажмите кнопку со стрелкой.
3. На странице **Указать адресное пространство** в текстовом поле **Начальный IP-адрес** введите префикс сети и блок CIDR для виртуальной сети Resource Manager, к которой необходимо подключиться. Этот параметр используется, чтобы определить адресное пространство для маршрутизации в виртуальную сеть RM.

### <a name="part-2---associate-the-local-network-to-your-vnet"></a>Часть 2. Связывание локальной сети с виртуальной сетью
1. В верхней части страницы щелкните **Виртуальная сеть** , чтобы перейти к экрану выбора виртуальных сетей, а затем выберите свою классическую виртуальную сеть. На странице виртуальной сети щелкните **Настроить** , чтобы перейти на страницу "Настройка".
2. В разделе **Подключение типа "сеть–сеть"** установите флажок **Подключиться к локальной сети**. Затем выберите созданную локальную сеть. При наличии нескольких созданных локальных сетей выберите в раскрывающемся списке ту, которая представляет вашу виртуальную сеть Resource Manager.
3. В нижней части страницы нажмите кнопку **Сохранить** .

### <a name="part-3---create-the-gateway"></a>Часть 3. Создание шлюза
1. После сохранения параметров в верхней части страницы щелкните **Панель мониторинга** , чтобы перейти к странице "Панель мониторинга". В нижней части страницы "Панель мониторинга" щелкните **Создать шлюз**, а затем — **Динамическая маршрутизация**. Нажмите кнопку **Да** , чтобы начать создание шлюза. Для этой конфигурации требуется шлюз динамической маршрутизации.
2. Подождите, пока шлюз не будет создан. Этот процесс может занять 45 минут или больше.

### <a name="<a-name="ip"></a>part-4---view-the-gateway-public-ip-address"></a><a name="ip"></a>Часть 4. Просмотр общедоступного IP-адреса шлюза
После создания шлюза его IP-адрес можно просмотреть на странице **Панель мониторинга**. Это общедоступный IP-адрес вашего шлюза. Запишите или скопируйте это значение, так как оно понадобится позже при создании локальной сети для настройки виртуальной сети Resource Manager.

## <a name="<a-name="creatermgw"></a>section-2:-configure-resource-manager-vnet-settings"></a><a name="creatermgw"></a> Раздел 2. Настройка параметров виртуальной сети Resource Manager
В этом разделе мы создадим шлюз и локальную сеть для виртуальной сети Resource Manager. Не приступайте к выполнению следующих действий до получения общедоступного IP-адреса шлюза классической виртуальной сети.

Снимки экрана приведены в качестве примеров. Обязательно подставьте собственные значения. Если вы создаете эту конфигурацию в качестве упражнения, можно использовать вот эти [значения](#values).

### <a name="part-1---create-a-gateway-subnet"></a>Часть 1. Создание подсети шлюза
Прежде чем подключать шлюз к виртуальной сети, нужно создать подсеть шлюза для виртуальной сети, к которой необходимо подключиться. Создайте подсеть шлюза размером /28 или больше (/27, /26 и т. д.).

[!INCLUDE [vpn-gateway-no-nsg-include](../../includes/vpn-gateway-no-nsg-include.md)]

В браузере откройте [портал Azure](http://portal.azure.com) и выполните вход с помощью учетной записи Azure.

[!INCLUDE [vpn-gateway-add-gwsubnet-rm-portal](../../includes/vpn-gateway-add-gwsubnet-rm-portal-include.md)]

### <a name="part-2---create-a-virtual-network-gateway"></a>Часть 2. Создание шлюза виртуальной сети
[!INCLUDE [vpn-gateway-add-gw-rm-portal](../../includes/vpn-gateway-add-gw-rm-portal-include.md)]

### <a name="part-3---create-a-local-network-gateway"></a>Часть 3. Создание локального сетевого шлюза
Обычно термин "шлюз локальной сети" означает локальное расположение. Он сообщает Azure диапазон IP-адресов для направления в расположение и общедоступный IP-адрес устройства в этом расположении. Но в этом случае он указывает диапазон адресов и общедоступный IP-адрес, связанные со шлюзом классической и обычной виртуальной сети.

Шлюзу локальной сети необходимо присвоить имя, по которому на него сможет ссылаться служба Azure. Во время создания шлюза виртуальной сети можно также создать шлюз локальной сети. Для этой конфигурации необходимо использовать общедоступный IP-адрес, назначенный шлюзу классической виртуальной сети в [предыдущем разделе](#ip).

[!INCLUDE [vpn-gateway-add-lng-rm-portal](../../includes/vpn-gateway-add-lng-rm-portal-include.md)]

### <a name="part-4---copy-the-public-ip-address"></a>Часть 4. Копирование общедоступного IP-адреса
После создания шлюза виртуальной сети скопируйте общедоступный IP-адрес, связанный со шлюзом. Он понадобится при настройке параметров локальной сети для классической виртуальной сети. 

## <a name="section-3:-modify-the-local-network-for-the-classic-vnet"></a>Раздел 3. Изменение параметров локальной сети для классической виртуальной сети
Откройте [классический портал](https://manage.windowsazure.com).

1. На классическом портале прокрутите вниз и в левой части выберите **Сети**. В верхней части страницы **Сети** щелкните **Локальные сети**. 
2. Выберите локальную сеть, настроенную в разделе "Часть 1. Создание локальной сети". В нижней части страницы щелкните **Изменить**.
3. На странице **Укажите сведения о локальной сети** замените заполнитель общедоступным IP-адресом шлюза Resource Manager, созданным в предыдущем разделе. Нажмите кнопку со стрелкой, чтобы перейти к следующему разделу. Убедитесь, что для параметра **Адресное пространство** задано правильное значение, а затем щелкните значок флажка, чтобы применить изменения.

## <a name="<a-name="connect"></a>section-4:-create-the-connection"></a><a name="connect"></a>Раздел 4. Создание подключения
В этом разделе мы создадим подключение между виртуальными сетями. Для этого нам понадобится PowerShell. Это подключение невозможно создать на каком-либо из порталов. Убедитесь, что командлеты PowerShell Resource Manager и классические командлеты PowerShell установлены.

1. В консоли PowerShell войдите в свою учетную запись Azure. Следующий командлет запрашивает учетные данные входа для вашей учетной записи Azure. После выполнения входа он скачивает параметры учетной записи, чтобы они были доступны в Azure PowerShell.
   
        Login-AzureRmAccount 
   
    Если у вас есть несколько подписок, запросите их список.
   
        Get-AzureRmSubscription
   
    Укажите подписку, которую нужно использовать. 
   
        Select-AzureRmSubscription -SubscriptionName "Name of subscription"
2. Добавьте свою учетную запись Azure, чтобы использовать классические командлеты PowerShell. Используйте для этого следующую команду:
   
        Add-AzureAccount
3. Установите общий ключ, выполнив приведенный ниже пример команды. В этом примере `-VNetName` — это имя классической виртуальной сети, а `-LocalNetworkSiteName` — имя локальной сети, определенное на классическом портале. `-SharedKey` — это значение, которое можно создать и задать. Заданное здесь значение должно совпадать со значением, которое вы укажите на следующем шаге при создании подключения.
   
        Set-AzureVNetGatewayKey -VNetName ClassicVNet `
        -LocalNetworkSiteName RMVNetLocal -SharedKey abc123
4. Создайте VPN-подключение, выполнив следующие команды.
   
    **Задание переменных**
   
        $vnet01gateway = Get-AzureRMLocalNetworkGateway -Name ClassicVNetLocal -ResourceGroupName RG1
        $vnet02gateway = Get-AzureRmVirtualNetworkGateway -Name RMGateway -ResourceGroupName RG1
   
    **Создание подключения**<br> Обратите внимание, что для параметра `-ConnectionType` используется значение IPsec, а не Vnet2Vnet. В этом примере для имени подключения используется `-Name` . Следующий пример команды позволяет создать подключение*rm-to-classic-connection*.
   
        New-AzureRmVirtualNetworkGatewayConnection -Name rm-to-classic-connection -ResourceGroupName RG1 `
        -Location "East US" -VirtualNetworkGateway1 `
        $vnet02gateway -LocalNetworkGateway2 `
        $vnet01gateway -ConnectionType IPsec -RoutingWeight 10 -SharedKey 'abc123'

## <a name="verify-your-connection"></a>Проверка подключения
Подключение можно проверить на классическом портале, на портале Azure или с помощью PowerShell. Чтобы проверить подключение, выполните приведенные ниже действия. Вместо примеров подставьте собственные значения.

[!INCLUDE [vpn-gateway-verify connection](../../includes/vpn-gateway-verify-connection-rm-include.md)]

## <a name="<a-name="faq"></a>vnet-to-vnet-faq"></a><a name="faq"></a>Часто задаваемые вопросы о подключениях типа "виртуальная сеть — виртуальная сеть"
Дополнительные сведения см. в ответах на часто задаваемые вопросы о подключениях типа "виртуальная сеть — виртуальная сеть".

[!INCLUDE [vpn-gateway-vnet-vnet-faq](../../includes/vpn-gateway-vnet-vnet-faq-include.md)]

<!--HONumber=Oct16_HO2-->


