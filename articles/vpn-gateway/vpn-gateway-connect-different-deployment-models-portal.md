---
title: "Подключение классических виртуальных сетей к виртуальным сетям Resource Manager с помощью портала | Документация Майкрософт"
description: "Узнайте, как создать VPN-подключение между классическими виртуальными сетями и виртуальными сетями Resource Manager с помощью VPN-шлюза и портала"
services: vpn-gateway
documentationcenter: na
author: cherylmc
manager: timlt
editor: 
tags: azure-service-management,azure-resource-manager
ms.assetid: 5a90498c-4520-4bd3-a833-ad85924ecaf9
ms.service: vpn-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/17/2017
ms.author: cherylmc
translationtype: Human Translation
ms.sourcegitcommit: 10985eaebd9148ef4fbd22eac0ba50076ca71ef5
ms.openlocfilehash: c20d72f25571e582310ae65ad1d887dbdb7b011c


---
# <a name="connect-virtual-networks-from-different-deployment-models-using-the-portal"></a>Подключение виртуальных сетей из разных моделей развертывания с помощью портала
> [!div class="op_single_selector"]
> * [Портал](vpn-gateway-connect-different-deployment-models-portal.md)
> * [PowerShell](vpn-gateway-connect-different-deployment-models-powershell.md)
> 
> 

В настоящее время в Azure есть два режима управления: классический и Resource Manager (RM). Если вы использовали Azure какое-то время, вероятно, у вас есть виртуальные машины и роли экземпляров Azure, выполняемые в классической виртуальной сети. А более новые виртуальные машины и экземпляры ролей могут выполняться в виртуальной сети, созданной Resource Manager. В этой статье описываются этапы настройки подключения между классическими виртуальными сетями и виртуальными сетями Resource Manager, чтобы ресурсы, размещенные в разных моделях развертывания, могли взаимодействовать между собой через шлюз. 

Подключение можно создать между виртуальными сетями, которые находятся в разных подписках и разных регионах. Вы также можете создать подключение между виртуальными сетями, которые уже подключены к локальным сетям. В этом случае для них должен быть настроен динамический шлюз или шлюз на основе маршрутов. Дополнительные сведения о подключении виртуальных сетей см. в разделе [Рекомендации по работе с подключением типа "виртуальная сеть — виртуальная сеть"](#faq) в конце этой статьи.

### <a name="deployment-models-and-methods-for-vnet-to-vnet-connections"></a>Модели и методы развертывания для подключений между виртуальными сетями
[!INCLUDE [vpn-gateway-clasic-rm](../../includes/vpn-gateway-classic-rm-include.md)]

Мы обновляем эту таблицу по мере выпуска новых статей и дополнительных инструментов для этой конфигурации. Если статья доступна, таблица ссылается на нее напрямую.<br><br>

**Подключение между виртуальными сетями**

[!INCLUDE [vpn-gateway-table-vnet-vnet](../../includes/vpn-gateway-table-vnet-to-vnet-include.md)]

**Пиринговая связь между виртуальными сетями**

[!INCLUDE [vpn-gateway-vnetpeeringlink](../../includes/vpn-gateway-vnetpeeringlink-include.md)]

## <a name="a-namebeforeabefore-beginning"></a><a name="before"></a>Подготовка
Далее приведены инструкции, которые помогут вам настроить динамический шлюз или шлюз на основе маршрутов для каждой виртуальной сети и создать VPN-подключение между шлюзами. Эта конфигурация не поддерживает статические шлюзы и шлюзы на основе политик. 

В этой статье мы используем портал Azure и PowerShell. PowerShell требуется для создания подключений между виртуальными сетями. Создать подключения для этой конфигурации с помощью портала невозможно.

### <a name="prerequisites"></a>Предварительные требования
* Обе виртуальные сети уже созданы.
* Диапазоны адресов для виртуальных сетей не перекрываются между собой или с другими диапазонами подключений, к которым могут быть подключены шлюзы.
* В системе установлена последняя версия командлетов Azure PowerShell. Дополнительные сведения см. в статье [Как установить и настроить Azure PowerShell](/powershell/azureps-cmdlets-docs). Командлеты управления службой и Resource Manager должны быть установлены. 

### <a name="a-namevaluesaexample-settings"></a><a name="values"></a>Примеры настроек
Параметры из примера можно использовать в качестве ориентира.

**Параметры классической виртуальной сети**

Имя виртуальной сети = ClassicVNet <br>
Адресное пространство: 10.0.0.0/24. <br>
Подсеть-1 = 10.0.0.0/27 <br>
Группа ресурсов: RG1. <br>
Расположение: Западная часть США <br>
Подсеть шлюза: 10.0.0.32/28. <br>
Локальный сайт: RMVNetLocal. <br>

**Параметры виртуальной сети Resource Manager**

Имя виртуальной сети = RMVNet <br>
Адресное пространство: 192.168.0.0/16. <br>
Подсеть-1 = 192.168.1.0/24 <br>
Шлюз подсети = 192.168.0.0/26 <br>
Группа ресурсов = RG1 <br>
Расположение = восточная часть США <br>
Имя шлюза виртуальной сети = RMGateway <br>
Тип шлюза: VPN <br>
Тип VPN: на основе маршрутов <br>
Общедоступное IP-имя шлюза: gwpip <br>
Шлюз локальной сети = ClassicVNetLocal <br>

## <a name="a-namecreatesmgwasection-1-configure-classic-vnet-settings"></a><a name="createsmgw"></a>Раздел 1. Настройка параметров классической виртуальной сети
В этом разделе мы создадим локальную сеть (локальный сайт) и шлюз виртуальной сети для классической виртуальной сети. Действия, описанные в этом разделе, выполняются на портале Azure. В инструкциях предполагается, что для классической виртуальной сети еще не был создан VPN-шлюз. Если у вас уже есть шлюз, убедитесь, что он является динамическим. Если это статический шлюз, необходимо сначала удалить этот VPN-шлюз, а затем выполнить приведенные ниже действия.

### <a name="part-1---configure-the-local-site"></a>Часть 1. Настройка локального сайта

Откройте [портал Azure](https://ms.portal.azure.com) и войдите в систему, используя свою учетную запись Azure.

1. Перейдите к колонке **Все ресурсы** и найдите классическую виртуальную сеть.
2. В колонке **Обзор** вразделе **VPN-подключения** щелкните значок **шлюза**, чтобы создать шлюз.

    ![Настройка VPN-шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/gatewaygraphic.png "Настройка VPN-шлюза")
3. В колонке **Новое VPN-подключение** для параметра **Тип подключения** выберите значение **Сеть-сеть**.
4. Для параметра **Локальный сайт** щелкните **Настроить обязательные параметры**. Откроется колонка **Локальный сайт**.
5. В колонке **Локальный сайт** введите имя, которое будет использоваться для виртуальной сети Resource Manager. Например, RMVNetLocal.
6. Если у VPN-шлюза для виртуальной сети Resource Manager уже есть общедоступный IP-адрес, укажите его в поле **IP-адрес VPN-шлюза**. Если вы еще не создали шлюз для виртуальной сети Resource Manager, то можно использовать заполнитель IP-адреса. Убедитесь, что для заполнителя IP-адреса используется допустимый формат. Позднее необходимо будет заменить его общедоступным IP-адресом шлюза виртуальной сети Resource Manager.
7. В поле **Client Address Space** (адресное пространство клиента) укажите значения адресных пространств IP-адресов виртуальной сети Resource Manager. Этот параметр используется, чтобы определить адресные пространства для маршрутизации в виртуальную сеть Resource Manager.
8. Нажмите кнопку **ОК**, чтобы сохранить значения и вернуться к колонке **Новое VPN-подключение**.

### <a name="part-2---create-the-virtual-network-gateway"></a>Часть 2. Создание шлюза виртуальной сети
1. В колонке **Новое VPN-подключение** установите флажок **Немедленно создать шлюз** и щелкните **Дополнительная настройка шлюза**, чтобы открыть колонку **Настройка шлюза**. 

    ![Открытие колонки настройки шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/optionalgatewayconfiguration.png "Открытие колонки настройки шлюза")
2. Щелкните **Подсеть - настроить обязательные параметры**, чтобы открыть колонку **Добавление подсети**. В этой колонке вы увидите, что в поле имени уже задано обязательное значение **GatewaySubnet**.
3. **Диапазон адресов** определяет диапазон подсети шлюза. Несмотря на то, что можно создать подсеть шлюза с диапазоном адресов /29 (3 адреса), рекомендуется создать подсеть шлюза с большим числом доступных IP-адресов, чтобы сделать возможными использование в будущем конфигураций, требующих больше доступных IP-адресов. Если это возможно, используйте диапазон /27 или /28. Нажмите кнопку **ОК**, чтобы создать подсеть шлюза.
4. В колонке **Настройка шлюза** отображается значение **Размер**, которое относится к номеру SKU шлюза. Выберите номер SKU для своего VPN-шлюза.
5. Убедитесь, что параметр **Тип маршрутизации** имеет значение **Динамическая**, и нажмите кнопку **ОК** для возврата к колонке **VPN-подключения**.
6. В колонке **VPN-подключения** нажмите кнопку **ОК**, чтобы создать VPN-шлюз. Это может занять до 45 минут.


### <a name="a-nameipapart-3---copy-the-virtual-network-gateway-public-ip-address"></a><a name="ip"></a>Часть 3. Копирование общедоступного IP-адреса шлюза виртуальной сети
После создания шлюза виртуальной сети можно просмотреть его IP-адрес. 

1. Перейдите к классической виртуальной сети и щелкните **Обзор**.
2. Щелкните **VPN-подключения**, чтобы открыть колонку "VPN-подключения". В колонке "VPN-подключения" можно увидеть общедоступный IP-адрес. Это общедоступный IP-адрес, назначенный вашему шлюзу виртуальной сети. Запишите или скопируйте его. Он понадобится позже, при работе с параметрами конфигурации локального сетевого шлюза Resource Manager. Можно также просмотреть состояние подключений шлюза. Обратите внимание, что созданный вами сайт локальной сети отображен в состоянии "Подключение". Это состояние изменится после создания подключений. Скопировав IP-адрес шлюза, закройте колонку.

## <a name="a-namecreatermgwasection-2-configure-resource-manager-vnet-settings"></a><a name="creatermgw"></a> Раздел 2. Настройка параметров виртуальной сети Resource Manager
В этом разделе мы создадим шлюз виртуальной сети и локальную сеть для виртуальной сети Resource Manager. Снимки экрана приведены в качестве примеров. Обязательно подставьте собственные значения. Если вы создаете эту конфигурацию в качестве упражнения, можно использовать вот эти [значения](#values).

### <a name="part-1---create-a-gateway-subnet"></a>Часть 1. Создание подсети шлюза
Чтобы создать шлюз виртуальной сети, сначала нужно создать подсеть шлюза. Создайте подсеть шлюза с диапазоном адресов /28 или больше. (/&27;, /26, и т. д.)

[!INCLUDE [vpn-gateway-no-nsg-include](../../includes/vpn-gateway-no-nsg-include.md)]

В браузере откройте [портал Azure](http://portal.azure.com) и выполните вход с помощью учетной записи Azure.

[!INCLUDE [vpn-gateway-add-gwsubnet-rm-portal](../../includes/vpn-gateway-add-gwsubnet-rm-portal-include.md)]

### <a name="part-2---create-a-virtual-network-gateway"></a>Часть 2. Создание шлюза виртуальной сети
[!INCLUDE [vpn-gateway-add-gw-rm-portal](../../includes/vpn-gateway-add-gw-rm-portal-include.md)]

Создание шлюза виртуальной сети может длиться до 45 минут. Можно дождаться завершения создания шлюза виртуальной сети Resource Manager или перейти к разделу [Часть 3. Создание локального сетевого шлюза](#createlng). После создания шлюза ему назначается общедоступный IP-адрес. На последующих этапах этим IP-адресом заменяется заполнитель IP-адреса в параметрах локального сайта классической виртуальной сети, созданного в разделе 1. 

### <a name="a-namecreatelngapart-3---create-a-local-network-gateway"></a><a name="createlng"></a>Часть 3. Создание локального сетевого шлюза

Локальный сетевой шлюз задает диапазон адресов и общедоступный IP-адрес, связанные с классической виртуальной сетью и ее шлюзом.

- Используйте общедоступный IP-адрес, назначенный шлюзу классической виртуальной сети в [предыдущем разделе](#ip). 
- Шлюзу локальной сети необходимо присвоить имя, по которому на него сможет ссылаться служба Azure. Например, ClassicVNetLocal.
- Используйте адресное пространство, которое было назначено классической виртуальной сети (не только подсети).

[!INCLUDE [vpn-gateway-add-lng-rm-portal](../../includes/vpn-gateway-add-lng-rm-portal-include.md)]


## <a name="section-3-modify-the-classic-vnet-local-site-settings"></a>Раздел 3. Изменение параметров локального сайта виртуальной сети

В этом разделе вы будете иметь дело с классической виртуальной сетью. Вы замените заполнитель IP-адреса, использованный при указании параметров локального сайта. В этом разделе используются классические командлеты PowerShell (управление службами). Если это еще не сделано, просмотрите параметры шлюза для виртуальной сети Resource Manager и скопируйте его общедоступный IP-адрес. Этот IP-адрес вы укажете вместо заполнителя IP-адреса.

Убедитесь, что вы скачали последнюю версию командлетов, как указано в разделе [Подготовка](#before).

1. На портале Azure перейдите к классической виртуальной сети.
2. В колонке своей виртуальной сети щелкните **Обзор**.
3. В разделе **VPN-подключения** щелкните имя своего локального сайта на схеме.

    ![VPN-подключения](./media/vpn-gateway-connect-different-deployment-models-portal/vpnconnections.png "VPN-подключения")
4. В колонке **VPN-подключения типа «сеть-сеть»** щелкните имя сайта.

    ![Имя сайта](./media/vpn-gateway-connect-different-deployment-models-portal/sitetosite3.png "Имя локального сайта")
5. В колонке подключения для локального сайта щелкните его имя, чтобы открыть колонку **Локальный сайт**.

    ![Открытие локального сайта](./media/vpn-gateway-connect-different-deployment-models-portal/openlocal.png "Открытие локального сайта")
6. В колонке **Локальный сайт** замените IP-адрес VPN-шлюза IP-адресом шлюза Resource Manager.

    ![IP-адрес шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/gwipaddress.png "IP-адрес шлюза")
7. Нажмите кнопку **ОК**, чтобы обновить IP-адрес.


## <a name="a-nameconnectasection-4-create-the-connection"></a><a name="connect"></a>Раздел 4. Создание подключения
В этом разделе вы создадите подключение между виртуальными сетями. Для этого понадобится PowerShell. Это подключение невозможно создать на каком-либо из порталов. Убедитесь, что командлеты PowerShell Resource Manager и классические командлеты PowerShell установлены.

### <a name="part-1---log-in-to-your-azure-account"></a>Часть 1. Вход в учетную запись Azure

1. Запустите консоль PowerShell с повышенными правами и войдите в свою учетную запись Azure. Следующий командлет запрашивает учетные данные входа для вашей учетной записи Azure. После выполнения входа он скачивает параметры учетной записи, чтобы они были доступны в Azure PowerShell.
   
        Login-AzureRmAccount 
   
2. Если у вас есть несколько подписок, запросите их список.
   
        Get-AzureRmSubscription
   
3. Укажите подписку, которую нужно использовать. 
   
        Select-AzureRmSubscription -SubscriptionName "Name of subscription"

4. Добавьте свою учетную запись Azure, чтобы использовать классические командлеты PowerShell. Используйте для этого следующую команду:
   
        Add-AzureAccount

### <a name="part-2---download-your-network-configuration-file"></a>Часть 2. Скачивание файла конфигурации сети

Иногда при создании параметров классической виртуальной сети на портале Azure имена классических виртуальных сетей и сайтов локальной сети в файле конфигурации сети изменяются из-за различий в моделях развертывания. Например, с помощью портала Azure мы назвали классическую виртуальную сеть Classic VNet и создали ее в группе ресурсов ClassicRG. Имя, которое хранится в файле конфигурации сети, преобразуется в Group ClassicRG Classic VNet. Если указывается имя виртуальной сети с пробелами, заключите его в кавычки.

1. Экспортируйте файл конфигурации сети Azure, выполнив приведенную ниже команду. При необходимости можно изменить расположение файла для экспорта.
   
        Get-AzureVNetConfig -ExportToFile C:\AzureNet\NetworkConfig.xml
3. С помощью текстового редактора, например Блокнота, откройте XML-файл и просмотрите его содержимое. Проверьте значения имен классической виртуальной сети и сайта локальной сети.

### <a name="part-3---set-the-shared-key"></a>Часть 3. Обновление общего ключа

Установите общий ключ для подключения классической виртуальной сети к виртуальной сети Resource Manager. При использовании указанных командлетов обязательно проверьте значения `-VNetName` и `-LocalNetworkSiteName` в файле конфигурации сети. Если вы указываете имена с пробелами, заключите их в кавычки. 

- В данном примере имя классической виртуальной сети — `-VNetName`. 
- `-LocalNetworkSiteName` — имя, указанное для локального сайта.
- `-SharedKey` — это значение, которое следует создать и задать. В этом примере мы использовали *abc123*, но можно создать что-нибудь посложнее. Важно отметить, что заданное здесь значение должно совпадать со значением, которое вы укажете на следующем шаге при создании подключения.

Задайте общий ключ, выполнив приведенный ниже пример в консоли PowerShell. Обязательно замените указанные значения собственными. В результате выполнения этого примера должно отобразиться состояние **Успешно**.
   
        Set-AzureVNetGatewayKey -VNetName "Group ClassicRG ClassicVNet" `
        -LocalNetworkSiteName "172B9E16_RMVNetLocal" -SharedKey abc123
### <a name="part-4---create-the-vpn-connection-by-running-the-following-commands"></a>Часть 4. Создание VPN-подключения с помощью команд
   
1. Задайте переменные.
   
        $vnet01gateway = Get-AzureRMLocalNetworkGateway -Name ClassicVNetLocal -ResourceGroupName RG1
        $vnet02gateway = Get-AzureRmVirtualNetworkGateway -Name RMGateway -ResourceGroupName RG1
   
2. Создайте подключение. В этом примере `-Name` — имя, которое вы хотите присвоить подключению, а не имя уже созданного подключения. Следующий пример создает подключение RM-Classic. Обратите внимание, что `-ConnectionType` имеет значение IPsec, а не Vnet2Vnet, и что `-SharedKey` совпадает с ключом, который вы задали ранее.
   
        New-AzureRmVirtualNetworkGatewayConnection -Name RM-Classic -ResourceGroupName RG1 `
        -Location "East US" -VirtualNetworkGateway1 `
        $vnet02gateway -LocalNetworkGateway2 `
        $vnet01gateway -ConnectionType IPsec -RoutingWeight 10 -SharedKey 'abc123'

## <a name="section-5-verify-your-connections"></a>Раздел 5. Проверка подключений
Подключения можно проверить на портале Azure или с помощью PowerShell. При проверке может потребоваться подождать пару минут, пока подключение не будет создано. В случае успешного подключения его состояние изменится с "Подключение" на "Подключено".

### <a name="to-verify-the-connection-from-your-classic-vnet-to-your-resource-manager-vnet"></a>Проверка подключения классической виртуальной сети к виртуальной сети Resource Manager

####<a name="verify-your-connection-using-powershell"></a>Проверка подключения с помощью PowerShell


[!INCLUDE [vpn-gateway-verify-connection-ps-classic](../../includes/vpn-gateway-verify-connection-ps-classic-include.md)]

####<a name="verify-your-connection-using-the-azure-portal"></a>Проверка подключения с помощью портала Azure

[!INCLUDE [vpn-gateway-verify-connection-azureportal-classic](../../includes/vpn-gateway-verify-connection-azureportal-classic-include.md)]


###<a name="to-verify-the-connection-from-your-resource-manager-vnet-to-your-classic-vnet"></a>Проверка подключения виртуальной сети Resource Manager к классической виртуальной сети

####<a name="verify-your-connection-using-powershell"></a>Проверка подключения с помощью PowerShell

[!INCLUDE [vpn-gateway-verify-ps-rm](../../includes/vpn-gateway-verify-connection-ps-rm-include.md)]

####<a name="verify-your-connection-using-the-azure-portal"></a>Проверка подключения с помощью портала Azure

[!INCLUDE [vpn-gateway-verify-connection-portal-rm](../../includes/vpn-gateway-verify-connection-portal-rm-include.md)]

## <a name="a-namefaqavnet-to-vnet-considerations"></a><a name="faq"></a>Рекомендации по работе с подключением типа "виртуальная сеть — виртуальная сеть"

[!INCLUDE [vpn-gateway-vnet-vnet-faq](../../includes/vpn-gateway-vnet-vnet-faq-include.md)]




<!--HONumber=Jan17_HO4-->


