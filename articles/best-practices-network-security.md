<properties
   pageTitle="Облачные службы (Майкрософт) и сетевая безопасность | Microsoft Azure"
   description="Сведения о некоторых ключевых функциях, доступных в Azure для создания безопасных сетевых сред."
   services="virtual-network"
   documentationCenter="na"
   authors="tracsman"
   manager="rossort"
   editor=""/>

<tags
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="09/16/2015"
   ms.author="jonor;sivae"/>

# Облачные службы (Майкрософт) и сетевая безопасность

Облачные службы (Майкрософт) позволяют пользоваться масштабируемыми службами и инфраструктурой, возможностями корпоративного класса и множеством вариантов гибридных подключений. Клиенты могут обращаться к этим службам через Интернет напрямую или с помощью службы ExpressRoute, которая дает возможность создавать подключения к частной сети. Платформа Microsoft Azure позволяет клиентам легко добавлять в свою инфраструктуру облачные решения и создавать многоуровневую архитектуру. Сторонние производители могут расширять возможности служб корпорации Майкрософт, предоставляя службы безопасности и виртуальные устройства. В этом техническом документе мы предлагаем обзор вопросов, касающихся безопасности и архитектуры, которые необходимо учитывать при доступе к облачным службам (Майкрософт) через ExpressRoute и при создании безопасных служб в виртуальной сети Microsoft Azure.

## Выбор решения
Приведенная ниже логическая схема поможет вам выбрать конкретные примеры разнообразных методов обеспечения безопасности, доступных на платформе Microsoft Azure. Вы можете использовать эту схему, чтобы быстро найти самое нужное, или прочитать документ полностью, чтобы получить подробную информацию о многих доступных вариантах. ![Блок-схема вариантов системы безопасности][0]

[Пример 1 — защита приложений. Построение сети периметра с группами безопасности сети](#example-1-build-a-simple-dmz-with-nsgs)</br> [Пример 2 — защита приложений. Построение сети периметра с брандмауэром и группами безопасности сети](#example-2-build-a-dmz-to-protect-applications-with-a-firewall-and-nsgs)</br> [Пример 3 — защита сетей. Построение сети периметра с брандмауэром, определяемым пользователем маршрутом и группой безопасности сети](#example-3-build-a-dmz-to-protect-networks-with-a-firewall-udr-and-nsg)</br> [Пример 4 — добавление гибридного подключения типа «сеть-сеть» и виртуального VPN-устройства](#example-4-adding-a-hybrid-connection-with-a-site-to-site-virtual-appliance-vpn)</br> [Пример 5 — добавление гибридного подключения типа «сеть-сеть» и VPN-шлюза Azure](#example-5-adding-a-hybrid-connection-with-a-site-to-site-azure-gateway-vpn)</br> [Пример 6 — добавление гибридного подключения с использованием ExpressRoute](#example-6-adding-a-hybrid-connection-with-expressroute)</br> Примеры с добавлением подключений «виртуальная сеть — виртуальная сеть», повышением уровня доступности и цепочками служб будут внесены в этот документ в ближайшие месяцы.

## Соответствие нормативным требованиям и инфраструктурная защита
Корпорация Майкрософт является лидером в поддержке инициатив соответствия нормативным требованиям, которые важны для корпоративных клиентов. Ниже приведены некоторые сертификаты соответствия платформы Azure. ![Значки соответствия Azure][1]

Дополнительные сведения можно найти по адресу [http://azure.microsoft.com/support/trust-center/compliance/](http://azure.microsoft.com/support/trust-center/compliance/)

Корпорация Майкрософт использует комплексную защиту облачной инфраструктуры, на базе которой работают глобальные масштабируемые службы. В облачную инфраструктуру Майкрософт входят аппаратное и программное обеспечение, сети, административный и эксплуатационный персонал, а также физические центры обработки данных.

![Средства безопасности Azure][2]

Описанный выше подход гарантирует клиентам надежный фундамент для развертывания служб на платформе Microsoft Cloud. На его основе клиентам следует разработать и создать системы безопасности для защиты этих служб.

## Традиционные архитектуры систем безопасности и сети периметра
Корпорация Майкрософт вкладывает большие средства в защиту облачной инфраструктуры. Пользователи тоже должны принимать меры для защиты облачных служб и групп ресурсов. Многоуровневая защита является лучшим подходом к обеспечению безопасности. Сеть периметра (также называется демилитаризованной зоной или DMZ) защищает внутренние сетевые ресурсы от ненадежных сетей. Концепция DMZ широко используется в системах информационной безопасности корпоративных сетей. Сетью периметра называют периметр или сегмент сети, расположенный между Интернетом и защищенной ИТ-инфраструктурой предприятия.

В обычной корпоративной сети базовая инфраструктура хорошо защищена по всему периметру несколькими уровнями устройств безопасности. Границы каждого уровня состоят из устройств и точек реализации политики. Здесь могут использоваться брандмауэры, устройства предотвращения распределенных атак типа «отказ в обслуживании» (DDoS), системы обнаружения или предотвращения вторжений (IDS/IPS), устройства поддержки виртуальных частных сетей (VPN) и т. д. Реализация политики выполняется в форме политик брандмауэра, списков управления доступом или правил маршрутизации. Первый уровень защиты сети, напрямую контактирующий с входящим трафиком из Интернета, содержит определенное сочетание таких механизмов. Они должны блокировать атаки и вредоносный трафик, но пропускать в локальную сеть допустимые запросы. Допустимый трафик направляется к ресурсам в сети периметра. Эти ресурсы могут «общаться» с ресурсами, размещенными более глубоко в локальной сети, проходя при этом проверку на следующей границе сети. Самый внешний уровень именуется сетью периметра, поскольку эта часть сети имеет прямой контакт с Интернетом. Обычно системы защиты размещаются с обеих сторон от сети периметра. На следующем рисунке показан пример подсети DMZ в корпоративной сети, которая состоит из одной подсети и имеет два периметра безопасности (между DMZ и Интернетом и между DMZ и внутренней виртуальной сетью).

![Сеть периметра в корпоративной сети][3]

Существует много вариантов архитектуры сети периметра: от простого балансировщика нагрузки перед веб-фермой до нескольких подсетей с различными механизмами на каждой границе, призванными блокировать нежелательный трафик и защищать глубокие слои корпоративной сети. Структура сети периметра зависит от конкретных потребностей предприятия и допустимых уровней риска.

Пользователи постепенно переносят рабочие нагрузки в общедоступные облака. При этом крайне важно поддерживать в Azure такие же возможности, которые предоставляет концепция DMZ, чтобы соблюдать требования безопасности и стандартов. В этом документе мы приводим рекомендации о том, как создать в Azure безопасную сетевую среду. Основное внимание будем уделять сети периметра, но при этом подробно рассмотрим и многие другие аспекты безопасности сети. Вы получите ответы на следующие вопросы.

1.	Как построить сеть периметра в Azure?
2.	Какие функции для создания сети периметра есть в Azure?
3.	Как защитить серверную часть рабочей нагрузки?
4.	Как в Azure контролируется взаимодействие рабочих нагрузок с Интернетом?
5.	Как защитить локальные сети от развертывания в Azure?
6.	Когда лучше использовать собственные функции безопасности Azure, а когда — устройства или службы сторонних производителей?

На следующей схеме показаны различные уровни защиты, которые Azure предоставляет клиентам. Они могут быть реализованы в виде встроенных возможностей платформы Azure или определяемых пользователем компонентов.

![Архитектура безопасности Azure][4]

На входе из Интернета действует защита Azure от атак DDoS, которая отслеживает масштабные атаки на систему Azure. Трафик, прошедший через эту защиту, попадает на общедоступные конечные точки, определяемые пользователем. Конечные точки определяют, какой трафик можно передавать через облачную службу в виртуальную сеть. Виртуальная сеть Azure имеет встроенную систему изоляции от всех сетей. Трафик может поступать в нее только теми путями и методами, которые настроены пользователем. Эти пути и методы формируют следующий уровень защиты, на котором для защиты развернутых приложений создаются периметры безопасности, в том числе сети периметра, с применением сетевых групп безопасности (NSG), определяемых пользователем маршрутов (UDR) и виртуальных сетевых устройств.

Следующий раздел содержит обзор виртуальных сетей Azure. Виртуальные сети Azure создаются пользователями и используются для подключения развернутых рабочих нагрузок. Виртуальные сети являются основой всех функций сетевой безопасности, используемых для создания сети периметра для защиты клиентских развертываний в Azure.

## Общие сведения о виртуальных сетях Azure
Прежде чем интернет-трафик поступит в виртуальные сети Azure, он проходит два встроенных уровня безопасности платформы Azure.

1.	**Защита от атак DDoS**. Защиту от распределенных атак типа «отказ в обслуживании» (DDoS) выполняет уровень физической сети Azure. Он защищает платформу Azure от крупномасштабных атак через Интернет, при которых злоумышленники используют множество автоматизированных узлов для перегрузки интернет-службы. Платформа Azure надежно защищена от атак DDoS на всех интерфейсах, принимающих трафик из Интернета. Защита от атак DDoS не имеет параметров, настраиваемых пользователем, и этот уровень недоступен для клиентов. Он защищает от крупномасштабных атак всю платформу Azure в целом, но не будет защищать отдельные клиентские приложения. Для защиты от локализованных атак клиент может настроить дополнительные уровни устойчивости. Например, если общедоступная конечная точка клиента А подвергается крупномасштабной атаке DDoS, Azure заблокирует подключения к этой службе. Клиент А сможет восстановить предоставление службы через другую виртуальную сеть или другую конечную точку службы, которые не подвержены атаке. Следует отметить, что для клиента А изменится только работа этой конечной точки, а другие службы на других конечных точках будут работать как обычно. Кроме того, такая атака не повлияет на других клиентов и другие службы.
2.	**Конечные точки службы**. Конечные точки позволяют облачным службам или группам ресурсов использовать общедоступные (для всего Интернета) IP-адреса и порты. Входящий трафик они перенаправляют с помощью процесса преобразования сетевых адресов на внутренний адрес и порт в виртуальной сети Azure. Это основной путь передачи внешнего трафика в виртуальные сети Azure. Пользователь может настраивать конечные точки службы и указывать, какой трафик следует пропускать в виртуальную сеть, а также как и где его следует пропускать. 

При входе трафика в виртуальную сеть может применяться множество функций, так как виртуальные сети Azure являются основой для присоединения клиентских рабочих нагрузок и применения систем безопасности базовой сети. Они предоставляют клиенту Azure частную сеть (наложение виртуальной сети) со следующими функциями и характеристиками.
 
1.	**Изоляция трафика**. Виртуальная сеть на платформе Azure является границей изоляции трафика. Виртуальные машины в одной виртуальной сети не могут напрямую обращаться к виртуальным машинам в другой виртуальной сети, даже если обе виртуальные сети созданы одним клиентом. Это критически важное свойство, которое гарантирует, что виртуальные машины и все коммуникации клиента останутся закрытыми в пределах виртуальной сети. 
2.	**Многоуровневая топология**. Виртуальные сети позволяют клиентам сформировать многоуровневую топологию путем выделения подсетей и отдельных адресных пространств для различных элементов или «уровней» рабочих нагрузок. Эти логические группы и топологии позволяют определить различные политики доступа для разных типов рабочей нагрузки, а также контролировать потоки трафика между уровнями. 
3.	**Подключение между организациями**. Клиенты могут организовать соединение между виртуальной сетью и несколькими локальными сетями или другими виртуальными сетями Azure через VPN-шлюзы Azure или виртуальные сетевые устройства сторонних производителей. Azure поддерживает VPN типа «сеть-сеть» со стандартными протоколами IPsec/IKE, а также службу частного соединения ExpressRoute. 
4.	**Сетевая группа безопасности** (NSG) позволяет пользователям создавать правила (ACL) на разных уровнях детализации: сетевые интерфейсы, отдельные виртуальные машины или виртуальные подсети. Пользователи могут управлять доступом, разрешая или запрещая взаимодействия рабочих нагрузок друг с другом в пределах виртуальной сети, с клиентскими системами в сетях клиента через технологии связи между сетями, а также прямые взаимодействия через Интернет. 
5.	**Определяемые пользователем маршруты** (UDR) и **IP-пересылка** позволяют клиентам определять пути взаимодействия между разными уровнями виртуальной сети. Клиенты могут развернуть брандмауэр, устройство IDS/IPS или другое виртуальное устройство и направить через него сетевой трафик, что позволяет применять, контролировать и проверять политики периметра безопасности.
6.	**Виртуальные сетевые устройства** в магазине Azure. Устройства защиты, например брандмауэры, балансировщики нагрузки и службы обнаружения и предотвращения вторжений (IDS/IPS), доступны в магазине Azure и в коллекции образов виртуальных машин. Клиенты могут развернуть эти устройства в своих виртуальных сетях, в частности на периметрах безопасности (в том числе в подсетях DMZ), чтобы создать многоуровневую защищенную сетевую среду.

Давайте рассмотрим пример архитектуры сети периметра, которую можно создать в Azure с помощью этих функций и возможностей.

![Сеть периметра в виртуальной сети Azure][5]

## Характеристики сети периметра и требования к ней
В этом разделе описываются характеристики DMZ в Azure и требования к ним. Как упоминалось ранее, сеть периметра используется как интерфейс, осуществляющий прямое взаимодействие с Интернетом. Прежде чем попасть на внутренние серверы, входящие пакеты должны проходить через устройства безопасности: брандмауэры, IDS, IPS и другие устройства, расположенные в сети периметра. Пакеты, направленные в Интернет рабочими нагрузками, могут проходить также через защитные устройства сети периметра перед выходом из сети. Это полезно для применения политик, выполнения проверок и аудита. Кроме того, сети периметра могут использоваться для размещения VPN-шлюзов, соединяющих виртуальные сети клиента с локальными сетями.

### Характеристики сети периметра
Рассматривая приведенную выше схему DMZ в виртуальной сети Azure, выделим некоторые характеристики правильно построенной сети периметра.

- Внешняя (интерфейсная) граница сети периметра с Интернетом.
    - Подсеть DMZ имеет прямой выход в Интернет и непосредственную связь с Интернетом.
    - Общедоступные IP-адреса, виртуальные IP-адреса и (или) конечные точки передают интернет-трафик на интерфейсные сети и устройства.
    - Входящий трафик из Интернета проходит через устройства безопасности, прежде чем попасть на другие ресурсы интерфейсной сети.
    - Если включена политика безопасности исходящих подключений, трафик проходит через устройства безопасности на последнем шаге перед выходом в Интернет.
- Внутренняя граница на пути к базовой инфраструктуре (защищенная сеть).
    - Нет прямого пути из Интернета к базовой инфраструктуре.
    - Каналы связи с базовой инфраструктурой ОБЯЗАТЕЛЬНО проходят через устройства безопасности, такие как NSG, брандмауэры и VPN-устройства сети периметра.
    - Другие устройства сети периметра НЕ МОГУТ передавать трафик из Интернета к базовой инфраструктуре.
    - Устройства безопасности на границах сети периметра с Интернетом и защищенной сетью (на рисунке выше представлены двумя пиктограммами брандмауэров) фактически могут быть реализованы на одном виртуальном устройстве с различными правилами или интерфейсами для границы с Интернетом и внутренней границы (т. е. одно устройство логически разделяется для передачи трафика через обе границы сети периметра).
- Другие общие рекомендации и ограничения
    - Рабочие нагрузки в сети периметра НЕ МОГУТ хранить критически важную информацию.
    - Доступ для просмотра и обновления конфигураций и развертываний сети периметра имеют только авторизованные администраторы.

### Требования к сети периметра
В следующем списке приведены обобщенные требования к виртуальной сети, позволяющие создать успешную сеть периметра, которая будет обладать описанными выше характеристиками.

- Архитектура подсети. Определите виртуальную сеть таким образом, чтобы вся подсеть была выделена для сети периметра и отделена от других подсетей в той же виртуальной сети. Это позволит гарантировать, что трафик между сетью периметра и другими уровнями внутренних или частных подсетей будет проходить через брандмауэры или виртуальные устройства IDS и IPS, расположенные на границах подсетей, с применением определенных пользователем маршрутов.
- Группы безопасности сети (NSG) для DMZ. Сама подсеть сети периметра должна быть открытой, чтобы была возможна связь между сетью периметра и Интернетом, но это не значит, что не должны применяться группы безопасности сети. Широко распространенным способом снижения количества точек контакта с Интернетом является ограничение диапазонов адресов, с которых разрешен доступ к развертываниям и (или) определенным открытым протоколам и портам. Но не забывайте, что это не всегда возможно. Например, если в Azure размещен внешний веб-сайт клиента, сеть периметра должна пропускать входящие веб-запросы от любого общедоступного IP-адреса, но только на порты веб-приложения TCP:80 и TCP:443.
- Таблицы маршрутизации для сети периметра. Подсеть DMZ должна иметь возможность взаимодействовать с Интернетом напрямую, но не должна допускать прямой обмен данными с серверной частью или с локальными сетями в обход брандмауэра или устройства безопасности.
- Конфигурация устройств безопасности сети периметра. Устройства безопасности, выполняющие маршрутизацию и проверку пакетов, курсирующих между сетью периметра и другими сегментами защищенных сетей (например, брандмауэры, устройства IDS и IPS), могут настраиваться как многоадресные, то есть иметь отдельные сетевые адаптеры для сети периметра и внутренних подсетей. Сетевые адаптеры в сети периметра будут взаимодействовать непосредственно с Интернетом, в них будут использоваться сетевые группы безопасности и таблица маршрутизации сети периметра. Сетевые адаптеры, подключенные к внутренним подсетям, будут использовать более ограниченные сетевые группы безопасности и таблицы маршрутизации этих подсетей.
- Функциональные возможности устройств безопасности сети периметра. Устройства безопасности, развернутые в сети периметра, обычно выполняют следующие функции.
    - Брандмауэр — применяет правила брандмауэра или политики контроля доступа к входящим запросам.
    - Выявление и предотвращение угроз — обнаруживает вредоносные атаки из Интернета и снижает их опасность.
    - Аудит и ведение журнала — заносит подробную информацию в журналы для аудита и анализа.
    - Обратный прокси-сервер — перенаправляет входящие запросы на соответствующие тыловые серверы, сопоставляя и преобразовывая на интерфейсных устройствах сети периметра (обычно на брандмауэрах) адреса назначения в фактические адреса тыловых серверов.
    - Прокси-сервер переадресации — выполняет преобразование сетевых адресов, а также аудит взаимодействий, направленных из виртуальной сети в Интернет.
    - Маршрутизатор — перенаправляет прямой входящий и перекрестный трафик подсетей в виртуальной сети.
    - VPN-устройство — выполняет функции VPN-шлюзов для взаимодействия через VPN между локальными сетями клиента и виртуальными сетями Azure.
    - VPN-сервер — выполняет функции VPN-серверов, принимая подключения VPN-клиентов к виртуальной сети Azure.

>[AZURE.TIP]Управляйте пользователями, которым разрешен доступ к сети периметра, отдельно от пользователей, имеющих права администраторов по разработке, развертыванию и эксплуатации приложений. Разделение этих групп обеспечивает распределение обязанностей и не позволит одному человеку обойти одновременно систему безопасности приложений и систему безопасности сети.

### Важные вопросы при создании границ сети
Во всех случаях, если прямо не указано иное, при обсуждении «сетей Azure» в этом разделе любые сетевые термины (сети, виртуальные сети, подсети) обозначают частные виртуальные сети Azure, созданные администратором подписки, а не базовые физические сети платформы Azure.

Кроме того, виртуальные сети Azure часто используются для расширения традиционных локальных сетей. В архитектуры сетей периметра можно интегрировать и гибридные сетевые решения с технологиями «сеть-сеть» или ExpressRoute. Этот аспект важно учитывать при создании сетевых периметров безопасности, и он включен в приведенный ниже список вопросов.

Итак, вот три основных вопроса, на которые нужно ответить при создании сети с сетью периметра и несколькими периметрами безопасности.

#### 1) Сколько мне нужно периметров?
Первым делом важно определить, сколько нужно периметров безопасности в каждом конкретном случае.

- Один периметр: одна сеть периметра в качестве интерфейса между виртуальной сетью и Интернетом.
- Два периметра: один между Интернетом и сетью периметра, другой между подсетью сети периметра и внутренними подсетями виртуальной сети Azure.
- Три периметра: один между Интернетом и сетью периметра, один между DMZ и внутренними подсетями и еще один между внутренними подсетями и локальной сетью предприятия.
- N периметров: в зависимости от требований безопасности для конкретной сети может применяться любое количество периметров безопасности.

Количество и тип периметров будут зависеть от допустимого уровня риска для предприятия и характеристик конкретного сценария. Часто это решение совместно принимают несколько групп внутри организации, например отдел управления рисками и стандартами, отдел эксплуатации сети или платформы и команда разработчиков приложений. Важно привлечь к принятию этого решения людей с хорошим пониманием требований безопасности, используемых данных и технологий. Это позволит выбрать правильный подход к безопасности для каждого элемента инфраструктуры.

>[AZURE.TIP]Для каждого сценария лучшим решением будет наименьшее количество периметров, соответствующее требованиям безопасности. Чем больше периметров, тем сложнее будет эксплуатация и отладка системы. Кроме того, управление большим количеством периметров потребует более высоких административных расходов. При этом недостаточное количество периметров повышает риск. Важно найти идеальный баланс.

![Гибридная сеть с тремя периметрами безопасности][6]

Приведенный выше рисунок содержит обобщенную схему сети с тремя периметрами безопасности. Один из периметров расположен между Интернетом и сетью периметра, один — между частными подсетями переднего плана Azure и частными внутренними подсетями Azure и еще один — между внутренними подсетями Azure и локальной сетью предприятия.

#### 2) Где расположить периметры?
После выбора количества периметров следует решить, где они будут расположены. Обычно существует три варианта: 1) использовать промежуточную интернет-службу (например, облачный брандмауэр веб-приложения, который не рассматривается в этом документе); 2) использовать собственные функции и (или) виртуальные сетевые устройства Azure; 3) использовать физические устройства в локальной сети.

В сетях Azure выбор делается между собственными функциями Azure (например, подсистемы балансировки нагрузки Azure) и виртуальными сетевыми устройствами из экосистемы партнеров Azure (например, брандмауэры Check Point).

Если вам нужен периметр между Azure и локальной сетью, устройства безопасности могут находиться на любой стороне подключения (или на обеих сразу). Таким образом, нужно принять решение о месте размещения инфраструктуры безопасности.

На приведенном выше рисунке периметры между Интернетом и DMZ и между интерфейсными и внутренними сегментами располагаются полностью внутри Azure. Следовательно, это должны быть собственные функции Azure или виртуальные сетевые устройства. На периметре между внутренней подсетью Azure и корпоративной сетью предприятия устройства безопасности могут располагаться на стороне Azure или на стороне локальной сети. Можно даже сочетать устройства, размещенные на обеих сторонах. Каждое из решений может иметь существенные преимущества и недостатки, которые следует тщательно взвесить.

Рассмотрим, например, использование существующей физической инфраструктуры безопасности на стороне локальной сети. Достоинства: не требуется новая инфраструктура, достаточно обновить настройки. Недостатки: весь трафик должен быть передан из Azure в локальную сеть, чтобы его могли контролировать устройства безопасности. При этом трафик между разными сегментами сети Azure придется передавать в локальную сеть для применения политик безопасности. Это может привести к значительным задержкам трафика и отрицательно повлиять на производительность приложений и на качество взаимодействия с пользователем.

#### 3) Как будут реализованы периметры?
Для каждого периметра безопасности будут применяться различные функциональные требования (например, на интерфейсе между Интернетом и сетью периметра потребуются устройства IDS и правила брандмауэров, а между внутренней подсетью и сетью периметра будет достаточно списков управления доступом). Решение об используемых устройствах зависит от конкретного сценария и требований безопасности. Ниже в примерах сетей периметра 1, 2 и 3 описаны некоторые из возможных вариантов. Изучив встроенные функции сети Azure и возможности доступных для Azure устройств экосистемы партнеров, вы найдете множество других вариантов, которые позволят подобрать решение практически для любого сценария.

Еще одним важным вопросом является метод подключения локальной сети к Azure. Вы можете использовать виртуальный шлюз Azure или виртуальное сетевое устройство. Эти варианты подробно описываются и обсуждаются ниже в примерах 4, 5 и 6.

Кроме того, может потребоваться передача трафика между разными виртуальными сетями Azure. Эти сценарии рассматриваются более подробно в примерах 7 и 8.

Когда будут готовы ответы на эти вопросы, раздел [Выбор решения](#fast-start) выше поможет вам определить, какие примеры лучше всего подходят для вашего сценария.

## Создание периметра безопасности для виртуальных сетей Azure
### Пример 1. Построение простой сети периметра с группами безопасности сети
[Вернуться к выбору решения](#fast-start) | [Подробные инструкции по построению для этого примера][Example1]

![Входящая сеть периметра с группой безопасности сети][7]

#### Описание среды
В этом примере используется подписка, которая содержит такие компоненты:

- две облачные службы: FrontEnd001 и BackEnd001;
- виртуальная сеть CorpNetwork с двумя подсетями (FrontEnd и BackEnd);
- одна группа безопасности сети, которая применяется к обеим подсетям;
- сервер Windows Server, который представляет веб-сервер приложений (IIS01);
- два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
- сервер Windows Server, который представляет DNS-сервер (DNS01).

Дополнительные сведения о создании системы из этого примера (со скриптами и шаблонами ARM) размещены на странице [Подробные инструкции по построению][Example1].

#### Описание группы безопасности сети (NSG)
В этом примере создается группа безопасности сети, после чего в нее загружаются шесть правил.

>[AZURE.TIP]В общем, сначала создаются конкретные правила разрешения, а затем более общие правила запрета. Порядок выполнения правил задается назначенным приоритетом. Когда система находит правило, применимое к пакету трафика, остальные правила игнорируются. Правила группы безопасности сети могут применяться ко входящему или исходящему трафику (относительно подсети).

Декларативно для входящего трафика определяются следующие правила.

1.	Внутренний трафик DNS (порт 53) разрешается.
2.	Трафик RDP (порт 3389) из Интернета к любой виртуальной машине разрешается.
3.	Трафик HTTP (порт 80) из Интернета к веб-серверу (IIS01) разрешается.
4.	Весь трафик (все порты) от сервера IIS01 к серверу AppVM1 разрешается.
5.	Весь трафик (все порты) из Интернета ко всей виртуальной сети (обе подсети) запрещается.
6.	Весь трафик (все порты) из подсети FrontEnd в подсеть BackEnd запрещается.

Эти правила применяются для каждой подсети. Поступающий из Интернета HTTP-запрос к веб-серверу соответствует правилам 3 (разрешить) и 5 (запретить). Так как правило 3 имеет более высокий приоритет, будет применено только оно, а до правила 5 очередь не дойдет. Таким образом, HTTP-запрос сможет достичь веб-сервера. Если тот же трафик будет направлен к серверу DNS01, сначала будет применено правило 5 (запретить), поэтому трафик не сможет достичь сервера. Правило 6 (запретить) блокирует трафик из подсети FrontEnd в подсеть BackEnd (за исключением трафика, разрешенного правилами 1 и 4). Это позволяет защитить сеть BackEnd при компрометации веб-приложения на сервере FrontEnd. В этом случае злоумышленник получит ограниченный доступ к «защищенной» сети BackEnd (только к ресурсам, предоставляемым на сервере AppVM01).

Для исходящего трафика стандартное правило разрешает любой трафик в Интернет. В этом примере мы разрешаем исходящий трафик и не меняем для него никаких правил. Чтобы заблокировать трафик в обоих направлениях, требуется определенная пользователем маршрутизация. Этот момент рассмотрен в примере 3 ниже.

#### Заключение
Это относительно простой и эффективный способ изоляции внутренней подсети от входящего трафика. Вы можете получить такие дополнительные сведения об этом примере:

- Создание такой сети периметра с помощью сценариев PowerShell.
- Создание такой сети периметра с использованием шаблона ARM.
- Подробное описание каждой команды NSG.
- Подробные сценарии прохождения трафика с демонстрацией разрешений и запретов на каждом уровне.

Эту информацию вы найдете на странице [Подробные инструкции по построению][Example1].

### Пример 2 — защита приложений. Построение сети периметра с брандмауэром и группами безопасности сети
[Вернуться к выбору решения](#fast-start) | [Подробные инструкции по построению для этого примера][Example2]

![Входящая сеть периметра с виртуальным сетевым устройством и группой безопасности сети][8]

#### Описание среды
В этом примере используется подписка, которая содержит такие компоненты:

- две облачные службы: FrontEnd001 и BackEnd001;
- виртуальная сеть CorpNetwork с двумя подсетями (FrontEnd и BackEnd);
- одна группа безопасности сети, которая применяется к обеим подсетям;
- виртуальное сетевое устройство, которое в этом примере является брандмауэром, подключенным к подсети FrontNet;
- сервер Windows Server, который представляет веб-сервер приложений (IIS01);
- два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
- сервер Windows Server, который представляет DNS-сервер (DNS01).

Дополнительные сведения о создании системы из этого примера (со скриптами и шаблонами ARM) размещены на странице [Подробные инструкции по построению][Example2].

#### Описание группы безопасности сети (NSG)
В этом примере создается группа безопасности сети, после чего в нее загружаются шесть правил.

>[AZURE.TIP]В общем, сначала создаются конкретные правила разрешения, а затем более общие правила запрета. Порядок выполнения правил задается назначенным приоритетом. Когда система находит правило, применимое к пакету трафика, остальные правила игнорируются. Правила группы безопасности сети могут применяться ко входящему или исходящему трафику (относительно подсети).

Далее следует описание правил, создаваемых для входящего трафика.

1.	Внутренний трафик DNS (порт 53) разрешается.
2.	Трафик RDP (порт 3389) из Интернета к любой виртуальной машине разрешается.
3.	Весь трафик (все порты) из Интернета к серверу NVA (брандмауэр) разрешается.
4.	Весь трафик (все порты) от сервера IIS01 к серверу AppVM1 разрешается.
5.	Весь трафик (все порты) из Интернета ко всей виртуальной сети (обе подсети) запрещается.
6.	Весь трафик (все порты) из подсети FrontEnd в подсеть BackEnd запрещается.

Эти правила применяются для каждой подсети. Поступающий из Интернета HTTP-запрос к брандмауэру соответствует правилам 3 (разрешить) и 5 (запретить). Так как правило 3 имеет более высокий приоритет, будет применено только оно, а до правила 5 очередь не дойдет. Таким образом, запрос HTTP сможет достичь брандмауэра. Если такой же трафик будет направлен к серверу IIS01, расположенному в сети переднего плана, будет применено правило 5 (запретить), поэтому трафик не сможет достичь сервера. Правило 6 (запретить) блокирует трафик из подсети FrontEnd в подсеть BackEnd (за исключением трафика, разрешенного правилами 1 и 4). Это позволяет защитить сеть BackEnd при компрометации веб-приложения на сервере FrontEnd. В этом случае злоумышленник получит ограниченный доступ к «защищенной» сети BackEnd (только к ресурсам, предоставляемым на сервере AppVM01).

Для исходящего трафика стандартное правило разрешает любой трафик в Интернет. В этом примере мы разрешаем исходящий трафик и не меняем для него никаких правил. Чтобы заблокировать трафик в обоих направлениях, требуется определенная пользователем маршрутизация. Этот момент рассмотрен в примере 3 ниже.

#### Описание правил брандмауэра
В брандмауэре необходимо создать правила пересылки. Поскольку в этом примере входящий трафик только пересылается на брандмауэр, а затем на веб-сервер, потребуется только одно правило перенаправления NAT.

Это правило перенаправления принимает входящий трафик с любых адресов на HTTP-порты (порт 80 и порт 443 для HTTPS), приходящий на брандмауэр, и отправляет его через локальный сетевой интерфейс брандмауэра на веб-сервер с IP-адресом 10.0.1.5.

#### Заключение
Это относительно простой способ защиты приложения с помощью брандмауэра и изоляции внутренней подсети от входящего трафика. Вы можете получить такие дополнительные сведения об этом примере:

- Как создать такую сеть периметра с помощью сценариев PowerShell.
- Как создать такую сеть периметра с использованием шаблона ARM.
- Подробное описание каждой команды и правила брандмауэра группы безопасности сети.
- Подробные сценарии прохождения трафика с демонстрацией разрешений и запретов на каждом уровне.

Эту информацию вы найдете на странице [Подробные инструкции по построению][Example2].

### Пример 3 — защита сетей. Построение сети периметра с брандмауэром, определяемым пользователем маршрутом и группой безопасности сети
[Вернуться к выбору решения](#fast-start) | [Подробные инструкции по построению для этого примера][Example3]

![Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами][9]

#### Настройка среды
В этом примере используется подписка, которая содержит такие компоненты:

- три облачные службы: SecSvc001, FrontEnd001 и BackEnd001;
- виртуальная сеть CorpNetwork с тремя подсетями (SecNet, FrontEnd и BackEnd);
- виртуальное сетевое устройство, которое в этом примере является брандмауэром, подключенным к подсети SecNet;
- сервер Windows Server, который представляет веб-сервер приложений (IIS01);
- два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
- сервер Windows Server, который представляет DNS-сервер (DNS01).

Дополнительные сведения о создании системы из этого примера (со скриптами и шаблонами ARM) размещены на странице [Подробные инструкции по построению][Example3].

#### Описание определяемых пользователем маршрутов (UDR)
По умолчанию следующие системные маршруты определяются так:

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

VNETLocal всегда является префиксом адресов виртуальной сети для конкретной сети (т. е. он будет изменяться для каждой виртуальной сети в зависимости от способа ее определения). Остальные системные маршруты статические и заданы по умолчанию, как указано в таблице выше.

В этом примере создаются две таблицы маршрутизации, одна для подсети переднего плана и одна для внутренней подсети. В каждую таблицу загружены статические маршруты для данной подсети. В каждой таблице есть три маршрута, которые направляют весь трафик (0.0.0.0/0) через брандмауэр (следующий прыжок = IP-адрес виртуального устройства).

1. Для трафика локальной подсети значение следующего прыжка не указано, что позволяет трафику локальной подсети обходить брандмауэр.
2. Для трафика виртуальной сети значением следующего прыжка установлен адрес брандмауэра. Это значение переопределяет правило по умолчанию, которое разрешает прямое прохождение трафика виртуальной локальной сети.
3. Для всего остального трафика (0/0) значением следующего прыжка задан адрес брандмауэра.

После создания таблиц маршрутизации они привязываются к соответствующим подсетям. После создания и привязки таблица маршрутизации подсети переднего плана FrontEnd будет выглядеть так.

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active 
		 {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active

>[AZURE.NOTE]Сейчас существуют ограничения по использованию определяемых пользователем маршрутов и гибридных сетей. Эта проблема будет снята в последующих выпусках. Примеры использования сети периметра с ExpressRoute или соединениями типа «сеть-сеть» описаны ниже, в примерах 3 и 4.

#### Описание IP-пересылки
Определяемые пользователем маршруты всегда используются вместе с функцией IP-пересылки. Это параметр для виртуального устройства, который позволяет принимать не адресованный устройству трафик и пересылать его конечному получателю.

Например, если поступает трафик от AppVM01 с запросом к серверу DNS01, определяемый пользователем маршрут направит такой трафик на брандмауэр. При включенной IP-пересылке трафик с указанным назначением DNS01 (10.0.2.4) будет принят устройством (10.0.0.4) и затем передан конечному получателю (10.0.2.4). Если IP-пересылка на брандмауэре не разрешена, такой трафик не будет принят устройством, даже если в качестве следующего прыжка в таблице маршрутизации указан брандмауэр. Для использования виртуального устройства важно не забыть включить IP-пересылку и определяемые пользователем маршруты.

#### Описание группы безопасности сети (NSG)
В этом примере создается группа безопасности сети, после чего в нее загружается одно правило. Затем эта группа привязывается только к подсетям Frontend и Backend (не SecNet). Декларативно создается следующее правило:

1.	Весь трафик (все порты) из Интернета ко всей виртуальной сети (все подсети) запрещается.

В этом примере используются группы безопасности сети, но его основной целью является создание дополнительного уровня защиты от неправильной настройки вручную. Нам нужно заблокировать весь входящий трафик из Интернета к подсетям Frontend и Backend. Трафик должен проходить только через подсеть SecNet к брандмауэру (а затем — в подсеть Frontend или Backend, при наличии таковых). Кроме того, если установлены правила определяемых пользователем маршрутов, любой трафик, поступивший в подсети Frontend и Backend, будет направляться на брандмауэр (благодаря наличию определяемых пользователем маршрутов). Брандмауэр воспримет это как асимметричный поток и отбросит исходящий трафик. Следовательно, существует три уровня безопасности для защиты подсетей Frontend и Backend: 1) отсутствие открытых конечных точек в облачных службах FrontEnd001 и BackEnd001, 2) группы безопасности сети, запрещающие трафик из Интернета, 3) брандмауэр, отбрасывающий асимметричный трафик.

В этом примере есть интересная особенность, касающаяся сетевой группы безопасности. В нем содержится только одно правило, которое запрещает трафик из Интернета ко всей виртуальной сети, включая подсеть безопасности. Однако, так как сетевая группа безопасности привязана только к подсети переднего плана и внутренней подсети, это правило не применяется к входящему трафику подсети безопасности. В результате трафик будет попадать в подсеть безопасности, поскольку правило сетевой группы безопасности, запрещающее интернет-трафик на любой адрес виртуальной сети, не было привязано к подсети безопасности.

#### Правила брандмауэра
В брандмауэре необходимо создать правила пересылки. Так как брандмауэр блокирует или пересылает весь входящий, исходящий и внутренний трафик виртуальной сети, требуется много правил брандмауэра. Кроме того, весь входящий трафик будет попадать на общедоступный IP-адрес службы безопасности (на разных портах) для последующей обработки брандмауэром. Прежде чем настраивать подсети и правила брандмауэра, рекомендуем составить схему логических потоков, чтобы избежать переделывания позже. Следующий рисунок является логическим представлением правил брандмауэра для этого примера.
 
![Логическое представление правил брандмауэра][10]

>[AZURE.NOTE]Порты управления будут различными в зависимости от используемого виртуального сетевого устройства. В этом примере брандмауэр Barracuda NG Firewall использует порты 22, 801 и 807. Обратитесь к документации поставщика устройства, чтобы точно знать, какие порты используются для управления устройством.

#### Описание правила брандмауэра
На приведенной выше логической схеме не отображена подсеть безопасности, так как брандмауэр является единственным ресурсом в этой подсети. Кроме того, вместо фактического пути маршрутизации на схеме показаны правила брандмауэра и логика разрешения или запрета трафика. Кроме того, внешние порты, выбранные для трафика RDP, являются портами высшего диапазона (8014–8026) и выбраны для совмещения с последними двумя октетами локального IP-адреса для облегчения чтения (например, адрес локального сервера 10.0.1.4 связан с внешним портом 8014). Тем не менее можно использовать любые неконфликтующие порты высшего диапазона.

В этом примере нам нужно 7 типов правил. Их описание приведено ниже.

- Внешние правила (для входящего трафика):
  1.	Правило управления брандмауэром. Это правило перенаправления приложения разрешает пересылать трафик на порты управления виртуального сетевого устройства.
  2.	Правила RDP (для каждого сервера Windows Server). Эти четыре правила (по одному для каждого сервера) позволяют управлять серверами через RDP. Эти правила можно объединить в одно, если виртуальное сетевое устройство поддерживает такую возможность.
  3.	Правила трафика приложений. Существует два правила трафика приложений: первое — для веб-трафика подсети переднего плана, а второе — для трафика внутренней подсети (например, от веб-сервера к уровню данных). Параметры этих правил будут зависеть от архитектуры сети размещения серверов и характеристик потоков трафика (направление потока и используемые порты).
      - Первое правило позволяет фактическому трафику приложения достигать сервера приложений. Другие правила нужны для безопасности, управления и т. д., а правила приложений позволяют внешним пользователям и службам взаимодействовать с приложениями. В этом примере используется один веб-сервер на порту 80, поэтому на брандмауэре потребуется одно правило приложения. Оно принимает трафик, поступающий на внешний IP-адрес, и переправляет его на внутренний IP-адрес веб-серверов. Затем этот трафик обрабатывается службой NAT (преобразование сетевых адресов) и передается на внутренний сервер.
      - Второе правило трафика приложения используется для внутренней подсети. Оно разрешает веб-серверу обращаться к серверу AppVM01 (но не AppVM02) через любой порт.
- Внутренние правила (для внутреннего трафика виртуальной сети)
  4.	Правило трафика, исходящего в Интернет. Это правило разрешает передачу трафика из любой сети в указанные сети. Обычно это правило является заданным в брандмауэре по умолчанию и при этом отключенным. В нашем примере это правило следует активировать.
  5.	Правило DNS. Это правило разрешает передавать на DNS-сервер только трафик DNS (на порт 53). Для этой среды блокируется почти весь трафик от подсети Frontend к Backend, а это правило отдельно разрешает трафик DNS из любой локальной подсети.
  6.	Правило трафика между подсетями. Это правило позволяет любому серверу внутренней подсети подключаться к любому серверу в подсети переднего плана (но не наоборот).
- Резервное правило (для трафика, который не соответствует указанным выше правилам).
  7.	Правило запрета любого трафика. Это правило всегда должно быть последним (по приоритету). Если трафик не соответствует ни одному из предыдущих правил, этим правилом он будет отброшен. Это правило обычно уже установлено по умолчанию и активировано, поэтому не требует дополнительных действий.

>[AZURE.TIP]Второе правило трафика приложения разрешает трафик на любой порт (для упрощения примера). В реальной системе следует использовать как можно более узкие диапазоны портов и адресов, чтобы снизить площадь поражения от атак, обусловленных применением этого правила.

После создания всех приведенных выше правил обязательно проверьте приоритет каждого правила, чтобы разрешения и запреты трафика выполнялись надлежащим образом. В нашем примере правила расположены в порядке приоритета.

#### Заключение
Этот способ сложнее, но предоставляет более полную защиту и изоляцию сети (пример 2 защищает только приложения, а пример 1 только выполняет изоляцию подсетей). Такая схема позволяет контролировать трафик, идущий в обоих направлениях. Она не только защищает сервер приложений от входящего трафика, но и применяет политику сетевой безопасности для всех серверов в сети. Кроме того, если позволяет используемое устройство, может осуществляться полный аудит и контроль трафика. Вы можете получить такие дополнительные сведения об этом примере:

- Как создать такую сеть периметра с помощью сценариев PowerShell.
- Как создать такую сеть периметра с использованием шаблона ARM.
- Подробное описание каждой команды UDR, NSG и правил брандмауэра.
- Подробные сценарии прохождения трафика с демонстрацией разрешений и запретов на каждом уровне.

Эту информацию вы найдете на странице [Подробные инструкции по построению][Example3].

### Пример 4 — добавление гибридного подключения типа «сеть-сеть» и виртуального VPN-устройства
[Вернуться к выбору решения](#fast-start) | Подробные инструкции по построению ожидаются в ближайшее время

![Сеть периметра с гибридной сетью, подключенной через виртуальное сетевое устройство][11]

#### Настройка среды
Гибридная сеть, использующая виртуальное сетевое устройство, может быть добавлена к сети периметра любого из предыдущих примеров (1, 2 или 3).

Как показано на приведенном выше рисунке, VPN-подключение через Интернет (типа «сеть-сеть») выполняется через виртуальное сетевое устройство для подключения локальной сети к виртуальной сети Azure.

>[AZURE.NOTE]Если вы используете ExpressRoute с включенным открытым пирингом Azure, следует создать статический маршрут, чтобы запросы на IP-адрес виртуального сетевого VPN-устройства направлялись через границу с Интернетом, а не через границу ExpressRoute WAN. Это связано с тем, что для работы открытого пиринга ExpressRoute Azure требуется преобразование сетевых адресов (NAT), чтобы прерывать сеансы VPN (набор IPSec обычно плохо взаимодействует с NAT).

После подключения VPN виртуальное сетевое устройство становится центральным «концентратором» для всех сетей и подсетей. Правила пересылки брандмауэра определяют, какие потоки трафика пропускаются, какие направляются через NAT, какие перенаправляются или отбрасываются (даже для трафика между локальной сетью и Azure, если потоки направлены таким образом).

Потоки трафика следует тщательно планировать, так как такая схема сети может их оптимизировать или ухудшить в зависимости от конкретного сценария использования.

Мы возьмем среду, созданную в примере 3 «Защита сетей. Построение сети периметра с брандмауэром, определяемыми пользователем маршрутами и группами безопасности сети», и добавим к ней гибридное сетевое VPN-подключение типа «сеть-сеть», что даст нам следующую структуру.

![Сеть периметра с виртуальным сетевым устройством и VPN-подключением типа «сеть-сеть»][12]

В приведенной выше схеме роль VPN-клиента будет выполнять локальный маршрутизатор или другое сетевое устройство, совместимое с виртуальным сетевым VPN-устройством. Это физическое устройство будет выполнять запуск и поддержание VPN-подключения с вашим виртуальным сетевым устройством.

С точки зрения виртуального сетевого устройства сеть логически разделена на четыре отдельные «зоны безопасности», а трафик между этими зонами контролируется в основном правилами, установленными на виртуальном сетевом устройстве. Логически это выглядит следующим образом.

![Логическая сеть с точки зрения виртуального сетевого устройства][13]

#### Заключение
Создав в виртуальной сети Azure гибридное сетевое VPN-подключение типа «сеть-сеть», вы можете безопасно добавить сеть Azure к своей локальной сети. VPN-подключение шифрует весь трафик и передает его через Интернет. Как показано в этом примере, виртуальное сетевое устройство становится центральной точкой применения и контроля политики безопасности. Вы можете получить такие дополнительные сведения об этом примере:

- Как создать такую сеть периметра с помощью сценариев PowerShell.
- Как создать такую сеть периметра с использованием шаблона ARM.
- Подробные сценарии потоков трафика, демонстрирующие прохождение трафика через эту схему сети.

Ссылка на эту информацию будет скоро доступна на этой странице.

### Пример 5 — добавление гибридного подключения типа «сеть-сеть» и VPN-шлюза Azure
[Вернуться к выбору решения](#fast-start) | Подробные инструкции по построению ожидаются в ближайшее время

![Сеть периметра с гибридной сетью, подключенной через шлюз][14]

#### Настройка среды
Гибридная сеть, использующая VPN-шлюз Azure, может быть добавлена к сети периметра, описанной в примере 1 или 2.

Как показано на приведенном выше рисунке, VPN-подключение через Интернет (типа «сеть-сеть») выполняется через VPN-шлюз Azure для подключения локальной сети к виртуальной сети Azure.

>[AZURE.NOTE]Если вы используете ExpressRoute с включенным открытым пирингом Azure, следует создать статический маршрут, чтобы запросы на IP-адрес VPN-шлюза Azure направлялись через границу с Интернетом, а не через границу ExpressRoute WAN. Это связано с тем, что для работы открытого пиринга ExpressRoute Azure требуется преобразование сетевых адресов (NAT), чтобы прерывать сеансы VPN (набор IPSec обычно плохо взаимодействует с NAT).

Как показано ниже, в этом варианте среды сеть имеет две границы. На первой границе виртуальное сетевое устройство и группы безопасности сети управляют потоками трафика между сетями Azure и между Azure и Интернет. VPN-шлюз Azure выполняет роль второй границы сети, полностью отделенной и изолированной, через которую Azure соединяется с локальной сетью.

Потоки трафика следует тщательно планировать, так как такая схема сети может их оптимизировать или ухудшить в зависимости от конкретного сценария использования.

Мы возьмем среду, созданную в примере 1 «Защита приложений. Построение простой сети периметра с группами безопасности сети», и добавим к ней гибридное сетевое VPN-подключение типа «сеть-сеть», что даст нам следующую структуру.

![Сеть периметра со шлюзом и подключением ExpressRoute][15]

#### Заключение
Создав в виртуальной сети Azure гибридное сетевое VPN-подключение типа «сеть-сеть», вы можете безопасно добавить сеть Azure к своей локальной сети. Встроенный VPN-шлюз Azure шифрует весь трафик по протоколу IPSec и передает его через Интернет. Кроме того, VPN-шлюз Azure может оказаться более бюджетным решением (не потребуются дополнительные затраты на лицензии сторонних производителей виртуальных сетевых устройств). Для сети из примера 1, в которой не используются виртуальные сетевые устройства, этот вариант будет самым экономичным. Вы можете получить такие дополнительные сведения об этом примере:

- Как создать такую сеть периметра с помощью сценариев PowerShell.
- Как создать такую сеть периметра с использованием шаблона ARM.
- Подробные сценарии потоков трафика, демонстрирующие прохождение трафика через эту схему сети.

Ссылка на эту информацию будет скоро доступна на этой странице.

### Пример 6 — добавление гибридного подключения с использованием ExpressRoute
[Вернуться к выбору решения](#fast-start) | Подробные инструкции по построению ожидаются в ближайшее время

![Сеть периметра с гибридной сетью, подключенной через шлюз][16]

#### Настройка среды
Гибридную сеть, использующую частный пиринг ExpressRoute, можно добавить к сети периметра, описанной в примере 1 или 2.

Как показано на рисунке выше, частный пиринг ExpressRoute позволяет создавать прямое подключение между локальной сетью и виртуальной сетью Azure. Трафик проходит только через сеть поставщика службы и сеть Microsoft Azure, не выходя в Интернет.

>[AZURE.NOTE]Из-за сложности динамической маршрутизации, используемой на виртуальном шлюзе Azure, существует ограничение по использованию определяемых пользователем маршрутов и ExpressRoute. К подсетям, которые связываются со шлюзом Azure, обеспечивающим соединение ExpressRoute, не должны применяться определяемые пользователем маршруты. Кроме того, шлюз Azure не может быть указан в качестве следующего прыжка в определяемых пользователем маршрутах для других подсетей. В следующем выпуске Azure будет включена возможность полностью интегрировать определяемые пользователем маршруты с ExpressRoute.

</br>
>[AZURE.TIP]ExpressRoute не передает корпоративный трафик через Интернет, благодаря чему повышает уровень безопасности, значительно увеличивает производительность и позволяет использовать соглашения об уровне обслуживания поставщика службы ExpressRoute. Что касается производительности ExpressRoute, шлюз Azure может передавать через ExpressRoute до 2 Гбит/с, тогда как максимальная пропускная способность шлюза Azure при работе через VPN-шлюз типа «сеть-сеть» составляет 200 Мбит/с.

Как показано на схеме ниже, в этом варианте среды сеть имеет две границы. На первой границе виртуальное сетевое устройство и группы безопасности сети управляют потоками трафика между сетями Azure и между Azure и Интернетом. Шлюз выполняет роль второй границы сети, полностью отделенной и изолированной, через которую Azure соединяется с локальной сетью.

Потоки трафика следует тщательно планировать, так как такая схема сети может их оптимизировать или ухудшить в зависимости от конкретного сценария использования.

Мы возьмем среду, созданную в примере 1 «Построение простой сети периметра с группами безопасности сети», и добавим к ней гибридное сетевое подключение ExpressRoute, что даст нам следующую структуру.

![Сеть периметра со шлюзом и подключением ExpressRoute][17]

#### Заключение
Добавив сетевое подключение частного пиринга ExpressRoute, вы можете безопасно подключить Azure к своей локальной сети. Этот метод снижает задержки и повышает производительность подключения. Также встроенный VPN-шлюз Azure может оказаться более бюджетным решением, как в нашем примере (не потребуются дополнительные затраты на лицензии сторонних производителей виртуальных сетевых устройств). Вы можете получить такие дополнительные сведения об этом примере:

- Как создать такую сеть периметра с помощью сценариев PowerShell.
- Как создать такую сеть периметра с использованием шаблона ARM.
- Подробные сценарии потоков трафика, демонстрирующие прохождение трафика через эту схему сети.

Ссылка на эту информацию будет скоро доступна на этой странице.

## Ссылки
### Полезные веб-сайты и документация
- Доступ к Azure с использованием ARM: 
- Доступ к Azure с помощью PowerShell: [https://azure.microsoft.com/documentation/articles/powershell-install-configure/](./powershell-install-configure.md)
- Документация по виртуальной сети: [https://azure.microsoft.com/documentation/services/virtual-network/](https://azure.microsoft.com/documentation/services/virtual-network/)
- Документация по группам безопасности сети: [https://azure.microsoft.com/documentation/articles/virtual-networks-nsg/](./virtual-network/virtual-networks-nsg.md)
- Документация по определяемым пользователем маршрутам: [https://azure.microsoft.com/documentation/articles/virtual-networks-udr-overview/](./virtual-network/virtual-networks-udr-overview.md)
- Виртуальные шлюзы Azure: [https://azure.microsoft.com/documentation/services/vpn-gateway/](https://azure.microsoft.com/documentation/services/vpn-gateway/)
- VPN типа «сеть-сеть»: [https://azure.microsoft.com/documentation/articles/vpn-gateway-site-to-site-create/](./virtual-network/vpn-gateway-site-to-site-create.md)
- Документация ExpressRoute (обязательно ознакомьтесь с разделами «Приступая к работе» и «Инструкции»): [https://azure.microsoft.com/documentation/services/expressroute/](https://azure.microsoft.com/documentation/services/expressroute/)

<!--Image References-->
[0]: ./media/best-practices-network-security/flowchart.png "Блок-схема вариантов системы безопасности"
[1]: ./media/best-practices-network-security/compliancebadges.png "Значки соответствия Azure"
[2]: ./media/best-practices-network-security/azuresecurityfeatures.png "Средства безопасности Azure"
[3]: ./media/best-practices-network-security/dmzcorporate.png "Сеть периметра в корпоративной сети"
[4]: ./media/best-practices-network-security/azuresecurityarchitecture.png "Архитектура безопасности Azure"
[5]: ./media/best-practices-network-security/dmzazure.png "Сеть периметра в виртуальной сети Azure"
[6]: ./media/best-practices-network-security/dmzhybrid.png "Гибридная сеть с тремя периметрами безопасности"
[7]: ./media/best-practices-network-security/example1design.png "Входящая сеть периметра с группой безопасности сети"
[8]: ./media/best-practices-network-security/example2design.png "Входящая сеть периметра с виртуальным сетевым устройством и группой безопасности сети"
[9]: ./media/best-practices-network-security/example3design.png "Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами"
[10]: ./media/best-practices-network-security/example3firewalllogical.png "Логическое представление правил брандмауэра"
[11]: ./media/best-practices-network-security/example4designoptions.png "Сеть периметра с гибридной сетью, подключенной через виртуальное сетевое устройство"
[12]: ./media/best-practices-network-security/example4designs2s.png "Сеть периметра с виртуальным сетевым устройством и VPN-подключением типа «сеть-сеть»"
[13]: ./media/best-practices-network-security/example4networklogical.png "Логическая сеть с точки зрения виртуального сетевого устройства"
[14]: ./media/best-practices-network-security/example5designoptions.png "Сеть периметра с гибридным сетевым подключением типа «сеть-сеть» через шлюз Azure"
[15]: ./media/best-practices-network-security/example5designs2s.png "Сеть периметра со шлюзом Azure и VPN-подключением типа «сеть-сеть»"
[16]: ./media/best-practices-network-security/example6designoptions.png "Сеть периметра с гибридным сетевым подключением ExpressRoute через шлюз Azure"
[17]: ./media/best-practices-network-security/example6designexpressroute.png "Сеть периметра со шлюзом Azure и подключением ExpressRoute"

<!--Link References-->
[Example1]: ./virtual-network/virtual-networks-dmz-nsg-asm.md
[Example2]: ./virtual-network/virtual-networks-dmz-nsg-fw-asm.md
[Example3]: ./virtual-network/virtual-networks-dmz-nsg-fw-udr-asm.md
[Example4]: ./virtual-network/virtual-networks-hybrid-s2s-nva-asm.md
[Example5]: ./virtual-network/virtual-networks-hybrid-s2s-agw-asm.md
[Example6]: ./virtual-network/virtual-networks-hybrid-expressroute-asm.md
[Example7]: ./virtual-network/virtual-networks-vnet2vnet-direct-asm.md
[Example8]: ./virtual-network/virtual-networks-vnet2vnet-transit-asm.md

<!---HONumber=Oct15_HO1-->