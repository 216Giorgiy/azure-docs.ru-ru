---
title: Создание настраиваемых ролей управления доступом на основе ролей и их назначение внутренним и внешним пользователям в Azure | Документация Майкрософт
description: Назначение настраиваемых ролей RBAC, созданных с помощью PowerShell и интерфейса командной строки, внутренним и внешним пользователям.
services: active-directory
documentationcenter: ''
author: rolyon
manager: mtillman
editor: kgremban
ms.assetid: ''
ms.service: active-directory
ms.devlang: ''
ms.topic: article
ms.tgt_pltfrm: ''
ms.workload: identity
ms.date: 03/20/2018
ms.author: rolyon
ms.reviewer: skwan
ms.custom: it-pro
ms.openlocfilehash: d2eb39aa0a3fda7b543b6989cda937559f4d09ea
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="intro-on-role-based-access-control"></a>Общие сведения об управлении доступом на основе ролей

Управление доступом на основе ролей (RBAC) — это единственная функция на портале Azure, с помощью которой владельцы подписки могут назначать роли другим пользователям, что позволяет им управлять определенными областями действия ресурсов в среде.

RBAC предоставляет расширенные возможности управления безопасностью для больших организаций, а также малых и средних предприятий, работающих с внешними сотрудниками, поставщиками или фрилансерами, которым требуется доступ к определенным ресурсам в среде, а не к целой инфраструктуре или любым областям, связанным с выставлением счетов. Кроме того, RBAC обеспечивает гибкость владения подпиской Azure, управляемой с использованием учетной записи администратора (роль администратора службы на уровне подписки), и позволяет нескольким пользователям работать в рамках одной подписки, но без прав администратора. Что касается управления и выставления счетов, функция RBAC гарантирует эффективное использование времени, а также предоставляет полезные возможности управления средой Azure в разных сценариях.

## <a name="prerequisites"></a>предварительным требованиям
Чтобы реализовать возможности RBAC в среде Azure, вам потребуется:

* автономная подписка Azure, назначенная пользователю как владельцу (роль подписки);
* роль владельца подписки Azure;
* доступ к [порталу Azure](https://portal.azure.com);
* поставщики ресурсов **Microsoft.Authorization**, зарегистрированные в подписке пользователя. Дополнительные сведения о регистрации поставщиков ресурсов см. в статье [Поставщики диспетчера ресурсов, регионы, версии API и схемы](../azure-resource-manager/resource-manager-supported-services.md).

> [!NOTE]
> Подписки Office 365 или лицензии Azure Active Directory (например, доступ к Azure Active Directory), подготовленные в Центре администрирования Office 365, не поддерживают RBAC.

## <a name="how-can-rbac-be-used"></a>Как можно использовать RBAC
RBAC можно применять в трех различных областях в Azure. Вот они (от самой высокой области действия до самой низкой):

* подписка (самый высокий уровень доступа);
* Группа ресурсов
* область действия ресурса (самый низкий уровень доступа с разрешениями на доступ к отдельной области действия ресурса Azure).

## <a name="assign-rbac-roles-at-the-subscription-scope"></a>Назначение ролей RBAC в области действия подписки
Существует два распространенных примера использования RBAC (но это еще не все):

* При работе с внешними пользователями организации, которые не являются частью клиента Azure Active Directory администратора и которым предоставляется доступ на управление определенными ресурсами или целой подпиской.
* При работе с пользователями в организации, которые являются частью клиента Azure Active Directory пользователя, но входят в разные команды или группы и которым требуется доступ к целой подписке или определенным группам ресурсов (областям действия ресурсов) в среде.

## <a name="grant-access-at-a-subscription-level-for-a-user-outside-of-azure-active-directory"></a>Предоставление доступа на уровне подписки внешним пользователям Azure Active Directory
Роли RBAC можно получить только от **владельца** подписки. Таким образом, администратор должен войти в качестве пользователя, у которого эта роль предопределена или который уже создал подписку Azure.

Войдите на портал Azure как администратор. Выберите "Подписки", а затем выберите необходимую подписку.
![Колонка подписки на портале Azure](./media/role-assignments-external-users/0.png) По умолчанию администратору, который приобрел подписку Azure, назначается роль **администратора учетной записи**. Дополнительные сведения о ролях подписки Azure см. в статье [Добавление или изменение администраторов подписки Azure](../billing/billing-add-change-azure-subscription-administrator.md).

В этом примере пользователь alflanigan@outlook.com является **владельцем** бесплатной пробной версии подписки в клиенте AAD (каталог Default tenant Azure (Клиент Azure по умолчанию)). Так как этот пользователь создал подписку Azure, используя начальную учетную запись Microsoft Outlook, после добавления других пользователей в этот клиент к их учетной записи будет добавляться следующее доменное имя (по умолчанию): **@alflaniganuoutlook.onmicrosoft.com**. Новое доменное имя состоит из имени пользователя и доменного имени пользователя, создавшего клиент, а также расширения **.onmicrosoft.com**.
Кроме того, пользователи могут войти в систему, используя имя личного домена в клиенте. Для этого сначала необходимо добавить это имя в новый клиент, а затем проверить. Дополнительные сведения о проверке имени личного домена в клиенте Azure Active Directory см. в [этой статье](/active-directory/active-directory-add-domain).

В этом примере в каталоге Default tenant Azure (Клиент Azure по умолчанию) содержатся только пользователи с доменным именем @alflanigan.onmicrosoft.com.

После выбора подписки администратор должен щелкнуть **Управление доступом (IAM)** и выбрать **Добавить новую роль**.





![Функция "Управление доступом (IAM)" на портале Azure](./media/role-assignments-external-users/1.png)





![Параметр "Добавить новую роль" в области "Управление доступом (IAM)" на портале Azure](./media/role-assignments-external-users/2.png)

Далее необходимо выбрать роль RBAC и пользователя, которому ее нужно назначить. В раскрывающемся меню **Роль** для администратора отображаются только встроенные роли RBAC, доступные в Azure. Подробное описание каждой роли и их назначаемых областей см. в статье [Встроенные роли для управления доступом на основе ролей в Azure](built-in-roles.md).

Затем необходимо добавить адрес электронной почты внешнего пользователя. Этот внешний пользователь не должен отображаться в имеющемся клиенте. Приглашенные пользователи, а также все текущие пользователи с ролью RBAC в области действия подписки отображаются в области **Подписки > Управление доступом (IAM)**.





![Добавить разрешения в новую роль RBAC](./media/role-assignments-external-users/3.png)





![Список ролей RBAC на уровне подписки](./media/role-assignments-external-users/4.png)

Пользователя chessercarlton@gmail.com пригласили стать **владельцем** бесплатной пробной версии подписки. После отправки приглашения внешний пользователь получит письмо со ссылкой активации.
![Приглашение по электронной почте стать участником роли RBAC](./media/role-assignments-external-users/5.png)

Новые внешние пользователи организации не имеют атрибутов в каталоге Default tenant Azure (Клиент Azure по умолчанию). Все атрибуты создаются после предоставления этому пользователю разрешений на запись в каталоге, который связан с подпиской с назначенной ролью.





![Сообщение с приглашением стать участником роли RBAC](./media/role-assignments-external-users/6.png)

В дальнейшем этот пользователь отображается в клиенте Azure Active Directory как внешний. Это можно посмотреть на портале Azure.





![Колонка пользователя Azure Active Directory на портале Azure](./media/role-assignments-external-users/7.png)



В представлении **Пользователи** внешних пользователей можно распознать по разным типам значков на портале Azure.

Тем не менее внешний пользователь с ролью **Владелец** или **Участник** в области действия **подписки** не имеет доступа к каталогу администратора, если это разрешение ему не предоставит **глобальный администратор**. В свойствах пользователя можно определить параметр **Тип пользователя**, который имеет два значения: **Участник** и **Гость**. Участник — это зарегистрированный в каталоге пользователь, а гость — это пользователь, приглашенный в каталог из внешнего источника. Дополнительные сведения см. в статье [Как администраторы Azure Active Directory могут добавить пользователей службы совместной работы B2B?](../active-directory/active-directory-b2b-admin-add-users.md).

> [!NOTE]
> Убедитесь, что после ввода учетных данных на портале внешний пользователь входит в нужный каталог. Тот же пользователь может иметь доступ к нескольким каталогам и может войти в любой из них, щелкнув имя пользователя в верхнем правом углу на портале Azure и выбрав в раскрывающемся списке нужный каталог.

Будучи гостем, внешний пользователь может управлять всеми ресурсами в подписке Azure, но не имеет доступа к каталогу.





![Доступ к каталогу Azure Active Directory на портале Azure ограничен](./media/role-assignments-external-users/9.png)

Azure Active Directory и подписка Azure не имеют дочерних и родительских отношений, в отличие от других ресурсов Azure (например, виртуальные машины, виртуальные сети, веб-приложения, хранилище и т. д.), которые связаны с подпиской Azure. Создание этих ресурсов, выставление счетов за использование и управление ими выполняется в рамках подписки Azure, а с помощью самой подписки контролируется доступ к каталогу Azure. Дополнительные сведения см. в статье [Как связать или добавить подписку Azure в Azure Active Directory](/active-directory/active-directory-how-subscriptions-associated-directory).

Из всех встроенных ролей RBAC только роли **Владелец** и **Участник** предлагают возможности полного доступа к управлению всеми ресурсами в среде. Разница между ними заключается в том, что участник не может создавать и удалять роли RBAC. Другие встроенные роли, например **Участник виртуальных машин**, обеспечивают доступ к управлению только теми ресурсами, которые указаны в названиях этих ролей, вне зависимости от **группы ресурсов**, используемой при их создании.

К пользователю с ролью **Участник виртуальных машин**, назначенной на уровне подписки, применяются следующие разрешения и ограничения:

* просматривать все виртуальные машины независимо от даты их развертывания и группы ресурсов, к которой они принадлежат;
* полный доступ к управлению виртуальными машинами в подписке;
* не может просматривать другие типы ресурсов в подписке;
* не может изменять параметры выставления счетов.

## <a name="assign-a-built-in-rbac-role-to-an-external-user"></a>Назначение встроенной роли RBAC внешним пользователям
Для оценки разных сценариев внешнему пользователю alflanigan@gmail.com назначили роль **Участник виртуальных машин**.




![Встроенная роль "Участник виртуальных машин"](./media/role-assignments-external-users/11.png)

Внешний пользователь с этой встроенной ролью может просматривать только виртуальные машины и ресурсы Resource Manager, необходимые во время развертывания, а также управлять ими. Эти роли с ограниченными правами обеспечивают доступ только к соответствующим ресурсам, созданным на портале Azure.



![Обзор роли "Участник виртуальных машин" на портале Azure](./media/role-assignments-external-users/12.png)

## <a name="grant-access-at-a-subscription-level-for-a-user-in-the-same-directory"></a>Предоставление доступа на уровне подписки пользователям в том же каталоге
Этот процесс аналогичен добавлению внешнего пользователя и в отношении администратора, предоставляющего роль RBAC, и пользователя, которому эта роль назначается. Отличие заключается в том, что приглашенный пользователь не получит приглашение по электронной почте, так как после входа все области действия ресурсов в подписке будут доступны на панели мониторинга.

## <a name="assign-rbac-roles-at-the-resource-group-scope"></a>Назначение ролей RBAC в области действия группы ресурсов
Процесс назначения роли RBAC внешним и внутренним пользователям (в том же каталоге) в области действия **группы ресурсов** и на уровне подписки аналогичен. Пользователи с ролью RBAC могут просматривать в среде только группу ресурсов, к которой им предоставлен доступ, щелкнув значок **Группы ресурсов** на портале Azure.

## <a name="assign-rbac-roles-at-the-resource-scope"></a>Назначение ролей RBAC в области действия ресурсов
Процесс назначения роли RBAC в области действия ресурсов, на уровне подписки и на уровне группы ресурсов аналогичен. В обоих сценариях используется тот же рабочий процесс. Опять же, пользователи с ролью RBAC могут просматривать только те элементы, к которым им предоставлен доступ. Эти ресурсы отображаются на вкладке **Все ресурсы** или непосредственно на панели мониторинга.

Важный аспект, который следует учитывать при назначении роли RBAC на уровне группы ресурсов или на уровне ресурсов, — это то, что пользователи должны войти в нужный каталог.





![Вход в каталог на портале Azure](./media/role-assignments-external-users/13.png)

## <a name="assign-rbac-roles-for-an-azure-active-directory-group"></a>Назначение ролей RBAC группе Azure Active Directory
Все сценарии с использованием ролей RBAC на трех различных уровнях в Azure обеспечивают права на развертывание, администрирование различных ресурсов и управление ими, не управляя личной подпиской. Независимо от того, назначена ли роль RBAC на уровне подписки, группы ресурсов или ресурса, все созданные пользователями ресурсы оплачиваются в рамках подписки Azure, к которой они имеют доступ. Таким образом, пользователи с правами администратора выставления счетов всей подписки Azure имеют полное представление о потреблении ресурсов, независимо от того, кто ими управляет.

В более крупных организациях роли RBAC можно таким же образом применять к группам Azure Active Directory, учитывая то, что администраторы хотят предоставлять доступ командам или целым отделам, а не отдельно каждому пользователю. Это позволяет эффективно использовать время, а также предоставляет полезные возможности управления. Чтобы проиллюстрировать этот момент, мы назначили одной из групп в клиенте роль **Участник** на уровне подписки.





![Добавление роли RBAC группе AAD](./media/role-assignments-external-users/14.png)

Подготовка этих групп безопасности и управление ими выполняется только в Azure Active Directory.

## <a name="create-a-custom-rbac-role-to-open-support-requests-using-powershell"></a>Создание настраиваемой роли RBAC с разрешением на открытие запросов в службу поддержки с помощью PowerShell
Встроенные роли, доступные в Azure, предоставляют определенные уровни разрешений, исходя из доступных ресурсов в среде. Тем не менее, если встроенные роли не соответствуют вашим потребностям, вы можете создать пользовательские роли.

Чтобы создать пользовательскую роль, можно начать со встроенной роли. Измените ее, а затем создайте роль. В этом примере мы настроили встроенную роль **Читатель**, которая позволяет пользователю отправлять запросы в службу поддержки.

Используйте команду [Get-AzureRmRoleDefinition](/powershell/module/azurerm.resources/get-azurermroledefinition) в PowerShell, чтобы экспортировать роль **Читатель** в формате JSON.

```powershell
Get-AzureRmRoleDefinition -Name "Reader" | ConvertTo-Json | Out-File C:\rbacrole2.json
```

Ниже приведены выходные данные JSON для роли "Читатель".

```json
{
    "Name":  "Reader",
    "Id":  "acdd72a7-3385-48ef-bd42-f606fba81ae7",
    "IsCustom":  false,
    "Description":  "Lets you view everything, but not make any changes.",
    "Actions":  [
                    "*/read"
                ],
    "NotActions":  [

                   ],
    "AssignableScopes":  [
                             "/"
                         ]
}
```

Теперь, чтобы создать пользовательскую роль, внесите правки в выходные данные JSON.

```json
{
    "Name":  "Reader support tickets access level",
    "IsCustom":  true,
    "Description":  "View everything in the subscription and also open support requests.",
    "Actions":  [
                    "*/read",
                    "Microsoft.Support/*"
                ],
    "NotActions":  [

                   ],
    "AssignableScopes":  [
                             "/subscriptions/11111111-1111-1111-1111-111111111111"
                         ]
}
```

Типичная роль состоит из трех основных разделов: **Actions**, **NotActions** и **AssignableScopes**.

В разделе **Actions** перечислены все разрешенные операции роли. В данном случае для создания запросов в службу поддержки необходимо добавить операцию **Microsoft.Support/&ast;**. Важно понимать, что каждая операция предоставляется поставщиком ресурсов. Чтобы получить список операций для поставщика ресурсов, можно использовать команду [Get-AzureRmProviderOperation](/powershell/module/azurerm.resources/get-azurermprovideroperation) или ознакомиться со статьей [Azure Resource Manager Resource Provider operations](resource-provider-operations.md) (Операции поставщика ресурсов Azure Resource Manager).

Чтобы ограничить все действия конкретной роли, поставщики ресурсов перечислены в разделе **NotActions**.
Роль обязательно должна содержать явные идентификаторы подписки, в которой она назначена. Идентификаторы подписки перечислены в разделе **AssignableScopes**. Если они не указаны, вы не сможете импортировать роль в подписку.

Чтобы создать пользовательскую роль, используйте команду [New-AzureRmRoleDefinition](/powershell/module/azurerm.resources/new-azurermroledefinition) и предоставьте обновленный JSON-файл определения роли.

```powershell
New-AzureRmRoleDefinition -InputFile "C:\rbacrole2.json"
```

В этом примере имя пользовательской роли — "Уровень доступа запросов в службу поддержки: читатель". Она разрешает пользователю просматривать все в подписке, а также открывать запросы в службу поддержки.

> [!NOTE]
> Единственными двумя встроенными ролями, разрешающими пользователю открывать запросы в службу поддержки, являются **Владелец** и **Участник**. Чтобы разрешить пользователю открывать запросы в службу поддержки, ему необходимо назначить роль на уровне подписки, так как все эти запросы создаются на основе подписки Azure.

Новые пользовательские роли теперь доступны на портале Azure и могут назначаться пользователям.

![Снимок экрана пользовательской роли, импортированной на портал Azure](./media/role-assignments-external-users/18.png)

![Снимок экрана назначения импортированной пользовательской роли пользователю в том же каталоге](./media/role-assignments-external-users/19.png)

![Снимок экрана с разрешениями импортированной пользовательской роли](./media/role-assignments-external-users/20.png)

Теперь с помощью пользовательской роли пользователи могут создавать запросы в службу поддержки.

![Снимок экрана пользовательской роли, используемой для создания запросов в службу поддержки](./media/role-assignments-external-users/21.png)

Пользователи этой пользовательской роли не могут совершать других действий. Например, они не могут создавать виртуальные машины или группы ресурсов.

![Снимок экрана пользовательской роли, которая не имеет разрешений на создание виртуальных машин](./media/role-assignments-external-users/22.png)

![Снимок экрана пользовательской роли, которая не имеет разрешений на создание групп ресурсов](./media/role-assignments-external-users/23.png)

## <a name="create-a-custom-rbac-role-to-open-support-requests-using-azure-cli"></a>Создание настраиваемой роли RBAC с разрешением на открытие запросов в службу поддержки с помощью Azure CLI

Шаги по созданию пользовательской роли с помощью Azure CLI соответствуют шагам, используемым в PowerShell. Но выходные данные JSON отличаются.

Для этого примера можно начать со встроенной роли **Читатель**. Используйте команду [az role definition list](/cli/azure/role/definition#az_role_definition_list), чтобы получить список действий роли "Читатель".

```azurecli
az role definition list --name "Reader" --output json
```

```json
[
  {
    "additionalProperties": {},
    "assignableScopes": [
      "/"
    ],
    "description": "Lets you view everything, but not make any changes.",
    "id": "/subscriptions/11111111-1111-1111-1111-111111111111/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7",
    "name": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
    "permissions": [
      {
        "actions": [
          "*/read"
        ],
        "additionalProperties": {},
        "notActions": []
      }
    ],
    "roleName": "Reader",
    "roleType": "BuiltInRole",
    "type": "Microsoft.Authorization/roleDefinitions"
  }
]
```

Создайте файл JSON в следующем формате. Операция **Microsoft.Support/&ast;** была добавлена в раздел **Actions**, чтобы этот пользователь мог открывать запросы в службу поддержки, продолжая оставаться читателем. Необходимо добавить идентификатор подписки, в которой эта роль будет назначена, в разделе **AssignableScopes**.

```json
{
    "Name":  "Reader support tickets access level",
    "IsCustom":  true,
    "Description":  "View everything in the subscription and also open support requests.",
    "Actions":  [
                    "*/read",
                    "Microsoft.Support/*"
                ],
    "NotActions":  [

                   ],
    "AssignableScopes": [
                            "/subscriptions/11111111-1111-1111-1111-111111111111"
                        ]
}
```

Чтобы создать пользовательскую роль, используйте команду [az role definition create](/cli/azure/role/definition#az_role_definition_create).

```azurecli
az role definition create --role-definition ~/roles/rbacrole1.json
```

Новая пользовательская роль теперь доступна на портале Azure. Процесс использования такой же, как и в предыдущих разделах PowerShell.

![Снимок экрана портала Azure с пользовательской ролью, созданной с помощью CLI 1.0](./media/role-assignments-external-users/26.png)
