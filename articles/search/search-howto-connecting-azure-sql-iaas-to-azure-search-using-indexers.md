<properties 
	pageTitle="Настройка подключения из индексатора Поиска Azure к SQL Server на виртуальной машине Azure | Microsoft Azure | Индексаторы" 
	description="Активируйте зашифрованные подключения и настройте брандмауэр, чтобы разрешить подключения к SQL Server на виртуальной машине Azure из индексатора Поиска Azure." 
	services="search" 
	documentationCenter="" 
	authors="jack4it" 
	manager="pablocas" 
	editor=""/>

<tags 
	ms.service="search" 
	ms.devlang="rest-api" 
	ms.workload="search" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.date="09/06/2016" 
	ms.author="jackma"/>

# Настройка подключения из индексатора Поиска Azure к SQL Server на виртуальной машине Azure

Как было отмечено в статье [Подключение базы данных SQL Azure к Поиску Azure с помощью индексаторов](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers-2015-02-28.md#frequently-asked-questions), служба поиска Azure поддерживает создание индексаторов для **SQL Server на виртуальных машинах Azure** (или **виртуальных машинах SQL Azure** для краткости), но существует два требования безопасности, которые необходимо выполнить.

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-both-include.md)]

## Активация зашифрованных подключений

Службе поиска Azure для чтения данных из базы данных требуется защищенное подключение. Это означает, что на виртуальной машине SQL Azure необходимо активировать зашифрованные подключения, настроив SSL-сертификат.

Шаги, необходимые для активации зашифрованных подключений к SQL Server, описаны в статье [Включение шифрования соединений в ядре СУБД](https://msdn.microsoft.com/library/ms191192.aspx), но при подключениях через общедоступный Интернет, таких как подключение службы поиска Azure к виртуальной машине SQL Azure, требуется выполнение нескольких дополнительных условий.

### Предоставление полного доменного имени в сертификате SSL

Имя субъекта SSL-сертификата должно быть полным доменным именем (**FQDN**) виртуальной машины SQL Azure. Это же полное доменное имя необходимо указать в строке подключения к базе данных при создании источника данных в службе поиска. Полное доменное имя для виртуальных машин **Resource Manager** имеет формат `<your-VM-name>.<region>.cloudapp.azure.com`. Если вы все еще используете **классические** виртуальные машины, то для них формат имени — `<your-cloud-service-name.cloudapp.net>`. Найти полное доменное имя виртуальной машины SQL Azure можно на [портале Azure](https://portal.azure.com/), просмотрев ее DNS-имя или DNS-метку.

### Настройка SSL-сертификата с помощью редактора реестра (REGEDIT)

Диспетчер конфигурации SQL Server не поддерживает отображение SSL-сертификата полного доменного имени в раскрывающемся списке **Сертификат**, как описано в документации. Для устранения этой проблемы настройте SSL-сертификат, изменив следующий раздел реестра: **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Microsoft SQL Server[MSSQL13.MSSQLSERVER]\\MSSQLServer\\SuperSocketNetLib\\Certificate**. Часть *[MSSQL13. MSSQLSERVER]* зависит от версии и имени экземпляра SQL Server. Этот раздел необходимо обновить с помощью **отпечатка** SSL-сертификата, установленного на виртуальной машине SQL Azure.

### Предоставление разрешений учетной записи службы

Убедитесь, что учетной записи службы SQL Server предоставлено необходимое разрешение для закрытого ключа SSL-сертификата. Если пренебречь этим шагом, то SQL Server не запустится.

## Настройка брандмауэра на разрешение подключений из Поиска Azure

Обычной практикой является настройка брандмауэра и соответствующей конечной точки Azure или списка управления доступом (ACL) таким образом, чтобы виртуальная машина Azure стала доступной для других сторон. Есть вероятность, что вы уже выполнили эту настройку, чтобы разрешить логике вашего приложения подключаться к виртуальной машине SQL Azure. Такой же принцип применяется для подключения службы поиска Azure к виртуальной машине SQL Azure. Если вы еще этого не сделали, то ознакомьтесь с приведенными ниже рекомендациями по безопасности, которые стоит учитывать.

Если вы используете виртуальные машины **Resource Manager**, то ознакомьтесь со статьей [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](../virtual-machines/virtual-machines-windows-sql-connect.md). Если вы все еще используете **классические** виртуальные машины, то см. статью [Подключение к виртуальной машине SQL Server в Azure (классическое развертывание)](../virtual-machines/virtual-machines-windows-classic-sql-connect.md).

### Ограничение доступа к IP-адресу службы поиска

Какой бы ни была модель развертывания, при настройке подключений из Поиска Azure настоятельно рекомендуется ограничить доступ к IP-адресу службы поиска с помощью списка управления доступом (ACL), а не оставлять виртуальные машины SQL Azure открытыми для любых запросов на подключение. Вы можете легко узнать этот IP-адрес, выполнив проверку связи с полным доменным именем (например: `<your-search-service-name>.search.windows.net`) своей службы поиска.

### Настройка диапазона IP-адресов

Обратите внимание, что если служба поиска имеет только одну единицу поиска (то есть одну реплику и одну секцию), то IP-адрес может меняться во время перезагрузки службы. Во избежание сбоев подключения следует указать диапазон IP-адресов в регионе Azure, в котором выполняется подготовка службы поиска. Список диапазонов IP-адресов, из которых общедоступные IP-адреса назначаются ресурсам Azure, опубликован в файле с [диапазонами IP-адресов центров обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653).

### Включение IP-адресов портала Поиска Azure

Кроме того, если для создания индексатора используется портал Azure, то в процессе создания логике портала Поиска Azure также необходим доступ к виртуальной машине SQL Azure. Чтобы найти IP-адреса портала службы поиска Azure, можно выполнить проверку связи с `stamp1.search.ext.azure.com` и `stamp2.search.ext.azure.com`.

## Дальнейшие действия

Когда вышеперечисленные требования к конфигурации выполнены, SQL Server на виртуальной машине Azure можно указать в качестве источника данных для индексатора Поиска Azure. Дополнительные сведения см. в статье [Подключение базы данных SQL Azure к Поиску Azure с помощью индексаторов](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers-2015-02-28.md).

<!---HONumber=AcomDC_0907_2016-->