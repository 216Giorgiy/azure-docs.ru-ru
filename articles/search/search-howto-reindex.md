---
title: Перестроение индекса в службе "Поиск Azure" или обновление содержимого для поиска | Документация Майкрософт
description: Вы можете добавлять новые элементы, обновлять существующие элементы или документы и удалять устаревшие документы в процессе обновления индекса службы "Поиск Azure", выполняя полное перестроение или частичное добавочное индексирование.
services: search
author: HeidiSteen
manager: cgronlun
ms.service: search
ms.topic: conceptual
ms.date: 05/01/2018
ms.author: heidist
ms.openlocfilehash: f38054eaf2829149a496f840366b6f2f9e03e12b
ms.sourcegitcommit: d98d99567d0383bb8d7cbe2d767ec15ebf2daeb2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
ms.locfileid: "33942109"
---
# <a name="how-to-rebuild-an-azure-search-index"></a>Как перестроить индекс службы "Поиск Azure"

Перестроение индекса изменяет его структуру и изменяет физическое выражение индекса в службе "Поиск Azure". С другой стороны, обновление индекса затрагивает только его содержимое, отражая свежие изменения во внешнем источнике исходных данных. В этой статье объясняется, как обновить структуру или содержимое индекса.

Для обновления индекса нужны разрешения на чтение и запись на уровне службы. Полное перестроение или добавочное индексирование содержимого можно выполнить программными средствами через REST API или API .NET, указав параметры для выбора метода обновления. 

Как правило, обновление индекса выполняется по требованию. Но для индексов, которые заполняются [индексаторами](search-indexer-overview.md), нацеленными на конкретный источник, вы можете использовать встроенный планировщик. Планировщик поддерживает обновление документов с частотой от 15 минут до любого требуемого интервала или расписания обновлений. Чтобы обновлять индекс чаще, придется инициировать обновления вручную, например через двойную запись при транзакциях или путем одновременного обновления внешнего источника данных и индекса Поиска Azure.

## <a name="full-rebuilds"></a>Полное перестроение

Для многих типов обновлений требуется полное перестроение. Полное перестроение по сути означает удаление индекса, всех его данных и метаданных, с последующим заполнением индекса из внешних источников данных. С программной точки зрения, перестроение индекса включает его [удаление](https://docs.microsoft.com/rest/api/searchservice/delete-index), [создание](https://docs.microsoft.com/rest/api/searchservice/create-index) и [перезагрузку](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents). 

Если вы выполняете тестирование частоты запросов и профилей повышений, после перестроения индекса следует ожидать некоторых изменений в результатах запросов, если изменялось базовое содержимое.

## <a name="when-to-rebuild"></a>Как часто нужно перестраивать индекс

Частое полное перестроение следует выполнять в период активной разработки, пока схемы индексов еще не полностью определены.

| Изменения | Состояние перестроения|
|--------------|---------------|
| Изменение имени поля, типа данных или [атрибутов индекса](https://docs.microsoft.com/rest/api/searchservice/create-index) | Изменение определения поля обычно требует перестроения индексов, за исключением нескольких [атрибутов индекса](https://docs.microsoft.com/rest/api/searchservice/create-index): Retrievable, SearchAnalyzer, SynonymMaps. Атрибуты Retrievable, SearchAnalyzer и SynonymMaps вы можете добавлять к существующим полям без необходимости перестроения индекса.|
| Добавление полей | Нет строгих требований перестроения. Во всех существующих в индексе документах новому полю присваивается значение null. При последующем перестроении индекса в службе "Поиск Azure" эти пустые значения заменятся сведениями из источника данных. |
| Удаление поля | Невозможно напрямую удалить поле из индекса службы "Поиск Azure". Вы можете лишь прекратить использовать "удаленное" поле в своем приложении. Физически определение и содержимое поля сохраняются в индексе до следующего перестроения индекса с использованием схемы, в которой это поле отсутствует.|

> [!Note]
> Также перестроение требуется при изменении уровня. Если в определенный момент вам потребуется дополнительная производительность, вы не сможете выполнить обновление на месте. Придется создавать службу с требуемым уровнем производительности и создавать для нее все индексы "с нуля". 

## <a name="partial-or-incremental-indexing"></a>Частичное или добавочное индексирование

Когда индекс будет передан в рабочую среду, по возможности ограничьте работу с ним до добавочного индексирования, чтобы не создавать перерывы в работе службы. Частичное или добавочное индексирование затрагивают только содержимое индекса. Эта рабочая нагрузка синхронизирует содержимое индекса поиска, чтобы отразить актуальное состояние содержимого в исходных источниках данных. Все документы, добавленные или удаленные в источнике, добавляются в индекс или удаляются из него. В коде вам нужно вызвать операцию [Добавление, обновление или удаление документов](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents) или ее аналог в .NET.

> [!Note]
> Если используются индексаторы, которые сканируют внешние источники данных, для добавочного индексирования применяются механизмы отслеживания изменений в исходных системах. Для [хранилища BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md#incremental-indexing-and-deletion-detection) используется поле `lastModified`. В [хранилище таблиц Azure](search-howto-indexing-azure-tables.md#incremental-indexing-and-deletion-detection) эти функции выполняет `timestamp`. В [индексаторе для Базы данных SQL Azure](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#capture-new-changed-and-deleted-rows) и [индексаторе для Azure Cosmos DB](search-howto-index-cosmosdb.md#indexing-changed-documents) также используются поля, обозначающие обновление строки. Дополнительную информацию об индексаторах см. в [этом описании](search-indexer-overview.md).

## <a name="scale-out-indexing"></a>Индексирование с поддержкой горизонтального масштабирования

При росте объемов данных или изменении требований к их обработке вы можете столкнуться с ситуацией, когда простого перестроения и изменения индекса будет уже недостаточно. Для соответствия растущим требованиям мы рекомендуем в первую очередь повысить [масштабируемость и емкость](search-capacity-planning.md) в пределах существующей службы. 

Если у вас есть возможность применить [индексаторы](search-indexer-overview.md), вам будут доступны дополнительные механизмы масштабирования. Индексаторы имеют встроенный планировщик, который позволяет разделить индексирование на этапы, выполняя его через регулярные интервалы или даже дольше 24 часов. Кроме того, при использовании совместно с определениями источников данных индексаторы позволяют реализовать некоторый параллелизм. Вы можете разбить данные на разделы и обрабатывать их параллельно, настроив соответствующие расписания.

### <a name="scheduled-indexing-for-large-data-sets"></a>Запланированное индексирование для больших наборов данных

Планирование служит важным механизмом в обработке больших наборов данных и длительных операций анализа, таких как анализ изображений в конвейере когнитивного поиска. Индексатор выполняет обработку в пределах 24-часового периода. Если за это время ее завершить не удается, вы можете исправить ситуацию с помощью планирования индексаторов. 

Запланированные операции индексирования запускаются через определенные интервалы времени, и обычно работа очередного задания индексатора завершается до того, как наступит время запускать следующее. Но если обработка к этому моменту еще не завершена, индексатор останавливается (завершается отведенное ему время). При запуске следующего задания обработка начнется с места остановки, так как система отслеживает текущее состояние операций. 

На практике это означает, что для многодневных задач индексирования вам следует настроить для индексатора запуск через каждые 24 часа. Каждое следующее задание индексирования в начале 24-часового отрезка начнет работу с последнего документа, который считается надежным. Такая схема работы позволяет индексатору перебирать очередь документа в течение нескольких дней, пока все они не будут обработаны. Дополнительные сведения об этом подходе вы найдете в руководстве по [индексированию больших наборов данных](search-howto-indexing-azure-blob-storage.md#indexing-large-datasets).

<a name="parallel-indexing"></a>

### <a name="parallel-indexing"></a>Параллельное индексирование

У вас есть и второй вариант — настроить стратегию параллельного индексирования. Для нетипичных заданий индексирования, требующих высокой вычислительной мощности, например для распознавания текста в отсканированных документах в конвейере когнитивного поиска, правильным решением может оказаться стратегия параллельного индексирования. В конвейере обогащения когнитивного поиска значительное время уходит на анализ изображений и обработку естественного языка. Параллельное индексирование данных службы, которая не обрабатывает запросы одновременно, позволит достаточно быстро переработать значительный объем содержимого, требующего длительной обработки. 

Стратегия параллельной обработки включает следующие этапы:

+ Разделите исходные данные на несколько контейнеров или несколько виртуальных папок в одном контейнере. 
+ Сопоставьте каждый небольшой набор данных с отдельным [источником данных](https://docs.microsoft.com/rest/api/searchservice/create-data-source) и создайте для каждого свой [индексатор](https://docs.microsoft.com/rest/api/searchservice/create-indexer).
+ В службе когнитивного поиска настройте один и тот же [набор навыков](ref-create-skillset.md) для каждого из определений индексаторов.
+ В качестве целевого объекта записи назначьте им один и тот же индекс. 
+ Настройте для всех индексаторов запуск в одно и то же время.

> [!Note]
> Служба "Поиск Azure" не поддерживает выделенные реплики или разделы для конкретных рабочих нагрузок. Большой объем одновременных заданий индексирования может привести к перегрузке системы, что ухудшит производительность обработки запросов. Если у вас есть тестовая среда, попробуйте запустить в ней параллельное индексирование, чтобы оценить потенциальные проблемы.

### <a name="configure-parallel-indexing"></a>Настройка параллельного индексирования

Вычислительная мощность индексаторов слабо связана с одной подсистемой индексаторов, которую служба поиска использует для каждой единицы службы (SU). Несколько одновременных индексаторов можно выполнять в службах "Поиск Azure", которые предоставляются на уровне "Базовый" или "Стандартный" и имеют по меньше мере две реплики. 

1. На [портале Azure](https://portal.azure.com) откройте панель мониторинга для службы поиска, затем страницу **Обзор** и проверьте значение параметра **Ценовая категория**, чтобы убедиться в доступности параллельного индексирования. На уровнях "Базовый" и "Стандартный" поддерживается использование нескольких реплик.

2. В разделе **Параметры** > **Масштабирование** [увеличьте количество реплик](search-capacity-planning.md) для параллельной обработки, создав одну дополнительную реплику для каждой рабочей нагрузки индексатора. Оставьте достаточное количество реплик для обработки фактического объема запросов. Не следует жертвовать рабочими нагрузками обработки запросов в пользу индексирования.

3. Распределите данные на несколько контейнеров на таком уровне, который доступен для индексаторов службы "Поиск Azure". Например, создайте несколько таблиц в базе данных SQL Azure, несколько контейнеров в хранилище BLOB-объектов Azure или несколько коллекций. Определите отдельный объект источника данных для каждой таблицы или контейнера.

4. Создайте несколько индексаторов и расписания для их параллельного выполнения.

   + В качестве примера давайте рассмотрим службу с шестью репликами. Настройте для нее шесть индексаторов, каждый из которых сопоставлен с источником данных, содержащим примерно шестую часть от общего объема набора данных. 

   + Настройте для каждого индексатора один и тот же индекс. Укажите один и тот же набор навыков для рабочих нагрузок когнитивного поиска.

   + В определении каждого индексатора запланируйте одинаковые графики выполнения. Например, `"schedule" : { "interval" : "PT8H", "startTime" : "2018-05-15T00:00:00Z" }` создает для всех индексаторов расписание, по которому они запускаются каждые 8 часов 15 мая 2018 г.

В запланированное время все индексаторы одновременно начнут загружать данные, применять к ним правила обогащения (если вы настроили для них конвейер когнитивного поиска) и сохранять результаты в индекс. Служба "Поиск Azure" не применяет блокировку индекса для обновлений. Параллельные операции записи обрабатываются логикой повторных попыток, если при первой попытке не удалось записать данные.

> [!Note]
> Увеличивая количество реплик, попробуйте увеличить и количество разделы, если прогнозируется значительное увеличение размера индекса. Разделы хранят фрагменты индексированного содержимого. Чем больше разделов, тем меньше объем сохраненной в каждом из них информации.

## <a name="see-also"></a>См. также

+ [Обзор индексатора](search-indexer-overview.md)
+ [Импорт данных в службу поиска Azure с помощью портала](search-import-data-portal.md)
+ [Подключение базы данных SQL Azure к Поиску Azure с помощью индексаторов](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md)
+ [Индексатор базы данных Azure Cosmos](search-howto-index-cosmosdb.md)
+ [Индексатор хранилища BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md)
+ [Индексатор хранилища таблиц Azure](search-howto-indexing-azure-tables.md)
+ [Безопасность и управляемый доступ в службе поиска Azure](search-security-overview.md)