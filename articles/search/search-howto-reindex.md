---
title: Перестроение индекса в службе "Поиск Azure" или обновление содержимого для поиска
description: Вы можете добавлять новые элементы, обновлять существующие элементы или документы и удалять устаревшие документы в процессе обновления индекса службы "Поиск Azure", выполняя полное перестроение или частичное добавочное индексирование.
services: search
author: HeidiSteen
manager: cgronlun
ms.service: search
ms.topic: conceptual
ms.date: 12/20/2018
ms.author: heidist
ms.custom: seodec2018
ms.openlocfilehash: 55de72b2a82dea3dfe763d786966565beb229042
ms.sourcegitcommit: 21466e845ceab74aff3ebfd541e020e0313e43d9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2018
ms.locfileid: "53745097"
---
# <a name="how-to-rebuild-an-azure-search-index"></a>Как перестроить индекс службы "Поиск Azure"

В этой статье объясняется, как перестроить индекс службы поиска Azure, обстоятельства, при которых требуется перестроение, и рекомендации по смягчению последствий перестроения для текущих запросов.

*Перестроение* — это удаление и повторное создание структур физических данных, связанных с индексом, включая все индексы, инвертированные на основе поля. В службе поиска Azure невозможно удалить и заново создать определенные поля. Для перестроения индекса все хранилище полей необходимо удалить, создать заново на основе существующей или измененной схемы индексов, а затем повторно заполнить их данными, отправленными в индекс или полученными из внешних источников. Обычно индексы перестраиваются во время разработки, но иногда требуется перестроить индекс производственного уровня в соответствии со структурными изменениями, например при добавлении сложных типов.

В отличие от перестроения индекса в автономном режиме *обновление данных* выполняется как фоновая задача. Вы можете добавить, удалить и заменить документы с минимальными нарушениями рабочих нагрузок запросов, хотя запросы могут выполняться дольше. Дополнительные сведения об обновлении содержимого индекса см. в статье [Добавление, обновление и удаление документов](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents).

## <a name="rebuild-conditions"></a>Условия перестроения

| Условие | ОПИСАНИЕ |
|-----------|-------------|
| Изменение определения поля | Если вы меняете имя, тип данных или определенные [атрибуты индекса](https://docs.microsoft.com/rest/api/searchservice/create-index) (с возможностью поиска, фильтрации, сортировки или аспектов), требуется полное перестроение. |
| Удаление поля | Чтобы физически удалить все следы поля, необходимо перестроить индекс. Если перестроить индекс сейчас неудобно, большинство разработчиков меняют код приложения, чтобы отключить доступ к удаленному полю. Физически определение и содержимое поля сохраняются в индексе до следующего перестроения с использованием схемы, в которой это поле отсутствует. |
| Переключение уровней | Если вам необходим больший объем, обновление на месте не поддерживается. Придется создавать службу с требуемым уровнем производительности и строить для нее все индексы с нуля. |

Любые другие изменения могут выполняться без влияния на существующие физические структуры. В частности, следующие изменения *не* указывают на перестроение индекса.

+ Добавление нового поля
+ Задание атрибута **Доступный для получения** для существующего поля
+ Установка анализатора в существующее поле
+ Добавление, обновление или удаление профилей повышения
+ Добавление, обновление или удаление параметров CORS
+ Добавление, обновление или удаление средств подбора
+ Добавление, обновление или удаление synonymMaps

Когда вы добавляете новое поле, во всех существующих в индексе документах новому полю присваивается значение null. При последующем обновлении данных в службе "Поиск Azure" эти пустые значения заменятся сведениями из внешнего источника данных.

## <a name="partial-or-incremental-indexing"></a>Частичное или добавочное индексирование

В службе "Поиск Azure" невозможно контролировать индексирование для каждого поля, удаляя и повторно создавая определенные поля. Аналогичным образом, нет встроенного механизма для [индексирования документов на основе критериев](https://stackoverflow.com/questions/40539019/azure-search-what-is-the-best-way-to-update-a-batch-of-documents). Любые требования к индексированию на основе критериев должны быть выполнены с помощью пользовательского кода.

Но вы можете легко *обновить документы* в индексе. Во многих решениях для поиска внешние исходные данные являются временными и синхронизация между исходными данными и индексом поиска — это распространенная практика. В коде вызовите операцию [Добавление, обновление и удаление документов](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents) или [эквивалент для .NET](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.indexesoperationsextensions.createorupdate?view=azure-dotnet), чтобы обновить содержимое индекса или добавить значения для нового поля.

## <a name="partial-indexing-with-indexers"></a>Частичное индексирование с помощью индексаторов

[Индексаторы](search-indexer-overview.md) упрощают задачу обновления данных. Индексатор может проиндексировать только одну таблицу или представление во внешнем источнике данных. Чтобы проиндексировать несколько таблиц, проще всего создать представление, которое объединяет таблицы и проецирует столбцы, подлежащие индексированию. 

При использовании индексаторов, сканирующих внешние источники данных, проверьте столбец максимального использования в источнике данных. Если таковой существует, его можно использовать для обнаружения последовательных изменений путем выбора только строк с новым или измененным содержанием. Для [хранилища BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md#incremental-indexing-and-deletion-detection) используется поле `lastModified`. В [хранилище таблиц Azure](search-howto-indexing-azure-tables.md#incremental-indexing-and-deletion-detection) эти функции выполняет `timestamp`. В [индексаторе для Базы данных SQL Azure](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#capture-new-changed-and-deleted-rows) и [индексаторе для Azure Cosmos DB](search-howto-index-cosmosdb.md#indexing-changed-documents) также используются поля, обозначающие обновление строки. 

Дополнительную информацию об индексаторах см. в разделах [Обзор индексаторов](search-indexer-overview.md) и [REST API сброса индексатора](https://docs.microsoft.com/rest/api/searchservice/reset-indexer).

## <a name="how-to-rebuild-an-index"></a>Как перестроить индекс

Частое полное перестроение следует выполнять в период активной разработки, пока схемы индексов еще не полностью определены. Для приложений, которые уже находятся в рабочей среде, рекомендуется создать новый индекс, который выполняется параллельно существующему, чтобы избежать простоя запроса.

Если у вас строгие требования к уровню обслуживания, подготовьте новую службу специально для этой работы, чтобы разработка и индексирование выполнялись в полной изоляции от индекса в рабочей среде. Это отдельная служба выполняется на своем оборудовании, устраняя возможное состязание ресурсов. По завершении разработки можно будет оставить новый индекс на месте, перенаправляя запросы к новой конечной точке и индексу, или выполнить завершенный код, чтобы опубликовать измененный индекс в исходной службе поиска Azure. В настоящее время отсутствует механизм для перемещения готового индекса в другую службу.

Для обновления индекса нужны разрешения на чтение и запись на уровне службы. На программном уровне вы можете вызвать [API REST для обновления индекса](https://docs.microsoft.com/rest/api/searchservice/update-index) или API .NET для полного перестроения. Этот запрос идентичен [REST API для создания индекса](https://docs.microsoft.com/rest/api/searchservice/create-index), но имеет другой контекст.

1. При повторном использовании имени индекса [удалите существующий индекс](https://docs.microsoft.com/rest/api/searchservice/delete-index). Все запросы, предназначенные для этого индекса, немедленно удаляются. Удаление индекса является необратимой операцией, при которой уничтожается физическое хранилище для коллекции полей и другие конструкции. Убедитесь, что понимаете последствия удаления индекса, прежде чем удалять его. 

2. Предоставьте схему индекса с измененными определениями полей. Требования к схеме описаны в разделе [Создание индекса](https://docs.microsoft.com/rest/api/searchservice/create-index).

3. Укажите [ключ администратора](https://docs.microsoft.com/azure/search/search-security-api-keys) по запросу.

4. Отправьте команду [Обновить индекс](https://docs.microsoft.com/rest/api/searchservice/update-index), чтобы перестроить физическое выражение индекса в службе поиска Azure. Текст запроса содержит схему индекса, а также конструкции для профилей повышения, анализаторов, средств подбора и параметров CORS.

5. [Загрузите индекс с документами](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents) из внешнего источника. Этот API также можно использовать при добавлении в существующую и неизменяемую схему индекса обновленных документов.

При создании индекса физическое хранилище выделяется для каждого поля в схеме индекса, и для каждого поля с поддержкой поиска создается инвертированный индекс. Поля, не поддерживающие поиск, можно использовать в фильтрах или выражениях, но у них нет инвертированных индексов и они недоступны для полнотекстового поиска. При перестроении индекса эти инвертированные индексы удаляются и создаются снова на основе предоставленной схемы индекса.

Когда вы загружаете индекс, инвертированный индекс каждого поля заполняется всеми уникальными маркированными словами из каждого документа с сопоставлением по идентификаторам соответствующих документов. Например, при индексировании набора данных гостиницы инвертированный индекс для поля "Город" может содержать условия для значений "Сиэтл", "Портленд" и т. д. Для документов, содержащих "Сиэтл" или "Портленд" в поле "Город", будет указан идентификатор рядом с условием поиска. При любой операции [добавления, обновления или удаления](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents) условия поиска и список идентификаторов документов обновляются соответствующим образом.

## <a name="view-updates"></a>Просмотр обновлений

Вы можете отправлять запросы к индексу сразу после загрузки первого документа. Если вы знаете идентификатор документа, [API REST поиска по документу](https://docs.microsoft.com/rest/api/searchservice/lookup-document) возвращает определенный документ. Для более подробного тестирования подождите полной загрузки индекса, а затем используйте запросы, чтобы проверить контекст, который вы ожидаете увидеть.

## <a name="see-also"></a>См. также

+ [Обзор индексатора](search-indexer-overview.md)
+ [Индексирование с поддержкой горизонтального масштабирования в службе "Поиск Azure"](search-howto-large-index.md)
+ [Импорт данных в службу поиска Azure с помощью портала](search-import-data-portal.md)
+ [Подключение базы данных SQL Azure к Поиску Azure с помощью индексаторов](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md)
+ [Индексатор базы данных Azure Cosmos](search-howto-index-cosmosdb.md)
+ [Индексатор хранилища BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md)
+ [Индексатор хранилища таблиц Azure](search-howto-indexing-azure-tables.md)
+ [Безопасность и управляемый доступ в службе поиска Azure](search-security-overview.md)