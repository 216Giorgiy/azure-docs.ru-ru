<properties 
	pageTitle="Создайте свое первое решение с использованием Поиска Azure" 
	description="Создайте свое первое решение с использованием Поиска Azure" 
	services="search" 
	documentationCenter="" 
	authors="HeidiSteen" 
	manager="mblythe" 
	editor=""/>

<tags 
	ms.service="search" 
	ms.devlang="rest-api" 
	ms.workload="search" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.date="07/08/2015" 
	ms.author="heidist"/>

# Создайте свое первое решение с использованием Поиска Azure

В данном примере рассматривается поисковое приложение, созданное для компании Adventure Works, занимающейся производством велосипедов. По итогам выполнения всех заданий данного учебника будет создан онлайн-каталог продукции, обладающий широкими возможностями для поиска, среди которых: многоаспектная навигация, различные параметры для сортировки поисковых результатов, а также всплывающие по мере ввода поисковых запросов подсказки.

   ![][7]

Данный демонстрационный пример позволяет начать работу с Поиском Azure посредством выполнения следующих упражнений:

+	Создание индекса Поиска Azure.
+	Выполнение загрузки документов (данных) в индекс службы Поиска Azure из базы данных SQL Server.
+	Создание MVC4 приложения на ASP.NET, которое использует Поиск Azure для выполнения следующих операций:
	+	Поиск и отображение результатов, полученных из индекса службы Поиска Azure
	+	Отображение подсказок по мере ввода текста поисковых запросов в поле Поиска
	+	Фильтрация поисковых результатов на основе использования концепции аспектов


<a id="sub-1"></a>
## Предварительные требования

+	[Подписка Azure](../includes/free-trial-note.md). Если вы не хотите регистрироваться и получать пробную подписку, пропустите это руководство и обратитесь вместо него к [службе ознакомления с приложениями Azure](https://tryappservice.azure.com/). Выбрав этот альтернативный вариант, вы сможете пользоваться поиском Azure с веб-приложением ASP.NET бесплатно (в течение одного часа за один сеанс); подписка в таком случае не требуется.
+	Visual Studio 2012 или более поздней версии с ASP.NET MVC 4 и SQL Server. Если у вас не установлено программное обеспечение, загрузите бесплатные версии Express: [Visual Studio 2013 Express](http://www.visualstudio.com/products/visual-studio-express-vs.aspx) и [Microsoft SQL Server 2014 Express](http://msdn.microsoft.com/evalcenter/dn434042.aspx).
+	Служба "Поиск Azure". Вам понадобятся имя службы поиска и ключ администратора. Дополнительные сведения см. в статье [Создание службы поиска Azure на портале](search-create-service-portal.md).
+	[Демонстрационный проект поиска Azure в Adventure Works на CodePlex](http://go.microsoft.com/fwlink/p/?LinkID=510972). На вкладке Source Code (Исходный код) нажмите **Download** (Загрузить), чтобы скачать ZIP-архив с решением. 

    ![][12]


Это решение содержит два проекта:

+	**CatalogIndex** создает индекс поиска Azure и загружает данные из базы данных SQL Server, вложенной в проект.
+	**AdventureWorksWeb** — это приложение MVC4, запрашивающее индекс поиска Azure. Использование этого учебника предполагает наличие у вас достаточных знаний по работе с ASP.NET MVC.

<a id="sub-2"></a>
## Создание индекса Поиска Azure

На данном этапе с помощью **CatalogIndex** вы создадите новый индекс Поиска Azure, обозначаемый как "каталог" и строящийся на основе базы данных SQL Server AdventureWorks.

1.	В Visual Studio откройте демонстрационное решение на базе поиска Azure с названием **AdventureWorksCatalog.sln**.  
2.	Щелкните правой кнопкой мыши на **CatalogIndexer** в Обозревателе решений и выберите пункт **Назначить запускаемым проектом**, что приведет к запуску именно этого приложения, а не проекта **AdventureWorksWeb** после нажатия клавиши **F5**.
3.	Откройте файл **App.config** в этом проекте и присвойте параметрам "SearchServiceName" и "SearchServiceApiKey" соответствующие значения для доступа к службе Поиска Azure. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.
4.	Дополнительно в файле App.config находится параметр "SourceSqlConnectionString", который указывает на базу данных SQL Server 2014 Express (здесь сервер совпадает с базой данных LocalDB версии 11.0). При использовании другой версии SQL Server внесите в название сервера соответствующие изменения. Например, если имеется локальный экземпляр по умолчанию, можно использовать обозначения "(local)" или "localhost".
5.	Сохраните файл **App.config**.
6.	Нажмите клавишу **F5**, чтобы запустить проект.

Должна открыться командная оболочка со следующим текстом: "Создание индекса...".

Через некоторое она должна завершиться с текстовым сообщением "Завершено. Нажмите клавишу <enter>, чтобы продолжить:"

   ![][8]

Нажмите клавишу **Enter**, чтобы закрыть это приложение. На данном этапе произошло создание индекса для службы Поиска Azure.

> [AZURE.NOTE]Если возникнет ошибка, например "Недопустимое значение ключа attachdbfilename" или другая ошибка присоединения базы данных, возможно, существует конфликт на уровне контроля учетных записей. В целях данной демонстрации, обойдите полученные ошибки, выполнив следующие действия: скопируйте решение в новую или существующую папку (например, Temp), доступ к которой может получить любой зарегистрированный пользователь. Запустите Visual Studio с помощью команды **Запуск от имени администратора**. Откройте решение, выполните сборку, а затем нажмите клавишу **F5**, чтобы создать индекс.

Чтобы проверить создание индекса и состояние передачи документа, перейдите на панель мониторинга службы поиска на [портале управления Azure](https://portal.azure.com). Значение параметра "Использование" для индекса должно увеличиться на единицу, и в наличии должно быть 294 документа: по одному для каждого продукта из базы данных.

Щелкните на заголовок **Индексы**, чтобы открыть список индексов. В результате этого появится выпадающий список индексов, в котором должен присутствовать новый индекс и счетчик документов. Обратите внимание, что бесплатная версия позволяет иметь до трех индексов. Если у вас уже есть три индекса, удалите один из них, чтобы освободить место для нового.

   ![][9]


<a id="sub-3"></a>
## Обзор CatalogIndexer

А теперь давайте более подробно познакомимся с проектом **CatalogIndexer** и выясним принципы его работы.

1.	Откройте файл **Program.cs** из Обозревателя решений и перейдите к функции `Main(string[] args)`.

    Обратите внимание на то, каким образом эта функция создает универсальный код ресурса (URI) с именем `_serviceURI` на основе конкретной службы поиска Azure, а затем HttpClient с именем `_httpClient`, который использует ключ API для авторизации в этой службе поиска.

2.	`ChangeEnumeratorSql` и `ChangeSet` используются для перечисления данных из таблицы продуктов в базе данных SQL Server AdventureWorks.

3.	На основе данных, полученных из этой таблицы, выполняется вызов `ApplyChanges`, позволяющий применить эти данные к индексу поиска Azure.

4.	Перейдите к функции `ApplyChanges` в том же файле. Обратите внимание на то, каким образом эта функция выполняет удаление индекса, если он уже существует (`DeleteCatalogIndex`), а затем создает новый индекс с названием "каталог" (`CreateCatalogIndex`).

5.	Перейдите к функции `CreateCatalogIndex` и обратите внимание на то, как создается индекс по схеме, соответствующей столбцам из таблицы продуктов в SQL Server. В каждом поле имеется параметр "Тип" (например, `Edm.String` или `Edm.Double`), а также атрибуты, которые определяют предназначение этих полей. Более подробная информация о данных атрибутах приводится в [документации API REST для службы Поиска Azure](http://msdn.microsoft.com/library/azure/dn798935.aspx).

6.	Вернитесь к функции `ApplyChanges`. Обратите внимание на то, как эта функция циклически обрабатывает данные, имеющиеся в нумерованном списке изменений `ChangeSet`. Вместо того чтобы применять эти изменения последовательно, они разбиваются на группы по 1 000 штук, а затем передаются в службу Поиска. Такой подход является более эффективным по сравнению с последовательной обработкой документов.

Теперь после знакомства с процессом создания и заполнения индекса с помощью реляционных данных c SQL Server рассмотрим создание каталога продуктов, в котором используются эти поисковые данные.

<a id="sub-4"></a>
## Разработка приложения MVC4 с помощью Поиска Azure

На данном этапе мы создадим и запустим поисковое приложение в веб-браузере.

1.	В Visual Studio откройте демонстрационное решение на базе поиска Azure с названием **AdventureWorksCatalog.sln**.  

2.	Щелкните правой кнопкой мыши **AdventureWorksWeb** в обозревателе решений и выберите команду **Назначить запускаемым проектом**.

3.	Откройте в этом проекте файл **Web.config** и присвойте параметрам "SearchServiceName" и "SearchServiceApiKey" значения, соответствующие службе поиска Azure. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.

4.	Сохраните файл **Web.config**.

5.	Нажмите клавишу **F5**, чтобы запустить проект. Если возникнет ошибка сборки, следуйте инструкциям по [устранению неполадок](#err-mvc).

    ![][10]

6.	Оставьте поле поиска пустым и нажмите кнопку **Поиск**, при этом отобразятся все 294 продукта.

7.	Обратите внимание на перечень аспектов, расположенный с левой стороны. Нажмите на один из этих аспектов. Это приведет к повторному выполнению процедуры поиска, но при этом произойдет добавление выбранного вами аспекта для фильтрации обнаруженных результатов. В файле **HomeController.cs** можно добавить точку останова в первую строку функции `Search`, что позволит последовательно продвигаться по каждой строке нажатием клавиши F11.

7.	Введите поисковый шаблон, например "mountain bikes" (горные велосипеды). По мере ввода текстовых символов появится выпадающий список подсказок с обнаруженными по запросу результатами поиска.

    ![][11]

Рисунок, уже приводившийся в начале данного демонстрационного проекта, вновь приводится ниже в качестве напоминания об освещенных здесь вопросах. В предыдущих разделах обсуждались следующие темы: многоаспектная навигация (отображающаяся с левой стороны), счетчик документов, присутствующий вверху страницы, подсказки, параметры сортировки для отбора результатов по наибольшей степени соответствия, по алфавитному порядку или по цене.

   ![][7]


<a id="sub-5"></a>
## Обзор AdventureWorksWeb

Проект AdventureWorksWeb иллюстрирует, как можно использовать ASP.NET MVC 4 для организации взаимодействия между службой Поиска Azure и веб-приложением. В этом разделе будут рассмотрены отдельные части программного кода приложения и их предназначение.

1.	В обозревателе решений разверните узел **AdventureWorksWeb** | **Контроллер** и откройте **HomeController.cs**.

    Данный контроллер MVC предназначен для управления взаимодействием из окна просмотра индекса. В верхней части контроллера вы увидите ссылку на функцию `CatalogSearch _catalogSearch`, которая создает объект HttpClient для подключения к службе поиска Azure. Программный код для функции `CatalogSearch` находится в файле **CatalogSeach.cs**.

2. В фале **HomeController.cs** имеется две основные функции:

	**Поиск.** Когда пользователь нажимает кнопку поиска или выбирает какой-либо аспект, происходит вызов данной функции, предназначенной для сбора найденных результатов и отправки их в окно просмотра индекса для последующего отображения.

	**Подбор**. По мере ввода пользователем шаблона в поле поиска, происходит вызов данной функции, возвращающей список подсказок на основе информации, присутствующей в индексе Поиска Azure.

Давайте разберем работу двух этих функций более подробно.

3.	Присутствующая в файле **HomeController.cs** функция `Search` ссылается на функцию `_catalogSearch.Search`, которая, в свою очередь, содержит объект подключения к службе поиска Azure. При вызове поисковой функции из файла **CatalogSearch.cs** видно, что она использует эти параметры при создании запроса для службы поиска Azure. Результаты запроса сохраняются в объекте JSON с именем `result`, а затем возвращаются в окно просмотра `Index`, где обрабатываются и отображаются в виде веб-страницы.

4.	Откройте файл **Index.cshtml** из каталога Views | Home. Здесь есть программный код, отвечающий за обработку этих результатов.

5.	Остановите работу приложения, если оно запущено, и откройте файл **Index.cshtml** из каталога Views | Home. В конце этого файла имеется функция на языке JavaScript, которая использует `JQuery $(function ())`. Эта функция вызывается при загрузке страницы. В ней используется функция автозаполнения JQuery, которая связана с обратным вызовом от поискового текстового поля, обозначенного как "q". Когда пользователь вводит в это поле какой-либо текст, происходит вызов этой функции автозаполнения, которая в свою очередь вызывает функцию /home/suggest с введенным текстом. `/home/suggest` является ссылкой на функцию в **HomeController.cs**, которая называется `Suggest`.

6.	Откройте файл **HomeController.cs** и перейдите к функции "Suggest" (Подсказка). Данный программный код в значительной степени совпадает с функцией поиска (Search), которая использует объект `_catalogSearch` для вызова из файла **CatalogSearch.cs** функции с названием `Suggest`. Вместо отправки поискового запроса функция `Suggest` обращается к [API средств подбора](http://msdn.microsoft.com/library/azure/dn798936.aspx). которая на основе введенного в текстовое поле шаблона формирует список возможных подсказок. Эти значения возвращаются в файл **Index.cshtml** и автоматически отображаются в поле поиска по мере ввода поискового шаблона.

Здесь может возникнуть вопрос относительно критериев, на основе которых служба Поиска Azure выполняет отбор полей, используемых для формирования подсказок. Ответ на него был дан ранее в разделе о создании индекса. В функции `CreateCatalogIndex` из файла Program.cs в проекте **CatalogIndexer** присутствует атрибут с именем `Suggestions`. Если данный атрибут имеет значение `True`, это означает, что служба поиска Azure может использовать его в качестве поля для получения подсказок

Давайте это проверим.

7.	Скомпилируйте приложение еще раз, а затем нажмите клавишу **F5**, чтобы его запустить.

8.	В поле поиска введите слово "Road" (Дорога). После непродолжительного времени вы увидите отображающийся внизу текстового поля список товаров с подсказками, которые могут заинтересовать пользователя.

Можно добавить точку останова в функцию `Suggest` из файла **HomeController.cs** и последовательно отследить каждый вызов, который выполняется для формирования списка подсказок, нажимая клавишу F11.

На этом демонстрация проекта завершена. Вы познакомились со всеми основными операциями, о которых нужно знать при создании приложения на базе ASP.NET MVC4 с использованием Поиска Azure.


<a id="err-mvc"></a>
## Устранение ошибки "Невозможно загрузить файл или сборку System.Web.Mvc"

Если при сборке AdventureWorksWeb вы получаете сообщение об ошибке Could not load file or assembly 'System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35' or one of its dependencies (Невозможно загрузить файл или сборку System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35 или один из зависимых компонентов), попробуйте выполнить эти действия, чтобы устранить ошибку.

1. Откройте консоль диспетчера пакетов, последовательно выбрав пункты **Сервис** | **Диспетчер пакетов NuGet** | **Консоль диспетчера пакетов**.
2. В командной строке PM> введите Update-package -reinstall Microsoft.AspNet.Mvc.
3. Когда вам будет предложено перезагрузить файл, выберите **Yes to All** (Да для всех).
4. Повторно выполните сборку и попробуйте еще раз нажать **F5**.


<a id="next-steps"></a>
## Дальнейшие действия

Для самостоятельного изучения дополнительных возможностей попробуйте добавить страницу "Details" (Сведения), которая открывается, когда пользователь нажимает указателем мыши на один из поисковых результатов. В качестве подготовки выполните следующие действия:

+	Изучите [API Lookup](http://msdn.microsoft.com/library/azure/dn798929.aspx), это позволит выполнять отправку запросов в службу Поиска Azure для вызова определенного документа (например, можно передавать параметр "productID", отвечающий за идентификацию товара).
+	Добавьте новую функцию в файл **HomeController.cs** и присвойте ей название "Details" (Сведения). Добавьте соответствующее поле просмотра **Details.cshtml**, которое будет получать результаты от упомянутой API Lookup и отображать их.
+	Ознакомьтесь со следующими дополнительными примерами программного кода и видеоматериалами, относящимися к теме геопространственного поиска: [Channel 9. Поиск Azure и геопространственные данные](http://channel9.msdn.com/Shows/Data-Exposed/Azure-Search-and-Geospatial-Data) и [CodePlex. Пример использования геопространственного поиска Azure](http://azuresearchgeospatial.codeplex.com).

Также можно ознакомиться с документацией [API REST для службы Поиска Azure](http://msdn.microsoft.com/library/azure/dn798935.aspx) в MSDN.


<!--Anchors-->
[Prerequisites]: #sub-1
[Create an Azure Search index]: #sub-2
[Explore CatalogIndexer]: #sub-3
[Build an MVC4 Application using Azure Search]: #sub-4
[Explore AdventureWorksWeb]: #sub-5
[Next steps]: #next-steps


<!--Image references-->
[7]: ./media/search-create-first-solution/AzureSearch_Create1_WebApp.PNG
[8]: ./media/search-create-first-solution/AzureSearch_Create1_ConsoleMsg.PNG
[9]: ./media/search-create-first-solution/AzureSearch_Create1_DashboardIndexes.PNG
[10]: ./media/search-create-first-solution/AzureSearch_Create1_WebAppEmpty.PNG
[11]: ./media/search-create-first-solution/AzureSearch_Create1_Suggestions.PNG
[12]: ./media/search-create-first-solution/AzureSearch_Create1_CodeplexDownload.PNG

<!---HONumber=July15_HO2-->