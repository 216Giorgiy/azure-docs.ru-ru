<properties pageTitle="Azure Search "Frequently Bought Together" recommendations | Microsoft Azure | Apache Mahout | Azure Machine Learning" description="Sample code for adding Frequently Bought Together, New For You, or Also Bought recommendations to an Azure Search application using Apache Mahout or Azure Machine Learning" services="search" documentationCenter="" authors="liamca" manager="pablocas" editor="" tags="machine learning"/>

<tags
   ms.service="search"
   ms.devlang="dotnet"
   ms.workload="search"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.date="11/12/2015"
   ms.author="liamca"/>

# Рекомендации "Часто покупают вместе" службы поиска Azure

Если вы когда-либо делали покупки в интернет-магазинах, вероятно, вы успели заметить такие формулировки, как "Часто покупают вместе" или "Посетители, которые заказывают этот продукт, также приобретают" или даже список "Новинки" с перечнем дополнительных товаров или услуг. Как правило, эти данные компилируются интернет-магазинами на основе журнала покупок многих клиентов или же это просто данные о предпочтениях, уникальных для каждого клиента. Возможность предоставления соответствующих, ориентированных на потребителя рекомендаций посредством поиска является мощным дополнением не только к коммерческим приложениям, но и к сайтам, предоставляющим мультимедийное содержимое или информацию.

В приложениях поиска Azure можно реализовать рекомендации, написав дополнительный код, который объединяет данные и службы, используемые для определения шаблонов и связей в данных, а затем преобразует их в рекомендации, подходящие пользователям.

[В этом примере показано, как](https://github.com/liamca/azure-search-recommendations) использовать [Apache Mahout]() для системы рекомендаций.

В оставшейся части этой статьи вы познакомитесь с примером кода, добавляющего рекомендации "Часто смотрят вместе", на основе образца данных о просмотре фильмов.

![1](./media/search-fbt-recommendations/product_recommendations.png)

## Что такое рекомендация?

*Рекомендации* — это методика для получения дополнительных элементов из каталога на основе существующих действий пользователя по поиску (например, веб-журналы). Она используется для рекомендации элементов и улучшения преобразования.

Обучение систем рекомендаций часто выполняется за счет последнего действия клиента или путем сбора данных непосредственно из цифрового магазина. В этом примере для сбора данных рекомендаций используется Apache Mahout.

В число распространенных рекомендаций входят следующие: "Часто покупают вместе" — клиент, купивший тот товар, также купил этот товар. Рекомендации "Клиент — продукт": клиент так же, как вы, приобрел этот товар

## Создание индекса поиска Azure

- Откройте решение AzureSearchMovieRecommendations.sln и задайте ImportAzureSearchIndexData в качестве проекта по умолчанию.  
- Откройте файл Program.cs в ImportAzureSearchIndexData и измените параметры SearchServiceName и SearchApiKey так, чтобы они указывали на службу поиска Azure.
- Загрузите hetrec2011-movielens-2k.zip из http://grouplens.org/datasets/hetrec-2011/ и скопируйте файлы Movies.dat и user\_ratedmovies.dat в каталог \\ImportAzureSearchIndexData\\data.
- Запустите проект для создания индекса и загрузки данных фильма. 
- В конце приложения выполните тестовый поиск.

## Создание простого HTML-приложения для поиска фильмов

Завершенное веб-приложение JavaScript, которое позволяет запрашивать индекс поиска Azure, можно найти здесь: \\WebSite\\starter-template-complete.

Чтобы просмотреть демонстрацию с нуля, исходный CSS-файл можно найти здесь: \\WebSite\\starter-template.

Откройте файл search.js в \\WebSite\\starter-template-complete и обновите apiKey и azureSearchService сведениями службы поиска Azure.

У вас должна быть возможность открывать этот файл в браузере, например Chrome, чтобы просматривать фильмы, вводя их название в поле поиска.

## Команда для выполнения создания рекомендаций с использованием Mahout

- Отправьте файл data\\movie\_usage.txt в хранилище BLOB-объектов Azure. 
- Создайте экземпляр HDInsight (включив удаленный рабочий стол) и подключитесь к компьютеру через приложение удаленного рабочего стола (доступно на портале Azure).
- На компьютере HDInsight откройте "командную строку Hadoop".
- Перейдите в каталог Mahout bin по адресу: c:\\apps\\dist. В данном случае он выглядит следующим образом, но вы можете получить обновленную версию Mahout: C:\\apps\\dist\\mahout-1.0.0.2.3.3.0-2992\\bin.
- Выполните следующую команду, где замените [CONTAINER] и [STORAGEACT] сведениями о хранилище Azure (где находится файл movie\_usage.txt):

    mahout itemsimilarity -s SIMILARITY\_COSINE --input "wasb://[CONTAINER]@[STORAGEACT].blob.core.windows.net/movie\_usage.txt" --output "wasb://[CONTAINER]@[STORAGEACT].blob.core.windows.net/output/" --tempDir "wasb://[CONTAINER]@[STORAGEACT].blob.core.windows.net/temp" -m 5

Процесс длится несколько минут. По его завершении ваш контейнер хранилища должен содержать следующий файл с рекомендациями фильма: /movies/output/part-r-00000.

В этом файле находятся 3 столбца: [Идентификатор элемента фильма], [Идентификатор элемента рекомендаций, относящихся к этому фильму], [Процент сходства].

## Импорт данных из Mahout в службу поиска Azure

Программа, создавшая индекс поиска Azure, также создала поле с именем `Recommendations`, имеющим тип Collection (который аналогичен набору строк, разделенных запятыми). Мы объединим данные, созданные на предыдущем шаге, с этим индексом поиска Azure.

- Из решения AzureSearchMovieRecommendations.sln Visual Studio откройте файл Program.cs в MahoutOutputLoader.
- Обновите SearchServiceName и SearchApiKey сведениями службы поиска Azure.
- Обновите StorageApiKey и StorageAccountName сведениями учетной записи хранилища Azure, для которых вы сохранили файл рекомендаций Mahout.
- Запустите приложение, чтобы объединить данные.
 
## Визуализация рекомендаций
На этом этапе вы можете вернуться в веб-приложение и щелкнуть любой фильм, чтобы просмотреть рекомендации.

Чтобы увидеть, каким образом были возвращены рекомендации при щелчке изображения, откройте файл Search.js и взгляните на функцию openMovieDetails().

## Материалы

Данные предоставлены лабораторией GroupLens (http://grouplens.org/datasets/hetrec-2011/).

Сведения о лицензировании этих данных см. на странице по адресу: http://files.grouplens.org/datasets/hetrec2011/hetrec2011-movielens-readme.txt

<!---HONumber=Nov15_HO4-->