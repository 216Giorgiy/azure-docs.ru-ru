---
title: "Как реализовать фасетную навигацию в службе Поиск Azure | Документация Майкрософт"
description: "Добавьте фасетную навигацию в приложения, которые интегрируются с Поиском Azure, размещенной облачной службой поиска в Microsoft Azure."
services: search
documentationcenter: 
author: HeidiSteen
manager: mblythe
editor: 
ms.assetid: cdf98fd4-63fd-4b50-b0b0-835cb08ad4d3
ms.service: search
ms.devlang: rest-api
ms.workload: search
ms.topic: article
ms.tgt_pltfrm: na
ms.date: 10/17/2016
ms.author: heidist
translationtype: Human Translation
ms.sourcegitcommit: dcda8b30adde930ab373a087d6955b900365c4cc
ms.openlocfilehash: f70240f2bebca76872194e556cf9cae9130b56db


---
# <a name="how-to-implement-faceted-navigation-in-azure-search"></a>Как реализовать фасетную навигацию в службе поиска Azure
Фасетная навигация представляет собой механизм фильтрации, обеспечивающий самоуправляемую детализированную навигацию в приложениях поиска. Хотя термин "фасетная навигация" может быть неизвестен вам, можно утверждать, что вы ранее использовали этот механизм. Как показано в следующем примере, фасетная навигации — это не что иное, как категории, с помощью которых фильтруются результаты.

## <a name="what-it-looks-like"></a>Принцип работы
 ![][1]

С помощью фасетов вы можете найти нужные данные. Вероятность нулевого результата сводится к нулю. Используя фасеты, разработчики могут определить наиболее полезные условия поиска для навигации в пределах совокупности искомых данных. В интерактивных приложениях для розничного торговли в фасетной навигации часто используются такие категории, как торговые марки, отделы (например, "Детская обувь"), размер, цена, популярность и оценки. 

Способ реализации фасетной навигации зависит от технологии поиска и может представлять из себя очень сложный процесс. В службе поиска Azure фасетная навигации реализуется при подаче запроса с использованием полей атрибутов, ранее указанных в схеме. Создаваемые приложением запросы должны включать *параметры запроса фасета* , чтобы обеспечить получение доступных значений фильтра фасетов для получаемого в результате набора документов. Чтобы усечь результирующий набор документов, приложение должно применить выражение `$filter` .

С точки зрения разработки приложений основная задача — написать код, который создает запросы. Часто фасетная навигация реализуется в приложениях с помощью службы, которая среди прочего обеспечивает встроенную поддержку настройки диапазонов и получение количества результатов, полученных с использованием фасета. Кроме того, служба включает понятные значения по умолчанию, которые помогают упростить структуру навигации. 

Эта статья состоит из следующих разделов.

* [Построение запроса](#howtobuildit)
* [Создание уровня представления данных](#presentationlayer)
* [Создание индекса](#buildindex)
* [Проверка качества данных](#checkdata)
* [Создание запроса](#buildquery)
* [Советы по управлению фасетной навигацией](#tips)
* [Фасетная навигация на основе диапазона значений](#rangefacets)
* [Фасетная навигация на основе геоточек](#geofacets)
* [Попробуйте сейчас](#tryitout)

## <a name="why-use-it"></a>Преимущества
Наиболее эффективные приложения поиска поддерживают несколько моделей взаимодействия, помимо поля поиска. Фасетная навигации — альтернативная точка входа в поиск, которую можно использовать вместо того, чтобы вручную вводить сложные выражения поиска.

## <a name="know-the-fundamentals"></a>Принципы работы
Если вы ранее не разрабатывали средства поиска, представьте, что фасетная навигация обеспечивает возможности самоуправляемого поиска. Это тип детализированного поиска на основе предопределенных фильтров, который позволяет быстро сузить результаты поиска с помощью интерактивных действий. 

**Модель взаимодействия**

При фасетной навигации поиск является итеративным, поэтому его следует рассматривать как последовательность запросов, которые развертываются в ответ на действия пользователя.

Начальная точка — страница приложения, которая обеспечивает фасетную навигацию (возможности которой, как правило, представлены на периферии). Часто фасетная навигации представляет из себя древовидную структуру с флажками для каждого значения или текстом, который можно щелкнуть. 

1. В запросе, отправляемом в службу поиска Azure, с помощью одного или нескольких параметров запроса фасета указывается структура фасетной навигации. Например, запрос может включать элемент `facet=Rating` с необязательным параметром `:values` или `:sort`, дополнительно уточняющим представление данных.
2. Уровень представления данных прорисовывает страницу поиска с возможностями фасетной навигации, используя указанные в запросе фасеты.
3. Если структура фасетной навигации включает оценку, чтобы отобразить исключительно продукты с оценкой 4 или выше, пользователю нужно щелкнуть "4". 
4. В ответ приложение отправляет запрос, включающий `$filter=Rating ge 4` 
5. Уровень представления данных обновляет страницу, показывая сокращенный результирующий набор, который содержит только элементы, соответствующие новым условиям (в этом случае — продукты с оценкой 4 и выше).

Фасет — это параметр запроса. Однако его не следует путать с входными данными запроса. Он никогда не используется в качестве критериев выбора в запросе. Вместо этого рассматривайте параметры запроса фасета как входные данные в структуре переходов, возвращаемой в ответе. Для каждого указанного вами параметра запроса фасета служба поиска Azure определяет, сколько документов содержат частичные результаты для каждого значения фасета.

Обратите внимание на выражение `$filter` в шаге 4. Это важный аспект фасетной навигации. Хоть фасеты и фильтры являются независимыми в интерфейсе API, для реализации нужных возможностей вам понадобятся и те, и другие. 

**Шаблоны проектирования**

В коде приложения шаблон состоит в использовании параметров запроса фасета для возврата структуры фасетной навигации вместе с результатами фасета, а также выражения $filter, которое обрабатывает событие, выполняемое щелчком. Представьте выражение `$filter` кодом, который обеспечивает фактическое усечение результатов поиска, возвращаемых на уровень представления данных. Предположим, что у нас есть фасет Colors (Цвета). Если щелкнуть цвет Red (Красный), с помощью выражения `$filter` будут выбраны элементы исключительно красного цвета. 

**Основы запроса в службе поиска Azure**

В службе поиска Azure запрос указывается с помощью одного или нескольких параметров запроса (описание каждого из них приведено в [статье, посвященной поиску документов](http://msdn.microsoft.com/library/azure/dn798927.aspx) ). Ни один из параметров запроса не является обязательным, но при этом необходимо указать по крайней мере один параметр запроса.

Точность, которая обычно рассматривается как возможность фильтровать ненужные совпадения, обеспечивается с помощью одного или обоих следующих выражений.

* **search=**<br/>
  Значение этого параметра представляет из себя выражение поиска. Это может быть текстовый фрагмент или сложное выражение поиска, которое включает в себя несколько условий и операторов. На сервере выражение поиска используется для полнотекстового поиска. Оно запрашивает соответствующие условия в индексе в пределах полей, поддерживающих поиск, и возвращает результаты в порядке ранжирования. Если задать для выражения `search` значение NULL, запрос будет выполняться в пределах всего индекса (то есть `search=*`). В этом случае другие элементы запроса, такие как `$filter` или профиль оценки, будут основными факторами, определяющими возвращаемые документы (`($filter`) и порядок их возвращения (`scoringProfile` или `$orderb`y).
* **$filter=**<br/>
   Фильтр — это мощный механизм ограничения количества результатов поиск а на основе значений атрибутов конкретных документов. Сначала оценивается выражение `$filter` , после чего логика по фасетному принципу создает допустимые значения и определяет количественные показатели каждого из них.

Сложные выражения поиска снижают производительность запроса. По возможности используйте правильно сформированные выражения фильтров, чтобы повысить точность и производительность запросов.

Чтобы лучше понять, как фильтр улучшает точность поиска, сравните сложное выражение поиска с выражением, которое включает в себя выражение фильтра.

* `GET /indexes/hotel/docs?search=lodging budget +Seattle –motel +parking`
* `GET /indexes/hotel/docs?search=lodging&$filter=City eq ‘Seattle’ and Parking and Type ne ‘motel’`

Несмотря на то, что оба запроса являются допустимыми, второй предпочтителен, если вы гостиницы, отличные от мотелей, с парковкой в Сиэтле. В первом запросе используются конкретные слова, которые упоминаются или не упоминаются в полях строк, таких как Name (Имя) или Description (Описание), и других полях с данными, поддерживающими поиск. Второй запрос выполняет поиск точных совпадений среди структурированных данных и, скорее всего, вернет гораздо более точные результаты.

В приложениях, содержащих фасетную навигацию, необходимо убедиться, что все действия, который выполняет пользователь со структурой фасетной навигации, сопровождаются сужением результатов поиска с помощью выражения фильтра.

<a name="howtobuildit"></a>

## <a name="how-to-build-it"></a>Построение запроса
Фасетная навигации в службе поиска Azure реализуется в коде приложения, создающем запрос, но зависит от предопределенных элементов схемы.

В индексе поиска предопределяются такие элементы, как атрибут индекса `Facetable [true|false]` , который задается для выбранных полей, чтобы включить или отключить их использование в структуре фасетной навигации. Если поле не содержит атрибута `"Facetable" = true`, его невозможно использовать в фасетной навигации.

Во время выполнения запроса код приложения создает запрос, который включает элемент `facet=[string]`— параметр запроса, указывающий поле для фасетной навигации. Запрос может содержать несколько фасетов, таких как `&facet=color&facet=category&facet=rating`, которые разделяются символов "амперсанд" (&).

Кроме того, код приложения также должен создать выражение `$filter` для обработки событий, выполняемых при щелчке, во время фасетной навигации. Выражение `$filter` сокращает количество результатов поиска, используя значение фасета в качестве условия фильтра.

Служба поиска Azure возвращает результаты поиска на основе условий, которые ввел пользователь, обновляя при этом структуру фасетной навигации. В службе поиска Azure фасетная навигация представляет из себя одноуровневую структуру со значениями фасетов и количеством результаты, найденных для каждого из них.

Уровень представления данных в коде обеспечивает взаимодействие с пользователем. Он должен содержать составные части фасетной навигации, например метку, значения, флажки и счетчик. Интерфейс API REST службы поиска Azure не зависит от платформы, поэтому вы можете использовать любой язык и платформу. Важно включить элементы пользовательского интерфейса, поддерживающие добавочное обновление. При этом состояние пользовательского интерфейса должно обновляться при выборе каждого дополнительного фасета. 

В следующих разделах мы более подробно рассмотрим, как создать каждую из составных частей запроса, начиная с уровня представления данных.

<a name="presentationlayer"></a>

## <a name="build-the-presentation-layer"></a>Создание уровня представления данных
Уровень представления данных позволяет определить требования, которые в противном случае могли бы быть упущены. Кроме того, вы узнаете, какие возможности являются ключевыми для выполнения поиска.

С точки зрения фасетной навигации ваша веб-страница или страница приложения отображает структуру фасетной навигации, обнаруживает данные, которые пользователь ввел на странице, и вставляет измененные элементы. 

В веб-приложениях на уровне представления данных обычно используется технология AJAX, так как она позволяет обновлять добавочные изменения. Вы также можете использовать ASP.NET MVC или любую другую платформу визуализации, которая поддерживает подключение к службе поиска Azure по протоколу HTTP. Пример приложения, который приводится в этой статье ( **AdventureWorks Catalog** ), — это приложение ASP.NET MVC.

В следующем примере, взятом из файла **index.cshtml** примера приложения, создается динамическая структура HTML для отображения фасетной навигации на странице результатов поиска. В этом примере фасетная навигации встроена в страницу результатов поиска и отображается после того, как пользователь отправит условие поиска.

Обратите внимание, что каждый фасет имеет метку, например Colors (Цвета), Categories (Категории) и Prices (Цены), привязку к полю фасета (color, categoryName, listPrice) и параметр `.count` , который возвращает данные о количестве элементов, найденных для соответствующего результата фасета.

  ![][2]

> [!TIP]
> При разработке страницы результатов поиска не забудьте включить механизм очистки фасетов. Если использовать флажки, пользователи интуитивно поймут, как очистить фильтры. Для других структур может понадобиться шаблон навигации или другой нестандартный элемент. Например, в примере приложения AdventureWorks Catalog можно щелкнуть название (AdventureWorks Catalog), чтобы сбросить настройки страницы поиска.
> 
> 

<a name="buildindex"></a>

## <a name="build-the-index"></a>Создание индекса
Поддержка фасетов включается для каждого поля в индексе по отдельности с помощью этого атрибута индекса: `"Facetable": true`.  
Для всех типов полей, которые можно использовать в фасетной навигации, по умолчанию устанавливается значение `Facetable` . К таким типам полей относятся `Edm.String`, `Edm.DateTimeOffset` и все типы числовых полей (по сути, поддержкой фасетов отличаются все типы полей, за исключением `Edm.GeographyPoint`, который невозможно использовать в фасетной навигации). 

При создании индекса с помощью фасетной навигации рекомендуется явно отключить поддержку фасетов для полей, которые не должны использоваться в качестве фасетов.  В частности, для полей строк одноэлементных значений, таких как идентификатор или название продукта, следует задать значение `"Facetable": false` во избежание их случайного (и неэффективного) использования при фасетной навигации.

Ниже приведена схема для примера приложения AdventureWorks Catalog (некоторые атрибуты усечены, чтобы уменьшить общий размер).

 ![][3]

Обратите внимание, что атрибут `Facetable` отключен для полей строк, которые не должны использоваться в качестве фасетов (например, идентификатор или имя). Отключение поддержки фасетов в случаях, где она не нужна, обеспечивает небольшой размер индекса и обычно улучшает производительность.

> [!TIP]
> Для каждого поля рекомендуется включить полный набор атрибутов индекса. Хотя атрибут `Facetable` по умолчанию активируется для практически всех полей, в случае намеренной установки каждого атрибута вы можете продумать, как применить каждое решение схемы. 
> 
> 

<a name="checkdata"></a>

## <a name="check-for-data-quality"></a>Проверка качества данных
При разработке любого приложения для обработки данных одной из самых трудоемких задач часто является подготовка данных. Приложения поиска — не исключение. Качество данных напрямую влияет на должное функционирование и эффективность структуры фасетной навигации, помогая создавать фильтры, которые уменьшают размер результирующего набора.

В службе поиск Azure совокупность искомых данных состоит из документов, которые заполняют индекс. Документы предоставляют значения, используемые для вычисления фасетов. Если вы хотите выполнять поиск по такому аспекту, как Brand (Торговая марка) или Price (Цена), то каждый документ должен содержать допустимые, согласованные и эффективные значения *BrandName* и *ProductPrice*, используемые для фильтрации.

Ниже перечислены несколько напоминаний о том, как повысить эффективность поиска.

* Определите, содержит ли каждое из полей, используемых в качестве фасетов, значения, которые можно использовать как фильтры при самоуправляемом поиске. Значения должны быть краткими, описательными и в достаточной мере отличительными для разграничения различных параметров.
* Опечатки или близкие значения. Если вы используете фасет Color (Цвет), а значения полей включают Orange (Оранжевый) и Ornage (опечатка), фасет, в основе которой лежит поле Color (Цвет), выберет оба значения.
* Использование текста, написанного прописными и строчными буквами, также может негативно отразиться на фасетной навигации, так как элементы orange и Orange будут считаться двумя разными значениями. 
* Если одно значение указано в единственном и множественном числе, для каждой формы будет создан отдельный фасет.

Как вы видите, тщательная подготовка данных обеспечивает максимальную эффективность фасетной навигации.

<a name="buildquery"></a>

## <a name="build-the-query"></a>Создание запроса
В коде, написанном для построения запросов, следует указать все компоненты допустимого запроса, включая выражения поиска, фасеты, фильтры и профили оценки, то есть все элементы, используемые для создания запроса. В этом разделе мы изучим роль фасетов в создании запроса и покажем, как использовать с ними фильтры для сокращения размера результирующего набора.

Лучше всего начать с примера. В следующем примере, взятом из файла **CatalogSearch.cs** , создается запрос, используемый для фасетной навигации с использованием фасетов Color (Цвет), Category (Категория) и Price (Цена). 

Обратите внимание, что фасеты являются неотъемлемой частью этого примера приложения. При поиске в приложении AdventureWorks Catalog используются фасетная навигация и фильтры. Об этом свидетельствует место, которое занимают элементы фасетной навигации на странице. Пример приложения включает параметры универсального кода ресурса (URI) для фасетов (цвет, категория, цены) в качестве свойств метода поиска (согласно особенностям примера приложения).

  ![][4]

Параметр запроса аспекта задается для поля и (в зависимости от типа данных) может дополняться списком параметров, разделенных запятыми, таких как `count:<integer>`, `sort:<>`, `intervals:<integer>` и `values:<list>`. Список значений, создаваемый при настройке диапазонов, поддерживает числовые данные. Дополнительные сведения об использовании см. в статье [Поиск документов (API REST службы поиска Azure)](http://msdn.microsoft.com/library/azure/dn798927.aspx).

Создаваемый с помощью приложения запрос должен включать, помимо фасетов, также и соответствующие фильтры, которые позволяют сузить набор документов на основе выбранного значения фасета. Предположим, что вы ищете велосипед в специализированном магазине. С помощью фасетной навигации вы можете узнать о имеющихся в наличии велосипедах по цвету, производителю и типу. Используя фильтрацию, вы можете найти, к примеру, горные велосипеды красного цвета в указанном ценовом диапазоне.

Если пользователь щелкнет Red, чтобы отобразить только велосипеды красного цвета, отправляемый приложением запрос будет включать фрагмент `$filter=Color eq ‘Red’`.

## <a name="best-practices-for-faceted-navigation"></a>Советы и рекомендации по фасетной навигации
Ниже приведено несколько советов и рекомендаций.

* **Точность**<br/>
   Используйте фильтры. Если вы полагаетесь исключительно на выражения поиска, выделение корней приведет к возврату документа, поля которого не будут содержать точных значений фасетов. 
* **Целевые поля**<br/>
   Как правило, при детализации с использованием фасетов требуется включать только документы, содержащие значение фасета в конкретном (фасетном) поле, а не во всех полях, которые поддерживают поиск. Если добавить фильтр, поиск соответствующего значения будет выполнен только в поле фасета.
* **Эффективное использование индекса**<br/>
  Если в приложении используется исключительно фасетная навигации (без поля поиска), то вы можете задать для поля атрибуты `searchable=false`, `facetable=true`, чтобы сократить размер индекса. Кроме того, индексируются только целые значения фасетов, а не фрагменты слов или компоненты многосложных значений.
* **Производительность**<br/>
   Фильтры позволяют сузить набор документов для поиска и исключить их из ранжирования. Если у вас имеется большой набор документов, фасетная детализация с использованием выбранных фасетов часто значительное повышает эффективность поиска.

<a name="tips"></a> 

## <a name="tips-on-how-to-control-faceted-navigation"></a>Советы по управлению фасетной навигацией
Ниже приведены советы и рекомендации по конкретным вопросам.

**Используя фасетную навигацию, добавляйте метки для всех полей.**

Метки обычно определяются в HTML-файле или форме (**index.cshtml** в примере приложения). В службе поиска Azure не предусмотрен интерфейс API для работы с метками фасетной навигации или другими метаданными.

**Определите поля, которые можно использовать в качестве фасетов.**

Вспомним, что схема индекса определяет, какие поля можно использовать в качестве фасетов. Если поля поддерживают фасеты, в запросе указываются поля, по которым следует выполнять поиск с использованием фасетов. Поле, по которому выполняется поиск, предоставляет значения, которые отображаются под меткой. 

Значения, которые отображаются под каждой меткой, извлекаются из индекса. Например, если используется поле фасета *Color*(Цвет), дополнительная фильтрация будет выполняться по доступным значениям этого поля, таким как Red (Красный), Black (Черный) и так далее.

Для числовых значений, а также значений даты и времени можно явно задать значения поля фасета (например, `facet=Rating,values:1|2|3|4|5`). Поля этих типов поддерживают список значений, что позволяет упростить разделение целевых фасетов по смежным диапазонам (диапазонам на основе числовых значений или периодов времени). 

**Сокращайте количество результатов, получаемых при использовании фасета.**

Фасеты позволяют отобразить в результатах поиска документы, соответствующие определенному фасету. В следующем примере результаты поиска фразы *cloud computing* (облачные вычисления) включают 254 элемента с типом содержимого *internal specification* (внутренняя спецификация). Элементы не обязательно взаимно исключают друг друга. Если элемент соответствует условиям обоих фильтров, он учитывается в каждом из них. Это возможно при фасетном поиске в полях `Collection(Edm.String)` , которые часто используются для обозначения документов тегами.

        Search term: "cloud computing"
        Content type
           Internal specification (254)
           Video (10) 

Как правило, если вам кажется, что при использовании фасета вы получаете слишком много результатов, мы рекомендуем добавить фильтры, как описано в предыдущих разделах, чтобы пользователи приложения могли сузить область поиска.

**Ограничивайте число элементов, используемых при фасетной навигации.**

Для каждого поля фасета в дереве навигации по умолчанию можно задать не более 10 значений. Это упрощает структуру переходов, позволяя управлять списком значений. Вы можете переопределить это ограничение по умолчанию, указав соответствующее число.

* Параметр `&facet=city,count:5` указывает, что при применении фасета будут возвращены только первые 5 городов с наивысшим приоритетом. Предположим, вы задали условие поиска airport (аэропорт) и получили 32 совпадения. Если при этом включить в запрос параметр `&facet=city,count:5`, то в результаты поиска, полученные при использовании фасета, будут включены только первые пять уникальных городов с наибольшим количеством документов.

Обратите внимание на различие между результатами применения фасета и результатами поиска. Результаты поиска — это все документы, которые удовлетворяют условиям запроса. Результаты фасета — это совпадения для каждого значения фасета. В этом примере результаты поиска будут включать названия городов, которые не входят в список классификации фасета (в этом случае — 5). Результаты, которые фильтруются посредством фасетной навигации, отображаются пользователям, когда они удаляют фасеты или выбирают другие фасеты помимо City (Город). 

> [!NOTE]
> Если имеются фасеты несколько типов, параметр `count` может привести к отображению различных данных. В следующей таблице вкратце описывается, как этот параметр используется в интерфейсе API службы поиска Azure, примере кода и документации. 
> 
> 

* `@colorFacet.count`<br/>
   В коде представления данных фасет включает параметр количества, который используется для отображения числа результатов, полученных при использовании фасета. В результатах применения фасета параметр count указывает на число документов, соответствующих условию одного или диапазону нескольких фасетов.
* `&facet=City,count:12`<br/>
   В запросе фасета вы можете задать значение параметра count.  Значение по умолчанию — 10, но его можно изменить. Если задать значение `count:12` , результаты применения фасета будут включать 12 лучших совпадений по числу документов.
* "`@odata.count`"<br/>
   В ответе на запрос это значение указывает количество совпадений в результатах поиска. В среднем оно превышает суммарное число результатов применения фасета из-за наличия элементов, которые соответствуют условию поиска, но при этом не совпадают со значениями фасета.

**Уровни фасетной навигации** 

Как уже упоминалось, фасеты невозможно непосредственно вкладывать в иерархию. По умолчанию фасетная навигация поддерживает только один уровень фильтров. Однако это ограничение можно обойти. Вы можете кодировать иерархическую структуру фасета в `Collection(Edm.String)` с одной точкой входа для одной иерархии. Обход этого ограничения выходит за рамки настоящей статьи, но дополнительные сведения о коллекциях приведены в [статье, посвященной примерам использования протокола OData](http://msdn.microsoft.com/library/ff478141.aspx). 

**Проверка полей**

При динамическом создании списка фасетов на основе данных, введенных ненадежными пользователями, следует проверить допустимость имен полей фасетов или исключить имена при создании URL-адресов с помощью параметра `Uri.EscapeDataString()` в .NET или его эквивалента в другой платформе.

**Количество результатов применения фасета**

При добавлении фильтра в фасетный запрос вам может потребоваться сохранить инструкцию фасета (например, `facet=Rating&$filter=Rating ge 4`). С технической точки зрения элемент facet=Rating не требуется, но он позволяет возвратить количество значений фасетов для оценок, начиная с 4 и выше. Например, если пользователь щелкнет "4", а запрос включает фильтр для отображения оценок, начиная с "4", будут возвращены количественные показатели для каждой оценки от 4 и выше.  

**Сегментирование количественных показателей фасета**

В определенных ситуациях может оказаться, что количественные показатели аспектов не соответствуют результирующим наборам (ознакомьтесь с [сообщением на форуме, посвященным фасетной навигации в Поиске Azure](https://social.msdn.microsoft.com/Forums/azure/06461173-ea26-4e6a-9545-fbbd7ee61c8f/faceting-on-azure-search?forum=azuresearch)).

Такие неточности обусловлены особенностями архитектуры сегментирования. Каждый индекс поиска включает несколько сегментов, каждый из которых в свою очередь содержит сведения о числе наиболее соответствующих фасетов, которые затем объединяются в единый результат. Если некоторые сегменты включают много совпадающих значений, в то время как другие сегменты содержат меньше значений, некоторые значения фасетов могут отсутствовать или не учитываться в результатах.

Хотя такое поведение может измениться в любое время, при наличии подобных проблем их можно устранить, искусственно увеличив значение параметра count:<number> к очень большому числу, чтобы затребовать отображение всех данных с каждого сегмента. Если значение параметра count: больше или равно количеству уникальных значений в поле, вы гарантировано получите точные результаты. Однако если имеется очень много документов, производительность снижается, поэтому выполняйте эти действия рассудительно.

<a name="rangefacets"></a>

## <a name="facet-navigation-based-on-a-range-values"></a>Фасетная навигация на основе диапазона значений
В приложениях поиска часто используется фасетная навигация на основе диапазонов значений. Поддерживаются диапазоны числовых данных, а также значений даты и времени. Каждый подход подробно описан в [статье, посвященной поиску документов с помощью интерфейса API службы поиска Azure)](http://msdn.microsoft.com/library/azure/dn798927.aspx).

Служба поиска Azure упрощает создание диапазонов, обеспечивая два способа их вычисления. В обоих способах служба поиска Azure создает соответствующие диапазоны с учетом данных, которые вы ввели. Например, если указать диапазон значений 10|20|30, будут автоматически созданы диапазоны 0–10, 10–20 и 20–30. В этом примере приложения удаляются все пустые интервалы. 

**Способ 1. Использование параметра interval**<br/>
Чтобы задать аспекты цены с шагом в 10 долл. США, следует указать: `&facet=price,interval:10`

**Способ 2. Использование списка значений**<br/>
 Для числовых данных можно использовать список значений.  Рассмотрим следующий диапазон значений фасета listPrice.

  ![][5]

Диапазон указан в файле **CatalogSearch.cs** с помощью следующего списка значений.

    facet=listPrice,values:10|25|100|500|1000|2500

Каждый диапазон создается с использованием отправной точки 0 и конечной точки, равной значению из списка. Затем из всего диапазона удаляется предыдущий диапазон, что позволяет создавать дискретные интервалы. Служба поиска Azure выполняет эти действия в рамках фасетной навигации. Для создания каждого интервала не нужно писать код.

### <a name="build-a-filter-for-facet-ranges"></a>Создание фильтра для диапазонов значений фасета
Чтобы фильтровать документы на основе выбранного диапазона значений, вы можете включить операторы фильтров `"ge"` и `"lt"` в двухкомпонентное выражение, которое определяет конечные точки диапазона значений. Например, если выбрать диапазон 10–25, будет применен фильтр `$filter=listPrice ge 10 and listPrice lt 25`.

В примере приложения для задания конечных точек в выражении фильтра используются параметры **priceFrom** и **priceTo**. Метод **BuildFilter** в файле **CatalogSearch.cs** содержит выражение фильтра, которое возвращает документы в пределах диапазона значений.

  ![][6]

<a name="geofacets"></a> 

## <a name="filtered-navigation-based-on-geopoints"></a>Фасетная навигация на основе геоточек
Часто используются фильтры, помогающие выбрать магазин, ресторан или пункт назначения в зависимости от их близости к вашему текущему местоположению*. Хотя фильтр такого типа похож на фасетную навигацию, он является всего лишь обычным фильтром. Этот вопрос упоминается здесь для пользователей, которым нужно решить проблему с реализацией этого компонента.

Поиск Azure поддерживает две геопространственные функции: **geo.distance** и **geo.intersects**.

* Функция **geo.distance** возвращает расстояния в километрах между двумя точками, одна из которых представляет из себя поле, а другая — константу, переданную как часть фильтра. 
* Функция **geo.intersects** возвращает значение true, если заданная точка находится в пределах указанного многоугольника, где точка представляет из себя поле, а многоугольник указывается кв качестве списка констант координат, которые передаются как часть фильтра.

Примеры фильтров приведены в статье [Синтаксис выражений OData для поиска Azure](http://msdn.microsoft.com/library/azure/dn798921.aspx).

<a name="tryitout"></a>

## <a name="try-it-out"></a>Попробуйте сейчас
Примеры, на которые ссылается эта статья, приведены на сайте CodePlex в демонстрационной статье, посвященной использованию службы поиска Azure компанией Adventure Works. При работе с результатами поиска понаблюдайте, как меняется URL-адрес при построении запроса. Когда вы выбираете фасеты, это приложение добавляет их к универсальному коду ресурса (URI).

1. Настройте пример приложения для использования своего URL-адреса службы и ключа API. 
   
   Обратите внимание на схему, которая определена в файле Program.cs проекта CatalogIndexer. В ней указаны поля, поддерживающие такие фасеты как color (цвет), listPrice (список цен), size (размер), weight (вес), categoryName (имя категории) и modelName (имя модели).  В фасетной навигации используются только некоторые из этих фасетов (color, listPrice, categoryName).
2. Запустите приложение. 
   
   Сначала отобразится только поле поиска. Нажмите кнопку Search (Поиск), чтобы сразу получить все результаты поиска, или введите условие поиска.
   
   ![][7]
3. Введите условие поиска, например bike (велосипед), и нажмите кнопку **Search**(Поиск). Будет быстро выполнен запрос.
   
   Вместе с результатами поиска будет также возвращена структура фасетной навигации.  В URL-адресе фасеты Colors (Цвета), Categories (Категории) и Prices (Цены) имеют значение NULL. На странице результатов поиска структура фасетной навигации включает количественные показатели для каждого результата фасета.
   
   ![][8]
4. Щелкните цвет, категорию и диапазон цен. При первоначальном поиске фасеты имеют значение NULL, но по мере того, как они принимают значения, из результатов поиска удаляются несоответствующие элементы. Обратите внимание, что внесенные в запрос изменения влияют на универсальный код ресурса (URI).
   
   ![][9]
5. Вы можете по-разному очистить запрос, использующий фасеты, например щелкнуть **AdventureWorks Catalog** в верхней части страницы.
   
   ![][10]

<a name="nextstep"></a>

## <a name="next-step"></a>Дальнейшее действие
Чтобы проверить свои знания, можно добавить поле фасета *modelName*. Для этого фасета уже настроен индекс, поэтому в индекс не нужно вносить изменения. Однако вам потребуется изменить код HTML, чтобы включить новый фасет Models (Модели) и добавите поле фасета в конструктор запросов.

Чтобы больше узнать о принципах разработки решений фасетной навигации, щелкните следующие ссылки.

* [Разработка решения для поиска с использованием фасетов](http://www.uie.com/articles/faceted_search/)
* [Шаблоны разработки: фасетная навигация](http://alistapart.com/article/design-patterns-faceted-navigation)

Также можно просмотреть видео [Azure Search Deep Dive](http://channel9.msdn.com/Events/TechEd/Europe/2014/DBI-B410). Начиная с 45:25, на этой видеозаписи демонстрируется, как реализовать фасеты.

<!--Anchors-->
[How to build it]: #howtobuildit
[Build the presentation layer]: #presentationlayer
[Build the index]: #buildindex
[Check for data quality]: #checkdata
[Build the query]: #buildquery
[Tips on how to control faceted navigation]: #tips
[Faceted navigation based on range values]: #rangefacets
[Faceted navigation based on GeoPoints]: #geofacets
[Try it out]: #tryitout

<!--Image references-->
[1]: ./media/search-faceted-navigation/Facet-1-slide.PNG
[2]: ./media/search-faceted-navigation/Facet-2-CSHTML.PNG
[3]: ./media/search-faceted-navigation/Facet-3-schema.PNG
[4]: ./media/search-faceted-navigation/Facet-4-SearchMethod.PNG
[5]: ./media/search-faceted-navigation/Facet-5-Prices.PNG
[6]: ./media/search-faceted-navigation/Facet-6-buildfilter.PNG
[7]: ./media/search-faceted-navigation/Facet-7-appstart.png
[8]: ./media/search-faceted-navigation/Facet-8-appbike.png
[9]: ./media/search-faceted-navigation/Facet-9-appbikefaceted.png
[10]: ./media/search-faceted-navigation/Facet-10-appTitle.png

<!--Link references-->
[Designing for Faceted Search]: http://www.uie.com/articles/faceted_search/
[Design Patterns: Faceted Navigation]: http://alistapart.com/article/design-patterns-faceted-navigation
[Create your first application]: search-create-first-solution.md
[OData expression syntax (Azure Search)]: http://msdn.microsoft.com/library/azure/dn798921.aspx
[Azure Search Adventure Works Demo]: https://azuresearchadventureworksdemo.codeplex.com/
[http://www.odata.org/documentation/odata-version-2-0/overview/]: http://www.odata.org/documentation/odata-version-2-0/overview/ 
[Faceting on Azure Search forum post]: ../faceting-on-azure-search.md?forum=azuresearch
[Search Documents (Azure Search API)]: http://msdn.microsoft.com/library/azure/dn798927.aspx




<!--HONumber=Dec16_HO2-->


