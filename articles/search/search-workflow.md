<properties
	pageTitle="Типовая процедура разработки Поиска Azure | Microsoft Azure"
	description="Процедура или схема создания прототипа и рабочих приложений, интегрируемых с облачной службой Поиск Azure."
	services="search"
	documentationCenter=""
	authors="HeidiSteen"
	manager="mblythe"
	editor=""/>

<tags
	ms.service="search"
	ms.devlang="rest-api"
	ms.workload="search"
	ms.topic="get-started-article"
	ms.tgt_pltfrm="na"
	ms.date="11/04/2015"
	ms.author="heidist"/>

# Типовая процедура разработки Поиска Azure

В этой статье приводятся инструкции по включению Поиска Azure, облачной службы поиска, в пользовательское приложение в качестве компонента, выполняющего функции поиска. В зависимости от того, разведываете ли вы обстановку или уже готовы приступить к активной работе, вам потребуется определенное предварительное руководство по интеграции Поиска Azure в свой пользовательский проект.

В следующих разделах разбирается типовая процедура разработки начального прототипа, который позволит оценить, насколько Поиск Azure соответствует требованиям вашего приложения к функции поиска. Во второй части статьи рассматриваются важные решения, влияющие на более серьезные мероприятия по разработке приложений.

Прежде чем приступать к созданию прототипа, рекомендуем вам изучить одно из руководств по началу работы или посмотреть эту [подробную часовую видеопрезентацию](http://azure.microsoft.com/documentation/videos/tech-ed-europe-2014-azure-search-deep-dive/). Руководства по началу работу доступны для следующих языков: [.NET](search-get-started-dotnet.md), [Java](search-get-started-java.md), [Node.JS](search-get-started-nodejs.md).

## Разработка прототипа

Самый быстрый путь к созданию успешного прототипа обычно включает шаги, описанные в этом разделе. В число этих шагов входят подготовка службы, определение схемы для выбранного индекса, загрузка индекса с документами и запрос индекса.

Для приложений с быстро меняющимися данными (например, в случае быстрого изменения запасов или содержимого) прототип должен также включать компонент, обновляющий документы.

   ![][1]

### Шаг 1. Подготовка службы

Поиск Azure — это полностью управляемая онлайн-служба, доступ к которой предоставляется по подписке Azure. [После регистрации в Azure](http://azure.microsoft.com/pricing/free-trial/) служба поиска добавляется очень просто. См. инструкции по добавлению службы поиска в подписку в разделе [Создание службы поиска на портале](search-create-service-portal.md).

Доступны два уровня ценообразования. Мы рекомендуем общую (бесплатную) службу для создания прототипов, если вы будете работать с небольшим подмножеством данных. Общая служба бесплатная для действующих подписчиков (пробной или обычной версии) и быстро устанавливается, но позволяет использовать не больше трех индексов и 10 000 документов на индекс либо 50 МБ на все хранилище в зависимости от того, какое ограничение будет достигнуто быстрее.

### Шаг 2. Создание индекса

После создания службы можно приступать к созданию индекса, начиная с определения его схемы.

Самый быстрый и простой способ создания индекса — через портал Azure. Каждый документ должен, как минимум, иметь уникальный ключ и хотя бы одно поле с данными, по которым можно осуществлять поиск. Инструкции по началу работы см. в разделе [Создание индекса на портале](search-create-index-portal.md).

> [AZURE.NOTE]Содержание индекса в Поиске Azure
>
> *Индекс* — это упорядоченные, постоянные данные, которые составляют *совокупность искомых данных* для всех последующих операций поиска. Ваша совокупность искомых данных хранится в облаке по подписке на службу Поиска, что позволяет выполнять операции поиска быстро и согласованно. В терминологии поиска элемент совокупности искомых данных называется *документом*, а общая масса всех документов — *коллекцией документов*.
>
>*Схема индекса* определяет все поля в документе по имени, типу данных и атрибутам, указывающим, доступно ли поле для поиска, фильтрации, применения фасетов и т. д.
>
> Наряду со структурой документа схема индекса определяет также профили оценки, предоставляющие критерии для повышения оценки поиска, и параметры конфигурации, обеспечивающие автоматическое завершение запросов (средства подбора) и CORS для междоменных запросов. *Мы рекомендуем начинать создание прототипа с определения полей в документе*, а затем постепенно добавлять другие компоненты (список дополнительных функций для последующего добавления см. в шаге 5).
>
> Рассмотрим применение этих рекомендаций на практике, взяв для примера приложение электронной коммерции. Индекс поиска будет содержать все продукты или службы, доступные для поиска в вашем приложении (все, что возвращается в результатах поиска). Для каждого SKU будет создан один документ. Каждый документ будет содержать название, торговую марку, размер, цену и цвета продукта и даже ссылки на его изображения или другие файлы ресурсов, которые вы хотите получать в результатах поиска.

### Шаг 3. Загрузка документов

Следующим шагом после сохранения индекса Поиска Azure является заполнение индекса документами. На этом этапе данные загружаются, анализируются, снабжаются метками и сохраняются в структуры данных (например, в инвертированные индексы), предназначенные для рабочих нагрузок поиска.

Загружаемые в индекс данные должны соответствовать схеме, определенной на предыдущем этапе. Данные документа представляются в виде набора пар "ключ-значение" в формате JSON для каждого поля. Если схема определяет поле идентификатора (ключ), поле имени и поле URL-адреса (которое можно использовать, если в результатах поиска отображаются внешние изображения), то в каждом таком поле каждого индексируемого документа должны содержаться значения (не нули).

Загружать документы можно разными способами, но на данный момент все они требуют API. Из-за требований к коду для большинства прототипов этот шаг будет самым трудоемким. Параметры описаны далее в этой статье.

> [AZURE.NOTE]Помните, что общая служба имеет ограничение в 10 000 документов на индекс. Сократите свой набор данных таким образом, чтобы он соответствовал этим пределам. Дополнительные сведения см. в разделе [Пределы и ограничения](search-limits-quotas-capacity.md).

#### Загрузка данных в индекс

Один из способов загрузки данных связан с использованием индексатора. Для Azure DocumentDB или реляционных источников данных SQL Server в Azure (в частности базы данных SQL Azure или SQL Server на виртуальной машине Azure) можно использовать [индексаторы](https://msdn.microsoft.com/library/dn946891.aspx), извлекающие документы из поддерживаемого источника данных. Примеры кода с применением индексаторов для загрузки документов можно найти в любом из следующих руководств по началу работы: [.NET](search-get-started-dotnet.md), [Java](search-get-started-java.md), [Node.JS](search-get-started-nodejs.md).

Второй вариант — это написать простую программу с использованием API REST или библиотеки .NET, загружающей документы:

- [Добавление, обновление и удаление документов (API REST)](https://msdn.microsoft.com/library/dn798930.aspx)
- [Класс DocumentOperationsExtensions](https://msdn.microsoft.com/library/microsoft.azure.search.documentoperationsextensions.aspx)

Третий вариант подходит для небольших наборов данных и предполагает загрузку документов с помощью приложения [Fiddler](search-fiddler.md) или [Chrome Postman](search-chrome-postman.md).

Четвертый вариант (пожалуй, самый простой) — это взять код из [примера API REST для Adventure Works C#](https://azuresearchadventureworksdemo.codeplex.com/), который загружает документы из внедренной базы данных (MDF) в решении, или [пример API REST для профилей оценки на C#](https://azuresearchscoringprofiles.codeplex.com/), который загружает данные из файлов данных JSON, включенных в решение.

> [AZURE.TIP]Можно изменить и запустить [пример профиля оценки](https://azuresearchscoringprofiles.codeplex.com/), заменив файлы данных JSON и schema.json на данные, допустимые для вашего приложения.

### Шаг 4. Запрос документов

После загрузки документов в индекс можно написать первый запрос.

Самый быстрый способ получить первые результаты поиска от службы поиска — это использовать приложение [Fiddler](search-fiddler.md) или [Chrome Postman](search-chrome-postman.md) для просмотра ответа, но на практике, скорее всего, вы захотите написать простой код пользовательского интерфейса, позволяющий просмотреть результаты в удобном для чтения формате.

API для операций поиска включают:

- [Операцию поиска документов](https://msdn.microsoft.com/library/dn798927.aspx)
- [Класс SearchIndexClient](https://msdn.microsoft.com/library/microsoft.azure.search.searchindexclient.aspx)

Запросы в Поиск Azure могут быть очень простыми. Если включить в URL-адрес параметр `search=*`, будут выданы первые 50 элементов в совокупности искомых данных, а параметр `search=<some phrase>` позволит выполнить полнотекстовый поиск по фразе и вернет до 50 документов (при наличии хотя бы 50 документов, содержащих указанный критерий поиска).

50 документов — это значение по умолчанию. Изменить количество возвращаемых документов можно с помощью параметра запроса `$Count`. Он описан в разделе [Поиск документов](https://msdn.microsoft.com/library/dn798927.aspx).

> [AZURE.TIP]Самый полный список примеров запросов приводится в разделе [Поиск документов](https://msdn.microsoft.com/library/dn798927.aspx), а список поддерживаемых операторов см. в [Справочнике по синтаксису](https://msdn.microsoft.com/library/dn798920.aspx).

### Шаг 5. Изучение дополнительных функций

Теперь, когда у вас есть и служба, и индекс, вы можете поэкспериментировать с функциями и дополнительно усовершенствовать работу поиска. Краткий список функций для ознакомления приведен ниже.

**Страницы поиска** часто включают в результаты поиска число документов или позволяют разбивать результаты поиска на страницы с более удобным для работы числом элементов. Дополнительные сведения см. в разделе [Разбивка на страницы](search-pagination-page-layout.md).

**searchMode=all** — это параметр запроса, который изменяет способ оценки оператора NOT Поиском Azure. По умолчанию запросы с оператором NOT (-) расширяют, а не сужают результаты поиска. Можно настроить этот параметр таким образом, чтобы порядок оценки оператора был иным. Параметр описан в разделах [Поиск документов](https://msdn.microsoft.com/library/dn798927.aspx) и [Перечисление SearchMode](https://msdn.microsoft.com/library/microsoft.azure.search.models.searchmode.aspx).

**Профили оценки** используются для повышения оценки поиска, в результате чего элементы, соответствующие предустановленным критериям, занимают в результатах поиска более высокую позицию. Инструкции по работе с этой функцией см. в разделе [Начало работы с профилями оценки](search-get-started-scoring-profiles.md).

**Фильтры** используются для сужения результатов поиска, позволяя указывать дополнительные критерии отбора. Выражения фильтров указываются в запросе. Дополнительные сведения см. в разделе [Поиск документов](https://msdn.microsoft.com/library/dn798927.aspx).

**Фасетная навигация** используется для автоматической фильтрации. Поиск Azure создает и возвращает структуру, а код выдает структуру фасетной навигации на странице результатов поиска. Дополнительные сведения см. в разделе [Фасетная навигация](search-faceted-navigation.md).

**Средства подбора** используются для упреждающего ввода и автозавершения запросов, возвращающих предлагаемые условия поиска при вводе первых символов поискового запроса. Дополнительные сведения см. в разделах [Операции предложений](https://msdn.microsoft.com/library/dn798936.aspx) и [Класс средств подбора](https://msdn.microsoft.com/library/microsoft.azure.search.models.suggester.aspx).

**Анализаторы языка** предоставляют лингвистические правила, используемые при анализе текста. По умолчанию в Поиске Azure используется анализатор языка Lucene English, но можно выбрать и другой или другие анализаторы, указав их в индексе. Анализаторы Lucene доступны во всех API. Средства обработки естественного языка корпорации Майкрософт доступны только в [API REST версии 2015-02-28-Preview](search-api-2015-02-28-preview.md). Дополнительные сведения см. в разделе [Языковая поддержка](https://msdn.microsoft.com/library/dn879793.aspx).

### Шаг 6. Обновления индексов и документов

Некоторые функции, которые могут вас заинтересовать, требуют обновления индекса, что часто влечет за собой необходимость обновления документов.

Если вам нужно обновить индекс или документы, например чтобы добавить средства подбора или указать анализаторы языка для добавленных с этой целью полей, обратитесь за инструкциями к следующим разделам:

- [Операция обновления индекса (API REST)](https://msdn.microsoft.com/library/dn800964.aspx)
- [Операция обновления индексатора (API REST)](https://msdn.microsoft.com/library/dn946892.aspx)
- [Операция добавления, обновления или удаления документов (API REST)](https://msdn.microsoft.com/library/dn798930.aspx)
- [Класс Index (библиотека .NET)](https://msdn.microsoft.com/library/microsoft.azure.search.models.index.aspx)
- [Класс Documents (библиотека .NET)](https://msdn.microsoft.com/library/microsoft.azure.search.models.document.aspx)

Создав рабочий прототип, можно подняться на следующий уровень, разработав проект, поддерживающий выполнение рабочей нагрузки.

## Разработка приложений

Для перехода на следующий уровень необходимо выбрать API и решить, каким образом будет осуществляться управление документами и периодичностью загрузок и нужно ли включать в результаты поиска внешние ресурсы.

Проект решения также потребует выполнения всех описанных для прототипа шагов, но вместо того чтобы отдать предпочтение короткому пути, вам нужно выбрать подходы, максимально совместимые с вашим решением.

### Выбор API

Поиск Azure предлагает две модели программирования: библиотеку .NET для управляемого кода и API REST для таких языков программирования, как Java, JavaScript или другой язык, не предназначенный для платформы Microsoft .NET Framework.

В настоящее время в библиотеке .NET еще не реализовано небольшое подмножество функций, поэтому, даже если вы предпочитаете писать управляемый код, для получения желаемых функций вам может потребоваться API REST. Функции, доступные только в API REST:

- [Средства обработки естественного языка корпорации Майкрософт — только предварительный просмотр](../search-api-2015-02-28-preview/)
- [Функция moreLikeThis — только предварительный просмотр](../search-api-2015-02-28-preview/)
- [API управления](https://msdn.microsoft.com/library/dn832684.aspx)

Для отслеживания изменений в состоянии функций периодически заглядывайте в статью [Что нового](search-latest-updates.md).

### Определите методы синхронизации данных: проталкивание или вытягивание.

Модели проталкивания и вытягивания определяют порядок обновления документов в индексе. Зачастую выбор подходящей модели диктует сценарий.

Если вы занимаетесь онлайн-торговлей, то, скорее всего, вам подойдет модель проталкивания, которая позволит принудительно или неоднократно вносить изменения в материальные запасы как в базе данных OLTP, так и в индексе Поиска Azure. Чтобы избежать недовольства среди покупателей, индекс должен обновляться, как только тот или иной SKU будет полностью распродан или закончится какой-то размер или цвет. Только модель проталкивания обеспечивает обновление индекса поиска практически в режиме реального времени.

В Поиске Azure нет отдельного механизма для внедрения модели проталкивания. Код приложения на уровне данных должен обрабатывать операцию обновления документов, используя для обновления документов в коллекции [API REST](https://msdn.microsoft.com/library/dn798935.aspx) или [библиотеку .NET](https://msdn.microsoft.com/library/dn951165.aspx). Задачу можно упростить, если использовать в качестве ключа документа SKU продукта.

Модель вытягивания обычно представляет собой запланированные операции, которые получают данные из внешних источников данных. В Поиске Azure модель проталкивания реализуется с помощью [индексаторов](https://msdn.microsoft.com/library/azure/dn946891.aspx), доступных для определенных источников данных: Azure Documentdb или базы данных SQL Azure (а также SQL Server на виртуальной машине Azure).

### Пакетная загрузка документов

Мы рекомендуем добавлять документы партиями в целях улучшения пропускной способности. Можно одновременно группировать до 1000 документов при условии, что средний размер документа составляет 1–2 КБ.

Для запроса POST возвращается общий код состояния. Коды состояния могут быть либо HTTP 200 (успех), либо HTTP 207 (многостатусный), если есть успешно обработанные документы и документы с ошибками. Дополнительно к коду состояния запроса POST поиск Azure поддерживает поле состояния для каждого документа. При групповой загрузке вам необходимо получить статус каждого документа, который отображает успешное добавление или ошибку при добавлении каждого документа. Поле состояния обеспечивает такую информацию. Это поле устанавливается в статус "false" при ошибке загрузки документа.

При высокой нагрузке ошибки загрузки могут встречаться часто. При возникновении ошибки общий код состояния равен 207, что говорит о частично успешной загрузке. У документов, при индексировании которых произошла ошибка, свойство "статус" будет иметь значение false.

> [AZURE.NOTE]Полученные службой документы индексируются по очереди и не сразу появляются в результатах поиска. В случае отсутствия высокой нагрузки документы, как правило, индексируются за несколько секунд.

При обновлении индекса вы можете сочетать в одной группе несколько действий (вставка, слияние, удаление), что устраняет необходимость в нескольких запросах. В настоящий момент Поиск Azure не поддерживает частичные обновления (HTTP PATCH), поэтому, если вам необходимо обновить индекс, необходимо повторно отправить его определение.

### Интеграция внешних данных в результаты поиска

Поиск Azure использует внутреннее хранилище для индексов и документы, которые используются в операциях поиска. Текстовый анализ зависит от того, есть ли поля, по которым может вестись поиск, и доступны ли при этом связанные атрибуты.

Однако не все поля в документе доступны для поиска. Например, если ваше приложение представляет собой онлайн-каталог музыки или видео, мы рекомендуем хранить двоичные файлы в службе BLOB-объектов Azure или в другом хранилище. Поиск по двоичным файлам не производится, поэтому нет смысла в их нахождении в хранилище Поиска Azure. Несмотря на то что следует хранить изображения, видео и звуковые файлы в других службах или в другом расположении, следует включить поле, которое ссылается на URL-адрес к файлу. Таким образом, можно вернуть внешние данные как часть результатов поиска.

Чтобы использовать внешние данные, необходимо определить в индексе поле, в котором будет храниться указатель на URL-адрес внешнего файла данных. Если вы создаете [Документ поиска](https://msdn.microsoft.com/library/dn798929.aspx) или включаете поле в результаты поиска, двоичный файл отображается в контексте документа.

### Планирование загрузки

Одна из самых приятных особенностей Поиска Azure — это простота масштабирования ресурсов в соответствии с требованиями. И хотя эта возможность не устраняют необходимость в планировании мощностей, она сводит к минимуму основной риск. Вам не приходится ограничиваться дополнительным или неподходящим оборудованием для выполнения рабочей нагрузки поиска.

На последнем этапе проанализируйте существующие уровни ресурсов для реплик и разделов и определите, нужны ли корректировки. Проще всего корректировать мощность через [портал Azure](https://ms.portal.azure.com/).

Помните, что только стандартные ценовой уровень можно масштабировать вверх или вниз. Кроме того, развертывание дополнительных кластеров для вашей службы может занять от нескольких минут до нескольких часов в зависимости от степени коррекции.

> [AZURE.NOTE]Мощность можно изменить программным способом с помощью API REST управления. Дополнительные сведения см. в разделе [API REST управления](https://msdn.microsoft.com/library/azure/dn832684.aspx).


<!--Image references-->
[1]: ./media/search-workflow/AzSearch-Workflow.png

<!---HONumber=Nov15_HO2-->