<properties 
	pageTitle="Создание приложения для геопространственного поиска с помощью Поиска Azure" 
	description="Создание приложения геопространственного поиска с помощью Bing и Поиска Azure" 
	services="search" 
	documentationCenter="" 
	authors="HeidiSteen" 
	manager="mblythe" 
	editor=""/>

<tags 
	ms.service="search" 
	ms.devlang="rest-api" 
	ms.workload="search" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.date="07/08/2015" 
	ms.author="heidist"/>

# Создание приложения для геопространственного поиска с помощью Поиска Azure

В этом учебнике показано, как добавить в веб-приложения геопространственный поиск с использованием Поиска Azure и Карт Bing. Используя геопространственный поиск, можно находить объекты на определенном расстоянии от заданной точки (например, все рестораны в радиусе 5 км от текущего местоположения). Геопространственные возможности в Поиске Azure поддерживают широко используемые картографические технологии. Например, если в приложении для агентства недвижимости вы хотите использовать многоугольники, чтобы отображать выставленные на продажу дома в границах определенного района, это можно легко сделать с помощью OData или нашего простого синтаксиса поиска.

Чтобы узнать больше, просмотрите это видео с сайта Channel 9 о [поиске Azure и геопространственных данных](http://channel9.msdn.com/Shows/Data-Exposed/Azure-Search-and-Geospatial-Data).

![][7]

Чтобы создать приложение, с помощью картографической службы Bing выполним геокодирование адресов, загруженных из CSV-файла, а затем сохраним полученные данные в индексе поиска.

Этот учебник составлен на основе демонстрации [Поиск Azure: Adventure Works](http://azuresearchadventureworksdemo.codeplex.com). Если вы еще не ознакомились с ней, рекомендуем сделать это, чтобы получить общее представление о создании индекса и вызове API Поиска Azure из веб-приложения.

<a id="sub-1"></a>
## Предварительные требования

+	Visual Studio 2012 или более поздней версии с ASP.NET MVC 4 и SQL Server. Если у вас не установлено программное обеспечение, загрузите бесплатные версии Express: [Visual Studio 2013 Express](http://www.visualstudio.com/products/visual-studio-express-vs.aspx) и [Microsoft SQL Server 2014 Express](http://msdn.microsoft.com/evalcenter/dn434042.aspx).
+	Служба "Поиск Azure". Вам понадобятся имя службы поиска и ключ администратора. Дополнительные сведения см. в статье [Создание службы поиска Azure на портале](search-create-service-portal.md).
+	Служба "Карты Bing" и ключ для доступа к ней. Инструкции приведены в следующем разделе.
+	[Пример использования геопространственного поиска Azure в CodePlex](https://azuresearchgeospatial.codeplex.com/). На вкладке Source Code (Исходный код) нажмите **Download** (Загрузить), чтобы скачать ZIP-архив с решением. 

    ![][12]

Это решение содержит два проекта:

+	**StoreIndexer**: создает индекс поиска Azure и загружает данные.
+	**AdventureWorksWebGeo**: приложение MVC4, которое отправляет запросы к индексу поиска Azure и отображает расположение магазинов на карте Bing.

[AZURE.INCLUDE [Для работы с данным руководством требуется учетная запись Azure.](../../includes/free-trial-note.md)]

<a id="sub-2"></a>
## Карты Bing

Мы воспользуемся интерфейсом API Карт Bing в двух целях.

+ **Геокодирование адресов.** Наши данные содержат адреса (город, регион, почтовый индекс), но для геопространственного поиска также нужны координаты (долгота и широта) этих мест. Чтобы получить координаты, мы с помощью API потока данных Карт Bing отправим набор адресов на геокодирование. При использовании пробной учетной записи Bing одновременно можно отправить до 50 адресов, но этого достаточно для выполнения данного учебного проекта.

+ **Карты Bing.** Во время работы приложения мы будем отображать местоположение магазинов на Картах Bing.

### Создание учетной записи для Карт Bing

1. Перейдите на [портал Карт Bing](https://www.bingmapsportal.com/) и создайте учетную запись. Для этого нужно ввести учетные данные.

2. Когда учетная запись будет создана, выберите пункт **Create or view keys** (Создать или просмотреть ключи) и введите данные для создания ключа. Для этого демонстрационного проекта можно выбрать пункт **Trial Key** (Ключ пробной версии).

3. Нажмите **Submit** (Отправить). После этого вы должны увидеть сведения о ключе для своего приложения на базе Карт Bing. Запишите этот ключ, так как он понадобится позже.

<a id="sub-3"></a>
## Геокодирование адресов на C# с использованием API потока данных Карт Bing

На этом шаге мы с помощью API потока данных Карт Bing выполним геокодирование некоторых адресов различных велосипедных магазинов по всему миру.

Эти данные поступают из CSV-файла с именем store_locations.csv, который содержится в загруженном ранее источнике. Если вы откроете этот файл в текстовом редакторе или Excel, то увидите, что он содержит столбцы идентификатора, названия и адреса для каждого магазина.

Давайте подробнее рассмотрим код, чтобы понять, как он работает.

1. Откройте решение AdventureWorksGeo в Visual Studio, разверните проект **StoreIndexer** в обозревателе решений и откройте файл Program.cs. Мы уже обсуждали создание индекса в описании демонстрации [Поиск Azure: Adventure Works](http://azuresearchadventureworksdemo.codeplex.com/), поэтому нет необходимости пояснять, как это реализовано в Program.cs.

2. Перейдите к функции **Main** и обратите внимание, что она вызывает функцию **ApplyStoreData**. Перейдите к этой функции и просмотрите код.

3. Функция **ApplyStoreData** загружает данные из CSV-файла с именем store_locations.csv в таблицу System.Data.DataTable.

    Этот файл содержит данные обо всех магазинах (включая их адреса), которые мы хотим загрузить в Поиск Azure. Перебирая все строки в этом файле, мы можем создать набор объектов **indexOperations**, который затем будет вставлен в индекс Поиска Azure (ранее созданный в функции **CreateStoresIndex()**).

    Если после этого внимательно изучить индекс, можно заметить, что поле **GeoPt**, которое должно содержать долготу и широту каждого магазина, остается пустым. По этой причине требуется следующий шаг в функции **Main**.

5. Перейдите к функции **ExtractAddressInfoToXML()**. Она извлекает данные об адресах из файла store_locations.csv и загружает их в XML-файл в формате, который поддерживается Картами Bing для геокодирования. Созданный файл будет отправлен на обработку в поток данных Карт Bing с помощью вызова функции **GeoCoding.CreateJob**.

6. Геокодирование может занять некоторое время, поэтому предусмотрен цикл, каждые десять секунд вызывающий функцию **GeoCoding.CheckStatus**, чтобы проверить, выполнено ли задание. После его завершения результаты загружаются в класс адресов с помощью вызова функции **GeoCoding.DownloadResults**.

7. Последний шаг — получение геокодированных адресов и их отправка в Поиск Azure. Чтобы посмотреть, как это происходит, откроем функцию **UpdateStoreData**.

  Функция **UpdateStoreData** с помощью действия **@search.action: merge** добавляет в поле местоположения типа Edm.GeographyPoint геокодированные координаты (долготу и широту), которые только что были загружены из Карт Bing. Для этого функция ищет уникальный ключ документа storeId в индексе stores и объединяет эти новые данные с существующим документом.

8. Перед запуском приложения добавьте свои данные для службы "Поиск Azure" и API Карт Bing. Для этого откройте файл App.config и введите нужные значения SearchServiceName, SearchServiceApiKey и BingMapsAPI. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.

9. Щелкните проект **StoreIndexer** правой кнопкой мыши и выберите пункты **Отладка** | **Запустить новый экземпляр**, чтобы начать его выполнение.

<a id="sub-4"></a>
## Добавление картографических данных в приложение MVC4 с использованием Поиска Azure и Карт Bing

На этом шаге мы соберем и запустим в веб-браузере приложение, которое загружает результаты поиска магазинов, а затем отображает их на Картах Bing.

1.	В Visual Studio откройте демонстрационное решение на базе Поиска Azure с именем AdventureWorksGeo.sln. 
	
2.	В обозревателе решений щелкните **AdventureWorksWebGeo** правой кнопкой мыши и выберите команду **Назначить запускаемым проектом**.
	
3.	Откройте файл Web.config в этом проекте и присвойте параметрам SearchServiceName, SearchServiceApiKey и BingMapsAPI свои значения для доступа к службе "Поиск Azure" и к API Карт Bing. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.

4.	Сохраните файл Web.config.
	
5.	Нажмите клавишу **F5**, чтобы запустить проект. Если возникнет ошибка сборки, следуйте инструкциям по [устранению неполадок](#err-mvc).

Обратите внимание, что теперь магазины отображаются в виде точек на карте. Щелкните одну из них, и вы увидите всплывающее окно с информацией о магазине. Все эти данные загружаются из индекса Поиска Azure с именем stores, который был создан на предыдущих этапах.

<a id="sub-5"></a>
## Обзор проекта AdventureWorksWebGeo

В проекте **AdventureWorksWebGeo** показано, как с помощью ASP.NET MVC 4 можно организовать взаимодействие с Поиском Azure для создания картографического приложения с поддержкой геопространственного поиска. В этом разделе мы рассмотрим отдельные части программного кода приложения и их предназначение.

1.	В обозревателе решений разверните элемент **AdventureWorksWebGeo** | **Controller** и откройте файл HomeController.cs. Функция **Index()** вызывается при запуске приложения и загрузке страницы Index. Эта функция загружает интерфейс API Карт Bing на основе данных из файла Web.config и передает его в представление Index в качестве ViewBag.BingAPI.

2.	Откройте файл Index.cshtml из папки **Views** | **Home**.

3.	В этом файле реализована обычная процедура добавления Карт Bing в веб-приложение, однако вам стоит обратить внимание на некоторые моменты, указанные ниже.

+	Функция ViewBag из контроллера загружает учетные данные для доступа к карте с помощью команды credentials: '@ViewBag.BingAPI' 

+	После загрузки карты выполняется запрос JQuery $.post к функции **Search** из HomeController по пути /home/search

+	Функция **Search** извлекает данные о местоположении магазинов. Эти полученные данные затем отображаются в виде вешек на Картах Bing.

4.	Откройте файл HomeController.cs в папке **Controllers** (Контроллеры) и взгляните на функцию **Search**. Обратите внимание на вызов функции __storeSearch.Search(lat, lon, 10000). Такой запрос возвращает все магазины в пределах 10 тыс. км от точки с указанной широтой (lat) и долготой (lon). Результаты этого запроса обрабатываются, а затем отправляются обратно в представление Index, где они отображаются в виде вешек на Картах Bing.

На этом демонстрация проекта завершена. Вы познакомились со всеми основными операциями, о которых нужно знать при создании картографического приложения на базе ASP.NET MVC4 с использованием поиска Azure.


<a id="err-mvc"></a>
## Устранение ошибки "Невозможно загрузить файл или сборку System.Web.Mvc"

Если при сборке AdventureWorksWeb вы получаете сообщение об ошибке Could not load file or assembly 'System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35' or one of its dependencies (Невозможно загрузить файл или сборку System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35 или один из зависимых компонентов), попробуйте выполнить эти действия, чтобы устранить ошибку.

1. Откройте консоль диспетчера пакетов, последовательно выбрав пункты **Сервис** | **Диспетчер пакетов NuGet** | **Консоль диспетчера пакетов**.
2. В командной строке PM> введите Update-package -reinstall Microsoft.AspNet.Mvc.
3. Когда вам будет предложено перезагрузить файл, выберите **Yes to All** (Да для всех).
4. Повторно выполните сборку и попробуйте еще раз нажать **F5**.

<a id="next-steps"></a>
## Дальнейшие действия

В качестве самостоятельного упражнения вы можете расширить возможности этого картографического приложения. Например, можно добавить:

+ поле поиска, чтобы пользователи могли найти определенные магазины;

+ ограничения, чтобы пользователи могли фильтровать магазины по стране или региону;

+ возможность нарисовать на карте область поиска. Такая область отфильтровывается поиском Azure с помощью API пересечения географических данных и отображается на карте.


<!--Anchors-->
[Prerequisites]: #sub-1
[Bing Maps]: #sub-2
[Geocode Addresses in C# using Bing Maps DataFlow API]: #sub-3
[Add Mapping to an MVC4 Application using Azure Search and Bing Maps]: #sub-4
[Explore AdventureWorksWebGeo]: #sub-5
[Next steps]: #next-steps


<!--Image references-->
[7]: ./media/search-create-geospatial/AzureSearch-geo1-App.PNG
[12]: ./media/search-create-geospatial/AzureSearch_Create2_CodeplexDownload.PNG

<!---HONumber=July15_HO2-->