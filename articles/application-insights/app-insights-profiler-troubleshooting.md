---
title: Устранение неполадок в Azure с помощью Application Insights Profiler | Документация Майкрософт
description: Эта страница содержит инструкции по устранению неполадок и информацию, помогающую разработчикам в решении проблем с включением или использованием Application Insights Profiler.
services: application-insights
documentationcenter: ''
author: mrbullwinkle
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.topic: conceptual
ms.reviewer: cawa
ms.date: 08/06/2018
ms.author: mbullwin
ms.openlocfilehash: 7b7aad2cb8aa9b4faeada795f20c818995f62fb6
ms.sourcegitcommit: 333d4246f62b858e376dcdcda789ecbc0c93cd92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/01/2018
ms.locfileid: "52720445"
---
# <a name="troubleshoot-problems-enabling-or-viewing-application-insights-profiler"></a>Устранение неполадок по включению и просмотру Application Insights Profiler

## <a id="troubleshooting"></a>Общие действия по устранению неполадок

### <a name="profiles-are-only-uploaded-if-there-are-requests-to-your-application-while-the-profiler-is-running"></a>Профили загружаются только в том случае, если есть запросы к вашему приложению во время работы профилировщика
Application Insights Profiler собирает данные профилировщика в течение двух минут каждый час, или когда нажата кнопка [**Profile Now**](app-insights-profiler-settings.md?toc=/azure/azure-monitor/toc.json) (Профилировать сейчас) на странице **Настройка Application Insights**. Но данные профилирования загружаются только тогда, когда их можно привязать к запросу, который появился во время работы профилировщика. 

Профилировщик записывает сообщения трассировки и пользовательские события в ресурс application insights. Можно использовать эти события, чтобы просмотреть работу профилировщика. Если предполагается, что профилировщик должен работать и захватывать трассировки, но они не отображаются на странице "Производительность", вы можете проверить работу профилировщика с помощью таких действий.

1. Выполните поиск сообщений трассировки и пользовательских событий, записанных профилировщиком в ресурс application insights. Можно использовать эту строку для поиска необходимых данных:

    ```
    stopprofiler OR startprofiler OR upload OR ServiceProfilerSample
    ```
    На скриншоте ниже приведен пример выполнения двух поисков на двух разных ресурсах ИИ. 
    
    * В левой части — приложение, которое не получает запросы во время работы профилировщика. Отобразится сообщение, которое содержит сведения о том, что загрузка была отменена из-за отсутствия действий. 

    * В примере справа можно увидеть, что профилировщик запущен и уже отправил пользовательские события при обнаружении запросов, которые появились во время его работы. Если отображается пользовательское событие ServiceProfilerSample, это означает, что профилировщик вложил трассировку в запрос, и вы можете просмотреть трассировку на странице производительности Application Insights.

    * Если вы не видите никакой телеметрии вообще, то профилировщик не работает. Возможно, вам потребуется прочитать разделы по устранению неполадок для конкретного типа приложения в этом документе ниже.  

     ![Поиск данных телеметрии профилировщика][profiler-search-telemetry]

1. Если запросы возникают во время работы профилировщика, убедитесь, что они обрабатываются в рамках вашего приложения, которое включено профилировщиком. Иногда приложения состоят из нескольких компонентов, но Profiler доступен не для всех компонентов, а лишь для некоторых. На странице настроек профилировщика Application Insights отобразятся компоненты с отправленной трассировкой.

### <a name="other-things-to-check"></a>Что нужно еще проверить:
* Приложение на платформе .NET Framework 4.6.
* Если веб-приложение является приложением ASP.NET Core, оно должно работать под управлением ASP.NET Core 2.0.
* Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку. Трассировки удаляются через 7 дней.
* Убедитесь, что доступ к https://gateway.azureserviceprofiler.net для прокси-серверов или брандмауэра не заблокирован.

### <a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем длительность запроса.

Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме. В таком случае общее время потока будет больше затраченного времени. Один поток может ожидать завершения другого. Средство просмотра пытается это обнаружить и исключить ненужное ожидание, но при этом вместо исключения отображается слишком много сведений. Это могут быть критически важные сведения.

Обнаружив параллельные потоки в трассировках, укажите, какие потоки находятся в состоянии ожидания, чтобы можно было определить критический путь к запросу. В большинстве случаев поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки. Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.

### <a name="error-report-in-the-profile-viewer"></a>Отчет об ошибках в средстве просмотра данных о профилировании
Отправьте запрос в службу поддержки на портале. Обязательно укажите идентификатор корреляции из сообщения об ошибке.

## <a name="troubleshooting-profiler-on-app-services"></a>Устранение неполадок с помощью Profiler в службах приложений
### <a name="for-the-profiler-to-work-properly"></a>Для правильной работы профилировщика выполните следующее:
* Необходимо использовать план службы веб-приложений уровня "Базовый" или выше.
* Для веб-приложения нужно включить Application Insights.
* Веб-приложение должно содержать параметр приложения **APPINSIGHTS_INSTRUMENTATIONKEY**, настроенный с тем же ключом инструментирования, который использует пакет SDK Application Insights.
* Веб-приложение должно иметь параметр приложения **APPINSIGHTS_PROFILERFEATURE_VERSION**, определенный и настроенный в соответствии с версией 1.0.0.
* В веб-приложении должен быть определен параметр **DiagnosticServices_EXTENSION_VERSION** со значением ~3.
* Веб-задание **ApplicationInsightsProfiler3** должно быть запущено. Чтобы проверить веб-задание, выберите [Kudu](https://blogs.msdn.microsoft.com/cdndevs/2015/04/01/the-kudu-debug-console-azure-websites-best-kept-secret/), затем в меню "Средства"откройте **Панель мониторинга веб-заданий**. Как показано на скриншотах ниже, щелкнув ссылку ApplicationInsightsProfiler2, можно получить подробную информацию о веб-задании, включая журнал.

    Для просмотра сведений о веб-задании перейдите по этой ссылке: 

    ![profiler-webjob]

    Ниже приведена страница с подробными сведениями. Загрузите журнал и отправьте его нашей команде, чтобы выяснить причину отказа запуска профилировщика.
    
    ![profiler-webjob-log]

### <a name="manual-installation"></a>Ручная установка

При настройке профилировщика в параметры веб-приложения вносятся обновления. Обновления можно применить вручную, если этого требует ваша среда. Например, если приложение выполняется в среде веб-приложений для PowerApps.

1. В области **управления веб-приложением** выберите **Параметры**.
1. Для **платформы .NET Framework** установите версию **4.6**.
1. Установите для параметра **Всегда включено** значение **Включено**.
1. Добавьте параметр приложения **APPINSIGHTS_INSTRUMENTATIONKEY** и задайте для него значение с тем же ключом инструментирования, который используется пакетом SDK.
1. Добавьте параметр приложения **APPINSIGHTS_PROFILERFEATURE_VERSION** и задайте ему значение 1.0.0.
1. Добавьте параметр **DiagnosticServices_EXTENSION_VERSION** и укажите значение ~3.

### <a name="too-many-active-profiling-sessions"></a>Слишком много активных сеансов профилирования

Сейчас вы можете включить профилировщик не более, чем в четырех веб-приложениях Azure и слотах развертывания, работающих в рамках одного плана службы. Если в рамках одного плана службы приложений у вас работает больше веб-приложений, может появиться исключение Microsoft.ServiceProfiler.Exceptions.TooManyETWSessionException, вызванное профилировщиком. Профилировщик запускается отдельно для каждого веб-приложения и пытается запустить сеанс трассировки событий Windows (ETW) для каждого приложения. Но существует ограничение на количество сеансов ETW, выполняемых одновременно. Если веб-задание профилировщика содержит слишком много активных сеансов профилирования, то перенесите некоторые веб-приложения в другой план службы.

### <a name="deployment-error-directory-not-empty-dhomesitewwwrootappdatajobs"></a>Ошибка развертывания: "Каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"".

При повторном развертывании в ресурсе веб-приложений с включенным профилировщиком может отобразиться сообщение, содержащее сведения о следующей ошибке:

*Каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"*.

Эта ошибка происходит при запуске веб-развертывания с помощью сценариев или в конвейере развертывания Azure DevOps. Чтобы устранить эту проблему, необходимо добавить приведенные ниже параметры развертывания в задачу веб-развертывания.

```
-skip:Directory='.*\\App_Data\\jobs\\continuous\\ApplicationInsightsProfiler.*' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs\\continuous$' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs$'  -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data$'
```

Эти параметры удаляют папку, используемую Application Insights Profiler, и разблокируют процесс повторного развертывания. Текущий запущенный экземпляр профилировщика не будет затронут.

### <a name="how-do-i-determine-whether-application-insights-profiler-is-running"></a>Как определить, работает ли Application Insights Profiler?

Профилировщик запускается в качестве непрерывного веб-задания в веб-приложении. Вы можете открыть ресурс веб-приложения на [портале Azure](https://portal.azure.com). Проверьте состояние **ApplicationInsightsProfiler** в области **Веб-задания**. Если он не работает, откройте **Журналы**, чтобы просмотреть дополнительные сведения.

## <a name="troubleshooting-problems-with-profiler-and-wad"></a>Устранение неполадок с помощью Profiler и WAD

Существуют три шага, чтобы проверить, что профилировщик настроен правильно, с помощью WAD. Шаг 1. Убедитесь, что содержимое развернутой конфигурации WAD соответствует вашим ожиданиям. Шаг 2. Проверьте, передает ли WAD правильный ключ инструментирования iKey в командную строку профилировщика. Шаг 3. Просмотрите файл журнала профилировщика, чтобы выяснить, почему профилировщик получает ошибку при работе. 

Чтобы проверить настройки, которые использовались для WAD, вам необходимо войти в виртуальную машину и открыть файл журнала в этом расположении: 
```
c:\logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.11.3.12\DiagnosticsPlugin.logs  
```
В этом файле в строке "WadCfg" вы найдете параметры, которые были переданы на виртуальную машину для настройки WAD. Можно проверить правильность этого ключа инструментирования, который используется в приемнике профилировщика.

Также вы можете проверить командную строку, которая используется для запуска профилировщика. Следующий файл содержит аргументы, используемые для запуска профилировщика.
```
D:\ProgramData\ApplicationInsightsProfiler\config.json
```
Проверьте правильность ключа инструментирования ikey в командной строке профилировщика. 

Далее, используя путь, обнаруженный в файле config.json выше, проверьте файл журнала профилировщика. Он отобразит информацию об отладке,которая указывает на параметры, используемые профилировщиком, а также сообщения о статусе и ошибках. Если профилировщик работает, пока приложение получает запросы, отобразится следующее сообщение: "Обнаружены действия с использованием iKey". При отправке трассировки отобразится следующее сообщение: "Начало отправки трассировки". 


[profiler-search-telemetry]:./media/app-insights-profiler/Profiler-Search-Telemetry.png
[profiler-webjob]:./media/app-insights-profiler/Profiler-webjob.png
[profiler-webjob-log]:./media/app-insights-profiler/Profiler-webjob-log.png








