<properties 
	pageTitle="Как работать с Application InsightsРесурсы в Application Insights" 
	description="Вопросы и ответы об Application Insights" 
	services="application-insights" 
    documentationCenter=""
	authors="alancameronwills" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="10/11/2015" 
	ms.author="awills"/>

# Как работать с Application Insights

## Получать уведомление по электронной почте, если...

### Уведомлять меня по электронной почте, если сайт выходит из строя

Настройте [веб-тест доступности](app-insights-monitor-web-app-availability.md).

### Уведомлять меня по электронной почте, если сайт перегружен

Настройте [оповещение](app-insights-alerts.md) для **времени ответа от сервера**. Пороговое значение может быть в пределах от 1 до 2 секунд.

![](./media/app-insights-how-do-i/030-server.png)

Приложение может также демонстрировать признаки нагрузки, выдавая коды ошибок. Настройте оповещение при **неудачных запросах**.

Если вы хотите настроить оповещение при **исключениях сервера**, для просмотра данных может потребоваться [дополнительная настройка](app-insights-asp-net-exceptions.md).

### Получить уведомление по электронной почте при исключении

1. [Настройте мониторинг исключений](app-insights-asp-net-exceptions.md)
2. [Установите оповещение](app-insights-alert.md) об исключении подсчета метрики


### Уведомлять меня по электронной почте о событиях в приложении

Предположим, что вы хотите получать уведомления по электронной почте при возникновении определенных событий. Application Insights не предоставляет эту функцию напрямую, но позволяет [отправлять оповещение, если метрика превысит пороговое значение](app-insights-alerts.md).

Оповещения можно настроить для [пользовательских метрик](app-insights-api-custom-events-metrics.md#track-metric), но не для пользовательских событий. Напишите код, который будет увеличивать метрику при возникновении соответствующего события:

    telemetry.TrackMetric("Alarm", 10);

или:

    var measurements = new Dictionary<string,double>();
    measurements ["Alarm"] = 10;
    telemetry.TrackEvent("status", null, measurements);

Так как оповещения имеют два состояния, отправьте минимальное значение, при котором оповещение должно быть отменено:

    telemetry.TrackMetric("Alarm", 0.5);

Создайте диаграмму в [обозревателе метрик](app-insights-metric-explorer.md), чтобы увидеть оповещение:

![](./media/app-insights-how-do-i/010-alarm.png)

Теперь настройте оповещение таким образом, чтобы оно отправлялось в случае, когда метрика превышает среднее значение за короткий период:


![](./media/app-insights-how-do-i/020-threshold.png)

Установите минимальный период усреднения.

Вы будете получать уведомления по электронной почте, если метрика поднимется выше или упадет ниже порогового значения.

Учитывайте следующие факторы.

* Оповещение может находиться в двух состояниях: «оповещение» и «исправен». Состояние оценивается только при получении метрики.
* Электронное письмо отправляется только при изменении состояния. Вот почему необходимо отправлять как верхнюю, так и нижнюю метрику. 
* Для оценки оповещениям берется среднее значений, полученных за предыдущий период. Это происходит при каждом получении метрики, поэтому сообщения электронной почты могут отправляться чаще установленной вами периодичности.
* Поскольку сообщения электронной почты отправляются и при состоянии «оповещение», и при состоянии «исправен», считайте это разовое событие условием с двумя состояниями. Например, вместо события «задание завершено» создайте условие «задание выполняется», при котором сообщения электронной почты будут отправляться при запуске и завершении задания.

### Настройте автоматические оповещения

[Создание новых оповещений с помощью PowerShell](app-insights-alerts/#set-alerts-by-using-powershell)

## Использование PowerShell для управления Application Insights

* [Создание новых ресурсов](app-insights-powershell-script-create-resource.md)
* [Создание новых оповещений](app-insights-alerts/#set-alerts-by-using-powershell)

## Версии приложения и метки

### Отделите результаты от dev, test и prod

* Настройте разные ключи для различных сред
* Задайте метки телеметрии с помощью значений различных свойств для различных меток (dev, test, prod)

[Подробнее](app-insights-separate-resources.md)
 

### Фильтрация по номеру сборки

При публикации новой версии приложения имеет смысл отделить телеметрию от других сборок.

Для этого можно настроить свойство "Версия приложения" для фильтрации результатов [поиска](app-insights-diagnostic-search.md) и [обозревателя метрик](app-insights-metrics-explorer.md).


![](./media/app-insights-how-do-i/050-filter.png)

Свойство «Версия приложения» можно настроить различными способами.

* Напрямую:

    `telemetryClient.Context.Component.Version = typeof(MyProject.MyClass).Assembly.GetName().Version;`

* Вставьте эту строку в [инициализатор телеметрии](app-insights-api-custom-events-metrics.md#telemetry-initializers), чтобы обеспечить согласованность всех экземпляров TelemetryClient.

* [ASP.NET] Задайте версию в `BuildInfo.config`. Веб-модуль берет номер версии из узла BuildLabel. Включите этот файл в проект и не забудьте установить свойство «Всегда копировать» в обозревателе решений.

    ```XML

    <?xml version="1.0" encoding="utf-8"?>
    <DeploymentEvent xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.microsoft.com/VisualStudio/DeploymentEvent/2013/06">
      <ProjectName>AppVersionExpt</ProjectName>
      <Build type="MSBuild">
        <MSBuild>
          <BuildLabel kind="label">1.0.0.2</BuildLabel>
        </MSBuild>
      </Build>
    </DeploymentEvent>

    ```
* [ASP.NET] Настройте автоматическое создание файла BuildInfo.config в MSBuild. Для этого добавьте в CSPROJ-файл несколько строк:

    ```XML

    <PropertyGroup>
      <GenerateBuildInfoConfigFile>true</GenerateBuildInfoConfigFile>    <IncludeServerNameInBuildInfo>true</IncludeServerNameInBuildInfo>
    </PropertyGroup> 
    ```

    Вы получите файл *Имя\_проекта*.BuildInfo.config. В процессе публикации он переименовывается в BuildInfo.config.

    При создании сборки с помощью Visual Studio в подпись включается заполнитель (AutoGen\_...). Если используется MSBuild, в подписи указывается правильный номер версии.

    Чтобы разрешить MSBuild генерировать номера версий, задайте версию вида `1.0.*` в файле AssemblyReference.cs.

## Мониторинг внутренних серверов

[Используйте базовый API-Интерфейс](app-insights-windows-desktop.md)


## Визуализируйте данные

#### Панель мониторинга с метрикой для нескольких приложений

* В [обозревателе метрик](app-insights-metrics-explorer.md) настройте диаграмму и сохраните ее в списке избранного. Закрепите ее на панели мониторинга Azure.
* 

#### Панель мониторинга с данными из других источников и Application Insights

* [Экспорт телеметрии в Power BI](app-insights-export-power-bi.md). 

Или

* Используйте SharePoint как панель мониторинга для отображения данных веб-компонентов SharePoint. [Используйте непрерывный экспорт и Stream Analytics для экспорта в SQL](app-insights-code-sample-export-sql-stream-analytics.md). Используйте PowerView для просмотра базы данных и создания веб-компонента SharePoint для PowerView.


### Сложная фильтрация, сегментация и соединение

* [Используйте непрерывный экспорт и Stream Analytics для экспорта в SQL](app-insights-code-sample-export-sql-stream-analytics.md). Используйте PowerView для просмотра базы данных.

<a name="search-specific-users"></a>
### Отфильтровывание анонимных или прошедших проверку подлинности пользователей

Если пользователь вошел в систему, можно установить [идентификатор пользователя, прошедшего проверку подлинности](app-insights-api-custom-events-metrics.md#authenticated-users). (Это не происходит автоматически.)

Затем можно:

* выполнить поиск по определенным идентификаторам пользователей;

![](./media/app-insights-how-do-i/110-search.png)

* выполнить фильтрацию метрики для анонимных или прошедших проверку подлинности пользователей.

![](./media/app-insights-how-do-i/115-metrics.png)

## Изменение имен и значений свойств

Создайте фильтр (app-insights-api-filtering-sampling.md#filtering). Это позволяет изменять или фильтровать данные телеметрии перед их отправкой из приложения в Application Insights.

## Вывод списка определенных пользователей и информации об их использовании

Если вы хотите просто выполнить [поиск конкретных пользователей](#search-specific-users), можно установить [идентификатор пользователя, прошедшего проверку подлинности](app-insights-api-custom-events-metrics/#authenticated-users).

Если вы хотите получить список пользователей с данными — например, на какие страницы заходят пользователи или как часто они входят в систему, — существует два варианта действий:

* [установить идентификатор пользователя, прошедшего проверку подлинности](app-insights-api-custom-events-metrics/#authenticated-users); [выполнить экспорт данных в базу данных](app-insights-code-sample-export-sql-stream-analytics.md) и проанализировать данные в базе данных с помощью подходящих инструментов.
* Если количество пользователей невелико, отправить пользовательские события или метрики с использованием интересующих данных, таких как значение метрики и имя события, и задавать идентификатор пользователя в качестве свойства. Для анализа просмотров страниц замените стандартный вызов JavaScript trackPageView. Чтобы проанализировать данные телеметрии на стороне сервера, используйте инициализатор телеметрии для добавления идентификатора пользователя ко всем данным телеметрии сервера. После этого можно фильтровать и разделять метрику и выполнять поиск по идентификатору пользователя.


## Уменьшение трафика из вашего приложения в Application Insights

* В файле [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md) отключите все неиспользуемые модули, например счетчики производительности.
* Используйте [выборку и фильтрацию](app-insights-api-filtering-sampling.md) в пакете SDK.
* Если вы используете [TrackMetric](app-insights-api-custom-events-metrics.md#track-metric), вычисляйте агрегированное значение значений метрики для пакетов перед отправкой результата. Это можно сделать с помощью перегруженного метода TrackMetric().


Подробнее о [расценках и квотах](app-insights-pricing.md).

## Отключение данных телеметрии

Чтобы **динамически остановить и запустить** сбор и передачу данных телеметрии с сервера:

```

    using  Microsoft.ApplicationInsights.Extensibility;

    TelemetryConfiguration.Active.DisableTelemetry = true;
```



Чтобы **отключить выбранные стандартные сборщики**, например счетчики производительности, HTTP-запросы или зависимости, удалите или закомментируйте соответствующие строки в файле [ApplicationInsights.config](app-insights-api-custom-events-metrics.md). Это можно сделать, если вы, например, хотите отправить собственные данные TrackRequest.



## Просмотр счетчиков производительности системы

В показатели метрики, которые можно отображать в обозревателе метрики, входит набор системных счетчиков производительности. В предопределенной колонке **Серверы** отображается несколько таких счетчиков.

![Откройте ресурс Application Insights и щелкните "Серверы".](./media/app-insights-how-do-i/121-servers.png)

### Если данные счетчика производительности не отображаются

* **Сервер IIS** на собственном компьютере или на виртуальной машине. [Установите монитор состояния](app-insights-monitor-performance-live-website-now.md). 
* **Веб-сайт Azure** — мы еще не поддерживаем счетчики производительности. Существует несколько метрик, которые можно получить в составе стандартной панели управления веб-сайта Azure.
* **Сервер Unix** — [установите collectd](app-insights-java-collectd.md)

### Для отображения дополнительных счетчиков производительности

* Во-первых, [добавьте новую диаграмму](app-insights-metrics-explorer.md), чтобы посмотреть, находится ли счетчик в базовом наборе предложения.
* Если его нет, [добавьте счетчик к набору, собранному модулем счетчика производительности](app-insights-web-monitor-performance.md#system-performance-counters).

<!---HONumber=Nov15_HO2-->