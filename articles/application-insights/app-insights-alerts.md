<properties 
	pageTitle="Настройка оповещений в Application Insights" 
	description="Получайте сообщения о сбоях, исключениях и изменениях метрик." 
	services="application-insights" 
    documentationCenter=""
	authors="alancameronwills" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/23/2015" 
	ms.author="awills"/>
 
# Настройка оповещений в Application Insights

[Visual Studio Application Insights][start] может предупреждать об изменениях в метриках производительности или использования в приложении.

Application Insights выполняет мониторинг живого приложения на [разнообразных платформах][platforms], чтобы помочь вам диагностировать проблемы с производительностью и понять закономерности использования приложения.

Оповещения бывают двух типов:
 
* **веб-тесты**, сообщающие о том, что сайт недоступен в Интернете или медленно реагирует; [Подробнее][availability].
* **оповещения о метриках**, сообщающие, что какая-либо метрика, например количества сбоев, объема памяти или количества просмотров страницы, достигла порогового значения за некоторый период времени. 

Есть [отдельная страница о веб-тестах][availability], поэтому здесь речь пойдет об оповещениях о метриках.

## Оповещения о метриках

Если вы еще не установили Application Insights для своего приложения, [сделайте это][start].

Чтобы получать сообщения, когда метрики будут достигать порогового значения, запустите обозреватель метрик или перейдите к плитке «Правила оповещения» в колонке «Обзор».

![В колонке правил оповещений нажмите кнопку «Добавить оповещение». Установите приложение в качестве ресурса для измерения, введите имя оповещения и выберите метрику.](./media/app-insights-alerts/01-set-metric.png)

Выбирайте ресурс прежде других свойств. **Выберите ресурс («компоненты»)**, если нужно задать предупреждения для метрик производительности или использования.

Аккуратно указывайте единицы измерения для пороговых значений.

Имя, присваиваемое предупреждению, должно быть уникальным в пределах группы ресурсов (не только приложения).

*Отсутствует кнопка «Добавить оповещение».* Вы используете учетную запись организации? Вы можете настроить оповещения, если у вас есть доступ к этому ресурсу приложения на правах владельца или участника. Просмотрите пункт меню «Параметры» -> «Пользователи». [Дополнительная информация о контроле доступа][roles].

## Отображение оповещений

Вы получите сообщение электронной почты при изменении состояния предупреждения с неактивного на активное.

Текущее состояние каждого предупреждения в колонке правил оповещений.

Ниже показана сводка недавних действий в раскрывающемся списке оповещений.

![](./media/app-insights-alerts/010-alert-drop.png)

Журнал изменений состояния находится в журнале событий эксплуатации:

![В нижней части колонки «Обзор» щелкните «События за прошлую неделю»](./media/app-insights-alerts/09-alerts.png)

*Связаны ли эти события с событиями телеметрии или пользовательскими событиями?*

* Нет. Такие операционные события представляют собой журнал того, что происходит с ресурсом приложения. 


## Принципы работы оповещений

* Оповещение может находиться в двух состояниях: "предупреждение" и "работоспособен". 

* При изменении состояния оповещения выполняется отправка соответствующего электронного письма.

* Каждый раз при получении метрики выполняется оценка оповещения (но не в других случаях).

* При такой оценке выполняется вычисление метрики за предыдущий период и ее сравнение с пороговым значением для определения нового состояния оповещения.

* Выбранный вами период определяет интервал, для которого выполняется вычисление метрики. Он не влияет на периодичность оценки оповещения. Она зависит от частоты получения метрик.

* Если в течение некоторого времени для определенной метрики не поступает никаких данных, то такая ситуация оказывает различное влияние на оценку оповещения и на диаграммы в обозревателе метрик. Если данные не поступают в обозреватель метрик в течение периода, превышающего интервал выборки диаграммы, то на диаграмме будет отображено значение 0. При этом не будет выполняться повторная оценка оповещения, основанного прежней метрике, и его состояние останется неизменным.

    Когда, наконец, данные поступят, значение диаграммы снова станет ненулевым. Будет выполнена оценка оповещения на основании данных, доступных за указанный вами период. Если новая точка данных — единственная доступная в периоде, то для вычисления будет использована только эта точка.

* Даже если задать длительный период, оповещение может часто менять свое состояние с "предупреждение" на "работоспособен" и наоборот. Это может происходить, если значение метрики находится вблизи порогового значения. Для порогового значения не предусмотрен гистерезис: переход из состояния "предупреждение" в состояние "работоспособен" и наоборот происходит при одном и том же значении.



## Оповещения о доступности

Вы можете настроить веб-тесты, которые могут проверить любой веб-сайт в любой точке мира. [Подробнее][availability].

## Какие оповещения следует настраивать

Это зависит от приложения. Прежде всего, лучше не задавать слишком много метрик. Просмотрите диаграммы метрик во время выполнения приложения, чтобы понять, как работает приложение в нормальном режиме. Это поможет вам найти способы повышения его производительности. Затем настройте оповещения, которые будут предупреждать вас, если метрики превысят пределы обычного режима работы.

Чаще всего используются следующие оповещения.

* [Веб-тесты][availability] следует использовать, если приложение представляет собой общедоступный веб-сайт или общедоступную веб-службу, видимые в Интернете. Они сообщают о недоступности сайта или медленном реагировании, даже если это проблема оператора, а не приложения. Но эти тесты — искусственные, поэтому они не измеряют фактическое взаимодействие пользователя с приложением.
* [Метрики браузера][client] (особенно показатель **времени загрузки страницы** браузера) удобно использовать для веб-приложений. Если страница содержит много сценариев, вам может потребоваться найти **исключения браузера**. Чтобы получить эти метрики и оповещения, необходимо настроить [мониторинг веб-страниц][client].
* **Время отклика сервера** и **Запросы со сбоями** для серверной части веб-приложений. Кроме настройки оповещений, следите за этими метриками, чтобы определить, насколько пропорционально они меняются по мере увеличения частоты запросов, так как непропорциональность может указывать на то, что в приложении заканчиваются ресурсы.
* **Исключения сервера**. Чтобы отобразить их, необходимо выполнить [дополнительную настройку](app-insights-asp-net-exceptions.md).

## Настройка оповещений с помощью PowerShell

В большинстве случаев достаточно настроить оповещения вручную. Но если вы хотите автоматически создавать оповещения метрик, это можно сделать с помощью PowerShell.

#### Однократная настройка

Если вы ранее не использовали PowerShell для подписки Azure:

Установите модуль Azure Powershell на компьютере, где требуется выполнять сценарии.

 * Установите [установщик веб-платформы Майкрософт (версии 5 или более поздней)](http://www.microsoft.com/web/downloads/platform.aspx).
 * Используйте его для установки Microsoft Azure PowerShell.


#### Подключение к Azure

Запустите Azure PowerShell и [подключитесь к вашей подписке](powershell-install-configure.md).

```PowerShell

    Add-AzureAccount
    Switch-AzureMode AzureResourceManager
```


#### Получение оповещений

    Get-AlertRule -ResourceGroup "Fabrikam" [-Name "My rule"] [-DetailedOutput]

#### Добавление оповещения


    Add-AlertRule  -Name "{ALERT NAME}" -Description "{TEXT}" `
     -ResourceGroup "{GROUP NAME}" `
     -ResourceId "/subscriptions/{SUBSCRIPTION ID}/resourcegroups/{GROUP NAME}/providers/microsoft.insights/components/{APP RESOURCE NAME}" `
     -MetricName "{METRIC NAME}" `
     -Operator GreaterThan  `
     -Threshold {NUMBER}   `
     -WindowSize {HH:MM:SS}  `
     [-SendEmailToServiceOwners] `
     [-CustomEmails "EMAIL1@X.COM","EMAIL2@Y.COM" ] `
     -Location "East US"
     -RuleType Metric



#### Пример 1

Я хочу получать электронные сообщения, если в среднем за 5 минут ответ сервера на HTTP-запросы выполняется дольше 1 секунды. Мой ресурс Application Insights называется IceCreamWebApp, и он находится в группе ресурсов Fabrikam. Я владелец подписки Azure.

GUID — это идентификатор подписки (не ключ инструментирования приложения).

    Add-AlertRule -Name "slow responses" `
     -Description "email me if the server responds slowly" `
     -ResourceGroup "Fabrikam" `
     -ResourceId "/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/Fabrikam/providers/microsoft.insights/components/IceCreamWebApp" `
     -MetricName "request.duration" `
     -Operator GreaterThan `
     -Threshold 1 `
     -WindowSize 00:05:00 `
     -SendEmailToServiceOwners `
     -Location "East US" -RuleType Metric

#### Пример 2

У меня есть приложение, в котором используется [TrackMetric()](app-insights-api-custom-events-metrics.md#track-metric) для предоставления метрики salesPerHour. Я хочу, чтобы моим коллегам отправлялось электронное сообщение, если в среднем за 24 часа salesPerHour станет меньше 100.

    Add-AlertRule -Name "poor sales" `
     -Description "slow sales alert" `
     -ResourceGroup "Fabrikam" `
     -ResourceId "/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/Fabrikam/providers/microsoft.insights/components/IceCreamWebApp" `
     -MetricName "salesPerHour" `
     -Operator LessThan `
     -Threshold 100 `
     -WindowSize 24:00:00 `
     -CustomEmails "satish@fabrikam.com","lei@fabrikam.com" `
     -Location "East US" -RuleType Metric

Это же правило можно использовать для метрики, передаваемой с помощью [параметра измерения](app-insights-api-custom-events-metrics.md#properties) другого вызова отслеживания, например TrackEvent или trackPageView.

#### Имена метрик

Имя метрики | Имя экрана | Описание
---|---|---
`basicExceptionBrowser.count`|Исключения браузера|Число необработанных исключений в браузере.
`basicExceptionServer.count`|Исключения сервера|Число необработанных исключений приложения
`clientPerformance.clientProcess.value`|Время обработки клиента|Время с момента получения последнего байта документа до загрузки модели DOM. Обработка асинхронных запросов может продолжаться.
`clientPerformance.networkConnection.value`|Время подключения к сети при загрузке страницы| Время, необходимое браузеру для подключения к сети. Может быть 0, если страница в кэше.
`clientPerformance.receiveRequest.value`|Время получения ответа| Время с момента отправки браузером запроса до начала получения ответа.
`clientPerformance.sendRequest.value`|Время отправки запроса| Время, необходимое браузеру для отправки запроса.
`clientPerformance.total.value`|Время загрузки страницы в браузере|Время с момента отправки запроса пользователя до загрузки DOM, таблиц стилей, сценариев и изображений.
`performanceCounter.available_bytes.value`|Объем доступной памяти|Физическая память, доступная для использования процессами или системой.
`performanceCounter.io_data_bytes_per_sec.value`|Скорость обработки операций ввода-вывода|Общее число байтов в секунду в операциях чтения и записи в файлы, сеть и устройства.
`performanceCounter.number_of_exceps_thrown_per_sec`|Частота порождения исключений|Количество исключений, порождаемых в секунду.
`performanceCounter.percentage_processor_time.value`|Обработка ЦП|Процент времени, затраченного всеми потоками процессов, используемых процессором для выполнения инструкций для процесса приложения.
`performanceCounter.percentage_processor_total.value`|Процессорное время|Процент времени, затраченного процессором на непростаивающие потоки.
`performanceCounter.process_private_bytes.value`|Количество байтов исключительного использования процессов|Память, выделенная исключительно для процессов наблюдаемого приложения.
`performanceCounter.request_execution_time.value`|Время выполнения запроса ASP.NET|Время выполнения самого последнего запроса.
`performanceCounter.requests_in_application_queue.value`|Число запросов ASP.NET в очереди выполнения|Длина очереди запросов приложений.
`performanceCounter.requests_per_sec`|Частота запросов ASP.NET|Частота всех запросов из ASP.NET к приложению в секунду.
`remoteDependencyFailed.durationMetric.count`|Ошибки зависимости|Количество неудачных вызовов внешних ресурсов серверным приложением.
`request.duration`|Время ответа от сервера|Время с момента получения HTTP-запроса до завершения отправки ответа.
`request.rate`|Частота запросов|Частота всех запросов к приложению в секунду.
`requestFailed.count`|Failed requests (Неудачные запросы)|Число HTTP-запросов, приведших к отображению кода ответа >= 400. 
`view.count`|Просмотры страниц|Количество клиентских запросов пользователя для веб-страницы. Искусственный трафик отфильтровывается.
{имя пользовательской метрики}|{имя метрики}|Значение метрики, переданное [TrackMetric](app-insights-api-custom-events-metrics.md#track-metric) или в [параметре измерения вызова отслеживания](app-insights-api-custom-events-metrics.md#properties).

Метрики отправляются различными модулями телеметрии:

Группа метрик | Модуль сборщика
---|---
basicExceptionBrowser,<br/>clientPerformance,<br/>view | [Browser JavaScript](app-insights-javascript.md)
performanceCounter | [Производительность](app-insights-configuration-with-applicationinsights-config.md#nuget-package-3)
remoteDependencyFailed| [Dependency](app-insights-configuration-with-applicationinsights-config.md#nuget-package-1)
request,<br/>requestFailed|[Server request](app-insights-configuration-with-applicationinsights-config.md#nuget-package-2)


<!--Link references-->

[availability]: app-insights-monitor-web-app-availability.md
[client]: app-insights-javascript.md
[platforms]: app-insights-platforms.md
[roles]: app-insights-resources-roles-access-control.md
[start]: app-insights-overview.md

 

<!---HONumber=Oct15_HO4-->