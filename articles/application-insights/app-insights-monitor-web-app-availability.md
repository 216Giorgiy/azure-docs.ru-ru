<properties
	pageTitle="Наблюдение за доступностью и скоростью реагирования веб-сайта | Microsoft Azure"
	description="Настройка веб-тестов в Application Insights. Получение оповещений, когда веб-сайт становится недоступным или медленно реагирует на запросы."
	services="application-insights"
    documentationCenter=""
	authors="alancameronwills"
	manager="douge"/>

<tags
	ms.service="application-insights"
	ms.workload="tbd"
	ms.tgt_pltfrm="ibiza"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="05/20/2016"
	ms.author="awills"/>

# Наблюдение за доступностью и скоростью реагирования веб-сайта


[AZURE.INCLUDE [app-insights-selector-get-started-dotnet](../../includes/app-insights-selector-get-started-dotnet.md)]

После развертывания своего веб-приложения вы можете настроить веб-тесты для наблюдения за его доступностью и скоростью реагирования. Application Insights отправляет веб-запросы через одинаковые промежутки времени из разных точек по всему миру и может предупреждать вас, если приложение реагирует медленно или не реагирует вообще.

![Пример веб-теста](./media/app-insights-monitor-web-app-availability/appinsights-10webtestresult.png)

Вы можете настроить веб-тесты для любой конечной точки HTTP или HTTPS, доступной из Интернета.

Существует два типа веб-тестов:

* [Тест проверки связи с URL-адресом](#set-up-a-url-ping-test) – простой тест, который вы можете создать на портале Azure.
* [Многошаговый веб-тест](#multi-step-web-tests) – тест, который вы создаете в Visual Studio Ultimate или Visual Studio Enterprise и загружаете на портал.

Для одного ресурса приложения можно создать не более 10 веб-тестов.


## Настройка теста проверки связи с URL-адресом

### <a name="create"></a>1. Создать новый ресурс?

Пропустите этот шаг, если вы уже [настроили ресурс Application Insights][start] для этого приложения и хотите, чтобы данные о доступности отображались в этом же месте.

Зарегистрируйтесь в [Microsoft Azure](http://azure.com), перейдите на [портал Azure](https://portal.azure.com) и создайте новый ресурс Application Insights.

![Создать > Application Insights](./media/app-insights-monitor-web-app-availability/11-new-app.png)

Откроется колонка "Обзор" для нового ресурса. Чтобы в любой момент найти ее на [портале Azure](https://portal.azure.com), щелкните **Обзор**.

### <a name="setup"></a>2. Создание веб-теста

В ресурсе Application Insights найдите плитку "Доступность". Щелкните ее, чтобы открыть колонку "Веб-тесты" для вашего приложения, и добавьте веб-тест.

![Укажите хотя бы URL-адрес своего веб-сайта](./media/app-insights-monitor-web-app-availability/13-availability.png)

- **URL-адрес** должен быть видимым из общедоступного Интернета. Он может содержать строку запроса, поэтому вы, например, сможете немного поупражняться в работе с базой данных. Если URL-адрес указывает на перенаправление, мы будем переходить по нему до 10 раз.
- **Запросы, зависимые от синтаксического анализа**: изображения, сценарии, файлы стилей и другие ресурсы страницы запрашиваются как часть теста. Тест завершится ошибкой, если эти ресурсы не удается загрузить в течение времени ожидания, актуального для всего теста.
- **Разрешить повторные попытки**: в случае неудачного завершения тест будет повторяться через короткие интервалы времени. Сообщение об ошибке отобразится только после трех неудачных попыток подряд. Последующие тесты будут выполняться с обычной частотой. Повторные попытки будут временно приостановлены до следующей успешной попытки. Это правило действует в любом расположении тестирования. (Эта настройка является рекомендуемой. В среднем около 80 % неудачных попыток решаются при повторной попытке.)
- **Частота тестирования**: задает частоту выполнения теста из каждого тестового расположения. При частоте 5 минут и с 5 тестовыми расположениями ваш сайт будет проверяться в среднем каждую минуту.
- **Расположения тестирования** – это места, из которых наши серверы отправляют веб-запросы на ваш URL-адрес. Выберите несколько расположений, чтобы можно было различать проблемы веб-сайта и сетевые проблемы. Вы можете выбрать до 16 таких расположений.

- **Критерии успешного завершения**:

    **Время ожидания теста**: уменьшите этот параметр, чтобы получать оповещения о медленных откликах. Тест считается неудачной попыткой, если ответы от сайта не были получены в течение заданного периода. Если выбран параметр **Запросы, зависимые от синтаксического анализа**, все изображения, файлы стилей, сценарии и другие зависимые ресурсы должны быть получены в течение этого периода.

    **HTTP-ответ**: возвращаемый код состояния, который считается успешным результатом. Код 200 указывает на возврат нормальной веб-страницы.

    **Совпадение содержимого**: строка, например «Добро пожаловать!». Проверим, что она содержится в каждом ответе. Это должна быть строка обычного текста без подстановочных знаков. Не забывайте, что если контент страницы изменяется, необходимо обновить эту строку.


- **Оповещения** по умолчанию отправляются в случае неудачных попыток в трех расположениях на протяжении 5 минут. Сбой в одном расположении, вероятно, будет вызван проблемой с сетью, а не с сайтом. Но для настройки чувствительности это пороговое значение можно изменить; можно также изменить адресатов, которые получат сообщения по электронной почте.

    Можно настроить [веб-перехватчик](../azure-portal/insights-webhooks-alerts.md), вызываемый при возникновении предупреждения.

#### Тестирование дополнительных URL-адресов

Добавьте дополнительные тесты. Например, при тестировании домашней страницы можно также проверить, запущена ли база данных, путем тестирования URL-адреса поиска.


### <a name="monitor"></a>3. Просмотр отчетов о доступности

Через 1–2 минуты щелкните **Обновить** в колонке доступности или веб-тестов. (Она не обновляется автоматически.)

![Сводка по результатам в домашнем разделе](./media/app-insights-monitor-web-app-availability/14-availSummary.png)

Щелкните любой столбик сводной диаграммы в верхней части окна, чтобы открыть более подробное представление за соответствующий период.

В этих диаграммах приводятся результаты всех веб-тестов данного приложения.

#### Компоненты веб-страницы

Процесс тестирования включает запрос изображений, таблиц стилей и скриптов, а также других статических компонентов тестируемой веб-страницы.

Записанное время ответа — это время, затраченное на загрузку всех компонентов.

Если не удается загрузить какой-либо компонент, тест будет помечен как сбойный.

## <a name="failures"></a>При возникновении сбоев...

Щелкните красную точку.

![Щелкните красную точку.](./media/app-insights-monitor-web-app-availability/14-availRedDot.png)

Либо прокрутите экран вниз и щелкните тест с результатом меньше 100 %.

![Открытие конкретного веб-теста](./media/app-insights-monitor-web-app-availability/15-webTestList.png)

Так будут отображаться результаты теста.

![Открытие конкретного веб-теста](./media/app-insights-monitor-web-app-availability/16-1test.png)

Тест проводится из нескольких расположений. Выберите одно, в котором результаты меньше 100 %.

![Открытие конкретного веб-теста](./media/app-insights-monitor-web-app-availability/17-availViewDetails.png)


Прокрутите вниз до пункта **Неудачные тесты** и выберите результат.

Щелкните результат, чтобы проанализировать его на портале и просмотреть причину сбоя.

![Результат выполнения веб-теста](./media/app-insights-monitor-web-app-availability/18-availDetails.png)


Можно также скачать файл результатов и изучить его в Visual Studio.


*Кажется, что все работает правильно, но выдается отчет об ошибке?* Проверьте все изображения, сценарии, таблицы стилей и любые другие файлы, загружаемые на страницу. Если любой из них дает сбой, отчет о тесте будет выдавать ошибку, даже если главная HTML-страница загружается правильно.



## Многошаговые веб-тесты

Вы можете отслеживать сценарий, который содержит последовательность URL-адресов. Например, в случае наблюдения за интернет-магазином вы можете проверить, что добавление товаров в корзину работает исправно.

Для создания многошагового теста необходимо записать сценарий с помощью Visual Studio и затем отправить запись в Application Insights. Application Insights будет периодически воспроизводить сценарий и проверять ответы.

Обратите внимание, что в тестах нельзя использовать запрограммированные функции: действия сценария в должны содержаться в виде сценария в WEBTEST-файле.

#### 1\. Запись сценария

Для записи веб-сеанса используйте Visual Studio Enterprise или Ultimate.

1. Создайте проект веб-теста производительности.

    ![В Visual Studio создайте новый проект на основе шаблона "Веб-тесты производительности и нагрузочные тесты".](./media/app-insights-monitor-web-app-availability/appinsights-71webtest-multi-vs-create.png)

2. Откройте WEBTEST-файл и начните запись.

    ![Откройте WEBTEST-файл и щелкните "Запись".](./media/app-insights-monitor-web-app-availability/appinsights-71webtest-multi-vs-start.png)

3. Выполните действия пользователя, которые нужно смоделировать в тесте: откройте веб-сайт, добавьте продукт в корзину и т. д. Затем остановите тест.

    ![Запись веб-теста выполняется в Internet Explorer.](./media/app-insights-monitor-web-app-availability/appinsights-71webtest-multi-vs-record.png)

    Не делайте слишком длинный сценарий. Ограничение — 100 шагов и 2 минуты.

4. Отредактируйте тест, чтобы:
 - Добавить проверки полученного текста и кодов ответов.
 - Удалить все лишние взаимодействия. Вы также можете удалить связанные запросы изображений, запросы к рекламным сайтам или сайтам отслеживания.

    Помните, что редактировать можно только тестовый сценарий — добавлять собственный код и вызывать другие веб-тесты нельзя. Не вставляйте в тест циклы. Вы можете использовать стандартные подключаемые модули для веб-тестов.

5. Запустите тест в Visual Studio и убедитесь, что он работает.

    Средство выполнения веб-тестов откроет веб-браузер и повторит записанные действия. Убедитесь, что тест работает правильно.

    ![В Visual Studio откройте WEBTEST-файл и щелкните "Выполнить".](./media/app-insights-monitor-web-app-availability/appinsights-71webtest-multi-vs-run.png)


#### 2\. Загрузка веб-теста в Application Insights

1. Создайте новый веб-тест на портале Application Insights.

    ![В колонке "Веб-тесты" нажмите кнопку "Добавить".](./media/app-insights-monitor-web-app-availability/16-another-test.png)

2. Выберите многошаговый тест и загрузите WEBTEST-файл.

    ![Выберите многошаговый веб-тест.](./media/app-insights-monitor-web-app-availability/appinsights-71webtestUpload.png)

    Установите для тестовых местоположений, частоты и параметров оповещения те же значения, что и для проверок связи.

Просмотр результатов теста и всех ошибок выполняется так же, как и для тестов с одним URL.

Распространенной причиной ошибок является слишком большое время выполнения теста. Тест должен выполняться не более двух минут.

Не забывайте, что для успешного завершения теста на страницу необходимо корректно загрузить все ресурсы, в том числе сценарии, таблицы стилей, изображения и т. д.

Обратите внимание, что веб-тест должен полностью содержаться в WEBTEST-файле: в тесте нельзя использовать запрограммированные функции.


### Вставка времени и случайных чисел в многошаговый тест

Предположим, что вы тестируете инструмент, который получает зависящие от времени данные (например, запасы) от внешнего источника. При записи веб-теста необходимо использовать определенные значения времени, но они должны быть заданы как параметры теста StartTime и EndTime.

![Веб-тест с параметрами.](./media/app-insights-monitor-web-app-availability/appinsights-72webtest-parameters.png)

При запуске теста параметру EndTime следует всегда присваивать текущее время, а параметру StartTime – время за 15 минут до текущего.

Подключаемые модули веб-теста позволяют сделать это.

1. Добавьте подключаемые модули веб-теста для всех необходимых значений переменных параметров. На панели инструментов веб-теста выберите **Добавить подключаемый модуль веб-теста**.

    ![Щелкните "Добавить подключаемый модуль веб-теста" и выберите тип.](./media/app-insights-monitor-web-app-availability/appinsights-72webtest-plugins.png)

    В этом примере мы используем два экземпляра подключаемого модуля даты и времени. Для первого экземпляра будет задано время за 15 минут до текущего, а для второго – текущее время.

2. Откройте свойства каждого подключаемого модуля. Присвойте ему имя и настройте его для использования текущего времени. Для одного из экземпляров задайте для параметра "Добавление минут" значение "-15".

    ![Задайте имя, выберите "Использовать текущее время" и "Добавить минуты".](./media/app-insights-monitor-web-app-availability/appinsights-72webtest-plugin-parameters.png)

3. В параметрах веб-теста используйте {{имя подключаемого модуля}} для ссылки на имя подключаемого модуля.

    ![В параметрах теста используйте {{имя подключаемого модуля}}.](./media/app-insights-monitor-web-app-availability/appinsights-72webtest-plugin-name.png)

Теперь можно передать тест на портал. Он будет использовать динамические значения при каждом тестировании.

## Работа с входом

Если пользователи входят в приложение, есть ряд вариантов для имитации входа, с помощью которых можно протестировать страницы входа. Выбор подхода зависит от типа безопасности в приложении.

Во всех случаях следует создавать учетную запись только для целей тестирования. Если возможно, ограничьте разрешения учетной записи, чтобы она была доступна только для чтения.

* Простое имя пользователя и пароль. Просто запишите веб-тест обычным способом. Сначала удалите файлы cookie.
* Проверка подлинности SAML. Для этого способа можно использовать подключаемый модуль SAML, который доступен для веб-тестов.
* Секрет клиента. Если в приложении предусмотрен маршрут входа с секретом клиента, используйте его. Эта возможность доступна в Azure Active Directory. 
* Открытая проверка подлинности — например, вход с помощью учетной записи Майкрософт или Google. Многие приложения, использующие OAuth, предоставляют альтернативный вариант с использованием секрета клиента, поэтому сначала стоит попробовать этот способ. Если в вашем тесте выполняется вход с использованием OAuth, общий порядок действий таков:
 * Проверьте трафик между веб-браузером, сайтом проверки подлинности и приложением при помощи Fiddler или аналогичного средства. 
 * Выполните вход несколько раз с разных компьютеров или из разных браузеров либо через большие промежутки времени (чтобы истек срок действия маркеров).
 * Сравнивая различные сеансы, определите маркер, возвращаемый с сайта проверки подлинности, который затем передается на сервер приложения после входа. 
 * Запишите веб-тест с помощью Visual Studio. 
 * Параметризуйте маркеры, задав параметр при возврате маркера из структуры проверки подлинности и использовав его в запросе к сайту. (Visual Studio попытается параметризовать тест, но не сможет правильно параметризовать маркеры).


## <a name="edit"></a>Изменение или отключение теста

Откройте отдельный тест, чтобы изменить или отключить его.

![Изменение или отключение веб-теста](./media/app-insights-monitor-web-app-availability/19-availEdit.png)

Отключение веб-тестов может потребоваться при выполнении обслуживания в службе.

## Автоматизация

* [С помощью сценариев PowerShell веб-тест можно настроить ](https://azure.microsoft.com/blog/creating-a-web-test-alert-programmatically-with-application-insights/) автоматически. 
* Настройте [веб-перехватчик](../azure-portal/insights-webhooks-alerts.md), вызываемый при возникновении предупреждения.

## Вопросы? Проблемы?

* *Можно ли вызывать код из моего веб-теста?*

    Нет. Действия теста должны находиться в WEBTEST-файле. Кроме того, нельзя вызывать другие веб-тесты и использовать циклы. Но существует ряд подключаемых модулей, которые могут оказаться полезным.

* *Поддерживается ли протокол HTTPS?*

    В настоящее время поддерживаются протоколы SSL 3.0 и TLS 1.0.

* *Есть ли разница между понятиями «веб-тесты» и «тесты доступности»?*

    Мы используем эти термины как взаимозаменяемые.

* *Мне нужно использовать тесты доступности на нашем внутреннем сервере, который работает за брандмауэром.*

    Разрешите в брандмауэре запросы с IP-адресов, которые приведены в конце этой статьи.

* *Сбой отправки многошагового веб-теста*.

    Максимальный размер — 300 000.

    Циклы не поддерживаются.

    Ссылки на другие веб-тесты не поддерживаются.

    Источники данных не поддерживаются.

    
* *Мой многошаговый тест не выполняется*.

    Максимальное количество запросов в тесте — 100.

    Тест будет остановлен, если он выполняется дольше двух минут.

* *Как запустить тест с клиентскими сертификатами?*

    К сожалению, эта возможность не поддерживается.


## <a name="video"></a>Видео

> [AZURE.VIDEO monitoring-availability-with-application-insights]

## <a name="next"></a>Дальнейшие действия

[Поиск по журналам диагностики][diagnostic]

[Устранение неполадок][qna]


## IP-адреса веб-тестов

Если вам нужно разрешить в брандмауэре веб-тесты, используйте следующий список IP-адресов. Время от времени он может изменяться.

Откройте порты 80 (HTTP) и 443 (HTTPS).

```

213.199.178.54
213.199.178.55
213.199.178.56
213.199.178.61
213.199.178.57
213.199.178.58
213.199.178.59
213.199.178.60
213.199.178.63
213.199.178.64
207.46.98.158
207.46.98.159
207.46.98.160
207.46.98.157
207.46.98.152
207.46.98.153
207.46.98.156
207.46.98.162
207.46.98.171
207.46.98.172
65.55.244.40
65.55.244.17
65.55.244.42
65.55.244.37
65.55.244.15
65.55.244.16
65.55.244.44
65.55.244.18
65.55.244.46
65.55.244.47
207.46.14.60
207.46.14.61
207.46.14.62
207.46.14.55
207.46.14.63
207.46.14.64
207.46.14.51
207.46.14.52
207.46.14.56
207.46.14.65
157.55.14.60
157.55.14.61
157.55.14.62
157.55.14.47
157.55.14.64
157.55.14.65
157.55.14.43
157.55.14.44
157.55.14.49
157.55.14.50
65.54.66.56
65.54.66.57
65.54.66.58
65.54.66.61
207.46.71.54
207.46.71.52
207.46.71.55
207.46.71.38
207.46.71.51
207.46.71.57
207.46.71.58
207.46.71.37
202.89.228.67
202.89.228.68
202.89.228.69
202.89.228.57
65.54.78.49
65.54.78.50
65.54.78.51
65.54.78.54
94.245.82.32
94.245.82.33
94.245.82.37
94.245.82.38
94.245.72.44
94.245.72.45
94.245.72.46
94.245.72.49
207.46.56.57
207.46.56.58
207.46.56.59
207.46.56.67
207.46.56.61
207.46.56.62
207.46.56.63
207.46.56.64
65.55.82.84
65.55.82.85
65.55.82.86
65.55.82.81
65.55.82.87
65.55.82.88
65.55.82.89
65.55.82.90
65.55.82.91
65.55.82.92
94.245.78.40
94.245.78.41
94.245.78.42
94.245.78.45
70.37.147.43
70.37.147.44
70.37.147.45
70.37.147.48
94.245.66.43
94.245.66.44
94.245.66.45
94.245.66.48

```


<!--Link references-->

[azure-availability]: ../insights-create-web-tests.md
[diagnostic]: app-insights-diagnostic-search.md
[qna]: app-insights-troubleshoot-faq.md
[start]: app-insights-overview.md

<!---HONumber=AcomDC_0525_2016-->