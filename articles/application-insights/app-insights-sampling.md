<properties 
	pageTitle="Выборка данных телеметрии в Application Insights" 
	description="Как управлять объемом данных телеметрии." 
	services="application-insights" 
    documentationCenter="windows"
	authors="vgorbenko" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="10/20/2015" 
	ms.author="awills"/>

#  Выборка в Application Insights

*Application Insights находится в состоянии предварительной версии.*


Выборка — это функция в Application Insights, которая позволяет собирать и хранить сокращенный набор данных телеметрии наряду с выполнением статистически правильного анализа данных приложений. Выборка обычно используется для сокращения трафика и предотвращения [регулирования](app-insights-pricing.md#data-rate). Данные фильтруются таким образом, чтобы похожие элементы пропускались и вы могли выполнять диагностику с сокращенным набором данных. Клиент и сервер автоматически координируют свои действия, чтобы фильтровать похожие элементы. Отображаемые на портале счетчики метрик перенормированы с учетом выборки, чтобы их влияние на статистику было минимальным.


Функция выборки в настоящее время работает в режиме бета-версии. В будущем она может измениться.

## Настройка выборки для приложения

Выборка в настоящее время доступна для пакета SDK для ASP.NET или [любой веб-страницы](#other-web-pages).

### Сервер ASP.NET
Чтобы настроить выборку в приложении, вставьте следующий фрагмент кода в метод `Application_Start()` в файле Global.asax.cs:

```C#

    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;
    // This configures sampling percentage at 10%:
    TelemetryConfiguration.Active.TelemetryChannel = new TelemetryChannelBuilder().UseSampling(10.0).Build();
```

> [AZURE.NOTE]В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число. Например, допустимыми являются следующие значения: 50 (= 1/2), 33,33 (= 1/3), 25 (= 1/4), 20 (= 1/5) и т. д. В настоящее время выборка не поддерживает другие значения.

### Веб-страницы с использованием JavaScript

Вы можете настроить веб-страницы для использования выборки с любого сервера. Для серверов ASP.NET настройка требуется на стороне клиента и сервера.

При [настройке веб-страниц для Application Insights](app-insights-javascript.md) измените фрагмент, загруженный с портала Application Insights (для ASP.NET он находится в файле \_Layout.cshtml). Вставьте строку, например `samplingPercentage: 10,`, перед ключом инструментирования:

    <script>
	var appInsights= ... 
	}({ 

	samplingPercentage: 10, 

	instrumentationKey:...
	}); 
	
	window.appInsights=appInsights; 
	appInsights.trackPageView(); 
	</script> 

Убедитесь, что вы указали такой же процент выборки в JavaScript, как и для сервера.

[Дополнительные сведения об API](app-insights-api-custom-events-metrics.md)


## Когда следует использовать выборку?

Выборка не требуется для большинства приложений малого и среднего размера. Наиболее полезные диагностические сведения и наиболее точную статистику можно получить путем сбора данных обо всех действиях пользователей.

 
Далее приведены основные причины, по которым вам стоит использовать выборку.


* Служба Application Insights удаляет («регулирует») точки данных, когда приложение слишком часто отправляет данные телеметрии за короткий интервал времени. 
* Вам нужно оставаться в пределах [квоты](app-insights-pricing.md) на точки данных для вашей ценовой категории. 
* Вам нужно сократить сетевой трафик, который тратится на сбор данных телеметрии. 

## Как работает функция выборки?

Для приложения выборка — это компонент пакета SDK для Application Insights. Вы указываете, какой процент точек данных должен отправляться в службу Application Insights. Пакет SDK для Application Insights версии 2.0.0 позволяет указывать процент выборки в коде. (В будущих версиях пакета SDK будет реализована дополнительная возможность настраивать процент выборки в файле ApplicationInsights.config.)

Пакет SDK определяет, какие элементы телеметрии будут удалены, а какие будут сохранены. Решение выборки основано на нескольких правилах, цель которых — сохранение всех точек взаимосвязанных данных без изменений, а также реализация функции диагностики в Application Insights даже с использованием сокращенного набора данных. Например, если для неудачно завершенного запроса приложение отправляет дополнительные элементы телеметрии (например, исключение и трассировки, зарегистрированные этим запросом), выборка не будет разделять этот запрос и другие данные телеметрии. Она либо сохраняет, либо удаляет все элементы вместе. Поэтому при просмотре сведений о запросе в Application Insights вы всегда будете видеть запрос вместе со связанными элементами телеметрии.

Для приложений, которые определяют пользователя (т. е. наиболее типичных веб-приложений), решение выборки основывается на хэше идентификатора пользователя. Это означает, что все данные телеметрии для конкретного пользователя либо сохраняются, либо удаляются. Для типов приложений, которые не определяют пользователей (например, веб-службы), решение выборки основывается на идентификаторе операции запроса. Наконец, для элементов телеметрии, у которых нет ни идентификатора пользователя, ни идентификатора операции (например, элементы телеметрии, включенные в отчет по асинхронным потокам без контекста HTTP), выборка будет просто собирать определенный процент элементов телеметрии каждого типа.

Представляя вам данные телеметрии, служба Application Insights корректирует метрики в соответствии с процентом выборки, который использовался во время сбора. Это делается, чтобы компенсировать отсутствующие точки данных. Следовательно, при просмотре данных телеметрии в Application Insights пользователи видят статистически правильные приблизительные значения, очень близкие к реальным цифрам.

Точность приблизительного значения в значительной степени зависит от заданного процента выборки. Кроме того, точность возрастает для приложений, обрабатывающих большой объем сходных запросов от большого количества пользователей. С другой стороны, для приложений, которые не работают с существенной нагрузкой, выборка не требуется, так как эти приложения обычно могут отправлять все данные телеметрии, не выходя за пределы квоты и не вызывая потерю данных в результате регулирования.

Обратите внимание, что служба Application Insights не выполняет выборку типов данных телеметрии, представленных метриками и сеансами, так как снижение точности для этих типов может быть весьма нежелательным.

## Выборка и пакет SDK для JavaScript

Пакет SDK клиента (JavaScript) участвует в выборке в сочетании с серверным пакетом SDK. Инструментированные страницы будут отправлять данные телеметрии клиента только от тех пользователей, которых сервер включил в выборку. Такая логика обеспечивает непрерывность сеанса пользователя как на клиенте, так и на сервере. Благодаря этому с помощью любого элемента телеметрии в Application Insights можно найти все остальные элементы телеметрии для этого пользователя или сеанса.

*Данные телеметрии на клиенте и сервере не отображают скоординированные образцы, как описано выше.*

* Проверьте, включена ли выборка на сервере и клиенте.
* Убедитесь в том, что используется пакет SDK версии 2.0 или выше.
* Проверьте, указан ли процент выборки на клиенте и сервере.


## Часто задаваемые вопросы 

*Почему выборка — это не простой сбор X процентов данных телеметрии каждого типа?*

 *  Хотя такой подход к выборке обеспечил бы очень высокую точность в приблизительных значениях метрик, он не позволит сопоставлять диагностические данные для каждого пользователя, сеанса и запроса, что является критически важным для диагностики. Поэтому выборку лучше всего описать как «сбор всех элементов телеметрии для X процентов пользователей приложения» или «сбор всех данных телеметрии для X процентов запросов приложения». Для элементов телеметрии, не связанных с запросами (включая асинхронную фоновую обработку), альтернативным вариантом является «сбор X процентов всех элементов для данных телеметрии каждого типа». 

*Может ли процент выборки меняться со временем?*

 * В текущей реализации вы не сможете изменить процент выборки после его настройки при запуске приложения. Хотя вы можете управлять средой выполнения процента выборки, невозможно определить, какой процент выборки будет оптимальным и будет собирать «только нужный объем данных», прежде чем будет применена логика регулирования или исчерпана ежемесячная квота на объем данных. Будущие версии пакета SDK для Application Insights будут включать адаптивную выборку, которая в режиме реального времени будет настраивать процент выборки (уменьшать и увеличивать) на основе наблюдаемого в настоящее время объема данных телеметрии и других факторов. 

*Как узнать, какой процент выборки будет наилучшим для моего приложения?*

* Сейчас об этом можно только гадать. Анализируйте текущее использование телеметрии в AI, отслеживайте связанное с регулированием удаление данных, а также оценивайте объем собранных данных телеметрии. Эти три фактора в сочетании с выбранной ценовой категорией позволят оценить объем собранных данных телеметрии, который может потребоваться сократить. При этом изменение объема данных телеметрии может нарушить оптимальную настройку процента выборки (например, при увеличении количества пользователей). При реализации адаптивной выборки процент выборки будет автоматически регулироваться в соответствии с оптимальным уровнем в зависимости от наблюдаемого объема данных телеметрии.

*Что произойдет, если настроить слишком низкий процент выборки?*

* Слишком низкий процент выборки (излишне агрессивная выборка) снизит точность приблизительных значений, когда служба Application Insights пытается компенсировать отображение данных для сокращения объема данных. Кроме того, это может отрицательно повлиять на функцию диагностики, так как в выборку могут не попасть некоторые редкие сбои или медленные запросы.

*Что произойдет, если настроить слишком высокий процент выборки?*

* Настройка слишком высокого процента выборки (недостаточно агрессивная выборка) приведет к недостаточному снижению объема собранных данных телеметрии. У вас по-прежнему может наблюдаться потеря данных телеметрии, связанная с регулированием, а затраты на использование Application Insights могут быть выше запланированных из-за избыточных расходов.

*На каких платформах можно использовать выборку?*

* В настоящее время выборка доступна для использования с любыми веб-страницами, а также веб-приложениями .NET (как на стороне клиента, так и на стороне сервера).

*Можно ли использовать выборку с приложениями для устройств (Windows Phone, iOS, Android или классическими приложениями)?*

* Нет, с приложениями для устройств использование выборки в настоящее время не поддерживается. 

<!---HONumber=Oct15_HO4-->