.<properties 
	pageTitle="Выборка данных телеметрии в Application Insights" 
	description="Как управлять объемом данных телеметрии." 
	services="application-insights" 
    documentationCenter="windows"
	authors="vgorbenko" 
	manager="douge"/>

.<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="08/30/2016" 
	ms.author="awills"/>

#  Выборка в Application Insights

*Доступна только предварительная версия Application Insights.*


Выборка — это функция в Application Insights, которая позволяет собирать и хранить сокращенный набор данных телеметрии, а также выполнять статистически правильный анализ данных приложений. Выборка позволяет сократить трафик и избежать [регулирования](app-insights-pricing.md#data-rate). Данные фильтруются таким образом, чтобы похожие элементы пропускались и вы могли переходить между элементами в ходе диагностики. Отображаемые на портале счетчики метрик перенормированы с учетом выборки, чтобы их влияние на статистику было минимальным.

Функция выборки в настоящее время работает в режиме бета-версии. В будущем она может измениться.

## Краткое описание

* Выборка сохраняет 1 из *n* записей и отклоняет остальные. Например, при частоте выборки 20 % сохраняется 1 из 5 событий.
* Если приложение отправляет большие объемы данных телеметрии, выборка происходит автоматически. Автоматическая выборка активируется только при больших объемах и только в приложениях веб-сервера ASP.NET.
* Выборку можно также задать вручную на портале на странице цен, чтобы сократить объем хранящихся данных телеметрии и соблюдать месячную квоту, или в пакете SDK для ASP.NET в CONFIG-файле, чтобы также уменьшить сетевой трафик.
* Текущую частоту выборки определяет соответствующее свойство каждой записи. В окне "Поиск" откройте событие, например запрос. Нажмите кнопку "…" (многоточие), чтобы развернуть список свойств и найти свойство "количество *", например "количество запросов" или "количество событий", в зависимости от типа данных телеметрии. Если значение этого свойства больше 1, выполняется выборка. Значение 3 означает, что выборка составляет 33 %, т. е. каждая сохраняемая запись равна трем первоначально созданным записям.
* Если при регистрации пользовательских событий необходимо убедиться, что набор событий сохранен или отклонен полностью, проверьте, одинаковое ли у них значение идентификатора операции.
* При написании запросов аналитики необходимо [учитывать выборку](app-insights-analytics-tour.md#counting-sampled-data). В частности, вместо простого подсчета записей следует использовать функцию `summarize sum(itemCount)`.


## Типы выборки

Существует три альтернативных метода выборки.

* **Адаптивная выборка** автоматически корректирует объем данных телеметрии, отправляемых из пакета SDK в приложение ASP.NET. По умолчанию используется SDK версии 2.0.0-beta3.
* **Выборка с фиксированной частотой** уменьшает объем данных телеметрии, отправляемых с сервера ASP.NET и из браузеров пользователей. Частоту вы задаете сами.
* **Выборка приема** уменьшает объем данных телеметрии, сохраняемых службой Application Insights с указанной вами периодичностью. Она не уменьшает трафик телеметрии, но помогает оставаться в пределах месячной квоты.

## Выборка приема

Этот вид выборки работает в точке, где данные телеметрии с веб-сервера, браузеров и устройств достигают конечной точки службы Application Insights. Несмотря на то, что трафик телеметрии, отправляемой из приложения, такая выборка не уменьшает, она сокращает объем данных для обработки и сохранения в службе Application Insights, а значит и размер оплаты.

Используйте этот тип выборки, если ваше приложение часто выходит за рамки ежемесячной квоты, а возможности использовать один из типов выборки на основе SDK нет.

Частота выборки задается в колонке квот и ценообразования:

![В колонке общих сведений о приложении щелкните "Параметры", "Квота", "Выборки", выберите частоту выборки и щелкните "Обновить".](./media/app-insights-sampling/04.png)

Как и в других типах выборки, алгоритм сохраняет связанные элементы телеметрии. Например, при проверке телеметрии в поиске это позволит найти запрос, связанный с определенным исключением. Правильно сохраняются счетчики метрик, например частота запросов и частота исключений.

Точки данных, отклоненные выборкой, доступны не во всех функциях Application Insights, например [Непрерывный экспорт](app-insights-export-telemetry.md).

Выборка приема не работает во время действия адаптивной или фиксированной выборки на основе пакета SDK. Если частота выборки в пакете SDK меньше 100 %, заданная частота выборки приема не учитывается.

> [AZURE.WARNING] Значение, отображаемое на плитке, обозначает значение, которое вы задали для выборки приема. Оно не отражает фактическую частоту выборки, если действует выборка пакета SDK.


## Адаптивная выборка на веб-сервере

Адаптивная выборка доступна в пакете SDK Application Insights для ASP.NET 2.0.0-beta3 или более поздней версии и по умолчанию включена.


Адаптивная выборка влияет на объем данных телеметрии, отправляемых в службу Application Insights из приложения веб-сервера. Том автоматически настраивается на работу с заданным максимальным объемом трафика.

Он не работает с небольшими объемами данных телеметрии и не затрагивается при отладке приложения или веб-узла с низкой нагрузкой.

Для получения целевого тома некоторые формируемые данные телеметрии игнорируются. Однако, как и в других типах выборки, алгоритм сохраняет связанные элементы телеметрии. Например, при проверке телеметрии в поиске это позволит найти запрос, связанный с определенным исключением.

Счетчики метрик, например частота запросов и частота исключений, корректируются с учетом частоты выборки, так что в обозревателе метрик отображаются приблизительно точные значения.

**Обновите пакеты NuGet своего проекта** до последней *предварительной* версии Application Insights. В обозревателе решений щелкните проект правой кнопкой мыши, выберите «Управление пакетами NuGet», установите флажок **Включить предварительный выпуск** и выполните поиск Microsoft.ApplicationInsights.Web.

В файле [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md) можно настроить несколько параметров узла `AdaptiveSamplingTelemetryProcessor`. Ниже представлены значения по умолчанию.

* `<MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>`

    Целевая частота, к которой стремится адаптивный алгоритм **на каждом узле сервера**. Если веб-приложение выполняется на множестве узлов, нужно уменьшить это значение, чтобы не превышать целевую скорость трафика на портале Application Insights.

* `<EvaluationInterval>00:00:15</EvaluationInterval>`

    Интервал повторного вычисления текущей частоты телеметрии. Вычисление выполняется на основе скользящего среднего. Вы можете сократить этот интервал, если наблюдаете неожиданные скачки данных телеметрии в сторону увеличения.

* `<SamplingPercentageDecreaseTimeout>00:02:00</SamplingPercentageDecreaseTimeout>`

    Время, по истечении которого можно снова снизить процент выборки для сбора меньшего объема данных после изменения значения процента выборки.

* `<SamplingPercentageIncreaseTimeout>00:15:00</SamplingPercentageIncreaseTimeout>`

    Время, по истечении которого можно снова увеличить процент выборки для сбора большего объема данных после изменения значения процента выборки.

* `<MinSamplingPercentage>0.1</MinSamplingPercentage>`

    Минимальное допустимое значение с учетом изменения процента выборки.

* `<MaxSamplingPercentage>100.0</MaxSamplingPercentage>`

    Максимальное допустимое значение с учетом изменения процента выборки.

* `<MovingAverageRatio>0.25</MovingAverageRatio>`

    Взвешенное значение, присваиваемое последнему значению при вычислении скользящего среднего. Используйте значение не больше 1. Использование значений ниже рекомендуемых приводит к тому, что скорость реагирования алгоритма на резкие изменения замедляется.

* `<InitialSamplingPercentage>100</InitialSamplingPercentage>`

    Значение, назначенное сразу после запуска приложения. Не снижайте это значение во время отладки.

### Альтернатива: настройка адаптивной выборки в коде

Вместо настройки выборки в CONFIG-файле вы можете использовать код. Это позволяет указать функцию обратного вызова, которая вызывается каждый раз, когда производится повторная оценка частоты выборки. Это можно использовать, например, чтобы узнать, какая частота выборки используется.

Удалите узел `AdaptiveSamplingTelemetryProcessor` из CONFIG-файла.



*C#*

```C#

    using Microsoft.ApplicationInsights;
    using Microsoft.ApplicationInsights.Extensibility;
    using Microsoft.ApplicationInsights.WindowsServer.Channel.Implementation;
    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;
    ...

    var adaptiveSamplingSettings = new SamplingPercentageEstimatorSettings();

    // Optional: here you can adjust the settings from their defaults.

    var builder = TelemetryConfiguration.Active.TelemetryProcessorChainBuilder;
    
    builder.UseAdaptiveSampling(
         adaptiveSamplingSettings,

        // Callback on rate re-evaluation:
        (double afterSamplingTelemetryItemRatePerSecond,
         double currentSamplingPercentage,
         double newSamplingPercentage,
         bool isSamplingPercentageChanged,
         SamplingPercentageEstimatorSettings s
        ) =>
        {
          if (isSamplingPercentageChanged)
          {
             // Report the sampling rate.
             telemetryClient.TrackMetric("samplingPercentage", newSamplingPercentage);
          }
      });

    // If you have other telemetry processors:
    builder.Use((next) => new AnotherProcessor(next));

    builder.Build();

```

([Сведения о процессорах телеметрии](app-insights-api-filtering-sampling.md#filtering).)


<a name="other-web-pages"></a>
## Включение выборки для веб-страниц с помощью JavaScript

Вы можете настроить выборку с фиксированной частотой для веб-страниц с любого сервера.

При [настройке веб-страниц для Application Insights](app-insights-javascript.md) измените фрагмент, скачанный с портала Application Insights. (В приложениях ASP.NET фрагменты обычно содержатся в \_Layout.cshtml.) Вставьте строку, похожую на `samplingPercentage: 10,`, перед ключом инструментирования:

    <script>
	var appInsights= ... 
	}({ 


    // Value must be 100/N where N is an integer.
    // Valid examples: 50, 25, 20, 10, 5, 1, 0.1, ...
	samplingPercentage: 10, 

	instrumentationKey:...
	}); 
	
	window.appInsights=appInsights; 
	appInsights.trackPageView(); 
	</script> 

В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число. В настоящее время выборка не поддерживает другие значения.

Если вы также включите выборку с фиксированной частотой на сервере, выборка будет синхронизироваться между клиентом и сервером. Благодаря этому вы сможете перемещаться между связанными представлениями страниц и запросами в службе поиска.


## Выборка с фиксированной частотой для веб-сайтов ASP.NET

Выборка с фиксированной частотой уменьшает объем трафика, отправляемого с веб-сервера и веб-браузеров. В отличие от адаптивной выборки объем данных уменьшается в фиксированном, заданном вами размере. Выборки клиента и сервера синхронизируются, а связанные элементы сохраняются: например, просматривая представление странице в поиске, вы всегда сможете найти соответствующий ему запрос.

Алгоритм выборки сохраняет связанные элементы. При каждом событии HTTP-запроса он и связанные с ним события игнорируются или передаются.

В обозревателе метрик такие параметры, как счетчики запросов и исключений, умножаются на коэффициент, компенсирующий частоту выборки, что позволяет получать примерно точные значения.

1. **Обновите пакеты NuGet проекта** до последней *предварительной* версии Application Insights. В обозревателе решений щелкните проект правой кнопкой мыши, выберите «Управление пакетами NuGet», установите флажок **Включить предварительный выпуск** и выполните поиск Microsoft.ApplicationInsights.Web.

2. **Отключите адаптивную выборку**. В файле [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md) удалите или преобразуйте в комментарий узел `AdaptiveSamplingTelemetryProcessor`.

    ```xml

    <TelemetryProcessors>
    <!-- Disabled adaptive sampling:
      <Add Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.AdaptiveSamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">
        <MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>
      </Add>
    -->
    

    ```

2. **Включите модуль выборки с фиксированной частотой.** Добавьте этот фрагмент кода в файл [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md):

    ```XML

    <TelemetryProcessors>
     <Add  Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.SamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">

      <!-- Set a percentage close to 100/N where N is an integer. -->
     <!-- E.g. 50 (=100/2), 33.33 (=100/3), 25 (=100/4), 20, 1 (=100/100), 0.1 (=100/1000) -->
      <SamplingPercentage>10</SamplingPercentage>
      </Add>
    </TelemetryProcessors>

    ```

> [AZURE.NOTE] В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число. В настоящее время выборка не поддерживает другие значения.



### Альтернатива: включение выборки с фиксированной частотой в коде сервера


Вы можете использовать код и не задавать параметр выборки в CONFIG-файле.

*C#*

```C#

    using Microsoft.ApplicationInsights.Extensibility;
    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;
    ...

    var builder = TelemetryConfiguration.Active.GetTelemetryProcessorChainBuilder();
    builder.UseSampling(10.0); // percentage

    // If you have other telemetry processors:
    builder.Use((next) => new AnotherProcessor(next));

    builder.Build();

```

([Сведения о процессорах телеметрии](app-insights-api-filtering-sampling.md#filtering).)


## Когда следует использовать выборку?

Адаптивная выборка включается автоматически, если используется пакет SDK для ASP.NET 2.0.0-beta3 или более поздней версии. Выборку приема (на наших серверах) можно применять независимо от используемой версии SDK.

Выборка не требуется для большинства приложений малого и среднего размера. Наиболее полезные диагностические сведения и наиболее точную статистику можно получить, собирая данные обо всех действиях пользователей.

 
Основные преимущества выборки:

* Служба Application Insights удаляет («регулирует») точки данных, когда приложение слишком часто отправляет данные телеметрии за короткий интервал времени.
* Вы остаетесь в пределах [квоты](app-insights-pricing.md) на точки данных для своей ценовой категории.
* Вам нужно сократить сетевой трафик, который тратится на сбор данных телеметрии.

### Какой тип выборки следует использовать?


**Используйте выборку приема, если:**

* Вы часто превышаете ежемесячную квоту телеметрии.
* Вы используете версию пакета SDK, которая не поддерживает выборки, например, более раннюю версию пакета SDK для Java или ASP.NET, чем версия 2.
* Вы получаете много данных телеметрии с веб-браузеров пользователей.

**Используйте выборку с фиксированной частотой, если:**

* Вы используете пакет SDK Application Insights для веб-служб ASP.NET 2.0.0 или более поздней версии; и
* Вам нужна синхронизированная выборка между клиентом и сервером, которая позволяет перемещаться между связанными событиями на стороне клиента и сервера (такими, как просмотры страниц и HTTP-запросы) при использовании [службы поиска](app-insights-diagnostic-search.md) в ходе анализа событий.
* Вам нужна уверенность в выборе соответствующего процента выборки для вашего приложения. Он должен быть достаточно высоким, чтобы получить точные метрики и при этом не превышать ценовую квоту и ограничения регулирования.


**Используйте адаптивную выборку:**

В противном случае мы рекомендуем использовать адаптивную выборку. В SDK сервера ASP.NET 2.0.0-beta3 или более поздней версии она включена по умолчанию. Такая выборка не уменьшает трафик, не превышающий определенный минимальный объем, и не влияет на сайты, которые используются редко.


## Как узнать, действует ли выборка

Чтобы узнать фактическую частоту выборки (где бы она ни применялась), выполните такой [запрос аналитики](app-insights-analytics.md):

    requests | where timestamp > ago(1d)
    | summarize 100/avg(itemCount) by bin(timestamp, 1h) 
    | render areachart 

Для каждой сохранившейся записи `itemCount` обозначает число исходных записей, которые эта запись представляет (1 + число предыдущих удаленных записей).


## Как работает функция выборки?

Выборка с фиксированной частотой и адаптивная выборка — это компонент пакета SDK в ASP.NET 2.0.0 и более поздних версий. Выборка приема — это компонент службы Application Insights. Она может работать, даже если пакет SDK не выполняет выборку.

Алгоритм выборки решает, какие элементы телеметрии необходимо удалить, а какие сохранить (как в пакете SDK, так и в службе Application Insights). Решение выборки основано на нескольких правилах, цель которых — сохранение всех точек взаимосвязанных данных без изменений, а также реализация функции диагностики в Application Insights даже с использованием сокращенного набора данных. Например, если для неудачно завершенного запроса приложение отправляет дополнительные элементы телеметрии (например, исключение и трассировки, зарегистрированные этим запросом), выборка не будет разделять этот запрос и другие данные телеметрии. Она либо сохраняет, либо удаляет все элементы вместе. Поэтому при просмотре сведений о запросе в Application Insights вы всегда будете видеть запрос вместе со связанными элементами телеметрии.

Для приложений, которые определяют пользователя (т. е. наиболее типичных веб-приложений), решение выборки основывается на хэше идентификатора пользователя. Это означает, что все данные телеметрии для конкретного пользователя либо сохраняются, либо удаляются. Для типов приложений, которые не определяют пользователей (например, веб-службы), решение выборки основывается на идентификаторе операции запроса. Наконец, для элементов телеметрии, у которых нет ни идентификатора пользователя, ни идентификатора операции (например, элементы телеметрии, включенные в отчет по асинхронным потокам без контекста HTTP), выборка будет просто собирать определенный процент элементов телеметрии каждого типа.

Представляя вам данные телеметрии, служба Application Insights корректирует метрики в соответствии с процентом выборки, который использовался во время сбора. Это делается, чтобы компенсировать отсутствующие точки данных. Следовательно, при просмотре данных телеметрии в Application Insights пользователи видят статистически правильные приблизительные значения, очень близкие к реальным цифрам.

Точность приблизительного значения в значительной степени зависит от заданного процента выборки. Кроме того, точность возрастает для приложений, обрабатывающих большой объем сходных запросов от большого количества пользователей. С другой стороны, для приложений, которые не работают с существенной нагрузкой, выборка не требуется, так как такие приложения обычно могут отправлять все данные телеметрии, не выходя за пределы квоты и не вызывая потерю данных в результате регулирования.

Обратите внимание, что служба Application Insights не выполняет выборку типов данных телеметрии, представленных метриками и сеансами, так как снижение точности для этих типов может быть весьма нежелательным.

### Адаптивная выборка

Адаптивная выборка добавляет компонент, который отслеживает текущую скорость передачи данных из пакета SDK и корректирует процент выборки, чтобы оставаться в пределах целевой максимальной скорости. Корректировка пересчитывается через регулярные интервалы времени в зависимости от скользящего среднего для скорости исходящей передачи.

## Выборка и пакет SDK для JavaScript

Пакет SDK клиента (JavaScript) участвует в выборке с фиксированной частотой в сочетании с серверным пакетом SDK. Инструментированные страницы отправляют данные телеметрии клиента только от тех пользователей, которых сервер включил в выборку. Такая логика обеспечивает непрерывность сеанса пользователя как на клиенте, так и на сервере. Благодаря этому с помощью любого элемента телеметрии в Application Insights можно найти все остальные элементы телеметрии для этого пользователя или сеанса.

*Данные телеметрии на клиенте и сервере не отображают скоординированные образцы, как описано выше.*

* Убедитесь в том, что выборка с фиксированной частотой включена и на сервере, и в клиенте.
* Убедитесь в том, что используется пакет SDK версии 2.0 или выше.
* Проверьте, указан ли процент выборки на клиенте и сервере.


## Часто задаваемые вопросы 

*Почему выборка — это не простой сбор X процентов данных телеметрии каждого типа?*

 *  Хотя такой подход к выборке обеспечил бы очень высокую точность в приблизительных значениях метрик, он не позволит сопоставлять диагностические данные для каждого пользователя, сеанса и запроса, что является критически важным для диагностики. Поэтому выборку лучше всего описать как «сбор всех элементов телеметрии для X процентов пользователей приложения» или «сбор всех данных телеметрии для X процентов запросов приложения». Для элементов телеметрии, не связанных с запросами (включая асинхронную фоновую обработку), альтернативным вариантом является сбор X процентов всех элементов для данных телеметрии каждого типа.

*Может ли процент выборки меняться со временем?*

 * Да, адаптивная выборка постепенно меняет процент выборки в зависимости от текущего объема данных телеметрии.

 

*Если я использую выборку с фиксированной частотой, как узнать, какой процент выборки будет оптимальным для моего приложения?*

* Один из способов — начать с адаптивной выборки, узнать подобранную частоту (см. вопрос выше) и переключиться на выборку с этой фиксированной частотой.

    В противном случае придется только угадывать. Анализируйте текущее использование телеметрии в AI, наблюдайте осуществляемое регулирование и оценивайте объем собранных данных телеметрии. Эти три фактора в сочетании с выбранной ценовой категорией позволяют оценить объем собранных данных телеметрии, который может потребоваться сократить. Однако увеличение числа пользователей или некоторые другие факторы, меняющие объем данных телеметрии, могут сделать оценку недействительной.

*Что произойдет, если настроить слишком низкий процент выборки?*

* Слишком низкий процент выборки (излишне агрессивная выборка) снижает точность приблизительных значений, когда служба Application Insights пытается компенсировать отображение данных для сокращения объема данных. Кроме того, это может отрицательно повлиять на функцию диагностики, так как в выборку могут не попасть некоторые редкие сбои или медленные запросы.

*Что произойдет, если настроить слишком высокий процент выборки?*

* Слишком высокий процент выборки (недостаточно агрессивная выборка) приводит к недостаточному снижению объема собранных данных телеметрии. У вас по-прежнему может наблюдаться потеря данных телеметрии, связанная с регулированием, а затраты на использование Application Insights могут быть выше запланированных из-за избыточных расходов.

*На каких платформах можно использовать выборку?*

* Выборка приема может выполняться автоматически, когда объем данных телеметрии превышает определенный порог, если пакет SDK не выполняет выборку. Она будет работать, например, если приложение использует сервер Java или если вы используете старую версию пакета SDK для ASP.NET.

* Если вы используете пакет SDK ASP.NET 2.0.0 и более поздних версий (размещенный в Azure или на собственном сервере), адаптивная выборка работает по умолчанию, однако вы можете перейти на выборку с фиксированной частотой, как описано выше. При выборке с фиксированной частотой пакет SDK браузера выполняет автоматическую синхронизацию с событиями, связанными с выборкой.

*Есть определенные редкие события, которые я всегда хочу просматривать. Как сделать так, чтобы модуль выборки не отфильтровывал их?*

 * Инициализируете отдельный экземпляр TelemetryClient с новой конфигурацией TelemetryConfiguration (не активной по умолчанию). Используйте его для отправки редких событий.

<!---HONumber=AcomDC_0831_2016-->