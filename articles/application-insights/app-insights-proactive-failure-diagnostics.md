<properties 
	pageTitle="Упреждающая диагностика в Application Insights почти в реальном времени | Microsoft Azure" 
	description="Оповещает о необычном характере ошибок в приложении и предоставляет диагностический анализ. Настройка не требуется." 
	services="application-insights" 
    documentationCenter=""
	authors="yorac" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="08/31/2016" 
	ms.author="awills"/>
 
# Упреждающая диагностика сбоев

Пакет [Visual Studio Application Insights](app-insights-overview.md) автоматически уведомляет вас (почти в реальном времени), когда работа веб-приложения сопровождается чрезмерным числом сбоев. Он обнаруживает необычное увеличение числа неудавшихся HTTP-запросов. Для того чтобы вам было проще определить и диагностировать проблему, в уведомление включается анализ характеристик невыполненных запросов и соответствующие данные телеметрии. Кроме того, даются ссылки на портал Application Insights для дальнейшей диагностики. Эта функция не требует настройки, так как использует алгоритмы машинного обучения для прогнозирования нормальной частоты невыполненных запросов.

Эта функция работает для веб-приложений Java и ASP.NET, размещенных в облаке или на ваших серверах. Она также работает для любого приложения, создающего телеметрию запросов, например, при наличии рабочей роли, вызывающей [TrackRequest()](app-insights-api-custom-events-metrics.md#track-request).

Если пакет [Application Insights настроен для вашего проекта](app-insights-overview.md), а ваше приложение создает минимальный объем данных телеметрии, системе упреждающей диагностики необходимо 24 часа, чтобы изучить нормальное поведение приложения. Затем система включается и может отправлять оповещения.

Вот пример оповещения.

![Пример умного оповещения, содержащий связанный со сбоем анализ кластера](./media/app-insights-proactive-failure-diagnostics/010.png)

> [AZURE.NOTE] По умолчанию приходит более краткое сообщение, чем в этом примере. Но можно [переключиться на этот подробный формат](#configure-alerts).

Обратите внимание на то, что оно содержит:

* Количество сбоев по сравнению с обычным поведением приложения.
* Число затронутых пользователей, чтобы вы знали, насколько сильно следует беспокоиться.
* Шаблон характеристик, связанный с ошибками. В этом примере имеются конкретный код ошибки, имя запроса (операция) и версия приложения. Это позволяет сразу же определить фрагмент кода, с которого следует начать поиск. К другим возможностям может относиться определенный тип браузера или клиентской операционной системы.
* Исключения, трассировки журналов и сбои в зависимостях (базах данных или других внешних компонентах), которые могут быть связаны с описанными неудачными запросами.
* Прямые ссылки на соответствующие поиски телеметрии в Application Insights.

## Преимущества упреждающих оповещений

Обычные [оповещения метрик](app-insights-alerts.md) сообщают о возможном наличии проблемы. А функция упреждающей диагностики сбоев самостоятельно осуществляет диагностику и анализ, которые иначе вам пришлось бы выполнять самостоятельно. Вы получаете тщательно подобранные результаты, что помогает быстро выявить первопричину проблемы.

## Принцип работы

Диагностика в близком к реальному масштабе времени отслеживает поступающие из вашего приложения данные телеметрии, а именно частоту невыполненных запросов. Эта метрика подсчитывает количество запросов, для которых свойство `Successful request` имеет значение false. По умолчанию `Successful request== (resultCode < 400)` (если вы не написали пользовательский код для [фильтрации](app-insights-api-filtering-sampling.md#filtering) или создания собственных вызовов [TrackRequest](app-insights-api-custom-events-metrics.md#track-request)).

Производительность вашего приложения обладает типичным шаблоном поведения. Одни запросы будут более подвержены сбоям, чем другие, а общий процент сбоев может возрастать при увеличении нагрузки. Для выявления таких аномалий упреждающая диагностика сбоев использует машинное обучение.

Так как телеметрия поступает в Application Insights из веб-приложения, упреждающая диагностика сбоев сравнивает текущее поведение с поведением, наблюдаемым последние несколько дней. Если по сравнению с предыдущими показателями производительности наблюдается чрезмерное увеличение частоты отказов, запускается анализ.

При запуске анализа служба анализирует кластер по неудачному запросу, чтобы попытаться определить шаблон значений, который характеризует отказы. В приведенном выше примере анализ обнаружил, что большинство сбоев связаны с конкретным кодом ошибки, именем запроса, URL-адресом сервера и экземпляром роли. Анализ также обнаружил, что свойство операционной системы клиента распределено по нескольким значениям, и поэтому его нет в списке.

Если ваша служба может предоставлять эти данные телеметрии, анализатор находит исключение и ошибку зависимости, связанные с запросами в установленном кластере, а также примеры журналов трассировки, связанных с такими запросами.

Результат анализа отправляется в виде оповещения, если в настройках не указан иной способ.

Как и в случае [оповещений, настраиваемых вручную](app-insights-alerts.md), вы можете проверить состояние оповещения и настроить его в соответствующей колонке ресурса Application Insights. Но в отличие от других оповещений вам не нужно настраивать упреждающую диагностику сбоев. При желании адреса электронной почты для отправки оповещений можно отключить или изменить.


## Настройка оповещений 

Вы можете отключить упреждающую диагностику, изменить получателей электронной почты, создать веб-перехватчик или предоставить согласие на получение более подробных оповещений.

Откройте страницу "Оповещения". Превентивная диагностика включается для всех оповещений, которые вы настроили вручную. Здесь можно увидеть, находится ли она в состоянии оповещения.

![На странице "Обзор" щелкните плитку оповещения. Либо на любой странице метрики нажмите кнопку "Оповещения".](./media/app-insights-proactive-failure-diagnostics/021.png)

Щелкните оповещение, чтобы его настроить.

![Конфигурация](./media/app-insights-proactive-failure-diagnostics/031.png)


Обратите внимание, что превентивную диагностику можно отключить, но нельзя удалить (или создать еще одну).

#### Подробные оповещения

Если установить флажок "Получать подробный анализ", сообщение электронной почты будет содержать дополнительные диагностические сведения. Иногда удается диагностировать проблему на основе только данных в сообщении электронной почты.

Существует небольшой риск, что более подробное оповещение может содержать конфиденциальные сведения, поскольку оно включает сообщения об исключениях и трассировке. Тем не менее это может произойти, только если код допускает передачу конфиденциальных сведений в эти сообщения.


## Рассмотрение и диагностика оповещения

Оповещение означает, что обнаружен чрезмерный рост частоты невыполненных запросов. Скорее всего, проблема возникла в приложении или его среде.

В зависимости от процента запросов и числа вовлеченных пользователей вы можете решить, насколько срочно необходимо решить проблему. В приведенном выше примере доля невыполненных запросов (22,5 %) сравнивается с нормальным показателем (1 %), из чего очевидно наличие проблемы. С другой стороны, это затронуло только 11 пользователей. Если это было ваше приложение, вы сможете оценить серьезность ситуации.

Зачастую проблему можно быстро диагностировать по имени запроса, исключениям, зависимостям и другим данным трассировки.

Существуют и некоторые другие признаки. Например, процент сбоев зависимостей в этом примере совпадает с процентом исключений (89,3 %). Из этого можно предположить, что исключение возникает непосредственно при сбое зависимости, что позволяет точно определить фрагмент кода, с которого следует начать проверку.

Для дальнейшего изучения воспользуйтесь ссылками в каждом разделе, которые укажут на [страницу поиска](app-insights-diagnostic-search.md), относящуюся к соответствующим запросам, исключениям, зависимостям или трассировкам. Вы также можете открыть [портал Azure](https://portal.azure.com), выбрав ресурс Application Insights для своего приложения и открыв колонку "Сбои".

В этом примере при выборе ссылки "Просмотр сведений о сбоях зависимостей" откроется колонка поиска Application Insights с инструкциями SQL и первопричиной: значения NULL, указанные в обязательных полях, не прошли проверку во время операции сохранения.


![Поиск по журналу диагностики](./media/app-insights-proactive-failure-diagnostics/051.png)

## Просмотр последних оповещений

Чтобы просмотреть оповещения на портале, откройте **Параметры, Журналы аудита**.

![Общие данные оповещения](./media/app-insights-proactive-failure-diagnostics/041.png)


Щелкните оповещение, чтобы открыть его полные данные.

Или щелкните **Упреждающее обнаружение**, чтобы быстро перейти к последнему оповещению.

![Общие данные оповещения](./media/app-insights-proactive-failure-diagnostics/070.png)




## В чем разница?

Упреждающая диагностика сбоев дополняет аналогичные компоненты Application Insights с отличающимися функциями.

* [Оповещения метрик](app-insights-alerts.md) задаются пользователем и позволяют отслеживать самые разные метрики, включая нагрузку на ЦП, частоту запросов, время загрузки страниц и т. д. Их можно использовать, например, для того, чтобы добавить ресурсы. А упреждающая диагностика сбоев, напротив, охватывает небольшой диапазон критически важных метрик (сейчас — только число невыполненных запросов), почти в реальном времени оповещая вас о том, что частота невыполненных запросов в веб-приложении намного превышает нормальный для веб-приложения уровень.

    Упреждающая диагностика сбоев автоматически соотносит пороговое значение с имеющимися условиями.

    Упреждающая диагностика сбоев самостоятельно запускает процедуру диагностики.
* [Упреждающая диагностика аномалий](app-insights-proactive-anomaly-diagnostics.md) использует искусственный интеллект для обнаружения необычного поведения ваших метрик без необходимости в настройке. В отличие от упреждающей диагностики сбоев, эта функция предназначена для поиска плохо обслуживаемых сегментов вашего приложения (например, неправильной работы определенных страниц в определенном типе браузера). Анализ выполняется ежедневно, и обнаруженные результаты обычно не требуют таких срочных действий, как оповещения. Анализ упреждающей диагностики сбоев, напротив, выполняется непрерывно на основе всех поступающих данных телеметрии. Если частота сбоев сервера намного превышает ожидания, вы получите оповещение в течение нескольких минут.

## Если вы получили оповещение от упреждающей диагностики сбоев

*Почему мне направлено это предупреждение?*

*	Мы обнаружили аномальное увеличение количества неудачных запросов по сравнению с обычными показателями за предыдущий период. После анализа сбоев и соответствующей телеметрии мы считаем, что возникла проблема, которую необходимо решить.

*Уведомление означает, что определенно возникла какая-то неполадка?*

*	Мы стараемся выдавать предупреждения о нарушении или ухудшении работы приложения, хотя только вы имеете полное представление о семантике и влиянии на приложение или пользователей.

*Это означает, что вы отслеживаете мои данные?*

*	Нет, служба работает полностью в автоматическом режиме. Уведомления получаете только вы. Ваши данные [конфиденциальны](app-insights-data-retention-privacy.md).

*Нужно ли мне подписаться на это оповещение?*

*	Нет. Каждое приложение, отправляющее телеметрию запросов, имеет это правило оповещения.

*Можно отменить подписку или настроить пересылку уведомлений моим коллегам?*

*	Да, в области "Правила оповещений" щелкните правило "Превентивная диагностика" для настройки пересылки. Вы можете отключить это оповещение или изменить его получателей.

*Не могу найти письмо. Где найти уведомления на портале?*

*	В журналах аудита. Щелкните "Параметры", "Журналы аудита", а затем щелкните по любому оповещению, чтобы просмотреть его. При этом отображаемые сведения о свойстве будут ограничены.

*Некоторые оповещения относятся к известным проблемам, и я не хочу получать их.*

*	У нас в планах есть функция подавления оповещений.


## Дальнейшие действия

Эти диагностические средства позволяют проверять данные телеметрии из приложения:

* [Обозреватель метрик](app-insights-metrics-explorer.md)
* [Обозреватель поиска](app-insights-diagnostic-search.md)
* [Аналитика, мощный язык запросов](app-insights-analytics-tour.md)

Упреждающее обнаружение — это полностью автоматическая функция, но, возможно, вам потребуется настроить некоторые дополнительные оповещения.

* [Настройка оповещений в Application Insights](app-insights-alerts.md)
* [Доступность веб-тестов](app-insights-monitor-web-app-availability.md)

<!---HONumber=AcomDC_0907_2016-->