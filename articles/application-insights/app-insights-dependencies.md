<properties 
	pageTitle="Диагностика проблем с зависимостями в Application Insights" 
	description="Найдите сбои и операции с низкой производительностью, вызванные зависимостями." 
	services="application-insights" 
    documentationCenter=""
	authors="alancameronwills" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/17/2015" 
	ms.author="awills"/>
 
# Диагностика проблем с зависимостями в Application Insights


*Зависимость* – это внешний компонент, который вызывается приложением. Как правило, это служба, вызываемая с использованием HTTP, база данных или файловая система. В Visual Studio Application Insights можно легко увидеть то, сколько времени приложение ожидает зависимости и как часто происходит сбой вызова зависимости.

## Возможное применение

Мониторинг зависимостей по умолчанию сейчас доступен для

* веб-приложений и служб ASP.NET, работающих на сервере IIS или на платформе Azure;
* [Веб-приложения Java](app-insights-java-agent.md)

Для других типов приложений, например приложений для устройств, можно написать свой собственный монитор, используя [API TrackDependency](app-insights-api-custom-events-metrics.md#track-dependency).

Сейчас монитор зависимостей по умолчанию предоставляет отчеты о вызовах зависимостей таких типов:

* ASP.NET:
 * базы данных SQL;
 * веб-службы и службы WCF ASP.NET, использующие привязки на основе HTTP;
 * локальные или удаленные HTTP-вызовы;
 * Azure DocumentDB, очередь, таблица и хранилище больших двоичных объектов.
* Java:
 * вызовы к базе данных с помощью драйвера [JDBC](http://docs.oracle.com/javase/7/docs/technotes/guides/jdbc/) (например, MySQL, SQL Server, PostgreSQL или SQLite).

Напомним, что можно самостоятельно написать вызовы SDK для мониторинга других зависимостей.

## Настройка мониторинга зависимостей

Установите соответствующий агент для сервера узла.

платформа | Установить
---|---
Сервер IIS | [Монитор состояния](app-insights-monitor-performance-live-website-now.md)
Веб-приложение Azure | [Расширение для Application Insights](../azure-portal/insights-perf-analytics.md)
Веб-сервер Java | [Веб-приложения Java](app-insights-java-agent.md)

В случае с монитором состояния для серверов IIS вам не нужно заново компилировать проект с исходным кодом, используя пакет SDK для Application Insights.

## <a name="diagnosis"></a> Диагностика проблем с производительностью зависимостей

Чтобы оценить производительность запросов сервера:

![На странице «Обзор» приложения в Application Insights щелкните плитку «Производительность».](./media/app-insights-dependencies/01-performance.png)

прокрутите вниз, чтобы увидеть сетку запросов.

![Список запросов со средними значениями и их количеством](./media/app-insights-dependencies/02-reqs.png)

Получение ответа на верхний запрос заняло слишком много времени. Стоит попытаться выяснить, на что потрачено время.

Щелкните эту строку, чтобы просмотреть события для отдельного запроса.


![Список вхождений запросов](./media/app-insights-dependencies/03-instances.png)

Щелкните любой длительный экземпляр, чтобы проверить его более детально.

> [AZURE.NOTE]Немного прокрутите вниз, чтобы выбрать экземпляр. Задержка в конвейере может означать неполноту данных верхних экземпляров.

Прокрутите вниз до вызовов удаленных зависимостей, связанных с этим запросом:

![Найдите вызовы удаленных зависимостей и определите необычную продолжительность.](./media/app-insights-dependencies/04-dependencies.png)

По-видимому, большую часть времени обработки этого запроса занял вызов локальной службы.

Выберите эту строку, чтобы получить дополнительную информацию.


![Щелкните эту удаленную зависимость, чтобы определить причину.](./media/app-insights-dependencies/05-detail.png)

Подробности включают в себя достаточно данных для диагностики проблемы.



## Сбои

При наличии неудачных запросов щелкните диаграмму.

![Щелкните диаграмму неудачных запросов.](./media/app-insights-dependencies/06-fail.png)

Щелкните тип и экземпляр запроса, чтобы найти удаленную зависимость, вызов которой не удалось выполнить.


![Щелкните тип запроса, а затем его экземпляр, чтобы открыть этот же экземпляр в другом представлении. Щелкните его еще раз, чтобы просмотреть подробную информацию об исключении.](./media/app-insights-dependencies/07-faildetail.png)


## Пользовательское отслеживание зависимостей

Стандартный модуль отслеживания зависимостей выявляет внешние зависимости, например базы данных и API REST, автоматически. Однако при необходимости аналогичную обработку можно настроить и для других компонентов.

Код, который отправляет сведения о зависимостях, можно написать с использованием того же интерфейса [API TrackDependency](app-insights-api-custom-events-metrics.md#track-dependency), что используется в стандартных модулях.

Например, формируя код на основе готовой сборки, можно назначить время для всех вызовов этого кода и таким образом выяснить, как он влияет на время отклика вашей системы. Чтобы эти данные отображались в диаграммах зависимостей в Application Insights, используйте для их отправки командлет `TrackDependency`.

```C#

            var success = false;
            var startTime = DateTime.UtcNow;
            var timer = System.Diagnostics.Stopwatch.StartNew();
            try
            {
                success = dependency.Call();
            }
            finally
            {
                timer.Stop();
                telemetry.TrackDependency("myDependency", "myCall", startTime, timer.Elapsed, success);
            }
```

Чтобы отключить стандартный модуль отслеживания зависимостей, удалите ссылку на DependencyTrackingTelemetryModule в файле [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md).

<!--Link references-->

<!---HONumber=Oct15_HO3-->