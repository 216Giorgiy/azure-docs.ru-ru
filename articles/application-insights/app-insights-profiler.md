---
title: "Профилирование динамических веб-приложений в Azure с помощью Application Insights | Документация Майкрософт"
description: "Определите критический путь в коде веб-сервера с помощью профилировщика небольшого размера."
services: application-insights
documentationcenter: 
author: alancameronwills
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.devlang: na
ms.topic: article
ms.date: 04/03/2017
ms.author: awills
ms.translationtype: Human Translation
ms.sourcegitcommit: aaf97d26c982c1592230096588e0b0c3ee516a73
ms.openlocfilehash: 13a2883c59092c964cf3c353e767839c5f9ef788
ms.contentlocale: ru-ru
ms.lasthandoff: 04/27/2017


---
# <a name="profiling-live-azure-web-apps-with-application-insights-preview"></a>Профилирование динамических веб-приложений Azure с помощью Application Insights (предварительная версия)

*Эта функция доступна только в предварительной версии Application Insights.*

Узнайте, сколько времени выполняется каждый метод в динамическом веб-приложении с помощью средства профилирования [Azure Application Insights](app-insights-overview.md). Оно отображает подробные данные профилей динамических запросов, обработанные приложением, а также выделяет "критический путь", на использование которого уходит большая часть времени. Это средство автоматически выбирает примеры с разным временем ответа. Профилировщик использует различные методы для минимизации затрат. 

Сейчас он работает для веб-приложений ASP.NET, запущенных в службах приложений Azure, по крайней мере с ценовой категорией "Базовый". (При использовании ASP.NET Core целевая платформа должна содержать значение `.NetCoreApp`.)

<a id="installation"></a>
## <a name="enable-the-profiler"></a>Включение профилировщика

[Установите Application Insights](app-insights-asp-net.md) в коде. Если эта среда уже установлена, убедитесь, что вы используете последнюю версию. (Щелкните правой кнопкой мыши проект в обозревателе решений и выберите "Управление пакетами NuGet". Выберите "Обновления" и обновите все пакеты.) Повторно разверните приложение.

*Используете ASP.NET Core? [Ознакомьтесь с этим разделом](#aspnetcore).*

На сайте [https://portal.azure.com](https://portal.azure.com) откройте ресурс Application Insights для своего веб-приложения. Откройте колонку **Производительность** и нажмите кнопку **Настроить**. Выберите приложение и следуйте указаниям мастера.

![Колонка "Производительность", кнопка "Настроить"][performance-blade]

* *Отсутствует кнопка "Настроить"? Устраните проблему [вручную](#manual-installation).*

Если профилировщик необходимо остановить или перезапустить, его можно найти **в ресурсе службы приложений** в **веб-заданиях**. Чтобы его удалить, найдите раздел **Расширения**.

Если вы используете WebDeploy для развертывания изменений в веб-приложении, убедитесь, что папка **App_Data** не удалилась во время развертывания. В противном случае файлы с расширением профилировщика будут удалены при следующем развертывании веб-приложения в Azure.

**[Обновление]**  Расширение сайта Application Insights содержит встроенный агент профилировщика из выпуска 2.3. Он заменяет исходное расширение сайта профилировщика Application Insights. Можно выполнить перенос на последнюю версию с помощью мастера **настройки**.

## <a name="viewing-profiler-data"></a>Просмотр данных профилировщика

Откройте колонку "Производительность" и прокрутите вниз до списка операций.




![Столбец примеров в колонке "Производительность" Application Insights][performance-blade-examples]

Ниже приведены столбцы в таблице.

* **Число.** Количество запросов в диапазоне времени колонки.
* **Median** (Медиана). Стандартное время, требуемое приложению для ответа на запрос. Половина всех ответов была получена быстрее, чем сейчас.
* **95th percentile** (95-й процентиль). 95 % ответов были получены быстрее, чем сейчас. Если это число существенно отличается от медианы, возможно, в приложении периодически возникают неполадки. (Или это можно объяснить с помощью такой конструктивной функции, как кэширование.)
* **Примеры.** Значок указывает, что профилировщик получил трассировки стека для этой операции.

Щелкните значок "Примеры", чтобы открыть обозреватель трассировки. В обозревателе находится несколько примеров, записанных профилировщиком, которые классифицируются по времени ответа.

Выберите пример, чтобы отобразить классификацию на уровне кода по времени, затраченному на выполнение запроса.

![Обозреватель трассировки Application Insights][trace-explorer]

С помощью флажка **Show hot path** (Показывать критический путь) можно открыть основной листовой узел или хотя бы что-то с ним связанное. В большинстве случаев этот узел будет размещаться рядом с узким местом производительности.



* **Метка** — имя функции или события. В дереве отображается сочетание кода и возникающих событий (например, события SQL и HTTP). Основное событие предоставляет общую длительность запроса.
* **Метрика** — затраченное время.
* **Когда** — отображает время запуска функции или события по отношению к другим функциям. 

## <a name="how-to-read-performance-data"></a>Чтение данных о производительности

Профилировщик службы Майкрософт использует метод выборки и инструментирование для анализа производительности приложения. Во время подробной сборки профилировщик службы каждую миллисекунду проводит выборку указателя инструкций для всех ЦП компьютера. Каждый пример записывает полный стек вызовов выполняющегося потока, предоставляя подробные и полезные сведения о нем на высоком и низком уровне абстракции. Профилировщик службы также собирает сведения о других событиях, например о событиях переключения контекста, библиотеки параллельных задач (TPL) и пула потоков для отслеживания корреляции действий и причинно-следственных связей. 

Стек вызовов, отображаемый в представлении временной шкалы, является результатом приведенной выше выборки и инструментирования. Так как каждый пример записывает полный стек вызовов потока, он содержит код из .NET Framework, а также из других указанных платформ.

### <a id="jitnewobj"></a>Выделение объектов (`clr!JIT\_New or clr!JIT\_Newarr1`)
`clr!JIT\_New and clr!JIT\_Newarr1` — это вспомогательные функции в .NET Framework, выделяющие память из управляемой кучи. `clr!JIT\_New` вызывается при выделении объекта. `clr!JIT\_Newarr1` вызывается при выделении массива объектов. Обычно эти две функции выполняются очень быстро за относительно небольшое время. Если функции `clr!JIT\_New` или `clr!JIT\_Newarr1` занимают довольно много времени во временной шкале, это указывает на то, что код, возможно, выделяет несколько объектов и потребляет значительный объем памяти. 

### <a id="theprestub"></a>Код загрузки (`clr!ThePreStub`)
`clr!ThePreStub` — это вспомогательная функция в .NET Framework, подготавливающая код к первому выполнению. Как правило, она включает в себя JIT-компиляцию (но не ограничивается ей). Для каждого метода C# `clr!ThePreStub` должна вызываться только один раз в течение всего времени существования процесса.

Если `clr!ThePreStub` требуется много времени для запроса, это значит, что запрос впервые выполняет метод, на загрузку которого требуется значительное время работы среды выполнения .NET Framework. Вы можете использовать процесс прогрева, выполняющий эту часть кода до предоставления к нему доступа пользователям, или запустить NGen в сборках. 

### <a id="lockcontention"></a>Конфликт блокировки (`clr!JITutil\_MonContention` или `clr!JITutil\_MonEnterWorker`)
`clr!JITutil\_MonContention` или `clr!JITutil\_MonEnterWorker` указывают текущий поток, ожидающий снятия блокировки. Обычно это отображается при выполнении команды lock языка C# путем вызова метода Monitor.Enter или метода с атрибутом MethodImplOptions.Synchronized. Конфликт блокировки обычно происходит при получении блокировки потоком A, а также при попытке получить ту же блокировку потоком Б до ее снятия потоком A. 

### <a id="ngencold"></a>Код загрузки (`[COLD]`)
Если имя метода содержит `[COLD]`, например `mscorlib.ni![COLD]System.Reflection.CustomAttribute.IsDefined`, это значит, что в среде выполнения .NET Framework выполняется код, оптимизация которого впервые не осуществилась <a href="https://msdn.microsoft.com/library/e7k32f4k.aspx">с использованием профиля</a>. Для каждого метода он должен отображаться только один раз в течение всего времени существования процесса. 

Если коду загрузки требуется значительное время на запрос, это значит, что запрос впервые выполняет неоптимизированную часть метода. Вы можете использовать процесс прогрева, который выполняет эту часть кода до предоставления к нему доступа пользователям. 

### <a id="httpclientsend"></a>Отправка HTTP-запроса
Методы (например, `HttpClient.Send`) указывают код, ожидающий завершения HTTP-запроса.

### <a id="sqlcommand"></a>Операция с базой данных
Метод (например, SqlCommand.Execute) указывает код, ожидающий завершения операции с базой данных.

### <a id="await"></a>Ожидание (`AWAIT\_TIME`)
`AWAIT\_TIME` указывает код, ожидающий завершения другой задачи. Обычно это осуществляется с помощью команды await языка C#. Когда код выполняет эту команду, поток освобождает и возвращает элемент управления в пул потоков, а поток, блокирующийся при ожидании завершения await, отсутствует. Однако если рассуждать логически, поток, который "заблокировал" await, ожидает завершения операции. `AWAIT\_TIME` указывает время блокировки в ожидании завершения задачи.

### <a id="block"></a>Время блокировки
`BLOCKED_TIME` указывает, что код ожидает, пока другой ресурс станет доступным, например, ожидает объект синхронизации, ожидает, пока поток станет доступным, или ожидает завершения запроса. 

### <a id="cpu"></a>Время ЦП
ЦП занят выполнением инструкций.

### <a id="disk"></a>Время работы диска
Приложение выполняет операции с диском.

### <a id="network"></a>Сетевое время
Приложение выполняет сетевые операции.

### <a id="when"></a>Столбец "Время"
Это визуальное представление того, как со временем изменяются выборки INCLUSIVE, собранные для узла. Общий диапазон запроса состоит из 32 временных периодов, в которых накапливаются включающие выборки для данного узла. Затем каждый период представляется в виде полосы, высота которой обозначает масштабированное значение. Для узлов, помеченных как `CPU_TIME` или `BLOCKED_TIME`, или когда существует очевидная связь с потреблением ресурсов (ЦП, диск, поток), в полосе представлено использование одного из этих ресурсов за определенный период времени. Для этих метрик можно получить показатель, превышающий 100 %, за счет потребления нескольких ресурсов. Например, если в среднем за определенный интервал времени используется два процессора, показатель достигнет 200 %.


## <a id="troubleshooting"></a>Устранение неполадок

### <a name="how-can-i-know-whether-application-insights-profiler-is-running"></a>Как узнать, работает ли профилировщик Application Insights?

Профилировщик запускается в качестве непрерывного веб-задания в веб-приложении. Вы можете открыть ресурс веб-приложения на сайте https://portal.azure.com и проверить состояние ApplicationInsightsProfiler в колонке веб-заданий. Если он не работает, щелкните **Журналы**, чтобы узнать об этом побольше. 

### <a name="why-cant-i-find-any-stack-examples-even-though-the-profiler-is-running"></a>Почему не удается найти все примеры стека даже при работе профилировщика?

Вот несколько моментов, которые можно проверить.

1. Убедитесь, что вы используете план службы веб-приложений уровня "Базовый" и выше.
2. Проверьте, содержит ли веб-приложение пакет SDK Application Insights бета-версии 2.2 и более поздней.
3. Убедитесь, что веб-приложение содержит параметр APPINSIGHTS_INSTRUMENTATIONKEY с тем же ключом инструментирования, который использует пакет SDK Application Insights.
4. Проверьте, работает ли веб-приложение на платформе .Net Framework 4.6.
5. Если это приложение ASP.NET Core, также проверьте [необходимые зависимости](#aspnetcore).

После запуска профилировщика наблюдается короткий период прогрева, во время которого профилировщик активно собирает несколько трассировок производительности. Он выполняет это действие в течение двух минут каждый час.  

### <a name="i-was-using-azure-service-profiler-what-happened-to-it"></a>Я включил профилировщик службы Azure. Что с ним произошло?  

При включении профилировщика Application Insights агент профилировщика службы Azure отключается.

### <a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем фактическая длительность запроса. 

Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме. Поэтому общее время потока будет больше затраченного времени. Во многих случаях один поток может ожидать завершения другого. Средство просмотра пытается это обнаружить и исключить ненужное ожидание, но при этом вместо исключения возникает слишком много ошибок. Это могут быть критически важные сведения.  

Обнаружив параллельные потоки в трассировках, необходимо указать, какие потоки находятся в состоянии ожидания, чтобы можно было определить критический путь к запросу. В большинстве случаев поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки. Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.

### <a id="issue-loading-trace-in-viewer"></a>Нет данных профилирования

1. Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку.

2. Проверьте, не заблокирован ли доступ к https://gateway.azureserviceprofiler.net для прокси-серверов или брандмауэра. 

3. Убедитесь, что ключ инструментирования Application Insights, используемый в приложении, совпадает с ресурсом Application Insights с включенным профилированием. Обычно ключ находится в файле ApplicationInsights.config, но его также можно найти в файле web.config или app.config.

### <a name="error-report-in-the-profiling-viewer"></a>Отчет об ошибках в средстве просмотра профилирования

Отправьте запрос в службу поддержки с портала. Укажите идентификатор корреляции из сообщения об ошибке.


## <a name="manual-installation"></a>Ручная установка

При настройке профилировщика в параметры веб-приложения вносятся следующие обновления. Вы можете установить их вручную.

1. В колонке управления веб-приложением выберите "Параметры".
2. Для платформы .NET Framework установите версию 4.6.
3. Установите для параметра "Всегда включено" значение "Включено".
4. Добавьте параметр приложения __APPINSIGHTS_INSTRUMENTATIONKEY__ и задайте для него значение с тем же ключом инструментирования, используемым пакетом SDK.
5. В разделе **Расширения** добавьте Application Insights. Установка займет несколько минут.

## <a id="aspnetcore"></a>Поддержка ASP.NET Core

Сейчас приложение ASP.NET Core поддерживается в среде выполнения .NET Core.

Приложение также должно включать следующие компоненты для включения профилирования.

1. [Application Insights для ASP.NET Core 2.0](https://github.com/Microsoft/ApplicationInsights-aspnetcore/releases/tag/v2.0.0)
2. [System.Diagnostics.DiagnosticSource 4.4.0-beta-25022-02](https://dotnet.myget.org/feed/dotnet-core/package/nuget/System.Diagnostics.DiagnosticSource/4.4.0-beta-25022-02)
    * В Visual Studio выберите "Инструменты -> Диспетчер пакетов NuGet -> Параметры диспетчера пакетов".
    * В диалоговом окне "Параметры" выберите "Диспетчер пакетов NuGet -> Источники пакетов".
    * Нажмите кнопку "+" для добавления нового источника пакета с именем DotNet-Core-MyGet и значением https://dotnet.myget.org/F/dotnet-core/api/v3/index.json.
    * Нажмите кнопку "Обновить" и закройте диалоговое окно "Параметры".
    * Откройте обозреватель решений, щелкните проект ASP.NET Core правой кнопкой мыши и выберите "Управление пакетами NuGet…".
    * На вкладке "Обзор" выберите Package source: DotNet-Core-MyGet (Источник пакета: DotNet-Core-MyGet) и установите флажок "Включить предварительные выпуски".
    * Найдите System.Diagnostics.DiagnosticSource и выберите __4.4.0-beta-25022-02__ для установки.


## <a name="next-steps"></a>Дальнейшие действия

* [Работа с Azure Application Insights в Visual Studio](https://docs.microsoft.com/azure/application-insights/app-insights-visual-studio)

[performance-blade]: ./media/app-insights-profiler/performance-blade.png
[performance-blade-examples]: ./media/app-insights-profiler/performance-blade-examples.png
[trace-explorer]: ./media/app-insights-profiler/trace-explorer.png
[trace-explorer-toolbar]: ./media/app-insights-profiler/trace-explorer-toolbar.png
[trace-explorer-hint-tip]: ./media/app-insights-profiler/trace-explorer-hint-tip.png
[trace-explorer-hot-path]: ./media/app-insights-profiler/trace-explorer-hot-path.png

