---
title: "Профилирование динамических веб-приложений в Azure с помощью Application Insights Profiler | Документация Майкрософт"
description: "Определите критический путь в коде веб-сервера с помощью профилировщика небольшого размера."
services: application-insights
documentationcenter: 
author: mrbullwinkle
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.devlang: na
ms.topic: article
ms.date: 05/04/2017
ms.author: mbullwin
ms.openlocfilehash: e66dc2af18785c6c8e83815129c8bca5b877d25b
ms.sourcegitcommit: f8437edf5de144b40aed00af5c52a20e35d10ba1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/03/2017
---
# <a name="profile-live-azure-web-apps-with-application-insights"></a>Профилирование динамических веб-приложений Azure с помощью Application Insights

*Эта функция Application Insights общедоступна для службы приложений Azure и предоставляется в предварительной версии для вычислительных ресурсов Azure.*

Узнайте, сколько времени выполняется каждый метод в динамическом веб-приложении с помощью [Application Insights Profiler](app-insights-overview.md). Инструмент профилирования Application Insights отображает подробные данные профилей динамических запросов, обработанные приложением, а также выделяет *критический путь*, на использование которого уходит большая часть времени. Профилировщик автоматически выбирает примеры, которые имеют разное время отклика, а затем использует различные методы для минимизации затрат.

Сейчас он работает для веб-приложений ASP.NET, запущенных в службе приложений Azure, по крайней мере с ценовой категорией "Базовый".

## <a id="installation"></a> Включение профилировщика

[Установите Application Insights](app-insights-asp-net.md) в коде. Если эта среда уже установлена, убедитесь, что вы используете последнюю версию. Чтобы проверить наличие последней версии, в обозревателе решений щелкните правой кнопкой мыши свой проект и выберите **Управление пакетами NuGet** > **Обновления** > **Обновить все пакеты**. Затем разверните приложение заново.

*Используете ASP.NET Core? Ознакомьтесь с [дополнительными сведениями](#aspnetcore).*

На [портале Azure](https://portal.azure.com) откройте ресурс Application Insights для своего веб-приложения. Выберите **Производительность** > **Включить Application Insights Profiler**.

![Выбор баннера включения профилировщика][enable-profiler-banner]

Кроме того, можно выбрать **Настройка**, чтобы просмотреть состояние профилировщика, а также включить или отключить его.

![Выбор "Настройка" в разделе "Производительность"][performance-blade]

Веб-приложения, для которых настроено использование Application Insights, перечислены в разделе **Настройка**. Следуйте инструкциям, чтобы при необходимости установить агент профилировщика. Если у вас нет веб-приложений, для которых настроено использование Application Insights, выберите **Добавить связанные приложения**.

Чтобы управлять профилировщиком для всех связанных веб-приложений, выберите **Включить профилировщик** или **Отключить профилировщик** в колонке **Настройка**.

![Параметры колонки "Настройка"][linked app services]

В отличие от веб-приложений, размещенных при помощи планов службы приложений, приложения, размещенные в вычислительных ресурсах Azure (например, на виртуальных машинах Azure, в масштабируемых наборах виртуальных машин, Azure Service Fabric или облачных службах Azure), не управляются Azure напрямую. В этом случае нет связанных веб-приложений. Вместо привязки к приложению нажмите кнопку **Включить профилировщик**.

## <a name="disable-the-profiler"></a>Отключение профилировщика
Чтобы остановить или перезапустить профилировщик для отдельного экземпляра службы приложений, в области **Веб-задания** перейдите к ресурсу службы приложений. Чтобы удалить профилировщик, откройте **Расширения**.

![Отключение профилировщика для веб-заданий][disable-profiler-webjob]

Мы рекомендуем включить профилировщик для всех веб-приложений, чтобы обеспечить максимально быстрое обнаружение проблем производительности.

Если вы используете WebDeploy для развертывания изменений в веб-приложении, убедитесь, что папка App_Data не удалилась во время развертывания. В противном случае файлы с расширением профилировщика будут удалены при следующем развертывании веб-приложения в Azure.

### <a name="using-profiler-with-azure-vms-and-azure-compute-resources-preview"></a>Использование профилировщика с виртуальными машинами и вычислительными ресурсами Azure (предварительная версия)

После [включения Application Insights для службы приложений Azure в среде выполнения](app-insights-azure-web-apps.md#run-time-instrumentation-with-application-insights) Application Insights Profiler автоматически становится доступным. Если вы уже включили Application Insights для ресурса, то, возможно, вам следует выполнить обновление до последней версии с помощью мастера настройки.

Ознакомьтесь со сведениями о [предварительной версии профилировщика для вычислительных ресурсов Azure](https://go.microsoft.com/fwlink/?linkid=848155).


## <a name="limitations"></a>Ограничения

Срок хранения данных по умолчанию — пять дней. Максимальный объем ежедневно обрабатываемых данных — 10 ГБ.

За использование службы профилировщика плата не взимается. Для использования службы профилировщика веб-приложение должно быть размещено по крайней мере на уровне "Базовый" службы приложений.

## <a name="overhead-and-sampling-algorithm"></a>Дополнительная нагрузка и алгоритм выборки

Раз в час профилировщик запускается случайным образом на две минуты на каждой виртуальной машине, где размещено приложение, для сбора трассировок которого настроен профилировщик. При запуске профилировщик увеличивает нагрузку на ресурсы ЦП сервера на 5–15 %.
Чем больше серверов доступно для размещения приложения, тем меньше профилировщик влияет на общую производительность приложения. Причина этого состоит в том, что алгоритм выборки запускает профилировщик только на 5 % серверов в любой момент времени. Для обслуживания веб-запросов будет доступно больше серверов, которые возьмут на себя нагрузку серверов, выполняющих дополнительную рабочую нагрузку профилировщик.


## <a name="view-profiler-data"></a>Просмотр данных профилировщика

Перейдите к области **Производительность** и прокрутите вниз до списка операций.

![Столбец примеров в области "Производительность" Application Insights][performance-blade-examples]

Таблица операций содержит следующие столбцы:

* **Число**. Количество запросов в диапазоне времени области **Число**.
* **Медиана**. Стандартное время, требуемое приложению для ответа на запрос. Половина всех ответов была получена быстрее, чем это значение.
* **95-й процентиль**. 95 % ответов были получены быстрее, чем это значение. Если это значение существенно отличается от медианы, возможно, в приложении периодически возникают неполадки. (Или это можно объяснить с помощью такой конструктивной функции, как кэширование.)
* **Трассировки Profiler**. Значок указывает, что профилировщик получил трассировки стека для этой операции.

Нажмите кнопку **Просмотр**, чтобы открыть обозреватель трассировки. В обозревателе находится несколько примеров, записанных профилировщиком, которые классифицируются по времени ответа.

Если вы используете область **Preview Performance** (Производительность предварительной версии), перейдите в раздел **Take Actions** (Предпринять действия) страницы, чтобы просмотреть трассировку профилировщика. Нажмите кнопку **Трассировки Profiler**.

![Кнопка "Трассировка профилировщика" в области "Preview Performance" (Производительность предварительной версии) Application Insights][performance-blade-v2-examples]

Выберите пример, чтобы отобразить классификацию на уровне кода по времени, затраченному на выполнение запроса.

![Обозреватель трассировки Application Insights][trace-explorer]

Обозреватель трассировки отображает следующие сведения:

* **Показать критический путь** — открывает основной листовой узел или хотя бы что-то с ним связанное. В большинстве случаев этот узел размещается рядом с узким местом производительности.
* **Метка** — имя функции или события. В дереве отображается сочетание кода и возникающих событий (например, события SQL и HTTP). Основное событие предоставляет общую длительность запроса.
* **Истекло** — интервал времени между началом и завершением операции.
* **Когда** — время запуска функции или события по отношению к другим функциям.

## <a name="how-to-read-performance-data"></a>Чтение данных о производительности

Профилировщик службы Майкрософт использует метод выборки в сочетании с инструментированием для анализа производительности приложения. Во время подробной сборки профилировщик службы каждую миллисекунду проводит выборку указателя инструкций для всех ЦП компьютера. Каждый пример записывает полный стек вызовов выполняющегося потока. Он предоставляет подробные и полезные сведения об этом потоке на высоком и низком уровне абстракции. Профилировщик службы также собирает сведения о других событиях, включая события переключения контекста, библиотеки параллельных задач (TPL) и пула потоков, для отслеживания корреляции действий и причинно-следственных связей.

Стек вызовов, отображаемый в представлении временной шкалы, является результатом выборки и инструментирования. Так как каждый пример записывает полный стек вызовов потока, он содержит код из Microsoft .NET Framework, а также из других указанных вами платформ.

### <a id="jitnewobj"></a>Выделение объектов (clr!JIT\_New или clr!JIT\_Newarr1)
**clr!JIT\_New** и **clr!JIT\_Newarr1** — это вспомогательные функции в .NET Framework, выделяющие память из управляемой кучи. **clr!JIT\_New** вызывается при выделении объекта. **clr!JIT\_Newarr1** вызывается при выделении массива объектов. Обычно эти две функции выполняются очень быстро за относительно небольшое время. Если функции **clr!JIT\_New** или **clr!JIT\_Newarr1** занимают довольно много времени во временной шкале, это указывает на то, что код, возможно, выделяет несколько объектов и потребляет значительный объем памяти.

### <a id="theprestub"></a>Код загрузки (clr!ThePreStub)
**clr!ThePreStub** — это вспомогательная функция в .NET Framework, подготавливающая код к первому выполнению. Как правило, она включает в себя JIT-компиляцию (но не ограничивается ей). Для каждого метода C# **clr!ThePreStub** должна вызываться только один раз в течение всего времени существования процесса.

Если **clr!ThePreStub** требуется много времени для запроса, это значит, что запрос впервые выполняет метод. На загрузку этого метода требуется значительное время работы среды выполнения .NET Framework. Вы можете использовать процесс прогрева, выполняющий эту часть кода до предоставления к нему доступа пользователям, или запустить генератор образа в машинном коде (ngen.exe) в сборках.

### <a id="lockcontention"></a>Конфликт блокировки (clr!JITutil\_MonContention или clr!JITutil\_MonEnterWorker)
**clr!JITutil\_MonContention** или **clr!JITutil\_MonEnterWorker** указывает, что текущий поток ожидает снятия блокировки. Обычно это отображается при выполнении команды **LOCK** языка C# путем вызова метода **Monitor.Enter** или метода с атрибутом **MethodImplOptions.Synchronized**. Конфликт блокировки обычно происходит при получении блокировки потоком A, а также при попытке получить ту же блокировку потоком Б до ее снятия потоком A.

### <a id="ngencold"></a>Код загрузки ([COLD])
Если имя метода содержит **[COLD]**, например **mscorlib.ni![COLD]System.Reflection.CustomAttribute.IsDefined**, это значит, что в среде выполнения .NET Framework впервые выполняется код, оптимизация которого не осуществилась с помощью <a href="https://msdn.microsoft.com/library/e7k32f4k.aspx">профильной оптимизации</a>. Для каждого метода он должен отображаться только один раз в течение всего времени существования процесса.

Если коду загрузки требуется значительное время на запрос, это значит, что запрос впервые выполняет неоптимизированную часть метода. Вы можете использовать процесс прогрева, который выполняет эту часть кода до предоставления к нему доступа пользователям.

### <a id="httpclientsend"></a>Отправка HTTP-запроса
Методы, такие как **HttpClient.Send**, указывают на то, что код ожидает завершения HTTP-запроса.

### <a id="sqlcommand"></a>Операция с базой данных
Методы, такие как **SqlCommand.Execute**, указывают на то, что код ожидает завершения операции с базой данных.

### <a id="await"></a>Ожидание (AWAIT\_TIME)
**AWAIT\_TIME** указывает на то, что код ожидает завершения другой задачи. Обычно это осуществляется с помощью команды **AWAIT** языка C#. Когда код выполняет команду **AWAIT**, поток освобождает и возвращает элемент управления в пул потоков, а поток, блокирующийся при ожидании завершения **AWAIT**, отсутствует. Однако если рассуждать логически, то поток, который выполнил команду **AWAIT**, "заблокирован" и ожидает завершения операции. Команда **AWAIT\_TIME** указывает время блокировки в ожидании завершения задачи.

### <a id="block"></a>Время блокировки
**BLOCKED_TIME** указывает на то, что код ожидает, пока другой ресурс станет доступным. Например, он может ожидать объект синхронизации, или когда поток станет доступным, или когда завершится запрос.

### <a id="cpu"></a>Время ЦП
ЦП занят выполнением инструкций.

### <a id="disk"></a>Время работы диска
Приложение выполняет операции с диском.

### <a id="network"></a>Сетевое время
Приложение выполняет сетевые операции.

### <a id="when"></a>Столбец "Время"
Столбец **Когда** — это визуальное представление того, как со временем изменяются выборки INCLUSIVE, собранные для узла. Общий диапазон запроса состоит из 32 временных периодов. В них накапливаются включающие выборки для данного узла. Каждый период представляется в виде полосы. Высота полосы обозначает масштабированное значение. Для узлов, помеченных как **CPU_TIME** или **BLOCKED_TIME**, или когда существует очевидная связь с потреблением ресурсов (ЦП, диск, поток), в полосе представлено использование одного из этих ресурсов за определенный период времени. Для этих метрик можно получить значение, превышающее 100 %, за счет потребления нескольких ресурсов. Например, если в среднем за определенный интервал времени используется два процессора, то показатель достигнет 200 %.


## <a id="troubleshooting"></a>Устранение неполадок

### <a name="too-many-active-profiling-sessions"></a>Слишком много активных сеансов профилирования

Сейчас вы можете включить профилировщик не более, чем в четырех веб-приложениях Azure и слотах развертывания, работающих в рамках одного плана службы. Если веб-задание профилировщика содержит слишком много активных сеансов профилирования, то перенесите некоторые веб-приложения в другой план службы.

### <a name="how-do-i-determine-whether-application-insights-profiler-is-running"></a>Как определить, работает ли Application Insights Profiler?

Профилировщик запускается в качестве непрерывного веб-задания в веб-приложении. Вы можете открыть ресурс веб-приложения на [портале Azure](https://portal.azure.com). Проверьте состояние **ApplicationInsightsProfiler** в области **Веб-задания**. Если он не работает, откройте **Журналы**, чтобы просмотреть дополнительные сведения.

### <a name="why-cant-i-find-any-stack-examples-even-though-the-profiler-is-running"></a>Почему не удается найти все примеры стека даже при работе профилировщика?

Вот несколько моментов, которые можно проверить:

* Убедитесь, что вы используете план службы веб-приложений уровня "Базовый" или выше.
* Проверьте, содержит ли веб-приложение пакет SDK Application Insights бета-версии 2.2 или более поздней.
* Убедитесь, что веб-приложение содержит параметр **APPINSIGHTS_INSTRUMENTATIONKEY**, настроенный с тем же ключом инструментирования, который использует пакет SDK Application Insights.
* Проверьте, работает ли веб-приложение на платформе .NET Framework 4.6.
* Если ваше веб-приложение является приложением ASP.NET Core, то проверьте [необходимые зависимости](#aspnetcore).

После запуска профилировщика наблюдается короткий период прогрева, во время которого профилировщик активно собирает несколько трассировок производительности. Он выполняет это действие в течение двух минут каждый час.  

### <a name="i-was-using-azure-service-profiler-what-happened-to-it"></a>Я включил профилировщик службы Azure. Что с ним произошло?  

При включении Application Insights Profiler агент профилировщика службы Azure отключается.

### <a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем длительность запроса.

Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме. В таком случае общее время потока будет больше затраченного времени. Один поток может ожидать завершения другого. Средство просмотра пытается это обнаружить и исключить ненужное ожидание, но при этом вместо исключения возникает слишком много ошибок. Это могут быть критически важные сведения.  

Обнаружив параллельные потоки в трассировках, укажите, какие потоки находятся в состоянии ожидания, чтобы можно было определить критический путь к запросу. В большинстве случаев поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки. Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.

### <a id="issue-loading-trace-in-viewer"></a>Нет данных профилирования

Вот несколько моментов, которые можно проверить:

* Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку.
* Проверьте, не заблокирован ли доступ к https://gateway.azureserviceprofiler.net для прокси-серверов или брандмауэра.
* Убедитесь, что ключ инструментирования Application Insights, используемый в приложении, совпадает с ресурсом Application Insights, который вы использовали для включения профилирования. Обычно ключ находится в файле ApplicationInsights.config, но его также можно найти в файле web.config или app.config.

### <a name="error-report-in-the-profiling-viewer"></a>Отчет об ошибках в средстве просмотра профилирования

Отправьте запрос в службу поддержки на портале. Обязательно укажите идентификатор корреляции из сообщения об ошибке.

### <a name="deployment-error-directory-not-empty-dhomesitewwwrootappdatajobs"></a>Ошибка развертывания: каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"

При повторном развертывании веб-приложения в ресурсе служб приложений с включенным профилировщиком может возникнуть ошибка примерно следующего вида:

"Каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"".

Эта ошибка происходит при запуске веб-развертывания с помощью сценариев или в конвейере развертывания Visual Studio Team Services. Чтобы устранить эту проблему, необходимо добавить приведенные ниже параметры развертывания в задачу веб-развертывания.

```
-skip:Directory='.*\\App_Data\\jobs\\continuous\\ApplicationInsightsProfiler.*' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs\\continuous$' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs$'  -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data$'
```

Эти параметры удаляют папку, используемую Application Insights Profiler, и разблокируют процесс повторного развертывания. Текущий запущенный экземпляр профилировщика не будет затронут.


## <a name="manual-installation"></a>Ручная установка

При настройке профилировщика в параметры веб-приложения вносятся обновления. Обновления можно применить вручную, если этого требует ваша среда. Например, если приложение выполняется в среде службы приложений для PowerApps.

1. В области управления веб-приложением выберите **Параметры**.
2. Для **платформы .NET Framework** установите версию **4.6**.
3. Установите для параметра **Всегда включено** значение **Включено**.
4. Добавьте параметр приложения __APPINSIGHTS_INSTRUMENTATIONKEY__ и задайте для него значение с тем же ключом инструментирования, который используется пакетом SDK.
5. Откройте 	**Дополнительные инструменты**.
6. Выберите **Перейти**, чтобы открыть веб-сайт Kudu.
7. На веб-сайте Kudu выберите **Site extensions** (Расширения сайта).
8. Установите __Application Insights__ из коллекции веб-приложений Azure.
9. Перезапустите веб-приложение.

## <a id="aspnetcore"></a>Поддержка ASP.NET Core

Приложению ASP.NET Core необходимо установить пакет NuGet Microsoft.ApplicationInsights.AspNetCore версии 2.1.0-beta6 или более поздней версии для работы с профилировщиком. Начиная с 27 июня 2017 г. более ранние версии не поддерживаются.

## <a name="next-steps"></a>Дальнейшие действия

* [Работа с Azure Application Insights в Visual Studio](https://docs.microsoft.com/azure/application-insights/app-insights-visual-studio)

[performance-blade]: ./media/app-insights-profiler/performance-blade.png
[performance-blade-examples]: ./media/app-insights-profiler/performance-blade-examples.png
[performance-blade-v2-examples]:./media/app-insights-profiler/performance-blade-v2-examples.png
[trace-explorer]: ./media/app-insights-profiler/trace-explorer.png
[trace-explorer-toolbar]: ./media/app-insights-profiler/trace-explorer-toolbar.png
[trace-explorer-hint-tip]: ./media/app-insights-profiler/trace-explorer-hint-tip.png
[trace-explorer-hot-path]: ./media/app-insights-profiler/trace-explorer-hot-path.png
[enable-profiler-banner]: ./media/app-insights-profiler/enable-profiler-banner.png
[disable-profiler-webjob]: ./media/app-insights-profiler/disable-profiler-webjob.png
[linked app services]: ./media/app-insights-profiler/linked-app-services.png
