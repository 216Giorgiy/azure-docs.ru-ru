<properties 
	pageTitle="Анализ использования для веб-приложений с помощью Application Insights" 
	description="Общие сведения об аналитике использования для веб-приложений с помощью Application Insights" 
	services="application-insights" 
    documentationCenter=""
	authors="alancameronwills" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="06/12/2016" 
	ms.author="awills"/>
 
# Анализ использования для веб-приложений с помощью Application Insights

Знание особенностей работы пользователей с приложением позволяет сосредоточить разработку на сценариях, которые наиболее важны для пользователей, и выявить цели, которые кажутся им простыми или сложными для достижения.

Visual Studio Application Insights обеспечивает два уровня отслеживания использования:

* **Данные по числу пользователей, сеансов и просмотров страниц** предоставляются по умолчанию.
* **Пользовательская телеметрия** — вы [пишете код][api] для отслеживания пользователей посредством их взаимодействия с вашим приложением.

## Настройка

Откройте ресурс Application Insights на [портале Azure](https://portal.azure.com), щелкните пустую диаграмму загрузки страницы браузера и выполните инструкции.

[Подробнее](app-insights-javascript.md)


## Насколько популярно мое веб-приложение?

Войдите на [портал Azure][portal], найдите свой ресурс приложения и щелкните «Использование»:

![](./media/app-insights-web-track-usage/14-usage.png)

* **Пользователи** — количество уникальных активных пользователей за период времени.
* **Сеансы** — количество активных сеансов.
* **Количество просмотров страницы** — подсчитывается количество вызовов функции trackPageView(), которая обычно вызывается один раз на каждой веб-странице.

Щелкните любую диаграмму, чтобы увидеть более подробные данные. Обратите внимание, что диапазоны времени диаграмм можно менять.

### Где живут мои пользователи?

В колонке использования щелкните диаграмму «Пользователи», чтобы увидеть более подробные сведения.

![В колонке использования щелкните диаграмму пользователей.](./media/app-insights-web-track-usage/02-sessions.png)
 
### Какие операционные системы или браузеры они используют?

Группируйте (сегментируйте) данные по свойству, например обозревателю, операционной системе или городу:

![Выберите диаграмму, показывающую одну метрику, переключитесь на группировку и выберите какое-либо свойство](./media/app-insights-web-track-usage/03-browsers.png)


## Сеансы:

Сеанс является базовым понятием Application Insights, целью которого является сопоставление телеметрических событий — таких как запросы, просмотры страниц, исключения или настраиваемые событий, запрограммированные вами — с определенным сеансом пользователя.

О каждом сеансе собирается подробная контекстная информация, например, характеристики устройства, географическое положение, сведения об операционной системе и т. д.

При одновременном инструментировании клиента и сервера ([ASP.NET][greenbrown] или [J2EE][java]) пакеты SDK будут распространять идентификатор сеанса между клиентом и сервером для сопоставления событий с обеих сторон.

При [диагностировании проблем][diagnostic] можно найти все телеметрические события, связанные с сеансом, в рамках которого возникла проблема, в том числе все запросы и все зарегистрированные события, исключения или трассировки.

Сеансы предоставляют подробную информацию о частотности контекстов, таких как устройство, операционная система или местоположение. Например, отобразив количество сеансов, сгруппированных по устройствам, можно получить более точную информацию о том, как часто определенное устройство используется вместе с приложением, чем используя данные счетчика просмотров страницы. Эти входные данные будут полезны при рассмотрении любых проблем, связанных с конкретным устройством.


#### Что такое сеанс?

Сеанс представляет собой отдельный случай использования приложения пользователем. Простейший сеанс начинается с запуска приложения пользователем и завершается, когда пользователь прекращает работу с приложением. Для веб-приложений сеанс по умолчанию завершается через 30 минут бездействия или через 24 часа использования приложения.

Эти значения по умолчанию можно изменить, отредактировав фрагмент кода:

    <script type="text/javascript">
        var appInsights= ... { ... }({
            instrumentationKey: "...",
            sessionRenewalMs: 3600000,
            sessionExpirationMs: 172800000
        });

* `sessionRenewalMs` : Промежуток работы устройства в режиме ожидания (в миллисекундах), по истечении которого сеанс завершается. Значение по умолчанию — 30 минут.
* `sessionExpirationMs` Максимальная продолжительность сеанса, в миллисекундах. Если по истечении этого промежутка пользователь остается активным, регистрируется новая сессия. Значение по умолчанию — 24 часа.

**Длительность сеанса** — [метрика][metrics], представляющая собой промежуток времени между первым и последним телеметрическим событием сеанса. (Она не включает время ожидания.)

**Числом сеансов** за определенный промежуток времени называют количество уникальных сеансов, в рамках которых осуществлялись какие-либо действия. С точки зрения долговременных диапазонов, таких как число ежедневных сеансов за неделю, это число обычно эквивалентно общему количеству сеансов.

Однако при анализе более коротких временных диапазонов продолжительностью, скажем, один час, долговременный многочасовой сеанс будет учитываться каждый час его активности.

## Пользователи и число пользователей


Каждому сеансу пользователя присваивается уникальный идентификатор пользователя.

По умолчанию пользователь идентифицируется посредством размещения файла cookie. Пользователь, использующий несколько браузеров или устройств, будет учтен несколько раз. (Ознакомьтесь с исключениями в разделе [Прошедшие проверку пользователи](#authenticated-users).)


Метрикой **число пользователей** за определенный промежуток времени называют количество уникальных пользователей, со стороны которых была зарегистрирована активность в данный промежуток времени. Таким образом, при установке временного интервала с шагом в час и менее пользователи, осуществляющие долгие сеансы, могут быть учтены несколько раз.

Метрика**новые пользователи** показывает количество пользователей, которые начали свой первый сеанс работы в приложении в данный интервал времени. При учете пользователей с помощью файлов cookie (этот метод используется по умолчанию) пользователи, удалившие файлы cookie или использующие новое устройство или браузер для доступа к приложению, будут учитываться как новые. ![В колонке использования щелкните диаграмму пользователей, чтобы изучить новых пользователей.](./media/app-insights-web-track-usage/031-dual.png)

### Прошедшие проверку пользователи

Если в веб-приложение могут входить пользователи, вы можете настроить для Application Insights использование уникального идентификатора пользователя, чтобы знать их точное количество. Это не должно быть имя пользователя или его идентификатор, который уже используется в приложении. Как только приложение идентифицирует пользователя, введите следующий код:


*JavaScript на стороне клиента*

      appInsights.setAuthenticatedUserContext(userId);

Если приложение группирует пользователей по учетным записям, вы также можете передать идентификатор учетной записи.

      appInsights.setAuthenticatedUserContext(userId, accountId);

Идентификаторы пользователей и учетных записей не должны содержать пробелы и знаки `,;=|`.


В [обозревателе метрик](app-insights-metrics-explorer.md) можно создать диаграмму **прошедших проверку пользователей** и **учетных записей**.

## Синтезированный трафик

Синтезированный трафик включает запросы от нагрузочных тестов и тестов доступности, поисковых модулей и других агентов.

Application Insights старается автоматически определять и классифицировать синтезированный трафик, а также соответствующим образом помечать его. В большинстве случаев синтезированный трафик не вызывает пакетов SDK для JavaScript, чтобы данное действие исключалось из учета пользователей и сеансов.

Однако в [веб-тестах][availability] Application Insights идентификатор пользователя автоматически присваивается на основе расположения POP, а идентификатор сеанса присваивается на основе идентификатора тестового запуска. В отчетах по умолчанию синтезированный трафик фильтруется по умолчанию, при этом данные пользователи и сеансы будут исключаться. Тем не менее, включение синтезированного трафика может привести к незначительному увеличению общего числа пользователей и сеансов.
 
## Использование страницы

Щелкните диаграмму просмотров страниц, чтобы получить более детальные сведения вместе с анализом наиболее популярных страниц:


![В колонке обзора щелкните диаграмму "Просмотры страниц"](./media/app-insights-web-track-usage/05-games.png)
 
Приведенный выше пример взят с игрового веб-сайта. Из него можно сразу же увидеть следующее:

* Использование не увеличилось за прошлую неделю. Возможно, стоит задуматься о поисковой оптимизации?
* Гораздо меньше пользователей просматривают страницы игр, по сравнению с домашней страницей. Почему домашняя страница не привлекает людей играть в игры?
* "Кроссворд" является наиболее популярной игрой. Ему следует отдать приоритет в получении новых идей и улучшениях.

## Настраиваемое отслеживание

Предположим, что вместо создания отдельной страницы для каждой игры вы решили реорганизовать их все в одностраничное приложение, большинство функций которого реализовано с помощью кода JavaScript на веб-странице. Это позволяет пользователям быстро переключаться между играми или иметь несколько игр на одной странице.

Но вы все равно хотите, чтобы служба Application Insights протоколировала, сколько раз каждая игра была открыта, точно так же, как если бы игры находились на отдельных веб-страницах. Это несложно: просто вставьте вызов модуля телеметрии в код JavaScript в то место, где нужно сделать запись о том, что открыта новая "страница":

	appInsights.trackPageView(game.Name);

## Настраиваемые события

Записывайте пользовательскую телеметрию для регистрации определенных событий. Очевидно, вы захотите узнать (особенно в одностраничных приложениях), как часто пользователь выполняет определенные действия или достигает определенных целей:

    appInsights.trackEvent("GameEnd");

Например, зарегистрировать переходы по ссылке:

    <a href="target.htm" onclick="appInsights.trackEvent('linkClick');return true;">my link</a>


## Просмотр числа пользовательских событий

Откройте обозреватель метрик и добавьте диаграмму с отображением событий. Выберите сегментацию по имени:

![Выберите диаграмму, на которой отображается только одна метрика. Переключитесь на группировку. Выберите какое-либо свойство. Доступны не все свойства.](./media/app-insights-web-track-usage/06-eventsSegment.png)



## Детализация определенных событий

Чтобы лучше понимать, как проходит обычный сеанс, может потребоваться сосредоточиться на пользовательском сеансе, который содержит определенный тип события.

В этом примере создано настраиваемое событие NoGame, которое вызывается, если пользователь выходит из системы без фактического запуска игры. Почему пользователь так поступил? Возможно, если проанализировать некоторые повторяющиеся случаи, удастся выяснить причину.

Настраиваемые события, получаемые от приложения, перечислены по алфавиту в колонке "Обзор":


![В колонке "Обзор" выберите один из типов пользовательских событий.](./media/app-insights-web-track-usage/07-clickEvent.png)
 
Щелкните интересующее событие и выберите последний конкретный случай:


![В списке под сводной диаграммой выберите событие](./media/app-insights-web-track-usage/08-searchEvents.png)
 
Давайте рассмотрим все данные телеметрии для сеанса, в котором произошло конкретное событие "NoGame".


![Щелкните "Все данные телеметрии для сеанса"](./media/app-insights-web-track-usage/09-relatedTelemetry.png)
 
Исключений не возникало, поэтому пользователю не мешал играть какой-либо сбой.
 
Для этого сеанса мы можем отфильтровать все типы телеметрии, оставив просмотры страниц:


![](./media/app-insights-web-track-usage/10-filter.png)
 
И теперь видно, что этот пользователь вошел в систему просто для того, чтобы проверить последний счет игры. Возможно, нам следует учесть рассмотренную пользовательскую историю, упростив эти действия. (И мы можем создать настраиваемое событие, чтобы отслеживать возникновения этой конкретной истории.)

## Фильтрация, поиск и сегментация данных с помощью свойств
Событиям можно присваивать произвольные теги и числовые значения.
 

*JavaScript на стороне клиента*

```JavaScript

    appInsights.trackEvent("WinGame",
        // String properties:
        {Game: currentGame.name, Difficulty: currentGame.difficulty},
        // Numeric measurements:
        {Score: currentGame.score, Opponents: currentGame.opponentCount}
    );
```

*C# на стороне сервера*

```C#

    // Set up some properties:
    var properties = new Dictionary <string, string> 
        {{"game", currentGame.Name}, {"difficulty", currentGame.Difficulty}};
    var measurements = new Dictionary <string, double>
        {{"Score", currentGame.Score}, {"Opponents", currentGame.OpponentCount}};

    // Send the event:
    telemetry.TrackEvent("WinGame", properties, measurements);
```

*VB на стороне сервера*

```VB

    ' Set up some properties:
    Dim properties = New Dictionary (Of String, String)
    properties.Add("game", currentGame.Name)
    properties.Add("difficulty", currentGame.Difficulty)

    Dim measurements = New Dictionary (Of String, Double)
    measurements.Add("Score", currentGame.Score)
    measurements.Add("Opponents", currentGame.OpponentCount)

    ' Send the event:
    telemetry.TrackEvent("WinGame", properties, measurements)
```

Таким же образом прикрепите свойства к просмотрам страниц:

*JavaScript на стороне клиента*

```JS

    appInsights.trackPageView("Win", 
        url,
        {Game: currentGame.Name}, 
        {Score: currentGame.Score});
```

В колонке поиска по журналу диагностики можно просматривать свойства, щелкая отдельные вхождения события.


![В списке событий откройте событие и нажмите кнопку с многоточием "...", чтобы просмотреть дополнительные свойства](./media/app-insights-web-track-usage/11-details.png)
 
Используйте поле поиска для просмотра вхождений события с определенным значением свойства.


![Введите значение в поле поиска](./media/app-insights-web-track-usage/12-searchEvents.png)


## Тестирование A или B

Если неизвестно, какой вариант функции будет более эффективен, выпустите их оба, чтобы каждый из них был доступен для разных пользователей. Измерьте успешность каждого варианта, а затем перейдите к единой версии.

В рамках этого способа необходимо присвоить разные теги всем данным телеметрии, отправляемым каждой версией приложения. Для этого нужно определить свойства в активном контексте телеметрии TelemetryContext. Эти свойства по умолчанию добавляются к каждому сообщению телеметрии, которое отправляет приложение, — не только к настраиваемым сообщениям, но также к стандартным данным телеметрии.

Затем, чтобы сравнить различные версии, на портале Application Insights можно будет отфильтровать и сгруппировать (сегментировать) данные по тегам.

*C# на стороне сервера*

```C#

    using Microsoft.ApplicationInsights.DataContracts;

    var context = new TelemetryContext();
    context.Properties["Game"] = currentGame.Name;
    var telemetry = new TelemetryClient(context);
    // Now all telemetry will automatically be sent with the context property:
    telemetry.TrackEvent("WinGame");
```

*VB на стороне сервера*

```VB

    Dim context = New TelemetryContext
    context.Properties("Game") = currentGame.Name
    Dim telemetry = New TelemetryClient(context)
    ' Now all telemetry will automatically be sent with the context property:
    telemetry.TrackEvent("WinGame")
```

Некоторые данные телеметрии могут отличаться от значений по умолчанию.

Можно настроить универсальный инициализатор, чтобы все новые клиенты телеметрии TelemetryClient автоматически использовали ваш контекст.

```C#


    // Telemetry initializer class
    public class MyTelemetryInitializer : ITelemetryInitializer
    {
        public void Initialize (ITelemetry telemetry)
        {
            telemetry.Properties["AppVersion"] = "v2.1";
        }
    }
```

В инициализаторе приложения, например Global.asax.cs:

```C#

    protected void Application_Start()
    {
        // ...
        TelemetryConfiguration.Active.TelemetryInitializers
        .Add(new MyTelemetryInitializer());
    }
```


## Создание — измерение — обучение

При использовании аналитики она становится неотъемлемой частью цикла разработки, а не просто поводом поразмышлять над решением проблем. Ниже приведен ряд советов.

* Определите ключевые метрики своего приложения. Необходимо привлечь максимальное число пользователей или лучше немного пользователей, но зато довольных? Необходимо увеличить число посещений или объем продаж?
* Планируйте протоколирование каждой истории. Если создается новый компонент или пользовательская история или их необходимо обновить, всегда думайте о том, как определить успешность изменения. Прежде чем начинать писать код, задайте вопрос: "Как этот код повлияет на метрики, когда он будет работать? Следует ли отслеживать новые события?" И, конечно, когда компонент становится рабочим, обязательно просматривайте аналитику и действуйте исходя из результатов.
* Соотносите другие метрики с ключевой метрикой. Например, если вы добавили компонент «Избранное», следует узнать, как часто пользователи добавляют в «Избранное». Но, возможно, еще интереснее узнать, как часто они обращаются к своему избранному. И, самое главное, стали ли пользователи, использующие "Избранное", в конечном счете больше покупать?
* Осторожное тестирование. Настройте переключатель, позволяющий делать новый компонент видимым только некоторым пользователям. С помощью Application Insights узнайте, используется ли новый компонент так, как было предусмотрено. Внесите корректировки, а затем сделайте компонент доступным для более широкого круга пользователей.
* Общайтесь с пользователями! Самой по себе аналитики недостаточно, она дополняет поддержание хороших отношений с клиентами.


## Ссылки

* [Использование API. Обзор][api]
* [Справочник по JavaScript API](https://github.com/Microsoft/ApplicationInsights-JS/blob/master/API-reference.md)

## Видео

> [AZURE.VIDEO usage-monitoring-application-insights]


<!--Link references-->

[api]: app-insights-api-custom-events-metrics.md
[availability]: app-insights-monitor-web-app-availability.md
[client]: app-insights-javascript.md
[diagnostic]: app-insights-diagnostic-search.md
[greenbrown]: app-insights-asp-net.md
[java]: app-insights-java-get-started.md
[metrics]: app-insights-metrics-explorer.md
[portal]: http://portal.azure.com/
[windows]: app-insights-windows-get-started.md

 

<!---HONumber=AcomDC_0914_2016-->