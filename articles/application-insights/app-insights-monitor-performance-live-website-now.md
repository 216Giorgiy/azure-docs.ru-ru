<properties
	pageTitle="Диагностика проблем производительности на работающем веб-сайте IIS | Microsoft Azure"
	description="Мониторинг производительности веб-сайта без необходимости его повторного развертывания. Для получения телеметрии зависимостей используйте автономно или с пакетом SDK для Application Insights."
	services="application-insights"
    documentationCenter=".net"
	authors="alancameronwills"
	manager="douge"/>

<tags
	ms.service="application-insights"
	ms.workload="tbd"
	ms.tgt_pltfrm="ibiza"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="03/09/2016"
	ms.author="awills"/>


# Установка монитора состояний Application Insights для мониторинга производительности веб-сайта

*Доступна только предварительная версия Application Insights.*

C помощью монитора состояний Visual Studio Application Insights можно диагностировать исключения и проблемы производительности в приложениях ASP.NET.

![примеры диаграмм](./media/app-insights-monitor-performance-live-website-now/10-intro.png)

> [AZURE.TIP] Существуют отдельные статьи об инструментировании [динамических веб-приложений J2EE](app-insights-java-live.md) и [облачных служб Azure](app-insights-cloudservices.md).


Вы можете выбрать один из трех указанных ниже вариантов применения Application Insights для веб-приложений IIS.

* **Во время сборки.** [Добавьте пакет SDK для Application Insights][greenbrown] в код вашего веб-приложения и вы получите следующие преимущества:
 * Комплексная стандартная телеметрия диагностики и использования.
 * Благодаря [API Application Insights][api] вы можете написать собственную систему телеметрии для отслеживания подробных сведений об использовании или диагностики проблем.
* **Во время выполнения.** Используйте монитор состояний для инструментирования веб-приложения на сервере.
 * Мониторинг уже запущенных веб-приложений. При этом нет необходимости повторно их создавать или публиковать.
 * Комплексная стандартная телеметрия диагностики и использования.
 * Диагностика зависимостей. Получайте информацию об ошибках и низкой производительности приложения во время использования других компонентов, таких как базы данных, REST API или другие службы.
 * Устранение неполадок телеметрии.
* **Во время выполнения и во время сборки.** Выполните компиляцию пакета SDK в коде вашего веб-приложения и запустите монитор состояний на веб-сервере. Вы получаете следующие преимущества обоих способов:
 * Стандартная телеметрия диагностики и использования.
 * Диагностика зависимостей.
 * C помощью этого API вы можете написать пользовательскую систему телеметрии.
 * Устранение неполадок, связанных с пакетом SDK и телеметрией.


## Установка монитора состояний Application Insights

Вам потребуется подписка на [Microsoft Azure](http://azure.com).

### Если приложение выполняется на сервере IIS

1. Войдите на веб-сервер IIS с учетными данными администратора.
2. Скачайте и запустите [установщик монитора состояний](http://go.microsoft.com/fwlink/?LinkId=506648).
4. В мастере установки выполните вход в Microsoft Azure.

    ![Войдите в Azure с данными учетной записи Майкрософт.](./media/app-insights-monitor-performance-live-website-now/appinsights-035-signin.png)

    *Возникли ошибки подключения? См. раздел [Устранение неполадок](#troubleshooting).*

5. Выберите установленное веб-приложение или веб-сайт для мониторинга и настройте ресурс, где вы будете просматривать результаты на портале Application Insights.

    ![Выберите приложение и ресурс.](./media/app-insights-monitor-performance-live-website-now/appinsights-036-configAIC.png)

    Как правило, необходимо настроить новый ресурс и [группу ресурсов][roles].

    В противном случае используйте существующий ресурс, если для вашего сайта уже настроены [веб-тесты][availability] или [система мониторинга веб-клиентов][client].

6. Перезапустите IIS.

    ![Выберите "Перезапустить" в верхней части диалогового окна.](./media/app-insights-monitor-performance-live-website-now/appinsights-036-restart.png)

    Работа вашей веб-службы будет ненадолго прервана.

6. Обратите внимание, что в веб-приложения, для которых планируется мониторинг, вставлен файл ApplicationInsights.config.

    ![Найдите файл .config и файлы кода веб-приложения.](./media/app-insights-monitor-performance-live-website-now/appinsights-034-aiconfig.png)

   Также некоторые изменения вносятся в файл web.config.

#### Необходимо выполнить настройку позднее?

После завершения работы мастера можно в любое время выполнить повторную настройку агента. Это можно использовать и в том случае, если агент был установлен, но на начальном этапе возникли какие-либо проблемы.

![Нажатие значка Application Insights в панели задач](./media/app-insights-monitor-performance-live-website-now/appinsights-033-aicRunning.png)


### Если приложение выполняется в качестве веб-приложения Azure

На панели управления веб-приложения Azure добавьте расширение Application Insights.

![В веб-приложении последовательно выберите пункты "Настройки", "Расширения", "Добавить" и "Application Insights".](./media/app-insights-monitor-performance-live-website-now/05-extend.png)


### Если это проект облачной службы Azure

[Добавьте сценарии в веб-роли и рабочие роли](app-insights-cloudservices.md).


## Просмотр телеметрии производительности

Войдите на [портал Azure](https://portal.azure.com), перейдите в Application Insights и откройте созданный ресурс.

![Выберите "Обзор", Application Insights, а затем свое приложение.](./media/app-insights-monitor-performance-live-website-now/appinsights-08openApp.png)

Откройте колонку "Производительность", чтобы отобразить сведения о запросе, времени отклика, зависимости и другие данные.

![Производительность](./media/app-insights-monitor-performance-live-website-now/21-perf.png)

Щелкните, чтобы изменить отображаемые сведения или добавить новую диаграмму.


![](./media/app-insights-monitor-performance-live-website-now/appinsights-038-dependencies.png)

## Зависимости

На диаграмме длительности зависимостей отображается время, потраченное на выполнение вызовов вашего приложения к внешним компонентам, например базам данных, REST API или хранилищу больших двоичных объектов Azure.

Для сегментирования диаграммы по вызовам и различным зависимостям выберите необходимую диаграмму, включите функцию группирования, а затем выберите пункт "Зависимость", "Тип зависимости" или "Производительность зависимости".

Кроме того, можно отфильтровать диаграмму, чтобы отобразить определенный сегмент зависимости, типа или производительности. Щелкните "Фильтры".

## Счетчики производительности

(Не предназначено для веб-приложений Azure.) В колонке обзора щелкните "Серверы", чтобы отобразить диаграммы счетчиков производительности серверов, например счетчиков использования ресурсов ЦП и памяти.

Добавьте новую диаграмму или щелкните любую имеющуюся, чтобы изменить отображаемые ею значения.

Кроме того, вы можете [изменить набор счетчиков производительности, данные которых передает пакет SDK](app-insights-configuration-with-applicationinsights-config.md#nuget-package-3).

## Исключения

![Щелкните диаграмму исключений сервера.](./media/app-insights-monitor-performance-live-website-now/appinsights-039-1exceptions.png)

Вы можете подробно рассмотреть конкретные исключения (за последние семь дней) и получить данные трассировки стека и контекста.

## Выборка

Если ваше приложение выполняет отправку больших объемов данных, а вы используете Application Insights SDK для ASP.NET версии 2.0.0-beta3 или более поздней, функция адаптивной выборки может сработать и отправить только часть вашей телеметрии. [Дополнительная информация о выборке.](app-insights-sampling.md)


## Устранение неполадок

### Ошибки подключения

Чтобы монитор состояний мог работать, необходимо открыть некоторые исходящие порты в брандмауэре сервера:

+ Телеметрия — необходимы постоянно:
 +	`dc.services.visualstudio.com:80`
 +	`dc.services.visualstudio.com:443`
 +	`dc.applicationinsights.microsoft.com`
+ Конфигурация — необходимы только для внесения изменений:
 -	`management.core.windows.net:443`
 -	`management.azure.com:443`
 -	`login.windows.net:443`
 -	`login.microsoftonline.com:443`
 -	`secure.aadcdn.microsoftonline-p.com:443`
 -	`auth.gfx.ms:443`
 -	`login.live.com:443`
+ Установка:
 +	`packages.nuget.org:443`

Время от времени этот список может меняться.

### Отсутствие данных телеметрии

  * С помощью своего сайта создайте данные.
  * Подождите несколько минут, пока поступят данные, а затем щелкните **Обновить**.
  * Чтобы просмотреть отдельные события, откройте поиск по журналу диагностики, щелкнув плитку "Поиск". События часто отображаются в поле поиска по журналу диагностики перед появлением статистических данных на диаграммах.
  * Откройте монитор состояний и на левой панели выберите свое приложение. Проверьте, не появились ли в разделе "Уведомления о конфигурации» сообщения с диагностическими сведениями для этого приложения:

  ![](./media/app-insights-monitor-performance-live-website-now/appinsights-status-monitor-diagnostics-message.png)

  * Убедитесь, что брандмауэр сервера пропускает исходящий трафик через перечисленные выше порты.
  * Если на сервере отображается сообщение "Недостаточно разрешений", выполните следующее:
    * В диспетчере IIS выберите ваш пул приложений, откройте **Дополнительные параметры** и в разделе **Модель процесса** скопируйте значение параметра "Идентификация".
    * На панели управления компьютера добавьте это значение к группе пользователей монитора производительности.
  * Если на вашем сервере установлен MMA/SCOM, некоторые версии могут конфликтовать. Удалите SCOM и монитор состояний и повторно установите последние версии.
  * См. раздел [Устранение неполадок][qna].

## Требования к системе

Операционные системы, которые поддерживаются для монитора состояний Application Insights на сервере:

- Windows Server 2008
- Windows Server 2008 R2
- Windows Server 2012
- Windows Server 2012 R2.

На них должны быть установлены последний пакет обновления и платформа .NET Framework 4.0 и 4.5.

На клиентских компьютерах должна быть установлена ОС Windows 7, 8 или 8.1 с платформой .NET Framework 4.0 и 4.5.

Поддерживаются такие версии IIS: 7, 7.5, 8, 8.5 (IIS – обязательный компонент).

## Автоматизация с помощью PowerShell

Мониторинг можно запускать и останавливать с помощью PowerShell.

`Get-ApplicationInsightsMonitoringStatus [-Name appName]`

* `-Name` (необязательный параметр) — имя веб-приложения.
* Отображает состояние мониторинга Application Insights для каждого веб-приложения (или именованного приложения) на этом сервере IIS.

* Возвращает `ApplicationInsightsApplication` для каждого приложения:
 * `SdkState==EnabledAfterDeployment`: приложение отслеживается. Оно инструментировано во время выполнения с помощью монитора состояния или командлета `Start-ApplicationInsightsMonitoring`.
 * `SdkState==Disabled`: приложение не инструментировано для Application Insights. Оно либо никогда не было инструментировано, либо мониторинг был отключен во время выполнения с помощью монитора состояния или командлета `Stop-ApplicationInsightsMonitoring`.
 * `SdkState==EnabledByCodeInstrumentation`: приложение инструментировано путем добавления пакета SDK в исходный код. Этот пакет SDK нельзя обновить или остановить.
 * `SdkVersion` отображает версию, которая используется для мониторинга этого приложения.
 * `LatestAvailableSdkVersion` отображает версию, доступную сейчас в коллекции NuGet. Чтобы обновить приложение до этой версии, используйте командлет `Update-ApplicationInsightsMonitoring`.

`Start-ApplicationInsightsMonitoring -Name appName -InstrumentationKey 00000000-000-000-000-0000000`

* `-Name` — имя приложения в IIS.
* `-InstrumentationKey` — ключ инструментирования ресурса Application Insights, в котором должны отображаться результаты.

* Этот командлет влияет только на приложения, которые еще не инструментированы, то есть SdkState==NotInstrumented.

    Командлет не влияет на приложение, которое уже было инструментировано путем добавления пакета SDK в код во время сборки или с использованием этого же командлета ранее во время выполнения.

    Версия пакета SDK для инструментирования приложения — это последняя версия, загруженная на этот сервер.

    Чтобы загрузить последнюю версию, используйте командлет Update-ApplicationInsightsVersion.

* В случае успешного выполнения возвращает `ApplicationInsightsApplication`. В случае сбоя трассировка записывается в stderr.

    
          Name                      : Default Web Site/WebApp1
          InstrumentationKey        : 00000000-0000-0000-0000-000000000000
          ProfilerState             : ApplicationInsights
          SdkState                  : EnabledAfterDeployment
          SdkVersion                : 1.2.1
          LatestAvailableSdkVersion : 1.2.3

`Stop-ApplicationInsightsMonitoring [-Name appName | -All]`

* `-Name` — имя приложения в IIS.
* `-All` останавливает мониторинг всех приложений на этом сервере IIS, для которых `SdkState==EnabledAfterDeployment`.

* Останавливает мониторинг для указанных приложений и удаляет инструментирование. Это применимо только для приложений, инструментированных во время выполнения с помощью монитора состояния или командлета Start-ApplicationInsightsApplication. (`SdkState==EnabledAfterDeployment`)

* Возвращает ApplicationInsightsApplication.

`Update-ApplicationInsightsMonitoring -Name appName [-InstrumentationKey "0000000-0000-000-000-0000"`]

* `-Name` — имя веб-приложения в IIS.
* `-InstrumentationKey` (необязательный параметр). используется для изменения ресурса, в который отправляются данные телеметрии приложения.
* Этот командлет:
 * Обновляет именованное приложение до последней версии пакета SDK, загруженной на этот компьютер (работает, только если `SdkState==EnabledAfterDeployment`).
 * Если указан ключ инструментирования, именованное приложение повторно настраивается для отправки данных телеметрии в ресурс с этим ключом (работает, если `SdkState != Disabled`).

`Update-ApplicationInsightsVersion`

* Загружает последний пакет SDK для Application Insights на сервер.

## Шаблон Azure

Если веб-приложение работает в Azure и вы создаете ресурсы с помощью шаблона Azure Resource Manager, можно настроить Application Insights, добавив следующий код в узел ресурсов:

    {
      resources: [
        /* Create Application Insights resource */
        {
          "apiVersion": "2015-05-01",
          "type": "microsoft.insights/components",
          "name": "nameOfAIAppResource",
          "location": "centralus",
          "kind": "web",
          "properties": { "ApplicationId": "nameOfAIAppResource" },
          "dependsOn": [
            "[concat('Microsoft.Web/sites/', myWebAppName)]"
          ]
        }
       ]
     } 

* `nameOfAIAppResource` — имя ресурса Application Insights.
* `myWebAppName` — идентификатор веб-приложения.

## <a name="next"></a>Дальнейшие действия

* [Создайте веб-тесты][availability], чтобы убедиться, что ваш сайт продолжает работать.
* [Поиск событий и журналов][diagnostic] для диагностики неполадок.
* [Добавьте телеметрию веб-клиента][usage], чтобы просматривать исключения в коде веб-страницы и вставлять вызовы трассировки.
* [Добавьте пакет SDK для Application Insights в код веб-службы][greenbrown], чтобы иметь возможность вставлять вызовы трассировки и журналов в серверный код.

## Видео

#### Мониторинг производительности

[AZURE.VIDEO app-insights-performance-monitoring]

<!--Link references-->

[api]: app-insights-api-custom-events-metrics.md
[availability]: app-insights-monitor-web-app-availability.md
[client]: app-insights-javascript.md
[diagnostic]: app-insights-diagnostic-search.md
[greenbrown]: app-insights-asp-net.md
[qna]: app-insights-troubleshoot-faq.md
[roles]: app-insights-resources-roles-access-control.md
[usage]: app-insights-web-track-usage.md

<!---HONumber=AcomDC_0420_2016-->