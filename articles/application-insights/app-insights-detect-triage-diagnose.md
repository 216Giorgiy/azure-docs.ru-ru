<properties
	pageTitle="Обнаружение, рассмотрение, диагностика"
	description="Анализируйте сбои, отслеживайте и устраняйте проблемы производительности в приложениях"
	authors="alancameronwills"
	services="application-insights"
    documentationCenter=""
	manager="douge"/>

<tags
	ms.service="application-insights"
	ms.workload="tbd"
	ms.tgt_pltfrm="ibiza"
	ms.devlang="na"
	ms.topic="article" 
	ms.date="11/06/2015"
	ms.author="awills"/>

# Обнаружение, рассмотрение и диагностика с помощью Application Insights

*Доступна только предварительная версия Application Insights.*


Application Insights помогает получить сведения о производительности и использовании динамического приложения. А в случае возникновения проблемы эта служба уведомляет вас о ней, помогает оценить влияние и определить причину.

Прочитайте отзыв рабочей группы, разрабатывающей веб-приложения:

* *"Несколько дней назад мы развернули минимальное исправление. Мы не проводили широкое тестирование, но, к сожалению, возникли неожиданные изменения в полезных данных, что привело к несовместимости между внешним и внутренним интерфейсами. Сразу же возросло число исключений сервера и сработало оповещение, которое и уведомило нас о ситуации. В несколько щелчков на портале Application Insights мы получили достаточно информации из стека вызовов исключений, чтобы сузить круг причины проблемы. Мы сразу же выполнили откат и тем самым сократили ущерб. Благодаря Application Insights эта часть цикла разработки стала очень простой и реально выполнимой".*

Давайте посмотрим, как обычная команда веб-разработчиков использует Application Insights для отслеживания производительности. Мы будем наблюдать за действиями команды, разрабатывающей систему онлайн-банкинга в банке Fabrikam.

![Типовой веб-сайт банка](./media/app-insights-detect-triage-diagnose/03-bank.png)

Цикл работы команды примерно следующий.

![Цикл разработки и операций](./media/app-insights-detect-triage-diagnose/00-devcycle.png)

Требования поступают в невыполненную работу по разработке (список задач). Команда работает в коротких спринтах, результатом которых, как правило, является работающее программное обеспечение — обычно в виде улучшений и расширений для существующего приложения. В динамическое приложение часто добавляются новые функции. Поскольку приложение динамическое, команда отслеживает его производительность и использование с помощью Application Insights. Результаты этого анализа поступают в невыполненную работу по разработке.

Команда использует Application Insights для тщательного наблюдения за динамическим веб-приложением. * Производительность. Им нужна информация о том, как время отклика зависит от количества запросов; какой объем ресурсов ЦП, сети, диска и т. д. используется; и где возникают узкие места. * Сбои. При возникновении исключений или запросов, завершившихся ошибкой, или если счетчик производительности выходит за пределы обычных значений, группе необходимо быстро получать сведения о сбоях, чтобы принять меры. * Использование. Каждый раз, когда выпускается новая функция, команде нужно знать, часто ли она используется и не возникают ли у пользователей проблемы при работе с ней.



Рассмотрим часть цикла, связанную с отзывами.

![Обнаружение — рассмотрение — диагностика](./media/app-insights-detect-triage-diagnose/01-pipe1.png)



## Обнаружение низкой доступности


Анастасия Лебедева — специалист по тестированию в команде онлайн-банкинга. Она также отвечает за мониторинг производительности сети. Маргарита настраивает несколько [веб-тестов][availability]\:

* Тест с одним URL-адресом для основной целевой страницы приложения — http://fabrikambank.com/onlinebanking/. Она задает в качестве условия получение кода состояния HTTP 200 и текста "Добро пожаловать!". Если данный тест завершается ошибкой, это говорит о серьезном сбое в работе сети или серверов или же о проблемах с развертыванием. (Возможно, кто-то изменил сообщение "Добро пожаловать" на странице и не поставил Анастасию в известность.)


* Глубокий многоэтапный тест, во время которого выполняется вход в систему и создается список текущих учетных записей, а также проверяется несколько ключевых пунктов на каждой странице. Этот тест позволяет проверить, работает ли ссылка на базу учетных записей. Анастасия использует идентификатор вымышленного пользователя: несколько таких пользователей создано специально для тестирования.


Благодаря этим тестам она уверена, что команда сможет быстро узнать о любом сбое в системе.


Ошибки отображаются красными точками на диаграмме веб-теста:

![Отображение веб-тестов, выполненных за предыдущий период](./media/app-insights-detect-triage-diagnose/04-webtests.png)


Но еще важнее другое: команда разработчиков будет получать тревожное оповещение о любом сбое по электронной почте. Таким образом, специалисты узнают о проблеме раньше почти всех клиентов.


## Мониторинг метрик производительности


На странице "Обзор" Application Insights есть диаграмма, отображающая ряд [ключевых показателей][perf].

![Различные метрики](./media/app-insights-detect-triage-diagnose/05-perfMetrics.png)

Время загрузки страницы в браузере определяется на основе телеметрических данных, отправляемых непосредственно с веб-страниц. Данные о времени отклика сервера, числе запросов к серверу и числе неудачных запросов фиксируются на веб-сервере, а затем передаются в Application Insights.


Число неудачно завершенных запросов показывает случаи, когда ошибка была видна пользователям — обычно такое случается из-за исключений в коде. Возможно, пользователи увидят сообщение "К сожалению, сейчас невозможно обновить ваши данные" или, в худшем случае, по вине веб-сервера на экране отобразится дамп стека.


Анастасия любит время от времени смотреть на эти диаграммы. Отсутствие неудачных запросов вселяет уверенность, но при изменении временного охвата диаграммы на всю прошедшую неделю можно заметить некоторые ошибки. Это допустимый уровень для загруженного сервера. Однако о внезапном скачке числа сбоев или ухудшении таких показателей, как время отклика сервера, Анастасии нужно узнавать немедленно. Это может свидетельствовать о непредвиденной проблеме, вызванной выпуском кода, или сбоем в зависимости, к примеру, в базе данных, или же внезапной реакцией на высокое число запросов.

#### Оповещения

Поэтому она задает два [оповещения][metrics]\: одно для времени отклика, превышающего обычное пороговое значение, а другое — для количества неудачно завершенных запросов, превосходящего текущий уровень.


Наряду с оповещением о доступности эти два оповещения позволяют Анастасии быть уверенной в том, что она моментально узнает о любой возникшей неисправности.


Можно также настроить оповещения для множества других метрик. Например, получать уведомление по электронной почте в случае увеличения числа исключений, нехватки памяти или при пиковых значениях числа клиентских запросов.



![Добавление колонки оповещений](./media/app-insights-detect-triage-diagnose/07-alerts.png)




## Определение исключений


После несложной настройки уведомления об [исключениях](app-insights-asp-net-exceptions.md) поступают в Application Insights автоматически. Они также могут быть захвачены напрямую путем вставки в код вызовов [TrackException()](app-insights-api-custom-events-metrics.md#track-exception):

    var telemetry = new TelemetryClient();
    ...
    try
    { ...
    }
    catch (Exception ex)
    {
       // Set up some properties:
       var properties = new Dictionary <string, string>
         {{"Game", currentGame.Name}};

       var measurements = new Dictionary <string, double>
         {{"Users", currentGame.Users.Count}};

       // Send the exception telemetry:
       telemetry.TrackException(ex, properties, measurements);
    }


В команде Банка Fabrikam сложилась практика всегда отправлять телеметрические данные об исключении, если отсутствует очевидный способ восстановления.

В реальности их стратегия даже шире: данные телеметрии отправляются во всех случаях, когда клиент не удовлетворен результатом операции, которую он выполнял в онлайн-банке, — и неважно, имеет это отношение к исключению в коде или нет. Например, если сторонняя система межбанковских переводов отображает сообщение "невозможно выполнить данную операцию" по какой-то внутренней причине (не по вине клиента), команда отслеживает это событие.

    var successCode = AttemptTransfer(transferAmount, ...);
    if (successCode < 0)
    {
       var properties = new Dictionary <string, string>
            {{ "Code", returnCode, ... }};
       var measurements = new Dictionary <string, double>
         {{"Value", transferAmount}};
       telemetry.TrackEvent("transfer failed", properties, measurements);
    }

TrackException служит для сообщения об исключениях путем отправки копии стека, а также для информирования о других событиях. Можно прикреплять любые свойства, которые могут пригодиться при диагностике.

Исключения и события отображаются в колонке [Поиск по журналу диагностики][diagnostic]. Можно также проанализировать исключения, просмотрев дополнительные свойства и трассировку стека.

![В колонке "Поиске по журналам диагностики" можно использовать фильтры для отображения определенных типов данных](./media/app-insights-detect-triage-diagnose/appinsights-333facets.png)

## Отслеживание активности пользователей

Если показатель времени отклика сервера на неизменно хорошем уровне с немногими исключениями, разработчикам стоит задуматься об удобстве использования службы и о том, как поспособствовать большему числу пользователей достичь желаемой цели.


Например, многие пользователи просматривают сайт по принципу воронки продаж: почти все клиенты смотрят на различные способы кредитования, лишь некоторые из них заполняют форму запроса стоимости, а из заполнивших только часть идет дальше и получает кредит.

![](./media/app-insights-detect-triage-diagnose/12-funnel.png)

Выявляя, на каких из этапов просмотра сайта теряется больше всего клиентов, предприятие способно добиться увеличения количества пользователей, прошедших к концу воронки продаж. Возможные проблемы могут быть связаны с интерфейсом, например с плохой видимостью кнопки перехода далее или непонятностью инструкций. Однако более вероятно, что существуют более серьезные деловые причины потерь: процентная ставка может быть слишком высока.

Независимо от причины, получаемые данные позволяют команде разобраться, чем интересуются пользователи. Для детализации общей картины можно отслеживать больше действий. С помощью TrackEvent() можно отслеживать любые действия пользователя, от малейших подробностей индивидуальных нажатий до таких значительных достижений, как погашение кредитов.

Таким образом команда привыкает к доступности информации о действиях пользователей. Теперь при разработке любой новой функции предусматривается процесс получения отзывов о ее использовании. Вставка функций вызова отслеживания закладывается в проект изначально. Обратная связь используется для улучшения программного продукта на каждом из циклов разработки.


## Упреждающий мониторинг  


Анастасия не просто сидит на месте в ожидании тревожных оповещений. Вскоре после каждого повторного развертывания она просматривает [время отклика][perf] — как общее значение, так и таблицу с самыми медленными запросами, а также количество исключений.



![Диаграмма и сетка значений времени отклика сервера.](./media/app-insights-detect-triage-diagnose/09-dependencies.png)

Она может оценить изменение производительности после каждого развертывания, сравнивая результаты с данными за предыдущую неделю. При резком ухудшении показателей она сообщает о проблеме разработчикам.


## Рассмотрение


Рассмотрение — оценка важности и глубины проблемы — является первым шагом после обнаружения. Стоит ли собирать команду посреди ночи? Или можно поместить проблему в список невыполненных задач и решить ее при первой удобной возможности? Процесс рассмотрения предполагает ответы на некоторые ключевые вопросы.


Каков масштаб проблемы? Диаграммы в колонке "Общая информация" позволяют достаточно глубоко оценить ситуацию. Например, за ночь приложение Fabrikam создало четыре тревожных оповещения, связанных с веб-тестами. Утром, взглянув на диаграмму, сотрудники увидели на ней соответствующие красные точки, при этом большая часть тестов была выполнена успешно, о чем свидетельствовали точки зеленого цвета. При детальном изучении диаграммы стало ясно, что все эти временные проблемы связаны с одним тестом. Очевидно, возникшая в сети проблема затронула только один маршрут, после чего самоустранилась.


В то же время значительный и непрерывный рост на диаграмме исключений или времени отклика явно свидетельствует о серьезной проблеме.


Полезная тактика — выполнять рассмотрение самостоятельно. Потому что при повторном возникновении этой проблемы вы будете знать, что нужно делать.


Какая часть пользователей пострадала от проблемы? Чтобы получить приблизительный ответ, разделите число сбоев на число сеансов.


![Диаграммы неудачно завершенных запросов и сеансов](./media/app-insights-detect-triage-diagnose/10-failureRate.png)

В случае медленного отклика сравните таблицу самых медленных запросов с частотой использования каждой страницы.


Насколько важен заблокированный сценарий? Это функциональная проблема блокирует только одну конкретную пользовательскую историю? Насколько она серьезна? Если клиенты не могут оплачивать свои счета, это серьезно; если не получается изменить настройки цвета экрана — возможно, это может подождать. Подробные сведения о событии, исключении или идентификация медленной страницы подскажет вам, в каком месте пользователи сталкиваются с проблемой.


## Диагностика


Диагностика — это не совсем то же самое, что и отладка. Прежде чем приступить к отслеживанию через код, необходимо иметь примерное представление о причинах, месте и времени возникновения проблемы.


**Когда это происходит?** Просмотр журналов событий и диаграмм с метриками упрощает соотнесение последствий с возможными причинами. В случае периодического увеличения времени отклика или числа исключений взгляните на счетчик запросов: если пиковые значения достигаются в одно и то же время, это говорит о проблеме с ресурсами. Необходимо выделить дополнительные ЦП или память? Или это зависимость, которая не может справиться с нагрузкой?


**Или причина в нас?** При внезапном падении производительности отдельного типа запросов — например, получение клиентом выписки по счету — проблема с большей вероятностью будет заключаться во внешней подсистеме, а не в вашем веб-приложении. В обозревателе метрик выберите показатели "Сбой зависимости" и "Длительность зависимости", после чего сравните их журналы за последние несколько часов или дней с момента возникновения проблемы. Если присутствуют взаимообусловленные изменения, причиной сбоя может являться внешняя подсистема.


![Диаграммы сбоя зависимостей и длительности вызовов зависимостей](./media/app-insights-detect-triage-diagnose/11-dependencies.png)

Иногда проблемы с медленными зависимостями возникают вследствие недоработок, связанных с географическим расположением. В Банке Fabrikam используются виртуальные машины Azure, и однажды обнаружилось, что банк непреднамеренно разместил свой веб-сервер и сервер учетных записей в разных странах. Перенос одного из них позволил добиться резкого улучшения в работе.


**Что мы сделали?** Если проблема не в зависимости и если она не проявлялась ранее, то, возможно, причиной является последнее изменение. Благодаря наличию исторической справки в диаграммах показателей и событий можно легко соотносить внезапные изменения с развертываниями. Это значительно сужает круг поиска причины проблемы.


**В чем причина?** Некоторые ошибки возникают крайне редко и их сложно отследить при тестировании в автономном режиме. Все, что можно сделать в таком случае, — попытаться записать ошибку при ее возникновении в реальном времени. Можно проверить дампы стека в отчетах об исключениях. Кроме того, можно написать трассировочные вызовы с использованием привычной платформы ведения журналов либо задействовать TrackTrace() или TrackEvent().


В Банке Fabrikam периодически возникала проблема с переводами между учетными записями, при этом были затронуты только записи определенного типа. Чтобы лучше разобраться в происходящем, они вставили вызовы TrackTrace() в ключевые точки кода, добавив тип учетной записи в виде свойства к каждому вызову. Это позволило легко отсортировать нужные трассировки в колонке "Поиск по журналу диагностики". Они также присоединили значения параметров в виде свойств и измерений к трассировочным вызовам.


## Устранение проблемы


Как только проблема диагностирована, нужно составить план по ее исправлению. Возможно, потребуется выполнить откат последнего изменения или же устранить ошибку обычным образом. После исправления проблемы служба Application Insights сообщит об успешном результате.


Благодаря применению Application Insights команда разработчиков Банка Fabrikam выработала более структурированный подход к измерению производительности.

* На странице общей информации Application Insights они задали целевые значения производительности по отдельным показателям.

* В приложение были встроены показатели производительности, работающие уже с момента запуска. Среди них — показатели, отслеживающие продвижение пользователей через воронки продаж сайта.




## Использование

Служба Application Insights также собирает информацию о том, как пользователи используют приложение. Если оно работает без сбоев, разработчикам важно знать, какие из функций наиболее популярны, с чем у пользователей возникают сложности и как часто они возвращаются к приложению. Это позволяет правильно расставить приоритеты для предстоящей работы. Также можно запланировать измерение эффективности каждой функции в качестве отдельной части цикла разработки. [Подробная информация][usage].

## Ваши приложения

Вот как одна команда использует службу Application Insights не только для устранения отдельных проблем, но и для улучшения жизненного цикла разработки в целом. Надеюсь, вы получили некоторые соображения относительно того, как Application Insights может помочь в повышении производительности вашего приложения.

## Видео

[AZURE.VIDEO performance-monitoring-application-insights]

<!--Link references-->

[api]: app-insights-api-custom-events-metrics.md
[availability]: app-insights-monitor-web-app-availability.md
[diagnostic]: app-insights-diagnostic-search.md
[metrics]: app-insights-metrics-explorer.md
[perf]: app-insights-web-monitor-performance.md
[usage]: app-insights-web-track-usage.md
 

<!---HONumber=Nov15_HO3-->