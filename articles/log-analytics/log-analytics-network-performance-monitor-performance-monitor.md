---
title: "Функция мониторинга производительности в решении \"Монитор производительности сети\" в службе Azure Log Analytics | Документация Майкрософт"
description: "Возможность мониторинга производительности в Мониторе производительности сети помогает отслеживать подключения между разными точками в сети, например облачными развертываниями и локальными расположениями, несколькими центрами обработки данных и филиалами, критически важными многоуровневыми приложениями и микрослужбами."
services: log-analytics
documentationcenter: 
author: abshamsft
manager: carmonm
editor: 
ms.assetid: 5b9c9c83-3435-488c-b4f6-7653003ae18a
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/20/2018
ms.author: abshamsft
ms.openlocfilehash: a90ab3bc857b704d9d94daf96d17611844abb1a6
ms.sourcegitcommit: 12fa5f8018d4f34077d5bab323ce7c919e51ce47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2018
---
# <a name="network-performance-monitor-solution---performance-monitoring"></a>Решение "Монитор производительности сети": производительность сети

Возможность мониторинга производительности в [Мониторе производительности сети](log-analytics-network-performance-monitor.md) помогает отслеживать подключения между разными точками в сети, например облачными развертываниями и локальными расположениями, несколькими центрами обработки данных и филиалами, критически важными многоуровневыми приложениями и микрослужбами. С помощью мониторинга производительности можно выявить проблемы в сети перед тем, как пользователи начнут на них жаловаться. Ключевыми преимуществами являются: 

- отслеживание потерь и задержек в различных подсетях и настройка оповещений; 
- отслеживать все пути (включая избыточные) в сети; 
- устранение временных неполадок в сети и неполадок в сети до точки во времени, которые усложняют репликацию; 
- определение конкретного сегмента в сети, с которым связана низкая производительность; 
- отслеживание работоспособности сети без необходимости использования SNMP. 


![Монитор производительности сети](media/log-analytics-network-performance-monitor/npm-performance-monitor.png)

## <a name="configuration"></a>Параметр Configuration
Чтобы открыть конфигурацию Монитора производительности сети, откройте решение [Монитор производительности сети](log-analytics-network-performance-monitor.md) и нажмите кнопку **Настройка**.

![Настройка Монитора производительности сети](media/log-analytics-network-performance-monitor/npm-configure-button.png)

### <a name="create-new-networks"></a>Создание сетей

В NPM сеть — это логический контейнер для подсетей. Он позволяет организовать мониторинг инфраструктуры сети с учетом ваших потребностей. Вы можете создать сеть с понятным именем и добавить в нее подсети в соответствии с бизнес-логикой. Например, можно создать сеть London и добавить в нее все подсети, размещенные в лондонском центре обработки данных, или создать сеть *ContosoFrontEnd* и добавить в нее все подсети, обслуживающие внешний интерфейс приложения Contoso. Решение автоматически создает сеть по умолчанию, в которой содержатся все подсети, обнаруженные в вашей среде. При создании сети добавьте в нее подсеть, и эта подсеть удалится из сети "По умолчанию". Если удалить сеть, все подсети автоматически возвратятся в сеть "По умолчанию". Иными словами, сеть Default является контейнером для всех подсетей, которые не содержатся в какой-либо сети, определяемой пользователем. Сеть "По умолчанию" нельзя изменить или удалить. Она всегда остается в системе. Тем не менее вы можете создать любое количество настраиваемых сетей. В большинстве случаев подсети в вашей организации расположены в нескольких сетях. Вам следует создать одну или несколько сетей, чтобы сгруппировать подсети в соответствии с бизнес-логикой.

Чтобы создать сеть, сделайте следующее:


1. Щелкните вкладку **Сети**.
1. Щелкните  **Добавить сеть** и введите имя и описание сети. 
2. Выберите одну или несколько подсетей и щелкните **Добавить**. 
3. Чтобы сохранить конфигурацию, нажмите кнопку **Сохранить**. 


### <a name="create-monitoring-rules"></a>Создание правил мониторинга 

Функция монитора производительности формирует события работоспособности при нарушении порога производительности сетевых подключений между двумя подсетями или сетями. Система может определить эти пороговые значения автоматически. При желании можно задать настраиваемые пороги. Система автоматически создает правило по умолчанию, которое формирует событие работоспособности каждый раз, когда значения потери или задержки между любой парой подключенных сетей или подсетей превышают определенный системой порог. Это помогает решению отслеживать сетевую инфраструктуру, пока правила мониторинга не созданы явным образом. Если **правило по умолчанию** включено, то все узлы отправляют искусственные транзакции на все узлы, для которых включен мониторинг. Правило по умолчанию удобно применять в небольших сетях, например, если имеется небольшое количество серверов, на которых выполняется микрослужба, и вы хотите обеспечить подключение между всеми серверами. 

>[!NOTE]
> Настоятельно рекомендуется отключить **правило по умолчанию** и создать настраиваемые правила мониторинга, особенно для крупных сетей, в которых используется большое количество узлов, требующих наблюдения. Это позволяет уменьшить трафик, создаваемый решением, и упростить организацию мониторинга сети. 

Создайте правила мониторинга в соответствии с бизнес-логикой. Например, если требуется отслеживать производительность сетевого подключения между двумя офисными сайтами и главным офисом, сгруппируйте все подсети на офисном сайте 1 в сети O1, все подсети на офисном сайте 2 в сети O2 и все подсети главного офиса в сети H. Создайте 2 правила мониторинга: одно между сетями O1 и H, второе — между сетями O2 и H. 

Чтобы создать настраиваемые правила мониторинга, сделайте следующее:

1. На вкладке **Монитор** щелкните **Добавить правило** и введите имя и описание правила. 
2. Выберите из списков пару сетевых соединений или соединений подсети для мониторинга. 
3. Сначала выберите сеть, в которой содержатся необходимые первые подсети, в раскрывающемся списке сетей, а затем выберите нужные подсети в раскрывающемся списке подсетей. Выберите **Все подсети**, если необходимо отслеживать все подсети в сетевом соединении. Аналогичным образом выберите другие необходимые подсети. Щелкните **Добавить исключение**, чтобы исключить мониторинг для определенных соединений подсети из списка выбранных. 
4. Для выполнения искусственных транзакций выберите один из протоколов: ICMP или TCP. 
5. Если не нужно создавать события работоспособности для выбранных элементов, снимите флажок **Включить наблюдение за работоспособностью ссылок, охваченных этим правилом**. 
6. Выберите условия мониторинга. Вы можете задать настраиваемые пороговые значения для создания событий работоспособности. Каждый раз, когда значение условия превышает выбранное пороговое значение для выбранной пары сетей или подсетей, создается событие работоспособности. 
7. Чтобы сохранить конфигурацию, нажмите кнопку **Сохранить**. 

Сохранив правило мониторинга, вы можете интегрировать это правило с управлением оповещениями. Для этого щелкните **Создать предупреждение**. Правило оповещений автоматически создается с заполненными полями поискового запроса и других необходимых параметров. Используя правило оповещения, вы можете получать оповещения по электронной почте в дополнение к существующим оповещениям в NPM. Оповещения также могут активировать корректирующие действия для модулей runbook. Или их можно интегрировать с существующими решениями управления службами, использующими объекты webhook. Нажмите кнопку **Управлять оповещениями**, чтобы изменить параметры оповещений. 

Теперь можно создать дополнительные правила мониторинга производительности или перейти к панели мониторинга решения, чтобы начать использование возможности. 

### <a name="choose-the-protocol"></a>Выбор протокола

Монитор производительности сети (NPM) использует искусственные транзакции для вычисления показателей производительности сети, таких как потеря пакетов и задержка связи. Чтобы лучше в этом разобраться, рассмотрим агент NPM, подключенный к одной конечной точке сетевого соединения. Этот агент NPM отправляет пробные пакеты во второй агент NPM, подключенный к другой конечной точке сети. Второй агент отвечает отправкой ответных пакетов. Этот процесс повторяется несколько раз. Измеряя количество ответов и время, затраченное на получение каждого ответа, первый агент NPM оценивает задержку связи и потерю пакетов. 

Формат, размер и последовательность этих пакетов определяется протоколом, который выбирается при создании правил мониторинга. В зависимости от протокола пакетов промежуточные сетевые устройства (маршрутизаторы, коммутаторы и др.) могут по-разному обрабатывать эти пакеты. Поэтому от выбора протокола зависит точность результатов. От выбора протокола также зависит, потребуется ли после развертывания решения NPM выполнять какие-то действия вручную. 

Для выполнения искусственных транзакций в NPM доступны два протокола — ICMP и TCP. Если при создании правила искусственных транзакций выбрать протокол ICMP, то для расчета задержки в сети и потери пакетов агенты NPM будут использовать эхо-сообщения ICMP. В эхо-сообщениях ICMP используется такой же тип сообщений, как и в традиционной служебной программе проверки связи. Если выбрать протокол TCP, то агенты NPM будут отправлять по сети пакет TCP SYN. После этого выполняется подтверждение TCP, а затем подключение удаляется с помощью пакетов RST. 

Прежде чем выбрать протокол, ознакомьтесь с приведенными ниже сведениями. 

**Обнаружение нескольких сетевых маршрутов.**  При обнаружении нескольких маршрутов протокол TCP обеспечивает более точные результаты. А также ему требуется меньше агентов в каждой подсети. Например, один или два агента, использующие протокол TCP, могут обнаруживать все избыточные пути между подсетями. При этом для достижения подобных результатов с помощью протокола ICMP необходимо несколько агентов. При использовании протокола ICMP, если у вас несколько маршрутов между двумя подсетями, то вам необходимо иметь не менее 5N агентов в исходной или целевой подсети. 

**Точность результатов.** Как правило, маршрутизаторы и коммутаторы назначают эхо-пакетам ICMP более низкий приоритет по сравнению с пакетами TCP. В определенных ситуациях при высокой загрузке сетевых устройств данные, полученные по протоколу TCP, более точно отражают фактические показатели потери и задержки в приложениях. Это связано с тем, что большая часть трафика приложений проходит по протоколу TCP. В таких случаях ICMP обеспечивает менее точные результаты, чем TCP. 

**Настройка брандмауэра.** Для протокола TCP требуется, чтобы пакеты TCP отправлялись на конечный порт. По умолчанию агенты NPM используют порт 8084, однако его можно изменить при настройке агентов. Таким образом, необходимо убедиться, что сетевые брандмауэры или правила групп безопасности сети (в Azure) разрешают трафик через этот порт. Также необходимо убедиться, что в настройках локального брандмауэра на компьютерах, где установлены агенты, разрешен трафик через этот порт. Правила брандмауэра на компьютерах под управлением Windows можно настроить с помощью сценариев PowerShell, а сетевой брандмауэр настраивается вручную. ICMP функционирует иначе. Этот протокол не использует порт. В большинстве корпоративных сценариев ICMP-трафик через брандмауэры разрешается, чтобы была возможность использовать диагностические инструменты, такие как служебная программа проверки связи. Таким образом, если вам удалось выполнить проверку связи между двумя компьютерами, то вы можете использовать протокол ICMP, не настраивая брандмауэры вручную. 

>[!NOTE] 
> Некоторые брандмауэры могут блокировать протокол ICMP, что может привести к повторной передаче, порождающей большое количество событий в сведениях системы безопасности и системе управления событиями. Убедитесь, что выбранный протокол не блокируется брандмауэром или группой безопасности сети, в противном случае у NPM не будет возможности отслеживать сегмент сети. По этой причине рекомендуется использовать протокол TCP для мониторинга. Протокол ICMP следует применять в сценариях, в которых невозможно использовать протокол TCP, например: 
>
> - если вы используете узлы на основе клиента Windows, так как незащищенные сокеты TCP не допускаются в клиенте Windows;
> - если ваш сетевой брандмауэр или NSG блокирует протокол TCP.
> - Как сменить протокол 

Если во время развертывания вы выбрали протокол ICMP, то для его смены на протокол TCP в любое время можно изменить правило мониторинга по умолчанию.

1. Последовательно выберите **Производительность сети** > **Мониторинг** > **Настройка** > **Мониторинг**, а затем щелкните  **Default rule** (Правило по умолчанию). 
2. Прокрутите страницу до раздела **Protocol** (Протокол) и выберите протокол, который хотите использовать. 
3. Чтобы применить настройку, нажмите кнопку **Save** (Сохранить). 

Даже если в правиле по умолчанию используется определенный протокол, вы можете создавать другие правила с другим протоколом. Можно даже создать набор правил, в котором одна часть правил будет использовать протокол ICMP, и другая часть — TCP. 

## <a name="walkthrough"></a>Пошаговое руководство 

Теперь, когда вы узнали о мониторинге производительности, давайте рассмотрим, как легко выявить причину возникновения события работоспособности.  

На панели мониторинга решений можно увидеть событие работоспособности — сетевое соединение находится в неработоспособном состоянии. Если вы решили определить причину проблемы, щелкните плитку **Network links being monitored** (Отслеживаемые сетевые соединения).

На странице подробных сведений вы увидите, что в неработоспособном состоянии находится соединение **DMZ2-DMZ1**. Для этого сетевого подключения щелкните ссылку **View subnet links** (Просмотр соединений подсети). 


На странице детализации отобразятся все соединения подсети в сетевом соединении **DMZ2-DMZ1**. Обратите внимание, что для обоих соединений подсети значение задержки превысило пороговое значение. Это и является причиной неработоспособности сетевого соединения. Кроме того, можно увидеть тенденции задержки обоих соединений подсети. На диаграмме можно использовать элемент управления для выбора времени, чтобы сосредоточиться на необходимом диапазоне времени. Вы узнаете период, когда значение задержки достигло пика. Позже можно найти сведения для этого периода времени в журналах, чтобы определить причину проблемы. Щелкните **Просмотреть ссылки на узлы** для дополнительной детализации. 
 
 ![Соединение между подсетями](media/log-analytics-network-performance-monitor/subnetwork-links.png) 

Как и на предыдущей странице, на странице детализации для определенного соединения подсети представлены, связанные с ней соединения узлов. Здесь можно выполнить те же действия, которые описаны на предыдущем шаге. Чтобы просмотреть топологию между двумя узлами, щелкните **Просмотреть топологию**. 
 
 ![Соединение между узлами](media/log-analytics-network-performance-monitor/node-links.png) 

Все пути между двумя выбранными узлами отображаются на карте топологии. Топологию маршрутов можно визуализировать по прыжкам между двумя узлами на карте топологии. Это обеспечивает четкое представление о количестве маршрутов между двумя узлами и путях, по которым передаются пакеты данных. Узкие места производительности сети помечаются красным цветом. Чтобы найти неисправное сетевое подключение или неисправное сетевое устройство, нужно просмотреть элементы, помеченные красным цветом на карте топологии. 

 ![Панель мониторинга с топологией](media/log-analytics-network-performance-monitor/topology-dashboard.png) 

Значения потери, задержки и количество прыжков в каждом пути можно просмотреть в области **Действие**. Используйте полосу прокрутки, чтобы просмотреть сведения об этих неработоспособных путях. Используйте фильтры для выбора путей с неработоспособными прыжками, чтобы отобразить топологию только выбранных путей. С помощью колесика мыши можно увеличить или уменьшить масштаб карты топологии. 

Если посмотреть на пути и прыжки, выделенные красным цветом на изображении ниже, станет понятна основная причина проблем для определенной части сети. Щелкнув узел на карте топологии, можно увидеть его свойства, включая полное доменное имя и IP-адрес. Если щелкнуть прыжок, отобразится IP-адрес прыжка. 
 
![Панель мониторинга с топологией](media/log-analytics-network-performance-monitor/topology-dashboard-root-cause.png) 

## <a name="next-steps"></a>Дополнительная информация
* [Выполните поиск по журналам](log-analytics-log-searches.md), чтобы просмотреть подробные записи данных о производительности сети.
