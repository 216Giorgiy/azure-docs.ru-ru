---
title: Общие сведения об оповещениях в Azure Log Analytics | Документация Майкрософт
description: Оповещения в Log Analytics идентифицируют важную информацию в репозитории OMS и могут заранее уведомлять вас о возникших проблемах или выполнять действия в попытке устранить их.  В этой статье описываются различные типы правил генерации оповещений и их определение.
services: log-analytics
documentationcenter: ''
author: bwren
manager: carmonm
editor: tysonn
ms.assetid: 6cfd2a46-b6a2-4f79-a67b-08ce488f9a91
ms.service: log-analytics
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/05/2018
ms.author: bwren
ms.openlocfilehash: ece2e7eeb53aebbb18bce4bb34e03307b0aea74c
ms.sourcegitcommit: d74657d1926467210454f58970c45b2fd3ca088d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
---
# <a name="understanding-alerts-in-log-analytics"></a>Общие сведения об оповещениях в Log Analytics

Оповещения в Log Analytics содержат важную информацию о вашем репозитории Log Analytics.  В этой статье рассматриваются некоторые проектные решения, которые необходимо принять, основываясь на интервале сбора запрашиваемых данных, случайных задержках при приеме данных, которые могут быть обусловлены задержками сети, объемом ресурсов, требуемых для обработки, и фиксацией данных в репозитории Log Analytics.  Здесь также содержатся сведения о работе правил генерации оповещений в Log Analytics, а также описываются различия между разными типами этих правил.

Сведения о создании правил генерации оповещений см. по следующим ссылкам:

- создание правил генерации оповещений на [портале Azure](log-analytics-alerts-creating.md);
- создание правил генерации оповещений с помощью [шаблона Resource Manager](../operations-management-suite/operations-management-suite-solutions-resources-searches-alerts.md);
- создание правил генерации оповещений с помощью [REST API](log-analytics-api-alerts.md).

## <a name="considerations"></a>Рекомендации

Сведения о частоте сбора данных для различных решений и типов данных доступны в [этом разделе](log-analytics-add-solutions.md#data-collection-details) статьи с обзором решения. Как уже отмечалось в данной статье, сбор может выполняться не чаще, чем раз в семь дней *при уведомлении*. Перед настройкой оповещения следует принять во внимание частоту сбора данных. 

- Частота сбора определяет, как часто агент OMS на компьютерах будет отправлять данные в службу Log Analytics. Например, если частота сбора составляет 10 минут и в системе нет других задержек, тогда передаваемые данные будут добавляться в репозиторий на 0–10 минут позже, и их поиск может выполняться в Log Analytics.

- Прежде чем будет активировано оповещение, данные должны быть записаны в репозиторий, чтобы они были доступны при запросе. Из-за описанной выше задержки частота сбора данных не совпадает со временем, когда данные доступны для запросов. Например, данные, собираемые точно каждые 10 минут, будут доступны в репозитории через нерегулярные интервалы времени. Гипотетически, данные, собранные с нулевым, 10 и 20-минутными интервалами, могут быть доступны для поиска через 25, 28 и 35 минут соответственно или через какой-то другой нерегулярный интервал, на который влияет задержка приема данных. Наихудший случай этих задержек описан в [соглашении об уровне обслуживания Log Analytics](https://azure.microsoft.com/support/legal/sla/log-analytics/v1_1), в который не включены задержки, связанные с интервалом сбора или задержкой сети между компьютером и службой Log Analytics.


## <a name="alert-rules"></a>правила оповещений.

Оповещения создаются с помощью правил оповещения, которые автоматически выполняют поиск по журналам через регулярные интервалы.  Если результаты поиска по журналам соответствуют определенным условиям, создается запись оповещения.  После этого правило может автоматически запустить одно или несколько действий, чтобы заблаговременно уведомить вас об оповещении либо вызвать другой процесс.  В каждом типе правил генерации оповещений используется определенная логика выполнения этого анализа.

![Оповещения Log Analytics](media/log-analytics-alerts/overview.png)

Из-за ожидаемой задержки приема данных журнала невозможно точно определить время, когда индексированные данные станут доступными для поиска.  При определении правил генерации оповещений следует учитывать доступность собранных данных практически в реальном времени.    

Существует компромисс между надежностью и скоростью реагирования оповещений. Можно настроить параметры оповещений так, чтобы свести к минимуму ложные и пропущенные оповещения, или же выбрать параметры оповещения для быстрой реакции на условия, которые отслеживаются, но иногда создают ложные или пропущенные оповещения.

Правила генерации оповещений определяются следующими сведениями:

- **Поиск по журналам**.  Это запрос, который будет запускаться каждый раз при срабатывании правила генерации оповещений.  С помощью записей, возвращаемых этим запросом, можно определить, нужно ли создавать оповещение.
- **Временное окно**.  Указывает диапазон времени для запроса.  Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени.  Это значение может составлять от 5 минут до 24 часов. Диапазон должен быть достаточно широким, чтобы охватить приемлемые задержки при приеме данных. Временное окно должно быть в два раза больше самой длинной задержки, которую нужно обрабатывать.<br> Например, если вы хотите надежные оповещения для 30-минутных задержек, диапазон должен составлять один час.  

    Есть две проблемы, которые могут возникнуть, если диапазон времени слишком мал.

    - **Отсутствующие оповещения**. Предположим, что задержка приема данных иногда составляет 60 минут, но в большинстве случаев — это пятнадцать минут.  Если временное окно равно 30 минутам, оповещение будет пропущено, если задержка составит 60 минут, так как данные не будут доступны для поиска при выполнении запроса на оповещение. 
   
        >[!NOTE]
        >Установить причину пропуска оповещения невозможно. Например, в приведенном выше случае данные записываются в репозиторий через 60 минут после выполнения запроса на оповещение. Если на следующий день окажется, что оповещение было пропущено, а на следующий день запрос будет выполняться через правильный интервал времени, то критерий поиска по журналам будет соответствовать результату. Может показаться, что оповещение должно быть активировано. На самом деле оповещение не активировано, так как данные еще не доступны при выполнении запроса на оповещение. 
        >
 
    - **Ложные оповещения**. Иногда запросы на оповещения предназначены для определения отсутствия событий. Одним из примеров является обнаружение отключенного состояния виртуальной машины путем поиска неполученных сигналов пульса. Как указано выше, если пульс невозможно найти в рамках окна времени оповещения, тогда будет создано оповещение, так как данные пульса еще не доступны для поиска и поэтому отсутствуют. Это тот же результат, как если бы виртуальная машина находилась в автономном режиме и не создавала данные пульса. Выполнение запроса на следующий день в правильном временном окне покажет, что сигналы пульса отправлялись и оповещение завершилось со сбоем. Фактически, сигналы пульса еще не были доступны для поиска, потому что окно времени оповещения было слишком маленьким.  

- **Частота**.  Указывает, как часто запрос должен выполняться, и может использоваться, чтобы увеличить скорость реагирования в обычных случаях. Значение может находиться в диапазоне от 5 минут до 24 часов и должно быть равным или меньшим, чем окно времени оповещения.  Если значение больше, чем временное окно, появляется риск пропуска записей.<br>Если целью является обеспечение надежности для задержек до 30 минут, в то время как нормальная задержка — 10 минут, временное окно должно составлять один час, а значение частоты — 10 минут. Это приведет к запуску оповещения с данными, у которых есть 10-минутная задержка приема, между 10 и 20 минутами при создании данных оповещения.<br>Чтобы избежать создания нескольких оповещений для одних и тех же данных из-за слишком большого временного окна, можно использовать параметр [Отключить оповещения](log-analytics-tutorial-response.md#create-alerts) для подавления оповещений в течение этого периода времени.
  
- **Пороговое значение**.  Чтобы определить, следует ли создавать оповещение, оцениваются результаты поиска по журналам.  Для каждого типа правил генерации оповещений определяется собственное пороговое значение.

Каждое правило генерации оповещений в Log Analytics относится к одному из двух типов.  Каждый из этих типов подробно описан в последующих разделах.

- **[Число результатов](#number-of-results-alert-rules)**. Если число записей, возвращенных в результатах поиска по журналам, превышает указанное количество, создается оповещение.
- **[Измерение метрик](#metric-measurement-alert-rules)**.  Оповещение, созданное для каждого объекта в результатах поиска по журналам со значением, превышающим указанное пороговое значение.

Ниже приведены различия между типами правил генерации оповещений.

- Правило генерации оповещений **Число результатов** всегда создает одно оповещение, а **Измерение метрик** — по одному для каждого объекта, для которого превышено пороговое значение.
- Правило генерации оповещений **Число результатов** создает оповещение при одноразовом превышении порогового значения. Правило генерации оповещений **Измерение метрик** может создавать оповещение при превышении порогового значения определенное количество раз за указанный интервал времени.

## <a name="number-of-results-alert-rules"></a>Правило генерации оповещений "Число результатов"
Правила генерации оповещений **Число результатов** создают одно оповещение, если количество записей, возвращенных в результатах поискового запроса, превышает указанное пороговое значение.

### <a name="threshold"></a>Threshold (Пороговое значение)
Под пороговым значением правила генерации оповещений **Число результатов** подразумевается значение, большее или меньшее чем определенное значение.  Если число записей, возвращенных в результатах поиска по журналам, соответствует этому критерию, создается оповещение.

### <a name="scenarios"></a>Сценарии

#### <a name="events"></a>События
Этот тип правила генерации оповещений идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал и настраиваемые журналы.  Вам может потребоваться создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в определенном временном окне.

Для оповещения об одном событии задайте количество результатов больше 0, а частоту и временное окно установите равными 5 минутам.  При этом запрос выполняется каждые 5 минут и проверяет наличие одного события, созданного с момента последнего выполнения запроса.  Уменьшение частоты может привести к увеличению интервала между сбором данных о событии и созданием оповещения.

Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае вам может потребоваться создавать оповещение только в случае возникновения нескольких событий за определенное временное окно.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного временного окна, следует создать оповещение.  В этом случае задайте пороговое значение **Меньше 1**.

#### <a name="performance-alerts"></a>Оповещения производительности
[Данные о производительности](log-analytics-data-sources-performance-counters.md) хранятся в виде записей в репозитории OMS по аналогии с событиями.  Если вы хотите создать оповещение, когда значение счетчика производительности превышает определенный порог, это пороговое значение следует включить в запрос.

Например, если бы вам было нужно получать оповещения, когда процессор нагружен более чем на 90 %, то вы могли бы использовать запрос с пороговым значением для правила генерации оповещений **Больше 0**. Пример такого запроса приведен ниже.

    Type=Perf ObjectName=Processor CounterName="% Processor Time" CounterValue>90

Если бы вам было нужно получать оповещения, когда средняя нагрузка процессора превышает 90 % в определенном временном окне, то вы могли бы использовать запрос с командой `measure` и пороговым значением для правила генерации оповещений **Больше 0**. Ниже приведен пример такого запроса.

    Type=Perf ObjectName=Processor CounterName="% Processor Time" | measure avg(CounterValue) by Computer | where AggregatedValue>90

>[!NOTE]
> Если для рабочей области обновлен [язык запросов Log Analytics](log-analytics-log-search-upgrade.md), указанные выше запросы будут изменены следующим образом: `Perf | where ObjectName=="Processor" and CounterName=="% Processor Time" and CounterValue>90`
> `Perf | where ObjectName=="Processor" and CounterName=="% Processor Time" | summarize avg(CounterValue) by Computer | where CounterValue>90`.


## <a name="metric-measurement-alert-rules"></a>Metric measurement alert rules (Измерение метрики для правила генерации оповещений)

>[!NOTE]
> Сейчас правила генерации оповещений "Измерение метрик" находятся на этапе общедоступной предварительной версии.

Правила генерации оповещений **Измерение метрик** создают оповещение для каждого объекта в запросе со значением, превышающим указанное пороговое значение.  Ниже приведены их четко выраженные отличия от правил генерации оповещений **Число результатов**.

#### <a name="log-search"></a>Поиск по журналам
Правило генерации оповещений **Число результатов** поддерживает все типы запросов, но в отношении запросов для правила "Измерение метрик" применяются определенные требования.  Например, этот запрос должен содержать команду `measure`, которая позволяет сгруппировать результаты по определенному полю. Эта команда должна содержать следующие элементы.

- **Агрегатная функция**.  Указывает выполняемые вычисления и (необязательно) числовое поле для статистических вычислений.  Например, **count()** возвращает число записей в запросе, а **avg(CounterValue)** — среднее значение поля CounterValue в течение указанного интервала.
- **Группировка по полю**.  Для каждого экземпляра этого поля будет создана запись с агрегированным значением, и для каждого из них можно создать оповещение.  Например, если вы хотите создать оповещение для каждого компьютера, используйте группировку **по компьютерам**.   
- **Интервал**.  Определяет интервал времени, в течение которого выполняется статистическое вычисление данных.  Например, если вы указали значение **5 минут**, запись будет создана для каждого экземпляра поля группировки, вычисленного с интервалом в 5 минут, за период времени, указанный для оповещения.

#### <a name="threshold"></a>Threshold (Пороговое значение)
Пороговое значение для правил генерации оповещений "Измерение метрик" определяется на основе статического значения и числа нарушений.  Если любая точка данных в результатах поиска по журналам превышает это значение, она рассматривается как нарушение.  Когда число нарушений в результатах для любого объекта превышает указанное значение, для этого объекта создается оповещение.

#### <a name="example"></a>Пример
Рассмотрим ситуацию, где оповещение должно создаваться, когда использование процессора на компьютере превышает 90 % три раза в течение 30 минут.  Вы должны создать правило генерации оповещений с приведенными ниже сведениями.  

**Запрос:** Type=Perf ObjectName=Processor CounterName="% Processor Time" | measure avg(CounterValue) by Computer Interval 5minute.<br>
**Временное окно:** 30 минут.<br>
**Периодичность предупреждений:** 5 минут.<br>
**Объединенное значение:** больше 90.<br>
**Активировать оповещение на основе:** общее число нарушений, превышающее 5.<br>

Запрос вернет среднее значение для каждого компьютера с интервалом в 5 минут.  Этот запрос выполняется каждые 5 минут для данных, собранных в течение предыдущих 30 минут.  Ниже приведен пример данных для трех компьютеров.

![Результаты выполнения примера запроса](media/log-analytics-alerts/metrics-measurement-sample-graph.png)

В этом примере отдельные оповещения создаются для компьютеров srv02 и srv03, так как за указанное временное окно они 3 раза превысили пороговое значение в 90 %.  Если значение параметра **Активировать оповещение на основе:** изменить на **Consecutive** (Последовательные нарушения), тогда оповещение будет создано только для компьютера srv03, так как он превысил пороговое значение 3 раза подряд.

## <a name="alert-records"></a>Записи оповещений
Записи оповещений, созданные правилами генерации оповещений в Log Analytics, имеют значение **Alert** для **Type** и значение **OMS** для **SourceSystem**.  У них есть свойства, приведенные в таблице ниже.

| Свойство | ОПИСАНИЕ |
|:--- |:--- |
| type |*Предупреждение* |
| SourceSystem |*OMS* |
| *Объект*  | Оповещения [Измерение метрик](#metric-measurement-alert-rules) будут содержать свойство поля группировки.  Например, если результаты поиска по журналам группируются по компьютерам, запись оповещения будет содержать поле Computer с именем компьютера в качестве значения.
| AlertName |Имя оповещения. |
| AlertSeverity |Серьезность оповещения. |
| LinkToSearchResults |Ссылки на поиск журналов Log Analytics, возвращающая записи из запроса, создавшего оповещение. |
| Запрос |Текст запроса, который был запущен. |
| QueryExecutionEndTime |Конец диапазона времени для запроса. |
| QueryExecutionStartTime |Начало диапазона времени для запроса. |
| ThresholdOperator | Оператор, используемый правилом оповещения. |
| ThresholdValue | Значение, используемое правилом оповещения. |
| TimeGenerated |Дата и время создания оповещения. |

Существуют и другие виды записей оповещений, создаваемые [решением для управления оповещениями](log-analytics-solution-alert-management.md) и [экспортами Power BI](log-analytics-powerbi.md).  Все они имеют значение **Alert** для **Type**, но различаются по **SourceSystem**.


## <a name="next-steps"></a>Дополнительная информация
* Установите [решение для управления оповещениями](log-analytics-solution-alert-management.md), чтобы анализировать предупреждения, создаваемые в Log Analytics, вместе с оповещениями, полученными от System Center Operations Manager.
* Вы можете ознакомиться с дополнительными сведениями о [поисках журналов](log-analytics-log-searches.md) , которые могут создавать оповещения.
* Вы можете выполнить пошаговое руководство по [настройке webook](log-analytics-alerts-webhooks.md) с использованием правила генерации оповещений.  
* Вы можете научиться писать [модули Runbook в службе автоматизации Azure](https://azure.microsoft.com/documentation/services/automation) для устранения проблем, обозначенных в оповещениях.
