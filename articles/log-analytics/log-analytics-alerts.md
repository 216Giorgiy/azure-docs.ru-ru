---
title: "Создание оповещений в OMS Log Analytics | Документация Майкрософт"
description: "Оповещения в Log Analytics идентифицируют важную информацию в репозитории OMS и могут заранее уведомлять вас о возникших проблемах или выполнять действия в попытке устранить их.  Эта статья описывает создание правила генерации оповещений и сведения о различных действиях, которые оно может выполнить."
services: log-analytics
documentationcenter: 
author: bwren
manager: jwhit
editor: tysonn
ms.assetid: 6cfd2a46-b6a2-4f79-a67b-08ce488f9a91
ms.service: log-analytics
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/25/2017
ms.author: bwren
translationtype: Human Translation
ms.sourcegitcommit: 9fe104a1ea26afa2817aedaa8ed77d042404cda6
ms.openlocfilehash: 9a62ed7540de05b1db7610e12f2671d33fc8049d


---
# <a name="alerts-in-log-analytics"></a>Оповещения в Log Analytics
Оповещения в Log Analytics содержат важную информацию о вашем репозитории OMS.  Правила генерации оповещений автоматически выполняют поиск журналов по расписанию и создают запись оповещения, если результаты соответствуют определенным условиям.  После этого правило может автоматически запустить одно или несколько действий, чтобы заблаговременно уведомить вас об оповещении либо вызвать другой процесс.   

![Оповещения Log Analytics](media/log-analytics-alerts/overview.png)

>[!NOTE]
> Сведения о правилах генерации оповещений об измерениях метрик, которые в настоящее время находятся на этапе общедоступной предварительной версии, см. в разделе [New metric measurement alert rule type in Public Preview!](https://blogs.technet.microsoft.com/msoms/2016/11/22/new-metric-measurement-alert-rule-type-in-public-preview/) (Новый тип правила генерации оповещений об измерении метрики в общедоступной предварительной версии!).

## <a name="creating-an-alert-rule"></a>Создание правила генерации оповещений
Чтобы создать правило генерации оповещений, начните с создания поиска записей журналов, которые должны вызывать оповещение.  После этого станет доступна кнопка **Оповещение** , позволяющая создать и настроить правило генерации оповещений.

1. На странице обзора OMS щелкните **Log Search**(Поиск журналов).
2. Создайте новый запрос поиска журналов или выберите сохраненный поиск. 
3. Щелкните **Оповещение** в верхней части страницы, чтобы открыть экран **Добавить правило оповещения**.
4. Приведенная ниже таблица содержит сведения о параметрах для настройки оповещения.
5. При указании временного окна для правила генерации оповещений отображается число существующих записей, соответствующих критериям поиска, для этого временного окна.  Это помогает определить частоту, позволяющую получить ожидаемое число результатов.
6. Щелкните **Сохранить** для завершения работы с правилом генерации оповещений.  Оно запускается немедленно.

![Добавить правило оповещения](media/log-analytics-alerts/add-alert-rule.png)

| Свойство | Описание |
|:--- |:--- |
| **Alert information** | |
| Имя |Уникальное имя для идентификации правила генерации оповещений. |
| Уровень серьезности |Серьезность оповещения, созданного этим правилом. |
| Поисковый запрос |Щелкните **Use current search query** (Использовать текущий запрос), чтобы выбрать текущий запрос, или выберите сохраненный поисковый запрос из списка.  Синтаксис запроса приведен в текстовое поле, где его можно изменить. |
| Time window (Временное окно) |Указывает диапазон времени для запроса.  Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени.  Это значение может составлять от 5 минут до 24 часов.  Оно должно быть больше или равно частоте оповещений.  <br><br> Например, если временное окно равно 60 минутам, а запрос выполняется в 13:15, возвращаются только записи, созданные между 12:15 и 13:15. |
| **Расписание** | |
| Пороговое значение |Критерии, определяющие условия для создания оповещения.  Оповещение создается в том случае, если число записей, возвращаемых запросом, соответствует этому критерию. |
| Alert frequency (Частота оповещений) |Указывает, как часто должен выполняться запрос.  Это значение может составлять от 5 минут до 24 часов.  Оно должно быть меньше или равно временному окну. |
| Отменить вывод оповещений |При включении подавления для правила генерации оповещений действия для этого правила отключаются на заданный промежуток времени после создания оповещения.  Правило по прежнему выполняется и создает записи оповещений при соблюдении критериев.  Это дает вам время устранить проблему без запуска повторяющихся действий. |
| **Действия** | |
| Уведомление по электронной почте |Укажите **Да** , если хотите отправить сообщение электронной почты при активации оповещения. |
| Субъект |Тема сообщения электронной почты.  Основной текст сообщения нельзя изменить. |
| Recipients |Адреса всех получателей электронной почты.  При указании нескольких адресов разделяйте их точкой с запятой (;). |
| webhook |Укажите **Да** , если хотите вызвать webhook при активации оповещения. |
| URL-адрес Webhook |URL-адрес действия webhook. |
| Include custom JSON payload (Включить пользовательские полезные данные JSON) |Выберите этот параметр, если хотите заменить полезные данные по умолчанию пользовательскими. |
| Enter your custom JSON payload (Введите пользовательские полезные данные JSON) |Пользовательские полезные данные для действия webhook.  Подробности приведены в предыдущем разделе. |
| Модуль Runbook |Укажите **Да** , если хотите запустить модуль Runbook службы автоматизации Azure при активации оповещения. |
| Выберите Runbook |Выберите запускаемый модуль Runbook в учетной записи автоматизации, настроенной в решении автоматизации. |
| Запуск на |Выберите **Azure** для запуска Runbook в облаке Azure.  Выберите **Гибридная рабочая роль** для запуска Runbook в [гибридной рабочей роли Runbook](../automation/automation-hybrid-runbook-worker.md) в локальной среде. |


## <a name="manage-alert-rules"></a>Управление правилами генерации оповещений
Список всех правил генерации оповещений можно получить в меню **Оповещения** раздела **Параметры** Log Analytics.  

![Управление оповещениями](./media/log-analytics-alerts/configure.png)

1. В консоли OMS выберите плитку **Параметры** .
2. Выберите **Оповещения**.

В этом представлении можно выполнить несколько действий.

* Отключите правило, выбрав параметр **Отключить** рядом с ним.
* Измените правило генерации оповещений, щелкнув значок карандаша рядом с ним.
* Удалите правило генерации оповещений, щелкнув значок **X** рядом с ним. 

## <a name="setting-time-windows-and-thresholds"></a>Установка временных окон и пороговых значений

>[!NOTE]
> Сведения о правилах генерации оповещений об измерениях метрик, которые в настоящее время находятся на этапе общедоступной предварительной версии, см. в разделе [New metric measurement alert rule type in Public Preview!](https://blogs.technet.microsoft.com/msoms/2016/11/22/new-metric-measurement-alert-rule-type-in-public-preview/) (Новый тип правила генерации оповещений об измерении метрики в общедоступной предварительной версии!).
 
### <a name="event-alerts"></a>Оповещения о событиях
События включают источники данных, такие как журналы событий Windows, Syslog и пользовательские журналы.  Вам может потребоваться создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в определенном временном окне.

Для оповещения об одном событии задайте количество результатов больше 0, а частоту и временное окно установите равными 5 минутам.  При этом запрос запускается каждые 5 минут и проверяет наличие одного события, созданного с момента последнего выполнения запроса.  Уменьшение частоты может привести к увеличению интервала между сбором данных о событии и созданием оповещения.

Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае вам может потребоваться создавать оповещение только в случае возникновения нескольких событий за определенное временное окно.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного временного окна, следует создать оповещение.  В этом случае задайте пороговое значение **Меньше 1**.

### <a name="performance-alerts"></a>Оповещения производительности
[Данные о производительности](log-analytics-data-sources-performance-counters.md) хранятся в виде записей в репозитории OMS по аналогии с событиями.  Если вы хотите создать оповещение, когда значение счетчика производительности превышает определенный порог, это пороговое значение следует включить в запрос.

Например, если бы вам было нужно получать оповещения, когда процессор нагружен более чем на 90 %, то вы могли бы использовать запрос с пороговым значением для правила генерации оповещений **Больше 0**. Пример такого запроса приведен ниже.

    Type=Perf ObjectName=Processor CounterName="% Processor Time" CounterValue>90

Если бы вам было нужно получать оповещения, когда средняя нагрузка процессора превышает 90 % в определенном временном окне, то вы могли бы использовать запрос с [командой measure](log-analytics-search-reference.md#commands) и пороговым значением для правила генерации оповещений **Больше 0**. Ниже приведен пример такого запроса. 

    Type=Perf ObjectName=Processor CounterName="% Processor Time" | measure avg(CounterValue) by Computer | where AggregatedValue>90

## <a name="alert-actions"></a>Действия оповещений
В дополнение к созданию записи оповещения можно настроить правило генерации оповещений для автоматического выполнения одного или нескольких действий.  Действия могут заранее уведомлять вас об оповещении или вызывать процесс, пытающийся устранить обнаруженную проблему.  Ниже описаны действия, доступные в настоящее время.

### <a name="email-actions"></a>Действия электронной почты
Действия электронной почты отправляют сообщение электронной почты с описанием оповещения одному или несколькими получателям.  Вы можете указать тему сообщения, но его содержимое имеет стандартный формат, определяемый службой Log Analytics.  Оно содержит сводные данные, такие как имя оповещения, а также описание до&10; записей, возвращенных в результате поиска журналов.  Он также включает ссылку на поиск журналов в Log Analytics, которая возвращает полный набор записей на основе этого запроса.   Отправителем сообщения является *группа разработчиков Microsoft Operations Management Suite&lt;noreply@oms.microsoft.com&gt;*. 

### <a name="webhook-actions"></a>Действия webhook
Действия webhook позволяют вызывать внешний процесс с помощью одного запроса HTTP POST.  Вызываемая служба должна поддерживать действия webhook и определить использование получаемых полезных данных.  Можно также вызвать REST API без поддержки действий webhook, если запрос имеет формат, понятный этому API.  Примеры использования webhook в ответ на оповещение используют такую службу, как [Slack](http://slack.com) для отправки сообщения со сведениями об оповещении или создания инцидента в такой службе, как [PagerDuty](http://pagerduty.com/).  

Полное пошаговое руководство по созданию правила генерации оповещений с webhook для вызова примера службы доступно в статье [Действия webhook в оповещениях Log Analytics](log-analytics-alerts-webhooks.md).

Действия webhook включают URL-адрес и полезные данные в формате JSON, которые являются данными, отправляемыми во внешнюю службу.  По умолчанию полезные данные включают в себя значения из приведенной ниже таблицы.  Такие полезные данные можно заменить на собственные.  В этом случае можно использовать переменные из таблицы для каждого параметра, чтобы включить их значение в пользовательские полезные данные.

| Параметр | Переменная | Описание |
|:--- |:--- |:--- |
| AlertRuleName |#AlertRuleName |Имя правила генерации оповещений. |
| AlertThresholdOperator |#thresholdoperator |Оператор порога для правила генерации оповещений.  *Больше* или *Меньше*. |
| AlertThresholdValue |#thresholdvalue |Значение порога для правила генерации оповещений. |
| LinkToSearchResults |#LinkToSearchResults |Ссылки на поиск журналов Log Analytics, возвращающая записи из запроса, создавшего оповещение. |
| ResultCount |#searchresultcount |Число записей в результатах поиска. |
| SearchIntervalEndtimeUtc |#SearchIntervalEndtimeUtc |Время окончания для запроса в формате UTC. |
| SearchIntervalInSeconds |#searchinterval |Временное окно для правила генерации оповещений. |
| SearchIntervalStartTimeUtc |#SearchIntervalStartTimeUtc |Время начала для запроса в формате UTC. |
| SearchQuery |#SearchQuery |Запрос поиска журналов, используемый правилом генерации оповещений. |
| SearchResults |См. ниже |Записи, возвращенные запросом в формате JSON.  Только первые 5000 записей. |
| WorkspaceID |#WorkspaceID |Идентификатор рабочей области OMS |

Например, можно указать следующие пользовательские полезные данные, содержащие один параметр — *text*.  Служба, вызываемая этим действием webhook, будет ожидать этот параметр.

    {
        "text":"#alertrulename fired with #searchresultcount over threshold of #thresholdvalue."
    }

При отправке в webhook этот пример полезных данных разрешается в нечто следующее:

    {
        "text":"My Alert Rule fired with 18 records over threshold of 10 ."
    }

Чтобы включить результаты поиска в пользовательские полезные данные, добавьте следующую строку как свойство верхнего уровня в полезных данных JSON.  

    "IncludeSearchResults":true

Например, чтобы создать пользовательские полезные данные, включающие только имя оповещения и результаты поиска, можно использовать следующее: 

    {
       "alertname":"#alertrulename",
       "IncludeSearchResults":true
    }


С полным примером создания правила генерации оповещений с помощью webhook для запуска внешней службы можно ознакомиться в статье [Пример webhook для оповещения Log Analytics](log-analytics-alerts-webhooks.md).

### <a name="runbook-actions"></a>Действия Runbook
Действия Runbook запускают модуль Runbook в службе автоматизации Azure.  Чтобы использовать этот тип действия, необходимо иметь установленное и настроенное [решение автоматизации](log-analytics-add-solutions.md) в рабочей области OMS.  Если оно не установлено при создании нового правила генерации оповещений, отображается ссылка для его установки.  Можно выбрать один из модулей Runbook в учетной записи автоматизации, настроенной в решении автоматизации.

Действия Runbook запускают модуль Runbook с помощью [webhook](../automation/automation-webhooks.md).  При создании правила генерации оповещений автоматически создается новое действие webhook для модуля Runbook с именем **OMS Alert Remediation** , за которым следует GUID.  

Нельзя напрямую заполнять параметры Runbook. Однако в [параметре $WebhookData](../automation/automation-webhooks.md) будут содержаться подробные сведения о предупреждении, включая результаты поиска по журналам,из-за которого оно возникло.  Для доступа к свойствам предупреждения модулю Runbook потребуется определить **$WebhookData** в качестве параметра.  Данные предупреждения доступны в формате Json в свойстве **SearchResults** свойства **RequestBody** параметра **$WebhookData**.  Свойства этого параметра приведены в таблице ниже.

| Узел | Описание |
|:--- |:--- |
| id |Путь и GUID для поиска. |
| __metadata |Сведения об оповещении, включая количество записей и состояние результатов поиска. |
| value |Отдельная запись для каждой записи в результатах поиска.  Подробные сведения о записи будут соответствовать свойствам и значениям записи. |

Например, следующий модуль Runbook извлечет записи, возвращенные в результате поиска по журналам, и назначит разные свойства на основе типа каждой записи.  Обратите внимание, что сначала модуль Runbook преобразовывает формат **RequestBody** из Json, чтобы с этим параметром можно было работать в качестве объекта в PowerShell.

    param ( 
        [object]$WebhookData
    )

    $RequestBody = ConvertFrom-JSON -InputObject $WebhookData.RequestBody
    $Records     = $RequestBody.SearchResults.value

    foreach ($Record in $Records)
    {
        $Computer = $Record.Computer

        if ($Record.Type -eq 'Event')
        {
            $EventNo    = $Record.EventID
            $EventLevel = $Record.EventLevelName
            $EventData  = $Record.EventData
        }

        if ($Record.Type -eq 'Perf')
        {
            $Object    = $Record.ObjectName
            $Counter   = $Record.CounterName
            $Instance  = $Record.InstanceName
            $Value     = $Record.CounterValue
        }
    }


## <a name="alert-records"></a>Записи оповещений
Записи оповещений, созданные правилами генерации оповещений в Log Analytics, имеют значение **Alert** для **Type** и значение **OMS** для **SourceSystem**.  У них есть свойства, приведенные в таблице ниже.

| Свойство | Описание |
|:--- |:--- |
| Тип |*Предупреждение* |
| SourceSystem |*OMS* |
| AlertSeverity |Серьезность оповещения. |
| AlertName |Имя оповещения. |
| Запрос |Текст запроса, который был запущен. |
| QueryExecutionEndTime |Конец диапазона времени для запроса. |
| QueryExecutionStartTime |Начало диапазона времени для запроса. |
| TimeGenerated |Дата и время создания оповещения. |

Существуют и другие виды записей оповещений, создаваемые [решением для управления оповещениями](log-analytics-solution-alert-management.md) и [экспортами Power BI](log-analytics-powerbi.md).  Все они имеют значение **Alert** для **Type**, но различаются по **SourceSystem**.

## <a name="next-steps"></a>Дальнейшие действия
* Установите [решение для управления оповещениями](log-analytics-solution-alert-management.md) , чтобы анализировать предупреждения, созданные Log Analytics, вместе с оповещениями, данные о которых собраны из System Center Operations Manager (SCOM).
* Вы можете ознакомиться с дополнительными сведениями о [поисках журналов](log-analytics-log-searches.md) , которые могут создавать оповещения.
* Вы можете выполнить пошаговое руководство по [настройке webook](log-analytics-alerts-webhooks.md) с использованием правила генерации оповещений.  
* Вы можете научиться писать [модули Runbook в службе автоматизации Azure](https://azure.microsoft.com/documentation/services/automation) для устранения проблем, обозначенных в оповещениях.




<!--HONumber=Jan17_HO4-->


