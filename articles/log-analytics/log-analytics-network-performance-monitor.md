---
title: "Решение \"Монитор производительности сети\" в Azure | Документация Майкрософт"
description: "Монитор производительности сети в Azure позволяет отслеживать производительность ваших сетей практически в реальном времени для обнаружения в них узких мест производительности."
services: log-analytics
documentationcenter: 
author: abshamsft
manager: carmonm
editor: 
ms.assetid: 5b9c9c83-3435-488c-b4f6-7653003ae18a
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/20/2018
ms.author: abshamsft
ms.openlocfilehash: 399fe552d5c7d9a96cdabc2a1dfafe99635d4a61
ms.sourcegitcommit: 12fa5f8018d4f34077d5bab323ce7c919e51ce47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2018
---
# <a name="network-performance-monitor-solution-in-azure"></a>Решение "Монитор производительности сети" в Azure

![Символ монитора производительности сети](./media/log-analytics-network-performance-monitor/npm-symbol.png)


Монитор производительности сети (NPM) — это облачное гибридное решение мониторинга сети, которое позволяет отслеживать производительность сети между различными точками в сетевой инфраструктуре, сетевое подключение к конечным точкам служб и приложений, а также производительность Azure ExpressRoute.  

NPM обнаруживает проблемы сети, такие как появление "черных дыр" в трафике, ошибки маршрутизации и проблемы, которые невозможно обнаружить с помощью традиционных методов мониторинга сети. Это решение создает оповещения, уведомляет о превышении порогового значения для сетевого соединения, обеспечивает своевременное обнаружение проблем с производительностью сети и определяет конкретный сегмент сети или сетевое устройство как источник проблемы. 

NPM предлагает три расширенные возможности. 

[Мониторинг производительности](log-analytics-network-performance-monitor-performance-monitor.md): отслеживайте подключения к сети в облачных развертываниях и локальных расположениях, нескольких центрах обработки данных и филиалах, критически важных многоуровневых приложениях или микрослужбах. С помощью мониторинга производительности можно выявить проблемы в сети перед тем, как пользователи начнут на них жаловаться.  

[Мониторинг конечной точки службы](log-analytics-network-performance-monitor-service-endpoint.md): вы можете отслеживать подключение своих пользователей к нужным службам, определять инфраструктуру в пути, а также узкие места в сети. Вы можете узнавать о простоях, прежде чем с ними столкнутся пользователи, а также точно определять проблемные области в сетевом пути. 

Эта возможность позволяет проводить тесты протоколов HTTP, HTTPS, TCP и ICMP практически в реальном времени или по журнальным данным, отслеживая доступность и время отклика вашей службы, а также влияние сети на потерю и задержку пакетов. Благодаря карте топологии сети вы сможете изолировать задержки в сети, выявив проблемные места на сетевом пути от узла к службе, видя данные о задержках на каждом прыжке. Используя встроенные тесты, вы можете отслеживать подключения к службам Office 365 и Dynamics CRM без предварительной настройки. Благодаря этой функции вы можете отслеживать сетевое подключение к любой конечной точке, поддерживающей TCP, например веб-сайтам, приложениям SaaS и PaaS, базам данных SQL и т. д.  

[Мониторинг ExpressRoute](log-analytics-network-performance-monitor-expressroute.md): отслеживайте сквозное подключение и производительность между своими филиалами и Azure через Azure ExpressRoute.  
 

## <a name="set-up-and-configure"></a>Установка и настройка

### <a name="install-and-configure-agents"></a>Установка и настройка агентов 

Базовая процедура установки агентов приведена в статьях [Подключение компьютеров Windows к Log Analytics](log-analytics-windows-agents.md) и [Подключение Operations Manager к Log Analytics](log-analytics-om-agents.md).

### <a name="where-to-install-the-agents"></a>Место для установки агентов 

**Мониторинг производительности:** установите агенты OMS по крайней мере на одном узле, подключенном к каждой подсети, из которой вы хотите отслеживать сетевое подключение к другим подсетям.  

Для отслеживания сетевого соединения агенты нужно установить на обеих конечных точках соединения.  Если вы не знаете топологию сети, установите агенты на серверах с критически важными рабочими нагрузками, где требуется отслеживать производительность сети. Например, если нужно отследить сетевое подключение между веб-сервером и сервером, работающим под управлением SQL, установите агент на обоих серверах. Агенты отслеживают сетевое подключение (соединения) между узлами, а не сами узлы. 

**Мониторинг конечной точки службы:** установите агент OMS на каждом узле, из которого нужно отследить сетевое подключение к конечной точке службы. Например, если вы планируете отслеживать сетевое подключение к Office 365 с офисного сайта O1, O2 и O3, тогда установите агент OMS по крайней мере на одном узле на каждом из соответствующих сайтов — O1, O2 и O3. 

**Мониторинг ExpressRoute:** установите хотя бы один агент OMS в виртуальной сети Azure и по крайней мере один агент в своей локальной подсети, которая подключается через частный пиринг ExpressRoute.  

### <a name="configure-oms-agents-for-monitoring"></a>Настройка агентов OMS для мониторинга  

NPM использует искусственные транзакции для мониторинга производительности сети между агентами источника и назначения. В решении в качестве протокола для отслеживания в возможностях мониторинга производительности и мониторинга конечной точки службы можно выбрать между TCP и ICMP, тогда как для мониторинга ExpressRoute используется протокол TCP. Убедитесь, что брандмауэр разрешает обмен данными между агентами OMS, используемыми для мониторинга, по протоколу, который вы выбрали.  

**Протокол TCP:** если вы выбрали TCP как протокол мониторинга, откройте порт брандмауэра для агентов, используемых для функций мониторинга производительности и мониторинга ExpressRoute, чтобы обеспечить подключение между агентами. Для этого запустите сценарий EnableRules.ps1 PowerShell, не задавая каких-либо параметров, в окне PowerShell с правами администратора.  

Этот сценарий создает разделы реестра, необходимые для решения, а также правила брандмауэра Windows, чтобы разрешить агентам создавать TCP-подключения друг к другу. В разделах реестра, созданных скриптом, также нужно указать, следует ли записывать журналы отладки и путь к файлу журнала. Он также определяет TCP-порт агента, используемый для обмена данными. Значения этих реестров автоматически устанавливаются с помощью скрипта, поэтому вам не нужно изменять их вручную. Открытый порт по умолчанию — 8084. Вы можете использовать пользовательский порт, задав в сценарии параметр portNumber. На всех компьютерах, где выполняется скрипт, нужно использовать один и тот же порт. 

>[!NOTE]
> Сценарий настраивает брандмауэр Windows только локально. При наличии брандмауэра сети он должен разрешать пропуск трафика к TCP-порту, который используется монитором производительности сети. 

>[!NOTE]
> Вам не нужно запускать сценарий EnableRules.ps1 PowerShell для мониторинга конечной точки службы. 

 

**Протокол ICMP:** если вы выбрали ICMP как протокол мониторинга, включите следующие правила брандмауэра для надежного использования этого протокола: 

 
```
netsh advfirewall firewall add rule name="NPMDICMPV4Echo" protocol="icmpv4:8,any" dir=in action=allow 
netsh advfirewall firewall add rule name="NPMDICMPV6Echo" protocol="icmpv6:128,any" dir=in action=allow 
netsh advfirewall firewall add rule name="NPMDICMPV4DestinationUnreachable" protocol="icmpv4:3,any" dir=in action=allow 
netsh advfirewall firewall add rule name="NPMDICMPV6DestinationUnreachable" protocol="icmpv6:1,any" dir=in action=allow 
netsh advfirewall firewall add rule name="NPMDICMPV4TimeExceeded" protocol="icmpv4:11,any" dir=in action=allow 
netsh advfirewall firewall add rule name="NPMDICMPV6TimeExceeded" protocol="icmpv6:3,any" dir=in action=allow 
```
 

### <a name="configure-the-solution"></a>Настройка решения 

1. Добавьте решение "Монитор производительности сети" из [Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/Microsoft.NetworkMonitoringOMS?tab=Overview) в рабочую область, как описано в статье [Добавление решений для управления Azure Log Analytics в рабочую область](log-analytics-add-solutions.md). 
2. Откройте рабочую область Log Analytics и щелкните плитку **Обзор**.  
3. Щелкните плитку с именем **Монитор производительности сети**  с сообщением *Для решения требуется дополнительная настройка*.

    ![Плитка NPM](media/log-analytics-network-performance-monitor/npm-config.png)

3. На странице **установки** вы увидите параметр установки агентов OMS и их настройки для мониторинга в представлении **Общие параметры**. Как объяснялось выше, если вы уже установили и настроили агенты OMS, щелкните представление **установки** для настройки возможностей, в которых вы заинтересованы.  

    **Представление мониторинга производительности**: выберите протокол для искусственных транзакций в правиле системного монитора по умолчанию и нажмите кнопки "Сохранить" и "Продолжить". Этот протокол можно выбрать только для правила по умолчанию, генерируемого системой, и вам нужно выбирать его каждый раз, когда вы явно создаете правило мониторинга производительности. Вы всегда можете перейти к параметрам правила по умолчанию на вкладке мониторинга производительности (доступной после завершения начальной настройки) и изменить протокол позднее. Если вы не заинтересованы в функции мониторинга производительности, вы можете отключить правило по умолчанию в соответствующих параметрах на вкладке мониторинга производительности. 

    ![Конфигурация NPM](media/log-analytics-network-performance-monitor/npm-synthetic-transactions.png)
    
    **Представление мониторинга конечной точки службы**: эта функция обеспечивает встроенные предварительно сконфигурированные тесты для мониторинга сетевого подключения к Office 365 и Dynamics 365 из агентов. Выберите службы Office 365 и Dynamics 365, в мониторинге которых вы заинтересованы, установив флажок рядом с ними. Выберите агенты, которых нужно использовать для мониторинга, нажав кнопку добавления агентов. Если вы не хотите использовать эту функцию или хотите настроить ее позже, вы можете пропустить этот шаг и сразу же нажать кнопки **Сохранить** и **Продолжить**.  

    ![Конфигурация NPM](media/log-analytics-network-performance-monitor/npm-service-endpoint-monitor.png)

    **Представление мониторинга ExpressRoute**: нажмите кнопку **Провести обнаружение**, чтобы открыть все частные пиринги ExpressRoute, подключенные к виртуальным сетям в подписке Azure, связанной с этим рабочим пространством Log Analytics.  


    >[!NOTE] 
    > В настоящее время решение обнаруживает только частные пиринги ExpressRoute. 

    >[!NOTE] 
    > Обнаруживаются только те частные пиринги, которые подключены к виртуальным сетям, связанным с подпиской, используемой для этого рабочего пространства Log Analytics. Если ваш канал ExpressRoute подключен к виртуальным сетям за пределами подписки, связанной с этим рабочим пространством, вам необходимо создать рабочее пространство Log Analytics в этих подписках и использовать NPM для мониторинга этих пирингов. 

    ![Конфигурация NPM](media/log-analytics-network-performance-monitor/npm-express-route.png)

    После завершения обнаружения найденные частные пиринги появятся в таблице.  

    ![Конфигурация NPM](media/log-analytics-network-performance-monitor/npm-private-peerings.png)
    
    Мониторинг этих пирингов изначально отключен. Щелкните каждый пиринг, в мониторинге которого вы заинтересованы, и настройте их отслеживание в представлении подробных сведений подсистемы наблюдения за ресурсами справа.  Нажмите кнопку "Сохранить", чтобы сохранить конфигурацию. Дополнительные сведения см. в [настройках мониторинга ExpressRoute]().  

    Как только настройка будет завершена, данные будут заполнены в течение 30–60 минут. Пока решение будет агрегировать данные из вашей сети, в плитке обзора NPM будет отображаться сообщение *Для решения требуется дополнительная настройка*. Когда данные будут собраны и проиндексированы, сообщение на плитке обзора изменится и отобразится сводка о работоспособности сети. Затем вы можете изменить мониторинг узлов, на которых установлены агенты OMS, а также подсети, обнаруженные в вашей среде. 

#### <a name="edit-monitoring-settings-for-subnets-and-nodes"></a>Изменение параметров мониторинга для подсетей и узлов 

Все подсети, в которых установлен хотя бы один агент, приведены на вкладке "Подсети" на странице конфигурации. 


Включение или отключение мониторинга определенных подсетей 

1. Установите или снимите флажок рядом с  **идентификатором подсети**  и то же самое сделайте для параметра  **Используйте для мониторинга** . Вы можете установить или снять флажки для нескольких подсетей. Если мониторинг подсетей отключен, они не отслеживаются, так как агенты останавливают проверку связи с другими агентами. 
2. Выберите узлы, которые требуется отслеживать в определенной подсети, выбрав подсеть из списка и переместив необходимые узлы между списками, содержащими неотслеживаемые и отслеживаемые узлы. В подсеть можно добавить **пользовательское описание**. 
3. Чтобы сохранить конфигурацию, нажмите кнопку **Сохранить**. 

#### <a name="choose-nodes-to-monitor"></a>Выбор узлов для отслеживания

Все узлы, на которых установлен агент, перечислены на вкладке **Узлы**. 

1. Установите флажки возле узлов, которые необходимо отслеживать, и снимите флажки возле тех узлов, мониторинг которых необходимо прекратить. 
2. Установите или снимите флажок  **Используйте для мониторинга** соответственно. 
3. Выберите команду **Сохранить**. 


Настройте функции, в которых вы заинтересованы: 
- [мониторинг производительности](log-analytics-network-performance-monitor-performance-monitor.md#configuration);
- [мониторинг конечной точки службы](log-analytics-network-performance-monitor-performance-monitor.md#configuration);
- [мониторинг ExpressRoute](log-analytics-network-performance-monitor-expressroute.md#configuration).

 

## <a name="data-collection-details"></a>Сведения о сборе данных
Монитор производительности сети использует пакет подтверждения TCP SYN-SYNACK при выборе TCP и ICMP ECHO ICMP ECHO REPLY при выборе ICMP в качестве протокола для сбора сведений о потере и задержке. Для получения сведений о топологии также используется трассировка маршрута.

В следующей таблице приведены методы сбора данных и другие сведения о сборе данных для монитора производительности сети.

| платформа | Direct Agent | Агент SCOM | Хранилище Azure | Нужен ли SCOM? | Отправка данных агента SCOM через группу управления | Частота сбора |
| --- | --- | --- | --- | --- | --- | --- |
| Windows | &#8226; | &#8226; |  |  |  |Подтверждения TCP/сообщения ICMP ECHO отправляются каждые 5 секунд. Данные отправляются каждые 3 минуты. |
 

 
Решение использует искусственные транзакции для оценки работоспособности сети. Агенты OMS, установленные в различных точках сети, обмениваются между собой пакетами TCP или ICMP Echo (в зависимости от выбранного для мониторинга протокола). В процессе агенты узнают время приема-передачи и обнаруживают потерю пакетов, если она есть. Периодически каждый агент выполняет трассировку маршрута к другим агентам, чтобы найти все маршруты в сети, которые необходимо протестировать. Используя эти данные, агенты могут снизить показатели задержки сети и потери пакетов. Тесты повторяются каждые пять секунд, и агенты собирают данные в течение трех минут перед их отправкой в службу Log Analytics. 



>[!NOTE]
> Несмотря на то что агенты часто обмениваются данными друг с другом, они не создают большой объем сетевого трафика во время проведения тестов. Чтобы определить потери и задержки, агенты полагаются только на пакеты подтверждения TCP SYN-SYNACK-ACK. Обмен пакетами данных не происходит. Во время этого процесса агенты взаимодействуют друг с другом только при необходимости, а топология обмена данными между агентами оптимизирована для снижения сетевого трафика.

## <a name="using-the-solution"></a>Использование решения 

### <a name="npm-overview-tile"></a>Плитка обзора NPM 

После включения решения монитора производительности сети на плитке решения на странице обзора появляется краткий обзор работоспособности сети. 

 ![Плитка обзора NPM](media/log-analytics-network-performance-monitor/npm-overview-tile.png)

### <a name="network-performance-monitor-dashboard"></a>Панель мониторинга монитора производительности сети 

На странице **Наиболее частые события работоспособности сети** представлен список последних событий работоспособности и предупреждений в системе, а также время, когда событие стало активным. Событие или предупреждение о работоспособности генерируется всякий раз, когда значение выбранной метрики (потеря, задержка, время отклика или использование пропускной способности) для правила мониторинга превышает пороговое значение. 

На странице  **мониторинга производительности** представлена ​​сводка работоспособности соединений сети и подсети, отслеживаемых решением. Плитка топологии уведомляет о количестве отслеживаемых сетевых путей в вашей сети. Если щелкнуть эту плитку, вы перейдете в представление топологии. 

На странице  **мониторинга конечной точки службы** вы найдете сводные данные работоспособности различных созданных вами тестов. Плитка топологии уведомляет о количестве отслеживаемых конечных точек. Если щелкнуть эту плитку, вы перейдете в представление топологии.

На странице  **мониторинга ExpressRoute** представлена ​​сводка работоспособности различных пиринговых подключений ExpressRoute, отслеживаемых решением. Плитка топологии уведомляет о количестве отслеживаемых в вашей сети сетевых путей через каналы ExpressRoute. Если щелкнуть эту плитку, вы перейдете в представление топологии.

На странице  **стандартных запросов** содержится набор поисковых запросов, которые непосредственно получают необработанные данные мониторинга сети. Эти запросы можно использовать как отправную точку для создания собственных запросов для настраиваемых отчетов. 

![Панель мониторинга NPM](media/log-analytics-network-performance-monitor/npm-dashboard.png)

 

### <a name="drill-down-for-depth"></a>Углубленное изучение 

Вы можете щелкнуть различные ссылки на панели мониторинга решений, чтобы узнать больше о любой интересующей вас области. Например, когда на панели мониторинга отображается предупреждение или неработоспособное сетевое соединение, его можно щелкнуть для дальнейшего изучения. Вы будете перенаправлены на страницу, на которой приведены все соединения подсети, относящиеся к конкретному сетевому соединению. Там вы можете увидеть показатели потери, задержки и работоспособности каждого соединения подсети и быстро узнать, какие соединения подсети являются причиной проблемы. Вы также можете щелкнуть  **Просмотреть ссылки на узлы** , чтобы просмотреть все соединения узлов, связанные с неработоспособным соединением подсети. Затем можно просмотреть отдельные соединения между узлами и найти неработоспособные соединения узлов. 

Выберите  **Просмотреть топологию** , чтобы просмотреть топологию по прыжкам маршрута между исходным узлом и узлом назначения. Неработоспособные маршруты выделены красным цветом, что дает возможность просмотреть задержку, вызванную каждым прыжком, чтобы быстро идентифицировать проблему в определенной части сети. 

 

### <a name="network-state-recorder"></a>Запись состояния сети 

Каждое представление отображает моментальный снимок работоспособности сети в определенный момент времени. По умолчанию отображается последнее состояние. На панели в верхней части страницы отображается точка времени, для которой отображается состояние. Вы можете вернуться назад во времени и просмотреть моментальный снимок работоспособности сети, щелкнув панель "Действия". Также во время просмотра актуального состояния можно включить или отключить автоматическое обновление для любой страницы. 

 ![Запись состояния сети](media/log-analytics-network-performance-monitor/network-state-recorder.png)

 

### <a name="trend-charts"></a>Диаграммы трендов 

На каждом уровне, который вы детально изучаете, вы можете увидеть тенденцию применимой метрики — потерю, задержку, время отклика, использование пропускной способности. Вы можете изменить интервал времени для тенденции с помощью элемента управления временем в верхней части диаграммы. 

На диаграммах трендов отображается историческая справка об эффективности метрики производительности. Некоторые проблемы с сетью временные и их трудно обнаружить только на основе текущего состояния сети. Это объясняется тем, что проблемы могут быстро появиться и исчезнуть, прежде чем их кто-либо заметит. Они появятся вновь чуть позднее. Такие временные проблемы также создают сложности для администраторов приложений, так как они часто проявляются в виде необъяснимых увеличений времени отклика приложения, даже если все компоненты приложения работают стабильно. 

Вы можете легко обнаружить проблемы такого рода, просмотрев диаграмму тренда, где проблема будет отображаться в виде внезапного пика задержки сети или потери пакетов. Затем вы можете изучить проблему с помощью регистратора сетевого состояния, чтобы просмотреть сетевой моментальный снимок и топологию для точки во времени, когда возникла проблема. 

 
![Диаграммы трендов](media/log-analytics-network-performance-monitor/trend-charts.png)
 

### <a name="topology-map"></a>Карта топологии 

Монитор производительности сети отображает топологию по прыжкам маршрутов между конечной точкой источника и назначения на интерактивной карте топологии. Вы можете просмотреть карту топологии, щелкнув плитку **Топология** на панели мониторинга решения или ссылку **Просмотреть топологию** на страницах детализации.  

На карте топологии отображаются количество маршрутов между конечной точкой источника и назначения и пути, по которым передаются пакеты данных. Также отображается задержка, вызываемая каждым прыжком в сети. Все пути, для которых общая задержка пути превышает пороговое значение (установленное в соответствующем правиле мониторинга), отображаются красным цветом.  

Если щелкнуть узел или навести на него указатель мыши на карте топологии, отобразятся его свойства, например полное доменное имя и IP-адрес. Нажмите кнопку прыжка, чтобы увидеть IP-адрес. Вы можете определить нежелательный прыжок в сети, сопоставив с ним время задержки. Вы можете фильтровать определенные маршруты с помощью фильтров на свертываемой панели действий. Вы также можете упрощать топологии сети, скрывая промежуточные прыжки с помощью ползунка на панели действий. Масштаб карты топологии можно увеличить или уменьшить с помощью колесика мыши. 

Обратите внимание, что топология, показанная на карте, — это топология уровня 3, которая не содержит устройства и подключения уровня 2. 

 
![Карта топологии](media/log-analytics-network-performance-monitor/topology-map.png)
 

## <a name="log-analytics-search"></a>Поиск в Log Analytics 

Все данные, графически представленные на панели мониторинга монитора производительности сети и страницах детализации, также доступны непосредственно через [поиск в Log Analytics](log-analytics-log-search-new.md). Вы можете выполнять интерактивный анализ данных в репозитории, сопоставлять данные из разных источников, создавать настраиваемые оповещения, создавать пользовательские представления и экспортировать данные в Excel, PowerBI или ссылку с общим доступом. В области "Общие запросы" на панели мониторинга содержатся некоторые полезные запросы, которые можно использовать в качестве отправной точки для создания собственных запросов и отчетов. 

 

## <a name="provide-feedback"></a>Отзывы 

**UserVoice.** Если вы хотите, чтобы мы разработали новые функции для монитора производительности сети, здесь вы можете публиковать свои идеи. Посетите нашу  [страницу UserVoice](https://feedback.azure.com/forums/267889-log-analytics/category/188146-network-monitoring). 

**Присоединяйтесь к когорте наших клиентов.**  Мы всегда заинтересованы в новых клиентах. Став одним из них, вы получаете доступ к новым функциям и помогаете нам улучшить монитор производительности сети. Если вы хотите присоединиться к нам, пройдите этот  [быстрый опрос](https://aka.ms/npmcohort). 

## <a name="next-steps"></a>Дополнительная информация 
- Дополнительные сведения о [мониторинге производительности](log-analytics-network-performance-monitor-performance-monitor.md), [мониторинге конечной точки службы](log-analytics-network-performance-monitor-performance-monitor.md) и [мониторинге ExpressRoute](log-analytics-network-performance-monitor-expressroute.md). 
