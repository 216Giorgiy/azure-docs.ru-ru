---
title: "Решение служб анализа SQL Azure в Log Analytics | Документация Майкрософт"
description: "Решение служб анализа SQL Azure поможет вам управлять базами данных SQL Azure."
services: log-analytics
documentationcenter: 
author: bandersmsft
manager: carmonm
editor: 
ms.assetid: b2712749-1ded-40c4-b211-abc51cc65171
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/22/2017
ms.author: banders
translationtype: Human Translation
ms.sourcegitcommit: 503cf4afba4575492984891a681c187a8683a553
ms.openlocfilehash: 9d8fd7ec594671e1ea7bf06459494f1c3a1adbdf
ms.lasthandoff: 02/23/2017


---


# <a name="monitor-azure-sql-database-using-azure-sql-analytics-preview-in-log-analytics"></a>Мониторинг базы данных SQL Azure с помощью служб анализа SQL Azure (предварительная версия) в Log Analytics

Решение мониторинга SQL Azure в Azure Log Analytics собирает и отображает важные метрики производительности SQL Azure. На основе этих метрик можно создавать пользовательские правила мониторинга и оповещения. Вы можете отслеживать метрики базы данных SQL Azure и эластичных пулов в нескольких подписках Azure и эластичных пулах, а также визуализировать их. Решение также поможет вам определить проблемы на каждом уровне стека приложений.  Оно использует [метрики диагностики Azure](log-analytics-azure-storage.md) с представлениями Log Analytics, чтобы представить данные обо всех базах данных SQL Azure и эластичных пулах в единой рабочей области Log Analytics.

Сейчас эта предварительная версия решения поддерживает 150 000 баз данных SQL Azure и 5 000 эластичных пулов SQL на каждую рабочую область.

Решение для мониторинга SQL Azure, как и другие решения, доступные для Log Analytics, помогает отслеживать и получать уведомления о работоспособности ресурсов Azure — в данном случае о базах данных SQL Azure. База данных SQL Microsoft Azure представляет собой масштабируемую службу реляционных баз данных, предоставляющую возможности, аналогичные возможностям SQL Server, в приложениях, запущенных в облаке Azure. Log Analytics помогает собирать, коррелировать и визуализировать структурированные и неструктурированные данные.

## <a name="connected-sources"></a>Подключенные источники

В отличие от большинства других решений Log Analytics решение для мониторинга SQL Azure не использует агенты для подключения к службе Log Analytics.

В следующей таблице описаны подключенные источники, которые поддерживаются этим решением.

| Подключенный источник | Поддержка | Описание |
| --- | --- | --- |
| [Агенты Windows](log-analytics-windows-agents.md) | Нет | Решение не использует прямые агенты Windows. |
| [Агенты Linux](log-analytics-linux-agents.md) | Нет | Решение не использует прямые агенты Linux. |
| [Группы управления SCOM](log-analytics-om-agents.md) | Нет | Решение не использует прямое подключение агента SCOM к Log Analytics. |
| [Учетная запись хранения Azure](log-analytics-azure-storage.md) | Да | Данные метрик Azure отправляются в Log Analytics с использованием учетной записи хранения. |

## <a name="prerequisites"></a>Предварительные требования

1. Подписка Azure. Если у вас ее нет, вы можете создать ее [бесплатно](https://azure.microsoft.com/free/).
2. Рабочая область Log Analytics. Вы можете использовать имеющуюся рабочую область или же [создать ее](log-analytics-get-started.md), прежде чем начать использовать это решение.
3. Включите систему диагностики Azure для баз данных SQL Azure и эластичных пулов и [настройте для них отправку данных в Log Analytics](https://blogs.technet.microsoft.com/msoms/2017/01/17/enable-azure-resource-metrics-logging-using-powershell/).

## <a name="configuration"></a>Конфигурация

Чтобы добавить решение для мониторинга SQL Azure в рабочую область, сделайте следующее.

1. Добавьте решение для мониторинга SQL Azure в рабочую область, как описано в статье [Добавление решений для управления Operations Management Suite (OMS)](log-analytics-add-solutions.md).
2. На портале Azure щелкните **Создать** (знак +), а затем в списке ресурсов выберите **Мониторинг и управление**.  
    ![Мониторинг и управление](./media/log-analytics-azure-sql/monitoring-management.png)
3. В списке **Мониторинг и управление** щелкните **Показать все**.
4. В списке **Рекомендуется** выберите **More** (Дополнительно), а затем в новом списке найдите и выберите **Службы анализа SQL Azure (предварительная версия)**.  
    ![Решение служб анализа SQL Azure](./media/log-analytics-azure-sql/azure-sql-solution-portal.png)
5. В колонке **Службы анализа SQL Azure (предварительная версия)** щелкните **Создать**.  
    ![Создание](./media/log-analytics-azure-sql/portal-create.png)
6. В колонке **Создание решения** выберите рабочую область, в которую необходимо добавить решение, а затем нажмите кнопку **Создать**.  
    ![Добавление в рабочую область](./media/log-analytics-azure-sql/add-to-workspace.png)


### <a name="to-configure-multiple-azure-subscriptions"></a>Настройка нескольких подписок Azure

Чтобы обеспечить поддержку нескольких подписок, используйте сценарий PowerShell. Дополнительные сведения см. в статье [Enable Azure resource metrics logging using PowerShell](https://blogs.technet.microsoft.com/msoms/2017/01/17/enable-azure-resource-metrics-logging-using-powershell/) (Включение ведения журнала метрик ресурсов Azure с помощью PowerShell). Укажите идентификатор ресурса рабочей области в качестве параметра при выполнении скрипта для отправки диагностических данных из ресурсов в одной подписке Azure в рабочую область в другой подписке Azure.

**Пример**

```
PS C:\> $WSID = "/subscriptions/<subID>/resourcegroups/oms/providers/microsoft.operationalinsights/workspaces/omsws"
```

```
PS C:\> .\Enable-AzureRMDiagnostics.ps1 -WSID $WSID
```

## <a name="using-the-solution"></a>Использование решения

Вместе с решением в рабочую область добавляется элемент служб анализа SQL Azure. Кроме того, он появляется в общих сведениях. В элементе отображаются сведения о количестве баз данных и эластичных пулов SQL Azure, к которым подключено решение.

![Элемент служб анализа SQL Azure](./media/log-analytics-azure-sql/azure-sql-sol-tile.png)

### <a name="viewing-azure-sql-monitoring-data"></a>Просмотр данных мониторинга SQL Azure

Щелкните элемент **Azure SQL Monitoring** (Мониторинг SQL Azure), чтобы открыть панель мониторинга служб анализа SQL Azure. Панель мониторинга содержит столбцы, перечисленные в приведенной ниже таблице. В каждом столбце содержится максимум десять элементов, соответствующих таким указанным критериям, как область действия и диапазон времени. Можно выполнить поиск по журналам, в результате которого возвращаются все записи, если щелкнуть заголовок этого столбца или **Показать все** внизу столбца.

Дополнительные сведения см. в статье [Параметры базы данных SQL и производительность: возможности разных уровней служб](../sql-database/sql-database-service-tiers.md).



![Панель мониторинга служб анализа SQL Azure](./media/log-analytics-azure-sql/azure-sql-dash-01.png)



![Панель мониторинга служб анализа SQL Azure](./media/log-analytics-azure-sql/azure-sql-dash-02.png)

| столбец | Описание |
| --- | --- |
| **Службы анализа баз данных SQL Azure** | &nbsp; |
| Первые N баз данных с показателем использования DTU &gt; 90 % | В этой области отображаются сведения о количестве баз данных SQL Azure с показателем использования DTU более 90 % за выбранное время. В первом элементе отображаются сведения о количестве баз данных, использовавших более 90 % от общего объема выделенных доступных DTU за указанное время, среди всех баз данных, которые отслеживаются в Log Analytics.  Щелкните имя базы данных, чтобы выполнить поиск по журналам. В результате отобразится график, в котором сравнивается использование DTU определенной базой данных и другими базами данных, отслеживаемых рабочей областью. |
| Первые N баз данных с показателем использования ЦП &gt; 90 % | В этой области отображаются сведения о количестве баз данных SQL Azure с показателем использования ЦП более 90 % за выбранное время. В первом элементе отображаются сведения о количестве баз данных, использовавших более 90 % от общего выделенного объема ЦП за указанное время, среди всех баз данных, которые отслеживаются в Log Analytics.  Щелкните имя базы данных, чтобы выполнить поиск по журналам. В результате отобразится график, в котором сравнивается использование ЦП определенной базой данных и другими базами данных, отслеживаемых рабочей областью. |
| Первые N баз данных с показателем использования хранилища &gt; 90 % | В этой области отображаются сведения о количестве баз данных SQL Azure, которые использовали более 90 % выделенного объема хранилища за выбранное время. В первом элементе отображаются сведения о количестве баз данных, которые превысили показатель 90 % за указанное время, среди всех баз данных, отслеживаемых в Log Analytics.  Щелкните имя базы данных, чтобы выполнить поиск по журналам. В результате отобразится график, в котором сравнивается объем хранилища, используемый базой данных и другими базами данных, отслеживаемыми рабочей областью. |
| **Эластичные пулы SQL Azure** | &nbsp; |
| Первые N эластичных пулов с показателем использования DTU &gt; 90 % | В этой области отображаются сведения о количестве эластичных пулов SQL Azure, использовавших более 90 % от общего выделенного количества DTU за выбранное время. В первом элементе отображаются сведения о количестве эластичных пулов, которые превысили показатель 90 % за указанное время, среди всех эластичных пулов SQL Azure, отслеживаемых в Log Analytics.  Щелкните имя эластичного пула, чтобы выполнить поиск по журналам. В результате отобразится график, в котором сравнивается объем хранилища, используемого эластичным пулом и другими пулами, которые отслеживаются рабочей областью. |
| Первые N эластичных пулов с показателем использования ЦП &gt; 90 % | В этой области отображаются сведения о количестве эластичных пулов SQL Azure, использовавших более 90 % ЦП за выбранное время. В первом элементе отображаются сведения о количестве эластичных пулов, которые превысили показатель 90 % за указанное время, среди всех эластичных пулов SQL Azure, отслеживаемых в Log Analytics.  Щелкните имя эластичного пула, чтобы выполнить поиск по журналам. В результате отобразится график, в котором сравнивается объем ЦП, используемый эластичным пулом и другими пулами, которые отслеживаются рабочей областью. |
| Первые N эластичных пулов с показателем использования хранилища &gt; 90 % | В этой области отображаются сведения о количестве эластичных пулов SQL Azure, использовавших более 90 % от выделенного объема хранилища за выбранное время. В первом элементе отображаются сведения о количестве эластичных пулов, которые превысили показатель 90 % за указанное время, среди всех эластичных пулов, отслеживаемых в Log Analytics.  Щелкните имя эластичного пула, чтобы выполнить поиск по журналам. В результате отобразится график, в котором сравнивается объем хранилища, используемого эластичным пулом и другими пулами, которые отслеживаются рабочей областью. |
| **Журналы действий SQL Azure** | &nbsp; |
| Аудит действий SQL Azure | В этой области отображаются сведения о количестве записей о действиях Azure для SQL Azure за выбранное время. Щелкните элемент, чтобы выполнить поиск по журналам, в результате которого вы получите дополнительные сведения об элементе. |



### <a name="analyze-data-and-create-alerts"></a>Анализ данных и создание оповещений

Решение включает полезные запросы для выполнения анализа данных. Если прокрутить вправо, на панели мониторинга отображается несколько общих запросов, которые можно щелкнуть для выполнения [поиска по журналам](log-analytics-log-searches.md) для данных SQL Azure.

![Запросы](./media/log-analytics-azure-sql/azure-sql-queries.png)

Решение включает некоторые *запросы на основе оповещений* (как показано выше), используя которые можно создать предупреждения по определенным пороговым значениям для баз данных и эластичных пулов SQL Azure.

#### <a name="to-configure-an-alert-for-your-workspace"></a>Чтобы настроить оповещение для рабочей области, сделайте следующее.

1. Перейдите на [портал OMS](http://mms.microsoft.com/) и войдите в систему.
2. Откройте рабочую область, настроенную для решения.
3. На странице обзора щелкните элемент **Службы анализа SQL Azure (предварительная версия)**.
4. Чтобы приступить к созданию оповещения, прокрутите вправо и щелкните запрос.  
![Запрос на оповещение](./media/log-analytics-azure-sql/alert-query.png)
5. В поиске по журналам щелкните **Оповещение**.  
![Создание оповещения в поиске](./media/log-analytics-azure-sql/create-alert01.png)
6. На странице **Добавить правило оповещения** настройте соответствующие свойства и определенные пороговые значения, а затем нажмите кнопку **Сохранить**.  
![Добавление правила оповещения](./media/log-analytics-azure-sql/create-alert02.png)

### <a name="act-on-azure-sql-monitoring-data"></a>Выполнение действий с данными мониторинга SQL Azure

К примеру, один из наиболее полезных запросов, которые можно выполнить, заключается в сравнении использования DTU для всех эластичных пулов SQL Azure во всех подписках Azure. Единица пропускной способности базы данных (DTU) выражает относительную емкость уровня производительности пулов и баз данных уровня "Базовый", "Стандартный" и "Премиум". Единицы DTU получают на основе показателей ЦП, памяти, операций чтения и записи. С увеличением числа единиц DTU увеличивается также и мощность, предлагаемая на уровне производительности. Например, уровень производительности с 5 единицами DTU в пять раз выше уровня производительности с 1 единицей DTU. К каждому серверу и эластичному пулу применяется максимальная квота DTU.

Выполнив следующий запрос поиска по журналам, вы можете легко определить степень использования эластичных пулов SQL Azure.

```
Type=AzureMetrics ResourceId=*"/ELASTICPOOLS/"* MetricName=dtu_consumption_percent | measure avg(Average) by Resource | display LineChart
```

Как видно из примера ниже, в одном эластичном пуле используется практически 100 % единиц DTU, тогда как показатели других чрезвычайно низкие. С помощью журналов действий Azure вы можете устранить потенциальные последние изменения в окружении.

![Результаты поиска по журналам. Высокая загрузка](./media/log-analytics-azure-sql/log-search-high-util.png)

## <a name="see-also"></a>См. также

- Используйте [поиск по журналам](log-analytics-log-searches.md) в Log Analytics для просмотра подробных данных SQL Azure.
- [Создавайте пользовательские панели мониторинга](log-analytics-dashboards.md), отображающие данные SQL Azure.
- [Создавайте оповещения](log-analytics-alerts.md), предупреждающие о возникновении определенных событий SQL Azure.

