<properties
	pageTitle="Подключение компьютеров Linux к Log Analytics | Microsoft Azure"
	description="Log Analytics позволяет собирать и обрабатывать данные, созданные компьютерами Linux."
	services="log-analytics"
	documentationCenter=""
	authors="bandersmsft"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="log-analytics"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="04/19/2016"
	ms.author="banders"/>

# Подключение компьютеров Linux к Log Analytics

Log Analytics позволяет собирать и обрабатывать данные, созданные компьютерами Linux. Добавив данные, собранные с компьютера Linux, в OMS, вы можете управлять системами Linux и решениями контейнера, например Docker, практически из любого места. Таким образом, источники данных могут находиться в локальном центре обработки данных в качестве физических серверов, на виртуальных компьютерах в облачной службе, такой как Amazon Web Services (AWS) или Microsoft Azure, или даже на настольном ноутбуке. Кроме того, OMS аналогичным образом собирает данные с компьютеров Windows. Так что это решение поддерживает гибридную ИТ-среду.

С помощью Log Analytics в OMS можно просматривать данные из всех этих источников и управлять ими на едином портале управления. Поэтому вам не нужно отслеживать решение с помощью разных систем, его использование упрощается, а все необходимые данные можно экспортировать в любое существующее решение или систему бизнес-аналитики.

Эта статья представляет собой краткое руководство, которое поможет выполнить сбор данных и управлять ими на компьютерах Linux с помощью агента OMS для Linux. Дополнительные технические сведения см. в [обзоре агента OMS для Linux](https://github.com/Microsoft/OMS-Agent-for-Linux) и в [полной документации по агенту OMS для Linux](https://github.com/Microsoft/OMS-Agent-for-Linux/blob/master/docs/OMS-Agent-for-Linux.md) на Github.


В настоящее время с компьютеров Linux можно собирать данные следующих типов:

- Метрики производительности
- события системного журнала;
- оповещения Nagios и Zabbix;
- метрики производительности, данные инвентаризации и журналов контейнера Docker.

## Поддерживаемые версии Linux

x86 и x64 являются официально поддерживаемыми версиями в различных дистрибутивах Linux. Однако агент OMS для Linux может выполняться и на других дистрибутивах, помимо следующих:

- выпуски Amazon Linux 2012.09–2015.09;
- CentOS Linux 5,6 и 7;
- Oracle Linux 5,6 и 7;
- сервер Red Hat Enterprise Linux 5,6 и 7;
- Debian GNU/Linux 6, 7 и 8;
- Ubuntu 12.04 LTS, 14.04 LTS, 15.04, 15.10;
- SUSE Linux Enterprise Server 11 и 12.

## Агент OMS для Linux
Агент Operations Management Suite для Linux состоит из нескольких пакетов. Файл выпуска содержит указанные ниже пакеты, к которым можно получить доступ, запустив пакет оболочки с помощью команды `--extract`.

**Package** | **Версия** | **Описание**
----------- | ----------- | --------------
omsagent | 1\.1.0 | Агент Operations Management Suite для Linux
omsconfig | 1\.1.1 | Агент конфигурации для агента OMS
omi | 1\.0.8.3 | OMI (Open Management Infrastructure) — упрощенная версия сервера CIM
scx | 1\.6.2 | Поставщики OMI CIM для метрик производительности операционной системы
apache-cimprov | 1\.0.0 | Поставщик мониторинга производительности сервера Apache HTTP Server для OMI. Устанавливается только при обнаружении сервера Apache HTTP Server
mysql-cimprov | 1\.0.0 | Поставщик мониторинга производительности сервера MySQL для OMI. Устанавливается только при обнаружении сервера MySQL или MariaDB
docker-cimprov | 0\.1.0 | Поставщик Docker для OMI. Устанавливается только при обнаружении Docker

### Дополнительные артефакты установки
После установки пакетов агента OMS для Linux применяются системные изменения конфигурации, приведенные ниже. Эти артефакты удаляются после удаления пакета omsagent.
- Создается непривилегированный пользователь с именем `omsagent`. Это учетная запись, под которой запускается управляющая программа omsagent.
- Создается файл sudoers с директивами include в каталоге /etc/sudoers.d/omsagent. Таким образом пользователь omsagent получает право на перезапуск управляющих программ syslog и omsagent. Если директивы include sudo не поддерживаются в установленной версии sudo, эти записи будут записываться в каталог /etc/sudoers.
- Конфигурация системного журнала настраивается для перенаправления подмножества событий агенту. Дополнительные сведения см. в разделе **Настройка сбора данных** ниже.

### Сведения о сборе данных Linux

В следующей таблице содержатся методы сбора данных и другие связанные сведения.

| источник | Direct Agent | Агент SCOM | Хранилище Azure | Нужен ли SCOM? | Отправка данных агента SCOM через группу управления | Частота сбора |
|---|---|---|---|---|---|---|
|Zabbix|![Да](./media/log-analytics-linux-agents/oms-bullet-green.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)| ![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|1 минута|
|Nagios|![Да](./media/log-analytics-linux-agents/oms-bullet-green.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)| ![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|При получении|
|syslog|![Да](./media/log-analytics-linux-agents/oms-bullet-green.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)| ![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|Из хранилища Azure — 10 минут, из агента — при получении|
|Счетчики производительности Linux|![Да](./media/log-analytics-linux-agents/oms-bullet-green.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)| ![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|По расписанию, не менее 10 секунд|
|Отслеживание изменений|![Да](./media/log-analytics-linux-agents/oms-bullet-green.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)| ![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|![Нет](./media/log-analytics-linux-agents/oms-bullet-red.png)|Ежечасно|



### Требования к пакетам
| **Требуемый пакет** | **Описание** | **Минимальная версия**|
|--------------------- | --------------------- | -------------------|
|Glibc |	Библиотека C GNU | 2\.5-12|
|Openssl | Библиотеки OpenSSL | 0\.9.8e или 1.0|
Curl | Веб-клиент cURL | 7\.15.5
|Python-ctypes |Библиотеки функций | Недоступно|
|PAM | Подключаемые модули аутентификации |Недоступно |

>[AZURE.NOTE] Для сбора сообщений системного журнала требуется rsyslog или syslog-ng. Управляющая программа syslog по умолчанию не поддерживается для сбора событий системного журнала в Red Hat Enterprise Linux версии 5, CentOS и Oracle Linux (sysklog). Чтобы собирать данные системного журнала из дистрибутивов этих версий, требуется установить и настроить управляющую программу rsyslog, которая заменит sysklog.

## Быстрая установка

Выполните следующие команды, чтобы скачать omsagent, проверить контрольную сумму, а также установить и внедрить агент. Команды предназначены для 64-разрядных систем. Идентификатор рабочей области и первичный ключ можно найти на портале OMS в разделе **Параметры** на вкладке **Connected Sources** (Подключенные источники).

![сведения о рабочей области](./media/log-analytics-linux-agents/oms-direct-agent-primary-key.png)

```
wget https://github.com/Microsoft/OMS-Agent-for-Linux/releases/download/v1.1.0-28/omsagent-1.1.0-28.universal.x64.sh
sha256sum ./omsagent-1.1.0-28.universal.x64.sh
sudo sh ./omsagent-1.1.0-28.universal.x64.sh --upgrade -w <YOUR OMS WORKSPACE ID> -s <YOUR OMS WORKSPACE PRIMARY KEY>
```

Существует множество других методов установки и обновления агента. Дополнительные сведения об этих методах см. в разделе [Установка агента OMS для Linux](https://github.com/Microsoft/OMS-Agent-for-Linux/blob/master/docs/OMS-Agent-for-Linux.md#steps-to-install-the-oms-agent-for-linux).


## Выбор метода сбора данных Linux

Выбор типов данных для сбора зависит от того, хотите ли вы использовать портал OMS или изменять различные файлы конфигурации непосредственно в клиентах Linux. Если вы решили использовать портал, конфигурация автоматически отправляется на все клиентские компьютеры Linux. Если требуются различные конфигурации для различных клиентов Linux, клиентские файлы потребуется изменять по отдельности или воспользоваться альтернативным вариантом, например средствами PowerShell DSC, Chef или Puppet.

События системного журнала и счетчиков производительности, данные которых нужно собирать, можно указать с помощью файлов конфигурации на компьютерах Linux. *Выбрав настройку сбора данных путем изменения файлов конфигурации агента, следует отключить централизованную конфигурацию.* Ниже представлены инструкции по настройке сбора данных в файлах конфигурации агента, а также по отключению центральной конфигурации для всех агентов OMS для Linux или отдельных компьютеров.

### Отключение управления OMS для отдельного компьютера Linux

Централизованный сбор данных конфигурации для отдельного компьютера Linux отключается с помощью скрипта OMS\_MetaConfigHelper.py. Это может быть полезно, если подмножеству компьютеров требуется специальная конфигурация.

Чтобы отключить централизованную конфигурацию, выполните следующую команду:

```
sudo /opt/microsoft/omsconfig/Scripts/OMS_MetaConfigHelper.py --disable
```

Чтобы включить централизованную конфигурацию, выполните следующую команду:

```
sudo /opt/microsoft/omsconfig/Scripts/OMS_MetaConfigHelper.py –enable
```

## Счетчики производительности Linux

Счетчики производительности Linux функционируют подобно счетчикам производительности Windows. Чтобы добавить и настроить их, можно использовать шаги, приведенные ниже. После добавления счетчиков производительности в OMS сбор данных для них осуществляется каждые 30 секунд.

### Добавление счетчиков производительности Linux в OMS

1. Чтобы настроить агенты OMS для Linux с помощью портала OMS, можно добавить счетчики производительности Linux на странице "Параметры" и щелкнуть **Данные**. ![data](./media/log-analytics-linux-agents/oms-settings-data01.png)
2. На странице **Параметры** в разделе **Данные** щелкните **Linux performance counters** (Счетчики производительности Linux) и слева от значка плюса введите имя счетчика, который нужно добавить. ![счетчики производительности Linux](./media/log-analytics-linux-agents/oms-linuxperfcounter01.png)
3. Если полное имя счетчика неизвестно, можно начать вводить часть имени, после чего отобразится список доступных счетчиков. Найдя счетчик, который требуется добавить, щелкните его имя в списке и значок плюса.
4. После добавления счетчика он появляется в списке счетчиков, выделенный цветной линией.
5. По умолчанию установлен флажок **Apply below configuration to my machines** (Применить конфигурации ниже к моим компьютерам). Если нужно отключить отправку данных конфигурации, снимите этот флажок.
6. Закончив изменение счетчиков производительности, нажмите кнопку **Сохранить** в нижней части страницы, чтобы завершить изменения. Затем выполненные изменения конфигурации отправляются во все агенты OMS для Linux, зарегистрированные в OMS. Обычно это занимает 5 минут.

### Настройка счетчиков производительности Linux в OMS

Для каждого счетчика производительности Windows можно выбрать конкретный экземпляр. Однако в случае счетчиков производительности Linux любой экземпляр выбранного счетчика применяется ко всем дочерним счетчикам родительского счетчика. В следующей таблице представлены распространенные экземпляры для счетчиков производительности Linux и Windows.

| **Имя экземпляра** | **Значение** |
| --- | --- |
| \_Total | Общее количество всех экземпляров |
| * | Все экземпляры |
| (/|/var) | Сопоставление экземпляров с именем / или/var |


Аналогичным образом, интервал выборки, выбранный для родительского счетчика, применяется ко всем дочерним счетчикам. Другими словами, все интервалы выборки и экземпляры дочерних счетчиков связаны друг с другом.

### Добавление и настройка метрик производительности в Linux

Собираемые метрики производительности определяются конфигурацией в файле /etc/opt/microsoft/omsagent/conf/omsagent.conf. Сведения о доступных классах и метриках для агента OMS для Linux см. [здесь](https://github.com/Microsoft/OMS-Agent-for-Linux/blob/master/docs/OMS-Agent-for-Linux.md#appendix-available-performance-metrics).

Каждый объект или категорию метрики производительности для сбора следует определить в файле конфигурации в качестве одного элемента `<source>`. Синтаксис соответствует шаблону ниже.

```
<source>
  type oms_omi  
  object_name "Processor"
  instance_regex ".*"
  counter_name_regex ".*"
  interval 30s
</source>

```

Для этого элемента можно настроить следующие параметры:

- **Object\_name** — имя объекта в коллекции.
- **Instance\_regex** — *регулярное выражение*, определяющее экземпляры, которые следует собирать. Значение `.*` указывает все экземпляры. Для сбора метрик процессора только для экземпляра \_Total можно указать `_Total`. Для сбора метрик обработки только для экземпляра crond или sshd можно указать `(crond|sshd)`.
- **Counter\_name\_regex** — *регулярное выражение*, определяющее счетчики для сбора (для объекта). Для сбора всех счетчиков для объекта укажите `.*`. Для сбора только счетчиков области подкачки для объекта памяти можно указать `.+Swap.+`
- **Interval** — частота сбора счетчиков объекта.

Конфигурация по умолчанию для метрики производительности:

```
<source>
  type oms_omi
  object_name "Physical Disk"
  instance_regex ".*"
  counter_name_regex ".*"
  interval 5m
</source>

<source>
  type oms_omi
  object_name "Logical Disk"
  instance_regex ".*
  counter_name_regex ".*"
  interval 5m
</source>

<source>
  type oms_omi
  object_name "Processor"
  instance_regex ".*
  counter_name_regex ".*"
  interval 30s
</source>

<source>
  type oms_omi
  object_name "Memory"
  instance_regex ".*"
  counter_name_regex ".*"
  interval 30s
</source>

```

### Включение счетчиков производительности MySQL с помощью команд Linux

Если при установке пакета omsagent на компьютере обнаружен сервер MySQL или MariaDB, поставщик мониторинга производительности устанавливается автоматически для сервера MySQL. Этот поставщик подключается к локальному серверу MySQL или MariaDB, чтобы предоставить статистику производительности. Чтобы поставщик смог получить доступ к серверу MySQL, необходимо настроить учетные данные пользователя MySQL.

Чтобы определить учетную запись пользователя по умолчанию для сервера MySQL для localhost, используйте в качестве примера команду ниже.

>[AZURE.NOTE] Файл учетных данных должен быть доступен для чтения для учетной записи omsagent. Рекомендуется выполнить команду mycimprovauth, используя учетную запись omsgent.


```
sudo su omsagent -c '/opt/microsoft/mysql-cimprov/bin/mycimprovauth default 127.0.0.1 <username> <password>'

sudo service omiserverd restart
```


Кроме того, необходимые учетные данные MySQL можно указать в файле. Для этого создайте файл /var/opt/microsoft/mysql-cimprov/auth/omsagent/mysql-auth. Дополнительные сведения об управлении учетными данными MySQL для мониторинга с помощью файла mysql-auth см. в разделе [Управление учетными данными MySQL для мониторинга в файле аутентификации](#manage-mysql-monitoring-credentials-in-the-authentication-file).

Дополнительные сведения о разрешениях объектов, необходимых пользователю MySQL для сбора данных производительности сервера MySQL, см. в разделе [Разрешения базы данных, необходимые пользователю MySQL для счетчиков производительности сервера MySQL](#database-permissions-required-for-mysql-performance-counters).

### Включение счетчиков производительности сервера Apache HTTP Server с помощью команд Linux

Если при установке пакета omsagent на компьютере обнаружен сервер Apache HTTP Server, для него автоматически устанавливается поставщик мониторинга производительности. Этот поставщик использует модуль Apache, который нужно загрузить на сервер Apache HTTP Server для доступа к данным производительности.

Модуль можно загрузить с помощью следующей команды:

```
sudo /opt/microsoft/apache-cimprov/bin/apache_config.sh -c
```

Чтобы выгрузить модуль мониторинга Apache, выполните следующую команду:

```
sudo /opt/microsoft/apache-cimprov/bin/apache_config.sh -u
```
### Просмотр данных производительности с помощью Log Analytics

1. На портале Operations Management Suite щелкните плитку поиска по журналам.
2. В строке поиска введите `* (Type=Perf)`, чтобы просмотреть все счетчики производительности.


Так как OMS также собирает данные счетчика производительности Windows, следует ограничить область поиска данными Linux. В следующем примере приведены данные о производительности для сервера Linux с именем Chorizo21.

```
Type=Perf Computer=chorizo*
```

![пример сервера, отображающийся на странице результатов поиска](./media/log-analytics-linux-agents/oms-perfsearch01.png)

В результатах можно щелкнуть **Метрики**, чтобы просмотреть счетчики, для которых осуществлялся сбор данных. Данные в реальном времени отображаются в виде графиков для каждого счетчика.

![metrics](./media/log-analytics-linux-agents/oms-perfmetrics01.png)


## Syslog

Системный журнал — это протокол ведения журнала событий, аналогичный журналу событий Windows. При отображении в OMS они работают одинаково.

### Добавление нового устройства системного журнала Linux в OMS

1. На странице **Параметры** на вкладке **Данные** щелкните раздел **Системный журнал** и слева от значка плюса введите имя устройства системного журнала, которое нужно добавить. ![системный журнал Linux](./media/log-analytics-linux-agents/oms-linuxsyslog01.png)
2.	Если полное имя устройства неизвестно, можно начать вводить часть имени, после чего отобразится список доступных устройств системного журнала. Чтобы добавить найденное устройство системного журнала, щелкните его имя в списке, а затем — значок плюса.
3.	После добавления устройства оно появляется в списке устройств, выделенное цветной линией. Затем выберите степени серьезности (категории сведений устройства системного журнала) для сбора.
4.	В нижней части страницы нажмите кнопку **Сохранить**, чтобы завершить изменения. Затем выполненные изменения конфигурации отправляются во все агенты OMS для Linux, зарегистрированные в OMS. Обычно это занимает 5 минут.


### Настройка устройств системного журнала Linux в Linux

События системного журнала отправляются из управляющей программы syslog, например rsyslog или syslog-ng, в локальный порт, который прослушивает агент. Порт по умолчанию — 25224. При установке агента применяется конфигурация системного журнала по умолчанию. Ее можно найти в следующих каталогах:


rsyslog — /etc/rsyslog.d/rsyslog-oms.conf;

syslog-ng — /etc/syslog-ng/syslog-ng.conf.


При конфигурации по умолчанию передаются события системного журнала агента OMS всех устройств с уровнем серьезности "Предупреждение" или выше.

>[AZURE.NOTE] При изменении конфигурации системного журнала требуется перезапустить управляющую программу syslog, чтобы изменения вступили в силу.

Ниже приведена конфигурация по умолчанию системного журнала для агента OMS для Linux для OMS.

#### При использовании rsyslog:

```
kern.warning       @127.0.0.1:25224
user.warning       @127.0.0.1:25224
daemon.warning     @127.0.0.1:25224
auth.warning       @127.0.0.1:25224
syslog.warning     @127.0.0.1:25224
uucp.warning       @127.0.0.1:25224
authpriv.warning   @127.0.0.1:25224
ftp.warning        @127.0.0.1:25224
cron.warning       @127.0.0.1:25224
local0.warning     @127.0.0.1:25224
local1.warning     @127.0.0.1:25224
local2.warning     @127.0.0.1:25224
local3.warning     @127.0.0.1:25224
local4.warning     @127.0.0.1:25224
local5.warning     @127.0.0.1:25224
local6.warning     @127.0.0.1:25224
local7.warning     @127.0.0.1:25224
```

#### При использовании syslog-ng:

```
#OMS_facility = all
filter f_warning_oms { level(warning); };
destination warning_oms { tcp("127.0.0.1" port(25224)); };
log { source(src); filter(f_warning_oms); destination(warning_oms); };
```

### Просмотр всех событий системного журнала с помощью Log Analytics

1. На портале Operations Management Suite щелкните плитку **поиска по журналам**.
2. В группе **Log Management** (Управление журналом) выберите предопределенный поиск по системному журналу, а затем — системный журнал, для которого требуется выполнить такой поиск.

В этом примере представлены все события системного журнала.

![события системного журнала, отображаемые на странице поиска по журналам](./media/log-analytics-linux-agents/oms-linux-syslog.png)

Теперь вы можете подробно рассмотреть результаты поиска.

## Оповещения Linux

При использовании Nagios или Zabbix для управления компьютерами Linux OMS может получать оповещения, созданные с помощью этих средств. Однако сейчас невозможно настроить данные входящих оповещений на портале OMS. Вместо этого для отправки оповещений в OMS необходимо изменить файл конфигурации.



### Сбор оповещений из Nagios

Для сбора оповещений сервера Nagios необходимо внести следующие изменения в конфигурацию:

1. Предоставьте пользователю **omsagent** доступ для чтения к файлу журнала Nagios (т. е. /var/log/nagios/nagios.log/var/log/nagios/nagios.log). Если файл nagios.log принадлежит группе **nagios**, пользователя **omsagent** можно добавить в группу **nagios**.

    ```
    sudo usermod –a -G nagios omsagent
    ```

2. Измените файл конфигурации omsagent.conf (etc/opt/microsoft/omsagent/conf/omsagent.conf). Для этого введите следующие записи в незакомментированном виде:

    ```
    <source>
    type tail
    #Update path to point to your nagios.log
    path /var/log/nagios/nagios.log
    format none
    tag oms.nagios
    </source>

    <filter oms.nagios>
    type filter_nagios_log
    </filter>
    ```

3. Перезапустите управляющую программу omsagent:

    ```
    sudo service omsagent restart
    ```

### Сбор оповещений из Zabbix

Для сбора оповещений с сервера Zabbix выполните такие же действия, как и для Nagios выше, однако укажите имя пользователя и пароль в *текстовом виде*. Это не очень удобно, но в скором времени это требование может измениться. Чтобы устранить эту проблему, рекомендуется создать пользователя и предоставить ему разрешение только для мониторинга.

Раздел файла конфигурации omsagent.conf (etc/opt/microsoft/omsagent/conf/omsagent.conf) для Zabbix должен выглядеть примерно следующим образом:

```
<source>
  type zabbix_alerts
  run_interval 1m
  tag oms.zabbix
  zabbix_url http://localhost/zabbix/api_jsonrpc.php
  zabbix_username Admin
  zabbix_password zabbix
</source>

```

### Просмотр оповещений с использованием поиска Log Analytics

После настройки компьютеров Linux для отправки оповещений в OMS можно выбрать несколько простых запросов на поиск по журналу для просмотра оповещений. В следующем примере запроса на поиск возвращаются все записанные созданные оповещения. Например, если в ИТ-инфраструктуре возникает какая-либо проблема, ее источник можно определить по результатам в указанном ниже примере запроса. Область исследования можно ограничить, просмотрев подробные сведения об оповещениях исходной системы. Преимущество заключается в том, что вам не нужно сначала просматривать различные системы управления при условии, что оповещения отправляются в OMS. Поиск можно начать прямо в этом решении.

```
Type=Alert
```

#### Просмотр всех событий Nagios с помощью Log Analytics
1. На портале Operations Management Suite щелкните плитку **поиска по журналам**.
2. На панели запросов введите следующий запрос на поиск:

    ```
    Type=Alert SourceSystem=Nagios
    ```
![оповещения Nagios, отображаемые на странице поиска по журналам](./media/log-analytics-linux-agents/oms-linux-nagios-alerts.png)

Просмотрев результаты поиска, можно ознакомиться с дополнительными сведениями, например с *AlertState*.

### Просмотр всех событий Zabbix с помощью Log Analytics
1. На портале Operations Management Suite щелкните плитку **поиска по журналам**.
2. На панели запросов введите следующий запрос на поиск:

    ```
    Type=Alert SourceSystem=Zabbix
    ```
![оповещения Zabbix, отображаемые на странице поиска по журналам](./media/log-analytics-linux-agents/oms-linux-zabbix-alerts.png)

Просмотрев результаты поиска, можно ознакомиться с дополнительными сведениями, например с *AlertName*.


## Совместимость с System Center Operations Manager

Агент OMS для Linux совместно использует двоичные файлы агента с агентом System Center Operations Manager. При установке агента OMS для Linux в системе под управлением Operations Manager пакеты OMI и SCX на компьютере обновляются до более новой версии. Агент OMS для Linux и System Center 2012 R2 совместимы. Тем не менее **System Center 2012 SP1 и более ранние версии не совместимы с агентом OMS для Linux.**

>[AZURE.NOTE] Если агент OMS для Linux устанавливается на компьютер, которым в настоящее время не управляет Operations Manager, но такое управление требуется в будущем, нужно изменить конфигурацию OMI до обнаружения компьютера. **Не нужно выполнять этот шаг, если агент Operations Manager установлен до агента OMS для Linux.**

### Обеспечение взаимодействия агента OMS для Linux с Operations Manager

1. Измените файл /etc/opt/omi/conf/omiserver.conf.
2. Укажите для **httpsport=** номер порта 1270. Таким образом — `httpsport=1270`.
3. Перезапустите сервер OMI, выполнив следующую команду:

    ```
    service omiserver restart or systemctl restart omiserver
    ```




## Разрешения базы данных, необходимые для счетчиков производительности MySQL

Чтобы предоставить разрешения пользователю мониторинга MySQL, у пользователя, предоставляющего разрешения, должна быть привилегия с параметром GRANT, а также предоставляемая привилегия.

Чтобы пользователь MySQL смог возвращать данные о производительности, ему потребуется доступ к следующим запросам:

```
SHOW GLOBAL STATUS;
SHOW GLOBAL VARIABLES:
```

В дополнение к этим запросам пользователю MySQL необходим доступ с разрешением SELECT для следующих таблиц по умолчанию:

- information\_schema;
- mysql

Эти привилегии можно предоставить, выполнив следующие команды:

```
GRANT SELECT ON information_schema.* TO ‘monuser’@’localhost’;
GRANT SELECT ON mysql.* TO ‘monuser’@’localhost’;
```

## Управление учетными данными для мониторинга MySQL в файле аутентификации

В следующих разделах представлены инструкции по управлению учетными данными MySQL.

### Настройка поставщика OMI MySQL

Поставщику OMI MySQL требуется предварительно настроенный пользователь MySQL и установленные клиентские библиотеки MySQL, чтобы запрашивать сведения о производительности и состоянии из экземпляра MySQL.

### Файл аутентификации OMI MySQL

Поставщик OMI MySQL использует файл аутентификации, чтобы определить адрес привязки и порт, который прослушивает экземпляр MySQL, а также учетные данные, которые нужно использовать для сбора метрик. Во время установки поставщик OMI MySQL проверит файлы конфигурации MySQL my.cnf (расположение по умолчанию) для адреса привязки и порта и частично укажет файл аутентификации OMI MySQL.

Чтобы завершить мониторинг экземпляра сервера MySQL, добавьте предварительно созданный файл аутентификации OMI MySQL в соответствующий каталог.

### Формат файла аутентификации

Файл аутентификации OMI MySQL — текстовый файл, содержащий следующие сведения:

- Порт
- адрес привязки;
- имя пользователя MySQL;
- пароль в кодировке Base64.

Файл аутентификации OMI MySQL предоставляет привилегии только для чтения и записи для пользователя Linux, который создал его.

```
[Port]=[Bind-Address], [username], [Base64 encoded Password]
(Port)=(Bind-Address), (username), (Base64 encoded Password)
(Port)=(Bind-Address), (username), (Base64 encoded Password)
AutoUpdate=[true|false]
```

Файл аутентификации OMI MySQL по умолчанию содержит экземпляр по умолчанию и номер порта в зависимости от доступных сведений и данных, полученных в результате анализа найденного файла конфигурации MySQL.

Экземпляр по умолчанию позволяет упростить управление несколькими экземплярами MySQL на одном узле Linux. Он обозначается экземпляром с портом 0. Все добавленные экземпляры наследуют свойства, заданные в экземпляре по умолчанию. Например, при добавлении экземпляра MySQL, который прослушивает порт 3308, для его мониторинга будет использоваться адрес привязки, имя пользователя и пароль в кодировке Base64 экземпляра по умолчанию. Если экземпляр на порте 3308 привязан к другому адресу и использует те же имя пользователя и пароль MySQL, необходимо переопределить только адрес привязки, а другие свойства будут унаследованы.

Содержание файлов аутентификации выглядит, как показано ниже.

Экземпляр по умолчанию и экземпляр с портом 3308:

```
0=127.0.0.1, myuser, cnBwdA==3308=, ,AutoUpdate=true
```

Экземпляр по умолчанию и экземпляр с портом 3308 и другим паролем в кодировке Base 64:

```
0=127.0.0.1, myuser, cnBwdA==3308=127.0.1.1, , AutoUpdate=true
```


| **Свойство** | **Описание** |
| --- | --- |
| Порт | Это текущий порт, который прослушивает экземпляр MySQL. Порт 0 означает, что для экземпляра по умолчанию используются следующие свойства. |
| Адрес привязки | Это текущий адрес привязки MySQL. |
| Имя пользователя | Это имя пользователя MySQL, которое нужно использовать для мониторинга экземпляра сервера MySQL. |
| Пароль в кодировке Base64 | Это пароль пользователя мониторинга MySQL в кодировке Base64. |
| Автоматическое обновление | При обновлении поставщик OMI MySQL повторно выполнит поиск изменений в файле my.cnf и перезапишет файл аутентификации OMI MySQL. Задайте для этого флага значение true или false в зависимости от необходимости обновления файла аутентификации OMI MySQL. |

#### Расположение файла аутентификации

Файл аутентификации OMI MySQL должен называться mysql-auth и находиться в следующем расположении:

/var/opt/microsoft/mysql-cimprov/auth/omsagent/mysql-auth

Файл (и каталог auth/omsagent) должен принадлежать пользователю omsagent.

## Журналы агента

Журналы агента OMS для Linux находятся в следующем каталоге:

/var/opt/microsoft/omsagent/log/

Журналы агента OMS для Linux для программы omsconfig (конфигурация агента) расположены в следующем каталоге:

/var/opt/microsoft/omsconfig/log/

Журналы для компонентов OMI и SCX (предоставляют данные метрики производительности) расположены в следующих каталогах:

/var/opt/omi/log/ и /var/opt/microsoft/scx/log

## Известные ограничения
Ознакомьтесь со следующими разделами, чтобы узнать о текущих ограничениях агента OMS для Linux.

### Диагностика Azure

Для виртуальных машин Linux в Azure может потребоваться выполнить дополнительные действия, чтобы разрешить сбор данных с помощью системы диагностики Azure и Operations Management Suite. Чтобы обеспечить совместимость с агентом OMS для Linux, требуется расширение диагностики для Linux **версии 2.2**.

Дополнительные сведения об установке и настройке расширения диагностики для Linux см. в разделе [Включение диагностического расширения Linux с помощью команды интерфейса командной строки Azure](../virtual-machines/virtual-machines-linux-classic-diagnostic-extension/#use-the-azure-cli-command-to-enable-linux-diagnostic-extension).

**Обновление расширения диагностики с версии 2.0 до версии 2.2 ASM интерфейса командной строки Azure:**

```
azure vm extension set -u <vm_name> LinuxDiagnostic Microsoft.OSTCExtensions 2.0
azure vm extension set <vm_name> LinuxDiagnostic Microsoft.OSTCExtensions 2.2 --private-config-path PrivateConfig.json
```

**ARM**

```
azure vm extension set -u <resource-group> <vm-name> Microsoft.Insights.VMDiagnosticsSettings Microsoft.OSTCExtensions 2.0
azure vm extension set <resource-group> <vm-name> LinuxDiagnostic Microsoft.OSTCExtensions 2.2 --private-config-path PrivateConfig.json
```

В этих примерах команд указан файл PrivateConfig.json. Этот файл должен выглядеть следующим образом:

```
	{
    "storageAccountName":"the storage account to receive data",
    "storageAccountKey":"the key of the account"
	}
```

### sysklog не поддерживается

Для сбора сообщений системного журнала требуется rsyslog или syslog-ng. Управляющая программа syslog по умолчанию не поддерживается для сбора событий системного журнала в Red Hat Enterprise Linux версии 5, CentOS и Oracle Linux (sysklog). Чтобы собирать данные системного журнала из дистрибутивов этих версий, требуется установить и настроить управляющую программу rsyslog, которая заменит sysklog. Дополнительные сведения о замене sysklog на rsyslog см. в разделе [Установка созданного RPM rsyslog](http://wiki.rsyslog.com/index.php/Rsyslog_on_CentOS_success_story#Install_the_newly_built_rsyslog_RPM).

## Дальнейшие действия

- Чтобы добавить функции и реализовать сбор данных, [добавьте решения Log Analytics из коллекции решений](log-analytics-add-solutions.md).
- Подробные сведения, которые собирают решения, описаны в статье [про поиск по журналам](log-analytics-log-searches.md).
- Используйте [панели мониторинга](log-analytics-dashboards.md) для сохранения и отображения настраиваемых систем поиска.

<!---HONumber=AcomDC_0504_2016-->