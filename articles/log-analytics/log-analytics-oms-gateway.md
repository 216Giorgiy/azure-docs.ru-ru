---
title: Подключение компьютеров с помощью шлюза OMS | Документация Майкрософт
description: Подключайте свои устройства и компьютеры под наблюдением Operations Manager к шлюзу OMS, чтобы отправлять данные в службу автоматизации Azure и Log Analytics в случае отсутствия доступа к Интернету.
services: log-analytics
documentationcenter: ''
author: MGoedtel
manager: carmonm
editor: ''
ms.assetid: ae9a1623-d2ba-41d3-bd97-36e65d3ca119
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/14/2018
ms.author: magoedte
ms.openlocfilehash: 66e5444f5346a44cfc8a43cf2b43dbaeacffedc9
ms.sourcegitcommit: 20d103fb8658b29b48115782fe01f76239b240aa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2018
---
# <a name="connect-computers-without-internet-access-by-using-the-oms-gateway"></a>Подключения компьютеров с помощью шлюза OMS без доступа к Интернету
В этом документе описывается, как настроить связь между службой автоматизации Azure и Log Analytics с помощью шлюза OMS, когда компьютеры, подключенные напрямую или отслеживаемые Operations Manager, не имеют доступа к Интернету. Шлюз OMS — это прокси-сервер переадресации HTTP, в котором HTTP-туннелирование осуществляется с помощью команды HTTP CONNECT. Он может собирать данные и отправлять их в службу автоматизации Azure и Log Analytics от имени компьютеров без доступа к Интернету.  

Шлюз OMS поддерживает следующее:

* Гибридные компоненты Runbook Worker в службе автоматизации Azure  
* Компьютеры на базе Windows с агентом Microsoft Monitoring Agent, который напрямую подключен к рабочей области Log Analytics.
* Компьютеры на базе Linux с агентом OMS для Linux, который напрямую подключен к рабочей области Log Analytics.  
* System Center Operations Manager 2012 с пакетом обновления 1 (SP1) и накопительным пакетом обновления 7 (UR7), Operations Manager 2012 R2 с накопительным пакетом обновления 3 (UR3), Operations Manager 2016 или группу управления Operations Manager версии 1801, интегрируемую с Log Analytics.  

Если политики ИТ-безопасности запрещают подключение определенных компьютеров (таких как POS-устройства или серверы, поддерживающие ИТ-службы) в сети к Интернету, а вам нужно подключить их к службе автоматизации Azure или Log Analytics для мониторинга и управления, для компьютеров можно настроить взаимодействие непосредственно со шлюзом OMS.

 Если эти компьютеры настроены с помощью агента OMS для подключения к рабочей области Log Analytics напрямую, вместо этого все они будут взаимодействовать со шлюзом OMS. Шлюз OMS передает данные из агентов в службу напрямую. Он не анализирует данные во время передачи.

Если группа управления Operations Manager интегрирована с Log Analytics, серверы управления можно настроить для подключения к шлюзу OMS, чтобы получать сведения о конфигурации и отправлять собранные данные. Агенты Operations Manager отправляют на сервер управления некоторые данные, такие как оповещения, оценки конфигурации, размер экземпляра и емкость данных Operations Manager. Другие данные большого объема, например журналы IIS, сведения о производительности и событиях безопасности, отправляются непосредственно в шлюз OMS.  

Если вы развернули один или несколько серверов шлюза Operations Manager в сети периметра или в другой изолированной сети для мониторинга ненадежных систем, они не смогут связаться со шлюзом OMS. Серверы Operations Manager шлюза могут сообщать данные только серверу управления. 

Если группа управления Operations Manager настроена для взаимодействия со шлюзом OMS, сведения о конфигурации прокси-сервера автоматически распространяются на каждый компьютер под управлением агента, настроенного для сбора данных для Log Analytics, даже если соответствующий параметр не указан.    

Обеспечить высокую доступность для компьютеров, подключенных напрямую, или для групп Operations Management, взаимодействующих с Log Analytics через шлюз OMS, можно с использованием балансировки нагрузки сети, чтобы перенаправлять и распределять трафик между несколькими серверами шлюза OMS. Если один сервер шлюза выходит из строя, трафик перенаправляется на другие доступные узлы.  

Мы рекомендуем установить агент OMS на компьютере, на котором выполняется программное обеспечение шлюза OMS, для мониторинга и анализа данных о производительности или событиях. Кроме того, агент помогает шлюзу OMS определить конечные точки службы, с которыми необходимо взаимодействовать.

Каждый агент должен иметь сетевое подключение к шлюзу. Так он сможет автоматически передавать данные в шлюз и извлекать их из него. Мы не рекомендуем устанавливать шлюз на контроллере домена.

На следующей схеме представлена передача данных от прямых агентов в службу автоматизации Azure или Log Analytics через сервер шлюза. Для конфигурации прокси-сервера агента необходимо использовать тот же порт, который шлюз OMS использует для взаимодействия со службой.  

![Схема взаимодействия прямого агента со службами](./media/log-analytics-oms-gateway/oms-omsgateway-agentdirectconnect.png)

На следующей схеме представлена передача данных из группы управления Operations Manager в Log Analytics.   

![Схема взаимодействия Operations Manager с Log Analytics](./media/log-analytics-oms-gateway/log-analytics-agent-opsmgrconnect.png)

## <a name="prerequisites"></a>предварительным требованиям

Компьютер, назначенный для запуска шлюза OMS, должен содержать следующие компоненты:

* Windows 10, Windows 8.1, Windows 7
* Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008
* .NET Framework 4.5
* 4-ядерный процессор и 8 ГБ памяти (минимальные требования). 

### <a name="language-availability"></a>Доступность языковых версий

Шлюз OMS доступен на следующих языках:

- Китайский (упрощенное письмо)
- Китайский (традиционное письмо)
- Чешский
- Нидерландский
- Английский
- Французский
- Немецкий
- Венгерский
- Итальянский
- Японский
- Корейский
- Польский
- Португальский (Бразилия)
- Португальский (Португалия)
- Русский
- испанский (международный).

### <a name="supported-encryption-protocols"></a>Поддерживаемые протоколы шифрования
Шлюз OMS поддерживает только протоколы TLS 1.0, 1.1 и 1.2.  Он не поддерживает протокол SSL.

### <a name="supported-number-of-agent-connections"></a>Поддерживаемое число подключений агента
В таблице ниже приведено поддерживаемое число агентов, которые можно подключить к серверу шлюза. Это значение получено с расчетом, что каждый агент передает примерно 200 КБ данных каждые 6 секунд. Общий объем данных, полученных с каждого агента в день, составляет 2,7 ГБ.

|Шлюз |Приблизительное количество поддерживаемых агентов|  
|--------|----------------------------------|  
|ЦП: Intel Xeon E5-2660 v3 с тактовой частотой 2,6 ГГц, 2 ядра<br> Память: 4 ГБ<br> Пропускная способность сети: 1 Гбит/с| 600|  
|ЦП: Intel Xeon E5-2660 v3 с тактовой частотой 2,6 ГГц, 4 ядра<br> Память: 8 ГБ<br> Пропускная способность сети: 1 Гбит/с| 1000|  

## <a name="download-the-oms-gateway"></a>Скачивание шлюза OMS

Есть два способа получения файла установки шлюза OMS последней версии.

1. Скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=54443).

2. Загрузить на портале Azure. После входа на портал Azure сделайте следующее:  

   1. Найдите список служб и выберите **Log Analytics**.  
   2. Выберите рабочую область.
   3. В колонке рабочей области в разделе **Общие** выберите **Быстрый запуск**.
   4. в разделе **Выбор источника данных для подключения к рабочей области** щелкните **Компьютеры**;
   5. На панели **Прямой агент** выберите **Скачать шлюз OMS**.
   
    ![Скачивание шлюза OMS](./media/log-analytics-oms-gateway/download-gateway.png)

-- ИЛИ -- 

   1. В колонке рабочей области в разделе **Параметры** щелкните **Дополнительные параметры**.
   2. Выберите **Подключенные источники** > **Серверы с Windows**. Выберите **Скачать шлюз OMS**.

## <a name="install-the-oms-gateway"></a>Установка шлюза OMS

Чтобы установить шлюз, сделайте следующее. Если установлена предыдущая версия, которая раньше называлась *сервером пересылки Log Analytics*, она будет обновлена до этого выпуска.  

1. В папке назначения выберите файл **OMS Gateway.msi**.
2. На странице **приветствия** нажмите кнопку **Далее**.

 ![Мастер установки шлюза](./media/log-analytics-oms-gateway/gateway-wizard01.png)
  
3. На странице **Лицензионное соглашение** установите флажок **I accept the terms in the License Agreement** (Я принимаю условия лицензионного соглашения). Затем нажмите кнопку **Далее**.

4. На странице со сведениями об **адресе порта и прокси-сервера**:

   a. Введите номер TCP-порта, используемого для шлюза. Программа установки настроит правило входящего трафика с этим номером порта в брандмауэре Windows. По умолчанию используется значение 8080. Допустимый диапазон номеров порта: 1–65535. При вводе значения, которое не входит в этот диапазон, появится сообщение об ошибке.

   Б. Если для сервера, где установлен шлюз, требуется взаимодействие с прокси-сервером, введите адрес прокси-сервера, к которому должен подключиться шлюз (при необходимости). Примером может служить `http://myorgname.corp.contoso.com:80`, как показано на следующем снимке экрана. Если оставить это поле пустым, шлюз выполнит попытку подключиться к Интернету напрямую.  Если для вашего прокси-сервера требуется проверка подлинности, введите имя пользователя и пароль.
   
    ![Конфигурация прокси-сервера в мастере установки шлюза](./media/log-analytics-oms-gateway/gateway-wizard02.png)

4. Щелкните **Далее**.

5. Если Центр обновления Майкрософт отключен, появится страница "Центр обновления Майкрософт", где его можно включить. Сделайте выбор и нажмите кнопку **Далее**. В противном случае перейдите к следующему шагу.

6. На странице **Конечная папка** оставьте папку по умолчанию (**c:\ProgramFiles\OMS Gateway**) или укажите расположение, куда необходимо установить шлюз OMS. Затем нажмите кнопку **Далее**.

7. На странице **Готово к установке** выберите **Установить**. После этого служба контроля учетных записей может запросить разрешение на установку. При появлении запроса на разрешение выберите **Да**.

8. После завершения установки выберите **Готово**. Проверить, запущена ли служба, можно в оснастке services.msc. Если это так, **шлюз OMS** появится в списке служб с состоянием **Выполняется**.

    ![Службы — шлюз OMS](./media/log-analytics-oms-gateway/gateway-service.png)  

## <a name="configure-network-load-balancing"></a>Настройка балансировки сетевой нагрузки 
Вы можете повысить уровень доступности шлюза с помощью балансировки сетевой нагрузки (NLB). Используйте балансировку сетевой нагрузки Майкрософт или подсистемы балансировки нагрузки на основе аппаратного обеспечения.  Подсистема балансировки нагрузки управляет трафиком, перенаправляя запрошенные подключения от серверов управления агента OMS или Operations Manager по узлам. Если один сервер шлюза выходит из строя, трафик перенаправляется на другие узлы.

Сведения о проектировании и развертывании кластера балансировки сетевой нагрузки Windows Server 2016 см. в статье о [балансировке сетевой нагрузки](https://technet.microsoft.com/windows-server-docs/networking/technologies/network-load-balancing).  Ниже описана процедура настройки кластера балансировки сетевой нагрузки Майкрософт.  

1.  Войдите на сервер Windows, который входит в кластер NLB, с использованием учетной записи администратора.  

2.  В диспетчере серверов откройте диспетчер балансировки сетевой нагрузки. Выберите **Инструменты**, а затем **Диспетчер балансировки сетевой нагрузки**.

3. Чтобы подключить сервер шлюза OMS с установленным компонентом Microsoft Monitoring Agent, щелкните правой кнопкой мыши IP-адрес кластера и выберите **Add Host to Cluster** (Добавить узел в кластер).

 ![Диспетчер балансировки сетевой нагрузки — "Добавить узел в кластер"](./media/log-analytics-oms-gateway/nlb02.png)

4. Введите IP-адрес сервера шлюза, к которому нужно подключиться.

    ![Диспетчер балансировки сетевой нагрузки — "Добавить узел в кластер: подключить"](./media/log-analytics-oms-gateway/nlb03.png) 
    
## <a name="configure-the-oms-agent-and-the-operations-manager-management-group"></a>Настройка агента OMS и группы управления Operations Manager
В следующем разделе этой статьи представлены инструкции по настройке взаимодействия между подключенными напрямую агентами OMS, группами управления Operations Manager или гибридными рабочими ролями Runbook службы автоматизации Azure или Log Analytics с помощью шлюза OMS.  

Чтобы ознакомиться с требованиями и шагами для установки агента OMS на компьютерах Windows, которые напрямую подключаются к Log Analytics, см. раздел [Предварительные требования](log-analytics-concept-hybrid.md#prerequisites).

 Для компьютеров Linux см. статью [Сбор данных с компьютеров Linux, размещенных в вашем окружении](log-analytics-quick-collect-linux-computer.md). Сведения о гибридной рабочей роли Runbook службы автоматизации см. в разделе [Развертывание гибридной рабочей роли Runbook](../automation/automation-hybrid-runbook-worker.md).

### <a name="configure-the-standalone-oms-agent"></a>Настройка изолированного агента OMS
Сведения о настройке агента для использования прокси-сервера (который в данном случае является шлюзом) см. в разделе [Предварительные требования](log-analytics-concept-hybrid.md#prerequisites). При развертывании нескольких серверов шлюзов после балансировщика сетевой нагрузки конфигурацией прокси-сервера агента OMS является виртуальный IP-адрес балансировщика сетевой нагрузки:

![Свойства Microsoft Monitoring Agent — настройки прокси-сервера](./media/log-analytics-oms-gateway/nlb04.png)

### <a name="configure-operations-manager-all-agents-use-the-same-proxy-server"></a>Настройка Operations Manager: все агенты используют один прокси-сервер
Operations Manager позволяет добавить сервер шлюза.  Конфигурация прокси-сервера Operations Manager применяется ко всем агентам, передающим данные в Operations Manager, автоматически, даже если соответствующий параметр не указан.  

Чтобы использовать шлюз OMS для поддержки Operations Manager, следует установить следующие компоненты:

* На сервере шлюза необходимо установить компонент Microsoft Monitoring Agent (версии **8.0.10900.0** или более поздней) и настроить его для рабочих областей Log Analytics, с которыми нужно установить взаимодействие.

* Шлюз должен иметь подключение к Интернету или должен быть подключен к прокси-серверу с подключением к Интернету.

> [!NOTE]
> Если не указать значение для шлюза, всем агентам передаются пустые значения.
> 

При первой регистрации группы управления Operations Manager в рабочей области Log Analytics параметр для указания конфигурации прокси-сервера для группы управления будет недоступен в консоли управления. 

Этот параметр станет доступным после успешной регистрации группы управления в службе. Обновите конфигурацию прокси-сервера системы с помощью Netsh в той же системе, в которой выполняется консоль управления, и все серверы управления в группе управления.

1. Откройте командную строку с повышенными привилегиями.

    a. Выберите **Пуск**. Затем введите **cmd**.
    
    Б. Щелкните правой кнопкой мыши **Командная строка**. Выберите **Run as administrator** (Запуск от имени администратора).
    
2. Введите следующую команду, а затем нажмите клавишу **Enter**.

    `netsh winhttp set proxy <proxy>:<port>`

После завершения интеграции с Log Analytics можно удалить изменения, запустив `netsh winhttp reset proxy`. Затем используйте параметр **Настройка прокси-сервера** в консоли управления, чтобы указать сервер шлюза OMS. 

1. Откройте консоль Operations Manager. В разделе **Operations Management Suite** выберите **Подключение**. Затем выберите **Настройка прокси-сервера**.

    ![Operations Manager — настройка прокси-сервера](./media/log-analytics-oms-gateway/scom01.png)

2. Выберите **Использовать прокси-сервер для доступа к набору Operations Management Suite**. После этого введите IP-адрес сервера шлюза OMS или виртуальный IP-адрес NLB. Он должен начинаться с префикса `http://`.

    ![Operations Manager — адрес прокси-сервера](./media/log-analytics-oms-gateway/scom02.png)

3. Выберите **Готово**. Группа управления Operations Manager настроена для обмена данными со службой Log Analytics через сервер шлюза.

### <a name="configure-operations-manager-specific-agents-use-proxy-server"></a>Настройка Operations Manager: определенные агенты используют прокси-сервер
В больших или сложных средах может потребоваться, чтобы только определенные серверы (или группы) использовали сервер шлюза OMS. Для этих серверов невозможно обновить агент Operations Manager напрямую, так как это значение перезаписывается глобальным значением группы управления. Вместо этого необходимо переопределить правило, используемое для передачи этих значений.  

> [!NOTE] 
> Вы можете использовать этот же прием конфигурации, чтобы разрешить использовать несколько серверов шлюза OMS в среде. Например, для каждого региона может понадобиться указать определенные серверы шлюза OMS.
>  

1. Откройте консоль Operations Manager и выберите рабочую область **Создание**.

2. В рабочей области "Создание" выберите **Правила**. Затем на панели инструментов Operations Manager нажмите кнопку **Область**. Если эта кнопка недоступна, убедитесь, что на панели **Мониторинг** выбран именно объект, а не папка. Появится диалоговое окно **Ориентация объектов пакета управления** со списком общих целевых классов, групп или объектов. 

3. В поле **Искать** введите **Служба работоспособности** и выберите ее в списке. Нажмите кнопку **ОК**.  

4. Найдите **правило настройки прокси-сервера помощника**. На панели инструментов консоли управления выберите **Переопределяет**. Затем выберите команду **Override the Rule\For a specific object of class: Health Service** (Переопределить правило для конкретного объекта класса: служба работоспособности). 

5. После этого выберите конкретный объект в списке. 

6. Создайте пользовательскую группу, содержащую объект службы работоспособности серверов, которые нужно переопределить (при необходимости). Затем примените переопределение к этой группе.

7. В диалогом окне **Свойства переопределения** в столбце **Переопределение** установите флажок возле параметра **WebProxyAddress**.  В поле **Значение переопределения** введите URL-адрес сервера шлюза OMS, в начале которого стоит префикс `http://`.  

    >[!NOTE]
    > Вам не нужно включать правило. Им уже автоматически управляет переопределение, содержащееся в пакете управления переопределением безопасной ссылки Microsoft System Center Advisor, предназначенном для группы серверов мониторинга Microsoft System Center Advisor.
    >   

8. Выберите пакет управления в списке **Выберите целевой пакет управления** или создайте незапечатанный пакет управления, щелкнув **Создать**. 

9. После внесения необходимых изменений нажмите кнопку **ОК**. 

### <a name="configure-the-oms-gateway-for-automation-hybrid-runbook-workers"></a>Настройка шлюза OMS для гибридных рабочих ролей Runbook службы автоматизации
При наличии в среде гибридных рабочих ролей Runbook службы автоматизации выполните приведенные ниже действия (временные решения, выполняемые вручную), чтобы настроить их поддержку в шлюзе OMS.

Для выполнения следующих действий нужно знать регион Azure, где находится учетная запись службы автоматизации. Чтобы найти расположение, сделайте следующее:

1. Войдите на [портале Azure](https://portal.azure.com/).
2. Выберите службу автоматизации Azure.
3. Выберите соответствующую учетную запись службы автоматизации Azure.
4. В разделе **Расположение** просмотрите регион учетной записи.

    ![Портал Azure — расположение учетной записи службы автоматизации](./media/log-analytics-oms-gateway/location.png)  

Используйте следующие таблицы, чтобы определить URL-адреса для каждого расположения.

**URL-адреса службы Job Runtime Data**

| **Местоположение.** | **URL-адрес** |
| --- | --- |
| Северо-центральный регион США |ncus-jobruntimedata-prod-su1.azure-automation.net |
| Западная Европа |we-jobruntimedata-prod-su1.azure-automation.net |
| Южно-центральный регион США |scus-jobruntimedata-prod-su1.azure-automation.net |
| Восток США 2 |eus2-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Канада |cc-jobruntimedata-prod-su1.azure-automation.net |
| Северная Европа |ne-jobruntimedata-prod-su1.azure-automation.net |
| Юго-Восточная Азия |sea-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Индия |cid-jobruntimedata-prod-su1.azure-automation.net |
| Япония |jpe-jobruntimedata-prod-su1.azure-automation.net |
| Австралия |ase-jobruntimedata-prod-su1.azure-automation.net |

**URL-адреса службы агента**

| **Местоположение.** | **URL-адрес** |
| --- | --- |
| Северо-центральный регион США |ncus-agentservice-prod-1.azure-automation.net |
| Западная Европа |we-agentservice-prod-1.azure-automation.net |
| Южно-центральный регион США |scus-agentservice-prod-1.azure-automation.net |
| Восток США 2 |eus2-agentservice-prod-1.azure-automation.net |
| Центральная Канада |cc-agentservice-prod-1.azure-automation.net |
| Северная Европа |ne-agentservice-prod-1.azure-automation.net |
| Юго-Восточная Азия |sea-agentservice-prod-1.azure-automation.net |
| Центральная Индия |cid-agentservice-prod-1.azure-automation.net |
| Япония |jpe-agentservice-prod-1.azure-automation.net |
| Австралия |ase-agentservice-prod-1.azure-automation.net |

Если компьютер автоматически зарегистрировался в качестве гибридной рабочей роли Runbook для установки исправлений с помощью решения "Управление обновлениями", сделайте следующее:

1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе OMS. Например, введите следующую команду: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`

2. Перезапустите службу шлюза OMS, используя следующий командлет PowerShell: `Restart-Service OMSGatewayService`.

Если компьютер подключен к службе автоматизации Azure с помощью командлета регистрации гибридной рабочей роли Runbook, сделайте следующее:

1. Добавьте URL-адрес для регистрации службы агента в список разрешенных узлов в шлюзе OMS. Например, введите следующую команду: `Add-OMSGatewayAllowedHost ncus-agentservice-prod-1.azure-automation.net`

2. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе OMS. Например, введите следующую команду: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`

3. Перезапустите службу шлюза OMS: `Restart-Service OMSGatewayService`

## <a name="useful-powershell-cmdlets"></a>Полезные командлеты PowerShell
Командлеты позволяют выполнять задачи, необходимые для обновления параметров конфигурации шлюза OMS. Прежде чем использовать их, обязательно выполните следующие действия:

1. Установите шлюз OMS (MSI).
2. Откройте окно консоли PowerShell.
3. Импортируйте модуль, введя эту команду: `Import-Module OMSGateway`.
4. Если при выполнении предыдущего шага не произошла ошибка, значит импорт модуля выполнен успешно и вы можете использовать командлеты. Введите `Get-Module OMSGateway`.
5. После внесения изменений с помощью командлетов перезапустите службу шлюза OMS.

Если при выполнении шага 3 произошла ошибка, значит модуль не импортирован. Возможно, эта ошибка возникла, так как PowerShell не удалось найди модуль. Его можно найти по указанному пути установки шлюза OMS: *C:\Program Files\Microsoft OMS Gateway\PowerShell*.

| **Командлет** | **Параметры** | **Описание** | **Пример** |
| --- | --- | --- | --- |  
| `Get-OMSGatewayConfig` |Ключ |Получает конфигурацию службы |`Get-OMSGatewayConfig` |  
| `Set-OMSGatewayConfig` |Ключ (обязательно) <br> Значение |Изменяет конфигурацию службы |`Set-OMSGatewayConfig -Name ListenPort -Value 8080` |  
| `Get-OMSGatewayRelayProxy` | |Получает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |`Get-OMSGatewayRelayProxy` |  
| `Set-OMSGatewayRelayProxy` |Адрес<br> Имя пользователя<br> Пароль |Задает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |1. Задайте прокси-сервер ретрансляции и учетные данные:<br> `Set-OMSGatewayRelayProxy`<br>`-Address http://www.myproxy.com:8080`<br>`-Username user1 -Password 123` <br><br> 2. Задайте прокси-сервер ретрансляции, для которого не требуется проверка подлинности: `Set-OMSGatewayRelayProxy`<br> `-Address http://www.myproxy.com:8080` <br><br> 3. Очистите параметры прокси-сервера ретрансляции:<br> `Set-OMSGatewayRelayProxy` <br> `-Address ""` |  
| `Get-OMSGatewayAllowedHost` | |Получает разрешенный в настоящее время узел (только локально настроенные разрешенные узлы; разрешенные узлы, скачанные автоматически, сюда не относятся) |`Get-OMSGatewayAllowedHost` | 
| `Add-OMSGatewayAllowedHost` |Узел (обязательно) |Добавляет узел в список разрешенных |`Add-OMSGatewayAllowedHost -Host www.test.com` |  
| `Remove-OMSGatewayAllowedHost` |Узел (обязательно) |Удаляет узел из списка разрешенных |`Remove-OMSGatewayAllowedHost`<br> `-Host www.test.com` |  
| `Add-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Добавляет субъект сертификата клиента в список разрешенных |`Add-OMSGatewayAllowed`<br>`ClientCertificate` <br> `-Subject mycert` |  
| `Remove-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Удаляет субъект сертификата клиента из списка разрешенных |`Remove-OMSGatewayAllowed` <br> `ClientCertificate` <br> `-Subject mycert` |  
| `Get-OMSGatewayAllowedClientCertificate` | |Получает разрешенные в настоящее время субъекты сертификата клиента (только локально настроенные разрешенные субъекты; разрешенные субъекты, скачанные автоматически, сюда не относятся) |`Get-`<br>`OMSGatewayAllowed`<br>`ClientCertificate` |  

## <a name="troubleshooting"></a>Устранение неполадок
Для сбора событий, регистрируемых шлюзом, необходимо также установить агент OMS.

![Просмотр событий — журнал шлюза OMS](./media/log-analytics-oms-gateway/event-viewer.png)

**Идентификаторы и описания событий шлюза OMS**

В следующей таблице приведены идентификаторы и описания событий журнала шлюза OMS:

| **Идентификатор** | **Описание** |
| --- | --- |
| 400 |Любая ошибка приложения без определенного идентификатора. |
| 401 |Неправильная конфигурация. Например, для параметра listenPort задано значение text вместо integer. |
| 402 |Исключение при анализе сообщений подтверждения TLS. |
| 403 |Сетевая ошибка. Например, не удается подключиться к целевому серверу. |
| 100 |Общие сведения. |
| 101 |Служба запущена. |
| 102 |Служба остановлена. |
| 103 |Получена команда HTTP CONNECT от клиента. |
| 104 |Команда HTTP CONNECT не получена. |
| 105 |Целевой сервер не включен в список разрешенных или конечный порт небезопасен (443). <br> <br> Убедитесь, что агент MMA на сервере шлюза и агенты, взаимодействующие со шлюзом, подключены к одной рабочей области Log Analytics. |
| 105 |Ошибка TCP-подключения — недопустимый сертификат клиента: CN=Gateway <br><br> Убедитесь в следующем: <br>    <br> используется шлюз версии 1.0.395.0 или более поздней; <br> агент MMA на сервере шлюза и агенты, взаимодействующие со шлюзом, подключены к одной рабочей области Log Analytics. |
| 106 |Шлюз OMS поддерживает только протоколы TLS 1.0, 1.1 и 1.2.  Он не поддерживает протокол SSL. Для любой неподдерживаемой версии протокола TLS или SSL шлюз OMS создает идентификатор события 106.|
| 107 |Сеанс TLS проверен. |

**Счетчики производительности, данные для которых необходимо собрать**

В следующей таблице приведены счетчики производительности, доступные для шлюза OMS. Счетчики можно добавить с помощью системного монитора.

| **Имя** | **Описание** |
| --- | --- |
| Шлюз OMS — Active Client Connection (Активные клиентские подключения) |Количество активных сетевых подключений клиента (TCP) |
| Шлюз OMS — Error Count (Количество ошибок) |Количество ошибок |
| Шлюз OMS — Connected Client (Подключенные клиенты) |Количество подключенных клиентов |
| Шлюз OMS — Rejection Count (Количество отклонений) |Количество отклонений из-за любых ошибок проверки TLS |

![Счетчики производительности шлюза OMS](./media/log-analytics-oms-gateway/counters.png)

## <a name="get-assistance"></a>Получение справки
На портале Azure можно запросить помощь по настройке шлюза OMS, а также любой службы или компонента службы Azure.

Чтобы запросить помощь, выберите знак вопроса в правом верхнем углу портала. Затем выберите **Новый запрос в службу поддержки**. Заполните форму нового запроса на поддержку.

![Новый запрос на техническую поддержку](./media/log-analytics-oms-gateway/support.png)

## <a name="next-steps"></a>Дополнительная информация
[Добавьте источники данных](log-analytics-data-sources.md), чтобы собирать данные из подключенных источников и сохранять их в рабочей области Log Analytics.
