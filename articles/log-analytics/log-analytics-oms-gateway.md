---
title: "Подключение компьютеров и устройств к OMS с помощью шлюза OMS | Документация Майкрософт"
description: "Подключайте свои устройства под управлением OMS и компьютеры под наблюдением Operations Manager к шлюзу OMS, чтобы отправлять данные в службу OMS в случае отсутствия доступа к Интернету."
services: log-analytics
documentationcenter: 
author: bandersmsft
manager: carmonm
editor: 
ms.assetid: ae9a1623-d2ba-41d3-bd97-36e65d3ca119
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/10/2017
ms.author: banders
translationtype: Human Translation
ms.sourcegitcommit: 6f9974c109905f432705b85dcc8fc4d3549f16e9
ms.openlocfilehash: 445bc1259cb3fa6f02fa1cadec11b1ac4b186e78


---
# <a name="connect-computers-and-devices-to-oms-using-the-oms-gateway"></a>Подключения компьютеров и устройств к OMS с помощью шлюза OMS
В этом документе описывается, как устройства под управлением OMS и компьютеры под наблюдением System Center Operations Manager (SCOM) могут отправлять данные в службу OMS в случае отсутствия доступа к Интернету. Шлюз OMS может собирать данные и отправлять их в службу OMS от имени этих устройств и компьютеров.

Шлюз — это прокси-сервер переадресации HTTP, в котором HTTP-туннелирование осуществляется с помощью команды HTTP CONNECT. Он может обрабатывать до 2000 параллельно подключенных к OMS устройств, запущенных на сервере под управлением Windows с емкостью 16 ГБ и четырехъядерным ЦП.

Например, на предприятии или в большой организации серверы могут быть подключены к сети, но не иметь доступа к Интернету, или вы можете иметь большое количество POS-устройств и не располагать средствами для их мониторинга напрямую. И еще один пример: Operations Manager может использовать шлюз OMS в качестве прокси-сервера. В этих случаях шлюз OMS может передавать данные от агентов, установленных на этих серверах или POS-устройствах, в OMS.

Вместо того чтобы каждый агент отправлял данные непосредственно в OMS, все данные отравляются на отдельный компьютер с подключением к Интернету. При этом нет необходимости настраивать прямое подключение к Интернету для каждого агента. Данные отправляются на компьютер, на котором установлен и используется шлюз. В этом сценарии агенты можно установить на всех компьютерах, где необходимо собирать данные. Затем шлюз передает данные от агентов напрямую в OMS, не анализируя их.

Вам необходимо установить агент OMS на компьютере с установленным шлюзом. Это позволит отслеживать шлюз OMS и анализировать данные производительности или событий на сервере, где он установлен. Кроме того, агент помогает шлюзу OMS определить конечные точки службы, с которыми необходимо взаимодействовать.

Для шлюза необходимо обеспечить доступ к Интернету, чтобы он мог отправлять данные в OMS. Каждый агент также должен иметь сетевое подключение к шлюзу. Так он сможет автоматически передавать данные в шлюз и извлекать их из него. Для получения наилучших результатов не устанавливайте шлюз на компьютере, который также используется в качестве контроллера домена.

Ниже приведена схема потока данных непосредственно от агентов в OMS.

![Схема передачи данных агентами напрямую](./media/log-analytics-oms-gateway/direct-agent-diagram.png)

Ниже приведена схема потока данных от Operations Manager в OMS.

![Схема Operations Manager](./media/log-analytics-oms-gateway/scom-mgt-server.png)

## <a name="language-availability"></a>Доступность языковых версий

Шлюз OMS доступен на следующих языках:

- Китайский (упрощенное письмо)
- Китайский (традиционное письмо)
- Чешский
- Нидерландский
- Английский
- Французский
- Немецкий
- Венгерский
- Итальянский
- Японский
- Корейский
- Польский
- Португальский (Бразилия)
- Португальский (Португалия)
- Русский
- испанский (международный).

## <a name="download-the-oms-gateway"></a>Скачивание шлюза OMS

Существует три способа, с помощью которых можно получить файл установки шлюза OMS.

### <a name="microsoft-download-center"></a>Центр загрузки Майкрософт

- Скачайте последнюю версию шлюза OMS в [Центре загрузки Майкрософт](http://download.microsoft.com/download/2/5/C/25CF992A-0347-4765-BD7D-D45D5B27F92C/OMS%20Gateway.msi).

### <a name="oms-portal"></a>Портал OMS

1.    Войдите в свою рабочую область OMS.
2.    Выберите **Параметры** > **Connected Sources ** (Подключенные источники) > **Windows Servers** (Серверы Windows Server).
3.    Щелкните **Скачать шлюз OMS**.


### <a name="azure-portal"></a>Портал Azure

1. Перейдите на [портал Azure](https://portal.azure.com), выполните вход, найдите список служб и выберите **Log Analytics**.
2. Выберите рабочую область.
3. В колонке рабочей области в разделе **Общие** щелкните **Быстрый запуск**.
4. В разделе **Choose a data source to connect to the workspace** (Выберите источник данных для подключения к рабочей области) щелкните **Компьютеры**.
4. В колонке **Direct Agent** щелкните **Download OMS Gateway** (Скачать шлюз OMS).  
    ![скачивание шлюза OMS](./media/log-analytics-oms-gateway/download-gateway.png)


## <a name="install-the-oms-gateway"></a>Установка шлюза OMS
При установке этого шлюза будут удалены предыдущие версии шлюза (сервер пересылки Log Analytics).

Предварительные требования: .Net Framework 4.5, Windows Server 2012 R2 с пакетом обновления 1 (SP1) или более поздней версии.


1. Чтобы начать установку, дважды щелкните файл **OMS Gateway.msi**.
2. На странице приветствия нажмите кнопку **Далее**.  
    ![Мастер установки шлюза](./media/log-analytics-oms-gateway/gateway-wizard01.png)
3. На странице лицензионного соглашения установите флажок **Я принимаю условия лицензионного соглашения**, а затем нажмите кнопку **Далее**.
4. На странице со сведениями об адресе порта и прокси-сервера:
   1. Введите номер TCP-порта, используемого для шлюза. Программа установки открывает этот номер порта из брандмауэра Windows. По умолчанию используется значение 8080.
      Допустимый диапазон номеров порта: 1–65535. При вводе значения, которое не входит в этот диапазон, появится сообщение об ошибке.
   2. Если для сервера, где установлен шлюз, требуется подключение к прокси-серверу, введите адрес прокси-сервера, к которому должен подключиться шлюз (при необходимости). Например, `http://myorgname.corp.contoso.com:80`. Если оставить это поле пустым, шлюз будет пытаться подключиться к Интернету напрямую. В противном случае шлюз подключается к прокси-серверу. Если ваш прокси-сервер требует проверки подлинности, введите имя пользователя и пароль.  
       ![Настройка прокси-сервера в мастере установки шлюза](./media/log-analytics-oms-gateway/gateway-wizard02.png)  
   3. Щелкните **Далее**
5. Если Центр обновления Майкрософт отключен, появится страница "Центр обновления Майкрософт", где его можно включить. Сделайте выбор и нажмите кнопку **Далее**. В противном случае перейдите к следующему шагу.
6. На странице "Конечная папка" оставьте папку по умолчанию (c:\ProgramFiles\OMS Gateway) или укажите расположение, куда необходимо установить шлюз, и нажмите кнопку **Далее**.
7. На странице "Все готово для установки" щелкните **Установить**. После этого служба контроля учетных записей может запросить разрешение на установку. Чтобы продолжить, нажмите кнопку **Да**.
8. После завершения установки нажмите кнопку **Готово**. Проверить, запущена ли служба, можно в оснастке services.msc. Если это так, **шлюз OMS** появится в списке служб.  
    ![Службы — шлюз OMS](./media/log-analytics-oms-gateway/gateway-service.png)

## <a name="install-an-agent-on-devices"></a>Установка агента на устройствах
Дополнительные сведения об установке напрямую подключенных агентов см. в статье [Подключение компьютеров Windows к Log Analytics](log-analytics-windows-agents.md) (при необходимости). В этой статье описана процедура установки агента с помощью программы установки или командной строки.

## <a name="configure-oms-agents"></a>Настройка агентов OMS
Сведения о настройке параметров прокси-сервера (в нашем случае это шлюз) для агента см. в статье [Настройка параметров прокси-сервера и брандмауэра в службе Log Analytics](log-analytics-proxy-firewall.md).

Агенты Operations Manager используют сервер управления, чтобы отправлять некоторые данные, такие как оповещения, оценки конфигурации, размер экземпляра и емкость данных Operations Manager. Другие данные большого объема, например журналы IIS, сведения о производительности и безопасности, отправляются непосредственно в шлюз OMS. Полный список данных, которые отправляются через каждый канал, см. в статье [Добавление решений Log Analytics из коллекции решений](log-analytics-add-solutions.md).

> [!NOTE]
> Если вы планируете настроить в шлюзе балансировку сетевой нагрузки, см. сведения в разделе [Настройка балансировки сетевой нагрузки](#optionally-configure-network-load-balancing).
>
>

## <a name="configure-a-scom-proxy-server"></a>Настройка прокси-сервера SCOM
Operations Manager позволяет использовать шлюз в качестве прокси-сервера. При обновлении конфигурации прокси-сервера она автоматически применяется ко всем агентам, отправляющим отчеты в Operations Manager.

Чтобы реализовать в шлюзе поддержку Operations Manager, требуется следующее:

* На сервере шлюза необходимо установить компонент Microsoft Monitoring Agent (версии **8.0.10900.0** или более поздней версии) и настроить его для рабочих областей OMS, с которыми нужно установить взаимодействие.
* Шлюз должен иметь подключение к Интернету или должен быть подключен к прокси-серверу с подключением к Интернету.

### <a name="to-configure-scom-for-the-gateway"></a>Настройка SCOM для шлюза
1. Откройте консоль Operations Manager и в разделе **Operations Management Suite** щелкните **Подключение**, а затем — **Настройка прокси-сервера**.  
    ![Operations Manager — настройка прокси-сервера](./media/log-analytics-oms-gateway/scom01.png)
2. Выберите **Использовать прокси-сервер для доступа к набору Operations Management Suite** и введите IP-адрес сервера шлюза OMS. Он должен начинаться с префикса `http://`.  
    ![Operations Manager — адрес прокси-сервера](./media/log-analytics-oms-gateway/scom02.png)
3. Нажмите кнопку **Готово** Теперь сервер Operations Manager подключен к рабочей области OMS.

## <a name="configure-network-load-balancing"></a>Настройка балансировки сетевой нагрузки
Вы можете повысить уровень доступности шлюза. Для этого нужно создать кластер и настроить балансировку сетевой нагрузки. Кластер управляет трафиком от агентов, перенаправляя запрашиваемые подключения от компонентов Microsoft Monitoring Agent на все его узлы. Если один сервер шлюза выходит из строя, трафик перенаправляется на другие узлы.

1. Откройте диспетчер балансировки сетевой нагрузки и создайте кластер.
2. Перед добавлением шлюзов щелкните правой кнопкой мыши кластер и выберите **Свойства кластера**. Настройте для кластера собственный IP-адрес.  
    ![Диспетчер балансировки сетевой нагрузки — IP-адреса кластера](./media/log-analytics-oms-gateway/nlb01.png)
3. Чтобы подключить сервер шлюза OMS с установленным компонентом Microsoft Monitoring Agent, щелкните правой кнопкой мыши IP-адрес кластера и выберите **Добавить узел в кластер**.  
    ![Диспетчер балансировки сетевой нагрузки — "Добавить узел в кластер"](./media/log-analytics-oms-gateway/nlb02.png)
4. Введите IP-адрес сервера шлюза, который нужно подключить.  
    ![Диспетчер балансировки сетевой нагрузки — "Добавить узел в кластер: подключить"](./media/log-analytics-oms-gateway/nlb03.png)
5. На компьютерах без доступа к Интернету для настройки **свойств Microsoft Monitoring Agent** используйте IP-адрес кластера.  
    ![Свойства Microsoft Monitoring Agent — настройки прокси-сервера](./media/log-analytics-oms-gateway/nlb04.png)

## <a name="configure-for-automation-hybrid-workers"></a>Настройка поддержки гибридных рабочих ролей службы автоматизации
При наличии в вашей среде гибридных рабочих ролей службы автоматизации выполните приведенные ниже действия (временные решения, выполняемые вручную), чтобы настроить их поддержку.

Для выполнения следующих действий нужно знать регион Azure, где находится учетная запись службы автоматизации. Чтобы определить расположение, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Выберите службу автоматизации Azure.
3. Выберите соответствующую учетную запись службы автоматизации Azure.
4. Просмотрите ее регион в разделе **Расположение**.  
    ![Портал Azure — расположение учетной записи автоматизации](./media/log-analytics-oms-gateway/location.png)

Используйте следующие таблицы, чтобы определить URL-адреса для каждого расположения.

**URL-адреса службы Job Runtime Data**

| **расположение** | **URL-адрес** |
| --- | --- |
| Северо-центральный регион США |ncus-jobruntimedata-prod-su1.azure-automation.net |
| Западная Европа |we-jobruntimedata-prod-su1.azure-automation.net |
| Южно-центральный регион США |scus-jobruntimedata-prod-su1.azure-automation.net |
| Восток США 2 |eus2-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Канада |cc-jobruntimedata-prod-su1.azure-automation.net |
| Северная Европа |ne-jobruntimedata-prod-su1.azure-automation.net |
| Юго-Восточная Азия |sea-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Индия |cid-jobruntimedata-prod-su1.azure-automation.net |
| Япония |jpe-jobruntimedata-prod-su1.azure-automation.net |
| Австралия |ase-jobruntimedata-prod-su1.azure-automation.net |

**URL-адреса службы агента**

| **расположение** | **URL-адрес** |
| --- | --- |
| Северо-центральный регион США |ncus-agentservice-prod-1.azure-automation.net |
| Западная Европа |we-agentservice-prod-1.azure-automation.net |
| Южно-центральный регион США |scus-agentservice-prod-1.azure-automation.net |
| Восток США 2 |eus2-agentservice-prod-1.azure-automation.net |
| Центральная Канада |cc-agentservice-prod-1.azure-automation.net |
| Северная Европа |ne-agentservice-prod-1.azure-automation.net |
| Юго-Восточная Азия |sea-agentservice-prod-1.azure-automation.net |
| Центральная Индия |cid-agentservice-prod-1.azure-automation.net |
| Япония |jpe-agentservice-prod-1.azure-automation.net |
| Австралия |ase-agentservice-prod-1.azure-automation.net |

Если компьютер автоматически зарегистрировался в качестве гибридной рабочей роли для установки исправлений с помощью решения "Управление обновлениями", сделайте следующее:

1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе OMS. Например:  `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
2. Перезапустите службу шлюза OMS с помощью следующего командлета PowerShell: `Restart-Service OMSGatewayService`.

Если компьютер подключен к службе автоматизации Azure с помощью командлета регистрации гибридной рабочей роли, выполните следующее:

1. Добавьте URL-адрес для регистрации службы агента в список разрешенных узлов в шлюзе OMS. Например: `Add-OMSGatewayAllowedHost ncus-agentservice-prod-1.azure-automation.net`
2. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе OMS. Например:  `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
3. Перезапустите службу шлюза OMS.
    `Restart-Service OMSGatewayService`

## <a name="useful-powershell-cmdlets"></a>Полезные командлеты PowerShell
Командлеты позволяют выполнять задачи, необходимые для обновления параметров конфигурации шлюза OMS. Перед их использованием выполните следующее:

1. Установите шлюз OMS (MSI).
2. Откройте окно PowerShell.
3. Чтобы импортировать модуль, введите эту команду: `Import-Module OMSGateway`.
4. Если при выполнении предыдущего шага не произошла ошибка, значит импорт модуля выполнен успешно и вы можете использовать командлеты. Введите `Get-Module OMSGateway`.
5. После внесения изменений с помощью командлетов перезапустите службу шлюза.

Если при выполнении шага 3 произошла ошибка, значит модуль не импортирован. Возможно, эта ошибка возникла, так как PowerShell не удалось найди модуль. Его можно найти по указанному пути установки шлюза: C:\Program Files\Microsoft OMS Gateway\PowerShell.

| **Командлет** | **Параметры** | **Описание** | **Примеры** |
| --- | --- | --- | --- |
| `Set-OMSGatewayConfig` |Ключ (обязательно) <br> Значение |Изменяет конфигурацию службы |`Set-OMSGatewayConfig -Name ListenPort -Value 8080` |
| `Get-OMSGatewayConfig` |Ключ |Получает конфигурацию службы |`Get-OMSGatewayConfig` <br> <br> `Get-OMSGatewayConfig -Name ListenPort` |
| `Set-OMSGatewayRelayProxy` |Адрес <br> Имя пользователя <br> Пароль |Задает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |1. Задайте прокси-сервер ответа и учетные данные: `Set-OMSGatewayRelayProxy -Address http://www.myproxy.com:8080 -Username user1 -Password 123` <br> <br> 2) Задайте прокси-сервер ответа, для которого не требуется проверка подлинности: `Set-OMSGatewayRelayProxy -Address http://www.myproxy.com:8080` <br> <br> 3. Очистите параметры прокси-сервера ответа (это означает, что прокси-сервер ответа не требуется): `Set-OMSGatewayRelayProxy -Address ""` |
| `Get-OMSGatewayRelayProxy` | |Получает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |`Get-OMSGatewayRelayProxy` |
| `Add-OMSGatewayAllowedHost` |Узел (обязательно) |Добавляет узел в список разрешенных |`Add-OMSGatewayAllowedHost -Host www.test.com` |
| `Remove-OMSGatewayAllowedHost` |Узел (обязательно) |Удаляет узел из списка разрешенных |`Remove-OMSGatewayAllowedHost -Host www.test.com` |
| `Get-OMSGatewayAllowedHost` | |Получает разрешенный в настоящее время узел (только локально настроенные разрешенные узлы; разрешенные узлы, скачанные автоматически, сюда не относятся) |`Get-OMSGatewayAllowedHost` |
| `Add-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Добавляет субъект сертификата клиента в список разрешенных |`Add-OMSGatewayAllowedClientCertificate -Subject mycert` |
| `Remove-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Удаляет субъект сертификата клиента из списка разрешенных |`Remove- OMSGatewayAllowedClientCertificate -Subject mycert` |
| `Get-OMSGatewayAllowedClientCertificate` | |Получает разрешенные в настоящее время субъекты сертификата клиента (только локально настроенные разрешенные субъекты; разрешенные субъекты, скачанные автоматически, сюда не относятся) |`Get-OMSGatewayAllowedClientCertificate` |

## <a name="troubleshoot"></a>Устранение неполадок
Агент OMS необходимо устанавливать на компьютерах с установленным шлюзом. Затем агент можно использовать для сбора событий, регистрируемых шлюзом.

![Средство просмотра событий — журнал шлюза OMS](./media/log-analytics-oms-gateway/event-viewer.png)

**Идентификаторы и описания событий шлюза OMS**

В следующей таблице приведены идентификаторы и описания событий журнала шлюза OMS.

| **Идентификатор** | **Описание** |
| --- | --- |
| 400 |Любая ошибка приложения без определенного идентификатора |
| 401 |Неправильная конфигурация. Например, для параметра listenPort задано значение text вместо integer |
| 402 |Исключение при анализе сообщений подтверждения TLS |
| 403 |Сетевая ошибка. Например, не удается подключиться к целевому серверу |
| 100 |Общие сведения |
| 101 |Служба запущена |
| 102 |Служба остановлена |
| 103 |Получена команда HTTP CONNECT от клиента |
| 104 |Команда HTTP CONNECT не получена |
| 105 |Целевой сервер не включен в список разрешенных или конечный порт небезопасен (443) <br> <br> Убедитесь, что агент MMA на сервере шлюза и агенты, взаимодействующие со шлюзом, подключены к одной рабочей области Log Analytics. |
| 105 |Ошибка TCP-подключения — недопустимый сертификат клиента: CN=Gateway <br><br> Убедитесь в следующем: <br>    <br> &#149; используется шлюз версии 1.0.395.0 или более поздней; <br> &#149; агент MMA на сервере шлюза и агенты, взаимодействующие со шлюзом, подключены к одной рабочей области Log Analytics. |
| 106 |Любая причина, по которой сеанс TLS считается подозрительным и отклоняется |
| 107 |Сеанс TLS проверен |

**Счетчики производительности, данные для которых необходимо собрать**

В следующей таблице приведены счетчики производительности, доступные для шлюза OMS. Счетчики можно добавить с помощью системного монитора.

| **Имя** | **Описание** |
| --- | --- |
| Шлюз OMS — Active Client Connection (Активные клиентские подключения) |Количество активных сетевых подключений клиента (TCP) |
| Шлюз OMS — Error Count (Количество ошибок) |Количество ошибок |
| Шлюз OMS — Connected Client (Подключенные клиенты) |Количество подключенных клиентов |
| Шлюз OMS — Rejection Count (Количество отклонений) |Количество отклонений из-за любых ошибок проверки TLS |

![Счетчики производительности шлюза OMS](./media/log-analytics-oms-gateway/counters.png)

## <a name="get-assistance"></a>Получение справки
На портале Azure можно запросить помощь по настройке шлюза OMS, а также любой службы или компонента службы Azure.
Чтобы запросить помощь, щелкните знак вопроса в правом верхнем углу портала и выберите **Новый запрос в службу поддержки**. Затем заполните форму нового запроса на поддержку.

![Новый запрос на техническую поддержку](./media/log-analytics-oms-gateway/support.png)

Кроме того, на [форуме обратной связи Microsoft Azure](https://feedback.azure.com/forums/267889) можно оставлять отзывы об OMS или Log Analytics.

## <a name="next-steps"></a>Дальнейшие действия
* [Добавьте источники данных](log-analytics-data-sources.md), чтобы собирать данные из подключенных источников в рабочую область OMS и сохранять их в репозитории OMS.



<!--HONumber=Feb17_HO2-->


