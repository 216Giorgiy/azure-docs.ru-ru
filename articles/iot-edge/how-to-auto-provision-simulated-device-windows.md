---
title: Автоматическая подготовка устройства Azure IoT Edge с помощью Службы подготовки устройств к добавлению в Центр Интернета вещей в Windows | Документация Майкрософт
description: Использование имитированного устройства на компьютере Windows для тестирования автоматической подготовки устройств для Azure IoT Edge с помощью Службы подготовки устройств к добавлению в Центр Интернета вещей
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 06/27/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 46970d5628df3b46ec88df998a328928f60e15b4
ms.sourcegitcommit: e32ea47d9d8158747eaf8fee6ebdd238d3ba01f7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/17/2018
ms.locfileid: "39090237"
---
# <a name="create-and-provision-a-simulated-tpm-edge-device-on-windows"></a>Создание и подготовка имитированного устройства IoT Edge TPM в Windows

Устройства Azure IoT Edge можно подготовить автоматически с помощью [Службы подготовки устройств к добавлению в Центр Интернета вещей](../iot-dps/index.yml) точно так же, как и другие устройства. При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить. 

В этой статье показано, как протестировать функцию автоматической подготовки на имитированном устройстве IoT Edge, с помощью следующих действий: 

* Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
* Создание имитированного устройства на компьютере Windows с имитированным доверенным платформенным модулем (TPM) для обеспечения безопасности оборудования.
* Создание отдельной регистрации устройства.
* Установка среды выполнения IoT Edge и подключение устройства к Центру Интернета вещей.

## <a name="prerequisites"></a>Предварительные требования

* Компьютер для разработки Windows. В этой статье используется Windows 10. 
* Действующий Центр Интернета вещей. 

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge. 

## <a name="simulate-a-tpm-device"></a>Имитация устройства TPM

Создайте имитированное устройства доверенного платформенного модуля на компьютере Windows для разработки. Получите **идентификатор регистрации** и **ключ подтверждения** для устройства и используйте их для создания записи индивидуальной регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей. 

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md). 

Выберите язык пакета SDK для создания имитации устройства, а затем создайте отдельную регистрацию. 

При этом выберите **Включить**, чтобы объявить, что эта виртуальная машина является **устройством IoT Edge**.

Руководства по использованию виртуальных устройств и отдельной регистрации: 
* [C](../iot-dps/quick-create-simulated-device.md)
* [Java](../iot-dps/quick-create-simulated-device-tpm-java.md)
* [C#](../iot-dps/quick-create-simulated-device-tpm-csharp.md)
* [Node.js](../iot-dps/quick-create-simulated-device-tpm-node.md)
* [Python](../iot-dps/quick-create-simulated-device-tpm-python.md)

Создав отдельную регистрацию, сохраните значение **идентификатора регистрации**. Это значение используется при настройке среды выполнения IoT Edge. 

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе. На устройствах под управлением Windows вы можете использовать контейнеры Windows или Linux. Выберите требуемый тип контейнеров и следуйте инструкциям. Среда выполнения IoT Edge должна быть настроена на автоматическую подготовку, а не подготовку вручную. 

Следуйте инструкциям по установке среды выполнения IoT Edge на устройстве, на котором выполняется имитированный доверенный платформенный модуль, из предыдущего раздела. 

Узнайте **область идентификатора** Службы подготовки устройств к добавлению в Центр Интернета вещей и **идентификатор регистрации** устройства, прежде чем переходить к следующим статьям. 

* [Контейнеры Windows](how-to-install-iot-edge-windows-with-windows.md)
* [Контейнеры Linux](how-to-install-iot-edge-windows-with-linux.md)

## <a name="create-a-tpm-environment-variable"></a>Создание переменной окружения доверенного платформенного модуля

На компьютере с запущенным имитированным устройством измените реестр службы **iotedge**, чтобы задать переменную среды.

1. В меню **Пуск** введите **regedit**. 
2. Перейдите в раздел **Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\iotedge**. 
3. Выберите **Изменить** > **Создать** > **Многострочное значение**. 
4. Введите имя **среды**. 
5. Дважды щелкните новую переменную и задайте для нее значение **IOTEDGE_USE_TPM_DEVICE=ON**. 
6. Нажмите кнопку **ОК** , чтобы сохранить изменения. 

## <a name="restart-the-iot-edge-runtime"></a>Перезапуск среды выполнения IoT Edge

Перезапустите среду выполнения IoT Edge, чтобы активировать все изменения конфигурации, внесенные на устройстве. 

```powershell
Stop-Service iotedge -NoWait
sleep 5
Start-Service iotedge
```

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена, перейдите в Центр Интернета вещей и проверьте, что новое устройство автоматически подготовлено и готово для запуска модулей IoT Edge. 

Проверьте состояние службы IoT Edge.

```powershell
Get-Service iotedge
```

Просмотрите журналы службы за последние пять минут.

```powershell
# Displays logs from last 5 min, newest at the bottom.

Get-WinEvent -ea SilentlyContinue `
  -FilterHashtable @{ProviderName= "iotedged";
    LogName = "application"; StartTime = [datetime]::Now.AddMinutes(-5)} |
  select TimeCreated, Message |
  sort-object @{Expression="TimeCreated";Descending=$false}
```

Просмотрите список запущенных модулей.

```powershell
iotedge list
```

## <a name="next-steps"></a>Дополнительная информация

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. См. дополнительные сведения о развертывании и мониторинге модулей IoT Edge с поддержкой масштабирования с помощью [портала Azure](how-to-deploy-monitor.md) или [Azure CLI](how-to-deploy-monitor-cli.md).