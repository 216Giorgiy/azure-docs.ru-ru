---
title: Развертывание службы "Машинное обучение Azure" для Azure IoT Edge | Документация Майкрософт
description: В этом руководстве вы развернете службу "Машинное обучение Azure" в качестве модуля на пограничном устройстве.
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 06/25/2018
ms.topic: tutorial
ms.service: iot-edge
services: iot-edge
ms.custom: mvc
ms.openlocfilehash: 28b963922b423bb776aa97e9b76392bc484ddcd6
ms.sourcegitcommit: 4de6a8671c445fae31f760385710f17d504228f8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/08/2018
ms.locfileid: "39627813"
---
# <a name="tutorial-deploy-azure-machine-learning-as-an-iot-edge-module-preview"></a>Руководство: развертывание службы "Машинное обучение Azure" в качестве модуля IoT Edge (предварительная версия)

Вы можете использовать модули IoT Edge для развертывания кода, который реализует вашу бизнес-логику непосредственно на устройствах IoT Edge. В этом руководстве рассматривается развертывание модуля машинного обучения Azure, который прогнозирует, когда устройство выходит из строя на основе данных моделируемой машинной температуры. Дополнительные сведения о Машинном обучении Azure в IoT Edge см. в [документации по Машинному обучению Azure](../machine-learning/desktop-workbench/use-azure-iot-edge-ai-toolkit.md).

Модуль машинного обучения Azure, который вы создадите в этом руководстве, считывает сформированные устройством данные об окружающей среде и отмечает сообщения как аномальные или нет.

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание модуля машинного обучения Azure
> * Отправка контейнера модуля в реестр контейнеров Azure
> * Развертывание модуля машинного обучения Azure на устройстве IoT Edge
> * Просмотр сформированных данных

>[!NOTE]
>Модули машинного обучения Azure в Azure IoT Edge находятся в общедоступной предварительной версии. 

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]


## <a name="prerequisites"></a>Предварительные требования

Устройство Azure IoT Edge.

* В качестве устройства Azure IoT Edge можно использовать компьютер, на котором ведется разработка, или виртуальную машину. Для этого выполните действия, описанные в кратком руководстве для устройств [Linux](quickstart-linux.md) или [Windows](quickstart.md).
* Модуль машинного обучения Azure не поддерживает процессоры ARM.

Облачные ресурсы.

* [Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) цен. категории "Стандартный" в Azure. 
* Учетная запись Студии машинного обучения Azure. Выполните инструкции из статьи [Create Azure Machine Learning accounts and install Azure Machine Learning Workbench](../machine-learning/service/quickstart-installation.md#create-azure-machine-learning-services-accounts) (Создание учетной записи для службы "Машинное обучение Azure" и установка Azure Machine Learning Workbench). Для этого руководства не нужно устанавливать приложение рабочего места (Workbench). 

Ресурсы разработки.

* Служба "Управление моделями" для службы "Машинное обучение Azure". Чтобы настроить среду и создать учетную запись, выполните инструкции из раздела о [настройке управления моделью](../machine-learning/desktop-workbench/deployment-setup-configuration.md). Во время установки развертывания рекомендуется выбирать локальную настройку вместо кластера, когда это возможно.

### <a name="disable-process-identification"></a>Отключение процесса идентификации

>[!NOTE]
>
> В предварительном просмотре машинное обучение Azure не поддерживает включенную по умолчанию с помощью IoT Edge функцию защиты процесса идентификации. 
> Ниже приведены шаги по ее отключению. Однако это не подходит для использования в рабочей среде. Эти действия необходимы только в Linux, так как они выполняются на этапе установки среды выполнения Windows Edge.

Чтобы отключить процесс идентификации на устройстве IoT Edge, в конфигурации управляющей программы IoT Edge в разделе **connect** для **workload_uri** и **management_uri** необходимо указать IP-адрес и порт.

Сначала получите IP-адрес. Введите `ifconfig` в командную строку и скопируйте IP-адрес интерфейса **docker0**.

Измените файл конфигурации управляющей программы IoT Edge.

```cmd/sh
sudo nano /etc/iotedge/config.yaml
```

Обновите раздел конфигурации **Подключение**, указав свой IP-адрес. Например: 
```yaml
connect:
  management_uri: "http://172.17.0.1:15580"
  workload_uri: "http://172.17.0.1:15581"
```

Введите те же адреса в раздел конфигурации **Ожидание передачи данных**. Например: 

```yaml
listen:
  management_uri: "http://172.17.0.1:15580"
  workload_uri: "http://172.17.0.1:15581"
```

Создайте переменную среды IOTEDGE_HOST с адресом management_uri (Чтобы установить ее на постоянно, добавьте в `/etc/environment`). Например:

```cmd/sh
export IOTEDGE_HOST="http://172.17.0.1:15580"
```


## <a name="create-the-azure-ml-container"></a>Создание контейнера машинного обучения Azure
В этом разделе выполняется скачивание файлов обученной модели и их преобразование в контейнер Azure ML.

На компьютере с запущенной службой "Управление моделями" для службы "Машинное обучение Azure" скачайте и сохраните файлы [iot_score.py](https://github.com/Azure/ai-toolkit-iot-edge/blob/master/IoT%20Edge%20anomaly%20detection%20tutorial/iot_score.py) и [model.pkl](https://github.com/Azure/ai-toolkit-iot-edge/blob/master/IoT%20Edge%20anomaly%20detection%20tutorial/model.pkl) из набора средств Azure ML IoT на GitHub. Эти файлы определяют обученную модель машинного обучения, которую вы развернете на своем устройстве Iot Edge.

С помощью обученной модели создайте контейнер, который можно развернуть на устройствах IoT Edge. Используйте эту команду для следующих задач:

   * регистрация модели;
   * Создайте манифест.
   * создание образа контейнера Docker с именем *machinelearningmodule*;
   * развертывание образа в кластере службы Azure Kubernetes (AKS).

```cmd
az ml service create realtime --model-file model.pkl -f iot_score.py -n machinelearningmodule -r python
```

### <a name="view-the-container-repository"></a>Просмотр репозитория контейнеров

Убедитесь, что образ контейнера создан и сохранен в реестр контейнеров Azure, который связан со средой машинного обучения.

1. На [портале Azure](https://portal.azure.com), перейдите в меню **Все службы** и выберите **Реестры контейнеров**.
2. Выберите ваш реестр. Имя должно начинаться с **mlcr** и относиться к группе ресурсов, расположению и подписке, которые использовались для настройки Module Management.
3. Выберите **Ключи доступа**.
4. Скопируйте значения **Сервер входа**, **Имя пользователя** и **Пароль**.  Они потребуются для доступа к реестру с устройств Edge.
5. Выберите **Репозитории**
6. Выберите **machinelearningmodule**
7. Теперь у вас есть полный путь к образу контейнера. Запишите этот путь для использования в следующем разделе. Он должен выглядеть следующим образом: **<имя_реестра>.azurecr.io/machinelearningmodule:1**.

## <a name="deploy-to-your-device"></a>Развертывание на устройстве

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com).

1. Щелкните **IoT Edge** и выберите устройство IoT Edge.

1. Щелкните **Set modules** (Настроить модули).

1. В разделе **Параметры реестра** добавьте учетные данные, которые скопированы из реестра контейнеров Azure. 

   ![Добавьте учетные данные реестра](./media/tutorial-deploy-machine-learning/registry-settings.png)

1. Если модуль tempSensor на вашем устройстве IoT Edge уже развернут, эти данные могут быть заполнены автоматически. Если его еще нет в списке модулей, добавьте его.

    1. Щелкните **Добавить** и выберите **Модуль IoT Edge**.
    2. В поле **Имя** введите `tempSensor`.
    3. В поле **URI образа** введите `mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0`.
    4. Щелкните **Сохранить**.

1. Добавьте созданный модуль машинного обучения.

    1. Щелкните **Добавить** и выберите **Модуль IoT Edge**.
    1. В поле **Имя** введите `machinelearningmodule`.
    1. В поле **Образ** введите адрес образа, например `<registry_name>.azurecr.io/machinelearningmodule:1`.
    1. Щелкните **Сохранить**.

1. Вернитесь к окну **Добавление модулей** и нажмите кнопку **Далее**.

1. На шаге **Specify Routes** (Указание маршрутов) скопируйте приведенный ниже код JSON в текстовое поле. Первый маршрут передает сообщения от датчика температуры в модуль машинного обучения через конечную точку amlInput, являющуюся конечной точкой, используемой всеми модулями службы "Машинное обучение Azure". Второй маршрут передает сообщения из модуля машинного обучения в Центр Интернета вещей. В этом маршруте amlOutput — это конечная точка, используемая всеми модулями службы "Машинное обучение Azure" для вывода данных, а $upstream обозначает Центр Интернета вещей.

    ```json
    {
        "routes": {
            "sensorToMachineLearning":"FROM /messages/modules/tempSensor/outputs/temperatureOutput INTO BrokeredEndpoint(\"/modules/machinelearningmodule/inputs/amlInput\")",
            "machineLearningToIoTHub": "FROM /messages/modules/machinelearningmodule/outputs/amlOutput INTO $upstream"
        }
    }
    ```

1. Щелкните **Далее**.

1. В окне **Проверка развертывания** выберите **Отправить**.

1. Вернитесь на страницу сведений об устройстве и выберите **Обновить**.  Должен отобразиться новый модуль **machinelearningmodule**, запущенный вместе с модулем **tempSensor** и модулями среды выполнения IoT Edge.

## <a name="view-generated-data"></a>Просмотр сформированных данных

Можно просматривать сообщения, формируемые каждым модулем IoT Edge, а также просматривать сообщения, доставленные в центр IoT.

### <a name="view-data-on-your-iot-edge-device"></a>Представление данных на устройстве IoT Edge

На устройстве IoT Edge можно просмотреть сообщения, отправляемые из каждого отдельного модуля. 

При выполнении этих команд на устройстве Linux, может потребоваться использование `sudo` для увеличения разрешения.

1. Просмотрите все модули на устройстве IoT Edge.

   ```cmd/sh
   iotedge list
   ```

2. Убедитесь, что сообщения отправляются из конкретного устройства. Используйте имя модуля из вывода предыдущей команды.

   ```cmd/sh
   iotedge logs <module_name> -f
   ```

### <a name="view-data-arriving-at-your-iot-hub"></a>Представление данных, поступающих в центр IoT

Можно просматривать сообщения с устройства в облако, которые получает Центр Интернета вещей, используя [расширение Azure IoT Toolkit для Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit).

Следующие шаги показывают, как настроить Visual Studio Code для контроля за сообщениями с устройства в облако, поступающие в центр IoT. 

1. В Visual Studio Code выберите **IoT Hub Devices** (Устройства Центра Интернета вещей).

2. Выберите меню **...**, затем — **Set IoT Hub Connection String** (Задать строку подключения Центра Интернета вещей).

   ![Дополнительное меню "Устройства Центра Интернета вещей"](./media/tutorial-deploy-machine-learning/set-connection.png)

3. В текстовое поле, которое откроется в верхней части страницы, введите строку подключения для вашего Центра Интернета вещей — iothubowner. Устройство IoT Edge должно появиться в списке устройств Центра Интернета вещей.

4. Выберите **...** еще раз, а затем выберите **Start monitoring D2C message** (Начать мониторинг сообщения D2C).

5. Просмотрите сообщения, поступающие от tempSensor каждые пять секунд. Текст сообщения содержит свойство с именем **anomaly**, которое модуль machinelearningmodule отображает со значением true или false. Свойство **AzureMLResponse** свойство содержит значение "OK", если модель выполнен успешно.

   ![Ответ Azure ML в теле сообщения](./media/tutorial-deploy-machine-learning/ml-output.png)

## <a name="clean-up-resources"></a>Очистка ресурсов 

<!--[!INCLUDE [iot-edge-quickstarts-clean-up-resources](../../includes/iot-edge-quickstarts-clean-up-resources.md)] -->

При переходе к следующей рекомендованной статье можно сохранить уже созданные ресурсы и конфигурации и повторно их использовать.

В противном случае можно удалить локальные конфигурации и ресурсы Azure, созданные в рамках этой статьи, чтобы избежать расходов. 

> [!IMPORTANT]
> Удаление ресурсов Azure и группы ресурсов является необратимым. Группа ресурсов и все содержащиеся в ней ресурсы удаляются без возможности восстановления. Будьте внимательны, чтобы случайно не удалить не ту группу ресурсов или не те ресурсы. Если вы создали Центр Интернета вещей в группе ресурсов, содержащей ресурсы, которые нужно сохранить, удалите только ресурс Центра Интернета вещей, не удаляя всю группу ресурсов.
>

Чтобы удалить только Центр Интернета вещей, выполните следующую команду, указав имена центра и группы ресурсов:

```azurecli-interactive
az iot hub delete --name {hub_name} --resource-group IoTEdgeResources
```


Чтобы удалить группу ресурсов по имени, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com) и щелкните **Группы ресурсов**.

2. Введите в текстовое поле **Фильтровать по имени...** имя группы ресурсов, содержащей Центр Интернета вещей. 

3. Справа от своей группы ресурсов в списке результатов щелкните **...**, а затем выберите **Удалить группу ресурсов**.

<!--
   ![Delete](./media/iot-edge-quickstarts-clean-up-resources/iot-edge-delete-resource-group.png)
-->
4. Подтвердите операцию удаления группы ресурсов. Еще раз введите имя группы ресурсов для подтверждения и нажмите кнопку **Удалить**. Через некоторое время группа ресурсов и все ее ресурсы будут удалены.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы развернули модуль IoT Edge на базе службы "Машинное обучение Azure". Вы можете перейти к любому из оставшихся руководств, чтобы узнать о других способах, с помощью которых Azure IoT Edge может помочь вам превратить данные в бизнес-аналитику на пограничном устройстве.

> [!div class="nextstepaction"]
> [Фильтрация данных датчика, с помощью кода C#](tutorial-csharp-module.md)

<!--Links-->
[lnk-tutorial1-win]: quickstart.md
[lnk-tutorial1-lin]: quickstart-linux.md
