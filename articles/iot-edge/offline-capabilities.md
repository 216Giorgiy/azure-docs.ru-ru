---
title: Автономные возможности Azure IoT Edge | Документы Майкрософт
description: Понять, как устройства и модули IoT Edge могут работать автономно в течение долгого периода времени и как обычные устройства Интернета вещей могут работать автономно с помощью IoT Edge.
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 09/20/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 30b85f15d8718e21af66634db5a4afd5623a77e6
ms.sourcegitcommit: 1aacea6bf8e31128c6d489fa6e614856cf89af19
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2018
ms.locfileid: "49340177"
---
# <a name="understand-extended-offline-capabilities-for-iot-edge-devices-modules-and-child-devices-preview"></a>Сведения о расширенных возможностях автономной работы устройств, модулей и дочерних устройств IoT Edge (предварительная версия)

Azure IoT Edge поддерживает расширенную автономную работу устройств IoT Edge и обеспечивает автономную работу для дочерних устройств не из Edge. Пока у устройства IoT Edge есть возможность подключиться к центру Интернета вещей, оно и его дочерние устройства могут продолжать работу с нестабильным подключением к Интернету или даже без него. 

>[!NOTE]
>Автономная поддержка IoT Edge находится на стадии [общедоступной предварительной версии](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="how-it-works"></a>Принцип работы

Когда устройство IoT Edge переходит в автономный режим, центр Edge выполняет три роли. Во-первых, он хранит все сообщения, которые необходимо отправить, до тех пор, пока соединение с устройством не будет восстановлено. Во-вторых, он выступает от имени центра Интернета вещей и проверяет подлинность модулей и дочерних устройств, чтобы они продолжали работу. В-третьих, он обеспечивает связь между дочерними устройствами, которая обычно проходит через центр Интернета вещей. 

В следующем примере показано, как IoT Edge работает в автономном режиме:

1. **Настройте устройство IoT Edge.**

   Функция автономной работы включена на устройствах IoT Edge автоматически. Чтобы дать эту возможность другим устройствам Интернета вещей, необходимо объявить отношение "родитель-дочерний элемент" между устройствами в центре Интернета вещей. 

2. **Синхронизируйтесь с Центром Интернета вещей.**

   Хотя бы один раз после установки среды выполнения IoT Edge необходимо подключить устройство IoT Edge к сети для синхронизации с центром Интернета вещей. Во время синхронизации устройство IoT Edge получает сведения о назначенных ему дочерних устройствах. Устройство IoT Edge безопасно обновляет свой локальный кэш, чтобы можно было продолжать работу автономно, и извлекает параметры для локального хранения сообщений телеметрии. 

3. **Перейдите в автономный режим.**

   При отключении от центра Интернета вещей устройств IoT Edge его развернутые модули и любые дочерние устройства Интернета вещей могут работать бесконечно. Модули и дочерние устройства могут запускаться и перезапускаться через проверку подлинности в центре Edge в автономном режиме. Восходящий поток телеметрии в центр Интернета вещей хранится локально. Обмен данными между модулями или дочерними устройствами Интернета вещей поддерживается через прямые методы или сообщения. 

4. **Подключитесь повторно и снова синхронизируйтесь с Центром Интернета вещей.**

   После восстановления связи с центром Интернета вещей устройство IoT Edge будет снова синхронизировано. Локально хранимые сообщения доставляются в том же порядке, в котором они были сохранены. Все различия между требуемыми и сообщаемыми свойствами модулей и устройств будут согласованы. Устройство IoT Edge передает все изменения в свои назначенные дочерние устройства.

## <a name="restrictions-and-limits"></a>Ограничения

Расширенные возможности автономной работы, описанные в этой статье, доступны в [IoT Edge версии 1.0.2 или более поздней версии](https://github.com/Azure/azure-iotedge/releases). Более ранние версии имеют подмножество автономных функций. Существующие устройства IoT Edge без расширенных возможностей автономной работы невозможно обновить, изменив версию среды выполнения. Необходимо изменить их конфигурацию с использованием нового удостоверения устройства IoT Edge, чтобы использовать эти функции. 

Расширенная поддержка автономной работы доступна во всех регионах, где есть центр Интернета вещей, за исключением восточной части США и Западной Европы. 

В качестве дочерних устройств можно добавить только устройства не из IoT Edge. 

Устройства IoT Edge и их дочерние устройства могут неограниченное время работать в автономном режиме после первой однократной синхронизации. Однако хранение сообщений зависит от срока жизни (TTL) и доступного места на диске для хранения сообщений. 

## <a name="set-up-an-edge-device"></a>Настройка устройства IoT Edge

Для любого устройства IoT Edge, которое должно длительное время работать в автономном режиме, настройте среду выполнения IoT Edge для обмена данными через MQTT. 

Чтобы возможности автономной работы устройства IoT Edge распространялись на дочерние устройства Интернета вещей, необходимо объявить отношения "родитель-дочерний элемент" на портале Azure.

### <a name="set-the-upstream-protocol-to-mqtt"></a>Настройка вышестоящего протокола MQTT

Настройте центр Edge и агент Edge для обмена данными по протоколу MQTT в качестве вышестоящего протокола. Этот протокол объявляется с помощью переменных среды в манифесте развертывания. 

На портале Azure вы найдете определения модулей центра Edge и агента Edge — нажмите кнопку **Настройка дополнительных параметров среды выполнения Edge** при настройке модулей для развертывания. Для обоих модулей создайте переменную среды с именем **UpstreamProtocol** и присвойте ей значение **MQTT**. 

В шаблоне развертывания JSON переменные среды объявляются, как показано в следующем примере: 

```json
"edgeHub": {
    "type": "docker",
    "settings": {
        "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
        "createOptions": "{\"HostConfig\":{\"PortBindings\":{\"8883/tcp\":[{\"HostPort\":\"8883\"}],\"443/tcp\":[{\"HostPort\":\"443\"}],\"5671/tcp\":[{\"HostPort\":\"5671\"}]}}}"
    },
    "env": {
        "UpstreamProtocol": {
            "value": "MQTT"
        }
    },
    "status": "running",
    "restartPolicy": "always"
}
```

### <a name="assign-child-devices"></a>Назначение дочерних устройств

Дочерние устройства могут быть любыми устройствами не Edge, зарегистрированными в одном центре Интернета вещей. Вы можете привязывать дочерние устройства при создании нового устройства или на странице сведений о родительском или дочернем устройстве Интернета вещей. 

   ![Управление дочерними устройствами на странице сведений об устройстве IoT Edge](./media/offline-capabilities/manage-child-devices.png)

Родительские устройства могут иметь несколько дочерних устройств, но дочернее устройство может иметь только один родительский элемент.

## <a name="optional-offline-settings"></a>Дополнительные параметры автономной работы

Если ожидается, что устройства будут длительное время работать в автономном режиме, а затем необходимо будет собрать все созданные за этот период сообщения, настройте центр Edge для хранения всех сообщений. Существует два изменения, которые можно внести в центр Edge, чтобы включить долгосрочное хранение сообщений. Сначала увеличьте срок жизни, а затем добавьте дополнительное место на диске для хранения сообщений. 

### <a name="time-to-live"></a>Срок жизни

Срок жизни — это период времени (в секундах), в течение которого сообщение ожидает доставки, прежде чем срок его действия истечет. По умолчанию это 7200 секунд (два часа). 

Этот параметр является требуемым свойством центра Edge, которое хранится в двойнике модуля. Его можно настроить на портале Azure в разделе **Настройка дополнительных параметров среды выполнения Edge** или непосредственно в манифесте развертывания. 

```json
"$edgeHub": {
    "properties.desired": {
        "schemaVersion": "1.0",
        "routes": {},
        "storeAndForwardConfiguration": {
            "timeToLiveSecs": 7200
        }
    }
}
```

### <a name="additional-offline-storage"></a>Дополнительное хранилище в автономном режиме

По умолчанию сообщения хранятся в файловой системе контейнера центра Edge. Если этого объема недостаточно для ваших потребностей, вы можете выделить локальное хранилище на устройстве IoT Edge. Вам нужно создать переменную среды для центра Edge, которая указывает на папку хранения в контейнере. Затем используйте параметры создания для привязки этой папки хранения к папке на хост-компьютере. 

Вы можете настроить переменные среды и параметры создания для модуля центра Edge на портале Azure в разделе **Настройка дополнительных параметров среды выполнения Edge**. Или вы можете указать эти значения непосредственно в манифесте развертывания. 

```json
"edgeHub": {
    "type": "docker",
    "settings": {
        "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
        "createOptions": "{\"HostConfig\":{\"Binds\":[\"<HostStoragePath>:<ModuleStoragePath>\"],\"PortBindings\":{\"8883/tcp\":[{\"HostPort\":\"8883\"}],\"443/tcp\":[{\"HostPort\":\"443\"}],\"5671/tcp\":[{\"HostPort\":\"5671\"}]}}}"
    },
    "env": {
        "storageFolder": {
            "value": "<ModuleStoragePath>"
        }
    },
    "status": "running",
    "restartPolicy": "always"
}
```

Замените `<HostStoragePath>` и `<ModuleStoragePath>` путями к хранилищу узла и модуля соответственно; это должны быть абсолютные пути.  Например, `\"Binds\":[\"/etc/iotedge/storage/:/iotedge/storage/"` означает, что путь к узлу `/etc/iotedge/storage` сопоставляется с путем к контейнеру `/iotedge/storage/`.  Кроме того, дополнительные сведения о createOptions можно найти в [документации docker](https://docs.docker.com/engine/api/v1.32/#operation/ContainerCreate).

## <a name="next-steps"></a>Дополнительная информация

Включите расширенные возможности автономной работы при использовании прозрачного шлюза для устройств [Linux](how-to-create-transparent-gateway-linux.md) или [Windows](how-to-create-transparent-gateway-windows.md).
