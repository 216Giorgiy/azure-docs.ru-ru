---
title: Отладка модулей C# для Azure IoT Edge | Документация Майкрософт
description: Использование Visual Studio Code для разработки, компиляции и отладки модулей C# для Azure IoT Edge
services: iot-edge
keywords: ''
author: shizn
manager: timlt
ms.author: xshi
ms.date: 09/27/2018
ms.topic: article
ms.service: iot-edge
ms.openlocfilehash: 88659d31b64b4a98043606a71602f7c29316a31e
ms.sourcegitcommit: 42405ab963df3101ee2a9b26e54240ffa689f140
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2018
ms.locfileid: "47423295"
---
# <a name="use-visual-studio-code-to-develop-and-debug-c-modules-for-azure-iot-edge"></a>Использование Visual Studio Code для разработки и отладки модулей C# для Azure IoT Edge

Вы можете превратить бизнес-логику в модули для Azure IoT Edge. Эта статья описывает, как использовать Visual Studio Code (VS Code) в качестве основного средства для разработки и отладки модулей C#.

## <a name="prerequisites"></a>Предварительные требования

Для разработки вы должны использовать компьютер или виртуальную машину под управлением Windows, macOS или Linux. Устройство IoT Edge может быть другим физическим устройством.

Существует два способа отладки модуля C# в VS Code. Один из способов — подключить процесс в контейнере модуля, а второй — запустить код модуля в режиме отладки. С возможностями отладки Visual Studio Code можно ознакомиться в [этой статье](https://code.visualstudio.com/Docs/editor/debugging).

Сначала установите Visual Studio Code, а затем добавьте следующие необходимые расширения:
* [Visual Studio Code](https://code.visualstudio.com/) 
* [расширение Azure IoT Edge](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-edge); 
* [расширение C#](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp); 
* [расширение Docker](https://marketplace.visualstudio.com/items?itemName=PeterJausovec.vscode-docker).

Чтобы создать модуль, требуется .NET для создания папки проекта, Docker для создания образа модуля и реестр контейнеров для хранения образа модуля:
* [Пакет SDK для .NET Core 2.1](https://www.microsoft.com/net/download).
* [Docker Community Edition](https://docs.docker.com/install/) на компьютере, на котором ведется разработка. 
* [Реестр контейнеров Azure](https://docs.microsoft.com/azure/container-registry/) или [Docker Hub](https://docs.docker.com/docker-hub/repos/#viewing-repository-tags).
   * Вместо облачного реестра можно использовать локальный реестр Docker для создания прототипов и тестирования. 

Чтобы настроить локальную среду разработки для отладки, запуска и тестирования решения IoT Edge, требуется [средство разработки Azure IoT EdgeHub](https://pypi.org/project/iotedgehubdev/). Установите [Python (2.7/3.6) и Pip](https://www.python.org/). Затем установите **iotedgehubdev**, выполнив следующую команду в окне терминала.

   ```cmd
   pip install --upgrade iotedgehubdev
   ```

Для тестирования модуля на устройстве требуется активный Центр Интернета вещей по крайней мере с одним созданным идентификатором устройства IoT Edge. Если вы запустили управляющую программу IoT Edge на компьютере разработки, может потребоваться остановить EdgeHub и EdgeAgent, прежде чем перейти к следующему шагу. 

## <a name="create-a-new-solution-with-c-module"></a>Создание решения с модулем C#

Выполните описанные здесь действия, чтобы создать модуль IoT Edge на основе .NET Сore 2.1 с использованием Visual Studio Code и расширения Azure IoT Edge. Сначала нужно создать решение, а затем сформировать в нем первый модуль. Каждое решение может содержать несколько модулей. 

1. В Visual Studio Code выберите **Вид** > **Интегрированный терминал**.
2. Выберите **Представление** > **Палитра команд**. 
3. В палитре команд введите и выполните команду **Azure IoT Edge: New IoT Edge Solution**.

   ![Запуск команды создания решения IoT Edge](./media/how-to-develop-csharp-module/new-solution.png)

4. Перейдите к папке, где требуется создать решение. Щелкните **Выбрать папку**. 
5. Введите имя для решения. 
6. Выберите **Модуль C#** в качестве шаблона для первого модуля в решении.
7. Введите имя модуля. Оно должно быть уникальным в пределах реестра контейнеров. 
8. Укажите имя репозитория образов для модуля. VS Code автоматически заполняет имя модуля значением **localhost:5000**. Замените его собственными данными реестра. Если для тестирования вы используете локальный реестр Docker, вполне подойдет значение **localhost**. Если используется Реестр контейнеров Azure, укажите сервер входа, заданный в параметрах реестра. Значение для сервера входа выглядит так: **\<имя реестра\>.azurecr.io**. Замените только часть строки localhost, не удаляйте имя модуля.

   ![Выбор репозитория образа Docker](./media/how-to-develop-csharp-module/repository.png)

VS Code принимает предоставленные сведения, создает решение IoT Edge, а затем загружает его в новом окне.

   ![Просмотр решения IoT Edge](./media/how-to-develop-csharp-module/view-solution.png)

В решении существует четыре элемента: 

* Папка **.vscode** содержит конфигурации отладки.
* Папка **modules** содержит вложенные папки для каждого модуля. На этом этапе у вас всего один модуль. Но вы можете добавить модули в палитре команд с помощью команды **Azure IoT Edge: Add IoT Edge Module**. 
* В файле **ENV** перечислены переменные среды. Если реестр контейнеров Azure является вашим реестром, вы получите в нем имя пользователя и пароль для реестра контейнеров Azure. 

   >[!NOTE]
   >Файл среды создается только в том случае, если вы указали репозиторий образов для модуля. Если вы не изменяли значения по умолчанию localhost для тестирования и отладки локально, объявлять переменные среды не требуется. 

* В файле **deployment.template.json** указан новый модуль, а также пример модуля **tempSensor**, который имитирует данные для тестирования. Дополнительные сведения о том, как работают манифесты развертывания, см. в разделе [Сведения об использовании манифестов развертывания для развертывания модулей и установки маршрутов](module-composition.md). 

## <a name="develop-your-module"></a>Разработка модуля

Код модуля С#, который поставляется с решением, по умолчанию находится в **modules** > ** [имя модуля] ** > **Program.cs**. Модуль и файл deployment.template.json настраиваются так, чтобы можно было собрать решение, передать его в реестр контейнеров и развернуть на устройстве, чтобы начать тестирование, не меняя код. Модуль просто принимает входные данные из источника (в данном случае модуль tempSensor имитирует данные) и передает их в Центр Интернета вещей. 

Когда вы будете готовы настроить шаблон C# с добавлением собственного кода, используйте [пакеты SDK для Центра Интернета вещей Azure](../iot-hub/iot-hub-devguide-sdks.md), чтобы создать модули, которые удовлетворяют ключевые потребности решений Интернета вещей, такие как безопасность, управление устройствами и надежность. 

Поддержка C# в VS Code оптимизирована для кроссплатформенной разработки в .NET Core. Дополнительные сведения о [способах работы с C# в VS Code](https://code.visualstudio.com/docs/languages/csharp).

## <a name="launch-and-debug-module-code-without-container"></a>Запуск и отладка кода модуля без контейнера

Модуль IoT Edge на C# является приложением .NET Core. Он зависит от пакета Azure SDK для устройства Интернета вещей для C#. Так как модуль IoT C# требует, чтобы настройки среды запускались и выполнялись в коде модуля по умолчанию, то инициализируется **ModuleClient** с параметрами среды и входным именем. Также необходимо отправлять или маршрутизировать сообщения во входные каналы. Модуль C# по умолчанию содержит только один канал входных данных, который называется **input1**.

### <a name="setup-iot-edge-simulator-for-single-module-app"></a>Настройка симулятора IoT Edge для приложения одного модуля

1. Чтобы настроить и запустить симулятор, в палитре команд VS Code введите и выберите **Azure IoT Edge: Start IoT Edge Hub Simulator for Single Module** (Azure IoT Edge. Запуск симулятора центра IoT Edge для одного модуля). Необходимо также указать имена входных каналов для приложения одного модуля, введите **input1** и нажмите клавишу ВВОД. Команда активирует CLI **iotedgehubdev** и запустит симулятор IoT Edge и тестирование контейнера модуля служебной программы. Вы можете увидеть приведенные ниже выходные данные во встроенном терминале, если симулятор был успешно запущен в режиме одного модуля. Также вы увидите команду `curl`, помогающую при пересылке сообщений. Оно понадобится вам позже.

   ![Настройка симулятора IoT Edge для приложения одного модуля](media/how-to-develop-csharp-module/start-simulator-for-single-module.png)

   Вы можете перейти в Docker Explorer и просмотреть состояние работы модуля.

   ![Состояние модуля симулятора](media/how-to-develop-csharp-module/simulator-status.png)

   Контейнер **edgeHubDev** — это ядро локального симулятора IoT Edge. Можно запустить его на компьютере разработки без управляющей программы безопасности IoT Edge и предоставлять параметры среды для собственного приложения модуля или контейнеров модуля. Контейнер **input** предоставляет REST API, помогающие отправлять сообщения в целевой входной канал в вашем модуле.

2. В палитре команд VS Code введите и выберите команду **Azure IoT Edge: Set Module Credentials to User Settings** (Azure IoT Edge. Установка учетных данных модуля для параметров пользователей), чтобы установить параметры среды модуля в `azure-iot-edge.EdgeHubConnectionString` и `azure-iot-edge.EdgeModuleCACertificateFile` в пользовательских параметрах. На эти параметры среды содержатся ссылки в **.vscode** > **launch.json**, и они также упоминаются в [параметрах пользователя VS Code](https://code.visualstudio.com/docs/getstarted/settings).

### <a name="build-module-app-and-debug-in-launch-mode"></a>Создание приложения модуля и отладка в режиме запуска

1. Во встроенном терминале измените каталог на папку **CSharpModule** и выполните следующую команду, чтобы создать приложение .NET Core.

    ```cmd
    dotnet build
    ```

2. Перейдите на страницу `program.cs`. Добавьте точку останова в этот файл.

3. Перейдите в представление отладки VS Code, выбрав "Вид" > "Отладка". Выберите конфигурацию отладки **ModuleName Local Debug (.NET Core)** (Локальная отладка Имя_модуля (.NET Core)) из раскрывающегося списка. 

  ![Переход в режим отладки в VS Code](media/how-to-develop-csharp-module/debug-view.png)

4. Нажмите кнопку **Начать отладку** или клавишу **F5**. Вы начнете сеанс отладки.

   > [!NOTE]
   > Если .Net Core `TargetFramework` не согласуется с путем к программе в `launch.json`, необходимо вручную обновить этот путь в `launch.json` в соответствии с параметром `TargetFramework` в файле CSPROJ. Таким образом VS Code сможет успешно запустить эту программу.

5. Во встроенном терминале VS Code выполните следующую команду, чтобы отправить сообщение **Hello World** в модуль. Это команда, показанная на предыдущих шагах, когда симулятор IoT Edge настроен успешно.

    ```cmd
    curl --header "Content-Type: application/json" --request POST --data '{"inputName": "input1","data":"hello world"}' http://localhost:53000/api/v1/messages
    ```

   > [!NOTE]
   > Если вы используете Windows, убедитесь, что используется оболочка встроенного терминала VS Code **Git Bash** или **WSL Bash**. Команду `curl` нельзя запустить в PowerShell или командной строке. 
   
   > [!TIP]
   > Вместо `curl` для отправки сообщений можно использовать [PostMan](https://www.getpostman.com/) или другие средства API.

6. В представлении отладки VS Code можно просмотреть переменные на панели слева. 

    ![Просмотр переменных](media/how-to-develop-csharp-module/single-module-variables.png)

7. Чтобы остановить сеанс отладки, нажмите кнопку "Остановить" или клавиши **SHIFT+F5**. В палитре команд VS Code введите и выберите остановку **Azure IoT Edge: Stop IoT Edge Simulator** (Azure IoT Edge. Остановка симулятора IoT Edge), затем очистите симулятор.

## <a name="build-module-container-for-debugging-and-debug-in-attach-mode"></a>Создание контейнера модуля для отладки и отладка в режиме подключения

Решение по умолчанию содержит два модуля: имитированный модуль датчика температуры и модуль канала C#. Имитируемый модуль датчика температуры продолжает отправлять сообщения в модуль канала C#, а затем сообщения отправляются по каналу в Центр Интернета вещей. В созданной папке модуля находится несколько файлов Docker для разных типов контейнеров. Вы можете использовать любой **DEBUG**-файл, чтобы создать модуль для тестирования. Сейчас модули C# поддерживают отладку только в контейнерах amd64 Linux в режиме подключения.

### <a name="setup-iot-edge-simulator-for-iot-edge-solution"></a>Настройка симулятора IoT Edge для решения IoT Edge

Вместо установки управляющей программы безопасности IoT Edge на компьютере разработки можно запустить симулятор IoT Edge для выполнения решения IoT Edge. 

1. В обозревателе устройств с левой стороны щелкните идентификатор устройства IoT Edge правой кнопкой мыши и выберите **Setup IoT Edge Simulator** (Настроить симулятор IoT Edge), чтобы запустить симулятор со строкой подключения устройства.

2. Вы можете увидеть, что симулятор IoT Edge успешно настроен во встроенном терминале.

### <a name="build-and-run-container-for-debugging-and-debug-in-attach-mode"></a>Создание и выполнение контейнера для отладки и отладка в режиме подключения

1. В VS Code перейдите к файлу `deployment.template.json`. Обновите URL-адрес образа модуля C#, добавив в конце **.debug**.

   ![Добавление **.debug** к имени образа](./media/how-to-develop-csharp-module/image-debug.png)

2. Перейдите на страницу `program.cs`. Добавьте точку останова в этот файл.

3. В проводнике VS Code выберите файл `deployment.template.json` решения, а в контекстном меню выберите **Build and Run IoT Edge solution in Simulator** (Создать и выполнить решение IoT Edge в симуляторе). Все журналы контейнеров модуля можно просмотреть в одном окне. Кроме того, можно перейти в обозреватель Docker, чтобы просмотреть состояние контейнера.

   ![Просмотр переменных](media/how-to-develop-csharp-module/view-log.png)

4. Перейдите в представление отладки VS Code. Выберите файл конфигурации отладки для модуля. Действие отладки должно иметь такое имя: **Удаленная отладка имя_модуля (.NET Core)**.

   ![Выбор конфигурации](media/how-to-develop-csharp-module/debug-config.png)

5. Выберите **Начать отладку** или нажмите клавишу **F5**. Выберите процесс для присоединения.

6. В представлении отладки VS Code можно просмотреть переменные на панели слева.

7. Чтобы остановить сеанс отладки, нажмите кнопку "Остановить" или клавиши **SHIFT+F5**. В палитре команд VS Code введите и выберите **Azure IoT Edge: Stop IoT Edge Simulator** (Azure IoT Edge. Остановка симулятора IoT Edge).

    > [!NOTE]
    > В этом примере показаны способы отладки модулей IoT Edge .NET Core в контейнерах. Он основан на отладочной версии файла `Dockerfile.debug`, который при сборке образа контейнера включает в него отладчик командной строки Visual Studio.NET Core (VSDBG). После отладки модулей C# рекомендуется непосредственно использовать или настраивать файл `Dockerfile` без VSDBG для готовых модулей IoT Edge.


## <a name="next-steps"></a>Дополнительная информация

После создания модуля узнайте, как [развернуть модули Azure IoT Edge в Visual Studio Code](how-to-deploy-modules-vscode.md).

Чтобы разрабатывать модули для устройств IoT Edge, см. раздел [Понимание и использование пакетов SDK для Центра Интернета вещей Azure](../iot-hub/iot-hub-devguide-sdks.md).
