---
title: Непрерывная интеграция и непрерывное развертывание Azure IoT Edge | Документация Майкрософт
description: Общие сведения о непрерывной интеграции и непрерывном развертывании Azure IoT Edge
author: shizn
manager: ''
ms.author: xshi
ms.date: 11/12/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 06dec64a55aaece4cd67ebf0485e34aa206a8936
ms.sourcegitcommit: 0b7fc82f23f0aa105afb1c5fadb74aecf9a7015b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2018
ms.locfileid: "51633739"
---
# <a name="continuous-integration-and-continuous-deployment-to-azure-iot-edge"></a>Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge

Вы можете легко внедрить DevOps для приложений Azure IoT Edge, используя [Azure IoT Edge для Azure Pipelines](https://marketplace.visualstudio.com/items?itemName=vsc-iot.iot-edge-build-deploy) или [подключаемый модуль Azure IoT Edge для Jenkins](https://plugins.jenkins.io/azure-iot-edge). В этой статье показано, как с помощью функций непрерывной интеграции и непрерывного развертывания Azure Pipelines и Microsoft Team Foundation Server (TFS) быстро и эффективно выполнять сборку, тестирование и развертывание приложений в Azure IoT Edge. 

В этой статье раскрываются следующие темы:
* Создание и регистрация примера решения IoT Edge.
* Установка расширения Azure IoT Edge для Azure DevOps.
* Настройка непрерывной интеграции (CI) для сборки решения.
* Настройка непрерывного развертывания (CD) для развертывания решения и просмотра ответов.

Выполнение задач, описанных в этой статье, займет 30 минут.

![Непрерывная интеграция и непрерывное развертывание](./media/how-to-ci-cd/cd.png)


## <a name="create-a-sample-azure-iot-edge-solution-using-visual-studio-code"></a>Создание примера решения Azure IoT Edge с помощью Visual Studio Code

В рамках этого раздела вы создадите пример решения IoT Edge, содержащий модульные тесты, которые можно выполнять как часть процесса сборки. Перед выполнением инструкций в этом разделе выполните действия, описанные в статье о [разработке решения IoT Edge с несколькими модулями в Visual Studio Code](tutorial-multiple-modules-in-vscode.md).

1. В палитре команд введите и выполните команду**Azure IoT Edge: New IoT Edge Solution**. Затем выберите папку рабочей области, введите имя решения (по умолчанию используется имя **EdgeSolution**) и создайте в этом решении первый модуль C# (**FilterModule**). Кроме того, для первого модуля следует указать репозиторий образов Docker. По умолчанию используется репозиторий образов на базе локального реестра Docker (`localhost:5000/filtermodule`). Измените его на реестр контейнеров Azure (`<your container registry address>/filtermodule`) или центр Docker для дальнейшей непрерывной интеграции.

    ![Настройка ACR](./media/how-to-ci-cd/acr.png)

2. Окно VS Code загрузит рабочую область решения IoT Edge. При желании можно ввести и выполнить команду **Azure IoT Edge: Add IoT Edge module**, чтобы добавить дополнительные модули. В корневой папке содержатся папка `modules`, папка `.vscode` и файл шаблона для манифеста развертывания. Коды всех пользовательских модулей находятся во вложенных папках каталога `modules`. `deployment.template.json` — это шаблон манифеста развертывания. Для некоторых параметров в этом файле значения извлекаются из файла `module.json`, который есть в папке каждого модуля.

3. Пример решения IoT Edge готов. Модуль C# по умолчанию действует как модуль сообщений для канала. В `deployment.template.json` это решение отображается с двумя модулями. Сообщение создается в модуле `tempSensor` и передается напрямую через `FilterModule`, а затем отправляется в Центр Интернета вещей.

4. Сохраните эти проекты и запишите их после изменения в репозиторий Azure Repos или TFS.
    
> [!NOTE]
> Дополнительные сведения об использовании Azure Repos см. в статье [Share your code with Visual Studio 2015 and Azure Repos](https://docs.microsoft.com/azure/devops/repos/git/share-your-code-in-git-vs?view=vsts) (Предоставление общего доступа к коду с помощью Visual Studio и Azure Repos).


## <a name="configure-azure-pipelines-for-continuous-integration"></a>Настройка непрерывной интеграции в Azure Pipelines
В этом разделе вы создадите конвейер сборки, настроенный для автоматического запуска при регистрации изменений в тестовом решении IoT, и отображения журналов сборки в Azure Pipelines.

1. Войдите в организацию Azure DevOps (**https://dev.azure.com/{yourорганизация/**) и откройте проект, в котором вы зарегистрировали тестовое приложение.

    ![Код записи после изменения](./media/how-to-ci-cd/init-project.png)

1. Перейдите на страницу [Azure IoT Edge For Azure Pipelines](https://marketplace.visualstudio.com/items?itemName=vsc-iot.iot-edge-build-deploy) (Azure IoT Edge для Azure Pipelines) на сайте Azure DevOps Marketplace. Нажмите кнопку **Получить бесплатно** и следуйте указаниям в мастере, чтобы установить это расширение для своей организации Azure DevOps или скачать его в TFS.

    ![Установка расширения](./media/how-to-ci-cd/install-extension.png)

1. В Azure Pipelines откройте узел **Build & Release** (Сборка и выпуск) и на вкладке **Builds** (Сборки) выберите **+ New pipeline** (+Создать конвейер). Или, если конвейеры сборки уже есть, нажмите кнопку **+ Создать**.

    ![Новый конвейер](./media/how-to-ci-cd/add-new-build.png)

1. Если потребуется выбрать тип источника, выберите **Git**. Затем выберите проект, репозиторий и ветвь, где находится нужный код. Выберите **Продолжить**.

    ![Выбор Git](./media/how-to-ci-cd/select-vsts-git.png)

    В окне **Select a template** (Выбор шаблона) выберите **start with an Empty process** (Начать с пустым процессом).

    ![Выберите шаблон](./media/how-to-ci-cd/start-with-empty.png)

1. В редакторе конвейера выберите пул агентов. 
    
    * Если вы хотите компилировать модули на платформе amd64 для контейнеров Linux, выберите **Hosted Ubuntu 1604** (Размещение в Ubuntu 1604).
    * Если вы хотите компилировать модули на платформе amd64 для контейнеров Windows, выберите **Hosted VS2017** (Размещение в VS2017). 
    * Если вы хотите компилировать модули на платформе arm32v7 для контейнеров Linux, настройте собственный агент сборки, нажав кнопку **Manage** (Управление).
    
    ![Настройка агента сборки](./media/how-to-ci-cd/configure-env.png)

1. В задании агента щелкните "+", чтобы добавить две задачи в конвейер сборки. Первая из них — из **Azure IoT Edge**. Вторая — **Publish Build Artifacts** (Публикация артефактов сборки).
    
    ![Добавление задач](./media/how-to-ci-cd/add-tasks.png)

1. В первой задаче **Azure IoT Edge** укажите для параметра **Display name** (Отображаемое имя) **Module Build and Push** (Сборка и отправка модуля), а в раскрывающемся списке **Action** (Действие) выберите **Build and Push** (Сборка и отправка). В текстовое поле **Module.json File** (Файл Module.json) добавьте указанный ниже путь. Затем выберите **тип реестра контейнеров**. Не забудьте настроить и выбрать тот же реестр в коде (module.json). Эта задача обеспечит сборку и отправку всех модулей в решении и их публикацию в указанном реестре контейнеров. Если нужно отправить модули в разные контейнеры, можете добавить несколько задач **сборки и отправки модулей**. Если решение IoT Edge не находится в корне репозитория кода, в определении сборки можно указать **путь к корневой папке решения Edge**.
    
    ![Создание и отправка](./media/how-to-ci-cd/build-and-push.png)

1. В задаче **Publish Build Artifacts** (Публикация артефактов сборки) следует указать файл развертывания, созданный задачей сборки. Для параметра **Path to publish** (Путь публикации) задайте значение config/deployment.json. Если в предыдущей задаче вы настроили **путь к корневой папке решения Edge**, в начало пути публикации добавьте путь к корневой папке. Например, если путь к корню решения Edge имеет значение ./edgesolution, **путь публикации** следует определить как ./edgesolution/config/deployment.json. Файл `deployment.json` создается во время сборки, поэтому можно игнорировать красные строки ошибок в текстовом поле. 

    ![Публикация артефакта](./media/how-to-ci-cd/publish-build-artifacts.png)

1. Откройте вкладку **Триггеры** и включите триггер **Непрерывная интеграция**. Убедитесь, что включена ветвь, содержащая ваш код.

    ![Настройка триггера](./media/how-to-ci-cd/configure-trigger.png)

    Сохраните новый конвейер сборки. Нажмите кнопку **Сохранить** .


## <a name="configure-azure-pipelines-for-continuous-deployment"></a>Настройка непрерывного развертывания в Azure Pipelines
В этом разделе описано, как создать конвейер выпуска, настроенный для автоматического запуска при получении артефакта от конвейера сборки и отображения журналов сборки в Azure Pipelines.

1. На вкладке **Releases** (Выпуски) выберите **+ New pipeline** (Создать конвейер). Если у вас уже есть конвейеры выпуска, нажмите кнопку **+ New** (Создать).  

    ![Добавление конвейера выпуска](./media/how-to-ci-cd/add-release-pipeline.png)

    В окне **Select a template** (Выбор шаблона) выберите вариант **start with an Empty process** (Начать с пустым процессом).

    ![Начало с пустым процессом](./media/how-to-ci-cd/start-with-empty-job.png)

2. Будет инициализирован конвейер выпуска с одним этапом: **Stage 1**. Переименуйте **Stage 1** в **QA**. Это будет тестовая среда. В типичном конвейере непрерывного развертывания, как правило, существует несколько этапов, и вы можете создать дополнительные этапы с учетом конкретных процессов DevOps.

    ![Создание этапа](./media/how-to-ci-cd/QA-env.png)

3. Свяжите выпуск с артефактами сборки. Щелкните **Add** (Добавить) в области артефактов.

    ![Добавление артефактов](./media/how-to-ci-cd/add-artifacts.png)  
    
    На **странице добавления артефакта** выберите тип источника **Build** (Сборка). Затем выберите проект и конвейер сборки, которые вы создали. Теперь щелкните **Add** (Добавить).

    ![Добавление артефакта](./media/how-to-ci-cd/add-an-artifact.png)

    Откройте триггер непрерывного развертывания, чтобы выпуск создавался каждый раз при доступности новой сборки.

    ![Настройка триггера](./media/how-to-ci-cd/add-a-trigger.png)

4. Перейдите к **этапу QA** и настройте задачи для этого этапа.

    ![Настройка задач QA](./media/how-to-ci-cd/view-stage-tasks.png)

   Задачи развертывания не зависят от платформы, а значит вы можете свободно выбирать между размещением в **VS2017** и **Ubuntu 1604** для параметра **Agent pool** (Пул агентов) (или выбрать любой агент, которым вы управляете самостоятельно). Щелкните "+" и добавьте одну задачу.

    ![Добавление задач для этапа QA](./media/how-to-ci-cd/add-task-qa.png)

5. В задаче Azure IoT Edge, перейдите к раскрывающемуся списку **Action** (Действие) и выберите **Deploy to IoT Edge device** (Развернуть на устройстве IoT Edge). Выберите **подписку Azure** и введите **имя Центра Интернета вещей**. Можно также указать **идентификатор** и **приоритет** развертывания IoT Edge. Также можно выбрать развертывание на одном или нескольких устройствах. При развертывании на **нескольких устройствах** следует указать **целевое условие** устройства. Целевое условие используется как фильтр для сопоставления с набором устройств Edge в Центре Интернета вещей. Если в качестве условия вы решите использовать теги устройства, не забудьте обновить соответствующие теги устройств в двойниках устройств Центра Интернета вещей. Предположим, что у вас есть несколько устройств IoT Edge с тегом qa. Конфигурация задачи в этом случае должна выглядеть так, как на следующем изображении. 

    ![Развертывание в QA](./media/how-to-ci-cd/deploy-to-qa.png)

    Сохраните новый конвейер выпуска. Нажмите кнопку **Сохранить** . Затем щелкните **Pipeline** (Конвейер), чтобы вернуться в конвейер.

6. Второй этап обозначает рабочую среду. Чтобы добавить новый этап PROD, можно клонировать этап QA и переименовать созданную копию в **PROD**.

    ![Клонирование этапа](./media/how-to-ci-cd/clone-stage.png)

7. Настройка задач для рабочей среды. Предположим, что у вас есть несколько устройств IoT Edge с тегами prod. Задайте в конфигурации задач для целевого условия значение prod, а для идентификатора развертывания — значение deploy-prod. Нажмите кнопку **Сохранить** . Затем щелкните **Pipeline** (Конвейер), чтобы вернуться в конвейер.
    
    ![Развертывание в рабочей среде](./media/how-to-ci-cd/deploy-to-prod.png)

7. Сейчас артефакт сборки будет непрерывно активироваться на этапе **QA**, а затем на этапе **PROD**. Но в большинстве случаев нужно еще выполнять нескольких тестовых случаев на устройствах QA и вручную утверждать элементы. Только после этого они будут развертываться в среде PROD. Утверждение на этапе PROD настраивается следующим образом.

    1. Откройте панель настроек **Pre-deployment conditions** (Условия перед развертыванием).

        ![Открытие условий перед развертыванием](./media/how-to-ci-cd/pre-deploy-conditions.png)    

    2. Задайте значение **Enabled** (Вкл.) для параметра **Pre-deployment approvals** (Утверждения перед развертыванием). Теперь заполните поле вводе **Approvers** (Утверждающие). Нажмите кнопку **Сохранить**.
    
        ![Настройка условий](./media/how-to-ci-cd/set-pre-deployment-conditions.png)


8. Теперь конвейер выпуска должен выглядеть следующим образом.

    ![Конвейер выпуска](./media/how-to-ci-cd/release-pipeline.png)

    
## <a name="verify-iot-edge-cicd-with-the-build-and-release-pipelines"></a>Проверка CI/CD для IoT Edge с использованием конвейеров сборки и выпуска

В этом разделе описано, как создать условия для сборки, чтобы запустить конвейер CI/CD. Затем вы проверите успешность развертывания.

1. Чтобы запустить задание сборки, можно создать фиксацию в репозитории исходного кода или активировать задание вручную. Чтобы запустить задание сборки в конвейере сборки, нажмите кнопку **Queue** (Очередь), как показано на следующем снимке экрана.

    ![Ручной триггер](./media/how-to-ci-cd/manual-trigger.png)

2. Если конвейер сборки завершится успешно, он активирует выпуск для этапа **QA**. Перейдите к журналам конвейера сборки и убедитесь, что там отображаются следующие данные.

    ![Журналы сборки](./media/how-to-ci-cd/build-logs.png)

3. Успешное развертывание для этапа **QA** активирует отправку уведомления утверждающему. Перейдите к конвейеру выпуска, где должно отображаться следующее. 

    ![Ожидающие утверждения](./media/how-to-ci-cd/pending-approval.png)


4. После того, как утверждающий утвердит изменение, его можно развернуть в **PROD**.

    ![Развертывание в PROD](./media/how-to-ci-cd/approve-and-deploy-to-prod.png)


## <a name="next-steps"></a>Дополнительная информация

* Основные сведения о развертывании IoT Edge см. в статье [Understand IoT Edge deployments for single devices or at scale](module-deployment-monitoring.md) (Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе).
* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
