---
title: Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge | Документация Майкрософт
description: Настройка непрерывной интеграции и непрерывного развертывания в Azure IoT Edge с использованием Azure DevOps, Azure Pipelines
author: shizn
manager: philmea
ms.author: xshi
ms.date: 12/12/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: aef88a4fbc7d71ee1438333afd9773d1aba3ed9c
ms.sourcegitcommit: a408b0e5551893e485fa78cd7aa91956197b5018
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2019
ms.locfileid: "54359159"
---
# <a name="continuous-integration-and-continuous-deployment-to-azure-iot-edge"></a>Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge

Вы можете легко внедрить DevOps для приложений Azure IoT Edge, используя встроенные задания Azure IoT Edge в Azure Pipelines или [подключаемый модуль Azure IoT Edge для Jenkins](https://plugins.jenkins.io/azure-iot-edge) на сервере Jenkins. В этой статье показано, как с помощью функций непрерывной интеграции и непрерывного развертывания, предоставляемых Azure Pipelines, быстро и эффективно выполнять сборку, тестирование и развертывание приложений в Azure IoT Edge. 

В этой статье раскрываются следующие темы:
* Создание и регистрация примера решения IoT Edge.
* Настройка непрерывной интеграции (CI) для сборки решения.
* Настройка непрерывного развертывания (CD) для развертывания решения и просмотра ответов.

![Схема ветвей CI и CD для разработки и эксплуатации](./media/how-to-ci-cd/cd.png)


## <a name="create-a-sample-azure-iot-edge-solution-using-visual-studio-code"></a>Создание примера решения Azure IoT Edge с помощью Visual Studio Code

В рамках этого раздела вы создадите пример решения IoT Edge, содержащий модульные тесты, которые можно выполнять как часть процесса сборки. Перед выполнением инструкций в этом разделе выполните действия, описанные в статье о [разработке решения IoT Edge с несколькими модулями в Visual Studio Code](how-to-develop-multiple-modules-vscode.md).

1. В палитре команд VS Code введите и выполните команду **Azure IoT Edge: New IoT Edge Solution** (Azure IoT Edge: создать решение IoT Edge). Затем выберите папку рабочей области, введите имя решения (по умолчанию используется имя **EdgeSolution**) и создайте в этом решении первый модуль C# (**FilterModule**). Кроме того, для первого модуля следует указать репозиторий образов Docker. По умолчанию используется репозиторий образов на базе локального реестра Docker (`localhost:5000/filtermodule`). Укажите вместо него реестр контейнеров Azure (`<your container registry address>/filtermodule`) или центр Docker, чтобы продлить поток непрерывной интеграции.

    ![Настройка Реестра контейнеров Azure](./media/how-to-ci-cd/acr.png)

2. Окно VS Code загрузит рабочую область решения IoT Edge. При необходимости можно ввести и выполнить команду **Azure IoT Edge: Add IoT Edge module** (Azure IoT Edge: добавить модуль IoT Edge) для добавления дополнительных модулей. В корневой папке содержатся папка `modules`, папка `.vscode` и файл шаблона для манифеста развертывания. Коды всех пользовательских модулей находятся во вложенных папках каталога `modules`. `deployment.template.json` — это шаблон манифеста развертывания. Для некоторых параметров в этом файле значения извлекаются из файла `module.json`, который есть в папке каждого модуля.

3. Пример решения IoT Edge готов. Модуль C# по умолчанию действует как модуль сообщений для канала. В `deployment.template.json` это решение отображается с двумя модулями. Сообщение создается в модуле `tempSensor` и передается напрямую через `FilterModule`, а затем отправляется в Центр Интернета вещей.

4. Сохраните эти проекты и запишите их после изменения в репозиторий Azure Repos.
    
> [!NOTE]
> Дополнительные сведения об использовании Azure Repos см. в статье [Share your code with Visual Studio 2015 and Azure Repos](https://docs.microsoft.com/azure/devops/repos/git/share-your-code-in-git-vs?view=vsts) (Предоставление общего доступа к коду с помощью Visual Studio и Azure Repos).


## <a name="configure-azure-pipelines-for-continuous-integration"></a>Настройка непрерывной интеграции в Azure Pipelines
В этом разделе вы создадите конвейер сборки, настроенный для автоматического запуска при регистрации изменений в тестовом решении IoT, и отображения журналов сборки в Azure Pipelines.

1. Войдите в организацию Azure DevOps (**https://dev.azure.com/{yourорганизация/**) и откройте проект, в котором вы зарегистрировали тестовое приложение.

    ![Фиксация кода в Azure Pipelines](./media/how-to-ci-cd/init-project.png)

1. В Azure Pipelines откройте вкладку **Builds** (Сборки) и выберите **+ New pipeline** (Создать конвейер). Или, если конвейеры сборки уже есть, нажмите кнопку **+ Создать**. Затем выберите **New build pipeline** (Новый конвейер сборки).

    ![Создание конвейера сборки](./media/how-to-ci-cd/add-new-build.png)

1. При появлении соответствующего запроса выберите Azure Repos в качестве источника. Затем выберите проект, репозиторий и ветвь, где находится нужный код. Выберите **Продолжить**.

    ![Выбор Azure Repos Git](./media/how-to-ci-cd/select-vsts-git.png)

    В окне **Select a template** (Выбор шаблона) выберите **start with an Empty process** (Начать с пустым процессом).

    ![Начало работы с пустым проектом](./media/how-to-ci-cd/start-with-empty.png)

1. В редакторе конвейера выберите пул агентов. 
    
    * Если вы хотите компилировать модули на платформе amd64 для контейнеров Linux, выберите **Hosted Ubuntu 1604** (Размещение в Ubuntu 1604).
    * Если вы хотите создавать модули на платформе amd64 для контейнеров Windows 1809, вам необходимо [настроить агента в Windows в локальной среде](https://docs.microsoft.com/azure/devops/pipelines/agents/v2-windows?view=vsts).
    * Если вы хотите компилировать модули на платформе arm32v7 для контейнеров Linux, вам необходимо [настроить агента в Linux в локальной среде](https://blogs.msdn.microsoft.com/iotdev/2018/11/13/setup-azure-iot-edge-ci-cd-pipeline-with-arm-agent/).
    
    ![Настройка пула агентов сборки](./media/how-to-ci-cd/configure-env.png)

1. В задании агента щелкните "+", чтобы добавить три задачи в конвейер сборки. Первые две поступают из **Azure IoT Edge**. Третья создается операцией **Publish Build Artifacts** (Публикация артефактов сборки).
    
    ![Добавление задач в конвейер сборки](./media/how-to-ci-cd/add-tasks.png)

1. В первой задаче **Azure IoT Edge** укажите для параметра **Display name** (Отображаемое имя) значение **Azure IoT Edge - Build module images** (Azure IoT Edge — Сборка образов модулей), а в раскрывающемся списке **Action** (Действие) выберите **Build module images** (Сборка образов модулей). В элементе управления **файл .template.json** выберите файл **deployment.template.json**, который описывает целевое решение IoT Edge. Затем выберите для параметра **Платформа по умолчанию** ту же платформу, на которой работает устройство IoT Edge. Эта задача скомпилирует все включенные в решение модули для выбранной целевой платформы. Также она сформирует файл **deployment.json**, путь к которому будет указан в выходных переменных. Задайте для этой переменной псевдоним `edge`.
    
    ![Настройка задачи сборки образов модуля](./media/how-to-ci-cd/build-and-push.png)

1. Во второй задаче **Azure IoT Edge** укажите для параметра **Display name** (Отображаемое имя) значение **Azure IoT Edge - Push module images** (Azure IoT Edge — Отправка образов модулей), а в раскрывающемся списке **Action** (Действие) выберите **Push module images** (Отправка образов модулей). Выберите тип реестра контейнеров и не забудьте настроить и выбрать тот же реестр в коде (module.json). В элементе управления **файл .template.json** выберите файл **deployment.template.json**, который описывает целевое решение IoT Edge. Затем выберите для параметра **Платформа по умолчанию** ту же платформу, на которой работают скомпилированные образы устройств. Эта задача передает все образы модулей в указанный реестр контейнеров. Также она добавит учетные данные этого реестра контейнеров в файл **deployment.json**, путь к которому будет указан в выходных переменных. Задайте для этой переменной псевдоним `edge`. Если для размещения образов модулей вы используете несколько реестров контейнеров, создайте дубликат этой задачи и выберите в нем другой реестр контейнеров, затем разместите действие **Bypass module(s)** (Обойти модуль/модули) в разделе дополнительных параметров, чтобы пропускать образы, не имеющие отношение к конкретному реестру.

    ![Настройка задачи отправки образов модуля](./media/how-to-ci-cd/push.png)

1. В задаче **Publish Build Artifacts** (Публикация артефактов сборки) следует указать файл развертывания, созданный задачей сборки. Задайте для параметра **Путь публикации** значение `$(edge.DEPLOYMENT_FILE_PATH)`.

    ![Настройка задачи публикации артефакта](./media/how-to-ci-cd/publish-build-artifacts.png)

1. Откройте вкладку **Триггеры** и включите триггер **Непрерывная интеграция**. Убедитесь, что включена ветвь, содержащая ваш код.

    ![Включение триггера непрерывной интеграции](./media/how-to-ci-cd/configure-trigger.png)

    Сохраните новый конвейер сборки кнопкой **Сохранить**.


## <a name="configure-azure-pipelines-for-continuous-deployment"></a>Настройка непрерывного развертывания в Azure Pipelines
В этом разделе описано, как создать конвейер выпуска, настроенный для автоматического запуска при получении артефакта от конвейера сборки и отображения журналов сборки в Azure Pipelines.

1. На вкладке **Releases** (Выпуски) выберите **+ New pipeline** (Создать конвейер). Если у вас уже есть конвейеры выпуска, нажмите кнопку **+ Создать** и щелкните **+ Создать конвейер выпуска**.  

    ![Добавление конвейера выпуска](./media/how-to-ci-cd/add-release-pipeline.png)

    В окне **Select a template** (Выбор шаблона) выберите вариант **start with an Empty process** (Начать с пустым процессом).

    ![Начало работы с пустым заданием](./media/how-to-ci-cd/start-with-empty-job.png)

2. Будет инициализирован конвейер выпуска с одним этапом: **Этап 1**. Переименуйте **Stage 1** в **QA**. Это будет тестовая среда. В типичном конвейере непрерывного развертывания, как правило, существует несколько этапов, и вы можете создать дополнительные этапы с учетом конкретных процессов DevOps.

    ![Этап создания тестовой среды](./media/how-to-ci-cd/QA-env.png)

3. Свяжите выпуск с артефактами сборки. Щелкните **Add** (Добавить) в области артефактов.

    ![Добавление артефактов](./media/how-to-ci-cd/add-artifacts.png)  
    
    На **странице добавления артефакта** выберите тип источника **Build** (Сборка). Затем выберите проект и конвейер сборки, которые вы создали. Затем щелкните **Добавить**.

    ![Добавление артефакта сборки](./media/how-to-ci-cd/add-an-artifact.png)

    Откройте триггер непрерывного развертывания, чтобы выпуск создавался каждый раз при доступности новой сборки.

    ![Настройка триггера непрерывного развертывания](./media/how-to-ci-cd/add-a-trigger.png)

4. Перейдите к **этапу QA** и настройте задачи для этого этапа.

    ![Настройка задач QA](./media/how-to-ci-cd/view-stage-tasks.png)

   Задачи развертывания не зависят от платформы, а значит вы можете свободно выбирать между размещением в **VS2017** и **Ubuntu 1604** для параметра **Agent pool** (Пул агентов) (или выбрать любой агент, которым вы управляете самостоятельно). Щелкните "+" и добавьте одну задачу.

    ![Добавление задач для этапа QA](./media/how-to-ci-cd/add-task-qa.png)

5. В задаче Azure IoT Edge, перейдите к раскрывающемуся списку **Action** (Действие) и выберите **Deploy to IoT Edge device** (Развернуть на устройстве IoT Edge). Выберите **подписку Azure** и введите **имя Центра Интернета вещей**. Вы можете выбрать, нужно ли выполнять развертывание на одном или нескольких устройствах. При развертывании на **нескольких устройствах** следует указать **целевое условие** устройства. Целевое условие используется как фильтр для сопоставления с набором устройств Edge в Центре Интернета вещей. Если в качестве условия вы решите использовать теги устройства, не забудьте обновить соответствующие теги устройств в двойниках устройств Центра Интернета вещей. Для параметра **Идентификатор развертывания IoT Edge** в разделе дополнительных параметров задайте значение "deploy-qa". Предположим, что у вас есть несколько устройств IoT Edge с тегом qa. Конфигурация задачи в этом случае должна выглядеть так, как на следующем изображении. 

    ![Развертывание в QA](./media/how-to-ci-cd/deploy-to-qa.png)

    Сохраните новый конвейер выпуска кнопкой **Сохранить**. Затем щелкните **Конвейер**, чтобы вернуться в конвейер.

6. Второй этап обозначает рабочую среду. Чтобы добавить новый этап PROD, можно клонировать этап QA и переименовать созданную копию в **PROD**.

    ![Клонирование этапа](./media/how-to-ci-cd/clone-stage.png)

7. Настройка задач для рабочей среды. Предположим, что у вас есть несколько устройств IoT Edge с тегами prod. Тогда в дополнительных параметрах конфигурации задач задайте для целевого условия значение prod, а для идентификатора развертывания — значение deploy-prod. Сохраните его кнопкой **Сохранить**. Затем щелкните **Конвейер**, чтобы вернуться в конвейер.
    
    ![Развертывание в рабочей среде](./media/how-to-ci-cd/deploy-to-prod.png)

7. Сейчас артефакт сборки будет непрерывно активироваться на этапе **QA**, а затем на этапе **PROD**. Но в большинстве случаев нужно еще выполнять нескольких тестовых случаев на устройствах QA и вручную утверждать элементы. Только после этого они будут развертываться в среде PROD. Настройте утверждение на этапе PROD, как показано на следующем снимке экрана.

    1. Откройте панель настроек **Pre-deployment conditions** (Условия перед развертыванием).

        ![Открытие условий перед развертыванием](./media/how-to-ci-cd/pre-deploy-conditions.png)    

    2. Задайте значение **Enabled** (Вкл.) для параметра **Pre-deployment approvals** (Утверждения перед развертыванием). Теперь заполните поле вводе **Approvers** (Утверждающие). Затем сохраните его кнопкой **Сохранить**.
    
        ![Настройка условий](./media/how-to-ci-cd/set-pre-deployment-conditions.png)


8. Теперь конвейер выпуска должен выглядеть, как на этом снимке экрана.

    ![Конвейер выпуска](./media/how-to-ci-cd/release-pipeline.png)

    
## <a name="verify-iot-edge-cicd-with-the-build-and-release-pipelines"></a>Проверка CI/CD для IoT Edge с использованием конвейеров сборки и выпуска

В этом разделе описано, как создать условия для сборки, чтобы запустить конвейер CI/CD. Затем вы проверите успешность развертывания.

1. Чтобы запустить задание сборки, можно создать фиксацию в репозитории исходного кода или активировать задание вручную. Чтобы запустить задание сборки в конвейере сборки, нажмите кнопку **Очередь**, как показано на следующем снимке экрана.

    ![Ручной триггер](./media/how-to-ci-cd/manual-trigger.png)

2. Если конвейер сборки завершится успешно, он активирует выпуск для этапа **QA**. Перейдите к журналам конвейера сборки и убедитесь, что их содержимое соответствует следующему снимку экрана.

    ![Журналы сборки](./media/how-to-ci-cd/build-logs.png)

3. Успешное развертывание для этапа **QA** активирует отправку уведомления утверждающему. Перейдите к конвейеру выпуска, который должен выглядеть, как на следующем снимке экрана. 

    ![Ожидающие утверждения](./media/how-to-ci-cd/pending-approval.png)


4. После того, как утверждающий утвердит изменение, его можно развернуть в **PROD**.

    ![Развертывание в PROD](./media/how-to-ci-cd/approve-and-deploy-to-prod.png)


## <a name="next-steps"></a>Дополнительная информация

* Основные сведения о развертывании IoT Edge см. в статье [Understand IoT Edge deployments for single devices or at scale](module-deployment-monitoring.md) (Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе).
* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
