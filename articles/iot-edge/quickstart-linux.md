---
title: Краткое руководство по использованию Azure IoT Edge и Linux | Документация Майкрософт
description: Из этого краткого руководства вы узнаете, как удаленно развертывать готовый код на устройстве IoT Edge.
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 08/14/2018
ms.topic: quickstart
ms.service: iot-edge
services: iot-edge
ms.custom: mvc
ms.openlocfilehash: af291782585cf0211cf8beac54adc36fd9fe0d34
ms.sourcegitcommit: 3f8f973f095f6f878aa3e2383db0d296365a4b18
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2018
ms.locfileid: "42023839"
---
# <a name="quickstart-deploy-your-first-iot-edge-module-to-a-linux-x64-device"></a>Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux

Azure IoT Edge переносит мощь облака на ваши устройства Интернета вещей. Из этого краткого руководства вы узнаете, как использовать облачный интерфейс для удаленного развертывания готового кода на устройстве IoT Edge.

Из этого краткого руководства вы узнаете, как выполнять следующие задачи:

1. Создайте Центр Интернета вещей.
2. Регистрация устройства IoT Edge в Центре Интернета вещей.
3. Установка и запуск среды выполнения IoT Edge на устройстве.
4. Удаленное развертывание модуля на устройстве IoT Edge.

![Архитектура, используемая при работе с этим кратким руководством][2]

В рамках этого краткого руководства компьютер или виртуальная машина Linux используются в качестве устройства IoT Edge. Вы можете развернуть модуль на портале Azure для устройства. Модуль, который вы развернете в рамках этого краткого руководства, представляет собой имитированный датчик, генерирующий данные температуры, влажности и давления. В других руководствах по Azure IoT Edge используются наработки из этой статьи: развернутые модули, которые анализируют смоделированные данные для бизнес-аналитики. 

Если у вас еще нет подписки Azure, перед началом работы [создайте бесплатную учетную запись Azure][lnk-account].


[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Для выполнения многих действий, описанных в этом кратком руководстве, используется Azure CLI, а также расширение Интернета вещей Azure для предоставления дополнительных функций. 

Добавьте расширение Интернета вещей Azure в экземпляр Cloud Shell.

   ```azurecli-interactive
   az extension add --name azure-cli-iot-ext
   ```
   
## <a name="prerequisites"></a>Предварительные требования

Облачные ресурсы. 

* Группа ресурсов для управления всеми ресурсами, которые вы используете в этом кратком руководстве. 

   ```azurecli-interactive
   az group create --name IoTEdgeResources --location westus
   ```

Устройства IoT Edge:

* Устройство или виртуальная машина Linux для работы в качестве устройства IoT Edge. Если вы хотите создать виртуальную машину в Azure, используйте следующую команду для быстрого начала работы:

   ```azurecli-interactive
   az vm create --resource-group IoTEdgeResources --name EdgeVM --image Canonical:UbuntuServer:16.04-LTS:latest --admin-username azureuser --generate-ssh-keys --size Standard_B1ms
   ```

## <a name="create-an-iot-hub"></a>Создание Центра Интернета вещей

Начните с создания Центра Интернета вещей с помощью Azure CLI. 

![Создание Центра Интернета вещей][3]

Для целей этого руководства можно использовать бесплатный уровень. Если вы уже использовали бесплатный Центр Интернета вещей и он у вас сохранился, можете использовать его. В подписке может быть только один бесплатный Центр Интернета вещей. 

При помощи следующего кода создается бесплатный центр **F1** в группе ресурсов **IoTEdgeResources**. Замените *{hub_name}* уникальным именем для вашего Центра Интернета вещей.

   ```azurecli-interactive
   az iot hub create --resource-group IoTEdgeResources --name {hub_name} --sku F1 
   ```

   Если отобразится сообщение об ошибке с уведомлением о том, что в вашей подписке уже имеется один бесплатный центр, измените номер SKU на **S1**. 

## <a name="register-an-iot-edge-device"></a>Регистрация устройства IoT Edge

Зарегистрируйте устройство IoT Edge в только что созданном Центре Интернета вещей. 
![Регистрация устройства][4]

Создайте удостоверение для своего имитированного устройства, чтобы оно могло обмениваться данными с Центром Интернета вещей. Удостоверение устройства находится в облаке. Чтобы связать физическое устройство с удостоверением, нужно использовать уникальную строку подключения к устройству. 

Так как устройства IoT Edge отличаются от стандартных устройств Интернета вещей поведением и управлением, объявите свое устройство устройством IoT Edge с самого начала. 

1. Чтобы создать устройство с именем **myEdgeDevice** в Центре Интернета вещей, введите следующую команду в Azure Cloud Shell.

   ```azurecli-interactive
   az iot hub device-identity create --hub-name {hub_name} --device-id myEdgeDevice --edge-enabled
   ```

1. Получите строку подключения для устройства, которая связывает физическое устройство с его идентификатором в Центре Интернета вещей. 

   ```azurecli-interactive
   az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {hub_name}
   ```

1. Скопируйте строку подключения и сохраните ее. Это значение потребуется для настройки среды выполнения IoT Edge в следующем разделе. 


## <a name="install-and-start-the-iot-edge-runtime"></a>Установка и запуск среды выполнения IoT Edge

Установите и запустите среду выполнения Azure IoT Edge на устройстве IoT Edge. 
![Регистрация устройства][5]

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Она состоит из трех компонентов. **Управляющая программа безопасности IoT Edge** запускается при каждой загрузке устройства Edge и перезагружает устройство, запустив агент IoT Edge. **Агент IoT Edge** упрощает развертывание и мониторинг модулей на устройстве IoT Edge, включая центр IoT Edge. **Центр IoT Edge** управляет взаимодействием между модулями на устройстве IoT Edge, а также между устройством и Центром Интернета вещей. 

Укажите строку подключения к устройству во время конфигурации среды выполнения. Используйте строку, полученную с помощью Azure CLI. Эта строка свяжет ваше физическое устройство с удостоверением устройства IoT Edge в Azure. 

Выполните следующие шаги на компьютере или в виртуальной машине Linux, подготовленные для работы в качестве устройства IoT Edge. 

### <a name="register-your-device-to-use-the-software-repository"></a>Регистрация устройства для использования репозитория программного обеспечения

Пакеты, которые необходимо запускать в среде выполнения IoT Edge, управляются в репозитории программного обеспечения. Настройте устройство IoT Edge для доступа к этому репозиторию. 

Все действия, описанные в этом разделе, предназначены для устройств под управлением **Ubuntu 16.04**. Сведения о том, как получить доступ к репозиторию программного обеспечения в других версиях Linux, см. в статьях по [установке среды выполнения Azure IoT Edge в Linux (x64)](how-to-install-iot-edge-linux.md) или [установке среды выполнения Azure IoT Edge в Linux (ARM32v7/armhf)](how-to-install-iot-edge-linux-arm.md).

1. На компьютере, используемом в качестве устройства IoT Edge, установите конфигурацию репозитория.

   ```bash
   curl https://packages.microsoft.com/config/ubuntu/16.04/prod.list > ./microsoft-prod.list
   sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/
   ```

2. Установите открытый ключ для доступа к репозиторию.

   ```bash
   curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
   sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/
   ```

### <a name="install-a-container-runtime"></a>Установка среды выполнения контейнера

Среда выполнения IoT Edge — это набор контейнеров и логическое приложение, которое развертывается на устройстве IoT Edge и упаковано в контейнеры. Подготовьте устройство для этих компонентов, установив среду выполнения контейнера.

1. Обновите **apt-get**.

   ```bash
   sudo apt-get update
   ```

2. Установите среду выполнения контейнера **Moby**.

   ```bash
   sudo apt-get install moby-engine
   ```

3. Установите команды CLI для Moby. 

   ```bash
   sudo apt-get install moby-cli
   ```

### <a name="install-and-configure-the-iot-edge-security-daemon"></a>Установка и настройка управляющей программы безопасности IoT Edge

Управляющая программа безопасности устанавливается как системная служба, поэтому среда выполнения IoT Edge будет запускаться каждый раз при загрузке устройства. Пакет установки также включает версию **hsmlib**, позволяющую управляющей программе безопасности взаимодействовать с аппаратным модулем безопасности устройства. 

1. Загрузите и установите управляющую программу безопасности IoT Edge. 

   ```bash
   sudo apt-get update
   sudo apt-get install iotedge
   ```

2. Откройте файл конфигурации IoT Edge. Это защищенный файл, поэтому для доступа к нему нужно использовать более высокий уровень привилегий.
   
   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

3. Добавьте строку подключения устройства IoT Edge. Найдите переменную **device_connection_string** и измените ее значение с помощью строки, скопированной после регистрации устройства. Эта строка подключения свяжет ваше физическое устройство с удостоверением устройства, созданным в Azure.

4. Сохраните и закройте файл. 

   `CTRL + X`, `Y`, `Enter`

5. Перезапустите управляющую программу безопасности IoT Edge, чтобы применить изменения.

   ```bash
   sudo systemctl restart iotedge
   ```

>[!TIP]
>Для выполнения команд `iotedge` требуется более высокий уровень привилегий. После установки среды выполнения IoT Edge, выхода из компьютера и обратного входа ваши разрешения обновляются автоматически. До этого момента используйте перед командой **sudo**. 

### <a name="view-the-iot-edge-runtime-status"></a>Просмотр состояния среды выполнения IoT Edge

Убедитесь, что среда выполнения успешно установлена и настроена.

1. Убедитесь, что управляющая программа безопасности Edge выполняется как системная служба.

   ```bash
   sudo systemctl status iotedge
   ```

   ![Проверка того, выполняется ли управляющая программа Edge как системная служба](./media/quickstart-linux/iotedged-running.png)

2. Если нужно устранить неполадки со службой, извлеките журналы службы. 

   ```bash
   journalctl -u iotedge
   ```

3. Просмотрите модули, запущенные на устройстве. 

   ```bash
   sudo iotedge list
   ```

   ![Просмотр данных об одном модуле на устройстве](./media/quickstart-linux/iotedge-list-1.png)

Теперь устройство IoT Edge настроено. Оно готово для запуска модулей, развернутых в облаке. 

## <a name="deploy-a-module"></a>Развертывание модуля

Управляя устройством Azure IoT Edge из облака, разверните модуль, который будет передавать данные телеметрии в Центр Интернета вещей.
![Регистрация устройства][6]

[!INCLUDE [iot-edge-deploy-module](../../includes/iot-edge-deploy-module.md)]

## <a name="view-generated-data"></a>Просмотр сформированных данных

В этом руководстве мы создали новое устройство IoT Edge и установили на нем среду выполнения IoT Edge. Затем с помощью портала Azure мы отправили на устройство и запустили модуль IoT Edge, не изменяя на устройстве никаких настроек. В этом примере отправленный модуль создает данные среды, которые можно использовать для работы с руководствами. 

Снова откройте командную строку на вашем устройстве IoT Edge. Убедитесь, что развернутый из облака модуль работает на вашем устройстве IoT Edge.

   ```bash
   sudo iotedge list
   ```

   ![Просмотр трех модулей на устройстве](./media/quickstart-linux/iotedge-list-2.png)

Убедитесь, что сообщения отправляются из модуля tempSensor.

   ```bash
   sudo iotedge logs tempSensor -f 
   ```
Когда вы выйдете из системы и войдете в нее, *sudo* больше не потребуется для приведенной выше команды.

![Просмотр получаемых с модуля данных](./media/quickstart-linux/iotedge-logs.png)

Модуль датчика температуры может ожидать подключения к центру Edge, если последней строкой в журнале оказывается `Using transport Mqtt_Tcp_Only`. Попробуйте завершить модуль, и пусть агент Edge перезапустит его. Для завершения можно воспользоваться командой `sudo docker stop tempSensor`.

Вы также можете просматривать на вашем Центре Интернета вещей данные телеметрии по мере их поступления, используя [расширение Azure IoT Toolkit для Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit). 


## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы хотите продолжить ознакомление с руководствами по IoT Edge, используйте устройство, зарегистрированное и настроенное в рамках этого краткого руководства. В противном случае можно удалить с устройства созданные ресурсы Azure и среду выполнения IoT Edge. 

### <a name="delete-azure-resources"></a>Удаление ресурсов Azure

Если вы создали виртуальную машину и Центр Интернета вещей в новой группе ресурсов, можно удалить эту группу и все связанные с ней ресурсы. Если в группе ресурсов, которую необходимо удалить, имеются важные данные, можно удалить только ненужные ресурсы. 

Удалите группу **IoTEdgeResources**. 

   ```azurecli-interactive
   az group delete --name IoTEdgeResources 
   ```

### <a name="remove-the-iot-edge-runtime"></a>Удаление среды выполнения IoT Edge

Чтобы удалить файлы установки с устройства, используйте приведенные ниже команды.  

Удалите среду выполнения IoT Edge.

   ```bash
   sudo apt-get remove --purge iotedge
   ```

При удалении среды выполнения IoT Edge созданные с ее помощью контейнеры остановятся, но будут по-прежнему храниться на устройстве. Просмотрите все контейнеры.

   ```bash
   sudo docker ps -a
   ```

Удалите контейнеры, созданные на устройстве средой выполнения IoT Edge. Измените имя контейнера tempSensor, если вы указали для него другое имя. 

   ```bash
   sudo docker rm -f tempSensor
   sudo docker rm -f edgeHub
   sudo docker rm -f edgeAgent
   ```

Удалите среду выполнения контейнера.

   ```bash
   sudo apt-get remove --purge moby-cli
   sudo apt-get remove --purge moby-engine
   ```

## <a name="next-steps"></a>Дополнительная информация

Изучение этого этим краткого руководства обязательно для дальнейшей работы со всеми остальными руководствами по IoT Edge. Вы можете перейти к любому из оставшихся руководств, чтобы узнать, как Azure IoT Edge может помочь вам превратить данные в бизнес-аналитику на пограничном устройстве.

> [!div class="nextstepaction"]
> [Фильтрация данных датчика с помощью Функций Azure](tutorial-deploy-function.md)



<!-- Images -->
[0]: ./media/quickstart-linux/cloud-shell.png
[1]: ./media/quickstart-linux/view-module.png
[2]: ./media/quickstart-linux/install-edge-full.png
[3]: ./media/quickstart-linux/create-iot-hub.png
[4]: ./media/quickstart-linux/register-device.png
[5]: ./media/quickstart-linux/start-runtime.png
[6]: ./media/quickstart-linux/deploy-module.png
[7]: ./media/quickstart-linux/iotedged-running.png
[8]: ./media/tutorial-simulate-device-linux/running-modules.png
[9]: ./media/tutorial-simulate-device-linux/sensor-data.png


<!-- Links -->
[lnk-docker-ubuntu]: https://docs.docker.com/engine/installation/linux/docker-ce/ubuntu/ 
[lnk-account]: https://azure.microsoft.com/free
[lnk-portal]: https://portal.azure.com
[lnk-delete]: https://docs.microsoft.com/cli/azure/iot/hub?view=azure-cli-latest#az-iot-hub-delete

<!-- Anchor links -->
[anchor-register]: #register-an-iot-edge-device
