---
title: Автоматическая подготовка устройства Azure IoT Edge с помощью Службы подготовки устройств к добавлению в Центр Интернета вещей для Linux | Документация Майкрософт
description: Использование имитированного доверенного платформенного модуля на виртуальной машине Linux для тестирования подготовки устройств для Azure IoT Edge
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 06/27/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 9609aab6c70bc0c2755de142023bd26e7417987a
ms.sourcegitcommit: 756f866be058a8223332d91c86139eb7edea80cc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2018
ms.locfileid: "37347860"
---
# <a name="create-and-provision-an-edge-device-with-a-virtual-tpm-on-a-linux-virtual-machine"></a>Создание и подготовка устройства IoT Edge с помощью виртуального доверенного платформенного модуля на виртуальной машине Linux

Устройства Azure IoT Edge можно подготовить автоматически с помощью [Службы подготовки устройств к добавлению в Центр Интернета вещей](../iot-dps/index.yml) точно так же, как и другие устройства. При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить. 

В этой статье показано, как протестировать функцию автоматической подготовки на имитированном устройстве IoT Edge, с помощью следующих действий: 

* Создание виртуальной машины Linux в Hyper-V с имитированным доверенным платформенным модулем (TPM) для обеспечения безопасности оборудования.
* Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
* Создание отдельной регистрации устройства
* Установка среды выполнения IoT Edge и подключение устройства к Центру Интернета вещей

Действия, описанные в этой статье, предназначены для целей тестирования.

## <a name="prerequisites"></a>предварительным требованиям

* Компьютер для разработки с ОС Windows с [включенным Hyper-V](https://docs.microsoft.com/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v). В этой статье используется виртуальная машина Ubuntu Server, запущенная в Windows 10. 
* Действующий Центр Интернета вещей. 

## <a name="create-a-linux-virtual-machine-with-a-virtual-tpm"></a>Создание виртуальной машины Linux с помощью виртуального доверенного платформенного модуля (TPM)

В этом разделе описывается создание новой виртуальной машины Linux на Hyper-V с имитированным доверенным платформенным модулем, чтобы с её помощью можно было проверить, как работает функция автоматической подготовки с IoT Edge. 

### <a name="create-a-virtual-switch"></a>Создание виртуального коммутатора

Виртуальный коммутатор позволяет виртуальной машине подключаться к физической сети.

1. Откройте Hyper-V на компьютере с ОС Windows. 

2. В меню **Действия** выберите **Диспетчер виртуальных коммутаторов**. 

3. Выберите **Внешний** виртуальный коммутатор, а затем выберите **Создать виртуальный коммутатор**. 

4. Назовите новый виртуальный коммутатор, например **EdgeSwitch**. Убедитесь, что выбранный тип соединения имеет значение **Внешняя сеть**, а затем выберите **OK**.

5. Всплывающее окно предупредит, что сетевое подключение может быть разорвано. Чтобы продолжить, нажмите кнопку **Да**. 

В случае возникновения ошибок при создании нового виртуального коммутатора, убедитесь, что другие коммутаторы не используют адаптер Ethernet и что для других коммутаторов не используется то же самое имя. 

### <a name="create-virtual-machine"></a>Создание виртуальной машины

1. Скачайте и сохраните локально файл образа диска для виртуальной машины. Например, [Ubuntu server](https://www.ubuntu.com/download/server). 

2. Снова откройте Hyper-V. В меню **Действия** выберите **Создать** > **Виртуальная машина**.

3. В ходе работы **Мастера создания виртуальной машины** укажите следующие настройки.

   1. **Укажите поколение**. Выберите **Generation 2**.
   2. **Настройка сети**. В параметре **Подключение** укажите виртуальный коммутатор, созданный в предыдущем разделе. 
   3. **Варианты установки**. Выберите **Установить операционную систему из файла загрузочного образа** и укажите путь к сохраненному файлу образа диска.

Создание виртуальной машины может занять несколько минут. 

### <a name="enable-virtual-tpm"></a>Включение виртуального доверенного платформенного модуля

1. После создания виртуальной машины откройте её параметры. 
2. Перейдите в раздел **Безопасность**. 
3. Снимите флажок **Включить безопасную загрузку**.
4. Поставьте флажок **Включить доверенный платформенный модуль**. 
5. Последовательно выберите **ОК**.  

### <a name="start-the-virtual-machine-and-collect-tpm-data"></a>Запуск виртуальной машины и сбор данных доверенного платформенного модуля

На виртуальной машине создайте инструмент пакета SDK для C, который может извлечь **Идентификатор регистрации** и **Ключ подтверждения** устройства. 

1. Запустите виртуальную машину и подключитесь к ней, чтобы завершить процесс установки. 

2. На виртуальной машине выполните действия, описанные в разделе [Настройка среды разработки Linux](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md#linux) для установки и создания пакета SDK для устройств Azure IoT для C. 

3. Выполните следующие команды для создания инструмента пакета SDK для C, извлекающего сведения о подготовке устройства. 

   ```bash
   cd azure-iot-sdk-c/cmake
   cmake -Duse_prov_client:BOOL=ON ..
   cd provisioning_client/tools/tpm_device_provision
   make
   sudo ./tpm_device_provision
   ```

3. Скопируйте значения параметров **Идентификатор регистрации** и **Ключ подтверждения**. Эти значения могут быть использованы при создании отдельной регистрации устройства в Службы подготовки устройств к добавлению в Центр Интернета вещей. 

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge. 

## <a name="create-a-dps-enrollment"></a>Создание регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей

Получите сведения о подготовке из вашей виртуальной машины и используйте их, чтобы создать отдельную регистрацию в Службе подготовки устройств к добавлению в Центр Интернета вещей. 

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md). 


1. На [портале Azure](https://portal.azure.com) перейдите к экземпляру Службы подготовки устройств к добавлению в Центр Интернета вещей. 

2. В разделе **Параметры**выберите **Управление регистрациями**. 

3. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   1. Для параметра **Механизм** выберите **TPM**. 
   2. Вставьте **Ключ подтверждения** и **Идентификатор регистрации**, скопированные из виртуальной машины.
   3. Выберите **Включить**, чтобы объявить, что эта виртуальная машина — устройство IoT Edge. 
   4. Выберите связанный **Центр Интернета вещей**, к которому планируется подключение устройства. 
   5. Если необходимо, укажите идентификатор устройства. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. 
   6. При необходимости добавьте значение тега в **Первоначальное состояние двойника устройства**. Теги можно использовать для указания групп устройств для развертывания модуля. 
   7. Щелкните **Сохранить**. 


## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе. Установите среду выполнения IoT Edge на вашей виртуальной машине. 

Узнайте **область идентификатора** Службы подготовки устройств к добавлению в Центр Интернета вещей и **идентификатор регистрации** устройства, прежде чем переходить к статье, соответствующей типу вашего устройства. Если был установлен приведенный в примере Ubuntu server, то используйте инструкции **x64**. Среда выполнения IoT Edge должна быть настроена на автоматическую подготовку, а не подготовку вручную. 

* [Linux (x64)](how-to-install-iot-edge-linux.md)
* [Linux (ARM32v7/armhf)](how-to-install-iot-edge-linux-arm.md)

## <a name="give-iot-edge-access-to-the-tpm"></a>Предоставление доступа IoT Edge доверенному платформенному модулю

Для проведения автоматической подготовки устройства среда выполнения IoT Edge должна иметь доступ к доверенному платформенному модулю. 

Чтобы предоставить доступ к доверенному платформенному модулю, следуйте приведенным ниже инструкциям. Достичь того же результата можно переопределив системные параметры таким образом, чтобы служба *iotedge* могла работать в режиме root. 

1. Найдите путь к аппаратному модулю доверенного платформенного модуля на устройстве и сохраните его в качестве локальной переменной. 

   ```bash
   tpm=$(sudo find /sys -name dev -print | fgrep tpm | sed 's/.\{4\}$//')
   ```

2. Создайте новое правило, которое предоставит среде выполнения IoT Edge доступ к tpm0. 

   ```bash
   sudo touch /etc/udev/rules.d/tpmaccess.rules
   ```

3. Откройте файл правил. 

   ```bash
   sudo nano /etc/udev/rules.d/tpmaccess.rules
   ```

4. Скопируйте следующие сведения о доступе в файл правил. 

   ```input 
   # allow iotedge access to tpm0
   KERNEL=="tpm0", SUBSYSTEM=="tpm", GROUP="iotedge", MODE="0660"
   ```

5. Сохраните и закройте файл. 

6. Запустите систему udev, чтобы оценить новое правило. 

   ```bash
   /bin/udevadm trigger $tpm
   ```

7. Убедитесь, что правило было успешно применено.

   ```bash
   ls -l /dev/tpm0
   ```

   В случае успешного применения правила данные вывода выглядят следующим образом.

   ```output
   crw------- 1 root root 10, 224 Jun 28 22:34 /dev/tpm0
   ```

8. Откройте файл переопределений среды выполнения IoT Edge. 

   ```bash
   sudo systemctl edit iotedge.service
   ```

9. Добавьте следующий код, чтобы создать переменную среды доверенного платформенного модуля.

   ```input
   [Service]
   Environment=IOTEDGE_USE_TPM_DEVICE=ON
   ```

9. Убедитесь, что переопределение прошло успешно.

   ```bash
   sudo systemctl cat iotedge.service
   ```

   Успешный вывод отобразит переменные службы **iotege** по умолчанию, а затем отобразит переменную среды, которую вы установили в **override.conf**. 

12. Перезагрузите параметры.

   ```bash
   sudo systemctl daemon-reload
   ```

## <a name="restart-the-iot-edge-runtime"></a>Перезапуск среды выполнения IoT Edge

Перезапустите среду выполнения IoT Edge, чтобы активировать все изменения конфигурации, внесенные на устройстве. 

   ```bash
   sudo systemctl restart iotedge
   ```

Убедитесь, что среда выполнения IoT Edge запущена. 

   ```bash
   sudo systemctl status iotedge
   ```

Возникновение ошибки подготовки может означать, что изменения конфигурации еще не вступили в силу. Попробуйте перезапустить управляющую программу IoT Edge. 

   ```bash
   sudo systemctl daemon-reload
   ```
   
Или попробуйте перезапустить виртуальную машину, чтобы проверить, вступят ли изменения в силу при новом запуске. 

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена, перейдите в Центр Интернета вещей и проверьте, что новое устройство автоматически подготовлено и готово для запуска модулей IoT Edge. 

Проверьте состояние управляющей программы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Изучите журналы управляющей программы.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```


## <a name="next-steps"></a>Дополнительная информация

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. См. дополнительные сведения о развертывании и мониторинге модулей IoT Edge с поддержкой масштабирования с помощью [портала Azure](how-to-deploy-monitor.md) или [Azure CLI](how-to-deploy-monitor-cli.md).
