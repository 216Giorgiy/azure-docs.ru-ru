<properties
	pageTitle="Использование ключей SSH в Linux и Mac | Microsoft Azure"
	description="Создание и использование SSH-ключей в Linux и Mac для развертывания с помощью диспетчера ресурсов и классической модели развертывания в Azure."
	services="virtual-machines-linux"
	documentationCenter=""
	authors="vlivech"
	manager="timlt"
	editor=""
	tags="" />

<tags
	ms.service="virtual-machines-linux"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-linux"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="05/16/2016"
	ms.author="v-livech"/>

# Создание ключей SSH для виртуальных машин Linux в ОС Linux и Mac в Azure

Создать открытый и закрытый ключи SSH с защитой паролем можно в окне терминала на рабочей станции. С помощью созданных ключей SSH вы можете создавать новые виртуальные машины; кроме того, можно добавлять открытый ключ к существующим виртуальным машинам. Обе операции выполняются с использованием интерфейса командной строки Azure или шаблонов Azure. Вы сможете входить в систему без пароля по протоколу SSH, используя более безопасный метод проверки подлинности — ключи вместо паролей.

## Краткий перечень команд

В примерах команд ниже замените значения между &lt; и &gt; значениями, соответствующими вашей среде.

```bash
ssh-keygen -t rsa -b 2048 -C "<your_user@yourdomain.com>"
```

Введите имя файла, который необходимо сохранить в каталоге `~/.ssh/`.

```bash
<azure_fedora_id_rsa>
```

Введите парольную фразу для azure\_fedora\_id\_rsa.

```bash
<correct horse battery staple>
```

Добавьте только что созданный ключ в `ssh-agent` на компьютере Linux и Mac (также добавляется к цепочке ключей OS X).

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/azure_fedora_id_rsa
```

Скопируйте открытый ключ SSH для сервера Linux.

```bash
ssh-copy-id -i ~/.ssh/azure_fedora_id_rsa.pub <youruser@yourserver.com>
```

Протестируйте вход в систему с использованием ключей вместо пароля.

```bash
ssh -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -i ~/.ssh/azure_fedora_id_rsa <youruser@yourserver.com>
Last login: Tue April 12 07:07:09 2016 from 66.215.22.201
$
```

## Введение

Использование открытого и закрытого ключей SSH — это самый простой способ войти на серверы Linux. Кроме того, [шифрование с открытым ключом](https://en.wikipedia.org/wiki/Public-key_cryptography) обеспечивает более безопасный вход на виртуальную машину Linux или BSD в Azure, чем использование паролей, которые можно легко взломать методом подбора. Открытый ключ можно предоставить любому пользователю, тогда как закрытый ключ принадлежит только вам (или локальной инфраструктуре безопасности). Созданный закрытый ключ SSH будет защищен с помощью [безопасного пароля](https://www.xkcd.com/936/). Этот пароль используется только для доступа к закрытому ключу SSH, но **не** для входа в учетную запись пользователя. Когда вы добавите к ключу SSH пароль, он зашифрует закрытый ключ. После этого закрытый ключ нельзя будет использовать без пароля для разблокировки. Если злоумышленник украдет ваш закрытый ключ, без пароля он не сможет воспользоваться закрытым ключом для входа на серверы, на которых установлен соответствующий открытый ключ. Если закрытый ключ защищен паролем, злоумышленник не сможет использовать его. Такой подход обеспечивает дополнительный уровень безопасности инфраструктуры в Azure.


В этой статье рассматривается создание файлов ключей в формате *ssh-rsa*. Мы рекомендуем использовать именно их при развертывании с помощью Resource Manager. Кроме того, они являются обязательными при развертываниях на [портале](https://portal.azure.com) (как при классической модели, так и модели развертывания с помощью Resource Manager).


## Создание ключей SSH

В Azure необходимо использовать по крайней 2048-разрядные открытые и закрытые ключи в формате ssh-rsa. Чтобы создать такую пару, выполните команду `ssh-keygen`. Во время ее выполнения вам нужно будет ответить на несколько вопросов, после чего будут записаны закрытый ключ и соответствующий открытый ключ. При создании виртуальной машины Azure осуществляется передача содержимого открытого ключа. Оно копируется в виртуальную машину Linux и используется при входе вместе с локальным безопасно хранимым закрытым ключом во время проверки подлинности пользователя.

## Использование команды ssh-keygen

Эта команда создает пару защищенных паролем (зашифрованных) ключей SSH, используя 2048-разрядный RSA. К этой паре можно добавить комментарий, чтобы ее потом можно было легко определить.

```bash
ssh-keygen -t rsa -b 2048 -C "ahmet@fedoraVMAzure"
```

_Описание команды_

`ssh-keygen` — программа, с помощью которой создаются ключи.

`-t rsa` — тип ключа, который нужно создать [RSA](https://en.wikipedia.org/wiki/RSA_(cryptosystem).

`-b 2048` — количество битов в ключе.

`-C "ahmet@fedoraVMAzure"` — комментарий, который будет добавлен в конец файла открытого ключа для идентификации. Обычно в качестве комментария используется адрес электронной почты, но вы можете выбрать для своей инфраструктуры любой удобный метод идентификации.

## Пошаговое руководство по использованию ssh-keygen

Каждый шаг подробно описан. Начните с выполнения команды `ssh-keygen`.

```bash
ssh-keygen -t rsa -b 2048 -C "ahmet@fedoraVMAzure"
Generating public/private rsa key pair.
Enter file in which to save the key (/home/ahmet/.ssh/id_rsa): azure_fedora_id_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in azure_fedora_id_rsa.
Your public key has been saved in azure_fedora_id_rsa.pub.
The key fingerprint is:
14:a3:cb:3e:78:ad:25:cc:55:e9:0c:08:e5:d1:a9:08 ahmet@fedoraVMAzure
The key's randomart image is:
+--[ RSA 2048]----+
|        o o. .   |
|      E. = .o    |
|      ..o...     |
|     . o....     |
|      o S =      |
|     . + O       |
|      + = =      |
|       o +       |
|        .        |
+-----------------+
```

Сохраненные файлы ключей:

`Enter file in which to save the key (/home/ahmet/.ssh/id_rsa): azure_fedora_id_rsa`

Имя пары ключей, используемое в этой статье. По умолчанию пара ключей называется **id\_rsa**. Так как некоторые средства ожидаемо ищут закрытый ключ в файле с именем **id\_rsa**, есть смысл создать такой файл. (По умолчанию все пары ключей SSH и файл конфигурации SSH располагаются в каталоге `~/.ssh/`.)

```bash
ahmet@fedora$ ls -al ~/.ssh
-rw------- 1 ahmet staff  1675 Aug 25 18:04 azure_fedora_id_rsa
-rw-r--r-- 1 ahmet staff   410 Aug 25 18:04 azure_fedora_id_rsa.pub
```
Эта команда покажет новые пары ключей и соответствующие разрешения. `ssh-keygen` создает каталог `~/.ssh`, если его нет, и устанавливает для него надлежащий файловый режим и режим владения.

Пароль ключа:

`Enter passphrase (empty for no passphrase):`

Настоятельно рекомендуем добавить пароль для своей пары ключей (`ssh-keygen` учитывает его в качестве парольной фразы). Если не защитить пару ключей паролем, любой пользователь, у которого есть копия файла закрытого ключа сможет использовать его, чтобы войти на любой из серверов, для которого предусмотрен соответствующий открытый ключ. Следовательно, добавив пароль, вы увеличите уровень защиты, на случай если доступ к файлу закрытого ключа получит другой пользователь. Это позволит выиграть время на изменение своих ключей проверки подлинности.

## Использование ssh-agent для хранения пароля закрытого ключа

Чтобы не вводить вручную пароль закрытого ключа при каждом входе с использованием SSH, вы можете создать кэш пароля от файла закрытого ключа с помощью команды `ssh-agent`. Это позволит вам быстрее выполнять безопасный вход на виртуальные машины Linux. Если вы используете операционную систему OS X, пароль закрытого ключа при вызове `ssh-agent` будет надежно сохранен в цепочке ключей.

Сначала убедитесь, что `ssh-agent` выполняется.

```bash
eval "$(ssh-agent -s)"
```

Теперь добавьте закрытый ключ `ssh-agent` с помощью команды `ssh-add`. В OS X эта команда запустит цепочку ключей, в которой будут храниться учетные данные.

```bash
ssh-add ~/.ssh/azure_fedora_id_rsa
```

Пароль закрытого ключа теперь сохранен; вам не нужно будет вводить этот пароль при каждом входе с использованием SSH.

## Создание и настройка файла конфигурации SSH

Файл `~/.ssh/config` не является необходимым для установки и запуска виртуальной машины Linux, но мы все же рекомендуем создать и настроить его. Это позволит предотвратить непреднамеренное использование паролей для входа в виртуальные машины, автоматизировать использование разных пар ключей для разных виртуальных машин Azure, а также настроить для работы с несколькими серверами другие программы, например **git**.

Ниже приведены шаги для выполнения стандартной конфигурации.

### Создание файла

```bash
touch ~/.ssh/config
```

### Изменение файла путем добавления новой конфигурации SSH

```bash
vim ~/.ssh/config
```

### Пример файла `~/.ssh/config`:

```bash
# Azure Keys
Host fedora22
  Hostname 102.160.203.241
  User ahmet
  PubkeyAuthentication yes
  IdentityFile /home/ahmet/.ssh/azure_fedora_id_rsa
# ./Azure Keys
# Default Settings
Host *
  PubkeyAuthentication=no
  IdentitiesOnly=yes
  ServerAliveInterval=60
  ServerAliveCountMax=30
  ControlMaster auto
  ControlPath /home/ahmet/.ssh/Connections/ssh-%r@%h:%p
  ControlPersist 4h
  StrictHostKeyChecking=no
  IdentityFile /home/ahmet/.ssh/id_rsa
  UseRoaming=no
```

Эта конфигурация SSH предусматривает отдельные разделы для служб, чтобы каждая из них могла использовать выделенную ей пару ключей. Параметры по умолчанию используются для всех узлов, на которые вы вошли и которые не принадлежат ни к одной из вышеуказанных групп.


### Описание файла конфигурации

`Host` — имя узла, вызываемого в терминале. Команда `ssh fedora22` сообщает `SSH`, что нужно использовать значения из блока параметров с меткой `Host fedora22`. ПРИМЕЧАНИЕ. Вы можете использовать любую удобную для вас метку, не обязательно связанную с именем узла любого из серверов.

`Hostname 102.160.203.241` — IP-адрес или DNS-имя сервера, на который будет выполняться вход. Он используется для маршрутизации на сервер и может быть внешним IP-адресом, сопоставимым с внутренним IP-адресом.

`User git` — удаленная учетная запись пользователя, которую нужно использовать при входе на виртуальную машину Azure.

`PubKeyAuthentication yes` — таким образом SSH сообщается, что для входа используется ключ SSH.

`IdentityFile /home/ahmet/.ssh/azure_fedora_id_rsa` — таким образом SSH сообщается, какую пару ключей следует использовать для прохождения аутентификации при входе на сервер.


## Вход в Linux с использованием SSH без пароля

Теперь, когда есть пара ключей SSH и настроен файл конфигурации SSH, вход в виртуальную машину Linux выполняется быстро и безопасно. При первом входе на сервер с использованием ключа SSH команда отправляет запрос на парольную фразу для этого файла ключа.

```bash
ssh fedora22
```

### Описание команды

При выполнении команды `ssh fedora22` SSH сначала находит и загружает все параметры из блока `Host fedora22`, а затем загружает все недостающие параметры из последнего блока (`Host *`).

## Дальнейшие действия

Следующий шаг — создание виртуальных машин Linux Azure с помощью нового открытого ключа SSH. Виртуальные машины Azure, созданные с использованием открытого ключа SSH в качестве данных для входа, защищены лучше, чем виртуальные машины, созданные с помощью метода по умолчанию, предусматривающего использование паролей. Для виртуальных машин Azure, использующих ключи SSH для входа, по умолчанию отключен вход с помощью пароля, что позволяет избежать попыток взлома методом подбора.

- [Создание защищенной виртуальной машины Linux с помощью шаблона Azure](virtual-machines-linux-create-ssh-secured-vm-from-template.md)
- [Создание защищенной виртуальной машины Linux с помощью портала Azure](virtual-machines-linux-quick-create-portal.md)
- [Создание защищенной виртуальной машины Linux с помощью интерфейса командной строки Azure](virtual-machines-linux-quick-create-cli.md)

<!---HONumber=AcomDC_0525_2016-->