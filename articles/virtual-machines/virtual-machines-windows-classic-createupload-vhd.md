<properties
	pageTitle="Создание и передача виртуального жесткого диска Windows Server с помощью Powershell | Microsoft Azure"
	description="Узнайте, как создать и передать виртуальный жесткий диск Windows Server с помощью классической модели развертывания и Azure Powershell."
	services="virtual-machines-windows"
	documentationCenter=""
	authors="cynthn"
	manager="timlt"
	editor="tysonn"
	tags="azure-service-management"/>

<tags
	ms.service="virtual-machines-windows"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="01/21/2016"
	ms.author="cynthn"/>

# Создание и передача виртуального жесткого диска Windows Server в Azure

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-classic-include.md)]Модель диспетчера ресурсов.


В этой статье показано, как передать виртуальный жесткий диск с операционной системой, чтобы использовать его в качестве образа для создания виртуальных машин. Дополнительные сведения о дисках и виртуальных жестких дисках в Microsoft Azure см. в разделе [О дисках и виртуальных жестких дисках для виртуальных машин](virtual-machines-linux-about-disks-vhds.md).



## Предварительные требования

В этой статье предполагается, что у вас есть следующие компоненты.

1. **Подписка Azure**. Если у вас нет подписки, вы можете [создать учетную запись Azure бесплатно](/pricing/free-trial/?WT.mc_id=A261C142F). Вы получаете кредиты, которые можно использовать для опробования платных служб Azure, и даже после израсходования кредитов вы сохраняете учетную запись и возможность использовать бесплатные службы Azure, такие как веб-сайты. С вашей кредитной карты не будет взиматься плата, пока вы явно не измените параметры и не запросите расчет. Вы также можете [активировать преимущества подписчика MSDN](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F). Ваша подписка MSDN каждый месяц приносит вам кредиты, которые можно использовать для оплаты служб Azure.

2. **Microsoft Azure PowerShell**. У вас уже установлен и настроен на использование подписки модуль Microsoft Azure PowerShell. Информацию о скачивании модуля см. в разделе [Загрузки Microsoft Azure](https://azure.microsoft.com/downloads/). Учебник по установке и настройке этого модуля см. [здесь](../powershell-install-configure.md). Для отправки файла виртуального жесткого диска используйте командлет [Add-AzureVHD](http://msdn.microsoft.com/library/azure/dn495173.aspx).

3. **Поддерживаемая операционная система Windows, сохраненная в VHD-файле и подключенная к виртуальной машине**. Существует несколько средств для создания VHD-файлов. Например, для создания виртуальной машины и установки операционной системы можно использовать Hyper-V. Инструкции см. в разделе [Установка роли Hyper-V и настройка виртуальной машины](http://technet.microsoft.com/library/hh846766.aspx). Дополнительные сведения об операционных системах см. в статье [Поддержка серверного ПО от Майкрософт для виртуальных машин Microsoft Azure](http://go.microsoft.com/fwlink/p/?LinkId=393550).

> [AZURE.IMPORTANT] Формат VHDX не поддерживается в Microsoft Azure. Можно преобразовать диск в формат VHD с помощью диспетчера Hyper-V или командлета [Convert-VHD](http://technet.microsoft.com/library/hh848454.aspx). Дополнительные сведения см. в [этом блоге](http://blogs.msdn.com/b/virtual_pc_guy/archive/2012/10/03/using-powershell-to-convert-a-vhd-to-a-vhdx.aspx).

## Шаг 1. Подготовка виртуального жесткого диска 

Перед отправкой виртуального жесткого диска в Azure его необходимо подготовить с помощью средства Sysprep к использованию в качестве образа. Дополнительные сведения о программе Sysprep см. в статье [Использование программы Sysprep: введение](http://technet.microsoft.com/library/bb457073.aspx).

В виртуальной машине, в которую была установлена операционная система, сделайте следующее:

1. Войдите в операционную систему.

2. Откройте окно командной строки с правами администратора. Измените каталог на **%windir%\\system32\\sysprep** и запустите файл `sysprep.exe`.

	![Откройте окно командной строки.](./media/virtual-machines-windows-classic-createupload-vhd/sysprep_commandprompt.png)

3.	Откроется диалоговое окно **Программа подготовки системы**.

	![Запустите Sysprep](./media/virtual-machines-windows-classic-createupload-vhd/sysprepgeneral.png)

4.  В разделе **Программа подготовки системы** выберите **Переход в окно приветствия системы (OOBE)** и убедитесь, что установлен флажок **Подготовка к использованию**.

5.  В разделе **Параметры завершения работы** выберите **Завершение работы**.

6.  Нажмите кнопку **ОК**.

## Шаг 2. Создание или получения сведений из учетной записи хранения Azure

Вам потребуется учетная запись хранения Azure, в которую можно будет отправить VHD-файл. Здесь показано, как создать учетную запись или получить нужные сведения из существующей учетной записи.

### Вариант 1. Создание учетной записи хранения

1. Войдите на [классический портал Azure](https://manage.windowsazure.com).

2. На панели команд нажмите **Создать**.

3. Последовательно выберите **Службы данных** > **Хранилище** > **Быстрое создание**.

	![Быстрое создание учетной записи хранения](./media/virtual-machines-windows-classic-createupload-vhd/Storage-quick-create.png)

4. Заполните поля, как показано ниже:

 - В поле **URL-адрес** введите имя поддомена, используемого в URL-адресе для учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это имя становится именем узла для URL-адреса, который используется для доступа к ресурсам больших двоичных объектов, очередей или таблиц в подписке.
 - Выберите **расположение или территориальную группу** для учетной записи хранения. Указав территориальную группу, можно выполнить совместное размещение облачных служб и хранилища в одном центре обработки данных.
 - Укажите, следует ли использовать **георепликацию** для учетной записи хранения. По умолчанию георепликация включена. Этот параметр позволяет бесплатно выполнять репликацию данных в дополнительное расположение. Таким образом хранилище переключится на это расположение в случае аварийного отказа основного расположения. Дополнительное местоположение назначается автоматически и не может быть изменено. Если в соответствии с законодательными требованиями или организационной политикой требуется более жесткий контроль расположения облачного хранилища, георепликацию можно отключить. Однако если включить георепликацию позже, с вас будет однократно снята плата за репликацию существующих данных в дополнительное расположение. Службы хранения без георепликации предлагаются со скидкой. Дополнительные сведения см. в статье [Создание и удаление учетной записи хранения, а также управление ею](../storage-create-storage-account/#replication-options).

      ![Введите сведения об учетной записи хранения](./media/virtual-machines-windows-classic-createupload-vhd/Storage-create-account.png)

5. Щелкните **Создать учетную запись хранения**. Учетная запись появится в списке раздела **Хранилище**.

	![Учетная запись хранения успешно создана](./media/virtual-machines-windows-classic-createupload-vhd/Storagenewaccount.png)

6. Теперь создайте контейнер для переданных виртуальных жестких дисков. Щелкните имя учетной записи хранения, а затем щелкните **Контейнеры**.

	![Информация об учетной записи хранения](./media/virtual-machines-windows-classic-createupload-vhd/storageaccount_detail.png)

7. Щелкните **Создание контейнера**.

	![Информация об учетной записи хранения](./media/virtual-machines-windows-classic-createupload-vhd/storageaccount_container.png)

8. Введите имя своего контейнера в поле **Имя** и выберите политику доступа в поле **Доступ**.

	![Имя контейнера](./media/virtual-machines-windows-classic-createupload-vhd/storageaccount_containervalues.png)

	> [AZURE.NOTE] По умолчанию доступ к контейнеру предоставляется только владельцу учетной записи. Чтобы разрешить общий доступ на чтение для больших двоичных объектов в контейнере, но не к свойствам и метаданным контейнера, используйте параметр **Общедоступный BLOB-объект**. Чтобы разрешить полный общий доступ на чтение для контейнера и больших двоичных объектов, используйте параметр **Общедоступный контейнер**.

### Вариант 2. Получение информации об учетной записи хранения

1.	Войдите на [классический портал Azure](https://manage.windowsazure.com).

2.	В области навигации щелкните **Хранилище**.

3.	Щелкните имя учетной записи хранения, а затем откройте **панель мониторинга**.

4.	На панели мониторинга в разделе **Службы** наведите указатель мыши на URL-адрес больших двоичных объектов, щелкните значок буфера обмена, чтобы скопировать URL-адрес, а затем вставьте и сохраните его. Он будет использоваться при создании команды для отправки виртуального жесткого диска.

## Шаг 3. Подключение к подписке из Azure PowerShell

Перед загрузкой файла VHD необходимо установить безопасное соединение между компьютером и вашей подпиской в Azure. Это можно сделать, используя метод Microsoft Azure Active Directory или метод сертификатов.

> [AZURE.TIP] Сведения о том, как начать работу с Azure PowerShell, см. в разделе [Установка и настройка Microsoft Azure PowerShell](../powershell-install-configure.md). Общие сведения см. в статье [Начало работы с командлетами Microsoft Azure](https://msdn.microsoft.com/library/azure/jj554332.aspx).

### Вариант 1. Использование Microsoft Azure AD

1. Откройте консоль Azure PowerShell.

2. Введите `Add-AzureAccount`.

3.	При входе в ОС Windows введите имя пользователя и пароль своей рабочей или учебной учетной записи.

4. Azure выполняет проверку подлинности и сохраняет учетные данные, а затем закрывает окно.

### Вариант 2. Использование сертификата

1. Откройте консоль Azure PowerShell.

2.	Введите `Get-AzurePublishSettingsFile`.

3. В открывшемся окне браузера появится запрос на скачивание PUBLISHSETTINGS-файла. Он содержит информацию и сертификат для подписки Microsoft Azure.

	![Страница скачивания браузера](./media/virtual-machines-windows-classic-createupload-vhd/Browser_download_GetPublishSettingsFile.png)

3. Сохраните файл .publishsettings.

4. Введите `Import-AzurePublishSettingsFile <PathToFile>`.

	где `<PathToFile>` — это полный путь к файлу PUBLISHSETTINGS.

## Шаг 4. Загрузка файла VHD

При загрузке файла .vhd его можно поместить в любом месте внутри хранилища больших двоичных объектов.

1. В окне Azure PowerShell, использованном при выполнении предыдущего шага, введите команду такого типа:

	`Add-AzureVhd -Destination "<BlobStorageURL>/<YourImagesFolder>/<VHDName>.vhd" -LocalFilePath <PathToVHDFile>`

	Описание
	- **BlobStorageURL** — это URL-адрес для учетной записи хранения.
	- **YourImagesFolder** — это контейнер внутри хранилища BLOB-объектов, где будут храниться образы.
	- **VHDName** — это имя, которое должно отображаться на классическом портале Azure для идентификации виртуального жесткого диска.
	- **PathToVHDFile** — это полный путь и имя VHD-файла.

	![PowerShell Add-AzureVHD](./media/virtual-machines-windows-classic-createupload-vhd/powershell_upload_vhd.png)

Дополнительную информацию о командлете Add-AzureVhd см. в разделе [Add-AzureVhd](http://msdn.microsoft.com/library/dn495173.aspx).

## Шаг 5. Добавление образа в список пользовательских образов

> [AZURE.TIP] Чтобы использовать для добавления образа модуль Azure PowerShell, а не классический портал Azure, воспользуйтесь командлетом **Add-AzureVMImage**. Например:

>	`Add-AzureVMImage -ImageName <ImageName> -MediaLocation <VHDLocation> -OS <OSType>`

1. На классическом портале Azure в разделе **Все элементы** щелкните **Виртуальные машины**.

2. В разделе виртуальных машин щелкните **Образы**.

3. Нажмите кнопку **Создать образ**.

	![PowerShell Add-AzureVHD](./media/virtual-machines-windows-classic-createupload-vhd/Create_Image.png)

4. В окне **Создание образа на основе VHD** сделайте следующее.

	- Укажите **имя**.

	- Введите **описание**.

	- В разделе **URL-адрес VHD-файла** щелкните значок папки, чтобы открыть окно **Обзор облачного хранилища**. Найдите VHD-файл и нажмите кнопку **Открыть**.

    ![Выбор виртуального жесткого диска](./media/virtual-machines-windows-classic-createupload-vhd/Select_VHD.png)

5.	В окне **Создание образа на основе VHD** выберите свою операционную систему в разделе **Семейство операционных систем**. Установите флажок **Я запустил Sysprep на виртуальной машине, связанной с этим VHD**, чтобы подтвердить, что операционная система подготовлена. Затем нажмите кнопку **ОК**.

    ![Добавление образа](./media/virtual-machines-windows-classic-createupload-vhd/Create_Image_From_VHD.png)

6. После выполнения предыдущих действий новый образ отобразится в списке при выборе вкладки **Образы**.

	![пользовательский образ](./media/virtual-machines-windows-classic-createupload-vhd/vm_custom_image.png)

	Теперь при создании виртуальной машины вы сможете воспользоваться этим новым образом, расположенным в папке **Мои образы**. Инструкции см. в статье [Создание настраиваемой виртуальной машины](virtual-machines-windows-classic-createportal.md).

	![создание виртуальной машины на основе пользовательского образа](./media/virtual-machines-windows-classic-createupload-vhd/create_vm_custom_image.png)

	> [AZURE.TIP] Если при попытке создать виртуальную машину возникнет сообщение об ошибке "Виртуальный жесткий диск https://XXXXX.. имеет неподдерживаемый виртуальный размер YYYY Б. Размер должен измеряться целым числом (в МБ)», это означает, что размер виртуальной памяти вашего VHD не составляет целое число в мегабайтах, и поэтому его размер нефиксированный. Попытайтесь добавить образ, используя командлет **Add-AzureVMImage** PowerShell вместо классического портала Azure (см. шаг 5 выше). Командлеты Azure обеспечивают соответствие VHD требованиям Azure.



[Step 1: Prepare the image to be uploaded]: #prepimage
[Step 2: Create a storage account in Azure]: #createstorage
[Step 3: Prepare the connection to Azure]: #prepAzure
[Step 4: Upload the .vhd file]: #upload

<!---HONumber=AcomDC_0323_2016-->