---
title: Подробное описание устранения неполадок SSH для виртуальной машины Azure | Microsoft Docs
description: Подробные указания по устранению неполадок SSH-подключений к виртуальной машине Azure
keywords: в SSH-подключении отказано, ошибка SSH, Azure SSH, ошибка SSH-подключения
services: virtual-machines-linux
documentationcenter: ''
author: iainfoulds
manager: timlt
editor: ''
tags: top-support-issue,azure-service-management,azure-resource-manager

ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: support-article
ms.date: 09/01/2016
ms.author: iainfou

---
# Подробное описание устранения неполадок SSH
Клиенту SSH не всегда удается получить доступ к SSH-службе на виртуальной машине по многим причинам. Если вы использовали более [общие действия по устранению неполадок SSH](virtual-machines-linux-troubleshoot-ssh-connection.md), то необходимы более конкретные действия для устранения проблемы подключения. В этой статье подробно изложено, как определить, где происходит сбой подключения SSH и как его устранить.

## Выполнение предварительных действий
На следующей схеме показаны задействованные при этом компоненты.

![Схема компонентов службы SSH](./media/virtual-machines-linux-detailed-troubleshoot-ssh-connection/ssh-tshoot1.png)

Приведенные ниже шаги помогут вам выявить источник сбоя и определить способы его устранения или обхода.

Сначала проверьте состояние виртуальной машины на портале.

[На портале Azure](https://portal.azure.com)

1. Для виртуальных машин, созданных с помощью классической модели развертывания, последовательно выберите **Обзор** > **Виртуальные машины (классика)** > *Имя виртуальной машины*.
   
    -ИЛИ-
   
    Для виртуальных машин, созданных с использованием модели развертывания с помощью Resource Manager, последовательно выберите **Обзор** > **Виртуальные машины** > *Имя виртуальной машины*.
   
    Панель состояния виртуальной машины должна отображать состояние **Выполняется**. Прокрутите страницу вниз для просмотра последних действий в ресурсах вычислений, хранения и сетевых ресурсах.
2. Выберите **Параметры**, чтобы проверить конечные точки, IP-адреса и другие параметры.
   
    Чтобы определить конечные точки в виртуальных машинах, созданных с помощью Resource Manager, задайте [группу безопасности сети](../virtual-network/virtual-networks-nsg.md). Кроме того, убедитесь, что к группе безопасности сети применены правила и что в подсети есть ссылки на них.

Для этого на [классическом портале Azure](https://manage.windowsazure.com) для виртуальных машин, созданных с помощью классической модели развертывания, сделайте следующее.

1. Последовательно выберите **Виртуальные машины** > *Имя виртуальной машины*.
2. Выберите **Панель мониторинга** для виртуальной машины, чтобы проверить ее состояние.
3. Выберите **Монитор**, чтобы просмотреть последние действия, связанные с вычислительными ресурсами, ресурсами сети и хранения.
4. Щелкните **Конечные точки**, чтобы убедиться, что для трафика SSH существует конечная точка.

Чтобы проверить сетевое подключение, проверьте настроенные конечные точки и определите, можете ли вы получить доступ к виртуальной машине с помощью другого протокола, например HTTP, или другой службы.

Выполнив эти действия, попытайтесь создать SSH-подключение еще раз.

## Поиск источника проблемы
Неспособность клиента SSH подключиться к службе SSH на виртуальной машине Azure может быть связана с проблемами и ошибками в настройках перечисленных ниже компонентов.

* [Клиентский компьютер SSH.](#source-1-ssh-client-computer)
* [Пограничное устройство организации.](#source-2-organization-edge-device)
* [Конечная точка облачной службы и список управления доступом (ACL)](#source-3-cloud-service-endpoint-and-acl)
* [Группы безопасности сети](#source-4-network-security-groups)
* [Виртуальная машина Azure под управлением Linux](#source-5-linux-based-azure-virtual-machine)

## Источник 1: клиентский компьютер SSH
Чтобы исключить компьютер из числа возможных источников ошибок, убедитесь, что с его помощью можно установить SSH-подключения к другому локальному компьютеру под управлением Linux.

![Схема, на которой выделены компоненты клиентского компьютера SSH](./media/virtual-machines-linux-detailed-troubleshoot-ssh-connection/ssh-tshoot2.png)

В случае сбоя подключения проверьте, нет ли на компьютере:

* настройки локального брандмауэра, блокирующей входящий и исходящий SSH-трафик (TCP 22);
* локального программного обеспечения с функциями прокси клиента, которое не позволяет установить SSH-подключение;
* локального программного обеспечения для мониторинга сети, которое не позволяет установить SSH-подключение;
* других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов.

Если одно из этих условий совпадает, временно отключите программное обеспечение и попробуйте установить SSH-подключение к локальному компьютеру, чтобы узнать причину блокировки подключения на вашем компьютере. Затем при поддержке администратора сети измените параметры программного обеспечения таким образом, чтобы оно не блокировало SSH-подключение.

Если вы используете проверку подлинности на основе сертификата, убедитесь, что у вас есть следующие разрешения для папки SSH в домашнем каталоге:

* Chmod 700 ~/.ssh;
* Chmod 644 ~/.ssh/*.pub;
* Chmod 600 ~/.ssh/id\_rsa (или другие файлы, в которых хранятся ваши закрытые ключи);
* Chmod 644 ~/.ssh/known\_hosts (содержит узлы, к которым установлено подключение по SSH-протоколу).

## Источник 2: пограничное устройство организации
Чтобы исключить пограничное устройство организации из числа возможных источников ошибок, убедитесь, что компьютер, подключенный к Интернету напрямую, может устанавливать SSH-подключения к виртуальной машине Azure. Если вы получаете доступ к виртуальной машине через VPN-подключение типа "сеть — сеть" или подключение Azure ExpressRoute, перейдите к подразделу [Источник 4: группы безопасности сети](#nsg).

![Схема, на которой выделено пограничное устройство организации](./media/virtual-machines-linux-detailed-troubleshoot-ssh-connection/ssh-tshoot3.png)

Если у вас нет компьютера, непосредственно подключенного к Интернету, создайте виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе, и используйте ее. Дополнительные сведения см. в статье [Создание виртуальной машины Linux в среде Azure](virtual-machines-linux-quick-create-cli.md). Завершив проверку, удалите группу ресурсов или виртуальную машину и облачную службу.

Если вам удается установить SSH-подключение с компьютера, непосредственно подключенного к Интернету, убедитесь, что на пограничном устройстве вашей организации отсутствуют следующие компоненты:

* внутренний брандмауэр, который блокирует SSH-трафик в Интернете;
* прокси-сервер, который не позволяет устанавливать SSH-подключения;
* программное обеспечение для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует SSH-подключения.

При поддержке администратора сети измените параметры пограничного устройства организации таким образом, чтобы оно не блокировало SSH-трафик через Интернет.

## Источник 3: конечная точка облачной службы и список управления доступом (ACL)
> [!NOTE]
> Этот источник применяется только к виртуальным машинам, созданным с помощью классической модели развертывания. Для виртуальных машин, созданных с помощью Resource Manager, перейдите к подразделу [Источник 4: группы безопасности сети](#nsg).
> 
> 

Чтобы исключить конечную точку облачной службы и список управления доступом из числа возможных источников ошибок, убедитесь, что другая виртуальная машина Azure в той же виртуальной сети может устанавливать SSH-подключения к вашей виртуальной машине.

![Диаграмма, на которой выделены конечная точка облачной службы и ACL](./media/virtual-machines-linux-detailed-troubleshoot-ssh-connection/ssh-tshoot4.png)

Если у вас нет еще одной виртуальной машины в той же виртуальной сети, вы можете легко ее создать. Дополнительные сведения см. в статье [Создание виртуальной машины Linux в Azure с помощью интерфейса командной строки](virtual-machines-linux-quick-create-cli.md). Завершив проверку, удалите дополнительную виртуальную машину.

Если вы создаете SSH-подключение к виртуальной машине в той же виртуальной сети, проверьте следующие параметры:

* **Конфигурация конечной точки для SSH-трафика на целевой виртуальной машине.** Частный TCP-порт на конечной точке должен совпадать с TCP-портом, который прослушивает SSH-служба на виртуальной машине. (Порт по умолчанию — 22.) Для виртуальных машин, созданных с использованием модели развертывания с помощью Resource Manager, проверьте номер TCP-порта SSH. Для этого на портале Azure последовательно выберите **Обзор** > **Virtual machines (v2)** (Виртуальные машины (вер. 2)) > *Имя виртуальной машины* > **Параметры** > **Конечные точки**.
* **Список управления доступом на конечной точке для SSH-трафика на целевой виртуальной машине.** С помощью него можно разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если список управления доступом неправильно настроен, входящий SSH-трафик на эту конечную точку может блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительные сведения см. в статье [Сетевые списки управления доступом](../virtual-network/virtual-networks-acl.md).

Чтобы исключить конечную точку из числа возможных источников проблем, удалите ее и создайте новую, указав имя SSH (номер для общего и частного TCP-порта — 22). Дополнительные сведения см. в статье [Настройка конечных точек на виртуальной машине Azure](virtual-machines-windows-classic-setup-endpoints.md).

<a id="nsg"></a>

## Источник 4: группы безопасности сети
Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure. Проверьте свои правила групп безопасности сети и убедитесь, что входящий и исходящий SSH-трафик разрешен. Дополнительную информацию см. в [статье о группах безопасности сети](../virtual-network/virtual-networks-nsg.md).

## Источник 5: виртуальная машина Azure в службе Azure
Последним потенциальным источником проблем является сама виртуальная машина Azure.

![Диаграмма, на которой выделена виртуальная машина Azure под управлением Linux](./media/virtual-machines-linux-detailed-troubleshoot-ssh-connection/ssh-tshoot5.png)

Выполните указания по [сбросу пароля или SSH на виртуальных машинах Linux](virtual-machines-linux-classic-reset-access.md) (если вы еще этого не сделали).

Попытайтесь снова установить подключение со своего компьютера. Если вам по-прежнему не удается подключиться, проверьте, не соответствует ли ваша среда одному из следующих условий:

* На целевой виртуальной машине не запущена SSH-служба.
* SSH-служба не прослушивает TCP-порт 22. Чтобы проверить это, установите клиент telnet на локальном компьютере и выполните действие "telnet *cloudServiceName*.cloudapp.net 22". Эта команда позволит определить, разрешает ли виртуальная машина входящий и исходящий обмен данными с конечной точкой SSH.
* Правила локального брандмауэра на целевой виртуальной машине блокируют входящий и исходящий SSH-трафик.
* Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует SSH-подключения.

## Дополнительные ресурсы
Дополнительные сведения об устранении неполадок с доступом к приложению см. в разделе [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines-linux-troubleshoot-app-connection.md).

<!---HONumber=AcomDC_0907_2016-->