<properties
	pageTitle="Запись образа виртуальной машины Linux | Microsoft Azure"
	description="Узнайте, как записать образ виртуальной машины Azure под управлением Linux, созданной с помощью классической модели развертывания."
	services="virtual-machines"
	documentationCenter=""
	authors="dsk-2015"
	manager="timlt"
	editor="tysonn"
	tags="azure-service-management"/>

<tags
	ms.service="virtual-machines"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-linux"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/16/2015"
	ms.author="dkshir"/>


# Как записать образ виртуальной машины Linux для использования в качестве шаблона

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-classic-include.md)]Модель диспетчера ресурсов.


В этой статье показано, как записать виртуальную машину Azure под управлением Linux, чтобы использовать ее в качестве шаблона при создании других виртуальных машин. Данный шаблон виртуальной машины включает в себя диск операционной системы и прочие диски данных, присоединенные к виртуальной машине. Он не включает в себя сетевую конфигурацию, поэтому ее необходимо настроить при создании других виртуальных машин, использующих шаблон.

Azure воспринимает этот шаблон как образ и хранит его в папке **Образы**. В этой папке также хранятся все переданные вами образы. Дополнительную информацию об образах см. в статье [Об образах виртуальной машины в Azure][].

## Перед началом работы

В шагах этой статьи предполагается, что вы уже создали виртуальную машину Azure с использованием классической модели развертывания и настроили операционную систему, а также присоединили диски данных. Если это еще не сделано, см. данные указания:

- [Создание виртуальной машины с ОС Linux][]


## Запись виртуальной машины

1. Подключитесь к виртуальной машине с помощью SSH-клиента по своему усмотрению. Дополнительную информацию см. в разделе [Как войти в виртуальную машину под управлением Linux][].

2. В окне SSH введите следующую команду. Обратите внимание, что выходные данные `waagent` могут незначительно отличаться в зависимости от версии этой служебной программы:

	`sudo waagent -deprovision`

	Эта команда попытается очистить систему и сделать ее пригодной для повторной подготовки. В ходе операции выполняются такие задачи:

	- удаляются ключи узла SSH (если в файле конфигурации для Provisioning.RegenerateSshHostKeyPair указано значение «y»);
	- очищается конфигурация имени сервера в /etc/resolv.conf;
	- удаляется пароль пользователя `root` из /etc/shadow (если в файле конфигурации для Provisioning.DeleteRootPassword указано значение «y»);
	- удаляются кэшированные аренды DHCP-клиентов.
	- возвращается имя узла localhost.localdomain;
	- удаляется последняя подготовленная учетная запись пользователя (полученная из /var/lib/waagent) и **связанные с ней данные**.

	>[AZURE.NOTE]Процедура отзыва приводит к удалению файлов и данных, так как выполняется попытке «обобщить» образ. Эту команду следует выполнять только на виртуальных машинах, которые требуется записать как шаблон нового образа. Отзыв не гарантирует, что из образа будет удалена вся конфиденциальная информация и что он будет готов к повторному распространению третьим сторонам.


3. Чтобы продолжить, введите **y**. Чтобы предотвратить появление запроса на подтверждение, добавьте параметр `-force`.

4. Введите **Exit**, чтобы закрыть SSH-клиент.


	>[AZURE.NOTE]Далее предполагается, что вы уже [установили Azure CLI](../xplat-cli-install.md) на клиентском компьютере. Также все действия можно выполнить на [портале управления][].

5. На клиентском компьютере откройте интерфейс командной строки Azure и войдите в подписку Azure. Подробнее см. в разделе [Подключение к среде Azure с использованием интерфейса командной строки Azure (Azure CLI)](../xplat-cli-connect.md).

6. Убедитесь, что вы находитесь в режиме управления службами:

	`azure config mode asm`

7. Завершите работу виртуальной машины, которая была отозвана ранее, с помощью команды:

	`azure vm shutdown <your-virtual-machine-name>`

	>[AZURE.NOTE]Вы можете получить все виртуальные машины, созданные в подписке, с помощью `azure vm list`.

8. Когда виртуальная машина остановлена, запишите образ с помощью команды:

	`azure vm capture -t <your-virtual-machine-name> <new-image-name>`

	Введите имя образа вместо _new-image-name_. Эта команда создает обобщенный образ операционной системы. Подкоманда `-t` удаляет исходную виртуальную машину.

9.	Новый образ станет доступным в списке образов, которые можно использовать для настройки новых виртуальных машин. Его можно просмотреть с помощью следующей команды:

	`azure vm image list`

	На [портале управления][] он будет показан в списке **ОБРАЗЫ**.

	![Успешная запись образа](./media/virtual-machines-linux-capture-image/VMCapturedImageAvailable.png)


## Дальнейшие действия
Образ готов к использованию в качестве шаблона для создания виртуальных машин. Вы можете использовать команду Azure CLI `azure vm create` и указать имя образа, который только что создали. Подробнее о команде см. в разделе [Управление службами Azure с помощью интерфейса командной строки Azure](virtual-machines-command-line-tools.md). Кроме того, с помощью [портала управления][] можно создать настраиваемую виртуальную машину, используя метод **Из коллекции** и выбрав образ, который вы только что создали. Подробнее см. в разделе [Как создать настраиваемую виртуальную машину][].

**См. также:** [Руководство пользователя агента Linux для Azure](virtual-machines-linux-agent-user-guide.md)

[портала управления]: http://manage.windowsazure.com
[портале управления]: http://manage.windowsazure.com
[Как войти в виртуальную машину под управлением Linux]: virtual-machines-linux-how-to-log-on.md
[Об образах виртуальной машины в Azure]: http://msdn.microsoft.com/library/azure/dn790290.aspx
[Как создать настраиваемую виртуальную машину]: virtual-machines-create-custom.md
[How to Attach a Data Disk to a Virtual Machine]: storage-windows-attach-disk.md
[Создание виртуальной машины с ОС Linux]: virtual-machines-linux-tutorial.md

<!---HONumber=Oct15_HO3-->