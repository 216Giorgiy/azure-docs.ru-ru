<properties 
	pageTitle="Как настроить Tomcat7 на виртуальной машине Linux с использованием Microsoft Azure" 
	description="Узнайте, как установить Tomcat7 в виртуальной машине под управлением Linux в Microsoft Azure." 
	services="virtual-machines" 
	documentationCenter="" 
	authors="NingKuang" 
	manager="timlt" 
	editor="tysonn"/>

<tags 
	ms.service="virtual-machines" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="vm-linux" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/21/2015" 
	ms.author="ningk"/>

#Как настроить Tomcat7 на виртуальной машине Linux с использованием Microsoft Azure 

Apache Tomcat (или просто Tomcat, ранее также именуемый Jakarta Tomcat) — это веб-сервер с открытым исходный кодом и контейнер сервлетов, разработанный Apache Software Foundation (ASF). Tomcat реализует спецификации технологий Java Servlet и JavaServer Pages (JSP) от Sun Microsystems, а также обеспечивает чистую среду HTTP-веб-серверов Java для выполнения Java-кода. При самой простой конфигурации Tomcat запускается с помощью одного процесса в операционной системе. Этот процесс запускает виртуальную машину Java. Каждый HTTP-запрос браузера к серверу Tomcat обрабатывается как отдельный поток в рамках процесса Tomcat.

В этом руководстве показано, как установить Tomcat7 в образе Linux и развернуть его в службе Microsoft Azure.

Вы узнаете:

-	как создать виртуальную машину в Azure.
-	как подготовить виртуальную машину для Tomcat7;
-	установка Tomcat7.

Предполагается, что читатель уже имеет подписку Azure. В противном случае зарегистрируйтесь и получите бесплатную пробную версию по адресу [http://azure.microsoft.com](http://azure.microsoft.com). Если у вас есть подписка MSDN, ознакомьтесь со статьей [Специальные предложения Microsoft Azure: преимущества для подписчиков MSDN, MPN и Bizspark](http://azure.microsoft.com/pricing/member-offers/msdn-benefits/?c=14-39). Дополнительную информацию о службе Azure см. в статье [Что такое Azure?](http://azure.microsoft.com/overview/what-is-azure/)

В этом учебнике предполагается, что вы располагаете достаточными знаниями по работе с Tomcat и Linux.

##Этап 1. Создание образа
На этом этапе вы создадите виртуальную машину с помощью образа Linux в Azure.

###Шаг 1. Создание ключа проверки подлинности SSH
SSH — это важный инструмент для системных администраторов. Однако для настройки безопасности доступа не рекомендуется использовать пароль, определенный пользователем. Злоумышленники могут взломать ненадежный пароль и проникнуть в вашу систему, использовав имя пользователя.

Хорошая новость заключается в том, что вы можете предоставлять удаленный доступ, не беспокоясь о надежности паролей. Этот метод состоит в проверке подлинности с асимметричным шифрованием. Пользователь проходит проверку подлинности с помощью своего закрытого ключа. Вы можете даже заблокировать учетную запись пользователя, чтобы полностью запретить проверку пароля.

Кроме этого, при использовании этого метода для входа на разные серверы не нужны разные пароли. Вы можете пройти аутентификацию с помощью личного закрытого ключа для всех серверов, благодаря чему не нужно запоминать несколько паролей.

На сервер также можно войти, запросив пароль таким методом.

Выполните следующие действия, чтобы создать ключ проверки подлинности SSH.

1.	Загрузите и установите puttygen из следующего расположения: [http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html](http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html) 
2.	Запустите PUTTYGEN.EXE.
3.	Нажмите кнопку **Создать**, чтобы создать ключи. В процессе вы можете увеличить степень случайности, двигая указатель мыши в пустой области окна. ![][1]
4.	После завершения процесса создания полученный ключ отобразится в средстве Puttygen.exe. Например: ![][2]
5.	Выберите и скопируйте открытый ключ в области **Ключ** и сохраните его в файле с именем publicKey.pem. Не щелкайте **Сохранить открытый ключ**, так как формат файла сохраненного открытого ключа отличается от необходимого открытого ключа.
6.	Щелкните **Сохранить закрытый ключ** и сохраните его в файл с именем privateKey.ppk. 

###Шаг 2. Создание образа на портале предварительной версии Azure
На [портале предварительной версии Azure](https://portal.azure.com/) на панели задач щелкните **Создать**, чтобы создать образ, и выберите образ Linux в соответствии с вашими потребностями. В этом примере используется образ Ubuntu 14.04.![][3]
 
В поле **Имя узла** укажите имя URL-адреса, с помощью которого интернет-клиенты будут получать доступ к этой виртуальной машине. Определите последнюю часть DNS-имени, например tomcatdemo, после чего в службе Azure будет создан URL-адрес tomcatdemo.cloudapp.net.

В поле **Ключ проверки подлинности SSH** скопируйте значение ключа из файла **publicKey.pem**, который содержит открытый ключ, созданный с помощью средства puttygen. ![][4]
  
При необходимости настройте другие параметры и нажмите кнопку «Создать».

##Этап 2. Подготовка виртуальной машины для Tomcat7
На этом этапе вы настроите конечную точку для трафика Tomcat и подключитесь к новой виртуальной машине.
###Шаг 1. Открытие HTTP-порта для разрешения веб-доступа
Конечные точки в Azure состоят из протокола (TCP или UDP), а также общего и частного порта. Частный порт — это порт, который прослушивает служба на виртуальной машине. Общий порт — это порт, который облачная служба Azure прослушивает извне на наличие интернет-трафика.

TCP-порт 8080 — номер порта по умолчанию, который прослушивает Tomcat. Открытие этого порта с помощью конечной точки Azure обеспечивает вам и другим интернет-клиентам доступ к страницам Tomcat.

1.	На портале предварительной версии Azure щелкните **Обзор** -> **Виртуальная машина** и выберите созданную виртуальную машину. ![][5]
2.	Чтобы добавить к виртуальной машине конечную точку, щелкните поле **Конечные точки**. ![][6] 
3.	Щелкните **Добавить**.  
	1.	Введите имя **конечной точки** в поле «Конечная точка» и значение 80 в поле **Общий порт**.  
	  
		Если задать значение 80, вам не нужно будет добавлять номер порта в URL-адрес, по которому вы получаете доступ к Tomcat. Пример: http://tomcatdemo.cloudapp.net.

		Если ему присвоено другое значение, например 81, необходимо добавить номер порта в URL-адрес для доступа к Tomcat. Пример: http://tomcatdemo.cloudapp.net:81/.
	2.	Введите 8080 в поле «Частный порт». По умолчанию Tomcat прослушивает TCP-порт 8080. Если вы изменили значение по умолчанию для прослушивающего порта Tomcat, обновите частный порт, чтобы он совпадал с прослушивающим портом Tomcat. ![][7]
 
4.	Нажмите кнопку **ОК**, чтобы добавить конечную точку к своей виртуальной машине.



###Шаг 2. Подключение к созданному образу.
Вы можете выбрать любой инструмент SSH для подключения к своей виртуальной машине. В этом примере мы используем средство Putty.

Сначала получите DNS-имя виртуальной машины на портале предварительной версии Azure. **Щелкните Обзор** -> **Виртуальные машины** -> имя своей виртуальной машины -> **Свойства**, а затем просмотрите значение в поле **Доменное имя** плитки **Свойства**.

Получите номер порта для соединений по протоколу SSH в поле **SSH**. Вот пример: ![][8]
 
Загрузите средство Putty [здесь](http://www.putty.org/).

После загрузки запустите исполняемый файл PUTTY.EXE. Настройте основные параметры, указав имя узла и номер порта, полученные в свойствах виртуальной машины. Вот пример: ![][9]
 
В левой области щелкните **Подключение** -> **SSH** -> **Проверка подлинности** и нажмите кнопку **Обзор**, чтобы указать расположение файла **privateKey.ppk**, который содержит закрытый ключ, созданный с помощью средства puttygen на этапе 1 «Создание образа». Вот пример: ![][10]
 
Щелкните **Открыть**. Может отобразиться оповещение в окне сообщения. Если вы настроили DNS-имя и номер порта правильно, нажмите кнопку **Да**. ![][11]


Вы увидите следующее: ![][12]

Введите имя пользователя, указанное при создании виртуальной машины на этапе 1 «Создание образа». Вы увидите что-то вроде этого: ![][13]





##Этап 3. Установка программного обеспечения
На этом этапе необходимо установить среду выполнения Java, пакет Tomcat и другие компоненты Tomcat.

###Среда выполнения Java
Программное обеспечение Tomcat написано на языке Java. Есть два вида комплектов Java Development Kit (JDK) — OpenJDK и Oracle JDK. Вы можете выбрать наиболее подходящий из них.

>AZURE.NOTE. В обоих видах JDK для классов в Java API используются почти одинаковые коды, но код для виртуальной машины действительно отличается. В OpenJDK, как правило, используются открытые библиотеки, а в Oracle JDK — закрытые библиотеки. Но в Oracle JDK доступно больше классов и в нем исправлены некоторые ошибки. К тому же Oracle JDK работает стабильнее, чем OpenJDK.

Следующие команды позволяют скачать различные JDK.

open-jdk

	sudo apt-get update  
	sudo apt-get install openjdk-7-jre  

oracle-jdk

-	Чтобы скачать JDK на веб-сайте Oracle:  

		wget --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u5-b13/jdk-8u5-linux-x64.tar.gz  

-	Чтобы создать каталог, в котором будут содержаться файлы JDK:

		sudo mkdir /usr/lib/jvm  

-	Чтобы извлечь файлы JDK в каталог /usr/lib/jvm/:

		sudo tar -zxf jdk-8u5-linux-x64.tar.gz  -C /usr/lib/jvm/  

-	Чтобы задать Oracle JDK в качестве виртуальной машины на Java по умолчанию:

		sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/jdk1.8.0_05/bin/java 100  
		sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/jdk1.8.0_05/bin/javac 100  

####Тестирование:
Вы можете использовать подобную команду, чтобы проверить, правильно ли установлена среда выполнения Java:

	java -version  

Если вы установили open-jdk, то вы увидите примерно такое сообщение: ![][14]

Если вы установили oracle-jdk, то вы увидите примерно такое сообщение: ![][15]

###Tomcat7
Используйте следующую команду для установки Tomcat7:

	sudo apt-get install tomcat7  

Если вы не используете Tomcat7, воспользуйтесь соответствующим вариантом этой команды.

####Тестирование:

Чтобы проверить, успешно ли установлен Tomcat7, перейдите к DNS-имени сервера Tomcat (пример используемого в этой статье URL-адреса http://tomcatexample.cloudapp.net/). Если вы видите подобную страницу, Tomcat7 установлен правильно. ![][16]


###Установка других компонентов Tomcat
Есть другие дополнительные компоненты Tomcat, которые вы также можете установить.

Используйте команду **sudo apt-cache search tomcat7**, чтобы увидеть все доступные компоненты. Следующие команды — примеры установки некоторых полезных частей.

	sudo apt-get install tomcat7-admin      #admin web applications
	sudo apt-get install tomcat7-user         #tools to create user instances  

##Этап 4. Настройка Tomcat
На этом этапе вы узнаете о том, как управлять Tomcat.
###Запуск и остановка Tomcat7
При установке пакета Tomcat7 сервер Tomcat7 запускается автоматически. Вы также можете запустить его самостоятельно, выполнив следующую команду:

	sudo /etc/init.d/tomcat7 start

Чтобы остановить Tomcat7:

	sudo /etc/init.d/tomcat7 stop 

Чтобы просмотреть состояние Tomcat7:

	sudo /etc/init.d/tomcat7 status

Чтобы перезапустить службы Tomcat:

	sudo /etc/init.d/tomcat7 restart

###Администрирование Tomcat
Вы можете изменить файл конфигурации пользователя Tomcat, чтобы настроить учетные данные администратора, с помощью следующей команды:

	sudo vi  /etc/tomcat7/tomcat-users.xml   

Вот пример: ![][17]

>AZURE.NOTE. Создайте надежный пароль для имени пользователя администратора.

Изменив этот файл, вам следует перезапустить службы Tomcat7 с помощью следующей команды, чтобы изменения вступили в силу:

	sudo /etc/init.d/tomcat7 restart  

Откройте браузер и введите URL-адрес **http://<your tomcat server DNS name>/manager/html**. В качестве примера в этой статье используется такой URL-адрес http://tomcatexample.cloudapp.net/manager/html.

После подключения должен появиться результат, аналогичный следующему: ![][18]
 
##Распространенные проблемы

###Не удается получить доступ к виртуальной машине с Tomcat и Moodle из Интернета

-	**Симптом** Tomcat работает, но в браузере не отображается страница Tomcat по умолчанию.
-	**Возможная основная причина**   
	1.	Прослушивающий порт Tomcat отличается от частного порта конечной точки виртуальной машины, предназначенного для трафика Tomcat.  
	
		Проверьте параметры конечных точек общего и частного портов и убедитесь, что частный порт совпадает с прослушивающим портом Tomcat. Дополнительные инструкции по настройке конечных точек см. на этапе 1 «Создание образа».

		Чтобы выяснить, какой порт прослушивает Tomcat, откройте файл /etc/httpd/conf/httpd.conf (выпуск Red Hat) или /etc/tomcat7/server.xml (выпуск Debian). По умолчанию Tomcat прослушивает порт 8080. Пример:

			<Connector port="8080" protocol="HTTP/1.1"  connectionTimeout="20000"  URIEncoding="UTF-8"            redirectPort="8443" />  

		Если вы используете виртуальную машину Debian или Ubuntu и вам необходимо изменить порт, который прослушивает Tomcat по умолчанию (например, 8081), вам следует открыть также порт для операционной системы. Сначала откройте профиль, выполнив следующую команду:

			sudo vi /etc/default/tomcat7  

		Раскомментируйте последнюю строку и измените «no» на «yes».

			AUTHBIND=yes

	2.	Брандмауэр отключил прослушивающий порт Tomcat.

		Если страница по умолчанию Tomcat отображается только на локальном узле, скорее всего, порт, который прослушивает служба Tomcat, блокируется брандмауэром. Для просмотра веб-страницы можно использовать средство w3m. Следующие команды позволяют установить программу w3m и перейти на страницу Tomcat по умолчанию.

			sudo yum  install w3m w3m-img
			w3m http://localhost:8080  

-	**Решение**
	1. Если прослушивающий порт Tomcat отличается от частного порта конечной точки виртуальной машины, предназначенного для трафика, необходимо изменить частный порт, чтобы он совпал с прослушивающим портом Tomcat.   
	
	2.	Если проблема вызвана брандмауэром или программой iptables, добавьте в /etc/sysconfig/iptables такие строки:
	
			-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
			-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT  

		Обратите внимание, что вторая строка требуется только для трафика https.

		Убедитесь, что эти строки расположены над всеми строками, которые глобально ограничивают доступ, например следующими:

			-A INPUT -j REJECT --reject-with icmp-host-prohibited  

		Чтобы перезагрузить iptables, выполните такую команду:

			service iptables restart  

		Протестировано в CentOS 6.3.

###Во время передачи файлов проекта в папку /var/lib/tomcat7/webapps/ вам отказано в доступе.  

-	**Симптом** Если вы используете любой SFTP-клиент (такой как FileZilla) для подключения к своей виртуальной машине и переходите в папку /var/lib/tomcat7/webapps/ для публикации своего сайта, отображается сообщение об ошибке, похожее на следующее:  

		status:	Listing directory /var/lib/tomcat7/webapps
		Command:	put "C:\Users\liang\Desktop\info.jsp" "info.jsp"
		Error:	/var/lib/tomcat7/webapps/info.jsp: open for write: permission denied
		Error:	File transfer failed

-	**Возможная основная причина** У вас нет разрешения на доступ к папке /var/lib/tomcat7/.
-	**Решение** Необходимо получить разрешение из учетной записи root. Можно изменить владельца этой папки из корневой папки на имя пользователя, которое использовалось при подготовке машины. Ниже приведен пример с именем учетной записи azureuser:  

		sudo chown azureuser -R /var/lib/tomcat7/webapps

	Кроме того, используйте параметр -R, чтобы применить разрешения для всех файлов в каталоге.

	Обратите внимание, что эта команда также работает для каталогов. Параметр -R изменяет разрешения для всех файлов и каталогов в каталоге. Пример:

		sudo chown -R username:group directory  

	Эта команда изменяет владельца (как пользователя, так и группу) для всех файлов и каталогов в каталоге и самого каталога.

	Только следующая команда изменяет разрешение для папки каталога, но оставляет файлы и папки внутри самого каталога.

		sudo chown username:group directory



[1]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-01.png
[2]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-02.png
[3]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-03.png
[4]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-04.png
[5]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-05.png
[6]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-06.png
[7]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-07.png
[8]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-08.png
[9]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-09.png
[10]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-10.png
[11]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-11.png
[12]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-12.png
[13]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-13.png
[14]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-14.png
[15]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-15.png
[16]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-16.png
[17]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-17.png
[18]: ./media/virtual-machines-linux-setup-tomcat7-linux/virtual-machines-linux-setup-tomcat7-linux-18.png
 

<!---HONumber=July15_HO3-->