<properties 
   pageTitle="Параметры разрешения DNS-имен для виртуальных машин Linux в Azure"
   description="Сценарии разрешения имен для виртуальных машин Linux в Azure IaaS, включая предоставленные службы DNS, гибридные внешние DNS и использование собственного DNS-сервера."
   services="virtual-machines"
   documentationCenter="na"
   authors="RicksterCDN"
   manager="timlt"
   editor="tysonn" />
<tags 
   ms.service="virtual-machines"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/11/2016"
   ms.author="rclaus" />

# Параметры разрешения DNS-имен для виртуальных машин Linux в Azure

Azure по умолчанию предоставляет разрешение DNS-имен для всех виртуальных машин, размещенных в одной виртуальной сети. Вы можете реализовать собственный механизм разрешения DNS-имен, настроив собственные службы DNS на виртуальных машинах, размещенных Azure. Ниже приведены сценарии, которые помогут вам выбрать наиболее подходящий вариант для конкретной ситуации.

- [разрешение имен Azure;](#azure-provided-name-resolution)

- [разрешение имен с помощью собственного DNS-сервера.](#name-resolution-using-your-own-dns-server)

Тип разрешения имен зависит от способа взаимодействия виртуальных машин и экземпляров ролей друг с другом.

**В следующей таблице представлены сценарии и соответствующие решения для разрешения имен.**

| **Сценарий** | **Решение** | **Суффикс** |
|--------------|--------------|----------|
| Разрешение имен между экземплярами ролей или виртуальными машинами, расположенными в одной виртуальной сети | [разрешение имен Azure;](#azure-provided-name-resolution)| имя узла или полное доменное имя |
| Разрешение имен между экземплярами ролей или виртуальными машинами, расположенными в разных виртуальных сетях | Управляемые клиентами DNS-серверы, перенаправляющие запросы между виртуальными сетями для разрешения в Azure (DNS-прокси). См. раздел [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server)| только полное доменное имя |
| Разрешение имен локального компьютера и службы из экземпляров роли или виртуальных машин в Azure | Управляемые клиентами DNS-серверы (например: локальный контроллер домена, локальный контроллер домена только для чтения или сервер DNS, вторично синхронизированный с помощью передач зоны). См. раздел [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server).|только полное доменное имя |
| Разрешение имен узлов Azure с локальных компьютеров | Перенаправление запросов на управляемый клиентом DNS прокси-сервер в соответствующей сети, прокси-сервер перенаправляет запросы в Azure для разрешения. См. раздел [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server).| только полное доменное имя |
| Обратный поиск DNS для внутренних IP-адресов | [разрешение имен с помощью собственного DNS-сервера.](#name-resolution-using-your-own-dns-server) | Недоступно |

## разрешение имен Azure;

Вместе с разрешением общедоступных DNS-имен Azure предоставляет разрешение внутренних имен для виртуальных машин и экземпляров ролей, которые находятся в той же виртуальной сети. В виртуальных сетях на основе ARM DNS-суффикс является одинаковым для всей виртуальной сети (поэтому полное доменное имя не требуется). DNS-имена можно назначать как сетевым картам, так и виртуальным машинам. Несмотря на то что разрешение имен Azure не требует настройки, это не самый лучший выбор для всех сценариев развертывания, как показано в приведенной выше таблице.

### Функции и рекомендации

**Функции**

- Простота использования: для использования разрешения имен, предоставляемого Azure, дополнительные настройки не нужны.

- Служба разрешения имен Azure отличается высокой доступностью, что устраняет необходимость создавать кластеры DNS-серверов и управлять ими.

- Может использоваться в сочетании с DNS-серверами для разрешения имен узлов в локальной среде и Azure.

- Разрешение имен предоставляется между виртуальными машинами в виртуальных сетях без необходимости указывать полное доменное имя.

- Вместо использования автоматически создаваемых имен узлов вы можете создавать имена, которые наиболее точно описывают ваши развертывания.

**Рекомендации**

- Созданный Azure DNS-суффикс нельзя изменить.

- Собственные записи нельзя регистрировать вручную.

- WINS и NetBIOS не поддерживаются.

- Имена узлов должны быть DNS-совместимыми (они могут содержать только символы 0–9, a–z и «-» и не могут начинаться или заканчиваться на «-». См. раздел 2 RFC 3696.)

- Трафик запросов DNS регулируется для каждой виртуальной машины. Это не должно влиять на большинство приложений. Если наблюдается регулирование запросов, проверьте, включено ли кэширование на стороне клиента. Дополнительные сведения см. в разделе [Наиболее эффективное использование разрешения имен Azure](#Getting-the-most-from-Azure-provided-name-resolution).


### Наиболее эффективное использование разрешения имен Azure
**Кэширование на стороне клиента**

Не каждый запрос DNS должен отправляться по сети. Кэширование на стороне клиента помогает уменьшить задержку и повысить устойчивость к нестабильной работе сети, разрешая повторяющиеся запросы DNS из локального кэша. Записи DNS содержат сведения о сроке жизни (TTL). Это позволяет кэшу хранить записи максимально долго, не влияя на их актуальность. Следовательно, кэширование на стороне клиента подходит для большинства ситуаций.

В некоторых дистрибутивах Linux возможность кэширования не включена по умолчанию. Поэтому рекомендуется включать ее на каждой виртуальной машине под управлением Linux (после проверки на отсутствие локального кэша).

Существует несколько разных доступных пакетов кэширования DNS, включая dnsmasq. Ниже описаны шаги по установке пакета dnsmasq на наиболее распространенные версии ОС.

- **Ubuntu (используется пакет resolvconf)**:
	- просто установите пакет dnsmasq (sudo apt-get install dnsmasq).
- **SUSE (используется пакет netconf)**:
	- установите пакет dnsmasq (sudo zypper install dnsmasq); 
	- активируйте службу dnsmasq (systemctl enable dnsmasq.service); 
	- запустите службу dnsmasq (systemctl start dnsmasq.service); 
	- измените путь /etc/sysconfig/network/config и замените блок NETCONFIG\_DNS\_FORWARDER="" текстом dnsmasq;
	- укажите в файле resolv.conf (netconfig update) кэш в качестве локального сопоставителя DNS.
- **OpenLogic (используется пакет NetworkManager)**:
	- установите пакет dnsmasq (sudo yum install dnsmasq);
	- активируйте службу dnsmasq (systemctl enable dnsmasq.service);
	- запустите службу dnsmasq (systemctl start dnsmasq.service);
	- добавьте строку prepend domain-name-servers 127.0.0.1; в файл /etc/dhclient-eth0.conf;
	- перезапустите сетевую службу (service network restart), чтобы указать кэш в качестве локального сопоставителя DNS.

> [AZURE.NOTE]\: пакет dnsmasq — один из многих доступных пакетов кэша DNS для ОС Linux. Перед его использованием проверьте, соответствует ли он вашим потребностям, а также не установлен ли у вас другой кэш.

**Повторные попытки на стороне клиента**

DNS использует преимущественно протокол UDP. Поскольку протокол UDP не гарантирует доставку сообщений, логика повторных попыток обрабатывается в самом протоколе DNS. Каждый DNS-клиент (ОС) может реализовывать разную логику повторных попыток в зависимости от предпочтений создателей.

 - ОС Windows выполняет повторную попытку через 1 с, затем через 2 и 4 с, а затем снова через 4 с. 
 - Повторные попытки в ОС Linux по умолчанию выполняются через 5 с. Рекомендуется изменить этот параметр, чтобы повторные попытки выполнялись 5 раз с интервалом в 1 с.  

Чтобы проверить текущие параметры на виртуальной машине под управлением ОС Linux, введите команду cat /etc/resolv.conf и просмотрите строку options:

	options timeout:1 attempts:5

Файл resolv.conf обычно создается автоматически; его не следует изменять. Шаги по добавлению строки options отличаются в разных дистрибутивах.

- **Ubuntu** (используется пакет resolvconf):
	- добавьте строку options в /etc/resolveconf/resolv.conf.d/head; 
	- выполните resolvconf -u для обновления.
- **SUSE** (используется пакет netconf):
	- добавьте параметр timeout:1 attempts:5 в блок NETCONFIG\_DNS\_RESOLVER\_OPTIONS="" в /etc/sysconfig/network/config; 
	- выполните netconfig update для обновления.
- **OpenLogic** (используется пакет NetworkManager):
	- добавьте echo "options timeout:1 attempts:5" в /etc/NetworkManager/dispatcher.d/11-dhclient; 
	- выполните service network restart для обновления.

## Разрешение имен с помощью собственного DNS-сервера
Существует множество ситуаций, в которых ваши требования к разрешению имен могут выйти за рамки возможностей Azure, например, если необходимо разрешение DNS-имен между виртуальными сетями. Для этих случаев Azure предоставляет возможность использовать свои собственные DNS-серверы.

DNS-серверы в виртуальной сети могут перенаправлять запросы DNS рекурсивным разрешителям Azure для разрешения имен узлов в этой виртуальной сети. Например, DNS-сервер, запущенный в Azure, может отвечать на запросы своих файлов зоны DNS и перенаправлять все остальные запросы в Azure. Это позволяет виртуальным машинам видеть как ваши записи в файлах зоны, так и имена узлов, предоставленные Azure (с помощью сервера перенаправления). Доступ к рекурсивным разрешителям Azure предоставляется через виртуальный IP-адрес 168.63.129.16.

Перенаправление запросов DNS также позволяет выполнять разрешение DNS между виртуальными сетями и позволяет вашим локальным компьютерам выполнять разрешение имен узлов, предоставляемых Azure. Чтобы разрешить имя узла виртуальной машины, DNS-сервер виртуальной машины должен находиться в той же виртуальной сети и быть настроен на перенаправление запросов имен узла в Azure. Так как DNS-суффиксы в разных виртуальных сетях различаются, можно использовать правила условного перенаправления для отправки запросов DNS в правильную виртуальную сеть для разрешения. На следующем рисунке показаны две виртуальные сети и локальная сеть, выполняющая разрешение DNS между виртуальными сетями с помощью этого метода:

![Разрешение имен DNS между виртуальными сетями](./media/virtual-machines-linux-azure-dns/inter-vnet-dns.png)

При использовании разрешения имен Azure внутренний DNS-суффикс передается на каждую виртуальную машину с помощью DHCP. При использовании собственного решения для разрешения имен этот суффикс не передается на виртуальные машины, так как влияет на другие архитектуры DNS. Для ссылки на компьютеры по полному доменному имени или для настройки суффикса на виртуальных машинах можно определить суффикс с помощью PowerShell или API:

-  Для виртуальных сетей с управлением ресурсами Azure суффикс можно узнать с помощью ресурса [сетевой карты](https://msdn.microsoft.com/library/azure/mt163668.aspx). Можно также выполнить команду `azure network public-ip show <resource group> <pip name>`, чтобы отобразить сведения о вашем общедоступном IP-адресе, включая полное доменное имя сетевой карты.    


Если перенаправление запросов в Azure не соответствует вашим требованиям, необходимо предоставить собственное решение DNS. Ваше решение DNS должно:

-  Предоставлять корректное разрешение имен, например, с помощью [DDNS](../virtual-network/virtual-networks-name-resolution-ddns.md). Обратите внимание, что при использовании DDNS может потребоваться отключить очистку записей DNS, так как время аренды DHCP в Azure очень длинное и очистка может удалить записи DNS преждевременно. 
-  Предоставлять корректное рекурсивное разрешение для разрешения внешних доменных имен.
-  Быть доступным (по протоколам TCP и UDP на порту 53) для клиентов, которых оно обслуживает, и иметь доступ к Интернету.
-  Быть защищенным от доступа из Интернета для снижения угроз, исходящих от внешних агентов.

> [AZURE.NOTE] Если в качестве DNS-серверов используются виртуальные машины Azure, для оптимальной производительности следует отключить IPv6 и назначить [общедоступный IP-адрес уровня экземпляра](../virtual-network/virtual-networks-instance-level-public-ip.md) каждой виртуальной машине, выполняющей роль DNS-сервера.

<!---HONumber=AcomDC_0427_2016-->