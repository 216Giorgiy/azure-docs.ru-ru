<properties
   pageTitle="Общие сведения о расширении Desired State Configuration для Azure | Microsoft Azure"
   description="Эта статья содержит общие сведения о работе с расширением Desired State Configuration PowerShell с помощью обработчика расширений Microsoft Azure. В ней описаны обязательные требования, архитектура, командлеты и многое другое."
   services="virtual-machines-windows"
   documentationCenter=""
   authors="zjalexander"
   manager="timlt"
   editor=""
   tags="azure-service-management,azure-resource-manager"
   keywords=""/>

<tags
   ms.service="virtual-machines-windows"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="vm-windows"
   ms.workload="na"
   ms.date="04/18/2016"
   ms.author="zachal"/>

# Общие сведения об обработчике расширения Desired State Configuration в Azure #

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-both-include.md)]

Агент VM Azure и связанные расширения являются частью служб инфраструктуры Microsoft Azure. Расширения VM являются программными компонентами, которые расширяют функциональность виртуальных машин и упрощают различные операции управления виртуальными машинами. Например, с помощью расширения VMAccess можно сбросить пароль виртуальной машины, а с помощью расширения Custom Script — выполнить скрипт на виртуальной машине.

В этой статье описано расширение PowerShell Desired State Configuration (DSC) для виртуальных машин Azure, которое входит в пакет SDK для Azure PowerShell. С помощью новых командлетов вы можете передать и применить конфигурацию DSC PowerShell на виртуальной машине Azure, на которой включено расширение DSC PowerShell. Расширение DSC PowerShell вызовет DSC PowerShell, чтобы применить полученную конфигурацию DSC на виртуальной машине. Эта функция доступна также на портале предварительной версии.

## Предварительные требования ##
**Локальный компьютер**. Для взаимодействия с расширением виртуальной машины Azure нужен портал предварительной версии или пакет SDK для Azure PowerShell.

**Гостевой агент**. Виртуальная машина Azure, на которой будет применяться конфигурация DSC, должна работать под управлением ОС, которая поддерживает Windows Management Framework (WMF) 4.0 или 5.0. Полный список поддерживаемых версий ОС можно найти в журнале версий расширения DSC.

## Термины и основные понятия ##
Для изучения этого руководства нужно знать приведенные ниже понятия.

Конфигурация — документ конфигурации DSC.

Узел — целевой объект для конфигурации DSC. Слово "узел" в этом документе всегда означает виртуальную машину Azure.

Данные конфигурации — PSD1-файл, содержащий данные среды для конфигурации.

## Основные сведения об архитектуре ##

Расширение DSC Azure использует платформу агента Azure, чтобы доставлять и применять конфигурации DSC виртуальных машин Azure, а также сообщать об этих конфигурациях. Расширению DSC требуется ZIP-файл, содержащий по крайней мере документ конфигурации, а также набор параметров, которые передаются через пакет SDK для Azure PowerShell или пользовательский интерфейс портала.

Когда расширение вызывается в первый раз, оно запускает процесс установки. Этот процесс устанавливает определенную версию Windows Management Framework (WMF), как указано ниже.

1. Если виртуальная машина Azure работает под управлением Windows Server 2016, никакие действия не требуются, потому что в WS 2016 уже установлена последняя версия PowerShell.
2. Если указано свойство `wmfVersion`, устанавливается соответствующая версия WMF (за исключением случаев, когда эта версия несовместима с ОС виртуальной машины).
3. Если свойство `wmfVersion` не указано, устанавливается последняя применимая версия WMF.

Для установки WMF требуется перезагрузка. После перезагрузки расширение скачивает ZIP-файл, указанный в свойстве `modulesUrl`. Если это расположение находится в хранилище BLOB-объектов Azure, то для доступа к файлу в свойстве `sasToken` можно указать маркер SAS. После скачивания и распаковки ZIP-файла функция конфигурации, определенная в `configurationFunction`, запускается и создает MOF-файл. Затем расширение выполняет командлет `Start-DscConfiguration -force` в созданном MOF-файле. Расширение фиксирует выходные данные и записывает их в канал состояний Azure. С этого момента локальный диспетчер конфигураций DSC выполняет мониторинг и обрабатывает исправления в обычном режиме.

## Командлеты PowerShell ##

Командлеты PowerShell можно использовать с ARM или ASM, чтобы упаковывать, публиковать и отслеживать развертывания расширений DSC. Приведенные ниже командлеты являются модулями ASM, но для использования модели ARM часть "Azure" следует заменить на "AzureRM". Например, в `Publish-AzureVMDscConfiguration` используется ASM, а в `Publish-AzureRmVMDscConfiguration` — ARM.

Командлет `Publish-AzureVMDscConfiguration` принимает файл конфигурации, проверяет его на наличие зависимых ресурсов DSC и создает ZIP-файл, содержащий ресурсы конфигурации и ресурсы DSC, необходимые для применения конфигурации. Этот командлет может создать пакет локально с помощью параметра `-ConfigurationArchivePath` или опубликовать ZIP-файл в хранилище BLOB-объектов Azure и защитить его маркером SAS.

На корневом уровне папки архива у ZIP-файла, созданного этим командлетом, есть скрипт конфигурации в формате PS1. Предназначенная для ресурсов папка модуля находится в папке архива.

Командлет `Set-AzureVMDscExtension` внедряет параметры, необходимые расширению DSC PowerShell, в объект конфигурации виртуальной машины, который затем можно применить к виртуальной машине Azure с помощью командлета `Update-AzureVm`.

Командлет `Get-AzureVMDscExtension` извлекает состояние расширения DSC определенной виртуальной машины.

Командлет `Get-AzureVMDscExtensionStatus` получает состояние конфигурации DSC, которое применил обработчик расширений DSC, от виртуальной машины или группы виртуальных машин.

Командлет `Remove-AzureVMDscExtension` удаляет обработчик расширений из определенной виртуальной машины. Это **не** приводит к удалению конфигурации, удалению WMF или изменению примененных параметров на виртуальной машине. Удаляется только обработчик расширений.

**Основные отличия между командлетами ASM и ARM**

- Командлеты ARM являются синхронными, а командлеты ASM — асинхронными.
- ResourceGroupName, VMName, ArchiveStorageAccountName, Version, Location — это новые обязательные параметры.
- ArchiveResourceGroupName — новый необязательный параметр для ARM. Его имеет смысл задать, если ваша учетная запись хранения не принадлежит к той группе ресурсов, в которой создана виртуальная машина.
- ConfigurationArchive — это ArchiveBlobName в ARM.
- ContainerName — это ArchiveContainerName в ARM.
- StorageEndpointSuffix — это ArchiveStorageEndpointSuffix в ARM.
- В ARM добавлен параметр –AutoUpdate, который позволяет автоматически обновлять обработчик расширений до последней версии сразу, когда она становится доступной. Обратите внимание, что вследствие этого после выпуска новой версии WMF возможна перезагрузка виртуальной машины. 


## Функциональные возможности портала предварительной версии ##
Перейдите к виртуальной машине. В разделе "Параметры" -> "Управление" щелкните "Расширения". Будет создана новая панель. Щелкните "Добавить" и выберите DSC PowerShell.

Потребуется ввести данные на портале. **Модули или скрипт конфигурации** — обязательное поле. Здесь следует указать PS1-файл, содержащий скрипт конфигурации, или ZIP-файл со скриптом конфигурации в формате PS1 в корне и всеми зависимыми ресурсами в папках модулей. Его можно создать с помощью командлета `Publish-AzureVMDscConfiguration -ConfigurationArchivePath`, входящего в пакет SDK для Azure PowerShell. Этот ZIP-файл передается в хранилище BLOB-объектов пользователя, защищенное маркером SAS.

**Файл данных конфигурации в формате PSD1** — необязательное поле. Если для вашей конфигурации требуется файл данных конфигурации в формате PSD1, выберите его с помощью этого поля и передайте в хранилище BLOB-объектов, где он будет защищен маркером SAS.
 
**Имя модуля конфигурации**. PS1-файлы могут включать несколько функций конфигурации. Введите имя скрипта конфигурации (в формате PS1), символ '', а затем имя функции конфигурации.

**Аргументы конфигурации**. Если функция конфигурации принимает аргументы, введите их здесь в формате `argumentName1=value1,argumentName2=value2`. Обратите внимание, что этот формат отличается от того, в котором аргументы конфигурации принимаются через командлеты PowerShell или шаблоны ARM.

## Приступая к работе ##

Расширение DSC Azure получает документы конфигурации DSC и применяет их на виртуальных машинах Azure. Ниже приведен простой пример конфигурации. Сохраните его локально как файл IisInstall.ps1.

```powershell
configuration IISInstall 
{ 
    node ("localhost") 
    { 
        WindowsFeature IIS 
        { 
            Ensure = "Present" 
            Name = "Web-Server"                       
        } 
    } 
}
```

Ниже показано, как разместить скрипт IisInstall.ps1 на указанной виртуальной машине, выполнить конфигурацию и сообщить о статусе.
 
```powershell
#Requires Azure Powershell cmdlets
Import-Module Azure

#Use an existing Azure Virtual Machine, 'DscDemo1'
$demoVM = get-AzureVM DscDemo1

#Publish the configuration script into user storage.
Publish-AzureVMDscConfiguration -ConfigurationPath ".\IisInstall.ps1" -StorageContext $storageContext -Verbose -Force

#Set the VM to run the DSC configuration
Set-AzureVMDscExtension -vm $demoVM -ConfigurationArchive "demo.ps1.zip" -StorageContext $storageContext -ConfigurationName "runScript" -verbose

#Azure Powershell batches commands until an update-AzureVM command is given
$demoVM | Update-AzureVM -Verbose

#check on status
get-azurevmdscextensionstatus -VM $demovm -verbose
```

## Ведение журналов ##

Журналы размещаются в следующем каталоге:

C:\\WindowsAzure\\Logs\\Plugins\\Microsoft.Powershell.DSC[номер\_версии]

## Дальнейшие действия ##

Для получения дополнительных сведений о DSC PowerShell [посетите центр документации PowerShell](https://msdn.microsoft.com/powershell/dsc/overview).

Чтобы получить дополнительные функциональные возможности, которыми можно управлять с помощью DSC PowerShell, [найдите в коллекции PowerShell](https://www.powershellgallery.com/packages?q=DscResource&x=0&y=0) дополнительные ресурсы DSC.

Сведения о передаче конфиденциальных параметров в конфигурации см. в статье [Passing credentials to the Azure DSC extension handler](virtual-machines-windows-extensions-dsc-credentials.md) (Передача учетных данных в обработчик расширений DSC Azure).

<!---HONumber=AcomDC_0420_2016-->