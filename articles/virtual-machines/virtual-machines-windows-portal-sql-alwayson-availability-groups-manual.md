---
title: Ручная настройка группы доступности AlwaysOn на виртуальной машине Azure — Microsoft Azure
description: Создание группы доступности AlwaysOn на виртуальных машинах Azure. В этом учебнике в основном используется пользовательский интерфейс и инструменты, а не сценарии.
services: virtual-machines
documentationcenter: na
author: MikeRayMSFT
manager: timlt
editor: monicar
tags: azure-service-management

ms.service: virtual-machines
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: infrastructure-services
ms.date: 09/22/2016
ms.author: MikeRayMSFT

---
# <a name="configure-always-on-availability-group-in-azure-vm-manually---resource-manager"></a>Ручная настройка группы доступности AlwaysOn на виртуальной машине Azure в модели Resource Manager
> [!div class="op_single_selector"]
> * [Шаблон Resource Manager](virtual-machines-windows-portal-sql-alwayson-availability-groups.md)
> * [Resource Manager: вручную](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md)
> * [Классическая модель: пользовательский интерфейс](virtual-machines-windows-classic-portal-sql-alwayson-availability-groups.md)
> * [Классическая модель: PowerShell](virtual-machines-windows-classic-ps-sql-alwayson-availability-groups.md)
> 
> 

<br/>

В этом полном учебнике показано, как реализовать группы доступности SQL Server для виртуальных машин Azure Resource Manager. 

В этом руководстве описывается создание:

* виртуальной сети, содержащей две подсети, включая внешнюю и внутреннюю подсети;
* двух контроллеров домена в группе доступности с доменом Active Directory (AD); 
* двух виртуальных машин SQL Server в группе доступности, развернутых во внутреннюю подсеть и присоединенных к домену AD;
* кластера WSFC из трех узлов с моделью кворума "Большинство узлов";
* внутреннего балансировщика нагрузки для предоставления IP-адреса группам доступности;
* группы доступности с двумя репликами с синхронной фиксацией базы данных доступности.

На следующем рисунке показано графическое представление решения.

![Архитектура для групп доступности в Azure Resource Manager](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/00-EndstateSampleNoELB.png)

Это одна из возможных конфигураций. При необходимости ее можно изменить. Например, вы можете сократить число виртуальных машин, используя контроллер домена как файловый ресурс-свидетель кворума. Это можно сделать для группы доступности с двумя репликами. Этот метод сокращает число виртуальных машин на одну по сравнению с исходной конфигурацией.

На изучение этого руководства уйдет пару часов, так как вам потребуется создать и настроить несколько виртуальных машин Azure. Это решение можно также создать автоматически. На портале Azure для групп доступности AlwaysOn с прослушивателем можно настроить шаблон из коллекции. При этом все необходимые параметры для групп доступности будут настроены автоматически. Дополнительные сведения см. в разделе [Портал — Resource Manager](virtual-machines-windows-portal-sql-alwayson-availability-groups.md). 

[!INCLUDE [availability-group-template](../../includes/virtual-machines-windows-portal-sql-alwayson-ag-template.md)]

В этом учебнике предполагается следующее:

* У вас уже есть учетная запись Azure.
* Вы уже умеете подготавливать виртуальную машину SQL Server из коллекции виртуальных машин через графический интерфейс пользователя. Дополнительные сведения см. в разделе [Подготовка виртуальной машины SQL Server в Azure](virtual-machines-windows-portal-sql-server-provision.md).
* Теперь вы хорошо понимаете принцип работы групп доступности. Дополнительные сведения см. в разделе [Группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx).

> [!NOTE]
> Если вы планируете использовать группы доступности с SharePoint, ознакомьтесь со статьей [Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://technet.microsoft.com/library/jj715261.aspx).
> 
> 

## <a name="create-resource-group"></a>Создать группу ресурсов
1. Войдите на [портал Azure](http://portal.azure.com). 
2. Нажмите **+ Создать**, а затем в окне поиска **Marketplace** введите **Группа ресурсов**.
   
   ![Группа ресурсов](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/01-resourcegroupsymbol.png)
3. Щелкните **Группа ресурсов** 
   
   ![Создание группы ресурсов](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/01-newresourcegroup.png)
4. Щелкните **Создать**. 
5. В колонке **Группа ресурсов** в поле **Имя группы ресурсов** введите **SQL-HA-RG**.
6. При наличии нескольких подписок Azure выберите ту, в которой необходимо создать группу доступности. 
7. Выберите расположение. Расположение — это регион Azure, где необходимо создать группу доступности. В этом руководстве все ресурсы будут созданы в одном расположении в среде Azure. 
8. Убедитесь, что флажок **Закрепить на панели мониторинга** установлен. Этот необязательный параметр позволяет разместить ярлык для группы ресурсов на панели мониторинга портала Azure. 
9. Щелкните **Создать** , чтобы создать группу ресурсов.

В среде Azure будет создана группа ресурсов, а ее ярлык закреплен на портале.

## <a name="create-network-and-subnets"></a>Создание сети и подсетей
Следующий шаг — создание сетей и подсетей в группе ресурсов Azure.

В решении используется виртуальная сеть с двумя подсетями. Дополнительные сведения о сетях в Azure см. в разделе [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md).

Создание виртуальной сети

1. На портале Azure щелкните новую группу ресурсов и нажмите кнопку **+** , чтобы добавить новый элемент в группу ресурсов. В Azure откроется колонка **Все** . 
   
   ![Новый элемент](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/02-newiteminrg.png)
2. Введите в поле поиска **виртуальная сеть**.
   
   ![Поиск виртуальной сети](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/04-findvirtualnetwork.png)
3. Щелкните **Виртуальная сеть**.
4. В колонке **Виртуальная сеть** выберите модель развертывания **Resource Manager** и нажмите кнопку **Создать**.
   
   ![Создание виртуальной сети](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/05-createvirtualnetwork.png)
5. В колонке **Создание виртуальной сети** настройте виртуальную сеть. 
   
   В таблице ниже приведены параметры виртуальной сети. 
   
   | **Поле** | Значение |
   | --- | --- |
   | **Имя** |autoHAVNET |
   | **Пространство адресов** |10.0.0.0/16 |
   | **Имя подсети** |Subnet-1 |
   | **Диапазон адресов подсети** |10.0.0.0/24 |
   | **Подписка** |Укажите подписку, которую нужно использовать. Если есть только одна подписка, то этот параметр может быть пустым. |
   | **Расположение** |Укажите расположение Azure. |
   
   Адресное пространство и диапазон адресов подсети могут отличаться от указанных в таблице. В зависимости от подписки Azure укажет доступное адресное пространство и соответствующий диапазон адресов подсети. Если достаточное пространство адресов недоступно, используйте другую подписку. 
6. Нажмите кнопку **Создать**
   
   ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/06-configurevirtualnetwork.png)

Вы вернетесь к панели мониторинга портала Azure и получите уведомление о создании сети.

### <a name="create-the-second-subnet"></a>Создание второй подсети
На этом этапе виртуальная сеть содержит одну подсеть с именем Subnet-1. Ее используют контроллеры домена. Серверы SQL Server используют вторую подсеть с именем **Subnet-2**. Чтобы настроить Subnet-2, сделайте следующее:

1. На панели мониторинга щелкните созданную группу ресурсов **SQL-HA-RG**. Найдите сеть в группе ресурсов в разделе **Ресурсы**.
   
   Если группа ресурсов **SQL-HA-RG** не отображается, ее можно найти, выбрав **Группы ресурсов** и установив фильтрацию по имени группы ресурсов.
2. Щелкните **autoHAVNET** в списке ресурсов. В Azure откроется колонка конфигурации сети.
3. На панели виртуальной сети **autoHAVNET** щелкните **Все параметры*.
4. В колонке **Параметры** выберите **Подсети**.
   
   Обратите внимание на созданную подсеть. 
   
   ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/07-addsubnet.png)
5. Создайте вторую подсеть. Щелкните **+ Subnet**(+Подсеть). 
   
   В колонке **Добавление подсети** настройте подсеть, указав в поле **Имя** значение **subnet-2**. Azure автоматически укажет допустимое значение в поле **Диапазон адресов**. Убедитесь, что этот диапазон адресов содержит по крайней мере 10 адресов. Для рабочей среды может потребоваться больше адресов. 
6. Нажмите кнопку **ОК**.

![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/08-configuresubnet.png)

Ниже приведена сводка параметров конфигурации для виртуальной сети и обеих подсетей.

| **Поле** | Значение |
| --- | --- |
| **Имя** |**autoHAVNET** |
| **Пространство адресов** |Зависит от доступных адресных пространств в подписке. Стандартное значение — 10.0.0.0/16. |
| **Имя подсети** |**Subnet-1** |
| **Диапазон адресов подсети** |Зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.0.0/24. |
| **Имя подсети** |**Subnet-2** |
| **Диапазон адресов подсети** |Зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.1.0/24. |
| **Подписка** |Укажите подписку, которую нужно использовать. |
| **Группа ресурсов** |**SQL-HA-RG** |
| **Расположение** |Укажите расположение, выбранное для группы ресурсов. |

## <a name="create-availability-sets"></a>Создание групп доступности
Прежде чем создавать виртуальные машины, необходимо создать группы доступности. Такие группы позволяют сократить простой при плановых и внеплановых мероприятиях обслуживания. Группа доступности Azure представляет собой логическую группу ресурсов, которую Azure помещает в физические домены сбоя и домены обновления. Домен сбоя обеспечивает разделение ресурсов питания и сетевых ресурсов для элементов группы доступности. Домен обновления гарантирует, что элементы группы доступности не отключаются для обслуживания одновременно. Узнайте об [управлении доступностью виртуальных машин](virtual-machines-windows-manage-availability.md).

Вам потребуется две группы доступности: одна для контроллеров домена, а вторая для серверов SQL Server.

Чтобы создать группу доступности, перейдите в колонку группы ресурсов и щелкните **Добавить**. Отфильтруйте результаты по запросу **Группа доступности**. В результатах выберите **Группа доступности** . Щелкните **Создать**.

Настройте две группы доступности согласно параметрам в таблице ниже.

| **Поле** | Группа доступности контроллера домена | Группа доступности SQL Server |
| --- | --- | --- |
| **Имя** |adavailabilitySet |sqlAvailabilitySet |
| **Группа ресурсов** |SQL-HA-RG |SQL-HA-RG |
| **Домены сбоя** |3 |3 |
| **Домены обновления** |5 |3 |

Создав группы доступности, вернитесь в колонку группы ресурсов на портале Azure.

## <a name="create-domain-controllers"></a>Создание контроллеров домена
Вы уже создали сеть, подсети, группы доступности и балансировщик нагрузки с выходом в Интернет. Теперь можно создать виртуальные машины для контроллеров домена.

### <a name="create-the-virtual-machines-for-the-domain-controllers"></a>Создание виртуальных машин для контроллеров домена
Чтобы создать и настроить контроллеры домена, вернитесь к группе ресурсов **SQL-HA-RG** .

1. Нажмите Добавить. Откроется колонка **Все** .
2. Введите **Windows Server 2012 R2 Datacenter**. 
3. Щелкните **Центр обработки данных Windows Server 2012 R2**. Убедитесь, что в колонке **Windows Server 2012 R2 Datacenter** в качестве модели развертывания выбран параметр **Resource Manager**, и нажмите кнопку **Создать**. В Azure откроется колонка **Создание виртуальной машины** . 

Выполните приведенную выше процедуру дважды, чтобы создать две виртуальные машины. Присвойте этим виртуальным машинам следующие имена:

* ad-primary-dc
* ad-secondary-dc.
  
  > [!NOTE]
  > **ad-secondary-dc** — дополнительный компонент для обеспечения высокой доступности доменных служб Active Directory. 
  > 
  > 

В таблице ниже приведены параметры для этих двух компьютеров.

| **Поле** | Значение |
| --- | --- |
| **Имя пользователя** |DomainAdmin |
| **Пароль** |Contoso!0000 |
| **Подписка** |*ваша подписка* |
| **Группа ресурсов** |SQL-HA-RG |
| **Расположение** |*ваше расположение* |
| **Размер** |D1_V2 (стандартный) |
| **Тип хранилища** |standard |
| **Учетная запись хранения** |*Создается автоматически* |
| **Виртуальная сеть** |autoHAVNET |
| **Подсеть** |Subnet-1 |
| **Общедоступный IP-адрес** |*Совпадает с именем виртуальной машины* |
| **Группа безопасности сети** |*Совпадает с именем виртуальной машины* |
| **Диагностика** |Включено |
| **Учетная запись хранения для диагностики** |*Создается автоматически* |
| **группа доступности;** |adavailabilitySet |

> [!NOTE]
> После создания группу доступности невозможно изменить на виртуальной машине.
> 
> 

Azure создаст виртуальные машины.

После создания виртуальных машин следует настроить контроллер домена.

### <a name="configure-the-domain-controller"></a>Настройка контроллера домена
На следующих этапах необходимо настроить машину **ad-primary-dc** в качестве контроллера домена для corp.contoso.com.

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **ad-primary-dc**. В колонке **ad-primary-dc** нажмите **Подключиться**, чтобы открыть RDP-файл для подключения к удаленному рабочему столу.
   
    ![Подключение к виртуальной машине](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/20-connectrdp.png)
2. Войдите в систему, используя настроенную учетную запись (**\DomainAdmin**) и пароль (**Contoso!0000**) администратора.
3. По умолчанию отображается панель мониторинга **Диспетчер серверов** .
4. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.
   
    ![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784623.png)
5. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
6. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
   
   > [!NOTE]
   > Windows предупреждает о том, что статического IP-адреса не существует. Если вы тестируете конфигурацию, нажмите кнопку "Продолжить". Для рабочих сценариев на портале Azure установите статический IP-адрес или [используйте PowerShell для установки статического IP-адреса компьютера контроллера домена](../virtual-network/virtual-networks-reserved-private-ip.md).
   > 
   > 
   
    ![Диалоговое окно добавления ролей](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784624.png)
7. Нажимайте **Далее**, пока не откроется раздел **Подтверждение**. Выберите флажок **Перезапустить целевой сервер, если требуется** .
8. Щелкните **Install**(Установить).
9. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
10. Выберите новый вариант **AD DS** на левой панели.
11. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.
    
     ![Диалоговое окно службы каталогов Active Directory на виртуальной машине DNS-сервера](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784625.png)
12. В столбце **Действие** диалогового окна **Сведения обо всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.
13. В **мастере настройки доменных служб Active Directory**используйте следующие значения:

| **Страница** | Настройка |
| --- | --- |
| **Конфигурация развертывания** |**Добавить новый лес** = выбрано<br/>**Имя корневого домена** = corp.contoso.com |
| **Параметры контроллера домена** |**Пароль DSRM** = Contoso!0000<br/>**Подтверждение пароля** = Contoso!0000 |

1. Нажимайте кнопку **Далее** , чтобы пройти остальные страницы мастера. Убедитесь, что на странице **Проверка готовности** отображается следующее сообщение: **Все проверки готовности успешно завершены**. Обратите внимание, что вам следует просмотреть все применимые предупреждения, но это не обязательно для продолжения установки.
2. Щелкните **Install**(Установить). Виртуальная машина **ad-primary-dc** перезагружается автоматически.

### <a name="configure-the-second-domain-controller"></a>Настройка второго контроллера домена
После перезагрузки основного контроллера домена можно настроить второй контроллер домена. Этот необязательный шаг выполняется для обеспечения высокой доступности. Для выполнения этого шага необходимо знать частный IP-адрес контроллера домена. Его можно получить на портале Azure. Чтобы настроить второй контроллер домена, сделайте следующее:

1. Войдите в виртуальную машину **ad-primary-dc** . 
2. Откройте удаленный рабочий стол и подключитесь к дополнительному контроллеру домена по IP-адресу. Если вы не знаете IP-адрес дополнительного контроллера домена, перейдите на портал Azure и проверьте адрес, назначенный сетевому интерфейсу для дополнительного контроллера домена. 
3. Измените предпочтительный адрес DNS-сервера на адрес контроллера домена. 
4. Запустите RDP-файл для основного контроллера домена (**ad-primary-dc**) и войдите на виртуальную машину с использованием настроенной учетной записи администратора (**BUILTIN\DomainAdmin**) и пароля (**Contoso!0000**).
5. На основном контроллере домена запустите удаленный рабочий стол для **ad-secondary-dc** , используя его IP-адрес. Используйте ту же учетную запись и пароль.
6. После входа вы должны увидеть панель мониторинга **Диспетчер серверов** . Щелкните **Локальный сервер** на левой панели.
7. Выберите ссылку **IPv4-адрес назначен DHCP, поддержка IPv6** .
8. В окне **Сетевые подключения** выберите значок сети.
   
    ![Изменение предпочитаемого DNS-сервера для виртуальной машины](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784629.png)
9. На панели команд нажмите **Изменить параметры этого подключения** (в зависимости от размера окна вам может потребоваться щелкнуть двойную стрелку вправо, чтобы увидеть эту команду).
10. Выберите пункт **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку "Свойства".
11. Установите переключатель "Использовать следующие адреса DNS-серверов" и укажите адрес основного контроллера домена в поле **Предпочитаемый DNS-сервер**.
12. В качестве адреса необходимо указать адрес, назначенный виртуальной машине **ad-primary-dc**в подсети subnet-1 в виртуальной сети Azure. Для проверки IP-адреса **ad-primary-dc** используйте команду **nslookup ad-primary-dc** в командной строке, как показано ниже.
    
     ![Поиск IP-адреса для контроллера домена с помощью NSLOОКUP](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC664954.png)
    
    > [!NOTE]
    > После установки DNS-сервера можно закрыть сеанс RDP с рядовым сервером. Для этого перезагрузите виртуальную машину на портале Azure.
    > 
    > 
13. Нажмите кнопку **ОК**, а затем — **Закрыть**, чтобы сохранить изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.
14. Повторите те же действия, что и при создании первого контроллера домена. Только в **мастере настройки доменных служб Active Directory** используйте следующие значения.

| Страница | Настройка |
| --- | --- |
| **Конфигурация развертывания** |**Добавить контроллер домена в существующий домен** = выбрано<br/>**Корневая папка** = corp.contoso.com |
| **Параметры контроллера домена** |**Пароль DSRM** = Contoso!0000<br/>**Подтверждение пароля** = Contoso!0000 |

### <a name="configure-domain-accounts"></a>Настройка учетных записей домена
На следующих этапах настраиваются учетные записи Active Directory (AD) для дальнейшего использования.

1. Войдите в виртуальную машину **ad-primary-dc** снова.
2. На панели **Диспетчер серверов** выберите **Средства**, а затем нажмите **Центр администрирования Active Directory**.
   
    ![Центр администрирования Active Directory](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784626.png)
3. В колонке **Центр администрирования Active Directory** select **corp (локальный)** на левой панели.
4. На правой панели **Задачи** выберите **Создать** и нажмите **Пользователь**. Используйте следующие параметры:

| Настройка | Значение |
| --- | --- |
| **Имя** |Install |
| **User SamAccountName** |Install |
| **Пароль** |Contoso!0000 |
| **Подтверждение пароля.** |Contoso!0000 |
| **Другие параметры пароля** |Выбрано |
| **Срок действия пароля не ограничен** |Флажок установлен |

1. Нажмите кнопку **ОК**, чтобы создать пользователя **Install**. Эта учетная запись используется для настройки отказоустойчивого кластера и группы доступности.
2. Создайте двух дополнительных пользователей тем же способом: **CORP\SQLSvc1** и **CORP\SQLSvc2**. Эти учетные записи используются в службах SQL Server. Затем предоставьте пользователю **CORP\Install** необходимые разрешения для настройки отказоустойчивой кластеризации служб Windows (WSFC).
3. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели. Затем на правой панели **Задачи** нажмите кнопку **Свойства**.
   
    ![Свойства пользователя CORP](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784627.png)
4. Выберите **Расширения**, затем нажмите кнопку **Дополнительно** на вкладке **Безопасность**.
5. В диалоговом окне **Дополнительные параметры безопасности для предприятия** . Щелкните **Добавить**.
6. Щелкните **Выбрать субъект**. Затем найдите **CORP\Install**. Нажмите кнопку **ОК**.
7. Выберите разрешения **Чтение всех свойств** и **Создание объектов-компьютеров**.
   
    ![Разрешения пользователя Corp](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784628.png)
8. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Закройте окно свойств предприятия.

После завершения настройки Active Directory и объектов пользователей нужно создать две виртуальные машины SQL Server и виртуальную машину следящего сервера. Затем присоедините их к этому домену.

## <a name="create-sql-servers"></a>Создание серверов SQL
### <a name="create-and-configure-the-sql-server-vms"></a>Создание и настройка виртуальных машин SQL Server
Далее создайте три виртуальные машины, включая две виртуальные машины SQL Server, и узел кластера WSFC. Чтобы создать виртуальные машины, вернитесь к группе ресурсов **SQL-HA-RG**, нажмите кнопку **Добавить**, найдите соответствующий элемент коллекции, выберите **Виртуальная машина**, а затем — **Из коллекции**. Затем используйте шаблоны из следующей таблицы, чтобы упростить создание виртуальных машин.

| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выбор соответствующего элемента коллекции |**Центр обработки данных Windows Server 2012 R2** |**SQL Server 2014 SP1 Enterprise на базе Windows Server 2012 R2** |**SQL Server 2014 SP1 Enterprise на базе Windows Server 2012 R2** |
| Конфигурация виртуальной машины **Базовый** |**Имя** = cluster-fsw<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-0<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-1<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |
| Конфигурация виртуальной машины **Размер** |DS1 (1 ядро, 3,5 ГБ памяти) |**РАЗМЕР** = DS 2 (2 ядра, 7 ГБ памяти) |**РАЗМЕР** = DS 2 (2 ядра, 7 ГБ памяти) |
| Конфигурация виртуальной машины **Параметры** |**Хранилище** = Premium (SSD)<br/>**ПОДСЕТИ** = autoHAVNET<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Подсеть** = subnet-2(10.1.1.0/24)<br/>**Общедоступный IP-адрес** = нет<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = sqlAvailabilitySet<br/> |**Хранилище** = Premium (SSD)<br/>**ПОДСЕТИ** = autoHAVNET<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Подсеть** = subnet-2(10.1.1.0/24)<br/>**Общедоступный IP-адрес** = нет<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = sqlAvailabilitySet<br/> |**Хранилище** = Premium (SSD)<br/>**ПОДСЕТИ** = autoHAVNET<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Подсеть** = subnet-2(10.1.1.0/24)<br/>**Общедоступный IP-адрес** = нет<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = sqlAvailabilitySet<br/> |
| Конфигурация виртуальной машины **Параметры SQL Server** |Не применяется |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |

<br/>

> [!NOTE]
> Предыдущая конфигурация предлагает виртуальные машины уровня СТАНДАРТНЫЙ, так как компьютеры уровня БАЗОВЫЙ не поддерживают конечные точки с балансировкой нагрузки, необходимые для прослушивателя группы доступности. Кроме того, предлагаемые здесь размеры компьютеров предназначены для тестирования групп доступности в виртуальных машинах Azure. Для обеспечения оптимальной производительности рабочих нагрузок см. рекомендации по размерам машин SQL Server и их настройке в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-performance.md).
> 
> 

После завершения подготовки трех виртуальных машин вам потребуется присоединить их к домену **corp.contoso.com** и предоставить пользователю CORP\Install права администратора виртуальных машин.

Чтобы продолжить, запишите виртуальный IP-адрес каждой виртуальной машины в Azure. Получите IP-адрес для каждого сервера. В группе ресурсов Azure SQL-HA-RG щелкните ресурс **autohaVNET** . В колонке **autohaVNET** отображаются IP-адреса для каждого компьютера в сети.

Запишите IP-адреса следующих устройств: 

| Роль виртуальной машины | Устройство | IP-адрес |
| --- | --- | --- |
| Основной контроллер домена |ad-primary-dc | |
| Дополнительный контроллер домена |ad-secondary-dc. | |
| Файловый ресурс-свидетель кластера |cluster-fsw | |
| SQL Server |sqlserver-0 | |
| SQL Server |sqlserver-1 | |

Эти адреса используются для настройки службы DNS для каждой виртуальной машины. Выполните следующие действия для каждой из трех виртуальных машин.

1. Для начала измените предпочитаемый адрес DNS-сервера для каждого рядового сервера. 
2. Запустите RDP-файл для основного контроллера домена (**ad-primary-dc**) и войдите на виртуальную машину с использованием настроенной учетной записи администратора (**BUILTIN\DomainAdmin**) и пароля (**Contoso!0000**).
3. На основном контроллере домена запустите удаленный рабочий стол для **sqlserver-0** , используя IP-адрес. Используйте ту же учетную запись и пароль.
4. После входа вы должны увидеть панель мониторинга **Диспетчер серверов** . Щелкните **Локальный сервер** на левой панели.
5. Выберите ссылку **IPv4-адрес назначен DHCP, поддержка IPv6** .
6. В окне **Сетевые подключения** выберите значок сети.
   
    ![Изменение предпочитаемого DNS-сервера для виртуальной машины](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784629.png)
7. На панели команд нажмите **Изменить параметры этого подключения** (в зависимости от размера окна вам может потребоваться щелкнуть двойную стрелку вправо, чтобы увидеть эту команду).
8. Выберите пункт **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку "Свойства".
9. Установите переключатель "Использовать следующие адреса DNS-серверов" и укажите адрес основного контроллера домена в поле **Предпочитаемый DNS-сервер**.
10. В качестве адреса необходимо указать адрес, назначенный виртуальной машине **ad-primary-dc**в подсети subnet-1 в виртуальной сети Azure. Для проверки IP-адреса **ad-primary-dc** используйте команду **nslookup ad-primary-dc** в командной строке, как показано ниже.
    
     ![Поиск IP-адреса для контроллера домена с помощью NSLOОКUP](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC664954.png)
    
    > [!NOTE]
    > После установки DNS-сервера можно закрыть сеанс RDP с рядовым сервером. Для этого перезагрузите виртуальную машину на портале Azure.
    > 
    > 
11. Нажмите кнопку **ОК**, а затем — **Закрыть**, чтобы сохранить изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.
12. В окне **Локальный сервер** щелкните ссылку **РАБОЧАЯ ГРУППА**.
13. В разделе **Имя компьютера** нажмите кнопку **Изменить**.
14. Установить флажок **Домен** и введите в текстовом поле **corp.contoso.com**. Нажмите кнопку **ОК**.
15. Во всплывающем диалоговом окне **Безопасность Windows** укажите имя (**CORP\DomainAdmin**) и пароль (**Contoso!0000**) учетной записи администратора домена по умолчанию.
16. При появлении сообщения "Добро пожаловать на домен corp.contoso.com" нажмите кнопку **ОК**.
17. Нажмите кнопку **Закрыть**, а затем **Перезагрузить сейчас** во всплывающем диалоговом окне.
18. Повторите эти шаги для сервера файлового ресурса-свидетеля и каждого экземпляра SQL Server. 

### <a name="add-the-corp\install-user-as-an-administrator-on-each-cluster-vm:"></a>Добавьте пользователя Corp\Install в качестве администратора на каждой виртуальной машине кластера:
1. Дождитесь перезапуска виртуальной машины, а затем запустите RDP-файл еще раз на основном контроллере домена, чтобы войти на **sqlserver-0**, используя учетную запись **BUILTIN\DomainAdmin**.
2. На панели **Диспетчер серверов** выберите **Инструменты**, а затем нажмите **Управление компьютерами**.
   
    ![Управление компьютерами](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784630.png)
3. В окне **Управление компьютерами** разверните пункт **Локальные пользователи и группы**, а затем выберите **Группы**.
4. Дважды щелкните группу **Администраторы** .
5. В диалоговом окне **Свойства администратора** нажмите кнопку **Добавить**.
6. Введите имя пользователя **CORP\Install**, а затем нажмите кнопку **ОК**. При появлении запроса учетных данных используйте учетную запись **DomainAdmin** и пароль **Contoso!0000**.
7. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Свойства администратора**.
8. Повторите описанные выше шаги для **sqlserver-1** и **cluster-fsw**.

## <a name="create-the-cluster"></a>Создание кластера
### <a name="add-the-**failover-clustering**-feature-to-each-cluster-vm."></a>Добавьте компонент **Отказоустойчивость кластеров** для каждой виртуальной машины кластера.
1. Подключитесь по протоколу RDP к **sqlserver-0**.
2. На панели мониторинга **Диспетчер серверов** нажмите **Добавить роли и компоненты**.
3. В **мастере добавления ролей и компонентов** нажимайте кнопку **Далее**, пока не откроется страница **Компоненты**.
4. Выберите **Отказоустойчивость кластеров**. При появлении запроса добавьте любые другие зависимые компоненты.
   
    ![Добавление компонента отказоустойчивой кластеризации к виртуальной машине](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784631.png)
5. Нажмите кнопку **Далее**, а затем **Установить** на странице **Подтверждение**.
6. После завершения установки компонента **Отказоустойчивая кластеризация** нажмите кнопку **Закрыть**.
7. Выйдите из виртуальной машины.
8. Повторите шаги в этом разделе для **sqlserver-1** и **cluster-fsw**.

Виртуальные машины SQL Server подготовлены и запущены, но они устанавливаются с SQL Server с использованием параметров по умолчанию.

### <a name="create-the-wsfc-cluster"></a>Создание кластера WSFC
В этом разделе вы создадите кластер WSFC для размещения группы доступности. К этому моменту для каждой из трех виртуальных машин в кластере WSFC вы должны были выполнить следующие действия:

* полная подготовка в Azure;
* присоединение к домену;
* добавление пользователя **CORP\Install** в локальную группу администраторов;
* добавление компонента "Отказоустойчивая кластеризация".

Все эти действия необходимо выполнить на каждой виртуальной машине перед тем, как присоединять ее к кластеру WSFC.

Кроме того, обратите внимание, что виртуальная сеть Azure функционирует иначе, чем локальная сеть. Создавать кластер необходимо в следующем порядке:

1. Создайте кластер с одним узлом на узле (**sqlserver-0**).
2. Измените IP-адрес кластера на неиспользуемый адрес в **sqlsubnet**.
3. Подключите имя кластера к сети.
4. Добавьте другие узлы (**sqlserver-1** и **cluster-fsw**).

Выполните следующие действия для настройки кластера.

1. Запустите RPD-файл для **sqlserver-0** и войдите под учетной записью домена **CORP\Install**.
2. На панели мониторинга **Диспетчер серверов** выберите **Инструменты**, а затем **Диспетчер отказоустойчивости кластеров**.
3. На левой панели щелкните правой кнопкой мыши элемент **Диспетчер отказоустойчивости кластеров** и выберите команду **Создать кластер**, как показано ниже.
   
    ![Создать кластер](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784632.png)
4. В мастере создания кластеров создайте кластер с одним узлом, поэтапно настроив параметры на всех страницах, как указано ниже:

| Страница | Параметры |
| --- | --- |
| Перед началом работы |По умолчанию |
| Выбор серверов |Введите **sqlserver-0** в поле **Введите имя сервера** и нажмите кнопку **Добавить**. |
| Предупреждение проверки |Выберите вариант **Нет. Для этого кластера не требуется поддержка корпорации Майкрософт, поэтому нет необходимости выполнять проверочные тесты. После нажатия кнопки "Далее" продолжить создание кластера**. |
| Точка доступа для администрирования кластера |Введите **Cluster1** в поле **Имя кластера** |
| Подтверждение |Используйте параметры по умолчанию, если вы не используете дисковые пространства. Ознакомьтесь с примечанием после этой таблицы. |

> [!NOTE]
> Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), в которых несколько дисков группируются в пулы носителей, снимите флажок **Добавление всех допустимых хранилищ в кластер** на странице **Подтверждение**. Если вы не сделаете этого, Windows отсоединит виртуальные диски в процессе кластеризации. Как следствие, они не отобразятся в диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.
> 
> 

После создания кластера проверьте конфигурацию и добавьте остальные узлы. 

1. На центральной панели найдите раздел **Ресурсы ядра кластера** и разверните элемент со сведениями **Имя: Cluster1**. Вы увидите ресурсы **Имя** и **IP-адрес** с состоянием **Ошибка**. Его невозможно подключить к сети, так как кластеру назначен тот же IP-адрес, что и самой виртуальной машине, то есть повторяющийся.
2. Щелкните правой кнопкой мыши ресурс **IP-адреса** в состоянии сбоя и выберите **Свойства**.
   
    ![Свойства кластера](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784633.png)
3. Выберите **Статический IP-адрес** и укажите доступный адрес из подсети subnet-2 в текстовом поле "Адрес". Затем нажмите кнопку **ОК**.
4. В разделе **Ресурсы ядра кластера** щелкните правой кнопкой мыши элемент **Имя: Cluster1** и нажмите кнопку **Подключить**. Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера подключится, он добавит на контроллер домена новую учетную запись компьютера Active Directory (AD). Эта учетная запись впоследствии будет использоваться для запуска кластерной службы группы доступности.
5. Наконец, добавьте оставшиеся узлы в кластер. В дереве обозревателя щелкните правой кнопкой мыши **Cluster1.corp.contoso.com**, а затем выберите **Добавить узел**, как показано ниже.
   
    ![Добавление узла в кластер](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC784634.png)
6. В **мастере добавления узлов** нажмите кнопку **Далее**. На странице **Выбор серверов** добавьте **sqlserver-1** и **cluster-fsw** в список, введя имя сервера в поле **Введите имя сервера** и нажав кнопку **Добавить**. Когда будете готовы, нажмите кнопку **Далее**.
7. На странице **Предупреждение проверки** нажмите кнопку **Нет** (в рабочем сценарии следует выполнить проверочные тесты). Затем щелкните **Далее**.
8. На странице **Подтверждение** нажмите кнопку **Далее**, чтобы добавить узлы.
   
   > [!WARNING]
   > Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, снимите флажок **Добавление всех допустимых хранилищ в кластер** . Если вы не сделаете этого, виртуальные диски будут отсоединены в процессе кластеризации. Как следствие, они не отобразятся к диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.
   > 
   > 
9. После добавления узлов в кластер нажмите кнопку **Готово**. Теперь диспетчер отказоустойчивости кластеров должен показывать три узла в кластере и отображать их в контейнере **Узлы** .
10. Выйдите из сеанса удаленного рабочего стола.

## <a name="configure-availability-groups"></a>Настройка групп доступности
В этом разделе вы выполните следующие действия на узлах **sqlserver-0** и **sqlserver-1**.

* Добавьте **CORP\Install** в качестве роли системного администратора экземпляра SQL Server по умолчанию.
* Откройте брандмауэр для удаленного доступа к SQL Server для процесса SQL Server, конечную точку зеркального отображения базы данных и порт пробы Azure Load Balancer. 
* Включение компонента групп доступности
* Измените учетную запись службы SQL Server на **CORP\SQLSvc1** и **CORP\SQLSvc2** соответственно.

Эти действия можно выполнять в любом порядке. Однако в следующем пошаговом руководстве они приведены в указанном порядке. Следуйте указаниям для **sqlserver-0** и **sqlserver-1**.

### <a name="add-installation-account-as-sysadmin-fixed-server-role-on-each-sql-server"></a>Добавление учетной записи для установки на каждый сервер SQL Server с использованием предопределенной роли системного администратора сервера
1. Если вы не вышли из сеанса удаленного рабочего стола для виртуальной машины, сделайте это.
2. Запустите RDP-файлы для **sqlserver-0** и **sqlserver-1** и войдите в систему в качестве пользователя **BUILTIN\DomainAdmin**.
3. Запустите **SQL Server Management Studio** и добавьте **CORP\Install** в экземпляр SQL Server по умолчанию в качестве роли **системного администратора**. В **обозревателе объектов** щелкните правой кнопкой мыши **Имена для входа**, а затем выберите пункт **Новое имя для входа**.
4. Введите **CORP\Install** в поле **Имя для входа**.
5. На странице **Роли сервера** выберите **системный администратор**. Затем нажмите кнопку **ОК**. После создания имени для входа вы можете увидеть его, развернув элемент **Имена для входа** in **диспетчере объектов**.

### <a name="open-the-firewall-for-remote-access-to-sql-server-and-the-probe-port-on-each-sql-server"></a>Открытие брандмауэра для удаленного доступа к SQL Server и порта пробы на каждом сервере SQL Server
Это решение требует двух правил брандмауэра на каждом сервере SQL Server. Первое правило обеспечивает входящий доступ к SQL Server, а второе — входящий доступ для балансировщика нагрузки и прослушивателя. 

1. Далее вам потребуется создать правило брандмауэра для SQL Server. На **начальном экране** запустите **Брандмауэр Windows в режиме повышенной безопасности**.
2. В левой панели выберите **Правила для входящих подключений**. На правой панели нажмите кнопку **Новое правило**.
3. На странице **Тип правила** выберите **Программа** и нажмите кнопку **Далее**.
4. На странице **Программа** выберите **Этот путь программы** и введите **%ProgramFiles%\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\Binn\sqlservr.exe** в текстовом поле (если вы следуете этим указаниям, но используете SQL Server 2012, каталог SQL Server — **MSSQL11.MSSQLSERVER**). Нажмите кнопку **Далее**.
5. На странице **Действие** оставьте флажок **Разрешить подключение** и нажмите кнопку **Далее**.
6. На странице **Профиль** примите параметры по умолчанию и нажмите кнопку **Далее**.
7. На странице **Имя** укажите имя правила, например **SQL Server (правило программы)**, в текстовом поле **Имя** и нажмите кнопку **Готово**.
8. Создайте дополнительное правило для входящего трафика брандмауэра для порта пробы. Для целей данного руководства это правило для входящего трафика TCP-порта 59999. Присвойте правилу имя **Прослушиватель SQL Server**.

Выполните все эти шаги для обоих серверов SQL Server.

### <a name="enable-availability-groups-feature-on-each-sql-server"></a>Включение компонента групп доступности на каждом сервере SQL Server
Выполните эти шаги для обоих серверов SQL Server. 

1. Затем включите компонент **групп доступности AlwaysOn** . На **начальном экране** запустите **Диспетчер конфигурации SQL Server**.
2. В дереве обозревателя выберите **Службы SQL Server**, затем щелкните правой кнопкой мыши службу **SQL Server (MSSQLSERVER)** и выберите пункт **Свойства**.
3. Выберите вкладку **Высокая доступность AlwaysOn**, затем выберите **Включить группы доступности AlwaysOn**, как показано ниже, и нажмите кнопку **Применить**. Нажмите кнопку **ОК** во всплывающем диалоговом окне и не закрывайте окно свойств. После изменения учетной записи службы вам потребуется перезапустить службу SQL Server.
   
    ![Включение групп доступности AlwaysOn](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665520.gif)

### <a name="set-the-sql-server-service-account-on-each-sql-server"></a>Настройка учетной записи службы SQL Server на каждом сервере SQL
Выполните эти шаги для обоих серверов SQL Server.

1. Далее вам потребуется изменить учетную запись службы SQL Server. Откройте вкладку **Вход** и введите **CORP\SQLSvc1** (для **sqlserver-0**) или **CORP\SQLSvc2** (для **sqlserver-1**) в поле **Имя учетной записи**, после чего введите и подтвердите пароль и нажмите кнопку **ОК**.
2. Во всплывающем окне нажмите кнопку **Да** , чтобы перезапустить службу SQL Server. После перезапуска службы SQL Server изменения, внесенные вами в окне свойств, вступят в силу.
3. Выйдите из виртуальных машин.

### <a name="create-the-availability-group"></a>Создание группы доступности
Теперь можно приступить к настройке группы доступности. Ниже приведено краткое описание того, что вам потребуется сделать:

* создать базу данных (**MyDB1**) на **sqlserver-0**;
* Создание полной резервной копии и резервной копии журнала транзакций базы данных.
* восстановить полную резервную копию и резервную копию журнала на **sqlserver-1** с параметром **NORECOVERY**;
* Создание группы доступности (**AG1**) с синхронной фиксацией, автоматической отработкой отказа и доступными для чтения вторичными репликами.

### <a name="create-the-mydb1-database-on-sqlserver-0:"></a>Создание базы данных MyDB1 на sqlserver-0
1. Если вы еще не вышли из сеансов удаленных рабочих столов для **sqlserver-0** и **sqlserver-1**, сделайте это.
2. Запустите RPD-файл для **sqlserver-0** и войдите под учетной записью **CORP\Install**.
3. В **проводнике** на диске **C:\** создайте каталог **backup* *. Вы будете использовать этот каталог для резервного копирования и восстановления базы данных.
4. Щелкните правой кнопкой мыши новый каталог, наведите указатель мыши на элемент **Общий доступ** и выберите **Отдельные люди**, как показано ниже.
   
    ![Создание папки резервного копирования](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665521.gif)
5. Добавьте пользователя **CORP\SQLSvc1** и предоставьте ему разрешение **Чтение и запись**. Затем добавьте пользователя **CORP\SQLSvc2** и предоставьте ему разрешение **Чтение и запись**, как показано ниже, после чего нажмите **Поделиться**. После завершения процесса предоставления общего доступа к файлам нажмите кнопку **Готово**.
   
    ![Предоставление разрешений для папки резервного копирования](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665522.gif)
6. Далее вы создадите базу данных. В меню **Пуск** запустите **SQL Server Management Studio**, затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.
7. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Новая база данных**.
8. В поле **Имя базы данных** введите **MyDB1**, а затем нажмите кнопку **ОК**.

### <a name="take-a-full-backup-of-mydb1-and-restore-it-on-sqlserver-1:"></a>Создание полной резервной копии MyDB1 и ее сохранение на sqlserver-1
1. Далее вы создадите полную резервную копию базы данных. В **обозревателе объектов** разверните элемент **Базы данных**, затем щелкните правой кнопкой мыши базу данных **MyDB1**, наведите указатель мыши на пункт **Задачи** и нажмите **Резервное копирование**.
2. В разделе **Источник** оставьте параметр **Тип резервного копирования** со значением **Полное**. В разделе **Назначение** нажмите кнопку **Удалить**, чтобы удалить путь к файлу резервной копии по умолчанию.
3. В разделе **Назначение** нажмите кнопку **Добавить**.
4. В текстовом поле **Имя файла** введите **\\\\sqlserver-0\backup\MyDB1.bak**. Затем нажмите кнопку **ОК** и еще раз кнопку **ОК**, чтобы создать резервную копию базы данных. После завершения резервного копирования нажмите кнопку **ОК** , чтобы закрыть диалоговое окно.
5. Далее вы создадите резервную копию журнала транзакций базы данных. В **обозревателе объектов** разверните элемент **Базы данных**, затем щелкните правой кнопкой мыши базу данных **MyDB1**, наведите указатель мыши на пункт **Задачи** и нажмите **Резервное копирование**.
6. В поле **Тип резервной копии** выберите вариант **Журнал транзакций**. В разделе **Назначение** оставьте указанный ранее путь к файлу и нажмите кнопку **ОК**. После завершения резервного копирования нажмите кнопку **ОК** еще раз.
7. Далее вы восстановите полную резервную копию и резервную копию журнала транзакций на **sqlserver-1**. Запустите RPD-файл для **sqlserver-1** и войдите под учетной записью **CORP\Install**. Оставьте сеанс удаленного рабочего стола для **sqlserver-0** открытым.
8. В меню **Пуск** запустите **SQL Server Management Studio**, затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.
9. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Восстановить базу данных**.
10. В разделе **Источник** выберите **Устройство** и нажмите кнопку **…**. .
11. В разделе **Выберите устройства резервного копирования** нажмите кнопку **Добавить**.
12. В поле "Расположение файла резервной копии" введите **\\\\sqlserver-0\backup**, затем нажмите кнопку "Обновить", выберите MyDB1.bak и два раза последовательно нажмите кнопку ОК. На панели "Восстанавливаемые резервные наборы данных" должны появиться полная резервная копия и резервная копия журнала.
13. Перейдите на страницу "Параметры", выберите вариант "ВОССТАНОВЛЕНИЕ С ПОМОЩЬЮ NORECOVERY" в состоянии "Восстановление" и нажмите кнопку "ОК", чтобы восстановить базу данных. После завершения восстановления нажмите кнопку "ОК".

### <a name="create-the-availability-group:"></a>Создание группы доступности:
1. Вернитесь к сеансу удаленного рабочего стола для **sqlserver-0**. В **обозревателе объектов** в SSMS щелкните правой кнопкой мыши **Высокая доступность AlwaysOn** и выберите **Мастер создания групп доступности**, как показано ниже.
   
    ![Запуск мастера создания групп доступности](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665523.gif)
2. На странице **Введение** нажмите кнопку **Далее**. На странице **Указание имени группы доступности** введите **AG1** в поле **Имя группы доступности**, затем нажмите кнопку **Далее** еще раз.
   
    ![Мастер создания групп доступности, ввод имени групп доступности](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665524.gif)
3. На странице **Выбор баз данных** выберите **MyDB1** и нажмите кнопку **Далее**. Эта база данных отвечает требованиям для создания группы доступности, так как вы создали для нее как минимум одну полную резервную копию на соответствующей первичной реплике.
   
    ![Мастер создания групп доступности, выбор баз данных](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665525.gif)
4. На странице **Указание реплик** нажмите кнопку **Добавить реплику**.
   
    ![Мастер создания групп доступности, указание реплик](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665526.png)
5. Появится диалоговое окно **Подключение к серверу** . В поле **Имя сервера** введите **sqlserver-1** и нажмите кнопку **Подключиться**.
   
    ![Мастер создания групп доступности, подключение к серверу](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665527.png)
6. На странице **Указание реплик** сервер **sqlserver-1** должен отобразиться в списке **Реплики доступности**. Настройте реплики, как показано ниже. 
   
    ![Мастер создания групп доступности, указание реплик (завершено)](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665528.png)
7. Щелкните **Конечные точки** , чтобы просмотреть конечную точку зеркального отображения базы данных, которая будет использоваться этой группой доступности. Каждый экземпляр SQL Server должен содержать одну конечную точку зеркального отображения базы данных. Укажите TCP-порт, который мастер задает для этой конечной точки. Создайте правило брандмауэра для входящего трафика на каждом сервере для TCP-порта.
   
    После завершения нажмите кнопку **Далее**.
8. На странице **Выбор начальной синхронизации данных** выберите **Только соединение** и нажмите кнопку **Далее**. Вы уже выполнили синхронизацию данных вручную при создании полной резервной копии и резервной копии журнала транзакций на **sqlserver-0** и их восстановлении на **sqlserver-1**. Вы можете не выполнять операции резервного копирования и восстановления для базы данных и выбрать **Полная** , чтобы позволить мастеру создания групп доступности выполнить синхронизацию данных вместо вас. Обратите внимание, что синхронизацию не рекомендуется проводить для весьма крупных баз, которые иногда используются на предприятиях.
   
    ![Мастер создания групп доступности, выбор начальной синхронизации данных](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665529.png)
9. На странице **Проверка** нажмите кнопку **Далее**. Страница должна иметь примерно такой вид: Появится предупреждение о конфигурации прослушивателя группы доступности, так как он еще не настроен. Вы можете пропустить это предупреждение, поскольку процедура настройки прослушивателя не описана в этом учебнике. В этом руководстве вы создадите прослушиватель позже.
   
    ![Мастер создания групп доступности, проверка](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665530.gif)
10. На странице **Сводка** нажмите кнопку **Готово**, затем подождите, пока мастер настроит новую группу доступности. На странице **Ход выполнения** вы можете нажать кнопку **Дополнительные сведения**, чтобы просмотреть подробности хода выполнения. Завершив работу с мастером, проверьте содержимое страницы **Результаты**, чтобы убедиться, что группа доступности успешно создана, как показано ниже, и нажмите кнопку **Закрыть**, чтобы выйти из мастера.
    
     ![Мастер создания групп доступности, результаты](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665531.png)
11. В **обозревателе объектов** разверните элемент **Высокая доступность AlwaysOn**, а затем элемент **Группы доступности**. Теперь в этом контейнере должна появиться новая группа доступности. Щелкните правой кнопкой мыши **AG1 (основная)** и выберите пункт **Отобразить панель мониторинга**.
    
     ![Отображение панели мониторинга группы доступности](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665532.png)
12. **Панель мониторинга AlwaysOn** должна выглядеть примерно следующим образом. Вы увидите реплики, режим отработки отказа для каждой из них и состояние синхронизации.
    
     ![Панель мониторинга группы доступности](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665533.png)
13. Вернитесь на панель **Диспетчер серверов**, выберите **Инструменты** и запустите **Диспетчер отказоустойчивости кластеров**.
14. Разверните элемент **Cluster1.corp.contoso.com**, а затем разверните элемент **Службы и приложения**. Выберите **Роли** и обратите внимание, что роль группы доступности **AG1** создана. Обратите внимание, что у группы AG1 нет IP-адреса, по которому клиенты базы данных могут подключиться к группе доступности, поскольку вы не настроили прослушиватель. Вы можете подключиться напрямую к основному узлу для операций чтения и записи и второстепенному узлу для запросов только на чтение.
    
     ![Группа доступности в диспетчере отказоустойчивости кластеров](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups-manual/IC665534.png)

> [!WARNING]
> Не пытайтесь выполнить отработку отказа для группы доступности через диспетчер отказоустойчивости кластеров. Все операции отработки отказов следует выполнять через **панель мониторинга AlwaysOn** в SSMS. Дополнительные сведения см. в разделе [Ограничения на использование диспетчера отказоустойчивости кластеров WSFC с группами доступности](https://msdn.microsoft.com/library/ff929171.aspx).
> 
> 

## <a name="configure-internal-load-balancer"></a>Настройка внутреннего балансировщика нагрузки
Чтобы подключиться к группе доступности напрямую, необходимо настроить балансировщик нагрузки. Она направляет клиентский трафик к виртуальной машине, к которой привязан IP-адрес прослушивателя и порт пробы. В этом руководстве используется внутренний балансировщик нагрузки (ILB). ILB разрешает трафику внутри одной виртуальной сети подключаться к SQL Server. Для приложений, которым требуется подключение к SQL Server через Интернет, необходим балансировщик нагрузки с выходом в Интернет или внешний балансировщик нагрузки. Дополнительные сведения см. в разделе [Обзор Azure Load Balancer](../load-balancer/load-balancer-overview.md).

> [!NOTE]
> В настоящее время портал Azure позволяет использовать только один определенный внешний порт для балансировщика нагрузки. Чтобы применить тот же порт для всех прослушивателей, используйте PowerShell для присоединения IP-адресов прослушивателя к балансировщику нагрузки. Дополнительные сведения см. в разделе [Настройка одного или нескольких прослушивателей группы доступности AlwaysOn в модели Resource Manager](virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md). 
> 
> 

### <a name="create-the-load-balancer-in-azure"></a>Создание балансировщика нагрузки в Azure
1. На портале Azure перейдите к **SQL-HA-RG** и нажмите **+ Добавить**.
2. Найдите **балансировщик нагрузки**. Выберите балансировщик нагрузки, опубликованный корпорацией Майкрософт, и щелкните **Создать**.
3. Настройте следующие параметры для балансировщика нагрузки:

| Настройка | Поле |
| --- | --- |
| **Имя** |sqlLB |
| **Схема** |Внутренний |
| **Виртуальная сеть** |autoHAVNET |
| **Подсеть** |subnet-2. Это IP-адрес, который будет задан для прослушивателя в ресурсе кластера. |
| **Назначение IP-адресов** |Статическое |
| **IP-адрес** |Используйте доступный адрес из подсети subnet-2. |
| **Подписка** |Используйте ту же подписку, которую используют другие ресурсы в этом решении. |
| **Расположение** |Используйте то же расположение, которое используют другие ресурсы в этом решении. |

Щелкните **Создать**.

Задайте следующие параметры для балансировщика нагрузки:

| Настройка | Поле |
| --- | --- |
| **серверного пула** Имя |sqlLBBE |
| **Группа доступности SQLLBBE** |sqlAvailabilitySet |
| **Виртуальные машины SQLLBBE** |sqlserver-0, sqlserver-1 |
| **Кем используется SQLLBBE** |SQLAlwaysOnEndPointListener |
| **пробы** Имя |SQLAlwaysOnEndPointProbe |
| **Протокол пробы** |TCP |
| **Порт пробы** |59999. Обратите внимание, что можно использовать любой неиспользуемый порт. |
| **Интервал пробы** |5 |
| **Порог состояния неработоспособности пробы** |2 |
| **Кем используется проба** |SQLAlwaysOnEndPointListener |
| **правил балансировки нагрузки** Имя |SQLAlwaysOnEndPointListener |
| **Протокол правил балансировки нагрузки** |TCP |
| **Порт правил балансировки нагрузки** |1433* |
| **Серверный порт правил балансировки нагрузки** |1433 |
| **Проба правил балансировки нагрузки** |SQLAlwaysOnEndPointProbe |
| **Сохранение сеанса правил балансировки нагрузки** |None |
| **Время ожидания в режиме простоя правил балансировки нагрузки** |4. |
| **Плавающий IP-адрес правил балансировки нагрузки (прямой ответ от сервера)** |Включено |

> * 1433 — это порт SQL Server по умолчанию. Используйте его в качестве внешнего порта для экземпляра по умолчанию. Если требуется несколько групп доступности, необходимо создать дополнительные IP-адреса для каждой из них. Каждой группе доступности потребуется отдельный внешний порт. Дополнительные сведения см. в разделе [Настройка одного или нескольких прослушивателей группы доступности AlwaysOn в модели Resource Manager](virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md).
> 
> [!NOTE]
> При создании правил балансировки нагрузки необходимо включить режим "Прямой ответ от сервера".
> 
> 

После настройки балансировщика нагрузки настройте прослушиватель в отказоустойчивом кластере. 

## <a name="configure-the-listener"></a>Настройка прослушивателя
Далее нужно настроить прослушиватель группы доступности в отказоустойчивом кластере. 

1. Подключитесь по протоколу RDP к SQL Server из ad-primary-dc к sqlserver-0.
2. В диспетчере отказоустойчивости кластеров запишите имя сети кластера. Чтобы определить имя сети кластера, в **диспетчере отказоустойчивости кластеров** в области слева щелкните **Сети**. Это имя будет использоваться в переменной `$ClusterNetworkName` в сценарии PowerShell.
3. В диспетчере отказоустойчивости кластеров разверните узел имени кластера и щелкните **Роли**.
4. В области **Роли** щелкните правой кнопкой мыши имя группы доступности и выберите **Добавить ресурс** > **Точка доступа клиента**. 
5. В поле **Имя** введите **aglistener**. Нажмите кнопку **Далее** дважды, а затем нажмите кнопку **Готово**. Не подключайте прослушивателя или ресурс на этом этапе.
6. Перейдите на вкладку **Ресурсы** и разверните созданную точку доступа клиента. Щелкните правой кнопкой мыши ресурс IP-адреса и выберите пункт "Свойства". Запишите IP-адрес. Это имя нужно использовать в переменной `$IPResourceName` в сценарии PowerShell.
7. В разделе **IP-адрес** выберите **Статический IP-адрес** и укажите для статического IP-адреса тот же адрес, который использовался на портале Azure для балансировщика нагрузки **sqlLB**. Этот же IP-адрес нужно использовать в переменной `$ILBIP` в сценарии Powershell. 
8. Отключите протокол NetBIOS для этого адреса и нажмите кнопку **ОК**. 
9. В узле кластера, в котором находится основная реплика, откройте интегрированную среду сценариев PowerShell с повышенными привилегиями и вставьте в новый сценарий следующие команды:
   
    ```
    $ClusterNetworkName = "<MyClusterNetworkName>" # the cluster network name (Use Get-ClusterNetwork on Windows Server 2012 of higher to find the name)
    $IPResourceName = "<IPResourceName>" # the IP Address resource name
    $ILBIP = "<X.X.X.X>" # the IP Address of the Internal Load Balancer (ILB). This is the static IP address for the load balancer you configured in the Azure portal.
    [int]$ProbePort = <nnnnn> # In this sample we've using 59999 for the probe port. 
   
    Import-Module FailoverClusters
   
    Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
    ```
10. Обновите переменные и запустите сценарий PowerShell, чтобы настроить IP-адрес и порт для нового прослушивателя.
11. В **диспетчере отказоустойчивости кластеров** щелкните правой кнопкой мыши ресурс группы доступности и выберите пункт **Свойства**. На вкладке **Зависимости** укажите зависимость группы ресурсов от имени сети прослушивателя. 
12. Задайте для свойства прослушивателя порта значение 1433. Для этого откройте SQL Server Management Studio, щелкните правой кнопкой мыши прослушиватель группы доступности и выберите пункт "Свойства". Задайте для параметра **Порт** значение 1433. Следует использовать номер порта, настроенного для SQL Server. 
13. На этом этапе можно подключить прослушиватель. Щелкните правой кнопкой мыши имя прослушивателя и выберите **Подключить**.

### <a name="test-the-connection-to-the-listener"></a>Проверка подключения к прослушивателю
Чтобы проверить подключение:

1. Подключитесь по протоколу RDP к серверу SQL Server, который не содержит реплику.
2. Для проверки подключения используйте служебную программу sqlcmd. Например, в следующем сценарии sqlcmd подключается к основной реплике через прослушиватель с использованием проверки подлинности Windows:
   
    sqlcmd -S "<listenerName>" -E
   
   Если прослушиватель использует другой порт помимо 1433, необходимо указать номер этого порта в тесте. Например, следующий запрос проверяет подключение к прослушивателю по имени через порт 1435:
   
        sqlcmd -S "<listenerName>",1435 -E

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения об использовании SQL Server в Azure см. в статье [Общие сведения об SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

<!--HONumber=Oct16_HO2-->


