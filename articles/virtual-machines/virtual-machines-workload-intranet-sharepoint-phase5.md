<properties 
	pageTitle="Ферма SharePoint в интрасети, этап 5: создание группы доступности и добавление баз данных SharePoint" 
	description="На последнем этапе развертывания фермы SharePoint 2013 в интрасети с группами доступности AlwaysOn для SQL Server на базе служб инфраструктуры Azure создается группа доступности и в нее добавляются базы данных SharePoint." 
	documentationCenter=""
	services="virtual-machines" 
	authors="JoeDavies-MSFT" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="virtual-machines" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/05/2015" 
	ms.author="josephd"/>

# Ферма SharePoint в интрасети, этап 5: создание группы доступности и добавление баз данных SharePoint

На последнем этапе развертывания фермы SharePoint 2013 в интрасети с группами доступности AlwaysOn для SQL Server на базе служб инфраструктуры Azure создается новая группа доступности AlwaysOn и добавляются базы данных фермы SharePoint.

Описания всех этапов см. в разделе [Развертывание среды SharePoint с группами доступности AlwaysOn для SQL Server на платформе Azure](virtual-machines-workload-intranet-sharepoint-overview.md).

## Создание группы доступности и добавление баз данных

На этапе начальной настройки SharePoint создает несколько баз данных. Чтобы подготовить их к использованию, необходимо выполнить перечисленные ниже действия.

1.	Создайте полную резервную копию и резервную копию журнала транзакций базы данных на основной виртуальной машине.
2.	Восстановите полную резервную копию и копию журнала на резервной машине.

Выполнив резервное копирование и восстановление баз данных, вы можете добавить их в группу доступности. Сервер SQL Server позволяет использовать в составе группы только те базы данных, для которых была создана (хотя бы один раз) и восстановлена на другой машине резервная копия.

### Предоставление доступа к папкам резервных копий

Для выполнения операций резервного копирования и восстановления файлы резервных копий (BAK-файлы) должны быть доступны с резервной виртуальной машины SQL Server. Выполните перечисленные ниже действия.

1.	Войдите на узел сервера-источника SQL Server с учетной записью [домен]**\\sp_farm_db**. 
2.	Перейдите на диск F:. 
3.	Щелкните правой кнопкой мыши папку **Backup**, выберите команду **Общий доступ** и щелкните **Отдельные люди**.
4.	В диалоговом окне **Общий доступ к файлам** введите **[домен]\\sqlservice** и нажмите кнопку **Добавить**.
5.	Щелкните столбец **Уровень разрешений** для учетной записи **sqlservice** и выберите **Чтение и запись**. 
6.	Нажмите кнопку **Общий доступ**, а затем — **Готово**.

Выполните перечисленные выше действия на узле сервера-получателя SQL Server (но на шаге 5 предоставьте учетной записи sqlservice разрешения на **чтение** для папки F:\\Backup).

### Резервное копирование и восстановление базы данных

Описанные ниже действия необходимо повторить для каждой базы данных, которую требуется добавить в группу доступности. Некоторые базы данных SharePoint 2013 не поддерживают группы доступности AlwaysOn для SQL Server. Дополнительную информацию см. в статье [Поддерживаемые варианты обеспечения высокого уровня доступности и аварийного восстановления для баз данных SharePoint](http://technet.microsoft.com/library/jj841106.aspx).

Чтобы создать резервную копию базы данных, выполните перечисленные ниже действия.

1.	На начальном экране компьютера с сервером-источником SQL Server введите **SQL Studio** и выберите **SQL Server Management Studio**.
2.	Щелкните **Подключить**.
3.	В левой области разверните узел **Базы данных**.
4.	Щелкните правой кнопкой мыши базу данных для резервного копирования, наведите указатель на элемент **Задачи** и выберите **Создать резервную копию**.
5.	В разделе **Назначение** нажмите кнопку **Удалить**, чтобы удалить путь к файлу резервной копии по умолчанию.
6.	Щелкните **Добавить**. В поле **Имя файла** введите **[имя_машины]\\backup[имя_базы_данных].bak**, где имя_машины — имя компьютера с сервером-источником SQL Server, а имя_базы_данных — название базы. Нажмите кнопку **ОК**, а затем щелкните **ОК** еще раз в окне с сообщением об успешном создании резервной копии.
7.	В левой области щелкните правой кнопкой мыши **[имя_базы_данных]**, наведите указатель на элемент **Задачи** и выберите **Создать резервную копию**.
8.	В поле **Тип резервной копии** выберите вариант **Журнал транзакций** и дважды нажмите кнопку **ОК**.
9.	Не закрывайте этот сеанс подключения к удаленному рабочему столу.

Чтобы восстановить резервную копию базы данных, выполните перечисленные ниже действия.

1.	Войдите на компьютер с сервером-получателем SQL Server с учетной записью [имя_домена]\\sp_farm_db.
2.	На начальном экране введите **SQL Studio** и выберите **SQL Server Management Studio**.
3.	Щелкните **Подключить**.
4.	В левой области щелкните правой кнопкой мыши **Базы данных** и выберите команду **Восстановить базу данных**.
5.	В разделе **Источник** выберите **Устройство** и нажмите кнопку с многоточием (…).
6.	В разделе **Выберите устройства резервного копирования** нажмите кнопку **Добавить**.
7.	В поле **Местоположение резервных копий** введите **[имя_машины]\\backup**, нажмите **ВВОД**, введите **[имя_базы_данных].bak** и дважды нажмите кнопку **ОК**. В разделе **Восстанавливаемые резервные наборы данных** должны появиться полная резервная копия и резервная копия журнала.
8.	В разделе **Выбор страницы** щелкните **Параметры**. В разделе **Параметры восстановления** в поле **Состояние восстановления** выберите вариант **NORECOVERY** и нажмите кнопку **ОК**. 
9.	При появлении запроса нажмите кнопку **ОК**.

### Создание группы доступности

Подготовив к работе хотя бы одну базу данных (посредством резервного копирования и восстановления), можно создавать группу доступности.

1.	Вернитесь к сеансу подключения к удаленному рабочему столу компьютера с сервером-источником SQL Server.
2.	В среде **SQL Server Management Studio** в левой области щелкните правой кнопкой мыши элемент **Высокий уровень доступности AlwaysOn** и откройте **мастер создания групп доступности**.
3.	На начальной странице нажмите кнопку **Далее**. 
4.	На странице «Указание имени группы доступности» введите название своей группы доступности (например, AG1) в поле **Имя группы доступности** и нажмите кнопку **Далее**.
5.	На странице «Выбор баз данных» выберите базы данных фермы SharePoint, для которых вы создали резервные копии, и нажмите кнопку **Далее**. Эти базы отвечают требованиям для создания группы доступности, так как вы создали для них как минимум одну полную резервную копию на соответствующей первичной реплике.
6.	На странице «Указание реплик» нажмите кнопку **Добавить реплику**.
7.	В поле **Подключение к серверу** введите имя компьютера с сервером-получателем SQL Server и нажмите кнопку **Подключить**. 
8.	На странице «Указание реплик» в списке **Реплики доступности** будет указан узел сервера-получателя SQL Server. Для обоих экземпляров сервера задайте указанные ниже значения параметров. 

Исходная роль | Параметр | Значение 
--- | --- | ---
Главный | Автоматический переход на другой ресурс (до 2) | Выбрано
Второстепенный | Автоматический переход на другой ресурс (до 2) | Выбрано
Главный | Синхронная фиксация (до 3) | Выбрано
Второстепенный | Синхронная фиксация (до 3) | Выбрано
Главный | Вторичная реплика для чтения | Да
Второстепенный | Вторичная реплика для чтения | Да
		
9.	Нажмите кнопку **Далее**.
10.	На странице «Выбор начальной синхронизации данных» щелкните **Только соединение** и нажмите кнопку **Далее**. Синхронизация данных выполняется вручную путем создания полной резервной копии и резервной копии журнала на сервере-источнике и их восстановления на сервере-получателе. Вместо этого можно выбрать вариант **Полная**, чтобы мастер создания групп доступности автоматически выполнил синхронизацию данных. Обратите внимание на то, что синхронизацию не рекомендуется проводить для крупных баз, которые иногда используются на предприятиях.
11.	На странице проверки нажмите кнопку **Далее**. Появится предупреждение об отсутствии параметров прослушивателя группы доступности, так как он еще не настроен. 
12.	На странице сводки нажмите кнопку **Готово**. Завершив работу с мастером, проверьте содержимое страницы **Результаты**, чтобы убедиться в том, что группа доступности успешно создана. Если все в порядке, нажмите кнопку **Закрыть**, чтобы выйти из мастера. 
13.	На начальном экране введите **Отказоустойчивость** и щелкните **Диспетчер отказоустойчивости кластеров**. В левой области откройте имя своего кластера и щелкните **Роли**. В списке должна появиться новая роль, имя которой совпадает с именем группы доступности.

Группа доступности AlwaysOn для SQL Server и баз данных SharePoint успешно настроена.

## Настройка прослушивателя для группы доступности AlwaysOn

Для группы доступности AlwaysOn можно задать конфигурацию прослушивателя. Соответствующие инструкции см. в статье [Учебник. Конфигурация прослушивателя для групп доступности AlwaysOn](https://msdn.microsoft.com/library/dn425027.aspx). Создайте один прослушиватель и задайте для него виртуальный IP-адрес экземпляра подсистемы внутренней балансировки нагрузки.

После создания прослушивателя вам потребуется указать его на всех виртуальных машинах SharePoint вместо имени первого сервера SQL Server в кластере. Вместо имен настройте виртуальные машины SharePoint для использования псевдонима SQL. Дополнительные сведения и инструкции см. в статье [Псевдоним SQL для SharePoint](http://blogs.msdn.com/b/priyo/archive/2013/09/13/sql-alias-for-sharepoint.aspx).

Дополнительные сведения о среде SharePoint с группами доступности AlwaysOn для SQL Server см. в статье [Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://technet.microsoft.com/library/jj715261.aspx).


## Дополнительные ресурсы

[Развертывание среды SharePoint с группами доступности AlwaysOn для SQL Server на платформе Azure](virtual-machines-workload-intranet-sharepoint-overview.md)

[Фермы SharePoint, размещенные в службах инфраструктуры Azure](virtual-machines-sharepoint-infrastructure-services.md)

[Среда SharePoint с группами доступности AlwaysOn для SQL Server](http://go.microsoft.com/fwlink/?LinkId=394788)

[Архитектуры Microsoft Azure для SharePoint 2013](https://technet.microsoft.com/library/dn635309.aspx)

<!--HONumber=54--> 