---
title: Настройка подключения к SAP HANA в Azure (крупные экземпляры) с виртуальных машин | Документация Майкрософт
description: Настройка подключения с виртуальных машин для использования SAP HANA в Azure (крупные экземпляры).
services: virtual-machines-linux
documentationcenter: ''
author: RicksterCDN
manager: jeconnoc
editor: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/10/2018
ms.author: rclaus
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f0e09e6dfce5d0ede525f461193866219b7f9429
ms.sourcegitcommit: 2d961702f23e63ee63eddf52086e0c8573aec8dd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/07/2018
ms.locfileid: "44167674"
---
# <a name="connecting-azure-vms-to-hana-large-instances"></a>Подключение виртуальных машин Azure к крупным экземплярам HANA

Как уже упоминалось в статье [Обзор и описание архитектуры SAP HANA в Azure (крупные экземпляры)](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/hana-overview-architecture), минимальное развертывание крупных экземпляров HANA с уровнем приложений SAP в Azure выглядит следующим образом:

![Виртуальная сеть Azure подключена к SAP HANA в Azure (крупные экземпляры) и к локальной сети](./media/hana-overview-architecture/image3-on-premises-infrastructure.png)

Обратите внимание на виртуальную сеть Azure. Для нее требуется следующее:

- Определение виртуальной сети Azure, которое будет использоваться для развертывания виртуальных машин на уровне приложений SAP.
- Это автоматически означает, что в виртуальной сети Azure определяется подсеть по умолчанию, в которой будут фактически развернуты виртуальные машины.
- В создаваемой виртуальной сети Azure должна быть по крайней мере одна подсеть виртуальной машины и одна подсеть шлюза для ExpressRoute. Таким подсетям нужно назначить диапазоны IP-адресов в соответствии со сведениями, указанными в разделах ниже.

Итак, давайте подробнее рассмотрим создание виртуальной сети Azure для крупных экземпляров HANA.

## <a name="creating-the-azure-vnet-for-hana-large-instances"></a>Создание виртуальной сети Azure для крупных экземпляров HANA

>[!Note]
>Эту виртуальную сеть Azure для крупных экземпляров HANA следует создавать с использованием модели развертывания с помощью Azure Resource Manager. Крупные экземпляры HANA не поддерживают старую модель развертывания Azure, известную как классическая модель развертывания.

Виртуальную сеть можно создать с помощью портала Azure, PowerShell, шаблона Azure или Azure CLI (см. статью [Создание виртуальной сети с помощью портала Azure](../../../virtual-network/manage-virtual-network.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json#create-a-virtual-network)). В следующем примере мы рассмотрим виртуальную сеть, созданную с помощью портала Azure.

Просматривая определения виртуальной сети Azure на портале Azure, давайте обратим внимание на некоторые определения и их взаимосвязь с перечисленными ниже различными диапазонами IP-адресов. Говоря об **адресном пространстве**, мы имеем в виду адресное пространство, которое разрешено использовать виртуальной сети Azure. Оно будет использоваться в виртуальной сети для распространения маршрутов BGP. Это **адресное пространство** можно увидеть здесь:

![Адресное пространство виртуальной сети Azure на портале Azure](./media/hana-overview-connectivity/image1-azure-vnet-address-space.png)

В предыдущем случае пространству адресов 10.16.0.0/16 виртуальной сети Azure назначен достаточно большой диапазон IP-адресов. Это значит, что все диапазоны IP-адресов последующих подсетей в виртуальной сети могут входить в указанное адресное пространство. Обычно мы не рекомендуем использовать настолько большой диапазон адресов для одной виртуальной сети в Azure. Однако давайте заглянем немного наперед и посмотрим подсети, определенные в виртуальной сети Azure:

![Подсети виртуальной сети Azure и их IP-адреса](./media/hana-overview-connectivity/image2b-vnet-subnets.png)

Как видно, создана виртуальная сеть с первой подсетью виртуальной машины (default) и подсеть GatewaySubnet.
В следующем разделе мы будем называть диапазон IP-адресов подсети default на снимке экрана **диапазоном IP-адресов подсети виртуальной машины Azure**, а диапазон IP-адресов подсети шлюза — **диапазоном IP-адресов подсети шлюза виртуальной сети**. 

В случае выше на двух снимках экрана можно увидеть, что в **адресное пространство виртуальной сети** входит **диапазон IP-адресов подсети виртуальной машины Azure** и **диапазон IP-адресов подсети шлюза виртуальной сети**. 

В других случаях, где необходимо сохранить диапазоны IP-адресов или использовать определенные диапазоны, можно ограничить **адресное пространство виртуальной сети** определенными диапазонами, используемыми каждой подсетью. В этом случае **адресное пространство виртуальной сети** можно определить как несколько конкретных диапазонов, как показано ниже:

![Адресное пространство виртуальной сети Azure в качестве двух пространств](./media/hana-overview-connectivity/image3-azure-vnet-address-space_alternate.png)

В этом случае для **адресного пространства виртуальной сети** определено два пространства, идентичных диапазонам IP-адресов, определенным для **диапазона IP-адресов подсети виртуальной машины Azure** и **диапазона IP-адресов подсети шлюза виртуальной сети**.

Для этих подсетей клиента (подсетей виртуальной машины) можно использовать любой стандарт именования. Тем не менее **каждой виртуальной подсети должна соответствовать только одна подсеть шлюза**, подключающаяся к каналу ExpressRoute для SAP HANA в Azure (крупные экземпляры). **Эту подсеть шлюза нужно называть GatewaySubnet**, чтобы обеспечить правильное размещение шлюза ExpressRoute.

> [!WARNING] 
> Крайне важно, чтобы подсеть шлюза называлась GatewaySubnet.

Вы можете использовать несколько подсетей виртуальной машины, даже при применении несмежных адресов. Однако, как упоминалось ранее, эти диапазоны адресов должны входить в **адресное пространство виртуальной сети** и указываться в сводной форме или в списке точных диапазонов подсетей виртуальной машины и подсети шлюза.

Ниже представлены важные факты о виртуальной сети Azure, которая подключается к крупным экземплярам HANA:

- При выполнении первоначального развертывания больших экземпляров HANA необходимо отправить **адресное пространство виртуальной сети** в корпорацию Майкрософт. 
- **Адресное пространство адресов виртуальной сети** может представлять собой один большой диапазон, охватывающий диапазоны IP-адресов подсети виртуальной машины Azure и диапазон IP-адресов подсети шлюза,
- или несколько диапазонов, **охватывающих разные** диапазоны IP-адресов в пределах диапазонов IP-адресов подсети виртуальной машины и диапазона IP-адресов подсети шлюза.
- Определенное **адресное пространство виртуальной сети** используется для распространения маршрутов BGP.
- Для подсети шлюза должно использоваться имя **GatewaySubnet**.
- **Адресное пространство виртуальной сети** используется в качестве фильтра на стороне крупных экземпляров HANA, чтобы разрешать или запрещать передачу трафика к единицам крупных экземпляров HANA из Azure. Если сведения о маршрутах BGP виртуальной сети Azure и диапазонах IP-адресов, настроенных для фильтрации на стороне крупных экземпляров HANA, не совпадают, могут возникнуть проблемы с подключением.
- В разделе "Подключение виртуальной сети к каналу ExpressRoute крупных экземпляров HANA" ниже указаны некоторые дополнительные сведения о подсети шлюза.



## <a name="different-ip-address-ranges-to-be-defined"></a>Определение разных диапазонов IP-адресов 

В предыдущих разделах мы уже рассмотрели некоторые диапазоны IP-адресов, необходимые для развертывания крупных экземпляров HANA. Однако стоит упомянуть и о других важных диапазонах IP-адресов. Давайте рассмотрим их подробнее. Вам нужно определить следующие IP-адреса перед отправкой запроса на первоначальное развертывание (лишь некоторые из них нужно отправлять в корпорацию Майкрософт):

- **Адресное пространство виртуальной сети** — это диапазон IP-адресов (как уже представлено выше), назначенный (или который планируется назначить) пространству адресов виртуальной сети Azure, которая подключается к среде крупных экземпляров SAP HANA. Мы рекомендуем, чтобы параметр адресного пространства использовался в качестве многострочного значения, состоящего из диапазонов подсети виртуальной машины Azure и диапазона подсети шлюза Azure, как показано на рисунке выше. Этот диапазон НЕ ДОЛЖЕН пересекаться с локальным диапазоном адресов, диапазоном IP-адресов пула серверов или с диапазоном адресов ER-P2P. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должны предоставить один или несколько диапазонов IP-адресов в сети или вне ее. Например, если используется подсеть виртуальной машины Azure 10.0.1.0/24 (см. выше) и подсеть шлюза Azure 10.0.2.0/28 (см. ниже), мы рекомендуем применять адресное пространство виртуальной сети Azure 10.0.1.0/24 и 10.0.2.0/28. Хотя значения адресных пространств можно агрегировать, мы рекомендуем сопоставить их с диапазонами подсетей, чтобы избежать случайного повторного использования неиспользуемых диапазонов IP-адресов с более крупными адресными пространствами в сети в будущем. **Адресное пространство виртуальной сети — это диапазон IP-адресов, который нужно отправить в корпорацию Майкрософт вместе с запросом на первоначальное развертывание.**

- **Диапазон IP-адресов подсети виртуальной машины Azure** — это диапазон IP-адресов (как уже представлено выше), назначенный (или который планируется назначить) подсети виртуальной сети Azure, которая подключается к среде крупных экземпляров SAP HANA. Этот диапазон IP-адресов используется для назначения IP-адресов виртуальным машинам Azure. IP-адреса вне этого диапазона разрешено использовать для подключения к серверам крупных экземпляров SAP HANA. При необходимости можно использовать несколько подсетей виртуальной машины Azure. Майкрософт рекомендует использовать по блоку CIDR с маской /24 для каждой подсети виртуальной машины Azure. Этот диапазон адресов должен быть частью значений, используемых в адресном пространстве виртуальной сети Azure. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети.

- **Диапазон IP-адресов подсети шлюза виртуальной сети.** В зависимости от функций, которые планируется использовать, мы рекомендуем применять следующие размеры:
   - Ультрапроизводительный шлюз ExpressRoute: блок адресов размером /26 — требуется для номеров SKU класса II
   - Сосуществование с VPN и ExpressRoute с применением шлюза HighPerformance ExpressRoute (или более низкой версии): блок адресов размером /27.
   - Другие ситуации: блок адресов размером /28. Этот диапазон адресов должен быть частью значений, используемых в адресном пространстве виртуальной сети. Этот диапазон адресов должен быть частью значений, используемых в адресном пространстве виртуальной сети Azure, которые нужно отправить в корпорацию Майкрософт. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети. 

- **Диапазон адресов для подключения ER-P2P** — это диапазон IP-адресов для однорангового подключения ExpressRoute (ER) крупных экземпляров SAP HANA. Это должен быть диапазон IP-адресов CIDR с маской /29. Этот диапазон НЕ ДОЛЖЕН пересекаться с локальным диапазоном адресов и с другими диапазонами IP-адресов Azure. Он используется для настройки подключения ER между шлюзом ExpressRoute виртуальной сети Azure и серверами крупных экземпляров SAP HANA. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети. **Этот диапазон IP-адресов нужно отправить в корпорацию Майкрософт вместе с запросом на первоначальное развертывание.**
  
- **Диапазон IP-адресов пула серверов.** Этот диапазон IP-адресов используется для назначения отдельных IP-адресов серверам больших экземпляров HANA. Мы рекомендуем использовать такой размер подсети, как блоки CIDR с маской /24. При необходимости его можно уменьшить, чтобы предоставлять минимальное число IP-адресов (64). Первые 30 IP-адресов в этом диапазоне будут зарезервированы для использования корпорацией Майкрософт. Учитывайте это, выбирая размер диапазона. Этот диапазон НЕ ДОЛЖЕН пересекаться с локальным диапазоном адресов и с другими диапазонами IP-адресов Azure. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети. Уникальный блок CIDR с диапазоном /24 (рекомендуется) для назначения определенных IP-адресов, необходимых для SAP HANA в Azure (крупные экземпляры). **Этот диапазон IP-адресов нужно отправить в корпорацию Майкрософт вместе с запросом на первоначальное развертывание.**
 
Хотя необходимо определить и спланировать диапазоны IP-адресов выше, не все из них нужно отправлять в корпорацию Майкрософт. Итак, вам нужно отправить в корпорацию Майкрософт следующие диапазоны IP-адресов:

- Адресное пространство виртуальной сети Azure.
- Диапазон IP-адресов для подключений ER-P2P.
- Диапазон IP-адресов пула серверов.

Для добавления дополнительных виртуальных сетей, которым требуется подключиться к крупным экземплярам HANA, необходимо отправить новое адресное пространство виртуальной сети Azure, добавляемой в корпорацию Майкрософт. 

Ниже приведен пример различных диапазонов, которые нужно настроить и отправить в корпорацию Майкрософт. В первом примере значение адресного пространства виртуальной сети Azure не агрегировано. Оно определяется по диапазонам первого диапазона IP-адресов подсети виртуальной машины Azure и диапазона IP-адресов подсети шлюза виртуальной сети. Чтобы вы могли использовать несколько подсетей виртуальной машины в виртуальной сети Azure соответствующим образом, настройте и отправьте дополнительные диапазоны IP-адресов дополнительных виртуальных подсетей в составе адресного пространства виртуальной сети Azure.

![Диапазоны IP-адресов, необходимые для минимального развертывания SAP HANA в Azure (крупные экземпляры)](./media/hana-overview-connectivity/image4b-ip-addres-ranges-necessary.png)

Вы также можете выполнить статистическую обработку данных, отправляемых в корпорацию Майкрософт. В этом случае адресное пространство виртуальной сети Azure будет содержать всего одно пространство. Если использовать диапазоны IP-адресов из примера выше, агрегированное адресное пространство виртуальной сети может выглядеть так:

![Второй вариант диапазонов IP-адресов, необходимых для минимального развертывания SAP HANA в Azure (крупные экземпляры)](./media/hana-overview-connectivity/image5b-ip-addres-ranges-necessary-one-value.png)

Как можно заметить, вместо двух диапазонов меньшего размера, определяющих адресное пространство виртуальной сети Azure, у нас есть один больший диапазон, охватывающий 4096 IP-адресов. При таком крупном определении адресного пространства некоторые крупные диапазоны не используются. Так как значения адресного пространства виртуальной сети используются для распространения маршрутов BGP, использование неиспользуемых диапазонов локально или в другой части сети может вызвать проблемы маршрутизации. Поэтому мы рекомендуем обеспечить точное соответствие адресного пространства фактически используемому адресному пространству подсети. При необходимости вы можете в любое время добавить новые значения адресного пространства позже, не вызывая простои в виртуальной сети.
 
> [!IMPORTANT] 
> IP-адреса адресного пространства ER-P2P, пула серверов и виртуальной сети Azure **НЕ** должны пересекаться между собой или с другими диапазонами IP-адресов в сети. Это должны быть отдельные адреса и, как показано на двух рисунках выше, они не должны быть частью подсети другого диапазона. Если диапазоны пересекаются, виртуальная сеть Azure может не подключиться к каналу ExpressRoute.

## <a name="next-steps-after-address-ranges-have-been-defined"></a>Дальнейшие действия после определения диапазонов адресов
После определения диапазонов IP-адресов нужно сделать следующее:

1. Отправьте диапазоны IP-адресов для адресного пространства виртуальной сети Azure, подключения ER-P2P и диапазона IP-адресов пула серверов, а также другие данные, указанные в начале документа. Сейчас также можно приступить к созданию виртуальной сети и подсети виртуальной машины. 
2. Корпорация Майкрософт создает канал ExpressRoute между подпиской Azure и стеком крупных экземпляров HANA.
3. Корпорация Майкрософт создает клиентскую сеть в стеке крупных экземпляров.
4. Специалисты Майкрософт настроят сеть таким образом, чтобы инфраструктура SAP HANA в Azure (крупные экземпляры) принимала IP-адреса из адресного диапазона виртуальной сети Azure, которая будет взаимодействовать с крупными экземплярами HANA.
5. В зависимости от конкретного приобретенного SKU SAP HANA в Azure (крупные экземпляры), корпорация Майкрософт назначит единицу вычисления в сети клиента, выделит и подключит хранилище, а также установит операционную систему (SUSE или RedHat Linux). IP-адреса для этих единиц берутся из диапазона IP-адресов пула серверов, отправленного в корпорацию Майкрософт.

В конце развертывания специалисты Майкрософт отправят вам следующие данные:
- Сведения, нужные для подключения виртуальной сети Azure к каналу ExpressRoute, по которому они подключаются к крупным экземплярам HANA.
     - ключи авторизации;
     - код узла ExpressRoute.
- Данные для доступа к крупным экземплярам HANA по настроенному каналу ExpressRoute и виртуальной сети Azure.

Можно также обратиться к последовательности подключения крупных экземпляров HANA, которая описана в документе [Комплексная настройка крупных экземпляров SAP HANA](https://azure.microsoft.com/resources/sap-hana-on-azure-large-instances-setup/). Многие из следующих действий демонстрируются в примере развертывания в этом документе. 

**Дальнейшие действия**

- См. статью о [подключении виртуальной сети к каналу ExpressRoute крупных экземпляров HANA](hana-connect-vnet-express-route.md).