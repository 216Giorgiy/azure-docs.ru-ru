---
title: "Обеспечение высокого уровня доступности и аварийное восстановление решения \"SAP HANA в Azure (крупные экземпляры)\" | Документация Майкрософт"
description: "Сведения об обеспечении высокого уровня доступности и о планировании аварийного восстановления решения \"SAP HANA в Azure (крупные экземпляры)\"."
services: virtual-machines-linux
documentationcenter: 
author: RicksterCDN
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/01/2016
ms.author: rclaus
ms.custom: H1Hack27Feb2017
ms.translationtype: HT
ms.sourcegitcommit: 48dfc0fa4c9ad28c4c64c96ae2fc8a16cd63865c
ms.openlocfilehash: 4356e35609fa7a9727d8ad4f20fd18df01a05e84
ms.contentlocale: ru-ru
ms.lasthandoff: 08/30/2017

---
# <a name="sap-hana-large-instances-high-availability-and-disaster-recovery-on-azure"></a>Высокий уровень доступности и аварийное восстановление SAP HANA в Azure (крупные экземпляры) 

Для работы критически важных серверов SAP HANA в Azure (крупные экземпляры) важно обеспечить высокий уровень доступности и реализовать стратегию аварийного восстановления. Кроме того, важно сотрудничать с SAP, вашим системным интегратором и (или) корпорацией Майкрософт, чтобы правильно создать архитектуру и реализовать подходящую стратегию обеспечения высокой доступности и аварийного восстановления. Также важно учитывать целевую точку восстановления и целевое время восстановления, характерные для вашей среды.

По умолчанию корпорация Майкрософт поддерживает некоторые готовые методы обеспечения высокого уровня доступности SAP HANA с помощью крупных экземпляров HANA. В частности, описаны такие возможности:

- **Репликация хранилища** — возможность системы хранения данных реплицировать все данные в другой стек крупных экземпляров HANA в другом регионе Azure. SAP HANA работает независимо от этого метода.
- **Репликация системы HANA** — репликация всех данных SAP HANA в отдельную систему SAP HANA. Целевое время восстановления уменьшается благодаря репликации данных с регулярными интервалами. SAP HANA поддерживает асинхронные, выполняющиеся в памяти синхронные и синхронные режимы (мы советуем использовать их только для систем SAP HANA, расположенных в том же центре обработки данных или на расстоянии менее 100 км от него). В текущей архитектуре стеков крупных экземпляров HANA репликацию системы HANA можно использовать только для обеспечения высокой доступности. Ввиду текущей структуры сети репликацию системы HANA невозможно использовать без стороннего компонента обратного прокси-сервера для конфигураций аварийного восстановления в другой регион Azure. 
- **Автоматическая отработка отказа узла** — решение для локального восстановления после сбоя для SAP HANA, используемое в качестве альтернативы репликации системы HANA. Один или несколько резервных узлов SAP HANA настроены в режиме развертывания, и SAP HANA автоматически выполняет отработку отказа на резервный узел, когда главный узел становится недоступным.

SAP HANA в Azure (крупные экземпляры) предлагается в двух регионах Azure, охватывающих три разных геополитических региона (США, Австралию и Европу). Два региона, в которых размещены стеки крупных экземпляров HANA, подключены с помощью отдельных выделенных сетевых каналов, используемых для репликации моментальных снимков хранилища в рамках методов аварийного восстановления. По умолчанию репликация не выполняется. Она настраивается для клиентов, которые заказали функциональные возможности аварийного восстановления. Репликация хранилища зависит от использования моментальных снимков хранилища для крупных экземпляров HANA. Кроме того, невозможно выбрать регион Azure в качестве региона аварийного восстановления, если он находится в другой геополитической области. 

В таблице ниже приведены методы обеспечения высокого уровня доступности и аварийного восстановления и их сочетания, поддерживаемые на текущий момент.

| Сценарий, поддерживаемый крупными экземплярами HANA | Вариант обеспечения высокого уровня доступности | Вариант аварийного восстановления | Комментарии |
| --- | --- | --- | --- |
| Отдельный узел | Недоступно | Конфигурация выделенного аварийного восстановления,<br /> конфигурация многоцелевого аварийного восстановления. | |
| Автоматическая отработка отказа узла: N + m,<br /> включая 1 + 1 | Возможно, если резервный узел становится активным.<br /> Переключения ролей управляет HANA. | Конфигурация выделенного аварийного восстановления,<br /> конфигурация многоцелевого аварийного восстановления.<br /> Синхронизация аварийного восстановления с помощью репликации хранилища. | Наборы томов HANA подключены ко всем узлам (n + m).<br /> Сайт аварийного восстановления должен иметь такое же число узлов. |
| Репликация системы HANA | Возможно в конфигурации с первичными или вторичными репликами.<br /> В случае отработки отказа вторичная реплика выполняет роль первичной.<br /> Отработку отказа контролируют служба репликации системы HANA и ОС. | Конфигурация выделенного аварийного восстановления,<br /> конфигурация многоцелевого аварийного восстановления.<br /> Синхронизация аварийного восстановления с помощью репликации хранилища.<br /> Аварийное восстановление с помощью репликации системы HANA пока еще невозможно без использования сторонних компонентов. | Отдельный набор томов дисков подключен к каждому узлу.<br /> Только тома дисков вторичной реплики на рабочем сайте реплицируются в расположение аварийного восстановления.<br /> На сайте аварийного восстановления необходим один набор томов. | 

Под конфигурацией выделенного аварийного восстановления мы подразумеваем конфигурацию, в которая единица крупного экземпляра HANA на сайте аварийного восстановления не используется для выполнения другой рабочей нагрузки или непроизводственной системы. Экземпляр является пассивным и развернут только для выполнения действий в случае, если выполняется аварийная отработка отказа. Пока что у нас нет ни одного клиента с такой конфигурацией.

Под конфигурацией многоцелевого аварийного восстановления мы подразумеваем конфигурацию на сайте аварийного восстановления, в которой единица крупного экземпляра HANA выполняет непроизводственную рабочую нагрузку. В случае аварии работа этой непроизводственной системы завершается, подключаются реплицированные в хранилище (дополнительные) наборы томов и запускается рабочий экземпляр HANA. Пока что все клиенты, использующие функции аварийного восстановления на основе крупных экземпляров HANA, применяют этот вариант конфигурации. 


Дополнительные сведения о высоком уровне доступности SAP HANA см. в следующих статьях о SAP: 

- [Техническая документация по высокому уровню доступности SAP HANA](http://go.sap.com/documents/2016/05/f8e5eeba-737c-0010-82c7-eda71af511fa.html)
- [Руководство по администрированию SAP HANA](http://help.sap.com/hana/SAP_HANA_Administration_Guide_en.pdf)
- [Видеокурс SAP по репликации системы SAP HANA](http://scn.sap.com/community/hana-in-memory/blog/2015/05/19/sap-hana-system-replication)
- [Примечание по SAP № 1999880. Часто задаваемые вопросы о репликации системы SAP HANA](https://bcs.wdf.sap.corp/sap/support/notes/1999880)
- [Примечание по SAP № 2165547. Резервное копирование и восстановление SAP HANA в среде репликации системы SAP HANA](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3231363535343726)
- [Примечание по SAP № 1984882. Использование репликации системы SAP HANA для замены оборудования без простоя](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3139383438383226)

## <a name="network-considerations-for-disaster-recovery-with-hana-large-instances"></a>Рекомендации по сети для аварийного восстановления с помощью крупных экземпляров HANA

Чтобы воспользоваться преимуществами аварийного восстановления крупных экземпляров HANA, вам потребуется спроектировать сетевое подключение к двум разным регионам Azure. Для этого вам нужно создать канал Azure ExpressRoute с подключением между локальной средой и основным регионом Azure и еще один канал с подключением между локальной средой и регионом аварийного восстановления. Это позволит обеспечить работоспособность в случае возникновения проблем со всем регионом Azure, в том числе с расположением маршрутизатора Microsoft Enterprise Edge Router (MSEE).

В качестве дополнительной меры можно подключить все виртуальные сети Azure, подключенные к SAP HANA в Azure (крупные экземпляры) в одном из регионов, к каналу ExpressRoute, который соединяет крупные экземпляры HANA в другом регионе. Благодаря такому перекрестному подключению службы, работающие в виртуальной сети Azure в регионе 1, могут подключаться к единицам крупных экземпляров HANA в регионе 2, и наоборот. Это позволит устранить проблемы при выходе из обслуживания одного из расположений MSEE, используемых для установки подключения между локальным расположением и Azure.

На рисунках ниже показана такая отказоустойчивая конфигурация аварийного восстановления.

![Оптимальная конфигурация для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/image1-optimal-configuration.png)



## <a name="other-requirements-for-using-hana-large-instances-storage-replication-for-disaster-recovery"></a>Прочие требования к использованию репликации крупных экземпляров HANA для аварийного восстановления

Ниже приведены дополнительные требования к конфигурации аварийного восстановления с помощью крупных экземпляров HANA.

- Закажите номера SKU для SAP HANA в Azure (крупные экземпляры) того же размера, что и рабочие номера SKU, и разверните их в регионе аварийного восстановления. На данный момент в клиентских развертываниях эти экземпляры используются для запуска непроизводственных экземпляров HANA. Мы относим их к конфигурациям многоцелевого аварийного восстановления.   
- При необходимости закажите дополнительный объем хранилища на сайте аварийного восстановления для каждого номера SKU решения "SAP HANA в Azure (крупные экземпляры)", который вы хотите восстановить на сайте аварийного восстановления. Это обеспечивает выделение томов хранения данных, используемых при репликации хранилища из рабочего региона Azure в регион Azure аварийного восстановления.

Дополнительные сведения об аварийном восстановлении приведены в последних главах этого документа.
 

## <a name="backup-and-restore"></a>Архивация и восстановление

При работе с базами данных очень важно защитить их от различных событий, которые приводят к сбоям. Эти события могут возникать как в результате стихийных бедствий, так и через простые ошибки пользователей.

Резервное копирование с возможностью восстановления до любой точки во времени (например, перед удалением важных данных) обеспечивает восстановление базы данных до состояния, максимально приближенного к состоянию перед сбоем.

Для получения оптимальных результатов выполните следующие два типа резервного копирования:

- резервное копирование баз данных — полные, добавочные или разностные резервные копии;
- резервное копирование журналов транзакций.

Помимо полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища. Однако моментальные снимки хранилища не заменяют резервные копии журналов транзакций. Резервные копии журналов транзакций по-прежнему важны для восстановления базы данных до определенной точки во времени и очистки журналов от уже зафиксированных транзакций. Однако моментальные снимки хранилища могут ускорить восстановление, быстро предоставив образ наката для базы данных. 

SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.

- Модель "Сделай сам". После вычисления необходимого дискового пространства и проверки его наличия создайте полные резервные копии базы данных и журналов с помощью методов резервного копирования на диск либо напрямую на тома, подключенные к единицам крупных экземпляров HANA в конфигурации общедоступных ресурсов NFS на виртуальной машине Azure. В последнем случае клиенты настраивают виртуальную машину Linux в Azure, подключают к ней службу хранилища Azure и предоставляют общий доступ к хранилищу через настроенный NFS-сервер на этой виртуальной машине. При выполнении резервного копирования с использованием томов, подключенных непосредственно к единицам крупных экземпляров HANA, резервные копии должны быть скопированы в учетную запись хранения Azure (после того, как вы настроите виртуальную машину Azure, которая экспортирует общедоступные ресурсы NFS на основе службы хранилища Azure), резервное хранилище Azure или "холодное" хранилище Azure. Для хранения резервных данных после их копирования в учетную запись хранения Azure можно также использовать стороннее средство защиты данных. Кроме того, может потребоваться самостоятельное решение для резервного копирования данных, которые нужно долго хранить для соблюдения нормативных требований и аудита. Во всех случаях резервные копии копируются в общедоступные ресурсы NFS, представленные с помощью виртуальной машины и службы хранилища Azure.
- Используйте функции резервного копирования и восстановления, предоставленные базовой инфраструктурой SAP HANA в Azure (крупные экземпляры). Этот вариант удовлетворяет потребность в резервном копировании и быстром восстановлении. В оставшейся части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA. Также рассматривается их связь с возможностями аварийного восстановления, предоставляемыми крупными экземплярами HANA.

> [!NOTE]
> Технология моментальных снимков, используемая в базовой инфраструктуре крупных экземпляров HANA, зависит от моментальных снимков SAP HANA. Моментальные снимки SAP HANA не работают в сочетании с несколькими клиентами контейнеров мультитенантных баз данных SAP HANA. Таким образом, этот метод резервного копирования не может использоваться в случае развертывания нескольких клиентов в контейнерах мультитенантных баз данных SAP HANA. Хотя он будет работать, если развернут только один клиент.

### <a name="using-storage-snapshots-of-sap-hana-on-azure-large-instances"></a>Использование моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры)

Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища для томов. Поддерживается резервное копирование и восстановление тома, но следует учитывать следующее.

- Вместо полных резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.
- При активации создания моментальных снимков томов /hana/data, hana/log и /hana/shared (включая /usr/sap) создание моментального снимка хранилища запускает создание моментального снимка SAP HANA, который создается перед моментальным снимком хранилища. Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища.
- После успешного создания моментального снимка хранилища моментальный снимок SAP HANA удаляется.
- Резервные копии журналов транзакций создаются часто и хранятся на томе /hana/logbackups или в Azure. Для тома /hana/logbackups, содержащего резервные копии журналов транзакций, можно активировать отдельное создание моментального снимка. В этом случае моментальный снимок HANA создавать не требуется.
- Если базу данных необходимо восстановить до определенной точки во времени, отправьте в службу поддержки Microsoft Azure (рабочий сбой) или отдел по управлению службами SAP HANA в Azure запрос на восстановление до определенного моментального снимка хранилища (например, плановое восстановление системы типа "песочница" до исходного состояния).
- Моментальный снимок SAP HANA, добавленный в моментальный снимок хранилища, используется в качестве точки смещения для применения резервных копий журнала транзакций, полученных и сохраненных после создания моментального снимка хранилища.
- Эти резервные копии журналов транзакций используются для восстановления базы данных до определенной точки во времени.

Клиент имеет возможность создавать моментальные снимки хранилища, нацеленные на три разных класса томов.

- Объединенный моментальный снимок томов /hana/data, /hana/log и /hana/shared (включая /usr/sap). (Для этого моментального снимка требуется создание моментального снимка SAP HANA.)
- Отдельный моментальный снимок тома /hana/logbackups.
- Раздел операционной системы (только для крупных экземпляров HANA типа I).


### <a name="storage-snapshot-considerations"></a>Факторы, которые необходимо учитывать при создании моментальных снимков хранилища

>[!NOTE]
>Моментальные снимки хранилища используют дисковое пространство, которое было выделено для единиц крупных экземпляров HANA. Поэтому необходимо учитывать приведенные ниже аспекты с точки зрения планирования создания моментальных снимков хранилища и количества хранящихся моментальных снимков хранилища. 

Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:

- Определенный моментальный снимок хранилища (на определенный момент времени, когда он создан) занимает мало пространства в хранилище.
- На моментальном снимке должен храниться исходный набор данных, так как данные и содержимое файлов данных в SAP HANA изменяются на томе хранилища.
- Размер моментального снимка хранилища увеличивается в зависимости от срока его хранения.
- Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.

SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA. Создание моментальных снимков этих томов требует много пространства на томе. Так что вы ответственны за планирование моментальных снимков хранилища, отслеживание потребления пространства томов хранилища и управление количеством хранящихся моментальных снимков. Только вы в конечном итоге можете решить отключить создание моментальных снимков хранилища, так как импортируются большие объемы данных, или внести другие важные изменения в базу данных HANA. 


В следующих разделах содержатся сведения о создании этих моментальных снимков, а также общие рекомендации.

- Хотя оборудование поддерживает 255 моментальных снимков на том, мы настоятельно советуем хранить намного меньшее их количество.
- Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.
- В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить. Может потребоваться уменьшить количество хранящихся моментальных снимков или расширить тома. (Вы можете заказать дополнительное пространство в единицах по 1 ТБ.)
- При выполнении таких действий, как перенос данных в SAP HANA с помощью средств переноса платформы SAP (R3load) или восстановление баз данных SAP HANA из резервных копий, необходимо отключить создание моментальных снимков хранилища для тома /hana/data. 
- При более значительных реорганизациях таблиц SAP HANA по возможности не создавайте моментальные снимки хранилища.
- Моментальные снимки хранилища необходимы для использования возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).

### <a name="setting-up-storage-snapshots"></a>Настройка моментальных снимков хранилища

Ниже приведены приблизительные инструкции по настройке создания моментальных снимков хранилища с помощью крупных экземпляров HANA.
1. Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".
2. Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.
3. На главном узле создайте учетную запись резервного копирования SAP HANA для каждого запущенного экземпляра SAP HANA (если применимо).
4. Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.
5. На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.
6. Скопируйте сценарии и файл конфигурации из [этого расположения GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts) в расположение **hdbsql** установленного экземпляра SAP HANA.
7. Измените файл HANABackupDetails.txt в соответствии с определенной спецификацией клиента.

### <a name="step-1-install-sap-hana-hdbclient"></a>Этап 1. Установка клиента SAP HANA HDB

Операционная система Linux, установленная в решении "SAP HANA в Azure (крупные экземпляры)", содержит папки и сценарии, необходимые для создания моментальных снимков хранилища SAP HANA, используемых для резервного копирования и восстановления. Проверьте наличие последних выпусков на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts). Самой последней версией выпуска сценариев является версия 2.0.
Однако во время установки SAP HANA вы должны самостоятельно установить клиент SAP HANA HDBclient для единиц крупных экземпляров HANA. (Корпорация Майкрософт не устанавливает ни HDBclient, ни SAP HANA.)

### <a name="step-2-change-etcsshsshconfig"></a>Этап 2. Изменение файла /etc/ssh/ssh\_config

Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_, как показано ниже.
```
#   RhostsRSAAuthentication no
#   RSAAuthentication yes
#   PasswordAuthentication yes
#   HostbasedAuthentication no
#   GSSAPIAuthentication no
#   GSSAPIDelegateCredentials no
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no
#   CheckHostIP yes
#   AddressFamily any
#   ConnectTimeout 0
#   StrictHostKeyChecking ask
#   IdentityFile ~/.ssh/identity
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   Port 22
Protocol 2
#   Cipher 3des
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,arcfour256,arcfour128,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com,hmac-ripemd160
MACs hmac-sha1
#   EscapeChar ~
#   Tunnel no
#   TunnelDevice any:any
#   PermitLocalCommand no
#   VisualHostKey no
#   ProxyCommand ssh -q -W %h:%p gateway.example.com
```

### <a name="step-3-create-a-public-key"></a>Этап 3. Создание открытого ключа

Чтобы обеспечить доступ к интерфейсам моментальных снимков хранилища клиента крупных экземпляров HANA, необходимо настроить вход с помощью открытого ключа. Для создания моментальных снимков на первом сервере решения "SAP HANA в Azure (крупные экземпляры)" в своем клиенте создайте открытый ключ, который будет использоваться для доступа к инфраструктуре хранилища. Этот ключ позволит входить в интерфейсы моментальных снимков хранилища без пароля, что устраняет необходимость в хранении учетных данных с паролями. Чтобы создать открытый ключ, в операционной системе Linux на сервере решения "Крупные экземпляры SAP HANA" выполните следующую команду:
```
  ssh-keygen –t dsa –b 1024
```
Новое расположение — _/root/.ssh/id\_dsa.pub. Не вводите фактический пароль, иначе вам нужно будет вводить его при каждом входе. Вместо этого нажмите клавишу **ВВОД** дважды, чтобы закрыть этот запрос.

Убедитесь, что открытый ключ был исправлен надлежащим образом. Для этого измените папки на /root/.ssh/ и выполните команду **ls**. Если ключ присутствует, его можно скопировать, выполнив следующую команду:

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/image2-public-key.png)

На этом этапе обратитесь в отдел по управлению службами SAP HANA в Azure и предоставьте открытый ключ. Уполномоченный представитель зарегистрирует его в базовой инфраструктуре хранилища, созданной для вашего клиента крупного экземпляра HANA.

### <a name="step-4-create-an-sap-hana-user-account"></a>Этап 4. Создание учетной записи пользователя SAP HANA

Чтобы иметь возможность инициировать создание моментальных снимков SAP HANA, необходимо создать пользователя в SAP HANA, который может использоваться сценариями создания моментальных снимков хранилища. Для этих целей создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Предоставьте ей привилегии _администратора резервного копирования_ и _права на чтение каталогов_. В этом примере мы создали имя пользователя SCADMIN. В имени учетной записи пользователя, созданной в HANA Studio, учитывается регистр знаков.  Обязательно щелкните "No" (Нет) в ответ на запрос, требовать ли от пользователя изменение пароля при следующем входе в систему.

![Создание пользователя в HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image3-creating-user.png)

### <a name="step-5-authorize-the-sap-hana-user-account"></a>Этап 5. Авторизация учетной записи пользователя SAP HANA

На этом шаге необходимо авторизовать созданную учетную запись SAP HANA, чтобы сценариям не приходилось отправлять пароли во время выполнения. Команда SAP HANA `hdbuserstore` позволяет создать ключ пользователя SAP HANA, который хранится на одном или нескольких узлах SAP HANA, и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания сценария, описанном ниже, не нужно заботиться об управлении паролями).

>[!IMPORTANT]
>Выполните следующую команду от имени `root`: В противном случае скрипт не будет работать должным образом.

Введите команду `hdbuserstore`, как показано ниже.

![Ввод команды hdbuserstore](./media/hana-overview-high-availability-disaster-recovery/image4-hdbuserstore-command.png)

В следующем примере используются пользователь SCADMIN01, имя узла lhanad01 и номер экземпляра 01. В этом случае команда выглядит следующим образом.
```
hdbuserstore set SCADMIN01 lhanad01:30115 <backup username> <password>
```
При наличии конфигурации развертывания SAP HANA следует управлять всеми сценариями посредством одного сервера. В этом примере ключ SAP HANA пользователя SCADMIN01 необходимо изменить для каждого узла. Этот ключ должен отражать узел, связанный с ним. Это означает, что в учетной записи резервного копирования SAP HANA нужно изменить номер экземпляра для базы данных HANA. Предоставьте ключу права администратора на узле, которому он назначен, а пользователю резервного копирования, используемому для масштабирования, — права на доступ ко всем экземплярам SAP HANA. Если развертываются узлы lhanad01, lhanad02 и lhanad03, то последовательность команд будет выглядеть следующим образом.

```
hdbuserstore set SCADMIN01 lhanad01:30115 SCADMIN <password>
hdbuserstore set SCADMIN02 lhanad02:30215 SCADMIN <password>
hdbuserstore set SCADMIN03 lhanad03:30315 SCADMIN <password>
```

### <a name="step-6-get-snapshot-scripts-configure-snapshots-and-test-configuration-and-connectivity"></a>Шаг 6. Получение сценариев создания моментальных снимков, настройка моментальных снимков, тестирование конфигурации и возможностей подключения

Скачайте последнюю версию сценариев [отсюда](https://github.com/Azure/hana-large-instances-self-service-scripts). Скопируйте скачанные сценарии и текстовый файл в рабочую папку для **hdbsql**. Для текущих установок HANA это каталог вида /hana/shared/D01/exe/linuxx86\_64/hdb.
```
azure\_hana\_backup.pl
azure\_hana\_replication\_status.pl
azure\_hana\_snapshot\_details.pl
azure\_hana\_snapshot\_delelte.pl
testHANAConnection.pl
testStorageSnapshotConnection.pl
removeTestStorageSnapshot.pl
HANABackupCustomerDetails.txt
```

Ниже приведено назначение различных сценариев и файлов.

- **azure\_hana\_backup.pl**. Этот сценарий необходимо запланировать с помощью Cron, чтобы создавать моментальные снимки хранилища томов HANA data/log/shared, тома /hana/logbackups или операционной системы (для номеров SKU типа I крупных экземпляров HANA).
- **azure\_hana\_replication\_status.pl**. Этот сценарий предназначен для передачи основных сведений о состоянии репликации с рабочего сайта на сайт аварийного восстановления.  Данный сценарий используется для отслеживания выполнения репликации. Он отображает размеры реплицируемых элементов.  Он также предоставляет инструкции в случае, если репликация выполняется слишком долго или возникла вероятность того, что канал не работает.
- **azure\_hana\_snapshot\_details.pl**. Этот сценарий предоставляет клиенту список основных сведений о всех моментальных снимках на каждом томе, существующем в вашей среде. Данный сценарий может выполняться на сервере-источнике или на экземпляре сервера в расположении аварийного восстановления. Этот сценарий предоставляет приведенные ниже сведения с разбивкой по томам, содержащим моментальные снимки: общий размер моментальных снимков на томе; затем для каждого снимка на этом томе указывается имя, время создания, размер, частота создания и идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо).
- **azure\_hana\_snapshot\_delelte.pl**. Этот сценарий предназначен для удаления моментального снимка хранилища или набора моментальных снимков с помощью идентификатора резервного копирования SAP HANA, указанного в HANA Studio, или имени моментального снимка хранилища.  В настоящее время идентификатор резервного копирования привязывается только к моментальным снимкам, созданным для томов HANA data/log/shared.  В противном случае, если ввести идентификатор моментального снимка, будет выполнен поиск всех моментальных снимков, которые соответствуют введенному идентификатору.  
- **testHANAConnection.pl**. Этот сценарий проверяет подключение к экземпляру SAP HANA. Он необходим для настройки моментальных снимков хранилища.
- **testStorageSnapshotConnection.pl**. У этого сценария две цели. Во-первых, он позволяет убедиться, что у единицы крупного экземпляра HANA, который выполняет сценарии, имеется доступ к назначенной виртуальной машине хранилища и, следовательно, к интерфейсу моментальных снимков хранилища крупных экземпляров HANA. Во-вторых, он предназначен для создания временного моментального снимка тестируемого экземпляра HANA. Этот сценарий нужно выполнить для каждого экземпляра HANA на сервере, чтобы убедиться, что сценарии резервного копирования работают должным образом.
- **removeTestStorageSnapshot.pl**. Этот сценарий используется для удаления тестового моментального снимка, созданного с помощью сценария testStorageSnapshotConnection.pl. 
- **HANABackupCustomerDetails.txt**. Это редактируемый файл конфигурации, который необходимо изменить, чтобы адаптировать конфигурацию SAP HANA.

 
HANABackupCustomerDetails.txt — файл параметров и конфигурации сценария, создающего моментальные снимки хранилища. Необходимо настроить этот файл в соответствии с собственными задачами и конфигурацией. После развертывания экземпляров отдел по управлению службами SAP HANA в Azure должен был предоставить _имя резервной копии хранилища_ и _IP-адрес хранилища_. Порядок, упорядочение переменных или интервал между ними в файле изменять нельзя. В противном случае сценарий не будет работать должным образом. Кроме того, вы получили IP-адрес узла увеличения масштаба или главного узла (в случае развертывания) от отдела по управлению службами SAP HANA в Azure. После установки SAP HANA вам также известен номер экземпляра HANA, и вам необходимо добавить имя резервного копирования в файл конфигурации.

После ввода имени резервной копии хранилища и IP-адрес хранилища для увеличения масштаба или масштабного развертывания файл конфигурации выглядит следующим образом. Далее потребуется ввести IP-адрес отдельного узла или главного узла, номер экземпляра HANA и имя резервной копии, которое можно будет выбрать.
```
#Provided by Microsoft Service Management
Storage Backup Name: client1hm3backup
Storage IP Address: 10.240.20.31
#Node IP addresses, instance numbers, and HANA backup name
#provided by customer.  HANA backup name created using
#hdbuserstore utility.
Node 1 IP Address: 
Node 1 HANA instance number:
Node 1 HANA Backup Name:
```

>[!NOTE]
>В настоящее время в фактическом скрипте создания моментальных снимков хранилища HANA используются только сведения об узле 1. Мы советуем проверить доступ ко всем узлам HANA и из них. Так вы сможете убедиться, что в случае возможного изменения главного узла резервного копирования любой другой узел сможет занять его место за счет изменения сведений в узле 1.

Поместив все данные конфигурации в файл HANABackupCustomerDetails.txt, необходимо проверить правильность конфигурации в отношении данных экземпляра HANA с помощью сценария testHANAConnection.pl. Этот сценарий не зависит от конфигурации развертывания или масштабирования SAP HANA.

```
testHANAConnection.pl
```

При наличии конфигурации развертывания SAP HANA убедитесь, что основной экземпляр HANA имеет доступ ко всем необходимым серверам и экземплярам HANA. В тестовом сценарии отсутствуют параметры, но для его надлежащего выполнения необходимо завершить добавление своих данных в файл конфигурации HANABackupCustomerDetails.txt. Этот скрипт не поддерживает поиск ошибок в каждом отдельном экземпляре, так как возвращаются только коды ошибок в команде оболочки. Однако он предоставляет некоторые полезные сведения, которые нужно тщательно проверить.

Выполните следующее, чтобы запустить этот сценарий.
```
 ./testHANAConnection.pl
```
Если в результате выполнения скрипта возвращается состояние экземпляра HANA, отобразится сообщение об успешном подключении к HANA.


Следующий шаг теста — проверка подключения к хранилищу на основе данных, помещенных в файл конфигурации HANABackupCustomerDetails.txt, и создание тестового моментального снимка.  Этот тест необходимо выполнить перед выполнением сценария azure\_hana\_backup.pl. Если на томе отсутствуют моментальные снимки, то невозможно определить: том просто пустой или при получении сведений о моментальных снимках произошла ошибка SSH. По этой причине выполнение скрипта состоит из двух этапов:

- Он проверяет, доступна ли виртуальная машина и интерфейсы клиента сценариям для создания моментальных снимков хранилища.
- создание тестового (фиктивного) моментального снимка для каждого тома экземпляра HANA.

Из-за этого экземпляр HANA добавляется в качестве аргумента. В случае сбоя выполнения нет возможности проверить ошибки подключения к хранилищу. Однако в таких случаях сценарий предоставляет полезные указания.

Скрипт выполняется как:
```
 ./testStorageSnapshotConnection.pl <HANA SID>
```
В качестве следующего шага сценарий попытается войти в хранилище с помощью открытого ключа, предоставленного во время установки, и данных, настроенных в файле HANABackupCustomerDetails.txt. При успешном входе возвращается следующее содержимое.

```
**********************Checking access to Storage**********************
Storage Access successful!!!!!!!!!!!!!!
```

Если при подключении к консоли хранилища возникнут проблемы, то выходные данные будут выглядеть следующим образом.

```
**********************Checking access to Storage**********************
WARNING: Storage check status command 'volume show -type RW -fields volume' failed: 65280
WARNING: Please check the following:
WARNING: Was publickey sent to Microsoft Service Team?
WARNING: If passphrase entered while using tool, publickey must be re-created and passphrase must be left blank for both entries
WARNING: Ensure correct IP address was entered in HANABackupCustomerDetails.txt
WARNING: Ensure correct Storage backup name was entered in HANABackupCustomerDetails.txt
WARNING: Ensure that no modification in format HANABackupCustomerDetails.txt like additional lines, line numbers or spacing
WARNING: ******************Exiting Script*******************************
```

После успешного входа в интерфейсы виртуальной машины хранилища этот сценарий перейдет к этапу 2 и создаст тестовый моментальный снимок, как показано ниже, для конфигурации масштабирования трех узлов SAP HANA.

```
**********************Creating Storage snapshot**********************
Taking snapshot testStorage.recent for hana_data_hm3_mnt00001_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00001_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00002_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00002_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00003_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00003_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_backups_hm3_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_backups_hm3_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_hm3_mnt00001_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_hm3_mnt00002_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_hm3_mnt00003_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_shared_hm3_t020_vol ...
Snapshot created successfully.
```

Если сценарию удастся успешно создать тестовый моментальный снимок, можно будет продолжить настройку действительных моментальных снимков хранилища. В противном случае потребуется изучить проблемы, прежде чем продолжить. Созданный тестовый моментальный снимок следует хранить, пока не будут созданы первые настоящие моментальные снимки.



### <a name="step-7-perform-snapshots"></a>Шаг 7. Создание моментальных снимков

По завершении всех этапов подготовки можно начать настройку действительной конфигурации моментальных снимков хранилища. Сценарий, выполнение которого следует запланировать, работает с конфигурациями увеличения масштаба и развертывания SAP HANA. Суть метода заключается в планировании выполнения сценариев с помощью Cron. 

Можно создать резервные копии моментальных снимков трех типов:
- HANA: объединенное резервное копирование моментальных снимков, при котором тома, содержащие /hana/data, /hana/log, /hana/shared (который также содержит /usr/sap), охватываются скоординированным моментальным снимком. Из этого моментального снимка можно восстановить отдельный файл.
- Журналы: резервное копирование моментальных снимков тома /hana/logbackups. Для создания этого моментального снимка хранилища не активируется создание моментального снимка HANA. Данный том хранилища — это том, предназначенный для хранения резервных копий журналов транзакций SAP HANA, которые создаются часто, чтобы ограничить рост журналов и избежать потенциальной потери данных. Из этого моментального снимка можно восстановить отдельный файл. Не следует задавать частоту меньше пяти минут.
- Загрузка: моментальный снимок тома, содержащего загрузочный логический номер устройства (LUN) крупного экземпляра HANA. Создание этой резервной копии моментального снимка возможна только для номеров SKU типа I крупных экземпляров HANA. Из моментального снимка тома, который содержит загрузочный логический номер устройства, невозможно восстанавливать отдельные файлы.  


Ниже приведен синтаксис вызова для этих трех типов моментальных снимков.
```
HANA backup covering /hana/data, /hana/log, /hana/shared (includes/usr/sap)
./azure_hana_backup.pl hana <HANA SID> manual 30

For /hana/logbackups snapshot
./azure_hana_backup.pl logs <HANA SID> manual 30

For snapshot of the volume storing the boot LUN
./azure_hana_backup.pl boot manual 30

```

Необходимо указать следующие параметры.

- Первый указываемый параметр определяет тип резервной копии моментального снимка. Его допустимые значения: hana, logs и boot.
- Второе значение — идентификатор безопасности HANA (например, HM3). Этот параметр не требуется для создания резервной копии загрузочного тома.
- Третий параметр — метка резервной копии для типа моментального снимка. Ожидается, что он остается одинаковым для запланированных моментальных снимков определенного типа или с определенной частотой создания.
- Четвертый параметр косвенно определяет срок хранения моментальных снимков. Он задает количество хранимых моментальных снимков с одинаковым префиксом (меткой). Этот параметр важен для запланированного выполнения с помощью Cron. 

В случае развертывания сценарий выполняет дополнительные проверки доступа ко всем серверам HANA. Перед выполнением дальнейших действий по созданию моментального снимка SAP HANA с последующим созданием моментального снимка хранилища все экземпляры HANA должны вернуть соответствующее состояние.

Сценарий azure\_hana\_backup.pl создает моментальный снимок хранилища, выполняя три отдельных этапа:

- создание моментального снимка SAP HANA;
- создание моментального снимка хранилища;
- удаление моментального снимка SAP HANA, который был создан перед созданием моментального снимка хранилища.

Выполните скрипт, вызвав его из выполняемой папки HDB, в которую он был скопирован. 

Срок хранения регулируется количеством моментальных снимков. Это значение задается как параметр во время выполнения сценария (например, 30 в примере выше). Поэтому срок хранения моментальных снимков хранилища — это функция периода выполнения и количества моментальных снимков, переданного в качестве параметра при выполнении сценария. Если число моментальных снимков превышает значение, заданное с помощью параметра при выполнении сценария, то перед созданием следующего моментального снимка удаляется самый старый моментальный снимок такой же меткой (_manual_ в описанном выше случае). Это означает, что количество хранимых моментальных снимков можно задать в последнем параметре вызова. С его помощью можно также косвенно управлять дисковым пространством, используемым для моментальных снимков. 

>После изменения метки отсчет начинается сначала. Это означает, что необходимо придерживаться строгих правил относительно меток.

### <a name="snapshot-strategies"></a>Стратегии моментальных снимков
Частота создания моментальных снимков для различных типов зависит от того, используются ли функции аварийного восстановления крупного экземпляра HANA. Так как функции аварийного восстановления крупных экземпляров HANA основываются на моментальных снимках хранилища, можно применить некоторые рекомендации относительно частоты и периодов создания моментальных снимков хранилища. В приведенных ниже рекомендациях предполагается, что вы НЕ используете функции аварийного восстановления, которые предлагают крупные экземпляры HANA. Предполагается, что вместо этого вы используете моментальные снимки хранилища в качестве средства резервного копирования и имеете возможность выполнить восстановление на определенный момент времени за последние 30 дней. Учитывая ограничения количества моментальных снимков и дискового пространства, клиенты учли следующие типы требований.

- Требования к RTO для восстановления на определенный момент времени.
- Использование пространства.
- Требования к целевой точке восстановления и целевому времени восстановления в случае возможного аварийного восстановления.
- Последующее выполнение полного резервного копирования базы данных HANA на диски. При выполнении полного резервного копирования базы данных на диски (или в интерфейс _backint_) создание моментальных снимков хранилища завершается сбоем. Если вы хотите выполнить полное резервное копирование базы данных на основе моментальных снимков хранилища, отключите на это время создание этих моментальных снимков.
- Количество моментальных снимков на том не может превышать 255.


Для клиентов, которые не используют функции аварийного восстановления крупных экземпляров HANA, частота создания моментальных снимков ниже. В таких случаях мы видим, что клиенты создают объединенные моментальные снимки томов /hana/data, /hana/log и /hana/shared (включая /usr/sap) за 12- или 24-часовой период и сохраняют эти моментальные снимки, чтобы охватить весь месяц. То же самое относится к моментальным снимкам тома резервных копий журналов. В то же время создание резервных копий журналов транзакций SAP HANA на томе резервных копий журналов выполняется за 5–15 минут.

Мы настоятельно советуем настроить плановое создание моментальных снимков хранилища с помощью средства Cron. Кроме того, мы советуем использовать один скрипт для создания всех резервных копий и аварийного восстановления (в этом случае нужно изменять входные данные скрипта в соответствии со временем резервного копирования). Создание этих моментальных снимков планируется на разное время в Cron, в зависимости от параметров времени выполнения: каждый час, каждые 12 часов, каждый день или каждую неделю. 

Ниже приведен пример расписания Cron в /etc/crontab.
```
00 1-23 * * * ./azure_hana_backup.pl hana HM3 hourlyhana 46
10 00 * * *  ./azure_hana_backup.pl hana HM3 dailyhana 28
00,05,10,15,20,25,30,35,40,45,50,55 * * * *  Perform SAP HANA transaction log backup
22 12 * * *  ./azure_hana_backup.pl log HM3 dailylogback 28
30 00 * * *  ./azure_hana_backup.pl boot dailyboot 28
```
В приведенном выше примере создается ежечасный объединенный моментальный снимок, который охватывает тома, содержащие расположения /hana/data, /hana/log и /hana/shared (включая /usr/sap). Моментальный снимок этого типа будет использоваться для ускорения восстановления на определенный момент времени в пределах двух дней. Кроме того, предусмотрено создание ежедневного моментального снимка этих томов. Таким образом вы охватили два дня ежечасными моментальными снимками и четыре недели — ежедневными моментальными снимками. Также один раз в день создается резервная копия тома резервных копий журналов транзакций. Эти резервные копии также хранятся четыре недели. Как видно в третьей строке crontab, резервное копирование журнала транзакций HANA запланировано с интервалом в пять минут. Вы также понимаете, что минуты запуска различных заданий Cron, которые создают моментальные снимки хранилища, заданы поочередно таким образом, чтобы эти моментальные снимки никогда не создавались одновременно. 

В приведенном ниже примере раз в час создавался бы объединенный моментальный снимок, который охватывает тома, содержащие расположения /hana/data, /hana/log и /hana/shared (включая /usr/sap). Эти моментальные снимки хранились бы два дня. Моментальные снимки томов резервных копий журналов транзакций создаются каждые пять минут и хранятся в течение четырех часов. Как и прежде, создание резервной копии файла журнала транзакций HANA запланировано с интервалом в пять минут. Моментальный снимок тома резервных копий журналов транзакций создается с задержкой в две минуты после начала резервного копирования журнала транзакций. В течение этих двух минут в обычных условиях резервное копирование журнала транзакций SAP HANA завершается. Как и ранее, резервное копирование тома, содержащего загрузочный логический номер устройства, выполняется один раз в день: создается моментальный снимок хранилища, который хранится приблизительно четыре недели.

```
10 0-23 * * * ./azure_hana_backup.pl hana HM3 hourlyhana 48
0,5,10,15,20,25,30,35,40,45,50,55 * * * *  Perform SAP HANA transaction log backup
2,7,12,17,22,27,32,37,42,47,52,57 * * * *  ./azure_hana_backup.pl log HM3 logback 48
30 00 * * *  ./azure_hana_backup.pl boot dailyboot 28
```

На рисунке ниже показаны последовательности операций из примера, приведенного выше, за исключением загрузочного логического номера устройства.

![Связь между резервными копиями и моментальными снимками](./media/hana-overview-high-availability-disaster-recovery/backup_snapshot.PNG)

SAP HANA регулярно записывает данные на том /hana/log, чтобы регистрировать зафиксированные изменения в базе данных. SAP HANA регулярно записывает точку сохранения на том /hana/data. Как указано в crontab, резервная копия журналов транзакций SAP HANA создается каждые пять минут. Кроме того, как видите, в результате активации создания объединенного моментального снимка хранилища, охватывающего тома /hana/data, /hana/log и /hana/shared, каждый час создается моментальный снимок SAP HANA. После успешного создания моментального снимка HANA создается объединенный моментальный снимок хранилища. Как указано в crontab, каждые пять минут, примерно через две минуты после резервного копирования журналов транзакций HANA, создается моментальный снимок хранилища тома /hana/logbackup.


>[!IMPORTANT]
> Резервное копирование SAP HANA на основе моментальных снимков хранилища имеет смысл, только если моментальные снимки создаются совместно с резервными копиями журналов транзакций SAP HANA. Эти резервные копии журналов транзакций должны охватывать временные периоды между моментальными снимками хранилища. 

Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:

- Возможность доступа к объединенному моментальному снимку хранилища, охватывающему расположения /hana/data, /hana/log и /hana/shared, которому должно быть не больше 30 дней.
- Связанные резервные копии журналов транзакций, охватывающие время между всеми объединенными моментальными снимками хранилища. Поэтому наиболее старому моментальному снимку тома резервных копий журналов транзакций должно быть 30 дней. Если только к тому времени вы не скопировали резервные копии журналов транзакций на другой общедоступный ресурс NFS, расположенный в службе хранилища Azure. В этом случае можно получить старые резервные копии журналов транзакций из этого общедоступного ресурса NFS.

Чтобы иметь возможность использовать моментальные снимки хранилища и итоговую репликацию резервных копий журналов транзакций, необходимо изменить расположение, в которое SAP HANA записывает резервные копии журналов транзакций. Это можно сделать в HANA Studio, как показано ниже. Хотя SAP HANA автоматически выполняет резервное копирование сегментов полного журнала, следует указать детерминированный интервал создания резервной копии журнала. Особенно при использовании аварийного восстановления, как правило, требуется создавать резервные копии журналов с детерминированным периодом. В случае, представленном ниже, мы указали интервал резервного копирования журналов, равный 15 минутам.

![Настройка расписания для создания резервных копий журнала SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

Можно выполнять резервные копии намного чаще, чем каждые 15 минут. Особенно при сочетании с аварийным восстановлением. Некоторые клиенты создают резервные копии журналов транзакций каждые пять минут.  

Если резервная копия базы данных еще не создавалась, то последний этап заключается в создании ее файловой резервной копии. Это позволит создать одну запись резервной копии, которая должна находиться в каталоге резервных копий. В противном случае SAP HANA не может инициировать резервное копирование журнала.

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)


После успешного создания первых моментальных снимков можно удалить тестовый моментальный снимок, созданный на шаге 6. Для этого необходимо запустить сценарий removeTestStorageSnapshot.pl, как показано ниже.
```
./removeTestStorageSnapshot.pl <hana instance>
```

### <a name="monitoring-the-number-and-size-of-snapshots-on-the-disk-volume"></a>Мониторинг количества и размера моментальных снимков на томе диска

Количество моментальных снимков и занимаемое ими пространство на определенном томе хранилища можно отслеживать. Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков. Тем не менее команда ОС Linux `du` отображает сведения об этих моментальных снимках хранилища, так как они хранятся на одних и тех же томах. Для этой команды можно указать следующие параметры.

- `du –sh .snapshot` — возвращает общее число моментальных снимков в каталоге моментальных снимков.
- `du –sh --max-depth=1` — выводит список всех моментальных снимков, сохраненных в папке .snapshot, и размер каждого моментального снимка.
- `du –hc` — возвращает общий размер всех моментальных снимков.

Следующие команды предоставляют сведения о создании и хранении моментальных снимков, а также об используемом ими пространстве на томах.

>[!NOTE]
>Приведенная выше команда не отображает моментальные снимки загрузочного логического номера устройства.

### <a name="getting-details-of-snapshots"></a>Получение сведений о моментальных снимках
Чтобы получить дополнительные сведения о моментальных снимках, можно также использовать сценарий azure\_hana\_snapshot\_details.pl. Этот сценарий можно выполнять в любом расположении, если в расположении аварийного восстановления имеется активный сервер. Данный сценарий предоставляет приведенные ниже сведения с разбивкой по томам, содержащим моментальные снимки: общий размер моментальных снимков на томе; затем для каждого снимка на этом томе указывается имя, время создания, размер, частота создания и идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо). Ниже приведен синтаксис выполнения сценария.

```
./azure_hana_snapshot_details.pl 
```

Так как сценарий пытается получить идентификатор резервного копирования HANA, он должен подключиться к экземпляру SAP HANA. Потому необходимо правильно настроить файл конфигурации HANABackupCustomerDetails.txt. Выходные данные двух моментальных снимков тома могут выглядеть следующим образом.

```
**********************************************************
****Volume: hana_shared_SAPTSTHDB100_t020_vol       ***********
**********************************************************
Total Snapshot Size:  411.8MB
----------------------------------------------------------
Snapshot:   customer.2016-09-20_1404.0
Create Time:   "Tue Sep 20 18:08:35 2016"
Size:   2.10MB
Frequency:   customer 
HANA Backup ID:   
----------------------------------------------------------
Snapshot:   customer2.2016-09-20_1532.0
Create Time:   "Tue Sep 20 19:36:21 2016"
Size:   2.37MB
Frequency:   customer2
HANA Backup ID:   
```


### <a name="file-level-restore-from-storage-snapshot"></a>Восстановление уровня файла из моментального снимка хранилища
Моментальные снимки типов hana и logs дают возможность обращаться непосредственно к моментальным снимкам на томах в каталоге .snapshot. В нем можно найти подкаталог для каждого моментального снимка. Из соответствующего подкаталога можно выбрать любой файл, попавший в моментальный снимок и находящийся в состоянии на момент создания снимка, и скопировать его в действительную структуру каталогов.

>[!NOTE]
>Восстановление отдельных файлов не поддерживается для моментальных снимков загрузочного логического номера устройства. Каталог .snapshot не представляется в загрузочном логическом номере устройства. 


### <a name="reducing-the-number-of-snapshots-on-a-server"></a>Уменьшение количества моментальных снимков на сервере

Как упоминалось ранее, количество моментальных снимков, создаваемых с определенным интервалом, можно уменьшить. Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.

```
./azure_hana_backup.pl hana HM3 hanadaily 30
```

В примере выше для моментальных снимков задана метка _customer_, а количество моментальных снимков, которые должны храниться с этой меткой, равно _30_. За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков. Вы можете легко сократить количество моментальных снимков, например до 15, с помощью сценария ниже, указав для последнего параметра значение 15.

```
./azure_hana_backup.pl hana HM3 hanadaily 15
```

Выполнение этого сценария позволяет уменьшить количество моментальных снимков с учетом нового моментального снимка хранилища до _15_. Останутся 15 последних моментальных снимков, тогда как 15 более старых моментальных снимков будут удалены.

 >[!NOTE]
 > Этот сценарий уменьшает количество моментальных снимков, только если имеются моментальные снимки, созданные более часа назад. Он не удаляет моментальные снимки, созданные менее часа назад. Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.

Если больше не требуется хранить набор моментальных снимков с определенной меткой резервной копии (в примерах синтаксиса это hanadaily), можно выполнить сценарий, задав для количества хранимых моментальных снимков значение _0_, чтобы удалить все моментальные снимки с этой меткой. Однако это повлияет на возможности аварийного восстановления.

Второй способ, позволяющий удалить определенные моментальные снимки, включает использование сценария azure\_hana\_snapshot\_delelte.pl. Этот сценарий предназначен для удаления моментального снимка или набора моментальных снимков с помощью идентификатора резервного копирования HANA, указанного в HANA Studio, или имени моментального снимка.  В настоящее время идентификатор резервного копирования привязывается только к моментальным снимкам типа hana. При резервном копировании моментальных снимков типа logs и boot моментальный снимок SAP HANA не создается. Поэтому идентификатор резервного копирования для этих моментальных снимков отсутствует. Если введено имя моментального снимка, то на разных томах будет выполнен поиск всех моментальных снимков, соответствующих этому имени. Ниже приведен синтаксис вызова сценария.

```
./azure_hana_snapshot_delete.pl 

```

Этот сценарий необходимо выполнить от имени _привилегированного_ пользователя.

Если выбрать моментальный снимок, то можно будет удалить моментальные снимки по отдельности. Вам будет предложено сначала указать том, содержащий моментальный снимок, а затем имя моментального снимка. Если моментальный снимок существует на этом томе и ему более одного часа, то он будет удален. Имена томов и моментальных снимков можно узнать, выполнив сценарий azure_hana_snapshot_details. 

>[!IMPORTANT]
>Если в удаляемом моментальном снимке хранятся данные, которые больше нигде не существуют, то удаление приведет к безвозвратной потере этих данных.

   

### <a name="recovering-to-the-most-recent-hana-snapshot"></a>Восстановление до последнего моментального снимка HANA

В случае сбоя рабочей системы, обратившись в службу поддержки Microsoft Azure, вы можете инициировать процесс восстановления из моментального снимка хранилища в качестве инцидента клиента. Подобный непредвиденный сценарий является срочной ситуацией, если данные были удалены из рабочей системы и единственный способ быстро вернуть их — восстановить рабочую базу данных.

С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться на несколько дней вперед. Чтобы спланировать восстановление, можно обратиться в отдел по управлению службами SAP HANA в Azure и поднять высокоприоритетные вопросы. К примеру, вы планируете установить новую версию пакета расширений для программного обеспечения SAP, а затем хотите вернуться до состояния перед обновлением EHP.

Прежде чем подать запрос, необходимо выполнить некоторые подготовительные действия, чтобы отдел по управлению службами SAP HANA в Azure мог обработать запрос и предоставить восстановленные тома, после чего вы сможете восстановить базу данных HANA на основе моментальных снимков. Ниже приведены действия для подготовки к запросу.

>[!NOTE]
>В зависимости от используемого выпуска SAP HANA пользовательский интерфейс может отличаться от следующих снимков экрана.

1. Выберите моментальный снимок, который нужно восстановить. Если не указано другое, будет восстановлен только том hana/data. 

2. Завершите работу экземпляра HANA.

 ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

3. Отключите тома данных на каждом узле базы данных HANA. Если тома данных все еще подключены к операционной системе, восстановление моментального снимка завершится ошибкой.
 ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

4. Отправьте запрос в службу поддержки Azure, чтобы получить указания по восстановлению определенного моментального снимка.

 - Во время восстановления: отдел по управлению службами SAP HANA в Azure может попросить об участии конференц-связи для координации, проверки и подтверждения восстановления правильного моментального снимка хранилища. 

 - После восстановления: отдел по управлению службами SAP HANA в Azure отправит вам оповещение о восстановлении моментального снимка хранилища.

5. Когда процесс восстановления завершится, подключите все тома данных.

 ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)

6. Выберите параметры восстановления в SAP HANA Studio, если они не отобразились автоматически при повторном подключении к базе данных HANA через SAP HANA Studio. В приведенном ниже примере показано, как выполнить восстановление до последнего моментального снимка HANA. Моментальный снимок хранилища внедряет моментальный снимок HANA. При восстановлении до последнего моментального снимка хранилища это будет последний моментальный снимок HANA. (При восстановлении до более старого моментального снимка хранилища найдите моментальный снимок HANA на основе времени создания моментального снимка хранилища.)

 ![Выбор параметров восстановления в SAP HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image10-recover-options-a.png)

7. Установите переключатель **Recover the database to a specific data backup or storage snapshot** (Восстановить базу данных до определенной резервной копии или моментального снимка хранилища).

 ![Окно Specify Recovery Type (Выбор типа восстановления)](./media/hana-overview-high-availability-disaster-recovery/image11-recover-options-b.png)

8. Установите переключатель **Specify backup without catalog** (Указать резервную копию без каталога).

 ![Окно Specify Backup Location (Указание расположения резервной копии)](./media/hana-overview-high-availability-disaster-recovery/image12-recover-options-c.png)

9. В списке **Destination Type** (Тип назначения) выберите **Snapshot** (Моментальный снимок).

 ![Окно Specify the Backup to Recover (Указание резервной копии для восстановления)](./media/hana-overview-high-availability-disaster-recovery/image13-recover-options-d.png)

10. Нажмите кнопку **Finish** (Готово), чтобы запустить процесс восстановления.

 ![Нажатие кнопки Finish (Готово) для запуска процесса восстановления](./media/hana-overview-high-availability-disaster-recovery/image14-recover-options-e.png)

11. Восстановление базы данных HANA выполняется в моментальный снимок HANA, добавленный моментальным снимком хранилища.

 ![Восстановление базы данных HANA в моментальный снимок HANA](./media/hana-overview-high-availability-disaster-recovery/image15-recover-options-f.png)

### <a name="recovering-to-the-most-recent-state"></a>Восстановление до последнего состояния

Здесь описывается восстановление моментального снимка HANA, содержащегося в моментальном снимке хранилища. Затем выполняется восстановление резервных копий журнала транзакций до последнего состояния базы данных перед восстановлением моментального снимка хранилища.

>[!IMPORTANT]
>Прежде чем продолжить, завершите создание цепочки последовательных резервных копий журнала транзакций. Без этих резервных копий невозможно восстановить текущее состояние базы данных.

1. Выполните действия 1–6, описанные в разделе "Восстановление до последнего моментального снимка HANA".

2. Установите переключатель **Recover the database to its most recent state** (Восстановить базу данных до последнего состояния).

 ![Установка переключателя Recover the database to its most recent state (Восстановить базу данных до последнего состояния).](./media/hana-overview-high-availability-disaster-recovery/image16-recover-database-a.png)

3. Укажите расположение последних резервных копий журнала HANA. В этом расположении должны находиться все резервные копии журналов транзакций HANA от моментального снимка HANA до последнего состояния.

 ![Указание расположения последних резервных копий журнала HANA](./media/hana-overview-high-availability-disaster-recovery/image17-recover-database-b.png)

4. Выберите резервную копию, из которой нужно выполнить восстановление базы данных. В нашем примере на снимке экрана показан моментальный снимок HANA, включенный в моментальный снимок хранилища. 

 ![Выбор резервной копии, из которой нужно выполнить восстановление базы данных](./media/hana-overview-high-availability-disaster-recovery/image18-recover-database-c.png)

5. Снимите флажок **Use Delta Backups** (Использовать измененные резервные копии), если в промежуток между созданием моментального снимка HANA и последним состоянием в резервные копии не вносились изменения.

 ![Флажок Use Delta Backups (Использовать измененные резервные копии), который нужно снять, если изменения не вносились](./media/hana-overview-high-availability-disaster-recovery/image19-recover-database-d.png)

6. В окне сводки нажмите кнопку **Finish** (Готово), чтобы запустить процедуру восстановления.

 ![Кнопка Finish (Готово) в окне сводки](./media/hana-overview-high-availability-disaster-recovery/image20-recover-database-e.png)

### <a name="recovering-to-another-point-in-time"></a>Восстановление до другой точки во времени
Чтобы выполнить восстановление на момент между созданием моментального снимка HANA (включенного в моментальный снимок хранилища) и более позднего моментального снимка, выполните следующее:

1. Соберите все резервные копии журнала транзакций от момента создания моментального снимка HANA до момента восстановления.
2. Выполните процедуру, описанную в разделе "Восстановление до последнего состояния".
3. На шаге 2 процедуры в окне **Specify Recovery Type** (Выбор типа восстановления) установите переключатель **Recover the database to the following point in time** (Восстановить базу данных до следующей точки во времени), укажите точку во времени, а затем завершите шаги 3–6.

### <a name="monitoring-the-execution-of-snapshots"></a>Мониторинг создания моментальных снимков

При использовании моментальных снимков хранилища крупных экземпляров HANA необходимо также следить за созданием этих моментальных снимков. При выполнении скрипта создания моментального снимка хранилища выходные данные записываются в файл, а сам файл сохраняется в том же расположении, что и скрипты Perl. Для каждого моментального снимка хранилища записывается отдельный файл. На основе выходных данных в каждом файле можно четко понять различные этапы, которые выполняет скрипт создания моментальных снимков:

- поиск томов, для которых необходимо создать моментальные снимки;
- поиск моментальных снимков этих томов;
- удаление имеющихся моментальных снимков в соответствии с указанным их количеством;
- создание моментального снимка SAP HANA;
- создание моментального снимка хранилища для тома;
- удаление моментального снимка SAP HANA;
- переименование последнего моментального снимка в **.0**.

Наиболее важной частью CAB-файла сценария является следующая:
```
**********************Creating HANA snapshot**********************
Creating the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data create snapshot"" ...
HANA snapshot created successfully.
**********************Creating Storage snapshot**********************
Taking snapshot hourly.recent for hana_data_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_backup_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_shared_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for sapmnt_lhanad01_t020_vol ...
Snapshot created successfully.
**********************Deleting HANA snapshot**********************
Deleting the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data drop snapshot"" ...
HANA snapshot deletion successfully.
```
В этом примере видно, как скрипт записывает создание моментального снимка HANA. В случае горизонтального масштабирования этот процесс инициируется на главном узле. Главный узел инициирует синхронное создание моментальных снимков SAP HANA всех рабочих узлов. Затем создается моментальный снимок хранилища. После создания этого снимка моментальный снимок HANA удаляется. Затем его создание инициируется снова с главного узла.


## <a name="disaster-recovery-principles"></a>Принципы аварийного восстановления
Предоставляя крупные экземпляры HANA, мы предлагаем функции аварийного восстановления между стеками крупных экземпляров HANA в разных регионах Azure. Это означает, что если вы развернете единицы крупного экземпляра HANA в западном регионе Azure "Западная часть США", то сможете использовать единицы крупного экземпляра HANA в регионе "Восточная часть США" как единицы аварийного восстановления. Как упоминалось ранее, аварийное восстановление не настраивается автоматически, так как требует платы за еще одну единицу крупного экземпляра HANA в регионе аварийного восстановления. Конфигурация аварийного восстановления работает с конфигурациями увеличения масштаба и развертывания. 

В развернутых на текущий момент сценариях клиенты использовали единицу в регионе аварийного восстановления для запуска непроизводственных систем, использующих установленный экземпляр HANA. Единица крупного экземпляра HANA должна использовать номер SKU, используемый в производственных целях. Затем требуется заказать дополнительные тома дисков, чтобы использовать их в качестве назначения репликации хранилища из рабочей системы на сайт аварийного восстановления. Тома, которые фактически реплицируются на сайт аварийного восстановления, охватывают:

- hana/data;
- hana/log;
- /hana/shared
- /hana/log/backup (в том числе /usr/sap).


В основе предлагаемых возможностей аварийного восстановления лежат функции репликации хранилища, предоставляемые инфраструктурой крупного экземпляра HANA. Функциональные возможности, используемые на стороне хранилища, — не постоянный поток изменений, реплицируемых в асинхронном режиме по мере внесения изменений в хранилище. Это механизм, в котором используется тот факт, что для этих томов регулярно создаются моментальные снимки. Разница между уже реплицированным моментальным снимком и новым моментальным снимком, который еще не реплицирован, передается на сайт аварийного восстановления и записывается на целевые тома дисков (того же размера, что и рабочие тома). В первый раз требуется перенести все данные тома, после чего объем передаваемых данных сокращается до разницы между моментальными снимками. В результате тома на сайте аварийного восстановления содержат все моментальные снимки томов, созданные на рабочем сайте. В результате этот факт позволяет получить более раннее состояние сс помощью системы аварийного восстановления, чтобы восстановить потерянные данные без отката рабочей системы.

В случаях, когда репликация системы HANA используется на рабочем сайте для обеспечения высокого уровня доступности, реплицируются только тома экземпляра уровня 2 (или реплики). Эта конфигурация может привести к появлению задержки при репликации хранилища на сайт аварийного восстановления в случае, если вы начнете обслуживание или завершите работу экземпляра сервера вторичной реплики (уровень 2) или экземпляра SAP HANA в данном экземпляре сервера. 

>[!IMPORTANT]
>Как и при использовании многоуровневой репликации системы HANA, завершение работы экземпляра HANA уровня 2 или экземпляра сервера будет блокировать репликацию на сайт аварийного восстановления при использовании функций аварийного восстановления крупного экземпляра HANA.


>[!NOTE]
>Функциональные возможности репликации хранилища крупного экземпляра HANA — это зеркальное отображение и репликация моментальных снимков хранилища. Таким образом, если вы не создаете моментальные снимки хранилища, как описывается в разделе о резервном копировании в этом документе, какая-либо репликация на сайт аварийного восстановления будет невозможна. Создание моментальных снимков хранилища является предварительным условием для репликации хранилища на сайт аварийного восстановления.

Чтобы свести к минимуму целевую точку восстановления, в службе крупного экземпляра HANA заданы приведенные ниже интервалы репликации.
- Тома, охватываемые объединенным моментальным снимком (типа hana), реплицируются каждые 15 минут на эквивалентные целевые тома хранилища на сайте аварийного восстановления.
- Тома резервных копий журналов (типа logs) реплицируются каждые 3 минуты на эквивалентные целевые тома хранилища на сайте аварийного восстановления.

Чтобы свести к минимуму целевую точку восстановления, необходимо настроить следующее.
- Создание моментального снимка хранилища типа hana (см. "Шаг 7. Создание моментальных снимков") каждые 30–60 минут.
- Создание резервных копий журналов транзакций SAP HANA каждые 5 минут.
- Создание моментального снимка хранилища типа logs каждые 5–15 минут. Благодаря такому периоду можно будет достичь целевой точки восстановления в 15–25 минут.

При такой конфигурации последовательность создания резервных копий журналов транзакций, моментальных снимков хранилища, а также репликации тома резервных копий журналов транзакций HANA и томов hana/data, /hana/log и /hana/shared (в том числе /usr/sap) может выглядеть, как показано на рисунке.

 ![Связь между созданием и зеркальным отображением моментального снимка резервной копии журналов транзакций по оси времени](./media/hana-overview-high-availability-disaster-recovery/snapmirror.PNG)

Чтобы еще больше улучшить значение целевой точки восстановления в случае аварийного восстановления, можно скопировать резервные копии журналов транзакций HANA из SAP HANA в Azure (крупные экземпляры) и переместите их в другой регион Azure. Чтобы таким образом дополнительно сократить значение целевой точки восстановления, выполните примерно следующее.

1. Выполняйте резервное копирование журналов транзакций HANA на том /hana/logbackups с максимально возможной частотой.
2. С помощью rsync скопируйте готовые резервные копии журналов транзакций в общедоступный ресурс NFS, в котором размещены виртуальные машины Azure, находящихся в виртуальны сетях Azure в рабочем регионе Azure и регионах аварийного восстановления. Необходимо подключить обе виртуальные сети Azure к каналу ExpressRoute, соединяющему рабочие крупные экземпляры HANA в Azure (см. рисунки в разделе требований к аварийному восстановлению этого документа). 
3. Храните резервные копии журналов транзакций в этом регионе на виртуальной машине, подключенной к экспортированному хранилищу NFS.
4. В случае аварийной отработки отказа дополните резервные копии журналов транзакций, хранящиеся на томе /hana/logbackups, более новыми резервными копиями журналов транзакций из общедоступного ресурса NFS на сайте аварийного восстановления. 
5. Теперь можно начать восстановление резервной копии журналов транзакций до последней резервной копии, которую удалось сохранить в регионе аварийного восстановления.

## <a name="disaster-recovery-fail-over-procedure"></a>Процедура отработки отказа при аварийном восстановлении
Если требуется выполнить отработку отказа на сайт аварийного восстановления, то нужно следовать процедуре обращения в отдел эксплуатации SAP HANA в Azure. В общем этот процесс выглядит следующим образом.

- Так как на единице аварийного восстановления крупных экземпляров HANA запущен непроизводственный экземпляр HANA, необходимо завершить работу этого экземпляра. Мы предполагаем наличие предварительно установленного неактивного рабочего экземпляра HANA.
- Необходимо убедиться в том, что никакие процессы SAP HANA больше не запущены. Проверить это можно с помощью команды: /usr/sap/hostctrl/exe/sapcontrol -nr <HANA instance number> -function GetProcessList. В выходных данных должен быть указан остановленный процесс hdbdaemon и должны отсутствовать какие-либо другие работающие или запущенные процессы HANA.
- Необходимо проверить имя моментального снимка или идентификатор резервного копирования SAP HANA для восстановления данных с сайта аварийного восстановления. В реальных ситуациях аварийного восстановления, как правило, это последний моментальный снимок. Однако вы можете оказаться в ситуации, когда необходимо восстановить потерянные данные. Поэтому потребуется выбрать более ранний снимок.
- Необходимо обратиться к отделу по управлению службами SAP HANA в Azure, отправив запрос на техническую поддержку с высоким приоритетом, и запросить восстановление с помощью этого моментального снимка и идентификатора резервного копирования HANA на сайте аварийного восстановления. На стороне отдела эксплуатации произойдет следующее.
    - Репликация моментальных снимков из рабочего тома на тома аварийного восстановления останавливается. Возможно, это уже произошло из-за сбоя рабочего сайта.
    - Выбранный моментальный снимок или идентификатор резервного копирования используется для восстановления данных на томах аварийного восстановления.
    - После завершения восстановления данных тома аварийного восстановления становятся доступны для подключения к единицам крупных экземпляров HANA в регионе аварийного восстановления.
- Следующий шаг выполняется на стороне клиента. Необходимо подключить тома аварийного восстановления к единице крупного экземпляра HANA на сайте аварийного восстановления. 
- Затем можно запустить до сих неактивный рабочий экземпляр SAP HANA.
- Если вы решили дополнительно скопировать резервные копии журналов транзакций, чтобы уменьшить значение целевой точки восстановления, необходимо объединить эти резервные копии в только что подключенном каталоге аварийного восстановления /hana/logbackups. Не перезаписывайте существующие резервные копии, а просто скопируйте более новые, которые еще не были реплицированы хранилищем.

Следующая последовательность действий включает в себя восстановление рабочего экземпляра SAP HANA на основе восстановленного моментального снимка хранилища и доступных резервных копий журналов транзакций. Эти действия приведены ниже.

Измените расположение резервных копий на /hana/logbackups с помощью SAP HANA Studio, как показано ниже: ![Изменение расположения резервных копий для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/change_backup_location_dr1.png).

SAP HANA проверит расположения файлов резервных копий и предложит для восстановления самую последнюю резервную копию журналов транзакций. Проверка может занять несколько минут, после чего отобразится экран, как показано ниже: ![Список резервных копий журналов транзакций для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/backup_list_dr2.PNG).

На следующем шаге необходимо настроить несколько параметров по умолчанию.

- Снимите флажок **Use Delta Backups** (Использовать разностные резервные копии).
- Установите флажок **Initialize Log Area** (Инициализировать область журнала), как показано ниже.

 ![Настройка инициализации области журнала](./media/hana-overview-high-availability-disaster-recovery/initialize_log_dr3.PNG)

На следующем экране нажмите кнопку **Finish** (Готово), как показано ниже.

 ![Завершение аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/finish_dr4.PNG)

Должно появиться окно хода выполнения, как показано ниже. Помните, что в примере выполняется аварийное восстановление развернутой 3-узловой конфигурации SAP HANA.

 ![Ход восстановления](./media/hana-overview-high-availability-disaster-recovery/restore_progress_dr5.PNG)

В случаях, когда кажется, что восстановление на завершающем экране остановилось и не отображается на экране хода выполнения, проверьте, все ли экземпляры SAP HANA на рабочих узлах выполняются. При необходимости запустите экземпляры SAP HANA вручную.


### <a name="fail-back-from-dr-to-production-site"></a>Восстановление размещения с сайта аварийного восстановления на рабочий сайт
Мы предполагаем, отработка отказа на сайт аварийного восстановления была вызвана проблемами в рабочем регионе Azure, а не вашей потребностью вернуть потерянные данные. То есть теперь вы находитесь на рабочем сайте или (уже некоторое время) на сайте аварийного восстановления. После устранения проблем на рабочем сайте вы хотите восстановить размещение на нем. Так как потеря данных недопустима, возвращение на рабочий сайт включает в себя несколько действий и тесное взаимодействие с отделом эксплуатации SAP HANA в Azure. Именно клиент должен запросить у отдела эксплуатации синхронизацию на рабочий сайт после устранения проблем.

Последовательность действий при этом примерно следующая.

- Отдел эксплуатации SAP HANA в Azure получает сигнал для синхронизации томов рабочего хранилища из томов хранилища аварийного восстановления, которые теперь представляют состояние рабочего сайта. В этом состоянии работа единицы крупного экземпляра HANA на рабочем сайте завершена
- Отдел эксплуатации SAP HANA в Azure отслеживает репликацию и обеспечивает актуальность данных, прежде чем информирует клиента.
- Необходимо завершить работу приложений, которые используют рабочий экземпляр HANA на сайте аварийного восстановления. Затем создайте резервную копию журналов транзакций HANA и остановите экземпляр HANA, запущенный на единицах крупного экземпляра HANA на сайте аварийного восстановления.
- После завершения работы экземпляра HANA, работавшего на единице крупного экземпляра HANA на сайте аварийного восстановления, отделу эксплуатации необходимо вручную повторно синхронизировать тома дисков.
- Отдел эксплуатации SAP HANA в Azure снова запустит единицу крупного экземпляра HANA на рабочем сайте и передаст ее вам. Убедитесь, что в момент запуска единицы крупного экземпляра HANA работа экземпляра SAP HANA завершена.
- Теперь нужно выполнить те же действия по восстановлению базы данных, которые вы выполняли ранее при отработке отказа на сайт аварийного восстановления.

### <a name="monitoring-disaster-recovery-replication"></a>Наблюдение за репликацией для аварийного восстановления

Можно наблюдать за состоянием процесса репликации хранилища, выполнив сценарий azure\_hana\_replication\_status.pl. Этот сценарий должен быть выполнен в единице, работающей в расположении аварийного восстановления. В противном случае он не будет работать должным образом. Сценарий работает независимо от того, активна ли репликация. Этот сценарий может выполняться для каждой единицы крупного экземпляра HANA вашего клиента в расположении аварийного восстановления. С его помощью невозможно получить сведения о загрузочном томе.

Вызовите сценарий следующим образом.
```
./replication_status.pl <HANA SID>
```

Выходные данные разбиты по томам на следующие разделы:  

- состояние канала;
- текущая операция репликации;
- последний реплицированный моментальный снимок; 
- размер последнего моментального снимка;
- текущий интервал задержки между последней выполненной репликацией моментального снимка и текущим моментом.  

Если канал между расположениями не находится в неработоспособном состоянии или в данный момент не выполняется отработка отказа, то отображается состояние канала "Active" (Активный). Под операцией репликации подразумевается репликация каких-либо данных, которая выполняется сейчас либо неактивна, а также другие операции с каналом, выполняемые в данный момент. В качестве последнего реплицированного моментального снимка должен отображаться только "snapmirror…". Затем отображается размер последнего моментального снимка. Наконец, отображается интервал задержки. Интервал задержки — это разница между временем завершения репликации и запланированным временем репликации. Интервал задержки может составлять больше часа для репликации данных, особенно при первоначальной репликации, даже если репликация запущена. Интервал задержки будет увеличиваться, пока не будет завершена текущая репликация.

Пример выходных данных может следующим образом.

```
hana_data_hm3_mnt00002_t020_dp
-------------------------------------------------
Link Status: Broken-Off
Current Replication Activity: Idle
Latest Snapshot Replicated: snapmirror.c169b434-75c0-11e6-9903-00a098a13ceb_2154095454.2017-04-21_051515
Size of Latest Snapshot Replicated: 244KB
Current Lag Time between snapshots: -   ***Less than 90 minutes is acceptable***
```












