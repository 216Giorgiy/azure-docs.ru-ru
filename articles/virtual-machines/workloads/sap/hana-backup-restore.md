---
title: Резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Узнайте, как выполнять резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры).
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: jeconnoc
editor: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/28/2018
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 04da80cd5c30d0556dc681b7bff412391aa2bcda
ms.sourcegitcommit: 5839af386c5a2ad46aaaeb90a13065ef94e61e74
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/18/2019
ms.locfileid: "58107735"
---
# <a name="backup-and-restore"></a>Архивация и восстановление

>[!IMPORTANT]
>Эта документация не заменяет документацию по администрированию SAP HANA или примечания SAP. Предполагается, что читатель хорошо понимает принципы администрирования и эксплуатации SAP HANA, особенно принципы резервного копирования, восстановления, обеспечения высокой доступности и аварийного восстановления. В этой документации показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Очень важно выполнять шаги и процессы в собственной среде и собственных версиях и выпусках HANA. Некоторые сведения, приведенные в этой документации, упрощены для более понятного общего представления и не предназначены для использования в качестве подробных действий для эксплуатационных справочников. Чтобы создать эксплуатационные справочники конкретной конфигурации, необходимо протестировать, выполнить и задокументировать процессы, связанные с ней. 

При работе с базами данных очень важно защитить их от различных событий, которые приводят к сбоям. Эти события могут возникать как в результате стихийных бедствий, так и из-за стандартных ошибок пользователей.

Резервное копирование базы данных с возможностью восстановления до любой точки во времени (например, перед удалением важных данных) обеспечивает восстановление базы данных до состояния, максимально приближенного к состоянию перед сбоем.

Для получения оптимальных результатов выполните следующие два типа резервного копирования:

- резервное копирование баз данных — полные, добавочные или разностные резервные копии;
- резервное копирование журналов транзакций.

Кроме полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища. Эти снимки не заменяют резервные копии журналов транзакций. Резервные копии журналов транзакций по-прежнему важны при восстановлении базы данных до определенной точки во времени и очистке журналов от уже зафиксированных транзакций. Однако моментальные снимки хранилища могут ускорить восстановление, быстро предоставив образ наката для базы данных. 

SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.

- Модель "Сделай сам". Чтобы обеспечить достаточный объем пространства на дисках, после вычисления выполните полное резервное копирование базы данных и журналов, используя один из приведенных методов резервного копирования дисков. Вы можете выполнить резервное копирование напрямую на тома, подключенные к единицам крупных экземпляров HANA, или сетевые файловые ресурсы (NFS), настроенные на виртуальной машине Azure. В последнем случае клиенты настраивают виртуальную машину Linux в Azure, подключают к ней службу хранилища Azure и предоставляют общий доступ к хранилищу через настроенный NFS-сервер на этой виртуальной машине. При выполнении резервного копирования с использованием томов, подключенных непосредственно к единицам крупных экземпляров HANA, резервные копии должны быть скопированы в учетную запись хранения Azure (после того как вы настроите виртуальную машину Azure, которая экспортирует общедоступные ресурсы NFS на основе службы хранилища Azure). Кроме того, их можно скопировать в резервное хранилище Azure или в автономное неструктурированное защищенное хранилище Azure. 

   Для хранения резервных данных после их копирования в учетную запись хранения Azure можно также использовать стороннее средство защиты данных. Кроме того, может потребоваться самостоятельное решение для резервного копирования данных, которые нужно долго хранить для соблюдения нормативных требований и аудита. Во всех случаях резервные копии копируются в общедоступные ресурсы NFS, представленные с помощью виртуальной машины и службы хранилища Azure.

- Функции резервного копирования и восстановления, предоставленные инфраструктурой. Вы можете использовать функции резервного копирования и восстановления, предоставленные базовой инфраструктурой SAP HANA в Azure (крупные экземпляры). Этот вариант удовлетворяет потребность в резервном копировании и быстром восстановлении. В остальной части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA. В этом разделе также рассматривается связь резервного копирования и восстановления с возможностями аварийного восстановления, предоставляемыми крупными экземплярами HANA.

> [!NOTE]
>   Технология моментальных снимков, используемая в базовой инфраструктуре крупных экземпляров HANA, зависит от моментальных снимков SAP HANA. Сейчас моментальные снимки SAP HANA не работают в сочетании с несколькими клиентами контейнеров мультитенантных баз данных SAP HANA. Если развернут только один клиент, тогда эти снимки можно применить и этот метод можно использовать.

## <a name="using-storage-snapshots-of-sap-hana-on-azure-large-instances"></a>Использование моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры)

Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища томов. Поддерживается резервное копирование и восстановление тома, но следует учитывать следующее.

- Вместо полных резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.
- При активации создания моментальных снимков томов /hana/data и /hana/shared (включая /usr/sap) технология создания моментального снимка хранилища запускает создание моментального снимка SAP HANA, который создается перед моментальным снимком хранилища. Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища. Для успешного создания моментального снимка HANA необходим активный экземпляр HANA.  В сценарии HSR создание моментальных снимков хранилища не поддерживается на текущем дополнительном узле, на котором невозможно создать моментальный снимок HANA.
- После успешного создания моментального снимка хранилища моментальный снимок SAP HANA удаляется.
- Резервные копии журналов транзакций создаются часто и хранятся на томе /hana/logbackups или в Azure. Вы можете активировать том /hana/logbackups, содержащий резервные копии журналов транзакций, для отдельного создания моментального снимка. В этом случае вам не нужно создавать моментальный снимок HANA.
- Если базу данных необходимо восстановить до определенной точки во времени, отправьте запрос в службу поддержки Microsoft Azure (рабочий сбой) или отдел по управлению службами SAP HANA в Azure на восстановление до определенного моментального снимка хранилища. Например, плановое восстановление системы типа "песочница" до исходного состояния.
- Моментальный снимок SAP HANA, добавленный в моментальный снимок хранилища, используется в качестве точки смещения для применения резервных копий журнала транзакций, полученных и сохраненных после создания моментального снимка хранилища.
- Эти резервные копии журналов транзакций используются для восстановления базы данных до определенной точки во времени.

Вы можете создавать моментальные снимки хранилища, нацеленные на три класса томов.

- Объединенный моментальный снимок томов /hana/data и /hana/shared (включая /usr/sap). Для этого моментального снимка требуется создать моментальный снимок SAP HANA в качестве подготовки для моментального снимка хранилища. Благодаря моментальному снимку SAP HANA база данных будет находиться в согласованном состоянии с точки зрения хранилища, а для восстановления нужно настраивать именно этот компонент.
- Отдельный моментальный снимок тома /hana/logbackups.
- Раздел операционной системы.

Последние сценарии создания моментальных снимков и документацию доступны на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts). При загрузке пакета сценариев создания моментальных снимков из [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts) вы также получаете соответствующую документацию в формате PDF. Каждый пакет сценариев имеет собственную документацию.

## <a name="storage-snapshot-considerations"></a>Факторы, которые необходимо учитывать при создании моментальных снимков хранилища

>[!NOTE]
>Моментальные снимки хранилища используют дисковое пространство, которое было выделено для единиц крупных экземпляров HANA. Необходимо учитывать приведенные ниже аспекты с точки зрения планирования создания моментальных снимков хранилища и количества хранящихся моментальных снимков хранилища. 

Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:

- Определенный моментальный снимок хранилища (на определенный момент времени, когда он создан) занимает мало пространства в хранилище.
- На моментальном снимке должен храниться исходный набор данных и их изменения, так как данные и содержимое файлов данных в SAP HANA изменяются на томе хранилища.
- В результате размер моментального снимка хранилища увеличивается. в зависимости от срока его хранения.
- Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.

SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA. Создание моментальных снимков этих томов требует много пространства на томе. Вам необходимо запланировать создание моментальных снимков хранилища. Необходимо также отслеживать потребление пространства томов хранилища и управлять количеством имеющихся моментальных снимков. Вы можете отключить создание моментальных снимков хранилища, если импортируются большие объемы данных, или внести другие важные изменения в базу данных HANA. 


В следующих разделах содержатся сведения о создании этих моментальных снимков, а также общие рекомендации.

- Хотя оборудование поддерживает 255 моментальных снимков на том, советуем хранить намного меньшее их количество. Рекомендуется использовать до 250 моментальных снимков.
- Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.
- В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить. Вы можете уменьшить количество хранящихся моментальных снимков или расширить тома. Вы можете заказать дополнительное пространство в единицах по 1 ТБ.
- При выполнении таких действий, как перенос данных в SAP HANA с помощью средств переноса платформы SAP (R3load) или восстановление баз данных SAP HANA из резервных копий, необходимо отключить создание моментальных снимков хранилища для тома /hana/data. 
- При более значительных реорганизациях таблиц SAP HANA по возможности не создавайте моментальные снимки хранилища.
- Моментальные снимки хранилища обеспечивают поддержку возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).

## <a name="prerequisites-for-using-self-service-storage-snapshots"></a>Необходимые условия для использования самостоятельных моментальных снимков хранилища

Чтобы гарантировать успешное выполнение сценария моментального снимка, убедитесь, что Perl установлен в операционной системе Linux на сервере HANA (крупные экземпляры). Perl уже предварительно установлен в единице HANA (крупные экземпляры). Чтобы проверить версию Perl, используйте следующую команду:

`perl -v`

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/perl_screen.png)


## <a name="set-up-storage-snapshots"></a>Настройка моментальных снимков хранилища

Чтобы настроить создание моментальных снимков хранилища с помощью крупных экземпляров HANA, выполните следующие действия:
1. Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".
1. Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.
1. На главном узле создайте учетную запись резервного копирования SAP HANA для каждого запущенного экземпляра SAP HANA (если применимо).
1. Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.
1. На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.
1. Скопируйте сценарии и файл конфигурации из [этого расположения GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts) в расположение **hdbsql** установленного экземпляра SAP HANA.
1. Измените файл *HANABackupDetails.txt* в соответствии с определенной спецификацией клиента.

Последние сценарии создания моментальных снимков и документацию доступны на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts). При загрузке пакета сценариев создания моментальных снимков из [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts) вы также получаете соответствующую документацию в формате PDF. Каждый пакет сценариев имеет собственную документацию.

### <a name="consideration-for-mcod-scenarios"></a>Рекомендации для сценариев MCOD
Если вы используете [сценарий MCOD](https://launchpad.support.sap.com/#/notes/1681092) с несколькими экземплярами SAP HANA в одном экземпляре HANA (крупные экземпляры), для каждого экземпляра SAP HANA подготавливается отдельный том хранения. В текущей версии самостоятельной автоматизации моментального снимка невозможно инициировать отдельные моментальные снимки на каждый идентификатор безопасности (SID) HANA. С помощью предоставленной функциональной возможности выполняется проверка зарегистрированных экземпляров SAP HANA в файле конфигурации сервера (см. далее в этой статье) и создается моментальный снимок томов всех экземпляров, зарегистрированных на устройстве.
 

### <a name="step-1-install-the-sap-hana-hdb-client"></a>Шаг 1. Установка клиента SAP HANA HDB

Операционная система Linux, установленная в решении "SAP HANA в Azure (крупные экземпляры)", содержит папки и сценарии, необходимые для создания моментальных снимков хранилища SAP HANA, используемых для резервного копирования и восстановления. Проверьте наличие последних выпусков на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts). Самой последней версией выпуска сценариев является версия 3. В рамках основного номера версии различные сценарии могут иметь разные вспомогательные версии.

>[!IMPORTANT]
>При переходе от версии 2.1 к версии 3.x сценариев может меняться структура файла конфигурации и некоторые синтаксические конструкции. Конкретные обозначения указаны в соответствующих разделах. 

Во время установки SAP HANA вы должны самостоятельно установить клиент SAP HANA HDB для единиц крупных экземпляров HANA.

### <a name="step-2-change-the-etcsshsshconfig"></a>Шаг 2. Изменение конфигурации /etc/ssh/ssh\_config

Измените файл `/etc/ssh/ssh_config`, добавив строку _MACs hmac-sha1_, как показано здесь:
```
#   RhostsRSAAuthentication no
#   RSAAuthentication yes
#   PasswordAuthentication yes
#   HostbasedAuthentication no
#   GSSAPIAuthentication no
#   GSSAPIDelegateCredentials no
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no
#   CheckHostIP yes
#   AddressFamily any
#   ConnectTimeout 0
#   StrictHostKeyChecking ask
#   IdentityFile ~/.ssh/identity
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   Port 22
Protocol 2
#   Cipher 3des
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,arcfour256,arcfour128,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com,hmac-ripemd160
MACs hmac-sha1
#   EscapeChar ~
#   Tunnel no
#   TunnelDevice any:any
#   PermitLocalCommand no
#   VisualHostKey no
#   ProxyCommand ssh -q -W %h:%p gateway.example.com
```

### <a name="step-3-create-a-public-key"></a>Шаг 3. Создание открытого ключа

Чтобы обеспечить доступ к интерфейсам моментальных снимков хранилища клиента крупных экземпляров HANA, необходимо настроить вход с помощью открытого ключа. На первом сервере решения "SAP HANA в Azure (крупные экземпляры)" в своем клиенте создайте открытый ключ, с помощью которого будет осуществляться доступ к инфраструктуре хранилища. Этот ключ позволит входить в интерфейсы моментальных снимков хранилища без пароля, что устраняет необходимость в хранении учетных данных с паролями. Чтобы создать открытый ключ, в операционной системе Linux на сервере решения "Крупные экземпляры SAP HANA" выполните следующую команду:
```
  ssh-keygen –t dsa –b 1024
```
Новое расположение — **_/root/.ssh/id\_dsa.pub**. Не вводите фактический пароль, иначе вам нужно будет вводить его при каждом входе. Вместо этого нажмите клавишу **ВВОД** дважды, чтобы закрыть этот запрос.

Убедитесь, что открытый ключ исправлен надлежащим образом. Для этого измените папки на **/root/.ssh/** и выполните команду `ls`. Если ключ присутствует, его можно скопировать, выполнив следующую команду:

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/image2-public-key.png)

На этом этапе обратитесь в отдел по управлению службами SAP HANA в Azure и предоставьте открытый ключ. Уполномоченный представитель зарегистрирует его в базовой инфраструктуре хранилища, созданной для вашего клиента крупного экземпляра HANA.

### <a name="step-4-create-an-sap-hana-user-account"></a>Шаг 4. Создание учетной записи пользователя SAP HANA

Чтобы инициировать создание моментальных снимков SAP HANA, необходимо создать учетную запись пользователя в SAP HANA, которую могут использовать сценарии создания моментальных снимков хранилища. Для этих целей создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Пользователя нужно создать в SYSTEMDB, а не с использованием идентификатора безопасности в базе данных для MDC. В отдельной среде контейнера пользователь настраивается в базе данных клиента. У этой учетной записи должны быть такие привилегии: **Backup Admin** (Администратор резервного копирования) и **Catalog Read** (Чтение каталогов). В этом примере мы создали имя пользователя **SCADMIN**. В имени учетной записи пользователя, созданной в HANA Studio, учитывается регистр знаков. Выберите **Нет**, чтобы пользователю нужно было изменить пароль при следующем входе.

![Создание пользователя в HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image3-creating-user.png)

В развертываниях MCOD с несколькими экземплярами SAP HANA на один блок этот шаг необходимо повторить для каждого экземпляра SAP HANA.

### <a name="step-5-authorize-the-sap-hana-user-account"></a>Шаг 5. Авторизация учетной записи пользователя SAP HANA

На этом шаге необходимо авторизовать созданную учетную запись пользователя SAP HANA, чтобы сценариям не приходилось отправлять пароли во время выполнения. Команда SAP HANA `hdbuserstore` позволяет создать ключ пользователя SAP HANA, который хранится на одном или нескольких узлах SAP HANA, и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания сценария не нужно заботиться об управлении паролями). Этот процесс написания сценариев описывается далее.

>[!IMPORTANT]
>Выполните следующую команду от имени пользователя, для которого запланировано выполнение сценариев. В противном случае скрипт не будет работать должным образом.

Введите команду `hdbuserstore`, как показано ниже.

**Для установки без MDC HANA**
```
hdbuserstore set <key> <host>:<3[instance]15> <user> <password>
```

**Для установки с MDC HANA**
```
hdbuserstore set <key> <host>:<3[instance]13> <user> <password>
```

В следующем примере рассматривается пользователь **SCADMIN01**, имя узла — **lhanad01** и номер экземпляра — **01**:
```
hdbuserstore set SCADMIN01 lhanad01:30115 <backup username> <password>
```
При использовании развертывания HANA MCOD с несколькими экземплярами SAP HANA на один блок шаг необходимо повторить для каждого экземпляра SAP HANA и соответствующего пользователя резервного копирования в блоке.

При наличии конфигурации горизонтального масштабирования SAP HANA следует управлять всеми сценариями посредством одного сервера. В этом примере ключ SAP HANA пользователя **SCADMIN01** необходимо изменить для каждого узла. Этот ключ должен отражать узел, связанный с ним. Измените в учетной записи резервного копирования SAP HANA номер экземпляра для базы данных HANA. Предоставьте ключу права администратора на узле, которому он назначен, а пользователю резервного копирования, используемому для конфигураций горизонтального масштабирования, — права на доступ ко всем экземплярам SAP HANA. Если развертываются узлы **lhanad01**, **lhanad02** и **lhanad03**, то последовательность команд будет выглядеть следующим образом.

```
hdbuserstore set SCADMIN01 lhanad01:30115 SCADMIN <password>
hdbuserstore set SCADMIN01 lhanad02:30115 SCADMIN <password>
hdbuserstore set SCADMIN01 lhanad03:30115 SCADMIN <password>
```

### <a name="step-6-get-the-snapshot-scripts-configure-the-snapshots-and-test-the-configuration-and-connectivity"></a>Шаг 6. Получение сценариев создания моментальных снимков, настройка моментальных снимков, тестирование конфигурации и возможностей подключения

Скачайте последнюю версию сценариев на [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts). Скопируйте скачанные сценарии и текстовый файл в рабочую папку для **hdbsql**. В текущих установках HANA это каталог имеет следующий формат: /hana/shared/D01/exe/linuxx86\_64/hdb. 
``` 
azure_hana_backup.pl 
azure_hana_replication_status.pl 
azure_hana_snapshot_details.pl 
azure_hana_snapshot_delete.pl 
testHANAConnection.pl 
testStorageSnapshotConnection.pl 
removeTestStorageSnapshot.pl
azure_hana_dr_failover.pl
azure_hana_test_dr_failover.pl 
HANABackupCustomerDetails.txt 
``` 

Рекомендации по работе со сценариями Perl: 

- Никогда не изменяйте сценарии, если это не указано в Microsoft Operations.
- При запросе на изменение сценария или файла параметров всегда используйте текстовый редактор Linux, например vi, и не используйте редакторы Windows, например Блокнот, так как это может привести к повреждению формата файла.
- Всегда используйте сценарии последней версии. Ее можно скачать с GitHub.
- Используйте одну версию сценариев в среде.
- Протестируйте сценарии, ознакомьтесь с их выходными данными и параметрами, прежде чем использовать их непосредственно в рабочей системе.
- Не изменяйте имя точки подключения сервера, подготовленной с помощью Microsoft Operations. Для успешного выполнения этих сценариев стандартные точки подключения должны быть доступны.


Ниже описано назначение различных сценариев и файлов.

- **azure\_hana\_backup.pl**. Этот сценарий необходимо запланировать с помощью служебной программы планирования Linux Cron, что позволит создавать моментальные снимки хранилища томов HANA data и shared, тома /hana/logbackups или операционной системы.
- **azure\_hana\_replication\_status.pl**. Этот сценарий предназначен для передачи основных сведений о состоянии репликации с рабочего сайта на сайт аварийного восстановления. Данный сценарий используется для отслеживания выполнения репликации. Он отображает размеры реплицируемых элементов. Он также предоставляет инструкции в случае, если репликация выполняется слишком долго или если канал не работает.
- **azure\_hana\_snapshot\_details.pl**. Этот сценарий предоставляет список основных сведений о всех моментальных снимках на каждом томе в вашей среде. Этот сценарий может выполняться на сервере-источнике или на экземпляре сервера в расположении аварийного восстановления. Этот сценарий предоставляет приведенные ниже сведения с разбивкой по томам, содержащим моментальные снимки:
   * общий размер моментальных снимков на томе;
   * Для каждого снимка на этом томе указываются следующие сведения: 
      - имя моментального снимка; 
      - время создания снимка; 
      - размер снимка;
      - частота создания снимка;
      - идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо).
- **azure\_hana\_snapshot\_delete.pl**. Этот сценарий предназначен для удаления моментального снимка хранилища или набора снимков. Вы можете использовать идентификатор резервного копирования SAP HANA, указанный в HANA Studio, или имя моментального снимка хранилища. В настоящее время идентификатор резервного копирования привязывается только к моментальным снимкам, созданным для томов HANA data/log/shared. В противном случае, если ввести идентификатор моментального снимка, будет выполнен поиск всех моментальных снимков, которые соответствуют введенному идентификатору.  
- **testHANAConnection.pl**. Этот сценарий проверяет подключение к экземпляру SAP HANA. Он необходим для настройки моментальных снимков хранилища.
- **testStorageSnapshotConnection.pl**. Этот сценарий необходим для двух целей. Во-первых, он позволяет убедиться, что у единицы крупного экземпляра HANA, который выполняет сценарии, имеется доступ к назначенной виртуальной машине хранилища и, следовательно, к интерфейсу моментальных снимков хранилища крупных экземпляров HANA. Во-вторых, он предназначен для создания временного моментального снимка тестируемого экземпляра HANA. Этот сценарий нужно выполнить для каждого экземпляра HANA на сервере, чтобы убедиться, что сценарии резервного копирования работают должным образом.
- **removeTestStorageSnapshot.pl**. Этот сценарий позволяет удалить тестовый моментальный снимок, созданный с помощью сценария **testStorageSnapshotConnection.pl**.
- **azure\_hana\_dr\_failover.pl**. Этот сценарий запускает отработку отказа с аварийным восстановлением в другой регион. Его нужно выполнять в экземпляре HANA (крупные экземпляры) в регионе аварийного восстановления или в экземпляре для отработки отказа. Этот сценарий останавливает репликацию хранилища из основной в дополнительную среду, восстанавливает последний моментальный снимок томов аварийного восстановления и предоставляет точки подключения для них.
- **azure\_hana\_test\_dr\_failover.pl**. Этот сценарий выполняет тестовую отработку отказа на сайт аварийного восстановления. В отличие от сценария azure_hana_dr_failover.pl этот сценарий не прерывает репликацию хранилища с основного сайта на вспомогательный. Вместо этого создаются клоны реплицированных томов хранения на стороне аварийного восстановления и предоставляются точки подключения клонированных томов. 
- **HANABackupCustomerDetails.txt**. Это редактируемый файл конфигурации, который необходимо изменить, чтобы адаптировать конфигурацию SAP HANA. *HANABackupCustomerDetails.txt* — файл параметров и конфигурации сценария, создающего моментальные снимки хранилища. Настройте этот файл в соответствии с собственными задачами и конфигурацией. После развертывания экземпляров отдел по управлению службами SAP HANA в Azure должен был предоставить **имя резервного копирования** и **IP-адрес хранилища**. Порядок, упорядочение переменных или интервал между ними в файле изменять нельзя. В противном случае сценарий не будет работать должным образом. Кроме того, вы получили IP-адрес узла увеличения масштаба или главного узла (в случае горизонтального масштабирования) от отдела по управлению службами SAP HANA в Azure. К тому же вы знаете номер экземпляра HANA, полученный во время установки SAP HANA. Теперь необходимо добавить имя резервной копии в файл конфигурации.

Для увеличения масштаба или масштабного развертывания после ввода имени сервера экземпляра HANA (крупные экземпляры) и IP-адреса сервера файл конфигурации будет выглядеть, как показано ниже. Заполните все необходимые поля для каждого идентификатора безопасности SAP HANA, который нужно архивировать или восстановить.

Кроме того, можно закомментировать строки экземпляров, которые в течение определенного периода не нужно архивировать, добавив # перед требуемым полем. Кроме того, не нужно вводить все экземпляры SAP HANA, содержащиеся на сервере, если не нужно архивировать или восстанавливать какой-либо конкретный экземпляр. Формат нужно сохранить для всех полей, иначе произойдет ошибка и все сценарии завершат работу. Вы можете удалить дополнительные требуемые строки в сведениях о любом неиспользуемом идентификаторе безопасности после последнего экземпляра SAP HANA. Все строки должны быть заполнены, закомментированы или удалены.

>[!IMPORTANT]
>При переходе от версии 2.1 к версии 3.x структура файла действительно изменилась. Если вы хотите использовать сценарии версии 3.x, необходимо адаптировать структуру файла конфигурации. 


```
HANA Server Name: testing01
HANA Server IP Address: 172.18.18.50
```

Для каждого экземпляра, настроенного в крупном экземпляре HANA, или для масштабируемой конфигурации необходимо определить данные следующим образом:

    
```
######***SID #1 Information***#####
SID1: h01
###Provided by Microsoft Operations###
SID1 Storage Backup Name: clt1h01backup
SID1 Storage IP Address: 172.18.18.11
######     Customer Provided    ######
SID1 HANA instance number: 00
SID1 HANA HDBuserstore Name: SCADMINH01
```
Для масштабирования и конфигураций службы репликации системы HANA повторите такую настройку на каждом из узлов. При этом гарантируется, что в случае сбоев архивация и окончательная репликация хранилища продолжат работать.   

Поместив все данные конфигурации в файл *HANABackupCustomerDetails.txt*, проверьте правильность конфигурации в отношении данных экземпляра HANA. Используйте сценарий `testHANAConnection.pl`, который не зависит от конфигурации развертывания или масштабирования SAP HANA.

```
testHANAConnection.pl
```

При наличии конфигурации развертывания SAP HANA убедитесь, что основной экземпляр HANA имеет доступ ко всем необходимым серверам и экземплярам HANA. В тестовом сценарии отсутствуют параметры, но для его надлежащего выполнения необходимо добавить свои данные в файл конфигурации *HANABackupCustomerDetails.txt*. Этот сценарий не поддерживает поиск ошибок в каждом отдельном экземпляре, так как возвращаются только коды ошибок в команде оболочки. Однако он предоставляет некоторые полезные сведения, которые нужно тщательно проверить.

Чтобы запустить сценарий, выполните следующую команду:
```
 ./testHANAConnection.pl
```
Если в результате выполнения скрипта возвращается состояние экземпляра HANA, отобразится сообщение об успешном подключении к HANA.


Следующий шаг теста — проверка подключения к хранилищу на основе данных, помещенных в файл конфигурации *HANABackupCustomerDetails.txt*, и создание тестового моментального снимка. Этот тест необходимо выполнить перед сценарием `azure_hana_backup.pl`. Если на томе отсутствуют моментальные снимки, то невозможно определить: том просто пустой или при получении сведений о моментальных снимках произошла ошибка SSH. По этой причине выполнение скрипта состоит из двух этапов:

- Он проверяет, доступна ли виртуальная машина и интерфейсы клиента сценариям для создания моментальных снимков хранилища.
- создание тестового (фиктивного) моментального снимка для каждого тома экземпляра HANA.

Из-за этого экземпляр HANA добавляется в качестве аргумента. В случае сбоя выполнения нет возможности проверить ошибки подключения к хранилищу. Даже если нет возможности проверить ошибки, сценарий предоставляет полезные указания.

1. Выполните последовательность команд для выполнения этого теста:

   ```
   ssh <StorageUserName>@<StorageIP>
   ```

   Вы получили имя пользователя и IP-адрес хранилища из крупного экземпляра HANA.

1. Выполните тестовый сценарий:
   ```
    ./testStorageSnapshotConnection.pl
   ```

Сценарий попытается войти в хранилище с помощью открытого ключа, предоставленного во время установки, и данных, настроенных в файле *HANABackupCustomerDetails.txt*. При успешном входе возвращается следующее содержимое.

```
**********************Checking access to Storage**********************
Storage Access successful!!!!!!!!!!!!!!
```

Если при подключении к консоли хранилища возникнут проблемы, то выходные данные будут выглядеть следующим образом:

```
**********************Checking access to Storage**********************
WARNING: Storage check status command 'volume show -type RW -fields volume' failed: 65280
WARNING: Please check the following:
WARNING: Was publickey sent to Microsoft Service Team?
WARNING: If passphrase entered while using tool, publickey must be re-created and passphrase must be left blank for both entries
WARNING: Ensure correct IP address was entered in HANABackupCustomerDetails.txt
WARNING: Ensure correct Storage backup name was entered in HANABackupCustomerDetails.txt
WARNING: Ensure that no modification in format HANABackupCustomerDetails.txt like additional lines, line numbers or spacing
WARNING: ******************Exiting Script*******************************
```

После успешного входа в интерфейсы виртуальной машины хранилища этот сценарий перейдет к этапу 2 и создаст тестовый моментальный снимок. Ниже показаны выходные данные для конфигурации масштабирования трех узлов SAP HANA:

```
**********************Creating Storage snapshot**********************
Taking snapshot testStorage.recent for hana_data_hm3_mnt00001_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00001_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00002_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00002_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00003_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_data_hm3_mnt00003_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_backups_hm3_t020_dp ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_backups_hm3_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_hm3_mnt00001_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_hm3_mnt00002_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_log_hm3_mnt00003_t020_vol ...
Snapshot created successfully.
Taking snapshot testStorage.recent for hana_shared_hm3_t020_vol ...
Snapshot created successfully.
```

Если сценарию удастся успешно создать тестовый моментальный снимок, можно будет продолжить настройку действительных моментальных снимков хранилища. Если же нет, сначала необходимо устранить проблемы, а затем продолжить. Тестовый моментальный снимок следует хранить, пока не будут созданы первые настоящие моментальные снимки.


### <a name="step-7-perform-snapshots"></a>Шаг 7. Создание моментальных снимков

По завершении всех этапов подготовки можно начать настройку действительной конфигурации моментальных снимков хранилища. Сценарий, выполнение которого следует запланировать, работает с конфигурациями увеличения масштаба и развертывания SAP HANA. Для периодического и регулярного выполнения сценария резервного копирования запланируйте его с помощью служебной программы Cron. 

Вы можете создать три типа резервных копий моментальных снимков:
- **HANA**. Объединенное резервное копирование моментальных снимков, при котором тома, содержащие /hana/data и /hana/shared (включая /usr/sap), охватываются скоординированным моментальным снимком. Из этого моментального снимка можно восстановить отдельный файл.
- **Журналы**. Резервное копирование моментальных снимков тома /hana/logbackups. Для создания этого моментального снимка хранилища не активируется создание моментального снимка HANA. Этот том хранилища предназначен для хранения резервных копий журналов транзакций SAP HANA. Эти копии часто создаются, чтобы ограничить рост журналов и избежать потенциальной потери данных. Из этого моментального снимка можно восстановить отдельный файл. Не указывайте частоту менее 3 минут.
- **Загрузка**. Моментальный снимок тома, содержащего загрузочный логический номер устройства (LUN) крупного экземпляра HANA. Создание этой резервной копии моментального снимка возможно только для номеров SKU типа I крупных экземпляров HANA. Из моментального снимка тома, который содержит загрузочный логический номер устройства, невозможно восстанавливать отдельные файлы.


>[!NOTE]
> Синтаксис вызова трех типов моментальных снимков изменился при переходе к версии 3.x сценариев, которые поддерживают развертывания MCOD. Больше не следует указывать идентификатор безопасности HANA экземпляра. Необходимо убедиться, что экземпляры SAP HANA настроены в файле конфигурации *HANABackupCustomerDetails.txt*.

>[!NOTE]
> При выполнении сценария в первый раз в среде с несколькими идентификаторами безопасности могут произойти неожиданные ошибки. Чтобы решить проблему, перезапустите сценарий.



Новый синтаксис вызова для выполнения моментальных снимков хранилища с помощью сценария *azure_hana_backup.pl* выглядит так:

```
HANA backup covering /hana/data and /hana/shared (includes/usr/sap)
./azure_hana_backup.pl hana <snapshot_prefix> <snapshot_frequency> <number of snapshots retained>

For /hana/logbackups snapshot
./azure_hana_backup.pl logs <snapshot_prefix> <snapshot_frequency> <number of snapshots retained>

For snapshot of the volume storing the boot LUN
./azure_hana_backup.pl boot <HANA Large Instance Type> <snapshot_prefix> <snapshot_frequency> <number of snapshots retained>

```

Сведения о параметрах: 

- Первый параметр определяет тип резервной копии моментального снимка. Его допустимые значения: **hana**, **logs** и **boot**. 
- Параметр **<HANA Large Instance Type>** необходим только для архивации загрузочных томов. От крупного экземпляра HANA зависят допустимые значения TypeI или TypeII. Чтобы определить тип своего экземпляра, см. сведения в статье [Обзор и описание архитектуры SAP HANA в Azure (крупные экземпляры)](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/hana-overview-architecture).  
- Параметр **<snapshot_prefix>** — метка резервной копии или моментального снимка для типа моментального снимка. Метка имеет две цели. Первая — вы присвоите ей понятное имя, характеризующее суть моментальных снимков. Вторая — определение сценарием *azure\_hana\_backup.pl* количества моментальных снимков хранилища, связанных с определенной меткой. Если вы запланировали создание двух резервных копий моментальных снимков хранилища одного типа (например, **hana**) с двумя разными метками и определили, что для каждой требуется 30 моментальных снимков, то у вас будет 60 моментальных снимков хранилища томов. Допускаются только буквы и цифры (A–Z, a–z, 0–9), символ подчеркивания (_) и дефис (-). 
- Параметр **<snapshot_frequency>** — зарезервирован для будущих разработок и ни на что не влияет. Задайте значение "3 мин" при архивации типа **журнал** и "15 мин" при архивации другого типа.
- Параметр **<number of snapshots retained>** косвенно определяет срок хранения моментальных снимков. Он задает количество хранимых моментальных снимков с одинаковым префиксом (меткой). Этот параметр важен для запланированных выполнений с помощью Cron. Если количество моментальных снимков с одним параметром snapshot_prefix превысит количество, заданное в этом параметре, самый старый моментальный снимок удаляется перед созданием моментального снимка хранилища.

В случае горизонтального масштабирования сценарий выполнит дополнительную проверку возможности доступа ко всем серверам HANA. Перед созданием моментального снимка SAP HANA он также проконтролирует, чтобы все экземпляры HANA возвращали соответствующее состояние. После создания моментального снимка SAP HANA создается моментальный снимок хранилища.

Создание моментальных снимков с помощью сценария `azure_hana_backup.pl` состоит из следующих трех этапов:

1. создание моментального снимка SAP HANA;
1. создание моментального снимка хранилища;
1. удаление моментального снимка SAP HANA, созданного перед моментальным снимком хранилища.

Чтобы выполнить сценарий, вызовите его из выполняемой папки HDB, в которую он скопирован. 

Срок хранения регулируется количеством моментальных снимков. Это значение задается как параметр во время выполнения сценария. Поэтому срок хранения моментальных снимков хранилища — это функция периода выполнения и количества моментальных снимков, переданного в качестве параметра при выполнении сценария. Если число моментальных снимков превышает значение, заданное с помощью параметра при выполнении сценария, то перед созданием следующего моментального снимка удаляется самый старый моментальный снимок такой же меткой. Количество хранимых моментальных снимков можно задать в последнем параметре вызова. С его помощью можно также косвенно управлять дисковым пространством, используемым для моментальных снимков. 

> [!NOTE]
>После изменения метки отсчет начинается сначала. Вы должны придерживаться строгих правил относительно меток, чтобы избежать случайного удаления моментальных снимков.

## <a name="snapshot-strategies"></a>Стратегии моментальных снимков
Частота создания моментальных снимков для различных типов зависит от того, используются ли функции аварийного восстановления крупного экземпляра HANA. Эти функциональные возможности полагаются на моментальные снимки хранилища, в случае с которыми могут потребоваться некоторые специальные рекомендации с точки зрения частоты и продолжительности их создания. 

В приведенных ниже рекомендациях предполагается, что вы *не* используете функции аварийного восстановления, которые предлагают крупные экземпляры HANA. Предполагается, что вместо этого вы используете моментальные снимки хранилища в качестве средства резервного копирования и имеете возможность выполнить восстановление на определенный момент времени за последние 30 дней. Учитывая ограничения количества моментальных снимков и дискового пространства, клиенты учли следующие типы требований:

- время восстановления до восстановления на определенный момент времени;
- используемое пространство;
- требования к целевой точке восстановления и целевому времени восстановления в случае возможного аварийного восстановления.
- последующее выполнение полного резервного копирования базы данных HANA на диски (при выполнении полного резервного копирования базы данных на диски (или в интерфейс **backint**) создание моментальных снимков хранилища завершается сбоем; если вы хотите выполнить полное резервное копирование базы данных на основе моментальных снимков хранилища, отключите на это время создание этих моментальных снимков);
- количество моментальных снимков на том (не может превышать 250).


Для клиентов, которые не используют функции аварийного восстановления крупных экземпляров HANA, частота создания моментальных снимков ниже. В таких случаях клиенты создают объединенные моментальные снимки томов /hana/data и /hana/shared (включая /usr/sap) за 12- или 24-часовой период и сохраняют эти моментальные снимки, чтобы охватить весь месяц. То же самое относится к моментальным снимкам тома резервных копий журналов. Однако создание резервных копий журналов транзакций SAP HANA на томе резервных копий журналов выполняется за 5–15 минут.

Плановое создание моментальных снимков хранилища лучше всего выполнять с помощью средства Cron. Используйте один сценарий для резервного копирования и аварийного восстановления. Измените входные данные сценария в соответствии со временем резервного копирования. Создание этих моментальных снимков планируется на разное время в Cron, в зависимости от параметров времени выполнения: каждый час, каждые 12 часов, каждый день или каждую неделю. 

Ниже приведен пример расписания cron в /etc/crontab.
```
00 1-23 * * * ./azure_hana_backup.pl hana hourlyhana 15min 46
10 00 * * *  ./azure_hana_backup.pl hana dailyhana 15min 28
00,05,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup.pl logs regularlogback 3min 28
22 12 * * *  ./azure_hana_backup.pl logs dailylogback 3min 28
30 00 * * *  ./azure_hana_backup.pl boot TypeI dailyboot 15min 28
```
В приведенном выше примере создается ежечасный объединенный моментальный снимок, который охватывает тома, содержащие расположения /hana/data и /hana/shared (включая /usr/sap). Моментальный снимок этого типа ускоряет восстановление на определенный момент времени в пределах двух дней. Кроме того, предусмотрено создание ежедневного моментального снимка этих томов. Таким образом, вы охватили два дня ежечасными моментальными снимками и четыре недели — ежедневными моментальными снимками. Кроме того, ежедневно создается резервная копия тома резервных копий журналов транзакций. Эти резервные копии также хранятся четыре недели. Как видно в третьей строке crontab, резервное копирование журнала транзакций HANA запланировано с интервалом в 5 минут. Время запуска различных заданий Cron, которые создают моментальные снимки хранилища, заданы поочередно таким образом, чтобы эти моментальные снимки никогда не создавались одновременно. 

В приведенном ниже примере раз в час создается объединенный моментальный снимок, который охватывает тома, содержащие расположения /hana/data и /hana/shared (включая /usr/sap). Они хранятся в течение двух дней. Моментальные снимки томов резервных копий журналов транзакций создаются каждые пять минут и хранятся в течение 4 часов. Как и прежде, создание резервной копии файла журнала транзакций HANA запланировано с интервалом в 5 минут. Моментальный снимок тома резервных копий журналов транзакций создается с задержкой в 2 минуты после начала резервного копирования журнала транзакций. В течение этих 2 минут в обычных условиях резервное копирование журнала транзакций SAP HANA завершается. Как и ранее, резервное копирование тома, содержащего загрузочный логический номер устройства, выполняется один раз в день: создается моментальный снимок хранилища, который хранится приблизительно четыре недели.

```
10 0-23 * * * ./azure_hana_backup.pl hana hourlyhana 15min 48
0,5,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup.pl logs regularlogback 3min 28
2,7,12,17,22,27,32,37,42,47,52,57 * * * *  ./azure_hana_backup.pl logs logback 3min 48
30 00 * * *  ./azure_hana_backup.pl boot TypeII dailyboot 15min 28
```

На следующем рисунке показаны последовательности предыдущего примера, за исключением загрузочного логического номера устройства:

![Связь между резервными копиями и моментальными снимками](./media/hana-overview-high-availability-disaster-recovery/backup_snapshot_updated0921.PNG)

SAP HANA регулярно записывает данные на том /hana/log, чтобы регистрировать зафиксированные изменения в базе данных. SAP HANA регулярно записывает точку сохранения на том /hana/data. Как указано в crontab, резервная копия журналов транзакций SAP HANA создается каждые 5 минут. Кроме того, как видите, в результате активации создания объединенного моментального снимка хранилища, охватывающего тома /hana/data и /hana/shared, каждый час создается моментальный снимок SAP HANA. После успешного создания моментального снимка HANA создается объединенный моментальный снимок хранилища. Как указано в crontab, каждые 5 минут, примерно через 2 минуты после резервного копирования журналов транзакций HANA, создается моментальный снимок хранилища тома /hana/logbackup.

> 

>[!IMPORTANT]
> Резервное копирование SAP HANA на основе моментальных снимков хранилища имеет смысл, только если моментальные снимки создаются совместно с резервными копиями журналов транзакций SAP HANA. Эти резервные копии журналов транзакций должны охватывать временные периоды между моментальными снимками хранилища. 

Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:

- В исключительных случаях — доступ к объединенному моментальному снимку хранилища, охватывающему расположения /hana/data и /hana/shared, которому должно быть не больше 30 дней.
- Связанные резервные копии журналов транзакций, охватывающие время между всеми объединенными моментальными снимками хранилища. Поэтому наиболее старому моментальному снимку тома резервных копий журналов транзакций должно быть 30 дней. Если только к тому времени вы не скопировали резервные копии журналов транзакций на другой общедоступный ресурс NFS, расположенный в службе хранилища Azure. В этом случае можно получить старые резервные копии журналов транзакций из этого общедоступного ресурса NFS.

Чтобы иметь возможность использовать моментальные снимки хранилища и итоговую репликацию резервных копий журналов транзакций, необходимо изменить расположение, в которое SAP HANA записывает резервные копии журналов транзакций. Это можно сделать в HANA Studio. Хотя SAP HANA автоматически выполняет резервное копирование сегментов полного журнала, следует указать детерминированный интервал создания резервной копии журнала. Особенно это нужно при использовании аварийного восстановления, поскольку тогда, как правило, требуется создавать резервные копии журналов с детерминированным периодом. В случае, представленном ниже, указан интервал резервного копирования журналов, равный 15 минутам.

![Настройка расписания для создания резервных копий журнала SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

Вы можете выполнять резервные копии намного чаще, чем каждые 15 минут. Такое более частое значение используется в сочетании с функциональной возможностью аварийного восстановления HANA (крупные экземпляры). Некоторые клиенты создают резервные копии журналов транзакций каждые 5 минут.  

Если резервная копия базы данных еще не создавалась, то последний этап заключается в создании ее файловой резервной копии. Это позволит создать одну запись резервной копии, которая должна находиться в каталоге резервных копий. В противном случае SAP HANA не может инициировать резервное копирование журнала.

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)


После успешного создания первых моментальных снимков можно удалить тестовый моментальный снимок, созданный на шаге 6. Для этого запустите сценарий `removeTestStorageSnapshot.pl`:
```
./removeTestStorageSnapshot.pl
```

Выходные данные сценария могут выглядеть так:
```
Checking Snapshot Status for h80
**********************Checking access to Storage**********************
Storage Snapshot Access successful.
**********************Getting list of volumes that match HANA instance specified**********************
Collecting set of volumes hosting HANA matching pattern *h80* ...
Volume show completed successfully.
Adding volume hana_data_h80_mnt00001_t020_vol to the snapshot list.
Adding volume hana_log_backups_h80_t020_vol to the snapshot list.
Adding volume hana_shared_h80_t020_vol to the snapshot list.
**********************Adding list of snapshots to volume list**********************
Collecting set of snapshots for each volume hosting HANA matching pattern *h80* ...
**********************Displaying Snapshots by Volume**********************
hana_data_h80_mnt00001_t020_vol
Test_HANA_Snapshot.2018-02-06_1753.3
Test_HANA_Snapshot.2018-02-06_1815.2
….
Command completed successfully.
Exiting with return code: 0
Command completed successfully.
```


### <a name="monitoring-the-number-and-size-of-snapshots-on-the-disk-volume"></a>Мониторинг количества и размера моментальных снимков на томе диска

Количество моментальных снимков и занимаемое ими пространство на определенном томе хранилища можно отслеживать. Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков. Тем не менее команда ОС Linux `du` демонстрирует сведения об этих моментальных снимках хранилища, так как они хранятся на одних и тех же томах. Для этой команды можно указать следующие параметры.

- `du –sh .snapshot`: Этот параметр возвращает общее число моментальных снимков в каталоге моментальных снимков.
- `du –sh --max-depth=1`: Этот параметр выводит список всех моментальных снимков, сохраненных в папке **.snapshot**, и размер каждого моментального снимка.
- `du –hc`: Этот параметр возвращает общий размер всех моментальных снимков.

Следующие команды предоставляют сведения о создании и хранении моментальных снимков, а также об используемом ими пространстве на томах.

>[!NOTE]
>Приведенные выше команды не отображают моментальные снимки загрузочного логического номера устройства.

### <a name="getting-details-of-snapshots"></a>Получение сведений о моментальных снимках
Чтобы получить дополнительные сведения о моментальных снимках, можно также использовать сценарий `azure_hana_snapshot_details.pl`. Этот сценарий можно выполнять в любом расположении, если в расположении аварийного восстановления имеется активный сервер. Этот сценарий предоставляет следующие выходные данные с разбивкой по томам, содержащим моментальные снимки: 
   * общий размер моментальных снимков на томе;
   * Для каждого снимка на этом томе указываются следующие сведения: 
      - имя моментального снимка; 
      - время создания снимка; 
      - размер снимка;
      - частота создания снимка;
      - идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо).

Синтаксис выполнения сценария может выглядеть так:

```
./azure_hana_snapshot_details.pl 
```

Так как сценарий пытается получить идентификатор резервного копирования HANA, он должен подключиться к экземпляру SAP HANA. Это подключение требует правильной настройки файла конфигурации *HANABackupCustomerDetails.txt*. Выходные данные двух моментальных снимков тома могут выглядеть так:

```
**********************************************************
****Volume: hana_shared_SAPTSTHDB100_t020_vol       ***********
**********************************************************
Total Snapshot Size:  411.8MB
----------------------------------------------------------
Snapshot:   customer.2016-09-20_1404.0
Create Time:   "Tue Sep 20 18:08:35 2016"
Size:   2.10MB
Frequency:   customer 
HANA Backup ID:   
----------------------------------------------------------
Snapshot:   customer2.2016-09-20_1532.0
Create Time:   "Tue Sep 20 19:36:21 2016"
Size:   2.37MB
Frequency:   customer2
HANA Backup ID:   
```



### <a name="reducing-the-number-of-snapshots-on-a-server"></a>Уменьшение количества моментальных снимков на сервере

Как упоминалось ранее, количество моментальных снимков, создаваемых с определенным интервалом, можно уменьшить. Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.

```
./azure_hana_backup.pl hana dailyhana 15min 28
```

В примере выше для моментальных снимков задана метка **dailyhana**, а количество моментальных снимков, которые должны храниться с этой меткой, равно **28**. За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков. Вы можете легко сократить количество моментальных снимков, например до 15, с помощью сценария ниже, указав для последнего параметра значение **15**:

```
./azure_hana_backup.pl hana dailyhana 15min 15
```

Выполнение этого сценария позволяет уменьшить количество моментальных снимков с учетом нового моментального снимка хранилища до 15. Останутся 15 последних моментальных снимков, тогда как 15 более старых моментальных снимков будут удалены.

 >[!NOTE]
 > Этот сценарий уменьшает количество моментальных снимков, только если имеются моментальные снимки, созданные более часа назад. Он не удаляет моментальные снимки, созданные менее часа назад. Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.

Если больше не требуется хранить набор моментальных снимков с определенной меткой резервной копии (в примерах синтаксиса это **hanadaily**), можно выполнить сценарий, задав для количества хранимых моментальных снимков значение **0**. Это позволяет удалить все моментальные снимки, соответствующие этой метке. Тем не менее удаление всех моментальных снимков может повлиять на функцию аварийного восстановления HANA (крупные экземпляры).

Второй способ удалить определенные моментальные снимки — сценарий `azure_hana_snapshot_delete.pl`. Этот сценарий позволяет удалять моментальные снимки или их набор с помощью идентификатора резервного копирования HANA, указанного в HANA Studio, или имени моментального снимка. В настоящее время идентификатор резервного копирования привязывается только к моментальным снимкам типа **hana**. При резервном копировании моментальных снимков типа **logs** и **boot** моментальный снимок SAP HANA не создается. Поэтому идентификатор резервного копирования этих моментальных снимков отсутствует. Если введено имя моментального снимка, то на разных томах будет выполнен поиск всех моментальных снимков, соответствующих этому имени. 

Вызовите сценарий, позволяющий указать идентификатор безопасности экземпляра HANA, с помощью следующего синтаксиса:

```
./azure_hana_snapshot_delete.pl <SID>

```

Выполните этот сценарий от имени **привилегированного** пользователя.

Если выбрать моментальный снимок, то можно будет удалить моментальные снимки по отдельности. Вам будет предложено сначала указать том, содержащий моментальный снимок, а затем имя моментального снимка. Если моментальный снимок существует на этом томе более одного часа, то он удаляется. Имена томов и моментальных снимков можно узнать, выполнив сценарий `azure_hana_snapshot_details`. 

>[!IMPORTANT]
>Если в удаляемом моментальном снимке хранятся данные, которые больше нигде не существуют, то удаление приведет к безвозвратной потере этих данных.

  
## <a name="file-level-restore-from-a-storage-snapshot"></a>Восстановление уровня файла из моментального снимка хранилища
Моментальные снимки типов **hana** и **logs** дают возможность обращаться непосредственно к моментальным снимкам на томах в каталоге **.snapshot**. Это подкаталог для каждого моментального снимка. Вы можете скопировать каждый файл, находящийся в состоянии на момент создания снимка, из этого подкаталога в действительную структуру каталогов. В текущей версии **НЕТ** сценария для самостоятельного восстановления моментального снимка (хотя восстановление моментального снимка может выполняться в сценариях самостоятельного аварийного восстановления на сайте аварийного восстановления при отработке отказа). Необходимо обратиться к рабочей группе Майкрософт, открыв запрос на обслуживание для восстановления требуемого моментального снимка с помощью доступных моментальных снимков.

>[!NOTE]
>Восстановление отдельных файлов не поддерживается для моментальных снимков загрузочного логического номера устройства, независимо от типа экземпляров HANA (крупные экземпляры). Каталог **.snapshot** не представляется в загрузочном логическом номере устройства. 
 

## <a name="recover-to-the-most-recent-hana-snapshot"></a>Восстановление до последнего моментального снимка HANA

В случае сбоя рабочей системы, обратившись в службу поддержки Microsoft Azure, вы можете инициировать процесс восстановления из моментального снимка хранилища в качестве инцидента клиента. Подобный непредвиденный сценарий требует срочного реагирования, если данные были удалены из рабочей системы, и единственный способ быстро вернуть их — восстановить рабочую базу данных.

С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться на несколько дней вперед. Чтобы спланировать восстановление, можно обратиться в отдел по управлению службами SAP HANA в Azure и поднять высокоприоритетные вопросы. Например, вы могли бы спланировать обновление программного обеспечения SAP, применив новую версию пакета расширений. Затем необходимо восстановить моментальный снимок с состоянием до обновления пакета расширений.

Прежде чем отправлять запрос, следует учесть некоторые моменты, чтобы отдел по управлению службами SAP HANA в Azure мог обработать запрос и предоставить восстановленные тома, после чего вы сможете восстановить базу данных HANA на основе моментальных снимков. 

Ниже приведены действия по подготовке к запросу.

>[!NOTE]
>В зависимости от используемого выпуска SAP HANA пользовательский интерфейс может отличаться от следующих снимков экрана.

1. Выберите моментальный снимок, который нужно восстановить. Если не указано другое, будет восстановлен только том hana/data. 

1. Завершите работу экземпляра HANA.

   ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

1. Отключите тома данных на каждом узле базы данных HANA. Если тома данных все еще подключены к операционной системе, восстановление моментального снимка завершится ошибкой.
   ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

1. Отправьте запрос в службу поддержки Azure и предоставьте указания по восстановлению определенного моментального снимка.

   - Во время восстановления: отдел по управлению службами SAP HANA в Azure может попросить установить с ним конференц-связь для координации, проверки и подтверждения восстановления правильного моментального снимка хранилища. 

   - После восстановления: отдел по управлению службами SAP HANA в Azure отправит вам оповещение о восстановлении моментального снимка хранилища.

1. Когда процесс восстановления завершится, подключите все тома данных.

   ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)

1. Выберите параметры восстановления в SAP HANA Studio, если они не отобразились автоматически при повторном подключении к базе данных HANA через SAP HANA Studio. В приведенном ниже примере показано, как выполнить восстановление до последнего моментального снимка HANA. Моментальный снимок хранилища внедряет моментальный снимок HANA. При восстановлении до последнего моментального снимка хранилища это будет последний моментальный снимок HANA. (При восстановлении до более старого моментального снимка хранилища найдите моментальный снимок HANA на основе времени создания моментального снимка хранилища.)

   ![Выбор параметров восстановления в SAP HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image10-recover-options-a.png)

1. Установите переключатель **Recover the database to a specific data backup or storage snapshot** (Восстановить базу данных до определенной резервной копии или моментального снимка хранилища).

   ![Окно Specify Recovery Type (Выбор типа восстановления)](./media/hana-overview-high-availability-disaster-recovery/image11-recover-options-b.png)

1. Установите переключатель **Specify backup without catalog** (Указать резервную копию без каталога).

   ![Окно Specify Backup Location (Указание расположения резервной копии)](./media/hana-overview-high-availability-disaster-recovery/image12-recover-options-c.png)

1. В списке **Destination Type** (Тип назначения) выберите **Snapshot** (Моментальный снимок).

   ![Окно Specify the Backup to Recover (Указание резервной копии для восстановления)](./media/hana-overview-high-availability-disaster-recovery/image13-recover-options-d.png)

1. Нажмите кнопку **Готово**, чтобы запустить процесс восстановления.

    ![Кнопка "Готово", чтобы запустить процесс восстановления](./media/hana-overview-high-availability-disaster-recovery/image14-recover-options-e.png)

1. Восстановление базы данных HANA выполняется в моментальный снимок HANA, добавленный моментальным снимком хранилища.

    ![Восстановление базы данных HANA в моментальный снимок HANA](./media/hana-overview-high-availability-disaster-recovery/image15-recover-options-f.png)

### <a name="recover-to-the-most-recent-state"></a>Восстановление до последнего состояния

Здесь описывается восстановление моментального снимка HANA, содержащегося в моментальном снимке хранилища. Затем выполняется восстановление резервных копий журнала транзакций до последнего состояния базы данных перед восстановлением моментального снимка хранилища.

>[!IMPORTANT]
>Прежде чем продолжить, завершите создание цепочки последовательных резервных копий журнала транзакций. Без этих резервных копий невозможно восстановить текущее состояние базы данных.

1. Выполните шаги 1–6, описанные в разделе "Восстановление до последнего моментального снимка HANA".

1. Установите переключатель **Recover the database to its most recent state** (Восстановить базу данных до последнего состояния).

   ![Установка переключателя Recover the database to its most recent state (Восстановить базу данных до последнего состояния).](./media/hana-overview-high-availability-disaster-recovery/image16-recover-database-a.png)

1. Укажите расположение последних резервных копий журнала HANA. В этом расположении должны находиться все резервные копии журналов транзакций HANA от моментального снимка HANA до последнего состояния.

   ![Указание расположения последних резервных копий журнала HANA](./media/hana-overview-high-availability-disaster-recovery/image17-recover-database-b.png)

1. Выберите резервную копию, из которой нужно выполнить восстановление базы данных. В нашем примере на снимке экрана показан моментальный снимок HANA, включенный в моментальный снимок хранилища. 

   ![Выбор резервной копии, из которой нужно выполнить восстановление базы данных](./media/hana-overview-high-availability-disaster-recovery/image18-recover-database-c.png)

1. Снимите флажок **Use Delta Backups** (Использовать измененные резервные копии), если в промежуток между созданием моментального снимка HANA и последним состоянием в резервные копии не вносились изменения.

   ![Флажок Use Delta Backups (Использовать измененные резервные копии), который нужно снять, если изменения не вносились](./media/hana-overview-high-availability-disaster-recovery/image19-recover-database-d.png)

1. В окне сводки нажмите кнопку **Готово**, чтобы запустить процедуру восстановления.

   ![Кнопка Finish (Готово) в окне сводки](./media/hana-overview-high-availability-disaster-recovery/image20-recover-database-e.png)

### <a name="recover-to-another-point-in-time"></a>Восстановление до другой точки во времени
Чтобы выполнить восстановление на момент между созданием моментального снимка HANA (включенного в моментальный снимок хранилища) и более позднего моментального снимка, выполните следующие шаги:

1. Соберите все резервные копии журнала транзакций от момента создания моментального снимка HANA до момента восстановления.
1. Выполните процедуру, описанную в разделе "Восстановление до последнего состояния".
1. На шаге 2 процедуры в окне **Specify Recovery Type** (Выбор типа восстановления) установите переключатель **Recover the database to the following point in time** (Восстановить базу данных до следующей точки во времени), а затем укажите точку во времени. 
1. Завершите шаги 3–6.

## <a name="monitor-the-execution-of-snapshots"></a>Мониторинг создания моментальных снимков

При использовании моментальных снимков хранилища крупных экземпляров HANA необходимо также следить за созданием этих моментальных снимков. При выполнении сценария создания моментального снимка хранилища выходные данные записываются в файл, а сам файл сохраняется в том же расположении, что и сценарии Perl. Для каждого моментального снимка хранилища записывается отдельный файл. На основе выходных данных в каждом файле можно четко понять различные этапы, которые выполняет сценарий создания моментальных снимков:

1. поиск томов, для которых необходимо создать моментальные снимки;
1. Поиск моментальных снимков этих томов.
1. Удаление имеющихся моментальных снимков в соответствии с указанным их количеством.
1. Создание моментального снимка SAP HANA.
1. Создание моментального снимка хранилища для тома.
1. Удаление моментального снимка SAP HANA.
1. Переименование последнего моментального снимка в **.0**.

Наиболее важной частью CAB-файла сценария является следующая:
```
**********************Creating HANA snapshot**********************
Creating the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data create snapshot"" ...
HANA snapshot created successfully.
**********************Creating Storage snapshot**********************
Taking snapshot hourly.recent for hana_data_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_backup_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_shared_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for sapmnt_lhanad01_t020_vol ...
Snapshot created successfully.
**********************Deleting HANA snapshot**********************
Deleting the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data drop snapshot"" ...
HANA snapshot deletion successfully.
```
В этом примере видно, как скрипт записывает создание моментального снимка HANA. В случае горизонтального масштабирования этот процесс инициируется на главном узле. Главный узел инициирует синхронное создание моментальных снимков SAP HANA всех рабочих узлов. Затем создается моментальный снимок хранилища. После создания этого снимка моментальный снимок HANA удаляется. Удаление моментального снимка HANA инициируется из главного узла.


**Дальнейшие действия**
- Дополнительные сведения см. в статье [Принципы аварийного восстановления](hana-concept-preparation.md).
