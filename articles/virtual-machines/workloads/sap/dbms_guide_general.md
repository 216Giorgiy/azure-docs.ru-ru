---
title: Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure | Документы Майкрософт
description: Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure
services: virtual-machines-linux,virtual-machines-windows
documentationcenter: ''
author: msjuergent
manager: patfilot
editor: ''
tags: azure-resource-manager
keywords: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/04/2018
ms.author: juergent
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 54511ac4dfdc05ec1880695b1ae2360f0b5e8162
ms.sourcegitcommit: d2329d88f5ecabbe3e6da8a820faba9b26cb8a02
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/16/2019
ms.locfileid: "56328373"
---
# <a name="considerations-for-azure-virtual-machines-dbms-deployment-for-sap-workload"></a>Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure
[1114181]:https://launchpad.support.sap.com/#/notes/1114181
[1409604]:https://launchpad.support.sap.com/#/notes/1409604
[1597355]:https://launchpad.support.sap.com/#/notes/1597355
[1928533]:https://launchpad.support.sap.com/#/notes/1928533
[1984787]:https://launchpad.support.sap.com/#/notes/1984787
[1999351]:https://launchpad.support.sap.com/#/notes/1999351
[2002167]:https://launchpad.support.sap.com/#/notes/2002167
[2015553]:https://launchpad.support.sap.com/#/notes/2015553
[2039619]:https://launchpad.support.sap.com/#/notes/2039619
[2069760]:https://launchpad.support.sap.com/#/notes/2069760
[2171857]:https://launchpad.support.sap.com/#/notes/2171857
[2178632]:https://launchpad.support.sap.com/#/notes/2178632
[2191498]:https://launchpad.support.sap.com/#/notes/2191498
[2233094]:https://launchpad.support.sap.com/#/notes/2233094
[2243692]:https://launchpad.support.sap.com/#/notes/2243692
[deployment-guide]:deployment-guide.md
[deployment-guide-3]:deployment-guide.md#b3253ee3-d63b-4d74-a49b-185e76c4088e
[planning-guide]:planning-guide.md

[Logo_Linux]:media/virtual-machines-shared-sap-shared/Linux.png
[Logo_Windows]:media/virtual-machines-shared-sap-shared/Windows.png


[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-rm-include.md)]

Это руководство — часть документации по внедрению и развертыванию программного обеспечения SAP в Microsoft Azure. Перед ознакомлением с этим руководством прочитайте статью [SAP NetWeaver на виртуальных машинах Azure. Руководство по планированию и реализации][planning-guide]. В этом документе рассматриваются аспекты универсального развертывания СУБД, связанного с SAP, на виртуальных машинах Microsoft Azure с использованием возможностей Azure IaaS.

Это руководство дополняет документацию по установке SAP и комментарии по SAP, которые являются основными ресурсами по установке и развертыванию SAP на упомянутых платформах.

В этом документе рассматриваются вопросы запуска связанных с SAP систем СУБД на виртуальных машинах Azure. Также здесь приводятся ссылки на конкретные СУБД. Конкретные СУБД рассматриваются ниже, после этой главы.

## <a name="definitions-upfront"></a>Определения
В этом документе мы будем использовать следующие термины:

* IaaS: инфраструктура как услуга
* PaaS: платформа как услуга
* SaaS: программное обеспечение как услуга
* Компонент SAP: отдельное приложение SAP, например ECC, BW, Solution Manager или EP. Компоненты SAP могут основываться на традиционной технологии ABAP или Java или быть приложениями не на основе NetWeaver, например бизнес-объектами.
* Среда SAP: один или несколько компонентов SAP, логически сгруппированных для выполнения бизнес-функции (разработка, оценка качества, обучение, аварийное восстановление или производство).
* Ландшафт SAP: этот термин обозначает все ресурсы SAP, доступные в клиентском ИТ-ландшафте. Ландшафт SAP включает все рабочие и нерабочие среды.
* Система SAP: сочетание уровня СУБД и уровня приложений системы разработки SAP ERP, например, тестовой системы SAP BW, рабочей системы SAP CRM и т. д. В развертываниях Azure не поддерживается разделение этих двух уровней между локальной средой и Azure. Таким образом, систему SAP необходимо развернуть полностью в локальной среде или полностью в Azure. Но при этом вы можете развертывать разные системы ландшафта SAP как в Azure, так и локально. Например, системы разработки и тестирования SAP CRM можно развернуть в Azure, а производственную систему SAP CRM — в локальной среде.
* Распределенное развертывание: описывает сценарии, при которых в подписке Azure развернуты виртуальные машины с подключениями типа "сеть – сеть" или ExpressRoute между локальными центрами обработки данных и Azure. В документации Azure развертывания такого рода также называются распределенными развертываниями. Такое подключение используется для расширения в Azure локальных доменов, локальной службы Active Directory и локальной службы DNS. Локальная среда распространяется на ресурсы Azure, входящие в подписку. При таком расширении виртуальные машины могут быть частью локального домена. Пользователи локального домена имеют доступ к серверам и могут запускать службы на этих виртуальных машинах (например, службы СУБД). Возможно взаимодействие и разрешение имен между виртуальными машинами, развернутыми в локальной сети и Azure. Этот сценарий является наиболее распространенным сценарием развертывания ресурсов SAP в Azure. Дополнительные сведения см. в разделе [Планирование и проектирование VPN-шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-plan-design).

> [!NOTE]
> Для производственных систем SAP поддерживаются распределенные развертывания систем SAP, в которых системы SAP выполняются на виртуальных машинах Azure, являющихся членами локального домена. Распределенная конфигурация предполагает развертывание в Azure полного ландшафта SAP или его частей. Даже если весь ландшафт SAP работает в Azure, эти виртуальные машины должны входить в локальный домен и каталог AD/LDAP. В прежних версиях этого документа мы говорили о гибридных сценариях ИТ-систем, где термин *гибридные* применялся на том основании, что между локальной сетью и Azure существует распределенное подключение. Кроме того, термин *гибридные* также обозначает, что развернутые в Azure виртуальные машины являются частью локальной системы Active Directory.
>
>

В некоторой документации Майкрософт сценарии распределенного подключения описываются иначе. В частности, это касается высокодоступных конфигураций СУБД. В документации по SAP сценарий распределенного подключения сводится к двум моментам: к наличию подключения типа "сеть-сеть" или частного подключения [ExpressRoute](https://azure.microsoft.com/services/expressroute/), а также к распределению ландшафта SAP между локальной сетью и Azure.

## <a name="resources"></a>Ресурсы
Существуют различные статьи, посвященные использованию рабочей нагрузки SAP в Azure. Рекомендуется начать со статьи [Рабочая нагрузка SAP в Azure — приступая к работе](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/get-started) и затем выбрать интересующую вас область

Следующие примечания SAP относятся к использованию SAP в Azure в области, описанной в настоящем документе:

| Номер примечания | Название |
| --- | --- |
| [1928533] |Приложения SAP в Azure: поддерживаемые продукты и типы виртуальных машин Azure |
| [2015553] |SAP в Microsoft Azure: необходимые компоненты для поддержки |
| [1999351] |Устранение неполадок, связанных с расширенным мониторингом Azure для SAP |
| [2178632] |Ключевые метрики мониторинга для SAP в Microsoft Azure |
| [1409604] |Виртуализация в Windows: расширенный мониторинг |
| [2191498] |SAP на платформе Linux в Azure: расширенный мониторинг |
| [2039619] |Приложения SAP в Microsoft Azure с использованием Oracle Database: поддерживаемые продукты и версии |
| [2233094] |DB6: приложения SAP в Azure с использованием IBM DB2 для Linux, UNIX и Windows – дополнительные сведения |
| [2243692] |Linux на виртуальной машине Microsoft Azure (IaaS): проблемы с лицензированием SAP |
| [1984787] |SUSE Linux Enterprise Server 12 Замечания по установке |
| [2002167] |Red Hat Enterprise Linux 7.x: установка и обновление |
| [2069760] |Установка и обновление Oracle Linux 7.x SAP |
| [1597355] |Рекомендация по области буфера для Linux |
| [2171857] |Oracle Database 12c: поддержка файловой системы в Linux |
| [1114181] |Oracle Database 11g: поддержка файловой системы в Linux |


Ознакомьтесь также с разделом [вики-сайта SCN](https://wiki.scn.sap.com/wiki/display/HOME/SAPonLinuxNotes), где представлены все примечания к SAP для Linux.

Вы узнаете об архитектуре Microsoft Azure и о том, как развертываются и эксплуатируются виртуальные машины Microsoft Azure. Дополнительные сведения можно найти в [документации по Azure](https://docs.microsoft.com/azure/).

Для IaaS установка и настройка Windows, Linux и СУБД в целом выполняются так же, как и для любой локальной виртуальной машины или локального физического компьютера. Но некоторые решения, связанные с архитектурой и реализацией управления системой, в Azure IaaS все же отличаются. В этом документе объясняются конкретные различия в архитектуре и управлении системой, которые следует учитывать при использовании Azure IaaS.


## <a name="65fa79d6-a85f-47ee-890b-22e794f51a64"></a>Структура хранилища виртуальной машины для развертывания реляционной СУБД
Прежде чем вы продолжите чтение, давайте вспомним, о чем шла речь в [этом][deployment-guide-3] разделе [руководства по развертыванию][deployment-guide]. Перед прочтением этой главы вы должны разобраться в различных сериях виртуальных машин и понять разницу между ними, а также понять разницу между службами хранилища ценовых категорий "Стандартный" и "Премиум". Для

Чтобы ознакомиться со службой хранилища Azure для виртуальных машин Azure, прочтите следующие статьи:

- [Статья с общими сведениями об управляемых дисках для ВМ Azure в Windows](../../windows/managed-disks-overview.md).
- [Статья с общими сведениями об управляемых дисках для ВМ Azure в Linux](../../linux/managed-disks-overview.md).

В базовой конфигурации мы обычно рекомендуем структуру развертывания, в которой операционная система, СУБД и двоичные файлы SAP отделены от файлов базы данных. Поэтому рекомендуется, чтобы в системах SAP на виртуальных машинах Azure были установлены виртуальные жесткие диски (или физические диски) с операционной системой, исполняемыми файлами СУБД и исполняемыми файлами SAP. Файлы данных СУБД и журналов будут храниться в службе хранилища Azure (класса Standard или Premium) в отдельных файлах дисков и присоединяться в качестве логических дисков к исходной виртуальной машине с образом операционной системы Azure. В частности, в документации могут быть приведены различные рекомендации для развертываний в Linux. В особенности это касается SAP HANA.

При планировании структуры диска необходимо найти оптимальный баланс между следующими компонентами:

* Количество файлов данных.
* Число дисков, содержащих файлы.
* Количество операций ввода-вывода для одного диска.
* Пропускная способность каждого диска.
* Количество дополнительных доступных дисков в зависимости от размера виртуальной машины.
* Общая пропускная способность хранилища, которую может предоставить виртуальная машина.
* Задержка для различных типов хранилища Azure.
* Соглашения об уровне обслуживания для виртуальной машины

Azure обеспечивает квоту на количество операций ввода-вывода для каждого диска данных. Эти квоты различаются для дисков, размещенных в службе хранилища Azure классов Standard и Premium. Задержка ввода-вывода для двух типов хранилищ также различается. Хранилище класса Premium обладает меньшей задержкой ввода-вывода. Каждый из типов виртуальных машин поддерживает присоединение ограниченного количества дисков. Другое ограничение состоит в том, что только некоторые типы виртуальных машин могут использовать службу хранилища Azure класса Premium. В результате решение для определенного типа виртуальной машины может приниматься не только на основе требований к ЦП и памяти, но и на основе требований к операциям ввода-вывода, задержке и пропускной способности диска, которые обычно масштабируются в зависимости от количества дисков или типа дисков хранилища класса Premium. В частности, для хранилища класса Premium размер диска также может зависеть от количества операций ввода-вывода и пропускной способности, которая должна достигаться каждым диском.

> [!NOTE]
> В развертываниях СУБД настоятельно рекомендуется использовать хранилище класса Premium для данных, журналов транзакций и файлов повторных операций. Поэтому неважно, развертываете ли вы систему, предназначенную или не предназначенную для рабочей среды.

> [!NOTE]
> Чтобы воспользоваться преимуществами уникального [Соглашения об уровне обслуживания для одной виртуальной машины](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_8/), необходимо сделать так, чтобы все диски, подключенные к этой виртуальной машине, включая основной виртуальный жесткий диск, имели тип службы хранилища Azure класса Premium.

> [!NOTE]
> Нельзя размещать основные файлы (файлы данных и журналов) баз данных SAP на оборудовании для хранения данных в расположении, где сторонние центры обработки данных размещаются вместе с центрами обработки данных Azure. Для хранения файлов данных и журнала транзакций баз данных SAP в рабочей нагрузке SAP можно использовать только хранилище, представленное в виде собственной службы Azure.

Расположение файлов баз данных, файлов журналов и файлов повторных операций, а также тип используемой службы хранилища Azure должны определяться требованиями к операциям ввода-вывода, задержкам и пропускной способности. Чтобы обеспечить достаточное количество операций ввода-вывода в секунду, необходимо использовать несколько дисков или использовать диск хранилища Premium большего размера. В случае использования нескольких дисков необходимо создать полосу программного чередования между дисками, содержащими файлы данных, файлы журнала и файлы повторных операций. В таких случаях соглашения об уровне обслуживания для операций ввода-вывода в секунду и пропускной способности диска или максимально возможное число операций ввода-вывода в секунду для дисков хранилища Azure класса Standard являются накопительными для результирующего чередующегося набора.

Как уже упоминалось, если ваши требования к числу операций ввода-вывода в секунду превышают возможности одного виртуального жесткого диска, необходимо сбалансировать необходимое количество операций ввода-вывода в секунду для файлов баз данных между несколькими виртуальными жесткими дисками. Самый простой способ распределить нагрузку по числу операций ввода-вывода в секунду между дисками — создать полосу программного чередования между несколькими дисками. Затем следует поместить ряд файлов данных СУБД SAP в LUN, полученные из полосы программного чередования. Число дисков в полосе определяется требованиям к операциям ввода-вывода, пропускной способности диска и размеру пространства.


- - -
> ![ Windows][Logo_Windows]  Windows
>
> Мы рекомендуем использовать дисковые пространства Windows для создания таких чередующихся наборов между несколькими виртуальными жесткими дисками Azure. Рекомендуется использовать Windows Server 2012 R2, Windows Server 2016 или более поздние версии.
>
> ![Linux][Logo_Linux] Linux
>
> Для создания программного RAID-массива в Linux поддерживаются только MDADM и LVM (диспетчер логических томов). Дополнительные сведения см. в следующих статьях:
>
> - [Настройка программного RAID-массива в Linux](https://docs.microsoft.com/azure/virtual-machines/linux/configure-raid) с помощью MDADM
> - [Настройка диспетчера логических томов на виртуальной машине Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/configure-lvm) с помощью диспетчера логических томов
>
>

- - -

> [!NOTE]
> Так как в службе хранилища Azure хранятся три образа виртуальных жестких дисков, настраивать избыточность при чередовании не нужно. Необходимо настроить чередование так, чтобы операции ввода-вывода распределялись между различными виртуальными жесткими дисками.
>

### <a name="managed-or-non-managed-disks"></a>Управляемые и неуправляемые диски
Учетная запись хранения Azure является не только административной конструкцией, но и предметом ограничений. Ограничения учетных записей Azure классов Standard и Premium различны. Точное описание возможностей и ограничений приведено в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-scalability-targets).

Для службы хранилища Azure класса Standard важно отметить ограничение количества операций ввода-вывода на учетную запись хранения (см. строку, содержащую фразу **Общая частота запросов**, в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-scalability-targets)). Кроме того, существует изначальное ограничение на количество учетных записей хранения в одной подписке Azure. Таким образом, вам необходимо сбалансировать виртуальные жесткие диски для более крупного ландшафта SAP между несколькими учетными записями хранения, чтобы избежать превышения ограничений этих учетных записей. Если у вас несколько сотен виртуальных машин, а количество виртуальных жестких дисков превышает тысячу, это утомительная работа.

Так как для развертываний СУБД совместно с рабочей нагрузкой SAP не рекомендуется использовать хранилище Azure класса Standard, ссылки и рекомендации для хранилища Azure класса Standard ограничены этой [короткой статьей](https://blogs.msdn.com/b/mast/archive/2014/10/14/configuring-azure-virtual-machines-for-optimal-storage-performance.aspx).

Чтобы избежать административной работы, связанной с планированием и развертыванием виртуальных жестких дисков в разных учетных записях хранения Azure, корпорация Майкрософт в 2017 году представила так называемые [управляемые диски](https://azure.microsoft.com/services/managed-disks/). Управляемые диски доступны для хранилища Azure классов Standard и Premium. Основные преимущества управляемых дисков по сравнению с неуправляемыми дисками таковы:

- Для управляемых дисков Azure автоматически распределяет различные виртуальные жесткие диски между разными учетными записями хранения во время развертывания и тем самым исключает вероятность превышения ограничений по объему данных, пропускной способности операций ввода-ввода и числу операций ввода-вывода в секунду для учетной записи хранения Azure.
- Благодаря управляемым дискам служба хранилища Azure поддерживает концепции групп доступности и с использованием этих принципов развертывает основной виртуальный жесткий диск, подключенный диск жесткого диска и подключенный диск виртуальной машины в разных доменах сбоя и обновления, если виртуальная машина входит в группу доступности Azure.


> [!IMPORTANT]
> Учитывая преимущества управляемых дисков Azure, настоятельно рекомендуется использовать управляемые диски Azure для развертываний СУБД и SAP в целом.
>

Чтобы переключить неуправляемые диски на управляемые, обратитесь к следующим статьям:

- [Переключение виртуальной машины Windows с неуправляемых на управляемые диски](https://docs.microsoft.com/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks)
- [Переключение виртуальной машины Linux с неуправляемых на управляемые диски](https://docs.microsoft.com/azure/virtual-machines/linux/convert-unmanaged-to-managed-disks)


### <a name="c7abf1f0-c927-4a7c-9c1d-c7b5b3b7212f"></a>Кэширование для виртуальных машин и дисков данных
При подключении дисков к виртуальным машинам вы можете выбрать, будет ли кэшироваться трафик ввода-вывода между виртуальной машиной и этими дисками, размещенными в хранилище Azure. В службе хранилища Azure классов Standard и Premium для этого типа кэша используются две разные технологии.

Приведенные ниже рекомендации даны исходя из следующих характеристик ввода-вывода для СУБД уровня "Стандартный":

- Главным образом используются рабочие нагрузки чтения для файлов данных базы данных. Производительность этих операций чтения критически важна для СУБД
- Запись в файлы данных возникает скачкообразно на основе контрольных точек или постоянного потока. Тем не менее средний объем операций записи за день меньше среднего объема операций чтения. В отличие от операций чтения из файлов данных эти операции записи являются асинхронными и не задерживают пользовательские транзакции.
- Вряд ли возникнут другие ситуации, когда понадобится чтение из журнала транзакций или файлов повторных операций. Исключениями являются крупные операции ввода-вывода при резервном копировании журналов транзакций.
- Основной нагрузкой для файлов журнала транзакций и файлов повторных операций являются операции записи. В зависимости от характера рабочей нагрузки можно иметь операции ввода-вывода размером 4 КБ, тогда как в других случаях размер может превышать 1 МБ.
- Все операции записи необходимо сохранить на диске надежным образом

Для службы хранилища Azure класса Standard возможны следующие типы кэша:

* Нет
* чтение
* Чтение/запись

Согласованную и предсказуемую производительность можно получить, задав значение "NONE" для параметра кэширования в службе хранилища Azure класса Standard для всех дисков, содержащих **файлы данных, связанные с СУБД, файлы журналов, файлы повторных операций и табличное пространство**. Для параметров кэширования основного виртуального жесткого диска можно оставить значения по умолчанию.

Для службы хранилища Azure класса Premium существуют следующие режимы кэширования:

* Нет
* чтение
* Чтение/запись
* Нет + ускоритель записи (только для виртуальных машин Azure серии M)
* Чтение + ускоритель записи (только для виртуальных машин Azure серии M)

Для хранилища Azure класса Premium рекомендуется использовать параметр **Read caching for data files** (Кэширование чтения файлов данных) базы данных SAP и выбрать **No caching for the disks of log file(s)** (Без кэширования дисков файлов журнала).

Для виртуальных машин серии M настоятельно рекомендуется использовать ускоритель записи Azure для развертывания СУБД. Дополнительные сведения об ускорителе записи, его ограничениях и развертывании см. в документе [Ускоритель записи](https://docs.microsoft.com/azure/virtual-machines/windows/how-to-enable-write-accelerator).


### <a name="azure-non-persistent-disks"></a>Временные диски Azure
Виртуальные машины Azure предлагают временные диски после развертывания виртуальной машины. В случае перезагрузки виртуальной машины все содержимое временных дисков будет удалено. Поэтому на этих дисках ни в коем случае не следует замещать файлы данных, файлы журнала и файлы повторных операций баз данных. Для некоторых баз данных возможны исключения: для них разрешается размещать на временных дисках табличные пространства tempdb и temp. Однако не следует использовать эти диски для виртуальных машин серии A, так как пропускная способность временных дисков с этим семейством виртуальных машин ограничена. Дополнительные сведения см. в статье [Сведения о временных дисках на виртуальных машинах Windows в Azure](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/)

- - -
> ![ Windows][Logo_Windows]  Windows
>
> D:\ на виртуальной машине Azure — это несохраняемый диск, поддерживаемый некоторыми локальными дисками на вычислительном узле Azure. Несохраняемый означает, что любые изменения содержимого диска D:\ теряются при перезагрузке виртуальной машины. Под любыми изменениями подразумевается сохранение файлов, создание каталогов, установка приложений и т. д.
>
> ![Linux][Logo_Linux] Linux
>
> Виртуальные машины Azure под управлением Linux автоматически подключают диск к каталогу /mnt/resource — несохраняемому диску, который поддерживается локальными дисками на вычислительном узле Azure. Несохраняемый обозначает, что любые изменения содержимого каталога /mnt/resource теряются при перезагрузке виртуальной машины. Под любыми изменениями подразумевается сохранение файлов, создание каталогов, установка приложений и т. д.
>
>

- - -



### <a name="10b041ef-c177-498a-93ed-44b3441ab152"></a>Устойчивость службы хранилища Microsoft Azure
Основной виртуальный жесткий диск (с ОС) и подключенные диски размещаются в службе хранилища Microsoft Azure не менее чем на трех различных узлах хранилища. Такое хранилище называется локально избыточным (LRS). LRS используется по умолчанию для всех типов хранилищ в Azure.

Существует несколько дополнительных методов избыточности, которые описаны в статье [Репликация службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-redundancy?toc=%2fazure%2fstorage%2fqueues%2ftoc.json).

> [!NOTE]
>Для хранилища Azure класса Premium, которое рекомендуется использовать для виртуальных машин СУБД и дисков, на которых находятся база данных, файлы журналов и файлы повторных операций, единственный доступный метод — LRS. Таким образом, необходимо настроить методы базы данных, SQL Server AlwaysOn, Oracle Data Guard и репликация системы HANA, чтобы включить репликацию данных базы данных в другой регион Azure или в другую зону доступности Azure.


> [!NOTE]
> Для развертываний СУБД не рекомендуется использовать географически избыточное хранилище, которое доступно для хранилища Azure класса Standard, так как оно оказывает серьезное влияние на производительность и не учитывает порядок записи для различных виртуальных жестких дисков, подключенных к виртуальной машине. Игнорирование порядка записи для различных виртуальных жестких дисков с высокой вероятностью приведет к несогласованности баз данных на целевой стороне репликации, если файлы журнала или файлы повторных операций распределены между несколькими виртуальными жесткими дисками (как обычно бывает) на стороне исходной виртуальной машины.



## <a name="vm-node-resiliency"></a>Устойчивость узлов виртуальной машины
Платформа Azure предоставляет несколько разных соглашений об уровне обслуживания для виртуальных машин. Точные сведения можно найти в последнем выпуске [Соглашения об уровне обслуживания для виртуальных машин](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_8/). Так как уровень СУБД обычно является важнейшим компонентом доступности системы SAP, необходимо ознакомиться с понятиями группы доступности, зоны доступности и событий обслуживания. Все эти понятия описаны в статьях [Управление доступностью виртуальных машин Windows в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/manage-availability) и [Управление доступностью виртуальных машин Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/manage-availability).

Минимальная рекомендация для рабочих сценариев СУБД с рабочей нагрузкой SAP такова:

- Разверните две виртуальные машины в отдельных группах доступности в одном регионе Azure.
- Эти две виртуальные машины будут работать в одной и той же виртуальной сети Azure, и их сетевые адаптеры будут подключены к одной и той же подсети.
- Используйте методы базы данных для сервера горячей замены на второй виртуальной машине. Можно использовать такие методы, как SQL Server AlwaysOn, Oracle Data Guard и репликация системы HANA.

Кроме того, можно развернуть третью виртуальную машину в другом регионе Azure и использовать те же методы базы данных, чтобы предоставить асинхронную реплику в другом регионе Azure.

Настройка групп доступности Azure описана в [этом](https://docs.microsoft.com/azure/virtual-machines/windows/tutorial-availability-sets) руководстве.



## <a name="azure-network-considerations"></a>Рекомендации по сети Azure
Для крупномасштабных развертываний SAP рекомендуется использовать схему [виртуального центра обработки данных Azure](https://docs.microsoft.com/azure/architecture/vdc/networking-virtual-datacenter) для настройки виртуальной сети и для назначения разрешений и ролей для различных частей организации.

Существует ряд проверенных рекомендаций, которые позволили успешно завершить несколько сотен клиентских развертываний:

- Виртуальные сети, в которые развертывается приложение SAP, не должны иметь доступ к Интернету.
- Виртуальные машины баз данных должны работать в той же подсети, что и прикладной уровень.
- Для виртуальных машин в виртуальной сети должно использоваться статическое выделение частных IP-адресов. Для справки можно использовать статью [Типы IP-адресов и методы распределения в Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm).
- Ограничения маршрутизации к виртуальным машинам СУБД и от них задаются **НЕ** с помощью брандмауэров, установленных на локальных виртуальных машинах СУБД. Вместо этого определяется маршрутизация трафика с использованием [групп безопасности сети Azure](https://docs.microsoft.com/azure/virtual-network/security-overview).
- Для разделения и изоляции трафика к виртуальной машине СУБД необходимо назначить виртуальной машине разные сетевые адаптеры. У каждого сетевого адаптера есть собственный IP-адрес, и каждый сетевой адаптер назначен собственной подсети виртуальной машины, в которой используются собственные правила группы безопасности сети. Помните, что изоляция или разделение сетевого трафика — это способ маршрутизации, и с их помощью невозможно установить квоты для пропускной способности сети.

> [!NOTE]
> Отдельным виртуальным сетевым адаптерам следует назначить статические IP-адреса с помощью Azure. Не следует назначать статические IP-адреса для виртуальных сетевых адаптеров в гостевой ОС. Некоторые службы Azure, такие как служба Azure Backup, полагаются на тот факт, что по крайней мере для основного виртуального сетевого адаптера используется DHCP, а не статические IP-адреса. См. дополнительные сведения в статье [Устранение неполадок при архивации виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#networking). Если виртуальной машине нужно присвоить несколько статических IP-адресов, ей также необходимо присвоить несколько виртуальных сетевых адаптеров.
>


> [!IMPORTANT]
> Из соображений функциональности и, что более важно, из соображений производительности в пути взаимодействия между приложением SAP и уровнем СУБД SAP NetWeaver, системой SAP Hybris или S/4HANA не поддерживается настройка [виртуальных сетевых модулей Azure (NVA)](https://azure.microsoft.com/solutions/network-appliances/). Связь между прикладным уровнем SAP и уровнем СУБД должна быть прямой. Это ограничение не относится к [правилам групп безопасности приложений и сети в Azure](https://docs.microsoft.com/azure/virtual-network/security-overview), если эти правила разрешают прямую связь. Виртуальные сетевые модули также не поддерживаются в путях взаимодействия между виртуальными машинами Azure, представляющими узлы кластера Pacemaker в Linux, и устройствами SBD, как описано в статье [Руководство по обеспечению высокого уровня доступности виртуальных машин Azure для SAP NetWeaver на SUSE Linux Enterprise Server для приложений SAP](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-suse). Они также не поддерживаются в путях взаимодействия между виртуальными машинами Azure и Windows Server SOFS, настроенными, как описано в статье [Кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью файлового ресурса в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-high-availability-guide-wsfc-file-share). Виртуальные сетевые модули в путях взаимодействия могут легко удвоить задержку в сети между двумя партнерами по взаимодействию и ограничить пропускную способность в критических путях между уровнем приложений SAP и уровнем СУБД. В некоторых сценариях, наблюдаемых клиентами, виртуальные сетевые модули могут привести к сбоям кластеров Pacemaker Linux в случаях, когда узлы кластера Linux Pacemaker должны взаимодействовать с устройством SBD через эти модули.
>

> [!IMPORTANT]
> Еще одно **НЕПОДДЕРЖИВАЕМОЕ** решение – разделение прикладного уровня SAP и уровня СУБД на разные виртуальные сети Azure, не являющиеся [одноранговыми](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview). Чтобы отделить прикладной уровень SAP от уровня СУБД, рекомендуем использовать подсети одной виртуальной сети Azure, а не разные виртуальные сети Azure. Если вы решите не следовать этой рекомендации, а разделить два уровня на разные виртуальные сети, то эти виртуальные сети должны быть [одноранговыми](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview). Учтите, что за передачу трафика между двумя [одноранговыми](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview) виртуальными сетями Azure взимается плата. Обмен большими объемами данных, насчитывающими много терабайтов, между прикладным уровнем SAP и уровнем СУБД может повлечь за собой существенные затраты, если прикладной уровень SAP и уровень СУБД находятся в разных одноранговых виртуальных сетях Azure.

Общая схема системы с двумя виртуальными машинами для развертывания рабочей среды СУБД в группе доступности Azure, а также с отдельной маршрутизацией прикладного уровня SAP и трафика управления и операций на две виртуальные машины СУБД выглядит следующим образом:

![Схема двух виртуальных машин в двух подсетях](./media/virtual-machines-shared-sap-deployment-guide/general_two_dbms_two_subnets.PNG)


### <a name="azure-load-balancer-for-redirecting-traffic"></a>Подсистема балансировки нагрузки Azure для перенаправления трафика
Для использования частных виртуальных IP-адресов, применяемых в таких методах, как SQL Server AlwaysOn или репликация системы HANA, необходимо настроить Azure Load Balancer. Azure Load Balancer может определить активный узел с помощью проверки портов и направить трафик только на этот активный узел базы данных. В случае отработки отказа для узла базы данных повторно настраивать приложение SAP не нужно. Вместо этого в большинстве распространенных архитектур SAP будет выполнено повторное подключение на частный виртуальный IP-адрес. В то же время подсистема балансировки нагрузки Azure реагирует на отработку отказа узла, перенаправляя трафик на частный виртуальный IP-адрес второго узла.

Azure предоставляет два различных [номера SKU подсистемы балансировки нагрузки](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview). SKU уровня "Базовый" и SKU уровня "Стандартный". Если вы хотите выполнить развертывание в зонах доступности Azure, вам подойдет подсистема балансировки нагрузки для SKU уровня "Базовый".

Всегда ли трафик между виртуальными машинами СУБД и прикладным уровнем SAP направляется через подсистему балансировки нагрузки? Ответ зависит от того, как настроить подсистему балансировки нагрузки. Сейчас входящий трафик к виртуальной машине СУБД всегда направляется через подсистему балансировки нагрузки Azure. Маршрут исходящего трафика от виртуальной машины СУБД на прикладной уровень виртуальной машины зависит от конфигурации подсистемы балансировки нагрузки Azure. В подсистеме балансировки нагрузки можно установить значение параметра DirectServerReturn. Если этот параметр установлен, трафик от виртуальной машины СУБД на прикладной уровень SAP **не** будет перенаправляться через подсистему балансировки нагрузки Azure. Вместо этого он будет направляться непосредственно на прикладной уровень. Если DirectServerReturn не установлен, трафик, возвращаемый на прикладной уровень SAP, направляется через подсистему балансировки нагрузки Azure.

Рекомендуется настроить параметр DirectServerReturn в сочетании с подсистемами балансировки нагрузки Azure, которые расположены между прикладным уровнем SAP и уровнем СУБД, чтобы уменьшить задержки в сети между двумя уровнями.

Пример настройки такой конфигурации, опубликованной в SQL Server AlwaysOn, см. в [этой статье](https://docs.microsoft.com/azure/virtual-machines/windows/sqlclassic/virtual-machines-windows-classic-ps-sql-int-listener).

Если вы решили использовать опубликованные шаблоны JSON GitHub в качестве основы для развертывания инфраструктуры в Azure, изучите этот [шаблон для трехуровневой системы SAP](https://github.com/Azure/azure-quickstart-templates/tree/4099ad9bee183ed39b88c62cd33f517ae4e25669/sap-3-tier-marketplace-image-converged-md). В этом шаблоне также можно изучить правильные настройки подсистемы балансировки нагрузки Azure.

### <a name="azure-accelerated-networking"></a>Ускорение работы в сети Azure
Чтобы еще больше сократить задержки в сети между виртуальными машинами Azure, рекомендуется использовать [Ускорение работы в сети Azure](https://azure.microsoft.com/blog/maximize-your-vm-s-performance-with-accelerated-networking-now-generally-available-for-both-windows-and-linux/) при развертывании виртуальных машин Azure для рабочей нагрузки SAP. Это особенно актуально для прикладного уровня SAP и уровня СУБД SAP.

> [!NOTE]
> Не все типы виртуальных машин поддерживают ускорение работы в сети. В указанной статье приведен список типов виртуальных машин, поддерживающих ускорение работы в сети.
>

- - -
> ![ Windows][Logo_Windows]  Windows
>
> Чтобы ознакомиться с основными понятиями и тем, как развернуть виртуальные машин с использованием ускорения работы в сети в Windows, обратитесь к статье [Создание виртуальной машины Windows с ускорением работы в сети](https://docs.microsoft.com/azure/virtual-network/create-vm-accelerated-networking-powershell).
>
> ![Linux][Logo_Linux] Linux
>
> Сведения для дистрибутивов Linux см. в статье [Создание виртуальной машины Linux с ускорением работы в сети](https://docs.microsoft.com/azure/virtual-network/create-vm-accelerated-networking-cli).
>
>

- - -

> [!NOTE]
> Для SUSE, Red Hat и Oracle Linux функция ускорения сети поддерживается в новых версиях этих дистрибутивов. В более старых версиях, таких как SLES 12 SP2 или RHEL 7.2, ускорение работы в сети Azure не поддерживается.
>


## <a name="deployment-of-host-monitoring"></a>Развертывание мониторинга узлов
Для использования приложений SAP на виртуальных машинах Azure в производственных целях системе SAP требуется возможность получения данных мониторинга узлов с физических узлов, на которых работают виртуальные машины Azure. Требуется определенный уровень исправлений SAP HostAgent, включающий эту возможность в SAPOSCOL и SAP HostAgent. Точное описание уровня исправлений указано в примечании к SAP [1409604].

Дополнительные сведения о развертывании компонентов, передающих данные узлов в SAPOSCOL и SAP Host Agent, и об управлении жизненным циклом этих компонентов см. в [руководстве по развертыванию][deployment-guide].


## <a name="next-steps"></a>Дальнейшие действия
Документацию по конкретной СУБД можно найти в следующих статьях:

- [Рабочие нагрузки SAP на виртуальных машинах Azure. Руководство по развертыванию СУБД SQL Server](dbms_guide_sqlserver.md)
- [Рабочие нагрузки SAP на виртуальных машинах Azure. Руководство по развертыванию СУБД Oracle](dbms_guide_oracle.md)
- [Рабочие нагрузки SAP на виртуальных машинах Azure. Руководство по развертыванию СУБД IBM DB2](dbms_guide_ibm.md)
- [Рабочие нагрузки SAP на виртуальных машинах Azure. Руководство по развертыванию СУБД SAP ASE](dbms_guide_sapase.md)
- [Развертывание SAP MaxDB, liveCache и сервера содержимого на виртуальных машинах Azure](dbms_guide_maxdb.md)
- [Руководство по использованию SAP HANA в Azure](hana-vm-operations.md)
- [Обеспечение высокого уровня доступности для SAP HANA на виртуальных машинах Azure](sap-hana-availability-overview.md)
- [Руководство по резервному копированию SAP HANA на виртуальных машинах Azure](sap-hana-backup-guide.md)

