---
title: Доступность SAP HANA в пределах одного региона Azure | Документация Майкрософт
description: Операции SAP HANA на собственных виртуальных машинах Azure
services: virtual-machines-linux,virtual-machines-windows
documentationcenter: ''
author: msjuergent
manager: patfilot
editor: ''
tags: azure-resource-manager
keywords: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 03/5/2018
ms.author: juergent
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 28fe9bc7c8cb1d59df404b7dd7429def54648a18
ms.sourcegitcommit: 168426c3545eae6287febecc8804b1035171c048
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2018
---
# <a name="sap-hana-availability-within-one-azure-region"></a>Доступность SAP HANA в пределах одного региона Azure
В этом разделе представлены несколько сценариев доступности в пределах одного региона Azure. В Azure есть множество регионов, распределенных по всему миру. Список регионов Azure см. в [этой статье](https://azure.microsoft.com/regions/). При развертывании SAP HANA на виртуальных машинах в пределах одного региона Azure корпорация Майкрософт предлагает развернуть одну виртуальную машину с экземпляром HANA. Для повышения уровня доступности можно развернуть две виртуальные машины с двумя экземплярами HANA в [группе доступности Azure](https://docs.microsoft.com/azure/virtual-machines/windows/tutorial-availability-sets), использующие репликацию системы HANA в целях обеспечения доступности. В Azure есть общедоступная предварительная версия [зон доступности](https://docs.microsoft.com/azure/availability-zones/az-overview). Эти зоны доступности пока не рассматриваются подробно. За исключением некоторых общих сведений об использовании групп доступности и зон доступности.

Какая разница между группами доступности и зонами доступности? В регионах Azure, где будут предлагаться зоны доступности, есть несколько центров обработки данных с независимыми источниками питания, системами охлаждения и сетями. В одном регионе Azure предлагаются разные зоны, чтобы обеспечить возможность развертывать приложения в двух или трех предложенных зонах доступности. Если неполадки с источниками питания или сетью затрагивают инфраструктуру только одной зоны доступности, развертывание приложения в регионе Azure по-прежнему будет работать нормально. Через время возможно некоторое снижение емкости, так как некоторые виртуальные машины в одной зоне могут быть потеряны. Виртуальные машины в двух других зонах по-прежнему будут работать. 
 
В то время как группа доступности Azure — это логическая группа функций, которые можно использовать в Azure, чтобы гарантировать изоляцию сбоев ресурсов виртуальной машины во время развертывания в центре обработки данных Azure. Azure гарантирует, что виртуальные машины, размещенные в группе доступности, выполняются на нескольких физических серверах, в вычислительных стойках, в пределах единиц хранения и сетевых коммутаторов. В других документах Azure они упоминаются как места размещения в различных [доменах сбоя и обновления](https://docs.microsoft.com/azure/virtual-machines/windows/manage-availability). Эти размещения обычно находятся в центре обработки данных Azure. Предполагая, что неполадки в источниках питания или сети повлияют на развернутый центр обработки данных, все ресурсы в одном регионе Azure будут затронуты.

Размещение центров обработки данных, представляющих зоны доступности Azure, связано с неким компромиссом: задержки сети между службами, развернутыми в разных зонах, которые приемлемы для большинства приложений, и определенное расстояние между центрами обработки данных. Так что в идеале природные катастрофы не повлияют на питание, сеть и инфраструктуру во всех зонах доступности в этом регионе. Однако, как показали крупные стихийные бедствия, зоны доступности не всегда могут обеспечить доступность в рамках одного региона. Вспомните ураган "Мария", который обрушился на остров Пуэрто-Рико 20 сентября 2017 года. Тогда на острове шириной в 90 километров практически полностью пропало электричество.   
  


## <a name="single-vm-scenario"></a>Сценарий с одной виртуальной машиной
В этом сценарии создана одна виртуальная машина Azure для экземпляра SAP HANA. Для размещения диска операционной системы и всех дисков с данными используется хранилище Azure класса Premium. Соглашения об уровне обслуживания с временем бесперебойной работы на уровне 99,9 % и соглашения об уровне обслуживания других компонентов Azure достаточно для того, чтобы обеспечить доступность по соглашению для своих клиентов. В этом сценарии нет необходимости использовать группу доступности Azure для виртуальных машин, на которых выполняется уровень СУБД. В этом сценарии вы полагаетесь на две различные функции:

- автоматическая перезагрузка виртуальной машины Azure (также известная, как восстановление службы Azure);
- автоматическая перезагрузка SAP HANA.

Автоматическая перезагрузка виртуальной машины Azure (или "восстановление службы") — это функция в Azure, которая работает на двух уровнях:

- узел сервера Azure проверяет работоспособность виртуальных машин, размещенных на узле сервера;
- контроллер структуры Azure отслеживает работоспособность и доступность узла сервера.

Для каждой виртуальной машины, размещенной на узле сервера Azure, функция проверки работоспособности отслеживает работоспособность размещенных виртуальных машин. В случае, если виртуальные машины оказываются в неисправном состоянии, агентом узла Azure, который проверяет работоспособность виртуальных машин, может быть инициирована их перезагрузка. Контроллер структуры Azure проверяет работоспособность узла путем проверки многих других параметров, указывающих на проблемы с оборудованием узла, а также проверяет доступность узла в сети. Признаки проблем с узлом может привести к таким действиям:

- Перезагрузка узла и запущенных на нем виртуальных машин, если узел сигнализирует о плохом состоянии работоспособности.
- Перезагрузка узла и виртуальных машин, которые изначально были размещены в работоспособном узле, если узел после перезагрузки находится в неработоспособном состоянии. В этом случае узел помечается как неработоспособный и используется в дальнейших развертываниях, пока не будет очищен или заменен.
- Немедленная перезагрузка виртуальных машин на работоспособном узле в случае, если в неработоспособном узле возникли проблемы с процессом перезагрузки. 

Благодаря мониторингу узла и виртуальной машины, выполняемому Azure, виртуальные машины Azure, размещенные на неисправном узле, автоматически перезагружаются на работоспособном узле Azure. 

Вторая функция, на которую вы полагаетесь в таких сценариях, заключается в том, что служба HANA, выполняемая в пределах таких перезагруженных виртуальных машин, автоматически запускается после перезагрузки виртуальной машины. [Автоматическую перезагрузку службы HANA](https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.01/en-US/cf10efba8bea4e81b1dc1907ecc652d3.html) можно настроить с помощью контрольных служб различных служб HANA.

Этот сценарий с одной виртуальной машиной можно улучшить, добавив узел холодной отработки отказа в конфигурацию SAP HANA. В документации по SAP HANA это называется [автоматической отработкой отказа узла](https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.01/en-US/ae60cab98173431c97e8724856641207.html). Эту конфигурацию целесообразно использовать в локальных развертываниях, когда аппаратное обеспечение сервера ограничено и вы назначаете один узел сервера узлом автоматической отработки для набора рабочих узлов. Однако в таких ситуациях, когда базовая инфраструктура Azure обеспечивает работоспособный целевой сервер для успешной перезагрузки виртуальной машины, нет смысла развертывать сценарий автоматической отработки отказа узла SAP HANA. 

В результате у нас нет эталонной архитектуры, которая предусматривает резервный узел для автоматической отработки отказа узла HANA. Это также относится к конфигурациям горизонтального масштабирования SAP HANA.


## <a name="availability-scenarios-involving-two-different-vms"></a>Сценарии доступности с двумя разными виртуальными машинами
Использование двух виртуальных машин Azure в группах доступности Azure позволяет увеличить время бесперебойной работы между этими двумя виртуальными машинами, если они размещены в группе доступности Azure в пределах одного региона Azure. Базовая установка в Azure будет выглядеть, как показано на рисунке ниже: ![Две виртуальные машины со всеми уровнями](./media/sap-hana-availability-one-region/two_vm_all_shell.PNG)

Чтобы показать различные сценарии доступности, некоторые из уровней выше исключаются и остаются уровни виртуальных машин, узлов, групп доступности и регионов Azure. Виртуальные сети Azure, группы ресурсов и подписки не играют роли в описанных сценариях.

### <a name="replicating-backups-to-second-virtual-machine"></a>Репликация резервных копий на вторую виртуальную машину
Одной из самых элементарных конфигураций является передача резервных копий, особенно резервных копий журналов транзакций, с одной виртуальной машины Azure на другую. Можно выбрать хранилище Azure любого типа. Вы несете ответственность за написание скрипта копирования запланированного резервного копирования, осуществляемого на первой виртуальной машине, на вторую. В случае использования требуемых экземпляров второй виртуальной машины понадобится восстановить полные, добавочные, разностные резервные копии и резервные копии журналов транзакций до нужной вам точки. Архитектура выглядит следующим образом: ![Две виртуальные машины с репликацией хранилища](./media/sap-hana-availability-one-region/two_vm_storage_replication.PNG) 

Эта конфигурация не слишком подходит для достижения хороших показателей RPO и RTO. В частности, целевое время восстановления (RTO) увеличится из-за необходимости полного восстановления всей базы данных со скопированными резервными копиями. Тем не менее эту конфигурацию можно использовать для восстановления после непреднамеренного удаления данных в основных экземплярах. С такой конфигурацией можно в любой момент выполнить восстановление до определенного момента во времени, извлечь данные и импортировать удаленные данные в свой основной экземпляр. Следовательно, имеет смысл использовать такой метод резервного копирования в сочетании с другими функциями обеспечения высокого уровня доступности. В то время, пока копируются только резервные копии, можно обойтись виртуальной машиной меньшего размера, чем та, в которой выполняются основные экземпляры SAP HANA. Однако помните, что к виртуальным машинам меньшего размера можно подключить меньше виртуальных жестких дисков. Чтобы узнать об ограничениях отдельных типов виртуальных машин, ознакомьтесь со статьей [Размеры виртуальных машин Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/sizes).

### <a name="using-sap-hana-system-replication-without-automatic-failover"></a>Использование репликации системы SAP HANA без автоматического перехода на другой ресурс
В следующих сценариях используется репликация системы SAP HANA. Чтобы просмотреть соответствующую документацию SAP, начните со статьи о [репликации системы](https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.01/en-US/b74e16a9e09541749a745f41246a065e.html). В двух виртуальных машинах Azure в одном регионе Azure есть две разные конфигурации, которые несколько отличаются в отношении целевого времени восстановления. Как правило, сценарии, в которых отсутствует автоматический переход на другой ресурс, могут не слишком соответствовать сценариям в пределах одного региона Azure. Причина в том, что в большинстве ситуаций со сбоями в инфраструктуре Azure восстановление службы Azure перезагружает основную виртуальную машину на другом узле. С точки зрения сценариев сбоев такая конфигурация может помочь только в некоторых пограничных случаях или в случаях, которые вы, как клиент, хотите реализовать, особенно в отношении повышения эффективности.

#### <a name="using-hana-system-replication-without-auto-failover-and-without-data-pre-load"></a>Использование репликации системы HANA без автоматического перехода на другой ресурс и предварительной загрузки данных 
Это сценарий, в котором репликация системы SAP HANA используется в целях синхронного перемещения данных, чтобы достичь целевой точки восстановления равной 0. С другой стороны, целевая точка восстановления достаточно продолжительная, поэтому вам не нужна ни отработка отказа, ни предварительная загрузка данных в кэш экземпляра HANA. В таком случае у вас есть возможности снизить затраты в своей конфигурации:

- Можно запустить другой экземпляр SAP HANA во второй виртуальной машине, который займет большую часть объема ее памяти. Обычно это такой экземпляр, который в случае отработки отказа на вторую виртуальную машину можно будет отключить. Таким образом реплицируемые данные можно загрузить в кэш целевого экземпляра HANA на второй виртуальной машине.
- Вторая виртуальная машина может быть меньшего размера. В случае отработки отказа перед переходом на другой ресурс вручную необходимо изменить размер виртуальной машины до размера исходной виртуальной машины. Сценарий выглядит следующим образом:

![Две виртуальные машины с репликацией хранилища](./media/sap-hana-availability-one-region/two_vm_HSR_sync_nopreload.PNG)

> [!NOTE]
> Даже без предварительной загрузки данных в целевом объекте репликации системы HANA для хранения данных хранилища строк в памяти целевого экземпляра необходимо по крайней мере 64 ГБ памяти.

#### <a name="using-hana-system-replication-without-auto-failover-and-with-data-pre-load"></a>Использование репликации системы HANA без автоматического перехода на другой ресурс, но с предварительной загрузкой данных
Разница с приведенным ранее сценарием заключается в том, что данные, которые реплицируются на экземпляр HANA во второй виртуальной машине, предварительно загружаются. Таким образом теряются два преимущества, которые могут быть в сценариях без предварительной загрузки данных. В этом случае нельзя запустить другую систему SAP HANA на второй виртуальной машине, а также использовать виртуальные машины меньшего размера. Следовательно, этот сценарий очень трудно реализовать клиентам.


### <a name="using-sap-hana-system-replication-with-automatic-failover"></a>Использование репликации системы SAP HANA с автоматическим переходом на другой ресурс

В стандартной конфигурации доступности в пределах одного региона Azure, которую реализуют большинство клиентов SAP HANA, у двух виртуальных машинах Azure под управлением SLES Linux есть определенный отказоустойчивый кластер. Кластер Linux SLES основан на платформе [Pacemaker](http://www.linux-ha.org/wiki/Pacemaker) в сочетании с устройством [STONITH](http://linux-ha.org/wiki/STONITH). С точки зрения SAP HANA используется режим синхронизированной репликации и настроен автоматический переход на другой ресурс. На второй виртуальной машине экземпляр SAP HANA действует как узел горячей замены, который получает синхронный поток записей с изменениями из основного экземпляра SAP HANA. По мере того как транзакции фиксируются приложением на основном узле HANA, основной узел HANA не будет подтверждать фиксацию в приложении, пока дополнительный узел SAP HANA не подтвердит получение записи о фиксации. В SAP HANA есть два различных режима синхронной репликации. Сведения об этих режимах см. в статье [Replication Modes for SAP HANA System Replication](https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.02/en-US/c039a1a5b8824ecfa754b55e0caffc01.html) (Режимы репликации для репликации систем SAP HANA).

Общая конфигурация выглядит следующим образом:

![Две виртуальные машины с репликацией хранилища и отработкой отказа](./media/sap-hana-availability-one-region/two_vm_HSR_sync_auto_pre_preload.PNG)

Это решение выбрано потому, что оно позволяет достичь RPO 0 и очень низкого целевого времени восстановления. Настройте клиентское подключение SAP HANA таким образом, чтобы клиенты SAP HANA использовали виртуальный IP-адрес для подключения к конфигурации репликации системы HANA. Это устранит необходимость перенастройки приложения в случае отработки отказа на дополнительный узел. В этом решении номера SKU виртуальной машины Azure для основного и дополнительного узла должны быть одинаковыми.  


## <a name="next-steps"></a>Дальнейшие действия
Если вам требуется пошаговое руководство по настройке конфигурации в Azure, см. следующие статьи:

- [Настройка репликации системы SAP HANA в виртуальные машины Azure](sap-hana-high-availability.md)
- [Your SAP on Azure – Part 4 – High Availability for SAP HANA using System Replication](https://blogs.sap.com/2018/01/08/your-sap-on-azure-part-4-high-availability-for-sap-hana-using-system-replication/) (SAP в Azure (часть 4). Настройка высокого уровня доступности SAP HANA путем использования репликации системы.)

Дополнительные сведения о доступности SAP HANA в регионах Azure:

- [Доступность SAP HANA в разных регионах Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/workloads/sap/sap-hana-availability-across-regions) 

