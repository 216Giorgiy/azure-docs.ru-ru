<properties
    pageTitle="Использование подчиненного подключаемого модуля Azure на сервере непрерывной интеграции Jenkins | Microsoft Azure"
    description="Описание использования подчиненного подключаемого модуля Azure на сервере непрерывной интеграции Jenkins."
	services="virtual-machines-linux"
	documentationCenter=""
	authors="rmcmurray"
	manager="wpickett"
	editor="" />

<tags
	ms.service="virtual-machines-linux"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-multiple"
	ms.devlang="java"
	ms.topic="article"
	ms.date="06/24/2016"
    ms.author="robmcm"/>

# Использование подчиненного подключаемого модуля Azure на сервере непрерывной интеграции Jenkins

С помощью подчиненного подключаемого модуля Azure для Jenkins можно подготовить подчиненные узлы в Azure при запуске распределенных сборок.

## Установка подчиненного подключаемого модуля Azure
1. На панели мониторинга Jenkins щелкните **Manage Jenkins** (Управление Jenkins).
2. На странице **Manage Jenkins** (Управление Jenkins) щелкните **Manage Plugins** (Управление подключаемыми модулями).
3. Перейдите на вкладку **Available** (Доступный).
4. В поле фильтра над списком доступных подключаемых модулей введите **Azure**, чтобы ограничить список соответствующими подключаемыми модулями.

	Кроме того, вы можете выполнить поиск в прокручиваемом списке доступных подключаемых модулей. Подчиненный подключаемый модуль Azure находится в разделе **Cluster Management and Distributed Build** (Управление кластерами и распределенная сборка).

5. Установите флажок **Azure Slave Plugin** (Подчиненный подключаемый модуль Azure).
6. Щелкните **Install without restart** (Установить без перезагрузки) или **Download now and install after restart** (Загрузить сейчас и установить позднее).

Теперь, когда подключаемый модуль установлен, необходимо настроить его с помощью профиля подписки Azure и создать шаблон, который будет использоваться при создании виртуальной машины для подчиненного узла.


## Настройка подчиненного подключаемого модуля Azure с помощью профиля подписки

Профиль подписки, также называемый настройками публикации, представляет собой XML-файл, содержащий защищенные учетные данные и некоторые дополнительные сведения, необходимые для использования Azure в среде разработки. Для настройки подчиненного подключаемого модуля Azure необходимы следующие данные:

* идентификатор подписки;
* сертификат управления подпиской.

Эти сведения можно найти в [профиле подписки]. Ниже приведен пример профиля подписки.

	<?xml version="1.0" encoding="utf-8"?>

		<PublishData>

  		<PublishProfile SchemaVersion="2.0" PublishMethod="AzureServiceManagementAPI">

    	<Subscription

      		ServiceManagementUrl="https://management.core.windows.net"

      		Id="<Subscription ID value>"

      		Name="Pay-As-You-Go"
			ManagementCertificate="<Management certificate value>" />

  		</PublishProfile>

	</PublishData>

После создания профиля подписки выполните перечисленные ниже действия, чтобы настроить подчиненный подключаемый модуль Azure.

1. На панели мониторинга Jenkins щелкните **Manage Jenkins** (Управление Jenkins).
2. Щелкните **Configure System** (Настройка системы).
3. Прокрутите страницу вниз до раздела **Cloud** (Облако).
4. Щелкните **Add new cloud > Microsoft Azure** (Добавить новое облако > Microsoft Azure).

	![раздел «Облако»][cloud section]

	Появятся поля, в которые необходимо ввести сведения о подписке.

	![конфигурация подписки][subscription configuration]

5. Скопируйте идентификатор подписки и сертификат управления из профиля подписки и вставьте их в соответствующие поля.

	При копировании идентификатора подписки и сертификата управления не копируйте кавычки, в которые заключены значения.

6. Щелкните **Verify configuration** (Проверить конфигурацию).
7. После проверки правильности конфигурации щелкните **Save** (Сохранить).

## Настройка шаблона виртуальной машины для подчиненного подключаемого модуля Azure

Шаблон виртуальной машины определяет параметры, которые подключаемый модуль будет использовать для создания подчиненного узла в Azure. Далее мы создадим шаблон для виртуальной машины Ubuntu.

1. На панели мониторинга Jenkins щелкните **Manage Jenkins** (Управление Jenkins).
2. Щелкните **Configure System** (Настройка системы).
3. Прокрутите страницу вниз до раздела **Cloud** (Облако).

4. В разделе **Cloud** найдите элемент **Add Azure Virtual Machine Template** (Добавить шаблон виртуальной машины Azure) и нажмите кнопку **Add** (Добавить).

	![добавление шаблона виртуальной машины][add vm template]

	Появятся поля, в которые необходимо ввести сведения о создаваемом шаблоне.

	![форма для ввода общих настроек][blank general configuration]

5. В поле **Name** (Имя) введите имя облачной службы Azure. Если введенное имя ссылается на уже существующую облачную службу, виртуальная машина будет подготовлена именно в этой службе. В противном случае Azure создаст новую службу.

6. В поле **Description** (Описание) введите описание создаваемого вами шаблона. Это описание будет использоваться только в информационных целях и не будет учитываться при подготовке виртуальной машины.
7. Поле **Labels** (Метки) предназначено для идентификации создаваемого вами шаблона и используется для обращения к шаблону при создании задания Jenkins. В нашем случае в этом поле указываем **linux**.
8. В списке **Region** (Регион) выберите регион, где будет создана виртуальная машина.
9. В списке **Virtual Machine Size** (Размер виртуальной машины) выберите необходимый размер.
10. В поле **Storage Account Name** (Имя учетной записи хранения) укажите учетную запись хранения, где будет создана виртуальная машина. Убедитесь, что она находится в одном регионе с облачной службой, которую вы собираетесь использовать. Если вы хотите создать новое хранилище, оставьте это поле пустым.
11. Время хранения — это время в минутах, которое должно пройти до удаления неактивного подчиненного модуля из Jenkins. Оставьте значение по умолчанию 60. Кроме того, вы можете не удалять неактивный подчиненный модуль, а просто отключить его. Для этого установите флажок **Shutdown Only (Do Not Delete) After Retention Time** (Отключить (не удалять) по истечении времени хранения).
12. В списке **Usage** (Использование) выберите условие для использования этого подчиненного узла. На этом этапе выберите вариант **Utilize this node as much as possible** (Использовать этот узел постоянно).

	На этом этапе заполняемая форма будет выглядеть примерно так.

	![конфигурация общего шаблона контрольной точки][checkpoint general template config]

	На следующем этапе вы должны предоставить подробную информацию об образе операционной системы, в которой вы хотите создать подчиненный модуль.

13. В поле **Image Family or Id** (Семейство или идентификатор образа) укажите, какой образ системы будет установлен на вашей виртуальной машине. Выберите образ из списка семейств или укажите пользовательский вариант.

	Если вы хотите выбрать образ из списка семейств, введите первую букву имени семейства (с учетом регистра). Например, если вы введете **U**, появится список семейств Ubuntu Server. При подготовке виртуальной машины Jenkins будет использовать последнюю версию образа системы из семейства, выбранного в списке.

	![образец списка образов ОС][OS Image list sample]

	Если вы хотите использовать пользовательский образ, введите его имя. Имена пользовательских образов не отображаются в списке, поэтому имя необходимо ввести правильно.

	В данном примере при вводе буквы **U** открывается список образов Ubuntu и мы выбираем вариант **Ubuntu Server 14.04 LTS**.

14. В списке **Launch Method** (Метод запуска) выберите **SSH**.
15. Скопируйте приведенный ниже сценарий и вставьте его в поле **Init script** (Сценарий инициализации).

		# Install Java

		sudo apt-get -y update

		sudo apt-get install -y openjdk-7-jdk

		sudo apt-get -y update --fix-missing

		sudo apt-get install -y openjdk-7-jdk

		# Install git

		sudo apt-get install -y git

		#Install ant

		sudo apt-get install -y ant

		sudo apt-get -y update --fix-missing

		sudo apt-get install -y ant

	Сценарий инициализации будет выполнен после создания виртуальной машины. В этом примере сценарий устанавливает Java, Git и Ant.

16. В полях **Username** (Имя пользователя) и **Password** (Пароль) введите значения для учетной записи администратора, которая будет создана на вашей виртуальной машине.
17. Чтобы проверить допустимость указанных параметров, щелкните **Verify Template** (Проверить шаблон).
18. Щелкните **Сохранить**.


## Создание задания Jenkins, выполняемого в подчиненном узле в Azure

В этом разделе вы узнаете о том, как создать задачу Jenkins, которая должна выполняться в подчиненном узле в Azure. Чтобы следить за этим процессом в реальном времени, создайте собственный проект на GitHub.

1. На панели мониторинга Jenkins щелкните элемент **New Item** (Создать элемент).
2. Введите название создаваемой задачи.
3. В качестве типа проекта выберите **Freestyle project** (Любой проект).
4. Нажмите кнопку **ОК**.
5. На странице настройки задания выберите **Restrict where this project can be run** (Ограничения для запуска этого проекта).
6. В поле **Label Expression** (Выражение метки) введите **linux**. В предыдущем разделе мы создали шаблон подчиненного модуля, который мы назвали **linux**. Сейчас мы указываем именно его.
7. В поле **Build** (Сборка) щелкните **Add build step** (Добавить шаг сборки) и выберите **Execute shell** (Запустить оболочку).
8. В показанном ниже сценарии вместо **(имени учетной записи github)**, **(названия проекта)** и **(каталога проекта)** укажите соответствующие значения и вставьте измененный сценарий в появившуюся текстовую область.

		# Clone from git repo

		currentDir="$PWD"

		if [ -e (your project directory) ]; then

  			cd (your project directory)

  			git pull origin master

		else

  			git clone https://github.com/(your GitHub account name)/(your project name).git

		fi

		# change directory to project

		cd $currentDir/(your project directory)

		#Execute build task

		ant

9. Щелкните **Сохранить**.
10. На панели мониторинга Jenkins наведите указатель мыши на созданную задачу и щелкните стрелку раскрывающегося списка, чтобы отобразить параметры задачи.
11. Щелкните **Build now** (Собрать).

Затем на основании шаблона, созданного в предыдущем разделе, Jenkins создаст подчиненный узел и выполнит сценарий, который вы указали на этапе сборки данной задачи.

<!-- URL List -->

[профиле подписки]: http://go.microsoft.com/fwlink/?LinkID=396395

<!-- IMG List -->

[cloud section]: ./media/virtual-machines-azure-slave-plugin-for-jenkins/jenkins-cloud-section.png
[subscription configuration]: ./media/virtual-machines-azure-slave-plugin-for-jenkins/jenkins-account-configuration-fields.png
[add vm template]: ./media/virtual-machines-azure-slave-plugin-for-jenkins/jenkins-add-vm-template.png
[blank general configuration]: ./media/virtual-machines-azure-slave-plugin-for-jenkins/jenkins-slave-template-general-configuration-blank.png
[checkpoint general template config]: ./media/virtual-machines-azure-slave-plugin-for-jenkins/jenkins-slave-template-general-configuration.png
[OS Image list sample]: ./media/virtual-machines-azure-slave-plugin-for-jenkins/jenkins-os-family-list-sample.png

<!---HONumber=AcomDC_0629_2016-->