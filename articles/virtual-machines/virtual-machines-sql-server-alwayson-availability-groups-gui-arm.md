<properties
	pageTitle="Настройка групп доступности AlwaysOn с помощью диспетчера ресурсов Azure | Microsoft Azure"
	description="Создание группы доступности AlwaysOn на виртуальных машинах Azure в режиме диспетчера ресурсов Azure. В этом руководстве описывается, как с помощью пользовательского интерфейса можно автоматически создать все решение."
	services="virtual-machines-windows"
	documentationCenter="na"
	authors="MikeRayMSFT"
	manager="jeffreyg"
	editor="monicar"
	tags="azure-resource-manager" />
<tags
	ms.service="virtual-machines-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="vm-windows-sql-server"
	ms.workload="infrastructure-services"
	ms.date="02/04/2016"
	ms.author="MikeRayMSFT" />

# Настройка группы доступности AlwaysOn на виртуальных машинах диспетчера ресурсов Azure с помощью графического пользовательского интерфейса

> [AZURE.SELECTOR]
- [Портал — диспетчер ресурсов](virtual-machines-sql-server-alwayson-availability-groups-gui-arm.md)
- [Портал — классический](virtual-machines-windows-classic-portal-sql-availability.md)
- [PowerShell — классическая модель](virtual-machines-windows-classic-ps-sql-availability.md)

<br/>

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-rm-include.md)]Классическая модель.


В этом полном руководстве показано, как создать группу доступности SQL Server с использованием виртуальных машин диспетчера ресурсов Azure. Для настройки шаблона мы воспользуемся колонками на портале Azure. В ходе работы мы проверим параметры по умолчанию, введем необходимые параметры, а затем обновим колонки на портале.

>[AZURE.NOTE] На портале управления Azure для групп доступности AlwaysOn с прослушивателем можно настроить новый шаблон из коллекции. Это включает автоматическую настройку всех необходимых параметров для групп доступности AlwaysOn. Дополнительную информацию см. в разделе [Предложение AlwaysOn SQL Server в коллекции классического портала Microsoft Azure](http://blogs.technet.com/b/dataplatforminsider/archive/2014/08/25/sql-server-alwayson-offering-in-microsoft-azure-portal-gallery.aspx).

В конце учебника ваше решение SQL Server AlwaysOn в Azure будет состоять из следующих элементов:

- виртуальной сети, содержащей несколько подсетей, включая начальную и конечной подсети;

- два контроллера домена с доменом Active Directory (AD);

- двух виртуальных машин SQL Server, развернутых во внутреннюю подсеть и присоединенных к домену AD;

- кластера WSFC из трех узлов с моделью кворума "Большинство узлов";

- группы доступности с двумя репликами с синхронной фиксацией базы данных доступности.

На следующем рисунке показано графическое представление решения.

![Лабораторное тестирование архитектуры для групп доступности в Azure](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/0-EndstateSample.png)

Все ресурсы в этом решении принадлежат к одной группе ресурсов.

В этом учебнике предполагается следующее:

- У вас уже есть учетная запись Azure. Если у вас ее нет, [зарегистрируйтесь, чтобы воспользоваться пробной версией](http://azure.microsoft.com/pricing/free-trial/).

- Вы уже умеете подготавливать виртуальную машину SQL Server из коллекции виртуальных машин через графический интерфейс пользователя. Дополнительные сведения см. в статье [Подготовка виртуальной машины SQL Server в Azure](virtual-machines-windows-classic-portal-sql.md).

- Вы уже хорошо понимаете принцип работы групп доступности AlwaysOn. Дополнительные сведения см. в статье [Группы доступности AlwaysOn (SQL Server)](http://msdn.microsoft.com/library/hh510230.aspx).

>[AZURE.NOTE] Если вы планируете использовать группы доступности AlwaysOn с SharePoint, ознакомьтесь со статьей [Настройка групп доступности AlwaysOn в SQL Server 2012 для SharePoint 2013](http://technet.microsoft.com/library/jj715261.aspx).

В этом руководстве мы будем использовать портал Azure для таких целей:

- выбор нового шаблона для группы доступности AlwaysOn на портале;

- проверка настроек шаблона и обновление некоторых параметров конфигурации для среды;

- мониторинг Azure во время создания среды;

- подключение к одному из контроллеров домена, а затем к одному из экземпляров SQL Server.

## Подготовка группы доступности AlwaysOn из коллекции с помощью модели развертывания диспетчера ресурсов

В Azure есть коллекция образов для всего решения. Найти шаблон можно так:

1. 	Войдите на портал Azure, используя свою учетную запись.
1.	На портале Azure щелкните **+Создать**. Откроется колонка "Создать". 
1.	В поле поиска этой колонки введите **AlwaysOn**. ![Поиск шаблона AlwaysOn](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/16-findalwayson.png)
1.	В результатах поиска найдите **Кластер SQL Server AlwaysOn**. ![Шаблон AlwaysOn](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/17-alwaysontemplate.png)
1.	В разделе **Выбор модели развертывания** щелкните **Диспетчер ресурсов**.

### Основы

Щелкните **Основные сведения** и настройте следующие параметры.

- **Имя администратора** — это учетная запись пользователя с правами администратора домена и предопределенной ролью сервера sysadmin для SQL Server на обоих экземплярах SQL Server. Для примера в этом руководстве мы будем использовать имя **DomainAdmin**. 

- **Пароль** — пароль к учетной записи администратора домена. Следует использовать сложный пароль. Подтвердите пароль.

- **Подписка** — подписка, для которой Azure будет выставлять счета за использование всех ресурсов, развернутых для группы доступности AlwaysOn. Если в вашей учетной записи есть несколько подписок, можно указать любую из них.
 
- **Группа ресурсов** — это имя группы, в которую войдут все ресурсы Azure, созданные в ходе работы с этим руководством. Мы будем использовать имя **SQL-HA-RG**. Дополнительные сведения см. в статье (Общие сведения о диспетчере ресурсов Azure) [resource-group-overview.md/#resource-groups].

- **Расположение** — регион Azure, где будут созданы ресурсы для этого руководства. Выберите регион Azure для размещения инфраструктуры.

Вот как будет выглядеть колонка **Основные сведения**:

![Основы](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/1-basics.png)

- Нажмите кнопку **ОК**. 

### Параметры домена и сети

Этот шаблон коллекции Azure создает домен с новыми контроллерами домена. Он также создает сеть c двумя подсетями. Шаблон не позволяет создавать серверы в существующем домене или виртуальной сети. Следующим шагом является настройка параметров домена и сети.

В колонке **Параметры домена и сети** просмотрите предустановленные значения для параметров домена и сети:

- **Имя корневого домена леса** — это имя домена AD, в котором будет размещаться кластер. Мы будем использовать **contoso.com**. 

- **Имя виртуальной сети** — это сетевое имя виртуальной сети Azure. Мы будем использовать имя **autohaVNET**.

- **Имя подсети контроллера домена** — это имя части виртуальной сети, в которой размещен контроллер домена. Мы будем использовать имя **subnet-1**. Эта подсеть будет использовать префикс адреса **10.0.0.0/24**.

- **Имя подсети SQL Server** — это имя части виртуальной сети, в которой размещены серверы SQL Server и файловый ресурс-свидетель. Мы будем использовать имя **subnet-2**. Эта подсеть будет использовать префикс адреса **10.0.1.0/26**.

Дополнительные сведения о виртуальных сетях Azure см. в статье [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md).

Раздел **Параметры домена и сети** должен выглядеть так:

![Параметры домена и сети](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/2-domain.png)
 
При необходимости эти значения можно изменить. В этом руководстве мы используем предустановленные значения.
 
- Проверьте параметры и нажмите кнопку **ОК**. 

###Параметры группы доступности

В разделе **Параметры группы доступности** просмотрите предустановленные значения для группы доступности и прослушивателя.

- **Имя группы доступности** — это имя кластеризованного ресурса для группы доступности. Мы будем использовать имя **Contoso-ag**. 

- **Имя прослушивателя группы доступности** используется кластером и внутренним балансировщиком нагрузки. Клиенты, которые подключаются к серверу SQL Server, могут использовать это имя для подключения к соответствующей реплике базы данных. Мы будем использовать имя **Contoso-listener**.

-  **Порт прослушивателя группы доступности** — это порт TCP, который будет использоваться прослушивателем SQL Server. В этом руководстве используется порт по умолчанию **1433**.

При необходимости эти значения можно изменить. В этом руководстве используются предустановленные значения.

![Параметры группы доступности](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/3-availabilitygroup.png)

- Нажмите кнопку **ОК**. 

###Размер виртуальной машины и параметры хранилища

В разделе **Размер виртуальной машины и параметры хранилища** выберите размер виртуальной машины SQL Server и просмотрите другие параметры.

- **Размер виртуальной машины SQL Server** — это размер виртуальной машины Azure для обоих серверов SQL Server. Выберите размер виртуальной машины, соответствующий вашей рабочей нагрузке. Если среда создается для обучения, используйте **DS2**. Для рабочей среды следует выбрать такой размер виртуальной машины, который сможет поддерживать рабочую нагрузку. При большом количестве рабочих нагрузок потребуется виртуальная машина **DS4** или большего размера. Шаблон создаст две виртуальные машины такого размера и установит SQL Server на каждой из них. Дополнительные сведения см. в разделе [Размеры виртуальных машин](virtual-machines-linux-sizes.md).

>[AZURE.NOTE]Azure установит выпуск SQL Server Enterprise Edition. Стоимость ПО зависит от выпуска и размера виртуальной машины. Подробные сведения о текущих ценах см. в разделе [Цены на виртуальные машины](http://azure.microsoft.com/pricing/details/virtual-machines/#Sql).

- **Размер виртуальной машины контроллера домена** — это размер виртуальной машины для контроллеров домена. Мы будем использовать размер **D2**.

- **Размер виртуальной машины файлового ресурса-свидетеля** — это размер виртуальной машины для файлового ресурса-свидетеля. Мы будем использовать размер **A1**.

- **Учетная запись хранения SQL** — имя учетной записи хранения для хранения данных SQL Server и дисков операционной системы. Мы будем использовать имя **alwaysonsql01**.

- **Учетная запись хранения контроллера домена** — имя учетной записи хранения для контроллеров домена. Мы будем использовать имя **alwaysondc01**.

- **Размер диска данных SQL Server в ТБ** — размер диска данных SQL Server в ТБ. Введите число от 1 до 4. Диск данных такого размера будет подключен к каждому серверу SQL. Мы будем использовать размер **1**.

- **Оптимизация хранилища** — это параметры конфигурации хранилища для виртуальных машин SQL Server на основе типа рабочей нагрузки. В нашем примере все серверы SQL Server используют хранилище класса Premium. При этом для кэша узла для диска Azure задано значение "Только для чтения". Кроме того, параметры SQL Server для рабочей нагрузки можно оптимизировать, выбрав один из трех таких параметров:

    - **Общая рабочая нагрузка** — определенные параметры конфигурации не указываются. 

    - **Обработка транзакций** — указываются флаги трассировки 1117 и 1118.

    - **Хранение данных** — указываются флаги трассировки 1117 и 610.

Мы будем использовать параметр **Общая рабочая нагрузка**.

![Размер виртуальной машины и параметры хранилища](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/4-vm.png)

- Проверьте параметры и нажмите кнопку **ОК**. 

####Примечание о хранилище

Дополнительная оптимизация зависит от размера дисков данных SQL Server. Для каждого терабайта диска данных Azure добавляет дополнительное хранилище класса Premium размером 1 ТБ (SSD). Если для сервера требуется 2 ТБ или больше, шаблон создает пул носителей для каждого экземпляра SQL Server. Пул носителей — это виртуализация хранилища, при которой настраиваются несколько дисков для обеспечения большей емкости, гибкости и производительности. Шаблон создает в пуле носителей дисковое пространство и предоставляет его операционной системе как отдельный диск, а затем назначает его как диск данных для SQL Server. Шаблон настраивает пул носителей для SQL Server со следующими параметрами:

- Размер полосы — это настройка блока чередования для виртуального диска. Для транзакционных рабочих нагрузок устанавливается значение 64 КБ. Для рабочих нагрузок хранения данных следует выбрать значение 256 КБ. 

- Для типа устойчивости выбирается параметр "Простой (без устойчивости)".

>[AZURE.NOTE] Хранилище Azure класса Premium является локально избыточным хранилищем, которое хранит три копии данных в одном регионе. Поэтому для пула носителей дополнительная устойчивость не требуется.

- Количество столбцов равно количеству дисков в пуле носителей. 

Дополнительные сведения о дисковом пространстве и пулах носителей:

- [Обзор дисковых пространств](http://technet.microsoft.com/library/hh831739.aspx) 

- [Windows Server Backup and Storage Pools (Резервное копирование данных Windows Server и пулы носителей)](http://technet.microsoft.com/library/dn390929.aspx)

Дополнительные рекомендации по настройке см. в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-windows-classic-sql-perf.md).


###Параметры SQL Server

В разделе **Параметры SQL Server** проверьте и измените префикс имени виртуальной машины SQL Server, версию SQL Server, учетную запись и пароль службы SQL Server, а также расписание автоматической установки исправлений на серверы SQL Server.

- **Префикс имени SQL Server** используется для создания имени каждого экземпляра SQL Server. Мы будем использовать имя **Contoso-ag**. Имена SQL Server будут такими: *Contoso-ag-0* и *Contoso-ag-1*. 

- **Версия SQL Server** — это используемая версия SQL Server. Мы будем использовать версию **SQL Server 2014**. Можно также выбрать **SQL Server 2012** или **SQL Server 2016**.

- **Имя пользователя учетной записи службы SQL Server** — это имя учетной записи домена для службы SQL Server. Мы будем использовать **sqlservice**.

- **Пароль** — пароль к учетной записи службы SQL Server. Следует использовать сложный пароль. Подтвердите пароль.

- **Расписание автоматической установки исправлений на серверы SQL** — это день недели, в который Azure будет автоматически устанавливать исправления на серверы SQL Server. Мы будем использовать **Воскресенье**.

- **Время запуска автоматической установки исправлений на серверы SQL** — это время суток в регионе Azure, в которое будет запущена автоматическая установка исправлений.

>[AZURE.NOTE]Операции по установке исправлений для каждой виртуальной машины выполняются поочередно в течение часа. Во избежание перебоев в работе служб исправления устанавливаются на виртуальные машины только по очереди.

![Параметры SQL Server](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/5-sql.png)

Проверьте параметры и нажмите кнопку **ОК**.

###Сводка

На странице сводных данных можно просмотреть параметры Azure, а также загрузить шаблон. Проверьте сводные данные. Нажмите кнопку **ОК**.

###Купить

Эта последняя колонка содержит **условия использования** и **политику конфиденциальности**. Просмотрите эту информацию. Когда вы подготовите все необходимое для создания виртуальных машин в Azure, включая ресурсы для группы доступности AlwaysOn, щелкните **Создать**.
 
На портале Azure будет создана группа ресурсов и все необходимые ресурсы.

##Мониторинг развертывания

На портале Azure можно следить за ходом развертывания. Значок, представляющий развертывание, автоматически закреплен на панели мониторинга портала Azure.

![Панель мониторинга Azure](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/11-deploydashboard.png)

##Подключение к SQL Server

Новые экземпляры SQL Server выполняются на виртуальных машинах без подключения к Интернету. При этом контроллеры домена подключены к Интернету. Чтобы подключиться к серверам SQL с помощью удаленного рабочего стола, сначала подключитесь по RDP к одному из контроллеров домена. Затем установите второе RDP-подключение к серверу SQL Server.

Чтобы подключиться по RDP к основному контроллеру домена:

1.	На панели мониторинга портала Azure убедитесь, что развертывание выполнено успешно. 

1.	Щелкните **Ресурсы**.

1.	В колонке **Ресурсы** щелкните **ad-primary-dc** — это имя виртуальной машины для основного контроллера домена.

1.	В колонке **ad-primary-dc** щелкните **Подключить**. В браузере отобразится сообщение с предложением открыть или сохранить объект удаленного подключения. Щелкните **Открыть**. ![Подключение к контроллеру домена](./media/virtual-machines-sql-server-alwayson-availability-groups-gui-arm/13-ad-primary-dc-connect.png)
1.	В ходе **подключения к удаленному рабочему столу** может появиться предупреждение о том, что издателя этого удаленного подключения невозможно определить. Щелкните **Подключить**.

1.	Служба безопасности Windows предложит вам ввести учетные данные для подключения к IP-адресу основного контроллера домена. Щелкните **Использовать другую учетную запись**. В поле **Имя пользователя** введите **contoso\\DomainAdmin**. Это учетная запись, которую вы указали для имени администратора. Используйте сложный пароль, введенный во время настройки шаблона.

1.	В ходе сеанса **удаленного рабочего стола** может появиться предупреждение о том, что проверка подлинности удаленного компьютера не может быть выполнена из-за проблем с сертификатом безопасности. Отобразится имя сертификата безопасности. В этом руководстве используется имя **ad-primary-dc.contoso.com**. Щелкните **Да**.

Теперь вы подключены к основному контроллеру домена. Подключиться по RDP к серверу SQL Server можно так:

1.	В контроллере домена щелкните **Подключение к удаленному рабочему столу**. 

1.	В поле **Компьютер** введите имя одного из серверов SQL Server. Мы будем использовать имя **sqlserver-0**.

1.	Укажите учетную запись пользователя и пароль, которые использовались для подключения по RDP к контроллеру домена.

Теперь вы подключены к серверу SQL Server по RDP. Откройте SQL Server Management Studio, подключитесь к экземпляру SQL Server по умолчанию и проверьте параметры группы доступности AlwaysOn.

<!---HONumber=AcomDC_0323_2016-->