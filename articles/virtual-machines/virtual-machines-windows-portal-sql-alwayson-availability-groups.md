<properties
	pageTitle="Автоматическая настройка группы доступности AlwaysOn на виртуальной машине Azure в модели Resource Manager"
	description="Создание группы доступности AlwaysOn на виртуальных машинах Azure в режиме диспетчера ресурсов Azure. В этом руководстве описывается, как с помощью пользовательского интерфейса можно автоматически создать все решение."
	services="virtual-machines-windows"
	documentationCenter="na"
	authors="MikeRayMSFT"
	manager="jhubbard"
	editor=""
	tags="azure-resource-manager" />
<tags
	ms.service="virtual-machines-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="vm-windows-sql-server"
	ms.workload="infrastructure-services"
	ms.date="06/12/2016"
	ms.author="mikeray" />

# Автоматическая настройка группы доступности AlwaysOn на виртуальной машине Azure в модели Resource Manager

> [AZURE.SELECTOR]
- [Resource Manager: автоматически](virtual-machines-windows-portal-sql-alwayson-availability-groups.md)
- [Resource Manager: вручную](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md)
- [Классическая модель: пользовательский интерфейс](virtual-machines-windows-classic-portal-sql-alwayson-availability-groups.md)
- [Классическая модель: PowerShell](virtual-machines-windows-classic-ps-sql-alwayson-availability-groups.md)

<br/>

В этом полном руководстве показано, как создать группу доступности SQL Server с использованием виртуальных машин диспетчера ресурсов Azure. Для настройки шаблона мы воспользуемся колонками на портале Azure. В ходе работы мы проверим параметры по умолчанию, введем необходимые параметры, а затем обновим колонки на портале.

Когда вы выполните все задания этого руководства, ваше решение с группой доступности SQL Server в Azure будет состоять из следующих элементов:

- виртуальной сети, содержащей несколько подсетей, включая начальную и конечной подсети;

- два контроллера домена с доменом Active Directory (AD);

- двух виртуальных машин SQL Server, развернутых во внутреннюю подсеть и присоединенных к домену AD;

- кластера WSFC из трех узлов с моделью кворума "Большинство узлов";

- группы доступности с двумя репликами с синхронной фиксацией базы данных доступности.

На следующем рисунке показано графическое представление решения.

![Лабораторное тестирование архитектуры для групп доступности в Azure](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/0-EndstateSample.png)

Все ресурсы в этом решении принадлежат к одной группе ресурсов.

В этом учебнике предполагается следующее:

- У вас уже есть учетная запись Azure. Если у вас ее нет, [зарегистрируйтесь, чтобы воспользоваться пробной учетной записью](http://azure.microsoft.com/pricing/free-trial/).

- Вы уже умеете подготавливать виртуальную машину SQL Server из коллекции виртуальных машин через графический интерфейс пользователя. Дополнительные сведения см. в статье [Подготовка виртуальной машины SQL Server в Azure](virtual-machines-windows-portal-sql-server-provision.md).

- Теперь вы хорошо понимаете принцип работы групп доступности. Дополнительные сведения см. в статье [Группы доступности AlwaysOn (SQL Server)](http://msdn.microsoft.com/library/hh510230.aspx).

>[AZURE.NOTE] Если вы планируете использовать группы доступности с SharePoint, ознакомьтесь со статьей [Configure SQL Server 2012 Always On availability groups for SharePoint 2013](http://technet.microsoft.com/library/jj715261.aspx) (Настройка групп доступности AlwaysOn SQL Server 2012 для SharePoint 2013).

В этом руководстве мы будем использовать портал Azure для таких целей:

- выбор на портале шаблона Always On;

- проверка настроек шаблона и обновление некоторых параметров конфигурации для среды;

- мониторинг Azure во время создания среды;

- подключение к одному из контроллеров домена, а затем к одному из экземпляров SQL Server.

[AZURE.INCLUDE [availability-group-template](../../includes/virtual-machines-windows-portal-sql-alwayson-ag-template.md)]


## Подготовка кластера из коллекции

В Azure есть коллекция образов для всего решения. Найти шаблон можно так:

1. 	Войдите на портал Azure, используя свою учетную запись.
1.	На портале Azure щелкните **+Создать**. Откроется колонка "Создать".
1.	В колонке "Создать" найдите **AlwaysOn**. ![Поиск шаблона AlwaysOn](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/16-findalwayson.png)
1.	В результатах поиска найдите **Кластер SQL Server AlwaysOn**. ![Шаблон AlwaysOn](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/17-alwaysontemplate.png)
1.	В разделе **Выбор модели развертывания** щелкните **Resource Manager**.

### Основы

Щелкните **Базовые** и настройте указанные ниже параметры.

- **Имя администратора** — учетная запись пользователя с правами администратора домена и предварительно определенной ролью сервера sysadmin для SQL Server на обоих экземплярах SQL Server. В этом учебнике мы будем использовать имя **DomainAdmin**.

- **Пароль** — пароль к учетной записи администратора домена. Следует использовать сложный пароль. Подтвердите пароль.

- **Подписка** — подписка, для которой Azure будет выставлять счета за использование всех ресурсов, развернутых для группы доступности. Если в вашей учетной записи есть несколько подписок, можно указать любую из них.

- **Группа ресурсов** — имя группы, в которую войдут все ресурсы Azure, созданные в ходе работы с этим учебником. Мы будем использовать имя **SQL-HA-RG**. Дополнительные сведения см. в статье (Общие сведения о диспетчере ресурсов Azure) [resource-group-overview.md/#resource-groups].

- **Расположение** — регион Azure, где будут созданы ресурсы для этого учебника. Выберите регион Azure для размещения инфраструктуры.

Вот как будет выглядеть колонка **Базовые**.

![Основы](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/1-basics.png)

- Нажмите кнопку **ОК**.

### Параметры домена и сети

Этот шаблон коллекции Azure создает домен с новыми контроллерами домена. Он также создает сеть c двумя подсетями. Шаблон не позволяет создавать серверы в существующем домене или виртуальной сети. Следующим шагом является настройка параметров домена и сети.

В колонке **Domain and network settings** (Параметры домена и сети) просмотрите предустановленные значения для параметров домена и сети.

- **Доменное имя корня леса** — имя домена Active Directory, в котором будет размещаться кластер. Мы будем использовать **contoso.com**.

- **Имя виртуальной сети** — сетевое имя виртуальной сети Azure. Мы будем использовать имя **autohaVNET**.

- **Domain Controller subnet name** (Имя подсети контроллера домена) — имя части виртуальной сети, в которой размещен контроллер домена. Мы будем использовать имя **subnet-1**. Эта подсеть будет использовать префикс адреса **10.0.0.0/24**.

- **SQL Server subnet name** (Имя подсети SQL Server) — имя части виртуальной сети, в которой размещены серверы SQL Server и файловый ресурс-свидетель. Мы будем использовать имя **subnet-2**. Эта подсеть будет использовать префикс адреса **10.0.1.0/26**.

Дополнительные сведения о виртуальных сетях Azure см. в статье [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md).

Раздел **Domain and network settings** (Параметры домена и сети) должен выглядеть так.

![Параметры домена и сети](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/2-domain.png)

При необходимости эти значения можно изменить. В этом руководстве мы используем предустановленные значения.

- Проверьте параметры и нажмите кнопку **ОК**.

###Параметры группы доступности

В разделе **Availability group settings** (Параметры группы доступности) просмотрите предустановленные значения для группы доступности и прослушивателя.

- **Availablity group name** (Имя группы доступности) — имя кластеризованного ресурса для группы доступности. Мы будем использовать префикс **Contoso-ag**.

- **Имя прослушивателя группы доступности** используется кластером и внутренней подсистемой балансировки нагрузки. Клиенты, которые подключаются к серверу SQL Server, могут использовать это имя для подключения к соответствующей реплике базы данных. Мы будем использовать имя **Contoso-listener**.

-  **Порт прослушивателя группы доступности** — TCP-порт, который будет использоваться прослушивателем SQL Server. В этом учебнике используется порт по умолчанию **1433**.

При необходимости эти значения можно изменить. В этом руководстве используются предустановленные значения.

![Параметры группы доступности](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/3-availabilitygroup.png)

- Нажмите кнопку **ОК**.

###Размер виртуальной машины и параметры хранилища

В разделе **VM size, storage settings** (Размер виртуальной машины и параметры хранилища) выберите размер виртуальной машины SQL Server и просмотрите другие параметры.

- **SQL Server virtual machine size** (Размер виртуальной машины SQL Server) — размер виртуальной машины Azure для обоих серверов SQL Server. Выберите размер виртуальной машины, соответствующий вашей рабочей нагрузке. При создании среды для этого учебника используйте размер **DS2**. Для рабочей среды следует выбрать такой размер виртуальной машины, который сможет поддерживать рабочую нагрузку. Для реальных рабочих нагрузок обычно нужна виртуальная машина **DS4** или большего размера. Шаблон создаст две виртуальные машины такого размера и установит SQL Server на каждой из них. Дополнительные сведения см. в разделе [Размеры виртуальных машин](virtual-machines-linux-sizes.md).

>[AZURE.NOTE]Azure установит выпуск SQL Server Enterprise Edition. Стоимость ПО зависит от выпуска и размера виртуальной машины. Подробные сведения о текущих ценах см. на странице [Цены на виртуальные машины](http://azure.microsoft.com/pricing/details/virtual-machines/#Sql).

- **Domain controller virtual machine size** (Размер виртуальной машины контроллера домена) — размер виртуальной машины для контроллеров домена. Мы будем использовать размер **D2**.

- **File Share Witness virtual machine size** (Размер виртуальной машины файлового ресурса-свидетеля) — размер виртуальной машины для файлового ресурса-свидетеля. Мы будем использовать размер **A1**.

- **SQL Storage account** (Учетная запись хранения SQL) — имя учетной записи хранения для хранения данных SQL Server и дисков операционной системы. Мы будем использовать имя **alwaysonsql01**.

- **DC Storage account** (Учетная запись хранения контроллера домена) — имя учетной записи хранения для контроллеров домена. Мы будем использовать имя **alwaysondc01**.

- **SQL Server data disk size** (Размер диска данных SQL Server) — размер диска данных SQL Server в ТБ. Введите число от 1 до 4. Диск данных такого размера будет подключен к каждому серверу SQL. Мы будем использовать размер **1**.

- **Storage optimization** (Оптимизация хранилища) — параметры конфигурации хранилища для виртуальных машин SQL Server на основе типа рабочей нагрузки. В нашем примере все серверы SQL Server используют хранилище класса Premium. При этом для кэша узла для диска Azure задано значение "Только для чтения". Кроме того, параметры SQL Server для рабочей нагрузки можно оптимизировать, выбрав один из трех таких параметров:

    - **General workload** (Общая рабочая нагрузка) — без особых параметров конфигурации.

    - **Transactional processing** (Обработка транзакций) — устанавливаются флаги трассировки 1117 и 1118.

    - **Data warehousing** (Хранение данных) — устанавливаются флаги трассировки 1117 и 610.

Мы будем использовать параметр **General workload** (Общая рабочая нагрузка).

![Размер виртуальной машины и параметры хранилища](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/4-vm.png)

- Проверьте параметры и нажмите кнопку **ОК**.

####Примечание о хранилище

Дополнительная оптимизация зависит от размера дисков данных SQL Server. Для каждого терабайта диска данных Azure добавляет дополнительное хранилище класса Premium размером 1 ТБ (SSD). Если для сервера требуется 2 ТБ или больше, шаблон создает пул носителей для каждого экземпляра SQL Server. Пул носителей — это виртуализация хранилища, при которой настраиваются несколько дисков для обеспечения большей емкости, гибкости и производительности. Шаблон создает в пуле носителей дисковое пространство и предоставляет его операционной системе как отдельный диск, а затем назначает его как диск данных для SQL Server. Шаблон настраивает пул носителей для SQL Server со следующими параметрами:

- Размер полосы — это настройка блока чередования для виртуального диска. Для транзакционных рабочих нагрузок устанавливается значение 64 КБ. Для рабочих нагрузок хранения данных следует выбрать значение 256 КБ.

- Для типа устойчивости выбирается параметр "Простой (без устойчивости)".

>[AZURE.NOTE] Хранилище Azure класса Premium является локально избыточным хранилищем, которое хранит три копии данных в одном регионе. Поэтому для пула носителей дополнительная устойчивость не требуется.

- Количество столбцов равно количеству дисков в пуле носителей.

Дополнительные сведения о дисковом пространстве и пулах носителей:

- [Обзор дисковых пространств](http://technet.microsoft.com/library/hh831739.aspx).

- [Windows Server Backup and Storage Pools (Резервное копирование данных Windows Server и пулы носителей)](http://technet.microsoft.com/library/dn390929.aspx)

Дополнительные рекомендации по настройке SQL Server см. в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-performance.md).


###Параметры SQL Server

В разделе **Настройки SQL Server** проверьте и при необходимости измените префикс имени виртуальной машины SQL Server, версию SQL Server, учетную запись и пароль службы SQL Server, а также расписание автоматической установки исправлений на серверы SQL Server.

- **SQL Server Name Prefix** (Префикс имени SQL Server) используется для создания имен экземпляров SQL Server. Мы будем использовать префикс **Contoso-ag**. Имена серверов SQL Server будут такими: *Contoso-ag-0* и *Contoso-ag-1*.

- **Версия SQL Server** — используемая версия SQL Server. Мы будем использовать версию **SQL Server 2014**. Можно также выбрать **SQL Server 2012** или **SQL Server 2016**.

- **SQL Server service account user name** (Имя пользователя учетной записи службы SQL Server) — имя учетной записи домена для службы SQL Server. Мы будем использовать **sqlservice**.

- **Пароль** — пароль к учетной записи службы SQL Server. Следует использовать сложный пароль. Подтвердите пароль.

- **SQL Auto Patching maintenance schedule** (Расписание автоматической установки исправлений на серверы SQL) — здесь указывается день недели, в который Azure будет автоматически устанавливать исправления на серверы SQL Server. Мы будем использовать **воскресенье**.

- **SQL Auto Patching maintenance start hour** (Время запуска автоматической установки исправлений на серверы SQL) — время суток в соответствующем регионе Azure, в которое будет запущена автоматическая установка исправлений.

>[AZURE.NOTE]Операции по установке исправлений для каждой виртуальной машины выполняются поочередно в течение часа. Во избежание перебоев в работе служб исправления устанавливаются на виртуальные машины только по очереди.

![Параметры SQL Server](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/5-sql.png)

Проверьте параметры и нажмите кнопку **ОК**.

###Сводка

На странице сводных данных можно просмотреть параметры Azure, а также загрузить шаблон. Проверьте сводные данные. Нажмите кнопку **ОК**.

###Купить

Эта последняя колонка содержит **условия использования** и **политику конфиденциальности**. Просмотрите эту информацию. Когда вы подготовите все необходимое для создания виртуальных машин в Azure, в том числе ресурсы для группы доступности, щелкните **Создать**.

На портале Azure будет создана группа ресурсов и все необходимые ресурсы.

##Мониторинг развертывания

На портале Azure можно следить за ходом развертывания. Значок, представляющий развертывание, автоматически закреплен на панели мониторинга портала Azure.

![Панель мониторинга Azure](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/11-deploydashboard.png)

##Подключение к SQL Server

Новые экземпляры SQL Server выполняются на виртуальных машинах без подключения к Интернету. При этом контроллеры домена подключены к Интернету. Чтобы подключиться к серверам SQL с помощью удаленного рабочего стола, сначала подключитесь по RDP к одному из контроллеров домена. Затем установите второе RDP-подключение к серверу SQL Server.

Чтобы подключиться по RDP к основному контроллеру домена:

1.	На панели мониторинга портала Azure убедитесь, что развертывание выполнено успешно.

1.	Щелкните **Ресурсы**.

1.	В колонке **Ресурсы** щелкните **ad-primary-dc** — имя виртуальной машины для основного контроллера домена.

1.	В колонке **ad-primary-dc** щелкните **Подключить**. В браузере отобразится сообщение с предложением открыть или сохранить объект удаленного подключения. Щелкните **Открыть**. ![Подключение к контроллеру домена](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/13-ad-primary-dc-connect.png)
1.	В ходе **подключения к удаленному рабочему столу** может появиться предупреждение о том, что издателя этого удаленного подключения невозможно определить. Щелкните **Подключить**.

1.	Служба безопасности Windows предложит вам ввести учетные данные для подключения к IP-адресу основного контроллера домена. Щелкните **Использовать другую учетную запись**. В поле **Имя пользователя** введите **contoso\\DomainAdmin**. Это учетная запись, которую вы указали для имени администратора. Используйте сложный пароль, введенный во время настройки шаблона.

1.	В ходе сеанса **удаленного рабочего стола** может появиться предупреждение о том, что аутентификация удаленного компьютера не может быть выполнена из-за проблем с сертификатом безопасности. Отобразится имя сертификата безопасности. В этом учебнике используется имя **ad-primary-dc.contoso.com**. Щелкните **Да**.

Теперь вы подключены к основному контроллеру домена. Подключиться по RDP к серверу SQL Server можно так:

1.	В контроллере домена щелкните **Подключение к удаленному рабочему столу**.

1.	В поле **Компьютер** введите имя одного из экземпляров SQL Server. Мы будем использовать имя **sqlserver-0**.

1.	Укажите учетную запись пользователя и пароль, которые использовались для подключения по RDP к контроллеру домена.

Теперь вы подключены к серверу SQL Server по RDP. Откройте SQL Server Management Studio, подключитесь к экземпляру SQL Server по умолчанию и убедитесь, что создана группа доступности.

<!---HONumber=AcomDC_0622_2016-->