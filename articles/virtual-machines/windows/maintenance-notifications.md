---
title: "Обработка уведомлений по обслуживанию для виртуальных машин Windows в Azure | Документация Майкрософт"
description: "Просмотрите уведомления по обслуживанию для виртуальных машин Windows, запущенных в Azure, и запустите самостоятельное обслуживание."
services: virtual-machines-windows
documentationcenter: 
author: zivraf
manager: timlt
editor: 
tags: azure-service-management,azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 10/26/2017
ms.author: zivr
ms.openlocfilehash: cf9a624574cc5d63e17537d07d23bf38cc9d442a
ms.sourcegitcommit: 0930aabc3ede63240f60c2c61baa88ac6576c508
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2017
---
# <a name="handling-planned-maintenance-notifications-for-windows-virtual-machines"></a>Обработка плановых уведомлений по обслуживанию для виртуальных машин Windows

Azure периодически выполняет обновления, чтобы повысить надежность, производительность и безопасность инфраструктуры узлов, в которой работают виртуальные машины. Обновления — это изменения, такие как исправление среды размещения или модернизация оборудования и вывод его из эксплуатации. Большинство этих обновлений не влияют на работу размещенных виртуальных машин. Но в некоторых случаях они все же оказывают определенное воздействие:

- Если обслуживание не требует перезагрузки, Azure с помощью миграции на месте приостанавливает работу виртуальной машины во время обновления узла.

- Если для обслуживания требуется перезагрузка, вы получите уведомление во время планирования обслуживания. В этих случаях вам предоставляется временное окно, в котором вы можете начать обслуживание самостоятельно в удобное для вас время.


Плановое обслуживание, требующее перезагрузки, запланировано в волнах. Каждая волна имеет разную область (регионы).

- Волна начинается с уведомления клиентов. По умолчанию уведомление отправляется владельцу и совладельцам подписки. Для уведомлений можно добавить дополнительных получателей и параметры обмена сообщениями, например электронная почта, SMS и объекты Webhook.  
- Вскоре после уведомления задается период самообслуживания. В рамках этого периода можно найти информацию о том, какая из виртуальных машин включена в эту волну, и начать обслуживание с использованием упреждающего повторного развертывания. 
- Когда заканчивается период самообслуживания, начинается период запланированного обслуживания. В настоящее время в Azure планируется и применяется необходимое обслуживание для вашей виртуальной машины. 

Два периода нужны, чтобы у вас было достаточно времени для запуска обслуживания и перезагрузки виртуальной машины до того, как Azure начнет обслуживание автоматически.


Для запроса окон обслуживания для виртуальных машин и запуска самообслуживания можно использовать портал Azure, PowerShell, REST API и CLI.

 > [!NOTE]
 > Если попытка запустить обслуживание завершилась сбоем, Azure отмечает виртуальную машину как **пропущенную** и не перезагружает ее во время периода запланированного обслуживания. Вместо этого позже вам сообщат новое расписание. 


[!INCLUDE [virtual-machines-common-maintenance-notifications](../../../includes/virtual-machines-common-maintenance-notifications.md)]

## <a name="check-maintenance-status-using-powershell"></a>Проверка состояния обслуживания с помощью PowerShell

Чтобы узнать, когда для виртуальных машин запланировано обслуживание, можно также использовать Azure PowerShell. Информацию о плановом обслуживании можно получить с помощью командлета [Get AzureRmVM](/powershell/module/azurerm.compute/get-azurermvm), используя параметр `-status`.
 
Сведения об обслуживании возвращаются, только если имеется запланированное обслуживание. Если нет запланированного обслуживания, влияющего на виртуальную машину, командлет не возвращает информацию об обслуживании. 

```powershell
Get-AzureRmVM -ResourceGroupName rgName -Name vmName -Status
```

В разделе MaintenanceRedeployStatus возвращаются следующие свойства: 
| Значение | Описание   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на виртуальной машине ||
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| PreMaintenanceWindowEndTime           | Завершение периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| MaintenanceWindowEndTime              | Завершение периода запланированного обслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| LastOperationResultCode               | Результат последней попытки инициирования обслуживания на виртуальной машине ||



Вы также можете получить информацию о состоянии обслуживания для всех виртуальных машин в группе ресурсов с помощью командлета [Get AzureRmVM](/powershell/module/azurerm.compute/get-azurermvm), не указывая виртуальную машину.
 
```powershell
Get-AzureRmVM -ResourceGroupName rgName -Status
```

Следующая функция PowerShell принимает идентификатор подписки и выводит список виртуальных машин, запланированных для обслуживания.

```powershell

function MaintenanceIterator
{
    Select-AzureRmSubscription -SubscriptionId $args[0]

    $rgList= Get-AzureRmResourceGroup 

    for ($rgIdx=0; $rgIdx -lt $rgList.Length ; $rgIdx++)
    {
        $rg = $rgList[$rgIdx]
        $vmList = Get-AzureRMVM -ResourceGroupName $rg.ResourceGroupName 
        for ($vmIdx=0; $vmIdx -lt $vmList.Length ; $vmIdx++)
        {
            $vm = $vmList[$vmIdx]
            $vmDetails = Get-AzureRMVM -ResourceGroupName $rg.ResourceGroupName -Name $vm.Name -Status
              if ($vmDetails.MaintenanceRedeployStatus )
            {
                Write-Output "VM: $($vmDetails.Name)  IsCustomerInitiatedMaintenanceAllowed: $($vmDetails.MaintenanceRedeployStatus.IsCustomerInitiatedMaintenanceAllowed) $($vmDetails.MaintenanceRedeployStatus.LastOperationMessage)"               
            }
          }
    }
}

```

### <a name="start-maintenance-on-your-vm-using-powershell"></a>Запуск обслуживания вашей виртуальной машины с помощью PowerShell

Используя информацию из функции в предыдущем разделе, следующая команда запускает обслуживание на виртуальной машине, если для свойства **IsCustomerInitiatedMaintenanceAllowed** задано значение true.

```powershell
Restart-AzureRmVM -PerformMaintenance -name $vm.Name -ResourceGroupName $rg.ResourceGroupName 
```

## <a name="faq"></a>Часто задаваемые вопросы


**Вопрос. Зачем вам нужно перезагружать сейчас мою виртуальную машину?**

**Ответ.** Хотя обновления платформы Azure преимущественно не оказывают влияния на доступность виртуальных машин, иногда мы не можем избежать перезагрузки виртуальных машин, размещенных в Azure. Мы хотим внести несколько изменений, и для этого нам нужно перезапустить наши серверы. Это, в свою очередь, приведет к перезагрузке виртуальных машин.

**Вопрос. Безопасно ли выполнять рекомендации по обеспечению высокой доступности с помощью группы доступности?**

**Ответ.** Виртуальные машины, развернутые в группе доступности или масштабируемом наборе виртуальных машин, связаны с таким понятием, как домены обновления. Во время обслуживания Azure учитывает ограничения доменов обновления и не выполняет перезагрузку виртуальных машин из разных доменов обновления (в пределах одной и той же группы доступности).  Azure также ожидает минимум 30 минут, прежде чем переходить к следующей группе виртуальных машин. 

Дополнительные сведения об обеспечении высокой доступности см. в руководствах по управлению доступностью виртуальных машин Windows и Linux в Azure.

**Вопрос. Мой набор аварийного восстановления находится в другом регионе. Насколько это безопасно?**

**Ответ.** Каждый регион Azure образует пару с другим регионом в пределах одной географической области (например США, Европа или Азия). Запланированные обновления Azure распространяются среди парных регионов последовательно, чтобы свести к минимуму время простоя и риск сбоев в работе приложений. Во время планового обслуживания Azure может запланировать такое окно, чтобы пользователи могли запустить процедуру обслуживания. Но эти окна будут отличаться для парных регионов.  

Дополнительные сведения о регионах Azure см. в разделе "Регионы и доступность виртуальных машин в Azure".  Здесь вы можете просмотреть полный список пар регионов.

**Вопрос. Как происходит информирование о плановом обслуживании?**

**Ответ.** Процедура планового обслуживания начинается с настройки расписания для одного или нескольких регионов Azure. Вскоре после этого владельцам подписки отправляется уведомление по электронной почте (одно сообщение для каждой подписки). Дополнительные каналы и получатели для этого уведомления можно настроить с помощью оповещений журнала действий. При развертывании виртуальной машины в регионе, в котором плановое обслуживание назначено по расписанию, вы не получите уведомление. Вам нужно будет проверить состояние обслуживания виртуальной машины.

**Вопрос. Почему информация о плановом обслуживании не отображается на портале, в PowerShell или интерфейсе командной строки?**

**Ответ.** Сведения о плановом обслуживании доступны в ходе этой процедуры только для виртуальных машин, которые включены в плановое обслуживание. Другими словами, если данные не отображаются, это значит, что процедура обслуживания уже завершена (или не начата) или виртуальная машина уже размещена на обновленном сервере.

**Вопрос. Нужно ли запускать обслуживание на моей виртуальной машине?**

**Ответ.** В общем случае на рабочие нагрузки, развернутые в облачную службу, группу доступности или масштабируемый набор виртуальных машин, плановое обслуживание не влияет.  Во время планового обслуживания в конкретный момент времени всегда затрагивается только один домен обновления. Обратите внимание, что изменения в доменах обновления не всегда происходят последовательно.

Вы можете самостоятельно запустить обслуживание в следующих случаях:
- Приложение выполняется на одной виртуальной машине, и вам нужно выполнить обслуживание в нерабочее время.
- Вам нужно координировать время обслуживания в рамках соглашения об уровне обслуживания.
- Вам нужно, чтобы перезагрузка каждой виртуальной машины (даже в пределах группы доступности) выполнялась с интервалом не менее 30 минут.
- Вы хотите полностью остановить работу приложения (несколько уровней, несколько доменов обновления) для ускорения процедуры обслуживания.

**Вопрос. Можно ли точно узнать, когда моя виртуальная машина будет затронута?**

**Ответ.** При планировании расписания мы определяем временное окно в несколько дней. Но точная последовательность серверов (и связанных виртуальных машин) в рамках этого окна неизвестна. Клиентам, которым нужно знать точное время для своих виртуальных машин, могут помочь запланированные события и запросы из виртуальных машин. За 10 минут до перезагрузки виртуальной машины они получат уведомление.
  
**Вопрос. Как долго моя виртуальная машина будет перезагружаться?**

**Ответ.** В зависимости от размера виртуальной машины перезагрузка может занять несколько минут. Учтите, что при использовании облачных служб, масштабируемых наборов или групп доступности вам будет предоставлен 30-минутный период для каждой группы виртуальных машин (домен обновления). 

**Вопрос. А что будет в случае использования облачных служб, масштабируемых наборов и Service Fabric?**

**Ответ.** Так как эти платформы будут затронуты плановым обслуживанием, клиенты смогут их безопасно использовать, если в указанный момент времени будут затронуты только виртуальные машины в одном домене обновления.  

**Вопрос. Мне пришло сообщение электронной почты о выводе оборудования из эксплуатации. Это и есть плановое обслуживание?**

**Ответ.** Хотя вывод оборудования из эксплуатации является частью планового обслуживания, мы еще не реализовали этот сценарий.  Получение двух аналогичных сообщений о двух разных процедурах планового обслуживания может внести некоторую путаницу.

**Вопрос. Информация об обслуживании не отображается в виртуальных машинах. В чем может быть проблема?**

**Ответ.** Есть несколько причин, по которым вы можете не видеть информацию об обслуживании в виртуальных машинах:
1.  Вы используете подписку, отмеченную в Майкрософт как внутренняя.
2.  Для виртуальных машин не запланировано обслуживание. Процедура обслуживания завершена, отменена или изменена так, чтобы не влиять на виртуальные машины.
3.  В представлении списка виртуальных машин отсутствует столбец "Обслуживание". Хотя мы добавили этот столбец в представление по умолчанию, клиенты, которые настроили отображение пользовательских столбцов, должны вручную добавить столбец **Обслуживание** в представление списка виртуальных машин.

**Вопрос. Для моей виртуальной машины запланировано обслуживание во второй раз. Почему?**

**Ответ.** Есть несколько ситуаций, когда для виртуальной машины может быть запланирована еще одна процедура после обслуживания с повторным развертыванием:
1.  Мы отменили процедуру обслуживания и перезапустили ее с другими полезными данными. Мы обнаружили неисправные полезные данные, и нам просто нужно развернуть дополнительные полезные данные.
2.  Виртуальная машина *восстановлена* на другой узел из-за сбоя оборудования.
3.  Вы решили остановить (отменить распределение) и перезапустить виртуальную машину.
4.  Вы настроили **автоматическое завершение работы** для виртуальной машины.


## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как зарегистрироваться для событий обслуживания прямо из виртуальной машины с помощью функции [запланированных событий](scheduled-events.md).
