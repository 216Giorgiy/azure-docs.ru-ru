---
title: Руководство по созданию конвейера CI/CD в Azure с помощью Azure DevOps Services | Документация Майкрософт
description: В этом руководстве вы узнаете, как создать конвейер Azure DevOps Services для непрерывной интеграции и доставки, который выполняет развертывание веб-приложения в службах IIS на виртуальной машине Windows в Azure.
services: virtual-machines-windows
documentationcenter: virtual-machines
author: zr-msft
manager: jeconnoc
editor: tysonn
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 05/12/2017
ms.author: zarhoads
ms.custom: mvc
ms.openlocfilehash: 4b4d514ec8bfd78b303a7f51c2a4072507da5be9
ms.sourcegitcommit: 62759a225d8fe1872b60ab0441d1c7ac809f9102
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2018
ms.locfileid: "49471464"
---
# <a name="tutorial-create-a-continuous-integration-pipeline-with-azure-devops-services-and-iis"></a>Руководство по созданию конвейера непрерывной интеграции с помощью Azure DevOps Services и IIS
Чтобы автоматизировать этапы создания, тестирования и развертывания проекта приложения, вы можете использовать конвейер для непрерывной интеграции и развертывания (CI/CD). В рамках этого руководства вы создадите конвейер CI/CD с помощью Azure DevOps Services и виртуальной машины Windows в Azure, где выполняются службы IIS. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * публиковать веб-приложение ASP.NET в проекте Azure DevOps Services;
> * создавать конвейер сборки, который активируется фиксациями кода;
> * устанавливать и настраивать IIS на виртуальной машине в Azure;
> * добавлять экземпляр IIS в группу развертывания в Azure DevOps Services;
> * создавать конвейер выпуска для публикации новых пакетов веб-развертывания в IIS;
> * Тестирование конвейера CI/CD

Для работы с этим руководством требуется модуль Azure PowerShell версии не ниже 5.7.0. Чтобы узнать версию, выполните команду `Get-Module -ListAvailable AzureRM`. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке модуля Azure PowerShell](/powershell/azure/install-azurerm-ps).

## <a name="create-a-project-in-azure-devops-services"></a>Создание проекта в Azure DevOps Services
Azure DevOps Services обеспечивает совместную работу и разработку без необходимости обслуживания решения по управлению локальным кодом. Azure DevOps Services также позволяет выполнять тестирование кода в облаке, а также создавать и анализировать приложение. Вы можете выбрать интегрированную среду разработки и репозиторий системы управления версиями, которые лучше всего подходят для вашего сценария разработки кода. В рамках этого руководства вы можете использовать бесплатную организацию, чтобы создать базовое веб-приложение ASP.NET и конвейер CI/CD. Если у вас еще нет организации Azure DevOps Services, [создайте ее](http://go.microsoft.com/fwlink/?LinkId=307137).

Чтобы управлять процессом фиксации кода, конвейерами сборки и выпуска, создайте конвейеры в Azure DevOps Services следующим образом:

1. В браузере откройте панель мониторинга Azure DevOps Services и выберите **Новый проект**.
2. Введите *myWebApp* для **имени проекта**. Оставьте все остальные значения по умолчанию, чтобы использовать управление версиями *Git* и процесс рабочих элементов *Agile*.
3. Выберите параметр для **совместного использования** с *участниками команды*, а затем выберите **Создать**.
5. После создания проекта выберите параметр для **инициализации с файлом сведений или GITIGNORE-файлом**, а затем щелкните **Инициализировать**.
6. Внутри нового проекта выберите **Панели мониторинга** в верхней области, а затем — **Открыть в Visual Studio**.


## <a name="create-aspnet-web-application"></a>Создание веб-приложения ASP.NET
На предыдущем шаге вы создали проект в Azure DevOps Services. На последнем шаге новый проект открывается в Visual Studio. Управление фиксациями кода выполняется в окне **Team Explorer**. Создайте локальную копию нового проекта, а затем создайте веб-приложение ASP.NET из шаблона, как показано ниже.

1. Нажмите кнопку **Клонировать**, чтобы создать локальный репозиторий Git проекта Azure DevOps Services.
    
    ![Клонирование репозитория из проекта Azure DevOps Services](media/tutorial-vsts-iis-cicd/clone_repo.png)

2. В разделе **Решения** выберите **Создать**.

    ![Создание решения веб-приложения](media/tutorial-vsts-iis-cicd/new_solution.png)

3. Выберите шаблоны **Веб**, а затем выберите шаблон **Веб-приложение ASP.NET**.
    1. Введите имя приложения, например *myWebApp*, а затем снимите флажок для параметра **Создать каталог для решения**.
    2. Снимите флажок для параметра **Добавить Application Insights в проект**, если он доступен. Вам потребуется авторизовать веб-приложение в Azure Application Insights. Чтобы упростить работу с этим руководством, пропустите этот процесс.
    3. Нажмите кнопку **ОК**.
4. Из списка шаблонов выберите **MVC**.
    1. Выберите **Изменить способ проверки подлинности**, затем — **Нет проверки подлинности** и нажмите кнопку **ОК**.
    2. Нажмите кнопку **ОК**, чтобы создать решение.
5. В окне **Team Explorer** выберите **Изменения**.

    ![Фиксация локальных изменений в репозитории Git в Azure Repos](media/tutorial-vsts-iis-cicd/commit_changes.png)

6. В текстовом поле фиксации введите сообщение, например *Начальная фиксация*. В раскрывающемся меню выберите **Зафиксировать все и синхронизировать**.


## <a name="create-build-pipeline"></a>Создание конвейера сборки
В Azure DevOps Services вы используете конвейер сборки, чтобы обозначить, как должно быть создано приложение. В рамках этого руководства мы создадим базовый конвейер, который выполняет сборку решения на основе исходного кода, а затем создает пакет веб-развертывания, который мы можем использовать для запуска веб-приложения на сервере IIS.

1. В проекте Azure DevOps Services выберите **Build & Release** (Сборка и выпуск) в верхней области, а затем — **Сборки**.
3. Выберите **+ Новое определение**.
4. Выберите шаблон **ASP.NET (предварительная версия)**, а затем щелкните **Применить**.
5. Оставьте все значения задач по умолчанию. В разделе **Получить исходные коды** выберите репозиторий *myWebApp* и *главную* ветвь.

    ![Создание конвейера сборки в Azure DevOps Services](media/tutorial-vsts-iis-cicd/create_build_definition.png)

6. На вкладке **Триггеры** переместите ползунок для параметра **включения триггера** в значение *Включено*.
7. Сохраните конвейер сборки и поместите в очередь новую сборку, выбрав **Save & queue** (Сохранить и поместить в очередь), а затем **снова выберите этот параметр**. Оставьте остальные значения по умолчанию, а затем выберите **Очередь**.

Просмотрите, как планируется выполнение сборки на размещенном агенте и как выполняется сам процесс сборки. Вы должны увидеть результат, аналогичный приведенному ниже.

![Успешная сборка проекта Azure DevOps Services](media/tutorial-vsts-iis-cicd/successful_build.png)


## <a name="create-virtual-machine"></a>Создание виртуальной машины
Чтобы предоставить платформу для выполнения веб-приложения ASP.NET, вам необходима виртуальная машина Windows, где выполняются службы IIS. Azure DevOps Services использует агент для взаимодействия с экземпляром IIS после фиксации кода и активации сборок.

Создайте виртуальную машину Windows Server 2016 с помощью команды [New-AzureRmVM](/powershell/module/azurerm.compute/new-azurermvm). В следующем примере создается виртуальная машина *myVM* в расположении *EastUS*. Кроме того, создается группа ресурсов *myResourceGroupAzureDevOpsServices* и вспомогательные ресурсы сети. Чтобы разрешить веб-трафик, для виртуальной машины открывается TCP-порт *80*. При появлении запроса укажите имя пользователя и пароль в качестве учетных данных для входа на виртуальную машину.

```powershell
# Create user object
$cred = Get-Credential -Message "Enter a username and password for the virtual machine."

# Create a virtual machine
New-AzureRmVM `
  -ResourceGroupName "myResourceGroupAzureDevOpsServices" `
  -Name "myVM" `
  -Location "East US" `
  -ImageName "Win2016Datacenter" `
  -VirtualNetworkName "myVnet" `
  -SubnetName "mySubnet" `
  -SecurityGroupName "myNetworkSecurityGroup" `
  -PublicIpAddressName "myPublicIp" `
  -Credential $cred `
  -OpenPorts 80
```

Чтобы подключиться к виртуальной машине, получите общедоступный IP-адрес с помощью команды [Get-AzureRmPublicIpAddress](/powershell/module/azurerm.network/get-azurermpublicipaddress), как показано ниже.

```powershell
Get-AzureRmPublicIpAddress -ResourceGroupName "myResourceGroup" | Select IpAddress
```

Создайте сеанс подключения к удаленному рабочему столу виртуальной машины:

```cmd
mstsc /v:<publicIpAddress>
```

На виртуальной машине откройте окно командной строки **PowerShell с правами администратора**. Установите IIS и необходимые компоненты .NET, как показано ниже.

```powershell
Install-WindowsFeature Web-Server,Web-Asp-Net45,NET-Framework-Features
```


## <a name="create-deployment-group"></a>Создание группы развертывания

Чтобы передать пакет веб-развертывания на сервер IIS, вам необходимо определить группу развертывания в Azure DevOps Services. Эта группа позволяет указать, какие серверы являются целевыми серверами новых сборок после фиксации кода в Azure DevOps Services и завершения сборок.

1. В Azure DevOps Services выберите **Build & Release** (Сборка и выпуск), а затем — **Группы развертываний**.
2. Выберите **Добавить группу развертывания**.
3. Введите имя группы, например *myIIS*, а затем выберите **Создать**.
4. В разделе **Регистрация компьютеров** выберите *Windows*, а затем установите флажок для параметра **использования личного маркера доступа в скрипте для проверки подлинности**.
5. Выберите параметр **Copy script to clipboard** (Копировать скрипт в буфер обмена).


### <a name="add-iis-vm-to-the-deployment-group"></a>Добавление виртуальной машины с IIS в группу развертывания
Добавьте каждый экземпляр IIS в созданную группу развертывания. Azure DevOps Services создает скрипт, который загружает и настраивает агент на виртуальной машине, которая получает новые пакеты веб-развертывания, а затем применяет их к IIS.

1. Вернитесь в сеанс **PowerShell с правами администратора**, запущенный на виртуальной машине, вставьте и запустите скрипт, скопированный из Azure DevOps Services.
2. При появлении запроса на настройку тегов для агента выберите *Y* и введите *web*.
3. При появлении запроса на указание учетной записи пользователя щелкните *Возврат*, чтобы принять значения по умолчанию.
4. Ожидайте сообщение о завершении выполнения скрипта — *Служба vstsagent.account.computername успешно запущена*.
5. На странице **групп развертывания** меню **сборки и выпуска** откройте группу развертывания *myIIS*. Убедитесь, что ваша виртуальная машина находится в списке на вкладке **Компьютеры**.

    ![Виртуальная машина успешно добавлена в группу развертывания Azure DevOps Services](media/tutorial-vsts-iis-cicd/deployment_group.png)


## <a name="create-release-pipeline"></a>Создание конвейера выпуска
Чтобы опубликовать сборки, создайте конвейер выпуска в Azure DevOps Services. Этот конвейер запускается автоматически при успешной сборке приложения. Вам необходимо выбрать группу развертывания, в которую требуется опубликовать пакет веб-развертывания, а также определить соответствующие параметры IIS.

1. Выберите **Сборка и выпуск**, а затем — **Сборки**. Выберите конвейер сборки, созданный на предыдущем шаге.
2. В разделе **Недавно завершенные** выберите последнюю сборку, а затем — **Версия**.
3. Щелкните **Да**, чтобы создать конвейер выпуска.
4. Выберите шаблон **Пустой**, а затем щелкните **Далее**.
5. Параметры проекта и конвейера сборки источника должны быть заполнены данными вашего проекта.
6. Установите флажок для параметра **Непрерывное развертывание**, а затем выберите **Создать**.
7. Щелкните раскрывающийся список рядом с параметром **+ Добавить задачи** и выберите *Добавить этап группы развертывания*.
    
    ![Добавление задания в конвейер выпуска в Azure DevOps Services](media/tutorial-vsts-iis-cicd/add_release_task.png)

8. Выберите **Добавить** рядом с **IIS Web App Deploy(Preview)** (Развертывание веб-приложения IIS (предварительная версия)), а затем выберите **Закрыть**.
9. Выберите родительскую задачу **Запуск в группе развертывания**.
    1. Для **группы развертывания** выберите ранее созданную группу развертывания, например *myIIS*.
    2. В поле **Теги компьютера** выберите **Добавить**, а затем выберите тег *web*.
    
    ![Задача группы развертывания конвейера выпуска для IIS](media/tutorial-vsts-iis-cicd/release_definition_iis.png)
 
11. Выберите задачу **развертывания веб-приложения IIS**, чтобы настроить параметры экземпляра IIS, как показано ниже.
    1. Для **имени веб-сайта** введите *Веб-сайт по умолчанию*.
    2. Оставьте все остальные параметры по умолчанию.
12. Щелкните **Сохранить**, а затем дважды нажмите кнопку **ОК**.


## <a name="create-a-release-and-publish"></a>Создание выпуска и публикация
Теперь вы можете отправить пакет веб-развертывания как новый выпуск. На этом шаге выполняется взаимодействие с агентом в каждом экземпляре, который является частью группы развертывания, отправка пакета веб-развертывания, а затем настройка IIS для выполнения обновленного веб-приложения.

1. В конвейере выпуска выберите **+ Release** (+ Выпуск), а затем **Создать выпуск**.
2. В раскрывающемся списке выберите последнюю сборку, а также триггер **Автоматическое развертывание: после создания выпуска**. Нажмите кнопку **Создать**.
3. В верхней области конвейера выпуска появится небольшой баннер, например *Создан выпуск 1*. Выберите ссылку выпуска.
4. Откройте вкладку **Журналы**, чтобы просмотреть состояние выпуска.
    
    ![Успешное создание выпуска Azure DevOps Services и отправка пакета веб-развертывания](media/tutorial-vsts-iis-cicd/successful_release.png)

5. После создания выпуска откройте браузер и введите общедоступный IP-адрес виртуальной машины. Вы увидите, что веб-приложение ASP.NET выполняется.

    ![Выполнение веб-приложения ASP.NET на виртуальной машине IIS](media/tutorial-vsts-iis-cicd/running_web_app.png)


## <a name="test-the-whole-cicd-pipeline"></a>Тестирование всего конвейера CI/CD
Теперь, когда у вас есть веб-приложение, выполняющееся на IIS, запустите конвейер CI/CD. После внесения изменений в Visual Studio и фиксации кода активируется сборка, которая затем запускает выпуск обновленного пакета веб-развертывания в IIS:

1. В Visual Studio откройте окно **обозревателя решений**.
2. Выберите *myWebApp | Views | Home | Index.cshtml*.
3. Измените строку 6 на следующую:

    `<h1>ASP.NET with Azure DevOps Services and CI/CD!</h1>`

4. Сохраните файл.
5. Откройте окно **Team Explorer** и выберите проект *myWebApp*, а затем — **Изменения**.
6. Введите сообщение фиксации, например *Тестирование конвейера CI/CD*, а затем в раскрывающемся меню выберите **Зафиксировать все и синхронизировать**.
7. В рабочей области Azure DevOps Services новая сборка активируется из фиксации кода. 
    - Выберите **Сборка и выпуск**, а затем — **Сборки**. 
    - Выберите свой конвейер сборки, а затем выберите сборку **В очереди и выполняется** для отслеживания процесса сборки.
9. После успешного выполнения сборки активируется новый выпуск.
    - Выберите **Сборка и выпуск**, а затем — **Выпуски**, чтобы увидеть пакет веб-развертывания, отправленный на виртуальную машину IIS. 
    - Щелкните значок **обновления**, чтобы обновить состояние. Появление в столбце *сред* зеленой галочки означает успешное развертывание выпуска в IIS.
11. Чтобы увидеть, что изменения применены, обновите веб-сайт IIS в браузере.

    ![Выполнение веб-приложения ASP.NET на виртуальной машине IIS из конвейера CI/CD](media/tutorial-vsts-iis-cicd/running_web_app_cicd.png)


## <a name="next-steps"></a>Дополнительная информация

В рамках этого руководства вы создали веб-приложение ASP.NET в Azure DevOps Services, а также настроили конвейеры сборки и выпуска для развертывания новых пакетов веб-развертывания в IIS для каждой фиксации кода. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * публиковать веб-приложение ASP.NET в проекте Azure DevOps Services;
> * создавать конвейер сборки, который активируется фиксациями кода;
> * устанавливать и настраивать IIS на виртуальной машине в Azure;
> * добавлять экземпляр IIS в группу развертывания в Azure DevOps Services;
> * создавать конвейер выпуска для публикации новых пакетов веб-развертывания в IIS;
> * Тестирование конвейера CI/CD

Перейдите к следующему руководству, чтобы узнать, как установить стек SQL&#92;IIS&#92;.NET на двух виртуальных машинах Windows.

> [!div class="nextstepaction"]
> [Стек SQL&#92;IIS&#92;.NET](tutorial-iis-sql.md)
