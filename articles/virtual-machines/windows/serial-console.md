---
title: Последовательная консоль виртуальной машины Azure | Документация Майкрософт
description: Двунаправленная последовательная консоль виртуальных машин Azure.
services: virtual-machines-windows
documentationcenter: ''
author: harijay
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure-services
ms.date: 08/07/2018
ms.author: harijay
ms.openlocfilehash: 66354db65d5e615780ec49683fbc72f1156ac5e1
ms.sourcegitcommit: 8ebcecb837bbfb989728e4667d74e42f7a3a9352
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2018
ms.locfileid: "42146065"
---
# <a name="virtual-machine-serial-console-preview"></a>Последовательная консоль виртуальной машины (предварительная версия) 


Последовательная консоль виртуальной машины в Azure предоставляет доступ к текстовой консоли для виртуальных машин Linux и Windows. Это последовательное подключение к виртуальной машине происходит через последовательный порт COM1 и открывает доступ к виртуальной машине вне зависимости от состояния, в котором находится сеть или операционная система виртуальной машины. Получить доступ к последовательной консоли для виртуальной машины сейчас можно только на портале Azure. Он предоставляется только тем пользователям, у которых есть права участника виртуальной машины или выше на доступ к виртуальной машине. 

Чтобы просмотреть документацию по последовательной консоли для виртуальных машин Linux, [щелкните здесь](../linux/serial-console.md).

> [!Note] 
> Предварительные версии предоставляются при условии, что вы соглашаетесь с условиями использования. Дополнительные сведения см. в статье [Дополнительные условия использования Предварительных выпусков Microsoft Azure.] (https://azure.microsoft.com/support/legal/preview-supplemental-terms/). Сейчас эта служба находится на этапе **общедоступной предварительной версии** и доступ к последовательной консоли для виртуальных машин предоставляется в глобальных регионах Azure. На этом этапе в последовательной консоли недоступно облако Azure для государственных организаций, Azure для Германии или Azure для Китая.

 

## <a name="prerequisites"></a>Предварительные требования 

* Требуется использовать модель развертывания управления ресурсами. Классические развертывания не поддерживаются. 
* На виртуальной машине ДОЛЖНА быть включена [диагностика загрузки](boot-diagnostics.md). 
* Учетной записи, использующей последовательную консоль, должна быть присвоена [роль участника](../../role-based-access-control/built-in-roles.md) для виртуальной машины и учетная запись хранения [диагностики загрузки](boot-diagnostics.md). 

## <a name="open-the-serial-console"></a>Открытие последовательной консоли
Получить доступ к последовательной консоли для виртуальной машины можно только на [портале Azure](https://portal.azure.com). Ниже приведены шаги для получения доступа к последовательной консоли виртуальных машин через портал. 

  1. Откройте портал Azure.
  2. В меню слева выберите виртуальные машины.
  3. Щелкните виртуальную машину в списке. Откроется страница обзора для виртуальной машины.
  4. Прокрутите вниз до раздела Support + Troubleshooting (Поддержка + Устранение неполадок) и щелкните параметр последовательной консоли (предварительная версия). Откроется новая область с последовательной консолью, и запустится подключение.

![](../media/virtual-machines-serial-console/virtual-machine-windows-serial-console-connect.gif)

## <a name="disable-serial-console"></a>Отключение последовательной консоли
По умолчанию доступ к последовательной консоли включен для всех виртуальных машин во всех подписках. Последовательную консоль можно отключить на уровне подписки или на уровне виртуальной машины.

### <a name="subscription-level-disable"></a>Отключение на уровне подписки
Последовательную консоль можно отключить для всей подписки с помощью [вызова REST API отключения консоли](https://aka.ms/disableserialconsoleapi). Вы можете нажать кнопку "Попробовать", доступную на странице документации по API, чтобы отключить и включить последовательную консоль для подписки. Введите свой `subscriptionId`, "default" в поле `default` и щелкните "Выполнить". Команды Azure CLI еще не доступны и будут внедрены позже. Попробуйте вызвать REST API [с помощью этой ссылки](https://aka.ms/disableserialconsoleapi).

![](../media/virtual-machines-serial-console/virtual-machine-serial-console-rest-api-try-it.png)

Кроме того, можно использовать набор команд в Cloud Shell (команды bash показаны ниже), чтобы отключить, включить и просмотреть отключенное состояние последовательной консоли для подписки. 

* Чтобы получить отключенное состояние последовательной консоли для подписки:
    ```
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s | jq .properties
    ```
* Чтобы отключить последовательную консоль для подписки:
    ```
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl -X POST "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default/disableConsole?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s -H "Content-Length: 0"
    ```
* Чтобы включить последовательную консоль для подписки:
    ```
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl -X POST "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default/enableConsole?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s -H "Content-Length: 0"
    ```

### <a name="vm-level-disable"></a>Отключение на уровне виртуальной машины
Последовательную консоль можно отключить для конкретных виртуальных машин, отключив параметр диагностики загрузки этой виртуальной машины. Просто отключите диагностику загрузки на портале Azure, и последовательная консоль будет отключена для виртуальной машины.

## <a name="serial-console-security"></a>Безопасность последовательной консоли 

### <a name="access-security"></a>Безопасность доступа 
Доступ к последовательной консоли ограничен кругом пользователей, обладающих на виртуальной машине правами [Участник](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) или более широкими полномочиями доступа к ней. Если клиентам AAD нужна многофакторная идентификация, тогда она потребуется и для доступа к последовательной консоли, так как доступ осуществляется через [портал Azure](https://portal.azure.com).

### <a name="channel-security"></a>Безопасность канала
Все данные, исходящие и поступающие, при пересылке по сети зашифрованы.

### <a name="audit-logs"></a>Журналы аудита
Все сведения о доступе к последовательной консоли записываются в журналы [диагностики загрузки](https://docs.microsoft.com/azure/virtual-machines/linux/boot-diagnostics) на виртуальной машине. Права доступа к этим журналам и на работу с ними принадлежат администратору виртуальной машины Azure.  

>[!CAUTION] 
Так как пароли доступа для консоли не записываются в журнал, если команды, выполняемые в консоли, содержат или выводят пароли, секреты, имена пользователей и любые другие формы персональных данных, они должны записываться в журналы диагностики загрузки виртуальной машины вместе с остальными элементами с видимым текстом. Это является частью реализации функциональности последовательной консоли. Эти журналы являются циклическими, и только пользователи с разрешениями на чтение для учетной записи хранения диагностики имеют к ним доступ. Но мы рекомендуем следовать рекомендации использования удаленного рабочего стола для всего, что может содержать секретные или персональные данные. 

### <a name="concurrent-usage"></a>Одновременное использование
Когда один пользователь подключен к последовательной консоли, а другой пользователь успешно запрашивает доступ к этой же виртуальной машине, первый пользователь будет отключен, а второй пользователь будет подключаться таким способом, как будто первый пользователь вышел из физической консоли, а новый пользователь остался.

>[!CAUTION] 
Это означает, что отключенный пользователь не выходит из системы! Возможность принудительного выхода из системы после отключения (с помощью SIGHUP или похожего механизма) по-прежнему планируется. Для Windows включено автоматическое истечение времени ожидания в SAC, а для Linux можно настроить параметр времени ожидания терминала. 


## <a name="access-serial-console-for-windows"></a>Доступ к последовательной консоли в Windows 
Новые образы Windows Server в Azure по умолчанию будут оснащены [специальной административной консолью](https://technet.microsoft.com/library/cc787940(v=ws.10).aspx) (SAC). SAC поддерживается в серверных версиях Windows, но не поставляется в клиентских версиях (например, в Windows 10, Windows 8 или Windows 7). Включение последовательной консоли в виртуальных машинах Windows, созданных с помощью февральских образов 2018 года или более поздних, происходит следующим образом. 

1. Подключитесь к виртуальной машине через удаленный рабочий стол Windows.
2. Запустите следующие команды из командной строки с правами администратора. 
* `bcdedit /ems {current} on`
* `bcdedit /emssettings EMSPORT:1 EMSBAUDRATE:115200`
3. Для получения доступа к консоли SAC перезагрузите систему.

![](../media/virtual-machines-serial-console/virtual-machine-windows-serial-console-connect.gif)

В случае необходимости SAC можно также включить в автономном режиме. 

1. Подключите диск Windows, который необходимо настроить с помощью консоли SAC в качестве диска данных, к имеющейся виртуальной машине. 
2. Запустите следующие команды из командной строки с правами администратора. 
* `bcdedit /store <mountedvolume>\boot\bcd /ems {default} on`
* `bcdedit /store <mountedvolume>\boot\bcd /emssettings EMSPORT:1 EMSBAUDRATE:115200`

### <a name="how-do-i-know-if-sac-is-enabled-or-not"></a>Как узнать, доступна ли SAC 

Если [SAC] (https://technet.microsoft.com/library/cc787940(v=ws.10).aspx)) не включена, последовательная консоль не выведет запрос SAC. В некоторых случаях она может показывать сведения о работоспособности виртуальной машины или же она может быть пустой.  

### <a name="enabling-boot-menu-to-show-in-the-serial-console"></a>Включение меню загрузки для отображения в последовательной консоли 

Если необходимо включить отображение сообщений загрузчика Windows в последовательной консоли, добавьте дополнительные параметры в загрузчик Windows.

1. Подключитесь к виртуальной машине через удаленный рабочий стол Windows.
2. Запустите следующие команды из командной строки с правами администратора. 
* `bcdedit /set {bootmgr} displaybootmenu yes`
* `bcdedit /set {bootmgr} timeout 5`
* `bcdedit /set {bootmgr} bootems yes`
3. Перезагрузите систему, чтобы включить меню загрузки.

> [!NOTE] 
> В этот момент поддержка функциональных клавиш не включена, и если требуются расширенные варианты загрузки, используйте bcdedit /set {current} onetimeadvancedoptions. Дополнительные сведения см. в разделе о [bcdedit](https://docs.microsoft.com/windows-hardware/drivers/devtest/bcdedit--set).

## <a name="using-serial-console-for-nmi-calls-in-windows-vms"></a>Использование последовательной консоли для вызовов NMI на виртуальных машинах Windows
Немаскируемое прерывание (NMI) предназначено для создания сигнала, который программное обеспечение на виртуальной машине не будет игнорировать. Раньше немаскируемые прерывания использовались для мониторинга аппаратных проблем в системах, требующих определенного времени отклика.  Сегодня программисты и системные администраторы часто используют немаскируемое прерывание в качестве механизма для отладки или устранения неполадок в зависших системах.

Последовательную консоль можно использовать для отправки немаскируемого прерывания на виртуальную машину Azure с помощью значка клавиатуры, показанного ниже в командной строке. Как только немаскируемое прерывание запустится, конфигурация виртуальной машины будет управлять реакцией системы. Windows может быть настроена на аварийное завершение и создание дампа памяти при получении немаскируемого прерывания.

![](../media/virtual-machines-serial-console/virtual-machine-windows-serial-console-nmi.png) <br>

Сведения о настройке Windows для создания аварийного дампа при получении немаскируемого прерывания см. в разделе [How to generate a complete crash dump file or a kernel crash dump file by using an NMI on a Windows-based system](https://support.microsoft.com/en-us/help/927069/how-to-generate-a-complete-crash-dump-file-or-a-kernel-crash-dump-file) (Как создать полный файл аварийного дампа или ядро файла аварийного дампа с использованием немаскируемого прерывания на компьютере с ОС Windows)


## <a name="errors"></a>Errors
Большинство ошибок носят временный характер и устраняются после повторной попытки подключения. В таблице ниже приведен список ошибок и способы устранения неисправностей. 

Ошибка                            |   Устранение 
:---------------------------------|:--------------------------------------------|
Не удалось получить параметры диагностики загрузки для "<VMNAME>". Чтобы использовать последовательную консоль, включите диагностику загрузки для этой виртуальной машины. | Включите [диагностику загрузки](boot-diagnostics.md) для виртуальной машины. 
Виртуальная машина находится в состоянии "Остановлено (освобождено)". Запустите виртуальную машину и повторите попытку подключения к последовательной консоли. | Для доступа к последовательной консоли виртуальная машина должна быть в состоянии "Запущено".
У вас нет нужных разрешений для использования последовательной консоли этой виртуальной машины. Убедитесь в наличии по крайней мере разрешений роли участника виртуальной машины.| Для доступа к последовательной консоли требуются определенные разрешения. Подробные сведения см. в разделе [требований доступа](#prerequisites).
Не удалось определить группу ресурсов для учетной записи хранения диагностики загрузки "<STORAGEACCOUNTNAME>". Убедитесь, что для этой виртуальной машины включена диагностика загрузки и у вас есть доступ к этой учетной записи хранения. | Для доступа к последовательной консоли требуются определенные разрешения. Подробные сведения см. в разделе [требований доступа](#prerequisites).
При доступе к учетной записи хранения для диагностики загрузки виртуальной машины обнаружен ответ "Запрещено". | Убедитесь, что в системе диагностики загрузки нет брандмауэра учетной записи. Для функционирования последовательной консоли требуется доступная учетная запись хранения для диагностики загрузки.
Веб-сокет закрыт или его не удалось открыть. | Может потребоваться добавить `*.console.azure.com` в список разрешений. Более подробный, но более длинный подход заключается в добавлении в список разрешений [диапазонов IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/en-us/download/details.aspx?id=41653), которые изменяются довольно часто.

## <a name="known-issues"></a>Известные проблемы 
Так как доступ к последовательной консоли по-прежнему находится на этапе предварительной версии, мы работаем над некоторыми известными проблемами. Ниже приведен список этих возможных решений. 

Проблема                             |   Устранение 
:---------------------------------|:--------------------------------------------|
Невозможно получить доступ к последовательной консоли экземпляра масштабируемого набора виртуальных машин | На этапе предварительной версии доступ к последовательной консоли для экземпляров масштабируемого набора виртуальных машин не поддерживается.
Нажатие клавиши ВВОД после заголовка соединения не отображает запрос на вход | [Нажатие клавиши ВВОД не приводит ни к каким результатам](https://github.com/Microsoft/azserialconsole/blob/master/Known_Issues/Hitting_enter_does_nothing.md)
Отображаются только сведения о работоспособности при подключении к виртуальной машине Windows| [Сигналы работоспособности Windows](https://github.com/Microsoft/azserialconsole/blob/master/Known_Issues/Windows_Health_Info.md)
Не удается выполнить ввод в командной строке SAC, если включена отладка ядра | Подключитесь к виртуальной машине по протоколу RDP и выполните `bcdedit /debug {current} off` из командной строки с повышенными привилегиями. Если вы не можете использовать RDP, вместо этого подключите диск ОС к другой виртуальной машине Azure и при подключении сделайте его диском данных с помощью `bcdedit /store <drive letter of data disk>:\boot\bcd /debug <identifier> off`, а затем переключите диск обратно.
Вставка в PowerShell в SAC приводит к возникновению третьего знака, если исходное содержимое имело повторяющийся знак | Возможным решением является удаление модуля PSReadLine. `Remove-Module PSReadLine` удаляет модуль PSReadLine из текущего сеанса.
Некоторые введенные с клавиатуры данные создают странные выходные данные SAC (например `[A`, `[3~`) | Еscape-последовательность [VT100](https://aka.ms/vtsequences) не поддерживается в запросе SAC.
При доступе к учетной записи хранения для диагностики загрузки виртуальной машины обнаружен ответ "Запрещено". | Убедитесь, что в системе диагностики загрузки нет брандмауэра учетной записи. Для функционирования последовательной консоли требуется доступная учетная запись хранения для диагностики загрузки.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы 
**В. Как отправить отзыв?**

О. Чтобы отправить отзыв как ошибку, перейдите на страницу https://aka.ms/serialconsolefeedback. Кроме того, (менее предпочтительно) отправьте отзыв по адресу azserialhelp@microsoft.com или в категории виртуальной машины на сайте http://feedback.azure.com.

**В. Я не могу получить доступ к последовательной консоли. Где можно отправить запрос в службу поддержки?**

О. Эта функция предварительной версии рассматривается в условиях предварительной версии Azure. Соответствующая поддержка эффективнее всего предоставляется через вышеупомянутые каналы. 

## <a name="next-steps"></a>Дополнительная информация
* Подробное руководство по командам CMD и PowerShell, которые можно использовать в Windows SAC, см. [здесь](serial-console-cmd-ps-commands.md).
* Последовательная консоль также доступна для виртуальных машин [Linux](../linux/serial-console.md).
* См. дополнительные сведения в статье [Устранение неполадок виртуальных машин Windows в Azure с использованием диагностики загрузки](boot-diagnostics.md).
