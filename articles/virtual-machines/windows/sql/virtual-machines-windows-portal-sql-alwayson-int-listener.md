---
title: "Создание прослушивателя для групп доступности SQL Server в службе виртуальных машин Azure | Документация Майкрософт"
description: "Пошаговые инструкции по созданию прослушивателя для группы доступности AlwaysOn для SQL Server в службе виртуальных машин Azure."
services: virtual-machines
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: monicar
ms.assetid: d1f291e9-9af2-41ba-9d29-9541e3adcfcf
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 05/01/2017
ms.author: mikeray
ms.translationtype: Human Translation
ms.sourcegitcommit: 64bd7f356673b385581c8060b17cba721d0cf8e3
ms.openlocfilehash: 9998c6ac27b9dc06b71edb4531aebeeb53fefcce
ms.contentlocale: ru-ru
ms.lasthandoff: 05/02/2017


---
# <a name="configure-an-internal-load-balancer-for-an-always-on-availability-group-in-azure"></a>Настройка внутренней подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure
В этой статье описывается, как создать внутреннюю подсистему балансировки нагрузки для группы доступности AlwaysOn для SQL Server на виртуальных машинах Azure, развернутых с помощью модели Azure Resource Manager. Группе доступности нужен балансировщик нагрузки, если экземпляры SQL Server находятся на виртуальных машинах Azure. Балансировщик нагрузки хранит IP-адрес для прослушивателя группы доступности. Если группа доступности распространяется на несколько регионов, для каждого из них нужен отдельный балансировщик.

Для этого необходимо развернуть группу доступности SQL Server на виртуальных машинах Azure с использованием модели Resource Manager. Обе виртуальные машины SQL Server должны принадлежать к одной и той же группе доступности. Вы можете использовать [шаблон Майкрософт](virtual-machines-windows-portal-sql-alwayson-availability-groups.md) , чтобы автоматически создать группу доступности в Azure Resource Manager. Этот шаблон также автоматически создает внутренний балансировщик нагрузки. 

При необходимости [группу доступности можно настроить вручную](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md).

Здесь предполагается, что группы доступности уже настроены.  

Связанные разделы включают:

* [Введение в группы доступности AlwaysOn SQL Server на виртуальных машинах Azure](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md)   
* [Настройка подключения между виртуальными сетями с помощью Azure Resource Manager и PowerShell](../../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md)

Последовательно выполнив все действия в этом документе, вы создадите и настроите подсистему балансировки нагрузки на портале Azure. После этого вы настроите в кластере IP-адрес подсистемы балансировки для прослушивателя группы доступности.

## <a name="create-and-configure-the-load-balancer-in-the-azure-portal"></a>Создание и настройка балансировщика нагрузки на портале Azure
В этом разделе мы сделаем на портале Azure следующее:

1. Создадим балансировщик нагрузки и настроим IP-адрес.
2. Настроим серверный пул.
3. Создадим пробу. 
4. Настроим правила балансировки нагрузки.

> [!NOTE]
> Если серверы SQL Server расположены в разных группах ресурсов и регионах, необходимо выполнить все эти действия в каждой группе ресурсов.
> 
> 

### <a name="1-create-the-load-balancer-and-configure-the-ip-address"></a>1. Создание балансировщика нагрузки и настройка IP-адреса
Сначала необходимо создать балансировщик нагрузки. На портале Azure откройте группу ресурсов, в которой содержатся виртуальные машины SQL Server. В колонке группы ресурсов щелкните **Добавить**.

1. Найдите **балансировщик нагрузки**. В результатах поиска выберите **Балансировщик нагрузки**, опубликованный корпорацией **Майкрософт**.
1. В колонке **Балансировщик нагрузки** щелкните **Создать**.
1. В колонке **Create load balancer**(Создание балансировщика нагрузки) настройте балансировщик, задав следующие параметры:

   | Параметр | Значение |
   | --- | --- |
   | **Имя** |Текст, представляющий имя балансировщика нагрузки. Например, **sqlLB**. |
   | **Тип** |**Внутренний** |
   | **Виртуальная сеть** |Выберите виртуальную сеть, в которой расположены серверы SQL Server. |
   | **Подсеть** |Выберите подсеть, в которой расположены серверы SQL Server. |
   | **Назначение IP-адресов** |**Статическое** |
   | **Частный IP-адрес** |Укажите свободный IP-адрес из нужной подсети. Используйте этот IP-адрес при создании прослушивателя в кластере. Далее вам понадобится использовать этот адрес для переменной `$ILBIP` в сценарии PowerShell. |
   | **Подписка** |Это поле может появиться, если у вас несколько подписок. Выберите подписку, которую требуется связать с этим ресурсом. Обычно это подписка, с которой связаны все ресурсы группы доступности. |
   | **Группа ресурсов** |Выберите группу ресурсов, в которой расположены серверы SQL Server. |
   | **Расположение** |Выберите расположение Azure, в котором находятся серверы SQL Server. |

1. Щелкните **Создать**. 

Azure создаст подсистему балансировки нагрузки. Балансировщик нагрузки относится к конкретной сети, подсети, группе ресурсов и расположению. После создания балансировщика нагрузки проверьте его параметры в Azure. 

### <a name="2-configure-the-backend-pool"></a>2. Настройка серверного пула
Следующий шаг — создание серверного пула адресов. В Azure серверный пул адресов называется просто *серверным пулом*. В нашем случае — это адреса двух серверов SQL Server в группе доступности. 

1. В группе ресурсов щелкните созданную подсистему балансировки нагрузки. 
1. В колонке **Параметры** щелкните **Серверные пулы**.
1. На вкладке **Серверные пулы** щелкните **Добавить**, чтобы создать серверный пул адресов. 
1. В колонке **Добавить внутренний пул** under **Имя**введите имя серверного пула.
1. В разделе **Виртуальные машины** щелкните **+ Добавить виртуальную машину**. 
1. В разделе **Выбор виртуальных машин** щелкните **Выберите группу доступности** и укажите группу доступности, к которой принадлежат виртуальные машины SQL Server.
1. Выбрав группу доступности, щелкните **Выберите виртуальные машины**. Щелкните две виртуальные машины, на которых размещены экземпляры SQL Server в группе доступности. Нажмите кнопку **Выбрать**. 
1. Нажмите кнопку **ОК**, чтобы закрыть колонки **Выбор виртуальных машин** и **Добавить внутренний пул**. 

После этого Azure обновит параметры для серверного пула адресов. Теперь в вашей группе доступности есть пул из двух серверов SQL Server.

### <a name="3-create-a-probe"></a>3. Создание пробы
Теперь необходимо создать пробу. Проба определяет, как Azure будет проверять, какому из серверов SQL Server в данный момент принадлежит прослушиватель группы доступности. Azure проверяет службу по IP-адресу и порту, которые вы указываете при создании пробы.

1. В колонке **Параметры** для подсистемы балансировки нагрузки щелкните **Health probes** (Пробы работоспособности). 
1. В колонке **Health probes** (Пробы работоспособности) щелкните **Добавить**.
1. Настройте пробу в колонке **Добавление пробы** . Для настройки пробы используйте следующие значения:

   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Текст, представляющий имя пробы. Например, **SQLAlwaysOnEndPointProbe**. |
   | **Протокол** |**TCP** |
   | **Порт** |Вы можете использовать любой доступный порт. Например, *59999*. |
   | **Интервал** |*5* |
   | **Пороговое значение сбоя** |*2* |

1.  Нажмите кнопку **ОК**. 

> [!NOTE]
> Указанный порт должен быть открыт в брандмауэре обоих серверов SQL Server. Для обоих серверов требуется правило для входящего трафика используемого TCP-порта. Дополнительные сведения см. в статье [Добавление и изменение правила брандмауэра](http://technet.microsoft.com/library/cc753558.aspx). 
> 
> 

Azure создаст пробу. С ее помощью Azure будет проверять, на каком сервере SQL Server есть прослушиватель для группы доступности.

### <a name="4-set-the-load-balancing-rules"></a>4. Настройка правил балансировки нагрузки
Настройте правила балансировки нагрузки. Правила балансировки нагрузки определяют способ направления трафика балансировщиком нагрузки на серверах SQL Server. Для этой подсистемы балансировки включите прямой ответ от сервера, так как одновременно только один из двух серверов SQL Server может содержать ресурс прослушивателя группы доступности.

1. В колонке **Параметры** для балансировщика нагрузки щелкните **Правила балансировки нагрузки**. 
1. В колонке **Правила балансировки нагрузки** щелкните **Добавить**.
1. Используйте колонку **Add load balancing rules** (Добавление правил балансировки нагрузки), чтобы настроить правило балансировки нагрузки. Используйте следующие параметры: 

   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Текст, представляющий имя правила балансировки нагрузки. Например, **SQLAlwaysOnEndPointListener**. |
   | **Протокол** |**TCP** |
   | **Порт** |*1433* |
   | **Серверный порт** |*1433*. Это значение игнорируется, поскольку правило использует **плавающий IP-адрес (прямой ответ от сервера)**. |
   | **Проба** |Используйте имя пробы, созданной для этого балансировщика нагрузки. |
   | **Сохранение сеанса** |**None** |
   | **Время ожидания простоя (в минутах)** |*4* |
   | **Плавающий IP-адрес (прямой ответ от сервера)** |**Включено** |

   > [!NOTE]
   > Возможно, потребуется прокрутить колонку вниз, чтобы просмотреть все параметры.
   > 

1. Нажмите кнопку **ОК**. 
1. Azure настроит правило балансировки нагрузки. Теперь балансировщик нагрузки настроен для маршрутизации трафика на сервер SQL Server, на котором размещается прослушиватель для группы доступности. 

На этом этапе группа ресурсов содержит подсистему балансировки нагрузки, через которую происходит подключение к обеим виртуальным машинам SQL Server. Подсистема балансировки также содержит IP-адрес прослушивателя группы доступности AlwaysOn для SQL Server. Таким образом, любая виртуальная машина может отвечать на запросы для групп доступности.

> [!NOTE]
> Если серверы SQL Server находятся в разных регионах, повторите эти действия еще раз в другом регионе. Балансировщик нагрузки необходим для каждого региона. 
> 
> 

## <a name="configure-the-cluster-to-use-the-load-balancer-ip-address"></a>Настройка использования IP-адреса балансировщика нагрузки для кластера
Теперь необходимо настроить прослушиватель в кластере и подключить его. Сделайте следующее: 

1. Создайте прослушиватель группы доступности в отказоустойчивом кластере. 
2. Подключите прослушиватель.

### <a name="5-create-the-availability-group-listener-on-the-failover-cluster"></a>5. Создание прослушивателя группы доступности в отказоустойчивом кластере
На этом шаге вручную создается прослушиватель группы доступности в диспетчере отказоустойчивости кластеров и службе SQL Server Management Studio (SSMS).

[!INCLUDE [ag-listener-configure](../../../../includes/virtual-machines-ag-listener-configure.md)]

### <a name="verify-the-configuration-of-the-listener"></a>Проверка конфигурации прослушивателя

Если ресурсы и зависимости кластера настроены правильно, вы увидите прослушиватель в SQL Server Management Studios. Чтобы задать порт прослушивателя, сделайте следующее:

1. Запустите SQL Server Management Studio и подключитесь к основной реплике.
2. Перейдите в раздел **Высокий уровень доступности AlwaysOn** | **Группы доступности** | **Прослушиватели группы доступности**. 
1. Теперь вы увидите имя прослушивателя, созданного в диспетчере отказоустойчивости кластеров. Щелкните правой кнопкой мыши имя прослушивателя и выберите **Свойства**.
1. В поле **Порт** укажите номер порта для прослушивателя группы доступности с помощью использованного ранее параметра $EndpointPort (по умолчанию использовалось значение 1433) и нажмите кнопку **ОК**.

Теперь у вас есть группа доступности на виртуальных машинах Azure, работающих в режиме Resource Manager. 

## <a name="test-the-connection-to-the-listener"></a>Проверка подключения к прослушивателю
Чтобы проверить подключение:

1. Подключитесь по протоколу RDP к серверу SQL Server, который находится в той же виртуальной сети, но не содержит реплику. Это может быть другой сервер SQL Server в кластере.
2. Для проверки подключения используйте служебную программу **sqlcmd** . Например, в следующем сценарии **sqlcmd** подключается к основной реплике через прослушиватель с использованием аутентификации Windows.
   
        sqlcmd -S <listenerName> -E

sqlcmd автоматически подключается к любому экземпляру SQL Server, на котором размещена основная реплика. 

## <a name="create-an-ip-address---for-an-additional-availability-group"></a>Создание IP-адреса для дополнительной группы доступности

Каждая группа доступности использует отдельный прослушиватель. У каждого прослушивателя имеется собственный IP-адрес. Используйте одну подсистему балансировки нагрузки для обслуживания IP-адреса для дополнительных прослушивателей. После создания группы доступности добавьте IP-адрес в подсистему балансировки нагрузки, а затем настройте прослушиватель.

Чтобы добавить IP-адрес в подсистему балансировки нагрузки с помощью портала Azure, выполните следующее.

1. На портале Azure откройте группу ресурсов, содержащую подсистему балансировки нагрузки, и щелкните эту подсистему. 
2. В разделе **Параметры** щелкните **Пул внешних IP-адресов**. Щелкните **+ Добавить**. 
3. В разделе **Добавить внешний IP-адрес** укажите имя внешнего интерфейса. 
4. Убедитесь, что указаны те же **виртуальная сеть** и **подсеть**, что и для экземпляров SQL Server.
5. Задайте IP-адрес для прослушивателя. 
   
   >[!TIP]
   >Можно задать статический IP-адрес, который в настоящее время не используется в подсети. Также можно задать динамический IP-адрес и сохранить новый пул внешних IP-адресов. При этом портал Azure автоматически назначит пулу доступный IP-адрес. Затем можно будет повторно открыть пул внешних IP-адресов и изменить этот адрес на статический. 

   Сохраните IP-адрес прослушивателя. 

6. Добавьте пробу работоспособности. Используйте следующие параметры:

   |Настройка |Значение
   |:-----|:----
   |**Имя** |Имя для идентификации пробы.
   |**Протокол** |TCP
   |**Порт** |Неиспользуемый TCP-порт. Должен быть доступен для всех виртуальных машин. Не должен использоваться для других целей. Два прослушивателя не могут использовать один и тот же порт пробы. 
   |**Интервал** |Промежуток времени между повторными попытками выполнения пробы. Используйте значение по умолчанию (5).
   |**Пороговое значение сбоя** |Количество последовательных нарушений пороговых значений, после которого виртуальная машина считается неработоспособной.

   Нажмите кнопку **ОК**, чтобы сохранить пробу. 

7. Создайте правило балансировки нагрузки. Выберите **Правила балансировки нагрузки**, затем щелкните **+ Добавить**.
8. Настройте новое правило балансировки нагрузки со следующими параметрами.

   |Настройка |Значение
   |:-----|:----
   |**Имя** |Имя для идентификации правила балансировки нагрузки. 
   |**Frontend IP address** (Интерфейсный IP-адрес) |Выберите IP-адрес, который вы создали. 
   |**Протокол** |TCP
   |**Порт** |Укажите порт, используемый экземплярами SQL Server. Экземпляр по умолчанию использует порт 1433, если только вы не изменили его. 
   |**Внутренний порт** |Укажите то же значение, что и для параметра **Порт**.
   |**Внутренний пул** |Пул, содержащий виртуальные машины с экземплярами SQL Server. 
   |**Зонд работоспособности** |Выберите пробу, которую вы создали.
   |**Сохранение сеанса** |None
   |**Время ожидания простоя (в минутах)** |Оставьте значение по умолчанию (4).
   |**Плавающий IP-адрес (прямой ответ от сервера)** | Включено

### <a name="configure-the-availability-group-go-use-the-new-ip-address"></a>Настройка группы доступности для использования нового IP-адреса

Чтобы завершить настройку кластера, повторите действия, которые были выполнены при создании первой группы доступности. То есть настройте [кластер для использования нового IP-адреса](#configure-the-cluster-to-use-the-load-balancer-ip-address). 

После добавления IP-адрес для прослушивателя можно настроить дополнительную группу доступности. 

1. Убедитесь, что порт пробы для нового IP-адреса открыт на обеих виртуальных машинах SQL Server. 

2. [Создайте точку доступа клиента в диспетчере кластеров](#addcap).

3. [Настройте ресурс IP-адреса для группы доступности](#congroup).

   >[!IMPORTANT]
   >При создании IP-адрес используйте IP-адрес, добавленный в подсистему балансировки нагрузки.  

4. [Сделайте так, чтобы ресурс группы доступности SQL Server зависел от точки доступа клиента](#dependencyGroup).

5. [Сделайте так, чтобы ресурс точки доступа клиента зависел от IP-адреса](#listname).
 
5. [Настройте параметры кластера в PowerShell](#setparam).

Настроив группу доступности для использования нового IP-адреса, настройте подключение к прослушивателю. 

## <a name="next-steps"></a>Дальнейшие действия

- [Настройка группы доступности AlwaysOn на виртуальных машинах Azure в разных регионах](virtual-machines-windows-portal-sql-availability-group-dr.md)

