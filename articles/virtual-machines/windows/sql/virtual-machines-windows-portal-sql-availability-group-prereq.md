---
title: "Необходимые компоненты для использования групп доступности SQL Server в виртуальных машинах Azure | Документация Майкрософт"
description: "В этом руководстве показано, как настроить необходимые компоненты для создания группы доступности AlwaysOn для SQL Server в виртуальных машинах Azure."
services: virtual-machines
documentationCenter: na
authors: MikeRayMSFT
manager: jhubbard
editor: monicar
tags: azure-service-management
ms.assetid: c492db4c-3faa-4645-849f-5a1a663be55a
ms.service: virtual-machines-sql
ms.devlang: na
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/17/2017
ms.author: mikeray
translationtype: Human Translation
ms.sourcegitcommit: 197ebd6e37066cb4463d540284ec3f3b074d95e1
ms.openlocfilehash: 8073a2ed0b565b1fdd2685f9c0f69abf2a3fc10a
ms.lasthandoff: 03/31/2017


---

# <a name="complete-prerequisites-for-creating-always-on-availability-groups-in-azure-virtual-machines"></a>Настройка необходимых компонентов для создания групп доступности AlwaysOn в виртуальных машинах Azure

В этом руководстве показано, как настроить необходимые компоненты для создания [группы доступности AlwaysOn для SQL Server в виртуальных машинах Azure](virtual-machines-windows-portal-sql-availability-group-tutorial.md). Когда необходимые компоненты будут настроены, у вас будут контроллер домена, два сервера SQL Server и следящий сервер в одной группе ресурсов.

**Оценка времени.** Чтобы завершить настройку компонентов, может потребоваться несколько часов. Большая часть времени уходит на создание виртуальных машин.

На схеме ниже показаны шаги, которые описываются в этом руководстве.

![Группа доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/00-EndstateSampleNoELB.png)

## <a name="review-availability-group-documentation"></a>Обзор документации группы доступности

К этому руководству можно переходить, если у вас имеются базовые представления о группах доступности Always On для SQL Server. Если же данная тема вам незнакома, см. сведения в статье [Обзор групп доступности AlwaysOn (SQL Server)](http://msdn.microsoft.com/library/ff877884.aspx).


## <a name="create-an-azure-account"></a>Создание учетной записи Azure
* Вам понадобится учетная запись Azure. Вы можете [создать бесплатную учетную запись Azure](/pricing/free-trial/?WT.mc_id=A261C142F) или [активировать преимущества для подписчиков Visual Studio](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F). 

## <a name="create-resource-group"></a>Создать группу ресурсов
1. Войдите на [портал Azure](http://portal.azure.com). 
2. Щелкните **+**, чтобы создать объект на портале.

   ![Создать](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-portalplus.png)

1. В окне поиска **Marketplace** введите **группа ресурсов**.
   
   ![Группа ресурсов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-resourcegroupsymbol.png)
1. Щелкните **Группа ресурсов**.
4. Щелкните **Создать**. 
5. В колонке **Группа ресурсов** в поле **Имя группы ресурсов** введите имя для группы ресурсов. Например, введите **sql-ha-rg**.
6. При наличии нескольких подписок Azure выберите ту, в которой необходимо создать группу доступности. 
7. Выберите расположение. Расположение — это регион Azure, где необходимо создать группу доступности. В этом руководстве все ресурсы будут созданы в одном расположении в среде Azure. 
8. Убедитесь, что флажок **Закрепить на панели мониторинга** установлен. Этот необязательный параметр позволяет разместить ярлык для группы ресурсов на панели мониторинга портала Azure.

   ![Группа ресурсов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-resourcegroup.png)

9. Щелкните **Создать** , чтобы создать группу ресурсов.

В среде Azure будет создана группа ресурсов, а ее ярлык закреплен на портале.

## <a name="create-network-and-subnets"></a>Создание сети и подсетей
Следующий шаг — создание сетей и подсетей в группе ресурсов Azure.

В решении используется виртуальная сеть с двумя подсетями. Дополнительные сведения о сетях в Azure см. в разделе [Обзор виртуальной сети](../../../virtual-network/virtual-networks-overview.md).

Создание виртуальной сети

1. На портале Azure в вашей группе ресурсов щелкните **+ Добавить**. В Azure откроется колонка **Все** . 
   
   ![Новый элемент](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/02-newiteminrg.png)
2. Введите в поле поиска **виртуальная сеть**.
   
     ![Поиск виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/04-findvirtualnetwork.png)
3. Щелкните **Виртуальная сеть**.
4. В колонке **Виртуальная сеть** выберите модель развертывания **Resource Manager** и нажмите кнопку **Создать**.
   
   В таблице ниже приведены параметры для виртуальной сети.
   
   | **Поле** | Значение |
   | --- | --- |
   | **Имя** |autoHAVNET |
   | **Пространство адресов** |10.33.0.0/24 |
   | **Имя подсети** |Администратор |
   | **Диапазон адресов подсети** |10.33.0.0/29 |
   | **Подписка** |Укажите подписку, которую нужно использовать. **Подписка.** Если есть только одна подписка, то этот параметр может быть пустым. |
   | **Расположение** |Укажите расположение Azure. |
   
   Адресное пространство и диапазон адресов подсети могут отличаться от указанных в таблице. В зависимости от подписки портал подскажет доступное адресное пространство и соответствующий диапазон адресов подсети. Если достаточное пространство адресов недоступно, используйте другую подписку. 

   В примере используется имя подсети **admin**. Эта подсеть для контроллеров домена. 

6. Щелкните **Создать**.
   
   ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/06-configurevirtualnetwork.png)

Вы вернетесь к панели мониторинга портала Azure и получите уведомление о создании сети.

### <a name="create-a-second-subnet"></a>Создание второй подсети
Новая виртуальная сеть имеет одну подсеть с именем **admin**. Ее используют контроллеры домена. Серверы SQL Server используют вторую подсеть с именем **SQL**. Чтобы настроить эту подсеть, сделайте следующее:

1. На панели мониторинга щелкните созданную группу ресурсов **SQL-HA-RG**. Найдите сеть в группе ресурсов в разделе **Ресурсы**.
   
    Если группа ресурсов **SQL-HA-RG** не отображается, ее можно найти, выбрав **Группы ресурсов** и установив фильтрацию по имени группы ресурсов.
2. Щелкните **autoHAVNET** в списке ресурсов. В Azure откроется колонка конфигурации сети.
3. В области виртуальной сети **autoHAVNET** щелкните **Все параметры**.
4. В колонке **Параметры** выберите **Подсети**.
   
    Обратите внимание на созданную подсеть. 
   
   ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/07-addsubnet.png)
5. Создайте вторую подсеть. Щелкните **+ Subnet**(+Подсеть). 
6. В колонке **Добавление подсети** настройте подсеть, указав **sqlsubnet** в поле **Имя**. Azure автоматически укажет допустимое значение в поле **Диапазон адресов**. Убедитесь, что этот диапазон адресов содержит по крайней мере 10 адресов. Для рабочей среды может потребоваться больше адресов. 
7. Нажмите кнопку **ОК**.
   
    ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/08-configuresubnet.png)

В следующей таблице описаны параметры конфигурации сети.

| **Поле** | Значение |
| --- | --- |
| **Имя** |**autoHAVNET** |
| **Пространство адресов** |Зависит от доступных адресных пространств в подписке. Стандартное значение — 10.0.0.0/16. |
| **Имя подсети** |**admin** |
| **Диапазон адресов подсети** |Зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.0.0/24. |
| **Имя подсети** |**sqlsubnet** |
| **Диапазон адресов подсети** |Зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.1.0/24. |
| **Подписка** |Укажите подписку, которую нужно использовать. |
| **Группа ресурсов** |**SQL-HA-RG** |
| **Расположение** |Укажите расположение, выбранное для группы ресурсов. |

## <a name="create-availability-sets"></a>Создание групп доступности

Прежде чем создавать виртуальные машины, необходимо создать группы доступности. Такие группы позволяют сократить простой при плановых и внеплановых мероприятиях обслуживания. Группа доступности Azure представляет собой логическую группу ресурсов, которую Azure помещает в физические домены сбоя и домены обновления. Домен сбоя обеспечивает разделение ресурсов питания и сетевых ресурсов для элементов группы доступности. Домен обновления гарантирует, что элементы группы доступности не отключаются для обслуживания одновременно. Узнайте об [управлении доступностью виртуальных машин](../manage-availability.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

Вам потребуется две группы доступности: одна для контроллеров домена, а вторая для серверов SQL Server.

Чтобы создать группу доступности, перейдите в колонку группы ресурсов и щелкните **Добавить**. Отфильтруйте результаты по запросу **Группа доступности**. В результатах выберите **Группа доступности** . Щелкните **Создать**.

Настройте две группы доступности в соответствии с параметрами в таблице ниже.

| **Поле** | Группа доступности контроллера домена | Группа доступности SQL Server |
| --- | --- | --- |
| **Имя** |adavailabilityset |sqlavailabilityset |
| **Группа ресурсов** |SQL-HA-RG |SQL-HA-RG |
| **Домены сбоя** |3 |3 |
| **Домены обновления** |5 |3 |

Создав группы доступности, вернитесь в колонку группы ресурсов на портале Azure.

## <a name="create-domain-controllers"></a>Создание контроллеров домена
Вы уже создали сеть, подсети, группы доступности и балансировщик нагрузки с выходом в Интернет. Теперь можно создать виртуальные машины для контроллеров домена.

### <a name="create-the-virtual-machines-for-the-domain-controllers"></a>Создание виртуальных машин для контроллеров домена
Чтобы создать и настроить контроллеры домена, вернитесь к группе ресурсов **SQL-HA-RG** .

1. Нажмите Добавить. Откроется колонка **Все** .
2. Введите **Windows Server 2016 Datacenter**. 
3. Щелкните **Windows Server 2016 Datacenter**. Убедитесь, что в колонке **Windows Server 2016 Datacenter** в качестве модели развертывания выбран параметр **Resource Manager**, а затем щелкните **Создать**. В Azure откроется колонка **Создание виртуальной машины** . 

Повторите действия выше, чтобы создать две виртуальные машины. Присвойте этим виртуальным машинам следующие имена:

* ad-primary-dc
* ad-secondary-dc.
  
  > [!NOTE]
  > **ad-secondary-dc** — дополнительный компонент для обеспечения высокой доступности доменных служб Active Directory. 
  > 
  > 

В таблице ниже приведены параметры для этих двух машин.

| **Поле** | Значение |
| --- | --- |
| **Тип диска виртуальной машины** |SSD |
| **Имя пользователя** |DomainAdmin |
| **Пароль** |Contoso!0000 |
| **Подписка** |*ваша подписка* |
| **Группа ресурсов** |SQL-HA-RG |
| **Расположение** |*ваше расположение* |
| **Размер** |DS1_V2 |
| **Учетная запись хранения** |*Создается автоматически* |
| **Виртуальная сеть** |autoHAVNET |
| **Подсеть** |admin |
| **Общедоступный IP-адрес** |*Совпадает с именем виртуальной машины* |
| **Группа безопасности сети** |*Совпадает с именем виртуальной машины* |
| **группа доступности;** |adavailabilityset |
| **Диагностика** |Включено |
| **Учетная запись хранения для диагностики** |*Создается автоматически* |


   >[!IMPORTANT]
   >Виртуальную машину можно разместить в группе доступности только при ее создании. После создания виртуальной машины группу доступности изменить невозможно. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин](../manage-availability.md).

Azure создаст виртуальные машины.

После создания виртуальных машин следует настроить контроллер домена.

### <a name="configure-the-domain-controller"></a>Настройка контроллера домена
На следующих этапах необходимо настроить машину **ad-primary-dc** в качестве контроллера домена для corp.contoso.com.

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **ad-primary-dc**. В колонке **ad-primary-dc** нажмите **Подключиться**, чтобы открыть RDP-файл для подключения к удаленному рабочему столу.
   
    ![Подключение к виртуальной машине](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/20-connectrdp.png)
2. Войдите в систему, используя настроенную учетную запись (**\DomainAdmin**) и пароль (**Contoso!0000**) администратора.
3. По умолчанию отображается панель мониторинга **Диспетчер серверов** .
4. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.
   
    ![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
5. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
6. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
   
   > [!NOTE]
   > Windows предупреждает о том, что статического IP-адреса не существует. Если вы тестируете конфигурацию, нажмите кнопку "Продолжить". Для рабочих сценариев на портале Azure установите статический IP-адрес или [используйте PowerShell для установки статического IP-адреса компьютера контроллера домена](../../../virtual-network/virtual-networks-reserved-private-ip.md).
   > 
   > 
   
    ![Диалоговое окно добавления ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/23-addroles.png)
7. Нажимайте **Далее**, пока не откроется раздел **Подтверждение**. Выберите флажок **Перезапустить целевой сервер, если требуется** .
8. Щелкните **Install**(Установить).
9. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
10. Выберите новый вариант **AD DS** на левой панели.
11. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.
    
    ![Диалоговое окно службы каталогов Active Directory на виртуальной машине DNS-сервера](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/24-addsmore.png)
12. В столбце **Действие** диалогового окна **Сведения обо всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.
13. В **мастере настройки доменных служб Active Directory**используйте следующие значения:
    
    | **Страница** | Настройка |
    | --- | --- |
    | **Конфигурация развертывания** |**Добавить новый лес**<br/> **Имя корневого домена** = corp.contoso.com |
    | **Параметры контроллера домена** |**Пароль DSRM** = Contoso!0000<br/>**Подтверждение пароля** = Contoso!0000 |
14. Нажимайте кнопку **Далее** , чтобы пройти остальные страницы мастера. Убедитесь, что на странице **Проверка готовности** отображается следующее сообщение: **Все проверки готовности успешно завершены**. Просмотрите все применимые предупреждающие сообщения, хотя для продолжения установки это и не обязательно.
15. Щелкните **Install**(Установить). Виртуальная машина **ad-primary-dc** перезагружается автоматически.

### <a name="note-ip-address-of-primary-domain-controller"></a>Получение IP-адреса основного контроллера домена

Используйте основной контроллер домена для DNS. Запишите IP-адрес основного контроллера домена.

Получить IP-адрес основного контроллера домена можно только через портал Azure. 

1. На портале Azure откройте группу ресурсов. 

1. Щелкните основной контроллер домена.

1. В колонке основного контроллера домена щелкните **Сетевые интерфейсы**.

![Новый элемент](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/25-primarydcip.png)

Сохраните частный IP-адрес для этого сервера. 

### <a name="configure-the-second-domain-controller"></a>Настройка второго контроллера домена
После перезагрузки основного контроллера домена можно настроить второй контроллер домена. Этот необязательный шаг выполняется для обеспечения высокой доступности. Чтобы настроить второй контроллер домена, сделайте следующее:

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **ad-secondary-dc**. В колонке **ad-secondary-dc** щелкните **Подключиться**, чтобы открыть RDP-файл для подключения к удаленному рабочему столу.
4. Войдите в виртуальную машину, используя настроенную учетную запись администратора (**BUILTIN\DomainAdmin**) и пароль (**Contoso!0000**).
3. Измените предпочтительный адрес DNS-сервера на адрес контроллера домена. 
1. В **Центре управления сетями и общим доступом** щелкните сетевой интерфейс. 
   ![NetworkInterface](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/26-networkinterface.png)

5. Щелкните **Свойства**.
10. Выберите пункт **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку "Свойства".
11. Установите переключатель **Использовать следующие адреса DNS-серверов** и укажите адрес основного контроллера домена в поле **Предпочитаемый DNS-сервер**.
1. Нажмите кнопку **ОК**, а затем — **Закрыть**, чтобы сохранить изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.

   >[!IMPORTANT]
   >Если вы потеряете подключение к удаленному рабочему столу после изменения параметров DNS-сервера, перейдите на портал Azure и перезапустите виртуальную машину.

1. С удаленного рабочего стола на втором контроллере домена откройте **панель мониторинга диспетчера сервера**.
4. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.
   
    ![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
5. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
6. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.

9. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
10. Выберите новый вариант **AD DS** на левой панели.
11. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.
12. В столбце **Действие** диалогового окна **Сведения обо всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.
1. На вкладке **Конфигурация развертывания** установите переключатель **Добавить контроллер домена в существующий домен**. 
   ![NetworkInterface](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/28-deploymentconfig.png)

1. Нажмите кнопку **Выбрать...**.
1. Подключитесь, используя учетную запись администратора (**CORP.CONTOSO.COM\domainadmin**) и пароль (**Contoso!0000**).
1. В разделе **Выберите домен в лесу** щелкните ваш домен, а затем щелкните **ОК**. 

1. В разделе **Параметры контроллера домена** используйте значения по умолчанию и задайте пароль DSRM.

   >[!NOTE]
   >На странице **Параметры DNS** может отобразиться предупреждение, что делегирование для этого DNS-сервера создать невозможно. В нерабочей среде это предупреждение можно игнорировать. 
1. Нажимайте кнопку **Далее** до тех пор, пока не откроется вкладка **Предварительные требования**. Нажмите **Install**(Установить).

После завершения изменений конфигурации перезапустите сервер. 

### <a name=DomainAccounts></a> Настройка учетных записей в домене

На следующих этапах настраиваются учетные записи Active Directory (AD). Учетные записи показаны в следующей таблице.

| |Учетная запись установки<br/> |sqlserver-0 <br/>Учетная запись SQL Server и службы агента SQL |sqlserver-1<br/>Учетная запись SQL Server и службы агента SQL
| --- | --- | --- | --- 
|**Имя** |Install |SQLSvc1 | SQLSvc2
|**User SamAccountName** |Install |SQLSvc1 | SQLSvc2

Чтобы создать каждую учетную запись, сделайте следующее: 

1. Войдите в виртуальную машину **ad-primary-dc** снова.
2. На панели **Диспетчер серверов** выберите **Средства**, а затем щелкните **Центр администрирования Active Directory**.   
3. Выберите **corp (local)** в левой области.
4. На правой панели **Задачи** выберите **Создать** и нажмите **Пользователь**. 
   ![Центр администрирования Active Directory](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/29-addcnewuser.png)

   >[!TIP]
   >Задайте сложный пароль для каждой учетной записи.<br/> Для нерабочей среды задайте неограниченный срок действия учетной записи пользователя.

5. Нажмите кнопку **ОК**, чтобы создать пользователя. 
6. Повторите предыдущие действия для каждой из трех учетных записей. 

### <a name="grant-required-permissions-to-the-installation-account"></a>Предоставление требуемых разрешений учетной записи установки
1. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели. Затем на правой панели **Задачи** нажмите кнопку **Свойства**.
   
    ![Свойства пользователя CORP](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/31-addcproperties.png)
8. Выберите **Расширения**, затем нажмите кнопку **Дополнительно** на вкладке **Безопасность**.
9. В диалоговом окне **Дополнительные параметры безопасности для предприятия** . Щелкните **Добавить**.
10. Щелкните **Выбрать субъект**. Затем найдите **CORP\Install**. Нажмите кнопку **ОК**.
11. Установите флажок **Read all properties** (Чтение всех свойств).

1. Установите флажок **Create Computer objects** (Создание объектов-компьютеров).
    
     ![Разрешения пользователя Corp](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/33-addpermissions.png)
12. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Закройте окно свойств предприятия.

После завершения настройки Active Directory и объектов пользователей нужно создать две виртуальные машины SQL Server и виртуальную машину следящего сервера. Затем присоедините их к этому домену.

## <a name="create-sql-servers"></a>Создание серверов SQL
### <a name="create-and-configure-the-sql-server-vms"></a>Создание и настройка виртуальных машин SQL Server
Далее создайте три виртуальные машины, включая две виртуальные машины SQL Server и виртуальную машину для дополнительного узла кластера. Чтобы создать виртуальные машины, вернитесь к группе ресурсов **SQL-HA-RG**, нажмите кнопку **Добавить**, найдите соответствующий элемент коллекции, выберите **Виртуальная машина**, а затем — **Из коллекции**. Используйте информацию из следующей таблицы, чтобы упростить создание виртуальных машин.

| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выбор соответствующего элемента коллекции |**Windows Server 2016 Datacenter** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |
| Конфигурация виртуальной машины **Базовый** |**Имя** = cluster-fsw<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-0<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-1<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |
| Конфигурация виртуальной машины **Размер** |DS1\_V2 (1 ядро, 3,5 ГБ) |**Размер** = DS2\_V2 (2 ядра, 7 ГБ) |**Размер** = DS2\_V2 (2 ядра, 7 ГБ) |
| Конфигурация виртуальной машины **Параметры** |**Хранилище** = Premium (SSD)<br/>**ПОДСЕТИ** = autoHAVNET<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** = нет<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = sqlAvailabilitySet<br/> |**Хранилище** = Premium (SSD)<br/>**ПОДСЕТИ** = autoHAVNET<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** = нет<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = sqlAvailabilitySet<br/> |**Хранилище** = Premium (SSD)<br/>**ПОДСЕТИ** = autoHAVNET<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** = нет<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = sqlAvailabilitySet<br/> |
| Конфигурация виртуальной машины **Параметры SQL Server** |Не применяется |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |

<br/>

> [!NOTE]
> Предлагаемые здесь размеры компьютеров предназначены для тестирования групп доступности в виртуальных машинах Azure. Для обеспечения оптимальной производительности рабочих нагрузок см. рекомендации по размерам машин SQL Server и их настройке в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-performance.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
> 
> 

После завершения подготовки трех виртуальных машин вам потребуется присоединить их к домену **corp.contoso.com** и предоставить пользователю CORP\Install права администратора виртуальных машин.

### <a name="set-dns-on-each-server"></a>Настройка DNS на каждом сервере
Для начала измените предпочитаемый адрес DNS-сервера для каждого рядового сервера. Выполните следующие действия.

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **sqlserver-0**. В колонке **sqlserver-0** щелкните **Подключиться**, чтобы открыть RDP-файл для подключения к удаленному рабочему столу.
2. Войдите в систему, используя настроенную учетную запись (**\DomainAdmin**) и пароль (**Contoso!0000**) администратора.
3. По умолчанию отображается панель мониторинга **Диспетчер серверов** . Щелкните **Локальный сервер** на левой панели.
5. Выберите ссылку **IPv4-адрес назначен DHCP, поддержка IPv6** .
6. В окне **Сетевые подключения** выберите значок сети.
7. На панели команд щелкните **Change the settings of this connection** (Изменить параметры этого подключения). Если этот параметр не отображается, щелкните стрелку справа дважды.
8. Выберите пункт **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку "Свойства".
9. Установите переключатель **Использовать следующие адреса DNS-серверов** и укажите адрес основного контроллера домена в поле **Предпочитаемый DNS-сервер**.
   >[!TIP]
   >Чтобы получить IP-адрес сервера, используйте `nslookup`.<br/>
   >Введите `nslookup ad-primary-dc` в командной строке. 
11. Нажмите кнопку **ОК**, а затем — **Закрыть**, чтобы сохранить изменения. 

   >[!IMPORTANT]
   >Если вы потеряете подключение к удаленному рабочему столу после изменения параметров DNS-сервера, перейдите на портал Azure и перезапустите виртуальную машину.

Повторите эти действия для всех серверов.

### <a name="joinDomain"></a>Присоединение серверов к домену

Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**. Выполните следующие действия для серверов SQL Server и сервера файлового ресурса-свидетеля: 

1. Удаленно подключитесь к виртуальной машине в качестве пользователя **BUILTIN\DomainAdmin**. 
1. В **диспетчере серверов** щелкните **Локальный сервер**.
1. Щелкните ссылку **Рабочая группа**.
1. В разделе **Имя компьютера** нажмите кнопку **Изменить**.
1. Установить флажок **Домен** и введите в текстовом поле **corp.contoso.com**. Нажмите кнопку **ОК**.
1. Во всплывающем диалоговом окне **Безопасность Windows** укажите имя (**CORP\DomainAdmin**) и пароль (**Contoso!0000**) учетной записи администратора домена по умолчанию.
1. При появлении сообщения "Добро пожаловать на домен corp.contoso.com" нажмите кнопку **ОК**.
1. Нажмите кнопку **Закрыть**, а затем **Перезагрузить сейчас** во всплывающем диалоговом окне.



### <a name="add-the-corpinstall-user-as-an-administrator-on-each-cluster-vm"></a>Добавьте пользователя Corp\Install в качестве администратора на каждой виртуальной машине кластера:

После того как каждая виртуальная машина будет перезапущена и войдет в состав домена, добавьте **CORP\Install** как участника группы локальных администраторов. 

1. Дождитесь перезапуска виртуальной машины, а затем запустите RDP-файл еще раз на основном контроллере домена, чтобы войти на **sqlserver-0**, используя учетную запись **CORP\DomainAdmin**.
   >[!TIP]
   >Обязательно выполните вход с использованием учетной записи администратора домена. Ранее вы использовали учетную запись администратора BUILTIN. Теперь, когда сервер находится в домене, используйте учетную запись домена. В сеансе RDP укажите *Домен*\\*имя пользователя*.

2. На панели **Диспетчер серверов** выберите **Инструменты**, а затем щелкните **Управление компьютером**.
3. В окне **Управление компьютерами** разверните пункт **Локальные пользователи и группы**, а затем выберите **Группы**.
4. Дважды щелкните группу **Администраторы** .
5. В диалоговом окне **Свойства администратора** нажмите кнопку **Добавить**.
6. Введите имя пользователя **CORP\Install**, а затем нажмите кнопку **ОК**. 
7. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Свойства администратора**.
8. Повторите описанные выше шаги для **sqlserver-1** и **cluster-fsw**.

### <a name="setServiceAccount"></a>Настройка учетных записей службы SQL Server

На каждом сервере SQL Server настройте учетную запись службы SQL Server. Используйте учетные записи, созданные при [настройке учетных записей домена](#DomainAccounts).

1. Откройте **диспетчер конфигурации SQL Server**.

1. Щелкните правой кнопкой мыши службу SQL Server, а затем выберите **Свойства**.

1. Настройте учетную запись и задайте пароль. 

1. Повторите эти действия на другом сервере SQL Server.  

Для групп доступности SQL Server каждый сервер SQL Server должен запускаться как учетная запись домена. 

### <a name="create-login-on-each-sql-server-for-installation-account"></a>Создание имени для входа на каждом сервере SQL Server для учетной записи установки

Используйте учетную запись установки, чтобы настроить группу доступности. Эта учетная запись должна быть участником предопределенной роли сервера **sysadmin** на каждом сервере SQL Server. Чтобы создать имя входа для учетной записи установки, сделайте следующее:

1. Выполните вход RDP на сервер, используя учетную запись *\<имя_компьютера\>\DomainAdmin*.

1. Откройте SQL Server Management Studio и подключитесь к локальному экземпляру сервера SQL Server. 

1. В **обозревателе объектов** щелкните **Безопасность**.

1. Щелкните правой кнопкой мыши **Имена входа**. Выберите **Создать имя входа...**.

1. В разделе **Создание имени входа** щелкните **Поиск...**.

1. Щелкните **Расположения...**.

1. Введите сетевые учетные данные администратора домена. 

1. Используйте учетную запись установки.

1. Сделайте имя для входа участником предопределенной роли сервера **sysadmin**. 

1. Нажмите кнопку ОК. 

Повторите эти действия на другом сервере SQL Server. 

## <a name="add-failover-cluster-features-to-both-sql-servers"></a>Добавление функций отказоустойчивого кластера на обоих серверах SQL Server

Чтобы добавить функции отказоустойчивого кластера, выполните следующие действия на обоих серверах SQL Server:

1. С удаленного рабочего стола на втором контроллере домена откройте **панель мониторинга диспетчера сервера**.
4. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.
   
    ![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
5. Нажимайте кнопку **Далее**, пока не откроется раздел **Server Features** (Функции сервера).
1. В разделе **функций** выберите **Отказоустойчивость кластеров**. 
1. Добавьте другие необходимые функции. 
1. Щелкните "Установить", чтобы добавить все функции.

Повторите эти действия на другом сервере SQL Server. 


## <a name="a-nameendpoint-firewall-configure-the-firewall-on-each-sql-server"></a><a name="endpoint-firewall"> Настройка брандмауэра на каждом сервере SQL Server

Это решение требует, чтобы в брандмауэре были открыты следующие TCP-порты:

- **SQL Server**<br/>
  Порт 1433 для экземпляра по умолчанию сервера SQL Server. 
- **Проба Azure Load Balancer**<br/>
  Любой доступный порт. В примерах часто используется 59999.
- **Конечная точка зеркального отображения базы данных** <br/>
  Любой доступный порт. В примерах часто используется 5022. 

Порты брандмауэра должны быть открыты на обоих серверах SQL Server.

Способ открытия портов зависит от используемого решения брандмауэра. В следующем разделе показано, как открыть порты в брандмауэре Windows. Откройте необходимые порты для каждого из серверов SQL Server. 

### <a name="open-a-tcp-port-on-a-firewall"></a>Открытие TCP-порта в брандмауэре 

1. На первом сервере SQL Server на **начальном экране** запустите **Брандмауэр Windows в режиме повышенной безопасности**.

2. В левой панели выберите **Правила для входящих подключений**. На правой панели нажмите кнопку **Новое правило**.

3. Для параметра **Тип правила** выберите **Порт**.

1. Для порта выберите тип TCP и введите соответствующие номера портов. Как в этом примере:

   ![SQLFirewall](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/35-tcpports.png)

1. Нажмите кнопку **Далее**. 

5. На странице **Действие** оставьте флажок **Разрешить подключение** и нажмите кнопку **Далее**.

6. На странице **Профиль** примите параметры по умолчанию и нажмите кнопку **Далее**.

7. На странице **Имя** укажите имя правила, например **Проба Azure LB**, в текстовом поле **Имя** и нажмите кнопку **Готово**.

Проделайте то же самое на втором сервере SQL Server.



## <a name="next-steps"></a>Дальнейшие действия

* [Создание группы доступности AlwaysOn для улучшения доступности и аварийного восстановления](virtual-machines-windows-portal-sql-availability-group-tutorial.md)

