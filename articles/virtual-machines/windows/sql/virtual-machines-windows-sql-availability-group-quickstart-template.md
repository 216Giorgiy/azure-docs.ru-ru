---
title: Создание WSFC и прослушивателя, а также настройка ILB для группы доступности Always On с помощью шаблона быстрого запуска Azure.
description: Использование шаблонов быстрого запуска Azure, упрощающих создание в Azure группы доступности для виртуальных машин SQL Server. С помощью шаблонов создается кластер, к нему присоединяются виртуальные машины SQL, создается прослушиватель и настраивается ILB.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: craigg
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 01/04/2018
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 9be8717bc9b1d15a59486edf206dd0657a711c06
ms.sourcegitcommit: a408b0e5551893e485fa78cd7aa91956197b5018
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2019
ms.locfileid: "54360559"
---
# <a name="create-wsfc-listener-and-configure-ilb-for-an-always-on-availability-group-on-a-sql-server-vm-with-azure-quickstart-template"></a>Создание WSFC и прослушивателя, а также настройка ILB для группы доступности Always On с помощью шаблона быстрого запуска Azure.
В этой статье объясняется, как использовать шаблоны быстрого запуска Azure для частично автоматизированного развертывания в Azure конфигурации с группой доступности Always On для виртуальных машин SQL Server. В этом процессе используются два шаблона быстрого запуска Azure. 

   | Шаблон | ОПИСАНИЕ |
   | --- | --- |
   | [101-sql-vm-ag-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) | Позволяет создать отказоустойчивый кластер Windows и присоединить к нему виртуальные машины SQL Server. |
   | [101-sql-vm-aglistener-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) | Позволяет создать прослушиватель группы доступности и настроить внутренний ресурс Load Balancer. |
   | &nbsp; | &nbsp; |

Остальные действия по созданию конфигурации группы доступности, в том числе создание группы доступности и внутреннего ресурса Load Balancer, выполняются вручную. В этой статье описана последовательность автоматизированных и выполняемых вручную действий.
 

## <a name="prerequisites"></a>Предварительные требования 
Чтобы автоматизировать настройку группы доступности Always On с помощью шаблонов быстрого запуска, требуется следующее: 
- [подписка Azure](https://azure.microsoft.com/free/);
- группа ресурсов с [контроллером домена](https://docs.microsoft.com/azure/architecture/reference-architectures/identity/adds-forest); 
- одна или несколько присоединенных к домену [виртуальных машин Azure под управлением SQL Server Enterprise Edition 2016 (или более поздней версии)](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision), размещенных в той же группе или зоне доступности, которая [зарегистрирована в поставщике ресурсов виртуальной машины SQL](#register-existing-sql-vm-with-new-resource-provider).  

## <a name="register-existing-sql-vm-with-new-resource-provider"></a>Регистрация существующей виртуальной машины SQL в новом поставщике ресурсов
Так как шаблоны быстрого запуска Azure для группы доступности зависят от поставщика ресурсов виртуальной машины SQL (Microsoft.SqlVirtualMachine), все существующие виртуальные машины SQL Server необходимо зарегистрировать в поставщике ресурсов виртуальной машины SQL. Этот шаг можно пропустить, если вы создали виртуальную машину SQL Server позднее декабря 2018 года. Все созданные после этой даты виртуальные машины SQL Server регистрируются автоматически. Из этого раздела вы узнаете, как зарегистрировать поставщик на портале Azure. Но вы можете использовать также [PowerShell](virtual-machines-windows-sql-ahb.md#powershell). 

  >[!IMPORTANT]
  > Если вы удалите ресурс виртуальной машины SQL Server, настройки лицензирования будут сброшены в состояние, жестко сохраненное в образе. 

1. Войдите на портал Azure и откройте раздел **Все службы**. 
1. Перейдите к разделу **Подписки** и выберите нужную подписку.  
1. В колонке **Подписки** перейдите к элементу **Поставщик ресурсов**. 
1. Введите в фильтр значение `sql`, чтобы отсортировать поставщиков ресурсов, имеющих отношение к SQL. 
1. Выберите действие *Зарегистрировать*, *Перерегистрировать* или *Отменить регистрацию* для поставщика **Microsoft.SqlVirtualMachine** в зависимости от ваших намерений. 

  ![Изменение поставщика](media/virtual-machines-windows-sql-ahb/select-resource-provider-sql.png)

## <a name="step-1---create-the-wsfc-and-join-sql-server-vms-to-the-cluster-using-quickstart-template"></a>Шаг 1. Создание кластера WSFC и присоединение виртуальных машин SQL Server к этому кластеру с помощью шаблона быстрого запуска 
Когда вы завершите регистрацию виртуальных машин SQL Server в новом поставщике ресурсов виртуальной машины SQL, можно будет объединить эти виртуальные машины SQL Server в группе *SqlVirtualMachineGroup*. Этот ресурс определяет метаданные для отказоустойчивого кластера Windows, в том числе версию, выпуск, полное доменное имя, учетные записи AD для управления кластером и учетную запись хранения для роли облака-свидетеля. Добавление виртуальной машины SQL Server в группу *SqlVirtualMachineGroup* обеспечивает начальную загрузку службы отказоустойчивого кластера Windows и соединение виртуальной машины SQL Server с кластером. Этот этап автоматизируется с помощью шаблона быстрого запуска **101-sql-vm-ag-setup**. Для его реализации выполните указанные ниже действия.

1. На портале Azure перейдите к шаблону быстрого запуска [**101-sql-vm-ag-setup**](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) и выберите действие **Развертывание в Azure**, чтобы запустить этот шаблон быстрого запуска.
1. Заполните все обязательные поля, чтобы настроить метаданные отказоустойчивого кластера Windows. Необязательные поля можно оставить пустыми.

    В приведенной ниже таблице представлены необходимые значения для этого шаблона. 

   | **Поле** | Значение |
   | --- | --- |
   | **Подписка** |  Подписка, в которой находятся ваши виртуальные машины SQL Server. |
   |**Группа ресурсов** | Группа ресурсов, где находятся ваши виртуальные машины SQL Server. | 
   |**Failover Cluster Name** (Имя отказоустойчивого кластера) | Имя, которое вы выбрали для нового отказоустойчивого кластера Windows. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Виртуальные машины SQL Server, которые вы хотите разместить в этой группе доступности, а значит, и в новом кластере. Разделите эти значения запятыми с пробелом (например, так: SQLVM1, SQLVM2). |
   | **Версия SQL Server** | Выберите в раскрывающемся списке версию SQL Server для виртуальных машин SQL Server. Сейчас поддерживаются только образы SQL 2016 и SQL 2017. |
   | **Existing Fully Qualified Domain Name** (Существующее полное доменное имя) | Полное доменное имя существующего домена, в котором находятся виртуальные машины SQL Server. |
   | **Existing Domain Account** (Учетная запись существующего домена) | Учетная запись существующего домена с доступом уровня системного администратора на SQL Server. | 
   | **Domain Account Password** (Пароль к учетной записи домена) | Пароль для указанной выше учетной записи домена. | 
   | **Existing Sql Service Account** (Существующая учетная запись службы SQL Server) | Учетная запись пользователя домена, которая используется для управления службой SQL Server. Эти сведения можно найти в [**диспетчере конфигурации SQL Server**](https://docs.microsoft.com/sql/relational-databases/sql-server-configuration-manager?view=sql-server-2017). |
   | **Sql Service Password** (Пароль службы SQL) | Пароль для учетной записи пользователя домена, которая используется для управления службой SQL Server. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями использования, установите флажок рядом с полем **Я принимаю указанные выше условия** и щелкните **Приобрести**, чтобы завершить развертывание шаблона быстрого запуска. 
1. Чтобы контролировать ход развертывания, выберите это развертывание в списке, который открывается щелчком значка колокольчика (**Уведомления**) на панели навигации вверху, или найдите **группу ресурсов** на портале Azure и выберите элемент **Развертывания** в поле **Параметры**, а затем щелкните развертывание с именем Microsoft.Template. 

## <a name="step-2---manually-create-the-availability-group"></a>Шаг 2. Создание группы доступности вручную 
Создайте группу доступности вручную, как обычно, с помощью [PowerShell](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/create-an-availability-group-sql-server-powershell?view=sql-server-2017), [SQL Server Management Studio](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio?view=sql-server-2017) или [Transact-SQL](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/create-an-availability-group-transact-sql?view=sql-server-2017). 

  >[!IMPORTANT]
  > Но на этот раз **не** создавайте прослушиватель, так как это действие автоматизировано в шаблоне быстрого запуска **101-sql-vm-aglistener-setup**, который вы примените на шаге 4. 

## <a name="step-3---manually-create-the-internal-load-balancer-ilb"></a>Шаг 3. Создание внутреннего ресурса Load Balancer (ILB) вручную
Прослушивателю группы доступности Always On требуется внутренний ресурс Azure Load Balancer (ILB). ILB предоставляет "плавающий" IP-адрес прослушивателю группы доступности, что обеспечивает более быструю отработку отказа и восстановление подключения. Если виртуальные машины SQL Server в группе доступности входят в одну группу доступности, вы можете использовать Load Balancer ценовой категории "Базовый". Если нет, потребуется Load Balancer ценовой категории "Стандартный".  **Подсистема ILB должна находиться в той же виртуальной сети, что и экземпляры виртуальной машины SQL Server.** Вам осталось создать только ILB, а все остальные элементы конфигурации (серверный пул, зонд работоспособности и правила балансировки нагрузки) уже учтены в шаблоне быстрого запуска **101-sql-vm-aglistener-setup**, который вы примените на шаге 4. 

1. На портале Azure откройте группу ресурсов, в которой содержатся виртуальные машины SQL Server. 
2. В колонке группы ресурсов щелкните **Добавить**.
3. Выполните поиск по запросу **подсистема балансировки нагрузки** и в результатах поиска выберите **Подсистема балансировки нагрузки**, опубликованную корпорацией **Майкрософт**.
4. В колонке **Балансировщик нагрузки** щелкните **Создать**.
5. В диалоговом окне **Создание подсистемы балансировки нагрузки** настройте подсистему балансировки нагрузки, задав следующие параметры:

   | Параметр | Значение |
   | --- | --- |
   | **Имя** |Текст, представляющий имя балансировщика нагрузки. Например, **sqlLB**. |
   | **Тип** |**Внутренние**. В большинстве реализаций используется внутренняя подсистема балансировки нагрузки, которая позволяет приложениям в одной и той же виртуальной сети подключаться к группе доступности.  </br> **Внешние**. Позволяет устанавливать общедоступное интернет-подключение к группе доступности. |
   | **Виртуальная сеть** |Выберите виртуальную сеть, в которой расположены экземпляры SQL Server. |
   | **Подсеть** |Выберите подсеть, в которой расположены экземпляры SQL Server. |
   | **Назначение IP-адресов** |**Статическое** |
   | **Частный IP-адрес** |Укажите свободный IP-адрес из нужной подсети. Используйте этот IP-адрес при создании прослушивателя в кластере.|
   | **Подписка** |Это поле может появиться, если у вас несколько подписок. Выберите подписку, которую требуется связать с этим ресурсом. Обычно это подписка, с которой связаны все ресурсы группы доступности. |
   | **Группа ресурсов** |Выберите группу ресурсов, в которой расположены экземпляры SQL Server. |
   | **Местоположение.** |Выберите расположение Azure, в котором расположены экземпляры SQL Server. |
   | &nbsp; | &nbsp; |

6. Нажмите кнопку **Создать**. 


  >[!NOTE]
  > Ресурс общедоступного IP-адреса для каждой виртуальной машины SQL Server должен иметь номер SKU "Стандартный", чтобы обеспечить совместимость с Load Balancer ценовой категории "Стандартный". Чтобы определить номер SKU для ресурса общедоступного IP-адреса виртуальной машины, найдите **группу ресурсов** и выберите ресурс **Общедоступный IP-адрес** для требуемой виртуальной машины SQL Server, а затем найдите для него значение параметра **Номер SKU** на панели **Обзор**. 

## <a name="step-4---create-the-ag-listener-and-configure-the-ilb-with-the-quickstart-template"></a>Шаг 4. Создание прослушивателя группы доступности и настройка ILB с помощью шаблона быстрого запуска

Создайте прослушиватель группы доступности и настройте внутренний ресурс Load Balancer (ILB) с помощью автоматизированного шаблона быстрого запуска **101-sql-vm-aglistener-setup**, который подготавливает ресурс Microsoft.SqlVirtualMachine/Sql Virtual Machine Groups/Availability Group Listener. Шаблон быстрого запуска **101-sql-vm-aglistener-setup** позволяет выполнить следующие действия через поставщик ресурсов виртуальной машины SQL:

 - Настройка параметров сети для кластера и ILB. 
 - Настройка серверного пула ILB, зонда работоспособности и правил балансировки нагрузки.
 - Создание прослушивателя группы доступности с указанными IP-адресом и именем.

Чтобы настроить ILB и прослушиватель группы доступности, выполните описанные ниже действия.
1. На портале Azure перейдите к шаблону быстрого запуска [**101-sql-vm-aglistener-setup**](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) и выберите действие **Развертывание в Azure**, чтобы запустить этот шаблон быстрого запуска.
1. Заполните обязательные поля для настройки ILB и создайте прослушиватель группы доступности. Необязательные поля можно оставить пустыми. 

    В приведенной ниже таблице представлены необходимые значения для этого шаблона. 

   | **Поле** | Значение |
   | --- | --- |
   |**Группа ресурсов** | Группа ресурсов, в которой размещены виртуальные машины SQL Server и группа доступности. | 
   |**Existing Failover Cluster Name** (Имя существующего отказоустойчивого кластера) | Имя кластера, к которому присоединены виртуальные машины SQL Server. |
   | **Existing Sql Availability Group** (Существующая группа доступности SQL)| Имя группы доступности, в которую входят виртуальные машины SQL Server. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Имена виртуальных машин SQL Server, которые входят в указанную выше группу доступности. Имена следует разделять запятой с пробелом (например, так: SQLVM1, SQLVM2). |
   | **Existing Fully Qualified Domain Name** (Существующее полное доменное имя) | Полное доменное имя существующего домена, в котором находятся виртуальные машины SQL Server. |
   | **Прослушиватель** | DNS-имя, которое нужно назначить прослушивателю. По умолчанию в шаблоне указано имя "aglistener", но его можно изменить. |
   | **Listener Port** (Порт прослушивателя) | Порт, который будет использовать прослушиватель. Обычно это стандартный порт 1433, поэтому именно этот номер порта указан в шаблоне. Но если вы изменили порт по умолчанию, то и порт прослушивателя следует изменить аналогичным образом. | 
   | **Existing Vnet** (Существующая виртуальная сеть) | Имя виртуальной сети, в которой находятся виртуальные машины SQL Server и ILB. |
   | **Existing Subnet** (Существующая подсеть) | *Имя* внутренней подсети, в которой размещена виртуальная машина SQL Server (например, default). Чтобы выяснить это значение, перейдите к элементу **группы ресурсов**, выберите используемую **виртуальную сеть** и **подсеть** на панели **Параметры**, а затем скопируйте значение параметра **Имя**. |
   | **Existing Internal Load Balancer** (Существующий внутренний ресурс Load Balancer) | Имя ресурса ILB, который вы создали на шаге 3. |
   | **Порт пробы** | Порт зонда, который будет использовать ILB. В этом шаблоне указано стандартное значение 59999, но его можно изменить. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями использования, установите флажок рядом с полем **Я принимаю указанные выше условия** и щелкните **Приобрести**, чтобы завершить развертывание шаблона быстрого запуска. 
1. Чтобы контролировать ход развертывания, выберите это развертывание в списке, который открывается щелчком значка колокольчика (**Уведомления**) на панели навигации вверху, или найдите **группу ресурсов** на портале Azure и выберите элемент **Развертывания** в поле **Параметры**, а затем щелкните развертывание с именем Microsoft.Template. 

  >[!NOTE]
  >Если развертывание завершается сбоем в середине процесса, следует вручную [удалить только что созданный прослушиватель](#remove-availability-group-listener) с помощью PowerShell, а затем попытаться повторно развернуть шаблон быстрого запуска **101-sql-vm-aglistener-setup**. 

## <a name="remove-availability-group-listener"></a>Удаление прослушивателя группы доступности
Если вам потребуется удалить прослушиватель группы доступности, настроенный с помощью шаблона, это нужно делать через поставщик ресурсов виртуальной машины SQL. Так как прослушиватель зарегистрирован в поставщике ресурсов виртуальной машины SQL, недостаточно просто удалить его с помощью SQL Server Management Studio. Его нужно удалить еще и в поставщике ресурсов виртуальной машины SQL с помощью команд PowerShell. Таким образом из поставщика ресурсов виртуальной машины SQL удаляются метаданные прослушивателя группы доступности и из группы доступности физически удаляется прослушиватель. 

Следующий фрагмент кода позволяет удалить прослушиватель группы доступности SQL из поставщика ресурсов SQL и из группы доступности: 

```PowerShell
# Remove the AG listener
# example: Remove-AzureRmResource -ResourceId '/subscriptions/a1a11a11-1a1a-aa11-aa11-1aa1a11aa11a/resourceGroups/SQLAG-RG/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/Cluster/availabilitygrouplisteners/aglistener' -Force
Remove-AzureRmResource -ResourceId '/subscriptions/<SubscriptionID>/resourceGroups/<resource-group-name>/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/<cluster-name>/availabilitygrouplisteners/<listener-name>' -Force
```
 
## <a name="known-issues-and-errors"></a>Известные проблемы и ошибки
В этом разделе описаны некоторые известные проблемы и возможные способы их устранения. 

### <a name="availability-group-listener-for-availability-group-ag-name-already-exists"></a>Прослушиватель группы доступности для группы доступности "\<имя_группы_доступности>" уже существует
Группа доступности, которая выбрана для прослушивателя группы доступности в шаблоне быстрого запуска, уже содержит прослушиватель. Это может быть физический прослушиватель в группе доступности или метаданные, зарегистрированные в поставщике ресурсов виртуальной машины SQL.  Удалите прослушиватель с помощью [PowerShell](#remove-availability-group-listener), а затем заново разверните шаблон быстрого запуска **101-sql-vm-aglistener-setup**. 

### <a name="connection-only-works-from-primary-replica"></a>Подключение работает только из первичной реплики
Такое поведение чаще всего связано с неудачным развертыванием шаблона **101-sql-vm-aglistener-setup**, которое привело к несогласованности конфигурации ILB. Убедитесь, что в серверном пуле отображается группа доступности, и что есть правила для зонда работоспособности и для балансировки нагрузки. Если что-либо из этого отсутствует, значит, конфигурация ILB находится в несогласованном состоянии. 

Чтобы решить эту проблему, удалите прослушиватель с помощью [PowerShell](#remove-availability-group-listener), затем удалите внутренний ресурс Load Balancer на портале Azure и повторите процесс, начиная с [шага 3](#step-3---manually-create-the-internal-load-balanced-ilb). 

### <a name="badrequest---only-sql-virtual-machine-list-can-be-updated"></a>Неправильный запрос — можно обновить только список виртуальных машин SQL
Такая ошибка может возникать при развертывании шаблона **101-sql-vm-aglistener-setup**, если прослушиватель был удален с помощью SQL Server Management Studio (SSMS), но не был удален из поставщика ресурсов виртуальной машины SQL. При удалении прослушивателя через SSMS метаданные прослушивателя не удаляются из поставщика ресурсов виртуальной машины SQL. Для их удаления следует использовать [PowerShell](#remove-availability-group-listener). 


## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения см. в следующих статьях: 

* [Общие сведения о виртуальной машине SQL Server](virtual-machines-windows-sql-server-iaas-overview.md)
* [Часто задаваемые вопросы о виртуальных машинах SQL Server](virtual-machines-windows-sql-server-iaas-faq.md)
* [Руководство по выбору ценовой категории для виртуальных машин SQL Server](virtual-machines-windows-sql-server-pricing-guidance.md)
* [Виртуальная машина SQL Server: заметки о выпуске](virtual-machines-windows-sql-server-iaas-release-notes.md)
* [Изменение модели лицензирования для виртуальной машины SQL Server](virtual-machines-windows-sql-ahb.md)



