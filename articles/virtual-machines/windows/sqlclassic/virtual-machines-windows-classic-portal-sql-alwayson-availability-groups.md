---
title: "Настройка группы доступности AlwaysOn на виртуальных машинах Azure (классическая модель) | Документы Майкрософт"
description: "Создание группы доступности AlwaysOn на виртуальных машинах Azure. В этом учебнике в основном используется пользовательский интерфейс и инструменты, а не сценарии."
services: virtual-machines-windows
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: 8d48a3d2-79f8-4ab0-9327-2f30ee0b2ff1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/17/2017
ms.author: mikeray
ms.openlocfilehash: b360fe9f28eeb9b10c82fce729165b1b572ac3c6
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="configure-always-on-availability-group-in-azure-virtual-machines-classic"></a>Настройка группы доступности AlwaysOn на виртуальных машинах Azure (классическая модель)
> [!div class="op_single_selector"]
> * [Классическая модель: пользовательский интерфейс](../classic/portal-sql-alwayson-availability-groups.md)
> * [Классическая модель: PowerShell](../classic/ps-sql-alwayson-availability-groups.md)
<br/>

Прежде чем начать, учтите, что теперь можно выполнить эту задачу в модели Azure Resource Manager. Для новых развертываний мы советуем использовать модель Azure Resource Manager. См. раздел [Введение в группы доступности AlwaysOn SQL Server на виртуальных машинах Azure](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md).

> [!IMPORTANT] 
> Для большинства новых развертываний Майкрософт рекомендует использовать модель диспетчера ресурсов. В Azure предлагаются две модели развертывания для создания ресурсов и работы с ними: [модель Resource Manager и классическая модель](../../../azure-resource-manager/resource-manager-deployment-model.md). В этой статье рассматривается использование классической модели развертывания. 

Чтобы выполнить эту задачу с использованием модели Azure Resource Manager, см. статью [Введение в группы доступности AlwaysOn SQL Server на виртуальных машинах Azure](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md).

В этом комплексном руководстве показано, как реализовывать группы доступности с помощью AlwaysOn SQL Server на виртуальных машинах Azure.

Когда вы завершите, решение SQL Server Always On в Azure будет состоять из следующих элементов:

* виртуальной сети, которая содержит несколько подсетей, в том числе внешнюю и внутреннюю подсети;
* контроллера домена с доменом Active Directory (Azure AD);
* двух виртуальных машин SQL Server, развернутых во внутреннюю подсеть и присоединенных к домену Azure AD;
* отказоустойчивого кластера из трех узлов с моделью кворума "Большинство узлов";
* группы доступности с двумя репликами базы данных доступности с синхронной фиксацией.

На рисунке ниже показано графическое представление решения.

![Архитектура лаборатории тестирования для групп доступности в Azure](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC791912.png)

Обратите внимание, что это одна из возможных конфигураций. Например, можно сократить число виртуальных машин для группы доступности с двумя репликами. Это позволит сократить часы вычислений в Azure, используя контроллер домена как файловый ресурс-свидетель кворума в кластере из двух узлов. Такой метод сокращает число виртуальных машин на одну по сравнению с показанной выше конфигурацией.

В этом учебнике предполагается следующее:

* У вас уже есть учетная запись Azure.
* Вы уже умеете подготавливать классическую виртуальную машину SQL Server с помощью графического интерфейса пользователя в коллекции виртуальных машин.
* Вы хорошо понимаете принцип работы групп доступности AlwaysOn. Дополнительные сведения см. в разделе [Группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx).

> [!NOTE]
> Если вы планируете использовать группы доступности AlwaysOn с SharePoint, ознакомьтесь также со статьей [Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://technet.microsoft.com/library/jj715261.aspx).
> 
> 

## <a name="create-the-virtual-network-and-domain-controller-server"></a>Создание виртуальной сети и сервера контроллера домена
Сначала создайте новую пробную учетную запись Azure. После настройки учетной записи вы увидите начальный экран классического портала Azure.

1. Нажмите кнопку **Создать** в левом нижнем углу страницы, как показано на снимке экрана ниже.
   
    ![Нажмите кнопку «Создать» на портале.](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665511.gif)
2. Выберите пункты **Сетевые службы** > **Виртуальная сеть** > **Настраиваемое создание**, как показано ниже.
   
    ![Создание виртуальной сети](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665512.gif)
3. В диалоговом окне **Создать виртуальную сеть** создайте виртуальную сеть, поэтапно настроив параметры, описанные в таблице ниже, на всех страницах. 
   
   | Страница | данных |
   | --- | --- |
   | Информация о виртуальной сети |**Имя — ContosoNET**<br/>**REGION = West US** |
   | DNS-серверы и подключение VPN |None |
   | Адресные пространства виртуальной сети |Параметры показаны на следующем снимке экрана: ![Создание виртуальной сети](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784620.png) |
4. Создайте виртуальную машину, чтобы использовать ее в качестве контроллера домена. Последовательно нажмите **Создать** > **Среда выполнения приложений** > **Виртуальная машина** > **Из коллекции**, как показано на снимке экрана ниже.
   
    ![Создание виртуальной машины](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784621.png)
5. В диалоговом окне **Создание виртуальной машины** настройте новую виртуальную машину, поэтапно настроив параметры, описанные в таблице ниже, на всех страницах. 
   
   | Страница | данных |
   | --- | --- |
   | Выбор операционной системы виртуальной машины |Центр обработки данных Windows Server 2012 R2 |
   | Конфигурация виртуальной машины |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoDC<br/>**Уровень** — Стандартный<br/>**Размер** — A2 (2 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |
   | Конфигурация виртуальной машины |**Облачная служба** — создайте облачную службу<br/>**DNS-имя облачной службы** — уникальное имя облачной службы<br/>**DNS-имя** — уникальное имя (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = (нет) |
   | Параметры виртуальной машины |По умолчанию |

После настройки новой виртуальной машины подождите, пока она будет подготовлена. Этот процесс занимает некоторое время. Если перейти на вкладку **Виртуальная машина** классического портала Azure, вы увидите, как состояния машины ContosoDC меняются в такой последовательности: **Запуск (идет подготовка)**, **Остановлено**, **Запуск**, **Работает (идет подготовка)** и, наконец, **Работает**.

Сервер контроллера домена успешно подготовлен. Далее нужно настроить домен Active Directory на этом сервере контроллера домена.

## <a name="configure-the-domain-controller"></a>Настройка контроллера домена
На следующих этапах вы настроите машину ContosoDC в качестве контроллера домена для corp.contoso.com.

1. На портале выберите машину **ContosoDC** . На вкладке **Панель мониторинга** нажмите кнопку **Подключиться**, чтобы открыть RDP-файл для удаленного доступа к рабочему столу.
   
    ![Подключение к виртуальной машине](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784622.png)
2. Войдите в систему с использованием настроенной учетной записи администратора (**\AzureAdmin**) и пароля (**Contoso!000**).
3. По умолчанию отображается панель мониторинга **Диспетчер серверов** .
4. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.
   
    ![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784623.png)
5. Нажимайте кнопку **Далее**, пока не откроется раздел **Роли сервера**.
6. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
   
   > [!NOTE]
   > Вы получите предупреждение проверки об отсутствии статического IP-адреса. Если вы тестируете конфигурацию, нажмите кнопку **Продолжить**. Для рабочих сценариев [используйте PowerShell для установки статического IP-адреса машины контроллера домена](../../../virtual-network/virtual-networks-reserved-private-ip.md).
   > 
   > 
   
    ![Диалоговое окно добавления ролей](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784624.png)
7. Нажимайте **Далее**, пока не откроется раздел **Подтверждение**. Установите флажок **Автоматически перезапускать конечный сервер, если это потребуется**.
8. Щелкните **Install**(Установить).
9. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов**.
10. Выберите новый пункт **AD DS** в левой области.
11. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.
    
     ![Диалоговое окно "AD DS" на виртуальной машине DNS-сервера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784625.png)
12. В столбце **Действие** диалогового окна **Сведения о всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.
13. В **мастере настройки доменных служб Active Directory**используйте следующие значения:
    
    | Страница | Настройка |
    | --- | --- |
    | Конфигурация развертывания |**Добавить новый лес** = выбрано<br/>**Имя корневого домена** = corp.contoso.com |
    | Параметры контроллера домена |**Пароль** = Contoso!000<br/>**Подтверждение пароля** = Contoso!000 |
14. Нажимайте кнопку **Далее** , чтобы пройти остальные страницы мастера. Убедитесь, что на странице **Проверка готовности** отображается следующее сообщение: **Все проверки готовности успешно завершены**. Обратите внимание, что вам следует просмотреть все применимые предупреждения, но это не обязательно для продолжения установки.
15. Щелкните **Install**(Установить). Виртуальная машина **ContosoDC** автоматически перезагрузится.

## <a name="configure-domain-accounts"></a>Настройка учетных записей в домене
На следующих этапах настраиваются учетные записи Active Directory для дальнейшего использования.

1. Снова войдите в компьютер **ContosoDC**.
2. На панели **Диспетчер серверов** выберите **Сервис** > **Центр администрирования Active Directory**.
   
    ![Центр администрирования Active Directory](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784626.png)
3. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели.
4. В правой области **Задачи** выберите **Создать** > **Пользователь**. Используйте следующие параметры:
   
   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Install |
   | **User SamAccountName** |Install |
   | **Пароль** |Contoso!000 |
   | **Подтверждение пароля.** |Contoso!000 |
   | **Другие параметры пароля** |Выбрано |
   | **Срок действия пароля не ограничен** |Флажок установлен |
5. Нажмите кнопку **ОК**, чтобы создать пользователя **Install**. Эта учетная запись используется для настройки отказоустойчивого кластера и группы доступности.
6. Создайте двух дополнительных пользователей **CORP\SQLSvc1** и **CORP\SQLSvc2** тем же способом. Эти учетные записи будут использоваться для экземпляров SQL Server. Затем вам потребуется предоставить пользователю **CORP\Install** необходимые разрешения для настройки отказоустойчивой кластеризации Windows.
7. В **центре администрирования Active Directory** выберите **corp (локальный)** в левой области. В области **Задачи** выберите пункт **Свойства**.
   
    ![Свойства пользователя CORP](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784627.png)
8. Выберите **Расширения**, затем нажмите кнопку **Дополнительно** на вкладке **Безопасность**.
9. В диалоговом окне **Дополнительные параметры безопасности для corp** нажмите кнопку **Добавить**.
10. Щелкните **Выберите субъект**, найдите **CORP\Install** и нажмите кнопку **ОК**.
11. Выберите разрешения **Чтение всех свойств** и **Создание объектов-компьютеров**.
    
     ![Разрешения пользователя Corp](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784628.png)
12. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Закройте окно свойств предприятия.

После настройки Active Directory и объектов пользователей вам необходимо создать три виртуальные машины SQL Server и присоединить их к этому домену.

## <a name="create-the-sql-server-virtual-machines"></a>Создание виртуальных машин SQL Server
Создайте три виртуальные машины. Одна из них предназначена для узла кластера, а другие две — для SQL Server. Для создания каждой виртуальной машины вернитесь на классический портал Azure и выберите **Создать** > **Среда выполнения приложений** > **Виртуальная машина** > **Из коллекции**. Затем используйте шаблоны из приведенной ниже таблицы, чтобы упростить создание виртуальных машин.

| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выбор операционной системы виртуальной машины |**Центр обработки данных Windows Server 2012 R2** |**SQL Server 2014 RTM Enterprise** |**SQL Server 2014 RTM Enterprise** |
| Конфигурация виртуальной машины |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoWSFCNode<br/>**Уровень** — Стандартный<br/>**Размер** — A2 (2 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoSQL1<br/>**Уровень** — Стандартный<br/>**Размер** — A3 (4 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoSQL2<br/>**Уровень** — Стандартный<br/>**Размер** — A3 (4 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |
| Конфигурация виртуальной машины |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** — создайте группу доступности<br/>**ИМЯ ГРУППЫ ДОСТУПНОСТИ** = SQLHADR |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** — SQLHADR (группу доступности можно также настроить после создания виртуальной машины) Все три машины следует определить в группу доступности SQLHADR). |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** — SQLHADR (группу доступности можно также настроить после создания виртуальной машины) Все три машины следует определить в группу доступности SQLHADR). |
| Параметры виртуальной машины |По умолчанию |По умолчанию |По умолчанию |

<br/>

> [!NOTE]
> Предыдущая конфигурация предлагает виртуальные машины уровня СТАНДАРТНЫЙ, так как компьютеры уровня БАЗОВЫЙ не поддерживают конечные точки с балансировкой нагрузки. Конечные точки с балансировкой нагрузки потребуются позднее для создания прослушивателя группы доступности. Кроме того, предлагаемые здесь размеры машин предназначены для тестирования групп доступности в виртуальных машинах Azure. Для обеспечения оптимальной производительности рабочих нагрузок см. рекомендации по размерам машин SQL Server и их настройке в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](../sql/virtual-machines-windows-sql-performance.md).
> 
> 

После завершения подготовки трех виртуальных машин вам потребуется присоединить их к домену **corp.contoso.com** и предоставить пользователю CORP\Install права администратора виртуальных машин. Для этого выполните указанные ниже действия для каждой из трех виртуальных машин.

1. Во-первых, измените предпочитаемый адрес DNS-сервера. Скачайте файл RDP для каждой виртуальной машины в локальный каталог, выбрав нужную виртуальную машину из списка и нажав кнопку **Подключиться**. Чтобы выбрать виртуальную машину, щелкните в любом месте, кроме первой ячейки в строке, как показано на снимке экрана ниже.
   
    ![Скачивание RDP-файла](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664953.jpg)
2. Откройте скачанный RDP-файл и войдите в виртуальную машину с использованием настроенной учетной записи администратора (**BUILTIN\AzureAdmin**) и пароля (**Contoso!000**).
3. После входа вы должны увидеть панель мониторинга **Диспетчер серверов**. Щелкните **Локальный сервер** на левой панели.
4. Щелкните ссылку **IPv4-адрес назначен DHCP, поддержка IPv6**.
5. В диалоговом окне **Сетевые подключения** щелкните значок сети.
   
    ![Изменение предпочтительного DNS-сервера виртуальной машины](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784629.png)
6. На панели команд щелкните **Change the settings of this connection** (Изменить параметры этого подключения). (В зависимости от размера окна вам может потребоваться щелкнуть двойную стрелку вправо, чтобы увидеть эту команду.)
7. Выберите пункт **Протокол Интернета версии 4 (TCP/IPv4)** и нажмите кнопку **Свойства**.
8. Выберите **Использовать следующие адреса DNS-серверов** и укажите адрес **10.10.2.4** в поле **Основной DNS-сервер**.
9. **10.10.2.4** — это адрес, назначенный виртуальной машине в подсети 10.10.2.0/24 в виртуальной сети Azure. Речь идет о виртуальной машине **ContosoDC**. Для проверки IP-адреса **ContosoDC** в окне командной строки выполните команду **nslookup contosodc**, как показано на снимке экрана ниже.
   
    ![Поиск IP-адреса для контроллера домена с помощью NSLOОКUP](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664954.jpg)
10. Нажмите **ОК** > **Закрыть**, чтобы сохранить изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.
11. В окне **Локальный сервер** щелкните ссылку **РАБОЧАЯ ГРУППА**.
12. В разделе **Имя компьютера** нажмите кнопку **Изменить**.
13. Установите флажок **Домен**, введите в текстовом поле **corp.contoso.com** и нажмите кнопку **ОК**.
14. В диалоговом окне **Безопасность Windows** укажите имя (**CORP\AzureAdmin**) и пароль (**Contoso!000**) учетной записи администратора домена по умолчанию.
15. При появлении сообщения "Добро пожаловать на домен corp.contoso.com" нажмите кнопку **ОК**.
16. В диалоговом окне нажмите **Закрыть** > **Перезагрузить сейчас**.

### <a name="add-the-corpinstall-user-as-an-administrator-on-each-virtual-machine"></a>Добавление пользователя Corp\Install в качестве администратора на каждой виртуальной машине
1. Подождите, пока виртуальная машина перезапустится, а затем снова откройте RDP-файл, чтобы войти в виртуальную машину с учетной записью **BUILTIN\AzureAdmin**.
2. В области **Диспетчер серверов** выберите **Сервис** > **Управление компьютером**.
   
    ![Управление компьютерами](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784630.png)
3. В диалоговом окне **Управление компьютером** разверните узел **Локальные пользователи и группы**, а затем выберите элемент **Группы**.
4. Дважды щелкните группу **Администраторы** .
5. В диалоговом окне **Свойства администратора** нажмите кнопку **Добавить**.
6. Введите имя пользователя **CORP\Install**, а затем нажмите кнопку **ОК**. При появлении запроса учетных данных используйте учетную запись **AzureAdmin** с паролем **Contoso!000**.
7. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Свойства администратора**.

### <a name="add-the-failover-clustering-feature-to-each-virtual-machine"></a>Добавление компонента отказоустойчивой кластеризации для каждой виртуальной машины
1. На панели мониторинга **Диспетчер серверов** нажмите **Добавить роли и компоненты**.
2. В **мастере добавления ролей и компонентов** нажимайте кнопку **Далее**, пока не откроется страница **Компоненты**.
3. Выберите **Отказоустойчивость кластеров**. При появлении запроса добавьте остальные зависимые компоненты.
   
    ![Добавление компонента отказоустойчивой кластеризации для виртуальной машины](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784631.png)
4. Нажмите кнопку **Далее**, а затем **Установить** на странице **Подтверждение**.
5. После завершения установки компонента **Отказоустойчивая кластеризация** нажмите кнопку **Закрыть**.
6. Выйдите из виртуальной машины.
7. Повторите действия в этом разделе для всех трех серверов: **ContosoWSFCNode**, **ContosoSQL1** и **ContosoSQL2**.

Виртуальные машины SQL Server подготовлены и запущены, но они имеют параметры по умолчанию для SQL Server.

## <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера
В этом разделе вы создадите отказоустойчивый кластер, на котором будет размещена группа доступности, созданная в дальнейшем. К этому моменту для каждой из трех виртуальных машин, которые будут использоваться в отказоустойчивом кластере, должны были быть выполнены следующие действия:

* полная подготовка виртуальной машины в Azure;
* присоединение виртуальной машины к домену;
* добавление пользователя **CORP\Install** в локальную группу администраторов;
* добавление компонента "Отказоустойчивая кластеризация".

Все эти действия необходимо выполнить на каждой виртуальной машине перед тем, как присоединять ее к отказоустойчивому кластеру.

Кроме того, обратите внимание, что виртуальная сеть Azure функционирует иначе, чем локальная сеть. Создавать кластер необходимо в следующем порядке:

1. Создайте кластер с одним узлом на одном из узлов (**ContosoSQL1**).
2. Измените IP-адрес кластера на неиспользуемый адрес (**10.10.2.101**).
3. Подключите имя кластера к сети.
4. Добавьте другие узлы (**ContosoSQL2** и **ContosoWSFCNode**).

Чтобы полностью настроить кластер, выполните указанные ниже действия.

1. Откройте RDP-файл для **ContosoSQL1** и войдите с использованием учетной записи домена **CORP\Install**.
2. На панели мониторинга **Диспетчер серверов** выберите **Сервис** > **Диспетчер отказоустойчивости кластеров**.
3. В левой области щелкните правой кнопкой мыши элемент **Диспетчер отказоустойчивости кластеров** и выберите команду **Создать кластер**, как показано на снимке экрана ниже.
   
    ![Создание кластера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784632.png)
4. В мастере создания кластеров создайте кластер с одним узлом, поэтапно настроив параметры на всех страницах, как указано в таблице ниже.
   
   | Страница | Параметры |
   | --- | --- |
   | Перед началом работы |По умолчанию |
   | Выбор серверов |Введите **ContosoSQL1** в поле **Введите имя сервера** и щелкните **Добавить**. |
   | Предупреждение проверки |Выберите вариант **Нет. Для этого кластера не требуется поддержка корпорации Майкрософт, поэтому нет необходимости выполнять проверочные тесты. После нажатия кнопки "Далее" продолжить создание кластера**. |
   | Точка доступа для администрирования кластера |Введите **Cluster1** в поле **Имя кластера** |
   | Подтверждение |Используйте параметры по умолчанию, если вы не используете дисковые пространства. Ознакомьтесь с предупреждением после этой таблицы. |
   
   > [!WARNING]
   > Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, на странице **Подтверждение** снимите флажок **Добавление всех допустимых хранилищ в кластер**. Если вы не сделаете этого, виртуальные диски будут отсоединены в процессе кластеризации. Как следствие, они не отобразятся в диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.
   > 
   > 
5. В левой области разверните элемент **Диспетчер отказоустойчивости кластеров** и щелкните **Cluster1.corp.contoso.com**.
6. В центральной области найдите раздел **Ресурсы ядра кластера** и разверните элемент со сведениями **Имя: Cluster1**. Вы увидите ресурсы **Имя** и **IP-адрес** с состоянием **Ошибка**. Ресурс IP-адреса невозможно подключить к сети, так как кластеру назначен тот же IP-адрес, что и самой виртуальной машине, то есть повторяющийся.
7. Щелкните правой кнопкой мыши ресурс **IP-адреса** в состоянии сбоя и выберите **Свойства**.
   
    ![Свойства кластера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784633.png)
8. Выберите **Статический IP-адрес**, в текстовом поле **Адрес** укажите значение **10.10.2.101**, а затем нажмите кнопку **ОК**.
9. В разделе **Ресурсы ядра кластера** щелкните правой кнопкой мыши элемент **Имя: Cluster1** и нажмите кнопку **Подключить**. Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера подключится, на сервер контроллера домена добавится новая учетная запись компьютера Active Directory. Эта учетная запись впоследствии будет использоваться для запуска кластерной службы группы доступности.
10. Добавьте оставшиеся узлы в кластер. В дереве обозревателя щелкните правой кнопкой мыши элемент **Cluster1.corp.contoso.com**, а затем выберите пункт **Добавить узел**, как показано на снимке экрана ниже.
    
     ![Добавление узла в кластер](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784634.png)
11. В **мастере добавления узлов** на странице **Выбор серверов** нажмите кнопку **Далее**, добавьте **ContosoSQL2** и **ContosoWSFCNode** в список, введя имя сервера в поле **Введите имя сервера** и нажав кнопку **Добавить**. Когда будете готовы, нажмите кнопку **Далее**.
12. На странице **Предупреждение проверки** нажмите кнопку **Нет**, хотя в рабочем сценарии следует выполнить проверочные тесты. Затем щелкните **Далее**.
13. На странице **Подтверждение** нажмите кнопку **Далее**, чтобы добавить узлы.
    
    > [!WARNING]
    > Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, снимите флажок **Добавление всех допустимых хранилищ в кластер**. Если вы не сделаете этого, виртуальные диски будут отсоединены в процессе кластеризации. Как следствие, они не отобразятся к диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.
    > 
    > 
14. После добавления узлов в кластер нажмите кнопку **Готово**. Теперь диспетчер отказоустойчивости кластеров должен показывать три узла в кластере и отображать их в контейнере **Узлы** .
15. Завершите сеанс удаленного рабочего стола.

## <a name="prepare-the-sql-server-instances-for-availability-groups"></a>Подготовка экземпляров SQL Server для групп доступности
В этом разделе вы сделаете следующее на узлах **ContosoSQL1** и **ContosoSQL2**:

* Добавите имя для входа для **NT AUTHORITY\System** с необходимым набором разрешений для экземпляра SQL Server по умолчанию.
* Добавите **CORP\Install** в качестве роли системного администратора экземпляра SQL Server по умолчанию.
* Откройте брандмауэр для удаленного доступа к SQL Server.
* Включите компонент групп доступности AlwaysOn.
* Измените учетную запись службы SQL Server на **CORP\SQLSvc1** и **CORP\SQLSvc2** соответственно.

Эти действия можно выполнять в любом порядке. Однако в следующем пошаговом руководстве они приведены в указанном порядке. Сделайте следующее для **ContosoSQL1** и **ContosoSQL2**:

1. Если вы еще не вышли из сеанса удаленного рабочего стола для виртуальной машины, сделайте это.
2. Откройте RDP-файлы для **ContosoSQL1** и **ContosoSQL2** и войдите с использованием учетной записи **BUILTIN\AzureAdmin**.
3. Добавьте **NT AUTHORITY\System** в список имен для входа SQL Server с необходимыми разрешениями. Откройте **SQL Server Management Studio**.
4. Нажмите кнопку **Подключение** , чтобы подключиться к экземпляру SQL Server по умолчанию.
5. В **обозревателе объектов** разверните элемент **Безопасность**, а затем элемент **Имена входа**.
6. Щелкните правой кнопкой мыши имя для входа **NT AUTHORITY\System**, а затем выберите пункт **Свойства**.
7. На странице **Защищаемые объекты** для локального сервера выберите **Предоставить** для указанных ниже разрешений и нажмите кнопку **ОК**.
   
   * Изменение любой группы доступности
   * Соединение SQL
   * Просмотр состояния сервера
8. Добавьте **CORP\Install** в качестве роли **системного администратора** экземпляра SQL Server по умолчанию. В **обозревателе объектов** щелкните правой кнопкой мыши узел **Имена для входа**, а затем выберите пункт **Создать имя входа**.
9. Введите **CORP\Install** в поле **Имя для входа**.
10. На странице **Роли сервера** выберите **sysadmin**, а затем нажмите кнопку **ОК**. После создания имени для входа вы можете увидеть его, развернув узел **Имена для входа** в **обозревателе объектов**.
11. Чтобы создать правило брандмауэра для SQL Server, на **начальном** экране запустите **Брандмауэр Windows в режиме повышенной безопасности**.
12. В левой панели выберите **Правила для входящих подключений**. В правой области нажмите кнопку **Новое правило**.
13. На странице **Тип правила** выберите **Программа** > **Далее**.
14. На странице **Программа** выберите **Путь к этой программе**, введите в текстовом поле **%ProgramFiles%\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\Binn\sqlservr.exe**, а затем нажмите кнопку **Далее**. Если вы следуете этим указаниям, но используете SQL Server 2012, каталог SQL Server — **MSSQL11.MSSQLSERVER**.
15. На странице **Действие** оставьте установленным флажок **Разрешить подключение** и нажмите кнопку **Далее**.
16. На странице **Профиль** примите параметры по умолчанию и нажмите кнопку **Далее**.
17. На странице **Имя** укажите имя правила, например **SQL Server (правило программы)**, в текстовом поле **Имя** и нажмите кнопку **Готово**.
18. Чтобы включить функцию **Группы доступности AlwaysOn**, на **начальном** экране запустите **диспетчер конфигурации SQL Server**.
19. В дереве обозревателя выберите **Службы SQL Server**, щелкните правой кнопкой мыши службу **SQL Server (MSSQLSERVER)** и выберите пункт **Свойства**.
20. Выберите вкладку **Высокий уровень доступности Always On**, затем параметр **Включить группы доступности AlwaysOn**, как показано на снимке экрана ниже, и нажмите кнопку **Применить**. Нажмите кнопку **ОК** в диалоговом окне и не закрывайте диалоговое окно **Свойства**. После изменения учетной записи службы вам потребуется перезапустить службу SQL Server.
    
     ![Включение групп доступности AlwaysOn](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665520.gif)
21. Чтобы изменить учетную запись службы SQL Server, откройте вкладку **Вход**, введите **CORP\SQLSvc1** (для **ContosoSQL1**) или **CORP\SQLSvc2** (для **ContosoSQL2**) в поле **Имя учетной записи**, введите и подтвердите пароль, а затем нажмите кнопку **ОК**.
22. В открывшемся диалоговом окне нажмите кнопку **Да**, чтобы перезапустить службу SQL Server. После перезапуска службы SQL Server изменения, внесенные вами в диалоговом окне **Свойства**, вступят в силу.
23. Выйдите из виртуальных машин.

## <a name="create-the-availability-group"></a>Создание группы доступности
Теперь можно приступить к настройке группы доступности. Ниже приведено краткое описание того, что вам потребуется сделать:

* Создание базы данных (**MyDB1**) на **ContosoSQL1**.
* Создание полной резервной копии и резервной копии журнала транзакций базы данных.
* Восстановление обеих резервных копий на **ContosoSQL2** с параметром **NORECOVERY**.
* Создание группы доступности (**AG1**) с синхронной фиксацией, автоматической отработкой отказа и доступными для чтения вторичными репликами.

### <a name="create-the-mydb1-database-on-contososql1"></a>Создание базы данных MyDB1 на ContosoSQL1
1. Если вы еще не вышли из сеансов удаленных рабочих столов для **ContosoSQL1** и **ContosoSQL2**, сделайте это.
2. Откройте RDP-файл для **ContosoSQL1** и выполните вход с использованием учетной записи **CORP\Install**.
3. В **проводнике** на диске **C:\\** создайте каталог **backup**. Вы будете использовать этот каталог для резервного копирования и восстановления базы данных.
4. Щелкните правой кнопкой мыши новый каталог, наведите указатель мыши на пункт **Общий доступ** и выберите пункт **Конкретные пользователи**, как показано на снимке экрана ниже.
   
    ![Создание папки резервного копирования](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665521.gif)
5. Добавьте пользователя **CORP\SQLSvc1** и предоставьте ему разрешение **Чтение и запись**. Добавьте пользователя **CORP\SQLSvc2** и предоставьте ему разрешение **Чтение**, как показано на снимке экрана ниже, после чего нажмите **Общий доступ**. После завершения процесса предоставления общего доступа к файлам нажмите кнопку **Готово**.
   
    ![Предоставление разрешений для папки резервного копирования](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665522.gif)
6. Чтобы создать базу данных, в меню **Пуск** запустите **SQL Server Management Studio**, а затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.
7. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Создать базу данных**.
8. В поле **Имя базы данных** введите **MyDB1**, а затем нажмите кнопку **ОК**.

### <a name="make-a-full-backup-of-mydb1-and-restore-it-on-contososql2"></a>Создание полной резервной копии MyDB1 и восстановление ее на ContosoSQL2
1. Чтобы создать полную резервную копию базы данных, в **обозревателе объектов** разверните элемент **Базы данных**, щелкните правой кнопкой мыши базу данных **MyDB1**, наведите указатель мыши на пункт **Задачи** и выберите пункт **Резервное копирование**.
2. В разделе **Источник** оставьте параметр **Тип резервного копирования** со значением **Полное**. В разделе **Назначение** нажмите кнопку **Удалить**, чтобы удалить путь к файлу резервной копии по умолчанию.
3. В разделе **Назначение** нажмите кнопку **Добавить**.
4. В текстовом поле **Имя файла** введите **\\ContosoSQL1\backup\MyDB1.bak**, нажмите кнопку **ОК** и еще раз нажмите кнопку **ОК**, чтобы создать резервную копию базы данных. После завершения резервного копирования нажмите кнопку **ОК** еще раз, чтобы закрыть диалоговое окно.
5. Чтобы создать резервную копию журнала транзакций, в **обозревателе объектов** разверните элемент **Базы данных**, щелкните правой кнопкой мыши базу данных **MyDB1**, наведите указатель мыши на пункт **Задачи** и выберите пункт **Резервное копирование**.
6. В поле **Тип резервной копии** выберите вариант **Журнал транзакций**. В поле **Назначение** оставьте указанный ранее путь к файлу и нажмите кнопку **ОК**. После завершения резервного копирования нажмите кнопку **ОК** еще раз.
7. Чтобы восстановить полную резервную копию и резервную копию журнала транзакций на **ContosoSQL2**, откройте RDP-файл для **ContosoSQL2** и войдите с учетной записью **CORP\Install**. Оставьте сеанс удаленного рабочего стола для **ContosoSQL1** открытым.
8. В меню **Пуск** откройте **SQL Server Management Studio**, а затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.
9. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Восстановить базу данных**.
10. В разделе **Источник** выберите **Устройство** и щелкните многоточие **…**. .
11. В разделе **Выберите устройства резервного копирования** нажмите кнопку **Добавить**.
12. В поле **Расположение файла резервной копии** введите **\\ContosoSQL1\backup**, нажмите кнопку **Обновить**, выберите **MyDB1.bak**, нажмите кнопку **ОК** и еще раз нажмите кнопку **ОК**. В области **Восстанавливаемые резервные наборы данных** должны появиться полная резервная копия и резервная копия журнала.
13. Перейдите на страницу **Параметры**, в поле **Состояние восстановления** выберите вариант **ВОССТАНОВЛЕНИЕ С ПАРАМЕТРОМ NORECOVERY** и нажмите кнопку **ОК**, чтобы восстановить базу данных. После завершения восстановления нажмите кнопку **ОК**.

### <a name="create-the-availability-group"></a>Создание группы доступности
1. Вернитесь к сеансу удаленного рабочего стола для **ContosoSQL1**. В **обозревателе объектов** в SQL Server Management Studio щелкните правой кнопкой мыши элемент **Высокий уровень доступности Always On** и выберите пункт **Мастер создания групп доступности**, как показано на снимке экрана ниже.
   
    ![Запуск мастера создания групп доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665523.gif)
2. На странице **Введение** нажмите кнопку **Далее**. На странице **Указание имени группы доступности** введите **AG1** в поле **Имя группы доступности**, а затем нажмите кнопку **Далее** еще раз.
   
    ![Мастер создания групп доступности, страница "Указание имени группы доступности"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665524.gif)
3. На странице **Выбор баз данных** выберите **MyDB1** и нажмите кнопку **Далее**. Эта база данных отвечает требованиям для создания группы доступности, так как вы создали для нее как минимум одну полную резервную копию на соответствующей первичной реплике.
   
    ![Мастер создания групп доступности, страница "Выбор баз данных"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665525.gif)
4. На странице **Указание реплик** нажмите кнопку **Добавить реплику**.
   
    ![Мастер создания групп доступности, страница "Указание реплик"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665526.gif)
5. В диалоговом окне **Подключение к серверу** введите **ContosoSQL2** в поле **Имя сервера** и нажмите кнопку **Подключиться**.
   
    ![Мастер создания групп доступности, диалоговое окно "Подключение к серверу"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665527.gif)
6. На странице **Указание реплик** сервер **ContosoSQL2** должен отобразиться в списке **Доступные реплики**. Настройте реплики, как показано на снимке экрана ниже. После завершения нажмите кнопку **Далее**.
   
    ![Мастер создания групп доступности, заполненная страница "Указание реплик"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665528.gif)
7. На странице **Выбор начальной синхронизации данных** выберите **Только присоединение** и нажмите кнопку **Далее**. Вы уже выполнили синхронизацию данных вручную при создании полной резервной копии и резервной копии журнала транзакций на **ContosoSQL1** и их восстановлении на **ContosoSQL2**. Вы можете не выполнять операции резервного копирования и восстановления для базы данных и вместо этого выбрать **Полная**, чтобы мастер создания групп доступности выполнил синхронизацию данных автоматически. Однако мы не рекомендуем такой вариант для очень крупных баз данных, которые иногда используются на предприятиях.
   
    ![Мастер создания групп доступности, страница "Выбор начальной синхронизации данных"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665529.gif)
8. На странице **Проверка** нажмите кнопку **Далее**. Эта страница должна выглядеть, как на снимке экрана ниже. Появится предупреждение о конфигурации прослушивателя группы доступности, так как он еще не настроен. Вы можете пропустить это предупреждение, поскольку процедура настройки прослушивателя не описана в этом учебнике. Чтобы после завершения работы с этим руководством настроить прослушиватель, ознакомьтесь со статьей [Настройка прослушивателя внутренней подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure](../classic/ps-sql-int-listener.md).
   
    ![Мастер создания групп доступности, страница "Проверка"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665530.gif)
9. На странице **Сводка** нажмите кнопку **Готово**, а затем подождите, пока мастер настроит новую группу доступности. На странице **Ход выполнения** вы можете нажать кнопку **Дополнительные сведения**, чтобы просмотреть подробности хода выполнения. Завершив работу с мастером, проверьте содержимое страницы **Результаты**, чтобы убедиться в том, что группа доступности успешно создана, как показано на снимке экрана ниже, и нажмите кнопку **Закрыть**, чтобы выйти из мастера.
   
    ![Мастер создания групп доступности, страница "Результаты"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665531.gif)
10. В **обозревателе объектов** разверните узел **Высокий уровень доступности AlwaysOn**, а затем узел **Группы доступности**. Теперь в этом контейнере должна появиться новая группа доступности. Щелкните правой кнопкой мыши элемент **AG1 (основная)** и выберите пункт **Отобразить панель мониторинга**.
    
     ![Отображение панели мониторинга группы доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665532.gif)
11. **Панель мониторинга AlwaysOn** должна выглядеть, как показано на снимке экрана ниже. Вы увидите реплики, режим отработки отказа для каждой из них и состояние синхронизации.
    
     ![Панель мониторинга группы доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665533.gif)
12. Вернитесь в область **Диспетчер серверов**, выберите **Сервис** и откройте **Диспетчер отказоустойчивости кластеров**.
13. Разверните элемент **Cluster1.corp.contoso.com**, а затем разверните элемент **Службы и приложения**. Выберите **Роли** и обратите внимание, что роль группы доступности **AG1** создана. Обратите внимание на то, что у группы AG1 нет IP-адреса, по которому клиенты базы данных могут подключиться к группе доступности, так как вы не настроили прослушиватель. Вы можете подключиться напрямую к основному узлу для операций чтения и записи и второстепенному узлу для запросов только на чтение.
    
     ![Группа доступности в диспетчере отказоустойчивости кластеров](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665534.gif)

> [!WARNING]
> Не пытайтесь выполнить отработку отказа для группы доступности через диспетчер отказоустойчивости кластеров. Все операции отработки отказа следует выполнять через **панель мониторинга AlwaysOn** в SQL Server Management Studio. Дополнительные сведения см. в статье [Отказоустойчивая кластеризация и группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/ff929171.aspx).
> 
> 

## <a name="next-steps"></a>Дальнейшие действия
Решение SQL Server Always On на основе группы доступности в Azure успешно создано. Инструкции по настройке прослушивателя для этой группы доступности см. в статье [Настройка прослушивателя внутренней подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure](../classic/ps-sql-int-listener.md).

Дополнительные сведения об использовании SQL Server в Azure см. в статье [Общие сведения об SQL Server на виртуальных машинах Azure](../sql/virtual-machines-windows-sql-server-iaas-overview.md).

