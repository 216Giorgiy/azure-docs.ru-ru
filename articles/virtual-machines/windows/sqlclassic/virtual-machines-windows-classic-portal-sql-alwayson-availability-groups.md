---
title: "Настройка группы доступности AlwaysOn на виртуальной машине Azure (классическая модель) | Документы Майкрософт"
description: "Создание группы доступности AlwaysOn на виртуальных машинах Azure. В этом учебнике в основном используется пользовательский интерфейс и инструменты, а не сценарии."
services: virtual-machines-windows
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: 8d48a3d2-79f8-4ab0-9327-2f30ee0b2ff1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/17/2017
ms.author: mikeray
translationtype: Human Translation
ms.sourcegitcommit: 6d749e5182fbab04adc32521303095dab199d129
ms.openlocfilehash: 1390a0caf4e9cfe2af8bd6171a4d07f58da4bc43
ms.lasthandoff: 03/22/2017


---
# <a name="configure-always-on-availability-group-in-azure-vm-classic"></a>Настройка группы доступности AlwaysOn на виртуальной машине Azure (классическая модель)
> [!div class="op_single_selector"]
> * [Классическая модель: пользовательский интерфейс](virtual-machines-windows-classic-portal-sql-alwayson-availability-groups.md)
> * [Классическая модель: PowerShell](virtual-machines-windows-classic-ps-sql-alwayson-availability-groups.md)
<br/>

> [!IMPORTANT] 
> Для большинства новых развертываний Майкрософт рекомендует использовать модель диспетчера ресурсов. В Azure предлагаются две модели развертывания для создания ресурсов и работы с ними: [модель диспетчера ресурсов и классическая модель](../../../azure-resource-manager/resource-manager-deployment-model.md). В этой статье рассматривается использование классической модели развертывания. 

Чтобы выполнить эту задачу с использованием модели Azure Resource Manager, см. статью [Введение в группы доступности AlwaysOn SQL Server на виртуальных машинах Azure](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md).

В этом комплексном руководстве показано, как реализовывать группы доступности с помощью AlwaysOn SQL Server на виртуальных машинах Azure.

Когда вы завершите, решение SQL Server Always On в Azure будет состоять из следующих элементов:

* виртуальной сети, содержащей несколько подсетей, включая начальную и конечной подсети;
* контроллера домена с доменом Active Directory (AD);
* двух виртуальных машин SQL Server, развернутых во внутреннюю подсеть и присоединенных к домену AD;
* отказоустойчивого кластера из трех узлов с моделью кворума "Большинство узлов";
* группы доступности с двумя репликами с синхронной фиксацией базы данных доступности.

На следующем рисунке показано графическое представление решения.

![Лабораторное тестирование архитектуры для групп доступности в Azure](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC791912.png)

Обратите внимание, что это одна из возможных конфигураций. Например, можно сократить число виртуальных машин для группы доступности с двумя репликами, чтобы сократить часы вычислительных операций в Azure, используя контроллер домена как следящую общую папку кворума в кластере из двух узлов. Этот метод сократит число виртуальных машин на одну по сравнению с указанной выше конфигурацией.

В этом учебнике предполагается следующее:

* У вас уже есть учетная запись Azure.
* Вы уже умеете подготавливать классическую виртуальную машину SQL Server из коллекции виртуальных машин через графический интерфейс пользователя.
* Вы хорошо понимаете принцип работы групп доступности AlwaysOn. Дополнительные сведения см. в разделе [Группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx).

> [!NOTE]
> Если вы планируете использовать группы доступности AlwaysOn с SharePoint, ознакомьтесь также со статьей [Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://technet.microsoft.com/library/jj715261.aspx).
> 
> 

## <a name="create-the-virtual-network-and-domain-controller-server"></a>Создание виртуальной сети и сервера контроллера домена
Сначала создайте новую пробную учетную запись Azure. После настройки учетной записи вы увидите начальный экран классического портала Azure.

1. Нажмите кнопку **Создать** в левом нижнем углу страницы, как показано ниже.
   
    ![Нажмите кнопку «Создать» на портале.](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665511.gif)
2. Щелкните **Сетевые службы**, **Виртуальная сеть** и **Настраиваемое создание**, как показано ниже.
   
    ![Создание виртуальной сети](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665512.gif)
3. В диалоговом окне **СОЗДАНИЕ ВИРТУАЛЬНОЙ СЕТИ** создайте новую виртуальную сеть, поэтапно настроив параметры на всех страницах, как показано ниже. 
   
   | Страница | данных |
   | --- | --- |
   | Информация о виртуальной сети |**Имя — ContosoNET**<br/>**REGION = West US** |
   | DNS-серверы и подключение VPN |None |
   | Адресные пространства виртуальной сети |Параметры показаны на следующем снимке экрана:  ![Создание виртуальной сети](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784620.png) |
4. Затем вам потребуется создать виртуальную машину, чтобы использовать ее в качестве контроллера домена. Снова нажмите кнопку **Создать**, а затем щелкните **Среда выполнения приложений**, **Виртуальная машина** и **Из коллекции**, как показано ниже.
   
    ![Создание виртуальной машины](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784621.png)
5. В диалоговом окне **СОЗДАНИЕ ВИРТУАЛЬНОЙ МАШИНЫ** настройте новую виртуальную машину, поэтапно настроив параметры на всех страницах, как показано ниже. 
   
   | Страница | данных |
   | --- | --- |
   | Выбор операционной системы виртуальной машины |Центр обработки данных Windows Server 2012 R2 |
   | Конфигурация виртуальной машины |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoDC<br/>**Уровень** — Стандартный<br/>**Размер** — A2 (2 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |
   | Конфигурация виртуальной машины |**Облачная служба** — создайте облачную службу<br/>**DNS-имя облачной службы** — уникальное имя облачной службы<br/>**DNS-имя** — уникальное имя (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = (нет) |
   | Параметры виртуальной машины |По умолчанию |

После завершения настройки новой виртуальной машины подождите, пока она подготовится к работе. Этот процесс занимает некоторое время, и если перейти на вкладку **Виртуальная машина** классического портала Azure, вы увидите, как состояния машины ContosoDC меняются в такой последовательности: **Starting (Provisioning)** (Запуск (идет подготовка)), **Остановлено**, **Запуск**, **Работает (идет подготовка)** и, наконец, **Работает**.

Сервер контроллера домена успешно подготовлен. Далее нужно настроить домен Active Directory на этом сервере контроллера домена.

## <a name="configure-the-domain-controller"></a>Настройка контроллера домена
На следующих этапах вы настроите машину ContosoDC в качестве контроллера домена для corp.contoso.com.

1. На портале выберите машину **ContosoDC** . На вкладке **Панель мониторинга** нажмите кнопку **Подключиться**, чтобы открыть RDP-файл для удаленного доступа к рабочему столу.
   
    ![Подключение к виртуальной машине](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784622.png)
2. Войдите в систему с использованием настроенной учетной записи администратора (**\AzureAdmin**) и пароля (**Contoso!000**).
3. По умолчанию отображается панель мониторинга **Диспетчер серверов** .
4. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.
   
    ![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784623.png)
5. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
6. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
   
   > [!NOTE]
   > Вы получите предупреждение проверки об отсутствии статического IP-адреса. Если вы тестируете конфигурацию, нажмите кнопку "Продолжить". Для рабочих сценариев [используйте PowerShell для установки статического IP-адреса машины контроллера домена](../../../virtual-network/virtual-networks-reserved-private-ip.md).
   > 
   > 
   
    ![Диалоговое окно добавления ролей](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784624.png)
7. Нажимайте **Далее**, пока не откроется раздел **Подтверждение**. Выберите флажок **Перезапустить целевой сервер, если требуется** .
8. Щелкните **Install**(Установить).
9. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
10. Выберите новый вариант **AD DS** на левой панели.
11. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.
    
     ![Диалоговое окно службы каталогов Active Directory на виртуальной машине DNS-сервера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784625.png)
12. В столбце **Действие** диалогового окна **Сведения обо всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.
13. В **мастере настройки доменных служб Active Directory**используйте следующие значения:
    
    | Страница | Настройка |
    | --- | --- |
    | Конфигурация развертывания |**Добавить новый лес** = выбрано<br/>**Имя корневого домена** = corp.contoso.com |
    | Параметры контроллера домена |**Пароль** = Contoso!000<br/>**Подтверждение пароля** = Contoso!000 |
14. Нажимайте кнопку **Далее** , чтобы пройти остальные страницы мастера. Убедитесь, что на странице **Проверка готовности** отображается следующее сообщение: **Все проверки готовности успешно завершены**. Обратите внимание, что вам следует просмотреть все применимые предупреждения, но это не обязательно для продолжения установки.
15. Щелкните **Install**(Установить). Виртуальная машина **ContosoDC** автоматически перезагрузится.

## <a name="configure-domain-accounts"></a>Настройка учетных записей домена
На следующих этапах настраиваются учетные записи Active Directory (AD) для дальнейшего использования.

1. Снова войдите в машину **ContosoDC** .
2. На панели **Диспетчер серверов** выберите **Средства**, а затем нажмите **Центр администрирования Active Directory**.
   
    ![Центр администрирования Active Directory](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784626.png)
3. В колонке **Центр администрирования Active Directory** select **corp (локальный)** на левой панели.
4. На правой панели **Задачи** выберите **Создать** и нажмите **Пользователь**. Используйте следующие параметры:
   
   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Install |
   | **User SamAccountName** |Install |
   | **Пароль** |Contoso!000 |
   | **Подтверждение пароля.** |Contoso!000 |
   | **Другие параметры пароля** |Выбрано |
   | **Срок действия пароля не ограничен** |Флажок установлен |
5. Нажмите кнопку **ОК**, чтобы создать пользователя **Install**. Эта учетная запись используется для настройки отказоустойчивого кластера и группы доступности.
6. Создайте двух дополнительных пользователей тем же способом: **CORP\SQLSvc1** и **CORP\SQLSvc2**. Эти учетные записи используются для экземпляров SQL Server. Затем вам потребуется предоставить пользователю **CORP\Install** необходимые разрешения для настройки отказоустойчивой кластеризации Windows.
7. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели. Затем на правой панели **Задачи** нажмите кнопку **Свойства**.
   
    ![Свойства пользователя CORP](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784627.png)
8. Выберите **Расширения**, затем нажмите кнопку **Дополнительно** на вкладке **Безопасность**.
9. В диалоговом окне **Дополнительные параметры безопасности для предприятия** . Щелкните **Добавить**.
10. Щелкните **Выбрать субъект**. Затем найдите **CORP\Install**. Нажмите кнопку **ОК**.
11. Выберите разрешения **Чтение всех свойств** и **Создание объектов-компьютеров**.
    
     ![Разрешения пользователя Corp](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784628.png)
12. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Закройте окно свойств предприятия.

После завершения настройки Active Directory и объектов пользователей вам потребуется создать три виртуальные машины SQL Server и присоединить их к этому домену.

## <a name="create-the-sql-server-vms"></a>Создание виртуальных машин SQL Server
Затем создайте три виртуальные машины, включая узел кластера и две виртуальные машины SQL Server. Для создания каждой виртуальной машины вернитесь на классический портал Azure и щелкните **Создать**, **Среда выполнения приложений**, **Виртуальная машина** и **Из коллекции**. Затем используйте шаблоны из следующей таблицы, чтобы упростить создание виртуальных машин.

| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выбор операционной системы виртуальной машины |**Центр обработки данных Windows Server 2012 R2** |**SQL Server 2014 RTM Enterprise** |**SQL Server 2014 RTM Enterprise** |
| Конфигурация виртуальной машины |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoWSFCNode<br/>**Уровень** — Стандартный<br/>**Размер** — A2 (2 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoSQL1<br/>**Уровень** — Стандартный<br/>**Размер** — A3 (4 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoSQL2<br/>**Уровень** — Стандартный<br/>**Размер** — A3 (4 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |
| Конфигурация виртуальной машины |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** — создайте группу доступности<br/>**ИМЯ ГРУППЫ ДОСТУПНОСТИ** = SQLHADR |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** — SQLHADR (группу доступности можно также настроить после создания виртуальной машины) Все три машины следует определить в группу доступности SQLHADR). |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** — SQLHADR (группу доступности можно также настроить после создания виртуальной машины) Все три машины следует определить в группу доступности SQLHADR). |
| Параметры виртуальной машины |По умолчанию |По умолчанию |По умолчанию |

<br/>

> [!NOTE]
> Предыдущая конфигурация предлагает виртуальные машины уровня СТАНДАРТНЫЙ, поскольку машины уровня БАЗОВЫЙ не поддерживают конечные точки с балансировкой нагрузки, необходимые для дальнейшего создания прослушивателей группы доступности. Кроме того, предлагаемые здесь размеры машин предназначены для тестирования групп доступности в виртуальных машинах Azure. Для обеспечения оптимальной производительности рабочих нагрузок см. рекомендации по размерам машин SQL Server и их настройке в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](../sql/virtual-machines-windows-sql-performance.md).
> 
> 

После завершения подготовки трех виртуальных машин вам потребуется присоединить их к домену **corp.contoso.com** и предоставить пользователю CORP\Install права администратора виртуальных машин. Для этого выполните следующие действия для каждой из трех виртуальных машин.

1. Во-первых, измените предпочитаемый адрес DNS-сервера. Для начала скачайте файл удаленного рабочего стола (RDP) для каждой виртуальной машины в локальный каталог, выбрав нужную виртуальную машину из списка и нажав кнопку **Подключиться** . Чтобы выбрать виртуальную машину, щелкните в любом месте, кроме первой ячейки в столбце, как показано ниже.
   
    ![Скачивание RDP-файла](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664953.jpg)
2. Запустите скачанный RDP-файл и войдите в виртуальную машину с использованием настроенной учетной записи администратора (**BUILTIN\AzureAdmin**) и пароля (**Contoso!000**).
3. После входа вы должны увидеть панель мониторинга **Диспетчер серверов** . Щелкните **Локальный сервер** на левой панели.
4. Выберите ссылку **IPv4-адрес назначен DHCP, поддержка IPv6** .
5. В окне **Сетевые подключения** выберите значок сети.
   
    ![Изменение предпочитаемого DNS-сервера для виртуальной машины](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784629.png)
6. На панели команд нажмите **Изменить параметры этого подключения** (в зависимости от размера окна вам может потребоваться щелкнуть двойную стрелку вправо, чтобы увидеть эту команду).
7. Выберите пункт **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку "Свойства".
8. Выберите Use the following DNS server addresses (Использовать следующие адреса DNS-серверов) и укажите **10.10.2.4** в поле **Основной DNS-сервер**.
9. **10.10.2.4** — это адрес, назначенный виртуальной машине в подсети 10.10.2.0/24 в виртуальной сети Azure. Речь идет о виртуальной машине **ContosoDC**. Для проверки IP-адреса **ContosoDC** используйте команду **nslookup contosodc** в соответствующем запросе, как показано ниже.
   
    ![Поиск IP-адреса для контроллера домена с помощью NSLOОКUP](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664954.jpg)
10. Нажмите кнопку **ОК**, а затем — **Закрыть**, чтобы сохранить изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.
11. В окне **Локальный сервер** щелкните ссылку **РАБОЧАЯ ГРУППА**.
12. В разделе **Имя компьютера** нажмите кнопку **Изменить**.
13. Установить флажок **Домен** и введите в текстовом поле **corp.contoso.com**. Нажмите кнопку **ОК**.
14. Во всплывающем диалоговом окне **Безопасность Windows** укажите имя (**CORP\AzureAdmin**) и пароль (**Contoso!000**) учетной записи администратора домена по умолчанию.
15. При появлении сообщения "Добро пожаловать на домен corp.contoso.com" нажмите кнопку **ОК**.
16. Нажмите кнопку **Закрыть**, а затем **Перезагрузить сейчас** во всплывающем диалоговом окне.

### <a name="add-the-corpinstall-user-as-an-administrator-on-each-vm"></a>Добавьте пользователя "Corp\Install" в качестве администратора на каждой виртуальной машине:
1. Дождитесь перезапуска виртуальной машины, затем снова запустите RDP-файл, чтобы войти в виртуальную машину под учетной записью **BUILTIN\AzureAdmin**.
2. На панели **Диспетчер серверов** выберите **Инструменты**, а затем нажмите **Управление компьютерами**.
   
    ![Управление компьютерами](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784630.png)
3. В окне **Управление компьютерами** разверните пункт **Локальные пользователи и группы**, а затем выберите **Группы**.
4. Дважды щелкните группу **Администраторы** .
5. В диалоговом окне **Свойства администратора** нажмите кнопку **Добавить**.
6. Введите имя пользователя **CORP\Install**, а затем нажмите кнопку **ОК**. При появлении запроса учетных данных используйте учетную запись **AzureAdmin** с паролем **Contoso!000**.
7. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Свойства администратора**.

### <a name="add-the-failover-clustering-feature-to-each-vm"></a>Добавьте компонент **Отказоустойчивость кластеров** для каждой виртуальной машины.
1. На панели мониторинга **Диспетчер серверов** нажмите **Добавить роли и компоненты**.
2. В **мастере добавления ролей и компонентов** нажимайте кнопку **Далее**, пока не откроется страница **Компоненты**.
3. Выберите **Отказоустойчивость кластеров**. При появлении запроса добавьте любые другие зависимые компоненты.
   
    ![Добавление компонента отказоустойчивой кластеризации к виртуальной машине](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784631.png)
4. Нажмите кнопку **Далее**, а затем **Установить** на странице **Подтверждение**.
5. После завершения установки компонента **Отказоустойчивая кластеризация** нажмите кнопку **Закрыть**.
6. Выйдите из виртуальной машины.
7. Повторите действия в этом разделе для всех трех серверов — **ContosoWSFCNode**, **ContosoSQL1** и **ContosoSQL2**.

Виртуальные машины SQL Server подготовлены и запущены, но они устанавливаются с SQL Server с использованием параметров по умолчанию.

## <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера
В этом разделе вы создадите отказоустойчивый кластер, на котором будет размещена группа доступности, созданная в дальнейшем. К этому моменту для каждой из трех виртуальных машин, которые будут использоваться в отказоустойчивом кластере, вы должны были выполнить следующие действия:

* полная подготовка в Azure;
* присоединение к домену;
* добавление пользователя **CORP\Install** в локальную группу администраторов;
* добавление компонента "Отказоустойчивая кластеризация".

Все эти действия необходимо выполнить на каждой виртуальной машине перед тем, как присоединять ее к отказоустойчивого кластеру.

Кроме того, обратите внимание, что виртуальная сеть Azure функционирует иначе, чем локальная сеть. Создавать кластер необходимо в следующем порядке:

1. Создайте кластер с одним узлом на одном из узлов (**ContosoSQL1**).
2. Измените IP-адрес кластера на неиспользуемый адрес (**10.10.2.101**).
3. Подключите имя кластера к сети.
4. Добавьте другие узлы (**ContosoSQL2** и **ContosoWSFCNode**).

Следуйте дальнейшим инструкциям, чтобы выполнить эти задачи для полной настройки кластера.

1. Запустите RPD-файл для **ContosoSQL1** и войдите с использованием учетной записи домена **CORP\Install**.
2. На панели мониторинга **Диспетчер серверов** выберите **Инструменты**, а затем **Диспетчер отказоустойчивости кластеров**.
3. На левой панели щелкните правой кнопкой мыши элемент **Диспетчер отказоустойчивости кластеров** и выберите команду **Создать кластер**, как показано ниже.
   
    ![Создать кластер](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784632.png)
4. В мастере создания кластеров создайте кластер с одним узлом, поэтапно настроив параметры на всех страницах, как указано ниже:
   
   | Страница | Параметры |
   | --- | --- |
   | Перед началом работы |По умолчанию |
   | Выбор серверов |Введите **ContosoSQL1** в поле **Введите имя сервера** и щелкните **Добавить**. |
   | Предупреждение проверки |Выберите вариант **Нет. Для этого кластера не требуется поддержка корпорации Майкрософт, поэтому нет необходимости выполнять проверочные тесты. После нажатия кнопки "Далее" продолжить создание кластера**. |
   | Точка доступа для администрирования кластера |Введите **Cluster1** в поле **Имя кластера** |
   | Подтверждение |Используйте параметры по умолчанию, если вы не используете дисковые пространства. Ознакомьтесь с примечанием после этой таблицы. |
   
   > [!WARNING]
   > Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, на странице **Подтверждение** снимите флажок **Add all eligible storage to the cluster** (Добавление всех допустимых хранилищ в кластер). Если вы не сделаете этого, виртуальные диски будут отсоединены в процессе кластеризации. Как следствие, они не отобразятся к диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.
   > 
   > 
5. На левой панели разверните элемент **Диспетчер отказоустойчивости кластеров** и щелкните **Cluster1.corp.contoso.com**.
6. На центральной панели найдите раздел **Ресурсы ядра кластера** и разверните элемент со сведениями **Имя: Cluster1**. Вы увидите ресурсы **Имя** и **IP-адрес** с состоянием **Ошибка**. Его невозможно подключить к сети, так как кластеру назначен тот же IP-адрес, что и самой виртуальной машине, то есть повторяющийся.
7. Щелкните правой кнопкой мыши ресурс **IP-адреса** в состоянии сбоя и выберите **Свойства**.
   
    ![Свойства кластера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784633.png)
8. Выберите **Статический IP-адрес** и укажите **10.10.2.101** в текстовом поле "Адрес". Затем нажмите кнопку **ОК**.
9. В разделе **Ресурсы ядра кластера** щелкните правой кнопкой мыши элемент **Имя: Cluster1** и нажмите кнопку **Подключить**. Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера подключится, он добавит на контроллер домена новую учетную запись компьютера Active Directory (AD). Эта учетная запись впоследствии будет использоваться для запуска кластерной службы группы доступности.
10. Наконец, добавьте оставшиеся узлы в кластер. В дереве обозревателя щелкните правой кнопкой мыши **Cluster1.corp.contoso.com**, а затем выберите **Добавить узел**, как показано ниже.
    
     ![Добавление узла в кластер](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784634.png)
11. В **мастере добавления узлов** нажмите кнопку **Далее**. На странице **Выбор серверов** добавьте **ContosoSQL2** и **ContosoWSFCNode** в список, введя имя сервера в поле **Введите имя сервера** и нажав кнопку **Добавить**. Когда будете готовы, нажмите кнопку **Далее**.
12. На странице **Предупреждение проверки** нажмите кнопку **Нет** (в рабочем сценарии следует выполнить проверочные тесты). Затем щелкните **Далее**.
13. На странице **Подтверждение** нажмите кнопку **Далее**, чтобы добавить узлы.
    
    > [!WARNING]
    > Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, снимите флажок **Добавить все доступные носители в кластер** . Если вы не сделаете этого, виртуальные диски будут отсоединены в процессе кластеризации. Как следствие, они не отобразятся к диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.
    > 
    > 
14. После добавления узлов в кластер нажмите кнопку **Готово**. Теперь диспетчер отказоустойчивости кластеров должен показывать три узла в кластере и отображать их в контейнере **Узлы** .
15. Выйдите из сеанса удаленного рабочего стола.

## <a name="prepare-the-sql-server-instances-for-availability-group"></a>Подготовка экземпляров SQL Server для группы доступности
В этом разделе вы сделаете следующее на узлах **ContosoSQL1** и **ContosoSQL2**:

* Добавите имя для входа для **NT AUTHORITY\System** с необходимыми разрешениями для экземпляра SQL Server по умолчанию.
* Добавьте **CORP\Install** в качестве роли системного администратора экземпляра SQL Server по умолчанию.
* Откроете брандмауэр для удаленного доступа к SQL Server.
* Включите компонент групп доступности AlwaysOn.
* Измените учетную запись службы SQL Server на **CORP\SQLSvc1** и **CORP\SQLSvc2** соответственно.

Эти действия можно выполнять в любом порядке. Однако в следующем пошаговом руководстве они приведены в указанном порядке. Сделайте следующее для **ContosoSQL1** и **ContosoSQL2**:

1. Если вы не вышли из сеанса удаленного рабочего стола для виртуальной машины, сделайте это.
2. Запустите RDP-файлы для **ContosoSQL1** и **ContosoSQL2** и войдите с использованием учетной записи **BUILTIN\AzureAdmin**.
3. Сначала добавьте **NT AUTHORITY\System** в список имен для входа SQL Server с необходимыми разрешениями. Запустите **SQL Server Management Studio**.
4. Нажмите кнопку **Подключение** , чтобы подключиться к экземпляру SQL Server по умолчанию.
5. В **обозревателе объектов** разверните элемент **Безопасность**, а затем элемент **Имена входа**.
6. Щелкните правой кнопкой мыши имя входа **NT AUTHORITY\System**, а затем выберите пункт **Свойства**.
7. На странице **Защищаемые объекты** для локального сервера выберите **Предоставить** для следующих разрешений и нажмите кнопку **ОК**.
   
   * Изменение любой группы доступности
   * Соединение SQL
   * Просмотр состояния сервера
8. Затем добавьте **CORP\Install** в качестве роли **системного администратора** в экземпляр SQL Server по умолчанию. В **обозревателе объектов** щелкните правой кнопкой мыши **Имена для входа**, а затем выберите пункт **Новое имя для входа**.
9. Введите **CORP\Install** в поле **Имя для входа**.
10. На странице **Роли сервера** выберите **системный администратор**. Затем нажмите кнопку **ОК**. После создания имени для входа вы можете увидеть его, развернув элемент **Имена для входа** in **диспетчере объектов**.
11. Далее вам потребуется создать правило брандмауэра для SQL Server. На **начальном экране** запустите **Брандмауэр Windows в режиме повышенной безопасности**.
12. В левой панели выберите **Правила для входящих подключений**. На правой панели нажмите кнопку **Новое правило**.
13. На странице **Тип правила** выберите **Программа** и нажмите кнопку **Далее**.
14. На странице **Программа** выберите **Этот путь программы** и введите **%ProgramFiles%\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\Binn\sqlservr.exe** в текстовом поле (если вы следуете этим указаниям, но используете SQL Server 2012, каталог SQL Server — **MSSQL11.MSSQLSERVER**). Нажмите кнопку **Далее**.
15. На странице **Действие** оставьте флажок **Разрешить подключение** и нажмите кнопку **Далее**.
16. На странице **Профиль** примите параметры по умолчанию и нажмите кнопку **Далее**.
17. На странице **Имя** укажите имя правила, например **SQL Server (правило программы)**, в текстовом поле **Имя** и нажмите кнопку **Готово**.
18. Затем включите функцию **групп доступности AlwaysOn** . На **начальном экране** запустите **Диспетчер конфигурации SQL Server**.
19. В дереве обозревателя выберите **Службы SQL Server**, затем щелкните правой кнопкой мыши службу **SQL Server (MSSQLSERVER)** и выберите пункт **Свойства**.
20. Выберите вкладку **Always On High Availability** (Высокий уровень доступности AlwaysOn), затем выберите **Enable Always On Availability Groups** (Включить группы доступности AlwaysOn), как показано ниже, и нажмите кнопку **Применить**. Нажмите кнопку **ОК** во всплывающем диалоговом окне и не закрывайте окно свойств. После изменения учетной записи службы вам потребуется перезапустить службу SQL Server.
    
     ![Включение групп доступности AlwaysOn](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665520.gif)
21. Далее вам потребуется изменить учетную запись службы SQL Server. Откройте вкладку **Вход**, затем введите **CORP\SQLSvc1** (для **ContosoSQL1**) или **CORP\SQLSvc2** (для **ContosoSQL2**) в поле **Имя учетной записи**, после чего введите и подтвердите пароль и нажмите кнопку **ОК**.
22. Во всплывающем окне нажмите кнопку **Да** , чтобы перезапустить службу SQL Server. После перезапуска службы SQL Server изменения, внесенные вами в окне свойств, вступят в силу.
23. Выйдите из виртуальных машин.

## <a name="create-the-availability-group"></a>Создание группы доступности
Теперь можно приступить к настройке группы доступности. Ниже приведено краткое описание того, что вам потребуется сделать:

* Создание базы данных (**MyDB1**) на **ContosoSQL1**.
* Создание полной резервной копии и резервной копии журнала транзакций базы данных.
* Восстановление обеих резервных копий на **ContosoSQL2** с параметром **NORECOVERY**.
* Создание группы доступности (**AG1**) с синхронной фиксацией, автоматической отработкой отказа и доступными для чтения вторичными репликами.

### <a name="create-the-mydb1-database-on-contososql1"></a>Создание базы данных MyDB1 на ContosoSQL1:
1. Если вы еще не вышли из сеансов удаленных рабочих столов для **ContosoSQL1** и **ContosoSQL2**, сделайте это.
2. Запустите RPD-файл для **ContosoSQL1** и войдите с использованием учетной записи **CORP\Install**.
3. В **проводнике** на диске **C:\** создайте каталог**backup* *. Вы будете использовать этот каталог для резервного копирования и восстановления базы данных.
4. Щелкните правой кнопкой мыши новый каталог, наведите указатель мыши на элемент **Общий доступ** и выберите **Отдельные люди**, как показано ниже.
   
    ![Создание папки резервного копирования](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665521.gif)
5. Добавьте пользователя **CORP\SQLSvc1** и предоставьте ему разрешение **Чтение и запись**. Затем добавьте пользователя **CORP\SQLSvc2** и предоставьте ему разрешение **Чтение**, как показано ниже, после чего нажмите **Share** (Предоставить общий доступ). После завершения процесса предоставления общего доступа к файлам нажмите кнопку **Готово**.
   
    ![Предоставление разрешений для папки резервного копирования](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665522.gif)
6. Далее вы создадите базу данных. В меню **Пуск** запустите **SQL Server Management Studio**, затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.
7. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Новая база данных**.
8. В поле **Имя базы данных** введите **MyDB1**, а затем нажмите кнопку **ОК**.

### <a name="take-a-full-backup-of-mydb1-and-restore-it-on-contososql2"></a>Создайте полную резервную копию MyDB1 и сохраните ее на ContosoSQL2:
1. Далее вы создадите полную резервную копию базы данных. В **обозревателе объектов** разверните элемент **Базы данных**, затем щелкните правой кнопкой мыши базу данных **MyDB1**, наведите указатель мыши на пункт **Задачи** и нажмите **Резервное копирование**.
2. В разделе **Источник** оставьте параметр **Тип резервного копирования** со значением **Полное**. В разделе **Назначение** нажмите кнопку **Удалить**, чтобы удалить путь к файлу резервной копии по умолчанию.
3. В разделе **Назначение** нажмите кнопку **Добавить**.
4. В текстовом поле **Имя файла** введите **\\ContosoSQL1\backup\MyDB1.bak**. Затем нажмите кнопку **ОК** и еще раз кнопку **ОК**, чтобы создать резервную копию базы данных. После завершения резервного копирования нажмите кнопку **ОК** , чтобы закрыть диалоговое окно.
5. Далее вы создадите резервную копию журнала транзакций базы данных. В **обозревателе объектов** разверните элемент **Базы данных**, затем щелкните правой кнопкой мыши базу данных **MyDB1**, наведите указатель мыши на пункт **Задачи** и нажмите **Резервное копирование**.
6. В поле **Тип резервной копии** выберите вариант **Журнал транзакций**. В разделе **Назначение** оставьте указанный ранее путь к файлу и нажмите кнопку **ОК**. После завершения резервного копирования нажмите кнопку **ОК** еще раз.
7. Далее вы восстановите полную резервную копию и резервную копию журнала транзакций на **ContosoSQL2**. Запустите RPD-файл для **ContosoSQL2** и войдите с использованием учетной записи **CORP\Install**. Оставьте сеанс удаленного рабочего стола для **ContosoSQL1** открытым.
8. В меню **Пуск** запустите **SQL Server Management Studio**, затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.
9. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Восстановить базу данных**.
10. В разделе **Источник** выберите **Устройство** и нажмите кнопку **…**. .
11. В разделе **Выберите устройства резервного копирования** нажмите кнопку **Добавить**.
12. В поле "Расположение файла резервной копии" введите \\ContosoSQL1\backup, затем нажмите кнопку "Обновить", выберите MyDB1.bak, нажмите кнопку "ОК" и еще раз кнопку "ОК". На панели "Восстанавливаемые резервные наборы данных" должны появиться полная резервная копия и резервная копия журнала.
13. Перейдите на страницу "Параметры", выберите вариант "ВОССТАНОВЛЕНИЕ С ПОМОЩЬЮ NORECOVERY" в состоянии "Восстановление" и нажмите кнопку "ОК", чтобы восстановить базу данных. После завершения восстановления нажмите кнопку "ОК".

### <a name="create-the-availability-group"></a>Создание группы доступности:
1. Вернитесь к сеансу удаленного рабочего стола для **ContosoSQL1**. В **обозревателе объектов** в SSMS щелкните правой кнопкой мыши элемент **Always On High Availability** (Высокий уровень доступности AlwaysOn) и выберите пункт **New Availability Group Wizard** (Мастер создания групп доступности), как показано ниже.
   
    ![Запуск мастера создания групп доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665523.gif)
2. На странице **Введение** нажмите кнопку **Далее**. На странице **Указание имени группы доступности** введите **AG1** в поле **Имя группы доступности**, затем нажмите кнопку **Далее** еще раз.
   
    ![Мастер создания групп доступности, ввод имени групп доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665524.gif)
3. На странице **Выбор баз данных** выберите **MyDB1** и нажмите кнопку **Далее**. Эта база данных отвечает требованиям для создания группы доступности, так как вы создали для нее как минимум одну полную резервную копию на соответствующей первичной реплике.
   
    ![Мастер создания групп доступности, выбор баз данных](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665525.gif)
4. На странице **Указание реплик** нажмите кнопку **Добавить реплику**.
   
    ![Мастер создания групп доступности, указание реплик](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665526.gif)
5. Появится диалоговое окно **Подключение к серверу** . Введите **ContosoSQL2** в поле **Имя сервера** и нажмите кнопку **Подключиться**.
   
    ![Мастер создания групп доступности, подключение к серверу](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665527.gif)
6. На странице **Specify Replicas** (Указание реплик) сервер **ContosoSQL2** должен отобразиться в списке **Available Replicas** (Доступные реплики). Настройте реплики, как показано ниже. После завершения нажмите кнопку **Далее**.
   
    ![Мастер создания групп доступности, указание реплик (завершено)](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665528.gif)
7. На странице **Выбор начальной синхронизации данных** выберите **Только соединение** и нажмите кнопку **Далее**. Вы уже выполнили синхронизацию данных вручную при создании полной резервной копии и резервной копии журнала транзакций на **ContosoSQL1** и их восстановлении на **ContosoSQL2**. Вы можете не выполнять операции резервного копирования и восстановления для базы данных и выбрать **Полная** , чтобы позволить мастеру создания групп доступности выполнить синхронизацию данных вместо вас. Обратите внимание, что синхронизацию не рекомендуется проводить для весьма крупных баз, которые иногда используются на предприятиях.
   
    ![Мастер создания групп доступности, выбор начальной синхронизации данных](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665529.gif)
8. На странице **Проверка** нажмите кнопку **Далее**. Страница должна иметь примерно такой вид: Появится предупреждение о конфигурации прослушивателя группы доступности, так как он еще не настроен. Вы можете пропустить это предупреждение, поскольку процедура настройки прослушивателя не описана в этом учебнике. Чтобы после завершения работы с этим руководством настроить прослушиватель, ознакомьтесь со статьей [Настройка прослушивателя внутренней подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure](virtual-machines-windows-classic-ps-sql-int-listener.md).
   
    ![Мастер создания групп доступности, проверка](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665530.gif)
9. На странице **Сводка** нажмите кнопку **Готово**, затем подождите, пока мастер настроит новую группу доступности. На странице **Ход выполнения** вы можете нажать кнопку **Дополнительные сведения**, чтобы просмотреть подробности хода выполнения. Завершив работу с мастером, проверьте содержимое страницы **Результаты**, чтобы убедиться, что группа доступности успешно создана, как показано ниже, и нажмите кнопку **Закрыть**, чтобы выйти из мастера.
   
    ![Мастер создания групп доступности, результаты](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665531.gif)
10. В **обозревателе объектов** разверните элемент **Always On High Availability** (Высокий уровень доступности AlwaysOn), а затем элемент **Группы доступности**. Теперь в этом контейнере должна появиться новая группа доступности. Щелкните правой кнопкой мыши **AG1 (основная)** и выберите пункт **Отобразить панель мониторинга**.
    
     ![Отображение панели мониторинга группы доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665532.gif)
11. **Панель мониторинга AlwaysOn** должна выглядеть следующим образом. Вы увидите реплики, режим отработки отказа для каждой из них и состояние синхронизации.
    
     ![Панель мониторинга группы доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665533.gif)
12. Вернитесь на панель **Диспетчер серверов**, выберите **Инструменты** и запустите **Диспетчер отказоустойчивости кластеров**.
13. Разверните элемент **Cluster1.corp.contoso.com**, а затем разверните элемент **Службы и приложения**. Выберите **Роли** и обратите внимание, что роль группы доступности **AG1** создана. Обратите внимание, что у группы AG1 нет IP-адреса, по которому клиенты базы данных могут подключиться к группе доступности, поскольку вы не настроили прослушиватель. Вы можете подключиться напрямую к основному узлу для операций чтения и записи и второстепенному узлу для запросов только на чтение.
    
     ![Группа доступности в диспетчере отказоустойчивости кластеров](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665534.gif)

> [!WARNING]
> Не пытайтесь выполнить отработку отказа для группы доступности через диспетчер отказоустойчивости кластеров. Все операции отработки отказа следует выполнять через **панель мониторинга AlwaysOn** в SSMS. Дополнительные сведения см. в статье [Отказоустойчивая кластеризация и группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/ff929171.aspx).
> 
> 

## <a name="next-steps"></a>Дальнейшие действия
Решение SQL Server Always On на основе группы доступности в Azure успешно создано. Инструкции по настройке прослушивателя для этой группы доступности см. в статье [Настройка прослушивателя внутренней подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure](virtual-machines-windows-classic-ps-sql-int-listener.md).

Дополнительные сведения об использовании SQL Server в Azure см. в статье [Общие сведения об SQL Server на виртуальных машинах Azure](../sql/virtual-machines-windows-sql-server-iaas-overview.md).


