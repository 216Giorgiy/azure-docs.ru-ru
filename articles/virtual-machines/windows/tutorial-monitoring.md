---
title: "Мониторинг Azure и виртуальные машины Windows | Документы Майкрософт"
description: "Руководство по мониторингу виртуальных машин Windows с помощью Azure PowerShell"
services: virtual-machines-windows
documentationcenter: virtual-machines
author: davidmu1
manager: timlt
editor: tysonn
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 05/04/2017
ms.author: davidmu
ms.translationtype: Human Translation
ms.sourcegitcommit: 18d4994f303a11e9ce2d07bc1124aaedf570fc82
ms.openlocfilehash: 2bf6e3cf2f039a9c92617203a3d4cf2aac8901ce
ms.contentlocale: ru-ru
ms.lasthandoff: 05/09/2017

---

# <a name="monitor-a-windows-virtual-machine-with-azure-powershell"></a>Мониторинг виртуальных машин Windows с помощью Azure PowerShell

Служба мониторинга Azure использует агенты для сбора данных о производительности и загрузке с виртуальных машин Azure, сохраняет эти данные в хранилище Azure и предоставляет к ним доступ через портал, модуль Azure PowerShell и Azure CLI. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Включение диагностики загрузки на виртуальной машине
> * Просмотр диагностики загрузки
> * Просмотр метрик узла виртуальной машины
> * Установка расширения системы диагностики
> * Просмотр метрик виртуальной машины
> * Создание оповещения
> * Настройка расширенного мониторинга

Для работы с этим руководством требуется модуль Azure PowerShell версии не ниже 3.6. Чтобы узнать версию, выполните команду ` Get-Module -ListAvailable AzureRM`. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке модуля Azure PowerShell](/powershell/azure/install-azurerm-ps).

Для выполнения примера в этом руководстве требуется виртуальная машина. Этот [пример сценария](../scripts/virtual-machines-windows-powershell-sample-create-vm.md) позволяет создать ее при необходимости. При работе с примером по мере необходимости заменяйте имена групп ресурсов, виртуальных машин и расположений.

## <a name="view-boot-diagnostics"></a>Просмотр диагностики загрузки

При загрузке виртуальных машин Windows агент диагностики загрузки записывает выходные данные на экране, которые можно использовать в целях устранения неполадок. Эта возможность включена по умолчанию. Записанные снимки экрана сохраняются в учетной записи хранения Azure, которая также создается по умолчанию. 

Данные диагностики загрузки можно получить с помощью команды [Get AzureRmVMBootDiagnosticsData](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmbootdiagnosticsdata). В следующем примере данные диагностики загрузки загружаются в корень диска *c:\*. 

```powershell
Get-AzureRmVMBootDiagnosticsData -ResourceGroupName myResourceGroup -Name myVM -Windows -LocalPath "c:\"
```

## <a name="view-host-metrics"></a>Просмотр метрик узла

Виртуальная машина Windows имеет выделенный узел виртуальной машины в Azure, с которым она взаимодействует. Метрики узла собираются автоматически, и их можно просмотреть на портале Azure.

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroup**, а затем **myVM** в списке ресурсов.
2. Чтобы просмотреть данные о производительности узла виртуальной машины, в колонке виртуальной машины щелкните **Метрики**, а затем выберите любую метрику узла в группе **Доступные метрики**.

    ![Просмотр метрик узла](./media/tutorial-monitoring/tutorial-monitor-host-metrics.png)

## <a name="install-diagnostics-extension"></a>Установка расширения диагностики

По умолчанию доступны основные метрики узла. Чтобы просмотреть более детальные метрики определенной виртуальной машины, требуется установить расширение системы диагностики Azure, позволяющее получать дополнительные данные мониторинга и диагностики виртуальной машины. С помощью этих метрик производительности можно создать уведомления с учетом работы виртуальной машины. Расширение системы диагностики устанавливается на портале Azure следующим образом:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroup**, а затем **myVM** в списке ресурсов.
2. Щелкните **Параметры диагностики**. В списке будет указано, что *диагностика загрузки* уже включена в предыдущем разделе. Установите флажок для параметра *Базовые метрики*.
3. Нажмите кнопку **Включить мониторинг на гостевом уровне**.

    ![Просмотр метрик диагностики](./media/tutorial-monitoring/enable-diagnostics-extension.png)

## <a name="view-vm-metrics"></a>Просмотр метрик виртуальной машины

Метрики виртуальной машины можно просмотреть аналогично метрикам узла виртуальной машины:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroup**, а затем **myVM** в списке ресурсов.
2. Чтобы увидеть, как работает виртуальная машина, в колонке виртуальной машины щелкните **Метрики**, затем выберите любую метрику диагностики в группе **Доступные метрики**.

    ![Просмотр метрик виртуальной машины](./media/tutorial-monitoring/monitor-vm-metrics.png)

## <a name="create-alerts"></a>Создание оповещений

На основе метрик производительности можно создавать оповещения. Например, оповещения можно использовать для уведомления о том, что средняя загрузка ЦП превышает пороговое значение или свободное место на диске ниже определенного значения. Оповещения отображаются на портале Azure или могут быть отправлены по электронной почте. Вы также можете активировать модули Runbook службы автоматизации Azure или Azure Logic Apps в ответ на создаваемые оповещения.

В следующем примере создается предупреждение на основе среднего показателя использования ЦП.

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroup**, а затем **myVM** в списке ресурсов.
2. В колонке виртуальной машины щелкните **Правила оповещения**, а затем выберите **Добавить оповещение метрики**.
4. Укажите **имя** оповещения, например *myAlertRule*.
5. Для активации оповещения о превышении процента использования ЦП на 1.0 в течение пяти минут оставьте все настройки по умолчанию.
6. При необходимости установите флажок возле параметра *Участники, читатели и владельцы электронной почты* для отправки уведомлений по электронной почте. Действие по умолчанию — предоставлять уведомления на портале.
7. Нажмите кнопку **ОК**.

## <a name="advanced-monitoring"></a>Расширенный мониторинг 

Более сложный мониторинг виртуальной машины можно выполнить с помощью [Operations Management Suite](https://docs.microsoft.com/azure/operations-management-suite/operations-management-suite-overview). Зарегистрируйтесь для получения [бесплатной пробной версии](https://www.microsoft.com/en-us/cloud-platform/operations-management-suite-trial) Operations Management Suite, если вы еще не сделали этого.

При наличии доступа к порталу OMS ключи и идентификатор рабочей области можно найти в колонке "Параметры". Используйте команду [Set-AzureRmVMExtension](https://docs.microsoft.com/powershell/module/azurerm.compute/set-azurermvmextension), чтобы добавить расширение OMS в виртуальную машину. Измените значения переменных в примере ниже, задав собственный идентификатор и ключ рабочей области OMS.  

```powershell
$omsId = "<Replace with your OMS Id>"
$omsKey = "<Replace with your OMS key>"

Set-AzureRmVMExtension -ResourceGroupName myResourceGroup `
  -ExtensionName "Microsoft.EnterpriseCloud.Monitoring" `
  -VMName myVM `
  -Publisher "Microsoft.EnterpriseCloud.Monitoring" `
  -ExtensionType "MicrosoftMonitoringAgent" `
  -TypeHandlerVersion 1.0 `
  -Settings @{"workspaceId" = $omsId} `
  -ProtectedSettings @{"workspaceKey" = $omsKey} `
  -Location eastus
```

Через несколько минут вы увидите новую виртуальную машину в рабочей области OMS. 

![Колонка OMS](./media/tutorial-monitoring/tutorial-monitor-oms.png)

## <a name="next-steps"></a>Дальнейшие действия
В этом руководстве вы выполнили настройку и проверку виртуальных машин с помощью центра безопасности Azure. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * Создать виртуальную сеть
> * Создание группы ресурсов и виртуальной машины 
> * Включение диагностики загрузки на виртуальной машине
> * Просмотр диагностики загрузки
> * Просмотр метрик узла
> * Установка расширения системы диагностики
> * Просмотр метрик виртуальной машины
> * Создание оповещения
> * Настройка расширенного мониторинга

Перейдите к следующему руководству, чтобы узнать о центре безопасности Azure.

> [!div class="nextstepaction"]
> [Мониторинг защиты виртуальных машин с помощью центра безопасности Azure](./tutorial-azure-security.md)
