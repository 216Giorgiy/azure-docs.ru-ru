---
title: "Планирование переноса ресурсов IaaS из классической модели в модель Azure Resource Manager | Документация Майкрософт"
description: "Планирование переноса ресурсов IaaS из классической модели в модель Azure Resource Manager"
services: virtual-machines-windows
documentationcenter: 
author: singhkays
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 78492a2c-2694-4023-a7b8-c97d3708dcb7
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 04/01/2017
ms.author: kasing
translationtype: Human Translation
ms.sourcegitcommit: 6ea03adaabc1cd9e62aa91d4237481d8330704a1
ms.openlocfilehash: 19ae04785d78eae43795b92e808ee835b9047229
ms.lasthandoff: 04/06/2017


---

# <a name="planning-for-migration-of-iaas-resources-from-classic-to-azure-resource-manager"></a>Планирование переноса ресурсов IaaS из классической модели в модель Azure Resource Manager
Хотя Azure Resource Manager и предлагает множество разнообразных возможностей, чрезвычайно важно спланировать процесс переноса ресурсов, чтобы не столкнуться с какими-либо проблемами. Грамотное планирование позволит предотвратить возникновение ошибок при выполнении действий переноса ресурсов. 

> [!NOTE] 
> Над этим руководством тщательно поработала команда консультирования клиентов Azure, а также архитекторы облачных решений, которые помогали клиентам перенести большие среды. Данное руководство будет периодически обновляться новыми рекомендациями, поэтому мы советуем просматривать его время от времени.

Перенос ресурсов состоит из четырех основных этапов.<br>

![Этапы миграции](../media/virtual-machines-windows-migration-classic-resource-manager/plan-labtest-migrate-beyond.png)

## <a name="plan"></a>План

### <a name="technical-considerations-and-tradeoffs"></a>Технические вопросы и компромиссы

В зависимости от масштаба технических требований, географических регионов и применяемых методик, вам необходимо учесть следующие моменты:

1. Почему ваша организация хочет перейти на использование Azure Resource Manager?  По каким деловым соображениям требуется перенос ресурсов?
2. Каковы технические причины использования Azure Resource Manager?  Какие из дополнительных служб Azure вы хотите использовать?
3. Какое приложение или какие наборы виртуальных машин участвуют в перемещении ресурсов?
4. Какие сценарии поддерживает API миграции?  Ознакомьтесь со списком [возможностей и конфигураций, которые не поддерживаются](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#unsupported-features-and-configurations).
5. Поддерживают ли рабочие группы приложения и виртуальные машины в классической модели и модели Azure Resource Manager?
6. Каким образом Azure Resource Manager изменяет процессы развертывания, администрирования, мониторинга виртуальной машины и отправки отчетов?  Нужно ли обновлять скрипты развертывания?
7. Каков ваш план взаимодействия для оповещения заинтересованных лиц (конечных пользователей, владельцев приложения и инфраструктуры)?
8. Учитывая сложность среды, предусмотрен ли какой-то период обслуживания, в течение которого приложение недоступно для конечных пользователей и его владельцев?  Если да, то как надолго?
9. Каков план обучения заинтересованных лиц работе с Azure Resource Manager?
10. Что представляет собой план управления программой или проектом для перемещения?
11. Сколько времени занимает переход на Azure Resource Manager и планы внедрения связанных технологий?  Согласованы ли они друг с другом?

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

У успешных клиентов есть подробные планы, где задокументированы соображения, касающиеся приведенных выше вопросов.  Спонсоры и заинтересованные лица должны быть хорошо ознакомлены с планами по перемещению.  Чтобы получить представления о средствах и процедуре миграции, мы настоятельно рекомендуем изучить приведенные ниже руководства.

* [Platform-supported migration of IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Поддерживаемый платформой перенос ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Техническое руководство по поддерживаемому платформой переносу из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-deep-dive.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Planning for migration of IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-plan.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Планирование переноса ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью Azure PowerShell](migration-classic-resource-manager-ps.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью интерфейса командной строки Azure](../linux/migration-classic-resource-manager-cli.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Community tools to migrate IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-community-tools.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Инструменты сообщества для перемещения ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Распространенные ошибки миграции](migration-classic-resource-manager-errors.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Frequently asked questions about classic to Azure Resource Manager migration](migration-classic-resource-manager-faq.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Часто задаваемые вопросы о перемещении ресурсов из классической модели в модель Azure Resource Manager)

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

- Отказ от планирования.  Этапы процесса перемещения являются проверенными, а результат прогнозируемым.
- Предположение, что API миграции, поддерживаемый платформой, охватывает все сценарии. Поддерживаемые сценарии см. в разделе о [возможностях и конфигурациях, которые не поддерживаются](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#unsupported-features-and-configurations).
- Упущение при планировании потенциальных простоев в работе приложений для конечных пользователей.  Рассчитайте достаточно места в буфере, чтобы корректно предупредить конечных пользователей о потенциальном простое в работе приложения.


## <a name="lab-test"></a>Лабораторные испытания 

**Репликация среды и выполнение тестового перемещения**
  > [!NOTE]
  > Точная репликация существующей среды выполняется с помощью средства, предоставленного сообществом, которое официально не поддерживается службой поддержки Майкрософт. Следовательно, этот шаг является **необязательным**, но это лучший способ обнаружить проблемы без реализации в рабочих средах. Если вы не планируете использовать это средство, ознакомьтесь с приведенными ниже рекомендациями о проверке, подготовке и отмене пробного запуска.
  >
  
  Проведение лабораторного испытания конкретного сценария (вычислительных, сетевых ресурсов и ресурсов хранения) — залог успешного перемещения. В рамках этого испытания вы можете:

  - Использовать отдельную лабораторную среду или существующую нерабочую среду для тестирования. Мы советуем использовать отдельную лабораторную среду, которую можно переместить несколько раз и разрушительно изменить.  Ниже перечислены сценарии сбора и расконсервации метаданных из реальных подписок.
  - Создать лабораторную среду в отдельной подписке. Так как лабораторная среда будет несколько раз удаляться, отдельная, изолированная подписка снизит вероятность случайного удаления каких-нибудь существенных элементов.

  Для этого вы можете использовать средство AsmMetadataParser. См. дополнительные сведения [здесь](https://github.com/Azure/classic-iaas-resourcemanager-migration/tree/master/AsmToArmMigrationApiToolset).

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

Ниже представлены проблемы, характерные для многих объемных перемещений. Приведенный ниже список не является окончательным. С дополнительными сведениями можно ознакомиться в разделе о [возможностях и конфигурациях, которые не поддерживаются](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#unsupported-features-and-configurations).  Возможно, вы и не столкнетесь с этими техническими неполадками, но устранив их перед попыткой миграции, вы обеспечите плавное перемещение.

- **Выполнение проверки, подготовки и отмены пробного запуска.** Это, наверное, самый важный шаг в обеспечении успешного перемещения из классической модели в модель Azure Resource Manager. API миграции выполняет три основных этапа: проверку, подготовку и фиксацию. Проверка будет считывать состояние классической среды и возвращать сведения обо всех неполадках. Но так как некоторые проблемы могут быть связаны со стеком Azure Resource Manager, в результате проверки обнаружить удастся не все. Следующим шагом является процедура подготовки. С помощью подготовки метаданные перемещаются из классической модели в модель Azure Resource Manager, но при этом перемещение не фиксируется и в классической модели ничего не удаляется и не изменяется. Пробный запуск включает в себя подготовку перемещения, а затем отмену (**не фиксацию**) этой подготовки. Целью проверки, подготовки и отмены пробного запуска является просмотр всех метаданных в стеке Azure Resource Manager, их анализ (*программным образом или на портале*), а также проверка корректности перемещения всех компонентов и устранение технических неполадок.  Таким образом вы также узнаете о продолжительности перемещения, что позволит вам спланировать время простоя.  Этот этап не вызывает простой в работе пользователя, а значит никаким образом не нарушает использование приложения.
  - Вопросы, приведенные ниже, необходимо разрешить непосредственно перед пробным запуском, хотя даже если их упустить, все необходимые этапы будут выполнены. Во время корпоративного перемещения пробный запуск зарекомендовал себя как безопасное средство, незаменимое при обеспечении готовности миграции.
  - При выполнении подготовки плоскость управления (операции управления Azure) будет заблокирована для всей виртуальной сети, поэтому в процессе проверки, подготовки или отмены вы не сможете изменить метаданные виртуальной машины.  Но кроме этого функции приложения (использование удаленного рабочего стола, виртуальной машины) никак не будут затронуты.  Пользователи виртуальных машин не будут уведомлены о выполнении пробного запуска.

- **Каналы Express Route и VPN.** В настоящее время шлюзы Express Route со ссылками авторизации невозможно перенести без простоев. Обходные пути см. в статье [Перенос каналов ExpressRoute и связанных виртуальных сетей из классической модели развертывания на модель Resource Manager](../../expressroute/expressroute-migration-classic-resource-manager.md).

- **Расширения виртуальной машины.** Расширения виртуальной машины потенциально являются одним из наибольших препятствий для переноса запущенных виртуальных машин. Учтите при планировании, что исправление расширений виртуальных машин может занять несколько дней.  Для передачи состояния расширения виртуальной машины запущенных виртуальных машин требуется работающий агент Azure. Если состояние для запущенной виртуальной машины неудовлетворительное, перемещение будет прервано. Сам агент не является таким уж необходимым для выполнения процесса перемещения, но если на виртуальной машине есть расширения, то для успешного перемещения потребуются как работающий агент, так и исходящее подключение к Интернету (с DNS).
  - Если во время перемещения потеряно подключение к DNS-серверу, все расширения виртуальной машины, кроме BGInfo v1.\*, необходимо удалить из каждой машины до начала подготовки перемещения, а затем после перемещения Azure Resource Manager повторно добавить на виртуальную машину.  **Это необходимо сделать только для запущенных виртуальных машин.**  Если виртуальные машины находятся в состоянии "Остановлено", их расширения удалять не нужно. **Примечание.** Многие расширения, например система диагностики Azure и мониторинг центра безопасности, будут автоматически установлены после перемещения, так что их удаление не представляет проблемы.
  - Кроме того, группы безопасности сети не должны ограничивать исходящий доступ к Интернету, что наблюдается в некоторых конфигурациях. Исходящий доступ к Интернету (и DNS) необходим для перемещения расширений виртуальной машины в модель Azure Resource Manager. 
  - Существуют две версии расширения BGInfo: v1 и v2.  Если виртуальная машина была создана с помощью классического портала или PowerShell, на ней, вероятнее всего, будет установлено одно расширение — v1. Его не нужно удалять, оно будет пропущено (не перемещено) API миграции. Но если классическая виртуальная машина была создана с помощью нового портала Azure, она, вероятно, будет включать версию v2 на основе JSON, которую можно переместить в Azure Resource Manager при наличии работающего агента и исходящего доступа к Интернету (и DNS). 
  - **Способ исправления 1.** Если у виртуальных машин нет исходящего доступа к Интернету, работающей службы DNS и агентов Azure, тогда непосредственно перед подготовкой удалите все расширения виртуальной машины как часть процесса перемещения, а затем после его завершения повторно установите их. 
  - **Способ исправления 2.** Если расширения виртуальной машины слишком большие, можно также завершить работу всех виртуальных машин или отменить их распределение перед перемещением. Переместите освобожденные виртуальные машины, а затем перезапустите их в модели Azure Resource Manager. Преимущество здесь заключается в том, что расширения виртуальных машин переместятся. Недостатком же является то, что все общедоступные виртуальные IP-адреса будут потеряны, работа виртуальных машин завершится, что заметным образом скажется на запущенных приложениях.

    > [!NOTE] 
    > Если политика центра безопасности Azure не предусматривает перемещение запущенных виртуальных машин, перед удалением расширений ее необходимо остановить. В противном случае удаленное расширение мониторинга безопасности автоматически будет повторно установлено на виртуальной машине.
  
- **Группы доступности.** Чтобы переместить виртуальную сеть в Azure Resource Manager, все виртуальные машины, которые включает классическое развертывание (например, облачная служба), должны либо находиться в одной группе доступности, либо не принадлежать ни к одной из групп. Azure Resource Manager не поддерживает наличие нескольких групп доступности в облачной службе, и это приведет к прерыванию перемещения.  Как было сказано выше, в группе доступности должны находиться либо все виртуальные машины, либо ни одной. Чтобы устранить эту проблему, необходимо реорганизовать облачную службу или же исправить неполадки.  Это может занять некоторое время, что следует учесть при планировании. 

- **Развертывания веб-ролей и рабочих ролей.** Облачные службы, содержащие веб- и рабочие роли, невозможно переместить в Azure Resource Manager. Их необходимо удалить из виртуальной сети до начала перемещения.  Стандартным решением является обычное перемещение экземпляров веб- и рабочих ролей в отдельную классическую виртуальную сеть, которая также связана с каналом ExpressRoute. Или же можно переместить код в более новые службы приложений PaaS (что не является разделом обсуждения в этом руководстве). Как и в предыдущем случае повторного развертывания, вам необходимо создать новую классическую виртуальную сеть, переместить и повторно развернуть веб- или рабочие роли в эту новую сеть, а затем удалить из нее перемещенные развертывания. Не требует изменения кода. Вы можете использовать новую функцию [пиринга между виртуальными сетями](../../virtual-network/virtual-network-peering-overview.md), чтобы установить пиринг между классической виртуальной сетью, содержащей веб- и рабочие роли, и другими виртуальными сетями в одном регионе Azure (например, перемещенной виртуальной сетью **после ее перемещения, так как пиринговые виртуальные сети переместить нельзя**). Это не повлияет на возможности и не приведет к потере производительности или штрафам по задержке и пропускной способности. С помощью [пиринга между виртуальными сетями](../../virtual-network/virtual-network-peering-overview.md) теперь можно избежать проблемы с развертыванием веб- и рабочих ролей и не блокировать перемещение в Azure Resource Manager.

- **Квоты Azure Resource Manager.** У регионов Azure есть отдельные квоты и ограничения для классической модели и модели Azure Resource Manager. Несмотря на то, что в сценарии перемещения мы не используем новое оборудование (*мы переключаем существующие виртуальные машины из классической модели в модель Azure Resource Manager*), квоты Azure Resource Manager все равно должны выполняться, чтобы можно было начать перемещение. Основные ограничения, вызывающие проблемы, приведены ниже.  Откройте запрос в службу поддержки квоты, чтобы создать ограничения. 

    > [!NOTE]
    > Эти ограничения нужно создать в том же регионе, куда будет перемещена текущая среда.
    >

    - Сетевые интерфейсы
    - Балансировщики нагрузки
    - Общедоступные IP-адреса
    - Статические общедоступные IP-адреса
    - Ядра
    - группы сетевой безопасности;
    - таблицы маршрутов;

    Используйте команды ниже с помощью последней версии Azure PowerShell, чтобы проверить текущие квоты Azure Resource Manager.

    **Вычисления** *(ядра, группы доступности)*

    ```powershell
    Get-AzureRmVMUsage -Location <azure-region>
    ```

    **Сети** *(виртуальные сети, статические общедоступные IP-адреса, общедоступные IP-адреса, группы безопасности сети, сетевые интерфейсы, балансировщики нагрузки, таблицы маршрутов)*
    
    ```powershell
    Get-AzureRmUsage /subscriptions/<subscription-id>/providers/Microsoft.Network/locations/<azure-region> -ApiVersion 2016-03-30 | Format-Table
    ```

    **Хранилище** *(учетная запись хранения)*
    
    ```powershell
    Get-AzureRmStorageUsage
    ```

- **Ограничения регулирования API Azure Resource Manager**. Если среда достаточно большая (например,  > 400 виртуальных машин в виртуальной сети), вы можете достигнуть ограничения регулирования по умолчанию API для операций записи (в этом случае до `1200 writes/hour`) в Azure Resource Manager. Перед началом перемещения создайте запрос в службу поддержки, чтобы увеличить это ограничение для подписки.


- **Состояние виртуальной машины "Превышено время ожидания подготовки"**. Если любая виртуальная машина имеет состояние `provisioning timed out`, это необходимо исправить до начала перемещения. Единственный способ — это использовать режим простоя. Необходимо отозвать процесс подготовки виртуальной машины или повторно запустить его (удалить машину, сохранить диск и снова создать виртуальную машину). 

- **Состояние виртуальной машины RoleStateUnknown**. Если перемещение прерывается из-за ошибки `role state unknown`, выполните анализ машины с помощью портала и убедитесь, что она исправна. Обычно через несколько минут такая ошибка самоустраняется (не нужны никакие дополнительные действия). Это ошибка переходного типа, которая происходит во время таких операций виртуальной машины, как `start`, `stop` и `restart`. **Рекомендуется:** возобновите перемещение через несколько минут. 

- **Кластер Fabric не существует.** В некоторых случаях определенные виртуальные машины нельзя переместить из-за нетипичных причин. Например, если виртуальная машина была создана недавно (неделю назад или около того), а затем перемещена в кластер Azure, который еще не подготовлен для рабочих нагрузок Azure Resource Manager.  В таком случае вы получите ошибку `fabric cluster does not exist`, и перемещение виртуальной машины станет невозможным. Обычно эту ошибку удается устранить в течение нескольких дней, когда для кластера будет включена поддержка Azure Resource Manager. Самый быстрый обходной путь — выполнить операцию `stop-deallocate` для виртуальной машины, затем продолжить перемещение, а после его завершения выполнить резервное копирование виртуальной машины в Azure Resource Manager.

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

- Не прибегайте к сокращенным путям и не пропускайте проверку, подготовку, отмену перемещений пробного запуска.
- Большинство (если не все) потенциальных проблем возникают в процессе проверки, подготовки и отмены.

## <a name="migration"></a>Миграция

### <a name="technical-considerations-and-tradeoffs"></a>Технические вопросы и компромиссы

Так как вы ознакомились с известными проблемами в среде, вы готовы к выполнению перемещения.

Для выполнения фактических перемещений вам необходимо учесть следующие рекомендации:

1. Планируйте перемещение виртуальных сетей (с учетом минимальных единиц перемещения) в порядке приоритета.  Мы рекомендуем начать с простых виртуальных сетей, постепенно подключая более сложные.
2. У большинства клиентов будут нерабочие и рабочие среды.  Запланируйте перемещение рабочей среды в последнюю очередь.
3. **(Необязательно.)** Спланируйте время планового обслуживания, оставив достаточно места в буфере на случай непредвиденных ошибок.
4. Обращайтесь к службам поддержки и принимайте во внимание рекомендации в случае проблем.

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

Технические рекомендации, описанные в разделе о лабораторных испытаниях, необходимо рассмотреть и выполнить до выполнения фактического перемещения.  С помощью соответствующей проверки можно выполнить перемещение без непредвиденных событий.  В рабочих средах рекомендуется наличие дополнительной поддержки, например доверенного партнера корпорации Майкрософт или служб Microsoft Premier.

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

Неполная проверка может вызвать проблемы и задержку перемещения.  

## <a name="beyond-migration"></a>Перемещение и другие вопросы

### <a name="technical-considerations-and-tradeoffs"></a>Технические вопросы и компромиссы

Теперь, когда вы переместились в Azure Resource Manager, разверните платформу.  Сведения о дополнительных преимуществах см. в статье [обзора Azure Resource Manager](../../azure-resource-manager/resource-group-overview.md).

Необходимо учитывать следующие факторы:

- Объединение миграции с другими действиями.  Большинство пользователей используют окно обслуживания приложений.  В таком случае вы можете использовать простой, чтобы включить другие возможности Azure Resource Manager, например шифрование и перемещение на управляемые диски.
- Пересмотрите технические и деловые соображения для Azure Resource Manager. Включите дополнительные службы, доступные только в Azure Resource Manager, которые применимы к вашей среде.
- Модернизируйте среду с помощью служб PaaS.

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

Включайте только необходимые службы в Azure Resource Manager.  Ниже приведены службы, которыми ограничивается большинство клиентов.

- [Управление доступом на основе ролей.](../../azure-resource-manager/resource-group-overview.md#access-control)
- [Шаблоны Azure Resource Manager для быстрого и контролируемого развертывания.](../../azure-resource-manager/resource-group-overview.md#template-deployment)
- [Теги](../../azure-resource-manager/resource-group-using-tags.md).
- [Управление действиями.](../../azure-resource-manager/resource-group-audit.md)
- [Политики ресурсов.](../../azure-resource-manager/resource-manager-policy.md)

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

Не забывайте об основной цели перемещения ресурсов из классической модели в модель Azure Resource Manager.  Каковы были исходные деловые соображения? Достигли ли вы этих целей?


## <a name="next-steps"></a>Дальнейшие действия

* [Platform-supported migration of IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Поддерживаемый платформой перенос ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Техническое руководство по поддерживаемому платформой переносу из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-deep-dive.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью Azure PowerShell](migration-classic-resource-manager-ps.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью интерфейса командной строки Azure](../linux/migration-classic-resource-manager-cli.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Community tools to migrate IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-community-tools.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Инструменты сообщества для перемещения ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Распространенные ошибки миграции](migration-classic-resource-manager-errors.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Frequently asked questions about classic to Azure Resource Manager migration](migration-classic-resource-manager-faq.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Часто задаваемые вопросы о перемещении ресурсов из классической модели в модель Azure Resource Manager)

