---
title: "Устранение неполадок с подключенными VHD на виртуальных машинах Windows в Azure | Документация Майкрософт"
description: "Как устранять такие неполадки, как непредвиденные перезагрузки виртуальных машин Windows или проблемы с удалением учетной записи хранения с подключенными VHD"
keywords: "отклонение SSH-подключения, ошибка SSH, Azure SSH, ошибка SSH-подключения"
services: virtual-machines-windows
author: iainfoulds
manager: jeconnoc
tags: top-support-issue,azure-service-management,azure-resource-manager
ms.service: virtual-machines-windows
ms.tgt_pltfrm: vm-windows
ms.topic: article
ms.date: 02/28/2018
ms.author: iainfou
ms.openlocfilehash: b4f3382a070894647aa4294fc5b0b63c98eddaab
ms.sourcegitcommit: 782d5955e1bec50a17d9366a8e2bf583559dca9e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2018
---
# <a name="troubleshoot-attached-vhds-on-azure-windows-virtual-machines"></a>Устранение неполадок с подключенными VHD на виртуальных машинах Windows в Azure

В виртуальных машинах Azure для диска операционной системы и всех подключенных дисков данных используются виртуальные жесткие диски (VHD). VHD хранятся в одной или нескольких учетных записях хранения Azure как страничные BLOB-объекты. В этой статье описаны способы устранения распространенных неполадок с VHD: 

  * [непредвиденные перезагрузки виртуальных машин с подключенными VHD];
  * [ошибки удаления хранилища в развертывании Resource Manager].

## <a name="you-are-experiencing-unexpected-reboots"></a>Непредвиденные перезагрузки виртуальных машин с подключенными VHD

Если к виртуальной машине Azure подключено большое число виртуальных жестких дисков, относящихся к одной учетной записи хранения, целевые показатели масштабируемости для этой учетной записи могут быть превышены. Это приводит к сбою виртуальной машины. Проверьте поминутные метрики для учетной записи хранения (**TotalRequests**/**TotalIngress**/**TotalEgress**) на наличие пиковых скачков с превышением целевых показателей для учетной записи. Чтобы определить, производилось ли регулирование для учетной записи хранения, см. раздел "[Метрики показывают увеличение значения PercentThrottlingError]".

Как правило, каждая отдельная операция ввода или вывода, выполняемая виртуальной машиной с виртуальным жестким диском, преобразуется в операцию **Get Page** или **Put Page** на уровне базового страничного BLOB-объекта. Поэтому вы можете использовать предполагаемое число операций ввода-вывода в секунду, установленное для среды, для корректировки допустимого числа виртуальных жестких дисков в одной учетной записи хранения в соответствии с особенностями функционирования приложения. Корпорация Майкрософт рекомендует использовать в одной учетной записи хранения не более 40 дисков. Дополнительные сведения о текущих целевых показателях масштабируемости для учетных записей хранения, в частности об общей скорости выполнения запросов и общей пропускной способности для используемого типа учетной записи хранения, см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](../../storage/common/storage-scalability-targets.md).

Если целевые показатели масштабируемости для учетной записи хранения превышены, распределите виртуальные жесткие диски между несколькими учетными записями хранения, чтобы снизить интенсивность использования каждой из них.

## <a name="storage-delete-errors-in-rm"></a>Ошибки удаления хранилища в развертывании Resource Manager

В этом разделе содержатся рекомендации по устранению неполадок при возникновении одной из указанных ниже ошибок во время попытки удаления учетной записи хранения, контейнера или большого двоичного объекта Azure в развертывании Azure Resource Manager.

>**Не удалось удалить учетную запись хранения "имя_учетной_записи_хранения". Ошибка: "Не удается удалить учетную запись хранения, так как ее артефакты используются".**

>**Не удалось удалить # из # контейнеров.<br> Виртуальные жесткие диски: сейчас контейнер находится в аренде, и в запросе не указан идентификатор аренды.**

>**Не удалось удалить # из # больших двоичных объектов.<br> BlobName.vhd: сейчас большой двоичный объект находится в аренде, и в запросе не указан идентификатор аренды.**

Виртуальные жесткие диски, используемые на виртуальных машинах Azure, — это VHD-файлы, хранящиеся как страничные BLOB-объекты в учетной записи хранения Azure (цен. категория "Стандартный" или "Премиум").  Дополнительные сведения о дисках Azure см. [здесь](../../virtual-machines/windows/about-disks-and-vhds.md). Среда Azure предотвращает удаление диска, подключенного к виртуальной машине, чтобы избежать повреждения. Она также препятствует удалению контейнеров и учетных записей хранения, содержащих страничный BLOB-объект, который подключен к виртуальной машине. 

Процесс удаления учетной записи хранения, контейнера или большого двоичного объекта при возникновении одной из упомянутых выше ошибок: 
1. [Определите большие двоичные объекты, присоединенные к виртуальной машине.](#step-1-identify-blobs-attached-to-a-vm)
2. [Удалите виртуальные машины с подключенным **диском ОС.**](#step-2-delete-vm-to-detach-os-disk)
3. [Отключите все **диски с данными** на оставшихся виртуальных машинах.](#step-3-detach-data-disk-from-the-vm)

Повторите попытку удаления учетной записи хранения контейнера или большого двоичного объекта после выполнения этих действий.

### <a name="step-1-identify-blob-attached-to-a-vm"></a>Шаг 1. Определение больших двоичных объектов, присоединенных к виртуальной машине

#### <a name="scenario-1-deleting-a-blob--identify-attached-vm"></a>Сценарий 1. Удаление большого двоичного объекта и определение подключенной виртуальной машины
1. Войдите на [портале Azure](https://portal.azure.com).
2. В главном меню выберите **Все ресурсы**. Перейдите к учетной записи хранения в разделе **Служба BLOB-объектов**, выберите **Контейнеры** и перейдите к большому двоичному объекту, который необходимо удалить.
3. Если **состояние аренды** большого двоичного объекта — **В аренде**, щелкните правой кнопкой мыши и выберите **Изменить метаданные**, чтобы открыть панель метаданных большого двоичного объекта. 

    ![Снимок экрана портала с учетной записью хранения больших двоичных объектов и выделенным действием "Изменить метаданные"](./media/troubleshoot-vhds/utd-edit-metadata-sm.png)

4. На панели метаданных большого двоичного объекта проверьте и запишите значение для **MicrosoftAzureCompute_VMName**. Это значение является именем виртуальной машины, к которой подключен виртуальный жесткий диск. (Если этого поля нет, см. раздел **Важно**.)
5. На панели метаданных большого двоичного объекта проверьте и запишите значение **MicrosoftAzureCompute_DiskType**. Это значение определяет, какой диск подключен: диск операционной системы или диск с данными. (Если этого поля нет, см. раздел **Важно**.) 

     ![Снимок экрана портала с открытой панелью хранилища Blob Metadata (Метаданные больших двоичных объектов)](./media/troubleshoot-vhds/utd-blob-metadata-sm.png)

6. Если тип диска большого двоичного объекта — **OSDisk**, выполните указания из раздела [Шаг 2. Удаление виртуальной машины для отключения диска ОС](#step-2-delete-vm-to-detach-os-disk). Если тип диска большого двоичного объекта — **DataDisk**, следуйте инструкциям в разделе [Шаг 3. Отключение диска с данными от виртуальной машины](#step-3-detach-data-disk-from-the-vm). 

> [!IMPORTANT]
> Если **MicrosoftAzureCompute_VMName** и **MicrosoftAzureCompute_DiskType** не отображаются в метаданных большого двоичного объекта, большой двоичный объект арендован и не подключен к виртуальной машине. Невозможно удалить арендованный большой двоичных объект, не прервав аренду. Чтобы прервать аренду, щелкните большой двоичный объект правой кнопкой мыши и выберите **Прервать аренду**. Аренда больших двоичных объектов, не подключенных к виртуальной машине, предотвращает удаление большого двоичного объекта, но не удаление контейнера или учетной записи хранения.

#### <a name="scenario-2-deleting-a-container---identify-all-blobs-within-container-that-are-attached-to-vms"></a>Сценарий 2. Удаление контейнера и определение всех больших двоичных объектов, подключенных к виртуальным машинам, внутри контейнера
1. Войдите на [портале Azure](https://portal.azure.com).
2. В главном меню выберите **Все ресурсы**. Перейдите к учетной записи хранения в разделе **Служба BLOB-объектов**, выберите **Контейнеры** и найдите контейнер, который нужно удалить.
3. Щелкните, чтобы открыть контейнер, и появится список больших двоичных объектов, находящихся внутри него. Определите из этого списка все большие двоичные объекты с типом больших двоичных объектов **Страничный BLOB-объект** и состоянием аренды **В аренде**. Выполните [сценарий 1](#step-1-identify-blobs-attached-to-a-vm), чтобы идентифицировать виртуальную машину, связанную с каждым из этих больших двоичных объектов.

    ![Снимок экрана портала с большими двоичными объектами учетной записи хранения и выделенным состоянием аренды "В аренде"](./media/troubleshoot-vhds/utd-disks-sm.png)

4. Выполните [Шаг 2](#step-2-delete-vm-to-detach-os-disk) и [Шаг 3](#step-3-detach-data-disk-from-the-vm), чтобы удалить виртуальные машины с **OSDisk** и отсоединить **DataDisk**. 

#### <a name="scenario-3-deleting-storage-account---identify-all-blobs-within-storage-account-that-are-attached-to-vms"></a>Сценарий 3. Удаление учетной записи хранения и определение всех подключенных к виртуальным машинам больших двоичных объектов в учетной записи хранения
1. Войдите на [портале Azure](https://portal.azure.com).
2. В главном меню выберите **Все ресурсы**. Перейдите к учетной записи хранения в разделе **Blob Service** (Служба больших двоичных объектов), выберите **Контейнеры**.

    ![Снимок экрана портала с контейнерами учетной записи хранения и выделенным состоянием аренды "В аренде"](./media/troubleshoot-vhds/utd-containers-sm.png)

3. В области **Контейнеры** найдите все контейнеры, у которых **состояние аренды** соответствует значению **В аренде**, и выполните действия из [сценария 2](#scenario-2-deleting-a-container---identify-all-blobs-within-container-that-are-attached-to-vms) для каждого **арендованного** контейнера.
4. Выполните [Шаг 2](#step-2-delete-vm-to-detach-os-disk) и [Шаг 3](#step-3-detach-data-disk-from-the-vm), чтобы удалить виртуальные машины с **OSDisk** и отсоединить **DataDisk**. 

### <a name="step-2-delete-vm-to-detach-os-disk"></a>Шаг 2. Удаление виртуальной машины для отключения диска ОС
Если виртуальный жесткий диск (VHD) является диском ОС, необходимо удалить виртуальную машину перед удалением подключенного VHD. Для дисков данных, подключенных к одной виртуальной машине, после выполнения следующих действий не потребуется дополнительных действий:

1. Войдите на [портале Azure](https://portal.azure.com).
2. В главном меню выберите **Виртуальные машины**.
3. Выберите виртуальную машину, к которой подключен виртуальный жесткий диск.
4. Убедитесь, что виртуальная машина больше не используется и в ней нет необходимости.
5. В верхней части области **сведений о виртуальной машине** выберите **Удалить**, а затем нажмите кнопку **Да**, чтобы подтвердить действие.
6. После этого виртуальная машина будет удалена, но виртуальный жесткий диск останется. Однако он выйдет из состояния аренды и отключится от виртуальной машины. Освобождение от аренды может занять несколько минут. Чтобы убедиться, что освобождение от аренды выполнено, перейдите в расположение большого двоичного объекта и на панели **свойств больших двоичных объектов** **состояние аренды** должно быть **Доступно**.

### <a name="step-3-detach-data-disk-from-the-vm"></a>Шаг 3. Отключение диска данных от виртуальной машины
Если виртуальный жесткий диск является диском данных, чтобы удалить аренду, отсоедините его от виртуальной машины.

1. Войдите на [портале Azure](https://portal.azure.com).
2. В главном меню выберите **Виртуальные машины**.
3. Выберите виртуальную машину, к которой подключен виртуальный жесткий диск.
4. В области **сведений о виртуальной машине** выберите **Диски**.
5. Выберите диск данных, к которому подключен виртуальный жесткий диск и который необходимо удалить. Большой двоичный объект, присоединенный к диску данных, можно определить, просмотрев URL-адрес виртуального жесткого диска.
6. Расположение большого двоичного объекта можно проверить, щелкнув диск, чтобы проверить путь в поле **URI VHD**.
7. В верхней части области **Диски** выберите **Изменить**.
8. Щелкните **значок отключения** диска данных, который необходимо удалить.

     ![Снимок экрана портала с открытой панелью хранилища Blob Metadata (Метаданные больших двоичных объектов)](./media/troubleshoot-vhds/utd-vm-disks-edit.png)

9. Щелкните **Сохранить**. Теперь диск отключен от виртуальной машины и больше не арендуется. Освобождение от аренды может занять несколько минут. Чтобы убедиться, что освобождение от аренды выполнено, перейдите в расположение большого двоичного объекта и на панели **свойств больших двоичных объектов** **состояние аренды** должно быть **Разблокировано** или **Доступно**.

[непредвиденные перезагрузки виртуальных машин с подключенными VHD]: #you-are-experiencing-unexpected-reboots
[ошибки удаления хранилища в развертывании Resource Manager]: #storage-delete-errors-in-rm