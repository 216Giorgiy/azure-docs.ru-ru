---
title: Выполнение сценариев PowerShell в виртуальной машине Windows Azure
description: В этом разделе описывается выполнение сценариев PowerShell в виртуальной машине Windows Azure с помощью команды "Выполнить"
services: automation
ms.service: automation
author: georgewallace
ms.author: gwallace
ms.date: 06/06/2018
ms.topic: article
manager: carmonm
ms.openlocfilehash: a2a1c916543da07f25b2b9727e309709632afe00
ms.sourcegitcommit: 1b8665f1fff36a13af0cbc4c399c16f62e9884f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "35267277"
---
# <a name="run-powershell-scripts-in-your-windows-vm-with-run-command"></a>Выполнение сценариев PowerShell в виртуальной машине Windows с помощью команды "Выполнить"

Команда "Выполнить" использует агент ВМ для выполнения сценариев PowerShell в виртуальной машине Windows Azure. Эти сценарии можно использовать для общих компьютеров или управления приложениями, также их можно использовать для быстрой диагностики и устранения проблем доступа и сети виртуальной машины и получить ее рабочее состояние.

## <a name="benefits"></a>Преимущества

Существует несколько вариантов, которые можно использовать для доступа к виртуальным машинам. Команда запуска может удаленно выполнять сценарии на виртуальных машинах с помощью их агента. Команда запуска может использоваться на портале Microsoft Azure, [REST API](/rest/api/compute/virtual%20machines%20run%20commands/runcommand), [Azure CLI](/cli/azure/vm/run-command?view=azure-cli-latest#az-vm-run-command-invoke) или [PowerShell](/powershell/module/azurerm.compute/invoke-azurermvmruncommand).

Эта возможность удобна во всех сценариях, где необходимо выполнить сценарии на виртуальных машинах, и является одним из способов для диагностики и устранения виртуальной машины, у которой нет RDP или открытого порта SSH из-за неправильной сети или административной конфигурации пользователя.

## <a name="restrictions"></a>Ограничения

При использовании команды "Выполнить" следует принимать во внимание перечисленные ниже ограничения.

* Выводятся только последние 4 096 байт.
* Минимальное время выполнения сценария составляет около 20 секунд.
* Сценарии выполняются как системные в Windows.
* Два сценария не могут выполняться одновременно
* Вы не можете отменить выполнение сценария
* Максимальное время выполнения сценария составляет 90 минут, после чего он выдаст ошибку времени ожидания

## <a name="run-a-command"></a>Запуск команды

Перейдите к виртуальной машине в [Azure](https://portal.azure.com) и выберите **Запуск команды** под **ОПЕРАЦИИ**. Появится список доступных команд, выполняемых на виртуальной машине.

![Список команд запуска](./media/run-command/run-command-list.png)

Выберите команду для запуска. Некоторые команды могут иметь необязательные или требуемые входные параметры. Параметры для этих команд представлены в виде текстовых полей для ввода входных значений. В каждой команде можно развернуть **Просмотреть сценарий**, чтобы просмотреть выполняемый сценарий. Команда **RunPowerShellScript** отличается от других команд тем, что она позволяет использовать пользовательские сценарии.

> [!NOTE]
> Встроенные команды не редактируются.

После выбора команды щелкните **Запуск** для выполнения сценария. Сценарий выполняется и по завершении выдает сообщения и возможные ошибки в окне вывода. На следующем рисунке показан пример сообщения после запуска команды **RDPSettings**.

![Вывод сценария команды запуска](./media/run-command/run-command-script-output.png)

## <a name="commands"></a>Команды

В таблице ниже представлен список команд, доступных для виртуальных машин Windows. Команда **RunPowerShellScript** может использоваться для выполнения любых сценариев.

|**Имя**|**Описание**|
|---|---|
|**RunPowerShellScript**|Выполняет сценарий PowerShell.|
|**EnableRemotePS**|Настраивает компьютер для удаленного подключения к PowerShell.|
|**EnableAdminAccount**|Проверяет, отключена ли учетная запись локального администратора, если да — включает ее.|
|**IPConfig**| Предоставляет подробные сведения об IP-адресе, маске подсети и шлюзе по умолчанию для каждого адаптера, использующего стек TCP/IP.|
|**RDPSettings**|Проверяет параметры реестра и параметры политики домена. Предлагает действия в рамках политики, если компьютер принадлежит домену, или сбрасывает параметры к значениям по умолчанию.|
|**ResetAccountPassword**| Сбрасывает пароль встроенной учетной записи администратора.|
|**ResetRDPCert**|Удаляет SSL-сертификат, привязанный к прослушивателю RDP, и восстанавливает по умолчанию его защиту. Используйте этот сценарий при появлении проблем с сертификатом.|
|**SetRDPPort**|Задает номер порта по умолчанию или указанный пользователем для подключений удаленного рабочего стола. Включает правило брандмауэра для входящего подключения к порту.|

## <a name="powershell"></a>PowerShell

Ниже приведен пример с использованием командлета [Invoke AzureRmVMRunCommand](/powershell/module/azurerm.compute/invoke-azurermvmruncommand) для выполнения сценария PowerShell на виртуальной машине Azure.

```azurepowershell-interactive
Invoke-AzureRmVMRunCommand -ResourceGroupName '<myResourceGroup>' -Name '<myVMName>' -CommandId 'RunPowerShellScript' -ScriptPath '<pathToScript>' -Parameter @{"arg1" = "var1";"arg2" = "var2"}
```

## <a name="limiting-access-to-run-command"></a>Ограничение доступа к команде запуска

Для перечисления команд запуска или отображения деталей команды требуется разрешение `Microsoft.Compute/locations/runCommands/read`, встроенное в роль [Читатель](../../role-based-access-control/built-in-roles.md#reader) и выше.

Для запуска команды требуется разрешение`Microsoft.Compute/virtualMachines/runCommand/action`, которое имеет роль [Участник](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) и выше.

Можно использовать одну из [встроенных](../../role-based-access-control/built-in-roles.md) ролей или создать [пользовательскую](../../role-based-access-control/custom-roles.md) роль для запуска команды.

## <a name="next-steps"></a>Дополнительная информация

Сведения о других способах удаленного запуска сценариев и команд на виртуальной машине см. в разделе [Выполнение сценариев в виртуальных машинах Windows](run-scripts-in-vm.md).