---
title: Последовательная консоль виртуальной машины Azure | Документация Майкрософт
description: Двунаправленная последовательная консоль виртуальных машин Azure.
services: virtual-machines-windows
documentationcenter: ''
author: harijay
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure-services
ms.date: 10/22/2018
ms.author: harijay
ms.openlocfilehash: 2cde7d2af4dee9e2bd241f0856b8f2d29ccad6ad
ms.sourcegitcommit: 6e09760197a91be564ad60ffd3d6f48a241e083b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2018
ms.locfileid: "50210743"
---
# <a name="virtual-machine-serial-console"></a>Последовательная консоль виртуальной машины


Последовательная консоль виртуальной машины в Azure предоставляет доступ к текстовой консоли для виртуальных машин Windows. Это последовательное подключение к виртуальной машине происходит через последовательный порт COM1, предоставляя доступ к виртуальной машине вне зависимости от состояния, в котором находится сеть или операционная система виртуальной машины. Доступ к последовательной консоли для виртуальной машины в настоящее время возможен только на портале Azure. Он предоставляется только тем пользователям, которые являются участниками виртуальной машины или имеют высшие права доступа к виртуальной машине. 

Чтобы просмотреть документацию по последовательной консоли для виртуальных машин Linux, [щелкните здесь](serial-console-linux.md).

> [!NOTE] 
> Последовательная консоль для виртуальных машин является общедоступной в глобальных регионах Azure. На этом этапе последовательная консоль еще недоступна в облаке Azure для государственных организаций или облаке Azure для Китая.

 

## <a name="prerequisites"></a>Предварительные требования 

* Требуется использовать модель развертывания управления ресурсами. Классические развертывания не поддерживаются. 
* На виртуальной машине ДОЛЖНА быть включена [диагностика загрузки](boot-diagnostics.md). 

    ![](../media/virtual-machines-serial-console/virtual-machine-serial-console-diagnostics-settings.png)

* Учетной записи, использующей последовательную консоль, должна быть присвоена [роль участника](../../role-based-access-control/built-in-roles.md) для виртуальной машины и учетная запись хранения [диагностики загрузки](boot-diagnostics.md). 
* Виртуальная машина, для которой вы входите в последовательную консоль, также должна иметь учетную запись с использованием пароля. Вы можете создать ее с функцией [сброса пароля](https://docs.microsoft.com/azure/virtual-machines/extensions/vmaccess#reset-password) расширения для доступа к виртуальной машине (см. снимок экрана ниже).

    ![](../media/virtual-machines-serial-console/virtual-machine-serial-console-reset-password.png)

## <a name="get-started-with-serial-console"></a>Начало работы с последовательной консолью
Получить доступ к последовательной консоли для виртуальной машины можно только на [портале Azure](https://portal.azure.com). Ниже приведены шаги для получения доступа к последовательной консоли виртуальных машин через портал.

  1. Откройте портал Azure.
  2. В меню слева выберите виртуальные машины.
  3. Щелкните виртуальную машину в списке. Откроется страница обзора для виртуальной машины.
  4. Прокрутите вниз до раздела Support + Troubleshooting (Поддержка + Устранение неполадок) и щелкните параметр "Серийная консоль". Откроется новая область с последовательной консолью, и запустится подключение.

## <a name="enable-serial-console-in-custom-or-older-images"></a>Включение последовательной консоли в пользовательских или старых образах
Новые образы Windows Server в Azure по умолчанию будут оснащены [специальной административной консолью](https://technet.microsoft.com/library/cc787940(v=ws.10).aspx) (SAC). SAC поддерживается в серверных версиях Windows, но не поставляется в клиентских версиях (например, в Windows 10, Windows 8 или Windows 7). 

Для более старых образов Windows Server (созданных до февраля 2018 г.) можно автоматически включить последовательную консоли с помощью функции "Выполнить команду" на портале Azure. Найдите команду с именем EnableEMS на портале Azure.

![](./media/virtual-machines-serial-console/virtual-machine-windows-serial-console-runcommand.png)

Также можно выполнить следующие действия, чтобы вручную включить последовательную консоль для виртуальных машин Windows, созданных до февраля 2018 г. 

1. Подключитесь к виртуальной машине через удаленный рабочий стол Windows.
1. Запустите следующие команды из командной строки с правами администратора. 
    * `bcdedit /ems {current} on`
    * `bcdedit /emssettings EMSPORT:1 EMSBAUDRATE:115200`
1. Для получения доступа к консоли SAC перезагрузите систему.

![](./media/virtual-machines-serial-console/virtual-machine-windows-serial-console-connect.gif)

В случае необходимости SAC можно также включить в автономном режиме.

1. Подключите диск Windows, который необходимо настроить с помощью консоли SAC в качестве диска данных, к имеющейся виртуальной машине. 
1. Запустите следующие команды из командной строки с правами администратора. 
* `bcdedit /store <mountedvolume>\boot\bcd /ems {default} on`
* `bcdedit /store <mountedvolume>\boot\bcd /emssettings EMSPORT:1 EMSBAUDRATE:115200`

### <a name="how-do-i-know-if-sac-is-enabled"></a>Как узнать, доступна ли SAC?

Если [SAC](https://technet.microsoft.com/library/cc787940(v=ws.10).aspx) не включена, последовательная консоль не выведет запрос SAC. В некоторых случаях отображаются сведения о работоспособности виртуальной машины, а в других случаях она будет пустой. Если вы используете образ Windows Server, созданный до февраля 2018 года, консоль SAC, скорее всего, не будет включена.

## <a name="enable-the-windows-boot-menu-in-serial-console"></a>Включение меню загрузки Windows в последовательной консоли 

Если необходимо включить отображение сообщений загрузчика Windows в последовательной консоли, добавьте дополнительные параметры для данных конфигурации загрузки. Дополнительные сведения см. в разделе [BCDEdit/set](https://docs.microsoft.com/windows-hardware/drivers/devtest/bcdedit--set).

1. Подключитесь к виртуальной машине через удаленный рабочий стол Windows.
2. Запустите следующие команды из командной строки с правами администратора. 
* `bcdedit /set {bootmgr} displaybootmenu yes`
* `bcdedit /set {bootmgr} timeout 10`
* `bcdedit /set {bootmgr} bootems yes`
3. Перезагрузите систему, чтобы включить меню загрузки.

> [!NOTE] 
> Время ожидания, установленное для отображения в меню диспетчера загрузки, будет влиять на время загрузки ОС в будущем. Одним пользователям может быть достаточно 10 секунд, чтобы убедиться, что диспетчер загрузки отображается в последовательной консоли, другим же может потребоваться более короткое или длительное время ожидания. Установите необходимое значение времени ожидания.

## <a name="use-serial-console-for-nmi-calls-in-windows-vms"></a>Использование последовательной консоли для вызовов NMI на виртуальных машинах Windows
Немаскируемое прерывание (NMI) предназначено для создания сигнала, который программное обеспечение на виртуальной машине не будет игнорировать. Раньше немаскируемые прерывания использовались для мониторинга аппаратных проблем в системах, требующих определенного времени отклика.  Сегодня программисты и системные администраторы часто используют немаскируемое прерывание в качестве механизма для отладки или устранения неполадок в зависших системах.

Последовательную консоль можно использовать для отправки немаскируемого прерывания на виртуальную машину Azure с помощью значка клавиатуры, показанного ниже в командной строке. Как только немаскируемое прерывание будет запущено, конфигурация виртуальной машины будет контролировать реакцию системы. Windows может быть настроена на аварийное завершение и создание дампа памяти при получении немаскируемого прерывания.

![](../media/virtual-machines-serial-console/virtual-machine-windows-serial-console-nmi.png) <br>

Сведения о настройке Windows для создания аварийного дампа при получении немаскируемого прерывания см. в разделе [How to generate a complete crash dump file or a kernel crash dump file by using an NMI on a Windows-based system](https://support.microsoft.com/en-us/help/927069/how-to-generate-a-complete-crash-dump-file-or-a-kernel-crash-dump-file) (Как создать полный файл аварийного дампа или ядро файла аварийного дампа с использованием немаскируемого прерывания на компьютере с ОС Windows)

## <a name="open-cmd-or-powershell-in-serial-console"></a>Открытие командной строки или Powershell в последовательной консоли

1. Подключитесь к последовательной консоли. Если подключение к последовательной консоли выполнено успешно, вы увидите **SAC>**, как показано на снимке экрана ниже:

    ![Подключение к SAC](./media/virtual-machines-serial-console/virtual-machine-windows-serial-console-connect-sac.png)

3.  Введите `cmd` для создания канала, имеющего экземпляр командной строки. 
4.  Введите `ch -si 1`, чтобы переключиться на канал, в котором выполняется экземпляр командной строки. 
5.  Нажмите клавишу ВВОД и введите учетные данные входа, обладающие правами администратора.
6.  После ввода действительных учетных данных открывается экземпляр командной строки.
7.  Чтобы запустить экземпляр PowerShell, введите `PowerShell` в экземпляре командной строки и нажмите клавишу ВВОД. 

    ![Открытие экземпляра PowerShell](./media/virtual-machines-serial-console/virtual-machine-windows-serial-console-powershell.png)


## <a name="disable-serial-console"></a>Отключение последовательной консоли
По умолчанию доступ к последовательной консоли включен для всех виртуальных машин во всех подписках. Последовательную консоль можно отключить на уровне подписки или на уровне виртуальной машины.

> [!NOTE]       
> Чтобы включить или отключить последовательную консоль для подписки, у вас должно быть разрешение на запись в этой подписке. Это касается ролей администратора или владельца (но не ограничивается ими). У пользовательских ролей также может быть разрешение на запись.

### <a name="subscription-level-disable"></a>Отключение на уровне подписки
Последовательную консоль можно отключить для всей подписки с помощью [вызова REST API отключения консоли](https://aka.ms/disableserialconsoleapi). Вы можете нажать кнопку "Попробовать", доступную на странице документации по API, чтобы отключить и включить последовательную консоль для подписки. Введите свой `subscriptionId`, "default" в поле `default` и щелкните "Выполнить". Команды Azure CLI еще не доступны и будут внедрены позже. Попробуйте вызвать REST API [с помощью этой ссылки](https://aka.ms/disableserialconsoleapi).

![](../media/virtual-machines-serial-console/virtual-machine-serial-console-rest-api-try-it.png)

Кроме того, можно использовать набор команд в Cloud Shell (команды Bash показаны ниже), чтобы отключить, включить и просмотреть отключенное состояние последовательной консоли для подписки. 

* Чтобы получить отключенное состояние последовательной консоли для подписки:
    ```azurecli-interactive
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s | jq .properties
    ```
* Чтобы отключить последовательную консоль для подписки:
    ```azurecli-interactive 
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl -X POST "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default/disableConsole?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s -H "Content-Length: 0"
    ```
* Чтобы включить последовательную консоль для подписки:
    ```azurecli-interactive
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl -X POST "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default/enableConsole?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s -H "Content-Length: 0"
    ```

### <a name="vm-level-disable"></a>Отключение на уровне виртуальной машины
Последовательную консоль можно отключить для конкретных виртуальных машин, отключив параметр диагностики загрузки этой виртуальной машины. Просто отключите диагностику загрузки на портале Azure, и последовательная консоль будет отключена для виртуальной машины.

## <a name="serial-console-security"></a>Безопасность последовательной консоли 

### <a name="access-security"></a>Безопасность доступа 
Доступ к последовательной консоли ограничен кругом пользователей, обладающих на виртуальной машине правами [Участник](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) или более широкими полномочиями доступа к ней. Если клиентам AAD нужна многофакторная идентификация, тогда она потребуется и для доступа к последовательной консоли, так как доступ осуществляется через [портал Azure](https://portal.azure.com).

### <a name="channel-security"></a>Безопасность канала
Все данные, исходящие и поступающие, при пересылке по сети зашифрованы.

### <a name="audit-logs"></a>Журналы аудита
Все сведения о доступе к последовательной консоли записываются в журналы [диагностики загрузки](https://docs.microsoft.com/azure/virtual-machines/linux/boot-diagnostics) на виртуальной машине. Права доступа к этим журналам и на работу с ними принадлежат администратору виртуальной машины Azure.  

>[!CAUTION] 
Так как пароли доступа для консоли не записываются в журнал, если команды, выполняемые в консоли, содержат или выводят пароли, секреты, имена пользователей и любые другие формы персональных данных, они должны записываться в журналы диагностики загрузки виртуальной машины вместе с остальными элементами с видимым текстом. Это является частью реализации функциональности последовательной консоли. Эти журналы являются циклическими, и только пользователи с разрешениями на чтение для учетной записи хранения диагностики имеют к ним доступ. Но мы рекомендуем следовать рекомендации использования удаленного рабочего стола для всего, что может содержать секретные или персональные данные. 

### <a name="concurrent-usage"></a>Одновременное использование
Когда один пользователь подключен к последовательной консоли, а другой пользователь успешно запрашивает доступ к этой же виртуальной машине, первый пользователь будет отключен, а второй пользователь будет подключаться таким способом, как будто первый пользователь вышел из физической консоли, а новый пользователь остался.

>[!CAUTION] 
Это означает, что отключенный пользователь не выходит из системы! Возможность принудительного выхода из системы после отключения (с помощью SIGHUP или похожего механизма) по-прежнему планируется. Для Windows включено автоматическое истечение времени ожидания в SAC, а для Linux можно настроить параметр времени ожидания терминала. 

## <a name="common-scenarios-for-accessing-serial-console"></a>Общие сценарии для доступа к последовательной консоли 
Сценарий          | Действия в последовательной консоли                
:------------------|:-----------------------------------------
Неверные правила брандмауэра | Откройте последовательную консоль и исправьте правила брандмауэра Windows. 
Проверка файловой системы на случай повреждения | Откройте последовательную консоль и восстановите файловую систему. 
Проблемы с конфигурацией RDP | Откройте последовательную консоль и измените параметры. Дополнительные сведения о том, как приступить к работе, см. в разделе [Remote Desktop - Allow access to your PC](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/clients/remote-desktop-allow-access) (Удаленный рабочий стол. Предоставление доступа к ПК).
Сеть блокирует работу системы| Получите доступ к последовательной консоли через портал, чтобы управлять системой. Некоторые сетевые команды см. в разделе [Команды Windows — CMD и PowerShell](serial-console-cmd-ps-commands.md). 
Взаимодействие с загрузчиком | Получите доступ к BCD через последовательную консоль. Чтобы приступить к работе перейдите к разделу [Включение меню загрузки для отображения в последовательной консоли](#enabling-boot-menu-to-show-in-the-serial-console). 

## <a name="accessibility"></a>Возможности доступа
Возможности доступа являются важной задачей для последовательной консоли Azure. С этой целью мы обеспечили доступность последовательной консоли для лиц с нарушениями зрения и слуха, а также для людей, которые не могут использовать мышь.

### <a name="keyboard-navigation"></a>Навигация с помощью клавиатуры
Используйте клавишу `tab` на клавиатуре для навигации по интерфейсу последовательной консоли на портале Aure. Ваше местоположение будет выделено на экране. Чтобы оставить фокус в колонке последовательной консоли, нажмите клавишу `Ctrl + F6` на клавиатуре.

### <a name="use-serial-console-with-a-screen-reader"></a>Использование последовательной консоли с помощью средства чтения экрана
Последовательная консоль поставляется со встроенной поддержкой чтения экрана. Навигация с помощью включенного средства чтения экрана дает возможность чтения текста вслух с помощью выбранной кнопки.

## <a name="errors"></a>Errors
Большинство ошибок носят временный характер и устраняются после повторной попытки подключения. В таблице ниже приведен список ошибок и способы устранения неисправностей.

Ошибка                            |   Устранение 
:---------------------------------|:--------------------------------------------|
Не удалось получить параметры диагностики загрузки для "<VMNAME>". Чтобы использовать последовательную консоль, включите диагностику загрузки для этой виртуальной машины. | Включите [диагностику загрузки](boot-diagnostics.md) для виртуальной машины. 
Виртуальная машина находится в состоянии "Остановлено (освобождено)". Запустите виртуальную машину и повторите попытку подключения к последовательной консоли. | Для доступа к последовательной консоли виртуальная машина должна быть в состоянии "Запущено".
У вас нет нужных разрешений для использования последовательной консоли этой виртуальной машины. Убедитесь в наличии по крайней мере разрешений роли участника виртуальной машины.| Для доступа к последовательной консоли требуются определенные разрешения. Подробные сведения см. в разделе [требований доступа](#prerequisites).
Не удалось определить группу ресурсов для учетной записи хранения диагностики загрузки "<STORAGEACCOUNTNAME>". Убедитесь, что для этой виртуальной машины включена диагностика загрузки и у вас есть доступ к этой учетной записи хранения. | Для доступа к последовательной консоли требуются определенные разрешения. Подробные сведения см. в разделе [требований доступа](#prerequisites).
При доступе к учетной записи хранения для диагностики загрузки виртуальной машины обнаружен ответ "Запрещено". | Убедитесь, что в системе диагностики загрузки нет брандмауэра учетной записи. Для функционирования последовательной консоли требуется доступная учетная запись хранения для диагностики загрузки.
Веб-сокет закрыт или его не удалось открыть. | Может потребоваться добавить `*.console.azure.com` в список разрешений. Более подробный, но более длинный подход заключается в добавлении в список разрешений [диапазонов IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/en-us/download/details.aspx?id=41653), которые изменяются довольно часто.
Отображаются только сведения о работоспособности при подключении к виртуальной машине Windows| Эта ошибка будет отображаться, если специальная административная консоль не была включена для вашего образа Windows. Инструкции о том, как вручную включить специальную административную консоль на виртуальной машине Windows, см. в разделе [Доступ к последовательной консоли в Windows](#access-serial-console-for-windows). Дополнительные сведения можно найти на странице [сигналов работоспособности Windows](https://github.com/Microsoft/azserialconsole/blob/master/Known_Issues/Windows_Health_Info.md).

## <a name="known-issues"></a>Известные проблемы 
Нам известно о некоторых проблемах с последовательной консолью. Ниже приведен список этих проблем и действия по их устранению.

Проблема                             |   Устранение 
:---------------------------------|:--------------------------------------------|
Нажатие клавиши ВВОД после заголовка соединения не отображает запрос на вход | Дополнительные сведения см. на странице, где описывается случай, когда [нажатие клавиши ВВОД не приводит ни к каким результатам](https://github.com/Microsoft/azserialconsole/blob/master/Known_Issues/Hitting_enter_does_nothing.md). Это может произойти, если вы используете пользовательскую виртуальную машину, защищенное устройство или конфигурацию загрузки, из-за чего операционная система Windows не может правильно подключиться к последовательному порту. Кроме того, это произойдет, если вы используете клиентскую виртуальную машину под управлением Windows 10, так как только для виртуальных машин Windows Server настроено включение EMS.
Не удается выполнить ввод в командной строке SAC, если включена отладка ядра | Подключитесь к виртуальной машине по протоколу RDP и выполните `bcdedit /debug {current} off` из командной строки с повышенными привилегиями. Если вы не можете использовать RDP, вместо этого подключите диск ОС к другой виртуальной машине Azure и при подключении сделайте его диском данных с помощью `bcdedit /store <drive letter of data disk>:\boot\bcd /debug <identifier> off`, а затем переключите диск обратно.
Вставка в PowerShell в SAC приводит к возникновению третьего знака, если исходное содержимое имело повторяющийся знак | Возможное решение — вставка фрагмента выгрузки модуля PSReadLine из текущего сеанса. Запустите `Remove-Module PSReadLine`, чтобы выгрузить модуль PSReadLine из текущего сеанса (этот процесс не удалит модуль).
Некоторые введенные с клавиатуры данные создают странные выходные данные SAC (например `[A`, `[3~`) | Еscape-последовательность [VT100](https://aka.ms/vtsequences) не поддерживается в запросе SAC.
Вставка очень длинных строк не работает | Серийная консоль ограничивает длину строк, которые можно вставить в окно терминала, до 2048 знаков. Это позволяет предотвратить перегрузку пропускной способности последовательного порта.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы 

**В. Как отправить отзыв?**

О. Чтобы отправить отзыв как ошибку, перейдите на страницу https://aka.ms/serialconsolefeedback. Кроме того (менее предпочтительно), отправьте отзыв по адресу azserialhelp@microsoft.com или в категории виртуальной машины на сайте http://feedback.azure.com

**В. Поддерживает ли последовательная консоль копирование и вставку?**

О. Да, поддерживает. Чтобы копировать и вставить текст в окно терминала, используйте сочетание клавиш CTRL+SHIFT+C и CTRL+SHIFT+V.

**В. Кто может включить или отключить последовательную консоль в подписке?**

О. Чтобы включить или отключить последовательную консоль на уровне подписки, у вас должно быть разрешение на запись в этой подписке. Разрешение на запись есть у ролей администратора и владельца (но не только). У пользовательских ролей также может быть разрешение на запись.

**В. Кто может получать доступ к последовательной консоли виртуальной машины?**

О. У вас должен быть доступ к виртуальной машине на уровне участника или более привилегированной роли, чтобы получить доступ к последовательной консоли виртуальной машины. 

**В. На последовательной консоли ничего не отображается, что делать?**

О. Возможно, ваш образ неправильно настроен для доступа к последовательной консоли. Дополнительные сведения о настройке образа для включения последовательной консоли см. в разделе [Включение последовательной консоли в пользовательских или старых образах](#enable-serial-console-in-custom-or-older-images).

**В. Доступна ли последовательная консоль для масштабируемых наборов виртуальных машин?**

О. На этом этапе доступ к последовательной консоли для экземпляров масштабируемого набора виртуальных машин не поддерживается.

## <a name="next-steps"></a>Дополнительная информация
* Подробное руководство по командам CMD и PowerShell, которые можно использовать в Windows SAC, см. [здесь](serial-console-cmd-ps-commands.md).
* Последовательная консоль также доступна для виртуальных машин [Linux](serial-console-linux.md).
* См. дополнительные сведения в статье [Устранение неполадок виртуальных машин Windows в Azure с использованием диагностики загрузки](boot-diagnostics.md).