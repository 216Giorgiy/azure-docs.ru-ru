---
title: Последовательная консоль виртуальной машины Azure | Документация Майкрософт
description: Двунаправленная последовательная консоль виртуальных машин Azure.
services: virtual-machines-linux
documentationcenter: ''
author: harijay
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 09/11/2018
ms.author: harijay
ms.openlocfilehash: 642bf03ecef7f6db25c51671635d96ef7baed91a
ms.sourcegitcommit: b7e5bbbabc21df9fe93b4c18cc825920a0ab6fab
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2018
ms.locfileid: "47412032"
---
# <a name="virtual-machine-serial-console"></a>Последовательная консоль виртуальной машины


Последовательная консоль виртуальной машины в Azure предоставляет доступ к текстовой консоли для виртуальных машин Linux. Это последовательное подключение к виртуальной машине происходит через последовательный порт COM1, предоставляя доступ к виртуальной машине вне зависимости от состояния, в котором находится сеть или операционная система виртуальной машины. Доступ к последовательной консоли для виртуальной машины в настоящее время возможен только на портале Azure. Он предоставляется только тем пользователям, которые являются участниками виртуальной машины или имеют высшие права доступа к виртуальной машине. 

Чтобы просмотреть документацию по последовательной консоли для виртуальных Windows, [щелкните здесь](../windows/serial-console.md).

> [!Note] 
> Последовательная консоль для виртуальных машин является общедоступной в глобальных регионах Azure. На этом этапе в последовательной консоли еще недоступно облако Azure для государственных организаций или облако Azure для Китая.


## <a name="prerequisites"></a>Предварительные требования 

* Требуется использовать модель развертывания управления ресурсами. Классические развертывания не поддерживаются. 
* На виртуальной машине необходимо включить [диагностику загрузки](boot-diagnostics.md) (см. снимок экрана ниже).

    ![](./media/virtual-machines-serial-console/virtual-machine-serial-console-diagnostics-settings.png)

* Учетной записи Azure, использующей последовательную консоль, необходимо присвоить [роль участника](../../role-based-access-control/built-in-roles.md) для виртуальной машины и учетной записи хранения [диагностики загрузки](boot-diagnostics.md). 
* Виртуальная машина, для которой вы входите в последовательную консоль, также должна иметь учетную запись с использованием пароля. Вы можете создать ее с функцией [сброса пароля](https://docs.microsoft.com/azure/virtual-machines/extensions/vmaccess#reset-password) расширения для доступа к виртуальной машине (см. снимок экрана ниже).

    ![](./media/virtual-machines-serial-console/virtual-machine-serial-console-reset-password.png)

* Сведения о параметрах, относящихся к дистрибутиву Linux, см. в разделе [Доступ к последовательной консоли для Linux](#Serial-Console-Linux-distro-availability).



## <a name="get-started-with-serial-console"></a>Начало работы с последовательной консолью
Получить доступ к последовательной консоли для виртуальной машины можно только на [портале Azure](https://portal.azure.com). Ниже приведены шаги для получения доступа к последовательной консоли для виртуальных машин на портале. 

  1. Откройте портал Azure.
  1. Добавьте пользователя, который использует аутентификацию имени пользователя или пароля, щелкнув колонку "Сброс пароля". (Пропустите этот шаг, если у виртуальной машины есть пользователь, который использует проверку пароля).
  1. В меню слева выберите виртуальные машины.
  1. Щелкните виртуальную машину в списке. Откроется страница обзора для виртуальной машины.
  1. Прокрутите вниз до раздела Support + Troubleshooting (Поддержка + Устранение неполадок) и щелкните параметр последовательной консоли. Откроется новая область с последовательной консолью, и запустится подключение.

![](./media/virtual-machines-serial-console/virtual-machine-linux-serial-console-connect.gif)

### 

> [!NOTE] 
> Для последовательной консоли требуется локальный пользователь с настроенным паролем. Сейчас на виртуальных машинах, настроенных только с помощью открытого ключа SSH, нельзя войти в последовательную консоль. Чтобы создать локального пользователя с паролем, используйте [расширение доступа к виртуальной машине](https://docs.microsoft.com/azure/virtual-machines/linux/using-vmaccess-extension), доступное на портале при нажатии кнопки "Сброс пароля".
> Кроме того, вы можете сбросить пароль администратора в своей учетной записи [используя GRUB, чтобы перейти в однопользовательской режим](./serial-console-grub-single-user-mode.md).

## <a name="serial-console-linux-distro-availability"></a>Доступность дистрибутива Linux для последовательной консоли
Для правильной работы последовательной консоли гостевая операционная система должна быть настроена для чтения и записи сообщений консоли в последовательный порт. В большинстве [рекомендуемых дистрибутивов Linux Azure](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros) последовательная консоль настроена по умолчанию. Чтобы получить доступ к консоли, достаточно просто щелкнуть раздел "Последовательная консоль" на портале Azure. 

Дистрибутив      | Доступ к последовательной консоли
:-----------|:---------------------
Red Hat Enterprise Linux.    | В образах Red Hat Enterprise Linux, доступных в Azure, доступ к консоли включен по умолчанию. 
CentOS      | В образах CentOS, доступных в Azure, доступ к консоли включен по умолчанию. 
Ubuntu      | В образах Ubuntu, доступных в Azure, доступ к консоли включен по умолчанию.
CoreOS      | В образах CoreOS, доступных в Azure, доступ к консоли включен по умолчанию.
SUSE        | В новых образах SLES, доступных в Azure, доступ к консоли включен по умолчанию. При использовании более старых версий (10 или более ранних) SLES в Azure следуйте указаниям в [статье базы знаний](https://www.novell.com/support/kb/doc.php?id=3456486), чтобы включить последовательную консоль. 
Oracle Linux        | В образах Oracle Linux, доступных в Azure, доступ к консоли включен по умолчанию.
Пользовательские образы Linux     | Чтобы включить последовательную консоль для настраиваемого образа виртуальной машины Linux, активируйте доступ к консоли в каталогу `/etc/inittab` для запуска терминала на устройстве `ttyS0`. Здесь приведен пример добавления нужного кода в файл inittab: `S0:12345:respawn:/sbin/agetty -L 115200 console vt102`. Дополнительные сведения о правильном создании пользовательских образов см. в [этой статье](https://aka.ms/createuploadvhd). Если вы создаете настраиваемое ядро, советуем включить флаги `CONFIG_SERIAL_8250=y` и `CONFIG_MAGIC_SYSRQ_SERIAL=y`. Файл конфигурации для дальнейшего изучения зачастую находится в каталоге /boot/.

## <a name="common-scenarios-for-accessing-serial-console"></a>Общие сценарии для доступа к последовательной консоли 
Сценарий          | Действия в последовательной консоли                
:------------------|:-----------------------------------------
Недопустимый FSTAB-файл | `Enter` ключ, чтобы продолжить и исправить FSTAB-файл в текстовом редакторе. Для этого вам может потребоваться перейти в однопользовательский режим. Чтобы приступить к работе, ознакомьтесь со статьей [Azure Linux VM cannot start because of FSTAB errors](https://support.microsoft.com/help/3206699/azure-linux-vm-cannot-start-because-of-fstab-errors) (Виртуальная машина Linux Azure не запускается из-за ошибок FSTAB) и [Use Serial Console to access GRUB and Single User Mode](serial-console-grub-single-user-mode.md) (Использование последовательной консоли для получения доступа к GRUB и однопользовательскому режиму).
Неверные правила брандмауэра | Откройте последовательную консоль и измените iptables. 
Проверка файловой системы на случай повреждения | Откройте последовательную консоль и восстановите файловую систему. 
Проблемы конфигурации SSH/RDP | Откройте последовательную консоль и измените параметры. 
Сеть блокирует работу системы| Получите доступ к последовательной консоли через портал, чтобы управлять системой. 
Взаимодействие с загрузчиком | Получите доступ к GRUB через последовательную консоль. Чтобы приступить к работе, ознакомьтесь со статьей [Use Serial Console to access GRUB and Single User Mode](serial-console-grub-single-user-mode.md) (Использование последовательной консоли для получения доступа к GRUB и однопользовательскому режиму). 

## <a name="disable-serial-console"></a>Отключение последовательной консоли
По умолчанию доступ к последовательной консоли включен для всех виртуальных машин во всех подписках. Последовательную консоль можно отключить на уровне подписки или на уровне виртуальной машины.

> [!Note] 
> Чтобы включить или отключить последовательную консоль для подписки, у вас должно быть разрешение на запись в этой подписке. Это касается ролей администратора или владельца (но не ограничивается ими). У пользовательских ролей также может быть разрешение на запись.

### <a name="subscription-level-disable"></a>Отключение на уровне подписки
Последовательную консоль можно отключить для всей подписки с помощью [вызова REST API отключения консоли](https://aka.ms/disableserialconsoleapi). Вы можете нажать кнопку "Попробовать", доступную на странице документации по API, чтобы отключить и включить последовательную консоль для подписки. Введите свой `subscriptionId`, "default" в поле `default` и щелкните "Выполнить". Команды Azure CLI еще не доступны и будут внедрены позже. Попробуйте вызвать REST API [с помощью этой ссылки](https://aka.ms/disableserialconsoleapi).

![](./media/virtual-machines-serial-console/virtual-machine-serial-console-rest-api-try-it.png)

Кроме того, можно использовать набор команд в Cloud Shell (команды bash показаны ниже), чтобы отключить, включить и просмотреть отключенное состояние последовательной консоли для подписки. 

* Чтобы получить отключенное состояние последовательной консоли для подписки:
    ```azurecli-interactive
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s | jq .properties
    ```
* Чтобы отключить последовательную консоль для подписки:
    ```azurecli-interactive
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl -X POST "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default/disableConsole?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s -H "Content-Length: 0"
    ```
* Чтобы включить последовательную консоль для подписки:
    ```azurecli-interactive
    $ export ACCESSTOKEN=($(az account get-access-token --output=json | jq .accessToken | tr -d '"')) 

    $ export SUBSCRIPTION_ID=$(az account show --output=json | jq .id -r)

    $ curl -X POST "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.SerialConsole/consoleServices/default/enableConsole?api-version=2018-05-01" -H "Authorization: Bearer $ACCESSTOKEN" -H "Content-Type: application/json" -H "Accept: application/json" -s -H "Content-Length: 0"
    ```

### <a name="vm-level-disable"></a>Отключение на уровне виртуальной машины
Последовательную консоль можно отключить для конкретных виртуальных машин, отключив параметр диагностики загрузки этой виртуальной машины. Просто отключите диагностику загрузки на портале Azure, и последовательная консоль будет отключена для виртуальной машины.

## <a name="serial-console-security"></a>Безопасность последовательной консоли 

### <a name="access-security"></a>Безопасность доступа 
Доступ к последовательной консоли ограничен кругом пользователей, обладающих на виртуальной машине правами [Участник](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) или более широкими полномочиями доступа к ней. Если клиентам AAD нужна многофакторная идентификация, тогда она потребуется и для доступа к последовательной консоли, так как доступ осуществляется через [портал Azure](https://portal.azure.com).

### <a name="channel-security"></a>Безопасность канала
Все данные, исходящие и поступающие, при пересылке по сети зашифрованы.

### <a name="audit-logs"></a>Журналы аудита
Все сведения о доступе к последовательной консоли записываются в журналы [диагностики загрузки](https://docs.microsoft.com/azure/virtual-machines/linux/boot-diagnostics) на виртуальной машине. Права доступа к этим журналам и на работу с ними принадлежат администратору виртуальной машины Azure.  

>[!CAUTION] 
Так как пароли доступа для консоли не записываются в журнал, если команды, выполняемые в консоли, содержат или выводят пароли, секреты, имена пользователей и любые другие формы персональных данных, они должны записываться в журналы диагностики загрузки виртуальной машины вместе с остальными элементами с видимым текстом. Это является частью реализации функциональности последовательной консоли. Эти журналы являются циклическими, и только пользователи с разрешениями на чтение для учетной записи хранения диагностики имеют к ним доступ. Но мы рекомендуем следовать рекомендации использования консоли SSH для всего, что может содержать секретные или персональные данные. 

### <a name="concurrent-usage"></a>Одновременное использование
Когда один пользователь подключен к последовательной консоли, а другой пользователь успешно запрашивает доступ к этой же виртуальной машине, первый пользователь будет отключен, а второй пользователь будет подключаться таким способом, как будто первый пользователь вышел из физической консоли, а новый пользователь остался.

>[!CAUTION] 
Это означает, что отключенный пользователь не выходит из системы! Возможность принудительного выхода из системы после отключения (с помощью SIGHUP или похожего механизма) по-прежнему планируется. Для Windows включено автоматическое истечение времени ожидания в SAC, а для Linux можно настроить параметр времени ожидания терминала. Для этого просто добавьте `export TMOUT=600` в .bash_profile или .profile для пользователя, с помощью которого выполняется вход в консоль, чтобы время ожидания сеанса истекло через 10 минут.

## <a name="accessibility"></a>Возможности доступа
Возможности доступа являются важной задачей для последовательной консоли Azure. С этой целью мы обеспечили доступность последовательной консоли для лиц с нарушениями зрения и слуха, а также для людей, которые не могут использовать мышь.

### <a name="keyboard-navigation"></a>Навигация с помощью клавиатуры
Используйте клавишу `tab` на клавиатуре для навигации по интерфейсу последовательной консоли на портале Aure. Ваше местоположение будет выделено на экране. Чтобы оставить фокус в колонке последовательной консоли, нажмите клавишу `Ctrl + F6` на клавиатуре.

### <a name="use-serial-console-with-a-screen-reader"></a>Использование последовательной консоли с помощью средства чтения экрана
Последовательная консоль поставляется со встроенной поддержкой чтения экрана. Навигация с помощью включенного средства чтения экрана дает возможность чтения текста вслух с помощью выбранной кнопки.

## <a name="errors"></a>Errors
Большинство ошибок носят временный характер, и повторное подключение к последовательной консоли часто устраняет их. В таблице ниже приведен список ошибок и способы устранения неисправностей.

Ошибка                            |   Устранение 
:---------------------------------|:--------------------------------------------|
Не удалось получить параметры диагностики загрузки для "<VMNAME>". Чтобы использовать последовательную консоль, включите диагностику загрузки для этой виртуальной машины. | Включите [диагностику загрузки](boot-diagnostics.md) для виртуальной машины. 
Виртуальная машина находится в состоянии "Остановлено (освобождено)". Запустите виртуальную машину и повторите попытку подключения к последовательной консоли. | Для доступа к последовательной консоли виртуальная машина должна быть в состоянии "Запущено".
У вас нет нужных разрешений для использования последовательной консоли этой виртуальной машины. Убедитесь в наличии по крайней мере разрешений роли участника виртуальной машины.| Для доступа к последовательной консоли требуются определенные разрешения. Подробные сведения см. в разделе [требований доступа](#prerequisites).
Не удалось определить группу ресурсов для учетной записи хранения диагностики загрузки "<STORAGEACCOUNTNAME>". Убедитесь, что для этой виртуальной машины включена диагностика загрузки и у вас есть доступ к этой учетной записи хранения. | Для доступа к последовательной консоли требуются определенные разрешения. Подробные сведения см. в разделе [требований доступа](#prerequisites).
Веб-сокет закрыт или его не удалось открыть. | Может потребоваться добавить `*.console.azure.com` в список разрешений. Более подробный, но более длинный подход заключается в добавлении в список разрешений [диапазонов IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/en-us/download/details.aspx?id=41653), которые изменяются довольно часто.
При доступе к учетной записи хранения для диагностики загрузки виртуальной машины обнаружен ответ "Запрещено". | Убедитесь, что в системе диагностики загрузки нет брандмауэра учетной записи. Для функционирования последовательной консоли требуется доступная учетная запись хранения для диагностики загрузки.

## <a name="known-issues"></a>Известные проблемы 
Нам известно о некоторых проблемах с последовательной консолью. Ниже приведен список этих проблем и действия по их устранению.

Проблема                           |   Устранение 
:---------------------------------|:--------------------------------------------|
Нажатие клавиши ВВОД после заголовка соединения не отображает запрос на вход | Дополнительные сведения см. на странице, где описывается случай, когда [нажатие клавиши ВВОД не приводит ни к каким результатам](https://github.com/Microsoft/azserialconsole/blob/master/Known_Issues/Hitting_enter_does_nothing.md). Это может произойти, если вы используете пользовательскую виртуальную машину, защищенное устройство или конфигурацию GRUB, из-за чего операционная система Linux не может правильно подключиться к последовательному порту.
Текст серийной консоли только занимает часть размера экрана (часто после использования текстового редактора) | Последовательные консоли не поддерживают согласование с размером окна ([RFC 1073](https://www.ietf.org/rfc/rfc1073.txt)). Это означает, что сигнал обновления размера экрана SIGWINCH не отправляется и виртуальная машина не может определить размер окна терминала. Мы рекомендуем установить xterm или другую аналогичную утилиту, которая дает команду "Изменить размер". Команда "Изменить размер" исправит эту проблему.
Вставка очень длинных строк не работает | Последовательная консоль ограничивает длину строк, которые можно вставить в окно терминала, до 2048 знаков. Это позволяет предотвратить перегрузку пропускной способности последовательного порта.


## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы 
**В. Как отправить отзыв?**

О. Чтобы отправить отзыв как ошибку, перейдите на страницу https://aka.ms/serialconsolefeedback. Кроме того, (менее предпочтительно) отправьте отзыв по адресу azserialhelp@microsoft.com или в категории виртуальной машины на сайте http://feedback.azure.com

**В. Поддерживает ли последовательная консоль копирование и вставку?**

О. Да, поддерживает. Чтобы копировать и вставить текст в окно терминала, используйте сочетание клавиш CTRL+SHIFT+C и CTRL+SHIFT+V.

**В. Можно ли использовать последовательную консоль вместо SSH-подключения?**

О. Хотя это может показаться технически возможным, последовательная консоль предназначена для использования в качестве средства устранения неполадок в случаях, когда подключение по протоколу SSH не возможно. Мы не рекомендуем использовать последовательную консоль в качестве замещения SSH по двум причинам.

1. Последовательная консоль не имеет такой пропускной способности как SSH, так как это текстовое соединение, поэтому в последовательной консоли сложнее взаимодействовать с графическим интерфейсом пользователя (GUI).
1. Доступ к серийной консоли в данный момент возможен только по имени пользователя и пароля. Ключи SSH более безопасны, чем комбинации имени пользователя и пароля, поэтому с точки зрения безопасности имени входа рекомендуется запускать SSH через последовательную консоль.

**В. Кто может включить или отключить последовательную консоль в подписке?**

О. Чтобы включить или отключить последовательную консоль на уровне подписки, у вас должно быть разрешение на запись в этой подписке. Разрешение на запись есть у ролей администратора и владельца (но не только). У пользовательских ролей также может быть разрешение на запись.

**В. Кто может получать доступ к последовательной консоли виртуальной машины?**

О. У вас должен быть доступ к виртуальной машине на уровне участника или более привилегированной роли, чтобы получить доступ к последовательной консоли виртуальной машины. 

**В. На последовательной консоли ничего не отображается, что делать?**

О. Возможно, ваш образ неправильно настроен для доступа к последовательной консоли. Дополнительные сведения о настройке образа для включения последовательной консоли см. в разделе [Virtual Machine Serial Console](#Access-Serial-Console-for-Linux) (Последовательная консоль виртуальной машины).

**В. Доступна ли последовательная консоль для масштабируемых наборов виртуальных машин?**

О. На этом этапе доступ к последовательной консоли для экземпляров масштабируемого набора виртуальных машин не поддерживается.

**В. На виртуальной машине настроена только аутентификация с ключом SSH. Можно ли подключаться к ней через последовательную консоль?** О. Да. Последовательная консоль не требует ключей SSH, поэтому все, что вам нужно, — это настроить имя пользователя и пароль. Это можно сделать на портале в колонке "Сброс пароля", а затем с помощью этих учетных данных войти в последовательную консоль.

## <a name="next-steps"></a>Дополнительная информация
* Используйте последовательную консоль для [перехода в режим GRUB и однопользовательский режим](serial-console-grub-single-user-mode.md).
* Используйте последовательную консоль для [вызовов SysRq и NMI](serial-console-nmi-sysrq.md).
* Последовательная консоль также доступна для виртуальных машин [Windows](../windows/serial-console.md).
* См. дополнительные сведения о [диагностике загрузки](boot-diagnostics.md).