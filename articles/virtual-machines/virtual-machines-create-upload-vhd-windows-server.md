<properties 
	pageTitle="Создание и передача виртуального жесткого диска Windows Server в Azure" 
	description="Узнайте, как создать и передать виртуальный жесткий диск с операционной системой Windows Server в Azure." 
	services="virtual-machines" 
	documentationCenter="" 
	authors="KBDAzure" 
	manager="timlt" 
	editor="tysonn"/>

<tags 
	ms.service="virtual-machines" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="vm-windows" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/29/2015" 
	ms.author="kathydav"/>


# Создание и передача виртуального жесткого диска Windows Server в Azure#

В этой статье показано, как передать виртуальный жесткий диск с операционной системой, чтобы использовать его в качестве образа для создания виртуальных машин. Дополнительную информацию о дисках и образах в Microsoft Azure см. в разделе [Диски и образы в Azure](http://msdn.microsoft.com/library/azure/jj672979.aspx).

> [AZURE.NOTE]При создании виртуальной машины на основе образа можно настроить параметры операционной системы, чтобы оптимизировать выполняемые приложения. Заданная конфигурация сохраняется на диске для этой виртуальной машины и не влияет на ее образ.

## Предварительные требования##

В данной статье предполагается, что у вас есть следующее:

1. **Подписка Azure**. Если у вас нет подписки, вы можете [создать учетную запись Azure бесплатно](/pricing/free-trial/?WT.mc_id=A261C142F). Вы получаете кредиты, которые можно использовать для опробования платных служб Azure, и даже после израсходования кредитов вы сохраняете учетную запись и возможность использовать бесплатные службы Azure, такие как веб-сайты. С вашей кредитной карты не будет взиматься плата, если вы явно не измените параметры и не попросите снимать плату. Вы также можете [активировать преимущества подписчика MSDN](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F). Ваша подписка MSDN каждый месяц приносит вам кредиты, которые можно использовать для оплаты служб Azure.   

2. **Microsoft Azure PowerShell**. У вас уже установлен и настроен на использование подписки модуль Microsoft Azure PowerShell. Информацию о скачивании модуля см. в разделе [Загрузки Microsoft Azure](http://azure.microsoft.com/downloads/). Учебник по установке и настройке этого модуля см. [здесь](../powershell-install-configure.md). Для отправки файла виртуального жесткого диска используйте командлет [Add-AzureVHD](http://msdn.microsoft.com/library/azure/dn495173.aspx).

3. **Поддерживаемая операционная система хранится в файле VHD**. Вы установили поддерживаемую операционную систему Windows Server на виртуальный жесткий диск. Существует несколько средств для создания VHD-файлов. Для создания виртуальной машины и установки операционной системы можно использовать решение для виртуализации, например Hyper-V. Инструкции см. в разделе [Установка роли Hyper-V и настройка виртуальной машины](http://technet.microsoft.com/library/hh846766.aspx).

> [AZURE.NOTE]Формат VHDX не поддерживается в Microsoft Azure. Можно преобразовать диск в формат VHD с помощью диспетчера Hyper-V или командлета [Convert-VHD](http://technet.microsoft.com/library/hh848454.aspx). Учебник по этому действию можно найти [здесь](http://blogs.msdn.com/b/virtual_pc_guy/archive/2012/10/03/using-powershell-to-convert-a-vhd-to-a-vhdx.aspx).
 
 Поддерживаются следующие версии Windows Server: <P> <TABLE BORDER="1" WIDTH="600"> <TR BGCOLOR="#E9E7E7"> <TH>ОС</TH> <TH>SKU</TH> <TH>Пакет обновления</TH> <TH>Архитектура</TH> </TR> <TR> <TD>Windows Server 2012 R2</TD> <TD>Все выпуски</TD> <TD>Недоступен</TD> <TD>x64</TD> </TR> <TR> <TD>Windows Server 2012</TD> <TD>Все выпуски</TD> <TD>Недоступен</TD> <TD>x64</TD> </TR> <TR> <TD>Windows Server 2008 R2</TD> <TD>Все выпуски</TD> <TD>SP1</TD> <TD>x64</TD> </TR> </TABLE> </P>


Эта задача включает следующие шаги:

- [Шаг 1. Подготовка образа для передачи][]
- [Шаг 2. Создание учетной записи хранения в Azure][]
- [Шаг 3. Подготовка подключения к Azure][]
- [Шаг 4. Загрузка VHD-файла][]

## Шаг 1. Подготовка образа для передачи ##

Перед отправкой образа в Azure необходимо сделать его универсальным с помощью команды Sysprep. Дополнительные сведения о команде Sysprep см. в статье [Как использовать команду Sysprep: введение](http://technet.microsoft.com/library/bb457073.aspx).

В виртуальной машине, в которую была установлена операционная система, сделайте следующее:

1. Войдите в операционную систему.

2. Откройте окно командной строки с правами администратора. Измените каталог на **%windir%\\system32\\sysprep** и запустите файл `sysprep.exe`.

	![Откройте окно командной строки](./media/virtual-machines-create-upload-vhd-windows-server/sysprep_commandprompt.png)

3.	Откроется диалоговое окно **Программа подготовки системы**.

	![Запустите Sysprep](./media/virtual-machines-create-upload-vhd-windows-server/sysprepgeneral.png)

4.  В разделе **Программа подготовки системы** выберите **Запуск при первом включении компьютера (OOBE)** и убедитесь, что установлен флажок «Обобщить».

5.  В разделе **Параметры завершения работы** выберите **Завершение работы**.

6.  Нажмите кнопку **ОК**.


## Шаг 2. Создание учетной записи хранения в Azure ##

Для загрузки файла VHD, который можно использовать в Azure для создания виртуальной машины, потребуется учетная запись хранения в Azure. Для создания учетной записи хранения можно использовать портал управления Azure.

1. Войдите на портал управления Azure.

2. На панели команд нажмите **Создать**.

3. Последовательно выберите **Службы данных** > **Хранилище** > **Быстрое создание**.

	![Быстрое создание учетной записи хранения](./media/virtual-machines-create-upload-vhd-windows-server/Storage-quick-create.png)

4. Заполните поля, как показано ниже:
	
	- В поле **URL-адрес** введите имя поддомена, используемого в URL-адресе для учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это имя становится именем узла в URL, который используется для адресации ресурсов BLOB-объекта, очереди и таблицы для подписки.
			
	- Выберите **расположение или территориальную группу** для учетной записи хранения. Указав территориальную группу, можно выполнить совместное размещение облачных служб и хранилища в одном центре обработки данных.
		 
	- Укажите, следует ли использовать **георепликацию** для учетной записи хранения. По умолчанию георепликация включена. Этот параметр позволяет бесплатно выполнять репликацию данных в дополнительное расположение. Таким образом хранилище переключится на это расположение в случае аварийного отказа основного расположения. Дополнительное местоположение назначается автоматически и не может быть изменено. Если в соответствии с законодательными требованиями или организационной политикой требуется более жесткий контроль расположения облачного хранилища, георепликацию можно отключить. Однако следует помнить, что если вы опять включите георепликацию, с вас будет взята однократная плата за репликацию существующих данных в дополнительное местоположение. Службы хранения без георепликации предлагаются со скидкой. Дополнительную информацию об управлении георепликацией учетных записей хранения см. здесь: [Создание и удаление учетной записи хранения, а также управление ею](../storage-create-storage-account/#replication-options).

	![Введите сведения об учетной записи хранения](./media/virtual-machines-create-upload-vhd-windows-server/Storage-create-account.png)


5. Щелкните **Создать учетную запись хранения**. Учетная запись появится в списке раздела **Хранилище**.

	![Учетная запись хранения успешно создана](./media/virtual-machines-create-upload-vhd-windows-server/Storagenewaccount.png)

6. Теперь создайте контейнер для переданных виртуальных жестких дисков. Щелкните имя учетной записи хранения, а затем щелкните **Контейнеры**.

	![Информация об учетной записи хранения](./media/virtual-machines-create-upload-vhd-windows-server/storageaccount_detail.png)

7. Щелкните **Создание контейнера**.

	![Информация об учетной записи хранения](./media/virtual-machines-create-upload-vhd-windows-server/storageaccount_container.png)

8. Введите имя своего контейнера в поле **Имя** и выберите политику доступа в поле **Доступ**.

	![Имя контейнера](./media/virtual-machines-create-upload-vhd-windows-server/storageaccount_containervalues.png)

	> [AZURE.NOTE]По умолчанию доступ к контейнеру предоставляется только владельцу учетной записи. Чтобы разрешить общий доступ на чтение для больших двоичных объектов в контейнере, но не к свойствам и метаданным контейнера, используйте параметр «Общедоступный BLOB-объект». Чтобы разрешить полный общий доступ на чтение для контейнера и больших двоичных объектов, используйте параметр «Общедоступный контейнер».

## Шаг 3. Подготовка подключения к Microsoft Azure ##

Перед загрузкой файла VHD необходимо установить безопасное соединение между компьютером и вашей подпиской в Azure. Это можно сделать, используя метод Microsoft Azure Active Directory или метод сертификатов.

> [AZURE.TIP]Сведения о том, как начать работу с Azure PowerShell, см. в разделе [Установка и настройка Microsoft Azure PowerShell](../install-configure-powershell.md). Общие сведения см. в статье [Начало работы с командлетами Azure](https://msdn.microsoft.com/library/azure/jj554332.aspx).

### Использование Microsoft Azure AD

1. Откройте консоль Azure PowerShell.

2. Введите `Add-AzureAccount`.
	
	После выполнения команды откроется окно входа, и вы сможете войти, используя свою рабочую или школьную учетную запись.

	![Окно PowerShell](./media/virtual-machines-create-upload-vhd-windows-server/add_azureaccount.png)

3. Azure выполняет проверку подлинности и сохраняет учетные данные, а затем закрывает окно.

### Использование сертификата 

1. Откройте консоль Azure PowerShell. 

2.	Введите `Get-AzurePublishSettingsFile`.

3. В открывшемся окне браузера появится запрос на скачивание PUBLISHSETTINGS-файла. Он содержит информацию и сертификат для подписки Microsoft Azure.

	![Страница скачивания браузера](./media/virtual-machines-create-upload-vhd-windows-server/Browser_download_GetPublishSettingsFile.png)

3. Сохраните файл .publishsettings.

4. Введите `Import-AzurePublishSettingsFile <PathToFile>`.

	где `<PathToFile>` — это полный путь к файлу PUBLISHSETTINGS.

## Шаг 4. Загрузка файла VHD

При загрузке файла .vhd его можно поместить в любом месте внутри хранилища больших двоичных объектов. В приведенных ниже примерах команд **BlobStorageURL** — это URL-адрес для учетной записи хранения, созданный при выполнении шага 2, **YourImagesFolder** — это контейнер внутри хранилища больших двоичных объектов, где будут храниться образы. **VHDName** — это метка, которая отображается в портале управления для идентификации виртуального жесткого диска. **PathToVHDFile** — это полный путь и имя файла .vhd.


1. В окне Azure PowerShell, использованном при выполнении предыдущего шага, введите:

	`Add-AzureVhd -Destination "<BlobStorageURL>/<YourImagesFolder>/<VHDName>.vhd" -LocalFilePath <PathToVHDFile>`
	
	![PowerShell Add-AzureVHD](./media/virtual-machines-create-upload-vhd-windows-server/powershell_upload_vhd.png)

	Дополнительную информацию о командлете Add-AzureVhd см. в разделе [Add-AzureVhd](http://msdn.microsoft.com/library/dn495173.aspx).

## Шаг 5. Добавление образа в список пользовательских образов ##

После загрузки файла VHD его можно добавить в качестве образа в список пользовательских образов, связанных с подпиской.

1. На портале управления в разделе **Все элементы** нажмите **Виртуальные машины**.

2. В разделе виртуальных машин щелкните **Образы**.

3. Затем щелкните **Создать образ**.

	![PowerShell Add-AzureVHD](./media/virtual-machines-create-upload-vhd-windows-server/Create_Image.png)

4. В разделе **Создать образ на основе VHD** выполните следующее:
 	

	- Укажите **имя**.
	- Введите **описание**.
	- Чтобы указать **URL-адрес виртуального жесткого диска**, нажмите кнопку папки. Откроется указанное ниже окно.
 
	![Выбор виртуального жесткого диска](./media/virtual-machines-create-upload-vhd-windows-server/Select_VHD.png)

	- Выберите учетную запись хранения, в которой находится ваш виртуальный жесткий диск, и нажмите **Открыть**. Это позволит вернуться в окно раздела **Создать образ на основе VHD**.
	- После возврата в раздел **Создать образ на основе VHD** выберите семейство ОС.
	- Отметьте пункт **Я выполнил Sysprep на виртуальной машине, связанной с этим VHD**, чтобы подтвердить обобщение операционной системы при выполнении шага 1, а затем нажмите **ОК**. 

	![Добавление образа](./media/virtual-machines-create-upload-vhd-windows-server/Create_Image_From_VHD.png)

5. **НЕОБЯЗАТЕЛЬНО.** Чтобы добавить виртуальный жесткий диск в качестве образа, вместо портала управления можно использовать командлет Add-AzureVMImage. В консоли Azure PowerShell введите:

	`Add-AzureVMImage -ImageName <Your Image's Name> -MediaLocation <location of the VHD> -OS <Type of the OS on the VHD>`
	
	![PowerShell Add-AzureVMImage](./media/virtual-machines-create-upload-vhd-windows-server/add_azureimage_powershell.png)

6. После выполнения предыдущих действий новый образ отобразится в списке при выборе вкладки **Образы**.


	![пользовательский образ](./media/virtual-machines-create-upload-vhd-windows-server/vm_custom_image.png)

	Теперь при создании виртуальной машины вы сможете воспользоваться этим новым образом, расположенным в папке **Мои образы**. Необходимые инструкции см. в разделе [Создание настраиваемой виртуальной машины, работающей под управлением ОС Windows](virtual-machines-windows-create-custom.md).

	![создание виртуальной машины на основе пользовательского образа](./media/virtual-machines-create-upload-vhd-windows-server/create_vm_custom_image.png)

	> [AZURE.TIP]Если при попытке создать виртуальную машину возникнет сообщение об ошибке "Виртуальный жесткий диск https://XXXXX.. имеет неподдерживаемый виртуальный размер YYYY Б. Размер должен измеряться целым числом (в МБ)», это означает, что размер виртуальной памяти вашего VHD не составляет целое число в мегабайтах, и поэтому его размер нефиксированный. Попытайтесь добавить образ, используя командлет Add-AzureVMImage PowerShell вместо портала управления (см. шаг 5 выше). Командлеты Azure обеспечивают соответствие VHD требованиям Azure.
	
## Дальнейшие действия ##
 

После создания виртуальной машины попробуйте создать виртуальную машину SQL Server. Указания см. в разделе [Подготовка виртуальной машины SQL Server в Microsoft Azure](virtual-machines-provision-sql-server.md).

[Шаг 1. Подготовка образа для передачи]: #prepimage
[Шаг 2. Создание учетной записи хранения в Azure]: #createstorage
[Шаг 3. Подготовка подключения к Azure]: #prepAzure
[Шаг 4. Загрузка VHD-файла]: #upload
 

<!---HONumber=July15_HO3-->