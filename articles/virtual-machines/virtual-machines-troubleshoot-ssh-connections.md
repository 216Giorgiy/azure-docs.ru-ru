<properties
	pageTitle="Устранение неполадок подключения к виртуальной машине Azure через SSH | Microsoft Azure"
	description="Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux"
	services="virtual-machines"
	documentationCenter=""
	authors="dsk-2015"
	manager="timlt"
	editor=""
	tags="top-support-issue,azure-service-management,azure-resource-manager"/>

<tags
	ms.service="virtual-machines"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-linux"
	ms.devlang="na"
	ms.topic="article"
	ms.date="10/27/2015"
	ms.author="dkshir"/>

# Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-both-include.md)]



Сбои SSH в виртуальной машине Azure под управлением Linux могут возникать по различным причинам. Эта статья поможет вам выявить и устранить причины сбоя.

Статья относится только к виртуальным машинам Azure под управлением Linux. Инструкции по устранению неполадок подключения на виртуальных машинах Azure под управлением Windows см. в [этой статье](virtual-machines-troubleshoot-remote-desktop-connections.md).

## Обращение в службу поддержки клиентов Azure

Если в любой момент при изучении этой статьи вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](http://azure.microsoft.com/support/forums/).

Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт службы поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните **Получение поддержки**. Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](http://azure.microsoft.com/support/faq/).


## Основные шаги: классическая модель развертывания.

Для устранения наиболее распространенных сбоев SSH-подключения в виртуальных машинах, созданных с помощью классической модели развертывания, попробуйте выполнить следующие действия.

1. **Выполните сброс удаленного доступа** на [портале предварительной версии Azure](https://portal.azure.com). Последовательно выберите **Просмотреть все** > **Виртуальные машины (классика)** > имя вашей виртуальной машины Windows > **Сброс удаленного доступа**.

	![Сброс удаленного доступа](./media/virtual-machines-troubleshoot-ssh-connections/Portal-SSH-Reset-Windows.png)

2. **Перезапустите** виртуальную машину. На [портале предварительной версии Azure](https://portal.azure.com) последовательно выберите пункты **Просмотреть все** > **Виртуальные машины (классические)** > имя вашей виртуальной машины Windows > **Перезапуск**. На [портале управления Azure](https://manage.windowsazure.com) откройте **Виртуальные машины** > **Экземпляры** и выберите **Перезапуск**.

3. [**Измените размер** виртуальной машины](https://msdn.microsoft.com/library/dn168976.aspx).

4. Выполните на виртуальной машине действия, описанные в статье [Как сбросить пароль или ключ SSH в виртуальных машинах Linux](virtual-machines-linux-use-vmaccess-reset-password-or-ssh.md), чтобы:

	- сбросить пароль или ключ SSH;
	- создать новую учетную запись пользователя sudo;
	- сбросить конфигурацию SSH.

5. Проверьте работоспособность ресурсов виртуальной машины, чтобы выявить любые проблемы, связанные с платформой. Последовательно выберите "Просмотреть все" > "Виртуальные машины (классика)" > имя вашей виртуальной машины Linux > **Проверить работоспособность**


## Основные шаги: модель развертывания диспетчера ресурсов

Для устранения распространенных проблем SSH на виртуальных машинах, созданных с помощью модели развертывания диспетчера ресурсов, попробуйте выполнить следующие действия.

1. **Сбросьте SSH-подключение** к виртуальной машине Linux в командной строке с помощью Azure CLI или Azure PowerShell. Убедитесь, что у вас установлен [агент Linux для Microsoft Azure](virtual-machines-linux-agent-user-guide.md) версии 2.0.5 или более поздней.

	**Использование Azure CLI**

	а. [Установите Azure CLI и подключитесь к подписке Azure](../xplat-cli-install.md) с помощью команды `azure login` (если вы еще этого не сделали).

	b. Переключитесь в режим диспетчера ресурсов.

	```
	azure config mode arm
	```

	c. Сброс SSH-подключения можно выполнить с помощью любого из следующих методов.

	* Используйте команду `vm reset-access`, как в следующем примере.

	```
	azure vm reset-access -g TestRgV2 -n TestVmV2 -r
	```

	При этом на виртуальную машину будет установлено расширение `VMAccessForLinux`.

	* Создайте файл с именем PrivateConf.json со следующим содержимым:

	```
	{  
	"reset_ssh":"True"
	}
	```

	Затем вручную запустите расширение `VMAccessForLinux`, чтобы сбросить SSH-подключение.

	```
	azure vm extension set "testRG" "testVM" VMAccessForLinux Microsoft.OSTCExtensions "1.2" --private-config-path PrivateConf.json
	```

	**Использование Azure PowerShell**

	а. [Установите Azure PowerShell и подключитесь к подписке Azure](../powershell-install-configure.md) с помощью метода Azure AD (если вы еще этого не сделали).

	b. Переключитесь в режим диспетчера ресурсов.

	```
	Switch-AzureMode -Name AzureResourceManager
	```

	c. Запустите расширение `VMAccessForLinux` для сброса SSH-подключения, как в следующем примере.

	```
	Set-AzureVMExtension -ResourceGroupName "testRG" -VMName "testVM" -Location "West US" -Name "VMAccessForLinux" -Publisher "Microsoft.OSTCExtensions" -ExtensionType "VMAccessForLinux" -TypeHandlerVersion "1.2" -SettingString "{}" -ProtectedSettingString '{"reset_ssh":true}'
	```

2. **Перезапустите** виртуальную машину Linux через портал. На [портале предварительной версии Azure](https://portal.azure.com) последовательно выберите **Просмотреть все** > **Виртуальные машины** > имя вашей виртуальной машины Windows > **Перезагрузить**.

	![Перезапуск v2](./media/virtual-machines-troubleshoot-ssh-connections/Portal-SSH-Restart-V2-Windows.png)

3. **Сбросьте пароль или ключ SSH** для виртуальной машины Linux в командной строке с помощью Azure CLI или Azure PowerShell. Также можно создать новое имя пользователя и пароль с полномочиями sudo, как в следующем примере.

	**Использование Azure CLI**

	Установите и настройте Azure CLI, как описано выше. Переключитесь в режим диспетчера ресурсов, а затем запустите расширение, используя один из следующих методов.

	* Выполните команду `vm reset-access`, чтобы задать учетные данные SSH.

	```
	azure vm reset-access TestRgV2 TestVmV2 -u NewUser -p NewPassword
	```

	Чтобы получить дополнительные сведения об этой команде, введите `azure vm reset-access -h` в командную строку.

	* Создайте файл с именем PrivateConf.json со следующим содержимым: ```
	{
	"username":"NewUsername", "password":"NewPassword", "expiration":"2016-01-01", "ssh_key":"", "reset_ssh":false, "remove_user":""
	}
	```

	Затем запустите расширение Linux с помощью указанного выше файла.

	```
	$azure vm extension set "testRG" "testVM" VMAccessForLinux Microsoft.OSTCExtensions "1.2" --private-config-path PrivateConf.json
	```

	Вы можете попробовать другие методы, выполнив действия, подобные описанным в статье [Как сбросить пароль или ключ SSH в виртуальных машинах Linux](virtual-machines-linux-use-vmaccess-reset-password-or-ssh.md). Не забудьте изменить инструкции Azure CLI для режима диспетчера ресурсов.

	**Использование Azure PowerShell**

	Установите и настройте Azure PowerShell, как описано выше. Переключитесь в режим диспетчера ресурсов, а затем запустите расширение, как указано ниже.

	```
	$RGName = 'testRG'
	$VmName = 'testVM'
	$Location = 'West US'

	$ExtensionName = 'VMAccessForLinux'
	$Publisher = 'Microsoft.OSTCExtensions'
	$Version = '1.2'

	$PublicConf = '{}'
	$PrivateConf = '{"username":"NewUsername", "password":"NewPassword", "ssh_key":"", "reset_ssh":false, "remove_user":""}'

	Set-AzureVMExtension -ResourceGroupName $RGName -VMName $VmName -Location $Location -Name $ExtensionName -Publisher $Publisher -ExtensionType $ExtensionName -TypeHandlerVersion $Version -SettingString $PublicConf -ProtectedSettingString $PrivateConf

	```

	Не забудьте заменить значения $RGName, $VmName, $Location и учетные данные SSH значениями, относящимися к вашей установке.

## Подробная диагностика

Если SSH-клиент по-прежнему не может подключиться к SSH-службе на виртуальной машине, это может быть вызвано разными причинами. Здесь приведены компоненты, которые участвуют в этом процессе.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot1.png)

Следующие разделы помогут вам выявить источник сбоя и определить способы его устранения или обхода.

### Действия до устранения неполадок

Сначала проверьте состояние виртуальной машины на портале Azure.

На [портале управления Azure](https://manage.windowsazure.com) для виртуальных машин в классической модели развертывания сделайте следующее.

1. Щелкните **Виртуальные машины** > *Имя виртуальной машины*.
2. Щелкните **Панель мониторинга** виртуальной машины, чтобы проверить ее состояние.
3. Щелкните **Монитор** для просмотра последних действий в ресурсах вычислений, хранения и сетевых ресурсах.
4. Щелкните **Конечные точки**, чтобы убедиться, что SSH-трафика существует конечная точка.

На [портале предварительной версии Azure](https://portal.azure.com) выполните следующие действия.

1. Для виртуальной машины, созданной в классической модели развертывания, щелкните **Обзор** > **Виртуальные машины (классика)** > *имя виртуальной машины*. Для виртуальной машины, созданной с помощью диспетчера ресурсов, щелкните **Обзор** > **Виртуальные машины** > *имя виртуальной машины*. Панель состояния виртуальной машины должна отображать состояние **Работает**. Прокрутите страницу вниз для просмотра последних действий в ресурсах вычислений, хранения и сетевых ресурсах.
2. Щелкните **Параметры**, чтобы проверить конечные точки, IP-адреса и другие параметры. Для идентификации конечных точек в виртуальных машинах, созданных с помощью диспетчера ресурсов, проверьте, определена ли [группа безопасности сети](../traffic-manager/virtual-networks-nsg.md), применены ли к ней правила и имеется ли на них ссылка в подсети.

Чтобы проверить сетевое подключение, проверьте настроенные конечные точки и определите, можете ли вы получить доступ к виртуальной машине с помощью другого протокола, например HTTP, или другой службы.

Выполнив эти действия, попытайтесь создать SSH-подключение еще раз.


### Действия по устранению неполадок

Неспособность SSH-клиента подключиться к SSH-службе на виртуальной машине Azure может быть связана с проблемами и ошибками в настройках перечисленных ниже компонентов.

- Клиентский компьютер SSH.
- Пограничное устройство организации.
- Конечная точка облачной службы и список управления доступом (ACL)
- группы сетевой безопасности;
- Виртуальная машина Linux.

#### Источник 1: клиентский компьютер SSH

Чтобы исключить компьютер из числа возможных источников ошибок, убедитесь, что с его помощью можно установить SSH-подключения к другому локальному компьютеру с Linux.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot2.png)

Если сделать это не удается, проверьте, нет ли на компьютере:

- настройки локального брандмауэра, блокирующей входящий и исходящий SSH-трафик (TCP 22);
- локального программного обеспечения с функциями прокси клиента, которое не позволяет установить SSH-подключение;
- локального программного обеспечения для мониторинга сети, которое не позволяет установить SSH-подключение;
- других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов.

В любом из перечисленных выше случаев временно отключите соответствующее программное обеспечение и попробуйте установить SSH-подключение с локальным компьютером, чтобы выявить причину проблемы. Затем при поддержке администратора сети измените параметры программного обеспечения таким образом, чтобы оно не блокировало SSH-подключение.

Если вы используете проверку подлинности на основе сертификата, убедитесь, что у вас есть следующие разрешения для папки SSH в домашнем каталоге:

- Chmod 700 ~/.ssh;
- Chmod 644 ~/.ssh/*.pub;
- Chmod 600 ~/.ssh/id\_rsa (или другие файлы, в которых хранятся ваши закрытые ключи);
- Chmod 644 ~/.ssh/known\_hosts (содержит узлы, с которыми вы установили подключение по SSH-протоколу).

#### Источник 2: пограничное устройство организации

Чтобы исключить пограничное устройство организации из числа возможных источников ошибок, убедитесь, что компьютер, подключенный к Интернету напрямую, может устанавливать SSH-подключения к виртуальной машине Azure. Если вы обращаетесь к виртуальной машине через VPN типа "сеть-сеть" или подключение ExpressRoute, перейдите к разделу [Источник 4: группы безопасности сети](#nsg).

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot3.png)

Если у вас нет такого компьютера, вы можете легко создать вместо него новую виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе. Дополнительные сведения см. в статье [Создание виртуальной машины Linux в среде Azure](virtual-machines-linux-tutorial.md). Завершив проверку, удалите группу ресурсов или виртуальную машину и облачную службу.

Если вам удается установить SSH-подключение с компьютера, непосредственно подключенного к Интернету, убедитесь, что на пограничном устройстве вашей организации отсутствуют следующие компоненты:

- внутренний брандмауэр, который блокирует SSH-трафик в Интернете;
- прокси-сервер, который не позволяет устанавливать SSH-подключения;
- программное обеспечение для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует SSH-подключения.

При поддержке администратора сети измените параметры пограничного устройства организации таким образом, чтобы оно не блокировало SSH-трафик через Интернет.

#### Источник 3: конечная точка облачной службы и список управления доступом (ACL)

> [AZURE.NOTE]Этот источник применяется только к виртуальным машинам, созданным с использованием классической модели развертывания. Для виртуальных машин, созданных с помощью диспетчера ресурсов, перейдите к разделу [Источник 4: группы безопасности сети](#nsg).

Чтобы исключить конечную точку облачной службы и список управления доступом из числа возможных источников ошибок для виртуальных машин, созданных с помощью [классической модели развертывания](../resource-manager-deployment-model.md), убедитесь, что другая виртуальная машина Azure в той же виртуальной сети может устанавливать SSH-подключения к вашей виртуальной машине.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot4.png)

Если у вас нет еще одной виртуальной машины в той же виртуальной сети, вы можете легко ее создать. Дополнительные сведения см. в статье [Создание виртуальной машины Linux в среде Azure](virtual-machines-linux-tutorial.md). Завершив проверку, удалите дополнительную виртуальную машину.

Если вы создаете SSH-подключение к виртуальной машине в той же виртуальной сети, проверьте следующие параметры.

- Конфигурация конечной точки для SSH-трафика на целевой виртуальной машине. Частный TCP-порт на конечной точке должен совпадать с TCP-портом, который прослушивает SSH-служба на виртуальной машине (по умолчанию это порт 22). Для виртуальных машин, созданных в модели развертывания диспетчера ресурсов Azure с помощью шаблонов, проверьте номер TCP-порта SSH. Для этого на портале предварительной версии Azure последовательно щелкните **Обзор** > **Виртуальные машины (v2)** > *имя виртуальной машины* > **Параметры** > **Конечные точки**.
- Список управления доступом на конечной точке для SSH-трафика на целевой виртуальной машине. С помощью него можно разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если список управления доступом неправильно настроен, входящий SSH-трафик на эту конечную точку может блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительные сведения см. в статье [Сетевые списки управления доступом](../virtual-network/virtual-networks-acl.md).

Чтобы исключить конечную точку из числа потенциальных источников проблем, удалите ее и создайте новую, указав имя **SSH** (номер для общего и частного TCP-порта — 22). Дополнительные сведения см. в статье [Настройка конечных точек на виртуальной машине Azure](virtual-machines-set-up-endpoints.md).

<a id="nsg"></a>
#### Источник 4: группы безопасности сети

Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure. Проверьте свои правила групп безопасности сети и убедитесь, что входящий и исходящий SSH-трафик разрешен. Дополнительную информацию см. в статье [О группах безопасности сети](../traffic-manager/virtual-networks-nsg.md).

#### Источник 5: виртуальная машина Azure в службе Azure

Последним потенциальным источником проблем является сама виртуальная машина Azure.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot5.png)

Выполните на виртуальной машине инструкции по [сбросу пароля или SSH в виртуальных машинах Linux](virtual-machines-linux-use-vmaccess-reset-password-or-ssh.md) (если вы еще этого не сделали).

Попытайтесь снова установить подключение со своего компьютера. Если вам по-прежнему не удастся этого сделать, проверьте, не является ли причиной один из перечисленных ниже моментов.

- На целевой виртуальной машине не запущена SSH-служба.
- SSH-служба не прослушивает TCP-порт 22. Чтобы проверить это, установите клиент telnet на локальном компьютере и выполните действие "telnet *cloudServiceName*.cloudapp.net 22". Это действие определит, разрешает ли виртуальная машина входящий и исходящий обмен данными с конечной точкой SSH.
- Правила локального брандмауэра на целевой виртуальной машине блокируют входящий и исходящий SSH-трафик.
- Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует SSH-подключения.


## Дополнительные ресурсы

Для виртуальных машин в классической модели развертывания см. статью [Как сбросить пароль или ключ SSH в виртуальных машинах Linux](virtual-machines-linux-use-vmaccess-reset-password-or-ssh.md).

[Устранение неполадок с подключением к удаленному рабочему столу виртуальной машины Windows в службе Azure](virtual-machines-troubleshoot-remote-desktop-connections.md)

[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines-troubleshoot-access-application.md)

<!---HONumber=Nov15_HO2-->