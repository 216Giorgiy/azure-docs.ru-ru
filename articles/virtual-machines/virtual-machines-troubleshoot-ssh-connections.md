<properties
	pageTitle="Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux"
	description="Если не удается подключиться к виртуальной машине Azure под управлением Linux, выполните следующие действия, чтобы выявить источник проблемы."
	services="virtual-machines"
	documentationCenter=""
	authors="JoeDavies-MSFT"
	manager="timlt"
	editor=""
	tags="azure-service-management,azure-resource-manager"/>


<tags
	ms.service="virtual-machines"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-linux"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/07/2015"
	ms.author="josephd"/>

# Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux

В этой статье описываются методы для выявления и устранения неполадок, из-за которых не удается выполнить подключение к виртуальной машине Azure под управлением Linux.

## Шаг 1. Сброс конфигурации, пароля или ключа SSH

Выполните на виртуальной машине действия, приведенные в статье [Как сбросить пароль или ключ SSH в виртуальных машинах Linux](virtual-machines-linux-use-vmaccess-reset-password-or-ssh.md). Следуя этим инструкциям, вы сможете:

- сбросить пароль или ключ SSH;
- создать новую учетную запись пользователя sudo;
- сбросить конфигурацию SSH.

Если SSH-клиент по-прежнему не может подключиться к SSH-службе на виртуальной машине, это может быть вызвано разными причинами. Вот схема компонентов, которые участвуют в этом процессе.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot1.png)

В следующих разделах приведены пошаговые инструкции по локализации проблемы и определению ее причин, а также варианты временных и постоянных решений.

## Шаг 2. Предварительные действия перед началом подробной диагностики

Сначала проверьте состояние виртуальной машины на портале управления Azure или портале предварительной версии Azure.

Войдите на портал управления Azure.

1. Щелкните **Виртуальные машины** > *Имя виртуальной машины*.
2. Щелкните **Панель мониторинга** соответствующей виртуальной машины, чтобы проверить ее состояние.
3. Щелкните **Монитор** для просмотра последних действий в ресурсах вычислений, хранения и сетевых ресурсах.
4. Щелкните **Конечные точки**, чтобы убедиться, что SSH-трафика существует конечная точка.

Войдите на портал предварительной версии Azure.

1. Щелкните **Обзор** > **Виртуальные машины** > *Имя виртуальной машины*. Для виртуальной машины, созданной в диспетчере ресурсов Azure, щелкните **Обзор** > **Виртуальные машины (вер. 2)** > *Имя виртуальной машины*. Панель состояния виртуальной машины должна отображать состояние **Работает**. Прокрутите страницу вниз для просмотра последних действий в ресурсах вычислений, хранения и сетевых ресурсах.
2. Щелкните **Параметры**, чтобы проверить конечные точки, IP-адреса и другие параметры.

Чтобы проверить сетевое подключение, проанализируйте конечные точки и определите, можете ли вы получить доступ к виртуальной машине с помощью другого протокола, например HTTP, или другой известной службы.

При необходимости [Перезапустите виртуальную машину](https://msdn.microsoft.com/library/azure/dn763934.aspx) или [Измените размер виртуальной машины](https://msdn.microsoft.com/library/dn168976.aspx).

Выполнив эти действия, попытайтесь создать SSH-подключение еще раз.

## Действие 3. Подробная диагностика

Неспособность SSH-клиента подключиться к SSH-службе на виртуальной машине Azure может быть связана с проблемами и ошибками в настройках перечисленных ниже компонентов.

- Клиентский компьютер SSH.
- Пограничное устройство организации.
- Конечная точка облачной службы и список управления доступом (ACL)
- группы сетевой безопасности;
- Виртуальная машина Linux.

### Источник 1: клиентский компьютер SSH

Чтобы устранить компьютер из числа возможных источников проблем и ошибок в настройках, убедитесь, что с его помощью можно установить SSH-подключение на другом локальном компьютере с Linux.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot2.png)

Если сделать это не удается, проверьте, нет ли на компьютере:

- настройки локального брандмауэра, блокирующей входящий и исходящий SSH-трафик (TCP 22);
- локального программного обеспечения с функциями прокси клиента, которое не позволяет установить SSH-подключение;
- локального программного обеспечения для мониторинга сети, которое не позволяет установить SSH-подключение;
- других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов, тем самым блокируя SSH-подключение.

В любом из перечисленных выше случаев попробуйте временно отключить соответствующее программное обеспечение и установить SSH-подключение на локальном компьютере, чтобы определить причину проблемы. Затем при поддержке администратора сети измените параметры программного обеспечения таким образом, чтобы оно не блокировало SSH-подключение.

Если вы используете проверку подлинности на основе сертификата, убедитесь, что у вас есть следующие разрешения для папки SSH в домашнем каталоге:

- Chmod 700 \~/.ssh;
- Chmod 644 \~/.ssh/\*.pub;
- Chmod 600 \~/.ssh/id\_rsa (или другие файлы, в которых могут храниться ваши закрытые ключи);
- Chmod 644 \~/.ssh/known\_hosts (содержит узлы, с которыми вы установили подключение по SSH-протоколу).

### Источник 2: пограничное устройство организации

Чтобы устранить пограничное устройство организации из числа возможных источников проблем и ошибок в настройках, убедитесь, что компьютер, непосредственно подключенный к Интернету, может устанавливать SSH-подключения к виртуальной машине Azure. Если вы обращаетесь к виртуальной машине через VPN-подключение или ExpressRoute, перейдите к разделу [Источник 4. Группы безопасности сети](#nsg).

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot3.png)

Если у вас нет такого компьютера, вы можете легко создать вместо него новую виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе. Дополнительные сведения см. в статье [Создание виртуальной машины Linux в среде Azure](virtual-machines-linux-tutorial.md). Завершив проверку, удалите группу ресурсов или виртуальную машину и облачную службу.

Если вам удается установить SSH-подключение с компьютера, непосредственно подключенного к Интернету, убедитесь, что на пограничном устройстве вашей организации отсутствуют следующие компоненты:

- внутренний брандмауэр, который блокирует SSH-трафик в Интернете;
- прокси-сервер, который не позволяет устанавливать SSH-подключения;
- программное обеспечение для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует SSH-подключения.

При поддержке администратора сети измените параметры пограничного устройства организации таким образом, чтобы оно не блокировало SSH-трафик через Интернет.

### Источник 3: конечная точка облачной службы и список управления доступом (ACL)

Чтобы устранить конечную точку облачной службы и ACL как источник проблем или неправильной конфигурации для виртуальных машин, созданных в управлении службами, убедитесь, что другая виртуальная машина Azure, которая находится в той же виртуальной сети, может устанавливать SSH-подключения к вашей виртуальной машине Azure.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot4.png)

> [AZURE.NOTE]Для виртуальных машин, созданных в диспетчере ресурсов Azure, см. раздел [Источник 4. Группы безопасности сети](#nsg).

Если у вас нет еще одной виртуальной машины в той же виртуальной сети, вы можете легко ее создать. Дополнительные сведения см. в статье [Создание виртуальной машины Linux в среде Azure](virtual-machines-linux-tutorial.md). Завершив проверку, удалите дополнительную виртуальную машину.

Если вы создаете SSH-подключение к виртуальной машине в той же виртуальной сети, проверьте следующие параметры.

- Конфигурация конечной точки для SSH-трафика на целевой виртуальной машине. Частный TCP-порт на конечной точке должен совпадать с TCP-портом, который прослушивает SSH-служба на виртуальной машине (по умолчанию это порт 22). Для виртуальных машин, созданных в диспетчере ресурсов Azure с помощью шаблонов, проверьте номер TCP-порта SSH. Для этого на портале предварительной версии Azure последовательно щелкните **Обзор** > **Виртуальные машины (вер. 2)** > *Имя виртуальной машины* > **Параметры** > **Конечные точки**.
- Список управления доступом на конечной точке для SSH-трафика на целевой виртуальной машине. С помощью него можно разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если список управления доступом неправильно настроен, входящий SSH-трафик на эту конечную точку может блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительные сведения см. в статье [О сетевых списках управления доступом (ACL)](https://msdn.microsoft.com/library/azure/dn376541.aspx).

Чтобы устранить конечную точку из числа потенциальных источников проблемы, удалите ее и создайте новую, указав имя **SSH** (номер для общедоступного и частного TCP-порта — 22) Дополнительные сведения см. в статье [Настройка конечных точек на виртуальной машине Azure](virtual-machines-set-up-endpoints.md).

### <a id="nsg"></a>Источник 4. Группы безопасности сети

Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure. Проверьте свои правила групп безопасности сети и убедитесь, что входящий и исходящий SSH-трафик разрешен. Дополнительную информацию см. в [статье о группах безопасности сети](../traffic-manager/virtual-networks-nsg.md).

### Источник 5: виртуальная машина Azure в службе Azure

Последним потенциальным источником проблем является сама виртуальная машина Azure.

![](./media/virtual-machines-troubleshoot-ssh-connections/ssh-tshoot5.png)

Если вы еще не сбросили пароль, выполните на виртуальной машине действия, приведенные в статье [Как сбросить пароль или ключ SSH в виртуальных машинах Linux](virtual-machines-linux-use-vmaccess-reset-password-or-ssh.md).

Попытайтесь снова установить подключение со своего компьютера. Если попытка не была успешной, вот причины, которые могут помешать вам установить подключение.

- На целевой виртуальной машине не запущена SSH-служба.
- SSH-служба не прослушивает TCP-порт 22. Чтобы проверить это, установите клиент telnet на локальном компьютере и выполните действие "telnet *cloudServiceName*.cloudapp.net 22". Это действие определит, разрешает ли виртуальная машина входящий и исходящий обмен данными с конечной точкой SSH.
- Правила локального брандмауэра на целевой виртуальной машине блокируют входящий и исходящий SSH-трафик.
- Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует SSH-подключения.


## Действие 4. Публикация вопроса на форумах поддержки Azure

Вы можете обратиться к специалистам по Azure со всего мира, рассказав о своей проблеме на форумах MSDN Azure и Stack Overflow. Дополнительную информацию см. на [форумах Microsoft Azure](http://azure.microsoft.com/support/forums/).

## Действие 5. Отправка запроса в службу поддержки Azure

Если вы выполнили действия с первого по четвертое из этой статьи и опубликовали свой вопрос на форумах поддержки Azure, но это вам не помогло установить SSH-подключение, возможно, следует удалить и снова создать виртуальную машину.

Если это невозможно, отправьте запрос в службу поддержки Azure.

Для этого зайдите на [сайт поддержки Azure](http://azure.microsoft.com/support/options/), а затем щелкните **Поддержка**.

Дополнительные сведения об использовании службы поддержки Azure см. в разделе [Часто задаваемые вопросы о поддержке Azure](http://azure.microsoft.com/support/faq/).

## Дополнительные ресурсы

[Как сбросить пароль или ключ SSH в виртуальных машинах Linux](virtual-machines-linux-use-vmaccess-reset-password-or-ssh.md)

[Устранение неполадок с подключением к удаленному рабочему столу виртуальной машины Windows в службе Azure](virtual-machines-troubleshoot-remote-desktop-connections.md)

[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines-troubleshoot-access-application.md)

<!---HONumber=July15_HO5-->