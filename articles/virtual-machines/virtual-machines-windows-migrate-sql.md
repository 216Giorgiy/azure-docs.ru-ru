<properties
	pageTitle="Перенос базы данных SQL Server в экземпляр SQL Server на виртуальной машине | Mirosoft Azure"
	description="Узнайте больше о том, как перенести локальную пользовательскую базу данных в SQL Server на виртуальной машине Azure."
	services="virtual-machines-windows"
	documentationCenter=""
	authors="sabotta"
	manager="jhubbard"
	editor=""
	tags="azure-service-management" />
<tags
	ms.service="virtual-machines-windows"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows-sql-server"
	ms.devlang="na"
	ms.topic="article"
	ms.date="06/06/2016"
	ms.author="carlasab"/>


# Миграция базы данных SQL Server в экземпляр SQL Server на виртуальной машине Azure

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-both-include.md)]Модель диспетчера ресурсов.


Существует несколько методов миграции пользовательской базы данных локального SQL Server в SQL Server на виртуальной машине Azure. В данной статье кратко рассматриваются различные методы, рекомендованы лучшие методы для различных сценариев. Кроме того, в статье есть [инструкции](#azure-vm-deployment-wizard-tutorial) по использованию мастера **развертывания баз данных SQL Server на виртуальной машине Microsoft Azure**.

Метод, подразумевающий использование мастера **развертывания базы данных SQL Server на виртуальной машине Microsoft Azure**, рассматриваемый в [учебнике](#azure-vm-deployment-wizard-tutorial), относится только к классической модели развертывания.

## Описание основных методов миграции

Ниже перечислены основные методы миграции.

- Использование мастера развертывания баз данных SQL Server на виртуальной машине Microsoft Azure.
- Локальная архивация с использованием сжатия и ручное копирование файла резервной копии на виртуальную машину Azure.
- Архивация на URL-адрес и восстановление в виртуальную машину Azure из URL-адреса.
- Отключение и копирование файлов данных и журналов в хранилище больших двоичных объектов Azure с последующим подключением их к SQL Server на виртуальной машине Azure с использованием URL-адреса.
- Преобразование локального физического компьютера в VHD Hyper-V, передача VHD в хранилище больших двоичных объектов Azure и последующее развертывание в виде новой виртуальной машины на базе отправленного VHD.
- Доставка жесткого диска в службу импорта и экспорта Windows.
- Кроме того, при наличии локального развертывания AlwaysOn с помощью [мастера добавления реплики Azure](virtual-machines-windows-classic-sql-onprem-availability.md) можно создать реплику в Azure, а затем выполнить отработку отказа, перенаправляя пользователей к экземпляру базы данных Azure.
- Используйте [репликацию транзакций](https://msdn.microsoft.com/library/ms151176.aspx) SQL Server для настройки экземпляра SQL Server Azure в качестве подписчика, а затем отключите репликацию, перенаправляя пользователей к экземпляру базы данных Azure.



## Выбор метода миграции

В общем случае для достижения оптимальной скорости передачи данных лучше всего выполнять миграцию файлов баз данных в виртуальную машину Azure с использованием сжатого файла резервной копии. Этот метод используется в [мастере развертывания баз данных SQL Server на виртуальной машине Microsoft Azure](#azure-vm-deployment-wizard-tutorial). Рекомендуется использовать этот мастер для миграции локальной пользовательской базы данных из SQL Server 2005 и более поздней версии в SQL Server 2014 и более поздней версии в случаях, когда размер сжатого файла резервной копии базы данных меньше 1 ТБ.

Чтобы свести к минимуму время простоя в процессе миграции базы данных, используйте функцию AlwaysOn или репликацию транзакций.

Если использовать указанные выше методы невозможно, перенесите базу данных вручную. В этом случае процесс, как правило, начинается с создания резервной копии базы данных, после этого выполняется перенос резервной копии базы данных в Azure, а затем восстановление базы данных. Кроме того, в Azure можно скопировать сами файлы базы данных, а затем подключить их. Существует несколько методов, с помощью которых можно выполнить ручную миграцию базы данных в виртуальную машину Azure.

> [AZURE.NOTE] При обновлении до SQL Server 2014 или SQL Server 2016 с предыдущих версий SQL Server необходимо определить, нужны ли изменения. При разработке проекта миграции рекомендуется решить вопрос со всеми зависимостями от компонентов, не поддерживаемых в новой версии SQL Server. Дополнительные сведения о поддерживаемых выпусках и сценариях см. в статье [Обновление до SQL Server](https://msdn.microsoft.com/library/bb677622.aspx).

В таблице ниже перечислены основные методы миграции и указано, в каком случае лучше всего использовать каждый из методов.

| Метод | Версия исходной базы данных | Версия базы данных назначения | Ограничение на размер файла резервной копии исходной базы данных | Примечания |
|---|---|---|---|---|
| [Использование мастера развертывания баз данных SQL Server на виртуальной машине Microsoft Azure](#azure-vm-deployment-wizard-tutorial) | SQL Server 2005 или более поздней версии | SQL Server 2014 или более поздней версии | Менее 1 TБ | Самый простой и быстрый метод. Следует при любой возможности использовать его для миграции в новый или существующий экземпляр SQL Server на виртуальной машине Azure. | 
| [Работа с мастером добавления реплики Azure](virtual-machines-windows-classic-sql-onprem-availability.md) | SQL Server 2012 или более поздней версии | SQL Server 2012 или более поздней версии | [Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) | Сокращает время простоя, используется при наличии локального развертывания AlwaysOn. |
| [Использование репликации транзакций SQL Server](https://msdn.microsoft.com/library/ms151176.aspx) | SQL Server 2005 или более поздней версии | SQL Server 2005 или более поздней версии | [Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) | Используется при необходимости сократить время простоя, если локальное развертывание AlwaysOn отсутствует. |
| [Локальная архивация с использованием сжатия и ручное копирование файла резервной копии на виртуальную машину Azure](#backup-to-file-and-copy-to-vm-and-restore) | SQL Server 2005 или более поздней версии | SQL Server 2005 или более поздней версии | [Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) | Применяется только тогда, когда невозможно использовать мастер, например если используется более ранняя версия базы данных назначения, чем SQL Server 2012 SP1 CU2, или если размер файла резервной копии базы данных превышает 1 ТБ (12,8 ТБ при использовании SQL Server 2016). |
| [Архивация в URL-адрес и последующее восстановление на виртуальную машину Azure с этого URL-адреса.](#backup-to-url-and-restore) | SQL Server 2012 SP1 CU2 или более поздней версии | SQL Server 2012 SP1 CU2 или более поздней версии | Менее 12,8 ТБ для SQL Server 2016, в противном случае менее 1 ТБ | Обычно использование [архивации на URL-адрес](https://msdn.microsoft.com/library/dn435916.aspx) так же эффективно, как и использование мастера, но не так просто. |
| [Отключение и копирование файлов данных и журналов в хранилище больших двоичных объектов Azure с последующим подключением к SQL Server на виртуальной машине Azure с использованием URL-адреса.](#detach-and-copy-to-url-and-attach-from-url) | SQL Server 2005 или более поздней версии | SQL Server 2014 или более поздней версии | [Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) | Используйте этот метод, если необходимо [сохранить файлы с помощью службы хранилища больших двоичных объектов Azure](https://msdn.microsoft.com/library/dn385720.aspx) и подключить их к SQL Server на виртуальной машине Azure, особенно при работе с очень большими базами данных. |
| [Преобразование локального компьютера в VHD Hyper-V, отправка VHD в хранилище больших двоичных объектов Azure и последующее развертывание новой виртуальной машины на базе отправленного VHD.](#convert-to-vm-and-upload-to-url-and-deploy-as-new-vm) | SQL Server 2005 или более поздней версии | SQL Server 2005 или более поздней версии | [Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) | Используется в случае [переноса вашей собственной лицензии SQL Server](../data-management-azure-sql-database-and-sql-server-iaas/) при миграции базы данных, которую планируется использовать на более ранней версии SQL Server, или при совместной миграции системных и пользовательских баз данных в рамках миграции базы данных, зависящей от других пользовательских и (или) системных баз данных. |
| [Доставка жестких дисков в службу импорта и экспорта Windows.](#ship-hard-drive) | SQL Server 2005 или более поздней версии | SQL Server 2005 или более поздней версии | [Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) | Следует использовать [службу импорта и экспорта Windows](../storage/storage-import-export-service.md), когда на ручное копирование требуется слишком много времени, особенно при работе с базами данных очень большого размера. |

## Учебник по работе с мастером развертывания виртуальных машин Azure

Мастер **развертывания баз данных SQL Server на виртуальной машине Microsoft Azure** в Microsoft SQL Server Management Studio используется для переноса локальных пользовательских баз данных SQL Server 2005, SQL Server 2008, SQL Server 2008 R2, SQL Server 2012, SQL Server 2014 или SQL Server 2016 (размером до 1 ТБ включительно) в SQL Server 2014 или SQL Server 2016 на виртуальной машине Azure. Этот мастер используется для переноса пользовательской базы данных на существующую виртуальную машину Azure или на виртуальную машину Azure с SQL Server, созданную мастером в процессе миграции. При переносе базы данных на SQL Server более поздней версии выполняется автоматическое обновление базы данных.

Этот метод предназначен только для классической модели развертывания.

### Получение последней версии мастера развертывания баз данных SQL Server на виртуальной машине Microsoft Azure

Чтобы использовать последнюю версию Microsoft SQL Server Management Studio для SQL Server, требуется последняя версия мастера **развертывания баз данных SQL Server на виртуальной машине Microsoft Azure**. Последняя версия этого мастера включает самые свежие обновления для классического портала Azure и поддерживает самые новые образы виртуальных машин Azure в коллекции (более старые версии мастера могут не работать). Чтобы получить последнюю версию Microsoft SQL Server Management Studio для SQL Server, [скачайте](http://go.microsoft.com/fwlink/?LinkId=616025) и установите ее на клиентском компьютере, подключенном к Интернету и к базе данных, для которой необходимо выполнить миграцию.

### Настройка существующей виртуальной машины Azure и экземпляра SQL Server (если это возможно)

При миграции на существующую виртуальную машину Azure необходимо выполнить указанные ниже действия по настройке.

- Настройте виртуальную машину Azure и экземпляр SQL Server так, чтобы обеспечить подключение с другого компьютера, выполнив процедуру в разделе [Подключение к экземпляру виртуальной машины SQL Server с SSMS на другом компьютере](virtual-machines-windows-sql-connect.md). При миграции с помощью мастера поддерживаются только образы SQL Server 2014 и SQL Server 2016 из коллекции.
- Настройте открытую конечную точку для службы Cloud Adapter SQL Server в шлюзе Microsoft Azure с частным портом 11435. Этот порт создается в процессе подготовки SQL Server 2014 или SQL Server 2016 к работе на виртуальной машине Microsoft Azure. Служба Cloud Adapter также создает правило брандмауэра Windows, чтобы разрешить входящие подключения TCP через порт по умолчанию 11435. Эта конечная точка позволяет мастеру использовать службу Cloud Adapter для копирования файлов резервных копий из локального экземпляра на виртуальную машину Azure. Дополнительные сведения см. в статье [Адаптер облака для SQL Server](https://msdn.microsoft.com/library/dn169301.aspx).

	![Создание конечной точки Cloud Adapter](./media/virtual-machines-windows-migrate-sql/cloud-adapter-endpoint.png)

### Запуск мастера развертывания баз данных SQL Server на виртуальной машине Microsoft Azure

1. Откройте Microsoft SQL Server Management Studio для Microsoft SQL Server 2016 и подключитесь к экземпляру SQL Server с пользовательской базой данных, которую необходимо перенести на виртуальную машину Azure.
2. Щелкните правой кнопкой мыши базу данных, для которой необходимо выполнить миграцию, наведите указатель мыши на пункт "Задачи" и выберите пункт "Развернуть на виртуальной машине Microsoft Azure".

	![Запуск мастера](./media/virtual-machines-windows-migrate-sql/start-wizard.png)

3. На начальной странице нажмите кнопку "Далее".
4. На странице параметров источника подключитесь к экземпляру SQL Server с базой данных, которую необходимо перенести на виртуальную машину Azure.
5. Укажите временное расположение для файлов резервных копий. При подключении к удаленному серверу необходимо указать сетевой диск.

	![Параметры источника](./media/virtual-machines-windows-migrate-sql/source-settings.png)

6. Нажмите кнопку Далее.
7. На странице входа в Microsoft Azure нажмите кнопку "Вход" и войдите в вашу учетную запись Azure.
8. Выберите подписку, которую необходимо использовать, и нажмите кнопку "Далее".

	![Вход в Azure](./media/virtual-machines-windows-migrate-sql/azure-signin.png)

9. На странице параметров развертывания можно указать имя новой или существующей облачной службы и имя виртуальной машины.

 - Чтобы создать облачную службу с новой виртуальной машиной Azure с помощью коллекции образов SQL Server 2014 или SQL Server 2016, укажите имя новой облачной службы и имя виртуальной машины.

     - Если вы указываете имя новой облачной службы, также укажите учетную запись хранения, которую вы будете использовать.

     - Если указать имя существующей облачной службы, сведения об учетной записи хранения будут получены и введены автоматически.

 - Чтобы создать виртуальную машину Azure в существующей облачной службе, укажите имя существующей облачной службы и имя новой виртуальной машины. Укажите только коллекцию образов SQL Server 2014 или SQL Server 2016.
 - Чтобы использовать существующую виртуальную машину Azure, укажите имя существующей облачной службы и имя виртуальной машины. Это должен быть образ, созданный с помощью коллекции образов SQL Server 2014 или SQL Server 2016.

		![Deploymnent Settings](./media/virtual-machines-windows-migrate-sql/deployment-settings.png)

10. Щелкните "Параметры"
  - Если вы укажете имя существующей облачной службы и имя виртуальной машины, то вам будет предложено указать имя пользователя и пароль.

		![Azure machine settings](./media/virtual-machines-windows-migrate-sql/azure-machine-settings.png)

	- Если вы указали имя новой виртуальной машины, вам будет предложено выбрать образ из списка коллекции образов и предоставить указанные ниже сведения.
	  - Образ. Выберите SQL Server 2014 или SQL Server 2016.
		- Имя пользователя
		- Новый пароль.
		- Подтверждение пароля.
		- Расположение
		- Размер.
 	- Кроме того, установите флажок принятия самостоятельно сформированного сертификата для новой виртуальной машины Microsoft Azure и нажмите кнопку ОК.

	![Параметры новой машины в Azure](./media/virtual-machines-windows-migrate-sql/azure-new-machine-settings.png)

11. Укажите имя базы данных назначения, если оно отличается от имени исходной базы данных. Если база данных назначения уже существует, то система автоматически увеличит имя базы данных на единицу и не будет перезаписывать существующую базу данных.
12. Нажмите кнопку "Далее", а затем — кнопку "Готово".

	![Результаты](./media/virtual-machines-windows-migrate-sql/results.png)

13. По завершении работы мастера подключитесь к виртуальной машине и убедитесь, что базы данных успешно перенесены.
14. Если вы создали виртуальную машину, настройте виртуальную машину Azure и экземпляр SQL Server, выполнив процедуру разделе [Подключение к экземпляру виртуальной машины SQL Server с SSMS на другом компьютере](virtual-machines-windows-sql-connect.md).

## Архивация в файл, копирование в виртуальную машину и восстановление

Этот метод применяется, когда невозможно использовать мастер развертывания баз данных SQL Server на виртуальной машине Microsoft Azure, так как вы выполняете миграцию в SQL Server версии, предшествовавшей версии SQL Server 2014, или размер файла резервной копии превышает 1 ТБ. Если размер файла резервной копии превышает 1 ТБ, необходимо разбить его на части, так как максимальный размер диска виртуальной машины — 1 ТБ. Для миграции пользовательской базы данных с помощью этого ручного метода выполните указанные ниже общие действия.

1.	Создайте полную резервную копию базы данных в локальном расположении.
2.	Создайте или отправьте виртуальную машину с необходимой версией SQL Server.
3.	Настройте подключения в соответствии со своими требованиями. Ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](virtual-machines-windows-sql-connect.md).
4.	Скопируйте файлы резервной копии в виртуальную машину с помощью удаленного рабочего стола, проводника Windows или команды копирования в командной строке.

## Архивация в URL-адрес и восстановление

Метод [архивации в URL-адрес](https://msdn.microsoft.com/library/dn435916.aspx) используется, когда невозможно использовать мастер развертывания баз данных SQL Server на виртуальной машине Microsoft Azure из-за того, что размер файла резервной копии превышает 1 TB и вы выполняете миграцию с SQL Server 2016 или на него. Если размер базы данных меньше 1 ТБ или используется SQL Server версии, предшествовавшей SQL Server 2016, рекомендуется использовать мастер. SQL Server 2016 поддерживает разбитые на части наборы резервных копий. Рекомендуется использовать их для повышения производительности и в случаях, когда необходимо обойти ограничения размера на один большой двоичный объект. Для очень больших баз данных рекомендуется использовать [службы импорта и экспорта Windows](../storage/storage-import-export-service.md).

## Отключение, копирование с указанием URL-адреса и подключение с использованием URL-адреса

Используйте этот метод, если необходимо [сохранить файлы с помощью службы хранилища больших двоичных объектов Azure](https://msdn.microsoft.com/library/dn385720.aspx) и подключить их к SQL Server на виртуальной машине Azure, особенно при работе с очень большими базами данных. Для миграции пользовательской базы данных с помощью этого ручного метода выполните указанные ниже общие действия.

1.	Отключите файлы базы данных от локального экземпляра базы данных.
2.	Скопируйте отключенные файлы базы данных в хранилище больших двоичных объектов Azure с помощью [служебной программы командной строки AZCopy](../storage/storage-use-azcopy.md).
3.	Подключите файлы базы данных из URL-адреса Azure к экземпляру SQL Server в виртуальной машине Azure.

## Преобразование в виртуальную машину, отправка на URL-адрес и развертывание в качестве новой виртуальной машины

Этот метод используется для переноса всех системных и пользовательских баз данных из локального экземпляра SQL Server на виртуальную машину Azure. Для переноса всего экземпляра SQL Server с помощью этого ручного метода выполните указанные ниже действия.

1.	Преобразуйте физические или виртуальные машины в VHD Hyper-V с помощью средства [Microsoft Virtual Machine Converter](http://technet.microsoft.com/library/dn873998.aspx).
2.	Отправьте VHD-файлы в службу хранилища Azure с помощью [командлета Add-AzureVHD](https://msdn.microsoft.com/library/windowsazure/dn495173.aspx).
3.	Разверните новую виртуальную машину на базе отправленного VHD-файла.

> [AZURE.NOTE] Чтобы перенести приложение целиком, можно воспользоваться [Azure Site Recovery](../site-recovery/site-recovery-overview.md).

## Отправка жестких дисков

Для передачи больших объемов данных в хранилище больших двоичных объектов Azure в ситуациях, когда отправка этих данных по сети чрезвычайно дорога или невыполнима, можно использовать [службу импорта и экспорта Windows](../storage/storage-import-export-service.md). При использовании этой службы можно отправить один или несколько жестких дисков с данными в центр обработки данных Azure, где данные будут перемещены в вашу учетную запись хранения.

## Дальнейшие действия

Подробные сведения о работе SQL Server на виртуальных машинах Azure см. в разделе [Общие сведения об SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

<!---HONumber=AcomDC_0608_2016-->