<properties
	pageTitle="Поддерживаемый платформой перенос ресурсов IaaS из классической модели в модель Azure Resource Manager | Microsoft Azure"
	description="В этой статье последовательно описывается поддерживаемый платформой перенос ресурсов из классической модели в модель Azure Resource Manager."
	services="virtual-machines-windows"
	documentationCenter=""
	authors="mahthi"
	manager="timlt"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machines-windows"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/22/2016"
	ms.author="mahthi"/>

# Поддерживаемый платформой перенос ресурсов IaaS из классической модели в модель Azure Resource Manager

В этой статье описывается, как обеспечить перенос ресурсов IaaS из классической модели в модель развертывания с помощью Resource Manager. Вы можете узнать больше о [возможностях и преимуществах Azure Resource Manager](../resource-group-overview.md). Мы подробно рассматриваем, как связать ресурсы из двух моделей развертывания и обеспечить их сосуществование в подписке с помощью шлюзов с подключением типа "сеть — сеть" в виртуальной сети.

## Цель миграции

Resource Manager позволяет развертывать сложные приложения с помощью шаблонов, настраивать виртуальные машины с помощью расширений виртуальных машин и внедрять управление доступом и добавление тегов. Azure Resource Manager позволяет выполнить масштабируемое параллельное развертывание виртуальных машин в группах доступности. Новая модель предоставляет также возможности независимого управления жизненным циклом вычислительных и сетевых ресурсов, а также ресурсов хранилища. И наконец, благодаря принудительному использованию виртуальных машин в виртуальной сети появилась возможность включать защиту по умолчанию.

Почти все функции для выполнения вычислений, работы с сетью и хранилищем из классической модели развертывания поддерживаются в модели Azure Resource Manager. Чтобы использовать преимущества новых возможностей Azure Resource Manager, можно перенести существующие развернутые службы из классической модели развертывания.

## Изменение возможностей автоматизации и набора инструментов после миграции

При переносе ресурсов из классической модели в модель развертывания с помощью Resource Manager требуется обновить существующую службу автоматизации или набор инструментов, чтобы обеспечить их работу после миграции.

## Значение переноса ресурсов IaaS из классической модели в модель Resource Manager

Прежде чем углубиться в подробности, давайте остановимся на отличиях между операциями с ресурсами IaaS в плоскости данных и плоскости управления.

- *Плоскость управления* описывает вызовы, поступающие в плоскость управления или API для изменения ресурсов. Например, такие операции, как создание виртуальной машины, перезапуск виртуальной машины и добавление в виртуальную сеть новой подсети, оперируют работающими ресурсами. Они не оказывают непосредственного влияния на подключение к экземплярам.
- *Плоскость данных* (приложение) описывает среду выполнения приложения, включая взаимодействие с экземплярами, которое не осуществляется через API Azure. Доступ к веб-сайту или извлечение данных из работающего экземпляра SQL Server или сервера MongoDB будут считаться операциями в плоскости данных или взаимодействием с приложением. Копирование большого двоичного объекта из учетной записи хранения и доступ к общедоступному IP-адресу для подключения к виртуальной машине по протоколу RDP или SSH также являются операциями в плоскости данных. Эти операции обеспечивают рабочее состояние приложения для вычислительных и сетевых ресурсов, а также ресурсов хранения.

>[AZURE.NOTE] В некоторых сценариях миграции платформа Azure останавливает, освобождает и перезапускает виртуальные машины. Это приводит к кратковременному простою плоскости данных.

## Поддерживаемые области применения миграции

Доступны три области применения миграции, которые нацелены в первую очередь на вычислительные ресурсы, а также ресурсы сети и хранилища.

### Перенос виртуальных машин (не в виртуальной сети)

В модели развертывания с помощью Resource Manager защита приложений применяется принудительно по умолчанию. В данной модели все виртуальные машины должны находиться в виртуальной сети. Платформа Azure перезапускает (`Stop`, `Deallocate` и `Start`) виртуальные машины в ходе миграции. Существует два варианта для виртуальных сетей.

- Вы можете отправить к платформе запрос на создание новой виртуальной сети и перенести виртуальную машину в нее.
- Вы можете перенести виртуальную машину в существующую виртуальную сеть в Resource Manager.

>[AZURE.NOTE] При такой области применения во время миграции, возможно, какое-то время будет запрещено выполнять операции в плоскости управления и плоскости данных.

### Перенос виртуальных машин (в виртуальной сети)

Для большинства конфигураций виртуальных машин между классической моделью и моделью развертывания с помощью Resource Manager переносятся только метаданные. Базовые виртуальные машины работают на одном оборудовании, в одной сети и в одном хранилище. При миграции в течение определенного периода, возможно, будет запрещено выполнять операции в плоскости управления. Однако выполнение операций в плоскости данных прерываться не будет. То есть приложения, запущенные в виртуальных машинах (классическая модель), не будут простаивать во время миграции.

Следующие конфигурации сейчас не поддерживаются. В случае добавления поддержки для них в будущем возможен простой некоторых виртуальных машин в этой конфигурации (из-за операций остановки, освобождения и перезапуска).

-	В отдельной облачной службе есть несколько групп доступности.
-	В отдельной облачной службе есть одна или несколько групп доступности, а также виртуальные машины, которые не входят в группу доступности.

>[AZURE.NOTE] При такой области применения миграции в течение определенного периода, возможно, будет запрещено выполнять операции в плоскости управления. В некоторых конфигурациях, как описано выше, будет возникать простой операций в плоскости данных.

### Перенос учетных записей хранения

Чтобы обеспечить бесперебойную миграцию, вы можете развернуть виртуальные машины Resource Manager в классической учетной записи хранения. Благодаря этой возможности вычислительные и сетевые ресурсы можно и нужно переносить независимо от учетных записей хранения. После миграции виртуальных машин и виртуальной сети для завершения процесса необходимо перенести учетные записи хранения.

>[AZURE.NOTE] В модели развертывания с помощью Resource Manager отсутствуют понятия классических образов и дисков. После переноса учетной записи хранения классические образы и диски не будут отображаться в стеке Resource Manager, но резервные виртуальные жесткие диски останутся в учетной записи хранения.

## Неподдерживаемые компоненты и конфигурации

В настоящее время не поддерживаются некоторые компоненты и конфигурации. В следующих разделах приведены рекомендации по ним.

### Неподдерживаемые функции

Следующие функции сейчас не поддерживаются. Дополнительно вы можете удалить эти параметры, перенести виртуальные машины, а затем повторно включить параметры в модели развертывания с помощью Resource Manager.

Поставщик ресурсов | Функция
---------- | ------------
Среда выполнения приложений | Несвязанные диски виртуальных машин.
Среда выполнения приложений | Образы виртуальных машин.
Сеть | Списки управления доступом для конечной точки.
Сеть | Шлюзы виртуальной сети ("сеть — сеть", Azure ExpressRoute, шлюз приложений, "точка — сеть").
Сеть | Виртуальные сети с использованием пиринга. (Переносе виртуальной сети в ARM с последующей реализацией пиринга.) Узнайте больше о [пиринговой виртуальной сети](../virtual-network/virtual-network-peering-overview.md).
Сеть | Профили диспетчера трафика.

### Неподдерживаемые конфигурации

Следующие конфигурации сейчас не поддерживаются.

служба | Конфигурация | Рекомендации
---------- | ------------ | ------------
Диспетчер ресурсов | Управление доступом на основе ролей (RBAC) для классических ресурсов | Так как после миграции универсальные коды ресурсов (URI) меняются, рекомендуется спланировать обновления политики RBAC, которые должны быть применены после миграции.
Среда выполнения приложений | Несколько подсетей, связанных с одной виртуальной машиной | Обновите конфигурацию подсетей, чтобы в ссылках были указаны только подсети.
Среда выполнения приложений | Виртуальные машины, размещенные в виртуальной сети, но без явно назначенной подсети | При необходимости можно удалить виртуальную машину.
Среда выполнения приложений | Виртуальные машины с оповещениями и политиками автомасштабирования | По мере выполнения миграции эти параметры будут удалены. Поэтому перед миграцией настоятельно рекомендуется оценить среду. Как вариант, можно настроить параметры оповещений после завершения миграции.
Среда выполнения приложений | Расширения виртуальных машин XML (отладчик Visual Studio, веб-развертывания и удаленная отладка) | Это не поддерживается. Чтобы продолжить миграцию, рекомендуется удалить эти расширения из виртуальной машины.
Среда выполнения приложений | Диагностика загрузки при использовании хранилища уровня "Премиум" | Отключите функцию диагностики загрузки для виртуальных машин, прежде чем продолжить миграцию. После завершения переноса можно будет включить диагностику загрузки в стеке Resource Manager. Кроме того, следует удалить большие двоичные объекты, которые используются для хранения снимков экрана и последовательных журналов, чтобы больше не оплачивать их.
Среда выполнения приложений | Облачные службы, содержащие веб-роли и рабочие роли | В настоящее время это не поддерживается.
Сеть | Виртуальные сети, содержащие виртуальные машины, а также веб-роли и рабочие роли | В настоящее время это не поддерживается.
Служба приложений Azure | Виртуальные сети, содержащие среды службы приложений | В настоящее время это не поддерживается.
Azure HDInsight | Виртуальные сети, содержащие службы HDInsight | В настоящее время это не поддерживается.
Microsoft Dynamics Lifecycle Services | Виртуальные сети, содержащие виртуальные машины под управлением служб Dynamics Lifecycle Services | В настоящее время это не поддерживается.

## Процесс миграции

Прежде чем начать миграцию, настоятельно рекомендуется следующее.

- Убедитесь, что ресурсы, которые вы хотите перенести, не используют какие-либо неподдерживаемые компоненты или конфигурации. Обычно платформа обнаруживает такие проблемы и выдает ошибку.
- В ходе подготовки виртуальные машины, которые не находятся в виртуальной сети, будут остановлены, а их распределение отменено. Если вы не хотите потерять общедоступный IP-адрес, зарезервируйте его, прежде чем начать подготовку. Тем не менее, если виртуальные машины расположены в виртуальной сети, то они не будут остановлены и освобождены.
- Планируйте провести миграцию в нерабочее время, чтобы справиться с любыми непредвиденными сбоями, которые могут возникнуть.
- Скачайте текущую конфигурацию виртуальных машин с помощью PowerShell, команд интерфейса командной строки или интерфейсов REST API, чтобы упростить проверку после завершения подготовки.
- Обновите сценарии автоматизации и ввода в эксплуатацию для работы с моделью развертывания с помощью Resource Manager, прежде чем начать миграцию. При необходимости можно выполнять операции GET, пока ресурсы находятся в состоянии подготовки.
- Оцените политики RBAC, настроенные для классических ресурсов IaaS, и составьте план на период после завершения миграции.

Ниже представлен рабочий процесс переноса.

![Снимок экрана с этапами миграции](./media/virtual-machines-windows-migration-classic-resource-manager/migration-workflow.png)

>[AZURE.NOTE] Все операции, описанные в следующих разделах, являются идемпотентными. Если вы столкнетесь с какой-либо проблемой, не связанной с неподдерживаемой функцией или ошибкой конфигурации, мы рекомендуем повторить подготовку, прервать или зафиксировать текущую операцию. Платформа Azure попытается повторить это действие.

### Проверка

Операция проверки — это первый шаг в процессе переноса. Цель этого шага — анализировать данные для переносимых ресурсов в фоновом режиме и сообщать об успешном завершении или сбое в зависимости от того, можно ли перенести ресурсы.

Вы выберете виртуальную сеть или размещенную службу (если она не является виртуальной сетью), которую нужно проверить перед переносом.

* Если ресурс невозможно перенести, то платформа Azure укажет все соответствующие причины.

### Подготовка.

Операция подготовки — это второй шаг в процессе переноса. На этом этапе моделируется преобразование классических ресурсов IaaS в ресурсы Resource Manager, после чего на экране рядом отображаются ресурсы до и после преобразования для наглядности.

Следует выбрать виртуальную сеть или размещенную службу (если она не является виртуальной сетью), которую нужно подготовить к миграции.

* Если ресурс не может быть перенесен, платформа Azure остановит процесс переноса и укажет причину, по которой не удалось выполнить операцию подготовки.
* Если ресурс можно перенести, платформа Azure сначала заблокирует для него операции в плоскости управления для переносимых ресурсов. Например, вы не сможете добавить диск данных в виртуальную машину, которая переносится.

Затем платформа Azure начнет перенос метаданных переносимых ресурсов из классической модели в модель Resource Manager.

После завершения подготовки можно будет визуализировать ресурсы в классической модели и модели Resource Manager. Для каждой облачной службы в классической модели развертывания платформа Azure создает имя группы ресурсов по шаблону `cloud-service-name>-migrated`.

>[AZURE.NOTE] Виртуальные машины, не входящие в классическую виртуальную сеть, на этом этапе миграции будут остановлены и освобождены.

### Проверка (вручную или с помощью сценария)

На этапе проверки можно дополнительно использовать конфигурацию, скачанную ранее, чтобы проверить, выполнена ли миграция правильно. Можно также войти на портал и выборочно просмотреть свойства и ресурсы, чтобы проверить, выполнена ли миграция метаданных должным образом.

В случае переноса виртуальной сети большинство конфигураций виртуальных машин не будут перезапущены. Однако можно проверить, работают ли приложения в виртуальных машинах.

Можно проверить мониторинг и автоматизацию, а также рабочие сценарии, чтобы убедиться, что виртуальные машины работают надлежащим образом и обновленные сценарии работают правильно. Если ресурсы находятся в состоянии подготовки, то для них доступны только операции GET.

Длительность миграции не фиксирована. В этом состоянии время не ограничено. Тем не менее плоскость управления для этих ресурсов будет заблокирована, пока не будет выполнено прерывание или фиксация.

Если возникнут какие-либо неполадки, всегда можно прервать миграцию и вернуться к классической модели развертывания. После этого платформа Azure разблокирует операции с ресурсами в плоскости управления, чтобы вы могли возобновить обычную работу этих виртуальных машин в классической модели развертывания.

### Прерывание

Прерывание — необязательный шаг, который позволяет отменить изменения классической модели развертывания и прервать миграцию.

>[AZURE.NOTE] Эту операцию нельзя выполнить, если вы активировали фиксацию.

### Фиксация

После завершения проверки миграцию можно зафиксировать. Ресурсы больше не будут отображаться в классической модели и будут доступны только в модели развертывания с помощью Resource Manager. Перенесенными ресурсами можно управлять только на новом портале.

>[AZURE.NOTE] Эта идемпотентная операция. В случае сбоя этой операции рекомендуется повторить попытку. Если проблема не устраняется, отправьте запрос в службу поддержки или создайте запись с тегом ClassicIaaSMigration на нашем [форуме о виртуальных машинах](https://social.msdn.microsoft.com/Forums/azure/ru-RU/home?forum=WAVirtualMachinesforWindows).

## Часто задаваемые вопросы

**Влияет ли этот план миграции на существующие службы или приложения, которые выполняются на виртуальных машинах Azure?**

Нет. Виртуальные машины (классические) — это службы, которые полностью поддерживаются в общедоступной версии. Можно продолжать использовать эти ресурсы, чтобы расширить занимаемый объем в Microsoft Azure.

**Что произойдет с моей виртуальной машиной, если я не планирую перенос в ближайшем будущем?**

Мы не прекратим предоставлять поддержку существующих интерфейсов API и ресурсов классической модели. Мы хотим максимально упростить миграцию с помощью расширенных функций, доступных в модели развертывания с помощью Resource Manager. Настоятельно рекомендуется рассмотреть [некоторые улучшения](virtual-machines-windows-compare-deployment-models.md), добавленные в Resource Manager как часть IaaS.

**Как изменятся существующие средства с этим планом миграции?**

Одним из важнейших изменений, которое следует учесть в плане миграции, является обновление набора инструментов до модели развертывания Resource Manager.

**Сколько времени продлится простой плоскости управления?**

Это зависит от числа переносимых ресурсов. В случае развертываний небольшого размера (с несколькими десятками виртуальных машин) вся миграция должна занимать не больше часа. В случае крупномасштабных развертываний (с сотнями виртуальных машин) миграция может длиться несколько часов.

**Можно ли выполнить откат после фиксации переносимых ресурсов в Resource Manager?**

Миграцию можно прервать, пока ресурсы находятся в состоянии подготовки. Откат после миграции ресурсов с фиксацией не поддерживается.

**Можно ли откатить миграцию при сбое фиксации?**

Прервать миграцию при сбое фиксации нельзя. Все операции миграции, включая фиксацию, являются идемпотентными. Поэтому рекомендуется повторить операцию спустя некоторое время. Если ошибка все равно возникает, отправьте запрос в службу поддержки или создайте запись с тегом ClassicIaaSMigration на нашем [форуме о виртуальных машинах](https://social.msdn.microsoft.com/Forums/azure/ru-RU/home?forum=WAVirtualMachinesforWindows).

**Нужно ли приобретать еще один канал ExpressRoute, если нужно использовать ресурсы IaaS в модели Resource Manager?**

Нет. Мы недавно сделали возможным [сосуществование канала ExpressRoute в классической модели и модели Resource Manager](../expressroute/expressroute-howto-coexist-resource-manager.md). Поэтому при наличии существующего канала ExpressRoute не нужно приобретать еще один.

**Что произойдет, если для классических ресурсов IaaS настроено управление доступом на основе ролей?**

Во время миграции ресурсы преобразуются из классической модели в модель Resource Manager. Поэтому рекомендуется спланировать обновления политики RBAC, которые следует применить после миграции.

**Что если я использую Azure Site Recovery или службу архивации Azure в настоящее время?**

Недавно мы добавили поддержку Azure Site Recovery и службы архивации Azure в Resource Manager. Кроме того, мы активно работаем над поддержкой переноса виртуальных машин в Resource Manager. В настоящее время, если вы используете эти функции, рекомендуется не выполнять миграцию.

**Можно ли проверить подписку или ресурсы, чтобы узнать, подходят ли они для миграции?**

Да. На первом этапе подготовки к поддерживаемой платформой миграции проверяется, можно ли перенести ресурсы. В случае сбоя операции проверки вы получите сообщения о всех причинах, из-за которых невозможно выполнить миграцию.

**Что произойдет, если при подготовке ресурсов IaaS к миграции произойдет ошибка, связанная с квотой?**

Рекомендуется прервать миграцию и отправить в службу поддержки запрос на увеличение квот в регионе, в который переносятся виртуальные машины. После утверждения запроса на увеличение квоты начните этапы миграции заново.

**Как сообщить о проблеме?**

Публикуйте проблемы и вопросы, связанные с переносом, на нашем [форуме о виртуальных машинах](https://social.msdn.microsoft.com/Forums/azure/ru-RU/home?forum=WAVirtualMachinesforWindows), указывая ключевое слово ClassicIaaSMigration. Рекомендуется публиковать на этом форуме все свои вопросы. Если у вас есть контракт на техническую поддержку, то вы всегда можете зарегистрировать запрос в службу поддержки.

**Что делать, если мне не нравятся имена, которые платформа выбрала для ресурсов во время миграции?**

Имена всех ресурсов, которые указаны явным образом в классической модели развертывания, при миграции будут сохранены. В некоторых случаях будут создаваться новые ресурсы. Например, для каждой виртуальной машины создается сетевой интерфейс. В данный момент возможность управления именами этих новых ресурсов, создаваемых во время миграции, не поддерживается. Проголосуйте за эту функцию на [форуме отзывов об Azure](http://feedback.azure.com).

**Получено сообщение *"VM is reporting the overall agent status as Not Ready. Hence, the VM cannot be migrated. Добейтесь того, чтобы сообщаемое агентом виртуальной машины общее состояние имело значение "Готов"."* или *"VM contains Extension whose Status is not being reported from the VM. Hence, this VM cannot be migrated" (Виртуальная машина содержит расширение, о состоянии которого она не сообщает. Поэтому виртуальную машину нельзя перенести).***

Это сообщение отображается в том случае, когда у виртуальной машины нет исходящего подключения к Интернету. Агент виртуальной машины использует исходящее подключение для обращения к учетной записи хранения Azure, чтобы обновлять состояние агента каждые пять минут.

## Дальнейшие действия
Теперь, когда вы получили представление о миграции классических ресурсов IaaS в Resource Manager, можно приступить к переносу ресурсов.

- [Техническое руководство по поддерживаемому платформой переносу из классической модели в модель Azure Resource Manager](virtual-machines-windows-migration-classic-resource-manager-deep-dive.md)
- [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью Azure PowerShell](virtual-machines-windows-ps-migration-classic-resource-manager.md)
- [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью интерфейса командной строки Azure](virtual-machines-linux-cli-migration-classic-resource-manager.md)
- [Клонирование классической виртуальной машины в Azure Resource Manager с помощью сценариев PowerShell](virtual-machines-windows-migration-scripts.md)

<!---HONumber=AcomDC_0824_2016-->