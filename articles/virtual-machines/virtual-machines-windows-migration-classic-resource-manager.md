<properties
	pageTitle="Поддерживаемый платформой перенос ресурсов IaaS из классической модели в модель Azure Resource Manager"
	description="В этой статье рассматриваются возможности поддерживаемой платформой службы миграции из управления службами в Azure Resource Manager"
	services="virtual-machines-windows"
	documentationCenter=""
	authors="mahthi"
	manager="drewm"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machines-windows"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/04/2016"
	ms.author="mahthi"/>

# Поддерживаемый платформой перенос ресурсов IaaS из классической модели в модель Azure Resource Manager

Почти год назад мы объявили о поддержке виртуальных машин в рамках модели Azure Resource Manager. Вы можете ознакомиться со сведениями об улучшениях и дополнительных возможностях, которые поддерживает решение, в других статьях. Кроме того, мы также предоставили рекомендации о том, как лучше всего подключить ресурсы из двух моделей и обеспечить их сосуществование в подписке с помощью шлюзов с подключением типа "сеть — сеть" в виртуальной сети. В этой статье мы хотели бы объяснить, как мы обеспечиваем перенос ресурсов IaaS из классической модели в модель Resource Manager.

## Цель миграции

Мы поражены возможностями новой модели и интерфейсов API, доступными в виртуальных машинах. Мы думаем, что это действительно сильно изменит способ использования облака. С выпуском новой модели вы получаете возможность не только развертывать и отслеживать связанные службы в группе ресурсов, но и управлять ими. Resource Manager позволяет развертывать сложные приложения с помощью шаблонов, настраивать виртуальные машины с помощью расширений виртуальных машин и внедрить управление доступом и добавление тегов. С его помощью также можно выполнить масштабируемое параллельное развертывание виртуальных машин в группы доступности. Кроме того, новая модель предоставляет возможности независимого управления жизненным циклом для вычислительных и сетевых ресурсов, а также ресурсов хранения. Благодаря принудительному использованию виртуальных машин в виртуальной сети появилась возможность включать защиту по умолчанию.

Azure Resource Manager поддерживает почти все возможности для вычислительных и сетевых ресурсов, а также ресурсов хранения за некоторыми исключениями. Мы активно пытаемся завершить работу над этими недостающими возможностями в течение нескольких месяцев. Кроме того, мы постоянно работаем над улучшением взаимодействия с пользователем и добавляем дополнительные возможности на портал Azure, чтобы объединить различные решения.

В связи с этими возможностями и растущей базой развертываний в новом Azure Resource Manager мы хотим предоставить клиентам возможность переноса существующих развертываний из классической модели.

>[AZURE.NOTE] С этим объявлением мы запускаем общедоступную предварительную версию службы миграции. В течение периода действия общедоступной предварительной версии рекомендуется переносить в подписку Azure только рабочие нагрузки среды разработки и тестирования.

## Изменения возможностей автоматизации и набора средств после миграции

Одно из важных изменений, которые потребуется внести в ходе переноса ресурсов из классической модели в модель Resource Manager, — обновление существующей автоматизации и средств. Это необходимо, чтобы обеспечить работоспособность даже после переноса ресурсов.

## Что значит перенос ресурсов IaaS из классической модели в модель Resource Manager?

Прежде чем углубляться в подробности, мы хотели бы кратко объяснить разницу между операциями с ресурсами IaaS на плоскости данных и на плоскости управления. Очень важно понять эту разницу, так как таким образом мы сможем объяснить, как мы планируем реализовать поддержку миграции.

- Плоскость управления. Сюда относятся вызовы, поступающие на плоскость управления или API, для изменения ресурсов. Например, создание виртуальной машины, перезапуск виртуальной машины, обновление виртуальной сети с добавлением новой подсети и т. д. Все эти операции управляют выполняемыми ресурсами, но не оказывают прямого влияния на подключение к экземплярам.
- Плоскость данных (приложение). Сюда относится среда выполнения приложения, включая взаимодействие с экземплярами, которые не проходят через API Azure. Доступ к веб-сайту или извлечение данных с работающего сервера SQL Server или mongoDB будут считаться операциями на плоскости данных или взаимодействием на уровне приложения. Копирование большого двоичного объекта из учетной записи хранения и доступ к общедоступному IP-адресу для подключения к виртуальной машине по протоколу RDP или SSH также являются операциями на плоскости данных. Эти операции обеспечивают рабочее состояние приложения для вычислительных и сетевых ресурсов, а также ресурсов хранения.

>[AZURE.NOTE] В некоторых сценариях миграции (дополнительные сведения см. в разделе "Неподдерживаемые конфигурации") виртуальные машины будут остановлены (освобождены) и перезапущены. Это приведет к кратковременному простою на плоскости данных.

## Какие типы миграции поддерживаются?

В рамках общедоступной предварительной версии предлагается два типа миграции, предназначенные для вычислительных и сетевых ресурсов. Кроме того, в скором времени планируется предоставить поддержку миграции учетных записей хранения. Тем не менее, чтобы обеспечить бесперебойную миграцию, мы добавили диски для виртуальных машин Resource Manager в классические учетные записи хранения. Подробности описаны в следующих разделах этой статьи.

### Перенос виртуальных машин (не в виртуальную сеть)

В модели развертывания Resource Manager защита приложений применяется принудительно по умолчанию. Таким образом, в этой модели все виртуальные машины должны находиться в виртуальной сети. Следовательно, в ходе миграции будет выполняться перезагрузка (остановка (освобождение) и запуск) виртуальных машин. Для виртуальных сетей доступно несколько вариантов:
- Вы можете отправить платформе запрос на создание виртуальной сети и перенести виртуальную машину в новую виртуальную сеть.
- Вы можете перенести виртуальную машину в существующую виртуальную сеть в Resource Manager.

>[AZURE.NOTE] При этом типе миграции в течение определенного периода, возможно, будет запрещено выполнять операции на плоскости управления и плоскости данных.

### Перенос виртуальных машин (в виртуальную сеть)

Этот тип для большинства конфигураций виртуальных машин предполагает перенос только метаданных между классической моделью и моделью Resource Manager. Базовые виртуальные машины работают на одном оборудовании, в одной сети и в одном хранилище. Таким образом, при переносе метаданных из классической модели в модель Resource Manager в течение определенного периода, возможно, будет запрещено выполнять операции на плоскости управления. Тем не менее плоскость данных будет продолжать работать, т. е. приложения, запущенные в виртуальных машинах (классическая модель), не будут остановлены во время миграции.

Ниже приведены конфигурации, которые в настоящее время не поддерживаются. Тем не менее при добавлении поддержки для них в будущем может быть затронута работа некоторых виртуальных машин в этой конфигурации (остановка (освобождение) и перезапуск):

-	Если в одной облачной службе настроено несколько групп доступности.
-	Если в одной облачной службе настроено несколько групп доступности и виртуальные машины, которые не входят в группу доступности.

>[AZURE.NOTE] При этом типе миграции в течение определенного периода, возможно, будет запрещено выполнять операции на плоскости управления. В некоторых специальных конфигурациях, описанных выше, будет возникать простой на плоскости данных.

### Миграция учетных записей хранения

В настоящее время миграция учетных записей хранения не поддерживается для общедоступной предварительной версии. Тем не менее в скором времени планируется предоставить такую поддержку. При миграции и соответствующих операциях с учетными записями хранения следует учесть два важных аспекта.

- Предоставление возможности развертывания виртуальных машин Resource Manager в классической учетной записи хранения. Чтобы обеспечить бесперебойную миграцию, мы включили возможность развертывания виртуальных машин Resource Manager в классической учетной записи хранения. Благодаря этой возможности вычислительные и сетевые ресурсы можно переносить независимо от учетных записей хранения.
- Рекомендации по миграции в учетную запись хранения. При поддержке миграции в учетную запись хранения платформа будет использовать вычислительные и сетевые ресурсы отдельно от ресурсов учетных записей хранения, чтобы обеспечить удобство работы.

## Неподдерживаемые возможности и конфигурации

В настоящее время не поддерживаются определенные возможности и конфигурации. Мы работаем над тем, чтобы предоставить такую поддержку. В следующем разделе представлены связанные рекомендации и планы.

### Неподдерживаемые функции

Перечисленные ниже возможности не поддерживаются для общедоступной предварительной версии. При необходимости можно удалить эти параметры, перенести виртуальные машины, а затем повторно включить их в модели Resource Manager. Мы планируем предоставить поддержку для большинства из этих возможностей. Они будут выпущены, как только станут доступными.

Поставщик ресурсов | Функция
---------- | ------------
Среда выполнения приложений | Диагностика загрузки
Среда выполнения приложений | Несвязанные диски виртуальных машин
Среда выполнения приложений | Образы виртуальных машин
Сеть | Несвязанные зарезервированные IP-адреса (без привязки к виртуальной машине). Поддерживаются зарезервированные IP-адреса, привязанные к виртуальным машинам
Сеть | Несвязанные группы безопасности сети (без привязки к виртуальной сети или сетевому интерфейсу). Поддерживаются группы безопасности, с которыми связаны виртуальные сети
Сеть | Списки управления доступом для конечной точки
Сеть | Шлюзы виртуальной сети ("сеть — сеть", ExpressRoute, "точка — сеть")
Хранилище | Учетные записи хранения

### Неподдерживаемые конфигурации

Перечисленные ниже конфигурации не поддерживаются для общедоступной предварительной версии. Для них указаны соответствующие рекомендации. Мы планируем предоставить поддержку для некоторых из этих конфигураций. Они будут выпущены, как только станут доступными.

служба | Конфигурация | Рекомендации
---------- | ------------ | ------------
Диспетчер ресурсов | Управление доступом на основе ролей для классических ресурсов | Так как URI ресурсов изменяется после миграции, рекомендуется заранее спланировать обновление политики RBAC, которое следует выполнить после миграции.
Среда выполнения приложений | Несколько подсетей, связанных с одной виртуальной машиной | Следует обновить конфигурацию подсети для связи с одной подсетью.
Среда выполнения приложений | Виртуальные машины, которые относятся к виртуальной сети, но для которых нет явно определенной подсети. | При необходимости можно удалить виртуальную машину. В настоящее время планируется предоставление поддержки этой возможности.
Среда выполнения приложений | Виртуальные машины с поддержкой оповещений и политик автомасштабирования | В этом случае миграция выполнится, а эти параметры будут сброшены. Поэтому перед миграцией рекомендуется оценить среду. Как вариант, можно настроить параметры оповещений после завершения миграции.
Среда выполнения приложений | Расширения XML виртуальных машин (VS Debugger, WebDeploy и RemoteDebug) | Эти расширения не будут поддерживаться. Чтобы продолжить миграцию, рекомендуется удалить их из виртуальной машины.
Среда выполнения приложений | Облачные службы, содержащие веб-роли и рабочие роли | В настоящее время такая конфигурация не поддерживается и находится на стадии планирования.
Сеть | Виртуальные сети, содержащие виртуальные машины, а также веб-роли и рабочие роли | В настоящее время такая конфигурация не поддерживается и находится на стадии планирования.
Сеть | Подсети, в именах которых есть пробелы | Планируется предоставление поддержки этой возможности.
Службы приложений | Виртуальная сеть, содержащая среды службы приложений | В настоящее время такая конфигурация не поддерживается и находится на стадии планирования.
Службы HDInsight | Виртуальная сеть, содержащая службы HDInsight | В настоящее время такая конфигурация не поддерживается и находится на стадии планирования.
Службы жизненного цикла Dynamics | Виртуальная сеть, содержащая виртуальные машины, которыми управляют службы Dynamics Lifecycle Services | В настоящее время такая конфигурация не поддерживается и находится на стадии планирования.

## Процесс миграции

Прежде чем начать миграцию настоятельно рекомендуется выполнить несколько действий:

1. Убедитесь, что ресурсы, которые планируется перенести, не используют неподдерживаемые возможности или конфигурации. В большинстве случаев платформа обнаруживает такие проблемы и выдает ошибку.
2. Виртуальные машины, которые не находятся в виртуальной сети, будут остановлены (освобождены) в ходе подготовки. Поэтому если вы не хотите потерять общедоступный IP-адрес, зарезервируйте его, прежде чем начать подготовку. Виртуальные машины, которые расположены в виртуальной сети, не будут остановлены (освобождены).
3. В Azure рекомендуется настроить тестовую среду с аналогичными параметрами и перенести эти ресурсы, прежде чем переносить рабочие развертывания.
4. Планируйте провести миграцию в нерабочее время, чтобы справиться с любыми непредвиденными сбоями, которые могут возникнуть.
5. Скачайте текущую конфигурацию виртуальных машин с помощью PowerShell, команд интерфейса командной строки или интерфейсов REST API, чтобы упростить проверку после завершения подготовки.
6. Обновите сценарии автоматизации и ввода в эксплуатацию для работы с моделью развертывания Resource Manager перед началом миграции. Кроме того, можно при необходимости выполнить операции GET, если ресурсы находятся в состоянии "Подготовлено".
7. Оцените политики RBAC, настроенные для классических ресурсов IaaS, и составьте план после завершения миграции.

С объявлением общедоступной предварительной версии мы добавили поддержку активации миграции с помощью интерфейсов REST API, PowerShell и интерфейса командной строки Azure. В настоящее время планируется предоставлять поддержку миграции на портале Azure, чтобы вы могли наглядно рассмотреть перенос с классической модели в модель ARM.

![Снимок экрана с этапами миграции](./media/virtual-machines-windows-migration-classic-resource-manager/migration-workflow.png)

1.	Подготовка.
	* Это первый шаг в процессе миграции. На этом этапе имитируется преобразование классических ресурсов IaaS в ресурсы Resource Manager. Эти процессы представляются параллельно для возможности визуализации. Подробные действия описаны ниже.
  * Выберите виртуальную сеть или размещенную службу (если она не является виртуальной сетью), которую нужно подготовить к миграции.
  *	Сначала платформа будет анализировать данные для переносимых ресурсов в фоновом режиме и возвращать сообщения об успешном завершении или сбое в зависимости от того, можно ли перенести ресурсы.
	*	Если ресурсы невозможно перенести, будут указаны соответствующие причины.
	* Если ресурсы можно перенести, платформа блокирует операции для этих ресурсов на плоскости управления. Например, вы не сможете добавить диск данных в виртуальную машину, для которой выполняется миграция.
  *	Затем на платформе будет запущена миграция метаданных переносимых ресурсов из классической модели в модель Resource Manager.  
  *	После завершения подготовки можно визуализировать ресурсы в классической модели и в модели Resource Manager. Для каждой облачной службы в классической модели развертывания мы создадим имя группы ресурсов с шаблоном `cloud-service-name>-migrated`.

2.	Проверка по сценарию или вручную
  * На этом этапе можно дополнительно использовать конфигурацию, скачанную ранее, чтобы проверить, выполнена ли миграция должным образом. Можно также войти на портал и просмотреть свойства и ресурсы на наличие ошибок, чтобы проверить, выполнена ли миграция метаданных должным образом.
	* При миграции виртуальной сети большинство конфигураций виртуальных машин не будут перезапущены. Однако можно проверить, работают ли приложения в виртуальных машинах.
	* Можно проверить мониторинг и автоматизацию, а также рабочие сценарии, чтобы убедиться, что виртуальные машины работают надлежащим образом и обновленные сценарии работают правильно. Обратите внимание, что если ресурсы находятся в состоянии "Подготовлено", будут поддерживаться только операции GET.
  * Вам не нужно зафиксировать миграцию в течение строго определенного срока. В этом состоянии время не ограничено. Однако имейте в виду, что плоскость управления для этих ресурсов будет заблокирована, пока не будет выполнено прерывание или фиксация.
  * Если возникнут любые неполадки, всегда можно прервать миграцию и вернуться к классической модели развертывания. После этого операции с ресурсами на плоскости управления будут разблокированы, чтобы вы могли выполнять операции в нормальном режиме на этих виртуальных машинах в классической модели развертывания.

3. Прерывание
  * Это необязательный шаг, который позволяет вернуться к классической модели развертывания и прервать миграцию. Обратите внимание на то, что эту операцию невозможно выполнить после запуска операции фиксации. 	

4.	Фиксация
  * После проверки можно зафиксировать миграцию. Ресурсы перестанут отображаться в классической модели и станут доступны только в модели развертывания Resource Manager. Это также означает, что перенесенными ресурсами можно управлять только на новом портале.
	* При сбое этой операции рекомендуется выполнить ее повторно несколько раз. Если проблема не устраняется, отправьте запрос в службу поддержки или оставьте запись на форуме с тегом ClassicIaaSMigration [здесь](https://social.msdn.microsoft.com/Forums/azure/ru-RU/home?forum=WAVirtualMachinesforWindows).

>[AZURE.NOTE] Обратите внимание, что все описанные ниже действия являются идемпотентными. Если вы столкнетесь с любой проблемой, кроме сообщений о неподдерживаемых функциях или ошибках конфигурации, мы рекомендуем повторить подготовку, отменить или зафиксировать текущую операцию. Платформа автоматически повторит попытку.

## Дальнейшие действия
Теперь, когда вы получили представление о миграции классических ресурсов IaaS в Resource Manager, можно приступить к переносу ресурсов.

- [Техническое руководство по поддерживаемому платформой переносу из классической модели в модель Azure Resource Manager](virtual-machines-windows-migration-classic-resource-manager-deep-dive.md)
- [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью Azure PowerShell](virtual-machines-windows-ps-migration-classic-resource-manager.md)
- [Use CLI to migrate IaaS resources from Classic to Azure Resource Manager](virtual-machines-linux-cli-migration-classic-resource-manager.md) (Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью интерфейса командной строки Azure)
- [Клонирование классической виртуальной машины в Azure Resource Manager с помощью сценариев PowerShell](virtual-machines-windows-migration-scripts.md)

## Часто задаваемые вопросы

**Влияет ли этот план миграции на существующие службы или приложения, которые выполняются на виртуальных машинах Azure?**

Нет. Виртуальные машины (классические) являются полностью поддерживаемыми общедоступными службами. Поэтому можно продолжать использовать эти ресурсы, чтобы расширить инфраструктуру в облаке Microsoft Azure.

**Что произойдет с моей виртуальной машиной, если я не планирую перенос в ближайшем будущем?**

Мы не прекратим предоставлять поддержку существующих интерфейсов API и ресурсов классической модели. Мы хотим максимально упростить миграцию с помощью расширенных функций, доступных в модели развертывания Resource Manager. Поэтому настоятельно рекомендуется рассмотреть некоторые улучшения, добавленные в Resource Manager как часть IaaS, [здесь](virtual-machines-windows-compare-deployment-models.md).

**Как изменятся существующие средства с этим планом миграции?**

При планировании миграции важнее всего обновить средства до модели развертывания Resource Manager.

**Сколько времени продлится простой плоскости управления?**

Это зависит от числа переносимых ресурсов. Для развертываний небольшого размера (несколько десятков виртуальных машин) вся миграция будет выполнена в течение часа. Однако для крупномасштабных развертываний (сотни виртуальных машин) это может занять несколько часов. Учитывая то, что служба находится на этапе общедоступной предварительной версии, настоятельно рекомендуется выполнить миграцию в подписке среды разработки или тестирования, чтобы оценить влияние.

**Можно ли выполнить откат после фиксации переносимых ресурсов в Resource Manager?**

Миграцию можно прервать при условии, что ресурсы находятся в состоянии "Подготовлено". Откат не поддерживается после миграции ресурсов с использованием операции фиксации.

**Можно ли откатить миграцию при сбое фиксации?**

Откатить миграцию при сбое фиксации нельзя. Все операции миграции, включая операцию фиксации, являются идемпотентными. Поэтому рекомендуется повторить операцию спустя некоторое время. Если ошибка все равно возникает, отправьте запрос в службу поддержки или оставьте запись на форуме с тегом ClassicIaaSMigration [здесь](https://social.msdn.microsoft.com/Forums/azure/ru-RU/home?forum=WAVirtualMachinesforWindows).

**Нужно ли приобретать другой канал ExpressRoute, если нужно использовать ресурсы IaaS в Resource Manager?**

Нет. Мы недавно обеспечили [возможность сосуществования канала ExpressRoute в классической модели и модели Resource Manager](../expressroute/expressroute-howto-coexist-resource-manager.md). Поэтому при наличии существующего канала ExpressRoute не нужно приобретать новый.

**У вас есть план добавления неподдерживаемых сценариев в список миграции?**

В настоящее время мы планируем развернуть первый набор сценариев в первом полугодии 2016 года. После первого выпуска мы продолжим добавлять поддержку таких функций.

**Что произойдет, если для классических ресурсов IaaS настроено управление доступом на основе ролей?**

Во время миграции ресурсы преобразуются из классической модели в модель Resource Manager. Поэтому рекомендуется заранее спланировать обновление политики RBAC, которое следует выполнить после миграции.

**Что произойдет, если я использую службу Azure Site Recovery или службу архивации Azure в среде Azure в настоящее время?**

Недавно мы добавили поддержку службы Azure Site Recovery и службы архивации Azure для виртуальных машин в Resource Manager. Мы активно сотрудничаем с группами, работающими над этими решениями, чтобы также включить возможность поддержки миграции виртуальных машин в Resource Manager. В настоящее время при использовании этих служб рекомендуется не выполнять миграцию.

**Можно ли проверить подписку или ресурсы, чтобы узнать, поддерживают ли они миграцию?**

В данный момент при подготовке выполняется неявная проверка ресурсов, которые подготавливаются к миграции. При подготовке к поддерживаемой платформой миграции сначала требуется проверить, можно ли перенести ресурсы. В случае сбоя проверки ресурсы не будут использоваться. Тем не менее мы также планируем выпустить новое действие для проверки, которое позволит упростить этот процесс.

**Что произойдет, если при подготовке ресурсов IaaS к миграции произойдет ошибка, связанная с квотой?**

В этом случае рекомендуется прервать миграцию. Затем отправьте в службу поддержки запрос на увеличение квоты в регионе, в который переносятся виртуальные машины. После утверждения запроса на увеличение квоты начните миграцию заново.

**Как можно сообщить о проблеме при отсутствии договора на техническую поддержку?**

Публикуйте свои проблемы и вопросы касательно миграции на форуме, посвященном виртуальным машинам, с ключевым словом ClassicIaaSMigration [здесь](https://social.msdn.microsoft.com/Forums/azure/ru-RU/home?forum=WAVirtualMachinesforWindows). Рекомендуется задавать все вопросы на этом форуме. Тем не менее при наличии договора на техническую поддержку вы можете отправить запрос в службу поддержки.

**Что делать, если мне не нравятся имена, которые платформа выбрала для моей группы ресурсов во время миграции?**

Вскоре мы собираемся объявить о поддержке перемещения ресурсов между группами ресурсов. После этого можно будет переместить ресурсы в выбранную группу ресурсов.

**Что делать, если мне не нравятся имена, которые платформа выбрала для ресурсов во время миграции?**

Имена всех ресурсов, которые указаны явным образом в классической модели развертывания, будут сохранены во время миграции. В некоторых случаях будут создаваться дополнительные ресурсы. Например, для каждой виртуальной машины будет создан сетевой интерфейс. В данный момент возможность управления именами этих новых ресурсов, созданных во время миграции, не поддерживается. Проголосовать за добавления этой возможности можно [здесь](http://feedback.azure.com).

<!---HONumber=AcomDC_0511_2016-->