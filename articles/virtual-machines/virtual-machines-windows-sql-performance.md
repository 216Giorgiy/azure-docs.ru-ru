<properties
	pageTitle="Рекомендации по производительности для SQL Server | Microsoft Azure"
	description="Содержит рекомендации по оптимизации производительности SQL Server в виртуальных машинах Microsoft Azure."
	services="virtual-machines-windows"
	documentationCenter="na"
	authors="rothja"
	manager="jhubbard"
	editor=""
	tags="azure-service-management" />

<tags
	ms.service="virtual-machines-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="vm-windows-sql-server"
	ms.workload="infrastructure-services"
	ms.date="09/07/2016"
	ms.author="jroth" />

# Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure

## Обзор

В этом разделе приведены рекомендации по оптимизации производительности SQL Server в виртуальной машине Microsoft Azure. При выполнении SQL Server в виртуальных машинах Azure рекомендуется продолжать использование тех же средств настройки производительности базы данных, которые применяются для SQL Server в локальной серверной среде. Однако производительность реляционной базы данных в общедоступном облаке зависит от многих факторов, таких как размер виртуальной машины и конфигурации дисков с данными.

При создании образов SQL Server [рекомендуется подготовить виртуальные машины на портале Azure](virtual-machines-windows-portal-sql-server-provision.md). В виртуальных машинах SQL Server, подготовленных на портале с помощью Resource Manager, реализованы все эти рекомендации, включая конфигурацию хранилища.

Этот документ содержит инструкции по достижению *оптимальной* производительности SQL Server на виртуальных машинах Azure. Если рабочая нагрузка не так велика, могут потребоваться не все перечисленные ниже оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности и характер рабочих нагрузок.

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-both-include.md)]

## Краткий контрольный список

Ниже приведен краткий контрольный список по обеспечению оптимальной производительности SQL Server на виртуальных машинах Azure.

|Область|Оптимизация|
|---|---|
|[Размер виртуальной машины](#vm-size-guidance)|[DS3](virtual-machines-windows-sizes.md#standard-tier-ds-series) или выше для выпуска SQL Enterprise.<br/><br/>[DS2](virtual-machines-windows-sizes.md#standard-tier-ds-series) или выше для выпусков SQL Standard и Web.|
|[Хранилище](#storage-guidance)|Используйте [хранилище класса Premium](../storage/storage-premium-storage.md). Стандартное хранилище рекомендуется использовать только для разработки и тестирования.<br/><br/>Храните [учетную запись хранения](../storage/storage-create-storage-account.md) и виртуальную машину SQL Server в одном и том же регионе.<br/><br/>Отключите [геоизбыточное хранилище](../storage/storage-redundancy.md) (георепликацию) Azure в учетной записи хранения.|
|[диски;](#disks-guidance)|Используйте как минимум 2 [диска P30](../storage/storage-premium-storage.md#scalability-and-performance-targets-whru-RUing-premium-storage) (1 для файлов журнала, 1 для файлов данных и базы данных TempDB).<br/><br/>Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br/><br/>Включите кэширование операций чтения на дисках, где размещены файлы данных и база данных TempDB.<br/><br/>Не включайте кэширование на дисках, где находится файл журнала.<br/><br/>Важно! Остановите службу SQL Server при изменении параметров кэша для диска виртуальной машины Azure.<br/><br/>Обеспечьте чередование нескольких дисков данных Azure для увеличения пропускной способности ввода-вывода.<br/><br/>Выполняйте форматирование с использованием задокументированных размеров кластера.|
|[ВВОД-ВЫВОД](#io-guidance)|Включите сжатие страниц базы данных.<br/><br/>Включите быструю инициализацию для файлов данных.<br/><br/>Ограничьте или отключите авторасширение базы данных.<br/><br/>Отключите автосжатие базы данных.<br/><br/>Переместите все базы данных на диски с данными, включая системные базы данных.<br/><br/>Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски с данными.<br/><br/>Настройте расположения для хранения файлов резервных копий и баз данных по умолчанию.<br/><br/>Включите заблокированные страницы.<br/><br/>Примените исправления производительности SQL Server.|
|[Зависит от определенных функций](#feature-specific-guidance)|Осуществите архивацию напрямую в хранилище BLOB-объектов.|

Дополнительные сведения о том, *как* выполнить эти оптимизации и *для чего* они необходимы, см. в следующих разделах.

## Рекомендации по выбору размеров виртуальных машин

Для приложений, чувствительных к уровню производительности, рекомендуется использовать следующие [размеры виртуальных машин](virtual-machines-windows-sizes.md).

- **Выпуск SQL Server Enterprise**: DS3 или выше

- **Выпуски SQL Server Standard и Web**: DS2 или выше


## Рекомендации по выбору хранилища

Виртуальные машины серий DS, DSv2 и GS поддерживают [хранилище класса Premium](../storage/storage-premium-storage.md). Для всех производственных рабочих нагрузок рекомендуется хранилище класса Premium.

> [AZURE.WARNING] Стандартное хранилище характеризуется различными задержками и пропускной способностью и рекомендуется только для рабочих нагрузок по разработке и тестированию. Для производственных рабочих нагрузок необходимо использовать хранилище класса Premium.

Кроме того, рекомендуется создать свою учетную запись хранения Azure в одном центре обработки данных с виртуальными машинами SQL Server для уменьшения задержек при передаче данных. При создании учетной записи хранения отключите георепликацию, поскольку согласованный порядок записи на несколько дисков не гарантируется. Вместо этого рекомендуется реализовать средства аварийного восстановления SQL Server между двумя центрами обработки данных Azure. Дополнительные сведения см. в разделе [Высокий уровень доступности и аварийное восстановление для SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-high-availability-dr.md).

## Рекомендации по использованию дисков

Виртуальная машина Azure поддерживает три основных типа дисков:

- **Диск ОС**: при создании виртуальной машины Azure платформа подключает к ней по меньшей мере один диск (обозначенный буквой **C**), используемый в качестве диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.
- **Временный диск**: виртуальные машины Azure содержат еще один диск (обозначенный буквой **D**), который называется временным диском. Это диск на узле, который может использоваться для области временных файлов.
- **Диски данных**: к виртуальной машине можно подключить дополнительные диски данных, которые будут сохранены в хранилище как страничные BLOB-объекты.

В следующих разделах приводятся рекомендации по использованию этих дисков.

### Диск операционной системы

Диск операционной системы — это виртуальный жесткий диск, который можно установить и использовать как диск с установленной операционной системой, данный диск имеет метку **C:**.

По умолчанию для диска операционной системы применяется политика кэширования **Чтение и запись**. Для приложений, чувствительных к уровню производительности, рекомендуется использовать диски данных вместо диска операционной системы. См. подраздел "Диски данных" ниже.

### Временный диск

Диск временного хранилища с меткой **D:** не сохраняется в хранилище больших двоичных объектов. Не храните файлы пользовательской базы данных или файлы журнала транзакций пользователя на диске **D**.

В виртуальных машинах серий D, Dv2 и G роль временного диска выполняет диск на основе SSD. Если рабочая нагрузка усложняет использование базы данных TempDB (например, для временных объектов или сложных соединений), то хранение базы данных TempDB на диске **D** может повысить пропускную способность и уменьшить задержку базы данных TempDB.

Для виртуальных машин (серии D, Dv2 и G), которые поддерживают хранилище класса Premium, рекомендуется хранить базу данных TempDB и (или) расширения буферного пула на диске, поддерживающем хранилище класса Premium, с включенным кэшированием чтения. Существует одно исключение: если работа базы данных TempDB предусматривает большое количество операций записи, то для достижения более высокой производительности можно сохранить базу данных TempDB на локальном диске **D**, который на виртуальных машинах этого размера также является диском на основе SSD.

### Диски данных

- **Использование дисков данных для файлов данных и журналов**: используйте не менее 2 [дисков P30](../storage/storage-premium-storage.md#scalability-and-performance-targets-whru-RUing-premium-storage) хранилища класса Premium, где один диск содержит файлы журнала, а другой — файлы данных и базу данных TempDB.

- **Чередование дисков**: для повышения пропускной способности можно добавить дополнительные диски данных и использовать чередование дисков. Чтобы определить количество дисков данных, необходимые проанализировать число доступных операций ввода-вывода для ваших дисков данных и журналов. Эта информация содержится в таблицах с числом операций ввода-вывода в секунду для [размера виртуальной машины](virtual-machines-windows-sizes.md) и размера диска в следующем разделе: [Использование хранилища класса Premium для дисков](../storage/storage-premium-storage.md). Придерживайтесь приведенных далее рекомендаций.

	- Для Windows 8 и Windows Server 2012 или более поздней версии используйте [дисковые пространства](https://technet.microsoft.com/library/hh831739.aspx). Задайте размер чередования в 64 КБ для рабочих нагрузок OLTP и 256 КБ для рабочих нагрузок хранилища данных, чтобы избежать снижения производительности из-за рассогласования разделов. Кроме того, задайте число столбцов равным количеству физических дисков. Чтобы настроить дисковое пространство с более чем 8 дисками, следует явно задать число столбцов равным количеству дисков с помощью PowerShell (а не пользовательского интерфейса диспетчера серверов). Дополнительные сведения о настройке [дисковых пространств](https://technet.microsoft.com/library/hh831739.aspx) см. в разделе [Командлеты дисковых пространств в Windows PowerShell](https://technet.microsoft.com/library/jj851254.aspx).

	- Для Windows 2008 R2 или более ранней версии можно воспользоваться динамическими дисками (чередующимися томами операционной системы), при этом размер чередования всегда составляет 64 КБ. Обратите внимание, что эта возможность не поддерживается в Windows 8 и Windows Server 2012. Дополнительные сведения см. в заявлении о поддержке в разделе [Служба виртуальных дисков переходит на API управления хранилищами Windows](https://msdn.microsoft.com/library/windows/desktop/hh848071.aspx).

	- Если рабочая нагрузка не слишком активно использует функции ведения журнала и не требует выделенного числа операций ввода-вывода в секунду, можно настроить только один пул носителей. В противном случае создайте два пула носителей: один для файлов журнала и другой для файлов данных и базы данных TempDB. Определите число дисков для каждого пула носителей на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. Дополнительные сведения см. в разделе [Размеры виртуальных машин](virtual-machines-windows-sizes.md).

	- Если хранилище класса Premium не применяется (сценарии разработки и тестирования), то рекомендуется добавить максимальное количество дисков данных, поддерживаемое для вашего [размера виртуальной машины](virtual-machines-windows-sizes.md), и использовать чередование дисков.

- **Политика кэширования**: для дисков данных хранилища класса Premium включите кэширование операций чтения только на дисках данных, где размещаются файлы данных и база данных TempDB. Если хранилище класса Premium не используется, не включайте кэширование ни для каких дисков данных. Указания по настройке кэширования дисков см. в следующих разделах: [Set-AzureOSDisk](https://msdn.microsoft.com/library/azure/jj152847) и [Set-AzureDataDisk](https://msdn.microsoft.com/library/azure/jj152851.aspx).

	>[AZURE.WARNING] Остановите службу SQL Server при настройке кэширования дисков виртуальной машины Azure, чтобы избежать возможного повреждения баз данных.

- **Размер кластера NTFS**: при форматировании диска данных рекомендуется использовать размер кластера 64 КБ для файлов данных и журналов, а также базы данных TempDB.

- **Рекомендации по управлению дисками**: при удалении диска данных или изменении его типа кэша остановите службу SQL Server. При изменении параметров кэширования диска ОС Azure останавливает виртуальную машину, изменяет тип кэша и перезапускает виртуальную машину. При изменении параметров кэша диска данных виртуальная машина не останавливается. Диск данных отключается от нее на время внесения изменений, а затем снова подключается к виртуальной машине.

	>[AZURE.WARNING] Если не останавливать службу SQL Server на время таких операций, это может привести к повреждению базы данных.

## Рекомендации по использованию операций ввода-вывода

- Наилучшие результаты работы с хранилищем класса Premium достигаются при параллелизации приложений и запросов. Хранилище класса Premium предназначено для сценариев, где глубина очереди ввода-вывода больше 1, поэтому прирост производительности для однопоточных последовательных запросов почти не ощущается (даже если они направляются в хранилище в большом объеме). Например, это может негативно повлиять на результаты однопоточного тестирования в средствах анализа производительности, таких как SQLIO.

- Рекомендуется использовать [сжатие страниц базы данных](https://msdn.microsoft.com/library/cc280449.aspx), так как это позволяет повысить производительность рабочих нагрузок с большим объемом операций ввода-вывода. Однако сжатие данных может повысить потребление ресурсов ЦП на сервере базы данных.

- Рекомендуется включить быструю инициализацию файлов для сокращения времени, необходимого для начального выделения файлов. Чтобы воспользоваться преимуществами быстрой инициализации файлов, назначьте SE\_MANAGE\_VOLUME\_NAME учетной записи службы SQL Server (MSSQLSERVER) и добавьте ее в политику безопасности **Выполнение задач по обслуживанию томов**. Если вы используете образ платформы SQL Server для Azure, учетная запись службы по умолчанию (NT Service\\MSSQLSERVER) не добавляется в политику безопасности **Выполнение задач по обслуживанию томов**. Другими словами, быстрая инициализация файлов в образе платформы SQL Server Azure не включена. После добавления учетной записи службы SQL Server в политику безопасности **Выполнение задач по обслуживанию томов** перезапустите службу SQL Server. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в статье [Инициализация файлов базы данных](https://msdn.microsoft.com/library/ms175935.aspx).

- **Авторасширение** считается лишь предупредительной мерой на случай непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. При использовании авторасширения предварительно увеличьте размер файла с помощью параметра размера.

- Убедитесь, что **автосжатие** отключено, чтобы избежать ненужных затрат ресурсов, что может отрицательно повлиять на производительность.

- Переместите все базы данных на диски с данными, включая системные базы данных. Дополнительные сведения см. в статье [Перемещение системных баз данных](https://msdn.microsoft.com/library/ms345408.aspx).

- Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски с данными. Для этого в диспетчере конфигурации SQL Server щелкните правой кнопкой мыши свой экземпляр SQL Server и выберите пункт "Свойства". На вкладке **Параметры запуска** можно изменить параметры файлов трассировки и журнала ошибок. Каталог дампа указан на вкладке **Дополнительно**. На приведенных далее снимках экрана показано, где находится параметр запуска журнала ошибок.

	![Снимок экрана SQL ErrorLog](./media/virtual-machines-windows-sql-performance/sql_server_error_log_location.png)

- Настройка расположений по умолчанию для файлов резервных копий и базы данных. Следуйте рекомендациям в этом разделе и внесите изменения в окне свойств сервера. Инструкции см. в статье [Просмотр или изменение расположения по умолчанию для файлов данных и журналов (среда SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx). На следующем снимке экрана показано, где нужно внести необходимые изменения.

	![Файлы журнала данных SQL и резервных копий](./media/virtual-machines-windows-sql-performance/sql_server_default_data_log_backup_locations.png)

- Включение блокировки страниц для сокращения числа операций ввода-вывода, а также операций разбиения по страницам. Дополнительные сведения см. в статье [Включение параметра "Блокировка страниц в памяти" (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).

- Если вы используете SQL Server 2012, установите накопительный пакет обновления 10 для пакета обновления 1. Это обновление содержит исправление для низкой производительности ввода-вывода при выполнении оператора выборки во временную таблицу в SQL Server 2012. Дополнительные сведения см. в этой [статье базы знаний](http://support.microsoft.com/kb/2958012).

- Рекомендуется сжимать файлы данных при их передаче в среду Azure и из нее.

## Рекомендации по использованию определенных функций

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. В следующем списке перечислены некоторые функции SQL Server, которые могут помочь добиться лучшей производительности:

- **Архивация в службу хранилища Azure**: при выполнении архивации данных SQL Server, запущенного на виртуальных машинах Azure, можно использовать [архивацию SQL Server на URL-адрес](https://msdn.microsoft.com/library/dn435916.aspx). Эта функция доступна, начиная с накопительного пакета обновления 2 для пакета обновления 1 SQL Server 2012, и рекомендуется к применению при архивации на подключенные диски данных. При выполнении архивации или восстановления с использованием службы хранилища Azure следуйте рекомендациям из раздела [Рекомендации по архивации SQL Server на URL-адрес, устранению неполадок и восстановлению из резервных копий в службе хранилища Azure](https://msdn.microsoft.com/library/jj919149.aspx). Кроме того, можно автоматизировать эти процессы архивации с помощью [автоматической архивации для SQL Server в виртуальных машинах Azure](virtual-machines-windows-classic-sql-automated-backup.md).

	В выпусках, предшествующих SQL Server 2012, можно использовать [инструмент архивации SQL Server в Azure](https://www.microsoft.com/download/details.aspx?id=40740). Это средство может помочь повысить пропускную способность при архивации благодаря использованию нескольких чередующихся целей архивации.

- **Файлы данных SQL Server в Azure**: эта новая функция [Файлы данных SQL Server в Azure](https://msdn.microsoft.com/library/dn385720.aspx) доступна, начиная с SQL Server 2014. Выполнение SQL Server с файлами данных в Azure демонстрирует уровень производительности, сравнимый с использованием дисков данных Azure.

## Дальнейшие действия

Если вы заинтересованы в более подробном изучении возможностей SQL Server и хранилища класса Premium, см. статью [Использование хранилища Azure Premium с SQL Server на виртуальных машинах](virtual-machines-windows-classic-sql-server-premium-storage.md).

Рекомендации по безопасности см. в статье [Рекомендации по безопасности SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-security.md).

Просмотрите другие подразделы, посвященные виртуальным машинам SQL Server, в разделе [Общие сведения об SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

<!---HONumber=AcomDC_0907_2016-->