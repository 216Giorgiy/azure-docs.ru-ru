---
title: "Запись образа виртуальной машины Linux с помощью Azure CLI 2.0 | Документация Майкрософт"
description: "Запись и подготовка к работе образа виртуальной машины Azure под управлением Linux, использующей управляемые диски, созданные с помощью Azure CLI 2.0"
services: virtual-machines-linux
documentationcenter: 
author: iainfoulds
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: e608116f-f478-41be-b787-c2ad91b5a802
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: azurecli
ms.topic: article
ms.date: 05/23/2017
ms.author: iainfou
ms.translationtype: Human Translation
ms.sourcegitcommit: 857267f46f6a2d545fc402ebf3a12f21c62ecd21
ms.openlocfilehash: fa0eeb1163c2e0ee01290b18eb696bb1b10fed5f
ms.contentlocale: ru-ru
ms.lasthandoff: 06/28/2017


---
# <a name="how-to-generalize-and-capture-a-linux-virtual-machine"></a>Как подготовить к работе и записать образ виртуальной машины Linux
Чтобы повторно использовать виртуальные машины, развернутые и настроенные в Azure, можно записать образ виртуальной машины. Этот процесс предполагает обобщение виртуальной машины, то есть удаление сведений о личной учетной записи перед развертыванием из образа новых виртуальных машин. В этой статье подробно описано, как записать образ виртуальной машины, использующей Управляемые диски Azure, с помощью Azure CLI 2.0. Эти диски полностью контролируются платформой Azure и не требуют никакой подготовки или хранилища. Дополнительные сведения об Управляемых дисках Azure см. в [этой статье](../../storage/storage-managed-disks-overview.md). В этой статье подробно описано, как записать образ виртуальной машины Linux с помощью Azure CLI 2.0. Эти действия можно также выполнить с помощью [Azure CLI 1.0](capture-image-nodejs.md).

> [!TIP]
> Если вы хотите создать копию существующей виртуальной машины Linux в конкретном состоянии в целях архивации или отладки, ознакомьтесь с разделом [Создание копии виртуальной машины Linux, работающей в Azure](copy-vm.md). А если вам требуется передать виртуальный жесткий диск Linux локальной виртуальной машины, ознакомьтесь с разделом [Передача пользовательского образа диска и создание виртуальной машины Linux на его основе](upload-vhd.md).  


## <a name="before-you-begin"></a>Перед началом работы
Необходимо выполнить следующие условия.

* **Виртуальная машина Azure, созданная в рамках модели развертывания с помощью Resource Manager**. Если вы еще не создали виртуальную машину Linux, для этого можно использовать [портал](quick-create-portal.md), [интерфейс командной строки Azure (Azure CLI)](quick-create-cli.md) или [шаблоны Resource Manager](cli-deploy-templates.md). Настройте виртуальную машину согласно своим требованиям. Например, [добавьте диски данных](add-disk.md), примените обновления и установите приложения. 

Также вам нужно установить последнюю версию [Azure CLI 2.0](/cli/azure/install-az-cli2) и войти в учетную запись Azure с помощью команды [az login](/cli/azure/#login).

## <a name="quick-commands"></a>Быстрые команды
Если вам необходимо быстро выполнить задачу, в следующем разделе описаны основные команды для записи образа виртуальной машины Linux в Azure. Дополнительные сведения и контекст для каждого этапа можно найти в остальной части документа, [начиная отсюда](#detailed-steps). В следующих примерах замените имена параметров собственными значениями. Примеры имен параметров: *myResourceGroup*, *myVM* и *myImage*.

1. Установите SSH-подключение к виртуальной машине и отзовите его с помощью `waagent -deprovision`. Параметр *+user* также удаляет последнюю подготовленную учетную запись пользователя. При вводе учетных данных в виртуальную машину, оставьте параметр *+user*. В следующем примере удаляется последняя подготовленная учетная запись пользователя:

    ```bash
    sudo waagent -deprovision+user -force
    exit
    ```

2. Отмените подготовку виртуальной машины командой [az vm deallocate](/cli/azure/vm#deallocate):

    ```azurecli
    az vm deallocate --resource-group myResourceGroup --name myVM
    ```

3. Обобщите виртуальную машину с помощью команды [az vm generalize](/cli/azure/vm#generalize): При использовании таких средств, как [Packer](http://www.packer.io) для сборки исходной виртуальной машины, пропустите этот шаг, так как образ уже был обобщен.
   
    ```azurecli
    az vm generalize --resource-group myResourceGroup --name myVM
    ```

4. Создайте образ из ресурса виртуальной машины с помощью команды [az image create](/cli/azure/image#create):
   
    ```azurecli
    az image create --resource-group myResourceGroup --name myImage --source myVM
    ```

5. Создайте виртуальную машину из ресурса образа с помощью команды [az vm create](/cli/azure/vm#create):

    ```azurecli
    az vm create --resource-group myResourceGroup --name myVMDeployed --image myImage
        --admin-username azureuser --ssh-key-value ~/.ssh/id_rsa.pub
    ```

## <a name="detailed-steps"></a>Подробные инструкции
В следующих шагах мы отменим выделение имеющейся виртуальной машины, отменим подготовку виртуальной машины и обобщим, а затем создадим образ. Этот образ затем можно использовать для создания виртуальных машин в любой группе ресурсов в рамках вашей подписки. В этом процессе [управляемые диски Azure](../../storage/storage-managed-disks-overview.md) имеют преимущество над неуправляемыми дисками. При работе с неуправляемыми дисками, вы сможете создать виртуальные машины только в той учетной записи хранения, где хранится скопированный большой двоичный объект виртуального жесткого диска. Используя управляемые диски, вы создаете ресурс образа, который затем можно развернуть в любом расположении в пределах подписки.

## <a name="step-1-remove-the-azure-linux-agent"></a>Шаг 1. Удалите агент Linux для Azure
Чтобы подготовить виртуальную машину для обобщения, отмените распределение виртуальной машины с помощью агента виртуальной машины Azure, чтобы удалить некоторые файлы и данные. На целевой виртуальной машине Linux выполните команду `waagent` с параметром *-deprovision*. Параметр *+user* также удаляет последнюю подготовленную учетную запись пользователя. При вводе учетных данных в виртуальную машину, оставьте параметр *+user*. В следующем примере удаляется последняя подготовленная учетная запись пользователя. Дополнительные сведения см. в [руководстве пользователя агента Linux Azure](../windows/agent-user-guide.md).

1. Подключитесь к виртуальной машине Linux c помощью клиента SSH.
2. В окне сеанса SSH введите следующую команду.
   
    ```bash
    sudo waagent -deprovision+user
    ```
   > [!NOTE]
   > Эту команду следует выполнять только на той виртуальной машине, образ которой вы хотите записать. Она не гарантирует, что из образа будет удалена вся конфиденциальная информация и что он будет готов к повторному распространению.
 
3. Чтобы продолжить, введите *y* . Чтобы запрос на подтверждение не появлялся, добавьте параметр *-force* .
4. После выполнения команды введите `exit`. Клиент SSH будет закрыт.

## <a name="step-2-create-vm-image"></a>Шаг 2. Создайте образ виртуальной машины
Используйте Azure CLI 2.0 для подготовки и записи образа виртуальной машины. В следующих примерах замените имена параметров собственными значениями. Примеры имен параметров: *myResourceGroup*, *myVnet* и *myVM*.

1. Отмените подготовку виртуальной машины, распределение которой вы отменили ранее с помощью команды [az vm deallocate](/cli//azure/vm#deallocate). В следующем примере отменяется распределение виртуальной машины *myVM*, входящей в группу ресурсов с именем *myResourceGroup*.
   
    ```azurecli
    az vm deallocate --resource-group myResourceGroup --name myVM
    ```

2. Обобщите виртуальную машину с помощью команды [az vm generalize](/cli//azure/vm#generalize): При использовании таких средств, как [Packer](http://www.packer.io) для сборки исходной виртуальной машины, пропустите этот шаг, так как образ уже был обобщен. В следующем примере обобщается виртуальная машина *myVM*, входящая в группу ресурсов с именем *myResourceGroup*:
   
    ```azurecli
    az vm generalize --resource-group myResourceGroup --name myVM
    ```

3. Теперь создайте образ из ресурса виртуальной машины с помощью команды [az image create](/cli//azure/image#create): В следующем примере создается образ с именем *myImage* в группе ресурсов с именем *myResourceGroup* на основе ресурса виртуальной машины с именем *myVM*:
   
    ```azurecli
    az image create --resource-group myResourceGroup --name myImage --source myVM
    ```
   
   > [!NOTE]
   > Образ создается в той же группе ресурсов, в которой находится исходная виртуальная машина. Виртуальную машину из этого образа можно создать в любой группе ресурсов в рамках вашей подписки. При управлении вам может потребоваться определенная группа ресурсов для ресурсов виртуальной машины и образов.

## <a name="step-3-create-a-vm-from-the-captured-image"></a>Шаг 3. Создание виртуальной машины из записанного образа
Создайте виртуальную машину из образа, который создали ранее с помощью команды [az vm create](/cli/azure/vm#create). В следующем примере создается виртуальная машина *myVMDeployed* из образа *myImage*:

```azurecli
az vm create --resource-group myResourceGroup --name myVMDeployed --image myImage
    --admin-username azureuser --ssh-key-value ~/.ssh/id_rsa.pub
```

Управляемые диски позволяют создавать виртуальные машины из образа в любой группе ресурсов в рамках вашей подписки. Это не так в случае неуправляемых дисков, которые позволяли создать виртуальные машины только в той же учетной записи хранения, где размещен исходный виртуальный жесткий диск. Чтобы создать виртуальную машину в другой группе ресурсов, укажите полный идентификатор ресурса для нужного образа. Список образов можно просмотреть с помощью команды [az image list](/cli/azure/image#list). Вы должны увидеть результат, аналогичный приведенному ниже.

```json
"id": "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage",
   "location": "westus",
   "name": "myImage",
```

В следующем примере используется команда [az vm create](/cli/azure/vm#create) для создания виртуальной машины в группе ресурсов, отличной от той, в которой размещается исходный образ. Для этого мы указываем идентификатор ресурса образа:

```azurecli
az vm create --resource-group myOtherResourceGroup --name myOtherVMDeployed 
    --image "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage"
    --admin-username azureuser --ssh-key-value ~/.ssh/id_rsa.pub
```


### <a name="verify-the-deployment"></a>Проверка развертывания
Чтобы проверить развертывание и начать использовать новую виртуальную машину, подключитесь к ней с помощью SSH-клиента. Чтобы подключиться через SSH, найдите IP-адрес или полное доменное имя виртуальной машины с помощью команды [az vm show](/cli/azure/vm#show):

```azurecli
az vm show --resource-group myResourceGroup --name myVM --show-details
```

## <a name="next-steps"></a>Дальнейшие действия
Вы можете создать несколько виртуальных машин из исходного образа виртуальной машины. В образ при необходимости можно внести изменения следующими действиями. 

- Создайте виртуальную машину из образа.
- Выполните желаемые обновления или изменения конфигурации.
- Повторите весь процесс: отзовите виртуальную машину, освободите ее, подготовьте к работе и запишите образ.
- Используйте этот новый образ для будущих развертываний. При необходимости удалите исходный образ.

Чтобы узнать больше об управлении виртуальными машинами с помощью интерфейса командной строки, ознакомьтесь с [Azure CLI 2.0](/cli/azure/overview).

