---
title: "Создание пользовательских образов виртуальных машин с помощью Azure CLI | Документы Майкрософт"
description: "Руководство по созданию настраиваемого образа виртуальной машины с помощью Azure CLI."
services: virtual-machines-linux
documentationcenter: virtual-machines
author: cynthn
manager: timlt
editor: tysonn
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 05/02/2017
ms.author: cynthn
ms.translationtype: Human Translation
ms.sourcegitcommit: be3ac7755934bca00190db6e21b6527c91a77ec2
ms.openlocfilehash: 2ce92b3f0a21f80eb4294161d6d3a5275c992600
ms.contentlocale: ru-ru
ms.lasthandoff: 05/03/2017

---

# <a name="create-a-custom-image-of-an-azure-vm-using-the-cli"></a>Создание пользовательского образа виртуальной машины Azure с помощью интерфейса командной строки

В этом руководстве вы узнаете, как определить пользовательский образ виртуальной машины Azure. Пользовательские образы позволяют создавать виртуальные машины с помощью уже настроенного образа. Пользовательские образы можно использовать для начальной загрузки двоичных файлов и приложений, конфигураций приложений, определений дисков данных виртуальных машин и других конфигураций операционной системы. При создании пользовательского образа в него добавляется настраиваемая виртуальная машина со всеми подключенными дисками.

Для работы с этим руководством можно использовать последнюю версию [Azure CLI 2.0](/cli/azure/install-azure-cli).

## <a name="before-you-begin"></a>Перед началом работы

Ниже подробно описано, как преобразовать существующую виртуальную машину в многократно используемый пользовательский образ, на основе которого можно создавать экземпляры виртуальной машины.

Для выполнения примера в этом руководстве требуется виртуальная машина. Этот [пример сценария](../scripts/virtual-machines-linux-cli-sample-create-vm-nginx.md) позволяет создать ее при необходимости. При работе с примером по мере необходимости заменяйте имена групп ресурсов и виртуальных машин.

## <a name="prepare-vm"></a>Подготовка виртуальной машины

Чтобы создать образ виртуальной машины, нужно подготовить виртуальную машину, выполнив отзыв, отменив выделение и пометив исходную виртуальную машину как обобщенную.

### <a name="deprovision-the-vm"></a>Отзыв виртуальной машины 

Отзыв обобщает виртуальную машину, удаляя относящиеся к ней сведения. Такое обобщение позволяет развернуть множество виртуальных машин из одного образа. Во время отзыва имя узла сбрасывается и принимает значение *localhost.localdomain*. Ключи узла SSH, конфигурации сервера доменных имен, пароль учетной записи root и кэшированные аренды DHCP также удаляются.

Чтобы отозвать виртуальную машину, используйте агент виртуальной машины Azure (waagent). Агент виртуальной машины Azure устанавливается на виртуальной машине и управляет подготовкой и взаимодействием с контроллером структуры Azure. Дополнительные сведения см. в [руководстве пользователя агента Linux Azure](agent-user-guide.md).

Подключитесь к виртуальной машине с помощью SSH и выполните команду для ее отзыва. При указании аргумента `+user` также удаляется последняя подготовленная учетная запись пользователя вместе со связанными данными. Замените IP-адрес в примере общедоступным IP-адресом виртуальной машины.

Подключитесь к виртуальной машине по протоколу SSH.
```bash
ssh azureuser@52.174.34.95
```
Отзовите виртуальную машину.

```bash
sudo waagent -deprovision+user -force
```
Закройте сеанс SSH.

```bash
exit
```

### <a name="deallocate-and-mark-the-vm-as-generalized"></a>Отмена выделения и пометка виртуальной машины как обобщенной

Чтобы создать образ, нужно отменить выделение виртуальной машины. Отмените выделение виртуальной машины с помощью команды [az vm deallocate](/cli//azure/vm#deallocate). 
   
```azurecli
az vm deallocate --resource-group myRGCaptureImage --name myVM
```

Наконец, сообщите платформе Azure, что виртуальная машина подготовлена к использованию, выполнив команду [az vm generalize](/cli//azure/vm#generalize). Создать образ можно только из подготовленной виртуальной машины.
   
```azurecli
az vm generalize --resource-group myResourceGroupImages --name myVM
```

## <a name="create-the-image"></a>Создание образа

Теперь можно создать образ виртуальной машины с помощью команды [az image create](/cli//azure/image#create). В следующем примере создается образ *myImage* из виртуальной машины *myVM*.
   
```azurecli
az image create \
    --resource-group myResourceGroupImages \
    --name myImage \
    --source myVM
```
 
## <a name="create-vms-from-the-image"></a>Создание виртуальных машин из образа

Теперь, когда образ готов, из него можно создать одну или несколько виртуальных машин с помощью команды [az vm create](/cli/azure/vm#create). В следующем примере создается виртуальная машина *myVMfromImage* из образа *myImage*.

```azurecli
az vm create \
    --resource-group myResourceGroupImages \
    --name myVMfromImage \
    --image myImage \
    --admin-username azureuser \
    --generate-ssh-keys
```

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы научились создавать пользовательские образы виртуальных машин. Перейдите к следующему руководству, чтобы узнать о высокодоступных виртуальных машинах.

[Создание высокодоступных виртуальных машин](tutorial-availability-sets.md)


