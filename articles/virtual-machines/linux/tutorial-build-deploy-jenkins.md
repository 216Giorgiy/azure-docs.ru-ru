---
title: Руководство. Непрерывная интеграция и непрерывное развертывание из Jenkins на виртуальных машинах Azure с помощью Team Services | Документация Майкрософт
description: В этом руководстве описано, как настроить непрерывную интеграцию (CI) и непрерывное развертывание (CD) приложения Node.js с помощью Jenkins на виртуальных машинах Azure из Release Management в Visual Studio Team Services или Microsoft Team Foundation Server.
author: ahomer
manager: douge
editor: tysonn
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 10/19/2017
ms.author: ahomer
ms.custom: mvc
ms.openlocfilehash: fc301edf13f8e6874f0b77440e2b0dc01b2a55fc
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32189937"
---
# <a name="tutorial-deploy-your-app-to-linux-virtual-machines-in-azure-with-using-jenkins-and-visual-studio-team-services"></a>Руководство. Развертывание приложения на виртуальных машинах Linux в Azure с помощью Jenkins и Visual Studio Team Services

Непрерывная интеграция (CI) и непрерывное развертывание (CD) представляют собой конвейер, с помощью которого можно выполнить сборку, выпустить и развернуть свой код. Visual Studio Team Services предоставляет полнофункциональный набор инструментов для автоматизации CI и CD для развертывания в Azure. Jenkins — это популярный сторонний серверный инструмент CI и CD стороннего поставщика, который также обеспечивает автоматизацию этих процессов. Вы можете использовать Team Services и Jenkins вместе, чтобы настроить способ доставки своего облачного приложения или службы.

В этом руководстве для создания веб-приложения Node.js используется Jenkins. Затем вы используете Team Services или Team Foundation Server, чтобы развернуть его в [группе развертывания](https://www.visualstudio.com/docs/build/concepts/definitions/release/deployment-groups/), содержащей виртуальные машины Linux. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Получение примера приложения.
> * Настройка подключаемых модулей Jenkins.
> * Настройка универсального проекта Jenkins для Node.js.
> * Настройка Jenkins для интеграции с Team Services.
> * Создание конечной точки службы Jenkins.
> * Создание группы развертывания для виртуальных машин Azure.
> * Создание определения выпуска в Team Services.
> * Выполнение развертывания вручную и с помощью непрерывной интеграции.

## <a name="before-you-begin"></a>Перед началом работы

* Вам нужен доступ к серверу Jenkins. Если вы еще не создали сервер Jenkins, см. сведения в статье [Создание сервера Jenkins на виртуальной машине Azure под управлением Linux на портале Azure](https://docs.microsoft.com/azure/jenkins/install-jenkins-solution-template). 

* Войдите в учетную запись Team Services (**https://{ваша_учетная _запись}.visualstudio.com**). 
  Вы можете получить [бесплатную учетную запись Team Services](https://go.microsoft.com/fwlink/?LinkId=307137&clcid=0x409&wt.mc_id=o~msft~vscom~home-vsts-hero~27308&campaign=o~msft~vscom~home-vsts-hero~27308).

  > [!NOTE]
  > Дополнительные сведения см. в разделе [Connect to Visual Studio Team Services from Eclipse, Xcode, Visual Studio, and more](https://www.visualstudio.com/docs/setup-admin/team-services/connect-to-visual-studio-team-services) (Подключение к Visual Studio Team Services из Eclipse, Xcode, Visual Studio и других сред).

*  Для целевого развертывания понадобится виртуальная машина Linux.  Для получения дополнительной информации см. статью [Создание виртуальных машин Linux и управление ими с помощью Azure CLI](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-manage-vm).

*  Откройте входящий порт 80 для виртуальной машины. Дополнительные сведения см. в статье [Создание групп безопасности сети с помощью портала Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-create-nsg-arm-pportal).

## <a name="get-the-sample-app"></a>Получение примера приложения

Развертываемое приложение должно храниться в репозитории Git.
В данном руководстве мы рекомендуем использовать [этот пример приложения с сайта GitHub](https://github.com/azooinmyluggage/fabrikam-node). В этом руководстве содержится пример сценария, который использовался во время установки Node.js и приложения. Если нужно работать с собственным репозиторием, следует настроить такой же образец.

Создайте вилку этого приложения и запишите расположение (URL-адрес), чтобы использовать его позже в данном руководстве. Дополнительные сведения см. в статье [Fork a repo](https://help.github.com/articles/fork-a-repo/) (Создание вилки репозитория).    

> [!NOTE]
> Приложение было создано с помощью [Yeoman](http://yeoman.io/learning/index.html). Оно использует Express, Bower и Grunt. У него также есть некоторые пакеты npm в качестве зависимостей.
> Кроме того, пример содержит сценарий, который устанавливает Nginx и развертывает приложение. Он выполняется на виртуальных машинах. В частности, сценарий выполняет следующее:
> 1. Устанавливает Node, Nginx и PM2.
> 2. Настраивает Nginx и PM2.
> 3. Запускает приложения Node.

## <a name="configure-jenkins-plug-ins"></a>Настройка подключаемых модулей Jenkins

Сначала необходимо настроить два подключаемых модуля Jenkins: **NodeJS** и **непрерывное развертывание VS Team Services**.

1. Откройте учетную запись Jenkins и выберите **Manage Jenkins** (Управление Jenkins).
2. На странице **Manage Jenkins** (Управление Jenkins) выберите **Manage Plugins** (Управление подключаемыми модулями).
3. Отфильтруйте список, чтобы найти подключаемый модуль **NodeJS**, и выберите параметр **Install without restart** (Установить без перезагрузки).
    ![Добавление подключаемого модуля NodeJS в Jenkins](media/tutorial-build-deploy-jenkins/jenkins-nodejs-plugin.png)
4. Отфильтруйте список, чтобы найти подключаемый модуль **Непрерывное развертывание VS Team Services**, и выберите параметр **Install without restart** (Установить без перезагрузки).
5. Вернитесь к панели мониторинга Jenkins и выберите **Manage Jenkins** (Управление Jenkins).
6. Выберите **глобальную конфигурацию средства**. Найдите **NodeJS** и выберите **NodeJS installations** (Установки NodeJS).
7. Выберите параметр **Install automatically** (Автоматическая установка), а затем введите значение **имени**.
8. Щелкните **Сохранить**.

## <a name="configure-a-jenkins-freestyle-project-for-nodejs"></a>Настройка универсального проекта Jenkins для Node.js

1. Выберите **New Item** (Создать элемент). Введите имя элемента.
2. Выберите **Freestyle project** (Универсальный проект). Нажмите кнопку **ОК**.
3. На вкладке **Source Code Management** (Управление исходным кодом) выберите **Git** и введите сведения о репозитории и ветви, содержащей код приложения.    
    ![Добавление репозитория в сборку](media/tutorial-build-deploy-jenkins/jenkins-git.png)
4. На вкладке **Build Triggers** (Триггеры сборки) выберите **Poll SCM** (Опрос SCM) и введите расписание `H/03 * * * *` для опроса репозитория Git на наличие изменений каждые три минуты. 
5. На вкладке **Build Environment** (Среда сборки) щелкните **Provide Node &amp; npm bin/ folder PATH** (Укажите путь к папке bin для Node и npm) и выберите значение **NodeJS Installation** (Установка NodeJS). Для параметра **npmrc file** (NPMRC-файл) оставьте значение **use system default** (Использовать системное значение по умолчанию).
6. На вкладке **Build** (Сборка) выберите **оболочку выполнения** и введите команду `npm install`, чтобы обновить все зависимости.


## <a name="configure-jenkins-for-team-services-integration"></a>Настройка Jenkins для интеграции с Team Services.

> [!NOTE]
> Убедитесь, что используемый для следующих шагов личный маркер доступа (PAT) включает в себя разрешение *выпуска* (чтение, запись, выполнение и управление) в Team Services.
 
1.  Создайте личный маркер доступа в учетной записи Team Services, если у вас его еще нет. Эти данные требуются Jenkins для доступа к учетной записи Team Services. Убедитесь, что данные маркера безопасности для будущих шагов хранятся в этом разделе.
  
    Чтобы узнать, как создать такой маркер, прочтите статью [Authenticate access with personal access tokens for VSTS and TFS](https://www.visualstudio.com/docs/setup-admin/team-services/use-personal-access-tokens-to-authenticate) (Аутентификация доступа с помощью личных маркеров доступа для VSTS и TFS).
2. На вкладке **Post-build Actions** (Действия после сборки) выберите **Add post-build action** (Добавить действие после сборки). Выберите **Archive the artifacts** (Архивировать артефакты).
3. Для **Files to archive** (Файлы для архивации) введите `**/*`, чтобы включить в архив все файлы.
4. Чтобы создать другое действие, выберите **Add post-build action** (Добавить действие после сборки).
5. Выберите **Trigger release in TFS/Team Services** (Активация выпуска в TFS и Team Services). Введите универсальный код ресурса (URI) для учетной записи Team Services, например **https://{имя_учетной_записи}.visualstudio.com**.
6. Введите имя **командного проекта**.
7. Выберите имя для определения выпуска. (Позже вы создадите определение выпуска в Team Services.)
8. Выберите учетные данные для подключения к среде Team Services или Team Foundation Server:
   - Оставьте пустым поле **Имя пользователя**, если вы используете Team Services. 
   - Если вы используете локальную версию Team Foundation Server, введите имя пользователя и пароль.    
   ![Настройка действий после сборки Jenkins](media/tutorial-build-deploy-jenkins/trigger-release-from-jenkins.png)
5. Сохраните проект Jenkins.


## <a name="create-a-jenkins-service-endpoint"></a>Создание конечной точки службы Jenkins

Конечная точка службы позволяет Team Services подключаться к Jenkins.

1. Откройте страницу **Службы** в Team Services, откройте список **Новая конечная точка службы**, а затем выберите **Jenkins**.
   ![Добавление конечной точки Jenkins](media/tutorial-build-deploy-jenkins/add-jenkins-endpoint.png)
2. Введите имя для подключения.
3. Введите URL-адрес сервера Jenkins и выберите параметр **Принимать ненадежные SSL-сертификаты**. Пример URL-адреса — **http://{URL_адрес_сервера_Jenkins}.westcentralus.cloudapp.azure.com**.
4. Введите имя пользователя и пароль для учетной записи Jenkins.
5. Выберите **Проверить подключение**, чтобы проверить правильность указанных данных.
6. Нажмите кнопку **ОК**, чтобы создать конечную точку службы.

## <a name="create-a-deployment-group-for-azure-virtual-machines"></a>Создание группы развертывания для виртуальных машин Azure

Для регистрации агента в Team Services требуется [группа развертывания](https://www.visualstudio.com/docs/build/concepts/definitions/release/deployment-groups/), чтобы определения выпуска можно было развернуть на виртуальной машине. Группы развертывания позволяют легко определить логические группы целевых компьютеров для развертывания и установить требуемый агент на каждом компьютере.

   > [!NOTE]
   > В следующей процедуре убедитесь, что установлены необходимые компоненты, и *не выполняйте сценарий с привилегиями sudo.*

1. Откройте вкладку **Выпуски** центра **Сборка &amp; Выпуск**, а затем откройте **Группы развертывания** и выберите **+ Создать**.
2. Введите имя группы развертывания и необязательное описание. Щелкните **Создать**.
3. Выберите операционную систему для целевой виртуальной машины развертывания, Например, выберите **Ubuntu 16.04+**.
4. Выберите **Использовать личный маркер доступа в сценарии для проверки подлинности**.
5. Выберите ссылку **Необходимые компоненты системы**. Установите необходимые компоненты для операционной системы.
6. Чтобы скопировать сценарий, выберите **Скопировать сценарий в буфер обмена**.
7. Войдите в целевую виртуальную машину развертывания и выполните этот сценарий. Не запускайте сценарий с привилегиями sudo.
8. После установки вам будет предложено ввести теги группы развертывания. Примите значения по умолчанию.
9. В Team Services проверьте недавно зарегистрированную виртуальную машину в разделе **Целевые объекты** области **Группы развертываний**.

## <a name="create-a-team-services-release-definition"></a>Создание определения выпуска в Team Services

Определение выпуска задает процесс, выполняемый Team Services для развертывания приложения. В этом примере выполняется сценарий оболочки.

Вот как можно создать определение выпуска в Team Services.

1. Откройте вкладку **Выпуски** в центре **Сборка &amp; Выпуск** и выберите **Создать определение выпуска**. 
2. Выберите шаблон **Empty** (Пустой), выбрав команду, позволяющую начать работу с **пустого процесса**.
3. В разделе **Артефакты** щелкните **+ Add Artifact** (+ Добавить артефакт) и выберите **Jenkins** в качестве **типа источника**. Выберите подключение к конечной точке службы Jenkins. Затем выберите исходное задание Jenkins и щелкните **Добавить**.
4. Щелкните многоточие рядом с пунктом **Среда 1**. Выберите **Этап добавления группы развертывания**.
5. Выберите группу развертывания.
5. Выберите **+**, чтобы добавить задачу для **этапа развертывания группы**.
6. Выберите задачу **Сценарий оболочки** и щелкните **Добавить**. Задача **Сценарий оболочки** предоставляет конфигурацию для сценария, выполняемого на каждом сервере для установки Node.js и запуска приложения.
8. В качестве **пути сценария** введите **$(System.DefaultWorkingDirectory)/Fabrikam-Node/deployscript.sh**.
9. Выберите **Дополнительно**, а затем включите параметр **Указать рабочий каталог**.
10. В качестве **рабочей папки** введите **$(System.DefaultWorkingDirectory)/Fabrikam-Node**.
11. Измените имя определения выпуска, указав имя, введенное на вкладке **Post-build Actions** (Действия после сборки) для сборки в Jenkins. Jenkins необходимо это имя, чтобы активировать новый выпуск при обновлении исходных артефактов.
12. Щелкните **Сохранить** и **ОК**, чтобы сохранить определение выпуска.

## <a name="execute-manual-and-ci-triggered-deployments"></a>Выполнение развертывания вручную и с помощью непрерывной интеграции

1. Щелкните **+ Release** (+ Выпуск) и выберите **Создать выпуск**.
2. Щелкните созданную сборку в выделенном раскрывающемся списке и выберите **Очередь**.
3. Перейдите по ссылке на выпуск во всплывающем сообщении. Пример: Создан выпуск **Release-1**.
4. Откройте вкладку **Журналы**, чтобы просмотреть выходные данные консоли для выпуска.
5. Откройте в браузере URL-адрес одного из серверов, добавленных в группу развертывания. Например, введите **http://{IP-адрес_вашего_сервера}**.
6. Перейдите в исходный репозиторий Git и измените содержимое заголовка **h1** в файле app/views/index.jade, заменив его текст.
7. Зафиксируйте изменения.
8. Через несколько минут вы увидите созданный выпуск на странице **Выпуски** в Team Services или Team Foundation Server. Откройте этот выпуск, чтобы увидеть, как выполняется развертывание. Поздравляем!

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы автоматизировали развертывание приложения в Azure, используя сборку Jenkins и Team Services для выпуска. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * Выполнение сборки приложения в Jenkins.
> * Настройка Jenkins для интеграции с Team Services.
> * Создание группы развертывания для виртуальных машин Azure.
> * Создание определения выпуска, которое настраивает виртуальные машины и развертывает приложение.

Чтобы узнать, как развернуть стек LAMP (Linux, Apache, MySQL и PHP), перейдите к следующему руководству.

> [!div class="nextstepaction"]
> [Развертывание стека LAMP](tutorial-lamp-stack.md)
