---
title: "Непрерывная интеграция и непрерывное развертывание из Jenkins на виртуальных машинах Azure с помощью VSTS | Документация Майкрософт"
description: "Настройка непрерывной интеграции (CI) и непрерывного развертывания (CD) приложения Node.js с помощью Jenkins на виртуальных машинах Azure из Release Management в Visual Studio Team Services (VSTS) или Microsoft Team Foundation Server (TFS)."
author: ahomer
manager: douge
editor: tysonn
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 10/19/2017
ms.author: ahomer
ms.custom: mvc
ms.openlocfilehash: d5c15d6ab36a8454d1c69bac498be89b990c7e33
ms.sourcegitcommit: dfd49613fce4ce917e844d205c85359ff093bb9c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2017
---
# <a name="deploy-your-app-to-linux-vms-using-jenkins-and-vsts"></a>Развертывание приложения на виртуальных машинах Linux с помощью Jenkins и VSTS

Непрерывная интеграция (CI) и непрерывное развертывание (CD) представляют собой конвейер, с помощью которого можно выполнить сборку, выпустить и развернуть свой код. Visual Studio Team Services (VSTS) предоставляет полнофункциональный набор инструментов для автоматизации CI и CD для развертывания в Azure. Jenkins — это популярный серверный инструмент CI и CD стороннего поставщика, который также обеспечивает автоматизацию этих процессов. Эти инструменты можно использовать вместе, чтобы настроить способ доставки своего облачного приложения или службы.

В этом руководстве используется Jenkins для выполнения сборки **веб-приложения Node.js** и VSTS или Team Foundation Server (TFS) для его развертывания в [группе развертывания](https://www.visualstudio.com/docs/build/concepts/definitions/release/deployment-groups/), содержащей виртуальные машины Linux.

Вы сможете выполнять следующие задачи:

> [!div class="checklist"]
> * Получение примера приложения
> * Настройка подключаемых модулей Jenkins
> * Настройка универсального проекта Jenkins для Node.js.
> * Настройка Jenkins для интеграции с VSTS.
> * Создание конечной точки службы Jenkins
> * Создание группы развертывания для виртуальных машин Azure.
> * Создание определения выпуска VSTS.
> * Выполнение развертывания вручную и с помощью непрерывной интеграции.

## <a name="before-you-begin"></a>Перед началом работы

* Вам нужен доступ к серверу Jenkins. Если вы еще не создали сервер Jenkins, см. статью [Создание сервера Jenkins на виртуальной машине Azure под управлением Linux на портале Azure](https://docs.microsoft.com/en-us/azure/jenkins/install-jenkins-solution-template). 

* Войдите в свою учетную запись VSTS (`https://{youraccount}.visualstudio.com`). 
  Вы можете получить [бесплатную учетную запись VSTS](https://go.microsoft.com/fwlink/?LinkId=307137&clcid=0x409&wt.mc_id=o~msft~vscom~home-vsts-hero~27308&campaign=o~msft~vscom~home-vsts-hero~27308).

  > [!NOTE]
  > Дополнительные сведения см. в статье [Connect to team projects](https://www.visualstudio.com/docs/setup-admin/team-services/connect-to-visual-studio-team-services) (Подключение к командным проектам).

*  Для целевого развертывания понадобится виртуальная машина Linux.  Для получения дополнительной информации см. статью [Создание виртуальных машин Linux и управление ими с помощью Azure CLI](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-manage-vm).

*  Откройте входящий порт 80 для виртуальной машины.  Дополнительные сведения см. в статье [Создание групп безопасности сети с помощью портала Azure](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-create-nsg-arm-pportal).

## <a name="get-the-sample-app"></a>Получение примера приложения

Развертываемое приложение должно храниться в репозитории Git.
В данном руководстве мы рекомендуем использовать [этот пример приложения с сайта GitHub](https://github.com/azooinmyluggage/fabrikam-node).  В этом руководстве содержится пример сценария, который использовался во время установки Node.js и приложения.  Если нужно работать с собственным репозиторием, следует настроить такой же образец.

1. Создайте вилку этого приложения и запишите расположение (URL-адрес), чтобы использовать его позже в данном руководстве.  Дополнительные сведения см. в статье [Fork a repo](https://help.github.com/articles/fork-a-repo/) (Разветвление репозитория).    

> [!NOTE]
> Приложение было создано с помощью [Yeoman](http://yeoman.io/learning/index.html). В нем используются **Express**, **bower** и **grunt**, а также несколько пакетов **npm** в качестве зависимостей.
> Кроме того, пример содержит сценарий, который устанавливает Nginx и развертывает приложение. Он выполняется на виртуальных машинах. В частности, этот сценарий устанавливает Node, Nginx и PM2, настраивает Nginx и PM2, а затем запускает приложение Node.

## <a name="configure-jenkins-plugins"></a>Настройка подключаемых модулей Jenkins

Сначала необходимо настроить два подключаемых модуля Jenkins для **NodeJS** и **непрерывного развертывания VS Team Services**.

1. Откройте учетную запись Jenkins и выберите **Manage Jenkins** (Управление Jenkins).
2. На странице **Manage Jenkins** (Управление Jenkins) щелкните **Manage Plugins** (Управление подключаемыми модулями).
3. Отфильтруйте список, чтобы найти подключаемый модуль **NodeJS**, и выберите параметр **Install without restart** (Установить без перезагрузки).
    ![Добавление подключаемого модуля NodeJS в Jenkins](media/tutorial-build-deploy-jenkins/jenkins-nodejs-plugin.png)
4. Отфильтруйте список, чтобы найти подключаемый модуль **Непрерывное развертывание VS Team Services**, и выберите параметр **Install without restart** (Установить без перезагрузки).
5. Вернитесь к панели мониторинга Jenkins и выберите **Управление Jenkins**.
6. Выберите **глобальную конфигурацию средства**.  Найдите **NodeJS** и щелкните **NodeJS installations** (Установки NodeJS).
7. Включите параметр **Install automatically** (Автоматическая установка), а затем введите значение **имени**.
8. Щелкните **Сохранить**.

## <a name="configure-a-jenkins-freestyle-project-for-nodejs"></a>Настройка универсального проекта Jenkins для Node.js

1. Щелкните **New Item** (Новый элемент).  Введите **имя элемента**.
2. Выберите **Freestyle project** (Универсальный проект).  Нажмите кнопку **ОК**.
3. На вкладке **Source Code Management** (Управление исходным кодом) выберите **Git** и введите сведения о репозитории и ветви, содержащей код приложения.    
    ![Добавление репозитория в сборку](media/tutorial-build-deploy-jenkins/jenkins-git.png)
4. На вкладке **Build Triggers** (Триггеры сборки) выберите **Poll SCM** (Опрос SCM) и введите расписание `H/03 * * * *` для опроса репозитория Git на наличие изменений каждые три минуты. 
5. На вкладке **Build Environment** (Среда сборки) щелкните **Provide Node &amp; npm bin/ folder PATH** (Укажите путь к папке bin для Node и npm) и выберите значение **NodeJS Installation** (Установки NodeJS). Для параметра **npmrc file** (NPMRC-файл) оставьте значение "use system default" (Использовать системное значение по умолчанию).
6. На вкладке **Build** (Сборка) выберите **оболочку выполнения** и введите команду `npm install`, чтобы обновить все зависимости.


## <a name="configure-jenkins-for-vsts-integration"></a>Настройка Jenkins для интеграции с VSTS.

  > [!NOTE]
  Убедитесь, что используемый для следующих шагов личный маркер доступа (PAT) включает в себя **разрешение выпуска (чтение, запись, выполнение и управление) в VSTS**.
 
1.  Создайте личный маркер доступа в учетную запись VSTS, если у вас его еще нет. Эти данные требуются Jenkins для доступа к учетной записи TVSTS.  Убедитесь, что данные маркера для будущих шагов **хранятся** в этом разделе.
  Прочтите статью [Authenticate access with personal access tokens for VSTS and TFS](https://www.visualstudio.com/docs/setup-admin/team-services/use-personal-access-tokens-to-authenticate) (Аутентификация доступа с помощью личных маркеров доступа для VSTS и TFS), чтобы узнать, как создать такой маркер.
2. На вкладке **Post-build Actions** (Действия после сборки) щелкните **Add post-build action** (Добавить действие после сборки). Выберите **Архивировать артефакты**.
3. Для **Files to archive** (Файлы для архивации) введите `**/*`, чтобы включить в архив все файлы.
4. Чтобы создать другое действие, щелкните **Add post-build action** (Добавить действие после сборки).
5. Выберите **Trigger release in TFS/Team Services** (Активация выпуска в TFS и Team Services), введите универсальный код ресурса для своей учетной записи VSTS (например, `https://{your-account-name}.visualstudio.com`).
6. Введите имя **командного проекта**.
7. Выберите имя для **определения выпуска** (это определение выпуска создается позже в VSTS).
8. Выберите учетные данные для подключения к среде VSTS или TFS.  Оставьте пустым поле **Имя пользователя**, если вы используете VSTS.
   Введите **имя пользователя и пароль** при использовании локальной версии TFS.    
    ![Настройка действий после сборки Jenkins](media/tutorial-build-deploy-jenkins/trigger-release-from-jenkins.png)
5. **Сохраните** проект jenkins.

## <a name="create-a-jenkins-service-endpoint"></a>Создание конечной точки службы Jenkins

Конечная точка службы позволяет VSTS подключаться к Jenkins.

1. Откройте страницу **Службы** в VSTS, откройте список **Новая конечная точка службы**, а затем выберите **Jenkins**.
    ![Добавление конечной точки Jenkins](media/tutorial-build-deploy-jenkins/add-jenkins-endpoint.png)
2. Введите имя для подключения.
3. Введите URL-адрес сервера Jenkins и выберите параметр **Принимать ненадежные SSL-сертификаты**.  Например, URL-адрес `http://{YourJenkinsURL}.westcentralus.cloudapp.azure.com`
4. Введите **имя пользователя и пароль** для учетной записи Jenkins.
5. Щелкните **Проверить подключение**, чтобы проверить правильность указанных данных.
6. Нажмите кнопку **ОК**, чтобы создать конечную точку службы.

## <a name="create-a-deployment-group-for-azure-virtual-machines"></a>Создание группы развертывания для виртуальных машин Azure

Для регистрации агента в VSTS требуется [группа развертывания](https://www.visualstudio.com/docs/build/concepts/definitions/release/deployment-groups/), чтобы определения выпуска можно было развернуть на виртуальной машине.  Группы развертывания позволяют легко определить логические группы целевых компьютеров для развертывания и установить требуемый агент на каждом компьютере.

   > [!NOTE]
   > В следующих шагах убедитесь, что установлены необходимые компоненты и **не выполняйте сценарий с привилегиями sudo**.

1. Откройте вкладку **Выпуски** концентратора **Сборка и выпуск**, затем откройте **Группы развертывания** и выберите **+ Создать**.
2. Введите имя группы развертывания и необязательное описание.
   Щелкните **Создать**.
3. Выберите операционную систему для целевой виртуальной машины развертывания,  например **Ubuntu 16.04 +**.
4. Установите флажок **Использовать личный маркер доступа в сценарии для проверки подлинности**.
5. Выберите ссылку **Необходимые компоненты системы**.  Установите необходимые компоненты для операционной системы.
6. Чтобы скопировать сценарий, выберите **Скопировать сценарий в буфер обмена**.
7. **Войдите в** целевую виртуальную машину развертывания и **выполните** этот сценарий.  **Не** запускайте сценарий с привилегиями sudo.
8. После установки вам будет предложено ввести теги группы развертывания.  Примите значения по умолчанию.
9. В VSTS проверьте недавно зарегистрированную виртуальную машину в разделе **Целевые объекты** области **Группы развертываний**.

## <a name="create-a-vsts-release-definition"></a>Создание определения выпуска VSTS

Определение выпуска задает процесс, выполняемый VSTS для развертывания приложения.  В этом примере выполняется сценарий оболочки.

Вот как можно создать определение выпуска в VSTS.

1. Откройте **Выпуски** в концентраторе **Сборка и выпуск** и выберите **Создать определение выпуска**. 
2. Выберите шаблон **Empty** (Пустой), выбрав команду, позволяющую начать работу с **пустого процесса**.
3. В разделе **Артефакты** щелкните **+ Add Artifact** (+ Добавить артефакт) и выберите **Jenkins** в качестве **типа источника**. Выберите подключение к конечной точке службы Jenkins. Затем выберите исходное задание Jenkins и щелкните **Добавить**.
4.  Щелкните многоточие рядом с пунктом **Среда 1**.  Щелкните **Этап добавления группы развертывания**.
5.  Выберите **группу развертывания**.
5. Щелкните **+**, чтобы добавить задачу для **этапа развертывания группы**.
6. Выберите задачу **Сценарий оболочки** и щелкните **Добавить**.    
    Задача **Сценарий оболочки** используется для предоставления конфигурации для сценария, выполняемого на каждом сервере для установки Node.js и запуска приложения. Настройте его следующим образом.
8. **Путь к сценарию**:     
    `$(System.DefaultWorkingDirectory)/Fabrikam-Node/deployscript.sh`
9.  Щелкните **Дополнительно**, а затем включите параметр **Указать рабочий каталог**.
10.  **Рабочий каталог**: `$(System.DefaultWorkingDirectory)/Fabrikam-Node`.
11. Измените имя определения выпуска, указав имя, введенное на вкладке **Post-build Actions** (Действия после сборки) для сборки в Jenkins. Jenkins необходимо это имя, чтобы активировать новый выпуск при обновлении исходных артефактов.
12. Щелкните **Сохранить** и **OK**, чтобы сохранить определение выпуска.

## <a name="execute-manual-and-ci-triggered-deployments"></a>Выполнение развертывания вручную и с помощью непрерывной интеграции

1. Щелкните **+ Release** (+ Выпуск) и выберите **Создать выпуск**.
2. Щелкните созданную сборку в выделенном раскрывающемся списке и выберите **Очередь**.
3. Перейдите по ссылке на выпуск во всплывающем сообщении. Пример: Создан выпуск **Release-1**.
4. Откройте вкладку **Журналы**, чтобы просмотреть выходные данные консоли для выпуска.
5. Откройте в браузере URL-адрес одного из серверов, добавленных в группу развертывания. Например, введите `http://{your-server-ip-address}`.
6. Перейдите в исходный репозиторий Git и измените содержимое заголовка **h1** в файле app/views/index.jade, заменив его текст.
7. **Зафиксируйте** изменения.
8. Через несколько минут вы увидите созданный выпуск на странице **Выпуски** в VSTS или TFS. Откройте этот выпуск, чтобы увидеть, как выполняется развертывание. Поздравляем!

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы автоматизировали развертывание приложения в Azure, используя сборку Jenkins и VSTS для выпуска. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * Выполнение сборки приложения в Jenkins.
> * Настройка Jenkins для интеграции с VSTS.
> * Создание группы развертывания для виртуальных машин Azure.
> * Создание определения выпуска, которое настраивает виртуальные машины и развертывает приложение.

Перейдите к следующему руководству, чтобы узнать, как развернуть стек LAMP (Linux, Apache, MySQL и PHP).

> [!div class="nextstepaction"]
> [Развертывание стека LAMP](tutorial-lamp-stack.md)