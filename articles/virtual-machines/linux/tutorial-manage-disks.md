---
title: Руководство. Управление дисками Azure с помощью Azure CLI | Документация Майкрософт
description: В этом руководстве описано, как с помощью Azure CLI 2.0 создать и администрировать диски Azure для виртуальных машин
services: virtual-machines-linux
documentationcenter: virtual-machines
author: cynthn
manager: jeconnoc
editor: tysonn
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 05/30/2018
ms.author: cynthn
ms.custom: mvc
ms.openlocfilehash: 889facbf9612f2462a10c886a428ac052becefd8
ms.sourcegitcommit: 0a84b090d4c2fb57af3876c26a1f97aac12015c5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2018
ms.locfileid: "38704493"
---
# <a name="tutorial---manage-azure-disks-with-the-azure-cli-20"></a>Руководство. Управление дисками Azure с помощью Azure CLI 2.0

Виртуальные машины (ВМ) Azure хранят операционную систему, приложения и данные на дисках. При создании ВМ важно выбрать размер диска и конфигурацию в соответствии с ожидаемой рабочей нагрузкой. В этом руководстве показано, как развернуть диски виртуальной машины и управлять ими. Здесь содержатся сведения о:

> [!div class="checklist"]
> * дисках ОС и временных дисках;
> * Диски данных
> * дисками уровня "Стандартный" и "Премиум";
> * производительностью дисков;
> * присоединением и подготовкой дисков данных;
> * изменением размеров дисков;
> * моментальными снимками дисков.

[!INCLUDE [cloud-shell-try-it.md](../../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать интерфейс командной строки локально, то для работы с этим руководством вам понадобится Azure CLI 2.0.30 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0](/cli/azure/install-azure-cli).

## <a name="default-azure-disks"></a>Диски Azure по умолчанию

При создании виртуальной машины Azure к ней автоматически подключаются два диска.

**Диск операционной системы**. Размер дисков операционной системы может составлять до 2 ТБ. Это диски, содержащие операционную систему ВМ. По умолчанию диск ОС помечается как */dev/sda*. Конфигурация кэширования диска ОС оптимизирована для производительности операционной системы. Ввиду этой конфигурации диски ОС **не должны** использоваться для хранения приложений или данных. Для приложений и данных используйте диски данных, которые описаны далее в этом руководстве.

**Временный диск**. Временные диски используют твердотельные накопители, расположенные на том же узле Azure, что и виртуальная машина. Временные диски обладают высокой производительностью и могут быть использованы для таких операций, как обработка временных данных. Тем не менее, если виртуальная машина перемещается на новый узел, удаляются все данные, хранящиеся на временном диске. Размер временного диска определяется размером виртуальной машины. Временные диски помечаются как */dev/sdb* и используют точку подключения */mnt*.

### <a name="temporary-disk-sizes"></a>Размеры временных дисков

| type | Распространенные размеры | Максимальный размер временного диска (ГБ) |
|----|----|----|
| [Универсальные](sizes-general.md) | Серии A, B и D | 1600 |
| [Оптимизированные для вычислений](sizes-compute.md) | Серия F | 576 |
| [Оптимизированные для памяти](sizes-memory.md) | Серии D, E, G и M | 6144 |
| [Оптимизированные для хранилища](sizes-storage.md) | Серия L | 5630 |
| [GPU](sizes-gpu.md) | Серия N | 1440 |
| [Высокопроизводительные](sizes-hpc.md) | Серии A и H | 2000 |

## <a name="azure-data-disks"></a>Диски данных Azure

Чтобы установить приложения и хранить данные, можно добавить дополнительные диски данных. Диски данных следует использовать в любой ситуации, где требуется надежное хранилище данных, обеспечивающее высокую скорость реагирования. Максимальная емкость каждого диска составляет 4 ТБ. Размер виртуальной машины определяет, сколько дисков данных можно к ней подключить. Для каждого виртуального ЦП виртуальной машины можно подключить два диска данных.

### <a name="max-data-disks-per-vm"></a>Максимальное число дисков данных на виртуальную машину

| type | Размер виртуальной машины | Максимальное число дисков данных на виртуальную машину |
|----|----|----|
| [Универсальные](sizes-general.md) | Серии A, B и D | 64 |
| [Оптимизированные для вычислений](sizes-compute.md) | Серия F | 64 |
| [Оптимизированные для памяти](../virtual-machines-windows-sizes-memory.md) | Серии D, E и G | 64 |
| [Оптимизированные для хранилища](../virtual-machines-windows-sizes-storage.md) | Серия L | 64 |
| [GPU](sizes-gpu.md) | Серия N | 64 |
| [Высокопроизводительные](sizes-hpc.md) | Серии A и H | 64 |

## <a name="vm-disk-types"></a>Типы дисков виртуальной машины

В Azure предоставляются диски двух типов.

### <a name="standard-disk"></a>Диск уровня "Стандартный"

Хранилище класса Standard использует жесткие диски и обеспечивает экономичное хранилище с достаточной производительностью. Эти диски идеально подходят для экономных рабочих нагрузок разработки и тестирования.

### <a name="premium-disk"></a>Диск уровня "Премиум"

Диски уровня "Премиум" используют высокопроизводительные твердотельные накопители с низкой задержкой. Они идеально подходят для виртуальных машин, выполняющих производственную рабочую нагрузку. Хранилище уровня "Премиум" поддерживает виртуальные машины серий DS, DSv2, GS и FS. При выборе размер диска округляется в большую сторону до следующего типа. Например, если размер диска составляет менее 128 ГБ, то типом диска является P10. Если размер диска составляет от 129 до 512 ГБ, то его размер — P20. Диски размером более 512 ГБ относятся к типу P30.

### <a name="premium-disk-performance"></a>Производительность диска уровня "Премиум"

|Тип диска хранилища уровня "Премиум" | P4 | P6 | P10 | P20 | P30 | P40 | P50 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| Размер диска (округленный в большую сторону) | 32 ГБ | 64 ГБ | 128 ГБ | 512 ГБ | 1024 ГБ (1 ТБ) | 2048 ГБ (2 ТБ) | 4095 ГБ (4 ТБ) |
| Макс. количество операций ввода-вывода в секунду на диск | 120 | 240 | 500 | 2300 | 5 000 | 7500 | 7500 |
Пропускная способность на диск | 25 МБ/с | 50 МБ/с | 100 МБ/с | 150 МБ/с | 200 МБ/с | 250 МБ/с | 250 МБ/с |

Хотя в таблице выше указано максимальное число операций ввода-вывода в секунду на диск, можно обеспечить более высокий уровень производительности, применив чередование нескольких дисков данных. Например, виртуальная машина Standard_GS5 может достичь 80 000 операций ввода-вывода в секунду. Дополнительные сведения о максимальных количествах операций ввода-вывода в секунду для виртуальных машин см. в разделе [Размеры виртуальных машин Linux](sizes.md).

## <a name="create-and-attach-disks"></a>Создание и подключение дисков

Диски данных можно создать и подключить к существующей виртуальной машины или же сделать это во время создания виртуальной машины.

### <a name="attach-disk-at-vm-creation"></a>Подключение диска при создании виртуальной машины

Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az-group-create).

```azurecli-interactive
az group create --name myResourceGroupDisk --location eastus
```

Создайте виртуальную машину с помощью команды [az vm create](/cli/azure/vm#az-vm-create). В следующем примере создаются виртуальная машина с именем *myVM*, добавляется учетная запись пользователя с именем *azureuser* и создаются ключи SSH, если они еще не существуют. Аргумент `--datadisk-sizes-gb` указывает, что должен быть создан дополнительный диск, подключаемый к виртуальной машине. Чтобы создать и подключить несколько дисков, используйте список значений размеров дисков, разделенный пробелами. В следующем примере создается виртуальная машина с двумя дисками емкостью по 128 ГБ. Так как размеры дисков составляют 128 ГБ, они настроены как диски типа P10, которые обеспечивают до 500 операций ввода-вывода на диск.

```azurecli-interactive
az vm create \
  --resource-group myResourceGroupDisk \
  --name myVM \
  --image UbuntuLTS \
  --size Standard_DS2_v2 \
  --admin-username azureuser \
  --generate-ssh-keys \
  --data-disk-sizes-gb 128 128
```

### <a name="attach-disk-to-existing-vm"></a>Подключение диска к существующей виртуальной машине

Чтобы создать диск и подключить его к существующей виртуальной машине, выполните команду [az vm disk attach](/cli/azure/vm/disk#az-vm-disk-attach). Приведенный ниже пример создает диск уровня "Премиум" размера в 128 ГБ и подключает его к виртуальной машине, созданной на предыдущем шаге.

```azurecli-interactive
az vm disk attach \
    --resource-group myResourceGroupDisk \
    --vm-name myVM \
    --disk myDataDisk \
    --size-gb 128 \
    --sku Premium_LRS \
    --new
```

## <a name="prepare-data-disks"></a>Подготовка дисков данных

После подключения диска к виртуальной машине необходимо настроить операционную систему для его использования. В примере ниже показано, как настроить диск вручную. Этот процесс можно автоматизировать с помощью cloud-init, как описывается в [этом руководстве](./tutorial-automate-vm-deployment.md).

### <a name="manual-configuration"></a>Настройка вручную

Создайте SSH-подключение к виртуальной машине. Замените IP-адреса в примере общедоступным IP-адресом виртуальной машины.

```azurecli-interactive
ssh azureuser@52.174.34.95
```

Создание разделы на диске с помощью `fdisk`.

```bash
(echo n; echo p; echo 1; echo ; echo ; echo w) | sudo fdisk /dev/sdc
```

Запишите файловую систему на раздел, выполнив команду `mkfs`.

```bash
sudo mkfs -t ext4 /dev/sdc1
```

Подключите новый диск, чтобы он был доступен в операционной системе.

```bash
sudo mkdir /datadrive && sudo mount /dev/sdc1 /datadrive
```

Теперь этот диск доступен через точку подключения *datadrive*, что можно проверить с помощью команды `df -h`.

```bash
df -h
```

Ее результат показывает, что новый диск подключен к */datadrive*.

```bash
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        30G  1.4G   28G   5% /
/dev/sdb1       6.8G   16M  6.4G   1% /mnt
/dev/sdc1        50G   52M   47G   1% /datadrive
```

Чтобы обеспечить повторное подключение диска после перезагрузки, его необходимо добавить в файл */etc/fstab*. Для этого получите UUID диска с помощью служебной программы `blkid`.

```bash
sudo -i blkid
```

На экране отображается UUID диска, в данном случае это `/dev/sdc1`.

```bash
/dev/sdc1: UUID="33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e" TYPE="ext4"
```

Добавьте в файл */etc/fstab* строку следующего вида.

```bash
UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive  ext4    defaults,nofail   1  2
```

Теперь, когда диск настроен, закройте сеанс SSH.

```bash
exit
```

## <a name="resize-vm-disk"></a>Изменение размера диска виртуальной машины

После развертывания виртуальной машины можно увеличить размер ее диска операционной системы или любого подключенного диска данных. Это удобно, если нужно выделить больше места для хранения данных или повысить уровень производительности (например, до P10, P20 или P30). Уменьшить размер дисков невозможно.

Прежде чем увеличить размер диска, нужно узнать его идентификатор или имя. Введите команду [az disk list](/cli/azure/disk#az-disk-list), чтобы вывести список всех дисков в группе ресурсов. Запишите имя диска, размер которого вы хотите изменить.

```azurecli-interactive
az disk list \
    --resource-group myResourceGroupDisk \
    --query '[*].{Name:name,Gb:diskSizeGb,Tier:accountType}' \
    --output table
```

ВМ нужно освободить. Используйте команду [az vm deallocate](/cli/azure/vm#az-vm-deallocate), чтобы остановить и освободить виртуальную машину.

```azurecli-interactive
az vm deallocate --resource-group myResourceGroupDisk --name myVM
```

Введите команду [az disk update](/cli/azure/vm/disk#az-vm-disk-update), чтобы изменить размер диска. Приведенный пример увеличивает размер диска *myDataDisk* до 1 ТБ.

```azurecli-interactive
az disk update --name myDataDisk --resource-group myResourceGroupDisk --size-gb 1023
```

После завершения операции изменения размера запустите виртуальную машину.

```azurecli-interactive
az vm start --resource-group myResourceGroupDisk --name myVM
```

Если изменить размер диска операционной системы, соответствующий раздел будет автоматически увеличен. При изменении размера диска данных необходимо увеличить все текущие разделы в операционной системе виртуальной машины.

## <a name="snapshot-azure-disks"></a>Создание моментальных снимков дисков Azure по умолчанию

При создании моментального снимка диска Azure создает копию диска на определенный момент времени, предназначенную только для чтения. Моментальные снимки виртуальной машины Azure можно использовать для быстрого сохранения ее состояния перед изменением конфигурации. В случае изменения конфигурации, оказавшегося нежелательным, состояние виртуальной машины можно восстановить с помощью моментального снимка. Если виртуальная машина содержит более одного диска, создается отдельный моментальный снимок каждого диска. Для создания резервных копий с сохранением целостности приложений рекомендуем остановить виртуальную машину перед созданием моментальных снимков дисков. В качестве альтернативы можно использовать [службу архивации Azure](/azure/backup/), которая обеспечивает автоматическую архивацию при запущенной виртуальной машине.

### <a name="create-snapshot"></a>Создание моментального снимка

Перед созданием моментального снимка диска виртуальной машины нужно узнать идентификатор или имя этого диска. Для этого выполните команду [az vm show](/cli/azure/vm#az-vm-show). В этом примере идентификатор диска сохраняется в переменной и может использоваться в дальнейшем.

```azurecli-interactive
osdiskid=$(az vm show -g myResourceGroupDisk -n myVM --query "storageProfile.osDisk.managedDisk.id" -o tsv)
```

Получив идентификатор диска виртуальной машины, выполните следующую команду, создающую его моментальный снимок.

```azurcli
az snapshot create \
    --resource-group myResourceGroupDisk \
    --source "$osdiskid" \
    --name osDisk-backup
```

### <a name="create-disk-from-snapshot"></a>Создание диска на основе моментального снимка

Этот моментальный снимок можно преобразовать в диск, с помощью которого можно повторно создать виртуальную машину.

```azurecli-interactive
az disk create --resource-group myResourceGroupDisk --name mySnapshotDisk --source osDisk-backup
```

### <a name="restore-virtual-machine-from-snapshot"></a>Восстановление виртуальной машины на основе моментального снимка

Чтобы продемонстрировать восстановление виртуальной машины, удалите существующую виртуальную машину.

```azurecli-interactive
az vm delete --resource-group myResourceGroupDisk --name myVM
```

Создайте виртуальную машину на основе диска моментального снимка.

```azurecli-interactive
az vm create \
    --resource-group myResourceGroupDisk \
    --name myVM \
    --attach-os-disk mySnapshotDisk \
    --os-type linux
```

### <a name="reattach-data-disk"></a>Повторное подключение диска данных

Все диски данных нужно повторно подключить к виртуальной машине.

Сначала найдите имя диска данных, выполнив команду [az disk list](/cli/azure/disk#az-disk-list). В этом примере имя диска помещается в переменную *datadisk*, которая будет использоваться на следующем шаге.

```azurecli-interactive
datadisk=$(az disk list -g myResourceGroupDisk --query "[?contains(name,'myVM')].[name]" -o tsv)
```

Подключите диск, выполнив команду [az vm disk attach](/cli/azure/vm/disk#az-vm-disk-attach).

```azurecli-interactive
az vm disk attach –g myResourceGroupDisk –-vm-name myVM –-disk $datadisk
```

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы ознакомились с дисками виртуальных машин, а именно с:

> [!div class="checklist"]
> * дисками ОС и временными дисками;
> * Диски данных
> * дисками уровня "Стандартный" и "Премиум";
> * производительностью дисков;
> * присоединением и подготовкой дисков данных;
> * изменением размеров дисков;
> * моментальными снимками дисков.

Перейдите к следующему руководству, чтобы узнать об автоматической настройке виртуальных машин.

> [!div class="nextstepaction"]
> [Автоматизация настройки виртуальной машины](./tutorial-automate-vm-deployment.md)
