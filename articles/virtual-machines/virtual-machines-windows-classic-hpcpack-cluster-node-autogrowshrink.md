<properties
 pageTitle="Автомасштабирование вычислительных ресурсов в кластере HPC | Microsoft Azure"
 description="Автоматическое увеличение и уменьшение количества вычислительных узлов кластера пакета HPC в Azure"
 services="virtual-machines-windows"
 documentationCenter=""
 authors="dlepow"
 manager="timlt"
 editor=""
 tags="azure-service-management,hpc-pack"/>
<tags
ms.service="virtual-machines-windows"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="vm-multiple"
 ms.workload="big-compute"
 ms.date="04/14/2016"
 ms.author="danlep"/>

# Автоматическое изменение размера ресурсов кластера пакета HPC в Azure в соответствии с рабочей нагрузкой кластера




Если вы развертываете в кластере пакета HPC "расширительные" узлы Azure или создаете кластер пакета HPC на виртуальных машинах Azure, может потребоваться способ автоматического увеличения или уменьшения количества вычислительных ресурсов Azure (например, ядер) в соответствии с текущей рабочей нагрузкой заданий в кластере. Это позволяет более эффективно использовать ресурсы Azure и управлять затратами на них. Для этого настройте свойство кластера пакета HPC **AutoGrowShrink**. Можно также выполнить скрипт HPC PowerShell **AzureAutoGrowShrink.ps1**, устанавливаемый вместе с пакетом HPC.

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-classic-include.md)]Модель диспетчера ресурсов. Кроме того, в настоящее время можно автоматически увеличивать и уменьшать только вычислительные узлы пакета HPC под управлением ОС Windows Server.

## Настройка свойства кластера AutoGrowShrink

### Предварительные требования

* **Кластер пакета HPC 2012 R2 с обновлением 2 или более поздней версии** — головной узел кластера может быть развернут локально или на виртуальной машине Azure. См. раздел [Настройка гибридного кластера с пакетом HPC](../cloud-services/cloud-services-setup-hybrid-hpcpack-cluster.md), чтобы приступить к работе с локальными головными узлами и «расширительными» узлами Azure. См. статью [о скрипте развертывания IaaS пакета HPC](virtual-machines-windows-classic-hpcpack-cluster-powershell-script.md) для быстрого развертывания кластера пакета HPC на виртуальных машинах Azure.


* **Для кластера с головным узлом в Azure** — при использовании скрипта развертывания IaaS пакета HPC для создания кластера включите свойство кластера **AutoGrowShrink**, задав параметр AutoGrowShrink в файле конфигурации кластера. Дополнительные сведения см. в сопроводительной документации [файла загрузки скрипта](https://www.microsoft.com/download/details.aspx?id=44949).

    Кроме того, настройте свойство кластера **AutoGrowShrink** после развертывания кластера с помощью команд HPC PowerShell, описанных в следующем разделе. Чтобы использовать для этого HPC PowerShell, сначала выполните следующие действия.
    1. Настройте сертификат управления Azure на головном узле и в подписке Azure. Для тестового развертывания можно использовать самозаверяющий сертификат Microsoft HPC Azure по умолчанию, который пакет HPC устанавливает на головном узле, и просто передать этот сертификат в подписку Azure. Сведения о параметрах и необходимых действиях см. в [руководстве библиотеки TechNet](https://technet.microsoft.com/library/gg481759.aspx).
    2. Выполните на головном узле команду **regedit**, перейдите к расположению HKLM\\SOFTWARE\\Micorsoft\\HPC\\IaasInfo и добавьте новое строковое значение. Для имени значения задайте значение "Отпечаток", а для данных значения — отпечаток сертификата, указанный в шаге 1.


### Команды HPC PowerShell для настройки свойства AutoGrowShrink

Ниже приведены примеры команд HPC PowerShell для настройки свойства **AutoGrowShrink** и дополнительных параметров его поведения. Полный список параметров см. в разделе [Параметры AutoGrowShrink](#AutoGrowShrink-parameters) далее в этой статье.

Чтобы выполнить эти команды, запустите HPC PowerShell на головном узле кластера с правами администратора.

**Включение свойства AutoGrowShrink**

    Set-HpcClusterProperty –EnableGrowShrink 1

**Выключение свойства AutoGrowShrink**

    Set-HpcClusterProperty –EnableGrowShrink 0

**Изменение интервала увеличения в минутах**

    Set-HpcClusterProperty –GrowInterval <interval>

**Изменение интервала уменьшения в минутах**

    Set-HpcClusterProperty –ShrinkInterval <interval>

**Просмотр текущей конфигурации AutoGrowShrink**

    Get-HpcClusterProperty –AutoGrowShrink

### Параметры AutoGrowShrink

Ниже перечислены параметры AutoGrowShrink, которые можно изменить с помощью команды **Set-HpcClusterProperty**.

* **EnableGrowShrink** — переключатель для включения или отключения свойства **AutoGrowShrink**.
* **ParamSweepTasksPerCore** — число задач параметрического анализа для увеличения одного ядра. Значение по умолчанию — увеличение одного ядра в каждой задаче. 
 
    >[AZURE.NOTE] Пакет HPC QFE KB3134307 изменяет параметр **ParamSweepTasksPerCore** на **TasksPerResourceUnit**. Он основан на типе ресурса задания и может быть узлом, сокетом или ядром.
    
* **GrowThreshold** — пороговое количество задач, находящихся в очереди, для запуска автоматического увеличения. Значение по умолчанию — 1. Это означает, что, если в очереди есть одна или несколько задач, увеличение узлов начнется автоматически.
* **GrowInterval** — интервал в минутах для активации автоматического увеличения. Значение по умолчанию — 5 минут.
* **ShrinkInterval** — интервал в минутах для активации автоматического уменьшения. Значение по умолчанию — 5 минут.|
* **ShrinkIdleTimes** — количество непрерывных проверок на уменьшение, выполняемых для определения того, находится ли узел в состоянии простоя. Значение по умолчанию — 3 раза. Например, если для параметра **ShrinkInterval** установлено значение 5 минут, пакет HPC проверяет, находится ли узел в состоянии простоя, каждые 5 минут. Если узлы находятся в состоянии простоя, после 3 последовательных проверок (15 минут), пакет HPC уменьшает этот узел.
* **ExtraNodesGrowRatio** — дополнительный процент узлов для увеличения для заданий интерфейса передачи сообщений (MPI). Значение по умолчанию — 1. Это означает, что пакет HPC увеличивает узлы на 1 % для заданий MPI. 
* **GrowByMin** — переключатель для указания того, основана ли политика автоматического увеличения на минимальном количестве ресурсов, необходимых для задания. Значение по умолчанию — false. Это означает, что пакет HPC увеличивает узлы для заданий на основании максимального количества ресурсов, необходимых для заданий.
* **SoaJobGrowThreshold** — пороговое значение входящих запросов SOA для автоматической активации увеличения. Значение по умолчанию — 50000.  
    
    >[AZURE.NOTE] Этот параметр поддерживается, начиная с версии пакета HPC 2012 R2 с обновлением 3.
    
* **SoaRequestsPerCore** — количество входящих запросов SOA для увеличения одного ядра. Значение по умолчанию — 20 000.

    >[AZURE.NOTE] Этот параметр поддерживается, начиная с версии пакета HPC 2012 R2 с обновлением 3.

### Пример MPI

По умолчанию пакет HPC увеличивает дополнительные узлы на 1 % для заданий MPI (для параметра **ExtraNodesGrowRatio** задано значение 1). Это связано с тем, что для MPI может потребоваться несколько узлов, а задание может выполняться только в том случае, когда готовы все узлы. Иногда при запуске узлов Azure одному из них может потребоваться больше времени для запуска, чем другим. Это приведет к тому, что другие узлы будут в состоянии простоя, ожидая, пока запустится этот узел. Увеличивая размер дополнительных узлов, пакет HPC сокращает это время ожидания ресурса и потенциально сокращает расходы. Для увеличения количества дополнительных узлов для заданий MPI (например, на 10 %) выполните команду, подобную следующей:

    Set-HpcClusterProperty -ExtraNodesGrowRatio 10

### Пример SOA

По умолчанию для параметра **SoaJobGrowThreshold** установлено значение 50 000, а для **SoaRequestsPerCore** — 200 000. Если отправить одно задание SOA с 70 000 запросов, будет существовать одна задача, поставленная в очередь, и 70 000 входящих запросов. В данном случае пакет HPC увеличит 1 ядро для задачи в очереди и 1 ядро для входящих запросов (по формуле (70000 – 50000)/20000 = 1), поэтому в итоге для этого задания SOA увеличатся 2 ядра.

## Запуск скрипта AzureAutoGrowShrink.ps1

### Предварительные требования

* **Кластер узла HPC 2012 R2 с обновлением 1 или более поздней версии** — сценарий **AzureAutoGrowShrink.ps1** установлен в папку %CCP\_HOME%bin. Головной узел кластера может быть развернут локально или на виртуальной машине Azure. См. раздел [Настройка гибридного кластера с пакетом HPC](../cloud-services/cloud-services-setup-hybrid-hpcpack-cluster.md), чтобы приступить к работе с локальными головными узлами и «расширительными» узлами Azure. Выполните быстрое развертывание кластера пакета HPC на виртуальных машинах Azure, как указано в описании [скрипта развертывания IaaS пакета HPC](virtual-machines-windows-classic-hpcpack-cluster-powershell-script.md), или обратитесь к [краткому руководству по шаблонам Azure](https://azure.microsoft.com/documentation/templates/create-hpc-cluster/).

* **Azure PowerShell 0.8.12**: в настоящее время скрипт зависит от конкретной версии Azure PowerShell. Если на головном узле используется более поздняя версия, для выполнения скрипта может потребоваться переход на более раннюю версию Azure PowerShell — [0\.8.12](http://az412849.vo.msecnd.net/downloads03/azure-powershell.0.8.12.msi).

* **Для кластеров с расширительными узлами Azure** — запустите сценарий на клиентском компьютере с установленным пакетом HPC или на головном узле. При выполнении на клиентском компьютере важно убедиться, что переменная $env:CCP\_SCHEDULER задана правильно и указывает на головной узел. «Расширительные» узлы Azure должны быть уже добавлены в кластер, однако они могут находиться в неразвернутом состоянии.


* **Для кластера, развернутого на виртуальных машинах Azure** —запустите сценарий на виртуальной машине головного узла, так как он зависит от сценариев **Start-HpcIaaSNode.ps1** и **Stop-HpcIaaSNode.ps1**, которые там установлены. Кроме того, эти сценарии требуют сертификат управления Azure или файл параметров публикации (см. раздел [Управление вычислительными узлами в кластере на основе пакета HPC в Azure](virtual-machines-windows-classic-hpcpack-cluster-node-manage.md)). Убедитесь, что все необходимые виртуальные машины вычислительных узлов уже добавлены в кластер. Они могут находиться в остановленном состоянии.

### Синтаксис

```
AzureAutoGrowShrink.ps1
[[-NodeTemplates] <String[]>] [[-JobTemplates] <String[]>] [[-NodeType] <String>]
[[-NumOfQueuedJobsPerNodeToGrow] <Int32>]
[[-NumOfQueuedJobsToGrowThreshold] <Int32>]
[[-NumOfActiveQueuedTasksPerNodeToGrow] <Int32>]
[[-NumOfActiveQueuedTasksToGrowThreshold] <Int32>]
[[-NumOfInitialNodesToGrow] <Int32>] [[-GrowCheckIntervalMins] <Int32>]
[[-ShrinkCheckIntervalMins] <Int32>] [[-ShrinkCheckIdleTimes] <Int32>]
[-UseLastConfigurations] [[-ArgFile] <String>] [[-LogFilePrefix] <String>]
[<CommonParameters>]

```
### Параметры

 * **NodeTemplates** — имена шаблонов узла для определения области увеличения и сжатия узлов. Если не указан (значение по умолчанию — @()), все узлы в группе узлов **AzureNodes** входят в область действия, когда **NodeType** имеет значение AzureNodes, и все узлы в группе узлов **ComputeNodes** входят в область действия, когда **NodeType** имеет значение ComputeNodes.

 * **JobTemplates** — имена шаблонов задания для определения области увеличения узлов.

 * **NodeType** — тип узла для увеличения и сжатия. Поддерживаемые значения:

     * **AzureNodes** — для (расширительных) узлов PaaS Azure в локальной среде или в кластере IaaS Azure.

     * **ComputeNodes** — для виртуальных машин вычислительных узлов только в кластере IaaS Azure.

* **NumOfQueuedJobsPerNodeToGrow** — количество заданий в очереди, требуемое для увеличения одного узла.

* **NumOfQueuedJobsToGrowThreshold** — пороговое значение числа заданий в очереди для запуска процесса увеличения.

* **NumOfActiveQueuedTasksPerNodeToGrow** — число активных задач в очереди, необходимое для увеличения одного узла. Если для **NumOfQueuedJobsPerNodeToGrow** указано значение больше 0, этот параметр пропускается.

* **NumOfActiveQueuedTasksToGrowThreshold** — пороговое значение числа активных задач в очереди для запуска процесса увеличения.

* **NumOfInitialNodesToGrow** — начальное минимальное число узлов для увеличения, если все узлы в области действия находятся в состоянии **Не развернут** или **Остановлен (распределение отменено)**.

* **GrowCheckIntervalMins** — интервал в минутах между проверками на увеличение.

* **ShrinkCheckIntervalMins** — интервал в минутах между проверками на сжатие.

* **ShrinkCheckIdleTimes** — количество последовательных проверок на сжатие (с интервалом **ShrinkCheckIntervalMins**), указывающих на простой узла.

* **UseLastConfigurations** — предыдущие конфигурации, сохраненные в файле аргументов.

* **ArgFile** — имя файла аргументов, используемого в целях сохранения и обновления конфигураций для выполнения сценария.

* **LogFilePrefix** — префикс файла журнала. Можно указать путь. По умолчанию журнал записывается в текущий рабочий каталог.

### Пример 1

В следующем примере расширительные узлы Azure, развернутые с помощью шаблона AzureNode по умолчанию, настраиваются для автоматического увеличения и сжатия. Если все узлы изначально находятся в состоянии **Не развернут**, запускается не менее 3 узлов. Если количество заданий в очереди превышает 8, сценарий запускает узлы, пока их количество не превысит отношение числа заданий в очереди к значению **NumOfQueuedJobsPerNodeToGrow**. Если узел обнаружен простаивающим 3 раза подряд, он останавливается.

```
.\AzureAutoGrowShrink.ps1 -NodeTemplates @('Default AzureNode
 Template') -NodeType AzureNodes -NumOfQueuedJobsPerNodeToGrow 5
 -NumOfQueuedJobsToGrowThreshold 8 -NumOfInitialNodesToGrow 3
 -GrowCheckIntervalMins 1 -ShrinkCheckIntervalMins 1 -ShrinkCheckIdleTimes 3
```

### Пример 2

В следующем примере виртуальные машины вычислительного узла Azure, развернутые с помощью шаблона ComputeNode по умолчанию, настраиваются для автоматического увеличения и сжатия. Задания, настроенные с помощью шаблона задания по умолчанию, определяют область действия рабочей нагрузки в кластере. Если все узлы изначально находятся в остановленном состоянии, запускается не менее 5 узлов. Если количество активных задач в очереди превышает 15, сценарий запускает узлы, пока их количество не превысит отношение числа активных задач в очереди к значению **NumOfActiveQueuedTasksPerNodeToGrow**. Если узел обнаружен простаивающим 10 раз подряд, он останавливается.

```
.\AzureAutoGrowShrink.ps1 -NodeTemplates 'Default ComputeNode Template' -JobTemplates 'Default' -NodeType ComputeNodes -NumOfActiveQueuedTasksPerNodeToGrow 10 -NumOfActiveQueuedTasksToGrowThreshold 15 -NumOfInitialNodesToGrow 5 -GrowCheckIntervalMins 1 -ShrinkCheckIntervalMins 1 -ShrinkCheckIdleTimes 10 -ArgFile 'IaaSVMComputeNodes_Arg.xml' -LogFilePrefix 'IaaSVMComputeNodes_log'
```

<!---HONumber=AcomDC_0420_2016-->