<properties 
   pageTitle="Создание и отправка виртуального жесткого диска FreeBSD в Azure" 
   description="Узнайте, как создать и передать виртуальный жесткий диск (VHD-файл) Azure, содержащий операционную систему FreeBSD." 
   services="virtual-machines" 
   documentationCenter="" 
   authors="KylieLiang" 
   manager="timlt" 
   editor=""/>

<tags
   ms.service="virtual-machines"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="vm-linux"
   ms.workload="infrastructure-services" 
   ms.date="05/19/2015"
   ms.author="kyliel"/>

# Создание и отправка виртуального жесткого диска FreeBSD в Azure 

В этой статье показано, как создать и передать виртуальный жесткий диск с операционной системой FreeBSD, чтобы использовать его в качестве образа для создания виртуальной машины в Azure.

##Предварительные требования##
В данной статье предполагается, что у вас есть следующие элементы:

- **Подписка Azure ** — если ее нет, можно создать бесплатную пробную учетную запись всего за несколько минут. Подробную информацию см. в разделе [Создание учетной записи Azure](../php-create-account.md). 

- **Средства Azure PowerShell.** У вас уже установлен модуль Microsoft Azure PowerShell, настроенный на использование вашей подписки. Информацию о скачивании модуля см. в разделе [Загрузки Azure](http://azure.microsoft.com/downloads/). Учебник по установке и настройке модуля вы найдете здесь. Для передачи VHD-файла вы будете использовать командлет из раздела [Загрузки Azure](http://azure.microsoft.com/downloads/).

- **Операционная система FreeBSD установлена в VHD-файл.** Поддерживаемая операционная система FreeBSD установлена на виртуальный жесткий диск. Существует несколько средств для создания файлов VHD. Например, для создания файла VHD и установки операционной системы можно использовать решения для виртуализации, такие как Hyper-V. Инструкции см. в разделе [Установка роли Hyper-V и настройка виртуальной машины](http://technet.microsoft.com/library/hh846766.aspx).

> [AZURE.NOTE]Более новый формат VHDX не поддерживается в Azure. Вы можете преобразовать диск в формат VHD с помощью диспетчера Hyper-V или командлета [convert-vhd](https://technet.microsoft.com/library/hh848454.aspx).

Эта задача включает в себя следующие пять шагов.

## Шаг 1. Подготовка образа для передачи ##

Учебник по установке FreeBSD на базе Hyper-V см. [здесь](http://blogs.msdn.com/b/kylie/archive/2014/12/25/running-freebsd-on-hyper-v.aspx).

Из виртуальной машины, где была установлена операционная система FreeBSD, выполните следующие действия:

1. **Включение DHCP**

		# echo 'ifconfig_hn0="SYNCDHCP"' >> /etc/rc.conf
		# service netif restart

2. **Включение SSH**

    SSH включается по умолчанию после установки с диска. Если этот компонент не включен или вы используете непосредственно виртуальный жесткий диск FreeBSD, введите:

		# echo 'sshd_enable="YES"' >> /etc/rc.conf 
		# ssh-keygen -t dsa -f /etc/ssh/ssh_host_dsa_key 
		# ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key 
		# service sshd restart

3. **Настройка последовательной консоли**

		# echo 'console="comconsole vidconsole"' >> /boot/loader.conf
		# echo 'comconsole_speed="115200"' >> /boot/loader.conf

4. **Установка sudo**

    Учетная запись root в Azure отключена, поэтому вам необходимо использовать sudo от лица непривилегированного пользователя для запуска команд с повышенными привилегиями.

		# pkg install sudo

5. Необходимые условия для агента Azure

    5.1. **Установка python**

		# pkg install python27 py27-asn1
		# ln -s /usr/local/bin/python2.7 /usr/bin/python

    5.2. **Установка wget**

		# pkg install wget 

6. **Установка агента Azure**

    Последний выпуск агента Azure всегда можно найти на сайте [github](https://github.com/Azure/WALinuxAgent/releases). В версии 2.0.10 и более поздних официально поддерживается FreeBSD 10 и последующих версий.

		# wget https://raw.githubusercontent.com/Azure/WALinuxAgent/WALinuxAgent-2.0.10/waagent --no-check-certificate
		# mv waagent /usr/sbin
		# chmod 755 /usr/sbin/waagent
		# /usr/sbin/waagent -install

    **Внимание**! После установки убедитесь, что компонент запущен.

		# service –e | grep waagent
		/etc/rc.d/waagent
		# cat /var/log/waagent.log

    Теперь вы можете **завершить работу** виртуальной машины. Вы также можете выполнить шаг 7 до завершения работы, но это необязательно.

7. Отзыв не является обязательным. Он служит для очистки системы для повторной подготовки к работе.

    Приведенная ниже команда также удаляет последнюю подготовленную учетную запись пользователя и связанные с ней данные.

		# waagent –deprovision+user

## Шаг 2. Создание учетной записи хранения в Azure ##

Для загрузки файла VHD, который можно использовать в Azure для создания виртуальной машины, потребуется учетная запись хранения в Azure. Для создания учетной записи хранения можно использовать портал управления Azure.

1. Войдите на портал управления Azure.

2. На панели команд нажмите **Создать**.

3. Последовательно выберите **Службы данных** > **Хранилище** > **Быстрое создание**.

	![Быстрое создание учетной записи хранения](./media/virtual-machines-freebsd-create-upload-vhd/Storage-quick-create.png)

4. Заполните поля, как показано ниже:
	
	- В поле **URL-адрес** введите имя поддомена, используемого в URL-адресе для учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это имя становится именем узла в URL, который используется для адресации ресурсов BLOB-объекта, очереди и таблицы для подписки.
			
	- Выберите **расположение или территориальную группу** для учетной записи хранения. Указав территориальную группу, можно выполнить совместное размещение облачных служб и хранилища в одном центре обработки данных.
		 
	- Укажите, следует ли использовать **георепликацию** для учетной записи хранения. По умолчанию георепликация включена. Этот параметр позволяет бесплатно выполнять репликацию данных в дополнительное расположение. Таким образом хранилище переключится на это расположение в случае аварийного отказа основного расположения. Дополнительное местоположение назначается автоматически и не может быть изменено. Если в соответствии с законодательными требованиями или организационной политикой требуется более жесткий контроль расположения облачного хранилища, георепликацию можно отключить. Однако следует помнить, что если вы опять включите георепликацию, с вас будет взята однократная плата за репликацию существующих данных в дополнительное местоположение. Службы хранения без георепликации предлагаются со скидкой. Дополнительную информацию об управлении георепликацией учетных записей хранения см. здесь: [Создание и удаление учетной записи хранения, а также управление ею](../storage-create-storage-account/#replication-options).

	![Введите сведения об учетной записи хранения](./media/virtual-machines-freebsd-create-upload-vhd/Storage-create-account.png)


5. Щелкните **Создать учетную запись хранения**. Учетная запись появится в списке раздела **Хранилище**.

	![Учетная запись хранения успешно создана](./media/virtual-machines-freebsd-create-upload-vhd/Storagenewaccount.png)

6. Теперь создайте контейнер для переданных виртуальных жестких дисков. Щелкните имя учетной записи хранения, а затем щелкните **Контейнеры**.

	![Информация об учетной записи хранения](./media/virtual-machines-freebsd-create-upload-vhd/storageaccount_detail.png)

7. Щелкните **Создание контейнера**.

	![Информация об учетной записи хранения](./media/virtual-machines-freebsd-create-upload-vhd/storageaccount_container.png)

8. Введите имя своего контейнера в поле **Имя** и выберите политику доступа в поле **Доступ**.

	![Имя контейнера](./media/virtual-machines-freebsd-create-upload-vhd/storageaccount_containervalues.png)

    > [AZURE.NOTE]По умолчанию доступ к контейнеру предоставляется только владельцу учетной записи. Чтобы разрешить общий доступ на чтение для больших двоичных объектов в контейнере, но не к свойствам и метаданным контейнера, используйте параметр «Общедоступный BLOB-объект». Чтобы разрешить полный общий доступ на чтение для контейнера и больших двоичных объектов, используйте параметр «Общедоступный контейнер».

## Шаг 3. Подготовка подключения к Microsoft Azure ##

Перед загрузкой файла VHD необходимо установить безопасное соединение между компьютером и вашей подпиской в Azure. Это можно сделать, используя метод Microsoft Azure Active Directory или метод сертификатов.

<h3>Использование Microsoft Azure AD</h3>

1. Откройте консоль Azure PowerShell.

2. Введите следующую команду: `Add-AzureAccount`
	
	После выполнения команды откроется окно входа, и вы сможете войти, используя свою рабочую или школьную учетную запись.

	![Окно PowerShell](./media/virtual-machines-freebsd-create-upload-vhd/add_azureaccount.png)

3. Azure выполняет проверку подлинности и сохраняет учетные данные, а затем закрывает окно.

<h3>Использование сертификата</h3>

1. Откройте консоль Azure PowerShell. 

2. Введите `Get-AzurePublishSettingsFile`.

3. В открывшемся окне браузера появится запрос на скачивание PUBLISHSETTINGS-файла. Он содержит информацию и сертификат для подписки Microsoft Azure.

	![Страница скачивания браузера](./media/virtual-machines-freebsd-create-upload-vhd/Browser_download_GetPublishSettingsFile.png)

3. Сохраните файл .publishsettings.

4. Введите `Import-AzurePublishSettingsFile <PathToFile>`.

	`<PathToFile>` — это полный путь к файлу PUBLISHSETTINGS.

   Дополнительную информацию см. в разделе [Начало работы с командлетами Microsoft Azure](http://msdn.microsoft.com/library/windowsazure/jj554332.aspx)
	
   Дополнительную информацию об установке и настройке PowerShell см. в статье [Как установить и настроить Microsoft Azure PowerShell](../install-configure-powershell.md).

## Шаг 4. Загрузка файла VHD ##

При загрузке файла .vhd его можно поместить в любом месте внутри хранилища больших двоичных объектов. В приведенных ниже примерах команд **BlobStorageURL** — это URL-адрес для учетной записи хранения, созданный при выполнении шага 2, **YourImagesFolder** — это контейнер внутри хранилища больших двоичных объектов, где будут храниться образы. **VHDName** — это метка, которая отображается в портале управления для идентификации виртуального жесткого диска. **PathToVHDFile** — это полный путь и имя файла .vhd.


1. В окне Azure PowerShell, использованном при выполнении предыдущего шага, введите:

		Add-AzureVhd -Destination "<BlobStorageURL>/<YourImagesFolder>/<VHDName>.vhd" -LocalFilePath <PathToVHDFile>		

## Шаг 5. Создание виртуальной машины с использованием переданного VHD-файла ##
После загрузки VHD-файла можно добавить его в качестве образа в список пользовательских образов, связанных с вашей подпиской, и создать виртуальную машину помощью с этого пользовательского образа.

1. В окне Azure PowerShell, использованном при выполнении предыдущего шага, введите:

		Add-AzureVMImage -ImageName <Your Image's Name> -MediaLocation <location of the VHD> -OS <Type of the OS on the VHD>

    **Внимание**! Укажите Linux в качестве типа ОС, так как текущая версия Azure PowerShell принимает в качестве параметра только значение Linux или Windows.

2. После выполнения предыдущих шагов новый образ отображается при выборе вкладки **Образы** на портале управления Azure.

    ![добавление образа](./media/virtual-machines-freebsd-create-upload-vhd/addfreebsdimage.png)

3. Создайте виртуальную машину из коллекции. Этот новый образ теперь доступен в разделе **Мои образы**. Выберите новый образ и выполните указания для настройки имени узла, пароля/SSH-ключа и т. п.

	![пользовательский образ](./media/virtual-machines-freebsd-create-upload-vhd/createfreebsdimageinazure.png)

4. После завершения подготовки вы увидите в Azure запущенную виртуальную машину FreeBSD.

	![образ FreeBSD в Azure](./media/virtual-machines-freebsd-create-upload-vhd/freebsdimageinazure.png)
 

<!---HONumber=July15_HO1-->