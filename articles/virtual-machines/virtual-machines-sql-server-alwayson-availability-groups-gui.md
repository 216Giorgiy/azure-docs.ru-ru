<properties
	pageTitle="Настройка групп доступности AlwaysOn (графический интерфейс пользователя) | Microsoft Azure"
	description="Создание группы доступности AlwaysOn на виртуальных машинах Azure. В этом учебнике в основном используется пользовательский интерфейс и инструменты, а не сценарии."
	services="virtual-machines"
	documentationCenter="na"
	authors="rothja"
	manager="jeffreyg"
	editor="monicar"
	tags="azure-service-management" />
<tags
	ms.service="virtual-machines"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="vm-windows-sql-server"
	ms.workload="infrastructure-services"
	ms.date="12/04/2015"
	ms.author="jroth" />

# Настройка групп доступности AlwaysOn в виртуальной машине Azure (графический пользовательский интерфейс)

> [AZURE.SELECTOR]
- [Portal - Resource Manager](virtual-machines-sql-server-alwayson-availability-groups-gui-arm.md)
- [Portal - Classic](virtual-machines-sql-server-alwayson-availability-groups-gui.md)
- [PowerShell - Classic](virtual-machines-sql-server-alwayson-availability-groups-powershell.md)

<br/>

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-classic-include.md)] Модель диспетчера ресурсов.


В этом комплексном учебнике вы научитесь реализовывать группы доступности с помощью SWL Server AlwaysOn на виртуальных машинах Azure.

>[AZURE.NOTE] На портале управления Azure находится новое средство настройки для групп доступности AlwaysOn с прослушивателем. Оно автоматически настраивает все необходимые параметры для групп доступности AlwaysOn. Дополнительную информацию см. в разделе [Предложение AlwaysOn SQL Server в коллекции классического портала Microsoft Azure](http://blogs.technet.com/b/dataplatforminsider/archive/2014/08/25/sql-server-alwayson-offering-in-microsoft-azure-portal-gallery.aspx). Инструкции по использованию PowerShell см. в учебнике по тому же сценарию в разделе [Настройка групп доступности AlwaysOn в Azure с помощью PowerShell](virtual-machines-sql-server-alwayson-availability-groups-powershell.md).

В конце учебника ваше решение SQL Server AlwaysOn в Azure будет состоять из следующих элементов:

- виртуальной сети, содержащей несколько подсетей, включая начальную и конечной подсети;

- контроллера домена с доменом Active Directory (AD);

- двух виртуальных машин SQL Server, развернутых во внутреннюю подсеть и присоединенных к домену AD;

- кластера WSFC из трех узлов с моделью кворума "Большинство узлов";

- группы доступности с двумя репликами с синхронной фиксацией базы данных доступности.

На следующем рисунке показано графическое представление решения.

![Лабораторное тестирование архитектуры для групп доступности в Azure](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC791912.png)

Обратите внимание, что это одна из возможных конфигураций. Например, можно сократить число виртуальных машин для группы доступности с двумя репликами, чтобы сократить часы вычислительных операций в Azure, используя контроллер домена как следящую общую папку кворума в кластере WSFC с 2 узлами. Этот метод сократит число виртуальных машин на одну по сравнению с указанной выше конфигурацией.

В этом учебнике предполагается следующее:

- У вас уже есть учетная запись Azure.

- Вы уже умеете подготавливать виртуальную машину SQL Server из коллекции виртуальных машин через графический интерфейс пользователя. Дополнительные сведения см. в статье [Подготовка виртуальной машины SQL Server в Azure](virtual-machines-provision-sql-server.md).

- Вы хорошо понимаете принцип работы групп доступности AlwaysOn. Дополнительные сведения см. в статье [Группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx).

>[AZURE.NOTE] Если вы планируете использовать группы доступности AlwaysOn с SharePoint, ознакомьтесь со статьей [Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://technet.microsoft.com/library/jj715261.aspx).

## Создание виртуальной сети и сервера контроллера домена

Сначала создайте новую пробную учетную запись Azure. После настройки учетной записи вы увидите начальный экран классического портала Azure.

1. Нажмите кнопку **Создать** в левом нижнем углу страницы, как показано ниже.

	![Нажмите кнопку «Создать» на портале.](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665511.gif)

1. Нажмите **Сетевые службы**, затем **Виртуальная сеть** и **Настраиваемое создание**, как показано ниже.

	![Создание виртуальной сети](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665512.gif)

1. В диалоговом окне **СОЗДАНИЕ ВИРТУАЛЬНОЙ СЕТИ** создайте новую виртуальную сеть, поэтапно настроив параметры на всех страницах, как показано ниже.

	|Страница|данных|
|---|---|
|Информация о виртуальной сети|**NAME = ContosoNET**<br/>**REGION = West US**|
|DNS-серверы и подключение VPN|None|
|Адресные пространства виртуальной сети|Параметры показаны на следующем снимке экрана: ![Создание виртуальной сети](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784620.png)|

1. Затем вам потребуется создать виртуальную машину, чтобы использовать ее в качестве контроллера домена. Снова нажмите кнопку **Создать**, затем **Вычисления**, **Виртуальная машина** и **Из коллекции**, как показано ниже.

	![Создание виртуальной машины](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784621.png)

1. В диалоговом окне **СОЗДАНИЕ ВИРТУАЛЬНОЙ МАШИНЫ** настройте новую виртуальную машину, поэтапно настроив параметры на всех страницах, как показано ниже.

	|Страница|данных|
|---|---|
|Выбор операционной системы виртуальной машины|Центр обработки данных Windows Server 2012 R2|
|Конфигурация виртуальной машины|**VERSION RELEASE DATE** = (последняя)<br/>**VIRTUAL MACHINE NAME** = ContosoDC<br/>**TIER** = STANDARD<br/>**SIZE** = A2 (2 ядра)<br/>**NEW USER NAME** = AzureAdmin<br/>**NEW PASSWORD** = Contoso!000<br/>**CONFIRM** = Contoso!000|
|Конфигурация виртуальной машины|**CLOUD SERVICE** = Создайте новую облачную службу<br/>**CLOUD SERVICE DNS NAME** = Уникальное имя облачной службы<br/>**DNS NAME** = Уникальное имя (например, ContosoDC123)<br/>**REGION/AFFINITY GROUP/VIRTUAL NETWORK** = ContosoNET<br/>**VIRTUAL NETWORK SUBNETS** = Back(10.10.2.0/24)<br/>**STORAGE ACCOUNT** = Используйте автоматически созданную учетную запись хранения<br/>**AVAILABILITY SET** = (Нет)|
|Параметры виртуальной машины|По умолчанию|

После завершения настройки новой виртуальной машины подождите, пока она подготовится к работе. Этот процесс занимает некоторое время, и если перейти на вкладку **Виртуальная машина** классического портала Azure, вы увидите, как состояния машины ContosoDC меняются в такой последовательности: **Запуск (Подготовка)**, **Остановлено**, **Запуск**, **Работает (Подготовка)** и, наконец, **Работает**.

Сервер контроллера домена успешно подготовлен. Далее нужно настроить домен Active Directory на этом сервере контроллера домена.

## Настройка контроллера домена

На следующих этапах вы настроите машину ContosoDC в качестве контроллера домена для corp.contoso.com.

1. На портале выберите машину **ContosoDC**. На вкладке **Панель мониторинга** нажмите кнопку **Подключиться**, чтобы открыть RDP-файл для удаленного доступа к рабочему столу.

	![Подключение к виртуальной машине](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784622.png)

1. Войдите в систему с использованием настроенной учетной записи администратора (**\\AzureAdmin**) и пароля (**Contoso!000**).

1. По умолчанию отображается панель мониторинга **Диспетчер серверов**.

1. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.

	![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784623.png)

1. Выбирайте **Далее**, пока не откроется раздел **Роли сервера**.

1. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.

	>[AZURE.NOTE] Вы получите предупреждение проверки об отсутствии статического IP-адреса. Если вы тестируете конфигурацию, нажмите кнопку "Продолжить". Для рабочих сценариев [используйте PowerShell для установки статического IP-адреса машины контроллера домена](./virtual-network/virtual-networks-reserved-private-ip.md).

	![Диалоговое окно добавления ролей](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784624.png)

1. Нажимайте кнопку **Далее**, пока не откроется раздел **Подтверждение**. Выберите флажок **Перезапустить целевой сервер, если требуется**.

1. Щелкните **Install** (Установить).

1. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов**.

1. Выберите новый вариант **AD DS** на левой панели.

1. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.

	![Диалоговое окно службы каталогов Active Directory на виртуальной машине DNS-сервера](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784625.png)

1. В столбце **Действие** диалогового окна **Сведения обо всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.

1. В **мастере настройки доменных служб Active Directory** используйте следующие значения:

	|Страница|Настройка|
|---|---|
|Конфигурация развертывания|**Добавить новый лес** = Выбранный<br/>**Имя корневого домена** = corp.contoso.com|
|Параметры контроллера домена|**Пароль** = Contoso!000<br/>**Подтверждение пароля** = Contoso!000|

1. Нажимайте кнопку **Далее**, чтобы пройти остальные страницы мастера. Убедитесь, что на странице **Проверка готовности** отображается следующее сообщение: **Все проверки готовности успешно завершены**. Обратите внимание, что вам следует просмотреть все применимые предупреждения, но это не обязательно для продолжения установки.

1. Щелкните **Install** (Установить). Виртуальная машина **ContosoDC** автоматически перезагрузится.

## Настройка учетных записей домена

На следующих этапах настраиваются учетные записи Active Directory (AD) для дальнейшего использования.

1. Снова войдите в машину **ContosoDC**.

1. На панели **Диспетчер серверов** выберите **Инструменты**, а затем нажмите **Центр администрирования Active Directory**.

	![Центр администрирования Active Directory](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784626.png)

1. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели.

1. На правой панели **Задачи** выберите **Создать** и нажмите **Пользователь**. Используйте следующие параметры:

	|Настройка|Значение|
|---|---|
|**Имя**|Установить|
|**User SamAccountName**|Установить|
|**Пароль**|Contoso!000|
|**Подтверждение пароля.**|Contoso!000|
|**Другие параметры пароля**|Выбрано|
|**Срок действия пароля не ограничен**|Флажок установлен|

1. Нажмите кнопку **ОК**, чтобы создать пользователя **Install** Эта учетная запись используется для настройки отказоустойчивого кластера и группы доступности.

1. Создайте двух дополнительных пользователей тем же способом: **CORP\\SQLSvc1** и **CORP\\SQLSvc2**. Эти учетные записи используются для экземпляров SQL Server. Затем вам потребуется предоставить пользователю **CORP\\Install** необходимые разрешения для настройки отказоустойчивой кластеризации служб Windows (WSFC).

1. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели. Затем на правой панели **Задачи** нажмите кнопку **Свойства**.

	![Свойства пользователя CORP](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784627.png)

1. Выберите **Расширения**, затем нажмите кнопку **Дополнительно** на вкладке **Безопасность**.

1. В диалоговом окне **Дополнительные параметры безопасности для предприятия**. Щелкните **Добавить**.

1. Щелкните **Выбрать субъект**. Затем найдите **CORP\\Install**. Нажмите кнопку **ОК**.

1. Выберите разрешения **Чтение всех свойств** и **Создание объектов-компьютеров**.

	![Разрешения пользователя Corp](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784628.png)

1. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Закройте окно свойств предприятия.

После завершения настройки Active Directory и объектов пользователей вам потребуется создать три виртуальные машины SQL Server и присоединить их к этому домену.

## Создание виртуальных машин SQL Server

Затем создайте три виртуальные машины, включая узел кластера WSFC и две виртуальные машины SQL Server. Для создания каждой виртуальной машины вернитесь на классический портал Azure и последовательно щелкните **Создать**, **Среда выполнения приложений**, **Виртуальная машина** и **Из коллекции**. Затем используйте шаблоны из следующей таблицы, чтобы упростить создание виртуальных машин.

|Страница|VM1|VM2|VM3|
|---|---|---|---|
|Выбор операционной системы виртуальной машины|**Центр обработки данных Windows Server 2012 R2**|**SQL Server 2014 RTM Enterprise**|**SQL Server 2014 RTM Enterprise**|
|Конфигурация виртуальной машины|**VERSION RELEASE DATE** = (последняя)<br/>**VIRTUAL MACHINE NAME** = ContosoWSFCNode<br/>**TIER** = STANDARD<br/>**SIZE** = A2 (2 ядра)<br/>**NEW USER NAME** = AzureAdmin<br/>**NEW PASSWORD** = Contoso!000<br/>**CONFIRM** = Contoso!000|**VERSION RELEASE DATE** = (последняя)<br/>**VIRTUAL MACHINE NAME** = ContosoSQL1<br/>**TIER** = STANDARD<br/>**SIZE** = A3 (4 ядра)<br/>**NEW USER NAME** = AzureAdmin<br/>**NEW PASSWORD** = Contoso!000<br/>**CONFIRM** = Contoso!000|**VERSION RELEASE DATE** = (последняя)<br/>**VIRTUAL MACHINE NAME** = ContosoSQL2<br/>**TIER** = STANDARD<br/>**SIZE** = A3 (4 ядра)<br/>**NEW USER NAME** = AzureAdmin<br/>**NEW PASSWORD** = Contoso!000<br/>**CONFIRM** = Contoso!000|
|Конфигурация виртуальной машины|**CLOUD SERVICE** = Уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**REGION/AFFINITY GROUP/VIRTUAL NETWORK** = ContosoNET<br/>**VIRTUAL NETWORK SUBNETS** = Back(10.10.2.0/24)<br/>**STORAGE ACCOUNT** = Используйте автоматически созданную учетную запись хранения<br/>**AVAILABILITY SET** = Создайте группу доступности<br/>**AVAILABILITY SET NAME** = SQLHADR|**CLOUD SERVICE** = Уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**REGION/AFFINITY GROUP/VIRTUAL NETWORK** = ContosoNET<br/>**VIRTUAL NETWORK SUBNETS** = Back(10.10.2.0/24)<br/>**STORAGE ACCOUNT** = Используйте автоматически созданную учетную запись хранения<br/>**AVAILABILITY SET** = SQLHADR (Вы также можете настроить группу доступности после создания машины. Все три машины следует определить в группу доступности SQLHADR).|**CLOUD SERVICE** = Уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**REGION/AFFINITY GROUP/VIRTUAL NETWORK** = ContosoNET<br/>**VIRTUAL NETWORK SUBNETS** = Back(10.10.2.0/24)<br/>**STORAGE ACCOUNT** = Используйте автоматически созданную учетную запись хранения<br/>**AVAILABILITY SET** = SQLHADR (Вы также можете настроить группу доступности после создания машины. Все три машины следует определить в группу доступности SQLHADR).|
|Параметры виртуальной машины|По умолчанию|По умолчанию|По умолчанию|

<br/>

>[AZURE.NOTE] Предыдущая конфигурация предлагает виртуальные машины уровня СТАНДАРТНЫЙ, поскольку машины уровня БАЗОВЫЙ не поддерживают конечные точки с балансировкой нагрузки, необходимые для дальнейшего создания прослушивателей группы доступности. Кроме того, предлагаемые здесь размеры машин предназначены для тестирования групп доступности в виртуальных машинах Azure. Для обеспечения наилучшей производительности рабочих нагрузок см. рекомендации по размерам машин SQL Server и их настройке в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-sql-server-performance-best-practices.md).

После полного завершения подготовки трех виртуальных машин вам потребуется присоединить их к домену **corp.contoso.com** и предоставить пользователю "CORP\\Install" права администратора виртуальных машин. Для этого выполните следующие действия для каждой из трех виртуальных машин.

1. Во-первых, измените предпочитаемый адрес DNS-сервера. Для начала скачайте файл удаленного рабочего стола (RDP) для каждой виртуальной машины в локальный каталог, выбрав нужную виртуальную машину из списка и нажав кнопку **Подключиться**. Чтобы выбрать виртуальную машину, щелкните в любом месте, кроме первой ячейки в столбце, как показано ниже.

	![Скачивание RDP-файла](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC664953.jpg)

1. Запустите скачанный RDP-файл и войдите в виртуальную машину с использованием настроенной учетной записи администратора (**BUILTIN\\AzureAdmin**) и пароля (**Contoso!000**).

1. После входа вы должны увидеть панель мониторинга **Диспетчер серверов**. Щелкните **Локальный сервер** на левой панели.

1. Выберите ссылку **IPv4-адрес назначен DHCP, поддержка IPv6**.

1. В окне **Сетевые подключения** выберите значок сети.

	![Изменение предпочитаемого DNS-сервера для виртуальной машины](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784629.png)

1. На панели команд нажмите **Изменить параметры этого подключения** (в зависимости от размера окна вам может потребоваться щелкнуть двойную стрелку вправо, чтобы увидеть эту команду).

1. Выберите пункт **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку "Свойства".

1. Выберите "Использовать следующие адреса DNS-серверов" и укажите **10.10.2.4** в поле **Основной DNS-сервер**.

1. **10.10.2.4** — это адрес, назначенный виртуальной машине в подсети 10.10.2.0/24 в виртуальной сети Azure. Речь идет о виртуальной машине **ContosoDC**. Для проверки IP-адреса **ContosoDC** используйте команду **nslookup contosodc** в соответствующем запросе, как показано ниже.

	![Поиск IP-адреса для контроллера домена с помощью NSLOОКUP](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC664954.jpg)

1. Нажмите кнопку О**К**, а затем **Закрыть**, чтобы сохранить изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.

1. В окне **Локальный сервер** щелкните ссылку **РАБОЧАЯ ГРУППА**.

1. В разделе **Имя компьютера** нажмите кнопку **Изменить**.

1. Выберите флажок **Домен** и введите **corp.contoso.com** в текстовом поле. Нажмите кнопку **ОК**.

1. Во всплывающем диалоговом окне **Безопасность Windows** укажите имя (**CORP\\AzureAdmin**) и пароль (**Contoso!000**) учетной записи администратора домена по умолчанию.

1. При появлении сообщения "Добро пожаловать на домен corp.contoso.com" нажмите кнопку **ОК**.

1. Нажмите кнопку **Закрыть**, а затем **Перезагрузить сейчас** во всплывающем диалоговом окне.

### Добавьте пользователя "Corp\\Install" в качестве администратора на каждой виртуальной машине:

1. Дождитесь перезапуска виртуальной машины, затем снова запустите RDP-файл, чтобы войти в виртуальную машину под учетной записью **BUILTIN\\AzureAdmin**.

1. На панели **Диспетчер серверов** выберите **Инструменты**, а затем нажмите **Управление компьютерами**.

	![Управление компьютером](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784630.png)

1. В окне **Управление компьютерами** разверните пункт **Локальные пользователи и группы**, а затем выберите **Группы**.

1. Дважды щелкните группу **Администраторы**.

1. В диалоговом окне **Свойства администратора** нажмите кнопку **Добавить**.

1. Введите имя пользователя **CORP\\Install**, а затем нажмите кнопку **ОК**. При появлении запроса учетных данных используйте учетную запись **AzureAdmin** с паролем **Contoso!000**.

1. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Свойства администратора**.

### Добавьте компонент **Отказоустойчивость кластеров** для каждой виртуальной машины.

1. На панели мониторинга **Диспетчер серверов** нажмите **Добавить роли и компоненты**.

1. В **мастере добавления ролей и компонентов** нажимайте кнопку **Далее**, пока не откроется страница **Компоненты**.

1. Выберите **Отказоустойчивость кластеров**. При появлении запроса добавьте любые другие зависимые компоненты.

	![Добавление компонента отказоустойчивой кластеризации к виртуальной машине](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784631.png)

1. Нажмите кнопку **Далее**, а затем **Установить** на странице **Подтверждение**.

1. После завершения установки компонента **Отказоустойчивая кластеризация** нажмите кнопку **Закрыть**.

1. Выйдите из виртуальной машины.

1. Повторите действия в этом разделе для всех трех серверов — **ContosoWSFCNode**, **ContosoSQL1** и **ContosoSQL2**.

Виртуальные машины SQL Server подготовлены и запущены, но они устанавливаются с SQL Server с использованием параметров по умолчанию.

## Создание кластера WSFC

В этом разделе вы создадите кластер WSFC, на котором будет размещена группа доступности, созданная в дальнейшем. К этому моменту для каждой из трех виртуальных машин, которые будут использоваться в кластере WSFC, вы должны были выполнить следующие действия:

- полная подготовка в Azure;

- присоединение к домену;

- добавление пользователя **CORP\\Install** в локальную группу администраторов;

- добавление компонента "Отказоустойчивая кластеризация".

Все эти действия необходимо выполнить на каждой виртуальной машине перед тем, как присоединять ее к кластеру WSFC.

Кроме того, обратите внимание, что виртуальная сеть Azure функционирует иначе, чем локальная сеть. Создавать кластер необходимо в следующем порядке:

1. Создайте кластер с одним узлом на одном из узлов (**ContosoSQL1**).

1. Измените IP-адрес кластера на неиспользуемый адрес (**10.10.2.101**).

1. Подключите имя кластера к сети.

1. Добавьте друге узлы (**ContosoSQL2** и **ContosoWSFCNode**).

Следуйте дальнейшим инструкциям, чтобы выполнить эти задачи для полной настройки кластера.

1. Запустите RPD-файл для **ContosoSQL1** и войдите под учетной записью домена **CORP\\Install**.

1. На панели мониторинга **Диспетчер серверов** выберите **Инструменты**, а затем **Диспетчер отказоустойчивости кластеров**.

1. На левой панели щелкните правой кнопкой мыши элемент **Диспетчер отказоустойчивости кластеров** и выберите команду **Создать кластер**, как показано ниже.

	![Создать кластер](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784632.png)

1. В мастере создания кластеров создайте кластер с одним узлом, поэтапно настроив параметры на всех страницах, как указано ниже:

	|Страница|данных|
|---|---|
|Перед началом работы|По умолчанию|
|Выбор серверов|Введите **ContosoSQL1** в поле **Введите имя сервера** и нажмите кнопку **Добавить**|
|Предупреждение проверки|Выберите вариант **Нет. Для этого кластера не требуется поддержка корпорации Майкрософт, поэтому нет необходимости выполнять проверочные тесты. После нажатия кнопки "Далее" продолжить создание кластера**.|
|Точка доступа для администрирования кластера|Введите **Cluster1** в поле **Имя кластера**|
|Подтверждение|Используйте параметры по умолчанию, если вы не используете дисковые пространства. Ознакомьтесь с примечанием после этой таблицы.|

	>[AZURE.WARNING] Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, снимите флажок **Добавление всех допустимых хранилищ в кластер** на странице **Подтверждение**. Если вы не сделаете этого, виртуальные диски будут отсоединены в процессе кластеризации. Как следствие, они не отобразятся к диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.

1. На левой панели разверните элемент **Диспетчер отказоустойчивости кластеров** и щелкните **Cluster1.corp.contoso.com**.

1. На центральной панели найдите раздел **Ресурсы ядра кластера** и разверните элемент со сведениями **Имя: Cluster1**. Вы увидите ресурсы **Имя** и **IP-адрес** с состоянием **Ошибка**. Его невозможно подключить к сети, так как кластеру назначен тот же IP-адрес, что и самой виртуальной машине, то есть повторяющийся.

1. Щелкните правой кнопкой мыши ресурс **IP-адреса** в состоянии сбоя и выберите **Свойства**.

	![Свойства кластера](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784633.png)

1. Выберите **Статический IP-адрес** и укажите **10.10.2.101** в текстовом поле "Адрес". Затем нажмите кнопку **ОК**.

1. В разделе **Ресурсы ядра кластера** щелкните правой кнопкой мыши элемент **Имя: Cluster1** и нажмите кнопку **Подключить**. Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера подключится, он добавит на контроллер домена новую учетную запись компьютера Active Directory (AD). Эта учетная запись впоследствии будет использоваться для запуска кластерной службы группы доступности.

1. Наконец, добавьте оставшиеся узлы в кластер. В дереве обозревателя щелкните правой кнопкой мыши **Cluster1.corp.contoso.com**, а затем выберите **Добавить узел**, как показано ниже.

	![Добавление узла в кластер](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC784634.png)

1. В **мастере добавления узлов** нажмите кнопку **Далее**. На странице **Выбор серверов** добавьте **ContosoSQL2** и **ContosoWSFCNode** в список, введя имя сервера в поле **Введите имя сервера** и нажав кнопку **Добавить**. Когда будете готовы, нажмите кнопку **Далее**.

1. На странице **Предупреждение проверки** нажмите кнопку **Нет** (в рабочем сценарии следует выполнить проверочные тесты). Нажмите кнопку **Далее**.

1. На странице **Подтверждение** нажмите кнопку **Далее**, чтобы добавить узлы.

	>[AZURE.WARNING] Если вы используете [дисковые пространства](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, снимите флажок **Добавить все доступные носители в кластер**. Если вы не сделаете этого, виртуальные диски будут отсоединены в процессе кластеризации. Как следствие, они не отобразятся к диспетчере или обозревателе дисков, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell.

1. После добавления узлов в кластер нажмите кнопку **Готово**. Теперь диспетчер отказоустойчивости кластеров должен показывать три узла в кластере и отображать их в контейнере **Узлы**.

1. Выйдите из сеанса удаленного рабочего стола.

## Подготовка экземпляров SQL Server для группы доступности

В этом разделе вы выполните следующие действия на узлах **ContosoSQL1** и **contosoSQL2**:

- Добавите имя для входа для **NT AUTHORITY\\System** с необходимыми разрешениями для экземпляра SQL Server по умолчанию.

- Добавите **CORP\\Install** в качестве роли системного администратора экземпляра SQL Server по умолчанию.

- Откроете брандмауэр для удаленного доступа к SQL Server.

- Включите компонент групп доступности AlwaysOn.

- Измените учетную запись службы SQL Server на **CORP\\SQLSvc1** и **CORP\\SQLSvc2** соответственно.

Эти действия можно выполнять в любом порядке. Однако в следующем пошаговом руководстве они приведены в указанном порядке. Выполните следующие действия для **ContosoSQL1** и **ContosoSQL2**:

1. Если вы не вышли из сеанса удаленного рабочего стола для виртуальной машины, сделайте это.

1. Запустите RDP-файлы для **ContosoSQL1** и **ContosoSQL2** войдите под учетной записью **BUILTIN\\AzureAdmin**.

1. Во-первых, добавьте **NT AUTHORITY\\System** в список имен для входа SQL Server с необходимыми разрешениями. Запустите **SQL Server Management Studio**.

1. Нажмите кнопку **Подключение**, чтобы подключиться к экземпляру SQL Server по умолчанию.

1. В **обозревателе объектов** разверните элемент **Безопасность**, а затем элемент **Имена для входа**.

1. Щелкните правой кнопкой мыши имя для входа **NT AUTHORITY\\System**, а затем выберите пункт **Свойства**.

1. На странице **Защищаемые объекты** для локального сервера выберите **Предоставить** для следующих разрешений и нажмите кнопку **ОК**.

	- Изменение любой группы доступности

	- Соединение SQL

	- Просмотр состояния сервера

1. Затем добавьте **CORP\\Install** в качестве роли **системного администратора** в экземпляр SQL Server по умолчанию. В **обозревателе объектов** щелкните правой кнопкой мыши **Имена для входа**, а затем выберите пункт **Новое имя для входа**.

1. Введите **CORP\\Install** в поле **Имя для входа**.

1. На странице **Роли сервера** выберите **системный администратор**. Затем нажмите кнопку **ОК**. После создания имени для входа вы можете увидеть его, развернув элемент **Имена для входа** в **диспетчере объектов**.

1. Далее вам потребуется создать правило брандмауэра для SQL Server. На **начальном экране** запустите **Брандмауэр Windows в режиме повышенной безопасности**.

1. В левой панели выберите **Правила для входящих подключений**. На правой панели нажмите кнопку **Новое правило**.

1. На странице **Тип правила** выберите **Программа** и нажмите кнопку **Далее**.

1. На странице **Программа** выберите **Этот путь программы** и введите **%ProgramFiles%\\Microsoft SQL Server\\MSSQL12.MSSQLSERVER\\MSSQL\\Binn\\sqlservr.exe** в текстовом поле (если вы следуете этим указаниям, но используете SQL Server 2012, каталог SQL Server — **MSSQL11.MSSQLSERVER**). Нажмите кнопку **Далее**.

1. На странице **Действие** оставьте флажок **Разрешить подключение** и нажмите кнопку **Далее**.

1. На странице **Профиль** примите параметры по умолчанию и нажмите кнопку **Далее**.

1. На странице **Имя** укажите имя правила, например **SQL Server (правило программы)**, в текстовом поле **Имя** и нажмите кнопку **Готово**.

1. Затем включите компонент **групп доступности AlwaysOn**. На **начальном экране** запустите **Диспетчер конфигурации SQL Server**.

1. В дереве обозревателя щелкните **Службы SQL Server**, затем щелкните правой кнопкой мыши службу **SQL Server (MSSQLSERVER)** и выберите пункт **Свойства**.

1. Выберите вкладку **Высокая доступность AlwaysOn**, затем выберите **Включить группы доступности AlwaysOn**, как показано ниже, и нажмите кнопку **Применить**. Нажмите кнопку **ОК** во всплывающем диалоговом окне и не закрывайте окно свойств. После изменения учетной записи службы вам потребуется перезапустить службу SQL Server.

	![Включение групп доступности AlwaysOn](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665520.gif)

1. Далее вам потребуется изменить учетную запись службы SQL Server. Откройте вкладку **Вход**, затем введите **CORP\\SQLSvc1** (для **ContosoSQL1**) или **CORP\\SQLSvc2** (для **ContosoSQL2**) в поле **Имя учетной записи**, после чего введите и подтвердите пароль и нажмите кнопку **ОК**.

1. Во всплывающем окне нажмите кнопку **Да**, чтобы перезапустить службу SQL Server. После перезапуска службы SQL Server изменения, внесенные вами в окне свойств, вступят в силу.

1. Выйдите из виртуальных машин.

## Создание группы доступности

Теперь можно приступить к настройке группы доступности. Ниже приведено краткое описание того, что вам потребуется сделать:

- Создание новой базы данных (**MyDB1**) на **ContosoSQL1**.

- Создание полной резервной копии и резервной копии журнала транзакций базы данных.

- Восстановление обеих резервных копий на **ContosoSQL2** с параметром **NORECOVERY**.

- Создание группы доступности (**AG1**) с синхронной фиксацией, автоматической отработкой отказа и доступными для чтения вторичными репликами.

### Создание базы данных MyDB1 на ContosoSQL1:

1. Если вы еще не вышли из сеансов удаленных рабочих столов для **ContosoSQL1** и **ContosoSQL2**, сделайте это.

1. Запустите RPD-файл для **ContosoSQL1** и войдите под учетной записью **CORP\\Install**.

1. В **проводнике** на диске **C:** создайте каталог с именем **backup**. Вы будете использовать этот каталог для резервного копирования и восстановления базы данных.

1. Щелкните правой кнопкой мыши новый каталог, наведите курсор на элемент **Общий доступ** и нажмите **Отдельные люди**, как показано ниже.

	![Создание папки резервного копирования](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665521.gif)

1. Добавьте пользователя **CORP\\SQLSvc1** и предоставьте ему разрешение **Чтение/запись**. Затем добавьте пользователя **CORP\\SQLSvc2** и предоставьте ему разрешение **Чтение**, как показано ниже, после чего нажмите **Поделиться**. После завершения процесса предоставления общего доступа к файлам нажмите кнопку **Готово**.

	![Предоставление разрешений для папки резервного копирования](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665522.gif)

1. Далее вы создадите базу данных. В меню **Пуск** запустите **SQL Server Management Studio**, затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.

1. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Новая база данных**.

1. В поле **Имя базы данных** введите **MyDB1**, а затем нажмите кнопку **ОК**.

### Создайте полную резервную копию MyDB1 и сохраните ее на ContosoSQL2:

1. Далее вы создадите полную резервную копию базы данных. В **обозревателе объектов**, разверните элемент **Базы данных**, затем щелкните правой кнопкой мыши базу данных **MyDB1**, наведите курсор на пункт **Задачи** и нажмите **Резервное копирование**.

1. В разделе **Источник** оставьте параметр **Тип резервного копирования** со значением **Полное**. В разделе **Назначение** нажмите кнопку **Удалить**, чтобы удалить путь к файлу резервной копии по умолчанию.

1. В разделе **Назначение** нажмите кнопку **Добавить**.

1. В текстовом поле **Имя файла** введите **\\ContosoSQL1\\backup\\MyDB1.bak**. Затем нажмите кнопку **ОК** и еще раз кнопку **ОК**, чтобы создать резервную копию базы данных. После завершения резервного копирования нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.

1. Далее вы создадите резервную копию журнала транзакций базы данных. В **обозревателе объектов** разверните элемент **Базы данных**, затем щелкните правой кнопкой мыши базу данных **MyDB1**, наведите курсор на пункт **Задачи** и нажмите **Резервное копирование**.

1. В поле **Тип резервной копии** выберите вариант **Журнал транзакций**. В разделе **Назначение** оставьте указанный ранее путь к файлу и нажмите кнопку **ОК**. После завершения резервного копирования нажмите кнопку **ОК** еще раз.

1. Далее вы восстановите полную резервную копию и резервную копию журнала транзакций на **ContosoSQL2**. Запустите RPD-файл для **ContosoSQL2** и войдите под учетной записью **CORP\\Install**. Оставьте сеанс удаленного рабочего стола для **ContosoSQL1** открытым.

1. В меню **Пуск** запустите **SQL Server Management Studio**, затем нажмите кнопку **Подключиться**, чтобы подключиться к экземпляру SQL Server по умолчанию.

1. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Восстановить базу данных**.

1. В разделе **Источник** выберите **Устройство** и нажмите кнопку **…**.

1. В разделе **Выберите устройства резервного копирования** нажмите кнопку **Добавить**.

1. В поле "Расположение файла резервной копии" введите "\\ContosoSQL1\\backup", затем нажмите кнопку "Обновить", выберите "MyDB1.bak", нажмите кнопку "ОК" и еще раз кнопку "ОК". На панели "Восстанавливаемые резервные наборы данных" должны появиться полная резервная копия и резервная копия журнала.

1. Перейдите на страницу "Параметры", выберите вариант "ВОССТАНОВЛЕНИЕ С ПОМОЩЬЮ NORECOVERY" в состоянии "Восстановление" и нажмите кнопку "ОК", чтобы восстановить базу данных. После завершения восстановления нажмите кнопку "ОК".

### Создание группы доступности:

1. Вернитесь к сеансу удаленного рабочего стола для **ContosoSQL1**. В **обозревателе объектов** в SSMS щелкните правой кнопкой мыши **Высокая доступность AlwaysOn** и выберите **Мастер создания групп доступности**, как показано ниже.

	![Запуск мастера создания групп доступности](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665523.gif)

1. На странице **Введение** нажмите кнопку **Далее**. На странице **Указание имени группы доступности** введите **AG1** в поле **Имя группы доступности**, затем нажмите кнопку **Далее** еще раз.

	![Мастер создания групп доступности, ввод имени групп доступности](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665524.gif)

1. На странице **Выбор баз данных** выберите **MyDB1** и нажмите кнопку **Далее**. Эта база данных отвечает требованиям для создания группы доступности, так как вы создали для нее как минимум одну полную резервную копию на соответствующей первичной реплике.

	![Мастер создания групп доступности, выбор баз данных](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665525.gif)

1. На странице **Указание реплик** нажмите кнопку **Добавить реплику**.

	![Мастер создания групп доступности, указание реплик](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665526.gif)

1. Появится диалоговое окно **Подключение к серверу**. Введите **ContosoSQL2** в поле **Имя сервера** и нажмите кнопку **Подключиться**.

	![Мастер создания групп доступности, подключение к серверу](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665527.gif)

1. На странице **Реплики** сервер **ContosoSQL2** должен отобразиться в списке **Доступные реплики**. Настройте реплики, как показано ниже. После завершения нажмите кнопку **Далее**.

	![Мастер создания групп доступности, указание реплик (завершено)](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665528.gif)

1. На странице **Выбор начальной синхронизации данных** выберите **Только соединение** и нажмите кнопку **Далее**. Вы уже выполнили синхронизацию данных вручную при создании полной резервной копии и резервной копии журнала транзакций на **ContosoSQL1** и их восстановлении на **ContosoSQL2**. Вы можете не выполнять операции резервного копирования и восстановления для базы данных и выбрать **Полная**, чтобы позволить мастеру создания групп доступности выполнить синхронизацию данных вместо вас. Обратите внимание, что синхронизацию не рекомендуется проводить для весьма крупных баз, которые иногда используются на предприятиях.

	![Мастер создания групп доступности, выбор начальной синхронизации данных](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665529.gif)

1. На странице **Проверка** нажмите кнопку **Далее**. Страница должна иметь примерно такой вид: Появится предупреждение о конфигурации прослушивателя группы доступности, так как он еще не настроен. Вы можете пропустить это предупреждение, поскольку процедура настройки прослушивателя не описана в этом учебнике. После завершения этого учебника инструкции по настройке прослушивателя вы можете найти в статье [Настройка прослушивателя внутренней подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure](virtual-machines-sql-server-configure-ilb-alwayson-availability-group-listener.md).

	![Мастер создания групп доступности, проверка](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665530.gif)

1. На странице **Сводка** нажмите кнопку **Готово**, затем подождите, пока мастер настроит новую группу доступности. На странице **Ход выполнения** вы можете нажать кнопку **Дополнительные сведения**, чтобы просмотреть подробности хода выполнения. Завершив работу с мастером, проверьте содержимое страницы **Результаты**, чтобы убедиться, что группа доступности успешно создана, как показано ниже, и нажмите кнопку **Закрыть**, чтобы выйти из мастера.

	![Мастер создания групп доступности, результаты](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665531.gif)

1. В **обозревателе объектов** разверните элемент **Высокая доступность AlwaysOn**, а затем элемент **Группы доступности**. Теперь в этом контейнере должна появиться новая группа доступности. Щелкните правой кнопкой мыши **AG1 (основная)** и выберите пункт **Отобразить панель мониторинга**.

	![Отображение панели мониторинга группы доступности](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665532.gif)

1. **Панель мониторинга AlwaysOn** должна выглядеть примерно следующим образом: Вы увидите реплики, режим отработки отказа для каждой из них и состояние синхронизации.

	![Панель мониторинга группы доступности](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665533.gif)

1. Вернитесь на панель **Диспетчер серверов**, выберите **Инструменты** и запустите **Диспетчер отказоустойчивости кластеров**.

1. Разверните элемент **Cluster1.corp.contoso.com**, а затем разверните элемент **Службы и приложения**. Выберите **Роли** и обратите внимание, что роль группы доступности **AG1** создана. Обратите внимание, что у группы AG1 нет IP-адреса, по которому клиенты базы данных могут подключиться к группе доступности, поскольку вы не настроили прослушиватель. Вы можете подключиться напрямую к основному узлу для операций чтения и записи и второстепенному узлу для запросов только на чтение.

	![Группа доступности в диспетчере отказоустойчивости кластеров](./media/virtual-machines-sql-server-alwayson-availability-groups-gui/IC665534.gif)

>[AZURE.WARNING] Не пытайтесь выполнить отработку отказа для группы доступности через диспетчер отказоустойчивости кластеров. Все операции отработки отказов следует выполнять через **панель мониторинга AlwaysOn** в SSMS. Дополнительные сведения см. в статье [Ограничения на использование диспетчера отказоустойчивости кластеров WSFC с группами доступности](https://msdn.microsoft.com/library/ff929171.aspx).

## Дальнейшие действия
Решение SQL Server AlwaysOn на основе группы доступности в Azure успешно создано. Инструкции по настройке прослушивателя группы доступности см. в статье [Настройка прослушивателя внутренней подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure](virtual-machines-sql-server-configure-ilb-alwayson-availability-group-listener.md).

Дополнительные сведения об использовании SQL Server в Azure см. в статье [Общие сведения об SQL Server на виртуальных машинах Azure](../articles/virtual-machines/virtual-machines-sql-server-infrastructure-services.md).

<!----HONumber=AcomDC_0211_2016-->
