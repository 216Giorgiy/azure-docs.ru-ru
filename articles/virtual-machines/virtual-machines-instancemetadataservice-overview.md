---
title: "Общие сведения о службе метаданных экземпляров Azure | Документация Майкрософт"
description: "Использование интерфейса RESTful для получения сведений о вычислительных ресурсах виртуальной машины, сети и ближайших мероприятиях обслуживания."
services: virtual-machines-windows, virtual-machines-linux,virtual-machines-scale-sets, cloud-services
documentationcenter: 
author: harijay
manager: timlt
editor: 
tags: 
ms.service: azure-instancemetadataservice
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/27/2017
ms.author: harijay
translationtype: Human Translation
ms.sourcegitcommit: cc9e81de9bf8a3312da834502fa6ca25e2b5834a
ms.openlocfilehash: b5c0268e1a0ebfcb33781678a367090cad865907
ms.lasthandoff: 04/11/2017

---

# <a name="azures-instance-metadata-service---preview"></a>Предварительная версия службы метаданных экземпляров Azure

> [!NOTE] 
> Предварительные версии предоставляются при условии, что вы соглашаетесь с условиями использования. Дополнительные сведения см. в статье [Дополнительные условия использования Предварительных выпусков Microsoft Azure] (https://azure.microsoft.com/ru-ru/support/legal/preview-supplemental-terms/).
>

Служба метаданных экземпляров содержит сведения о выполнении экземпляров виртуальных машин. Эти сведения можно использовать для настройки экземпляров в Azure и управления ими. Служба метаданных экземпляров Azure — это конечная точка RESTful, доступная для всех виртуальных машин IaaS, созданных с помощью нового [Azure Resource Manager](https://docs.microsoft.com/rest/api/resources/?redirectedfrom=MSDN). Конечная точка доступна по известному IP-адресу без поддержки маршрутизации (*169.254.169.254*), к которому можно получить доступ только в пределах виртуальной машины. Эта служба будет предоставлять важные данные об экземпляре виртуальной машины, конфигурации сети и ближайших мероприятиях обслуживания. Дополнительные сведения см. в разделе [Категории данных метаданных экземпляров](#instance-metadata-data-categories).

### <a name="important-information"></a>Важные сведения
Сейчас доступна только **предварительная версия** этой службы, которая содержит сведения об экземпляре виртуальной машины и ближайших мероприятиях обслуживания. Служба продолжает получать обновления. На этой странице ниже приведены определенные доступные [категории данных](#instance-metadata-data-categories).


## <a name="service-availability"></a>Доступность службы
Текущая предварительная версия доступна в **западно-центральной части США** службы Azure. В таблице ниже содержатся обновленные сведения по регионам, в которых доступна предварительная версия этой службы.
Чтобы протестировать службу метаданных экземпляров, создайте виртуальную машину с помощью [Azure Resource Manager](https://docs.microsoft.com/rest/api/resources/?redirectedfrom=MSDN) или [портала Azure](http://portal.azure.com) и используйте примеры, приведенные в подразделе "Примеры", для получения доступа к службе метаданных. 

Регионы, в которых доступна предварительная версия службы метаданных экземпляров:|
------------------------------------------------------------|
Западно-центральная часть США |



## <a name="retrieving-instance-metadata"></a>Получение метаданных экземпляров 

Используйте метаданные экземпляров для запуска виртуальных машин, созданных или управляемых с помощью [Azure Resource Manager](https://docs.microsoft.com/rest/api/resources/?redirectedfrom=MSDN). Вы можете получить доступ ко всем категориям данных экземпляров виртуальной машины с помощью следующего универсального кода ресурса (URI):

```
 curl -H Metadata:true "http://169.254.169.254/metadata/instance?api-version=2017-03-01"
```

Выходные данные по умолчанию для всех метаданных экземпляров предоставляются в формате JSON (тип содержимого application/JSON).

## <a name="usage-examples"></a>Примеры использования
Ниже приводится набор примеров и семантика использования для службы метаданных экземпляров.

### <a name="versioning"></a>Управление версиями 
Для службы метаданных экземпляров включено управление версиями. Версии являются обязательными и на данный момент используется предварительная версия от 01.03.2017.


```
curl -H Metadata:true "http://169.254.169.254/metadata/instance?api-version=2017-03-01"
```

Так как мы добавляем новые версии, вы все еще можете получить доступ к предыдущим версиям для обеспечения совместимости, если используемый скрипт зависит от конкретных форматов данных. Обратите внимание, что текущая предварительная версия может быть недоступна после выпуска общедоступной службы.


### <a name="data-output"></a>Выходные данные
По умолчанию метаданные экземпляра возвращают данные в формате JSON (тип содержимого — application/json).По мере необходимости различные элементы узла могут возвращать данные в другом формате по умолчанию. Следующая таблица содержит краткие справочные сведения по форматам данных. 

Элемент | Формат данных по умолчанию | Другие форматы
--------|---------------------|--------------
/instance | json | text
/scheduledevents | json | Нет

Для текстового формата в URL-адресе запроса используйте format=text, например: 

```
curl -H Metadata:true "http://169.254.169.254/metadata/instance?api-version=2017-03-01&format=text"
```
### <a name="security"></a>Безопасность
Конечная точка метаданных экземпляров доступна только в пределах запущенного экземпляра виртуальной машины на IP-адресе 169.254.169.254, не поддерживающем маршрутизацию. Кроме того, любой запрос с **заголовком X-Forwarded-For** отклоняется службой метаданных. Чтобы гарантировать, что фактический запрос отправлен напрямую и не был получен в ходе непреднамеренного перенаправления, он должен содержать отправляемый заголовок **Metadata:true**. 
### <a name="error"></a>Ошибка
Если элемент данных не найден или неправильно сформированные запросы службы метаданных экземпляров возвращают стандартную ошибку HTTP, изучите следующие несколько примеров кодов возврата: 

Код возврата HTTP | Причина
----------------|-------
200 | ОК
400 | Ошибка запроса, отсутствует заголовок, передан заголовок -H Metadata:true
404 | Не найдено, запрашиваемый элемент не существует 
405 | Неподдерживаемый метод 
429 | Слишком много запросов, сейчас поддерживается не более 5 запросов в секунду

### <a name="examples"></a>Примеры
#### <a name="retrieving-the-network-information"></a>Получение сведений о сети 

**Запрос**
```
curl -H Metadata:true "http://169.254.169.254/metadata/instance/network?api-version=2017-03-01"

```
**Ответ**
> [!NOTE] 
> Ответ представляет собой строку JSON. Следующие выходные данные JSON отформатированы с помощью служебной программы [jq](https://stedolan.github.io/jq/).
>

```
{
  "interface": [
    {
      "ipv4": {
        "ipaddress": [
          {
            "ipaddress": "10.0.0.4",
            "publicip": "<>.<>.<>.<>"
          }
        ],
        "subnet": [
          {
            "address": "10.0.0.0",
            "dnsservers": [
              {
                "ipaddress": "10.0.0.2"
              },
              {
                "ipaddress": "10.0.0.3"
              }
            ],
            "prefix": "24"
          }
        ]
      },
      "ipv6": {
        "ipaddress": []
      },
      "mac": "000D3A00FA89"
    }
  ]
}
```

#### <a name="retrieving-public-ip-address"></a>Получение общедоступного IP-адреса

```
curl -H Metadata:true "http://169.254.169.254/metadata/instance/network/interface/0/ipv4/ipaddress/0/publicip?api-version=2017-03-01&format=text"
```

#### <a name="retrieving-all-metadata-for-an-instance"></a>Получение всех метаданных для экземпляра

**Запрос**
```
curl -H Metadata:true "http://169.254.169.254/metadata/instance?api-version=2017-03-01"
```
**Ответ**
> [!NOTE]
> Ответ представляет собой строку JSON. Следующие выходные данные JSON отформатированы с помощью служебной программы [jq](https://stedolan.github.io/jq/).
>

```
{
"compute": {
    "location": "CentralUS",
    "name": "IMDSCanary",
    "offer": "RHEL",
    "osType": "Linux",
    "platformFaultDomain": "0",
    "platformUpdateDomain": "0",
    "publisher": "RedHat",
    "sku": "7.2",
    "version": "7.2.20161026",
    "vmId": "5c08b38e-4d57-4c23-ac45-aca61037f084",
    "vmSize": "Standard_DS2"
  },
  "network": {
    "interface": [
      {
        "ipv4": {
          "ipaddress": [
            {
              "ipaddress": "10.0.0.4",
              "publicip": "X.X.X.X"
            }
          ],
          "subnet": [
            {
              "address": "10.0.0.0",
              "dnsservers": [
                {
                  "ipaddress": "10.0.0.2"
                },
                {
                  "ipaddress": "10.0.0.3"
                }
              ],
              "prefix": "24"
            }
          ]
        },
        "ipv6": {
          "ipaddress": []
        },
        "mac": "000D3A00FA89"
      }
    ]
  }
}

```
#### <a name="retrieving-metadata-in-windows-virtual-machine"></a>Получение метаданных в виртуальной машине Windows

Метаданные экземпляра в Windows можно получить с помощью служебной программы Curl службы Powershell. В командной строке PowerShell выполните описанные ниже команды. 

**Запрос**
```
curl -H @{'Metadata'='true'} http://169.254.169.254/metadata/instance?api-version=2017-03-01 | select -ExpandProperty Content
```
**Ответ**
>[!NOTE]
> Ответ представляет собой строку JSON. Следующие выходные данные JSON отформатированы с помощью служебной программы ConvertTo-Json Powershell.
> 

```
{
    "compute":  {
                    "location":  "CentralUSEUAP",
                    "name":  "SQLTest",
                    "offer":  "SQL2016SP1-WS2016",
                    "osType":  "Windows",
                    "platformFaultDomain":  "0",
                    "platformUpdateDomain":  "0",
                    "publisher":  "MicrosoftSQLServer",
                    "sku":  "Enterprise",
                    "version":  "13.0.400110",
                    "vmId":  "453945c8-3923-4366-b2d3-ea4c80e9b70e",
                    "vmSize":  "Standard_DS2"
                },
    "network":  {
                    "interface":  [
                                      "@{ipv4=; ipv6=; mac=002248020E1E}"
                                  ]
                }
}
```


## <a name="instance-metadata-data-categories"></a>Категории данных метаданных экземпляров
Следующая таблица содержит список всех категорий данных, доступных в метаданных экземпляра:

Данные | Описание
-----|------------
location | Регион Azure, в котором запущена виртуальная машина 
name | Имя виртуальной машины. 
offer | Предоставление сведений для образа виртуальной машины (эти значения доступны только для образов, развернутых из коллекции образов Azure) 
publisher | Издатель образа виртуальной машины
sku | Определенный номер SKU для образа виртуальной машины  
версия | Версия образа виртуальной машины 
osType | Linux или Windows 
platformUpdateDomain |  [Домен обновления](virtual-machines-windows-manage-availability.md), на котором запущена виртуальная машина 
platformFaultDomain | [Домен сбоя](virtual-machines-windows-manage-availability.md), на котором запущена виртуальная машина
vmId | Дополнительные сведения об уникальном идентификаторе виртуальной машины см. [здесь](https://azure.microsoft.com/blog/accessing-and-using-azure-vm-unique-id/)
vmSize | [Размер виртуальной машины](virtual-machines-windows-sizes.md)
ipv4/ipaddress | Локальный IP-адрес виртуальной машины 
ipv4/publicip | Общедоступный IP-адрес экземпляра 
subnet/address | Адрес подсети 
subnet/dnsservers/ipaddress1 | Основной DNS-сервер.
subnet/dnsservers/ipaddress2 | Дополнительный DNS-сервер
subnet/prefix | Префикс подсети, пример 24
ipv6/ipaddress | IPv6-адрес виртуальной машины
mac | Mac-адрес виртуальной машины 
scheduledevents | Ознакомьтесь со статьей [Служба метаданных Azure. Запланированные события (предварительная версия)](virtual-machines-scheduled-events.md)



## <a name="example-scenarios-for-usage"></a>Примеры сценариев использования  

### <a name="tracking-vm-running-on-azure"></a>Отслеживание виртуальной машины в Azure 

Поставщику услуг может потребоваться отслеживать количество виртуальных машин, использующих ваше программное обеспечение, или установить агенты, отслеживающие уникальность виртуальной машины. Чтобы получить уникальный идентификатор для виртуальной машины, используйте поле vmId службы метаданных экземпляров. 

**Запрос**
```
curl -H Metadata:true "http://169.254.169.254/metadata/instance/compute/vmId?api-version=2017-03-01&format=text"
```
**Ответ**
```
5c08b38e-4d57-4c23-ac45-aca61037f084

```

### <a name="placement-of-containers-data-partitions-based-faultupdate-domain"></a>Размещение контейнеров и секций данных на основе домена сбоя или обновления 

В некоторых сценариях размещение разных реплик имеет первостепенное значение. Например, для [размещения реплики HDFS](https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/HdfsDesign.html#Replica_Placement:_The_First_Baby_Steps) или размещения контейнера с помощью [оркестратора](https://kubernetes.io/docs/user-guide/node-selection/) необходимо знать домен сбоя (platformFaultDomain) и домен обновления (platformUpdateDomain), на которых запущена виртуальная машина. Вы можете запросить точки данных непосредственно через метаданные экземпляров.

**Запрос**
```
curl -H Metadata:true "http://169.254.169.254/metadata/instance/compute/platformFaultDomain?api-version=2017-03-01&format=text" 
```
**Ответ**
```
0
```

### <a name="getting-more-information-about-the-vm-during-support-case"></a>Получение дополнительных сведений о виртуальной машине при обращении в службу поддержки 

Чтобы получить дополнительные сведения о виртуальной машине, поставщик услуг может позвонить в службу поддержки. Если клиент предоставит сведения о метаданных вычислений, специалист службы поддержки получит основные сведения о виртуальной машине в Azure. 

**Запрос**
```
curl -H Metadata:true "http://169.254.169.254/metadata/instance/compute?api-version=2017-03-01"
```
**Ответ**
> [!NOTE] 
> Ответ представляет собой строку JSON. Следующие выходные данные JSON отформатированы с помощью служебной программы [jq](https://stedolan.github.io/jq/).
>

```
{
"compute": {
    "location": "CentralUS",
    "name": "IMDSCanary",
    "offer": "RHEL",
    "osType": "Linux",
    "platformFaultDomain": "0",
    "platformUpdateDomain": "0",
    "publisher": "RedHat",
    "sku": "7.2",
    "version": "7.2.20161026",
    "vmId": "5c08b38e-4d57-4c23-ac45-aca61037f084",
    "vmSize": "Standard_DS2"
  }

}
```

## <a name="faq"></a>Часто задаваемые вопросы
1. Я получаю сообщение об ошибке 400 (недопустимый запрос) о том, что необходимый заголовок метаданных не указан. Что это означает?
   * Для работы службы метаданных экземпляра заголовок Metadata:true необходимо передать в запрос. Передача заголовка в вызов REST позволяет получить доступ к службе метаданных экземпляра. 
2. Почему я не получаю сведения о вычислениях для виртуальной машины?
   * Сейчас служба метаданных экземпляров поддерживает только экземпляры, созданные в Azure Resource Manager. В будущем мы планируем добавить поддержку для виртуальных машин облачных служб. 
3. Виртуальная машина была недавно создана с помощью Azure Resource Manager. Почему не отображаются сведения о метаданных вычислений?
   * Чтобы отобразить метаданные вычислений для любой виртуальной машины, созданной после сентября 2016 года, необходимо добавить [тег](../azure-resource-manager/resource-group-using-tags.md). Для обновления метаданных более старых виртуальных машин (созданных до сентября 2016 г.) удалите расширения или диски данных или добавьте их к виртуальной машине.
4. Почему возникает ошибка HTTP 500 (внутренняя ошибка сервера)?
   * Сейчас предварительная версия метаданных экземпляров доступна только в западно-центральной части США. Разверните виртуальные машины в поддерживаемых регионах.  
4. Где можно задать дополнительные вопросы или оставить комментарии?
   * Оставьте комментарии на сайте feedback.azure.com.
    
## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о запланированных событиях см. в статье [Служба метаданных Azure. Запланированные события (предварительная версия)] (virtual-machines-scheduled-events.md).

