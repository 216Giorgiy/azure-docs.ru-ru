<properties 
	pageTitle="Руководство пользователя агента Linux для Azure" 
	description="Узнайте, как установить и настроить агент Linux (waagent) для управления взаимодействием виртуальной машины с Azure Fabric Controller." 
	services="virtual-machines" 
	documentationCenter="" 
	authors="szarkos" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="virtual-machines" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="vm-linux" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/07/2015" 
	ms.author="szark"/>



#Руководство пользователя агента Linux для Azure

##Введение

Агент Linux для Azure (/usr/sbin/waagent) управляет взаимодействием виртуальной машины с контроллером структуры Azure. Он выполняет следующие действия:

* **Подготовка образа**
  - Создание учетной записи пользователя
  - Настройка типов аутентификации SSH
  - Развертывание открытых ключей SSH и пар ключей
  - Настройка имени узла
  - Публикация имени узла DNS платформы
  - Отчет с отпечатком ключа узла SSH для платформы
  - Управление диском ресурсов
  - Форматирование и подключение диска ресурсов
  - Настройка пространства подкачки
* **Сеть**
  - Управляет маршрутами для улучшения совместимости с DHCP-серверами платформы
  - Обеспечивает стабильность имени сетевого интерфейса
* **Ядро**
  - Настройка виртуальной архитектуры NUMA
  - Использование энтропии Hyper-V для /dev/random
  - Настройка времени ожидания SCSI для корневого устройства (может быть удаленным)
* **Диагностика**
  - Перенаправление консоли на последовательный порт
* **Развернутые приложения SCVMM**
    - Обнаружение и начальная загрузка агента VMM для Linux при работе в среде System Center Virtual Machine Manager 2012 R2
* **Расширение виртуальной машины**
    - Вставка компонента, созданного корпорацией Майкрософт и ее партнерами, в виртуальную машину Linux (IaaS) для включения программного обеспечения и автоматизации настройки
    - Эталонная реализация расширения виртуальной машины на сайте [https://github.com/Azure/azure-linux-extensions](https://github.com/Azure/azure-linux-extensions)


##Обмен данными

Поток информации от платформы к агенту передается по двум каналам:

* Прилагаемый DVD, используемый во время загрузки, для развернутых приложений IaaS. На этом DVD содержится OVF-совместимый файл конфигурации, включающий всю информацию для подготовки кроме самих пар ключей SSH.

* Чтобы получить развертывание и настройку топологии, используется конечная точка TCP с REST API.

###Получение агента Linux
Последнюю версию агента Linux вы можете напрямую получить:

- [у различных поставщиков дистрибутивов, работающих с Linux в Azure](http://support.microsoft.com/kb/2805216);
- из репозитория [Github открытого исходного кода для агента Linux для Azure](https://github.com/Azure/WALinuxAgent).


## Требования
Следующие системы протестированы и гарантированно поддерживают работу с агентом Linux для Azure. **Обратите внимание, что этот список может отличаться от официального списка систем, поддерживаемых платформой Microsoft Azure**, который доступен по следующему адресу: [http://support.microsoft.com/kb/2805216](http://support.microsoft.com/kb/2805216).

###Поддерживаемые дистрибутивы Linux

* CoreOS
* CentOS 6.2+
* Debian 7.0+
* Ubuntu 12.04+
* openSUSE 12.3+
* SLES 11 SP2+
* Oracle Linux 6.4+

Другие поддерживаемые системы:

* FreeBSD 9+ (агент Linux для Azure 2.0.10+)


Для правильного функционирования агента Linux требуются определенные пакеты системы:

* Python 2.6+
* Openssl 1.0+
* Openssh 5.3+
* Служебные программы файловой системы: sfdisk, fdisk, mkfs, parted
* Инструменты работы с паролями: chpasswd, sudo
* Инструменты обработки текста: sed, grep
* Сетевые инструменты: ip-route


##Установка

Установка с помощью пакета RPM или DEB из репозитория пакета дистрибутива является предпочтительным способом установки и обновления агента Linux для Azure.

При установке вручную следует скопировать сценарий waagent в /usr/sbin/waagent и произвести установку, выполнив следующую команду:

	# sudo chmod 755 /usr/sbin/waagent
	# sudo /usr/sbin/waagent -install -verbose

Файл журнала агента хранится в /var/log/waagent.log.


##Параметры командной строки

###Флаги

- verbose: расширить указанную команду
- force: пропустить интерактивные подтверждения для некоторых команд

###Команды

- help: список поддерживаемых команд и флагов.

- install: ручная установка агента
 * Проверяет систему на наличие обязательных зависимостей

 * Создает сценарий инициализации SysV (/etc/init.d/waagent), файл конфигурации logrotate (/etc/logrotate.d/waagent и настраивает образ, чтобы запустить сценарий инициализации во время загрузки

 * Записывает шаблон файла конфигурации в /etc/waagent.conf

 * Существующий файл конфигурации перемещается в /etc/waagent.conf.old

 * Определяет версию ядра и при необходимости применяет метод обхода VNUMA

 * Перемещает правила udev, которые могут конфликтовать сетью (/lib/udev/rules.d/75-persistent-net-generator.rules, /etc/udev/rules.d/70-persistent-net.rules) в /var/lib/waagent/

- uninstall: удаляет waagent и связанные файлы
 * Отменяет регистрацию сценария инициализации в системе и удаляет его

 * Удаляет конфигурацию logrotate и файл конфигурации waagent в /etc/waagent.conf

 * Восстанавливает все udev-правила, которые были перемещены во время установки

 * Автоматический возврат обходного пути VNUMA не поддерживается, необходимо изменить файлы конфигурации GRUB вручную, чтобы при необходимости повторно включить NUMA.

- deprovision: попытка очистки системы и выполнение действий для ее повторной подготовки. При выполнении этой операции были удалены следующие компоненты:
 * Все ключи узла SSH (если в файле конфигурации для Provisioning.RegenerateSshHostKeyPair указано значение «y»)

 * Настройка имени сервера в /etc/resolv.conf

 * Корневой пароль из /etc/shadow (если в файле конфигурации для Provisioning.DeleteRootPassword указано значение «y»)

 * Кэшированные аренды DHCP-клиентов

 * Возвращает имя узла localhost.localdomain

 **Предупреждение.** Отзыв не гарантирует, что из образа будет удалена вся конфиденциальная информация и что он будет готов к повторному распространению.

- deprovision+user: выполняет все действия, указанные для команды -deprovision (см. выше), а также удаляет последнюю подготовленную учетную запись пользователя (полученную в /var/lib/waagent) и связанные с ней данные. Этот параметр используется для отмены подготовки ранее подготовленного образа в Azure с целью его записи и повторного использования.

- version: отображает версию waagent

- serialconsole: настройка GRUB для маркировки ttyS0 (первый последовательный порт) в качестве консоли загрузки. Это гарантирует, что журналы загрузки ядра отправляются на последовательный порт и становятся доступными для отладки.

- daemon: запуск waagent в качестве управляющей программы для контроля взаимодействия с платформой. Этот аргумент указывается для waagent в сценарии инициализации waagent.

##Конфигурация

Файл конфигурации (/ etc/waagent.conf) определяет действия waagent. Ниже приводится пример файла конфигурации:
	
	#
	# Azure Linux Agent Configuration	
	#
	Role.StateConsumer=None 
	Role.ConfigurationConsumer=None 
	Role.TopologyConsumer=None
	Provisioning.Enabled=y
	Provisioning.DeleteRootPassword=n
	Provisioning.RegenerateSshHostKeyPair=y
	Provisioning.SshHostKeyPairType=rsa
	Provisioning.MonitorHostName=y
	ResourceDisk.Format=y
	ResourceDisk.Filesystem=ext4
	ResourceDisk.MountPoint=/mnt/resource 
	ResourceDisk.EnableSwap=n 
	ResourceDisk.SwapSizeMB=0
	LBProbeResponder=y
	Logs.Verbose=n
	OS.RootDeviceScsiTimeout=300
	OS.OpensslPath=None

Ниже подробно описаны различные параметры конфигурации. Параметры конфигурации относятся к одному из трех типов: логическое значение, строка или целое число. Логические параметры конфигурации могут принимать значение "y" или "n". Для некоторых записей конфигурации типа "строка", описанных ниже, может использоваться специальное ключевое слово "None".

**Role.StateConsumer:**

тип: строка; по умолчанию: нет.

Если указан путь к исполняемой программе, он вызывается при подготовке образа waagent и при подготовке подтверждения состояния "Готов" для структуры. В программе будет указан аргумент "Готов". Агент не будет ожидать возврата для продолжения программы.

**Role.ConfigurationConsumer:**

тип: строка; по умолчанию: нет.

Если указан путь к исполняемой программе, программа вызывается в том случае, когда структура указывает, что доступен файл конфигурации для виртуальной машины. Путь к XML-файлу конфигурации предоставляется в качестве аргумента в исполняемый файл. Он может вызываться несколько раз при каждом изменении файла конфигурации. Образец файла приведен в приложении. Текущий путь к этому файлу — /var/lib/waagent/HostingEnvironmentConfig.xml.

**Role.TopologyConsumer:**

тип: строка; по умолчанию: нет.

Если указан путь к исполняемой программе, программа вызывается в том случае, когда структура указывает, что доступен новый макет топологии сети для виртуальной машины. Путь к XML-файлу конфигурации предоставляется в качестве аргумента в исполняемый файл. Он может вызываться несколько раз при каждом изменении топологии сети (например, из-за восстановления службы). Образец файла приведен в приложении. Текущее размещение этого файла — /var/lib/waagent/SharedConfig.xml.

**Provisioning.Enabled:**

тип: логическое значение; по умолчанию: y.

Он позволяет пользователю включить или отключить функцию подготовки в агенте. Допустимые значения: "y" или "n". Если подготовка отключена, узел SSH и пользовательские ключи в образе сохраняются, а любые настройки, указанные в API для подготовки Azure, игнорируются.

	Note that this parameter defaults to "n" on Ubuntu Cloud Images that use cloud-init for provisioning.

**Provisioning.DeleteRootPassword:**

тип: логическое значение; по умолчанию: n.

Удаляет корневой пароль в файле /etc/shadow в процессе подготовки.

**Provisioning.RegenerateSshHostKeyPair:**

тип: логическое значение; по умолчанию: y.

Удаляет все пары ключей узла SSH (ecdsa, dsa и rsa) из /etc/ssh/ в процессе подготовки. При этом генерируется одна новая пара ключей.

Тип шифрования для новой пары ключей настраивается с помощью операции Provisioning.SshHostKeyPairType. Обратите внимание, что некоторые дистрибутивы повторно создают пары ключей SSH для любых недостающих типов шифрования при перезапуске управляющей программы SSH (например, после перезагрузки).

**Provisioning.SshHostKeyPairType:**

тип: строка; по умолчанию: rsa.

Задается тип алгоритма шифрования, поддерживаемый управляющей программой SSH на виртуальной машине. Обычно поддерживаются значения "rsa", "dsa" и "ecdsa". Обратите внимание, что "putty.exe" в Windows не поддерживает "ecdsa". Таким образом, если вы планируете использовать putty.exe в Windows для подключения к развертыванию Linux, используйте "rsa" или "dsa".

**Provisioning.MonitorHostName:**

тип: логическое значение; по умолчанию: y.

Если задано, waagent будет отслеживать виртуальную машину Linux на предмет изменений имени узла (как значение, возвращаемое командой "hostname") и автоматически обновлять сетевую конфигурацию образа в соответствии с изменениями. Для передачи изменения имени на DNS-серверы сеть на виртуальной машине будет перезапущена. Это приведет к кратковременной потере подключения к Интернету.

**ResourceDisk.Format:**

тип: логическое значение; по умолчанию: y.

Если задано, диск ресурсов, предоставленный платформой, будет отформатирован и смонтирован с использованием waagent, если тип файловой системы, запрошенный пользователем в "ResourceDisk.Filesystem", отличается от "ntfs". На диске будет доступен один раздел типа Linux (83). Обратите внимание, что этот раздел не будет отформатирован, если он может быть успешно подключен.

**ResourceDisk.Filesystem:**

тип: строка; по умолчанию: ext4.

Указывает тип файловой системы для диска ресурса. Допустимые значения зависят от дистрибутива Linux. Если используется строка X, в образе Linux должна присутствовать строка mkfs.X. Для образов SLES 11 обычно используется значение "ext3". Для образов FreeBSD здесь следует использовать "ufs2".

**ResourceDisk.MountPoint:**

тип: строка; по умолчанию: /mnt/resource.

Указывает путь, по которому подключен диск ресурсов. Следует отметить, что диск ресурсов является *временным* диском и должен быть очищен при отмене подготовки ВМ.

**ResourceDisk.EnableSwap:**

тип: логическое значение; по умолчанию: n.

Если задано, на диске ресурсов создается файл подкачки (/swapfile), который добавляется к пространству подкачки в системе.

**ResourceDisk.SwapSizeMB:**

тип: целое число; по умолчанию: 0.

Размер файла подкачки в мегабайтах.

**LBProbeResponder:**

тип: логическое значение; по умолчанию: y.

Если задано, waagent отвечает на запросы зондов средства балансировки нагрузки, имеющихся на платформе (при наличии).

**Logs.Verbose:**

тип: логическое значение; по умолчанию: n.

Если задано, то файл журнала расширяется. Waagent записывает данные в /var/log/waagent.log, а также использует системную функцию logrotate для ротации журналов.

**OS.RootDeviceScsiTimeout:**

тип: целое число; по умолчанию: 300.

Настраивает время ожидания SCSI в секундах на дисках операционной системы и на дисках с данными. Если не установлено, будут использоваться системные значения по умолчанию.

**OS.OpensslPath:**

тип: строка; по умолчанию: нет.

Можно указать альтернативный путь для двоичного файла openssl, используемого при выполнении шифрования.



##Образы облаков Ubuntu

Обратите внимание, что в образах облаков Ubuntu пакет [cloud-init](https://launchpad.net/ubuntu/+source/cloud-init) используется для выполнения ряда задач настройки, которыми в противном случае управлял бы агент Linux для Azure. Обратите внимание на следующие отличия.


- Для параметра **Provisioning.Enabled** по умолчанию устанавливается значение "n" в образах облаков Ubuntu, использующих пакет cloud-init для выполнения задач по подготовке.

- Следующие параметры конфигурации не влияют на образы облаков Ubuntu, использующие пакеты cloud-init для управления диском ресурсов и пространством подкачки:

 - **ResourceDisk.Format**;
 - **ResourceDisk.Filesystem**;
 - **ResourceDisk.MountPoint**;
 - **ResourceDisk.EnableSwap**;
 - **ResourceDisk.SwapSizeMB**.

- См. следующие ресурсы, если вам нужно настроить точку подключения диска ресурсов и пространство подкачки в образах облаков Ubuntu во время подготовки.

 - [Вики-сайт по Ubuntu: настройка разделов подкачки](http://go.microsoft.com/fwlink/?LinkID=532955&clcid=0x409)
 - [Включение пользовательских данных в виртуальную машину Azure](virtual-machines-how-to-inject-custom-data.md)

 

<!---HONumber=58_postMigration-->