<properties
	pageTitle="Устранение неполадок с подключением к удаленному рабочему столу виртуальной машины Windows в службе Azure"
	description="Если не удается подключиться к виртуальной машине Azure под управлением Windows, используйте эти методы диагностики и предлагаемые действия для выявления источника проблемы."
	services="virtual-machines"
	documentationCenter=""
	authors="dsk-2015"
	manager="timlt"
	editor=""
	tags="azure-service-management,azure-resource-manager"/>

<tags
	ms.service="virtual-machines"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/07/2015"
	ms.author="dkshir"/>

# Устранение неполадок с подключением к удаленному рабочему столу виртуальной машины Windows в службе Azure

В этой статье описана методика определения причин и устранения неполадок с подключением к удаленному рабочему столу, из-за которых не удается выполнить подключение к виртуальной машине Azure под управлением Windows.

## Действие 1. Запуск диагностического пакета Azure IaaS

Для устранения различных распространенных проблем, связанных с подключением к удаленным рабочим столам, корпорация Майкрософт разработала [пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864).

1.	Чтобы создать сеанс диагностики, щелкните ссылку **Пакет диагностики Microsoft Azure IaaS (Windows)** на этой странице.
2.	На странице **Какие из указанных проблем возникают в вашей виртуальной машине Azure?** выберите пункт **Подключение к порту удаленного рабочего стола в виртуальной машине Azure (требуется перезагрузка)**.

Дополнительные сведения см. в статье базы знаний [Пакет диагностики Microsoft Azure IaaS (Windows)](http://support.microsoft.com/kb/2976864).

Если с помощью пакета диагностики Azure IaaS вам не удалось решить проблему либо вы не смогли запустить его, вам придется воспользоваться пошаговыми инструкциями по устранению неполадок, приведенными ниже.

> [AZURE.NOTE]Пакет диагностики Azure IaaS (Windows) необходимо запускать на компьютере с операционной системой Windows 8, Windows 8.1, Windows Server 2012 или Windows Server 2012 R2.

## Действие 2. Определение сообщения об ошибке, полученного от клиента удаленного рабочего стола

Используйте эти разделы в зависимости от сообщения об ошибке, которое отображается при попытке подключения.

### Сообщение в окне подключения к удаленному рабочему столу: удаленный сеанс отключен, поскольку отсутствуют доступные серверы лицензирования удаленных рабочих столов, которые могли бы провести лицензирование.

Причина: истек 120-дневный льготный период лицензирования для роли сервера удаленных рабочих столов, и вам необходимо установить лицензии.

В качестве временного решения вы можете сохранить локальную копию RDP-файла с портала Azure, а затем установить подключение, выполнив следующую команду в командной строке Windows PowerShell:

	mstsc <File name>.RDP /admin

В результате лицензирование будет отключено для данного подключения.

Если вы не планируете устанавливать более двух одновременных подключений к удаленному рабочему столу виртуальной машины, вы можете удалить роль сервера удаленных рабочих столов с помощью диспетчера серверов.

Также ознакомьтесь с записью в блоге [Сбой виртуальной машины Azure с сообщением об отсутствии доступных серверов лицензирования удаленных рабочих столов](http://blogs.msdn.com/b/wats/archive/2014/01/21/rdp-to-azure-vm-fails-with-quot-no-remote-desktop-license-servers-available-quot.aspx).

### Сообщение в окне подключения к удаленному рабочему столу: клиенту удаленного рабочего стола не удается найти компьютер «имя компьютера».

Причина: клиенту удаленного рабочего стола не удается разрешить имя компьютера в параметрах RDP-файла.

Вот пример RDP-файла, созданного порталом Azure:

	full address:s:tailspin-azdatatier.cloudapp.net:55919
	prompt for credentials:i:1

В этом примере адресная часть состоит из полного доменного имени облачной службы, в которой находится виртуальная машина (в данном примере — tailspin-azdatatier.cloudapp.net), и внешнего TCP-порта конечной точки для обмена данными с удаленным рабочим столом (55919).

Варианты решения этой проблемы

- Если вы работаете в интрасети организации, убедитесь в том, что у вашего компьютера есть доступ к прокси-серверу и возможность передавать на него данные по протоколу HTTPS.
- Если вы работаете с локальным RDP-файлом, попробуйте воспользоваться файлом, созданным с помощью портала Azure: так вы гарантируете правильность DNS-имени виртуальной машины или облачной службы и номера порта конечной точки виртуальной машины.

### Окно сообщения подключения к удаленному рабочему столу: «Произошла ошибка проверки подлинности. Не удается связаться с локальным администратором безопасности».

Причина: виртуальной машине, к которой вы подключаетесь, не удается найти локального администратора безопасности, указанного в части имени пользователя ваших учетных данных.

Если имя пользователя имеет вид *SecurityAuthority*\*имя\_пользователя* (например, CORP\\User1), часть *SecurityAuthority* — это имя компьютера виртуальной машины (для локальной системы безопасности) или имя домена Active Directory.

Варианты решения этой проблемы

- Если учетная запись является локальной для виртуальной машины, проверьте правильность имени виртуальной машины.
- Если учетная запись является учетной записью домена Active Directory, проверьте правильность имени домена.
- Если учетная запись пользователя является учетной записью домена Active Directory и имя домена указано правильно, убедитесь, что контроллер домена для домена Active Directory доступен. Это может быть распространенной проблемой в виртуальной сети Azure с контроллерами домена, в которой не запущен компьютер контроллера домена. Временным решением проблемы является использование учетной записи локального администратора, а не учетной записи домена.

### Сообщение в окне системы безопасности Windows: недопустимые учетные данные.

Причина: виртуальная машина, к которой вы подключаетесь, не распознает указанные вами имя учетной записи и пароль.

Компьютер Windows принимает данные локальных учетных записей и учетных записей домена.

- В случае локальных учетных записей используйте синтаксис *имя\_компьютера*\*имя\_пользователя* (например, SQL1\\Admin4798).
- В случае учетных записей домена используйте синтаксис *имя\_домена*\*имя\_пользователя* (например, CONTOSO\\johndoe).

Для компьютеров, уровень которых повышен до контроллера домена в новом лесу Active Directory, локальная учетная запись администратора, с которой вы находились в системе в момент повышения, преобразуется в эквивалентную учетную запись с тем же паролем в новом лесу и домене. Существовавшая до этого локальная учетная запись администратора при этом удаляется. Например, если вы вошли с локальной учетной записью администратора DC1\\DCAdmin и повысили уровень виртуальной машины до контроллера домена corp.contoso.com в новом лесу, локальная учетная запись DC1\\DCAdmin удаляется, а вместо нее создается новая учетная запись домена CORP\\DCAdmin с тем же паролем.

Уточните имя учетной записи: убедитесь в том, что виртуальная машина принимает ее как действительную. Уточните пароль (убедитесь в том, что он правильный).

Указания по смене пароля учетной записи локального администратора см. в статье [Сброс пароля или службы удаленных рабочих столов для виртуальных машин Windows](virtual-machines-windows-reset-password.md).

### Сообщение в окне подключения к удаленному рабочему столу: не удалось подключить компьютер к удаленному компьютеру.

Причина: у учетной записи, которую вы используете для подключения, нет прав для входа на удаленный рабочий стол.

На каждом компьютере Windows есть локальная группа пользователей удаленного рабочего стола. В ней определены учетные записи и группы, у которых есть право на вход с помощью подключения к удаленному рабочему столу. Аналогичные права доступа есть и у участников локальной группы администраторов, хотя соответствующие учетные записи и не входят в локальную группу пользователей удаленного рабочего стола. На компьютерах, подключенных к домену, локальная группа администраторов также содержит учетные записи администраторов этого домена.

Убедитесь в том, что у учетной записи, с помощью которой вы создаете подключение, есть права для входа на удаленный рабочий стол. В качестве временного решения вы можете воспользоваться учетной записью администратора домена или локального администратора, чтобы создать подключение к удаленному рабочему столу и добавить требуемую учетную запись в локальную группу пользователей удаленного рабочего стола в оснастке «Управление компьютером» (**Служебные программы > Локальные пользователи и группы > Группы > Пользователи удаленного рабочего стола**).

### Сообщение в окне подключения к удаленному рабочему столу: удаленному рабочему столу не удалось подключиться к данному удаленному компьютеру по одной из следующих причин…

Причина: службы удаленных рабочих столов на виртуальной машине недоступны для клиента удаленного рабочего стола. Эта проблема может быть вызвана целым рядом причин.

Вот схема компонентов, которые участвуют в этом процессе.

![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_0.png)

Прежде чем начинать пошаговое устранение неполадок, имеет смысл подумать о том, что изменилось с момента последнего успешного подключения к удаленному рабочему столу, и взять это за основу для поиска проблемы. Например:

- Если вам удавалось успешно создавать подключения к удаленному рабочему столу и вы сменили общедоступный IP-адрес виртуальной машины или облачной службы, в которой находится ваша виртуальная машина, (он также называется виртуальным IP-адресом, или VIP-адресом), возможно, в кэше вашего DNS-клиента осталась запись с DNS-именем и *старым IP-адресом*. Очистите кэш DNS-клиента и повторите попытку. Вы также можете попытаться подключиться с использованием нового виртуального IP-адреса.
- Если для управления своими подключениями к удаленным рабочим столам вы ранее использовали портал Azure или портал предварительной версии Azure, а теперь перешли на приложение, убедитесь в том, что в его конфигурации задан случайным образом определяемый TCP-порт для трафика удаленного рабочего стола.

В следующих разделах приведены пошаговые инструкции по локализации проблемы и определению ее причин, а также варианты временных и постоянных решений.

## Действие 3. Предварительные меры перед началом подробной диагностики

Выполните перечисленные ниже действия.

- Проверьте состояние виртуальной машины на портале Azure или портале предварительной версии Azure.
- [Перезапустите виртуальную машину.](https://msdn.microsoft.com/library/azure/dn763934.aspx)
- [Измените размер виртуальной машины.](https://msdn.microsoft.com/library/dn168976.aspx)

Выполнив эти действия, попытайтесь создать подключение к удаленному рабочему столу еще раз.

## Действие 4. Подробная диагностика

Неспособность клиента удаленного рабочего стола подключиться к службам удаленных рабочих столов на виртуальной машине Azure может быть связана с проблемами и ошибками в настройках перечисленных ниже компонентов:

- Компьютер с клиентом удаленного рабочего стола
- Пограничное устройство интрасети организации
- Конечная точка облачной службы и список управления доступом (ACL)
- Группы безопасности сети
- Виртуальная машина Windows в службе Azure

### Источник 1: компьютер с клиентом удаленного рабочего стола

Чтобы устранить компьютер из числа возможных источников проблем и ошибок в настройках, убедитесь в том, что с его помощью можно установить подключение к удаленному рабочему столу на другом локальном компьютере с Windows.

![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_1.png)

Если сделать это не удается, проверьте, нет ли на компьютере:

- локального брандмауэра, в параметрах которого блокируется обмен данными с удаленным рабочим столом;
- локального программного обеспечения с функциями прокси-сервера, которое не позволяет установить подключение к удаленному рабочему столу;
- локального программного обеспечения для мониторинга сети, которое не позволяет установить подключение к удаленному рабочему столу;
- других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов, тем самым блокируя подключение к удаленному рабочему столу.

В любом из перечисленных выше случаев попытайтесь временно отключить соответствующее программное обеспечение и подключиться к удаленному рабочему столу на локальном компьютере, чтобы определить основную причину проблемы. Затем при помощи администратора сети измените параметры программного обеспечения таким образом, чтобы оно не блокировало подключения к удаленным рабочим столам.

### Источник 2: пограничное устройство интрасети организации

Чтобы устранить пограничное устройство интрасети организации из числа возможных источников проблем и ошибок в настройках, убедитесь в том, что установить соединение с удаленным рабочим столом на виртуальной машине Azure можно с помощью компьютера, непосредственно подключенного к Интернету.

![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_2.png)

Если у вас нет такого компьютера, вы можете легко создать вместо него новую виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе. Дополнительные сведения см. в статье [Создание виртуальной машины Windows в среде Azure](virtual-machines-windows-tutorial.md). Завершив проверку, удалите группу ресурсов или виртуальную машину и облачную службу.

Если вам удается установить соединение с удаленным рабочим столом с компьютера, непосредственно подключенного к Интернету, проверьте, нет ли на пограничном устройстве интрасети вашей организации:

- интернет-брандмауэра, который блокирует подключения к Интернету по протоколу HTTPS;
- прокси-сервера, который не позволяет установить подключение к удаленному рабочему столу;
- программного обеспечения для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует подключения к удаленным рабочим столам.

При помощи администратора сети измените параметры пограничного устройства интрасети вашей организации таким образом, чтобы оно не блокировало HTTPS-подключения к удаленным рабочим столам через Интернет.

### Источник 3: конечная точка облачной службы и список управления доступом (ACL)

Чтобы устранить конечную точку облачной службы и ACL как источник проблем или неправильной конфигурации для виртуальных машин, созданных с помощью API управления службами, убедитесь, что другая виртуальная машина Azure, которая находится в той же облачной службе или виртуальной сети, может устанавливать подключения удаленного рабочего стола к вашей виртуальной машине Azure.

![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_3.png)

> [AZURE.NOTE]Для виртуальных машин, созданных в диспетчере ресурсов, см. раздел [Источник 4. Группы безопасности сети](#nsgs).

Если у вас нет еще одной виртуальной машины в той же облачной службе или виртуальной сети, вы можете легко ее создать. Дополнительные сведения см. в статье [Создание виртуальной машины Windows в среде Azure](virtual-machines-windows-tutorial.md). Завершив проверку, удалите дополнительную виртуальную машину.

Если вам удается подключиться к удаленному рабочему столу с виртуальной машины в той же облачной службе или виртуальной сети, проверьте перечисленные ниже потенциальные источники проблем.

- Конфигурацию конечной точки для обмена данными с удаленным рабочим столом на целевой виртуальной машине. Частный TCP-порт на конечной точке должен совпадать с TCP-портом, на котором ожидают передачи данных службы удаленных рабочих столов на виртуальной машине (по умолчанию это порт 3389).
- Список управления доступом на конечной точке для обмена данными с удаленным рабочим столом на целевой виртуальной машине. С помощью него можно разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если он неправильно настроен, входящие данные с удаленного рабочего стола на эту конечную точку могут блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительную информацию см. в статье [Что такое сетевой список управления доступом (ACL)?](https://msdn.microsoft.com/library/azure/dn376541.aspx).

Чтобы устранить конечную точку из числа потенциальных источников проблемы, удалите ее и создайте новую, выбрав в качестве номера внешнего порта любой порт в диапазоне от 49152 до 65535. Дополнительную информацию см. в статье [Настройка конечных точек виртуальной машины](virtual-machines-set-up-endpoints.md).

### <a id="nsgs"></a>Источник 4: группы безопасности сети

Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure. Проверьте свои правила групп безопасности сети и убедитесь в том, что обмен данными с удаленными рабочими столами в Интернете разрешен.

Дополнительную информацию см. в статье [Группа безопасности сети](../virtual-network/virtual-networks-nsg.md).

### Источник 5: виртуальная машина Windows в службе Azure

Последним потенциальным источником проблем является сама виртуальная машина Azure.

![](./media/virtual-machines-troubleshoot-remote-desktop-connections/tshootrdp_5.png)

Сначала, если вам не удалось запустить [пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) для проблемы **Подключение к порту удаленного рабочего стола в виртуальной машине Azure (требуется перезагрузка)**, выполните сброс служб удаленных рабочих столов на виртуальной машине с помощью указаний в статье [Сброс пароля или службы удаленных рабочих столов для виртуальных машин Windows](virtual-machines-windows-reset-password.md). В результате:

- будет включено правило по умолчанию «Удаленный рабочий стол» в брандмауэре Windows (TCP-порт 3389);
- будут разрешены подключения к удаленным рабочим столам в реестре (для параметра HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\\fDenyTSConnections будет установлено значение 0).

Попытайтесь снова установить подключение со своего компьютера. Если вам не удастся этого сделать, проверьте, не является ли причиной один из перечисленных ниже моментов.

- На целевой виртуальной машине не запущены службы удаленных рабочих столов.
- Службы удаленных рабочих столов не ожидают передачи данных на TCP-порт 3389.
- В брандмауэре Windows или другом локальном брандмауэре есть правило для исходящего трафика, блокирующее трафик удаленных рабочих столов.
- Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует подключения к удаленным рабочим столам.

Чтобы исправить возможные проблемы для виртуальных машин, созданных с помощью API управления службами, можно использовать удаленный сеанс Azure PowerShell для виртуальной машины Azure. Сначала необходимо установить сертификат для облачной службы, в которой размещена виртуальная машина. Откройте страницу [Настройка защищенного удаленного доступа к среде PowerShell на виртуальных машинах Azure](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) и загрузите файл сценария **InstallWinRMCertAzureVM.ps1** в папку на своем локальном компьютере.

Затем установите Azure PowerShell, если еще не сделали этого. См. статью [Установка и настройка Azure PowerShell](../install-configure-powershell.md).

Затем откройте командную строку Azure PowerShell и перейдите из текущей папки в папку с файлом сценария **InstallWinRMCertAzureVM.ps1**. Для запуска сценария Azure PowerShell необходимо задать правильную политику выполнения. Выполните команду **Get-ExecutionPolicy**, чтобы определить текущий уровень политики. Инструкции по выбору подходящего уровня см. в описании команды [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).

Затем введите имя своей подписки Azure, имя облачной службы и имя виртуальной машины (удаляйте из них знаки < and >), а затем выполните следующие команды.

	$subscr="<Name of your Azure subscription>"
	$serviceName="<Name of the cloud service that contains the target virtual machine>"
	$vmName="<Name of the target virtual machine>"
	.\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName

Уточнить имя подписки можно в свойстве SubscriptionName, которое возвращает команда **Get-AzureSubscription**. Уточнить имя облачной службы своей виртуальной машины можно в столбце ServiceName в данных, которые возвращает команда **Get-AzureVM**.

Чтобы убедиться, что новый сертификат установлен, откройте оснастку «Сертификаты» для текущего пользователя и зайдите в папку **Trusted Root Certification Authorities\\Certificates**. Там должен быть сертификат с DNS-именем вашей облачной службы в столбце получателя (пример: cloudservice4testing.cloudapp.net).

Затем инициируйте удаленный сеанс Azure PowerShell с помощью следующих команд.

	$uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName
	$creds = Get-Credential
	Enter-PSSession -ConnectionUri $uri -Credential $creds

Указав действительные учетные данные администратора, вы должны увидеть в командной строке Azure PowerShell примерно следующее:

	[cloudservice4testing.cloudapp.net]: PS C:\Users\User1\Documents>

Первая часть этой строки говорит о том, что вы отправляете команды Azure PowerShell в облачную службу, в которой находится целевая виртуальная машина. Имя вашей облачной службы будет отличаться от cloudservice4testing.cloudapp.net.

Теперь с помощью команд Azure PowerShell вы можете проанализировать наличие перечисленных выше проблем и исправить конфигурацию.

### Изменение вручную TCP-порта прослушивания служб удаленных рабочих столов

Если вам не удалось запустить [пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) для проблемы **Подключение к порту удаленного рабочего стола в виртуальной машине Azure (требуется перезагрузка)**, выполните следующую команду в командной строке удаленного сеанса Azure PowerShell:

	Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

Свойство PortNumber содержит текущий номер порта. При необходимости вы можете восстановить номер порта удаленного рабочего стола по умолчанию (3389) с помощью следующей команды:

	Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber" -Value 3389

Убедитесь в том, что номер порта изменен на 3389, с помощью следующей команды:

	Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

Закройте удаленный сеанс Azure PowerShell с помощью этой команды:

	Exit-PSSession

Также убедитесь в том, что на конечной точке удаленного рабочего стола для виртуальной машины Azure в качестве внутреннего порта задан TCP-порт 3398. Затем перезапустите виртуальную машину и попытайтесь снова подключиться к удаленному рабочему столу.

## Действие 5. Публикация вопроса на форумах поддержки Azure

Вы можете обратиться к специалистам по Azure со всего мира, рассказав о своей проблеме на форумах MSDN Azure и Stack Overflow. Дополнительную информацию см. на [форумах Microsoft Azure](http://azure.microsoft.com/support/forums/).

## Действие 6. Отправка запроса в службу поддержки Azure

Если вы запустили [пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) для проблемы **Подключение к порту удаленного рабочего стола в виртуальной машине Azure (требуется перезагрузка)** или выполнили шаги 2–5 из этой статьи и опубликовали свой вопрос на форумах поддержки Azure, но создать подключение к удаленному рабочему столу по-прежнему не удается, возможно, имеет смысл удалить и повторно создать виртуальную машину.

Если это невозможно, отправьте запрос в службу поддержки Azure.

Для этого зайдите на [сайт поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните **Поддержка**.

Дополнительные сведения об использовании службы поддержки Azure см. в разделе [Часто задаваемые вопросы о поддержке Azure](http://azure.microsoft.com/support/faq/).

## Дополнительные ресурсы

[Пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)

[Сброс пароля или службы удаленных рабочих столов для виртуальных машин Windows](virtual-machines-windows-reset-password.md)

[Установка и настройка Azure PowerShell](../install-configure-powershell.md)

[Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux](virtual-machines-troubleshoot-ssh-connections.md)

[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines-troubleshoot-access-application.md)

<!---HONumber=August15_HO8-->