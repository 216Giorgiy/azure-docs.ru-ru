<properties
	pageTitle="Клонирование классической виртуальной машины в Azure Resource Manager с помощью сценариев PowerShell"
	description="В этой статье показано, как клонировать классическую виртуальную машину в модель Azure Resource Manager с помощью сценариев PowerShell"
	services="virtual-machines-windows"
	documentationCenter=""
	authors="singhkays"
	manager="timlt"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machines-windows"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/03/2016"
	ms.author="singhkay"/>

# Клонирование классической виртуальной машины в Azure Resource Manager с помощью сценариев PowerShell

В этой статье показано, как использовать сценарии, расположенные в репозитории [Azure/classic-iaas-resourcemanager-migration](https://github.com/Azure/classic-iaas-resourcemanager-migration), чтобы клонировать **одну** классическую виртуальную машину в модель развертывания с помощью Azure Resource Manager.

>[AZURE.IMPORTANT]Клонирование с использованием этих сценариев вызовет простой классической виртуальной машины. Если вы хотите выполнить поддерживаемую платформой миграцию, см. сведения в статьях:
- [Поддерживаемый платформой перенос ресурсов IaaS из классической модели в модель Azure Resource Manager](./virtual-machines-windows-migration-classic-resource-manager.md)
- [Техническое руководство по поддерживаемому платформой переносу из классической модели в модель Azure Resource Manager](./virtual-machines-windows-migration-classic-resource-manager-deep-dive.md)
- [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью Azure PowerShell](./virtual-machines-windows-ps-migration-classic-resource-manager.md)

## Получение сценариев

>[AZURE.NOTE]Сценарии PowerShell официально не поддерживаются службой поддержки Майкрософт. Они представлены на Github с открытым исходным кодом, и мы охотно принимаем запросы на включение внесенных изменений, связанные с исправлениями или дополнительными сценариями.

Чтобы получить сценарии, можно скачать ZIP-файл из указанного выше репозитория или клонировать репозиторий, используя **любую** из команд ниже.

```
git clone https://github.com/Azure/classic-iaas-resourcemanager-migration.git
```

**OR**

```
git clone git@github.com:Azure/classic-iaas-resourcemanager-migration.git
```

## Импорт модуля переноса

Получив сценарии, необходимо импортировать модуль в сеанс PowerShell. Это можно сделать при помощи следующей команды.

```
Import-Module .\asm2arm.psd1
```

## Аутентификация для доступа к подпискам классической модели развертывания и модели Azure Resource Manager

Прежде чем клонировать классическую виртуальную машину, необходимо выполнить проверку подлинности для доступа к учетной записи классической модели развертывания и модели Azure Resource Manager из сеанса PowerShell. Это можно сделать с помощью следующих командлетов:

```
Add-AzureAccount
Login-AzureRmAccount
```

>[AZURE.IMPORTANT]Выберите подписки по умолчанию, используя командлет `Select-AzureSubscription` для классической модели развертывания и Set-AzureRmContext для модели Azure Resource Manager.

## Использование сценариев

### Командлеты

При импорте модуля в текущий сеанс будут добавлены два следующих командлета:

```
Add-AzureSMVmToRM
New-AzureSmToRMDeployment
```

Действие этих командлетов описано ниже.

#### Add-AzureSMVmToRM
- Создает набор шаблонов Azure Resource Manager и императивных сценариев PowerShell (для копирования больших двоичных объектов с диска и, при наличии, расширений агента ВМ) для виртуальной машины.

>[AZURE.IMPORTANT]Если переключатель `-Deploy` указан, вызывается командлет `New-AzureSmToRMDeployment`, чтобы развернуть ранее созданные шаблоны Azure Resource Manager и императивные сценарии PowerShell.

#### New-AzureSmToRMDeployment
- Выполняет развертывание шаблонов и императивных сценариев PowerShell, созданных командлетом `Add-AzureSMVmToRM`, для запуска переноса.

### Идентификация классической виртуальной машины для клонирования

Чтобы идентифицировать классическую виртуальную машину, можно сохранить состояние этой машины в переменной и передать его в командлет `Add-AzureSMVmToRM` или напрямую использовать параметры `ServiceName` и `Name` виртуальной машины. После идентификации классической виртуальной машины ее можно клонировать, используя командлет `Add-AzureSMVmToRM`.

```
$vm = Get-AzureVm -ServiceName acloudservice -Name atestvm
Add-AzureSMVmToRM -VM $vm -ResourceGroupName aresourcegroupname -DiskAction CopyDisks -OutputFileFolder D:\myarmtemplates -AppendTimeStampForFiles -Deploy
```

**OR**

```
Add-AzureSMVmToRM -ServiceName acloudservice -Name atestvm -ResourceGroupName aresourcegroupname -DiskAction CopyDisks -OutputFileFolder D:\myarmtemplates -AppendTimeStampForFiles -Deploy
```

>[AZURE.IMPORTANT]Так как мы используем переключатель `-Deploy`, в приведенных выше примерах не требуется использовать командлет `New-AzureSmToRMDeployment`.

## Как осуществляется перенос при использовании этих сценариев

Командлеты выполняют шаги по клонированию классической виртуальной машины и создают ресурсы в виде настраиваемых хэш-таблиц PowerShell для поставщиков ресурсов хранения, сети и вычислительных ресурсов. Эти хэш-таблицы добавляются в массив, который записывается в файл. При этом массив преобразовывается в шаблон путем сериализации в формат JSON.

Этот шаблон создает файлы в зависимости от наличия расширений агента классической виртуальной машины и значения параметра DiskAction. Файлы помещаются в каталог, заданный с помощью параметра OutputFileFolder. Ниже приведено описание этих файлов.

1. `<ServiceName>-<VMName>-setup<optional timestamp>.json` — этот файл содержит ресурсы, которые необходимо подготовить перед клонированием классической виртуальной машины. Эти ресурсы должны совпадать для последующих виртуальных машин (мы не сохраняем состояние между последующими запусками, но так как учетную запись хранения необходимо подготовить до принудительной операции копирования больших двоичных объектов, логично объединить схожие ресурсы в одном файле).

2.  `<ServiceName>-<VMName>-deploy<optional timestamp>.json` — этот файл содержит шаблон виртуальной машины Resource Manager.
3.  `<ServiceName>-<VMName>-parameters<optional timestamp>.json` — этот файл содержит фактические параметры, передаваемые в шаблоны.
4.  `<ServiceName>-<VMName>-setextensions<optional timestamp>.json` — этот файл представляет набор командлетов PowerShell для настройки расширений агента виртуальной машины.
4.  `<ServiceName>-<VMName>-copydisks<optional timestamp>.json` — этот файл представляет набор командлетов PowerShell, выполняемых для копирования больших двоичных объектов с диска, если указан параметр CopyDisks.

Если флаг -Deploy установлен, после создания файлов командлет развертывает шаблон <имя\_службы>-<имя\_ВМ>-setup.jso, копирует большие двоичные объекты с диска исходной виртуальной машины, если для параметра DiskAction задано значение CopyDisks, а затем развертывает шаблон <имя\_службы>-<имя\_ВМ>-deploy.json, используя файл параметров <имя\_службы>-<имя\_ВМ>-parameters.json. После развертывания виртуальной машины выполняется императивный сценарий (для расширений агента виртуальной машины) или сценарий для копирования дисков (если они имеются).

### Сведения о сети
Командлет не предназначен для клонирования сетевых параметров классической виртуальной машины в модель Resource Manager. Он использует сетевые компоненты таким образом, чтобы обеспечить наиболее удобное клонирование самой виртуальной машины. Вот что происходит при различных условиях:

1.  Отсутствие виртуальной сети в целевой группе ресурсов.
    - Исходная виртуальная машина не находится в подсети: создается подсеть с адресным пространством 10.0.0.0/22 и виртуальная сеть по умолчанию с адресным пространством 10.0.0.0/16.
    - Исходная виртуальная машина находится в подсети: после обнаружения виртуальной сети, в которой находится виртуальная машина, копируются спецификации виртуальной сети и подсети.
2.  Целевая группа ресурсов содержит виртуальную сеть с именем `<VM virtual network>arm` (строка arm добавляется).
    - Если в виртуальной сети есть подсеть с теми же именем и адресным пространством, ее следует использовать.
    - Если подходящей подсети нет, необходимо найти блок адреса на основе существующих подсетей с битовой маской 22 и использовать его.

## Сравнение клонирования и поддерживаемого платформой переноса

Существует ряд различий между текущим методом клонирования и поддерживаемым платформой переносом.

### Клонирование


| Преимущества | Недостатки |
|--------------------------------------------------------|:----------------------------------------------------------------:|
| Клонирование виртуальной машины в облачной службе | Возникает простой виртуальных машин, так как их работу необходимо завершить |
| Клонирование виртуальной машины в или вне виртуальной сети | Длительные задержки при выполнении сценария, требующего копирования больших двоичных объектов с диска |
| | Изменение параметров сети для виртуальной машины (внутренние и виртуальные IP-адреса) |


### Поддерживаемый платформой перенос


| Преимущества | Недостатки |
|----------------------------------|:-------------------------------------------:|
| Большинство конфигураций виртуальной машины в виртуальной сети не повлекут простой | Все виртуальные машины в облачной службе или виртуальную сеть со всеми развернутыми в ней ресурсами необходимо переносить вместе |
 
 
## Неподдерживаемые сценарии

**Ниже приведены неподдерживаемые возможности в рамках сценариев клонирования.**

 1. Остановка работающей виртуальной машины.
 2. Изменение данных и дисков.
 3. Клонирование работающих виртуальных машин.
 4. Автоматическое клонирование нескольких виртуальных машин в сложном сценарии.
 5. Клонирование всей конфигурации сети ASM.
 6. Создание виртуальных машин с балансировкой нагрузки. Такую конфигурацию должен явно обрабатывать эксперт по Azure.
 
 
## Протестированные конфигурации

Командлет _Add-AzureSMVmToRM_ проверен для следующих тестовых сценариев.

| # | Description (Описание) |
|:---|:---|
| 1 | Виртуальная машина Windows с существующим диском ОС |
| 2 | Виртуальная машина Linux с существующим диском ОС |
| 3 | Виртуальная машина Windows с существующими диском ОС и диском данных |
| 4\. | Виртуальная машина Linux с существующими диском ОС и диском данных |
| 5 | Виртуальная машина Windows с новым диском ОС, сопоставленным из коллекции образов |
| 6 | Виртуальная машина Linux с новым диском ОС, сопоставленным из коллекции образов |
| 7 | Виртуальная машина Windows с новым диском ОС и пустыми дисками данных |
| 8 | Виртуальная машина Linux с новым диском ОС и пустыми дисками данных |
| 9 | Виртуальная машина Windows с общедоступными конечными точками |
| 10 | Виртуальная машина Linux с общедоступными конечными точками |
| 11 | Виртуальная машина Windows с сертификатом WinRM |
| 12 | Виртуальная машина Windows в виртуальной сети и подсети |
| 13\. | Виртуальная машина Linux в виртуальной сети и подсети |
| 14 | Виртуальная машина Windows с настраиваемыми расширениями |
| 15 | Виртуальная машина Windows в группе доступности |
| 16 | Виртуальная машина Windows в группе доступности, с несколькими дисками данных, общедоступными конечными точками, настраиваемыми расширениями, в виртуальной сети и подсети |
| 17 | Виртуальная машина Linux в группе доступности, с несколькими дисками данных, общедоступными конечными точками, настраиваемыми расширениями, в виртуальной сети и подсети |

## Примечания
1. При последовательном клонировании нескольких виртуальных машин с коротким промежутком времени может возникнуть конфликт DNS-имен для общедоступных IP-адресов из-за времени обновления кэша DNS.

<!---HONumber=AcomDC_0824_2016-->