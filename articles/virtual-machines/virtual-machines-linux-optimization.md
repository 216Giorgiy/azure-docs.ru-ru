<properties
	pageTitle="Оптимизация виртуальной машины Linux в Azure | Microsoft Azure"
	description="В этой статье приводятся советы по оптимизации, которые помогут вам настроить виртуальную машину Linux так, чтобы обеспечить ее оптимальную производительность в Azure."
	keywords="виртуальная машина linux,linux виртуальная машина,виртуальная машина ubuntu" 
	services="virtual-machines-linux"
	documentationCenter=""
	authors="rickstercdn"
	manager="timlt"
	editor="tysonn"
	tags="azure-resource-manager" />

<tags
	ms.service="virtual-machines-linux"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-linux"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/06/2016"
	ms.author="rclaus"/>

# Оптимизация виртуальной машины Linux в Azure

Вы можете легко создать виртуальную машину (VM) Linux с помощью портала или командной строки. В этом руководстве показано, как при помощи настроек оптимизировать производительность VM на платформе Microsoft Azure. В этой статье описывается виртуальная машина Ubuntu Server, но вы можете также создавать виртуальные машины Linux, используя [собственные образы в качестве шаблонов](virtual-machines-linux-create-upload-generic.md).

## Предварительные требования

В этой статье предполагается, что у вас уже есть действующая подписка Azure ([бесплатная пробная подписка](https://azure.microsoft.com/pricing/free-trial/)), [установлен интерфейс командной строки Azure (Azure CLI)](../xplat-cli-install.md) и подготовлена виртуальная машина в рамках подписки Azure. Прежде чем выполнять какие-либо действия в Azure, необходимо пройти аутентификацию в подписке. Чтобы сделать это с помощью Azure CLI, введите `azure login` для запуска интерактивного процесса.

## Диск ОС в Azure

После создания виртуальной машины Linux в Azure на ней будет два диска: /dev/sda — диск ОС, /dev/sdb — временный диск. Не используйте основной диск ОС (/dev/sda) для чего-либо, кроме операционной системы, так как он оптимизирован для быстрой загрузки виртуальной машины и не обеспечивает высокую производительность при рабочих нагрузках. К виртуальной машине можно подключить один или несколько дисков, чтобы создать постоянное оптимизированное хранилище данных.

## Добавление дисков для увеличения размера и производительности 

В зависимости от размера виртуальной машины можно подключить до 16 дополнительных дисков к машинам серии A, до 32 дисков — серии D и до 64 дисков — серии G (размер каждого диска — до 1 ТБ). Дополнительные диски добавляются по мере необходимости в зависимости от требований к пространству и количеству операций ввода-вывода. Каждый диск имеет следующие целевые показатели производительности: 500 операций ввода-вывода на диск для хранилища класса "Стандартный" и до 5000 операций ввода-вывода на диск для хранилища класса Premium. Дополнительные сведения о дисках хранилища уровня "Премиум" см. в статье [Хранилище Premium: высокопроизводительное хранилище для рабочих нагрузок виртуальных машин Azure](../storage/storage-premium-storage.md).

Чтобы достичь максимального количества операций ввода-вывода на дисках хранилища уровня "Премиум", когда для параметров кэширования задано значение "Только чтение" или "Нет", при подключении файловой системы в Linux необходимо отключить т. н. барьеры. Барьеры не нужны, так как записи на диски в хранилище класса Premium для этих параметров кэширования являются долговременными.

- Если вы используете систему **reiserFS**, отключите барьеры с помощью параметра подключения “barrier=none” (для включения барьеров используйте параметр “barrier=flush”).
- Если вы используете систему **ext3/ext4**, отключите барьеры с помощью параметра подключения “barrier=0” (для их включения используйте параметр “barrier=1”).
- Если вы используете систему **XFS**, отключите барьеры с помощью параметра подключения “nobarrier” (для их включения используйте параметр “barrier”).

## Рекомендации по учетной записи хранения

При создании виртуальной машины Linux в Azure необходимо подключить диски из учетных записей хранения, находящихся в одном регионе с вашей виртуальной машиной, чтобы обеспечить максимальную близость расположения и свести к минимуму задержки в сети. Для каждой учетной записи хранилища класса "Стандартный" предусмотрено максимум 20 тысяч операций ввода-вывода и размер до 500 ТБ. Это соответствует примерно 40 интенсивно используемым дискам, включая диск операционной системы и все созданные диски данных. Для учетных записей хранилища класса Premium нет ограничения на количество операций ввода-вывода, но существует ограничение на размер — 32 ТБ.

Если вы работаете с большим количеством операций ввода-вывода и выбрали для дисков хранилище уровня "Стандартный", то вам, возможно, потребуется разбить диски на несколько учетных записей хранения, чтобы не достичь ограничения в 20 000 операций ввода-вывода для учетных записей хранения уровня "Стандартный". Виртуальная машина может содержать диски из разных учетных записей хранения различных типов, что позволяет достичь оптимальной конфигурации.

## Временный диск на виртуальной машине

По умолчанию при создании виртуальной машины в Azure предоставляется диск операционной системы (/dev/sda) и временный диск (/dev/sdb). При добавлении дополнительных дисков они отображаются как /dev/sdc, /dev/sdd, /dev/sde и т. д. Все данные на временном диске (/dev/sdb) недолговечны и могут быть утеряны, если виртуальная машина будет перезапущена вследствие определенных событий, таких как изменение размера, повторное развертывание или обслуживание виртуальной машины. Размер и тип временного диска зависят от размера виртуальной машины, выбранного во время развертывания. В случае с любой из виртуальных машин размера "Премиум" (серии DS, G и DS\_V2) для временного диска предусмотрен резервный локальный твердотельный накопитель, обеспечивающий дополнительную производительность — до 48 тысяч операций ввода-вывода в секунду.

## Файл подкачки Linux

Образы виртуальных машин, развернутые из Azure Marketplace, содержат агент виртуальных машин Linux, интегрированный с операционной системой, который обеспечивает взаимодействие виртуальной машины с различными службами Azure. Предположим, что вы развернули стандартный образ из Azure Marketplace. Теперь вам необходимо выполнить указанные ниже действия, чтобы правильно настроить параметры файла подкачки Linux.

Найдите и измените две записи в файле **/etc/waagent.conf**. От них зависит наличие и размер специального файла подкачки. Следует изменить параметры `ResourceDisk.EnableSwap=N` и `ResourceDisk.SwapSizeMB=0`.

Необходимо изменить их следующим образом.

* ResourceDisk.EnableSwap=Y
* ResourceDisk.SwapSizeMB={требуемый размер в МБ}

После внесения изменений необходимо будет перезапустить waagent или виртуальную машину Linux, чтобы изменения вступили в действие. Вы можете убедиться в том, что изменения внесены, а файл подкачки создан, при помощи команды `free` для просмотра свободного пространства. В приведенном ниже примере файл подкачки размером 512 МБ создан в результате изменения файла waagent.conf.

    admin@mylinuxvm:~$ free
                total       used       free     shared    buffers     cached
    Mem:       3525156     804168    2720988        408       8428     633192
    -/+ buffers/cache:     162548    3362608
    Swap:       524284          0     524284
    admin@mylinuxvm:~$
 
## Алгоритм планирования операций ввода-вывода для хранилища класса Premium

С появлением ядра Linux 2.6.18 стандартный алгоритм планирования операций ввода-вывода был изменен с Deadline на CFQ (алгоритм организации полностью равноправных очередей). Если речь идет о моделях операций ввода-вывода с произвольным доступом, между алгоритмами CFQ и Deadline существуют минимальные различия в производительности. В случае с дисками на основе SSD, в которых модель операций ввода-вывода является преимущественно последовательной, переход обратно на алгоритм NOOP или Deadline позволяет добиться повышения производительности операций ввода-вывода.

### Просмотр текущего планировщика операций ввода-вывода

Используйте следующую команду:

	admin@mylinuxvm:~# cat /sys/block/sda/queue/scheduler

Вы увидите следующий результат, который указывает тип текущего планировщика.

	noop [deadline] cfq

###Изменение текущего устройства (/dev/sda) алгоритма планирования операций ввода-вывода

Используйте следующие команды:

	azureuser@mylinuxvm:~$ sudo su -
	root@mylinuxvm:~# echo "noop" >/sys/block/sda/queue/scheduler
	root@mylinuxvm:~# sed -i 's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash elevator=noop"/g' /etc/default/grub
	root@mylinuxvm:~# update-grub

>[AZURE.NOTE] Настраивать алгоритм только для устройства /dev/sda бесполезно. Его необходимо задать для всех дисков данных, где в модели операций ввода-вывода преобладают последовательные операции.

Вы увидите следующий результат, означающий, что файл grub.cfg успешно перестроен и планировщик по умолчанию обновлен до алгоритма NOOP.

	Generating grub configuration file ...
	Found linux image: /boot/vmlinuz-3.13.0-34-generic
	Found initrd image: /boot/initrd.img-3.13.0-34-generic
	Found linux image: /boot/vmlinuz-3.13.0-32-generic
	Found initrd image: /boot/initrd.img-3.13.0-32-generic
	Found memtest86+ image: /memtest86+.elf
	Found memtest86+ image: /memtest86+.bin
	done

Для семейства дистрибутивов Redhat вам необходимо выполнить только следующую команду:

	echo 'echo noop >/sys/block/sda/queue/scheduler' >> /etc/rc.local

## Использование программной конфигурации RAID для увеличения количества операций ввода-вывода

Если для рабочих нагрузок требуется больше операций ввода-вывода, чем может обеспечить один диск, то необходимо использовать программную конфигурацию RAID для нескольких дисков. Поскольку Azure уже выполняет функцию устойчивости диска на уровне локальной структуры, вы можете достичь максимальной производительности, используя конфигурацию с чередованием дисков RAID-0. Необходимо подготовить и создать диски в среде Azure и присоединить их к виртуальной машине Linux до секционирования, форматирования и подключения дисков. Дополнительные сведения о настройке программной конфигурации RAID на виртуальной машине Linux в Azure см. в документе **[Настройка программного RAID-массива в Linux](virtual-machines-linux-configure-raid.md)**.


## Дальнейшие действия

Как и при любой оптимизации, до и после каждого изменения необходимо выполнить тесты, чтобы оценить влияние этого изменения. Оптимизация — это пошаговый процесс, и результаты его будут разными на различных компьютерах в одной и той же среде. То, что эффективно для одной конфигурации, может не работать в другой.

Полезные ссылки на дополнительные ресурсы:

- [Хранилище Premium: высокопроизводительное хранилище для рабочих нагрузок виртуальной машины Azure](../storage/storage-premium-storage.md)
- [Руководство пользователя агента Linux для Azure](virtual-machines-linux-agent-user-guide.md)
- [Оптимизация производительности MySQL в виртуальных машинах Azure Linux](virtual-machines-linux-classic-optimize-mysql.md)
- [Настройка программного RAID-массива в Linux](virtual-machines-linux-configure-raid.md)

<!---HONumber=AcomDC_0914_2016-->