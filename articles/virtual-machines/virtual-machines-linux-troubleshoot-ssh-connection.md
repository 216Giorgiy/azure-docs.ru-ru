---
title: "Устранение неполадок SSH-подключения к виртуальной машине | Документация Майкрософт"
description: "Диагностика ошибок, например &quot;ошибка SSH-подключения&quot; или &quot;в SSH-подключении отказано&quot;, для виртуальной машины под управлением Linux."
keywords: "отклонение SSH-подключения, ошибка SSH, Azure SSH, ошибка SSH-подключения"
services: virtual-machines-linux
documentationcenter: 
author: iainfoulds
manager: timlt
editor: 
tags: top-support-issue,azure-service-management,azure-resource-manager
ms.assetid: dcb82e19-29b2-47bb-99f2-900d4cfb5bbb
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 09/27/2016
ms.author: iainfou
translationtype: Human Translation
ms.sourcegitcommit: ee34a7ebd48879448e126c1c9c46c751e477c406
ms.openlocfilehash: a585aaf2d40f077a81de299c0aef41844bde7cd1


---
# <a name="troubleshoot-ssh-connections-to-an-azure-linux-vm-that-fails-errors-out-or-is-refused"></a>Устранение неполадок с SSH-подключением к виртуальной машине Azure Linux: сбой, ошибка или отклонение
При попытке подключения к виртуальной машине Azure под управлением Linux ошибка, сбой или отклонение подключения Secure Shell (SSH) может возникнуть по нескольким причинам. В этой статье вы узнаете, как их выявить и устранить. Для устранения неполадок и решения проблем с подключением можно воспользоваться порталом Azure, Azure CLI или расширением для доступа к виртуальной машине для Linux.

[!INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-both-include.md)]

Если в любой момент при изучении этой статьи вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](http://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**. Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](http://azure.microsoft.com/support/faq/).

## <a name="quick-troubleshooting-steps"></a>Действия по устранению неполадок
После выполнения каждого шага устранения неполадок попробуйте подключиться к виртуальной машине еще раз.

1. сбросить конфигурацию SSH.
2. Сбросьте учетные данные пользователя.
3. Убедитесь, что правила [группы безопасности сети](../virtual-network/virtual-networks-nsg.md) разрешают трафик SSH.
   * Убедитесь, что правило для разрешения трафика SSH есть в группе безопасности сети (по умолчанию — TCP-порт 22).
   * Нельзя использовать перенаправление и сопоставление портов, не используя Azure Load Balancer.
4. Проверьте [работоспособность ресурсов виртуальной машины](../resource-health/resource-health-overview.md). 
   * Убедитесь, что виртуальная машина работоспособна.
   * Если включена диагностика загрузки, убедитесь, что виртуальная машина не сообщала об ошибках загрузки в журналах.
5. Перезапустите виртуальную машину.
6. Заново разверните виртуальную машину.

Читайте статью дальше, если вам нужны более подробные инструкции или пояснения об исправлении неполадок.

## <a name="available-methods-to-troubleshoot-ssh-connection-issues"></a>Доступные методы устранения неполадок подключения SSH
Вы можете сбросить учетные данные или конфигурацию SSH одним из следующих методов:

* [Портал Azure](#using-the-azure-portal) отлично подходит, когда нужно быстро сбросить конфигурацию или ключ SSH, а у вас не установлены инструменты Azure.
* [Команды Azure CLI.](#using-the-azure-cli) Если вы уже открыли командную строку, быстро сбросьте конфигурацию SSH или учетные данные.
* [Расширение Azure VMAccessForLinux.](#using-the-vmaccess-extension) Создайте и повторно используйте файлы определения JSON для сброса учетных данных пользователя или конфигурации SSH.

После выполнения каждого шага устранения неполадок попробуйте подключиться к виртуальной машине еще раз. Если все еще не удается подключиться, то попробуйте выполнить следующее действие.

## <a name="using-the-azure-portal"></a>Использование портала Azure
На портале Azure предусмотрена возможность быстрого сброса конфигурации SSH или учетных данных пользователей без установки каких-либо инструментов на локальном компьютере.

Выберите свою виртуальную машину на портале Azure. Прокрутите вниз до раздела **Поддержка и устранение неполадок** и выберите **Сбросить пароль**, как в следующем примере:

![Сброс конфигурации SSH или учетных данных на портале Azure](./media/virtual-machines-linux-troubleshoot-ssh-connection/reset-credentials-using-portal.png)

### <a name="reset-the-ssh-configuration"></a>Сброс конфигурации SSH
Сначала в раскрывающемся меню **Режим** выберите `Reset SSH configuration only`, как на предыдущем снимке экрана, и нажмите кнопку **Сброс**. Сделав это, попытайтесь снова войти в виртуальною машину.

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Чтобы сбросить учетные данные имеющегося пользователя, в раскрывающемся меню **Режим** выберите `Reset SSH public key` или `Reset password`, как на приведенном выше снимке экрана. Укажите имя пользователя и ключ SSH или новый пароль, а затем нажмите кнопку **Сброс**.

Кроме того, в этом меню можно создать пользователя с привилегиями sudo на виртуальной машине. Введите новое имя пользователя и соответствующий пароль или ключ SSH, а затем нажмите кнопку **Сброс**.

## <a name="using-the-azure-cli"></a>Использование Azure CLI
[Установите интерфейс командной строки (CLI) Azure и подключитесь к подписке Azure](../xplat-cli-install.md)(если вы еще этого не сделали). Убедитесь, что используется режим Resource Manager следующим образом:

```azurecli
azure config mode arm
```

Если вы создали и отправили пользовательский образ диска Linux, убедитесь, что установлен [агент Linux для Microsoft Azure](virtual-machines-linux-agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) версии 2.0.5 или более поздней. В виртуальных машинах, созданных с помощью образов из коллекции, это расширение для доступа уже установлено и настроено.

### <a name="reset-ssh-configuration"></a>Сбросьте конфигурацию SSH.
Может быть неправильно настроена сама конфигурация SSHD, или в службе произошла ошибка. Чтобы убедиться, что конфигурация SSH действительна, можно выполнить сброс SSHD. При устранении неполадок сначала нужно сбросить SSHD.

В следующем примере перезапускается SSHD на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте собственные имена для виртуальной машины и группы ресурсов следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
    --reset-ssh
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Если SSHD работает корректно, можно сбросить пароль для отдельного пользователя. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
     --username myUsername --password myPassword
```

При использовании аутентификации с помощью ключа SSH можно сбросить ключ SSH для отдельного пользователя. В следующем примере обновляется ключ SSH, хранящийся в файле `~/.ssh/azure_id_rsa.pub`, для пользователя с именем `myUsername` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
    --username myUsername --ssh-key-file ~/.ssh/azure_id_rsa.pub
```


## <a name="using-the-vmaccess-extension"></a>Использование расширения VMAccess
Расширение для доступа к виртуальной машине для Linux выполняет чтение в JSON-файле. При этом сбрасывается SSHD и ключ SSH или добавляется пользователь. Azure CLI по-прежнему используется для вызова расширения VMAccess, но при необходимости JSON-файлы можно использовать повторно в нескольких виртуальных машинах. Такой подход позволяет создать репозиторий JSON-файлов, которые можно впоследствии вызывать для заданных сценариев.

### <a name="reset-sshd"></a>Сброс SSHD
Создайте файл `PrivateConf.json` со следующим содержимым:

```json
{  
    "reset_ssh":"True"
}
```

С помощью Azure CLI вызовите расширение `VMAccessForLinux` для сброса подключения SSHD, указав JSON-файл. В следующем примере сбрасывается SSHD на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm extension set myResourceGroup myVM \
    VMAccessForLinux Microsoft.OSTCExtensions "1.2" \
    --private-config-path PrivateConf.json
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Если SSHD работает корректно, можно сбросить учетные данные для отдельного пользователя. Чтобы сбросить пароль для пользователя, создайте файл с именем `PrivateConf.json`. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword`. Введите следующие строки в файл `PrivateConf.json`, используя свои значения:

```json
{
    "username":"myUsername", "password":"myPassword"
}
```

Чтобы сбросить ключ SSH для пользователя, сначала создайте файл с именем `PrivateConf.json`. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Введите следующие строки в файл `PrivateConf.json`, используя свои значения:

```json
{
    "username":"myUsername", "ssh_key":"mySSHKey"
}
```

Создав JSON-файл, используйте Azure CLI, чтобы вызвать расширение `VMAccessForLinux` для сброса учетных данных пользователя SSH, указав JSON-файл. В следующем примере сбрасываются учетные данные на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm extension set myResourceGroup myVM \
    VMAccessForLinux Microsoft.OSTCExtensions "1.2" \
    --private-config-path PrivateConf.json
```


## <a name="restart-a-vm"></a>Перезапуск виртуальной машины
Если вы сбросили учетные данные пользователя и конфигурацию SSH или столкнулись с ошибкой при этом, попробуйте перезапустить виртуальную машину, чтобы устранить неполадки с базовыми вычислительными ресурсами.

### <a name="azure-portal"></a>Портал Azure
Чтобы перезапустить виртуальную машину с помощью портала Azure, выберите виртуальную машину и нажмите кнопку ***Перезапуск**, как показано в следующем примере:

![Перезапуск виртуальной машины на портале Azure](./media/virtual-machines-linux-troubleshoot-ssh-connection/restart-vm-using-portal.png)

### <a name="azure-cli"></a>Инфраструктура CLI Azure
В следующем примере перезапускается виртуальная машина `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm restart --resource-group myResourceGroup --name myVM
```


## <a name="redeploy-a-vm"></a>Повторное развертывание виртуальной машины
Виртуальную машину можно повторно развернуть на другом узле в Azure, что поможет устранить любые базовые сетевые проблемы. Сведения о повторном развертывании виртуальной машины на новом узле Azure см. [здесь](virtual-machines-windows-redeploy-to-new-node.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

> [!NOTE]
> Обратите внимание, что после этой операции будут потеряны данные на временном диске, а также изменятся динамические IP-адреса, связанные с виртуальной машиной.
> 
> 

### <a name="azure-portal"></a>Портал Azure
Чтобы повторно развернуть виртуальную машину с помощью портала Azure, выберите виртуальную машину и прокрутите вниз до раздела **Поддержка и устранение неполадок**. Нажмите кнопку **Повторить развертывание**, как показано в следующем примере:

![Повторное развертывание виртуальной машины на портале Azure](./media/virtual-machines-linux-troubleshoot-ssh-connection/redeploy-vm-using-portal.png)

### <a name="azure-cli"></a>Инфраструктура CLI Azure
В следующем примере повторно развертывается виртуальная машина `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm redeploy --resource-group myResourceGroup --name myVM
```

## <a name="vms-created-by-using-the-classic-deployment-model"></a>Виртуальные машины, созданные с использованием классической модели развертывания
Для устранения наиболее распространенных сбоев SSH-подключения для виртуальных машин, созданных с помощью классической модели развертывания, попробуйте выполнить указанные ниже действия. После выполнения каждого шага попробуйте подключиться к виртуальной машине еще раз.

* Выполните сброс удаленного доступа на [портале Azure](https://portal.azure.com). На портале Azure выберите свою виртуальную машину и нажмите кнопку **Reset Remote...** (Удаленный сброс...).
* Перезапустите виртуальную машину. На [портале Azure](https://portal.azure.com) выберите свою виртуальную машину и нажмите кнопку **Перезапуск**.
  
    -ИЛИ-
  
    На [классическом портале Azure](https://manage.windowsazure.com) откройте **Виртуальные машины** > **Экземпляры** > **Перезагрузить**.
* Повторно разверните виртуальную машину на новом узле Azure. Сведения о повторном развертывании виртуальной машины на новом узле Azure см. [здесь](virtual-machines-windows-redeploy-to-new-node.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
  
    Обратите внимание, что после этой операции будут потеряны данные на временном диске, а также изменятся динамические IP-адреса, связанные с виртуальной машиной.
* Следуйте указаниям в статье о [сбросе пароля или ключа SSH в виртуальных машинах Linux](virtual-machines-linux-classic-reset-access.md?toc=%2fazure%2fvirtual-machines%2flinux%2fclassic%2ftoc.json), чтобы сделать следующее:
  
  * сбросить пароль или ключ SSH;
  * Создайте учетную запись пользователя *sudo*.
  * сбросить конфигурацию SSH.
* Проверьте работоспособность ресурсов виртуальной машины, чтобы выявить любые проблемы, связанные с платформой.<br>
  Выберите свою виртуальную машину и прокрутите вниз до раздела **Параметры** > **Проверка работоспособности**.

## <a name="additional-resources"></a>Дополнительные ресурсы
* Если вам по-прежнему не удается выполнить SSH-подключение к виртуальной машине, см. [дополнительные действия по устранению неполадок](virtual-machines-linux-detailed-troubleshoot-ssh-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json), которые позволят просмотреть дополнительные шаги по устранению проблемы.
* Дополнительные сведения об устранении неполадок с доступом к приложению см. в статье [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines-linux-troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
* Дополнительные сведения об устранении неполадок на виртуальных машинах, созданных с помощью классической модели развертывания, см. в статье о [сбросе пароля или ключа SSH в виртуальных машинах Linux](virtual-machines-linux-classic-reset-access.md?toc=%2fazure%2fvirtual-machines%2flinux%2fclassic%2ftoc.json).




<!--HONumber=Nov16_HO3-->


