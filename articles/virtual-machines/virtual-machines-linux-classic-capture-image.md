<properties
	pageTitle="Запись образа виртуальной машины Linux | Microsoft Azure"
	description="Узнайте, как записать образ виртуальной машины Azure под управлением Linux, созданной с помощью классической модели развертывания."
	services="virtual-machines-linux"
	documentationCenter=""
	authors="iainfoulds"
	manager="timlt"
	editor="tysonn"
	tags="azure-service-management"/>

<tags
	ms.service="virtual-machines-linux"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-linux"
	ms.devlang="na"
	ms.topic="article"
	ms.date="06/14/2016"
	ms.author="iainfou"/>


# Запись классической виртуальной машины Linux в виде образа

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-classic-include.md)] [Resource Manager model](virtual-machines-linux-capture-image.md).

В этой статье показано, как записать виртуальную машину Azure под управлением Linux, чтобы использовать ее в качестве образа при создании других виртуальных машин. Данный образ виртуальной машины включает в себя диск операционной системы и прочие диски данных, присоединенные к виртуальной машине. Он не включает в себя сетевую конфигурацию, поэтому ее необходимо настроить при создании других виртуальных машин из образа.

Azure хранит образ в папке **Образы**. В этой папке также хранятся все переданные вами образы. Дополнительную информацию об образах см. в статье [Об образах виртуальной машины в Azure][].

## Перед началом работы

В шагах этой статьи предполагается, что вы уже создали виртуальную машину Azure с использованием классической модели развертывания и настроили операционную систему, а также присоединили диски данных. Если вы это еще сделали, прочтите статью [Создание виртуальной машины Linux][].


## Запись виртуальной машины

1. [Подключитесь к виртуальной машине](virtual-machines-linux-classic-log-on.md) с помощью SSH-клиента по своему усмотрению.

2. В окне SSH введите следующую команду. Обратите внимание, что выходные данные `waagent` могут незначительно отличаться в зависимости от версии этой служебной программы:

	`sudo waagent -deprovision+user`

	Эта команда попытается очистить систему и сделать ее пригодной для повторной подготовки. В ходе операции выполняются такие задачи:

	- удаляются ключи узла SSH (если в файле конфигурации для Provisioning.RegenerateSshHostKeyPair указано значение «y»);
	- очищается конфигурация имени сервера в /etc/resolv.conf;
	- удаляется пароль пользователя `root` из /etc/shadow (если в файле конфигурации для Provisioning.DeleteRootPassword указано значение «y»);
	- удаляются кэшированные аренды DHCP-клиентов.
	- возвращается имя узла localhost.localdomain;
	- удаляется последняя подготовленная учетная запись пользователя (полученная из /var/lib/waagent) и **связанные с ней данные**.

	>[AZURE.NOTE] Процедура отзыва приводит к удалению файлов и данных, так как выполняется попытке «обобщить» образ. Эту команду следует выполнять только на виртуальных машинах, которые требуется записать как шаблон нового образа. Отзыв не гарантирует, что из образа будет удалена вся конфиденциальная информация и что он будет готов к повторному распространению третьим сторонам.


3. Чтобы продолжить, введите **y**. Чтобы предотвратить появление запроса на подтверждение, добавьте параметр `-force`.

4. Введите **Exit**, чтобы закрыть SSH-клиент.

	>[AZURE.NOTE] Далее предполагается, что вы уже [установили Azure CLI](../xplat-cli-install.md) на клиентском компьютере. Также все эти действия можно выполнить на [классическом портале Azure][].

5. На клиентском компьютере откройте интерфейс командной строки Azure и войдите в подписку Azure. Подробнее см. в разделе [Подключение к среде Azure с использованием интерфейса командной строки Azure (Azure CLI)](../xplat-cli-connect.md).

6. Убедитесь, что вы находитесь в режиме управления службами:

	`azure config mode asm`

7. Завершите работу виртуальной машины, которая была отозвана ранее, с помощью команды:

	`azure vm shutdown <your-virtual-machine-name>`

	>[AZURE.NOTE] Вы можете получить все виртуальные машины, созданные в подписке, с помощью `azure vm list`.

8. Когда виртуальная машина остановлена, запишите образ с помощью команды:

	`azure vm capture -t <your-virtual-machine-name> <new-image-name>`

	Введите имя образа вместо _new-image-name_. Эта команда создает обобщенный образ операционной системы. Подкоманда `-t` удаляет исходную виртуальную машину.

9.	Новый образ станет доступным в списке образов, которые можно использовать для настройки новых виртуальных машин. Его можно просмотреть с помощью следующей команды:

	`azure vm image list`

	На [классическом портале Azure][] он будет показан в списке **ОБРАЗЫ**.

	![Успешная запись образа](./media/virtual-machines-linux-classic-capture-image/VMCapturedImageAvailable.png)


## Дальнейшие действия
Образ готов к использованию для создания виртуальных машин. Вы можете использовать команду Azure CLI `azure vm create` и указать имя образа, который только что создали. Дополнительные сведения о команде см. в статье [Использование Azure CLI для управления службами Azure](../virtual-machines-command-line-tools.md). Кроме того, с помощью [классического портала Azure][] можно создать настраиваемую виртуальную машину, выбрав метод **Из коллекции** и указав образ, который вы только что создали. Подробнее см. в разделе [Как создать настраиваемую виртуальную машину][].

**См. также:** [Руководство пользователя агента Linux для Azure](virtual-machines-linux-agent-user-guide.md)

[классического портала Azure]: http://manage.windowsazure.com
[классическом портале Azure]: http://manage.windowsazure.com
[Об образах виртуальной машины в Azure]: virtual-machines-linux-classic-about-images.md
[Как создать настраиваемую виртуальную машину]: virtual-machines-linux-classic-create-custom.md
[How to Attach a Data Disk to a Virtual Machine]: virtual-machines-windows-classic-attach-disk.md
[Создание виртуальной машины Linux]: virtual-machines-linux-classic-create-custom.md

<!---HONumber=AcomDC_0622_2016-->