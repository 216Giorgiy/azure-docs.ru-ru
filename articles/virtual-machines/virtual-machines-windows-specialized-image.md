<properties
	pageTitle="Создание копии виртуальной машины Windows | Microsoft Azure"
	description="Узнайте, как скопировать виртуальную машину Azure под управлением Windows в модели развертывания диспетчера ресурсов, создав *специализированный образ*."
	services="virtual-machines-windows"
	documentationCenter=""
	authors="cynthn"
	manager="timlt"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machines-windows"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="04/26/2016"
	ms.author="cynthn"/>

# Создание копии виртуальной машины Windows в модели развертывания с помощью Azure Resource Manager


В этой статье показано, как создать копию виртуальной машины Azure под управлением Windows. В частности, здесь рассматривается, как это сделать в модели развертывания с помощью Azure Resource Manager, используя Azure PowerShell и портал Azure. Здесь демонстрируется, как создать *специализированный* образ виртуальной машины Azure, содержащий учетные записи пользователей и другие данные о состоянии исходной виртуальной машины. Специализированный образ пригодится для перевода виртуальной машины Windows из классической модели развертывания в модель развертывания диспетчера ресурсов или создания резервной копии виртуальной машины Windows, созданной в модели развертывания диспетчера ресурсов. Таким образом можно скопировать операционную систему и диски данных и настроить сетевые ресурсы для создания новой виртуальной машины.

Если вам нужно создать массовые развертывания аналогичных виртуальных машин Windows, используйте *обобщенный* образ. Инструкции см. в статье [Как записать образ виртуальной машины Windows](virtual-machines-windows-capture-image.md).



## Перед началом работы

Перед началом описанной ниже процедуры необходимо выполнить следующие условия.

- **Наличие виртуальной машины Azure под управлением Windows**, созданной с использованием классической модели развертывания или модели развертывания с помощью Resource Manager. Настроенная операционная система, подключенные диски данных и другие настройки, такие как установка необходимых приложений. Эта виртуальная машина будет использоваться для создания копии. Если вам нужна помощь в создании исходной виртуальной машины, см. статью [Создание виртуальной машины Windows с помощью диспетчера ресурсов](virtual-machines-windows-ps-create.md).

- **Azure PowerShell 1.0 (или более поздней версии)**, установленный на компьютере, а также выполненный вход в подписку Azure. Дополнительные сведения см. в статье [Как установить и настроить Azure PowerShell](../powershell-install-configure.md).

- Загруженное и установленное **средство AzCopy**. Дополнительные сведения об этом средстве см. в статье [Передача данных с использованием средства командной строки AzCopy](../storage/storage-use-azcopy.md).

- Наличие **группы ресурсов**, **учетной записи хранения** и **контейнера для BLOB-объектов**, созданного в группе ресурсов, куда будут копироваться виртуальные жесткие диски. Процедуры использования существующей учетной записи хранения и создания новой см. в статье [Создание или поиск учетной записи хранения Azure](virtual-machines-windows-upload-image.md#createstorage).

> [AZURE.NOTE] Аналогичная процедура подходит для виртуальной машины, созданной с использованием одной из двух моделей развертывания как исходного образа. О различиях будет сказано в этой статье.


## Копирование виртуальных жестких дисков в учетную запись хранения для диспетчера ресурсов


1. Сначала освободите виртуальный жесткий диск, используемый исходной виртуальной машиной, одним из следующих способов.

	- Если вы хотите скопировать исходную виртуальную машину, остановите ее и отмените распределение.

		- Для виртуальных машин, созданных с помощью классической модели развертывания, можно использовать [портал](https://portal.azure.com), последовательно выбрав пункты **Обзор** > **Виртуальные машины (классические)** > *ваша виртуальная машина* > **Остановить**, или выполнить команду PowerShell `Stop-AzureVM -ServiceName <yourServiceName> -Name <yourVmName>`.

		- Для виртуальных машин, созданных с помощью модели развертывания диспетчера ресурсов, можно войти на портал и последовательно выбрать пункты **Обзор** > **Виртуальные машины** > *ваша виртуальная машина* > **Остановить** либо выполнить команду PowerShell `Stop-AzureRmVM -ResourceGroupName <yourResourceGroup> -Name <yourVmName>`. Обратите внимание, что состояние виртуальной машины на портале изменится с **Выполняется** на **Остановлено (освобождено)**.

	- Если вы хотите перенести исходную виртуальную машину, удалите ее и используйте оставшийся виртуальный жесткий диск. Найдите свою виртуальную машину на [портале](https://portal.azure.com) и нажмите кнопку **Удалить**.

1. Найдите клавиши доступа для учетной записи хранения, содержащей исходный виртуальный жесткий диск, а также для виртуальной учетной записи хранения, в которую будет скопирован виртуальный жесткий диск для создания новой виртуальной машины. Ключ учетной записи, из которой копируется виртуальный жесткий диск, называется *исходным*, а ключ учетной записи, в которую будет скопирован диск, называется *целевым*. Дополнительные сведения о клавишах доступа см. в статье [Об учетных записях хранения Azure](../storage/storage-create-storage-account.md).

	- Если исходная виртуальная машина создана с использованием классической модели развертывания, последовательно выберите пункты **Обзор** > **Учетные записи хранения (классические)** > *ваша учетная запись хранения* > **Все параметры** > **Ключи**. Скопируйте ключ, обозначенный как **ПЕРВИЧНАЯ КЛАВИША ДОСТУПА**.

	- Если исходная виртуальная машина была создана с использованием модели развертывания Resource Manager, а также для учетной записи хранения, которая будет использоваться для новой виртуальной машины, последовательно выберите пункты **Обзор** > **Учетные записи хранения** > *ваша учетная запись хранения* > **Все параметры** > **Клавиши доступа**. Скопируйте ключ с пометкой **key1**.

1. Получите URL-адреса для доступа к исходной и целевой учетной записи хранения. На портале найдите свою учетную запись хранения и щелкните **BLOB-объекты**. Щелкните контейнер, в котором находится исходный виртуальный жесткий диск (например, *vhds* для классической модели развертывания) или контейнер, в который нужно скопировать виртуальный жесткий диск. Щелкните **Свойства** этого контейнера и скопируйте текст с пометкой **URL-адрес**. Вам понадобятся URL-адреса исходного и целевого контейнеров. URL-адреса будут выглядеть следующим образом: `https://myaccount.blob.core.windows.net/mycontainer`.

1. На локальном компьютере откройте окно командной строки и найдите папку, где установлено средство AzCopy. (Это будет папка вида *C:\\Program Files (x86)\\Microsoft SDKs\\Azure\\AzCopy*.) Отсюда выполните следующую команду: </br>

		AzCopy /Source:<URL_of_the_source_blob_container> /Dest:<URL_of_the_destination_blob_container> /SourceKey:<Access_key_for_the_source_storage> /DestKey:<Access_key_for_the_destination_storage> /Pattern:<File_name_of_the_VHD_you_are_copying>
</br>

>[AZURE.NOTE] Операционную систему и диски с данными следует скопировать отдельно, используя AzCopy, как описано выше.


## Создание виртуальной машины с помощью скопированного виртуального жесткого диска

Используя созданный ранее виртуальный жесткий диск, можно создать виртуальную машину Windows на основе диспетчера ресурсов в новой виртуальной сети с помощью Azure PowerShell. Виртуальный жесткий диск должен находиться в той же учетной записи хранения, что и создаваемая виртуальная машина.


Настройте виртуальную сеть и сетевой адаптер для новой виртуальной машины, как указано ниже. Используйте для переменных (они обозначены в коде символом **$**) значения, соответствующие контексту вашего приложения.

	$pip = New-AzureRmPublicIpAddress -Name $pipName -ResourceGroupName $rgName -Location $location -AllocationMethod Dynamic

	$subnetconfig = New-AzureRmVirtualNetworkSubnetConfig -Name $subnet1Name -AddressPrefix $vnetSubnetAddressPrefix

	$vnet = New-AzureRmVirtualNetwork -Name $vnetName -ResourceGroupName $rgName -Location $location -AddressPrefix $vnetAddressPrefix -Subnet $subnetconfig

	$nic = New-AzureRmNetworkInterface -Name $nicname -ResourceGroupName $rgName -Location $location -SubnetId $vnet.Subnets[0].Id -PublicIpAddressId $pip.Id


Теперь настройте конфигурации виртуальной машины и используйте скопированные виртуальные жесткие диски для создания виртуальной машины. </br>

	#Set the VM name and size
	$vmConfig = New-AzureRmVMConfig -VMName $vmName -VMSize "Standard_A2"

	#Add the NIC
	$vm = Add-AzureRmVMNetworkInterface -VM $vmConfig -Id $nic.Id

	#Add the OS disk by using the URL of the copied OS VHD
	$osDiskName = $vmName + "osDisk"
	$vm = Set-AzureRmVMOSDisk -VM $vm -Name $osDiskName -VhdUri $osDiskUri -CreateOption attach -Windows

	#Add data disks by using the URLs of the copied data VHDs at the appropriate Logical Unit Number (Lun)
	$dataDiskName = $vmName + "dataDisk"
	$vm = Add-AzureRmVMDataDisk -VM $vm -Name $dataDiskName -VhdUri $dataDiskUri -Lun 0 -CreateOption attach

URL-адреса дисков данных и дисков операционной системы выглядят так: `https://StorageAccountName.blob.core.windows.net/BlobContainerName/DiskName.vhd`. Их можно узнать на портале. Для этого найдите целевой контейнер хранилища, щелкните скопированный виртуальный жесткий диск операционной системы или данных, а затем скопируйте содержимое URL-адреса.

	#Create the new VM
	New-AzureRmVM -ResourceGroupName $rgName -Location $location -VM $vm

Если команда будет выполнена успешно, вы увидите примерно такой результат.

	RequestId IsSuccessStatusCode StatusCode ReasonPhrase
	--------- ------------------- ---------- ------------
	                         True         OK OK


Созданная виртуальная машина должна отображаться на [портале Azure](https://portal.azure.com) (выберите **Обзор** > **Виртуальные машины**). Ее можно также увидеть, выполнив следующие команды PowerShell.

	$vmList = Get-AzureRmVM -ResourceGroupName $rgName
	$vmList.Name

Чтобы войти на новую виртуальную машину, найдите ее на [портале](https://portal.azure.com), нажмите кнопку **Подключение** и откройте RDP-файл "Удаленный рабочий стол". Для входа на новую виртуальную машину используйте учетные данные для входа в новую виртуальную машину.


## Дальнейшие действия

Сведения об управлении созданной виртуальной машиной с помощью Azure PowerShell см. в статье [Управление виртуальными машинами Azure с помощью диспетчера ресурсов и PowerShell](virtual-machines-windows-ps-manage.md).

<!---HONumber=AcomDC_0525_2016-->