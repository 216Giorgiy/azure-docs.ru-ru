<properties
	pageTitle="Создание копии виртуальной машины Windows | Microsoft Azure"
	description="Узнайте, как скопировать виртуальную машину Azure под управлением Windows в модели развертывания диспетчера ресурсов, создав *специализированный образ*."
	services="virtual-machines-windows"
	documentationCenter=""
	authors="dsk-2015"
	manager="timlt"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machines-windows"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="04/26/2016"
	ms.author="dkshir"/>

# Создание копии виртуальной машины Windows в модели развертывания диспетчера ресурсов


В этой статье показано, как создать копию виртуальной машины Azure под управлением Windows в модели развертывания диспетчера ресурсов, используя Azure PowerShell и портал Azure. Здесь демонстрируется процесс создания **_специализированного_** образа виртуальной машины Azure, содержащего учетные записи пользователей и другие о состоянии исходной виртуальной машины. Специализированный образ пригодится в таких ситуациях, как перевод виртуальной машины Windows из классической модели развертывания в модель развертывания диспетчера ресурсов или создание резервной копии виртуальной машины Windows, созданной в модели развертывания диспетчера ресурсов. Таким образом можно скопировать операционную систему и диски данных и настроить сетевые ресурсы для создания новой виртуальной машины.

В случае массового развертывания схожих виртуальных машин Windows требуется *обобщенный* образ (см. статью [Запись образа виртуальной машины Windows](virtual-machines-windows-capture-image.md)).



## Перед началом работы

В этой статье предполагается, что у вас есть следующие компоненты.

1. **Виртуальная машина Azure под управлением Windows** в классической модели развертывания или в модели развертывания Resource Manager с настроенной операционной системой, присоединенными дисками данных и установленными необходимыми приложениями. Если вам нужна помощь в создании такой виртуальной машины, см. статью [Создание виртуальной машины Windows с помощью Resource Manager и PowerShell](virtual-machines-windows-ps-create.md). 

1. Установленное на компьютере решение **Azure PowerShell версии 1.0 или выше**, а также выполненный вход в подписку Azure. Дополнительные сведения см. в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md).

1. Установленное на компьютере **средство AzCopy**. Дополнительные сведения об этом средстве см. в статье [Приступая к работе со служебной программой командной строки AzCopy](../storage/storage-use-azcopy.md).

1. **Группа ресурсов** с **учетной записью хранения** и созданный в ней **контейнер больших двоичных объектов** для копирования виртуальных жестких дисков. Процедуры использования существующей учетной записи хранения и создания новой см. в статье [Создание или поиск учетной записи хранения Azure](virtual-machines-windows-upload-image.md#createstorage).



> [AZURE.NOTE] Аналогичная процедура подходит для виртуальной машины, созданной с использованием одной из двух моделей развертывания как исходный образ. Незначительные отличия будут указаны.


## Копирование виртуальных жестких дисков в учетную запись хранения для диспетчера ресурсов


1. Сначала освободите виртуальный жесткий диск, используемый исходной виртуальной машиной, одним из следующих способов:

	- Если вы хотите **_скопировать_** исходную виртуальную машину, **остановите** ее и **отмените распределение**.
	
		- Для виртуальных машин, созданных с помощью классической модели развертывания, можно использовать [портал](https://portal.azure.com), последовательно выбрав пункты **Обзор** > **Виртуальные машины (классические)** > *ваша виртуальная машина* > **Остановить**, или выполнить команду PowerShell `Stop-AzureVM -ServiceName <yourServiceName> -Name <yourVmName>`. 
		
		- Для виртуальных машин, созданных по модели развертывания Resource Manager, можно войти на портал и последовательно выбрать пункты **Обзор** > **Виртуальные машины** > *ваша виртуальная машина* > **Остановить**, или выполнить команду PowerShell `Stop-AzureRmVM -ResourceGroupName <yourResourceGroup> -Name <yourVmName>`. Обратите внимание, что значение *Состояние* виртуальной машины на портале изменится с **Выполняется** на **Остановлено (освобождено)**.

	
	- Если вы хотите **_перенести_** исходную виртуальную машину, **удалите** ее и используйте оставшийся виртуальный жесткий диск. **Найдите** свою виртуальную машину на [портале](https://portal.azure.com) и нажмите кнопку **Удалить**.
	
1. Найдите ключи доступа для учетной записи хранения, содержащей исходный виртуальный жесткий диск, а также для виртуальной учетной записи хранения, в которую будет скопирован виртуальный жесткий диск для создания новой виртуальной машины. Ключ учетной записи, из которой копируется виртуальный жесткий диск, называется *исходным*, а ключ учетной записи, в которую будет скопирован диск, называется *целевым*. Дополнительные сведения о ключах доступа см. в статье [Об учетных записях хранения Azure](../storage/storage-create-storage-account.md).

	- Если исходная виртуальная машина создана с использованием классической модели развертывания, последовательно щелкните **Обзор** > **Учетные записи хранения (классические)** > *ваша учетная запись хранения* > **Все параметры** > **Ключи** и скопируйте ключ с пометкой **Первичный ключ доступа**. 
	
	- Для виртуальной машины, созданной с использованием модели развертывания Resource Manager, или для учетной записи хранения, которая будет использована для новой виртуальной машины: последовательно выберите пункты **Обзор** > **Учетные записи хранения** > *ваша учетная запись хранения* > **Все параметры** > **Ключи доступа** и скопируйте ключ с пометкой **key1**.

1. Получите URL-адреса для доступа к исходной и целевой учетной записи хранения. На портале **найдите** свою учетную запись хранения и щелкните **BLOB-объекты**. Щелкните контейнер, в котором находится исходный виртуальный жесткий диск (например, *vhds* для классической модели развертывания) или контейнер, в который нужно скопировать виртуальный жесткий диск. Щелкните **Свойства** этого контейнера и скопируйте текст с пометкой **URL-адрес**. Нам понадобятся URL-адреса исходного и целевого контейнеров. URL-адреса будут выглядеть следующим образом: `https://myaccount.blob.core.windows.net/mycontainer`.

1. На локальном компьютере откройте окно командной строки и перейдите в папку, где установлено средство AzCopy. Это будет папка вида *C:\\Program Files (x86)\\Microsoft SDKs\\Azure\\AzCopy*. Отсюда выполните следующую команду: </br>

		AzCopy /Source:<URL_of_the_source_blob_container> /Dest:<URL_of_the_destination_blob_container> /SourceKey:<Access_key_for_the_source_storage> /DestKey:<Access_key_for_the_destination_storage> /Pattern:<File_name_of_the_VHD_you_are_copying>
</br>

>[AZURE.NOTE] Диски операционной системы и данных необходимо скопировать отдельно, используя AzCopy, как описано выше.


## Создание виртуальной машины с помощью скопированного виртуального жесткого диска

Ниже показано, как использовать Azure PowerShell для создания виртуальной Машины Windows с диспетчер ресурсов на основе новой виртуальной сети с помощью виртуального жесткого диска, копируется в указанные выше шаги. Виртуальный жесткий диск должен находиться в той же учетной записи хранения, что и создаваемая виртуальная машина.


Сначала настройте виртуальную сеть и сетевой адаптер для новой виртуальной машины, как указано ниже. Используйте для переменных (они обозначены в коде символом **$**) значения, соответствующие контексту вашего приложения.

	$pip = New-AzureRmPublicIpAddress -Name $pipName -ResourceGroupName $rgName -Location $location -AllocationMethod Dynamic

	$subnetconfig = New-AzureRmVirtualNetworkSubnetConfig -Name $subnet1Name -AddressPrefix $vnetSubnetAddressPrefix

	$vnet = New-AzureRmVirtualNetwork -Name $vnetName -ResourceGroupName $rgName -Location $location -AddressPrefix $vnetAddressPrefix -Subnet $subnetconfig

	$nic = New-AzureRmNetworkInterface -Name $nicname -ResourceGroupName $rgName -Location $location -SubnetId $vnet.Subnets[0].Id -PublicIpAddressId $pip.Id


Теперь настройте конфигурации виртуальной машины и используйте скопированные виртуальные жесткие диски для создания виртуальной машины, как показано ниже. </br>

	#Set the VM name and size
	$vmConfig = New-AzureRmVMConfig -VMName $vmName -VMSize "Standard_A2"

	#Add the NIC
	$vm = Add-AzureRmVMNetworkInterface -VM $vmConfig -Id $nic.Id

	#Add the OS disk using the URL of the copied OS VHD
	$osDiskName = $vmName + "osDisk"
	$vm = Set-AzureRmVMOSDisk -VM $vm -Name $osDiskName -VhdUri $osDiskUri -CreateOption attach -Windows
	
	#Add data disks using the URLs of the copied data VHDs at the appropriate Logical Unit Number (Lun)
	$dataDiskName = $vmName + "dataDisk"
	$vm = Add-AzureRmVMDataDisk -VM $vm -Name $dataDiskName -VhdUri $dataDiskUri -Lun 0 -CreateOption attach
	
URL-адреса дисков данных и дисков операционной системы выглядят так: `https://StorageAccountName.blob.core.windows.net/BlobContainerName/DiskName.vhd`. Их можно узнать на портале. Для этого найдите целевой контейнер хранилища, щелкните скопированный виртуальный жесткий диск операционной системы или данных, а затем скопируйте содержимое поля **URL-адрес**.
	
	#Create the new VM
	New-AzureRmVM -ResourceGroupName $rgName -Location $location -VM $vm
	
Если команда будет выполнена успешно, вы увидите примерно такой результат:

	RequestId IsSuccessStatusCode StatusCode ReasonPhrase
	--------- ------------------- ---------- ------------
	                         True         OK OK


Созданная виртуальная машина должна отображаться на [портале Azure](https://portal.azure.com) (выберите **Обзор** > **Виртуальные машины**). Ее можно также увидеть, выполнив следующие команды PowerShell:

	$vmList = Get-AzureRmVM -ResourceGroupName $rgName
	$vmList.Name

Чтобы войти на новую виртуальную машину, **найдите** ее на [портале](https://portal.azure.com), нажмите кнопку **Подключение** и откройте RDP-файл *Удаленный рабочий стол*. Для входа на новую виртуальную машину используйте учетные данные для исходной виртуальной машины.


## Дальнейшие действия

Сведения об управлении созданной виртуальной машиной с помощью Azure PowerShell см. в статье [Управление виртуальными машинами с помощью Azure Resource Manager и PowerShell](virtual-machines-windows-ps-manage.md).

<!---HONumber=AcomDC_0511_2016-->