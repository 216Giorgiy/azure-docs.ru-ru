<properties
	pageTitle="Подробная диагностика удаленного рабочего стола | Microsoft Azure"
	description="Подробные указания по устранению неполадок подключений к удаленному рабочему столу виртуальной машины Azure под управлением Windows."
	services="virtual-machines"
	documentationCenter=""
	authors="dsk-2015"
	manager="timlt"
	editor=""
	tags="top-support-issue,azure-service-management,azure-resource-manager"/>

<tags
	ms.service="virtual-machines"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/16/2015"
	ms.author="dkshir"/>

# Подробная диагностика подключений к удаленному рабочему столу виртуальной машины Azure под управлением Windows

В этой статье подробно изложены пошаговые указания по устранению сложных ошибок в работе удаленного рабочего стола.

> [AZURE.IMPORTANT]Чтобы устранить более распространенные ошибки удаленного рабочего стола, обязательно ознакомьтесь с [основными способами устранения неполадок удаленного рабочего стола](virtual-machines-troubleshoot-remote-desktop-connections.md), прежде чем продолжить.

## Обращение в службу поддержки клиентов Azure

Если в любой момент при изучении этой статьи вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](http://azure.microsoft.com/support/forums/).

Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт службы поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните **Поддержка**. Дополнительные сведения об использовании службы поддержки Azure см. в разделе [Часто задаваемые вопросы о поддержке Azure](http://azure.microsoft.com/support/faq/).


## Универсальное сообщение об ошибке удаленного рабочего стола

Иногда в окне сообщений подключения к удаленному рабочему столу отображается это сообщение об ошибке: _Удаленному рабочему столу не удалось подключиться к данному удаленному компьютеру по одной из следующих причин…_

Эта ошибка возникает, когда служба удаленных рабочих столов на виртуальной машине недоступна для клиента удаленного рабочего стола. Возможны различные причины этой ошибки.

Вот схема компонентов, которые участвуют в этом процессе.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_0.png)

Прежде чем начинать пошаговое устранение неполадок, имеет смысл подумать о том, что изменилось с момента последнего успешного подключения к удаленному рабочему столу, и взять это за основу для поиска проблемы. Например:

- Если вам удавалось успешно создавать подключения к удаленному рабочему столу и вы сменили общедоступный IP-адрес виртуальной машины или облачной службы, в которой находится ваша виртуальная машина, (он также называется виртуальным IP-адресом, или VIP-адресом), возможно, в кэше вашего DNS-клиента осталась запись с DNS-именем и *старым IP-адресом*. Очистите кэш DNS-клиента и повторите попытку. Вы также можете попытаться подключиться с использованием нового виртуального IP-адреса.
- Если для управления своими подключениями к удаленным рабочим столам вы ранее использовали портал Azure или портал предварительной версии Azure, а теперь перешли на приложение, убедитесь в том, что в его конфигурации задан случайным образом определяемый TCP-порт для трафика удаленного рабочего стола.

В следующих разделах приведены пошаговые инструкции по локализации проблемы и определению ее причин, а также варианты временных и постоянных решений.


## Предварительные действия

Выполните следующие действия, прежде чем перейти к подробной диагностике.

- Проверьте состояние виртуальной машины на портале Azure или портале предварительной версии Azure.
- Перезапустите виртуальную машину.
- [Измените размер виртуальной машины.](virtual-machines-size-specs.md)

Выполнив эти действия, попытайтесь создать подключение к удаленному рабочему столу еще раз.


## Подробная диагностика

Возможно, клиенту удаленного рабочего стола не удалось подключиться к службам удаленных рабочих столов на виртуальной машине Azure из-за проблем и ошибок в настройках перечисленных ниже источниках:

- Компьютер с клиентом удаленного рабочего стола
- Пограничное устройство интрасети организации
- Конечная точка облачной службы и список управления доступом (ACL)
- Группы безопасности сети
- Виртуальная машина Windows в службе Azure

### Источник 1: компьютер с клиентом удаленного рабочего стола

Чтобы устранить компьютер из числа возможных источников проблем и ошибок в настройках, убедитесь в том, что с его помощью можно установить подключение к удаленному рабочему столу на другом локальном компьютере с Windows.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_1.png)

Если сделать это не удается, проверьте, нет ли на компьютере:

- локального брандмауэра, в параметрах которого блокируется обмен данными с удаленным рабочим столом;
- локального программного обеспечения с функциями прокси-сервера, которое не позволяет установить подключение к удаленному рабочему столу;
- локального программного обеспечения для мониторинга сети, которое не позволяет установить подключение к удаленному рабочему столу;
- других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов, тем самым блокируя подключение к удаленному рабочему столу.

В любом из перечисленных выше случаев попытайтесь временно отключить соответствующее программное обеспечение и подключиться к удаленному рабочему столу на локальном компьютере, чтобы выяснить основную причину проблемы. Затем при помощи администратора сети измените параметры программного обеспечения таким образом, чтобы оно не блокировало подключения к удаленным рабочим столам.

### Источник 2: пограничное устройство интрасети организации

Чтобы устранить пограничное устройство интрасети организации из числа возможных источников проблем и ошибок в настройках, убедитесь в том, что установить соединение с удаленным рабочим столом на виртуальной машине Azure можно с помощью компьютера, непосредственно подключенного к Интернету.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_2.png)

Если у вас нет такого компьютера, вы можете легко создать вместо него новую виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе. Дополнительные сведения см. в статье [Создание виртуальной машины Windows в среде Azure](virtual-machines-windows-tutorial.md). Завершив проверку, удалите группу ресурсов или виртуальную машину и облачную службу.

Если вам удается установить соединение с удаленным рабочим столом с компьютера, непосредственно подключенного к Интернету, проверьте, нет ли на пограничном устройстве интрасети вашей организации:

- интернет-брандмауэра, который блокирует подключения к Интернету по протоколу HTTPS;
- прокси-сервера, который не позволяет установить подключение к удаленному рабочему столу;
- программного обеспечения для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует подключения к удаленным рабочим столам.

При помощи администратора сети измените параметры пограничного устройства интрасети вашей организации таким образом, чтобы оно не блокировало HTTPS-подключения к удаленным рабочим столам через Интернет.

### Источник 3: конечная точка облачной службы и список управления доступом (ACL)

Чтобы устранить конечную точку облачной службы и ACL как источник проблем или неправильной конфигурации для виртуальных машин, созданных с помощью API управления службами, убедитесь, что другая виртуальная машина Azure, которая находится в той же облачной службе или виртуальной сети, может устанавливать подключения удаленного рабочего стола к вашей виртуальной машине Azure.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_3.png)

> [AZURE.NOTE]Для виртуальных машин, созданных в диспетчере ресурсов, переходите к подразделу [Источник 4: группы безопасности сети](#nsgs).

Если у вас нет еще одной виртуальной машины в той же облачной службе или виртуальной сети, вы можете легко ее создать. Дополнительные сведения см. в статье [Создание виртуальной машины Windows в среде Azure](virtual-machines-windows-tutorial.md). Завершив проверку, удалите дополнительную виртуальную машину.

Если вам удается подключиться к удаленному рабочему столу с виртуальной машины в той же облачной службе или виртуальной сети, проверьте перечисленные ниже потенциальные источники проблем.

- Конфигурацию конечной точки для обмена данными с удаленным рабочим столом на целевой виртуальной машине. Частный TCP-порт на конечной точке должен совпадать с TCP-портом, на котором ожидают передачи данных службы удаленных рабочих столов на виртуальной машине (по умолчанию это порт 3389).
- Список управления доступом на конечной точке для обмена данными с удаленным рабочим столом на целевой виртуальной машине. С помощью него можно разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если он неправильно настроен, входящие данные с удаленного рабочего стола на эту конечную точку могут блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительные сведения см. в разделе [Что такое списки управления доступом к сети?](../virtual-network/virtual-networks-acl.md).

Чтобы устранить конечную точку из числа потенциальных источников проблемы, удалите ее и создайте новую, выбрав в качестве номера внешнего порта любой порт в диапазоне от 49152 до 65535. Дополнительные сведения см. в разделе [Настройка конечных точек виртуальной машины](virtual-machines-set-up-endpoints.md).

### <a id="nsgs"></a>Источник 4: группы безопасности сети

Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure. Проверьте свои правила групп безопасности сети и убедитесь в том, что обмен данными с удаленными рабочими столами в Интернете разрешен.

Дополнительные сведения см. в разделе [Что такое группа безопасности сети?](../virtual-network/virtual-networks-nsg.md).

### Источник 5: виртуальная машина Windows в службе Azure

Последним потенциальным источником проблем является сама виртуальная машина Azure.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_5.png)

В [основной статье о диагностике удаленного рабочего стола](virtual-machines-troubleshoot-remote-desktop-connections.md) описывается использование [пакета диагностики IaaS Azure (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864). Если данному пакету диагностики не удалось устранить проблему **Подключение удаленного рабочего стола к виртуальной машине Azure (требуется перезагрузка)**, следуйте указаниям в [этой статье](virtual-machines-windows-reset-password.md), чтобы выполнить сброс службы удаленных рабочих столов на виртуальной машине. В результате:

- будет включено правило по умолчанию «Удаленный рабочий стол» в брандмауэре Windows (TCP-порт 3389);
- будут разрешены подключения к удаленным рабочим столам в реестре (для параметра HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\\fDenyTSConnections будет установлено значение 0).

Попытайтесь снова установить подключение со своего компьютера. Если вам не удастся этого сделать, проверьте, не является ли причиной один из перечисленных ниже моментов.

- На целевой виртуальной машине не запущены службы удаленных рабочих столов.
- Службы удаленных рабочих столов не ожидают передачи данных на TCP-порт 3389.
- В брандмауэре Windows или другом локальном брандмауэре есть правило для исходящего трафика, блокирующее трафик удаленных рабочих столов.
- Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует подключения к удаленным рабочим столам.

Чтобы исправить возможные проблемы для виртуальных машин, созданных с помощью API управления службами, можно использовать удаленный сеанс Azure PowerShell для виртуальной машины Azure. Сначала потребуется установить сертификат для облачной службы, в которой размещена виртуальная машина. Откройте страницу [Настройка защищенного удаленного доступа к среде PowerShell на виртуальных машинах Azure](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) и загрузите файл сценария **InstallWinRMCertAzureVM.ps1** в папку на своем локальном компьютере.

Затем установите Azure PowerShell, если еще не сделали этого. См. статью [Установка и настройка Azure PowerShell](../install-configure-powershell.md).

Затем откройте командную строку Azure PowerShell и перейдите из текущей папки в папку с файлом сценария **InstallWinRMCertAzureVM.ps1**. Для запуска сценария Azure PowerShell необходимо задать правильную политику выполнения. Выполните команду **Get-ExecutionPolicy**, чтобы определить текущий уровень политики. Инструкции по выбору подходящего уровня см. в описании команды [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).

Затем введите имя своей подписки Azure, имя облачной службы и имя виртуальной машины (удалив знаки < and >). После этого выполните следующие команды.

	$subscr="<Name of your Azure subscription>"
	$serviceName="<Name of the cloud service that contains the target virtual machine>"
	$vmName="<Name of the target virtual machine>"
	.\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName

Правильное имя подписки можно получить из свойства _SubscriptionName_ в выходных данных команды **Get-AzureSubscription**. Имя облачной службы для виртуальной машины можно получить из столбца _ServiceName_ в выходных данных команды **Get-AzureVM**.

Чтобы доказать, что у вас имеется новый сертификат, откройте оснастку «Сертификаты» для текущего пользователя и просмотрите папку **Trusted Root Certification Authorities\\Certificates**. Там должен быть сертификат с DNS-именем вашей облачной службы в столбце получателя (пример: cloudservice4testing.cloudapp.net).

Затем инициируйте удаленный сеанс Azure PowerShell с помощью следующих команд.

	$uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName
	$creds = Get-Credential
	Enter-PSSession -ConnectionUri $uri -Credential $creds

Указав действительные учетные данные администратора, вы должны увидеть в командной строке Azure PowerShell примерно следующее:

	[cloudservice4testing.cloudapp.net]: PS C:\Users\User1\Documents>

Первая часть этой строки говорит о том, что вы отправляете команды Azure PowerShell в облачную службу, в которой находится целевая виртуальная машина. Имя вашей облачной службы будет отличаться от cloudservice4testing.cloudapp.net.

Теперь с помощью команд Azure PowerShell вы можете проанализировать наличие перечисленных выше проблем и исправить конфигурацию.

### Изменение вручную TCP-порта прослушивания служб удаленных рабочих столов

Если вам не удалось запустить [пакет диагностики IaaS Azure (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) для проблемы **Подключение удаленного рабочего стола к виртуальной машине Azure (требуется перезагрузка)**, в командной строке удаленного сеанса Azure PowerShell выполните следующую команду.

	Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

Свойство PortNumber содержит текущий номер порта. При необходимости вы можете восстановить номер порта удаленного рабочего стола по умолчанию (3389) с помощью следующей команды:

	Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber" -Value 3389

Убедитесь в том, что номер порта изменен на 3389, с помощью следующей команды:

	Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

Закройте удаленный сеанс Azure PowerShell с помощью этой команды:

	Exit-PSSession

Также убедитесь в том, что на конечной точке удаленного рабочего стола для виртуальной машины Azure в качестве внутреннего порта задан TCP-порт 3398. Затем перезапустите виртуальную машину и попытайтесь снова подключиться к удаленному рабочему столу.


## Дополнительные ресурсы

[Пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)

[Сброс пароля или службы удаленных рабочих столов для виртуальных машин Windows](virtual-machines-windows-reset-password.md)

[Установка и настройка Azure PowerShell](../install-configure-powershell.md)

[Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux](virtual-machines-troubleshoot-ssh-connections.md)

[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines-troubleshoot-access-application.md)

<!---HONumber=Oct15_HO3-->