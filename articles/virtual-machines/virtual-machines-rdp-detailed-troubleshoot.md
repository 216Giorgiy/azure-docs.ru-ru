<properties
	pageTitle="Подробная диагностика удаленного рабочего стола | Microsoft Azure"
	description="Подробные указания по устранению неполадок подключений к удаленному рабочему столу виртуальной машины Azure под управлением Windows."
	services="virtual-machines"
	documentationCenter=""
	authors="dsk-2015"
	manager="timlt"
	editor=""
	tags="top-support-issue,azure-service-management,azure-resource-manager"/>

<tags
	ms.service="virtual-machines"
	ms.workload="infrastructure-services"
	ms.tgt_pltfrm="vm-windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="01/08/2016"
	ms.author="dkshir"/>

# Подробная диагностика подключений к удаленному рабочему столу виртуальной машины Azure под управлением Windows

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-both-include.md)]

В этой статье приводятся подробные инструкции по диагностике и устранению сложных ошибок удаленного рабочего стола для виртуальных машин Azure на базе Windows.

> [AZURE.IMPORTANT]Чтобы устранить более распространенные ошибки удаленного рабочего стола, обязательно ознакомьтесь с [основными способами устранения неполадок удаленного рабочего стола](virtual-machines-troubleshoot-remote-desktop-connections.md), прежде чем продолжить.

Если вы получите сообщение об ошибке удаленного рабочего стола, отличное от рассмотренных в [руководстве по устранению основных неполадок удаленного рабочего стола](virtual-machines-troubleshoot-remote-desktop-connections.md), выполните эти инструкции и попытайтесь определить, почему клиент удаленного рабочего стола ([RDP](https://en.wikipedia.org/wiki/Remote_Desktop_Protocol)) не может подключиться к службе RDP на виртуальной машине Azure.

Если вам потребуется дополнительная помощь по любому из вопросов, рассматриваемых в статье, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](http://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт службы поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните **Поддержка**. Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](http://azure.microsoft.com/support/faq/).


## Компоненты подключения к удаленному рабочему столу

В подключении к удаленному рабочему столу участвуют следующие компоненты:

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_0.png)

Прежде чем продолжить, проанализируйте, что изменилось с последнего успешного подключения удаленного рабочего стола к виртуальной машине. Например:

- Если общедоступный IP-адрес виртуальной машины или облачной службы ее размещения (также называемый виртуальным IP-адресом или [VIP](https://en.wikipedia.org/wiki/Virtual_IP_address)) изменился, сбой удаленного рабочего стола может быть связан с тем, что в кэше DNS-клиента по-прежнему хранится *старый IP-адрес*, зарегистрированный для DNS-имени. Очистите кэш DNS-клиента и попробуйте подключиться к виртуальной машине еще раз. Либо попробуйте подключиться напрямую по новому виртуальному IP-адресу.
- Если для управления своими подключениями к удаленным рабочим столам вы ранее использовали стороннее приложение вместо порталов Azure, убедитесь в том, что в его конфигурации указан правильный TCP-порт для трафика удаленного рабочего стола. Чтобы узнать номер порта для классической виртуальной машины на [портале Azure](portal.azure.com), щелкните параметры виртуальной машины и выберите пункт "Конечные точки".


## Предварительные действия

Прежде чем перейти к подробной диагностике, выполните следующие действия:

- Проверьте состояние виртуальной машины на классическом портале Azure или портале Azure на наличие очевидных проблем.
- Выполните [процедуры быстрого устранения ошибок удаленного рабочего стола, описанные в руководстве по устранению основных неполадок](virtual-machines-troubleshoot-remote-desktop-connections.md#quickfixrdp).


Выполнив эти действия, попробуйте заново подключиться к виртуальной машине через удаленный рабочий стол.


## Подробная диагностика

Возможно, клиенту удаленного рабочего стола не удалось подключиться к службе удаленных рабочих столов на виртуальной машине Azure из-за проблем в перечисленных ниже источниках:

- Компьютер с клиентом удаленного рабочего стола
- Пограничное устройство интрасети организации
- Конечная точка облачной службы и список управления доступом (ACL)
- Группы безопасности сети
- Виртуальная машина Windows в службе Azure

### Источник 1: компьютер с клиентом удаленного рабочего стола

Убедитесь, что ваш компьютер способен устанавливать подключения к удаленному рабочему столу на другом локальном компьютере под управлением Windows.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_1.png)

Если это не так, проверьте, нет ли на компьютере:

- локального брандмауэра, в параметрах которого блокируется обмен данными с удаленным рабочим столом;
- локального программного обеспечения с функциями прокси-сервера, которое не позволяет установить подключение к удаленному рабочему столу;
- локального программного обеспечения для мониторинга сети, которое не позволяет установить подключение к удаленному рабочему столу;
- других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов, тем самым блокируя подключение к удаленному рабочему столу.

В любом из перечисленных выше случаев временно отключите соответствующее программное обеспечение и попробуйте установить соединение с локальным компьютером через удаленный рабочий стол. Если это не помогло вам найти причину, обратитесь к администратору сети и измените параметры программного обеспечения таким образом, чтобы оно не блокировало подключения к удаленным рабочим столам.

### Источник 2: пограничное устройство интрасети организации

Убедитесь, что компьютер, подключенный непосредственно к Интернету, способен устанавливать подключения удаленного рабочего стола к виртуальной машине Azure.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_2.png)

Если у вас нет такого компьютера, создайте и протестируйте новую виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе. Дополнительные сведения см. в статье [Создание виртуальной машины Windows в среде Azure](virtual-machines-windows-tutorial.md). По завершении проверки удалите виртуальную машину и группу ресурсов или облачную службу.

Если вам удается установить соединение с удаленным рабочим столом с компьютера, непосредственно подключенного к Интернету, проверьте, нет ли на пограничном устройстве интрасети вашей организации:

- интернет-брандмауэра, который блокирует подключения к Интернету по протоколу HTTPS;
- прокси-сервера, который не позволяет установить подключение к удаленному рабочему столу;
- программного обеспечения для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует подключения к удаленным рабочим столам.

При помощи администратора сети измените параметры пограничного устройства интрасети вашей организации таким образом, чтобы оно не блокировало HTTPS-подключения к удаленным рабочим столам через Интернет.

### Источник 3: конечная точка облачной службы и список управления доступом (ACL)

Если виртуальные машины созданы по классической модели развертывания, убедитесь, что другая виртуальная машина Azure, которая находится в той же облачной службе или виртуальной сети, может устанавливать подключения удаленного рабочего стола к вашей виртуальной машине Azure.

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_3.png)

> [AZURE.NOTE]Для виртуальных машин, созданных в диспетчере ресурсов, см. раздел [Источник 4: группы безопасности сети](#nsgs).

Если у вас нет другой виртуальной машины в той же облачной службе или виртуальной сети, ее можно создать, выполнив инструкции в статье [Создание виртуальной машины под управлением Windows в Azure](virtual-machines-windows-tutorial.md). По завершении теста удалите дополнительную виртуальную машину.

Если вам удается подключиться к удаленному рабочему столу с виртуальной машины в той же облачной службе или виртуальной сети, проверьте перечисленные ниже потенциальные источники проблем:

- Конфигурация конечной точки для трафика удаленного рабочего стола на целевой виртуальной машине: частный TCP-порт конечной точки должен совпадать с TCP-портом, который используется для прослушивания службы удаленных рабочих столов для виртуальных машин (по умолчанию — 3389).
- Список управления доступом на конечной точке для обмена данными с удаленным рабочим столом на целевой виртуальной машине: позволяет разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если он неправильно настроен, входящие данные с удаленного рабочего стола на эту конечную точку могут блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительные сведения см. в разделе [Что такое списки контроля доступа к сети?](../virtual-network/virtual-networks-acl.md).

Чтобы устранить конечную точку из числа потенциальных источников проблемы, удалите ее и создайте новую, выбрав в качестве номера внешнего порта любой порт в диапазоне от 49152 до 65535. Дополнительные сведения см. в разделе [Настройка конечных точек виртуальной машины](virtual-machines-set-up-endpoints.md).

### <a id="nsgs"></a>Источник 4: группы безопасности сети

Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure. Проверьте свои правила групп безопасности сети и убедитесь в том, что обмен данными с удаленными рабочими столами в Интернете разрешен.

Дополнительные сведения см. в разделе [Что такое группа безопасности сети?](../virtual-network/virtual-networks-nsg.md).

### Источник 5: виртуальная машина Windows в службе Azure

![](./media/virtual-machines-rdp-detailed-troubleshoot/tshootrdp_5.png)

Чтобы проверить, не связан ли сбой с самой виртуальной машиной Azure, используйте [пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864). Если данному пакету диагностики не удалось устранить проблему **Подключение удаленного рабочего стола к виртуальной машине Azure (требуется перезагрузка)**, следуйте указаниям в [этой статье](virtual-machines-windows-reset-password.md), чтобы выполнить сброс службы удаленных рабочих столов на виртуальной машине. В результате:

- будет включено правило по умолчанию «Удаленный рабочий стол» в брандмауэре Windows (TCP-порт 3389);
- будут разрешены подключения к удаленным рабочим столам в реестре (для параметра HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\\fDenyTSConnections будет установлено значение 0).

Попытайтесь снова установить подключение со своего компьютера. Если установить подключение через виртуальный рабочий стол по-прежнему не удается, проверьте наличие следующих проблем:

- На целевой виртуальной машине не запущена служба удаленных рабочих столов.
- Служба удаленных рабочих столов не прослушивается через TCP-порт 3389.
- В брандмауэре Windows или другом локальном брандмауэре есть правило для исходящего трафика, блокирующее трафик удаленных рабочих столов.
- Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует подключения к удаленным рабочим столам.

Для виртуальных машин, созданных по классической модели развертывания, можно использовать удаленный сеанс Azure PowerShell на виртуальной машине Azure. Сначала потребуется установить сертификат для облачной службы, в которой размещена виртуальная машина. Откройте страницу [Настройка защищенного удаленного доступа к среде PowerShell на виртуальных машинах Azure](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) и загрузите файл сценария **InstallWinRMCertAzureVM.ps1** на локальный компьютер.

Затем установите Azure PowerShell, если еще не сделали этого. См. статью [Установка и настройка Azure PowerShell](../install-configure-powershell.md).

Затем откройте командную строку Azure PowerShell и перейдите из текущей папки в папку с файлом сценария **InstallWinRMCertAzureVM.ps1**. Для запуска сценария Azure PowerShell необходимо задать правильную политику выполнения. Выполните команду **Get-ExecutionPolicy**, чтобы определить текущий уровень политики. Инструкции по выбору подходящего уровня см. в описании команды [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).

Затем введите имя своей подписки Azure, имя облачной службы и имя виртуальной машины (удалив знаки < and >). После этого выполните следующие команды.

	$subscr="<Name of your Azure subscription>"
	$serviceName="<Name of the cloud service that contains the target virtual machine>"
	$vmName="<Name of the target virtual machine>"
	.\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName

Правильное имя подписки можно получить из свойства _SubscriptionName_ в выходных данных команды **Get-AzureSubscription**. Имя облачной службы для виртуальной машины можно получить из столбца _ServiceName_ в выходных данных команды **Get-AzureVM**.

Чтобы проверить наличие нового сертификата, откройте оснастку "Сертификаты" для текущего пользователя и просмотрите папку **Trusted Root Certification Authorities\\Certificates**. Там должен быть сертификат с DNS-именем вашей облачной службы в столбце получателя (пример: cloudservice4testing.cloudapp.net).

Затем инициируйте удаленный сеанс Azure PowerShell с помощью следующих команд.

	$uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName
	$creds = Get-Credential
	Enter-PSSession -ConnectionUri $uri -Credential $creds

Указав действительные учетные данные администратора, вы должны увидеть в командной строке Azure PowerShell примерно следующее:

	[cloudservice4testing.cloudapp.net]: PS C:\Users\User1\Documents>

Первая часть строки — это имя облачной службы, в которой находится целевая виртуальная машина (может отличаться от "cloudservice4testing.cloudapp.net"). Теперь, вызвав команды Azure PowerShell для этой облачной службы, вы можете проанализировать наличие перечисленных выше проблем и исправить конфигурацию.

### Изменение вручную TCP-порта прослушивания служб удаленных рабочих столов

Если вам не удалось запустить [пакет диагностики IaaS Azure (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864) для проблемы **Подключение удаленного рабочего стола к виртуальной машине Azure (требуется перезагрузка)**, в командной строке удаленного сеанса Azure PowerShell выполните следующую команду.

	Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

Свойство PortNumber содержит текущий номер порта. При необходимости вы можете восстановить номер порта удаленного рабочего стола по умолчанию (3389) с помощью следующей команды:

	Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber" -Value 3389

Убедитесь в том, что номер порта изменен на 3389, с помощью следующей команды:

	Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

Закройте удаленный сеанс Azure PowerShell с помощью этой команды:

	Exit-PSSession

Также убедитесь в том, что на конечной точке удаленного рабочего стола для виртуальной машины Azure в качестве внутреннего порта задан TCP-порт 3398. Перезапустите виртуальную машину Azure и попробуйте установить подключение к удаленному рабочему столу еще раз.


## Дополнительные ресурсы

[Пакет диагностики Azure IaaS (Windows)](https://home.diagnostics.support.microsoft.com/SelfHelp?knowledgebaseArticleFilter=2976864)

[Сброс пароля или службы удаленных рабочих столов для виртуальных машин Windows](virtual-machines-windows-reset-password.md)

[Установка и настройка Azure PowerShell](../install-configure-powershell.md)

[Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux](virtual-machines-troubleshoot-ssh-connections.md)

[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](virtual-machines-troubleshoot-access-application.md)

<!---HONumber=AcomDC_0114_2016-->