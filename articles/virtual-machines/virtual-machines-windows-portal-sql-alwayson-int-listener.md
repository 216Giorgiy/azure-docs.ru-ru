<properties
   pageTitle="Создание прослушивателя для группы доступности AlwaysOn для SQL Server в виртуальных машинах Azure"
   description="Пошаговые инструкции по созданию прослушивателя для группы доступности AlwaysOn для SQL Server в виртуальных машинах Azure"
   services="virtual-machines"
   documentationCenter="na"
   authors="MikeRayMSFT"
   manager="jhubbard"
   editor="monicar"/>

<tags
   ms.service="virtual-machines"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="vm-windows-sql-server"
   ms.workload="infrastructure-services"
   ms.date="04/17/2016"
   ms.author="MikeRayMSFT"/>

# Настройка внутреннего балансировщика нагрузки для группы доступности AlwaysOn в Azure

В этом разделе описывается, как создать внутренний балансировщик нагрузки для группы доступности AlwaysOn SQL Server в виртуальных машинах Azure, развернутых с использованием модели Resource Manager. Для группы доступности AlwaysOn необходим балансировщик нагрузки, если экземпляры SQL Server находятся на виртуальных машинах Azure. Балансировщик нагрузки хранит IP-адрес для прослушивателя группы доступности. Если группа доступности распространяется на несколько регионов, для каждого из них нужен отдельный балансировщик нагрузки.

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-rm-include.md)]классической модели.

Для создания балансировщика нагрузки необходимо развернуть группу доступности AlwaysOn SQL Server на виртуальных машинах Azure с использованием модели Resource Manager. Обе виртуальные машины SQL Server должны принадлежать к одной и той же группе доступности. Можно использовать [шаблон Майкрософт](virtual-machines-windows-portal-sql-alwayson-availability-groups.md), чтобы автоматически создать группу доступности AlwaysOn в Azure Resource Manager. Этот шаблон также автоматически создает внутренний балансировщик нагрузки.

При желании можно [вручную настроить группу доступности AlwaysOn](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md).

Здесь предполагается, что группы доступности уже настроены.

Связанные разделы включают:

 - [Настройка групп доступности AlwaysOn в виртуальной машине Azure (графический пользовательский интерфейс)](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md)   
 
 - [Настройка подключения между виртуальными сетями с помощью Azure Resource Manager и PowerShell](../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md)

## Действия

Последовательно выполнив все действия в этом документе, вы создадите и настроите балансировщик нагрузки на портале Azure. После этого вы настроите в кластере использование IP-адреса из балансировщика нагрузки для прослушивателя группы доступности AlwaysOn.

## Создание и настройка балансировщика нагрузки на портале Azure

В этом разделе описывается, как сделать следующее на портале Azure:

1. Создать балансировщик нагрузки и настроить IP-адрес.

1. Настроить серверный пул.

1. Создать пробу.

1. Настроить правила балансировки нагрузки.

>[AZURE.NOTE] Если серверы SQL Server расположены в разных группах ресурсов и регионах, необходимо выполнить все эти действия дважды, по одному разу в каждой группе ресурсов.

## 1\. Создание балансировщика нагрузки и настройка IP-адреса

Сначала необходимо создать балансировщик нагрузки. На портале Azure откройте группу ресурсов, в которой содержатся виртуальные машины SQL Server. В колонке группы ресурсов щелкните **Добавить**.

- Найдите **балансировщик нагрузки**. В результатах поиска выберите **Балансировщик нагрузки**, опубликованный корпорацией **Майкрософт**.

- В колонке **Балансировщик нагрузки** щелкните **Создать**.

- В колонке **Create load balancer** (Создание балансировщика нагрузки) настройте балансировщик, задав следующие параметры:

| Настройка | Значение |
| ----- | ----- |
| **Имя** | Текст, представляющий имя балансировщика нагрузки. Например, **sqlLB**. |
| **Схема** | **Внутренний** |
| **Виртуальная сеть** | Выберите виртуальную сеть, в которой расположены серверы SQL Server. |
| **Подсеть** | Выберите подсеть, в которой расположены серверы SQL Server. |
| **Подписка** | Это поле может появиться, если у вас несколько подписок. Выберите подписку, которую требуется связать с этим ресурсом. Как правило, это та же подписка, с которой связаны все ресурсы для группы доступности. |
| **Группа ресурсов** | Выберите группу ресурсов, в которой расположены серверы SQL Server. | 
| **Расположение** | Выберите расположение Azure, в котором находятся серверы SQL Server. |

- Щелкните **Создать**. 

Azure создаст балансировщик нагрузки с заданными параметрами. Балансировщик нагрузки относится к конкретной сети, подсети, группе ресурсов и расположению. После создания балансировщика нагрузки проверьте его параметры в Azure.

Затем настройте IP-адрес балансировщика нагрузки.

- В колонке **Параметры** для балансировщика нагрузки щелкните **IP-адрес**. В колонке **IP-адрес** показано, что это частный балансировщик нагрузки, который относится к той же виртуальной сети, что и ваши серверы SQL Server. 

- Задайте следующие параметры:

| Настройка | Значение |
| ----- | ----- |
| **Подсеть** | Выберите подсеть, в которой расположены серверы SQL Server. |
| **Назначение** | **Статическое** |
| **IP-адрес** | Введите неиспользуемый виртуальный IP-адрес из подсети. |

- Сохраните параметры.

Теперь у балансировщика нагрузки есть IP-адрес. Запишите его. Этот IP-адрес будет использоваться при создании прослушивателя в кластере. Далее вам понадобится использовать этот адрес для переменной `$ILBIP` в сценарии PowerShell.



## 2\. Настройка серверного пула

Следующий шаг — создание серверного пула адресов. В Azure серверный пул адресов называется просто *серверным пулом*. В нашем случае — это адреса двух серверов SQL Server в группе доступности.

- В группе ресурсов щелкните созданный балансировщик нагрузки. 

- В колонке **Параметры** щелкните **Серверные пулы**.

- На вкладке **Серверные пулы адресов** щелкните **Добавить**, чтобы создать серверный пул адресов.

- В колонке **Добавить внутренний пул** в поле **Имя** введите имя серверного пула.

- В разделе **Виртуальные машины** щелкните **+ Добавить виртуальную машину**.

- В разделе **Выбор виртуальных машин** щелкните **Выберите группу доступности** и укажите группу доступности, к которой принадлежат виртуальные машины SQL Server.

- Выбрав группу доступности, щелкните **Выберите виртуальные машины**. Щелкните две виртуальные машины, на которых размещены экземпляры SQL Server в группе доступности. Нажмите кнопку **Выбрать**.

- Нажмите кнопку **ОК**, чтобы закрыть колонки **Выбор виртуальных машин** и **Добавить внутренний пул**.

После этого Azure обновит параметры для серверного пула адресов. Теперь в вашей группе доступности есть пул из двух серверов SQL Server.

## 3\. Создание пробы

Теперь необходимо создать пробу. Проба представляет собой способ проверки, какому из серверов SQL Server в данный момент принадлежит прослушиватель группы доступности, в Azure. Azure будет проверять службу по IP-адресу на порте, который определяется при создании пробы.

- В колонке **Параметры** для балансировщика нагрузки щелкните **Пробы**. 

- В колонке **Пробы** щелкните **Добавить**.

- Настройте пробу в колонке **Добавление пробы**. Для настройки пробы используйте следующие значения:

| Настройка | Значение |
| ----- | ----- |
| **Имя** | Текст, представляющий имя пробы. Например, **SQLAlwaysOnEndPointProbe**. |
| **Протокол** | **TCP** |
| **Порт** | Вы можете использовать любой доступный порт. Например, *59999*. |
| **Интервал** | *5* | 
| **Пороговое значение сбоя** | *2* | 

- Нажмите кнопку **ОК**. 

>[AZURE.NOTE] Указанный порт должен быть открыт в брандмауэре обоих серверов SQL Server. Для обоих серверов требуется правило для входящего трафика используемого TCP-порта. Дополнительные сведения см. в статье [Добавление и изменение правила брандмауэра](http://technet.microsoft.com/library/cc753558.aspx).

Azure создает пробу. Она будет использоваться, чтобы проверить, на каком сервере SQL Server есть прослушиватель для группы доступности.

## 4\. Настройка правил балансировки нагрузки

Настройте правила балансировки нагрузки. Правила балансировки нагрузки определяют способ направления трафика балансировщиком нагрузки на серверах SQL Server. Для этого балансировщика нагрузки будет включен прямой ответ от сервера, так как одновременно только один из двух серверов SQL Server может содержать ресурс прослушивателя группы доступности.

- В колонке **Параметры** для балансировщика нагрузки щелкните **Правила балансировки нагрузки**. 

- В колонке **Правила балансировки нагрузки** щелкните **Добавить**.

- Используйте колонку **Add load balancing rules** (Добавление правил балансировки нагрузки), чтобы настроить правило балансировки нагрузки. Используйте следующие параметры:

| Настройка | Значение |
| ----- | ----- |
| **Имя** | Текст, представляющий имя правила балансировки нагрузки. Например, **SQLAlwaysOnEndPointListener**. |
| **Протокол** | **TCP** |
| **Порт** | *1433* |
| **Серверный порт** | *1433*. Обратите внимание, что этот порт будет отключен, так как для этого правила задан параметр **Плавающий IP-адрес (прямой ответ от сервера)**. |
| **Проба** | Используйте имя пробы, созданной для этого балансировщика нагрузки. |
| **Сохранение сеанса** | **None** | 
| **Время ожидания простоя (в минутах)** | *4* | 
| **Плавающий IP-адрес (прямой ответ от сервера)** | **Включено** | 

 >[AZURE.NOTE] Возможно, потребуется прокрутить колонку вниз, чтобы просмотреть все параметры.

- Нажмите кнопку **ОК**. 

- Azure настроит правило балансировки нагрузки. Теперь балансировщик нагрузки настроен для маршрутизации трафика на сервер SQL Server, на котором размещается прослушиватель для группы доступности.

На этом этапе группа ресурсов содержит балансировщик нагрузки, подключенный к обоим компьютерам SQL Server. Балансировщик нагрузки также содержит IP-адрес прослушивателя группы доступности AlwaysOn SQL Server. Таким образом, любой компьютер может отвечать на запросы для группы доступности.

>[AZURE.NOTE] Если серверы SQL Server находятся в разных регионах, повторите эти действия еще раз в другом регионе. Балансировщик нагрузки необходим для каждого региона.

## Настройка использования IP-адреса балансировщика нагрузки для кластера 

Теперь необходимо настроить прослушиватель в кластере и подключить его. Для этого сделайте следующее:

1. Создайте прослушиватель группы доступности в отказоустойчивом кластере. 

1. Подключение прослушивателя

## 1\. Создание прослушивателя группы доступности в отказоустойчивом кластере

На этом шаге вручную создается прослушиватель группы доступности в диспетчере отказоустойчивости кластеров и службе SQL Server Management Studio (SSMS).

- Подключитесь по протоколу RDP к виртуальной машине Azure, на которой размещена основная реплика. 

- Откройте диспетчер отказоустойчивости кластеров.

- Выберите узел **Сети** и запишите имя сети кластера. Это имя будет использоваться в переменной `$ClusterNetworkName` в сценарии PowerShell.

- Разверните имя кластера и нажмите кнопку **Роли**.

- В панели **Роли** щелкните правой кнопкой мыши имя группы доступности и выберите **Добавить ресурс** > **Точка доступа клиента**.

- В поле **Имя** создайте имя для этого нового прослушивателя, а затем щелкните дважды **Далее** и нажмите кнопку **Готово**. Не подключайте прослушивателя или ресурс на этом этапе.

 >[AZURE.NOTE] Имя для нового прослушивателя — это имя сети, которое будут использовать приложения для подключения к базам данных в группе доступности SQL Server.

- Перейдите на вкладку **Ресурсы** и разверните созданную точку доступа клиента. Щелкните правой кнопкой мыши ресурс IP-адреса и выберите пункт "Свойства". Запишите IP-адрес. Это имя будет использоваться в переменной `$IPResourceName` в сценарии PowerShell.

- В разделе **IP-адрес** щелкните **Статический IP-адрес** и установите для статического IP-адреса тот же адрес, который использовался на портале Azure при настройке IP-адреса балансировщика нагрузки. Включите протокол NetBIOS для этого адреса и нажмите кнопку **ОК**. Повторите этот шаг для каждого IP-ресурса, если решение распространяется на несколько виртуальных сетей Azure.

- В узле кластера, в котором находится основная реплика, откройте интегрированную среду сценариев PowerShell с повышенными привилегиями и вставьте в новый сценарий следующие команды:

        $ClusterNetworkName = "<MyClusterNetworkName>" # the cluster network name (Use Get-ClusterNetwork on Windows Server 2012 of higher to find the name)
        $IPResourceName = "<IPResourceName>" # the IP Address resource name
        $ILBIP = “<X.X.X.X>” # the IP Address of the Internal Load Balancer (ILB). This is the static IP address for the load balancer you configured in the Azure portal.
    
        Import-Module FailoverClusters
    
        Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"="59999";"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}

- Обновите переменные и запустите сценарий PowerShell, чтобы настроить IP-адрес и порт для нового прослушивателя.

 >[AZURE.NOTE] Если серверы SQL Server находятся в разных регионах, необходимо дважды запустить сценарий PowerShell. В первый раз используйте сетевое имя кластера, имя ресурса IP-адреса кластера и IP-адрес балансировщика нагрузки из первой группы ресурсов. Во второй раз используйте сетевое имя кластера, имя ресурса IP-адреса кластера и IP-адрес балансировщика нагрузки из второй группы ресурсов.

Теперь у кластера есть ресурс прослушивателя группы доступности.

## 2\. Подключение прослушивателя

С помощью настроенного ресурса прослушивателя группы доступности можно подключить прослушиватель, чтобы приложения могли подключаться через него к базам данных в группе доступности.

- Перейдите обратно в диспетчер отказоустойчивости кластеров. Разверните **Роли** и выделите свою группу доступности. На вкладке **Ресурсы** щелкните правой кнопкой мыши имя прослушивателя и выберите **Свойства**.

- Перейдите на вкладку **Зависимости**. Если в списке несколько ресурсов, убедитесь, что IP-адреса имеют зависимости OR, а не AND. Нажмите кнопку **ОК**.

- Щелкните правой кнопкой мыши имя прослушивателя и выберите **Подключить**.


- После подключения прослушивателя на вкладке **Ресурсы** щелкните правой кнопкой мыши группу доступности и выберите **Свойства**.

- Создайте зависимость для ресурса имени прослушивателя (не имени ресурсов IP адреса). Нажмите кнопку **ОК**.


- Запустите SQL Server Management Studio и подключитесь к основной реплике.


- Перейдите в раздел **Высокий уровень доступности AlwaysOn** | **Группы доступности** | **Прослушиватели группы доступности**.


- Теперь вы увидите имя прослушивателя, созданного в диспетчере отказоустойчивости кластеров. Щелкните правой кнопкой мыши имя прослушивателя и выберите **Свойства**.


- В поле **Порт** укажите номер порта для прослушивателя группы доступности с помощью использованного ранее параметра $EndpointPort (по умолчанию использовалось значение 1433) и нажмите кнопку **ОК**.

Теперь у вас есть группа доступности AlwaysOn SQL Server на виртуальных машинах Azure в режиме Resource Manager.

## Проверка подключения к прослушивателю

Чтобы проверить подключение:

1. Подключитесь по протоколу RDP к серверу SQL Server, который находится в той же виртуальной сети, но не содержит реплику. Это может быть другой сервер SQL Server в кластере.

1. Для проверки подключения используйте служебную программу **sqlcmd**. Например, в следующем сценарии **sqlcmd** подключается к основной реплике через прослушиватель с использованием проверки подлинности Windows:

        sqlmd -S <listenerName> -E

sqlcmd автоматически подключается к любому экземпляру SQL Server, на котором размещена основная реплика.

## Рекомендации и ограничения

Обратите внимание на следующие рекомендации относительно прослушивателя группы доступности в Azure, использующего внутренний балансировщик нагрузки Azure.

- Для одной облачной службы поддерживается только один внутренний прослушиватель группы доступности, так как он настраивается только на использование балансировщика нагрузки, а в облачной службе — только один внутренний балансировщик нагрузки. Однако можно создать несколько внешних прослушивателей. 

- С помощью внутреннего балансировщика нагрузки можно получить доступ только к прослушивателю, который находится в той же виртуальной сети.
 

<!---HONumber=AcomDC_0518_2016-->