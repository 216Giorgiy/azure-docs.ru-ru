<properties
pageTitle="Настройка локальных ресурсов хранилища в облачных службах Azure"
description=""
services="cloud-services"
documentationCenter=""
authors="cristy"
manager="timlt"
editor=""/>
<tags
ms.service="cloud-services"
ms.workload="tbd"
ms.tgt_pltfrm="na"
ms.devlang="na"
ms.topic="article"
ms.date="06/11/2015"
ms.author="cristyg"/>

# Настройка локальных ресурсов хранилища

Локальный ресурс хранилища — это зарезервированный каталог в файловой системе виртуальной машины, в которой выполняется экземпляр роли. Вы можете хранить информацию в вашем экземпляре виртуальной машины, чтобы код, исполняемый в экземпляре, мог иметь доступ к локальному ресурсу хранилища, когда необходимо выполнить запись в файл или чтение из файла. Например, локальный ресурс хранилища можно использовать для кэширования данных, которые могут потребоваться для повторного доступа, когда служба запущена в Azure. Локальный ресурс хранилища можно также настроить для хранения файлов во время запуска. Дополнительные сведения о настройке локальных ресурсов хранилища для запуска см. в разделе [Использование локального хранилища для сохранения файлов во время запуска](https://msdn.microsoft.com/library/azure/hh974419.aspx).

Локальный ресурс хранилища объявляется в файле определения службы. Можно объявить любое число локальных ресурсов хранилища для роли. Каждый локальный ресурс хранилища зарезервирован для каждого экземпляра этой роли. Минимальный объем дискового пространства, которое можно выделить для локального ресурса хранилища, составляет 1 МБ. Максимальный же объем, который можно зарезервировать для любого заданного локального ресурса, зависит от размера виртуальной машины, указанного для роли. Существует общий объем выделенного пространства, на основе которого определяется размер каждой виртуальной машины. Общий объем пространства, выделенного для всех локальных ресурсов хранилища, которые объявлены для роли, не должен превышать максимальный размер, выделенный для размера виртуальной машины. Дополнительные сведения о максимальном объеме места на локальном диске, выделенном для каждого размера виртуальной машины, см. в разделе [Настройка размеров для облачных служб](https://msdn.microsoft.com/library/azure/ee814754.aspx).

> [AZURE.NOTE]
>
-   Имейте в виду, что разработчик должен в обязательном порядке убедиться, что объем дискового пространства, который запрошен для локального ресурса хранилища, не превышает максимальный размер, выделенный для виртуальной машины. Если настроить локальный ресурс хранилища, размер которого превышает максимально допустимый, сообщение об ошибке не будет появляться до тех пор, пока вы не попытаетесь выполнить операцию записи, превышающую допустимый максимальный предел. В этом случае операция записи завершится сбоем и появится сообщение об ошибке, в котором будет указываться на нехватку дискового пространства. Модель обработки для Azure — попытка или отказ. Если появилась ошибка, в которой указывается на отсутствие места на диске, то ее можно устранить, очистив место на диске. Затем можно повторить операцию записи.
-   Можно указать, чтобы локальный ресурс хранилища пропускался при очистке экземпляра. Однако при этом не гарантируется, что данные, сохраненные в локальной файловой системе виртуальной машины, не будут затронуты. Если для роли требуются устойчивые данные, для хранения данных файлов рекомендуется использовать диск Azure. Надежность дисков Azure обеспечивается службой BLOB-объектов Azure, поэтому устойчивость хранящихся на них данных гарантирована.  
>


## Добавление локального ресурса хранилища

Чтобы объявить локальный ресурс хранилища в файле определения службы, добавьте элемент **LocalResources** в качестве дочернего в элемент **WebRole** или **WorkerRole**. Затем добавьте элемент **LocalStorage** для представления ресурса. Элемент **LocalStorage** имеет три атрибута:

-   *name*
-   *sizeInMB*: указывает желаемый размер для этого локального ресурса хранилища
-   *cleanOnRoleRecycle*: указывает, должен ли локальный ресурс хранилища очищаться при очистке экземпляра роли или сохраняться в течение всего жизненного цикла роли. Значение по умолчанию — **true**.

В следующем файле определения службы имеется два локальных ресурса хранилища, объявленных для веб-роли:

	<?xml version="1.0" encoding="utf-8"?>
    <ServiceDefinition xmlns="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition" name="MyService">
      <WebRole name="MyService_WebRole" vmsize="Medium">
        <InputEndpoints>
          <InputEndpoint name="HttpIn" port="80" protocol="http" />
        </InputEndpoints>
        <ConfigurationSettings>
          <Setting name="SimpleConfigSetting" />
        </ConfigurationSettings>
        <LocalResources>
          <LocalStorage name="localStoreOne" sizeInMB="10" />
          <LocalStorage name="localStoreTwo" sizeInMB="10" cleanOnRoleRecycle="false" />
        </LocalResources>
      </WebRole>
    </ServiceDefinition>

Дополнительные сведения о файле определения службы см. в разделе [Схема определения службы Azure (файл .csdef)](https://msdn.microsoft.com/library/azure/ee758711.aspx).

> [AZURE.NOTE]Если вы используете средство Azure для Microsoft Visual Studio, то определить локальный ресурс хранилища можно на страницах **Свойства** для роли. Дополнительные сведения см. в разделе [Настройка приложения Azure с помощью Visual Studio](https://msdn.microsoft.com/library/ee405486.aspx).

## Программный доступ к локальному ресурсу хранилища

Для доступа к локальному ресурсу хранилища приложению следует получить путь из метода [GetLocalResource](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.getlocalresource.aspx). Затем можно использовать стандартные операции с файлом для чтения и записи содержимого локального ресурса хранилища. В примере ниже показано, как выполнить чтение содержимого файла **MyTest.txt** из локального ресурса хранилища и отобразить ее на домашней странице приложения MVC 3:

    using Microsoft.WindowsAzure.ServiceRuntime;
    using System;
    using System.Text;
    using System.Web.Mvc;

    namespace StartupExercise.Controllers
    {
        public class HomeController : Controller
        {
            public ActionResult Index()
            {
                string SlsPath = RoleEnvironment.GetLocalResource("StartupLocalStorage").RootPath;

                string s = System.IO.File.ReadAllText(SlsPath + "\\MyTest.txt");

                ViewBag.Message = "Contents of MyTest.txt = " + s;

                return View();
            }
        }
    }

## Доступ к локальному ресурсу хранилища во время выполнения

В управляемой библиотеке Azure имеются классы для доступа к локальному ресурсу хранилища из кода, который выполняется в экземпляре роли. Метод [RoleEnvironment.GetLocalResource](https://msdn.microsoft.com/library/microsoft.windowsazure.serviceruntime.roleenvironment.getlocalresource.aspx) возвращает ссылку на именованный объект [LocalResource](https://msdn.microsoft.com/library/microsoft.windowsazure.serviceruntime.localresource.aspx).

Поскольку объект **LocalResource** представляет собой каталог, чтение из него и запись в этот каталог можно выполнять с помощью стандартных классов файлового ввода-вывода .NET. Чтобы определить путь к каталогу локального ресурса хранилища, используйте свойство [LocalResource.RootPath](https://msdn.microsoft.com/library/microsoft.windowsazure.serviceruntime.localresource.rootpath.aspx). Это свойство возвращает полный путь к локальному ресурсу хранилища, включая именованный каталог ресурса. Например, если служба выполняется в среде разработки, локальный ресурс хранилища определен в локальной файловой системе, а свойство **RootPath** возвратит значение следующего вида:


    C:\Users\myaccount\AppData\Local\dftmp\s0\deployment(1)\res\deployment(1).MyService.MyService_WebRole.0\directory\localStoreOne\

Если служба развернута в Azure, путь к локальному ресурсу хранилища включает идентификатор развертывания, а свойство **RootPath** возвращает значение следующего вида:


    C:\Resources\directory\f335471d5a5845aaa4e66d0359e69066.MyService_WebRole.localStoreOne\

Код, выполняемый в экземпляре роли, может получить доступ к локальному ресурсу хранилища, определенному для этой роли, с момента подключения экземпляра к сети до момента его отключения.

## Дальнейшие действия

- [Настройка облачной службы для Azure](https://msdn.microsoft.com/library/azure/hh124108.aspx)

<!---HONumber=Oct15_HO3-->