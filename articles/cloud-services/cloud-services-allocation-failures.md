<properties
	pageTitle="Устранение ошибок выделения ресурсов для облачной службы | Microsoft Azure"
	description="Устранение ошибки выделения при развертывании облачных служб в Azure"
	services="azure-service-management, cloud-services"
	documentationCenter=""
	authors="kenazk"
	manager="drewm"
	editor=""
	tags="top-support-issue"/>

<tags
	ms.service="cloud-services"
	ms.workload="na"
	ms.tgt_pltfrm="ibiza"
	ms.devlang="na"
	ms.topic="article"
	ms.date="11/04/2015"
	ms.author="kenazk"/>



# Устранение ошибки выделения при развертывании облачных служб в Azure

## Сводка
При развертывании экземпляров в облачной службе или добавлении новых экземпляров веб-узлов или рабочих ролей Microsoft Azure выделяет вычислительные ресурсы. Иногда во время выполнения этих операций могут возникать ошибки, даже если еще не достигнуты ограничения подписки Azure. В этой статье объясняются причины возникновения некоторых распространенных ошибок выделения, а также представлены возможные способы их устранения. Эта информация также может быть полезна при планировании развертывания служб.

Если на любом этапе изучения этой статьи вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](http://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт службы поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**.

### Общая информация — принцип выделения ресурсов
Серверы в центрах обработки данных Azure разделены на кластеры. Запрос о выделении новой облачной службы отправляется в несколько кластеров. Когда первый экземпляр развертывается в облачной службе (в тестовой или рабочей области), эта облачная служба прикрепляется к кластеру. Все последующие развертывания облачной службы выполняются в том же кластере. В этой статье мы будем называть этот процесс прикреплением к кластеру. На приведенной ниже схеме 1 показано, как обычно происходит выделение при попытке выполнения в нескольких кластерах. На схеме 2 показано выделение ресурсов, прикрепленное к кластеру 2, так как в нем размещена существующая облачная служба CS\_1.

![Схема выделения ресурсов](./media/cloud-services-allocation-failure/Allocation1.png)

### Причины возникновения ошибок выделения ресурсов
Если запрос на выделение прикреплен к одному кластеру, возрастает вероятность того, что не удастся найти свободные ресурсы, так как пул доступных ресурсов ограничен размером кластера. Кроме того, если запрос на выделение прикреплен к одному кластеру, а тип запрошенного ресурса не поддерживается, запрос завершится ошибкой, даже если в кластере есть свободные ресурсы. На схеме 3 ниже показан случай, когда ошибка выделения прикрепленных ресурсов произошла из-за отсутствия свободных ресурсов в единственном подходящем кластере. На схеме 4 показан случай, когда ошибка выделения прикрепленных ресурсов произошла потому, что единственный подходящий кластер не поддерживает запрошенный размер виртуальной машины, несмотря на наличие свободных ресурсов в кластере.

![Ошибка выделения прикрепленных ресурсов](./media/cloud-services-allocation-failure/Allocation2.png)

## Устранение ошибок выделения для облачных служб
### Сообщение об ошибке
Вы можете получить следующее сообщение об ошибке:

	"Azure operation '{operation id}' failed with code Compute.ConstrainedAllocationFailed. Details: Allocation failed; unable to satisfy constraints in request. The requested new service deployment is bound to an Affinity Group, or it targets a Virtual Network, or there is an existing deployment under this hosted service. Any of these conditions constrains the new deployment to specific Azure resources. Please retry later or try reducing the VM size or number of role instances. Alternatively, if possible, remove the aforementioned constraints or try deploying to a different region."

### Распространенные проблемы
В этом разделе описаны распространенные сценарии выделения ресурсов, вызывающие прикрепление запросов о распределении к отдельному кластеру.

- Развертывание в промежуточном слоте. Если в одном из слотов облачной службы имеется развертывание, вся облачная служба прикрепляется к определенному кластеру. Это означает, что если развертывание уже существует в рабочей области, то новое промежуточное развертывание может быть выделено только в том же кластере, что и рабочая область. Если кластер близок к заполнению, запрос может завершиться ошибкой. 
 
- Масштабирование. Для добавления новых экземпляров в существующую облачную службу требуется выделение ресурсов в том же кластере. Для мелких запросов масштабирования ресурсы обычно выделяются, но это происходит не всегда. Если кластер близок к заполнению, запрос может завершиться ошибкой.
	
- Территориальная группа. Если облачная служба не прикреплена ни к какой территориальной группе, структура может распределить новое развертывание в пустую облачную службу в любом кластере соответствующего региона. По возможности развертывания в одну и ту же территориальную группу будут выполняться в одном и том же кластере. Если кластер близок к заполнению, запрос может завершиться ошибкой.
	
- Территориальная группа vNet. Раньше виртуальные сети привязывались не к регионам, а к территориальным группам, а облачные службы в этих виртуальных сетях — к кластеру территориальной группы. По возможности развертывания в виртуальную сеть такого типа будут выполняться в связанном кластере. Если кластер близок к заполнению, запрос может завершиться ошибкой.

## Решения

1. Повторное развертывание в новую облачную службу. Данное решение, как правило, является самым удачным, поскольку позволяет платформе выбрать все кластеры в соответствующем регионе.
	
	- Разверните рабочую нагрузку в новую облачную службу.  
	
	- Обновите запись CNAME или A таким образом, чтобы она направляла трафик в новую облачную службу.
		
	- После того как трафик, направляемый на старый сайт, станет нулевым, старую облачную службу можно будет удалить. В этом случае время простоя должно быть нулевым.

2. Удалите рабочий и промежуточный слоты. Данное решение позволяет сохранить существующее имя DNS, но вызывает простой приложения.
	
	- Удалите рабочий и промежуточный слоты существующей облачной службы, чтобы облачная служба стала пустой. 
	
	- Создайте в существующей облачной службе новое развертывание. Оно попытается заново распределить все кластеры в регионе. Убедитесь, что облачная служба не привязана к территориальной группе.

3. Зарезервированный IP-адрес. Данное решение позволяет сохранить существующий IP-адрес, но вызывает простой приложения.
	
	- Создайте адрес ReservedIP для существующего развертывания с помощью Powershell. 

	```
	New-AzureReservedIP -ReservedIPName {new reserved IP name} -Location {location} -ServiceName {existing service name}
	```
		
	- Выполните описанный выше пункт 2 и убедитесь, что в CSCFG службы указан новый адрес ReservedIP.

4. Удалите территориальную группу для новых развертываний. Использовать территориальные группы больше не рекомендуются. Выполните описанный выше пункт 1, чтобы развернуть новую облачную службу. Убедитесь, что облачная служба не входит в территориальную группу.

5. Выполните преобразование в региональную виртуальную сеть: см. статью [Переход от территориальных групп к региональной виртуальной сети](https://azure.microsoft.com/documentation/articles/virtual-networks-migrate-to-regional-vnet/).

## Дополнительные ресурсы
### Обращение в службу поддержки клиентов Azure

Если эта статья не помогла решить проблему с Azure, см. форумы Azure на сайтах [MSDN и Stack Overflow](http://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение с проблемой в службу поддержки Azure. Перейдите на [веб-сайт службы поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните "Получить поддержку". Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](http://azure.microsoft.com/support/faq/).

<!---HONumber=Nov15_HO4-->