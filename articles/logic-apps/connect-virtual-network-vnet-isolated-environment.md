---
title: Подключение к виртуальным сетям Azure из Azure Logic Apps через среду службы интеграции (ISE)
description: Создайте среду службы интеграции (ISE), чтобы приложения логики и учетные записи интеграции могли получать доступ к виртуальным сетям Azure, оставаясь при этом частными и изолированными от общедоступной ("глобальной") среды Azure
services: logic-apps
ms.service: logic-apps
ms.suite: integration
author: ecfan
ms.author: estfan
ms.reviewer: klam, LADocs
ms.topic: article
ms.date: 02/12/2019
ms.openlocfilehash: 8d7fc6d8f581c3ad0e0f3266ea615acadcb7bc25
ms.sourcegitcommit: 301128ea7d883d432720c64238b0d28ebe9aed59
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2019
ms.locfileid: "56176209"
---
# <a name="connect-to-azure-virtual-networks-from-azure-logic-apps-by-using-an-integration-service-environment-ise"></a>Подключение к виртуальным сетям Azure из Azure Logic Apps с помощью среды службы интеграции (ISE)

> [!NOTE]
> Эта возможность находится на этапе *закрытой предварительной версии*. Чтобы присоединиться к использованию закрытой предварительной версии, [создайте заявку здесь](https://aka.ms/iseprivatepreview).

Для сценариев, в которых приложениям логики и учетным записям интеграции требуется доступ к [виртуальной сети Azure](../virtual-network/virtual-networks-overview.md), создайте [*среду службы интеграции*](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md). Среда службы интеграции является частной и изолированной средой, которая использует выделенное хранилище и другие ресурсы, хранимые отдельно от общедоступной "глобальной" службы Logic Apps. Такое разделение помогает уменьшить любое влияние других клиентов Azure на производительность вашего приложения. Среда службы интеграции *внедряется* в виртуальную сеть Azure и развертывает службу Logic Apps в вашей виртуальной сети. При создании приложений логики и учетных записей интеграции выберите эту среду службы интеграции в качестве их расположения. После этого приложение логики или учетная запись интеграции смогут напрямую получать доступ к ресурсам в виртуальной сети, таким как виртуальные машины, серверы, системы и службы.

![Выбор среды службы интеграции](./media/connect-virtual-network-vnet-isolated-environment/select-logic-app-integration-service-environment.png)

В этой статье показано, как выполнять следующие задачи:

* настраивать порты в виртуальной сети Azure для передачи трафика через среду службы интеграции (ISE) в подсетях в виртуальной сети;

* настраивать разрешения в виртуальной сети Azure для того, чтобы частные экземпляры Logic Apps могли получать доступ к ней;

* создавать среду службы интеграции;

* создавать приложение логики, которое может выполняться в среде службы интеграции;

* создавать учетную запись интеграции для приложений логики в среде службы интеграции.

Дополнительные сведения о средах службы интеграции см. в статье [Доступ к ресурсам виртуальных сетей Azure из Azure Logic Apps с использованием сред службы интеграции (ISE)](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md).

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, <a href="https://azure.microsoft.com/free/" target="_blank">зарегистрируйтесь для получения бесплатной учетной записи Azure</a>.

  > [!IMPORTANT]
  > Приложения логики, встроенные действия и соединители, которые выполняются в среде ISE, используют другой ценовой план, который не основан на потреблении. Дополнительные сведения см. на странице с [ценами на Logic Apps](../logic-apps/logic-apps-pricing.md).

* [Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md). Если у вас нет виртуальной сети, узнайте, [как ее создать](../virtual-network/quick-create-portal.md). Также для развертывания среды службы интеграции вам потребуются подсети в виртуальной сети. Эти подсети вы можете создать заранее или одновременно с созданием среды службы интеграции. Также [убедитесь, что в виртуальной сети предоставляются нужные порты](#ports), чтобы среда службы интеграции работала правильно и оставалась доступной.

* Чтобы предоставить приложениям логики прямой доступ к виртуальной сети Azure, [настройте в сети разрешения управления доступом на основе ролей (RBAC)](#vnet-access), которые позволят службе Logic Apps получать доступ к виртуальной сети.

* Чтобы использовать один или несколько пользовательских DNS-серверов для развертывания виртуальной сети Azure, [настройте такие серверы по инструкциям из этого руководства](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md), прежде чем развертывать среду службы интеграции в виртуальной сети. Иначе при каждом изменении DNS-сервера вам придется перезагружать среду службы интеграции. Такая возможность доступна в общедоступной предварительной версии среды службы интеграции.

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

<a name="ports"></a>

## <a name="set-up-network-ports"></a>Настройка сетевых портов

Чтобы среда службы интеграции работала правильно и оставалась доступной, ей должны быть доступны определенные порты в виртуальной сети. Если любой из этих портов будет недоступен, вы можете потерять доступ к среде службы интеграции и она может перестать работать. Когда вы используете среду службы интеграции в виртуальной сети, часто возникает проблема с блокировкой одного или нескольких нужных портов. Кроме того, дополнительные требования к портам могут быть у соединителя, который используется для подключений между средой службы интеграции и целевой системой. Например, если для связи с системой FTP вы используете соединитель FTP, убедитесь в доступности порта, который нужен для этой системы FTP (обычно это порт 21).

Чтобы контролировать входящий и исходящий трафик между подсетями виртуальной сети, в которых вы развернули среду выполнения интеграции, вы можете настроить для этих подсетей [группы безопасности сети](../virtual-network/security-overview.md) в соответствии с инструкциями по [фильтрации сетевого трафика между подсетями](../virtual-network/tutorial-filter-network-traffic.md). В этих таблицах указаны порты, которые среда службы интеграции использует в виртуальной сети, и описано их назначение. Звездочка (*) обозначает все источники трафика. [Тег службы](../virtual-network/security-overview.md#service-tags) обозначает группу префиксов IP-адресов. Это упрощает создание правил безопасности.

| Назначение | Направление | Исходный порт <br>Конечный порт | Тег службы источника <br>Тег целевой службы |
|---------|-----------|---------------------------------|-----------------------------------------------|
| Поток данных в Azure Logic Apps <br>Поток данных из Azure Logic Apps | Входящий трафик <br>Исходящие | * <br>80 и 443 | ИНТЕРНЕТ <br>VIRTUAL_NETWORK |
| Azure Active Directory | Исходящие | * <br>80 и 443 | VIRTUAL_NETWORK <br>AzureActiveDirectory |
| Зависимость от службы хранилища Azure | Исходящие | * <br>80 и 443 | VIRTUAL_NETWORK <br>Хранилище |
| Управление соединениями | Исходящие | * <br>443 | VIRTUAL_NETWORK <br>ИНТЕРНЕТ |
| Публикация журналов диагностики и метрик | Исходящие | * <br>443 | VIRTUAL_NETWORK <br>AzureMonitor |
| Конструктор Logic Apps — динамические свойства <br>Журнал выполнений приложения логики <br>Развертывание соединителя <br>Конечная точка триггера запроса | Входящий трафик | * <br>454 | ИНТЕРНЕТ <br>VIRTUAL_NETWORK |
| Зависимость от управления службой приложений | Входящий трафик | * <br>454 и 455 | AppServiceManagement <br>VIRTUAL_NETWORK |
| Управление API — конечная точка управления | Входящий трафик | * <br>3443 | APIManagement <br>VIRTUAL_NETWORK |
| Зависимость от политики передачи журнала в концентратор событий и от агента мониторинга | Исходящие | * <br>5672 | VIRTUAL_NETWORK <br>концентратор событий. |
| Доступ к экземплярам кэша Azure для Redis между экземплярами ролей | Входящий трафик <br>Исходящие | * <br>6381–6383 | VIRTUAL_NETWORK <br>VIRTUAL_NETWORK |
|||||

<a name="vnet-access"></a>

## <a name="set-virtual-network-permissions"></a>Настройка разрешений виртуальной сети

При создании среды службы интеграции нужно выбрать виртуальную сеть Azure, в которую будет *внедряться* эта среда. Но для того чтобы виртуальную сеть можно было выбрать, в ней необходимо настроить разрешения управления доступом на основе ролей. Чтобы задать такие разрешения, назначьте службе Azure Logic Apps следующие роли.

1. На [портале Azure](https://portal.azure.com) найдите и выберите виртуальную сеть.

1. В меню виртуальной сети выберите **Управление доступом (IAM)**.

1. В разделе **Управление доступом (IAM)** выберите **Добавить назначение роли**.

   ![Добавление ролей](./media/connect-virtual-network-vnet-isolated-environment/set-up-role-based-access-control-vnet.png)

1. На панели **Добавить назначение роли** добавьте нужные роли для службы Azure Logic Apps, как описано здесь.

   1. В поле **Роль** выберите значение **Участник сетей**.

   1. В поле **Назначение доступа к** выберите **Пользователь, группа или субъект-служба Azure AD**.

   1. В поле **Выбрать** введите **Azure Logic Apps**.

   1. Когда появится список участников, еще раз выберите **Azure Logic Apps**.

      > [!TIP]
      > Если найти эту службу не удается, введите идентификатор приложения службы Logic Apps: `7cd684f4-8a78-49b0-91ec-6a35d38739ba`.

   1. Когда все будет готово, нажмите **Сохранить**.

   Например: 

   ![Добавление назначения роли](./media/connect-virtual-network-vnet-isolated-environment/add-contributor-roles.png)

Подробные сведения см. в разделе [Разрешения для доступа к виртуальной сети](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md).

<a name="create-environment"></a>

## <a name="create-your-ise"></a>Создание среды службы интеграции

Чтобы создать среду службы интеграции, выполните следующие действия:

1. На [портале Azure](https://portal.azure.com) в главном меню Azure выберите **Создать ресурс**.

   ![Создание ресурса](./media/connect-virtual-network-vnet-isolated-environment/find-integration-service-environment.png)

1. В поле поиска введите "среда службы интеграции" в качестве фильтра.
Выберите в списке результатов **Integration Service Environment (preview)** (Среда службы интеграции (предварительная версия)), а затем нажмите кнопку **Создать**.

   ![Выбор пункта "Среда службы интеграции"](./media/connect-virtual-network-vnet-isolated-environment/select-integration-service-environment.png)

   ![Нажатие кнопки "Создать"](./media/connect-virtual-network-vnet-isolated-environment/create-integration-service-environment.png)

1. Укажите следующие сведения для своей среды, а затем выберите **Просмотр и создание**, как показано здесь:

   ![Предоставление сведений о среде](./media/connect-virtual-network-vnet-isolated-environment/integration-service-environment-details.png)

   | Свойство | Обязательно | Value | ОПИСАНИЕ |
   |----------|----------|-------|-------------|
   | **Подписка** | Yes | <*Azure-subscription-name*> | Подписка Azure, используемая для среды. |
   | **Группа ресурсов** | Yes | <*имя_группы_ресурсов_Azure*> | Группа ресурсов Azure, в которой необходимо создать среду. |
   | **Имя среды службы интеграции** | Yes | <*имя_среды*> | Имя, которое будет присвоено среде. |
   | **Местоположение.** | Yes | <*регион_центра_обработки_данных_Azure*> | Регион центра обработки данных Azure, в котором нужно развернуть среду. |
   | **Дополнительная емкость** | Yes | 0, 1, 2, 3 | Число единиц обработки, которые нужно применить для этого ресурса среды службы интеграции |
   | **Виртуальная сеть** | Yes | <*имя_виртуальной_сети_Azure*> | Виртуальная сеть Azure, в которую нужно внедрить среду, чтобы приложения логики в этой среде могли получить доступ к виртуальной сети. Если у вас нет сети, здесь можно создать ее. <p>**Важно!** Внедрение среды службы интеграции можно выполнить *только* при ее создании. Кроме того, перед созданием такой связи убедитесь, что вы уже [настроили управление доступом на основе ролей в виртуальной сети для Azure Logic Apps](#vnet-access). |
   | **Подсети** | Yes | <*subnet-resource-list*> | Среде службы интеграции требуется четыре *пустых* подсети для создания ресурсов в среде. Поэтому убедитесь, что эти подсети *не делегированы* в какую-либо службу. После создания среды вы *не можете изменить* эти адреса подсети. <p><p>Для создания каждой подсети [выполните действия, описанные в этой таблице](#create-subnet). Каждая подсеть должна соответствовать следующим критериям: <p>— Должна быть пустой. <br>– Используемое имя не должно начинаться с цифры или дефиса. <br>— Использует формат [Бесклассовая адресация](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing) и пространство адресов класса B. <br>— Включает по крайней мере `/27` в пространстве адресов, поэтому подсеть получает как минимум 32 адреса. Сведения о том, как рассчитать количество адресов, см. в разделе о блоках CIDR IPv4[здесь](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks). Например:  <p>- `10.0.0.0/24` содержит 256 адресов, потому что 2<sup>(32–24)</sup> равно 2<sup>8</sup> или 256. <br>- `10.0.0.0/27` содержит 32 адреса, потому что 2<sup>(32-27)</sup> равно 2<sup>5</sup> или 32. <br>- `10.0.0.0/28` содержит только 16 адресов, потому что 2<sup>(32-28)</sup> равно 2<sup>4</sup> или 16. |
   |||||

   <a name="create-subnet"></a>

   **Создание подсети**

   1. В списке **Подсети** выберите **Управление конфигурацией подсети**.

      ![Управление конфигурацией подсети](./media/connect-virtual-network-vnet-isolated-environment/manage-subnet.png)

   1. На панели **Подсети** выберите **Подсеть**.

      ![Добавление подсети](./media/connect-virtual-network-vnet-isolated-environment/add-subnet.png)

   1. На панели **Добавить подсеть** введите следующие сведения.

      * **Имя**. Имя для этой подсети.
      * **Диапазон адресов (блок CIDR)**. Диапазон адресов для подсети в виртуальной сети, выраженный в формате CIDR.

      ![Добавление сведений о подсети](./media/connect-virtual-network-vnet-isolated-environment/subnet-details.png)

   1. Когда все будет готово, нажмите кнопку **ОК**.

   1. Повторите эти шаги еще для трех подсетей.

1. После того как Azure успешно проверит данные для среды службы интеграции, щелкните **Создать**, как показано здесь:

   ![После успешной проверки щелкните "Создать"](./media/connect-virtual-network-vnet-isolated-environment/ise-validation-success.png)

   Azure начнет развертывание среды. Выполнение этого процесса *может* занять до двух часов. 
   Чтобы проверить состояние развертывания, на панели инструментов Azure выберите значок уведомлений, который открывает область уведомлений.

   ![Проверка состояния развертывания](./media/connect-virtual-network-vnet-isolated-environment/environment-deployment-status.png)

   Если развертывание будет успешно завершено, в Azure отобразится следующее уведомление:

   ![Развертывание выполнено](./media/connect-virtual-network-vnet-isolated-environment/deployment-success.png)

   > [!NOTE]
   > Если развертывание завершится ошибкой или вы удалите среду службы интеграции, освобождение подсетей в Azure *может* занять до одного часа. Это означает, что вы не сможете сразу применить эти подсети для другой среды службы интеграции.

1. Если Azure не перейдет автоматически к вашей среде после завершения развертывания, выберите **Перейти к ресурсу**, чтобы просмотреть среду.  

<a name="create-logic-apps-environment"></a>

## <a name="create-logic-app---ise"></a>Создание приложения логики, использующего среду службы интеграции

Чтобы создать приложения логики, использующие среду службы интеграции, выполните действия из статьи [Краткое руководство. Создание первого автоматизированного рабочего процесса с помощью Azure Logic Apps на портале Azure](../logic-apps/quickstart-create-first-logic-app-workflow.md), внеся в них небольшие коррективы: 

* При создании приложения логики для свойства **Расположение** выберите созданную среду службы интеграции в разделе **Среды службы интеграции**, как показано здесь:

  ![Выбор среды службы интеграции](./media/connect-virtual-network-vnet-isolated-environment/create-logic-app-with-integration-service-environment.png)

* Вы можете использовать те же встроенные триггеры и действия, в том числе для HTTP, которые выполняются в одной среде службы интеграции с приложением логики. Соединители с меткой **ISE** также выполняются в одной среде службы интеграции с приложением логики. Соединители без надписи **ISE** выполняются в глобальной службе Logic Apps.

  ![Выбор соединителей ISE](./media/connect-virtual-network-vnet-isolated-environment/select-ise-connectors.png)

* После внедрения среды службы интеграции в виртуальную сеть Azure приложения логики из этой среды смогут напрямую получать доступ к ресурсам в этой виртуальной сети. Для локальных систем, подключенных к виртуальной сети, внедрите среду службы интеграции в эту виртуальную сеть, чтобы приложения логики могли напрямую обращаться к этим системам через любой из указанных ниже элементов: 

  * Соединитель среды ISE для этой системы, например SQL Server
  
  * Действие HTTP 
  
  * Настраиваемый соединитель

  В локальных системах, которые не входят в виртуальную сеть или не имеют соединителей среды службы интеграции, подключение возможно после [настройки локального шлюза данных](../logic-apps/logic-apps-gateway-install.md).

<a name="create-integration-account-environment"></a>

## <a name="create-integration-account---ise"></a>Создание учетной записи интеграции для среды службы интеграции

Чтобы использовать учетную запись интеграции с приложениями логики в среде службы интеграции (ISE), эта учетная запись должна использовать *ту же среду*, что и приложения логики. Приложения логики в среде ISE могут ссылаться только на учетные записи интеграции, которые находятся в одной с ними среде ISE. 

Чтобы создать учетную запись интеграции, которая использует ISE, выполните действия из статьи [Создание и администрирование учетных записей интеграции для решений B2B в приложениях логики](../logic-apps/logic-apps-enterprise-integration-create-integration-account.md), кроме действий для свойства **Расположение**, в котором теперь появится раздел **Среды службы интеграции**. Выберите в этом разделе свою среду службы интеграции, а не регион, как показано здесь:

![Выбор среды службы интеграции](./media/connect-virtual-network-vnet-isolated-environment/create-integration-account-with-integration-service-environment.png)

## <a name="get-support"></a>Получение поддержки

* Если у вас возникли вопросы, то посетите <a href="https://social.msdn.microsoft.com/Forums/en-US/home?forum=azurelogicapps" target="_blank">форум Azure Logic Apps</a>.
* Отправить идею по поводу возможности или проголосовать за нее вы можете на <a href="https://aka.ms/logicapps-wish" target="_blank">сайте отзывов пользователей Logic Apps</a>.

## <a name="next-steps"></a>Дополнительная информация

* Узнайте больше о [виртуальной сети Azure](../virtual-network/virtual-networks-overview.md).
* Узнайте об [интеграции виртуальной сети для служб Azure](../virtual-network/virtual-network-for-azure-services.md).
