---
title: "Циклы. Обработка массивов или повторение действий в Azure Logic Apps | Документация Майкрософт"
description: "Обработка массивов с помощью циклов for each или повторение действий до выполнения определенных условий в приложениях логики."
services: logic-apps
keywords: "Циклы for each"
documentationcenter: 
author: ecfan
manager: anneta
editor: 
ms.assetid: 75b52eeb-23a7-47dd-a42f-1351c6dfebdc
ms.service: logic-apps
ms.workload: logic-apps
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/05/2018
ms.author: estfan; LADocs
ms.openlocfilehash: f634b1004fef2eb65c6b8134088ceead47c91890
ms.sourcegitcommit: 0b02e180f02ca3acbfb2f91ca3e36989df0f2d9c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2018
---
# <a name="loops-process-arrays-or-repeat-actions-until-a-condition-is-met"></a>Циклы. Обработка массивов или повторение действий до выполнения условия

Чтобы выполнить итерацию массивов в приложении логики, используйте [цикл for each](#foreach-loop) или [последовательный цикл for each](#sequential-foreach-loop). В стандартном цикле for each повторяемые операции выполняются параллельно, а в последовательном цикле for each — по одной за раз. Максимальное число элементов массива, которое циклы for each позволяют обработать в одном приложении логики, см. в статье [Ограничения и настройка Logic Apps](../logic-apps/logic-apps-limits-and-config.md). 

> [!TIP] 
> Если есть триггер, который получает массив, и нужно запустить рабочий процесс для каждого элемента массива, вы можете выполнить *индивидуальную обработку* этого массива с помощью [свойства **SplitOn** триггера](../logic-apps/logic-apps-workflow-actions-triggers.md#split-on-debatch). 
  
Чтобы повторять действия до выполнения условия или изменения определенного состояния, используйте цикл [until](#until-loop). Сначала приложение логики выполняет все действия в цикле, а затем проверяет условие. Если условие выполнено, цикл прекращается. В противном случае он повторяется. Максимальное число циклов until, которое можно выполнить за один запуск приложения логики, см. в статье [Ограничения и настройка Logic Apps](../logic-apps/logic-apps-limits-and-config.md). 

## <a name="prerequisites"></a>предварительным требованиям

* Подписка Azure. Если у вас нет ее, вы можете [зарегистрироваться для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/). 

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

<a name="foreach-loop"></a>

## <a name="foreach-loop"></a>Цикл for each

Чтобы повторять действия для каждого элемента в массиве, используйте цикл for each в рабочем процессе приложения логики. В этот цикл можно добавить несколько действий, а также вложить один цикл for each в другой. По умолчанию в стандартном цикле for each повторяемые операции выполняются параллельно. Максимальное число параллельных операций, которые циклы for each могут выполнить, см. в статье [Ограничения и настройка Logic Apps](../logic-apps/logic-apps-limits-and-config.md).

> [!NOTE] 
> Цикл for each применяется только для массива, а действия в цикле используют ссылку `@item()` для обработки каждого элемента в массиве. Если указать данные, которых нет в массиве, рабочий процесс приложения логики завершится ошибкой. 

Например, это приложение логики отправляет ежедневную сводку из RSS-канала веб-сайта. Оно использует цикл for each, который отправляет сообщение электронной почты для каждого нового элемента.

1. [Создайте этот пример приложения логики](../logic-apps/quickstart-create-first-logic-app-workflow.md), используя учетную запись Outlook.com или Office 365 Outlook.

2. Добавьте цикл for each между триггером RSS и действием отправки сообщения. 

   Чтобы добавить цикл между шагами, наведите указатель мыши на стрелку, где нужно добавить цикл. 
   Щелкните появившийся **знак "плюс"** (**+**), а затем выберите **Добавить цикл for each**.

   ![Добавление цикла for each между шагами](media/logic-apps-control-flow-loops/add-for-each-loop.png)

3. Теперь создайте цикл. В поле **Выберите выходные данные из предыдущих шагов**, когда отобразится список **Добавить динамическое содержимое**, выберите массив **Ссылки веб-канала**, который представляет выходные данные триггера RSS. 

   ![Выбор из списка динамического содержимого](media/logic-apps-control-flow-loops/for-each-loop-dynamic-content-list.png)

   > [!NOTE] 
   > Можно выбрать *только* выходные данные массива из предыдущего шага.

   Отобразится выбранный массив, как показано ниже:

   ![Выбор массива](media/logic-apps-control-flow-loops/for-each-loop-select-array.png)

4. Чтобы выполнить действие с каждым элементом массива, перетащите действие **Отправить сообщение** в цикл **for each**. 

   Ваше приложения логики может выглядеть так:

   ![Добавление шагов в цикл for each](media/logic-apps-control-flow-loops/for-each-loop-with-step.png)

5. Сохраните приложение логики. Чтобы вручную проверить приложение логики, на панели инструментов конструктора щелкните **Запустить**.

<a name="for-each-json"></a>

## <a name="foreach-loop-definition-json"></a>Определение цикла for each (JSON)

При работе в представлении кода для приложения логики вы можете в качестве альтернативы определить цикл `Foreach` в определении JSON приложения логики, как показано ниже.

``` json
"actions": {
    "myForEachLoopName": {
        "type": "Foreach",
        "actions": {
            "Send_an_email": {
                "type": "ApiConnection",
                "inputs": {
                    "body": {
                        "Body": "@{item()}",
                        "Subject": "New CNN post @{triggerBody()?['publishDate']}",
                        "To": "me@contoso.com"
                    },
                    "host": {
                        "api": {
                            "runtimeUrl": "https://logic-apis-westus.azure-apim.net/apim/office365"
                        },
                        "connection": {
                            "name": "@parameters('$connections')['office365']['connectionId']"
                        }
                    },
                    "method": "post",
                    "path": "/Mail"
                },
                "runAfter": {}
            }
        },
        "foreach": "@triggerBody()?['links']",
        "runAfter": {},
    }
},
```

<a name="sequential-foreach-loop"></a>

## <a name="foreach-loop-sequential"></a>Последовательный цикл for each

По умолчанию каждая повторяемая операция в цикле for each выполняется параллельно для каждого элемента массива. Чтобы все операции выполнялись последовательно, установите параметр **Последовательный** в цикле for each.

1. В правом верхнем углу области цикла выберите **многоточие** (**...**) > **Параметры**.

   ![Выбор "..." > "Параметры" в области цикла for each](media/logic-apps-control-flow-loops/for-each-loop-settings.png)

2. Включите параметр **Последовательный** и нажмите кнопку **Готово**.

   ![Включение параметра "Последовательный" для цикла for each](media/logic-apps-control-flow-loops/for-each-loop-sequential-setting.png)

Можно также задать для параметра **operationOptions** значение `Sequential` в определении JSON приложения логики. Например: 

``` json
"actions": {
    "myForEachLoopName": {
        "type": "Foreach",
        "actions": {
            "Send_an_email": {               
            }
        },
        "foreach": "@triggerBody()?['links']",
        "runAfter": {},
        "operationOptions": "Sequential"
    }
},
```

<a name="until-loop"></a>

## <a name="until-loop"></a>Цикл until
  
Чтобы повторять действия, пока не выполнится условие или не изменится определенное состояние, используйте цикл until в рабочем процессе приложения логики. Вот несколько распространенных вариантов использования цикла until:

* Вызов конечной точки до получения нужного ответа.
* Создайте запись в базе данных, дождитесь утверждения определенного поля в этой записи и продолжите обработку. 

> [!NOTE]
> Циклы until не могут включать циклы for each или другие циклы until.

Например, каждый день в 8:00 это приложение логики увеличивает значение переменной, пока оно не станет равно 10. Затем приложение логики отправляет сообщение электронной почты с подтверждением текущего значения. Хотя этот пример используется в Office 365 Outlook, его можно применять для любого поставщика услуг электронной почты, поддерживаемого Logic Apps ([см. список соединителей](https://docs.microsoft.com/connectors/)). Если вы используете другую учетную запись электронной почты, общие шаги те же, но пользовательский интерфейс может немного отличаться. 

1. Создание пустого приложения логики. В конструкторе приложений логики выполните поиск по слову "повторение" и выберите триггер **Расписание — повторение**. 

   ![Добавление триггера "Расписание — повторение"](./media/logic-apps-control-flow-loops/do-until-loop-add-trigger.png)

2. Укажите, когда должен срабатывать этот триггер, задав интервал, частоту и час дня. Чтобы указать час выберите **Показать дополнительные параметры**.

   ![Добавление триггера "Расписание — повторение"](./media/logic-apps-control-flow-loops/do-until-loop-set-trigger-properties.png)

   | Свойство | Значение |
   | -------- | ----- |
   | **Интервал** | 1 | 
   | **Frequency** | День |
   | **В эти часы** | 8 |
   ||| 

3. В разделе триггера выберите **Новый шаг** > **Добавить действие**. Выполните поиск по слову "переменные" и выберите действие **Переменные — инициализировать переменную**.

   ![Добавление действия "Переменные — инициализировать переменную"](./media/logic-apps-control-flow-loops/do-until-loop-add-variable.png)

4. Задайте для переменной следующие значения:

   ![Определение свойств переменной](./media/logic-apps-control-flow-loops/do-until-loop-set-variable-properties.png)

   | Свойство | Значение | ОПИСАНИЕ |
   | -------- | ----- | ----------- |
   | **Имя** | Ограничение | Имя переменной | 
   | **Тип** | Целое число  | Тип данных переменной | 
   | **Значение** | 0 | Начальное значение переменной | 
   |||| 

5. В разделе действия **Инициализировать переменную** выберите **Новый шаг** > **Дополнительно**. Выберите цикл **Добавить do until**.

   ![Добавление цикла do until](./media/logic-apps-control-flow-loops/do-until-loop-add-until-loop.png)

6. Создайте условие выхода из цикла. Для этого выберите переменную **Limit** и оператор **is equal**. Введите **10** в качестве значения для сравнения.

   ![Создание условия выхода для завершения цикла](./media/logic-apps-control-flow-loops/do-until-loop-settings.png)

7. В цикле выберите **Добавить действие**. Выполните поиск по слову "переменные" и добавьте действие **Переменные — увеличение переменной**.

   ![Добавление действия для увеличения значения переменной](./media/logic-apps-control-flow-loops/do-until-loop-increment-variable.png)

8. В поле **Имя** выберите переменную **Limit**. В поле **Значение** введите 1. 

   ![Увеличение значения переменной Limit на 1](./media/logic-apps-control-flow-loops/do-until-loop-increment-variable-settings.png)

9. В области цикла но за его пределами добавьте действие, которое отправляет сообщение. Если отобразится запрос на вход в учетную запись электронной почты, выполните его.

   ![Добавления действия, которое отправляет сообщение](media/logic-apps-control-flow-loops/do-until-loop-send-email.png)

10. Задайте свойства для сообщения электронной почты. Добавьте переменную **Limit** в поле темы. Таким образом, вы сможете убедиться в том, что текущее значение переменной соответствует заданному условию, как в этом примере:

    ![Настройка свойств для сообщения электронной почты](./media/logic-apps-control-flow-loops/do-until-loop-send-email-settings.png)

    | Свойство | Значение | ОПИСАНИЕ |
    | -------- | ----- | ----------- | 
    | **To** | *<email-address@domain>* | Адрес электронной почты получателя. Для тестировании используйте свой адрес электронной почты. | 
    | **Тема** | Текущее значение для переменной Limit — это **Limit**. | Укажите тему сообщения. Для этого примера обязательно добавьте переменную **Limit**. | 
    | **Текст** | <*email-content*> | Укажите содержимое сообщения, которое требуется отправить. Для этого примера введите любой текст. | 
    |||| 

11. Сохраните приложение логики. Чтобы вручную проверить приложение логики, на панели инструментов конструктора щелкните **Запустить**.

    После запуска приложения логики вы получите сообщение с содержимым, которое указали:

    ![Полученное сообщение](./media/logic-apps-control-flow-loops/do-until-loop-sent-email.png)

## <a name="prevent-endless-loops"></a>Предотвращение бесконечных циклов

Цикл until имеет ограничения по умолчанию, которые останавливают выполнение при любом из этих условий:

| Свойство | Значение по умолчанию | ОПИСАНИЕ | 
| -------- | ------------- | ----------- | 
| **Count** | 60 | Максимальное количество циклов, выполняемых до выхода из цикла. Значение по умолчанию — 60 повторяемых операций. | 
| **Время ожидания** | PT1H | Максимальное время выполнения цикла до выхода из него. Значение по умолчанию составляет один час и указывается в формате ISO 8601. <p>Значение времени ожидания вычисляется для каждой повторяющейся операции цикла. Если время любого действия в цикле превышает ограничение времени ожидания, текущий цикл не останавливается, а следующий цикл не запускается, так как условие ограничения не выполнено. | 
|||| 

Чтобы изменить эти ограничения по умолчанию, выберите **Показать дополнительные параметры** в области действия цикла.

<a name="until-json"></a>

## <a name="until-definition-json"></a>Определение цикла until (JSON)

При работе в представлении кода для приложения логики вы можете в качестве альтернативы определить цикл `Until` в определении JSON приложения логики, как показано ниже.

``` json
"actions": {
    "Initialize_variable": {
        // Definition for initialize variable action
    },
    "Send_an_email": {
        // Definition for send email action
    },
    "Until": {
        "type": "Until",
        "actions": {
            "Increment_variable": {
                "type": "IncrementVariable",
                "inputs": {
                    "name": "Limit",
                    "value": 1
                },
                "runAfter": {}
            }
        },
        "expression": "@equals(variables('Limit'), 10)",
        // To prevent endless loops, an "Until" loop 
        // includes these default limits that stop the loop. 
        "limit": { 
            "count": 60,
            "timeout": "PT1H"
        },
        "runAfter": {
            "Initialize_variable": [
                "Succeeded"
            ]
        },
    }
},
```

В другом примере этот цикл until вызывает конечную точку HTTP, которая создает ресурс, и останавливается, если в тексте ответа HTTP возвращается состояние Completed. Чтобы предотвратить бесконечные циклы, выполнение цикла останавливается при любом из этих условий:

* Цикл выполнялся 10 раз в соответствии с атрибутом `count`. Значение по умолчанию — 60 раз. 
* Попытка запустить цикл выполнялась в течение двух часов в соответствии с атрибутом `timeout` в формате ISO 8601. Значение по умолчанию — 1 час.
  
``` json
"actions": {
    "myUntilLoopName": {
        "type": "Until",
        "actions": {
            "Create_new_resource": {
                "type": "Http",
                "inputs": {
                    "body": {
                        "resourceId": "@triggerBody()"
                    },
                    "url": "https://domain.com/provisionResource/create-resource",
                    "body": {
                        "resourceId": "@triggerBody()"
                    }
                },
                "runAfter": {},
                "type": "ApiConnection"
            }
        },
        "expression": "@equals(triggerBody(), 'Completed')",
        "limit": {
            "count": 10,
            "timeout": "PT2H"
        },
        "runAfter": {}
    }
},
```

## <a name="get-support"></a>Получение поддержки

* Если у вас возникли вопросы, то посетите [форум Azure Logic Apps](https://social.msdn.microsoft.com/Forums/en-US/home?forum=azurelogicapps).
* Оставить предложения по функциям или проголосовать за них вы можете на [сайте отзывов пользователей Azure Logic Apps](http://aka.ms/logicapps-wish).

## <a name="next-steps"></a>Дополнительная информация

* [Conditional statements: Run steps based on a condition in logic apps](../logic-apps/logic-apps-control-flow-conditional-statement.md) (Условные операторы. Выполнение шагов на основе условия в приложениях логики)
* [Операторы switch. Выполнение различных шагов на основе различных значений в приложениях логики](../logic-apps/logic-apps-control-flow-switch-statement.md)
* [Create or join parallel branches in your logic app](../logic-apps/logic-apps-control-flow-branches.md) (Создание или присоединение параллельных ветвей в приложении логики)
* [Области. Выполнение шагов на основе состояния группы в приложениях логики](../logic-apps/logic-apps-control-flow-run-steps-group-scopes.md)