---
title: "Вызов пользовательских API в Azure Logic Apps | Документация Майкрософт"
description: "Вызов собственных пользовательских API, размещенных в службе приложений Azure с помощью Azure Logic Apps"
author: stepsic-microsoft-com
manager: anneta
editor: 
services: logic-apps
documentationcenter: 
ms.assetid: f113005d-0ba6-496b-8230-c1eadbd6dbb9
ms.service: logic-apps
ms.workload: integration
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/31/2016
ms.author: stepsic
translationtype: Human Translation
ms.sourcegitcommit: 6ea03adaabc1cd9e62aa91d4237481d8330704a1
ms.openlocfilehash: 9d169bcc0b1e89866d04cced474ee9c0e6ba6952
ms.lasthandoff: 04/06/2017


---
# <a name="call-custom-apis-hosted-on-azure-app-service-with-azure-logic-apps"></a>Вызов пользовательских API, размещенных в службе приложений Azure с помощью Azure Logic Apps

Несмотря на то что Azure Logic Apps предоставляет соединители (более 40) для различных служб, может возникнуть необходимость вызвать пользовательский API для выполнения собственного кода. Служба приложений Azure предоставляет один из самых простых и масштабируемых способов для размещения собственных пользовательских веб-API. В этой статье рассматривается вызов веб-API, размещенного в приложении API службы приложений, веб-приложении или мобильном приложении.
См. сведения о том, [как создать API в качестве триггера или действия в приложениях логики](../logic-apps/logic-apps-create-api-app.md).

## <a name="deploy-your-web-app"></a>Развертывание веб-приложения

Прежде всего необходимо развернуть API в качестве веб-приложения службы приложений Azure. Узнайте о [базовом развертывании при создании веб-приложения ASP.NET](../app-service-web/app-service-web-get-started-dotnet.md). Хотя из приложения логики можно вызвать любой интерфейс API, для получения наилучших результатов рекомендуется добавить метаданные Swagger для легкой интеграции с действиями приложения логики. Узнайте о [добавлении метаданных Swagger](../app-service-api/app-service-api-dotnet-get-started.md#use-swagger-api-metadata-and-ui).

### <a name="api-settings"></a>Параметры API

Чтобы конструктор приложений логики проанализировал метаданные Swagger, необходимо включить CORS и задать свойства определения API для веб-приложения. 

1.    На портале Azure выберите свое веб-приложение.
2.    В открывшейся колонке найдите **API** и выберите **Определение API**. Установите в качестве значения параметра **Расположение определения API** URL-адрес файла swagger.json.

    Как правило, этот URL-адрес имеет следующий формат: https://{имя}.azurewebsites.net/swagger/docs/v1.

3.    Чтобы разрешить запросы от конструктора приложений логики, в разделе **API** выберите **CORS** и задайте политику CORS для *.

## <a name="call-into-your-custom-api"></a>Вызов пользовательского API

Если вы задали свойства CORS и свойства определения API, вы сможете легко добавить пользовательские действия API в рабочий процесс на портале приложений логики. В конструкторе приложений логики вы можете просмотреть свои веб-сайты подписки, чтобы вывести список веб-сайтов с заданным URL-адресом Swagger. Вы можете также указать на Swagger и вывести список доступных действий и входных данных с помощью действия "HTTP + Swagger". Наконец, всегда можно создать запрос с помощью действия HTTP для вызова любых API, даже тех, которые не имеют или не предоставляют документа Swagger.

Чтобы защитить свой API, воспользуйтесь одним из следующих способов:

*    Не требует изменения кода. Для защиты API без изменения кода или повторного развертывания можно использовать Azure Active Directory.
*    Примените обычную проверку подлинности, проверку подлинности Azure Active Directory или проверку подлинности на основе сертификата в коде API.

## <a name="secure-calls-to-your-api-without-changing-code"></a>Безопасные вызовы API без изменения кода

В этом разделе вы создадите два приложения Azure Active Directory: одно для приложения логики, а другое — для веб-приложения. При вызовах к веб-приложению выполняется проверка подлинности с помощью субъекта-службы (идентификатора клиента и секрета), связанного с приложением Azure Active Directory для вашего приложения логики. Наконец, добавьте идентификаторы приложений в определение приложения логики.

### <a name="part-1-set-up-an-application-identity-for-your-logic-app"></a>Часть 1. Настройка удостоверения приложения для приложения логики

Приложение логики использует это удостоверение приложения для проверки подлинности в Azure Active Directory. Для вашего каталога это удостоверение необходимо настроить только один раз. Например, вы можете использовать одно удостоверение для всех приложений логики или создавать отдельные удостоверения для каждого из них. Вы можете настроить эти удостоверения на портале Azure или с помощью PowerShell.

#### <a name="create-the-application-identity-in-the-azure-classic-portal"></a>Создание удостоверения приложения на классическом портале Azure

1. На классическом портале Azure перейдите в раздел [Azure Active Directory](https://manage.windowsazure.com/#Workspaces/ActiveDirectoryExtension/directory). 
2. Выберите каталог, который используется для веб-приложения.
3. Перейдите на вкладку **Приложения**. Выберите **Добавить** на панели команд в нижней части страницы.
5. Присвойте удостоверению приложения имя и нажмите стрелку "Далее".
6. В разделе **Свойства приложения** введите уникальную строку в формате домена и установите флажок.
7. Выберите вкладку **Настройка**. Перейдите к параметру **Идентификатор клиента** и скопируйте идентификатор клиента для использования в приложении логики.
8. В разделе **Ключи** откройте список **Выбрать длительность** и выберите длительность для ключа.
9. В нижней части страницы нажмите кнопку **Сохранить**. Возможно, потребуется подождать несколько секунд.
10. Обязательно скопируйте ключ, который отобразится в разделе **Ключи**, чтобы его можно было использовать в приложении логики.

#### <a name="create-the-application-identity-using-powershell"></a>Создание удостоверения приложения с помощью PowerShell

1. `Switch-AzureMode AzureResourceManager`
2. `Add-AzureAccount`
3. `New-AzureADApplication -DisplayName "MyLogicAppID" -HomePage "http://someranddomain.tld" -IdentifierUris "http://someranddomain.tld" -Password "Pass@word1!"`
4. Скопируйте **идентификатор клиента**, **идентификатор приложения** и пароль.

### <a name="part-2-protect-your-web-app-with-an-azure-active-directory-app-identity"></a>Часть 2. Защита веб-приложения с помощью удостоверения приложения Azure Active Directory

Если веб-приложение уже развернуто, вы сможете включить проверку подлинности на портале Azure. Проверку подлинности также можно включить в рамках развертывания с помощью Azure Resource Manager.

#### <a name="enable-authorization-in-the-azure-portal"></a>Включение проверки подлинности на портале Azure

1. Найдите и выберите веб-приложение. В разделе **Параметры** выберите **Аутентификация или авторизация**.
2. В разделе **Проверка подлинности службы приложений** **включите** проверку подлинности и выберите **Сохранить**.

На этом этапе приложение будет создано автоматически. Идентификатор клиента этого приложения потребуется в части 3, поэтому сделайте следующее:

1. На классическом портале Azure перейдите в раздел [Azure Active Directory](https://manage.windowsazure.com/#Workspaces/ActiveDirectoryExtension/directory).
2.    Выберите свой каталог.
3. Найдите приложение в поле поиска.
4. Выберите его в списке.
5. Перейдите на вкладку **Настройка**, где должен отображаться **идентификатор клиента**.

#### <a name="deploy-your-web-app-using-an-azure-resource-manager-template"></a>Развертывание веб-приложения с помощью шаблона Azure Resource Manager

Сначала необходимо создать приложение для веб-приложения, которое отличается от приложения, используемого для приложения логики. Повторите действия, описанные в части 1, используя для **HomePage** и **IdentifierUris** фактический URL-адрес (https://**URL-адрес**) веб-приложения.

> [!NOTE]
> При создании приложения для веб-приложения необходимо использовать [классический портал Azure](https://manage.windowsazure.com/#Workspaces/ActiveDirectoryExtension/directory). Командлет PowerShell не поддерживает настройку необходимых разрешений для входа пользователей на веб-сайт.

Получив идентификатор клиента и арендатора, включите этот код в шаблон развертывания в качестве вложенного ресурса веб-приложения.

```
"resources": [
    {
        "apiVersion": "2015-08-01",
        "name": "web",
        "type": "config",
        "dependsOn": ["[concat('Microsoft.Web/sites/','parameters('webAppName'))]"],
        "properties": {
            "siteAuthEnabled": true,
            "siteAuthSettings": {
              "clientId": "<<clientID>>",
              "issuer": "https://sts.windows.net/<<tenantID>>/",
            }
        }
    }
]
```

Чтобы автоматически развернуть пустое веб-приложение и приложение логики, которые используют Azure Active Directory, нажмите **следующую кнопку**:

[![Развертывание в Azure](media/logic-apps-custom-hosted-api/deploybutton.png)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F201-logic-app-custom-api%2Fazuredeploy.json)

Полный шаблон см. в [этой статье на сайте GitHub](https://github.com/Azure/azure-quickstart-templates/blob/master/201-logic-app-custom-api/azuredeploy.json).

### <a name="part-3-populate-the-authorization-section-in-your-logic-app"></a>Часть 3. Заполнение раздела авторизации в приложении логики

В разделе **Авторизация** действия **HTTP** необходимо указать следующее:

`{"tenant":"<<tenantId>>", "audience":"<<clientID from Part 2>>", "clientId":"<<clientID from Part 1>>","secret": "<<Password or Key from Part 1>>","type":"ActiveDirectoryOAuth" }`

| Элемент | Описание |
| ------- | ----------- |
| type |Тип проверки подлинности. Для аутентификации ActiveDirectoryOAuth это значение равно `ActiveDirectoryOAuth`. |
| tenant |Идентификатор тенанта, используемый для идентификации тенанта AD. |
| audience |Обязательный параметр. Ресурс, к которому вы выполняете подключение. |
| clientID |Идентификатор клиента для приложения Azure AD. |
| secret |Обязательный параметр. Секретные данные клиента, запрашивающего маркер. |

В предыдущем шаблоне этот раздел авторизации уже настроен. Однако если вы создаете приложение логики полностью самостоятельно, вам потребуется включить весь раздел авторизации.

## <a name="secure-your-api-in-code"></a>Защита API в коде

### <a name="certificate-authentication"></a>Проверка подлинности на основе сертификата

Вы можете использовать сертификаты клиента для проверки входящих запросов к веб-приложению. Сведения о настройке кода см. в статье [Настройка взаимной проверки подлинности TLS для веб-приложения](../app-service-web/app-service-web-configure-tls-mutual-auth.md).

В разделе **Авторизация** необходимо указать следующее: 

`{"type": "clientcertificate","password": "test","pfx": "long-pfx-key"}`

| Элемент | Описание |
| ------- | ----------- |
| type |Обязательный параметр. Тип проверки подлинности. Для SSL-сертификатов клиента используйте значение `ClientCertificate`. |
| pfx |Обязательный параметр. Содержимое PFX-файла с кодировкой Base64. |
| password |Обязательный параметр. Пароль для доступа к PFX-файлу. |

### <a name="basic-authentication"></a>Обычная аутентификация

Для проверки входящих запросов можно использовать обычную проверку подлинности (например, имя пользователя и пароль). Обычная проверка подлинности — это универсальный вариант, который подходит для приложений, написанных на любых языках программирования.

В разделе **Авторизация** необходимо указать следующее:

`{"type": "basic","username": "test","password": "test"}`.

| Элемент | Описание |
| --- | --- |
| type |Обязательный параметр. Тип проверки подлинности. Для обычной проверки подлинности используйте значение `Basic`. |
| Имя пользователя |Обязательный параметр. Имя пользователя для проверки подлинности. |
| password |Обязательный параметр. Пароль для проверки подлинности. |

### <a name="handle-azure-active-directory-authentication-in-code"></a>Обработка проверки подлинности Azure Active Directory в коде

По умолчанию проверка подлинности Azure Active Directory, которую можно включить на портале Azure, не обеспечивает детального уровня авторизации. Например, она разрешает использование API не отдельным пользователям или приложениям, а на уровне конкретного клиента.

Чтобы ограничить доступ к API для приложения логики, например, в коде извлеките заголовок, который содержит маркер JWT. Проверяйте удостоверение вызывающей стороны и отклоняйте запросы, не отвечающие требованиям.

Чтобы реализовать проверку подлинности полностью в коде, не используя портал Azure, ознакомьтесь со статьей [Проверка подлинности в приложении Azure с помощью локального каталога Active Directory](../app-service-web/web-sites-authentication-authorization.md).
Для создания удостоверения приложения для приложения логики и вызова API вам потребуется выполнить приведенные выше шаги.
