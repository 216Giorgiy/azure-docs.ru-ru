---
title: "Выполнение действий на основе состояния сгруппированных действий в Azure Logic Apps | Документация Майкрософт"
description: "Группировка действий в области и выполнение шагов на основе состояния группы"
services: logic-apps
keywords: "ветви, параллельная обработка"
documentationcenter: 
author: ecfan
manager: anneta
editor: 
ms.assetid: 
ms.service: logic-apps
ms.workload: logic-apps
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/05/2018
ms.author: estfan; LADocs
ms.openlocfilehash: 052af45962f442e96ca28f05ffaa1b9814b2588b
ms.sourcegitcommit: 0b02e180f02ca3acbfb2f91ca3e36989df0f2d9c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2018
---
# <a name="scopes-run-steps-based-on-group-status-in-logic-apps"></a>Области. Выполнение шагов на основе состояния группы в приложениях логики

Чтобы выполнять шаги только после успешного или неуспешного выполнения действий другой группы, поместите эту группу в *область*. Эта структура полезна, если необходимо упорядочить действия как логическую группу, оценить состояние этой группы и выполнить действия на основе состояния области. После завершения выполнения всех действий в области она также получает собственное состояние. Например, области можно использовать, если необходимо реализовать [обработку ошибок и исключений](../logic-apps/logic-apps-exception-handling.md#scopes). 

Чтобы проверить состояние области, можно использовать те же критерии, что и для определения состояния выполнения приложения логики, например Succeeded (Успешно), Failed (Сбой), Cancelled (Отмена) и т. д. По умолчанию, когда все действия области будут выполнены, для состояния области устанавливается значение Succeeded (Успешно). Однако, когда какое-либо действие в области завершается со сбоем или отменяется, для состояния области устанавливается значение Failed (Сбой). Сведения об ограничениях в областях см. в статье [Ограничения и настройка Logic Apps](../logic-apps/logic-apps-limits-and-config.md). 

Например, вот приложение логики высокого уровня, которое использует область для выполнения определенных действий и условие для проверки состояния области. Если какие-либо действия в области завершаются сбоем или неожиданно прерываются, область получит состояние Failed (Сбой) или Aborted (Прервано) соответственно, а приложение логики отправит сообщение Scope failed (Область завершилась со сбоем). Если все действия области успешны, приложение логики отправляет сообщение Scope succeeded (Область успешна).

![Настройка триггера"Расписание — повторение"](./media/logic-apps-control-flow-run-steps-group-scopes/scope-high-level.png)

## <a name="prerequisites"></a>предварительным требованиям

Чтобы выполнить пример в этой статье, потребуется следующее:

* Подписка Azure. Если у вас нет ее, вы можете [зарегистрироваться для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/). 

* Учетная запись электронной почты любого поставщика электронной почты, поддерживаемого Logic Apps. В этом примере используется Outlook.com. Если вы используете другой поставщик, то общая последовательность остается прежней, но отображается другой пользовательский интерфейс.

* Ключ карт Bing. Чтобы получить этот ключ, ознакомьтесь со статьей <a href="https://msdn.microsoft.com/library/ff428642.aspx" target="_blank">Getting a Bing Maps Key</a> (Получение ключа Карт Bing).

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

## <a name="create-sample-logic-app"></a>Создание примера приложения логики

Сначала создайте этот пример приложения логики, чтобы позднее можно было добавить область:

![Создание примера приложения логики](./media/logic-apps-control-flow-run-steps-group-scopes/finished-sample-app.png)

* Триггер **Расписание — повторение** проверяет службу Карт Bing с заданной вами частотой.
* Действие **Bing Maps - Get route** (Карты Bing — получить маршрут) проверяет время перемещения между двумя расположениями.
* Условный оператор, который проверяет, превышает ли время перемещения указанное время.
* Действие, которое отправляет вам сообщение электронной почты о том, что текущее время перемещения превышает указанное время.

Приложение логики можно сохранить в любое время, так что часто сохраняйте свою работу.

1. Войдите на <a href="https://portal.azure.com" target="_blank">портал Azure</a>, если вы еще этого не сделали. Создание пустого приложения логики.

2. Добавьте триггер **Расписание — повторение** с такими параметрами: **Интервал** — 1, **Частота** — "Минута".

   ![Настройка триггера"Расписание — повторение"](./media/logic-apps-control-flow-run-steps-group-scopes/recurrence.png)

   > [!TIP]
   > Чтобы визуально упростить представление и скрыть сведения о каждом действии в конструкторе, сворачивайте фигуры каждого действия по мере выполнения этих шагов.

3. Добавьте действие **Bing Maps — Get route** (Карты Bing — получить маршрут). 

   1. Если у вас еще нет подключения к Картам Bing, появится запрос на его установку.

      | Параметр | Значение | ОПИСАНИЕ |
      | ------- | ----- | ----------- |
      | **Имя подключения** | BingMapsConnection | Укажите имя подключения. | 
      | **Ключ API**. | <*ваш ключ Карт Bing*> | Введите ключ Карт Bing, полученный ранее. | 
      ||||  

   2. Настройте действие **Get route** (Получить маршрут), как показано в таблице под этим изображением:

      ![Настройка действия Bing Maps - Get route (Карты Bing — получить маршрут)](./media/logic-apps-control-flow-run-steps-group-scopes/get-route.png) 

      Дополнительные сведения об этих параметрах см. в статье [Calculate a Route](https://msdn.microsoft.com/library/ff701717.aspx) (Расчет маршрута).

      | Параметр | Значение | ОПИСАНИЕ |
      | ------- | ----- | ----------- |
      | **Пункт маршрута 1** | <*Начало*> | Введите начало маршрута. | 
      | **Пункт маршрута 2** | <*Конец*> | Введите место назначения маршрута. | 
      | **Avoid** (Избегать) | None | Введите то, чего нужно избегать на маршруте, например шоссе, платные дороги и т. д. Возможные значения см. в статье [Calculate a Route](https://msdn.microsoft.com/library/ff701717.aspx) (Расчет маршрута). | 
      | **Optimize** (Оптимизация) | timeWithTraffic | Выберите параметр для оптимизации маршрута, например расстояние, время в пути в соответствии с информацией о текущей загрузке дорог и т. д. В этом примере используется это значение: "timeWithTraffic". | 
      | **Distance unit** (Единица расстояния) | <*выбранная единица*> | Введите единицы измерения расстояния для расчета маршрута. В этом примере используется значение: "Mile" (Миля). | 
      | **Travel mode** (Режим движения) | Driving (Движение на автомобиле) | Введите режим движения по маршруту. В этом примере используется значение: "Driving" (Вождение). | 
      | **Transit Date-Time** (Дата и время транзита) | Нет | Применяется только для режима движения Transit (Транзит). | 
      | **Transit Date-Time Type** (Тип даты и времени транзита) | Нет | Применяется только для режима движения Transit (Транзит). | 
      ||||  

4. Добавьте условие, чтобы проверить, превышает ли текущее время движения в соответствии с текущей загрузкой определенное время. Для этого примера выполните действия под этим изображением:

   ![Добавление условия](./media/logic-apps-control-flow-run-steps-group-scopes/build-condition.png)

   1. Переименуйте условие, используя описание: **Если время трафика превышает указанное время**.

   2. В списке параметров выберите поле **Travel Duration Traffic** (Трафик длительности пути), которое задается в секундах. 

   3. В поле оператора сравнения выберите оператор **больше чем**.

   4. Для значения сравнения введите значение **600** в секундах, что эквивалентно 10 минутам.

5. В ветке **Если истинно** условия добавьте действие "Отправить сообщение" для поставщика электронной почты. Настройте это действие, указав сведения, показанные в таблице под этим изображением:

   ![Добавление действия "Отправить сообщение" в ветвь "Если истинно"](./media/logic-apps-control-flow-run-steps-group-scopes/send-email.png)

   1. В поле **Кому** введите адрес электронной почты в целях тестирования.

   2. В поле **Тема** введите следующий текст:

      ```Time to leave: Traffic more than 10 minutes```

   3. В поле **Текст** введите этот текст с пробелом в конце: 

      ```Travel time: ```

      Пока ваш курсор находится в поле **Текст**, список динамического содержимого остается открытым, поэтому вы можете выбрать любые параметры, доступные на этом этапе.

   4. В списке динамического содержимого выберите **Выражение**.

   5. Найдите функцию **div( )** и выберите ее.

   6. Пока курсор находится в скобках функции, выберите **Динамическое содержимое**, чтобы иметь возможность добавить параметр **Travel Duration Traffic** (Трафик длительности пути).

   7. В разделе **Get route** (Получить маршрут) списка динамических параметров выберите поле **Travel Duration Traffic** (Трафик длительности пути).

      ![Выбор поля Travel Duration Traffic (Трафик длительности пути)](./media/logic-apps-control-flow-run-steps-group-scopes/send-email-2.png)

   8. После разрешения поля в формат JSON добавьте **запятую** (```,```), за которой следует число ```60```, чтобы преобразовать значение **Travel Duration Traffic** (Трафик длительности пути) из секунд в минуты. 
   
      ```
      div(body('Get_route')?['travelDurationTraffic'],60)
      ```

      Теперь выражение выглядит как в следующем примере:

      ![Итоговое выражение](./media/logic-apps-control-flow-run-steps-group-scopes/send-email-3.png)  

   9. Обязательно нажмите кнопку **ОК** после завершения работы.

  10. После разрешения выражения добавьте текст с начальным пробелом: ``` minutes```.
  
      Теперь поле **Текст** выглядит, как в следующем примере:

      ![Итоговое поле "Текст"](./media/logic-apps-control-flow-run-steps-group-scopes/send-email-4.png)

6. Сохраните приложение логики.

Затем добавьте область, чтобы группировать определенные действия и оценивать их состояние.

## <a name="add-a-scope"></a>Добавление области

1. Если это еще не сделано, откройте приложение логики в конструкторе приложений логики. 

2. Добавьте область в нужное место в рабочем процессе. Например: 

   * Чтобы добавить область между имеющимися шагами в рабочем процессе приложения логики, переместите указатель над стрелкой, где вы хотите добавить область. 
   Выберите **знак плюс** (**+**) > **Add a scope** (Добавить область).

     ![Добавление области](./media/logic-apps-control-flow-run-steps-group-scopes/add-scope.png)

     Если необходимо добавить область в конце рабочего процесса, перейдите в нижнюю часть приложения логики и выберите **+ Новый шаг** > **...More** (...Дополнительно) > **Add a scope** (Добавить область).

3. Теперь добавьте или перенесите имеющиеся шаги, которые необходимо выполнить внутри области. Например, перетащите эти действия в область:
      
   * **Get route** (Получить маршрут);
   * **Если время трафика превышает указанное время**, которое включает ветви **Если истинно** и **Если ложно**.

   Теперь приложение логики выглядит, как в следующем примере:

   ![Область добавлена](./media/logic-apps-control-flow-run-steps-group-scopes/scope-added.png)

4. Добавьте в область условие, которое проверяет ее состояние. Переименуйте условие, используя описание: **Если область завершилась со сбоем**.

   ![Добавление условия для проверки состояния области](./media/logic-apps-control-flow-run-steps-group-scopes/add-condition-check-scope-status.png)
  
5. Создайте выражение, которое проверяет значение состояние области: `Failed` или `Aborted`.

   ![Добавление выражения, которое проверяет состояние области](./media/logic-apps-control-flow-run-steps-group-scopes/build-expression-check-scope-status.png)

   Или, чтобы ввести выражение в виде текста, выберите **Edit in advanced mode** (Изменить в расширенном режиме).

   ```@equals('@result(''Scope'')[0][''status'']', 'Failed, Aborted')```

6. В ветвях **Если истинно** и **Если ложно** добавьте действия, которые нужно выполнить, например, отправку письма или сообщения.

   ![Добавление выражения, которое проверяет состояние области](./media/logic-apps-control-flow-run-steps-group-scopes/handle-true-false-branches.png)

7. Сохраните приложение логики.

Теперь готовое приложение логики выглядит, как пример ниже со всеми развернутыми фигурами:

![Готовое приложение логики с областью](./media/logic-apps-control-flow-run-steps-group-scopes/scopes-overview.png)

## <a name="test-your-work"></a>Проверка результатов своих действий

На панели инструментов конструктора нажмите кнопку **Запустить**. Если все действия области успешны, вы получите сообщение Scope succeeded (Область успешна). Если какие-либо действия области не были успешны, вы получите сообщение Scope failed (Область завершилась со сбоем). 

<a name="scopes-json"></a>

## <a name="json-definition"></a>Определение JSON

При работе в представлении кода вместо этого можно определить структуру области в определении JSON приложения логики. Например, вот определение JSON для триггера и действий в предыдущем приложении логики:

``` json
"triggers": {
  "Recurrence": {
    "type": "Recurrence",
    "recurrence": {
       "frequency": "Minute",
       "interval": 1
    },
  }
}
```

```json
"actions": {
  "If_scope_failed": {
    "type": "If",
    "actions": {
      "Scope_failed": {
        "type": "ApiConnection",
        "inputs": {
          "body": {
            "Body": "Scope failed",
            "Subject": "Scope failed",
            "To": "<your-email@domain.com>"
          },
          "host": {
            "connection": {
              "name": "@parameters('$connections')['outlook']['connectionId']"
            }
          },
          "method": "post",
          "path": "/Mail"
        },
        "runAfter": {}
      }
    },
    "else": {
      "actions": {
        "Scope_succeded": {
          "type": "ApiConnection",
          "inputs": {
            "body": {
              "Body": "None",
              "Subject": "Scope succeeded",
              "To": "<your-email@domain.com>"
            },
            "host": {
              "connection": {
               "name": "@parameters('$connections')['outlook']['connectionId']"
              }
            },
            "method": "post",
            "path": "/Mail"
          },
          "runAfter": {}
        }
      }
    },
    "expression": "@equals('@result(''Scope'')[0][''status'']', 'Failed, Aborted')",
    "runAfter": {
      "Scope": [
        "Succeeded"
      ]
    }
  },
  "Scope": {
    "type": "Scope",
    "actions": {
      "Get_route": {
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['bingmaps']['connectionId']"
            }
          },
          "method": "get",
          "path": "/REST/V1/Routes/Driving",
          "queries": {
            "distanceUnit": "Mile",
            "optimize": "timeWithTraffic",
            "travelMode": "Driving",
            "wp.0": "<start>",
            "wp.1": "<end>"
          }
        },
        "runAfter": {}
      },
      "If_traffic_time_more_than_specified_time": {
        "type": "If",
        "actions": {
          "Send_mail_when_traffic_exceeds_10_minutes": {
            "type": "ApiConnection",
            "inputs": {
              "body": {
                 "Body": "Travel time:@{div(body('Get_route')?['travelDurationTraffic'], 60)} minutes",
                 "Subject": "Time to leave: Traffic more than 10 minutes",
                 "To": "<your-email@domain.com>"
              },
              "host": {
                "connection": {
                   "name": "@parameters('$connections')['outlook']['connectionId']"
                }
              },
              "method": "post",
              "path": "/Mail"
            },
            "runAfter": {}
          }
        },
        "expression": "@greater(body('Get_route')?['travelDurationTraffic'], 600)",
        "runAfter": {
          "Get_route": [
            "Succeeded"
          ]
        }
      }
    },
    "runAfter": {}
  }
}
```

## <a name="get-support"></a>Получение поддержки

* Если у вас возникли вопросы, то посетите [форум Azure Logic Apps](https://social.msdn.microsoft.com/Forums/en-US/home?forum=azurelogicapps).
* Оставить предложения по функциям или проголосовать за них вы можете на [сайте отзывов пользователей Azure Logic Apps](http://aka.ms/logicapps-wish).

## <a name="next-steps"></a>Дополнительная информация

* [Conditional statements: Run steps based on a condition in logic apps](../logic-apps/logic-apps-control-flow-conditional-statement.md) (Условные операторы. Выполнение шагов на основе условия в приложениях логики)
* [Операторы switch. Выполнение различных шагов на основе различных значений в приложениях логики](../logic-apps/logic-apps-control-flow-switch-statement.md)
* [Loops: Process arrays or repeat actions until a condition is met](../logic-apps/logic-apps-control-flow-loops.md) (Циклы. Обработка массивов или повторение действий до выполнения условия)
* [Create or join parallel branches in your logic app](../logic-apps/logic-apps-control-flow-branches.md) (Создание или присоединение параллельных ветвей в приложении логики)