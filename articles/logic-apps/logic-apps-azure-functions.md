---
title: Добавление и выполнение пользовательского кода в Azure Logic Apps с помощью службы " Функции Azure" | Документация Майкрософт
description: Узнайте, как добавлять и выполнять фрагменты пользовательского кода для Azure Logic Apps с помощью службы "Функции Azure"
services: logic-apps
ms.service: logic-apps
author: ecfan
ms.author: estfan
manager: jeconnoc
ms.topic: article
ms.date: 07/25/2018
ms.reviewer: klam, LADocs
ms.suite: integration
ms.openlocfilehash: 20ad738541554279ff9fd6dd6babe90a38676c00
ms.sourcegitcommit: a5eb246d79a462519775a9705ebf562f0444e4ec
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/26/2018
ms.locfileid: "39263196"
---
# <a name="add-and-run-custom-code-snippets-in-azure-logic-apps-with-azure-functions"></a>Добавление и выполнение фрагментов пользовательского код для Azure Logic Apps с помощью службы "Функции Azure"

Если требуется создать и выполнить только фрагмент кода, который исправляет конкретную проблему в приложениях логики, можно создать собственные функции с помощью службы [Функции Azure](../azure-functions/functions-overview.md). Данная служба предоставляет возможность создания и выполнения пользовательских фрагментов кода, написанных в приложениях логики на языках Node.js или C#. При этом можно не беспокоиться о создании целого приложения или инфраструктуры для запуска кода. Служба "Функции Azure" обеспечивает бессерверные вычисления в облаке и является полезной при выполнении задач, приведенных ниже.

* Расширение режимов работы приложений логики с помощью компонентов, поддерживаемых Node.js или C#.
* Выполнение вычислений в рабочем процессе приложения логики.
* Применение расширенных функции форматирования или вычисления полей в приложениях логики.

Также можно [вызывать приложения логики из функций](#call-logic-app).

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, вам потребуются перечисленные ниже компоненты.

* Если у вас еще нет подписки Azure, <a href="https://azure.microsoft.com/free/" target="_blank">получите бесплатную учетную запись Azure</a>. 

* Приложение логики, в которое необходимо добавить функцию

  Если вы не работали с приложениями логики, см. руководства по [Azure Logic Apps](../logic-apps/logic-apps-overview.md) и [созданию первого приложения логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

* [Триггер](../logic-apps/logic-apps-overview.md#logic-app-concepts) в качестве первого шага приложения логики 

  Прежде чем добавлять действия для запуска функций, необходимо запустить приложение логики при помощи триггера.

* Приложение-функция Azure, которое является контейнером для всех функций Azure, в том числе и ваших. При отсутствии приложения-функции сначала его необходимо [создать](../azure-functions/functions-create-first-azure-function.md). Затем для создания функции в конструкторе приложений логики можно использовать сведения из разделов [Создание отдельных функций приложений логики](#create-function-external) или [Создание встроенных функций приложений логики](#create-function-designer).

  Как новые, так и существующие приложения-функции Azure имеют одинаковые требования для работы с приложениями логики.

  * Приложение-функция должно находиться в той же подписке Azure, что и приложение логики.

  * Функция должна использовать шаблон функции **Универсальный веб-перехватчик** для **JavaScript** или **C#**. Этот шаблон поддерживает содержимое приложения логики с типом `application/json`. Данные шаблоны помогают конструктору приложений логики в поиске и отображении пользовательских функций, которые были созданы с этими шаблонами при добавлении функций в приложение логики.

  * Убедитесь, что свойство **Режим** шаблона функции установлено как **Веб-перехватчик**, а свойство **Тип веб-перехватчика** установлено как **Generic JSON** (Универсальный JSON).

    1. Войдите на <a href="https://portal.azure.com" target="_blank">портале Azure</a>.
    2. В главном меню Azure выберите **Приложения-функции**. 
    3. В списке **Приложения-функции** выберите приложение-функцию, разверните его, а затем выберите **Интегрировать**. 
    4. Убедитесь, что свойство **Режим** шаблона установлено как **Веб-перехватчик**, а свойство **Тип веб-перехватчика** установлено как **Generic JSON** (Универсальный JSON). 

  * Если функция имеет [Определение API](../azure-functions/functions-openapi-definition.md), которое также известно как [файл Swagger](http://swagger.io/), конструктор Logic Apps предоставляет более широкие возможности для работы с параметрами функции. 
  Прежде чем приложение логики сможет найти и получить доступ к функции, обладающей описаниями Swagger, необходимо [настроить приложение-функцию, выполнив следующие действия](#function-swagger).

<a name="create-function-external"></a>

## <a name="create-functions-outside-logic-apps"></a>Создание отдельных функций приложений логики

Создайте приложение-функцию Azure на <a href="https://portal.azure.com" target="_blank">портале Azure</a>. Оно должно находиться в той же подписке, что и приложение логики. Затем создайте свою функцию Azure. Если вы еще не работали со службой "Функции Azure", изучите статью [Создание первой функции на портале Azure](../azure-functions/functions-create-first-azure-function.md). При этом необходимо обратить внимание на требования для создания функции Azure, которую можно добавить и вызвать из приложений логики.

* Убедитесь, что в качестве шаблона функции для **JavaScript** или **C#** был выбран **Универсальный веб-перехватчик**.

  ![Универсальный веб-перехватчик в JavaScript или C#](./media/logic-apps-azure-functions/generic-webhook.png)

* После создания функции Azure необходимо проверить, что свойства **Режим** шаблона и **Тип веб-перехватчика** настроены правильно.

  1. Разверните функцию в списке **Приложения-функции** и выберите **Интегрировать**. 

  2. Убедитесь, что свойство **Режим** шаблона установлено как **Веб-перехватчик**, а свойство **Тип веб-перехватчика** установлено на **Generic JSON** (Универсальный JSON). 

     ![Свойства шаблона функции "Интеграция"](./media/logic-apps-azure-functions/function-integrate-properties.png)

<a name="function-swagger"></a>

* Если для функции [создать определение API](../azure-functions/functions-openapi-definition.md), которое также известно как [файл Swagger](http://swagger.io/), то при необходимости можно получить широкие возможности при работе с параметрами функции в конструкторе Logic Apps. Чтобы настроить приложение-функцию, которое позволит приложению логики находить и получать доступ к функциям, которые обладают описанием Swagger, необходимо выполнить следующие действия.

  * Убедитесь, что приложение-функция активно выполняется.

  * В приложении-функции установите [Общий доступ к ресурсам независимо от источника (CORS)](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing), что позволит использовать все источники.

    1. Начиная со списка **Приложения-функции**, выберите приложение-функция > **Функции платформы** > **CORS**.

       ![Выберите приложение-функция > "Функции платформы" > CORS](./media/logic-apps-azure-functions/function-platform-features-cors.png)

    2. В разделе **CORS** необходимо добавить подстановочный знак `*` и удалить из списка все другие источники, а затем нажать кнопку **Сохранить**.

       ![Выберите приложение-функция > "Функции платформы" > CORS](./media/logic-apps-azure-functions/function-platform-features-cors-origins.png)

### <a name="access-property-values-inside-http-requests"></a>Доступ к значениям свойств внутри HTTP-запросов

Функции веб-перехватчика могут принимать HTTP-запросы в качестве входных и передавать эти запросы другим функциям. Например, несмотря на то, что служба Logic Apps имеет [функции преобразования значений DateTime](../logic-apps/workflow-definition-language-functions-reference.md), в этом базовом примере функции JavaScript отображается доступ к свойству внутри запрашиваемого объекта, который передается функции и выполняет операции над значением свойства. Чтобы получить доступ к свойствам, которые находятся внутри объекта, в этом примере используется [оператор точка (.)](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Operators/Property_accessors). 

```javascript
function convertToDateString(request, response){
   var data = request.body;
   response = {
      body: data.date.ToDateString();
   }
}
```

Ниже приведены процессы, которые выполняются внутри функции.

1. Функция создает переменную `data` и присваивает ей объект `body`, который находится внутри объекта `request`. Чтобы ссылаться на объект `body` внутри объекта `request`, функция использует оператор точку (.). 

   ```javascript
   var data = request.body;
   ```

2. Теперь функция может получить доступ к свойству `date` через переменную `data` и изменить значение свойства с типа DateTime на тип DateString с помощью вызова функции `ToDateString()`. Также в ответе функции она возвращает результат через свойство `body`. 

   ```javascript
   body: data.date.ToDateString();
   ```

После создания функции Azure можно выполнить шаги из раздела [Добавление существующей функций в приложения логики](#add-function-logic-app).

<a name="create-function-designer"></a>

## <a name="create-functions-inside-logic-apps"></a>Создание встроенных функций приложений логики

Перед созданием функции Azure, которая будет вызываться изнутри приложения логики в конструкторе приложений логики, сначала необходимо иметь приложение-функцию Azure, которое является контейнером функций. При отсутствии приложения-функции создайте его. См. статью [Создание первой функции на портале Azure](../azure-functions/functions-create-first-azure-function.md). 

1. Откройте приложение логики в конструкторе приложений логики на <a href="https://portal.azure.com" target="_blank">портале Azure</a>. 

2. На шаге, в котором необходимо создать и добавить функцию, последовательно выберите **Новый шаг** > **Add an action** (Добавить действие). 

3. В поле поиска введите "Функции Azure" в качестве условия фильтра.
Из списка действий выберите **Функции Azure — Выберите функцию Azure**. 

   ![Поиск "Функции Azure"](./media/logic-apps-azure-functions/find-azure-functions-action.png)

4. Выберите приложение-функцию из списка приложений-функций. После того как откроется список действий, выберите **Функции Azure — Выберите функцию Azure**

   ![Выбор приложения-функции](./media/logic-apps-azure-functions/select-function-app-create-function.png)

5. Определите функцию в редакторе определения функции.

   1. Введите имя функции в поле **Имя функции**. 

   2. В поле **Код** добавьте код функции в шаблон, включая ответ и полезные данные, которые необходимо вернуть приложению логики после того, как функция завершит выполнение. 
   Объект контекста в шаблоне кода описывает сообщение и содержимое, которое было передано в функцию приложением логики.

      ![Определение функции](./media/logic-apps-azure-functions/function-definition.png)

      Ссылаться на свойства объекта контекста внутри функции можно с помощью приведенного ниже синтаксиса.

      ```text
      context.<token-name>.<property-name>
      ```
      В этом примере приведен используемый синтаксис.

      ```text
      context.body.content
      ```

   3. Когда все будет готово, выберите **Создать**.

6. В поле **Текст запроса** укажите объект контекста, который передается как входные данные функции, которые должны быть отформатированы в формате JSON (нотация объектов JavaScript). После щелчка поля **Текст запроса** откроется список динамического содержимого, что позволит выбрать токены для свойств, доступных с предыдущих шагов. 

   В этом примере объект из триггера электронной почты будет передан токену **Текст**.  

   ![Пример "Текста запроса": полезные данные объекта контекста](./media/logic-apps-azure-functions/function-request-body-example.png)

   Основываясь на содержимом объекта контекста, конструктор приложений логики создает шаблон функции, который затем можно редактировать встроенным. 
   Служба Logic Apps также создает переменные на основе входного контекстного объекта.

   В данном примере объект контекста не приводится как строка, что позволяет добавить содержимое напрямую в полезные данные JSON. 
   Тем не менее, если объект не является токеном JSON, который должен быть либо строкой, либо объектом или массивом JSON, появится сообщение об ошибке. 
   Чтобы привести объект контекста к состоянию строки, добавьте двойные кавычки.

   ![Приведение объекта контекста к состоянию строки](./media/logic-apps-azure-functions/function-request-body-string-cast-example.png)

7. Чтобы указать дополнительные сведения, например, метод использования, заголовки запроса или параметры запроса, выберите **Показать расширенные параметры**.

<a name="add-function-logic-app"></a>

## <a name="add-existing-functions-to-logic-apps"></a>Добавление существующих функций в приложение логики

Чтобы вызвать существующие функции Azure из приложений логики, можно добавить функции Azure, например, любые другие действия в конструкторе приложений логики. 

1. Откройте приложение логики в конструкторе приложений логики на <a href="https://portal.azure.com" target="_blank">портале Azure</a>. 

2. На шаге, в котором необходимо добавить функцию, последовательно выберите **Новый шаг** > **Add an action** (Добавить действие). 

3. В поле поиска введите "Функции Azure" в качестве условия фильтра.
Из списка действий выберите **Функции Azure — Выберите функцию Azure**. 

   ![Поиск "Функции Azure"](./media/logic-apps-azure-functions/find-azure-functions-action.png)

4. Выберите приложение-функцию из списка приложений-функций. После появления функции выберите ее. 

   ![Выберите приложение-функцию и функцию Azure](./media/logic-apps-azure-functions/select-function-app-existing-function.png)

   Для функций, которые имеют определения API (описания Swagger) и которые [настроены таким образом, чтобы приложение логики могло найти и получить к ним доступ](#function-swagger), можно выбрать **Действия Swagger**.

   ![Выбор приложения-функции, "Действия Swagger", функции Azure](./media/logic-apps-azure-functions/select-function-app-existing-function-swagger.png)

5. В поле **Текст запроса** укажите объект контекста, который передается как входные данные функции, которые должны быть отформатированы в формате JSON (нотация объектов JavaScript). Объект контекста описывает сообщение и содержимое, которые приложение логики отправляет в функцию. 

   После щелчка поля **Текст запроса** откроется список динамического содержимого, что позволит выбрать токены для свойств, доступных с предыдущих шагов. 
   В этом примере объект из триггера электронной почты будет передан токену **Текст**.

   ![Пример "Текста запроса": полезные данные объекта контекста](./media/logic-apps-azure-functions/function-request-body-example.png)

   В данном примере объект контекста не приводится как строка, что позволяет добавить содержимое напрямую в полезные данные JSON. 
   Тем не менее, если объект не является токеном JSON, который должен быть либо строкой, либо объектом или массивом JSON, появится сообщение об ошибке. 
   Чтобы привести объект контекста к состоянию строки, добавьте двойные кавычки.

   ![Приведение объекта контекста к состоянию строки](./media/logic-apps-azure-functions/function-request-body-string-cast-example.png)

6. Чтобы указать дополнительные сведения, например, метод использования, заголовки запроса или параметры запроса, выберите **Показать расширенные параметры**.

<a name="call-logic-app"></a>

## <a name="call-logic-apps-from-functions"></a>Вызов приложений логики из функций

Чтобы вызвать приложение логики изнутри функции Azure, оно должно обладать вызываемой конечной точкой, а точнее триггером **Запрос**. Затем изнутри функции на URL-адрес будет отправлен HTTP запрос POST для триггера **Запрос** и включены полезные данные, необходимые для обработки приложения логики. Дополнительные сведения см. в разделе [Вызов, активация и вложение приложений логики](../logic-apps/logic-apps-http-endpoint.md). 

## <a name="get-support"></a>Получение поддержки

* Если у вас возникли вопросы, то посетите [форум Azure Logic Apps](https://social.msdn.microsoft.com/Forums/en-US/home?forum=azurelogicapps).
* Отправить идею по поводу возможности или проголосовать за нее вы можете на [сайте отзывов пользователей Logic Apps](http://aka.ms/logicapps-wish).

## <a name="next-steps"></a>Дополнительная информация

* См. дополнительные сведения о [соединителях Logic Apps](../connectors/apis-list.md).
