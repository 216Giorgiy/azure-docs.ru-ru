<properties 
	pageTitle="Создание имитации гибридной облачной среды для тестирования" 
	description="Научитесь создавать имитацию гибридной облачной среды для ИТ-специалистов или тестирования разрабатываемых продуктов, используя две виртуальные сети Azure и подключения типа VNet-to-VNet." 
	services="virtual-network" 
	documentationCenter="" 
	authors="JoeDavies-MSFT" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="virtual-network" 
	ms.workload="infrastructure-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="03/18/2015" 
	ms.author="josephd"/>

# Создание имитации гибридной облачной среды для тестирования

В этом разделе описываются шаги по созданию смоделированной гибридной облачной среды с помощью Microsoft Azure для тестирования с использованием двух виртуальных сетей Azure. Эту конфигурацию можно использовать как альтернативу 
[созданию гибридной облачной среды для тестирования],(virtual-networks-setup-hybrid-cloud-environment-testing.md) когда у вас нет прямого подключения к Интернету и доступного общего IP-адреса. Это конфигурация, которая получается в результате.

![](./media/virtual-networks-set-up-simulated-hybrid-cloud-environment-for-testing/CreateSimHybridCloud_4.png)

Они позволяет смоделировать гибридную облачную рабочую среду. В ее состав входит:

- смоделированная и упрощенная локальная сеть, размещенная в виртуальной сети Azure (виртуальная сеть TestLab).
- смоделированная виртуальная сеть с подключением между организациями, размещенная в Azure (TestVNET).
- подключение типа "VNet-to-VNet" между двумя виртуальными сетями.
- дополнительный контроллер домена в виртуальной сети TestVNET.

Это основа и общая начальная точка, на базе которой можно:

- разрабатывать и тестировать приложения в смоделированной гибридной облачной среде.
- создавать конфигурации тестов компьютеров в виртуальной сети TestLab и TestVNET для имитации гибридных облачных рабочих нагрузок ИТ-среды.

Существует четыре основных этапа настройки данной тестовой среды гибридного облака:

1.	настройка виртуальной сети TestLab.
2.	создание виртуальной сети между организациями.
3.	создание подключения типа "VNet-to-VNet".
4.	Настройка DC2. 

Если у вас еще нет подписки Azure, можно зарегистрироваться для получения бесплатной пробной версии на веб-сайте [Try Azure](http://azure.microsoft.com/pricing/free-trial/). При наличии подписки MSDN см. статью [Преимущества Azure для подписчиков MSDN](http://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/).

>[AZURE.NOTE] Виртуальные машины и шлюзы виртуальных сетей в Azure создают текущие расходы во время своей работы. На эти затраты выставляется счет при использовании бесплатной пробной версии, подписки MSDN или платной подписки. Чтобы снизить затраты на работу этой тестовой среды, когда она не используется, см. информацию в подразделе [Минимизация текущих расходов, связанных с данной средой](#costs) этого раздела для получения дополнительных сведений.


## Этап 1. Настройка виртуальной сети TestLab

Используйте указания в документе [Руководство по TestLab: базовая конфигурация в Azure](http://www.microsoft.com/download/details.aspx?id=41684), чтобы настроить в виртуальной сети Azure с именем TestLab компьютеры DC1, APP1 и CLIENT1. 

В портале управления Azure на локальном компьютере подключитесь к DC1 , используя учетные данные CORP\User1. Для настройки домена CORP таким образом, чтобы компьютеры и пользователи использовали свой локальный контроллер домена для проверки подлинности, выполните следующие команды из командной строки Windows PowerShell с правами администратора.

	New-ADReplicationSite -Name "TestLab" 
	New-ADReplicationSite -Name "TestVNET"
	New-ADReplicationSubnet -Name "10.0.0.0/8" -Site "TestLab"
	New-ADReplicationSubnet -Name "192.168.0.0/16" -Site "TestVNET"

Это текущая конфигурация.

![](./media/virtual-networks-set-up-simulated-hybrid-cloud-environment-for-testing/CreateSimHybridCloud_1.png)
 
## Этап 2. Создание виртуальной сети TestVNET

Сначала создайте новую виртуальную сеть с именем TestVNET.

1.	На панели задач портала управления Azure щелкните **Создать > Сетевые службы > Виртуальная сеть > Настраиваемое создание**.
2.	На странице "Сведения о виртуальной сети№ введите **TestVNET** в поле **Имя**.
3.	В поле **Расположение** выберите подходящее расположение.
4.	Нажмите стрелку Далее.
5.	На странице DNS-серверы и подключение VPN в разделе **DNS-серверы** введите **DC1** в поле **Выбрать или ввести имя**,а затем нажмите стрелку Далее.
6.	На странице " Адресные пространства виртуальной сети":
	- в разделе **Адресное пространство**, в поле **Начальный IP-адрес** выберите или введите **192.168.0.0**.
	- В разделе **Подсети** щелкните **Subnet-1** и замените имя на **TestSubnet**. 
	- В столбце **CIDR (число адресов)** для TestSubnet щелкните **/24 (256)**.
7.	Щелкните значок Завершить. Дождитесь создания виртуальной сети прежде, чем продолжить.

Далее следуйте инструкциям из статьи [Установка и настройка Azure PowerShell на локальном компьютере](install-configure-powershell.md).

После этого создайте новую облачную службу для виртуальной сети TestVNET. Необходимо выбрать уникальное имя. Например, ее можно назвать **TestVNET-***UniqueSequence*, где *UniqueSequence* - это сокращенное название вашей организации. К примеру, если ваша организация называется Tailspin Toys, облачную службу можно назвать **TestVNET-Tailspin**.

Уникальность имени можно проверить, выполнив эту команду Azure PowerShell на локальном компьютере.

	Test-AzureName -Service <Proposed cloud service name>

Если команда возвращает значение "False",имя является уникальным. Создайте облачную службу с помощью этой команды.

	New-AzureService -Service <Unique cloud service name> -Location "<Same location name as your virtual network>"

Это текущая конфигурация.

![](./media/virtual-networks-set-up-simulated-hybrid-cloud-environment-for-testing/CreateSimHybridCloud_2.png)
 
##Этап 3. Создание подключения типа "VNet-to-VNet"

Для начала необходимо создать локальные виртуальные сети, представляющие адресное пространство каждой виртуальной сети.

1.	В портале управления Azure на локальном компьютере щелкните **Создать > Сетевые службы > Виртуальная сеть > Добавить локальную сеть**.
2.	На странице "Указание сведений о локальной сети" введите **TestLabLNet** в поле **Имя**, введите **131.107.0.1** в поле **IP-адрес устройства VPN**, а затем нажмите кнопку со стрелкой вправо.
3.	На странице "Указание адресного пространства" в поле **Начальный IP-адрес** введите **10.0.0.0**.
4.	В столбце **CIDR (количество адресов)** выберите **/24 (256)**, а затем установите флажок.
5.	Щелкните **Создать > Сетевые службы > Виртуальная сеть > Добавить локальную сеть**.
6.	На странице "Указание сведений о локальной сети" введите **TestVNETLNet** в поле **Имя**, введите **131.107.0.2** в поле **IP-адрес устройства VPN**, а затем нажмите кнопку со стрелкой вправо.
7.	На странице "Указание адресного пространства" в поле **Начальный IP-адрес** введите **192.168.0.0**.
8.	В столбце **CIDR (количество адресов)** выберите **/24 (256)**, а затем установите флажок.

Обратите внимание, что IP-адреса 131.107.0.1 и 131.107.0.2 устройства VPN используются лишь в качестве временных заполнителей до тех пор, пока не будут настроены шлюзы для двух виртуальных сетей.

Далее следует настроить каждую виртуальную сеть для использования VPN-подключения "сеть-сеть" и локальную сеть, соответствующую другой виртуальной сети.

1.	В портале управления Azure на локальном компьютере щелкните **Сети** в левой панели, а затем убедитесь, что столбец **Состояние** для **TestLab** имеет значение **Создан**.
2.	Последовательно щелкните **TestLab** и **Настроить**. На странице TestLab в разделе **Подключение сайт-сайт** щелкните **Подключение к локальной сети**. 
3.	В разделе **Локальная сеть** выберите **TestVNETLNet**.
4.	Щелкните **Сохранить** на панели задач. В некоторых случаях может потребоваться щелкнуть параметр **Добавить подсеть шлюза**, чтобы создать подсеть, которая используется шлюзом Azure VPN.
5.	Щелкните **Сети** в левой панели, а затем убедитесь, что столбец **Состояние** для TestVNET имеет значение **Создан**.
6.	Последовательно щелкните **TestVNET** и **Настроить**. На странице TestVNET в разделе **Подключение сайт-сайт** щелкните **Подключение к локальной сети**. 
7.	В разделе **Локальная сеть** выберите **TestLabLNet**.
8.	Щелкните **Сохранить** на панели задач. В некоторых случаях может потребоваться щелкнуть параметр **Добавить подсеть шлюза**, чтобы создать подсеть, которая используется шлюзом Azure VPN.

Далее необходимо создать шлюзы виртуальной сети для двух виртуальных сетей.

1.	В портале управления Azure на странице **Сети** щелкните **TestLab**. На странице Панель мониторинга вы должны увидеть состояние **Шлюз не был создан**.
2.	На панели задач щелкните **Создать шлюз**, а затем щелкните **Динамическая маршрутизация**. Щелкните **Да** при появлении запроса. Дождитесь завершения создания шлюза и изменения его состояния на **Подключение**. Это может занять несколько минут.
3.	На странице "Панель мониторинга" обратите внимание на **IP-адрес шлюза**. Это общий IP-адрес шлюза Azure VPN для виртуальной сети TestLab. Запишите этот IP-адрес, так как он понадобится для настройки подключения типа "VNet-to-VNet".
4.	На панели задач щелкните **Управление ключами**, а затем щелкните значок копирования рядом с ключом, чтобы скопировать его в буфер обмена. Вставьте этот ключ в документ и сохраните его. Это значение ключа необходимо для настройки подключения типа "VNet-to-VNet".
5.	На странице Сети щелкните **TestVNET**. На странице Панель мониторинга вы должны увидеть состояние **Шлюз не был создан**.
6.	На панели задач щелкните **Создать шлюз**, а затем щелкните **Динамическая маршрутизация**. Щелкните **Да** при появлении запроса. Дождитесь завершения создания шлюза и изменения его состояния на **Подключение**. Это может занять несколько минут.
7.	На странице "Панель мониторинга" обратите внимание на **IP-адрес шлюза**. Это общий IP-адрес шлюза Azure VPN для виртуальной сети TestVNET. Запишите этот IP-адрес, так как он понадобится для настройки подключения типа "VNet-to-VNet".

Далее следует настроить локальные сети TestLabLNet и TestVNETLNet с общими IP-адресами, которые были получены при создании шлюзов виртуальных сетей.

1.	В портале управление Azure на странице Сети щелкните **Локальные сети**. 
2.	Щелкните **TestLabLNet**, а затем нажмите кнопку **Изменить** на панели задач.
3.	На странице "Укажите сведения о локальной сети" введите IP-адрес шлюза виртуальной сети TestLab (см. шаг 3 предыдущей процедуры) в поле **IP-адрес VPN-устройства (необязательно)**, а затем щелкните стрелку вправо.
4.	На странице "Указание адресного пространства" установите флажок.
5.	На странице "Локальные сети" щелкните **TestVNETLNet**, а затем нажмите кнопку **Изменить** на панели задач.
6.	На странице "Указание сведений о локальной сети" введите IP-адрес шлюза виртуальной сети TestVNET (см. шаг 7 предыдущей процедуры) в поле **IP-адрес VPN-устройства (необязательно)**, а затем щелкните стрелку вправо.
7.	На странице "Указание адресного пространства" установите флажок.

Далее необходимо настроить общий ключ для обоих шлюзов, чтобы они использовали одно и то же значение ключа, которое было определено с помощью портала управления Azure для виртуальной сети TestLab. На локальном компьютере в командной строке Azure PowerShell выполните следующие команды, указав значение общего ключа TestLab.

	$preSharedKey="<The preshared key for the TestLab virtual network>"
	Set-AzureVNetGatewayKey -VNetName TestVNET -LocalNetworkSiteName TestLabLNet -SharedKey $preSharedKey

Далее на странице Сеть портала управления Azure на локальном компьютере последовательно щелкните виртуальную сеть **TestLab**, **Панель мониторинга** и **Подключить** на панели задач. Дождитесь пока состояние виртуальной сети TestLab не изменится на "подключено".

Это текущая конфигурация.

![](./media/virtual-networks-set-up-simulated-hybrid-cloud-environment-for-testing/CreateSimHybridCloud_3.png)
 
## Этап 4. Настройка DC2

Во-первых, необходимо создать виртуальную машину Azure для DC2. Выполните следующие команды в командной строке Azure PowerShell на локальном компьютере.

	$ServiceName="<Your cloud service name from Phase 2>"
	$cred=Get-Credential -Message "Type the name and password of the local administrator account for DC2."
	$image = Get-AzureVMImage | where { $_.ImageFamily -eq "Windows Server 2012 R2 Datacenter" } | sort PublishedDate -Descending | select -ExpandProperty ImageName -First 1
	$vm1=New-AzureVMConfig -Name DC2 -InstanceSize Medium -ImageName $image
	$vm1 | Add-AzureProvisioningConfig -Windows -AdminUsername $cred.GetNetworkCredential().Username -Password $cred.GetNetworkCredential().Password
	$vm1 | Set-AzureSubnet -SubnetNames TestSubnet
	$vm1 | Set-AzureStaticVNetIP -IPAddress 192.168.0.4
	$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 20 -DiskLabel ADFiles -LUN 0 -HostCaching None
	New-AzureVM -ServiceName $ServiceName -VMs $vm1 -VNetName TestVNET

Далее выполните вход в новую виртуальную машину DC2.

1.	На левой панели портала управления Azure щелкните **Виртуальные машины**, а затем щелкните **Работающие** в столбце **Состояние** для DC2.
2.	In На панели задач щелкните **Подключить**. 
3.	При появлении запроса на открытие DC2.rdp щелкните **Открыть**.
4.	При появлении запроса в окне сообщений "Подключение к удаленному рабочему столу" щелкните **Подключить**.
5.	При появлении запроса используйте следующие учетные данные:
- имя: **DC2\\**[имя учетной записи локального администратора];
- пароль: [пароль для учетной записи локального администратора].
6.	После появления запроса, ссылающегося на сертификаты, в окне сообщений "Подключение к удаленному рабочему столу" щелкните **Да**.

Далее настройте правила брандмауэра Windows, чтобы разрешить трафик для тестирования базовых параметров подключения. Из командной строки Windows PowerShell с правами администратора на DC2 выполните следующие команды.

	Set-NetFirewallRule -DisplayName "File and Printer Sharing (Echo Request - ICMPv4-In)" -enabled True
	ping dc1.corp.contoso.com

В результате выполнения команды ping должны быть получены четыре успешных ответа с IP-адреса 10.0.0.4. Это проверка трафика через подключение типа "Vnet-to-Vnet".

Далее следует добавить дополнительный диск данных как новый том с буквой диска F:.

1.	В левой панели диспетчера серверов щелкните **Файловые службы и службы хранилища**, а затем щелкните **Диски**.
2.	На панели содержимого в группе **Диски** щелкните **диск 2** (с параметром **Раздел**, имеющим значение **Неизвестно**).
3.	Последовательно щелкните **Задачи**, а затем **Новый том**.
4.	На странице "Прежде чем начать" мастера создания томов щелкните **Далее**.
5.	На странице "Выбор сервера и диска" щелкните **Диск 2**, а затем щелкните **Далее**. При появлении запроса нажмите кнопку **OK**.
6.	На странице "Указание размера тома" щелкните **Далее**.
7.	На странице "Назначение букве диска или папке" щелкните **Далее**.
8.	На странице "Выбор параметров файловой системы" щелкните **Далее**.
9.	На странице "Подтверждение выбранных параметров" щелкните **Создать**.
10.	После завершения нажмите кнопку **Закрыть**.

Затем настройте DC2 в качестве реплики контроллера домена для домена corp.contoso.com. Выполните следующие команды из командной строки Windows PowerShell на DC2.

	Install-WindowsFeature AD-Domain-Services -IncludeManagementTools
	Install-ADDSDomainController -Credential (Get-Credential CORP\User1) -DomainName "corp.contoso.com" -InstallDns:$true -DatabasePath "F:\NTDS" -LogPath "F:\Logs" -SysvolPath "F:\SYSVOL"

Следует иметь в виду, что вам будет предложено ввести пароль CORP\User1 и пароль режима восстановления служб каталогов (DSRM), а также перезапустить DC2.

Отметим, что виртуальная сеть TestVNET имеет собственный DNS-сервер(DC2). Необходимо настроить виртуальную сеть TestVNET для использования этого DNS-сервера.

1.	В левой панели портала управления Azure щелкните **Сети**, а затем щелкните **TestVNET**.
2.	Нажмите **Настроить**.
3.	В разделе **DNS-серверы** удалите запись 10.0.0.4.
4.	В разделе **DNS-серверы** добавьте запись с именем **DC2** и IP-адресом **192.168.0.4**. 
5.	В нижней части панели команд щелкните **Сохранить**, а затем нажмите кнопку **Да** при появлении запроса. Дождитесь завершения обновления сети TestVNet.

Это текущая конфигурация.

![](./media/virtual-networks-set-up-simulated-hybrid-cloud-environment-for-testing/CreateSimHybridCloud_4.png)
 
Смоделированная гибридная облачная среда готова для тестирования.

Построение этой конфигурации можно также выполнить в этой тестовой среде:

- [Ферма интрасети SharePoint](virtual-networks-setup-sharepoint-hybrid-cloud-testing.md)
- [Веб бизнес-приложение](virtual-networks-setup-lobapp-hybrid-cloud-testing.md)
- [Сервер синхронизации каталога (DirSync) Office 365](virtual-networks-setup-dirsync-hybrid-cloud-testing.md)

## Дополнительные ресурсы

[Создание гибридной облачной среды для тестирования](virtual-networks-setup-hybrid-cloud-environment-testing.md)

[Настройка подключения VNet-VNet](http://msdn.microsoft.com/library/azure/dn690122.aspx)


## <a id="costs"></a>Минимизация текущих расходов на такую среду

Чтобы свести к минимуму затраты на работающие виртуальные машины в этой среде, следует как можно быстрее выполнить необходимое тестирование и демонстрацию, а затем удалить или выключить виртуальные машины, если они не используются. Например, можно использовать автоматизацию Azure и Runbook для автоматического выключения виртуальных машин в виртуальных сетях TestLab и Test_VNET в конце каждого рабочего дня. Дополнительные сведения см. в статье [Приступая к работе с автоматизацией Azure](automation-create-runbook-from-samples.md). При повторном запуске виртуальных машин в подсети Corpnet следует сначала запустить DC1.

Шлюз Azure VPN реализован как набор двух виртуальных машин Azure, работа которых создает текущие денежные расходы. Дополнительные сведения см.в статье [Цены на виртуальную сеть](http://azure.microsoft.com/pricing/details/virtual-network/). Чтобы свести к минимуму затраты на два шлюза VPN (один для TestLab и один для TestVNET), следует создать тестовую среду и как можно быстрее выполнить необходимое тестирование и демонстрацию или удалить шлюзы, выполнив следующие действия.
 
1.	В портале управления Azure на локальном компьютере щелкните **Сети** в левой панели, щелкните **TestLab**, а затем нажмите кнопку **Панель мониторинга**.
2.	В панели задач щелкните **Удалить шлюз**. Щелкните **Да** при появлении запроса. Подождите пока шлюз не будет удален, а его состояние не изменится на **Шлюз не был создан**.
3.	Щелкните **Сети** в левой панели, щелкните **TestVNET**, а затем нажмите кнопку **Панель мониторинга**.
4.	В панели задач щелкните **Удалить шлюз**. Щелкните **Да** при появлении запроса. Подождите пока шлюз не будет удален, а его состояние не изменится на **Шлюз не был создан**.

Если шлюзы удаляются и необходимо восстановить эту тестовую среду, следует сначала создать новые шлюзы.

1.	В портале управления Azure на локальном компьютере щелкните **Сети** в левой панели, а затем щелкните **TestLab**. На странице Панель мониторинга вы должны увидеть состояние **Шлюз не был создан**.
2.	На панели задач щелкните **Создать шлюз**, а затем щелкните **Динамическая маршрутизация**. Щелкните **Да** при появлении запроса. Дождитесь завершения создания шлюза и изменения его состояния на **Подключение**. Это может занять несколько минут.
3.	На странице "Панель мониторинга" обратите внимание на **IP-адрес шлюза**. Это новый общий IP-адрес шлюза Azure VPN для виртуальной сети TestLab. Этот IP-адрес необходим для повторной настройки локальной сети TestLabLNet.
4.	На панели задач щелкните **Управление ключами**, а затем щелкните значок копирования рядом с ключом, чтобы скопировать его в буфер обмена. Вставьте значение этого ключа в документ и сохраните его. Значение этого ключа понадобится для повторной настройки шлюза VPN для виртуальной сети TestVNET.
5.	В портале управления Azure на локальном компьютере щелкните **Сети** в левой панели, а затем щелкните **TestVNET**. На странице Панель мониторинга вы должны увидеть состояние **Шлюз не был создан**.
6.	На панели задач щелкните **Создать шлюз**, а затем щелкните **Динамическая маршрутизация**. Щелкните **Да** при появлении запроса. Дождитесь завершения создания шлюза и изменения его состояния на "Подключение". Это может занять несколько минут.
7.	На странице "Панель мониторинга" обратите внимание на **IP-адрес шлюза**. Это новый общий IP-адрес шлюза Azure VPN для виртуальной сети TestVNET. Этот IP-адрес необходим для повторной настройки локальной сети TestVNETLNet.

Далее следует настроить локальные сети TestLabLNet и TestVNETLNet с общими IP-адресами, которые были получены при создании шлюзов виртуальных сетей.

1.	В портале управление Azure на странице Сети щелкните **Локальные сети**. 
2.	Щелкните **TestLabLNet**, а затем нажмите кнопку **Изменить** на панели задач.
3.	На странице "Указание сведений о локальной сети " введите IP-адрес шлюза виртуальной сети для виртуальной сети TestLab (из шага 3 предыдущей процедуры) в поле **IP-адрес устройства VPN (необязательно)**,а затем нажмите стрелку вправо.
4.	На странице "Указание адресного пространства" установите флажок.
5.	На странице "Локальные сети" щелкните **TestVNETLNet**, а затем нажмите кнопку **Изменить** на панели задач.
6.	На странице "Указание сведений о локальной сети" введите IP-адрес шлюза виртуальной сети для виртуальной сети TestVNET (из шага 7 предыдущей процедуры) в поле **IP-адрес устройства VPN (необязательно)**, а затем нажмите стрелку вправо.
7.	На странице "Указание адресного пространства" установите флажок.

Далее необходимо настроить общий ключ для обоих шлюзов, чтобы они использовали одно и то же значение ключа, которое было определено с помощью портала управления Azure для виртуальной сети TestLab. На локальном компьютере в командной строке Azure PowerShell выполните следующие команды, указав значение общего ключа TestLab.

	$preSharedKey="<The preshared key for the TestLab virtual network>"
	Set-AzureVNetGatewayKey -VNetName TestVNET -LocalNetworkSiteName TestLabLNet -SharedKey $preSharedKey

После этого на странице Сеть портала управления Azure щелкните виртуальную сеть **TestLab**, а затем щелкните **Подключить** на панели задач. Дождитесь пока виртуальная сеть TestLab не покажет подключенное состояние к локальной сети TestVNET.

<!--HONumber=49-->