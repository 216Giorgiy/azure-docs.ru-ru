---
title: Мониторинг производительности служб приложений Azure | Документация Майкрософт
description: Мониторинг производительности приложений для служб приложений Azure. Диаграммы времени загрузки и ответа, информация о зависимостях и настройка оповещений о производительности.
services: application-insights
documentationcenter: .net
author: mrbullwinkle
manager: carmonm
ms.assetid: 0b2deb30-6ea8-4bc4-8ed0-26765b85149f
ms.service: application-insights
ms.workload: na
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 02/26/2019
ms.author: mbullwin
ms.openlocfilehash: 92a7c1a45655f8804aa1f81b1a77ebf7cd5197e8
ms.sourcegitcommit: 5839af386c5a2ad46aaaeb90a13065ef94e61e74
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2019
ms.locfileid: "58122171"
---
# <a name="monitor-azure-app-service-performance"></a>Мониторинг производительности Службы приложений Azure
На [портале Azure](https://portal.azure.com) вы можете настроить мониторинг производительности веб-приложений, мобильных серверных частей и приложений API в [Службе приложений Azure](../../app-service/overview.md). [Azure Application Insights](../../azure-monitor/app/app-insights-overview.md) инструментируют ваше приложение для отправки данных телеметрии о действиях в службу Application Insights, где эти данные хранятся и анализируются. В этой службе диаграммы метрик и инструменты поиска могут использоваться для диагностики неисправностей, улучшения производительности и анализа использования приложения.

## <a name="runtime-or-build-time"></a>Время выполнения или построения
Вы можете настроить параметры мониторинга с помощью инструментирования приложения одним из следующих способов:

* **Среда выполнения** -можно выбрать производительности, отслеживание расширения, когда службы приложений уже активирован. Для этого не обязательно перестраивать или переустанавливать приложение. Вы получаете стандартный набор пакетов для отслеживания времени отклика, частоты успешных выполнений, исключений, зависимостей и т. д.

* **Во время сборки.** Вы можете добавить пакет в код своего приложения на этапе разработки. Этот способ является более гибким решением. Помимо установки стандартных пакетов, вы можете написать код для настройки данных телеметрии либо для отправки пользовательской телеметрии. Вы можете вести журнал действий или регистрировать события в соответствии с семантикой домена вашего приложения. Это также дает возможность протестировать последнюю версию пакета SDK Application Insights, как вы можете для оценки бета-версии пакетов SDK, тогда как наблюдение за предназначен только для последнего стабильного выпуска.

## <a name="runtime-instrumentation-with-application-insights"></a>Инструментарий среды выполнения с помощью Application Insights
Если вы сейчас используете службу приложений в Azure, вы уже получили определенные сведения мониторинга: частоты запросов и ошибок по умолчанию. Добавьте Application Insights, чтобы получить дополнительные сведения, такие как время отклика, мониторинг вызовов зависимостей, Интеллектуальное обнаружение, а доступ к мощный язык запросов Kusto. 

1. На панели управления Azure **выберите Application Insights** для своей службы приложений.

    ![В разделе "Параметры" выберите пункт Application Insights](./media/azure-web-apps/settings-app-insights.png)

   * Нажмите переключатель "Создать новый ресурс", если вы еще не настроили ресурс Application Insights для этого приложения. 

     > [!NOTE]
     > Нажав кнопку **OK** для создания нового ресурса, вам будет предложено выбрать параметр **Применение параметров мониторинга**. Нажав кнопку **Продолжить**, вы свяжете новый ресурс Application Insights со службой приложений, а также **активируете перезапуск самой службы приложений**. 

     ![Инструментирование веб-приложения](./media/azure-web-apps/create-resource.png)

2. Указав ресурс для использования, вы можете выбрать способ сбора данных в Application Insights для каждой платформы для приложения. Мониторинг приложений ASP.NET включен по умолчанию с двумя разными уровнями из коллекции.

    ![Выбор параметров для каждой платформы](./media/azure-web-apps/choose-options-new.png)

   * Уровень **базовой коллекции** .NET предоставляет основные возможности APM с одним экземпляром.
    
   * Уровень **рекомендуемой коллекции** .NET:
       * Добавляет тенденции использования ЦП, памяти и операций ввода-вывода.
       * Сопоставляет микрослужбы в пределах границ запросов или зависимостей.
       * Собирает тенденции использования и обеспечивает сопоставление от результатов доступности до транзакций.
       * Собирает исключения, необработанные хост-процессом.
       * Улучшает точность метрик APM под нагрузкой при использовании выборки.
    
     .NET core предоставляет **рекомендуется коллекции** или **отключено** для .NET Core 2.0 и 2.1.

3. **Выполните инструментирование службы приложений** после установки Application Insights.

   **Включите мониторинг на стороне клиента** для получения сведений о просмотрах страниц и данных телеметрии пользователя.

    (Эта функция включена по умолчанию для приложений .NET Core с **рекомендуемой коллекцией**, независимо от того, присутствует ли параметр APPINSIGHTS_JAVASCRIPT_ENABLED приложения. Сейчас детализированная поддержка для отключения мониторинга на стороне клиента через пользовательский интерфейс не поддерживается для .NET Core.)
    
   * Выберите элементы "Параметры > Параметры приложения".
   * В разделе "Параметры приложения" добавьте новую пару "ключ — значение":

     Ключ: `APPINSIGHTS_JAVASCRIPT_ENABLED`.

     Значение: `true`
   * **Сохраните** параметры и **перезапустите** приложение.

4. Просматривать данные мониторинга приложения можно, выбрав **Параметры** > **Application Insights** > **Больше в Application Insights**.

Позже при необходимости можно создать приложение с помощью Application Insights.

*Как удалить Application Insights или отправлять данные на другой ресурс?*

* Откройте колонку управления веб-приложением в Azure и в разделе параметров откройте **Application Insights**. Вы можете отключить Application Insights, щелкнув **Отключить** сверху. Можно также выбрать новый ресурс в разделе **	Изменение ресурса**.

## <a name="build-the-app-with-application-insights"></a>Создание приложения с поддержкой Application Insights
Установите пакет SDK в свое приложение, чтобы воспользоваться более подробными сведениями телеметрии Application Insights. В частности, можно собирать журналы трассировки, [написать код пользовательской телеметрии](../../azure-monitor/app/api-custom-events-metrics.md) и получать более подробные отчеты об исключениях.

1. **В Visual Studio** (2013 года с обновлением 2 или более поздней версии) настройте Application Insights для проекта.

    Щелкните веб-проект правой кнопкой мыши и выберите **Добавить > Application Insights** или **Проект** > **Application Insights** > **Настроить Application Insights**.

    ![Щелкните правой кнопкой мыши веб-проект и выберите добавление или настройку Application Insights.](./media/azure-web-apps/03-add.png)

    Если отобразится предложение войти, воспользуйтесь данными вашей учетной записи Azure.

    Операция выполняет два действия:

   1. Создает ресурс Application Insights, в котором выполняется отображение, хранение и анализ данных телеметрии.
   2. Добавляет пакет NuGet Application Insights в код (если его еще нет) и настраивает его для отправки данных телеметрии в ресурс Azure.
2. **Проверьте данные телеметрии**, запустив приложение на компьютере разработки (F5).
3. **Опубликуйте приложение** в Azure обычным способом. 

*Как отправлять данные на другой ресурс Application Insights?*

* В Visual Studio щелкните проект правой кнопкой мыши, выберите **Настроить Application Insights**, а затем выберите нужный ресурс. После этого вы сможете создать, заново собрать или повторно развернуть ресурс.

## <a name="automate-monitoring"></a>Автоматизация наблюдения

Чтобы включить сбор данных телеметрии с Application Insights должны быть заданы только параметры приложения:

   ![Параметры приложения службы приложений с доступными параметрами Application Insights](./media/azure-web-apps/application-settings.png)

### <a name="application-settings-definitions"></a>Определения параметров приложения

|Имя параметра приложения |  Определение | Значение |
|-----------------|:------------|-------------:|
|ApplicationInsightsAgent_EXTENSION_VERSION | Основным расширением, управляющий мониторинг среды выполнения. | `~2` |
|XDT_MicrosoftApplicationInsights_Mode |  По умолчанию режим только, основные возможности для обеспечения оптимальной производительности. | `default` или `recommended`. |
|InstrumentationEngine_EXTENSION_VERSION | Управляет, если ядро перезаписи двоичный файл `InstrumentationEngine` будет включена. Этот параметр влияет на производительность и влияет на время холодного запуска или запуска. | `~1` |
|XDT_MicrosoftApplicationInsights_BaseExtensions | Элементы управления, если SQL и Azure таблицы текст будет захватываться вместе с вызовами зависимостей. Предупреждение о производительности: для этого требуется `InstrumentationEngine`. | `~1` |

### <a name="app-service-application-settings-with-azure-resource-manager"></a>Параметры приложений службы приложений с помощью Azure Resource Manager

Параметры приложения для службы приложений можно управлять и настроены [шаблонов Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-authoring-templates). Этот метод может использоваться при развертывании новых ресурсов службы приложений с помощью службы автоматизации Azure Resource Manager, или для изменения параметров из существующих ресурсов.

Базовая структура JSON параметров приложения службы приложений приведен ниже:

```JSON
      "resources": [
        {
          "name": "appsettings",
          "type": "config",
          "apiVersion": "2015-08-01",
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', variables('webSiteName'))]"
          ],
          "tags": {
            "displayName": "Application Insights Settings"
          },
          "properties": {
            "key1": "value1",
            "key2": "value2"
          }
        }
      ]

```

Пример из Azure Resource Manager шаблон с помощью параметров приложения настроен для Application Insights это [шаблона](https://github.com/Andrew-MSFT/BasicImageGallery) может быть полезным, в частности раздел будет начинаться на [строка 238](https://github.com/Andrew-MSFT/BasicImageGallery/blob/c55ada54519e13ce2559823c16ca4f97ddc5c7a4/CoreImageGallery/Deploy/CoreImageGalleryARM/azuredeploy.json#L238).

### <a name="automate-the-creation-of-an-application-insights-resource-and-link-to-your-newly-created-app-service"></a>Автоматизируйте создание ресурса Application Insights и ссылку на только что созданный службы приложений.

Чтобы создать шаблон диспетчера ресурсов Azure с все настройки, установленные по умолчанию Application Insights, начните процесс, как, если нужно создать новое веб-приложение с помощью Application Insights включена.

Выберите **параметры автоматизации**

   ![Меню создания веб-приложения службы приложений](./media/azure-web-apps/create-web-app.png)

Это приводит к возникновению ошибки последний шаблон Azure Resource Manager с настроены все необходимые параметры.

  ![Шаблон веб-приложения службы приложений](./media/azure-web-apps/arm-template.png)

> [!NOTE]
> Шаблон создаст параметры приложения в режиме «default». Этот режим используется производительности оптимизированных для операций, хотя можно изменить шаблон, чтобы активировать любой функции, вы предпочитаете.

## <a name="more-telemetry"></a>Дополнительные данные телеметрии

* [Данные о загрузке веб-страницы](../../azure-monitor/app/javascript.md)
* [Пользовательская телеметрия](../../azure-monitor/app/api-custom-events-metrics.md)

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="do-i-still-need-to-go-to-extensions---add---application-insights-extension-for-new-app-service-apps"></a>Я по-прежнему нужно выберите расширения - Add - расширение Application Insights для приложения службы приложений?

Нет, вы больше не требуется вручную добавить расширение. Включение Application Insights в колонке параметров добавит все необходимые параметры приложения, чтобы включить мониторинг. Теперь это возможно, так как теперь являются файлы, добавленные ранее расширение [предварительно](https://github.com/projectkudu/kudu/wiki/Azure-Site-Extensions) как часть образа службы приложений. Файлы размещаются в `d:\Program Files (x86)\SiteExtensions\ApplicationInsightsAgent`.

### <a name="if-runtime-and-build-time-monitoring-are-both-enabled-do-i-end-up-with-duplicate-data"></a>Если среда выполнения и отслеживания сборки одновременно включены я в итоге с повторяющимися данными?

Нет, по умолчанию при обнаружении мониторинг времени сборки среды выполнения мониторинга через расширение будет остановки передачи данных, и будет учитываться только время сборки, Конфигурация мониторинга. Определяет, принадлежат ли отключить наблюдение за основана на определение любого из этих трех файлов:

* Microsoft.ApplicationInsights dll
* Microsoft.ASP.NET.TelemetryCorrelation dll
* System.Diagnostics.DiagnosticSource dll

Важно помнить, что в многих версиях Visual Studio, некоторые или все эти файлы добавляются по умолчанию файлы шаблонов ASP.NET и ASP.NET Core, Visual Studio. Если проект был создан за пределами одного из шаблонов, даже если вы не включили явно Application Insights, наличие зависимостей файл могли бы помешать наблюдение за активацию.

### <a name="appinsightsjavascriptenabled-causes-incomplete-html-response-in-net-core-web-applications"></a>Параметр APPINSIGHTS_JAVASCRIPT_ENABLED вызывает неполный ответ HTML в веб-приложениях NET CORE.

Включение Javascript с помощью служб приложений может привести к усечению HTML-ответов.

* Возможное решение 1. Задайте для параметра приложения APPINSIGHTS_JAVASCRIPT_ENABLED значение false либо полностью удалите этот параметр и выполните перезагрузку.
* Обходной путь 2: добавьте пакет sdk с помощью кода и удалению расширения (Profiler и Snapshot debugger не будет работать с этой конфигурацией)

Чтобы отслеживать эту проблему, перейдите к [расширение Azure, вызывая неполный ответ HTML](https://github.com/Microsoft/ApplicationInsights-Home/issues/277).

Сейчас для .NET Core **не поддерживается** следующее:

* автономное развертывание;
* приложения, предназначенные для .NET Framework;
* приложения .NET Core 2.2.

> [!NOTE]
> Поддерживается .NET Core версии 2.0 и 2.1. Когда будет добавлена поддержка .NET Core 2.2, эта статья будет обновлена.

## <a name="next-steps"></a>Дальнейшие действия
* [Запуск профилировщика в живом приложении](../../azure-monitor/app/profiler.md).
* [Функции Azure.](https://github.com/christopheranderson/azure-functions-app-insights-sample) Отслеживайте функции Azure с помощью Application Insights.
* [Включите отправку данных диагностики Azure](../../azure-monitor/platform/diagnostics-extension-to-application-insights.md) в Application Insights.
* [Отслеживайте метрики состояния службы](../../azure-monitor/platform/data-collection.md), чтобы убедиться, что служба доступна и отвечает на запросы.
* [Получайте уведомления](../../azure-monitor/platform/alerts-overview.md) при возникновении операционных событий или превышении пороговых значений метрик.
* Используйте [расширение Application Insights для приложений JavaScript и веб-страниц](../../azure-monitor/app/javascript.md), чтобы получать данные телеметрии клиентов из браузеров, которые используются для открытия веб-страницы.
* [Настройте веб-тесты доступности](../../azure-monitor/app/monitor-web-app-availability.md), чтобы получать уведомления о сбоях в работе сайта.