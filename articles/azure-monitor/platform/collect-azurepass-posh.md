---
title: Сбор метрик ресурсов PaaS в Azure с помощью Log Analytics | Документация Майкрософт
description: Узнайте, как с помощью PowerShell включить сбор метрик ресурсов PaaS в Azure для хранения и анализа в службе Log Analytics.
services: log-analytics
documentationcenter: log-analytics
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ''
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 10/23/2018
ms.author: magoedte
ms.openlocfilehash: b7896ccc979d7c5bcdf6c46cbbef01d261a3a625
ms.sourcegitcommit: 5b869779fb99d51c1c288bc7122429a3d22a0363
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2018
ms.locfileid: "53183902"
---
# <a name="configure-collection-of-azure-paas-resource-metrics-with-log-analytics"></a>Сбор метрик ресурсов PaaS в Azure с помощью Log Analytics

В Azure ресурсы PaaS (платформа как услуга), например Azure SQL и веб-сайты (веб-приложения), имеют встроенные механизмы для передачи метрик производительности в Log Analytics. Этот скрипт позволяет пользователям включить ведение журнала метрик для ресурсов PaaS, развернутых в отдельной группе ресурсов, или для всех ресурсов подписки сразу. 

В настоящее время на портале Azure нет механизмов, позволяющих включить ведение журнала метрик для ресурсов PaaS. Пока это можно сделать только с помощью скрипта PowerShell. Встроенные механизмы ведения журнала метрик в сочетании с механизмом мониторинга Log Analytics позволяют отслеживать большое количество ресурсов Azure. 

## <a name="prerequisites"></a>Предварительные требования
Прежде чем продолжить, убедитесь, что на вашем компьютере установлены следующие модули Azure Resource Manager:

- AzureRM.Insights;
- AzureRM.OperationalInsights;
- AzureRM.Resources
- AzureRM.profile

>[!NOTE]
>Рекомендуем использовать одинаковые версии модулей Azure Resource Manager, чтобы обеспечить их совместимость при выполнении команд Azure Resource Manager из PowerShell.
>
Чтобы установить на компьютере последнюю версию модулей Azure Resource Manager, выполните инструкции в статье [Установка и настройка Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-azurerm-ps?view=azurermps-4.4.1#update-azps).  

## <a name="enable-azure-diagnostics"></a>Включение системы диагностики Azure  
Чтобы настроить систему диагностики Azure для ресурсов PaaS, выполните скрипт **Enable-AzureRMDiagnostics.ps1** из [коллекции PowerShell](https://www.powershellgallery.com/packages/Enable-AzureRMDiagnostics/2.52).  Этот скрипт поддерживает несколько сценариев работы:
  
* назначение ресурса, связанного с одной или несколькими группами ресурсов в подписке;  
* назначение ресурса, связанного с конкретной группой ресурсов в подписке;  
* изменение параметров ресурса для пересылки в другую рабочую область.

Можно использовать только те ресурсы, которые поддерживают сбор метрик при помощи системы диагностики Azure и напрямую отправляют их в Log Analytics.  Полный список этих ресурсов есть в статье [Сбор журналов и метрик для служб Azure для использования в Log Analytics](collect-azure-metrics-logs.md). 

Выполните приведенные ниже инструкции, чтобы скачать и выполнить этот скрипт.

1.  На начальном экране Windows введите **PowerShell** и щелкните правой кнопкой мыши PowerShell в результатах поиска.  В контекстном меню выберите действие **Запуск от имени администратора**.   
2. Сохраните скрипт **Enable-AzureRMDiagnostics.ps1** на локальном компьютере, выполнив следующую команду и указав путь для сохранения:    

    ```
    PS C:\> save-script -Name Enable-AzureRMDiagnostics -Path "C:\users\<username>\desktop\temp"
    ```

3. Выполните команду `Connect-AzureRmAccount`, чтобы создать подключение к Azure.   
4. Запустите скрипт `.\Enable-AzureRmDiagnostics.ps1` без параметров, чтобы включить сбор данных из определенного ресурса в вашей подписке, или с параметром `-ResourceGroup <myResourceGroup>`, чтобы указать ресурс в определенной группе ресурсов.   
5. Если у вас есть несколько подписок, выберите в списке нужную, указав правильное значение.<br><br> ![Выбор подписки в списке, выведенном при помощи скрипта](./media/collect-azurepass-posh/script-select-subscription.png)<br> Если доступна всего одна подписка, скрипт выбирает ее автоматически.
6. Затем при помощи скрипта выводится список рабочих областей Log Analytics, зарегистрированных в выбранной подписке.  Выберите в нем нужную область.<br><br> ![Выбор рабочей области в списке, выведенном при помощи скрипта](./media/collect-azurepass-posh/script-select-workspace.png)<br> 
7. Выберите ресурс Azure, для которого нужно включить сбор данных. Например, нажав клавишу 5, вы включите сбор данных в базах данных SQL Azure.<br><br> ![Выбор типа ресурса в списке, выведенном при помощи скрипта](./media/collect-azurepass-posh/script-select-resource.png)<br>
   Вы можете выбрать только те ресурсы, которые поддерживают сбор метрик при помощи системы диагностики Azure и напрямую отправляют их в Log Analytics.  В столбце **Metrics** (Метрики) скрипта отобразится значение **True** для ресурсов, обнаруженных в выбранной подписке или группе ресурсов.    
8. Отобразится запрос на подтверждение выбора.  Введите **Y**, чтобы включить ведение журнала метрик для всех выбранных ресурсов в выбранной области действия. В нашем примере это все базы данных SQL в подписке.  

При помощи скрипта для каждого из ресурсов, соответствующих выбранным условиям, будет включен сбор метрик. Когда работа завершится, появится сообщение о завершении настройки.  

Вскоре после завершения вы сможете убедиться, что данные из выбранных ресурсов (ресурса) PaaS Azure поступают в репозиторий Log Analytics.  Будет создана запись с типом `AzureMetrics`. Такие записи вы можете анализировать в решениях по управлению [Аналитика SQL Azure](../../azure-monitor/insights/azure-sql.md) и [Аналитика веб-приложений Azure](../../azure-monitor/insights/azure-web-apps-analytics.md).   

## <a name="update-a-resource-to-send-data-to-another-workspace"></a>Изменение параметров ресурса для отправки данных в другую рабочую область
Если ваш ресурс отправляет данные в рабочую область Log Analytics, но вам нужно перенаправить их в другую рабочую область, можно применить тот же самый скрипт с параметром `-Update`.  

**Пример:** 
`PS C:\users\<username>\Desktop\temp> .\Enable-AzureRMDiagnostics.ps1 -Update`

Отобразится запрос на те же сведения, что и для начальной настройки, которая описана выше.  

## <a name="next-steps"></a>Дополнительная информация

* Узнайте больше об [операциях поиска по журналу](../../azure-monitor/log-query/log-query-overview.md) , которые можно применять для анализа данных, собираемых из источников данных и решений. 

* Используйте [настраиваемые поля](../../azure-monitor/platform/custom-fields.md) для анализа записей событий по отдельным полям.

* Из статьи [Создание пользовательской панели мониторинга для Log Analytics](../../azure-monitor/platform/dashboards.md) вы узнаете, как визуализировать поиск по журналам, чтобы получить полезную для вашей организации информацию.
