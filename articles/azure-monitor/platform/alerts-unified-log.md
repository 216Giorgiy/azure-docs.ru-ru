---
title: Оповещения журнала в Azure Monitor
description: Узнайте, как активировать сообщения электронной почты и уведомления, вызывать URL-адреса веб-сайтов (использовать веб-перехватчики) или автоматизировать операции при выполнении заданных вами условий запросов аналитики в интерфейсе оповещений Azure.
author: msvijayn
services: monitoring
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 10/01/2018
ms.author: vinagara
ms.component: alerts
ms.openlocfilehash: 6a1b9c110c79e428ab0cc182d0da370e59bc4f30
ms.sourcegitcommit: 85d94b423518ee7ec7f071f4f256f84c64039a9d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2018
ms.locfileid: "53386219"
---
# <a name="log-alerts-in-azure-monitor"></a>Оповещения журнала в Azure Monitor
В этой статье рассматриваются оповещения журнала. Это один из типов оповещений, которые поддерживаются в системе [оповещений Azure](../../azure-monitor/platform/alerts-overview.md) и позволяют пользователям применять платформу аналитики Azure в качестве основы для оповещений.

Оповещение журнала состоит из правил поиска по журналам, созданных для [Azure Log Analytics](../../azure-monitor/learn/tutorial-viewdata.md) или [Application Insights](../../application-insights/app-insights-cloudservices.md#view-azure-diagnostic-events). Дополнительные сведения о его использовании см. в сведениях о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).

> [!NOTE]
> Распространенные данные журнала из [Azure Log Analytics](../../azure-monitor/learn/tutorial-viewdata.md) теперь также доступны на платформе метрик в Azure Monitor. Более подробную информацию см. в статье [Create Metric Alerts for Logs in Azure Monitor](../../azure-monitor/platform/alerts-metric-logs.md) (Создание оповещений метрик для журналов в Azure Monitor).


## <a name="log-search-alert-rule---definition-and-types"></a>Правило генерации оповещений для поиска по журналам: определения и типы

Правила поиска по журналам создаются в интерфейсе оповещений Azure, чтобы указанные запросы к журналу автоматически выполнялись с регулярными интервалами.  Если результаты запроса к журналу отвечают определенным условиям, создается запись оповещения. Затем правило может автоматически выполнять одно или несколько действий с помощью [групп действий](../../azure-monitor/platform/action-groups.md). 

Правила поиска по журналам определяются следующими сведениями:
- **Запрос к журналу.**  Это запрос, который будет запускаться каждый раз при срабатывании правила генерации оповещений.  Определить, создается ли оповещение, можно с помощью записей, возвращаемых этим запросом. Запрос аналитики также может включать [вызовы между приложениями](https://dev.applicationinsights.io/ai/documentation/2-Using-the-API/CrossResourceQuery) (вызовы между рабочими областями) и [вызовы между ресурсами](../../azure-monitor/log-query/cross-workspace-query.md) при условии, что у пользователя есть права доступа к внешним приложениям. 

    > [!IMPORTANT]
    > Для создания, изменения и обновления оповещений журнала в Azure Monitor у пользователя должна быть роль [участника мониторинга Azure](../../azure-monitor/platform/roles-permissions-security.md) наряду с правами доступа и выполнения запросов для целевых показателей аналитики в правилах генерации оповещений или запросах оповещений. Если при создании у пользователя отсутствует доступ ко всем целевым показателям аналитики в правиле генерации оповещений или запросе оповещения, создание правила может завершиться сбоем или правило генерации оповещений журнала будет выполнено с частичными результатами.

- **Период.**  Указывает диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, ago), используемую в запросе журнала. <br>*Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала возвращаются только записи, созданные между 12:15 и 13:15. Если в запросе журнала будет использована команда времени, например ago (7d), запрос журнала будет выполняться только для данных между 12:15 и 13:15 — как если бы данные существовали только за последние 60 минут. Данные за семь дней, как указано в запросе журнала, не будут выводиться.*
- **Частота**.  Указывает, как часто должен выполняться запрос. Это значение может составлять от 5 минут до 24 часов. Оно не должно превышать указанный период.  Если значение больше, чем указанный период, записи могут быть пропущены.<br>*Например, рассмотрим период в 30 минут и частоту в 60 минут.  Если запрос выполняется в 13:00, он возвращает записи между 12:30 и 13:00.  В следующий раз этот запрос будет выполнен в 14:00, а записи возвратятся между 13:30 и 14:00.  Записи, созданные между 13:00 и 13:30, не будут учитываться.*
- **Пороговое значение**.  Чтобы определить, следует ли создавать оповещение, оцениваются результаты поиска по журналам.  Для каждого типа правил генерации оповещений для поиска по журналам определяется собственное пороговое значение.

Правила поиска по журналам могут быть двух типов (как для [Azure Log Analytics](../../azure-monitor/learn/tutorial-viewdata.md), так и для [Application Insights](../../application-insights/app-insights-cloudservices.md#view-azure-diagnostic-events)). Каждый из этих типов подробно описан в последующих разделах.

- **[Число результатов](#number-of-results-alert-rules)**. Если число записей, возвращенных в результатах поиска по журналам, превышает указанное количество, создается оповещение.
- **[Измерение метрик](#metric-measurement-alert-rules)**.  Оповещение, созданное для каждого объекта в результатах поиска по журналам со значением, превышающим указанное пороговое значение.

Ниже приведены различия между типами правил генерации оповещений.

- Правило генерации оповещений *Число результатов* всегда создает одно оповещение, а правило *Измерение метрик* — по одному для каждого объекта, который превышает порог.
- Правило генерации оповещений *Число результатов* создает оповещение при одноразовом превышении порогового значения. Правило генерации оповещений *Измерение метрик* может создавать оповещение при превышении порогового значения определенное количество раз за указанный интервал времени.

### <a name="number-of-results-alert-rules"></a>Правило генерации оповещений "Число результатов"
Правила генерации оповещений **Число результатов** создают одно оповещение, если количество записей, возвращенных в результатах поискового запроса, превышает указанное пороговое значение. Этот тип правила генерации оповещений идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал, ответ веб-приложения и настраиваемые журналы.  Возможно, вам потребуется создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в течение определенного периода.

**Пороговое значение.** Порог для правила генерации оповещений "Число результатов" больше или меньше определенного значения.  Если число записей, возвращенных в результатах поиска по журналам, соответствует этому критерию, создается оповещение.

Для оповещения об отдельном событии задайте количество результатов больше 0 и проверяйте наличие одного события, созданного с момента последнего выполнения запроса. Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае, возможно, вам потребуется создавать оповещение только в случае возникновения нескольких событий за определенный период.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного периода, следует создать оповещение.  В этом случае задайте для порога значение **меньше 1**.

#### <a name="example-of-number-of-records-type-log-alert"></a>Пример оповещения журнала типа "Количество записей"
Рассмотрим сценарий, где нужно узнать, когда веб-приложение предоставит пользователям ответ с кодом 500 ("Внутренняя ошибка сервера"). Необходимо создать правило генерации оповещений со следующими сведениями:  
- **Запрос:** запросы | где resultCode == 500.<br>
- **Период времени:** 30 минут<br>
- **Частота предупреждений:** 5 минут.<br>
- **Пороговое значение:** больше 0.<br>

После этого оповещение будет выполнять запрос каждые 5 минут с 30 минутами данных для поиска записей с кодом результата 500. Если будет найдена хотя бы одна такая запись, сработает оповещение и запустится настроенное действие.

### <a name="metric-measurement-alert-rules"></a>Metric measurement alert rules (Измерение метрики для правила генерации оповещений)

- Правила генерации оповещений **Измерение метрик** создают оповещение для каждого объекта в запросе со значением, превышающим указанное пороговое значение.  Ниже приведены их четко выраженные отличия от правил генерации оповещений **Число результатов**.
- **Агрегатная функция.** Указывает выполняемые вычисления и (необязательно) числовое поле для статистических вычислений.  Например, **count()** возвращает число записей в запросе, а **avg(CounterValue)** — среднее значение поля CounterValue в рамках указанного интервала. Агрегатная функция в запросе должна иметь имя: AggregatedValue и указывать числовое значение. 
- **Группировка по полю.** Для каждого экземпляра этого поля будет создана запись с агрегированным значением, и для каждого из них можно создать оповещение.  Например, чтобы создать оповещение для каждого компьютера, используйте группировку **по компьютерам**. 

    > [!NOTE]
    > Для правил генерации оповещений "Измерение метрик" на основе Application Insights можно указать поле для группирования данных. Для этого в определении правила используйте параметр **Aggregate on** (Агрегирование по).   
    
- **Интервал.**  Определяет интервал времени, в течение которого выполняется статистическое вычисление данных.  Например, если вы указали значение **5 минут**, создается запись для каждого экземпляра поля группы, вычисленного с интервалом в 5 минут за период, указанный для оповещения.

    > [!NOTE]
    > В запросе для указания интервала необходимо использовать функцию Bin. Так как при использовании bin() можно получить неравные интервалы времени, интерфейс оповещений будет автоматически преобразовывать команду bin в команду bin_at с соответствующим временем выполнения, чтобы гарантировать получение результатов с фиксированной запятой. Тип оповещения журнала "Измерение метрик" предназначен для работы с запросами, имеющими единственную команду bin()
    
- **Пороговое значение.** Пороговое значение для правил генерации оповещений "Измерение метрик" определяется на основе статического значения и числа нарушений.  Если любая точка данных в результатах поиска по журналам превышает это значение, она рассматривается как нарушение.  Когда число нарушений в результатах для любого объекта превышает указанное значение, для этого объекта создается оповещение.

#### <a name="example-of-metric-measurement-type-log-alert"></a>Пример оповещения журнала типа "Измерение метрик"
Рассмотрим ситуацию, где оповещение должно создаваться, когда использование процессора на компьютере превышает 90 % три раза в течение 30 минут.  Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос** Perf | where ObjectName == "Processor" and CounterName == "% Processor Time" | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer<br>
- **Период времени:** 30 минут<br>
- **Частота предупреждений:** 5 минут.<br>
- **Статистическое значение:** больше 90.<br>
- **Активировать оповещение на основе:** общее число нарушений превышает 2.<br>

Запрос вернет среднее значение для каждого компьютера с интервалом в 5 минут.  Этот запрос выполняется каждые 5 минут для данных, собранных в течение предыдущих 30 минут.  Ниже приведен пример данных для трех компьютеров.

![Результаты выполнения примера запроса](media/alerts-unified-log/metrics-measurement-sample-graph.png)

В этом примере отдельные оповещения создаются для компьютеров srv02 и srv03, так как за указанный период они 3 раза превысили пороговое значение в 90 %.  Если значение параметра **Активировать оповещение на основе:** изменить на **Consecutive** (Последовательные нарушения), оповещение будет создано только для компьютера srv03, так как для него 3 раза подряд зафиксировано превышение порога.

## <a name="log-search-alert-rule---firing-and-state"></a>Правило генерации оповещений в поиске по журналу — срабатывание и состояние
Правило генерации оповещений в поиске по журналу работает по логике, заданной пользователем в соответствии с конфигурацией и используемым пользовательским запросом аналитики. Так как логика точного условия или причины, по которой должно срабатывать правило генерации оповещений, инкапсулируется в запросе аналитики, он может отличаться в каждом правиле генерации оповещений журнала. Оповещения Azure содержат ограниченную информацию о конкретной основной причине в результатах журнала, когда условие порога правила генерации оповещений в поиске по журналам соблюдается или превышено. Таким образом, оповещения журнала называются оповещениями без учета состояния и будут срабатывать каждый раз, когда результат поиска в журнале будет достаточным для превышения порогового значения, указанного в оповещениях журнала о типе условия *Количество результатов* или *Измерение метрики*. Правила генерации оповещений журнала всегда будут срабатывать, пока результат запроса аналитики пользователя соответствует условию оповещения и ни одно из оповещений не устраняется. Так как логика точной причины сбоя мониторинга маскируется внутри запроса аналитики, предоставленного пользователем, нет никаких средств, с помощью которых оповещения Azure могут окончательно определить, дает ли разрешение проблемы результат поиска по журналу, не отвечающий пороговому значению.

Теперь предположим, что у нас есть правило генерации оповещений журнала, которое называется *Contoso-Log-Alert* в соответствии с конфигурацией в [примере, представленном для оповещения журнала типа "Количество результатов"](#example-of-number-of-records-type-log-alert). 
- В 13:05, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, результат поиска по журналу выдал 0 записей ниже порога, из-за чего оповещение не появилось. 
- В следующей итерации в 13:10, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, в результате поиска по журналу было получено 5 записей. Это выше порога, поэтому сработало оповещение вскоре после запуска связанной [группы действий](../../azure-monitor/platform/action-groups.md). 
- В 13:15, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, в результате поиска по журналу было получено 2 записи. Порог был превышен, из-за чего сработало оповещение вскоре после запуска связанной [группы действий](../../azure-monitor/platform/action-groups.md).
- Далее в следующей итерации в 13:20, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, в результате поиска по журналу снова было предоставлено 0 записей ниже порога, из-за чего оповещение не появилось.

Но в приведенном выше случае в 13:15 оповещения Azure не могут определить, сохраняются ли основные проблемы, наблюдаемые в 13:10, и есть ли новые сбои. Так как запрос, предоставленный пользователем, может учитывать предыдущие записи, оповещения Azure могут точно определить то, что нужно. Следовательно, когда правило Contoso-Log-Alert выполняется в 13:15, настроенная [группа действий](../../azure-monitor/platform/action-groups.md) оповещается снова в целях предосторожности. Теперь в 13:20, когда записи не появляются, оповещения Azure не могут с точностью определить, что причина записей устранена, поэтому состояние правила Contoso-Log-Alert не будет изменено на "Разрешено" на панели мониторинга оповещений Azure, а также не будут доступны уведомления об устранении проблемы.


## <a name="pricing-and-billing-of-log-alerts"></a>Цены и выставление счетов для оповещений журнала
Цены, применимые к оповещениям журнала, установлены на странице [цен Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/). В счетах Azure оповещения журнала представлены типом `microsoft.insights/scheduledqueryrules`. Кроме того:
- Для оповещений журнала Application Insights указываются точное имя оповещения, группа ресурсов и свойства оповещения.
- Для оповещений журнала Log Analytics указываются имя оповещения в формате `<WorkspaceName>|<savedSearchId>|<scheduleId>|<ActionId>`, группа ресурсов и свойства оповещения.

    > [!NOTE]
    > Имена всех сохраненных поисковых запросов, отчетов и действий, создаваемых с помощью API Log Analytics, должны быть в нижнем регистре. Если используются недопустимые символы, такие как `<, >, %, &, \, ?, /`, в счете они будут заменены символом `_`.

## <a name="next-steps"></a>Дополнительная информация
* Дополнительные сведения о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).
* Информация о [веб-перехватчиках в оповещениях журналов в Azure](alerts-log-webhook.md).
* Сведения об [оповещениях Azure](../../azure-monitor/platform/alerts-overview.md).
* Дополнительные сведения об [Application Insights](../../application-insights/app-insights-analytics.md).
* Дополнительные сведения о [Log Analytics](../../azure-monitor/log-query/log-query-overview.md).    
