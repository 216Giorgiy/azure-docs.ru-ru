---
title: Устранение неполадок с оповещениями журналов в Azure Monitor
description: Распространенные проблемы, ошибки и методы их устранения для правил генерации оповещений журналов в Azure.
author: msvijayn
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 10/29/2018
ms.author: vinagara
ms.subservice: alerts
ms.openlocfilehash: 56d76cd43b63a389569ae39c1e987a5fccbb9793
ms.sourcegitcommit: 9999fe6e2400cf734f79e2edd6f96a8adf118d92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2019
ms.locfileid: "54429452"
---
# <a name="troubleshooting-log-alerts-in-azure-monitor"></a>Устранение неполадок с оповещениями журналов в Azure Monitor  

## <a name="overview"></a>Обзор

В этой статье показано, как разрешать распространенные проблемы, встречающиеся при настройке оповещений журналов в Azure Monitor. Здесь также приведены ответы на часто задаваемые вопросы о работе и настройке оповещений журналов. 

Термин **оповещения журнала** описывает оповещения, которые основаны на пользовательском запросе в [Log Analytics](../learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/analytics.md). Дополнительные сведения о функциях, терминологии и типах см. в статье [Оповещения журнала в Azure Monitor](../platform/alerts-unified-log.md).

> [!NOTE]
> В этой статье не рассматриваются случаи, когда правило генерации оповещений отображается на портале Azure как активированное и отправляет уведомление через связанные группы действий. В таких случаях см. сведения о [группах действий](../platform/action-groups.md).


## <a name="log-alert-didnt-fire"></a>Оповещение журналов не срабатывает

Ниже приведены некоторые распространенные причины, почему настроенное [правило оповещения журнала в Azure Monitor](../platform/alerts-log.md) не отображает состояние [как *Инициировано* в предполагаемое время](../platform/alerts-managing-alert-states.md). 

### <a name="data-ingestion-time-for-logs"></a>Время приема данных для журналов

Оповещения журналов периодически выполняют запросы через [Log Analytics](../learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/analytics.md). Так как Log Analytics обрабатывает много терабайт данных от тысяч клиентов и множества источников, распределенных по всему миру, в ее работе часто происходят различные задержки. См. дополнительные сведения о [времени приема данных в Log Analytics](../platform/data-ingestion-time.md).

Чтобы избежать задержки приема данных, система ждет и повторяет запрос предупреждения несколько раз, если обнаруживает, что необходимые данные еще не поступают. Система имеет экспоненциально возрастающее время ожидания. Предупреждение о регистрации журнала запускается только после того, как данные доступны, поэтому они могут задерживаться из-за медленного приема данных журнала. 

### <a name="incorrect-time-period-configured"></a>Неправильно настроен период времени

Как описано в статье с [терминологией для оповещений журналов](../platform/alerts-unified-log.md#log-search-alert-rule---definition-and-types), настроенный в конфигурации период времени определяет диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в указанный период времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, *ago*), используемую в запросе журнала. Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала используются только записи, созданные между 12:15 и 13:15. Если журнал запроса использует команду времени *ago (1d)*, запрос будет по прежнему использовать данные в диапазоне 12:15 и 1:15, так как в интервале задан этот период времени*.

Таким образом проверка этого периода времени в конфигурации соответствует условиям. Для описанного выше примера, где используется команда *ago (1d)*, как отмечено зеленым маркером, период времени должен составлять 24 часа (1440 минут, как указано красным цветом), чтобы результат выполнения такого запроса выполнятся, как ожидается.

![Период времени](media/alert-log-troubleshoot/LogAlertTimePeriod.png)

### <a name="suppress-alerts-option-is-set"></a>Настроена отмена вывода оповещений

Как описано в шаге 8 о создании [правил генерации оповещений для поиска по журналам на портале Azure](../platform/alerts-log.md#managing-log-alerts-from-the-azure-portal), оповещения журнала содержат параметр **отключения оповещений**, отключающий действия оповещения и уведомления в течении заданного времени. Таким образом, может показаться, что оповещения не срабатывают, хотя на самом деле они были отключены.  

![Отключение оповещений](media/alert-log-troubleshoot/LogAlertSuppress.png)

### <a name="metric-measurement-alert-rule-is-incorrect"></a>Неправильно настроено правило генерации оповещений "Измерение метрик"

**Оповещения журнала измерения метрик** являются подтипом оповещений журнала, которые обладают специальными возможностями и ограниченным синтаксисом запроса оповещений. Правило генерации оповещений журналов "Измерение метрик" требует, чтобы выходные данные запроса предоставляли временные ряды метрик, то есть таблицу с равномерно распределенными периодами времени и агрегированными значениями. Кроме того, пользователи могут настроить дополнительные переменные в таблице наряду с AggregatedValue. Эти переменные могут использоваться для сортировки таблицы. 

Предположим, что мы настроили такое правило генерации оповещений журнала с типом "Измерение метрик", как показано ниже:

- выполняемый запрос: `search *| summarize AggregatedValue = count() by $table, bin(timestamp, 1h)`;  
- период времени: 6 часов;
- пороговое значение: 50;
- логика оповещений: три последовательных нарушения;
- статистическое выражение (Aggregate Upon): $table.

Так как команда содержит *summarize … by* и предоставляет две переменные (timestamp и $table), система выберет $table в качестве *Aggregate Upon*. В итоге таблица результатов будет отсортирована по полю *$table*, как показано ниже, и по этим результатам будет выполнена проверка значений AggregatedValue для каждой таблицы (например, availabilityResults) в поисках 3 и более последовательных нарушений.

![Запрос "Измерение метрик" для нескольких значений](media/alert-log-troubleshoot/LogMMQuery.png)

Так как для статистического выражения *Aggregate Upon* выбрано значение *$table*, данные сортируются по столбцу $table (обозначено КРАСНЫМ цветом) и группируются, после чего по полю *Aggregate Upon* (т. е. $table) выполняется поиск типов. Например, все значения для availabilityResults будут считаться одним графиком или сущностью (как обозначено оранжевым цветом). Именно по этому графику или сущности служба уведомлений ищет три последовательных нарушения (как обозначено зеленым цветом), по которым и будут активированы уведомления для значения таблицы availabilityResults. Аналогичным образом, если будут обнаружены три последовательных нарушения для любого другого значения $table, для них создается дополнительное уведомление с автоматической сортировкой значений каждого графика (сущности) по времени, как показано оранжевым цветом.

Теперь предположим, что для этого правила генерации оповещений "Измерение метрик" мы указали запрос `search *| summarize AggregatedValue = count() by bin(timestamp, 1h)`, но сохранили все остальные настройки, в том числе логику оповещений при трех последовательных нарушениях. В этом случае для параметра Aggregate Upon будет выбрано значение по умолчанию timestamp. Так как в запросе для суммирования *summarize ... by* выбирается только одно значение, и теперь это будет значение *timestamp*, а выходные данные этого запроса будут выглядеть так, как показано ниже.

   ![Выполнение запроса "Измерение метрик" для одного значения](media/alert-log-troubleshoot/LogMMtimestamp.png)

Так как у параметра *Aggregate Upon* значение timestamp, данные сортируются по столбцу *timestamp* (как показано КРАСНЫМ цветом), а затем группируются по полю timestamp. В результате значения `2018-10-17T06:00:00Z` будут рассматриваться как один график (сущность), как показано оранжевым цветом. По этому графику или сущности служба оповещений не сможет обнаружить три последовательных нарушения, так как для каждого значения timestamp предоставлена только одна запись, а значит оповещение никогда не будет активировано. В таком случае у пользователя есть несколько вариантов:

- добавить фиктивную переменную или применить существующую переменную (например, $table), чтобы настроить правильную сортировку с помощью поля Aggregate Upon;
- изменить правило генерации оповещений так, чтобы использовать правильную логику оповещений по полю *total breach*.

## <a name="log-alert-fired-unnecessarily"></a>Оповещение журналов срабатывает без необходимости

Ниже приведены распространенные причины того, что [правило генерации оповещений журналов в Azure Monitor](../platform/alerts-log.md) отображается в [оповещениях Azure](../platform/alerts-managing-alert-states.md) как активированное, хотя вы не ожидаете его срабатывания.

### <a name="alert-triggered-by-partial-data"></a>Предупреждение активируется по частичным данным

Log Analytics и Application Insights основываются на службе аналитики, работа которой характеризуется задержками при приеме и обработке данных. Это означает, что на момент выполнения запроса для оповещения журналов нужные данные могут отсутствовать или быть неполными. См. дополнительные сведения о [времени приема данных в Log Analytics](../platform/data-ingestion-time.md).

В зависимости от настройки правила генерации оповещений могут происходить ложные срабатывания, если на момент выполнения запроса оповещений данные отсутствуют или являются неполными. В таких случаях мы советуем вам изменить запрос или конфигурацию для оповещения. 

Например, если правило генерации оповещений журнала должно активироваться при количестве результатов в запросе менее 5, оповещение будет срабатывать и при отсутствии данных (нуль записей) или наличии неполных данных (одна запись). Однако после задержки приема данных один и тот же запрос с полными данными может дать результат из 10 записей.

### <a name="alert-query-output-misunderstood"></a>Неправильная интерпретация выходных данных запроса оповещения

Вы предоставляете логику для оповещений журнала в аналитическом запросе. В этом аналитическом запросе могут использоваться различные возможности больших данных и математические функции.  Служба оповещений выполняет ваш запрос с указанной периодичностью по данным за указанный период времени. В зависимости от выбранного типа оповещений она вносит в запрос незначительные изменения. Эти изменения отображаются в разделе "Выполняемый запрос" на экране *Настроить логику сигналов*, как показано на следующем рисунке: ![Выполняемый запрос](media/alert-log-troubleshoot/LogAlertPreview.png)

В поле **Выполняемый запрос** отображается запрос, выполняемый службой оповещений журнала. Вы можете запустить указанный запрос, а также временной диапазон на [портале аналитики](../log-query/portals.md) или с помощью [API аналитики](https://docs.microsoft.com/rest/api/loganalytics/), если хотите просмотреть возможные выходные данные запроса оповещения перед фактическим созданием оповещения.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения см. в статье [Оповещения журнала в Azure Monitor. Интерфейс оповещений](../platform/alerts-unified-log.md).
- Дополнительные сведения об [Application Insights](../../azure-monitor/app/analytics.md)
- Дополнительные сведения см. в статье [Анализ данных Log Analytics в Azure Monitor](../../log-analytics/log-analytics-overview.md)
