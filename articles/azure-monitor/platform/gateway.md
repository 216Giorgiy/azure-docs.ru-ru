---
title: Подключение компьютеров через шлюз Log Analytics | Документация Майкрософт
description: Подключайте устройства и компьютеры под наблюдением Operations Manager через шлюз Log Analytics, чтобы отправлять данные в службу автоматизации Azure и Log Analytics в случае отсутствия доступа к Интернету.
services: log-analytics
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ae9a1623-d2ba-41d3-bd97-36e65d3ca119
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 01/15/2019
ms.author: magoedte
ms.openlocfilehash: 551e7c0ca3b4b5e0e94aca39e19d9a35d08e4e05
ms.sourcegitcommit: a1cf88246e230c1888b197fdb4514aec6f1a8de2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2019
ms.locfileid: "54353045"
---
# <a name="connect-computers-without-internet-access-using-the-log-analytics-gateway"></a>Подключение компьютеров без доступа к Интернету через шлюз Log Analytics
В этом документе описано, как настроить связь со службой автоматизации Azure и Log Analytics, используя шлюз Log Analytics, когда компьютеры с прямым подключением или отслеживанием через Operations Manager не имеют доступа к Интернету.  Шлюз Log Analytics, прокси-сервер переадресации HTTP, который поддерживает HTTP-туннелирование с помощью команды HTTP CONNECT, может собирать данные и отправлять их в службу автоматизации Azure и Log Analytics от их имени.  

Шлюз Log Analytics поддерживает:

* Отправка отчетов к тем же четырем рабочим областям Log Analytics, с помощью которых настроены агенты за шлюзом.  
* Гибридные компоненты Runbook Worker в службе автоматизации Azure  
* Компьютеры на базе Windows с агентом Microsoft Monitoring Agent, который напрямую подключен к рабочей области Log Analytics.
* компьютеры на базе Linux с агентом Log Analytics для Linux, который напрямую подключен к рабочей области Log Analytics;  
* System Center Operations Manager 2012 с пакетом обновления 1 (SP1) и накопительным пакетом обновления 7 (UR7), Operations Manager 2012 R2 с накопительным пакетом обновления 3 (UR3), Operations Manager 2016 или группу управления Operations Manager версии 1801, интегрируемую с Log Analytics.  

Если политики ИТ-безопасности запрещают подключение компьютеров (таких как POS-устройства) в сети к Интернету или к серверам, поддерживающим ИТ-службы, а вам нужно подключить их к службе автоматизации Azure или Log Analytics для мониторинга и управления, для компьютеров можно настроить взаимодействие непосредственно со шлюзом Log Analytics, который будет получать конфигурации и передавать данные от их имени.  Если для этих компьютеров настроено прямое подключение к рабочей области Log Analytics через агент Log Analytics, все они вместо этого будут взаимодействовать со шлюзом Log Analytics.  Затем шлюз передает данные от агентов напрямую в службу, не анализируя их.

Если группа управления Operations Manager интегрирована с Log Analytics, для серверов управления можно настроить подключение к шлюзу Log Analytics для сбора сведений о конфигурации и передачи собранных данных в зависимости от выбранного решения.  Агенты Operations Manager отправляют на сервер управления некоторые данные, такие как оповещения, оценки конфигурации, размер экземпляра и емкость данных Operations Manager. Другие данные большого объема, например журналы IIS, сведения о производительности и событиях безопасности, отправляются непосредственно в шлюз Log Analytics.  Если вы развернули один или несколько серверов шлюза Operations Manager в сети периметра или в другой изолированной сети для мониторинга ненадежных систем, они не смогут связаться со шлюзом Log Analytics.  Серверы Operations Manager шлюза могут сообщать данные только серверу управления.  Если для группы управления Operations Manager настроено взаимодействие со шлюзом Log Analytics, сведения о конфигурации прокси-сервера автоматически отправляются на каждый компьютер под управлением агента, на котором включен сбор данных для Log Analytics, даже если соответствующий параметр не указан.    

Обеспечить высокую доступность для компьютеров, подключенных напрямую, или для групп Operations Management, взаимодействующих с Log Analytics через шлюз, можно с использованием балансировки нагрузки сети, чтобы перенаправлять и распределять трафик между несколькими серверами шлюза.  Если один сервер шлюза выходит из строя, трафик перенаправляется на другие доступные узлы.  

Агент Windows Log Analytics необходим на компьютере, выполняющем шлюз Log Analytics, не только для идентификации конечных точек службы, с которыми ему необходимо взаимодействовать, но и для отправки отчетов к тем же рабочим областям, с помощью которых настроен агент или группа управления Operations Manager за шлюзом. Шлюзу необходимо разрешить им обмениваться данными с присвоенной рабочей областью. Шлюз может использовать множественную адресацию в четыре рабочие области, так как это общее количество рабочих областей, поддерживаемых агентом Windows.  

Каждый агент должен иметь сетевое подключение к шлюзу. Так он сможет автоматически передавать данные в шлюз и извлекать их из него. Мы не рекомендуем устанавливать шлюз на контроллере домена.

На следующей схеме представлена передача данных от прямых агентов в службу автоматизации Azure или Log Analytics через сервер шлюза. В конфигурации прокси-сервера на агентах нужно указать тот же порт, который настроен для шлюза Log Analytics.  

![Схема взаимодействия прямого агента со службами](./media/gateway/oms-omsgateway-agentdirectconnect.png)

На следующей схеме представлена передача данных из группы управления Operations Manager в Log Analytics.   

![Схема взаимодействия Operations Manager с Log Analytics](./media/gateway/log-analytics-agent-opsmgrconnect.png)

## <a name="prerequisites"></a>Предварительные требования

Прежде чем запускать шлюз Log Analytics, убедитесь, что на компьютере установлены следующие компоненты:

* Windows 10, Windows 8.1, Windows 7
* Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008
* .NET Framework 4.5;
* 4-ядерный процессор и 8 ГБ памяти (минимальные требования). 
* [Агент Log Analytics для Windows](agent-windows.md) установлен и настроен для отправки отчетов в той же рабочей области, что и агенты, взаимодействующие через шлюз.  

### <a name="language-availability"></a>Доступность языковых версий

Шлюз Log Analytics доступен на следующих языках:

- Китайский (упрощенное письмо)
- Китайский (традиционное письмо)
- Чешский
- Нидерландский
- Английский
- Французский
- Немецкий
- Венгерский
- Итальянский
- Японский
- Корейский
- Польский
- Португальский (Бразилия)
- Португальский (Португалия)
- Русский
- испанский (международный).

### <a name="supported-encryption-protocols"></a>Поддерживаемые протоколы шифрования
Шлюз Log Analytics поддерживает только протоколы TLS 1.0, 1.1 и 1.2.  Он не поддерживает протокол SSL.  Чтобы обеспечить безопасность данных, передаваемых в Log Analytics, настоятельно рекомендуем настроить для шлюза использование протокола TLS как минимум версии 1.2. Более старые версии протоколов TLS/SSL оказались уязвимы. Хотя они все еще используются для обеспечения обратной совместимости, применять их **не рекомендуется**.  См. дополнительные сведения о [безопасной отправке данных с помощью TLS 1.2](../../azure-monitor/platform/data-security.md#sending-data-securely-using-tls-12). 

### <a name="supported-number-of-agent-connections"></a>Поддерживаемое число подключений агента
В таблице ниже приведено поддерживаемое число агентов, которые можно подключить к серверу шлюза.  Это значение получено с расчетом, что каждый агент передает примерно 200 КБ данных каждые 6 секунд. Общий объем данных, полученных с каждого агента в день, составляет 2,7 ГБ.

|Шлюз |Примерное количество поддерживаемых агентов|  
|--------|----------------------------------|  
|— ЦП: Intel Xeon E5-2660 v3 с тактовой частотой 2,6 ГГц, 2 ядра<br> — Память: 4 ГБ<br> — Пропускная способность сети: 1 Гбит/с| 600|  
|— ЦП: Intel Xeon E5-2660 v3 с тактовой частотой 2,6 ГГц, 4 ядра<br> — Память: 8 ГБ<br> — Пропускная способность сети: 1 Гбит/с| 1000|  

## <a name="download-the-log-analytics-gateway"></a>Скачивание шлюза Log Analytics

Скачать последнюю версию файла для установки шлюза Log Analytics можно двумя способами.

1. Скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=54443).

1. Скачать на портале Azure.  После входа на портал Azure сделайте следующее.  

   1. Найдите список служб и выберите **Log Analytics**.  
   1. Выберите рабочую область.
   1. В колонке рабочей области в разделе **Общие** щелкните **Быстрый запуск**.
   1. В разделе **Choose a data source to connect to the workspace** (Выберите источник данных для подключения к рабочей области) щелкните **Компьютеры**.
   1. В колонке **Direct Agent** щелкните **Download Log Analytics Gateway** (Скачать шлюз Log Analytics).<br><br> ![Скачать шлюз Log Analytics](./media/gateway/download-gateway.png)

или 

   1. В колонке рабочей области в разделе **Параметры** щелкните **Дополнительные параметры**.
   1. Выберите **Подключенные источники** > **Серверы Windows** и щелкните **Скачать шлюз Log Analytics**.

## <a name="install-the-log-analytics-gateway"></a>Установка шлюза Log Analytics

Чтобы установить шлюз, сделайте следующее.  Если установлена предыдущая версия, которая раньше называлась *сервером пересылки Log Analytics*, она будет обновлена до этого выпуска.  

1. В папке назначения дважды щелкните файл **Log Analytics Gateway.msi**.
1. На странице **приветствия** нажмите кнопку **Далее**.<br><br> ![Мастер установки шлюза](./media/gateway/gateway-wizard01.png)<br> 
1. На странице **лицензионного соглашения** установите флажок **Я принимаю условия лицензионного соглашения**, а затем нажмите кнопку **Далее**.
1. На странице со сведениями об **адресе порта и прокси-сервера**:
   1. Введите номер TCP-порта, используемого для шлюза. Программа установки настроит правило входящего трафика с этим номером порта в брандмауэре Windows.  По умолчанию используется значение 8080.
      Допустимый диапазон номеров порта: 1–65535. При вводе значения, которое не входит в этот диапазон, появится сообщение об ошибке.
   1. Если для сервера, где установлен шлюз, требуется взаимодействие с прокси-сервером, введите адрес прокси-сервера, к которому должен подключиться шлюз (при необходимости). Например, `http://myorgname.corp.contoso.com:80`.  Если оставить это поле пустым, шлюз будет пытаться подключиться к Интернету напрямую.  Если ваш прокси-сервер требует проверки подлинности, введите имя пользователя и пароль.<br><br> ![Настройка прокси-сервера в мастере установки шлюза](./media/gateway/gateway-wizard02.png)<br>   
   1. Щелкните **Далее**.
1. Если Центр обновления Майкрософт отключен, появится страница "Центр обновления Майкрософт", где его можно включить. Сделайте выбор и нажмите кнопку **Далее**. В противном случае перейдите к следующему шагу.
1. На странице **Конечная папка** оставьте папку по умолчанию (c:\ProgramFiles\OMS Gateway) или укажите расположение, куда необходимо установить шлюз, и нажмите кнопку **Далее**.
1. На странице **Готово к установке** щелкните **Установить**. После этого служба контроля учетных записей может запросить разрешение на установку. Чтобы продолжить, нажмите кнопку **Да**.
1. После завершения установки нажмите кнопку **Готово**. Проверить, запущена ли служба, можно в оснастке services.msc. Если это так, **шлюз OMS** появится в списке служб с состоянием **Выполняется**.<br><br> ![Службы — шлюз Log Analytics](./media/gateway/gateway-service.png)  


## <a name="configure-network-load-balancing"></a>Настройка балансировки сетевой нагрузки 
Вы можете настроить шлюз для обеспечения высокой доступности с применением балансировки сетевой нагрузки, используя балансировку сетевой нагрузки Майкрософт или аппаратные подсистемы балансировки нагрузки.  Подсистема балансировки нагрузки управляет трафиком, распределяя по подключенным узлам запросы на подключение, полученные от агентов Log Analytics или серверов управления Operations Manager. Если один сервер шлюза выходит из строя, трафик перенаправляется на другие узлы.

Сведения о проектировании и развертывании кластера балансировки сетевой нагрузки Windows Server 2016 см. в статье о [балансировке сетевой нагрузки](https://technet.microsoft.com/windows-server-docs/networking/technologies/network-load-balancing).  Ниже описана процедура настройки кластера балансировки сетевой нагрузки Майкрософт.  

1. Войдите на сервер Windows, который входит в кластер балансировки сетевой нагрузки, с использованием учетной записи администратора.  
1. Откройте диспетчер балансировки сетевой нагрузки в диспетчере сервера, щелкните **Инструменты**, а затем — **Диспетчер балансировки сетевой нагрузки**.
1. Чтобы подключить сервер шлюза Log Analytics с установленным компонентом Microsoft Monitoring Agent, щелкните IP-адрес кластера правой кнопкой мыши и выберите **Добавить узел в кластер**.<br><br> ![Диспетчер балансировки сетевой нагрузки — "Добавить узел в кластер"](./media/gateway/nlb02.png)<br> 
1. Введите IP-адрес сервера шлюза, который нужно подключить.<br><br> ![Диспетчер балансировки сетевой нагрузки — "Добавление узла в кластер": Подключение](./media/gateway/nlb03.png) 
    
## <a name="configure-log-analytics-agent-and-operations-manager-management-group"></a>Настройка агента Log Analytics и группы управления Operations Manager
В следующем разделе представлены инструкции по настройке взаимодействия подключенных напрямую к шлюзу Log Analytics агентов Log Analytics, групп управления Operations Manager или гибридных рабочих ролей Runbook со службой автоматизации Azure или Log Analytics.  

### <a name="configure-standalone-log-analytics-agent"></a>Настройка изолированного агента Log Analytics
Требования к установке агента Log Analytics в шлюзах и на компьютерах Windows, подключенных к Log Analytics напрямую, а также процедуру такой установки см. в статье [Подключение компьютеров Windows к службе Log Analytics в Azure](agent-windows.md) или [Настройка агента Log Analytics для компьютеров Linux в гибридной среде](../../azure-monitor/learn/quick-collect-linux-computer.md). Там, где при настройке агента указывается прокси-сервер, замените указанные значения IP-адресом сервера шлюза Log Analytics и номером порта. Если в вашей системе за подсистемой балансировки сетевой нагрузки развернуты несколько серверов шлюза, конфигурация прокси-сервера для агента Log Analytics должна указывать виртуальный IP-адрес подсистемы балансировки сетевой нагрузки.  

После установки агента на сервере шлюза его можно настроить на передачу данных в рабочую область или к агентам рабочей области, обменивающимся данными со шлюзом. Если агент Log Analytics Windows не установлен на шлюзе, событие 300 записывается в журнал событий **Журнал шлюза OMS**, указывая, что необходимо установить агент. Если агент установлен, но не настроен на отправку отчетов в ту же рабочую область, что и агенты, которые обмениваются данными через него, событие 105 записывается в тот же журнал событий, в котором указывается, что агент в шлюзе необходимо было настроить для отправки отчетов в ту же рабочую область, что и агенты, обменивающиеся данными с узлом.

После завершения настройки необходимо перезапустить службу **шлюза OMS**, чтобы изменения вступили в силу. В противном случае шлюз отклонит агентов, пытающихся взаимодействовать с Log Analytics, и в журнале событий **Журнал шлюза OMS** будет зарегистрировано событие отчета с идентификатором 105. Это также применимо при добавлении или удалении рабочей области в конфигурации агента на сервере шлюза.   

Сведения о гибридной рабочей роли Runbook службы автоматизации см. в разделе [Развертывание гибридной рабочей роли Runbook](../../automation/automation-hybrid-runbook-worker.md).

### <a name="configure-operations-manager---all-agents-use-the-same-proxy-server"></a>Настройка Operations Manager (все агенты используют один прокси-сервер)
Operations Manager позволяет добавить сервер шлюза.  Конфигурация прокси-сервера Operations Manager применяется ко всем агентам, передающим данные в Operations Manager, автоматически, даже если соответствующий параметр не указан.  

Чтобы реализовать в шлюзе поддержку Operations Manager, требуется следующее:

* На сервере шлюза необходимо установить компонент Microsoft Monitoring Agent (версии **8.0.10900.0** или более поздней) и настроить его для рабочих областей Log Analytics, в которые группа управления отправляет отчеты.
* Шлюз должен иметь подключение к Интернету или должен быть подключен к прокси-серверу с подключением к Интернету.

> [!NOTE]
> Если не указать значение для шлюза, всем агентам передаются пустые значения.
> 

При первой регистрации группы управления Operations Manager в рабочей области Log Analytics параметр для указания конфигурации прокси-сервера для группы управления недоступен в консоли управления.  Этот параметр станет доступным после успешной регистрации группы управления в службе.  Обновите конфигурацию прокси-сервера системы с помощью Netsh в системе, в которой выполняется консоль управления, чтобы настроить интеграцию и обновить все серверы управления в группе управления.  

1. Откройте командную строку с повышенными привилегиями.

    a. Перейдите в **Пуск** и введите **cmd**.  
    b. Щелкните **командную строку** правой кнопкой мыши, а затем выберите **Запустить от имени администратора**.  

1. Введите следующую команду и нажмите клавишу **ВВОД**:

    `netsh winhttp set proxy <proxy>:<port>`

Завершив интеграцию с Log Analytics, вы можете удалить изменения с помощью команды `netsh winhttp reset proxy` и выбрать сервер шлюза Log Analytics с помощью параметра **Настройка прокси-сервера** в консоли управления. 

1. Откройте консоль Operations Manager и в разделе **Operations Management Suite** щелкните **Подключение**, а затем — **Настройка прокси-сервера**.<br><br> ![Operations Manager — настройка прокси-сервера](./media/gateway/scom01.png)<br> 
1. Выберите **Использовать прокси-сервер для доступа к набору Operations Management Suite** и введите IP-адрес сервера шлюза Log Analytics или виртуальный IP-адрес балансировщика сетевой нагрузки. Он должен начинаться с префикса `http://`.<br><br> ![Operations Manager — адрес прокси-сервера](./media/gateway/scom02.png)<br> 
1. Нажмите кнопку **Готово** Группа управления Operations Manager настроена для обмена данными со службой Log Analytics через сервер шлюза.

### <a name="configure-operations-manager---specific-agents-use-proxy-server"></a>Настройка Operations Manager (определенные агенты используют прокси-сервер)
В больших или сложных средах может потребоваться, чтобы только определенные серверы (или группы) использовали сервер шлюза Log Analytics.  Для этих серверов невозможно обновить агент Operations Manager напрямую, так как это значение перезаписывается глобальным значением группы управления.  Вместо этого необходимо переопределить правило, используемое для передачи этих значений.  

> [!NOTE] 
> Вы можете использовать этот же прием конфигурации, чтобы разрешить использовать в среде несколько серверов шлюза Log Analytics.  Например, для каждого региона можно указать определенные серверы шлюза Log Analytics.
>  

1. Откройте консоль Operations Manager и выберите рабочую область **Создание**.  
1. В рабочей области "Создание" выберите **Правила** и на панели инструментов Operations Manager нажмите кнопку **Область**. Если эта кнопка недоступна, убедитесь, что на панели "Мониторинг" выбран именно объект, а не папка. Появится диалоговое окно **Ориентация объектов пакета управления** со списком общих целевых классов, групп или объектов. 
1. В поле **Look for** (Искать) введите **служба работоспособности** и выберите ее в списке.  Последовательно выберите **ОК**.  
1. Найдите **правило настройки прокси-сервера Помощника**, на панели инструментов консоли Operations щелкните **Переопределения**, выберите команду **Override the Rule\For a specific object of class: Health Service** (Переопределить правило для конкретного объекта класса: служба работоспособности) и конкретный объект в списке.  При необходимости можно создать пользовательскую группу, содержащую объект службы работоспособности серверов, которые нужно переопределить, а затем примените переопределения к этой группе.
1. В диалогом окне **Свойства переопределения** в столбце **Переопределение** установите флажок возле параметра **WebProxyAddress**.  В поле **Значение переопределения** введите URL-адрес сервера шлюза Log Analytics с префиксом `http://`.  

    >[!NOTE]
    > Вам не нужно включать правило, так как им уже автоматически управляет переопределение, содержащееся в пакете управления переопределением безопасной ссылки Microsoft System Center Advisor, предназначенном для группы серверов мониторинга Microsoft System Center Advisor.
    >   

1. Выберите пакет управления в списке **Select destination management pack** (Выбор целевого пакета управления) или создайте открытый пакет управления, щелкнув **Создать**. 
1. После внесения необходимых изменений нажмите кнопку **ОК**. 

### <a name="configure-for-automation-hybrid-workers"></a>Настройка поддержки гибридных рабочих ролей службы автоматизации
При наличии в среде гибридных рабочих ролей Runbook службы автоматизации выполните приведенные ниже действия (временные решения, выполняемые вручную), чтобы настроить их поддержку.

Для выполнения следующих действий нужно знать регион Azure, где находится учетная запись службы автоматизации. Чтобы определить расположение, сделайте следующее:

1. Войдите на [портале Azure](https://portal.azure.com/).
1. Выберите службу автоматизации Azure.
1. Выберите соответствующую учетную запись службы автоматизации Azure.
1. Просмотрите ее регион в разделе **Расположение**.<br><br> ![Портал Azure — расположение учетной записи автоматизации](./media/gateway/location.png)  

Используйте следующие таблицы, чтобы определить URL-адреса для каждого расположения.

**URL-адреса службы Job Runtime Data**

| **расположение** | **URL-адрес** |
| --- | --- |
| Центрально-северная часть США |ncus-jobruntimedata-prod-su1.azure-automation.net |
| Западная Европа |we-jobruntimedata-prod-su1.azure-automation.net |
| Центрально-южная часть США |scus-jobruntimedata-prod-su1.azure-automation.net |
| Восток США 2 |eus2-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Канада |cc-jobruntimedata-prod-su1.azure-automation.net |
| Северная Европа |ne-jobruntimedata-prod-su1.azure-automation.net |
| Юго-Восточная Азия |sea-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Индия |cid-jobruntimedata-prod-su1.azure-automation.net |
| Япония |jpe-jobruntimedata-prod-su1.azure-automation.net |
| Австралия |ase-jobruntimedata-prod-su1.azure-automation.net |

**URL-адреса службы агента**

| **расположение** | **URL-адрес** |
| --- | --- |
| Центрально-северная часть США |ncus-agentservice-prod-1.azure-automation.net |
| Западная Европа |we-agentservice-prod-1.azure-automation.net |
| Центрально-южная часть США |scus-agentservice-prod-1.azure-automation.net |
| Восток США 2 |eus2-agentservice-prod-1.azure-automation.net |
| Центральная Канада |cc-agentservice-prod-1.azure-automation.net |
| Северная Европа |ne-agentservice-prod-1.azure-automation.net |
| Юго-Восточная Азия |sea-agentservice-prod-1.azure-automation.net |
| Центральная Индия |cid-agentservice-prod-1.azure-automation.net |
| Япония |jpe-agentservice-prod-1.azure-automation.net |
| Австралия |ase-agentservice-prod-1.azure-automation.net |

Если компьютер автоматически зарегистрировался в качестве гибридной рабочей роли Runbook для установки исправлений с помощью решения "Управление обновлениями", сделайте следующее:

1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
1. Перезапустите службу шлюза Log Analytics, используя командлет PowerShell `Restart-Service OMSGatewayService`.

Если компьютер подключен к службе автоматизации Azure с помощью командлета регистрации гибридной рабочей роли Runbook, сделайте следующее:

1. Добавьте URL-адрес для внесения службы агента в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost ncus-agentservice-prod-1.azure-automation.net`
1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
1. Перезапустите службу шлюза Log Analytics.
    `Restart-Service OMSGatewayService`

## <a name="useful-powershell-cmdlets"></a>Полезные командлеты PowerShell
Командлеты помогут выполнить задачи, необходимые для обновления параметров конфигурации шлюза Log Analytics. Перед их использованием выполните следующее:

1. Установите шлюз Log Analytics (MSI-файл).
1. Откройте окно консоли PowerShell.
1. Чтобы импортировать модуль, введите эту команду: `Import-Module OMSGateway`.
1. Если при выполнении предыдущего шага не произошла ошибка, значит импорт модуля выполнен успешно и вы можете использовать командлеты. Введите `Get-Module OMSGateway`.
1. После внесения изменений с помощью командлетов перезапустите службу шлюза.

Если при выполнении шага 3 произошла ошибка, значит модуль не импортирован. Возможно, эта ошибка возникла, так как PowerShell не удалось найди модуль. Его можно найти в пути установки шлюза: *C:\Program Files\Microsoft OMS Gateway\PowerShell\OmsGateway*.

| **Командлет** | **Параметры** | **Описание** | **Пример** |
| --- | --- | --- | --- |  
| `Get-OMSGatewayConfig` |Ключ |Получает конфигурацию службы |`Get-OMSGatewayConfig` |  
| `Set-OMSGatewayConfig` |Ключ (обязательно) <br> Значение |Изменяет конфигурацию службы |`Set-OMSGatewayConfig -Name ListenPort -Value 8080` |  
| `Get-OMSGatewayRelayProxy` | |Получает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |`Get-OMSGatewayRelayProxy` |  
| `Set-OMSGatewayRelayProxy` |Адрес<br> Имя пользователя<br> Пароль |Задает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |1. Задайте прокси-сервер ретрансляции и учетные данные:<br> `Set-OMSGatewayRelayProxy`<br>`-Address http://www.myproxy.com:8080`<br>`-Username user1 -Password 123` <br><br> 2. Задайте прокси-сервер ретрансляции, для которого не требуется проверка подлинности: `Set-OMSGatewayRelayProxy`<br> `-Address http://www.myproxy.com:8080` <br><br> 3. Очистите параметры прокси-сервера ретрансляции:<br> `Set-OMSGatewayRelayProxy` <br> `-Address ""` |  
| `Get-OMSGatewayAllowedHost` | |Получает разрешенный в настоящее время узел (только локально настроенные разрешенные узлы; разрешенные узлы, скачанные автоматически, сюда не относятся) |`Get-OMSGatewayAllowedHost` | 
| `Add-OMSGatewayAllowedHost` |Узел (обязательно) |Добавляет узел в список разрешенных |`Add-OMSGatewayAllowedHost -Host www.test.com` |  
| `Remove-OMSGatewayAllowedHost` |Узел (обязательно) |Удаляет узел из списка разрешенных |`Remove-OMSGatewayAllowedHost`<br> `-Host www.test.com` |  
| `Add-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Добавляет субъект сертификата клиента в список разрешенных |`Add-OMSGatewayAllowed`<br>`ClientCertificate` <br> `-Subject mycert` |  
| `Remove-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Удаляет субъект сертификата клиента из списка разрешенных |`Remove-OMSGatewayAllowed` <br> `ClientCertificate` <br> `-Subject mycert` |  
| `Get-OMSGatewayAllowedClientCertificate` | |Получает разрешенные в настоящее время субъекты сертификата клиента (только локально настроенные разрешенные субъекты; разрешенные субъекты, скачанные автоматически, сюда не относятся) |`Get-`<br>`OMSGatewayAllowed`<br>`ClientCertificate` |  

## <a name="troubleshooting"></a>Устранение неполадок
Чтобы собирать события, регистрируемые шлюзом, также должен быть установлен агент Log Analytics.<br><br> ![Средство просмотра событий — журнал шлюза Log Analytics](./media/gateway/event-viewer.png)

**Идентификаторы и описания событий для шлюза Log Analytics**

В следующей таблице приведены идентификаторы и описания для событий журнала шлюза Log Analytics.

| **Идентификатор** | **Описание** |
| --- | --- |
| 400 |Любая ошибка приложения без определенного идентификатора |
| 401 |Неправильная конфигурация. Например, для параметра listenPort задано значение text вместо integer |
| 402 |Исключение при анализе сообщений подтверждения TLS |
| 403 |Сетевая ошибка. Например, не удается подключиться к целевому серверу |
| 100 |Общие сведения |
| 101 |Служба запущена |
| 102 |Служба остановлена |
| 103 |Получена команда HTTP CONNECT от клиента |
| 104 |Команда HTTP CONNECT не получена |
| 105 |Целевой сервер не включен в список разрешенных или конечный порт небезопасен (443) <br> <br> Убедитесь, что агент MMA на сервере шлюза и агенты, взаимодействующие со шлюзом, подключены к одной рабочей области Log Analytics. |
| 105 |Ошибка TCP-подключения — недопустимый сертификат клиента: CN=Gateway <br><br> Убедитесь в следующем: <br>    <br> &#149; используется шлюз версии 1.0.395.0 или более поздней; <br> &#149; агент MMA на сервере шлюза и агенты, взаимодействующие со шлюзом, подключены к одной рабочей области Log Analytics. |
| 106 |Шлюз Log Analytics поддерживает только протоколы TLS 1.0, 1.1 и 1.2.  Он не поддерживает протокол SSL. Для любой неподдерживаемой версии протокола TLS или SSL шлюз Log Analytics создает идентификатор события 106.|
| 107 |Сеанс TLS проверен |

**Счетчики производительности, данные для которых необходимо собрать**

В следующей таблице приведены счетчики производительности, доступные для шлюза Log Analytics. Счетчики можно добавить с помощью системного монитора.

| **Имя** | **Описание** |
| --- | --- |
| Шлюз Log Analytics — Active Client Connection (Активные клиентские подключения) |Количество активных сетевых подключений клиента (TCP) |
| Шлюз Log Analytics — Error Count (Количество ошибок) |Количество ошибок |
| Шлюз Log Analytics — Connected Client (Подключенные клиенты) |Количество подключенных клиентов |
| Шлюз Log Analytics — Rejection Count (Количество отклонений) |Количество отклонений из-за любых ошибок проверки TLS |

![Счетчик производительности для шлюза Log Analytics](./media/gateway/counters.png)

## <a name="get-assistance"></a>Получение справки
На портале Azure можно запросить помощь по настройке шлюза Log Analytics, а также любой службы или компонента службы Azure.
Чтобы запросить помощь, щелкните знак вопроса в правом верхнем углу портала и выберите **Новый запрос в службу поддержки**. Затем заполните форму нового запроса на поддержку.

![Новый запрос на техническую поддержку](./media/gateway/support.png)

## <a name="next-steps"></a>Дополнительная информация
[Добавьте источники данных](../../azure-monitor/platform/agent-data-sources.md), чтобы собирать данные из подключенных источников и сохранять их в рабочей области Log Analytics.
