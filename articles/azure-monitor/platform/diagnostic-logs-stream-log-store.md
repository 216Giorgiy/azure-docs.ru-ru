---
title: Потоковая передача журналов диагностики Azure в Log Analytics
description: Узнайте, как настроить потоковую передачу журналов диагностики Azure в рабочую область Log Analytics.
author: johnkemnetz
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 04/04/2018
ms.author: johnkem
ms.subservice: logs
ms.openlocfilehash: bd760fca20a602127e7d33913547dcb2c6bc95f6
ms.sourcegitcommit: 87bd7bf35c469f84d6ca6599ac3f5ea5545159c9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2019
ms.locfileid: "58351572"
---
# <a name="stream-azure-diagnostic-logs-to-log-analytics"></a>Потоковая передача журналов диагностики Azure в Log Analytics

Можно настроить потоковую передачу **[журналов диагностики Azure](diagnostic-logs-overview.md)** почти в реальном времени в Azure Log Analytics с помощью портала, командлетов PowerShell или Azure CLI.

## <a name="what-you-can-do-with-diagnostics-logs-in-log-analytics"></a>Что можно делать с журналами диагностики в Log Analytics

Azure Log Analytics — это гибкий инструмент поиска по журналам и аналитики, который позволяет лучше понять необработанные данные журналов, созданные для ресурсов Azure. Ниже перечислены некоторые возможности:

* **Поиск по журналам**. Создание расширенных запросов для данных журналов, сопоставление журналов из разных источников и даже создание диаграмм, которые можно закрепить на панели мониторинга Azure.
* **Предупреждения**. Настройка получения электронного сообщения или вызов веб-перехватчика, когда одно или несколько событий соответствуют определенному запросу.
* **Решения**. Использование готовых представлений и панелей мониторинга, которые позволяют сразу же получить представление о данных журналов.
* **Расширенная аналитика**. Применение машинного обучения и алгоритмов сопоставления шаблонов для выявления возможных проблем, обнаруженных в журналах.

## <a name="enable-streaming-of-diagnostic-logs-to-log-analytics"></a>Включение потоковой передачи журналов диагностики в Log Analytics

Потоковую передачу журналов диагностики можно включить программно, через портал или с помощью [REST API Azure Monitor](https://docs.microsoft.com/rest/api/monitor/diagnosticsettings). В любом случае создается параметр диагностики, в котором указывается рабочая область Log Analytics, а также категории журналов и метрики, которые требуется отправить в эту рабочую область. Категория **журналов диагностики** — это тип журналов, которые может предоставить ресурс.

Рабочая область Log Analytics не обязательно должна находиться в той же подписке, в которой находится ресурс, выдающий журналы, если у пользователя, настраивающего параметр, имеется соответствующий доступ RBAC к обеим подпискам.

> [!NOTE]
> Отправка многомерных метрик с помощью параметров диагностики сейчас не поддерживается. Метрики с измерениями экспортируются как преобразованные в плоскую структуру одномерные метрики, агрегированные по значениям измерений.
>
> *Пример*. Метрику "Входящие сообщения" в концентраторе событий можно изучить и вывести в виде диаграммы на уровне очереди. Но при экспорте с помощью параметров диагностики метрика будет представлена в виде всех входящих сообщений для всех очередей концентратора событий.
>
>

## <a name="stream-diagnostic-logs-using-the-portal"></a>Потоковая передача журналов диагностики с помощью портала
1. На портале перейдите к Azure Monitor и щелкните **Параметры диагностики**.

    ![Раздел мониторинга Azure Monitor](media/diagnostic-logs-stream-log-store/diagnostic-settings-blade.png)

2. При необходимости отфильтруйте список по группе или типу ресурса, а затем щелкните ресурс, для которого необходимо задать параметр диагностики.

3. Если параметров для выбранного ресурса не существует, вам будет предложено создать параметр. Щелкните Turn on diagnostics (Включить диагностику).

   ![Добавление параметра диагностики — имеющиеся параметры отсутствуют](media/diagnostic-logs-stream-log-store/diagnostic-settings-none.png)

   Если в ресурсе имеются параметры, для него отобразится список настроенных параметров. Нажмите Add diagnostic setting (Добавить параметр диагностики).

   ![Добавление параметра диагностики — имеющиеся параметры](media/diagnostic-logs-stream-log-store/diagnostic-settings-multiple.png)

3. Введите имя параметра и установите флажок для **Отправить в Log Analytics**, затем выберите рабочую область Log Analytics.

   ![Добавление параметра диагностики — имеющиеся параметры](media/diagnostic-logs-stream-log-store/diagnostic-settings-configure.png)

4. Выберите команду **Сохранить**.

Через несколько секунд новый параметр появится в списке параметров для данного ресурса, и сразу же после создания данных о событии журналы диагностики будут отправлены в необходимую рабочую область. Обратите внимание на то, что между созданием события и его появлением в Log Analytics может пройти до 15 минут.

### <a name="via-powershell-cmdlets"></a>С помощью командлетов PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Для включения потоковой передачи с помощью [командлетов Azure PowerShell](../../azure-monitor/platform/powershell-quickstart-samples.md) применяется командлет `Set-AzDiagnosticSetting` с такими параметрами:

```powershell
Set-AzDiagnosticSetting -ResourceId [your resource ID] -WorkspaceID [resource ID of the Log Analytics workspace] -Categories [list of log categories] -Enabled $true
```

Обратите внимание на то, что свойство workspaceID содержит полный идентификатор рабочей области, а не идентификатор и ключ рабочей области, отображаемые в Log Analytics.

### <a name="via-azure-cli"></a>С помощью интерфейса командной строки Azure

Чтобы включить потоковую передачу с помощью [Azure CLI](../../azure-monitor/platform/cli-samples.md), используйте команду [az monitor diagnostic-settings create](/cli/azure/monitor/diagnostic-settings#az-monitor-diagnostic-settings-create).

```azurecli
az monitor diagnostic-settings create --name <diagnostic name> \
    --workspace <log analytics name or object ID> \
    --resource <target resource object ID> \
    --resource-group <log analytics workspace resource group> \
    --logs '[
    {
        "category": <category name>,
        "enabled": true
    }
    ]'
```

Вы можете расширить набор категорий в журнале диагностики, добавив словари в массив JSON, переданный в качестве параметра `--logs`.

Аргумент `--resource-group` является обязательным, только если `--workspace` — не идентификатор объекта.

## <a name="how-do-i-query-the-data-in-log-analytics"></a>Как запросить данные из Log Analytics?

В колонке "Поиск по журналу" на портале или в разделе "Расширенная аналитика" в Log Analytics можно запросить журналы диагностики, воспользовавшись решением по управлению журналами в таблице AzureDiagnostics. Существует также [несколько решений для ресурсов Azure](../../azure-monitor/insights/solutions.md), которые можно установить, чтобы мгновенно получать представление о данных журналов, отправляемых в Log Analytics.

### <a name="known-limitation-column-limit-in-azurediagnostics"></a>Известное ограничение: ограничение количества столбцов в AzureDiagnostics
Так как они отправляют много ресурсов, типы данных отправляются в той же таблице (_AzureDiagnostics_), схема этой таблицы — это принудительный набор схем все различные типы данных собираются. Например при создании параметров диагностики для сбора следующих типов данных, передача данных выполняется в той же рабочей области:
- Аудит журналов 1 ресурсов (имеющая схеме, состоящей из столбцов A, B и C)  
- Журналы ошибок 2 ресурсов (имеющая схеме, состоящей из столбцов, D, E и F)  
- Журналы потоков данных из ресурсов 3 (имеющая схеме, состоящей из столбцов G, H и я)  
 
В таблице AzureDiagnostics будет выглядеть следующим образом, с демонстрационными данными:  
 
| ResourceProvider | Категория | A | b | C | D | E | F | G. | H | I |
| -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- |
| Microsoft.Resource1 | AuditLogs | x1 | y1 | z1 |
| Microsoft.Resource2 | ErrorLogs | | | | Вопрос 1 | W1 | e1 |
| Microsoft.Resource3 | DataFlowLogs | | | | | | | J1 | K1 | L1|
| Microsoft.Resource2 | ErrorLogs | | | | вопрос 2 | W2 | e2 |
| Microsoft.Resource3 | DataFlowLogs | | | | | | | J3 | K3 | L3|
| Microsoft.Resource1 | AuditLogs | x5 | y5 | z5 |
| ... |
 
Нет явного ограничения, любой заданной таблицы журнала Azure, не имеющий более чем 500 столбцов. После достижения любой строки, содержащие данные с любой столбец за пределами первые 500, будут удалены во время приема. В таблице AzureDiagnostics является особенно подвержены быть влияет это ограничение. Обычно это происходит либо, так как множества различных источников данных передаются на той же рабочей области, или несколько источников очень подробные данные, отправляемые в той же рабочей области. 
 
#### <a name="azure-data-factory"></a>Фабрика данных Azure  
Фабрика данных Azure, из-за очень подробный набор журналов, — это ресурс, известно, что особенно влиять на это ограничение. например:  
- *Параметры пользователя, определенные для любого действия в конвейере*: будет новый столбец, созданный для каждого параметра пользователя с уникальным именем для любого действия. 
- *Вводимые и выдаваемые действиями*: они различаются деятельности к и формироваться большое число столбцов, из-за своей природе verbose. 
 
Как с широкой предложения решение ниже, рекомендуется выделить ADF журналы в собственной рабочей области, чтобы свести к минимуму вероятность возникновения этих журналов, влияя на другие типы журналов, собираемых в рабочие области. Мы планируем специально подобрали журналы для фабрики данных Azure доступны по середине апреля 2019 г.
 
#### <a name="workarounds"></a>Обходные пути
Короткий срок, пока не будет переопределена ограничение 500 столбцов, рекомендуется разделить на отдельные рабочие области, чтобы снизить вероятность превышения ограничения на типы подробные данные.
 
Более системы диагностики Azure переходят от единой, разреженными схемы в отдельные таблицы для каждого типа данных; в паре с поддержкой динамических типов, это существенно повысит удобство использования, поступающих в журналах Azure через механизм системы диагностики Azure. Вы уже видели это выберите типы ресурсов Azure, например [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/reports-monitoring/howto-analyze-activity-logs-log-analytics) или [Intune](https://docs.microsoft.com/intune/review-logs-using-azure-monitor) журналы. Выполните поиск новости о новых типов ресурсов в Azure, поддерживающих эти проверенные журналы на [обновления Azure](https://azure.microsoft.com/updates/) блога!


## <a name="next-steps"></a>Дальнейшие действия

* [Дополнительные сведения о журналах диагностики Azure](diagnostic-logs-overview.md)

