---
title: Фильтрация входящего трафика с помощью DNAT службы "Брандмауэр Azure" с использованием портала Azure
description: В этом руководстве вы можете узнать, как развернуть и настроить DNAT службы "Брандмауэр Azure" с помощью портала Azure.
services: firewall
author: vhorne
ms.service: firewall
ms.topic: tutorial
ms.date: 9/25/2018
ms.author: victorh
ms.custom: mvc
ms.openlocfilehash: 766ad04251fbe404d43734115e41e23ae0a4be28
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46982056"
---
# <a name="tutorial-filter-inbound-traffic-with-azure-firewall-dnat-using-the-azure-portal"></a>Руководство по фильтрации входящего трафика с помощью DNAT службы "Брандмауэр Azure" с использованием портала Azure

Вы можете настроить преобразование целевых сетевых адресов (DNAT) службы "Брандмауэр Azure" для преобразования и фильтрации входящего трафика в подсети. Служба "Брандмауэр Azure" не поддерживает концепцию правил входящего и исходящего трафика. Есть правила приложений и сети, которые применяются к любому трафику, поступающему в брандмауэр. Сначала применяются правила сети, затем — правила приложения, после чего выполнение правил завершается.

>[!NOTE]
>Сейчас функция DNAT брандмауэра доступна только в Azure PowerShell и REST.

Например, если правило сети выполняется, пакет не обрабатывается правилами приложения. Если правило сети не выполняется, а протокол пакета — HTTP/HTTPS, то пакет обрабатывается правилами приложения. Если правило и после этого не выполняется, пакет обрабатывается с использованием [коллекции правил инфраструктуры](infrastructure-fqdns.md). Если правило по-прежнему не выполняется, пакет отклоняется по умолчанию.

При настройке DNAT для действия коллекции правил NAT установлено значение **Преобразование сетевых адресов назначения (DNAT)**. Общедоступный IP-адрес и порт брандмауэра преобразуются в частный IP-адрес и порт. Затем правила применяются как обычно (сначала правила сети, а затем — правила приложения). Например, можно настроить правило сети, разрешающее трафик с удаленного рабочего стола через TCP-порт 3389. Сначала выполняется преобразование адресов, а затем с использованием преобразованных адресов применяются правила сети и приложений.

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * настройка тестовой сетевой среды;
> * развертывание брандмауэра;
> * создание маршрута по умолчанию;
> * настройка правила DNAT;
> * настройка правила сети;
> * тестирование брандмауэра.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

В рамках этого руководства вы создадите две пиринговые виртуальные сети:
- **VN-Hub** — в этой виртуальной сети находится брандмауэр.
- **VN-Spoke** — в этой виртуальной сети находится сервер рабочей нагрузки.

## <a name="create-a-resource-group"></a>Создание группы ресурсов
1. Войдите на портал Azure по адресу [http://portal.azure.com](http://portal.azure.com).
1. На домашней странице портала Azure щелкните **Группы ресурсов**, а затем — **Добавить**.
2. В качестве **имени группы ресурсов** введите **RG-DNAT-Test**.
3. В качестве **подписки** выберите свою подписку.
4. В качестве **расположения группы ресурсов** выберите расположение. Все следующие ресурсы, которые вы будете создавать, должны находиться в одном расположении.
5. Нажмите кнопку **Создать**.

## <a name="set-up-the-network-environment"></a>Настройка сетевой среды
Сначала создайте виртуальные сети, а затем установите пиринг между ними.

### <a name="create-the-hub-vnet"></a>Создание виртуальной сети концентратора
1. На домашней странице портала Azure щелкните **Все службы**.
2. В разделе **Сети** щелкните **Виртуальные сети**.
3. Щелкните **Добавить**.
4. В поле **Имя** введите **VN-Hub**.
5. В поле **адресного пространства** введите **10.0.0.0/16**.
7. В качестве **подписки** выберите свою подписку.
8. В разделе **Группа ресурсов** выберите **Use existing** (Использовать имеющуюся), а затем — **RG-DNAT-Test**.
9. В поле **Расположение** выберите использованное ранее расположение.
10. В разделе **Подсеть** в качестве **имени** введите **AzureFirewallSubnet**.

     Брандмауэр будет размещен в этой подсети. Для подсети **необходимо** указать имя AzureFirewallSubnet.
     > [!NOTE]
     > Минимальный размер подсети AzureFirewallSubnet равен /25.
11. В поле **Диапазон адресов** введите **10.0.1.0/24**.
12. Другие параметры оставьте настроенными по умолчанию, а затем нажмите кнопку **Создать**.

### <a name="create-a-spoke-vnet"></a>Создание периферийной виртуальной сети

1. На домашней странице портала Azure щелкните **Все службы**.
2. В разделе **Сети** щелкните **Виртуальные сети**.
3. Щелкните **Добавить**.
4. В поле **Имя** введите **VN-Spoke**.
5. В поле **Адресное пространство** введите **192.168.0.0/16**.
7. В качестве **подписки** выберите свою подписку.
8. В разделе **Группа ресурсов** выберите **Use existing** (Использовать имеющуюся), а затем — **RG-DNAT-Test**.
9. В поле **Расположение** выберите использованное ранее расположение.
10. В разделе **Подсеть** в поле **Имя** введите **SN-Workload**.

    Сервер будет располагаться в этой подсети.
1. В поле **Диапазон адресов** введите **192.168.1.0/24**.
2. Другие параметры оставьте настроенными по умолчанию, а затем нажмите кнопку **Создать**.

### <a name="peer-the-vnets"></a>Установление пиринга между виртуальными сетями

Теперь установите пиринг между двумя виртуальными сетями.

#### <a name="hub-to-spoke"></a>Из центральной сети в периферийную

1. Выберите виртуальную сеть **VN-Hub**.
2. В разделе **Параметры** щелкните **Пиринги**.
3. Щелкните **Добавить**.
4. В качестве имени укажите **Peer-HubSpoke**.
5. В качестве виртуальной сети выберите **VN-Spoke**.
7. Последовательно выберите **ОК**.

#### <a name="spoke-to-hub"></a>Из периферийной сети в центральную

1. Выберите виртуальную сеть **VN-Spoke**.
2. В разделе **Параметры** щелкните **Пиринги**.
3. Щелкните **Добавить**.
4. В качестве имени укажите **Peer-SpokeHub**.
5. В качестве виртуальной сети выберите **VN-Hub**.
6. Щелкните **Разрешить перенаправленный трафик**.
7. Последовательно выберите **ОК**.

## <a name="create-a-virtual-machine"></a>Создание виртуальной машины

Создайте виртуальную машину рабочей нагрузки и поместите ее в подсеть **SN-Workload**.

1. На домашней странице портала Azure щелкните **Все службы**.
2. В разделе **Вычисления** выберите **Виртуальные машины**.
3. Щелкните **Добавить**, а затем — **Windows Server**, выберите **Windows Server 2016 Datacenter** и нажмите кнопку **Создать**.

**Основы**

1. В поле **Имя** введите **Srv-Workload**.
5. Введите имя пользователя и пароль.
6. В качестве **подписки** выберите свою подписку.
7. В разделе **Группа ресурсов** щелкните **Use existing** (Использовать имеющуюся), а затем выберите вариант **RG-DNAT-Test**.
8. В поле **Расположение** выберите использованное ранее расположение.
9. Последовательно выберите **ОК**.

**Размер**

1. Выберите подходящий размер для тестовой виртуальной машины под управлением Windows Server. Например, **B2ms** (8 ГБ ОЗУ, 16 ГБ хранилища).
2. Нажмите кнопку **Выбрать**.

**Параметры**

1. В разделе **Сеть** в качестве **виртуальной сети** выберите **VN-Spoke**.
2. В качестве **подсети** выберите **SN-Workload**.
3. Щелкните **Общедоступный IP-адрес**, а затем выберите **Нет**.
4. В разделе **Выберите общедоступные входящие порты** выберите **Нет открытых входящих портов**. 
2. Оставьте другие параметры настроенными по умолчанию и нажмите кнопку **ОК**.

**Сводка**

Просмотрите сводные данные и нажмите кнопку **Создать**. Ее выполнение может занять несколько минут.

После завершения развертывания запишите частный IP-адрес для виртуальной машины. Он будет использоваться при настройке брандмауэра. Щелкните имя виртуальной машины, а затем в разделе **Параметры** выберите **Сети**, чтобы найти частный IP-адрес.


## <a name="deploy-the-firewall"></a>Развертывание брандмауэра

1. На домашней странице портала щелкните **Создать ресурс**.
2. Выберите **Сети**, а затем — **Рекомендованные** и щелкните **Просмотреть все**.
3. Щелкните **Брандмауэр**, а затем нажмите кнопку **Создать**. 
4. Используйте сведения в следующей таблице, чтобы настроить брандмауэр на странице **Создание брандмауэра**:
   
   |Параметр  |Значение  |
   |---------|---------|
   |ИМЯ     |FW-DNAT-test|
   |Подписка     |\<ваша подписка\>|
   |Группа ресурсов     |**Use existing** (Использовать имеющуюся): RG-DNAT-Test. |
   |Расположение     |Выберите использованное ранее расположение|
   |Выберите виртуальную сеть     |**Use existing** (Использовать имеющуюся): VN-Hub.|
   |Общедоступный IP-адрес     |**Создать**. Общедоступный IP-адрес должен быть типа SKU "Стандартный".|

2. Щелкните **Review + create** (Просмотреть и создать).
3. Просмотрите информацию на странице сводки. Для создания брандмауэра нажмите кнопку **Создать**.

   Развертывание может занять несколько минут.
4. По завершении развертывания перейдите в группу ресурсов **RG-DNAT-Test** и щелкните брандмауэр **FW-DNAT-test**.
6. Запишите частный IP-адрес. Вы будете использовать его позже при создании маршрута по умолчанию.


## <a name="create-a-default-route"></a>создание маршрута по умолчанию;

Для подсети **SN-Workload** вы настраиваете исходящий маршрут по умолчанию для прохождения через брандмауэр.

1. На домашней странице портала Azure щелкните **Все службы**.
2. В разделе **Сети** щелкните **Таблицы маршрутов**.
3. Щелкните **Добавить**.
4. В поле **Имя** введите **RT-FWroute**.
5. В качестве **подписки** выберите свою подписку.
6. В разделе **Группа ресурсов** выберите **Use existing** (Использовать имеющуюся), а затем — **RG-DNAT-Test**.
7. В поле **Расположение** выберите использованное ранее расположение.
8. Нажмите кнопку **Создать**.
9. Щелкните **Обновить**, а затем выберите таблицу маршрутов **RT-FWroute**.
10. Щелкните **Подсети**, а затем — **Сопоставить**.
11. Щелкните **Виртуальная сеть**, а затем выберите **VN-Spoke**.
12. В поле **Подсеть** щелкните **SN-Workload**.
13. Последовательно выберите **ОК**.
14. Щелкните **Маршруты**, а затем нажмите кнопку **Добавить**.
15. В поле **Имя маршрута** введите **FW-DG**.
16. В поле **Префикс адреса** укажите **0.0.0.0/0**.
17. В поле **Тип следующего прыжка** выберите **Виртуальный модуль**.

    На самом деле, Брандмауэр Azure является управляемой службой, но в этой ситуации подходит виртуальный модуль.
1. В поле **Адрес следующего прыжка** введите частный IP-адрес для брандмауэра, который вы записали ранее.
2. Последовательно выберите **ОК**.


## <a name="configure-a-dnat-rule"></a>Настройка правила DNAT

```azurepowershell-interactive
 $rgName  = "RG-DNAT-Test"
 $firewallName = "FW-DNAT-test"
 $publicip = type the Firewall public ip
 $newAddress = type the private IP address for the Srv-Workload virtual machine 
 
# Get Firewall
    $firewall = Get-AzureRmFirewall -ResourceGroupName $rgName -Name $firewallName
  # Create NAT rule
    $natRule = New-AzureRmFirewallNatRule -Name RL-01 -SourceAddress * -DestinationAddress $publicip -DestinationPort 3389 -Protocol TCP -TranslatedAddress $newAddress -TranslatedPort 3389
  # Create NAT rule collection
    $natRuleCollection = New-AzureRmFirewallNatRuleCollection -Name RC-DNAT-01 -Priority 200 -Rule $natRule
  # Add NAT Rule collection to firewall:
    $firewall.AddNatRuleCollection($natRuleCollection)
  # Save:
    $firewall | Set-AzureRmFirewall
```
## <a name="configure-a-network-rule"></a>Настройка правила сети

1. Откройте группу ресурсов **RG-DNAT-Test** и выберите брандмауэр **FW-DNAT-test**.
1. На странице **FW-DNAT-test** в разделе **Параметры** щелкните **Правила**.
2. Щелкните **Добавление коллекции правил сети**.

Настройте правило, используя следующую таблицу, а затем щелкните **Добавить**:


|Параметр  |Значение  |
|---------|---------|
|ИМЯ     |**RC-Net-01**|
|Приоритет     |**200**|
|Действие     |**Разрешить**|

В разделе **Правила**:

|Параметр  |Параметр  |
|---------|---------|
|ИМЯ     |**RL-RDP**|
|Протокол     |**TCP**|
|Исходные адреса     |*|
|Адреса назначения     |Частный IP-адрес **Srv-Workload**|
|Конечные порты|**3389**|


## <a name="test-the-firewall"></a>тестирование брандмауэра.

1. Подключите удаленный рабочий стол к общедоступному IP-адресу брандмауэра. Для этого необходимо установить подключение к виртуальной машине **Srv-Workload**.
3. Закройте удаленный рабочий стол.
4. Измените действие коллекции правил сети **RC-Net-01** на **Отклонить**.
5. Попробуйте установить подключение к общедоступному IP-адресу брандмауэра снова. На этот раз из-за установленного правила с действием **Отклонить** установить подключение не удастся.

## <a name="clean-up-resources"></a>Очистка ресурсов

Вы можете сохранить ресурсы брандмауэра для следующего руководства или, если они больше не нужны, удалить группу ресурсов **RG-DNAT-Test**, чтобы удалить ресурсы, связанные с брандмауэром.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * настройка тестовой сетевой среды;
> * развертывание брандмауэра;
> * создание маршрута по умолчанию;
> * настройка правила DNAT;
> * настройка правила сети;
> * тестирование брандмауэра.

Теперь вы можете отследить журналы Брандмауэра Azure.

> [!div class="nextstepaction"]
> [Руководство по мониторингу журналов Брандмауэра Azure](./tutorial-diagnostics.md)
