---
title: Регистрация событий пространства Azure Digital Twins | Документация Майкрософт
description: В этом руководстве вы узнаете, как получать уведомления от пространств, интегрировав Azure Digital Twins с Logic Apps.
services: digital-twins
author: dsk-2015
ms.service: digital-twins
ms.topic: tutorial
ms.date: 10/15/2018
ms.author: dkshir
ms.openlocfilehash: 91dd16938efbd1e24419352f66e3238646a77e8a
ms.sourcegitcommit: 74941e0d60dbfd5ab44395e1867b2171c4944dbe
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2018
ms.locfileid: "49323434"
---
# <a name="tutorial-receive-notifications-from-your-azure-digital-twins-spaces-using-logic-apps"></a>Руководство по получению уведомлений от пространств Azure Digital Twins с использованием Logic Apps

Развернув экземпляр Azure Digital Twins, подготовив пространства и реализовав пользовательские функции для отслеживания определенных условий, вы можете по электронной почте уведомлять администратора офиса, когда возникают отслеживаемые условия. 

В [первом руководстве](tutorial-facilities-setup.md) вы настроили пространственный граф воображаемого здания с комнатой, где присутствуют датчики движения, углекислого газа и температуры. Во [втором руководстве](tutorial-facilities-udf.md) вы подготовили граф и определяемую пользователем функцию для отслеживания значений датчиков и активации уведомлений, когда помещение пустое, а температура и уровень углекислого газа не выходят за пределы обычных значений. В этом руководстве показано, как интегрировать эти уведомления с Azure Logic Apps для отправки сообщений, когда комната свободна. Администратор офиса может использовать эти сведения, чтобы помогать сотрудникам бронировать конференц-зал с самыми оптимальными условиями для работы. 

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * интеграция событий со службой "Сетка событий";
> * уведомление о событиях с помощью приложения логики.
    
## <a name="prerequisites"></a>Предварительные требования

В этом руководстве предполагается, что вы [настроили](tutorial-facilities-setup.md) и [подготовили](tutorial-facilities-udf.md) экземпляр Azure Digital Twins. Прежде чем продолжить, убедитесь, что у вас есть:
- [Учетная запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
- Работающий экземпляр Digital Twins.
- [Примеры Digital Twins на C#](https://github.com/Azure-Samples/digital-twins-samples-csharp), скачанные и извлеченные на ваш рабочий компьютер.
- [Пакет SDK для .NET Core версии 2.1.403 или более поздней](https://www.microsoft.com/net/download) на компьютере разработки. Он нужен для запуска примера. Выполните команду `dotnet --version`, чтобы проверить, установлена ли необходимая версия. 
- Учетная запись Office 365 для отправки уведомлений по электронной почте.

## <a name="integrate-events-with-event-grid"></a>Интеграция событий со службой "Сетка событий" 
В этом разделе вы установите службу [Сетка событий](../event-grid/overview.md) для сбора событий из экземпляра Digital Twins и перенаправления их в [обработчик событий](../event-grid/event-handlers.md), например Logic Apps.

### <a name="create-event-grid-topic"></a>Создание раздела службы "Сетка событий"
[Разделы службы "Сетка событий"](../event-grid/concepts.md#topics) предоставляют интерфейс для маршрутизации событий, созданных определяемой пользователем функцией. 

1. Войдите на [портале Azure](https://portal.azure.com).

1. В области навигации слева щелкните **Создать ресурс**. 

1. Найдите и выберите **Раздел сетки событий**. Нажмите кнопку **Создать**.

1. Введите **имя** для раздела сетки событий и выберите **подписку**. Выберите **группу ресурсов**, которую вы использовали или создали для экземпляра Digital Twins, и **расположение**. Нажмите кнопку **Создать**. 

    ![Создание раздела службы "Сетка событий"](./media/tutorial-facilities-events/create-event-grid-topic.png)

1. Перейдите в раздел сетки событий из группы ресурсов, щелкните пункт **Обзор** и скопируйте значение **конечной точки раздела** во временный файл. Вам потребуется этот URL-адрес в следующем разделе. 

1. Щелкните **Ключи доступа** и скопируйте **Ключ 1** и **Ключ 2** во временный файл. Вам потребуются эти значения для создания конечной точки в следующем разделе.

    ![Ключи сетки событий](./media/tutorial-facilities-events/event-grid-keys.png)

### <a name="create-an-endpoint-for-the-event-grid-topic"></a>Создание конечной точки для раздела службы "Сетка событий"

1. В окне командной строки убедитесь, что вы находитесь в папке **_occupancy quickstart\src_** примера Digital Twins.

1. Откройте файл **_actions\createEndpoints.yaml_** в редакторе Visual Studio Code. Убедитесь, что в нем есть следующее содержимое:

    ```yaml
    - type: EventGrid
      eventTypes:
      - SensorChange
      - SpaceChange
      - TopologyOperation
      - UdfCustom
      connectionString: Primary_connection_string_for_your_Event_Grid
      secondaryConnectionString: Secondary_connection_string_for_your_Event_Grid
      path: Event_Grid_Topic_Path
    ```

1. Замените заполнитель `Primary_connection_string_for_your_Event_Grid` значением **Ключ 1**. 

1. Замените заполнитель `Secondary_connection_string_for_your_Event_Grid` значением **Ключ 2**.

1. Замените заполнитель `Event_Grid_Topic_Path` путем к разделу сетки событий. Вы можете получить этот путь, удалив *https://* и пути к ресурсам в конце из URL-адреса **конечной точки раздела**. Он должен быть похожим на следующий формат: **имя вашей сетки событий.ваше расположение.eventgrid.azure.net**. 

    > [!IMPORTANT]
    > Введите все значения без кавычек. Убедитесь, что в файле *YAML* после двоеточия есть по крайней мере один пробел. Вы также можете проверить содержимое файла *YAML* с помощью любого средства проверки YAML в Интернете, например [этого](https://onlineyamltools.com/validate-yaml).

1. Сохраните и закройте файл. В командном окне выполните следующую команду и войдите в систему при появлении запроса. 

    ```cmd/sh
    dotnet run CreateEndpoints
    ```

   Эта команда создает конечную точку для службы "Сетка событий". 

   ![Конечные точки для службы "Сетка событий"](./media/tutorial-facilities-events/dotnet-create-endpoints.png)


## <a name="notify-events-with-logic-app"></a>Уведомление о событиях с помощью приложения логики
Служба [Azure Logic Apps](../logic-apps/logic-apps-overview.md) позволяет создавать автоматизированные задачи для событий, полученных от других служб. В этом разделе вы настроите Logic Apps на создание электронных уведомлений о событиях, отправляемых с пространственных датчиков с помощью [раздела службы "Сетка событий"](../event-grid/overview.md).

1. В левой области навигации [портала Azure](https://portal.azure.com) щелкните **Создать ресурс**.

1. Найдите и выберите новый ресурс **Приложение логики**. Нажмите кнопку **Создать**.

1. Введите **имя** для своего приложения логики, а затем выберите **подписку**, **группу ресурсов** и **расположение**. Нажмите кнопку **Создать**.

    ![Создание приложения логики](./media/tutorial-facilities-events/create-logic-app.png)

1. Откройте развернутое приложение логики, а затем откройте панель **Конструктор приложений логики**. 

1. Выберите триггер **When an Event Grid event occurs** (Когда происходит событие службы "Сетка событий"). При появлении запроса **войдите** в клиент с использованием учетной записи Azure. При появлении запроса подтвердите **разрешение доступа** к вашей службе "Сетка событий". Нажмите кнопку **Продолжить**.

1. В окне **When an Event Grid event occurs (Preview)** (Когда происходит событие службы "Сетка событий" (предварительная версия)) сделайте следующее: 
    1. Выберите **подписку**, которую вы использовали ранее для создания службы "Сетка событий".

    1. Выберите **Microsoft.EventGrid.Topics** в качестве **типа ресурса**.

    1. Выберите ваш ресурс "Сетка событий" из раскрывающегося списка в поле **Имя ресурса**.

    ![Создание приложения логики](./media/tutorial-facilities-events/logic-app-resource-event.png)

1. Нажмите кнопку **Новый шаг**.

1. В окне **Выберите действие** сделайте следующее:
    1. Выполните поиск фразы *анализ json* и выберите действие **Анализ JSON**.

    1. Щелкните в поле **Содержимое** и выберите **Текст** из списка **Динамическое содержимое**.

    1. Выберите **Use sample to payload to generate schema** (Использовать пример полезной нагрузки, чтобы создать схему). Вставьте следующие полезные данные JSON и нажмите кнопку **Готово**.

        ```JSON
        {
        "id": "32162f00-a8f1-4d37-aee2-9312aabba0fd",
        "subject": "UdfCustom",
        "data": {
          "TopologyObjectId": "20efd3a8-34cb-4d96-a502-e02bffdabb14",
          "ResourceType": "Space",
          "Payload": "\"Air quality is poor.\"",
          "CorrelationId": "32162f00-a8f1-4d37-aee2-9312aabba0fd"
        },
        "eventType": "UdfCustom",
        "eventTime": "0001-01-01T00:00:00Z",
        "dataVersion": "1.0",
        "metadataVersion": "1",
        "topic": "/subscriptions/a382ee71-b48e-4382-b6be-eec7540cf271/resourceGroups/HOL/providers/Microsoft.EventGrid/topics/DigitalTwinEventGrid"
        }
        ```
    
    В этих полезных данных есть фиктивные значения. Приложение логики использует пример полезных данных для создания **схемы**.
    
    ![Анализ JSON в приложении логики для службы "Сетка событий"](./media/tutorial-facilities-events/logic-app-parse-json.png)

1. Нажмите кнопку **Новый шаг**.

1. В окне **Выберите действие** сделайте следующее:
    1. Найдите и выберите **Condition Control** (Элемент управления условием) из списка **Действия**. 

    1. Щелкните в первом текстовом поле **Выбор значения** и выберите **eventType** из списка **Динамическое содержимое** окна **Анализ JSON**.

    1. Затем щелкните в текстовом поле **Выбор значения** и введите *UdfCustom*.

    ![Анализ JSON в приложении логики для службы "Сетка событий"](./media/tutorial-facilities-events/logic-app-condition.png)

1. Внутри окна **Если истинно** сделайте следующее:
    1. Щелкните **Добавить действие** и выберите *Office 365 Outlook*.

    1. Из списка **Действия** выберите **Отправить электронное письмо**. Нажмите кнопку **Вход** и используйте учетные данные учетной записи электронной почты. При появлении запроса нажмите кнопку **Разрешить доступ**.

    1. В поле **Кому** введите свой идентификатор электронной почты для получения уведомлений. В поле **Тема** введите текст *Уведомление Digital Twins о плохом качестве воздуха в пространстве*, а затем выберите **TopologyObjectId** из списка **Динамическое содержимое** для окна **Анализ JSON**.

    1. В поле **Текст** того же окна введите примерно такой текст: *В комнате обнаружено плохое качество воздуха, и температура должна быть отрегулирована*. Вы можете прорабатывать все до мелочей с помощью элементов из списка **Динамическое содержимое**, как показано ниже.

    ![Отправка электронного письма из приложения логики](./media/tutorial-facilities-events/logic-app-send-email.png)

1. Нажмите кнопку **Сохранить** в верхней части панели **Конструктор приложений логики**.

1. Сымитируйте данные датчиков, перейдя в командном окне в папку **_device-connectivity_** примера Digital Twin и запустив `dotnet run`.

Через несколько минут вы начнете получать электронные уведомления из приложения логики. 

   ![Отправка электронного письма из приложения логики](./media/tutorial-facilities-events/logic-app-notification.png)

Чтобы отключить получение этих сообщений, перейдите к **приложению логики** на портале и выберите область **Обзор**. Нажмите кнопку **Отключить**.


## <a name="clean-up-resources"></a>Очистка ресурсов

Если на этом этапе вы хотите прекратить изучение Azure Digital Twins, можно удалить ресурсы, созданные в этом руководстве:

1. На [портале Azure](http://portal.azure.com) в меню слева щелкните **Все ресурсы**, выберите группу ресурсов Digital Twins и **удалите** ее.
2. Если необходимо, можно также удалить примеры приложений на рабочем компьютере. 


## <a name="next-steps"></a>Дополнительная информация

Вы можете приступить к следующему руководству, чтобы узнать, как визуализировать данные датчиков, а также анализировать тенденции и обнаруживать аномалии. 
> [!div class="nextstepaction"]
> [Руководство по визуализации и анализу событий пространств Azure Digital Twins с помощью Аналитики временных рядов](tutorial-facilities-analyze.md)

Вы также можете получить дополнительные сведения о пространственных интеллектуальных графах и моделях объектов в Azure Digital Twins. 
> [!div class="nextstepaction"]
> [Understanding Digital Twins object models and spatial intelligence graph](concepts-objectmodel-spatialgraph.md) (Основные сведения об объектных моделях и пространственном интеллектуальном графе в Digital Twins)