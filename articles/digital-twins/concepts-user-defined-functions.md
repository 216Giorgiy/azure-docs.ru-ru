---
title: Обработка данных и определяемые пользователем функции в Azure Digital Twins | Документация Майкрософт
description: Обзор обработки данных и определяемых пользователем функций в Azure Digital Twins
author: alinamstanciu
manager: bertvanhoof
ms.service: digital-twins
services: digital-twins
ms.topic: conceptual
ms.date: 10/08/2018
ms.author: alinast
ms.openlocfilehash: b7561848ffd0158e22e97530774112dcee2a9864
ms.sourcegitcommit: 74941e0d60dbfd5ab44395e1867b2171c4944dbe
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2018
ms.locfileid: "49323915"
---
# <a name="data-processing-and-user-defined-functions"></a>Обработка данных и определяемые пользователем функции

Azure Digital Twins предлагает расширенные вычислительные возможности. Разработчики могут определять и выполнять пользовательские функции с входящими сообщениями телеметрии для отправки событий в предварительно определенные конечные точки.

## <a name="data-processing-flow"></a>Процедура обработки данных

Когда устройства отправляют данные телеметрии к Digital Twins, разработчики могут обрабатывать данные в четыре этапа: _проверка_, _соответствие_, _вычисление_, и _диспетчеризация_.

![Поток обработки данных Digital Twins][1]

1. На этапе _проверки_ входящее сообщение телеметрии преобразуется в общепринятый формат [`data transfer object`](https://en.wikipedia.org/wiki/Data_transfer_object). На этом этапе также выполняется проверка устройств и датчиков.
1. На этапе _соответствие_ происходит поиск соответствующих определяемых пользователем функций для выполнения. Предопределенные сопоставления сущностей, обнаружат, определяемые пользователем функции на основе устройств, датчиков и сведений о пространстве из входящего сообщения телеметрии.
1. На этапе _вычисление_ определяемые пользователем функции выполняются точно так же, как на предыдущем этапе. Эти функции могут считывать и обновлять вычисленные значения на узлах пространственных граф и могут создавать пользовательские уведомления.
1. На этапе _диспетчеризации_ все пользовательские уведомления направляются от этапа вычислений к конечным точкам, определенным в графе.

## <a name="data-processing-objects"></a>Объекты обработки данных

Обработка данных в Azure Digital Twins состоит из определения трех объектов: _сопоставления_, _определяемые пользователем функции_, и _назначения ролей_.

![Поток обработки данных Digital Twins][2]

### <a name="matchers"></a>Сопоставления

_Сопоставления_ определяют набор условий, оценивающих, какие предпринимаемые действия, основаны на входящих данных телеметрии датчика. Эти условия, для определения соответствия могут включать свойства, родительское устройство и родительское пространство датчика. Условия выражаются в виде сравнения с [путем JSON](http://jsonpath.com/) как описано в следующем примере.

- Все датчики типа данных `Temperature`.
- Наличие `01` в их портах.
- Которые относятся к устройствам с ключом расширенного свойства `Manufacturer` присвоенного к значению `GoodCorp`.
- Которые принадлежат к типу пространства `Venue`.
- Которые походят с родительского `SpaceId` `DE8F06CA-1138-4AD7-89F4-F782CC6F69FD`.

```JSON
{
  "SpaceId": "DE8F06CA-1138-4AD7-89F4-F782CC6F69FD",
  "Name": "My custom matcher",
  "Description": "All sensors of datatype Temperature with 01 in their port that belong to devices with the extended property key Manufacturer set to the value GoodCorp and that belong to spaces of type Venue that are somewhere below space Id DE8F06CA-1138-4AD7-89F4-F782CC6F69FD",
  "Conditions": [
    {
      "target": "Sensor",
      "path": "$.dataType",
      "value": "\"Temperature\"",
      "comparison": "Equals"
    },
    {
      "target": "Sensor",
      "path": "$.port",
      "value": "01",
      "comparison": "Contains"
    },
    {
      "target": "SensorDevice",
      "path": "$.properties[?(@.name == 'Manufacturer')].value",
      "value": "\"GoodCorp\"",
      "comparison": "Equals"
    },
    {
      "target": "SensorSpace",
      "path": "$.type",
      "value": "\"Venue\"",
      "comparison": "Equals"
    }
  ]
}
```

> [!IMPORTANT]
> - Пути JSON не учитывают регистр.
> - Полезные данные JSON совпадают со значением полезных данных, которые возвращаются:
>   - `/sensors/{id}?includes=properties,types` для датчика;
>   - `/devices/{id}?includes=properties,types,sensors,sensorsproperties,sensorstypes` для устройства родительского датчика;
>   - `/spaces/{id}?includes=properties,types,location,timezone` для пространства родительского датчика.
> - Сравнения выполняются без учета регистра.

### <a name="user-defined-functions"></a>Определяемые пользователем функции

Объект _определяемой пользователем функции_ (_UDF_), имеет пользовательскую функцию, которая выполняется в изолированной среде в Azure Digital Twins. UDF имеют доступ как к сообщению телеметрической передачи необработанного датчика по мере его получения, так и к пространственному графику и диспетчерской службе. Как только UDF зарегистрирован в графе, необходимо создать соединитель (описано выше), чтобы указать, когда запускать UDF. Когда Digital Twins получает новые данные телеметрии из данного датчика, сопоставленная определяемая пользователем функция может вычислить скользящее среднее значение, например, нескольких последних датчиков.

Определяемые пользователем функции могут быть написаны на JavaScript и позволяют разработчикам выполнять настраиваемые фрагменты кода из сообщений телеметрии датчиков. Существуют вспомогательные методы для взаимодействия с графами в среде выполнения определяемой пользователем. С помощью определяемой пользователем функции разработчики могут:

- вводить считывание датчика непосредственно на датчик объекта в графе;
- выполнять действие в графе на основании показаний датчика в пространстве;
- создавать уведомления при выполнении определенных условий для показаний датчика;
- присоединять метаданные графа перед отправкой уведомления к показаниям датчика.

Дополнительную информацию см. в статье [Использование определяемых пользователем функций в Azure Digital Twins](how-to-user-defined-functions.md).

### <a name="role-assignment"></a>Назначение роли

Для защиты данных в службе, действия определяемой пользователем функции попадают под контроль управления доступом на основе ролей Digital Twins. Назначения ролей гарантируют, что данный UDF имеет соответствующие разрешения для взаимодействия с пространственным графом. Например, UDF пытается создать, считать, обновить или удалить графические данные в текущем пространстве. Уровень доступности определяемой пользователем функции, проверяется когда эта функция запрашивает данные графа или пытается выполнить действие. Дополнительные сведения см. в статье [Создание назначений ролей и управление ими](security-create-manage-role-assignments.md).

Возможно, что сопоставление запускает UDF, которая не имеет назначения ролей. В этом случае определяемая пользователем функция не сможет считывать данные из графа.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения см. в статье [Маршрутизация событий и сообщений](concepts-events-routing.md).

Дополнительные сведения о способах создания сопоставления сущностей, определяемых пользователем функций и назначения ролей см. в статье [Использование определяемых пользователем функций в Azure Digital Twins](how-to-user-defined-functions.md).

<!-- Images -->
[1]: media/concepts/digital-twins-data-processing-flow.png
[2]: media/concepts/digital-twins-user-defined-functions.png
