---
title: Обработка данных и определяемые пользователем функции в Azure Digital Twins | Документация Майкрософт
description: Обзор обработки данных, сопоставлений и определяемых пользователем функций в Azure Digital Twins
author: alinamstanciu
manager: bertvanhoof
ms.service: digital-twins
services: digital-twins
ms.topic: conceptual
ms.date: 10/26/2018
ms.author: alinast
ms.openlocfilehash: 2703778cd2eab582a9e7311aaf2024f100261889
ms.sourcegitcommit: 1f9e1c563245f2a6dcc40ff398d20510dd88fd92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2018
ms.locfileid: "51624528"
---
# <a name="data-processing-and-user-defined-functions"></a>Обработка данных и определяемые пользователем функции

Azure Digital Twins предлагает расширенные вычислительные возможности. Разработчики могут определять и выполнять пользовательские функции с входящими сообщениями телеметрии для отправки событий в предварительно определенные конечные точки.

## <a name="data-processing-flow"></a>Процедура обработки данных

Когда устройства отправляют данные телеметрии в Azure Digital Twins, разработчики могут обрабатывать данные в четыре этапа: проверка, соответствие, вычисление и диспетчеризация.

![Поток обработки данных Azure Digital Twins][1]

1. На этапе проверки входящее сообщение телеметрии преобразуется в общепринятый формат [объекта передачи данных](https://en.wikipedia.org/wiki/Data_transfer_object). На этом этапе также выполняется проверка устройств и датчиков.
1. На этапе соответствия происходит поиск соответствующих определяемых пользователем функций для выполнения. Предопределенные сопоставления сущностей обнаруживают определяемые пользователем функции на основе сведений об устройстве, датчике и пространстве из входящего сообщения телеметрии.
1. На этапе вычисления определяемые пользователем функции выполняются точно так же, как на предыдущем этапе. Эти функции могут считывать и обновлять вычисленные значения на узлах пространственных графов и могут создавать пользовательские уведомления.
1. На этапе диспетчеризации все пользовательские уведомления направляются от этапа вычислений к конечным точкам, определенным в графе.

## <a name="data-processing-objects"></a>Объекты обработки данных

Обработка данных в Azure Digital Twins состоит из определения трех объектов: сопоставлений, определяемых пользователем функций и назначений ролей.

![Объекты обработки данных Digital Twins][2]

### <a name="matchers"></a>Сопоставления

Сопоставления определяют набор условий, оценивающих, какие действия предпринимаются на основе входящих данных телеметрии датчика. Условия для определения соответствия могут включать свойства датчика, родительского устройства датчика и родительского пространства датчика. Условия выражаются в виде сравнения с [путем JSON](http://jsonpath.com/), как описано в следующем примере:

- Все датчики типа данных **Temperature** (Температура).
- Наличие `01` в их портах.
- Которые относятся к устройствам с ключом расширенного свойства **Manufacturer** (Производитель), которому присвоено значение `"GoodCorp"`.
- Которые принадлежат к типу пространства `"Venue"`.
- Которые являются потомками родительского **SpaceId** `DE8F06CA-1138-4AD7-89F4-F782CC6F69FD`.

```JSON
{
  "SpaceId": "DE8F06CA-1138-4AD7-89F4-F782CC6F69FD",
  "Name": "My custom matcher",
  "Description": "All sensors of datatype Temperature with 01 in their port that belong to devices with the extended property key Manufacturer set to the value GoodCorp and that belong to spaces of type Venue that are somewhere below space Id DE8F06CA-1138-4AD7-89F4-F782CC6F69FD",
  "Conditions": [
    {
      "target": "Sensor",
      "path": "$.dataType",
      "value": "\"Temperature\"",
      "comparison": "Equals"
    },
    {
      "target": "Sensor",
      "path": "$.port",
      "value": "01",
      "comparison": "Contains"
    },
    {
      "target": "SensorDevice",
      "path": "$.properties[?(@.name == 'Manufacturer')].value",
      "value": "\"GoodCorp\"",
      "comparison": "Equals"
    },
    {
      "target": "SensorSpace",
      "path": "$.type",
      "value": "\"Venue\"",
      "comparison": "Equals"
    }
  ]
}
```

> [!IMPORTANT]
> - Пути JSON не учитывают регистр.
> - Полезные данные JSON совпадают с возвращаемыми полезными данными по таким значениям:
>   - `/sensors/{id}?includes=properties,types` для датчика;
>   - `/devices/{id}?includes=properties,types,sensors,sensorsproperties,sensorstypes` для устройства родительского датчика;
>   - `/spaces/{id}?includes=properties,types,location,timezone` для пространства родительского датчика.
> - Сравнения выполняются без учета регистра.

### <a name="user-defined-functions"></a>Определяемые пользователем функции

Определяемая пользователем функция выполняется в изолированной среде в Azure Digital Twins. Эти функции имеют доступ как к сообщению необработанной телеметрии датчика, так и к пространственному графику и диспетчерской службе. Как только определяемая пользователем функция зарегистрирована в графе, необходимо создать сопоставитель (описано выше), чтобы указать, когда запускать эту функцию. Когда Digital Twins получает новые данные телеметрии из данного датчика, сопоставленная определяемая пользователем функция может вычислить скользящее среднее значение, например, нескольких последних значений датчика.

Определяемые пользователем функции можно написать на языке JavaScript. Разработчики могут выполнять пользовательские фрагменты кода для сообщений телеметрии датчиков. Существуют вспомогательные методы для взаимодействия с графами в среде выполнения, определяемой пользователем. С помощью определяемой пользователем функции разработчики могут:

- вводить считывание датчика непосредственно на датчик объекта в графе;
- выполнять действие в графе на основании показаний датчика в пространстве;
- создавать уведомления при выполнении определенных условий для показаний датчика;
- присоединять метаданные графа перед отправкой уведомления к показаниям датчика.

Дополнительные сведения об [использовании определяемых пользователем функций](how-to-user-defined-functions.md).

### <a name="role-assignment"></a>Назначение роли

Для защиты данных в службе действия определяемой пользователем функции попадают под контроль управления доступом на основе ролей Digital Twins. Назначения ролей гарантируют, что данная определяемая пользователем функция имеет соответствующие разрешения для взаимодействия с пространственным графом. Например, UDF пытается создать, считать, обновить или удалить графические данные в текущем пространстве. Уровень доступности определяемой пользователем функции, проверяется когда эта функция запрашивает данные графа или пытается выполнить действие. Дополнительные сведения об [управлении доступом на основе ролей](security-create-manage-role-assignments.md).

Возможно, что сопоставление запускает UDF, которая не имеет назначения ролей. В этом случае определяемая пользователем функция не сможет считывать данные из графа.

## <a name="next-steps"></a>Дополнительная информация

* Узнать, как маршрутизировать события и сообщения телеметрии к другим службам Azure, в [этой статье](concepts-events-routing.md).

* Дополнительные сведения о способах создания сопоставления сущностей, определяемых пользователем функций и назначения ролей см. в статье [Использование определяемых пользователем функций в Azure Digital Twins](how-to-user-defined-functions.md).

<!-- Images -->
[1]: media/concepts/digital-twins-data-processing-flow.png
[2]: media/concepts/digital-twins-user-defined-functions.png
