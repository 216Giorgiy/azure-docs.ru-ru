.<properties 
	pageTitle="Действие ";Хранимая процедура SQL Server";" 
	description="Узнайте, как с помощью действия хранимой процедуры SQL Server можно вызвать хранимую процедуру в Базе данных SQL Azure или хранилище данных SQL Azure из конвейера фабрики данных." 
	services="data-factory" 
	documentationCenter="" 
	authors="spelluru" 
	manager="jhubbard" 
	editor="monicar"/>

<tags 
	ms.service="data-factory" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="08/18/2016" 
	ms.author="spelluru"/>

# Действие "Хранимая процедура SQL Server"

С помощью действия "Хранимая процедура SQL Server" в [конвейере](data-factory-create-pipelines.md) фабрики данных можно вызвать хранимую процедуру в одном из следующих хранилищ данных.


- База данных SQL Azure
- Хранилище данных SQL Azure
- База данных SQL Server в вашей организации или на виртуальной машине Azure. Шлюз управления данными необходимо установить на том же компьютере, на котором размещена база данных, или на отдельном компьютере во избежание конкуренции за ресурсы с базой данных. Шлюз управления данными — это программное обеспечение, которое обеспечивает безопасное и управляемое подключение локальных источников данных и источников данных, расположенных на виртуальных машинах Azure, к облачным службам. Сведения о шлюзе управления данными см. в статье [Перемещение данных между локальными источниками и облаком](data-factory-move-data-between-onprem-and-cloud.md).

Данная статья основана на материалах статьи о [действиях преобразования данных](data-factory-data-transformation-activities.md), в которой приведен общий обзор преобразования данных и список поддерживаемых действий преобразования.

## Синтаксис
	{
    	"name": "SQLSPROCActivity",
    	"description": "description", 
    	"type": "SqlServerStoredProcedure",
    	"inputs":  [ { "name": "inputtable"  } ],
    	"outputs":  [ { "name": "outputtable" } ],
    	"typeProperties":
    	{
        	"storedProcedureName": "<name of the stored procedure>",
        	"storedProcedureParameters":  
        	{
				"param1": "param1Value"
				…
        	}
    	}
	}

## Сведения о синтаксисе

Свойство | Описание | Обязательно
-------- | ----------- | --------
name | Имя действия. | Да
description | Текст, описывающий, для чего используется действие | Нет
type | SqlServerStoredProcedure | Да
inputs | необязательный параметр. При указании входного набора данных он должен быть доступен (в состоянии "Готово") для выполнения действия хранимой процедуры. Входной набор данных не может потребляться в хранимой процедуре в качестве параметра. Он используется только для проверки зависимости перед запуском действия хранимой процедуры. | Нет
outputs | Для действия хранимой процедуры необходимо указать выходной набор данных. Выходной набор данных указывает **расписание** для действия хранимой процедуры (ежечасно, еженедельно, ежемесячно и т. д.). <br/><br/>Выходной набор данных должен использовать **связанную службу**, ссылающуюся на базу данных SQL Azure, хранилище данных SQL Azure или базу данных SQL Server, в которых следует запускать хранимую процедуру. <br/><br/>Выходной набор данных может использоваться для передачи результатов хранимой процедуры для дальнейшей обработки с помощью другого действия ([цепочки действий](data-factory-scheduling-and-execution.md#chaining-activities)) в конвейере. Тем не менее фабрика данных не записывает выходные данные хранимой процедуры в этот набор данных автоматически. Выходные данные записывает сама хранимая процедура в таблицу SQL, на которую указывает выходной набор данных. <br/><br/>В некоторых случаях выходной набор данных может быть **фиктивным набором данных**. Он используется, только чтобы задать расписание выполнения действия хранимой процедуры. | Да
storedProcedureName | Укажите имя хранимой процедуры в базе данных SQL Azure или хранилище данных SQL Azure, представленной связанной службой, которую использует выходная таблица. | Да
storedProcedureParameters | Указываемые значения для параметров хранимой процедуры. Если для параметра необходимо передать значение null, используйте синтаксис param1: null (все символы в нижнем регистре). Чтобы научиться использовать это свойство, см. пример ниже.| Нет

## Пошаговое руководство

### Образец таблицы и хранимая процедура
> [AZURE.NOTE] В этом примере используется база данных SQL Azure, но работает она точно так же, как в случае с хранилищем данных SQL Azure и базой данных SQL Server.

1. Создайте следующую **таблицу** в базе данных SQL Azure с помощью SQL Server Management Studio или другого подходящего инструмента. Столбец datetimestamp содержит дату и время создания соответствующего идентификатора.

		CREATE TABLE dbo.sampletable
		(
			Id uniqueidentifier,
			datetimestamp nvarchar(127)
		)
		GO

		CREATE CLUSTERED INDEX ClusteredID ON dbo.sampletable(Id);
		GO

	Id — уникальный идентификатор, а столбец datetimestamp содержит дату и время создания соответствующего идентификатора. ![Пример данных](./media/data-factory-stored-proc-activity/sample-data.png)

2. Создайте следующую **хранимую процедуру**, вставляющую данные в таблицу **sampletable**.

		CREATE PROCEDURE sp_sample @DateTime nvarchar(127)
		AS
		
		BEGIN
		    INSERT INTO [sampletable]
		    VALUES (newid(), @DateTime)
		END

	> [AZURE.IMPORTANT] **Имя** и **регистр** параметра (в этом примере — DateTime) должны соответствовать имени и регистру параметра, указанного в конвейере или действии JSON. Убедитесь, что в определении хранимой процедуры в качестве префикса для параметра используется символ **@**.
	
### Создать фабрику данных  
4. Войдите на [портал Azure](https://portal.azure.com/) и сделайте следующее:
	1.	В меню слева нажмите кнопку **Создать**.
	2.	В колонке **Создание** щелкните **Аналитика данных**.
	3.	Щелкните **Фабрика данных** в колонке **Аналитика данных**.
4.	В колонке **Создать фабрику данных** введите **SProcDF** в поле "Имя". Имена фабрики данных Azure являются глобально уникальными. Для успешного создания фабрики добавьте свое имя в качестве префикса имени фабрики.
3.	Если вы еще не создали группу ресурсов, сделайте это сейчас.
	1.	Щелкните **Имя группы ресурсов**.
	2.	Выберите **Создать новую группу ресурсов** в колонке **Группа ресурсов**.
	3.	В колонке **Создание группы ресурсов** введите значение **ADFTutorialResourceGroup** в поле **Имя**.
	4.	Нажмите кнопку **ОК**.
4.	После выбора группы ресурсов убедитесь, что используется именно та подписка, в которой нужно создать фабрику данных.
5.	В колонке **Создание фабрики данных** нажмите кнопку **Создать**.
6.	Созданная фабрика данных появится на **начальной панели** портала Azure. Ее содержимое отобразится на соответствующей странице.

### Создание связанной службы SQL Azure  
После создания фабрики данных вы создаете связанную службу SQL Azure, которая связывает вашу базу данных SQL Azure с фабрикой данных. Эта база данных содержит таблицу sampletable и хранимую процедуру sp\_sample.

7.	В колонке **Фабрика данных** щелкните **Создать и развернуть** для **SProcDF**, чтобы запустить редактор фабрики данных.
2.	Щелкните **Новое хранилище данных** в командной строке и выберите **Azure SQL**. В редакторе отобразится сценарий JSON для создания связанной службы SQL Azure.
4. Замените **servername** именем своего сервера базы данных SQL Azure, **databasename** — именем базы данных, в которой вы создали таблицу и хранимую процедуру, **username@servername** — учетной записью пользователя с доступом к базе данных, а **password** — паролем для учетной записи пользователя.
5. Чтобы развернуть эту службу, нажмите кнопку **Развернуть** на панели команд.

### Создание выходного набора данных
6. Щелкните **Новый набор данных** на панели команд и выберите **Azure SQL**.
7. Скопируйте и вставьте следующий скрипт JSON в редактор JSON.

		{			    
			"name": "sprocsampleout",
			"properties": {
				"type": "AzureSqlTable",
				"linkedServiceName": "AzureSqlLinkedService",
				"typeProperties": {
					"tableName": "sampletable"
				},
				"availability": {
					"frequency": "Hour",
					"interval": 1
				}
			}
		}
7. Нажмите кнопку **Развернуть** на панели команд, чтобы развернуть набор данных.

### Создание конвейера с помощью действия SqlServerStoredProcedure
Теперь создадим конвейера с помощью действия SqlServerStoredProcedure.
 
9. Щелкните **... (многоточие)** на панели команд, затем щелкните **Создать конвейер**.
9. Скопируйте и вставьте следующий фрагмент JSON. Имя хранимой процедуры **StoredProcedureName** было установлено в **sp\_sample**. Имя и регистр параметра **DateTime** должны совпадать с именем и регистром параметра в определении хранимой процедуры.

		{
		    "name": "SprocActivitySamplePipeline",
		    "properties": {
		        "activities": [
		            {
		                "type": "SqlServerStoredProcedure",
		                "typeProperties": {
		                    "storedProcedureName": "sp_sample",
		                    "storedProcedureParameters": {
		                        "DateTime": "$$Text.Format('{0:yyyy-MM-dd HH:mm:ss}', SliceStart)"
		                    }
		                },
		                "outputs": [
		                    {
		                        "name": "sprocsampleout"
		                    }
		                ],
		                "scheduler": {
		                    "frequency": "Hour",
		                    "interval": 1
		                },
		                "name": "SprocActivitySample"
		            }
		        ],
         		"start": "2016-08-02T00:00:00Z",
         		"end": "2016-08-02T05:00:00Z",
		        "isPaused": false
		    }
		}

	Если для параметра необходимо передать значение null, используйте синтаксис param1: null (все символы в нижнем регистре).
9. Щелкните **Развернуть** на панели инструментов для развертывания конвейера.

### Мониторинг конвейера

6. Щелкните **X**, чтобы закрыть колонки редактора фабрики данных и вернуться в колонку фабрики данных. Затем щелкните **Схема**.
7. В представлении схемы вы увидите все конвейеры и наборы данных, используемые в этом руководстве.
8. В представлении схемы дважды щелкните набор данных **sprocsampleout**. Отобразятся срезы в состоянии "Готово". Должно отобразиться пять срезов, так как из JSON срез создается каждый час в периоде между временем начала и окончания.
10. Если срез находится в состоянии **Готово**, выполните запрос **select * from sampletable** к базе данных SQL Azure, чтобы убедиться, что хранимая процедура вставила данные в таблицу.

	![Выходные данные](./media/data-factory-stored-proc-activity/output.png)

	В разделе [Мониторинг конвейера](data-factory-monitor-manage-pipelines.md) представлены подробные сведения о мониторинге конвейеров фабрики данных Azure.

> [AZURE.NOTE] В приведенном выше примере SprocActivitySample не содержит входных данных. Если требуется организовать это действие в цепочку с вышестоящим действием (то есть ранее выполнявшимся действием обработки), выходные данные вышестоящего действия можно использовать как входные данные в этом действии. В таком случае действие не будет выполнено, пока не завершится вышестоящее действие и не будут доступны выходные данные вышестоящих действий (в состоянии "Готово"). Входные данные нельзя использовать непосредственно в качестве параметра действия хранимой процедуры

## Передача статического значения 
Теперь давайте рассмотрим добавление другого столбца с именем "Scenario" в таблицу, содержащую статическое значение с именем "Document sample".

![Пример данных 2](./media/data-factory-stored-proc-activity/sample-data-2.png)

	CREATE PROCEDURE sp_sample @DateTime nvarchar(127) , @Scenario nvarchar(127)
	
	AS
	
	BEGIN
	    INSERT INTO [sampletable]
	    VALUES (newid(), @DateTime, @Scenario)
	END

Теперь передайте параметр Scenario и значение из действия хранимой процедуры. Раздел typeProperties в приведенном выше примере выглядит как следующий фрагмент кода:

	"typeProperties":
	{
		"storedProcedureName": "sp_sample",
	    "storedProcedureParameters": 
	    {
	    	"DateTime": "$$Text.Format('{0:yyyy-MM-dd HH:mm:ss}', SliceStart)",
			"Scenario": "Document sample"
		}
	}

<!---HONumber=AcomDC_0824_2016-->