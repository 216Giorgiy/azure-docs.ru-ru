<properties 
	pageTitle="Фабрика данных. Создание прогнозирующих конвейеров с помощью фабрик данных и машинного обучения | Azure" 
	description="Описывает создание создания прогнозирующего конвейеры, с помощью фабрики Azuer данных и Azure машинного обучения" 
	services="data-factory" 
	documentationCenter="" 
	authors="spelluru" 
	manager="jhubbard" 
	editor="monicar"/>

<tags 
	ms.service="data-factory" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/05/2015" 
	ms.author="spelluru"/>

# Создание прогнозирующих конвейеров с помощью фабрик данных Azure и машинного обучения Azure 
## Обзор
Вы можете вводят в действие публикации [Azure машинного обучения][azure-machine-learning] модели в конвейерах данных фабрики Azure. Конвейер, называются конвейеры прогнозирования. Для создания прогнозирующего конвейера потребуется следующее.

-	Ключ API опубликованной модели рабочей области и URL-адрес количественной оценки (см. рисунок ниже)
-	BLOB-объектов Azure хранилище удерживая входной файл CSV (или) база данных Azure SQL, который содержит входные данные данные быть рассчитаны. 
-	Хранилище больших двоичных объектов, который будет содержать оценки результатов CSV-файл (или) базы данных Azure SQL, который будет содержать выходные данные. 

	![Панель мониторинга машины обучения][machine-learning-dashboard]

	Пакет оценки URL-адрес для AzureMLLinkedService получается из как показано на рисунке выше, за вычетом "** справки **": https://ussouthcentral.services.azureml.net/workspaces/da9e350b758e44b2812a6218d507e216/services/8c91ff373a81416f8f8e0d96a1162681/jobs/

Объект **прогнозирующей конвейера** состоит из следующих частей:

-	Входные и выходные таблицы
-	Azure SQL хранилища Azure и Azure ML связанных служб
-	Конвейер с действием количественной оценки Azure ML

> [AZURE.NOTE]Можно использовать параметры веб-службы, предоставляемые опубликованной Azure машины обучения веб-службы в конвейерах данных фабрика Azure (ADF). Дополнительные сведения см. в разделе Параметры веб-службы в этой статье.

## Пример
Этот пример использует хранилище Azure для хранения входных и выходных данных. Также можно использовать базу данных SQL Azure вместо использования хранилища Azure.

Рекомендуется пройти [Приступая к работе с фабрикой данных Azure][adf-getstarted] учебника перед посредством этого примера и использования фабрики редактора данных для создания артефактов фабрика данных (связанные службы, таблицы, конвейер) в этом примере.
 

1. Создание связанной службы для хранилища Azure. Если входные и выходные файлы оценки находятся в разных учетных записях хранения, то потребуются две связанные службы. Ниже приведен пример JSON:

		{
		    "name": "StorageLinkedService",
		    "properties":
		    {
		        "type": "AzureStorageLinkedService",
		        "connectionString": "DefaultEndpointsProtocol=https;AccountName=[acctName];AccountKey=[acctKey]"
		    }
		}

2. Создание входных и выходных таблиц фабрики данных Azure. Обратите внимание, что в отличие от некоторых других таблиц данных фабрики эти должны оба содержать оба **folderPath** и **fileName** значения. Можно использовать секционирование для выполнения каждого пакета (каждого среза данных) для обработки или создания уникальных входных и выходных файлов. Скорее всего, потребуется включить некоторые вышестоящие действия для преобразования входных данных в формат CSV-файла и его размещения в учетной записи хранения для каждого среза. В этом случае не будут включены параметры waitOnExternal, как показано на примере ниже, и ScoringInputBlob будет выходной таблицей другого действия.

		{  
			"name":"ScoringInputBlob",
			"properties":
			{  
					"location":
					{  
						"type":"AzureBlobLocation",
						"folderPath":"azuremltesting/input",
						"fileName":"in.csv",
						"format":
						{ 
							"type":"TextFormat",
							"columnDelimiter":","
						},
						"linkedServiceName":"StorageLinkedService"
					},
					"availability":
					{  
						"frequency":"Day",
						"interval":1,
						"waitOnExternal":
						{
		                	"retryInterval": "00:01:00",
		                	"retryTimeout": "00:10:00",
		                	"maximumRetry": 3
		            	}
		      		}
		   		}
			}
	
	Пакет оценки CSV-файл должен иметь строки заголовка столбца. При использовании **Действие копирования** для создания или перемещения csv в хранилище BLOB-объектов, следует установить свойство приемника **blobWriterAddHeader** для **true**. Например:
	
	     sink: 
	     {
	         "type": "BlobSink",     
	         "blobWriterAddHeader": true 
	     }
	 
	Если CSV-файл не имеет строку заголовка, может появиться следующая ошибка: **ошибки в действии: ошибка при чтении строки. Непредвиденная лексема: StartObject. Путь ", строка 1, в позиции 1**.
3. В этом примере выходных данных используется секционирование для создания уникального выходного пути при выполнении каждого из срезов. Без этого действие перезапишет файл.

		{  
		   "name":"ScoringResultBlob",
		   "properties":
			{  
		        "location":
				{  
		            "type":"AzureBlobLocation",
		            "folderPath": "azuremltesting/scored/{folderpart}/",
		            "fileName": "{filepart}result.csv",
		            "partitionedBy": [ 
		                 { "name": "folderpart", "value": { "type": "DateTime", "date": "SliceStart", "format": "yyyyMMdd" } },
		                 { "name": "filepart", "value": { "type": "DateTime", "date": "SliceStart", "format": "HHmmss" } } 
		             ], 
		            "format":{  
		              "type":"TextFormat",
		              "columnDelimiter":","
		            },
		            "linkedServiceName":"StorageLinkedService"
		        },
		        "availability":
				{  
		            "frequency":"Day",
		            "interval":15
		        }
		   }
		}


4. Создание связанного типа службы: **AzureMLLinkedService**, предоставляя ключ API и модель оценки URL-адрес пакета.
		
		{
		    "name": "MyAzureMLLinkedService",
		    "properties":
		    {
		        "type": "AzureMLLinkedService",
		        "mlEndpoint":"https://[batch scoring endpoint]/jobs",
		        "apiKey":"[apikey]"
		    }
		}

5. И, наконец, разработке конвейера содержащего **AzureMLBatchScoringActivity**. Он получит расположение входного файла из входных таблиц, вызовет API количественной оценки AzureML и скопирует выходные данные количественной оценки в большой двоичный объект, переданный в таблице выходных данных. В отличие от некоторых других действий фабрики данных AzureMLBatchScoringActivity может иметь только одну входную и одну выходную таблицы.

		 {
		    "name": "PredictivePipeline",
		    "properties":
		    {
		        "description" : "use AzureML model",
		        "activities":
		        [
		         {  
		            "name":"MLActivity",
		            "type":"AzureMLBatchScoringActivity",
		            "description":"prediction analysis on batch input",
		            "inputs": [ { "name": "ScoringInputBlob" } ],
		            "outputs":[ { "name": "ScoringResultBlob" } ],
		            "linkedServiceName":"MyAzureMLLinkedService",
		            "policy":{  
		               "concurrency":3,
		               "executionPriorityOrder":"NewestFirst",
		               "retry":1,
		               "timeout":"02:00:00"
		            }
		         }
		        ]
		    }
		}


## Параметры веб-службы
Можно использовать параметры веб-службы, предоставляемые опубликованной Azure машины обучения веб-службы в конвейерах данных фабрика Azure (ADF). Можно создать эксперимента в Azure машинного обучения и опубликовать его как веб-службы и затем использовать эту веб-службу в нескольких конвейеры ADF или действий, передавая различных входных через параметры веб-службы.

### Передача значений для параметры веб-службы
Добавить **преобразования** раздел **AzureMLBatchScoringActivty** раздел в конвейере JSON для указания значений для параметры веб-службы в этом разделе, как показано в следующем примере:

	transformation: {
		webServiceParameters: {
			"Param 1": "Value 1",
			"Param 2": "Value 2"
		}
	}


Можно также использовать [функции фабрики данных](https://msdn.microsoft.com/library/dn835056.aspx) при передаче значения для веб-службы параметров, как показано в следующем примере:

	transformation: {
    	webServiceParameters: {
    	   "Database query": "$$Text.Format('SELECT * FROM myTable WHERE timeColumn = '{0:yyyy-MM-dd HH:mm:ss}'', Time.AddHours(SliceStart, 0))"
    	}
  	}
 
> [AZURE.NOTE]Параметры веб-службы, с учетом регистра, поэтому убедитесь, что имена, которые указываются в действии JSON соответствует те, предоставляемых веб-службой.

### Azure SQL модулей чтения и записи
Общие сценарии для использования параметры веб-службы является использование средства чтения SQL Azure и записи. Для загрузки данных в эксперимента из служб управления данными за пределами Azure машины обучения Studio используется модуль чтения и модуля записи для сохранения данных из эксперименты в службах управления данными за пределами Azure машины обучения Studio. Дополнительные сведения о SQL Azure BLOB-объектов Azure чтения/записи см [чтения](https://msdn.microsoft.com/library/azure/dn905997.aspx) и [записи](https://msdn.microsoft.com/library/azure/dn905984.aspx) разделы в библиотеке MSDN. В примере в предыдущем разделе используется Azure Blob чтения и записи больших двоичных объектов Azure. В этом разделе рассматривается использование Azure SQL чтения и модуля записи Azure SQL.

#### Модуль чтения Azure SQL
В Azure ML Studio можно построить эксперимента и публикации веб-службы с SQL Azure чтения для входных данных. Средство чтения SQL Azure имеет свойства соединения, которые могут быть предоставлены как параметры веб-службы, допускающие значения для свойства соединения, передаваемые во время выполнения в пакете оценки запроса.

Во время выполнения сведения из входной таблицы фабрика данных будет использоваться службой данных фабрики для заполнения в параметры веб-службы. Обратите внимание, что необходимо использовать имена по умолчанию (имя сервера базы данных, имя базы данных, имени учетной записи пользователя, пароль учетной записи пользователя сервера) для параметры веб-службы интеграции со службой данных фабрики для работы.

При наличии любого дополнительных веб-узла, используйте параметры **webServiceParameters** разделе действия JSON. При указании значения для параметров модуля чтения SQL Azure в этом разделе значения переопределяют значения выбираются из входного SQL Azure связанные службы. Не рекомендуется указывать значения для чтения SQL Azure раздела webServiceParameters. Используйте раздел передавать значения для любых дополнительных параметров.

Чтобы использовать средство чтения SQL Azure через конвейер фабрика данных Azure, выполните следующее:

- Создание **Azure SQL связанные службы**. 
- Создание фабрики данных **таблицы** использующий **AzureSqlTableLocation**.
- Задайте этой фабрики данных **таблицы** как **ввода** для **AzureMLBatchScoringActivity** в конвейере JSON. 



#### Модуль записи Azure SQL
Как чтения SQL Azure, модуль записи SQL Azure может также содержать его свойства предоставляются как параметры веб-службы. Модуль записи SQL Azure использует параметры либо связанные службы, связанной с таблице входной или выходной таблицы. В следующей таблице описаны, когда входные данные и вывода используется связанный связанные службы.

<table>
<tr>
<td>Выходные данные или ввода</td>
<td><b>Входные данные — Azure SQL</b></td>
<td><b>Входные данные — BLOB-объектов Azure</b></td>
</tr>
<tr>
<td><b>Вывод — Azure SQL</b></td>
<td><p>Служба фабрики данных использует строку подключения из службы связанных входных данных для создания параметры веб-службы с именами: «Имя сервера базы данных», «Имя базы данных», «Имя учетной записи пользователя сервера», «Пароль учетной записи пользователя сервера». Обратите внимание, что необходимо использовать имена по умолчанию для параметры веб-службы в Azure ML Studio.</p>
<p>Если средство чтения SQL Azure и модуль записи SQL Azure в Azure ML модели имеют одинаковые параметры веб-службы, упомянутых выше, подходят. Если не имеют одинаковые paramers веб-службы, например, если модуль записи SQL Azure использует имена параметров: базы данных сервера name1, name1 базы данных, name1 учетной записи пользователя сервера, пользователь сервера account password1 (с "1" в конце), необходимо передать значения для этих параметры ВЫВОДА веб-службы в разделе webServiceParameters действия JSON.</p>
<p>
Можно передавать значения для любого другие параметры веб-службы с помощью раздела webServiceParameters действия JSON.  
</p>

</td>
<td>
<p>Служба фабрики данных использует строку подключения из службы связанные выходные данные для создания параметры веб-службы с именами: «Имя сервера базы данных», «Имя базы данных», «Имя учетной записи пользователя сервера», «Пароль учетной записи пользователя сервера». Обратите внимание, что необходимо использовать имена по умолчанию для параметры веб-службы в Azure ML Studio.</p>
<p>Можно передавать значения для любого другие параметры веб-службы с помощью раздела webServiceParameters действия JSON. <p>Входного большого двоичного объекта будет использоваться как место хранения.</p>
</td>
</tr>
<tr>
<td><b>Выходные данные — BLOB-объектов Azure</b></td>
<td>Служба фабрики данных использует строку подключения из службы связанных входных данных для создания параметры веб-службы с именами: «Имя сервера базы данных», «Имя базы данных», «Имя учетной записи пользователя сервера», «Пароль учетной записи пользователя сервера». Обратите внимание, что необходимо использовать имена по умолчанию для параметры веб-службы в Azure ML Studio.
</td>
<td>
<p>Необходимо передавать значения для любого параметры веб-службы с помощью раздела WebServiceParameters действия JSON.</p> 

<p>BLOB-объектов будет использоваться как входные и выходные расположения.</p>

</td>
<tr>

</table>

> [AZURE.NOTE]Azure SQL Writer могут возникнуть нарушения ключа, если он является перезапись столбец идентификаторов. Необходимо обеспечить структуру выходную таблицу, чтобы избежать такой ситуации.
> 
> Промежуточные таблицы с действием хранимые процедуры можно использовать для объединения строк или усечения данных до оценки. При использовании этого подхода, значение параметра параллелизма executionPolicy 1.

### Пример использования параметры веб-службы
#### Конвейер с AzureMLBatchScoringActivity с параметры веб-службы

	{
		"name": "MLWithSqlReaderSqlWriter",
	  	"properties": {
		    "description": "Azure ML model with sql azure reader/writer",
		    "activities": [
		    	{
		    	    "name": "MLSqlReaderSqlWriterActivity",
		    	    "type": "AzureMLBatchScoringActivity",
		    	    "description": "test",
		        	"inputs": [ { "name": "MLSqlInput" } ],
		        	"outputs": [ { "name": "MLSqlOutput" } ],
		        	"linkedServiceName": "MLSqlReaderSqlWriterScoringModel",
		        	"policy": {
		          		"concurrency": 1,
			          	"executionPriorityOrder": "NewestFirst",
			          "retry": 1,
			          "timeout": "02:00:00"
			        },
			        transformation: {
			        	webServiceParameters: {
		            		"Database server name1": "output.database.windows.net",
				            "Database name1": "outputDatabase",
		            		"Server user account name1": "outputUser",
		            		"Server user account password1": "outputPassword",
			           		"Comma separated list of columns to be saved": "CustID, Scored Labels, Scored Probabilities",
		    		        "Data table name": "BikeBuyerPredicted" 
		          		}  
		        	}
		      	}
	    	]
		}
	}
 
В приведенном выше примере JSON:

- Модель Azure ML использует чтения SQL Azure и модуль записи SQL Azure
- При предоставлении через веб-службы для параметров используются имена по умолчанию
	- Для **чтения**: базы данных, имя сервера, имя базы данных, имени учетной записи пользователя и пароль учетной записи пользователя на сервере.
	- Для **записи**: name1 сервера, name1 базы данных, name1 учетной записи пользователя сервера и сервера password1 учетной записи пользователя базы данных.
	
		Обратите внимание, что средство чтения и записи не имеют параметров в этом случае.  
- Служба фабрики данных автоматически создает значения для параметры веб-службы с именами **имя сервера базы данных**, **имя базы данных**, **имя учетной записи пользователя сервера**, и **пароль учетной записи сервера**, которого совпадают с именами средства чтения входных данных. Таким образом, необходимо явным образом передать значения этих параметров через **webServiceParameters** в JSON ниже действия.  
- Параметры для записи (те, которые имеют суффикс «1») не заполняются автоматически службой данных фабрики. Таким образом, необходимо указать значения для этих параметров в **webServiceParameters** разделе действия JSON.  
- **Customer ID**, **результат метки**, и **оценки вероятности** сохраняются в виде столбцов с разделителями-запятыми. 
-  **Имя таблицы данных** в этом примере соответствует таблице в базе данных вывода.




## См. также

Статья | Описание
------ | ---------------
[Справочник разработчика фабрики данных Azure][developer-reference] | Справочник разработчика есть содержимое полный Справочник командлетов, скрипта JSON, библиотека классов .NET, функции, и т. д... 

[adf-introduction]: data-factory-introduction.md
[adf-getstarted]: data-factory-get-started.md
[use-onpremises-datasources]: data-factory-use-onpremises-datasources.md
[use-pig-and-hive-with-data-factory]: data-factory-pig-hive-activities.md
[adf-tutorial]: data-factory-tutorial.md
[use-custom-activities]: data-factory-use-custom-activities.md
[troubleshoot]: data-factory-troubleshoot.md
[data-factory-introduction]: data-factory-introduction.md
[developer-reference]: http://go.microsoft.com/fwlink/p/?LinkId=516908

[azure-machine-learning]: http://azure.microsoft.com/services/machine-learning/
[machine-learning-dashboard]: ./media/data-factory-create-predictive-pipelines/AzureMLDashboard.png

<!---HONumber=GIT-SubDir--> 