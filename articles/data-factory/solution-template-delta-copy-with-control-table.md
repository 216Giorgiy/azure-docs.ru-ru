---
title: Разностное копирование из базы данных с использованием контрольной таблицы в Фабрике данных Azure | Документация Майкрософт
description: Узнайте, как использовать шаблон решения для добавочного копирования только новых или обновленных строк из базы данных в Фабрике данных Azure.
services: data-factory
documentationcenter: ''
author: dearandyxu
ms.author: yexu
ms.reviewer: douglasl
manager: craigg
ms.service: data-factory
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 12/24/2018
ms.openlocfilehash: 23e1255013cd5e52166fe0e59a8931dd9ecd81a0
ms.sourcegitcommit: d1c5b4d9a5ccfa2c9a9f4ae5f078ef8c1c04a3b4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2019
ms.locfileid: "55966922"
---
# <a name="delta-copy-from-database-with-control-table"></a>Разностное копирование из базы данных с использованием контрольной таблицы

Если вам требуется добавочно загружать только изменения (новые или обновленные строки) из таблицы базы данных в Azure с использованием внешней контрольной таблицы, в которой хранится значение верхнего предела.  Рассматриваемый в этой статье шаблон предназначен для этого случая. 

Этот шаблон требует, чтобы схема базы данных-источника содержала столбец метки времени или добавочный ключ для идентификации новых или обновленных строк.

Если в базе данных-источнике есть столбец метки времени для идентификации новых или обновленных строк, но вы не хотите создавать внешнюю контрольную таблицу, позволяющую выполнять разностное копирование, вы можете использовать средство "Копирование данных", чтобы получить конвейер, который использует запланированное время в качестве переменной для считывания только новых строк из базы данных-источника.

## <a name="about-this-solution-template"></a>Информация о шаблоне решения

Этот шаблон всегда сначала извлекает старое значение предела, а затем сравнивает его с текущим значением. После этого из базы данных-источника копируются только изменения на основе сравнения двух значений пределов.  По завершении новое значение верхнего предела сохраняется во внешнюю контрольную таблицу для разностной загрузки данных в следующий раз.

Шаблон состоит из четырех действий.
-   Действие **поиска** для получения старого значения верхнего предела, хранящегося во внешней контрольной таблице.
-   Действие **поиска** для получения текущего значения верхнего предела из базы данных-источника.
-   Действие **копирования** для копирования только измененных данных из базы данных-источника в целевое хранилище. Запрос, используемый для определения изменений в базе данных-источника в действии копирования, похож на SELECT * FROM Data_Source_Table WHERE TIMESTAMP_Column > "последний верхний предел" и TIMESTAMP_Column <= "текущий верхний предел".
-   Действие **SqlServerStoredProcedure** для записи текущего значения верхнего предела во внешнюю контрольную таблицу для разностного копирования в следующий раз.

Шаблон определяет пять параметров.
-   Параметр *Data_Source_Table_Name* — это имя таблицы в базе данных-источнике, из которой необходимо загрузить данные.
-   Параметр *Data_Source_WaterMarkColumn* — это имя столбца в исходной таблице, которое может использоваться для идентификации новых или обновленных строк. Обычно типом этого столбца может быть datetime или INT и т. д.
-   Параметр *Data_Destination_Folder_Path* или *Data_Destination_Table_Name* — это расположение целевого хранилища, куда копируются данные.
-   Параметр *Control_Table_Table_Name* — это имя внешней контрольной таблицы для хранения значения верхнего предела.
-   Параметр *Control_Table_Column_Name* — это имя столбца во внешней контрольной таблице, где будет хранится значение верхнего предела.

## <a name="how-to-use-this-solution-template"></a>Использование шаблона решения

1. Изучите исходную таблицу, которую вы хотите загрузить, и определите столбец с верхним пределом, который можно использовать для среза новых или обновленных строк. Обычно типом этого столбца может быть datetime или INT и т д. Его данные продолжают увеличиваться при добавлении новых строк.  В примере исходной таблицы (имя таблицы: data_source_table), приведенном ниже, мы можем использовать столбец *LastModifytime* в качестве столбца верхнего предела.

    ```sql
            PersonID    Name    LastModifytime
            1   aaaa    2017-09-01 00:56:00.000
            2   bbbb    2017-09-02 05:23:00.000
            3   cccc    2017-09-03 02:36:00.000
            4   dddd    2017-09-04 03:21:00.000
            5   eeee    2017-09-05 08:06:00.000
            6   fffffff 2017-09-06 02:23:00.000
            7   gggg    2017-09-07 09:01:00.000
            8   hhhh    2017-09-08 09:01:00.000
            9   iiiiiiiii   2017-09-09 09:01:00.000
    ```
    
2. Создайте контрольную таблицу в SQL Server или SQL Azure, чтобы сохранить значение верхнего предела для разностной загрузки данных. В приведенном ниже примере вы можете увидеть, что имя контрольной таблицы — *watermarktable*. Имя столбца для хранения значения верхнего предела — *WatermarkValue*, а его тип — *datetime*.

    ```sql
            create table watermarktable
            (
            WatermarkValue datetime,
            );
            INSERT INTO watermarktable
            VALUES ('1/1/2010 12:00:00 AM')
    ```
    
3. Создайте хранимую процедуру в том же экземпляре SQL Server или SQL Azure, который использовался для создания контрольной таблицы. Хранимая процедура используется для записи нового значения верхнего предела во внешнюю контрольную таблицу для разностной загрузки данных в следующий раз.

    ```sql
            CREATE PROCEDURE update_watermark @LastModifiedtime datetime
            AS

            BEGIN

                UPDATE watermarktable
                SET [WatermarkValue] = @LastModifiedtime 

            END
    ```
    
4. Перейдите к шаблону **разностного копирования из базы данных** и создайте **новое подключение** к базе данных-источнику, из которой копируются данные.

    ![Создание подключения к исходной таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable4.png)

5. Создайте **подключение** к целевому хранилищу данных, в которое будут копироваться данные.

    ![Создание подключения к целевой таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable5.png)

6. Создайте **подключение** ко внешней контрольной таблице и хранимой процедуре.  Это подключение к базе данных, где вы создали контрольную таблицу и хранимую процедуру на шаге 2 и 3.

    ![Создание подключения к хранилищу данных контрольной таблицы](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable6.png)

7. Щелкните **Использовать этот шаблон**.

     ![Использовать этот шаблон](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable7.png)
    
8. На панели откроется доступный конвейер, как показано в следующем примере:

     ![Просмотр конвейера](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable8.png)

9. Щелкните действие "Хранимая процедура", выберите **Имя хранимой процедуры**, щелкните **Параметр импорта** и выберите **Добавить динамическое содержимое**.  

     ![Настройка действия хранимой процедуры](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable9.png) 

10. Введите **@{activity('LookupCurrentWaterMark').output.firstRow.NewWatermarkValue}** и нажмите кнопку **Готово**.  

     ![Запись содержимого для параметра хранимой процедуры](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable10.png)      
     
11. Щелкните **Отладка**, введите параметры, а затем нажмите кнопку **Готово**.

    ![Значок отладки](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable11.png)

12. На панели появятся результаты, как показано в следующем примере:

    ![Просмотр результатов](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable12.png)

13. Вы можете создать новые строки в исходной таблице.  Ниже приведен пример SQL для создания новых строк.

    ```sql
            INSERT INTO data_source_table
            VALUES (10, 'newdata','9/10/2017 2:23:00 AM')

            INSERT INTO data_source_table
            VALUES (11, 'newdata','9/11/2017 9:01:00 AM')
    ```
13. Снова запустите конвейер, щелкнув **Отладка**, введите параметры и нажмите кнопку **Готово**.

    ![Значок отладки](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable11.png)

14. Вы увидите, что в место назначения были скопированы только новые строки.

15. (Необязательно.) При выборе Хранилища данных SQL в качестве целевого хранилища необходимо также установить (ввести) подключение к хранилищу BLOB-объектов Azure (расположение для промежуточного хранения), которое необходимо для использования Polybase с Хранилищем данных SQL.  Убедитесь, что контейнер в хранилище BLOB-объектов уже создан.  
    
    ![Настройка PolyBase](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable15.png)
    
## <a name="next-steps"></a>Дополнительная информация

- [Общие сведения о службе фабрики данных Azure, службе интеграции данных в облаке](introduction.md)