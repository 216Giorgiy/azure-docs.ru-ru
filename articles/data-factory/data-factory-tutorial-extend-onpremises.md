<properties 
	pageTitle="Скопируйте выходные данные из учебника в базу данных локального сервера SQL Server" 
	description="Пошаговое руководство в этом учебнике расширяет учебник по фабрике данных, описывающий копирование данных эффективности кампании в базу данных локального сервера SQL Server."
	services="data-factory" 
	documentationCenter="" 
	authors="spelluru" 
	manager="jhubbard" 
	editor="monicar"/>

<tags 
	ms.service="data-factory" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="06/04/2015" 
	ms.author="spelluru"/>


# Пошаговое руководство: копирование данных эффективности кампании на локальный сервер SQL Server 
В этом пошаговом руководстве вы узнаете, как настроить среду для включения конвейера, работающего с вашими локальными данными.
 
В последнем шаге сценария обработки журнала из первого пошагового руководства был описан рабочий процесс "секционирование -> обогащение -> анализ", где выходные данные эффективности маркетинговой кампании были скопированы в базу данных SQL Azure. Вы также могли переместить эти данные на локальный сервер SQL Server для аналитического анализа внутри вашей организации.
 
Чтобы скопировать данные эффективности маркетинговой кампании из большого двоичного объекта Azure на локальный сервер SQL, необходимо создать дополнительную локальную связанную службу, таблицу и конвейер, используя тот же набор командлетов, представленный в первом пошаговом руководстве.

## Предварительные требования

Перед тем как приступить к пошаговому руководству, описанному в этом разделе, **необходимо** выполнить пошаговое руководство [Учебник. Перемещение и обработка файлов журналов с помощью фабрики данных][datafactorytutorial].

**(Рекомендуется.)** Чтобы выполнить пошаговое руководство по созданию конвейера для перемещения данных из локального сервера SQL Server в хранилище больших двоичных объектов Azure, прочитайте и выполните инструкции, изложенные в статье [Использование конвейера для работы с локальными данными][useonpremisesdatasources].


В этом пошаговом руководстве выполняются следующие действия.

1. [Шаг 1. Создание шлюза управления данными](#OnPremStep1). Шлюз управления данными — это агент клиента, который предоставляет доступ к локальным источникам данных в вашей организации из облака. Шлюз обеспечивает передачу данных между локальным сервером SQL Server и хранилищами данных Azure.	

	Вам необходимо установить по крайней мере один шлюз в корпоративной среде, а также зарегистрировать его в фабрике данных Azure, прежде чем добавлять локальную базу данных SQL Server как связанную службу в фабрику данных Azure.

2. [Шаг 2. Создание связанной службы для локального сервера SQL Server.](#OnPremStep2). На этом шаге вы сначала создадите на локальном компьютере SQL Server базу данных и таблицу, а затем создадите связанную службу **OnPremSqlLinkedService**:
3. [Шаг 3. Создание таблицы и конвейера](#OnPremStep3). На этом шаге вы создадите таблицу **MarketingCampaignEffectivenessOnPremSQLTable** и конвейер **EgressDataToOnPremPipeline**. 

4. [Шаг 4. Мониторинг конвейера и просмотр результата](#OnPremStep4) На этом шаге вы выполните мониторинг конвейеров, таблиц и срезов данных с помощью портала Azure.


## <a name="OnPremStep1"></a> Шаг 1. Создание шлюза управления данными

Шлюз управления данными — это агент клиента, который предоставляет доступ к локальным источникам данных в вашей организации из облака. Шлюз обеспечивает передачу данных между локальным сервером SQL Server и хранилищами данных Azure.
  
Вам необходимо установить по крайней мере один шлюз в корпоративной среде, а также зарегистрировать его в фабрике данных Azure, прежде чем добавлять локальную базу данных SQL Server как связанную службу в фабрику данных Azure.

Если у вас есть шлюз данных, который можно использовать, пропустите этот шаг.

1.	Создайте логический шлюз данных. На **портале предварительной версии Azure** щелкните **Связанные службы** в колонке **ФАБРИКА ДАННЫХ**.
2.	В панели команд щелкните **Добавить (+) шлюз данных**.  
3.	В колонке **Создать шлюз данных** щелкните **СОЗДАТЬ**.
4.	В колонке **Создать** введите **MyGateway** в поле **имя** шлюза данных.
5.	Щелкните **ВЫБРАТЬ РЕГИОН** и, при необходимости, измените регион. 
6.	Нажмите кнопку **ОК** в колонке **Создать**. 
7.	Должна появиться колонка **Настройка**. 
8.	В колонке **Настройка** щелкните **Установить непосредственно на этот компьютер**. Это приведет к скачиванию, установке и настройке шлюза на компьютере и к регистрации шлюза в службе. Если у вас на компьютере уже установлен существующий шлюз, который вы хотите связать с этим логическим шлюзом на портале, используйте ключ в этой колонке для повторной регистрации шлюза с помощью диспетчера конфигураций шлюза управления данными (предварительная версия).

	![Диспетчер конфигурации шлюза управления данными][image-data-factory-datamanagementgateway-configuration-manager]

9. Нажмите кнопку **ОК**, чтобы закрыть колонку **Настройка**, затем снова **ОК**, чтобы закрыть колонку **Создать**. Подождите, пока состояние **MyGateway** в колонке **Связанные службы** не изменится на **ХОРОШО**. Также можно запустить инструмент **Диспетчер конфигураций шлюза управления данными (предварительная версия)**, чтобы подтвердить, что имя шлюза совпадает с именем на портале, а **состояние** — **Зарегистрировано**. Может потребоваться закрыть и снова открыть колонку "Связанные службы", чтобы увидеть последнее состояние. Может пройти несколько минут, пока последнее состояние не обновится на экране.

## <a name="OnPremStep2"></a> Шаг 2. Создание связанной службы для локального сервера SQL Server  


На этом шаге вы сначала создадите на локальном компьютере SQL Server необходимые вам базу данных и таблицу, а затем создадите связанную службу.

### Подготовка локальной базы данных и таблицы

Прежде всего необходимо создать базу данных SQL Server, таблицу, пользовательские типы и хранимые процедуры. Они будут использоваться для перемещения результатов **MarketingCampaignEffectiveness** из большого двоичного объекта Azure в базу данных SQL Server.

1.	В **проводнике Windows** перейдите к вложенной папке **OnPremises** в папке **C:\\ADFWalkthrough** (или в расположении, в которое вы извлекли примеры файлов).
2.	Откройте **prepareOnPremDatabase&Table.ps1** в любом редакторе, замените выделенные данные информацией своего сервера SQL Server и сохраните файл (укажите данные **проверки подлинности SQL**. Для примера в этом учебнике включите проверку подлинности SQL для базы данных. 
			
		$dbServerName = "<servername>"
		$dbUserName = "<username>"
		$dbPassword = "<password>"

3. В **Azure PowerShell** перейдите к папке **C:\\ADFWalkthrough\\OnPremises**.
4.	Запустите **prepareOnPremDatabase&Table.ps1** **(знак & в двойных кавычках или как показано ниже)**.
			
		& '.\prepareOnPremDatabase&Table.ps1'

5. Если сценарий выполнится успешно, вы увидите следующее:
			
		PS E:\ADF\ADFWalkthrough\OnPremises> & '.\prepareOnPremDatabase&Table.ps1'
		6/10/2014 10:12:33 PM Script to create sample on-premises SQL Server Database and Table
		6/10/2014 10:12:33 PM Creating the database [MarketingCampaigns], table and stored procedure on [.]...
		6/10/2014 10:12:33 PM Connecting as user [sa]
		6/10/2014 10:12:33 PM Summary:
		6/10/2014 10:12:33 PM 1. Database 'MarketingCampaigns' created.
		6/10/2014 10:12:33 PM 2. 'MarketingCampaignEffectiveness' table and stored procedure 


### Создание связанной службы

1.	На **портале предварительной версии Azure** щелкните плитку **Автор и развертывание** в колонке **ФАБРИКА ДАННЫХ** для **LogProcessingFactory**.
2.	В **редакторе фабрики данных** щелкните **Создать хранилище данных** и выберите **База данных локального сервера SQL Server**.
3.	В сценарии JSON выполните следующее: 
	1.	Замените **<servername>** на имя сервера, на котором размещены базы данных SQL Server.
	2.	Замените **<databasename>** на **MarketingCampaigns**.
	3.	При использовании **проверки подлинности SQL:**
		1.	Укажите **<username>** и **<password>** в **connectionString**.
		2.	Последние две строки (свойства **username** и **password** JSON следует удалить только в том случае, если используется проверка подлинности Windows). 
		3.	Удалите запятую **(,) **в конце строки **gatewayName**. 
		**При использовании проверки подлинности Windows:** 1. Задайте значение **True** для **встроенной системы безопасности** в **connectionString**. Удалите "**User ID=<username>;Password=<password>;**" из connectionString. 2. В свойстве **username** укажите имя пользователя, который имеет доступ к базе данных. 3. В свойстве **password** укажите пароль для учетной записи пользователя.   
	4. В свойстве gatewayName укажите имя шлюза (**MyGateway**). 		  	 
3.	Щелкните **Развернуть** на панели инструментов для развертывания связанной службы. 

## <a name="OnPremStep3"></a> Шаг 3. Создание таблицы и конвейера.

### Создание локальной логической таблицы

1.	В **редакторе фабрики данных** щелкните на панели инструментов **Создать набор данных** и выберите **Локальный SQL**. 
2. Замените сценарий JSON в правой панели на сценарий JSON из файла **MarketingCampaignEffectivenessOnPremSQLTable.json** папки **C:\\ADFWalkthrough\\OnPremises**.
3. Измените имя связанной службы (свойство **linkedServiceName**) с **OnPremSqlServerLinkedService** на **SqlServerLinkedService**.
4. Щелкните **Развернуть** на панели инструментов для развертывания таблицы. 
	 
#### Создание конвейера для копирования данных из большого двоичного объекта Azure на сервер SQL Server

1.	1. В **редакторе фабрики данных**, щелкните кнопку **Создать конвейер** на панели инструментов. Нажмите **... (многоточие)** на панели инструментов, если кнопка не отображается. Кроме того, можно щелкнуть правой кнопкой мыши **Конвейеры** в древовидном представлении и выбрать **Создать конвейер**.
2. Замените сценарий JSON в правой панели на сценарий JSON из файла **EgressDataToOnPremPipeline.json**, который находится в папке **C:\\ADFWalkthrough\\OnPremises**.
3. Добавьте запятую **(,)** в конце закрывающей квадратной скобки **(])** в JSON и после этой закрывающей квадратной скобки добавьте следующие три строки. 

        "start": "2014-05-01T00:00:00Z",
        "end": "2014-05-05T00:00:00Z",
        "isPaused": false

	Обратите внимание, что время начала (**start**) и окончания (**end**) задано как 1.05.2014 и 5.05.2014, поскольку образец данных в этом пошаговом руководстве получен с 1.05.2014 по 5.05.2014.
 
3. Щелкните **Развернуть** на панели инструментов для создания и развертывания конвейера. Убедитесь, что в заголовке окна редактора отображается сообщение **КОНВЕЙЕР УСПЕШНО СОЗДАН**.
	
## <a name="OnPremStep4"></a> Шаг 4. Мониторинг конвейера и просмотр результата

Теперь можно воспользоваться инструкциями, предоставленными в разделе **Мониторинг конвейеров и срезов данных** [основного учебника][datafactorytutorial] для мониторинга конвейеров и срезов данных новой локальной таблицы ADF.
 
Изменение состояния среза таблицы **MarketingCampaignEffectivenessOnPremSQLTable** на Ready означает, что конвейер закончил выполнение среза. Чтобы просмотреть результаты, запросите таблицу **MarketingCampaignEffectiveness** в базе данных **MarketingCampaigns** на сервере SQL Server.
 
Поздравляем! Вы успешно прошли пошаговое руководство по использованию локального источника данных.
 

[monitor-manage-using-powershell]: data-factory-monitor-manage-using-powershell.md
[use-custom-activities]: data-factory-use-custom-activities.md
[troubleshoot]: data-factory-troubleshoot.md
[cmdlet-reference]: http://go.microsoft.com/fwlink/?LinkId=517456

[datafactorytutorial]: data-factory-tutorial.md
[adfgetstarted]: data-factory-get-started.md
[adfintroduction]: data-factory-introduction.md
[useonpremisesdatasources]: data-factory-use-onpremises-datasources.md
[usepigandhive]: data-factory-pig-hive-activities.md

[azure-preview-portal]: http://portal.azure.com
[azure-purchase-options]: http://azure.microsoft.com/pricing/purchase-options/
[azure-member-offers]: http://azure.microsoft.com/pricing/member-offers/
[azure-free-trial]: http://azure.microsoft.com/pricing/free-trial/

[sqlcmd-install]: http://www.microsoft.com/download/details.aspx?id=35580
[azure-sql-firewall]: http://msdn.microsoft.com/library/azure/jj553530.aspx

[download-azure-powershell]: http://azure.microsoft.com/documentation/articles/install-configure-powershell
[adfwalkthrough-download]: http://go.microsoft.com/fwlink/?LinkId=517495
[developer-reference]: http://go.microsoft.com/fwlink/?LinkId=516908

[image-data-factory-datamanagementgateway-configuration-manager]: ./media/data-factory-tutorial-extend-onpremises/DataManagementGatewayConfigurationManager.png

 

<!---HONumber=July15_HO3-->