---
title: "Отработка отказа между регионами в Azure DocumentDB | Документация Майкрософт"
description: "Сведения о том, как работает ручной и автоматический переход на другой ресурс в Azure DocumentDB."
services: documentdb
documentationcenter: 
author: arramac
manager: jhubbard
editor: 
ms.assetid: 446e2580-ff49-4485-8e53-ae34e08d997f
ms.service: documentdb
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/09/2017
ms.author: arramac
translationtype: Human Translation
ms.sourcegitcommit: 0921464c10d5ca3d426a535d434eab6cf02013e6
ms.openlocfilehash: c234958f5fc1ba0dbcb727e18e733d13ad0c7e71


---
# <a name="regional-failovers-in-azure-documentdb"></a>Отработка отказа между регионами в Azure DocumentDB
Azure DocumentDB упрощает глобальное распространение данных, предлагая полностью управляемые учетные [записи базы данных в нескольких регионах](documentdb-distribute-data-globally.md), которые обеспечивают четкие компромиссы между согласованностью, доступностью и производительностью с соответствующими гарантиями. Учетные записи DocumentDB обеспечивают высокий уровень доступности, задержки в единицы миллисекунд, [четко определенные уровни согласованности](documentdb-consistency-levels.md), прозрачную региональную отработку отказа с API многосетевого подключения, а также возможность эластично масштабировать пропускную способность и хранилище по всему миру. 

Azure DocumentDB поддерживает явную отработку отказа и отработку отказа на основе политик, что позволяет управлять поведением комплексной системы в случае сбоев. В этой статье мы рассмотрим следующие вопросы:

* как работает ручная отработка отказа в DocumentDB;
* как работает автоматическая отработка отказа в DocumentDB;
* как использовать ручную отработку отказа в архитектурах приложений.

Узнайте больше об отработке отказа между регионами в этом видео из цикла "Пятница с Azure" от Скотта Хенсельмана (Scott Hanselman) и главного технического руководителя Картика Рамана (Karthik Raman).

>[!ВИДЕО https://channel9.msdn.com/Shows/Azure-Friday/Planet-Scale-NoSQL-with-DocumentDB/player]  

## <a name="a-idconfiguremultiregionapplicationsaconfiguring-multi-region-applications"></a><a id="ConfigureMultiRegionApplications"></a>Настройка приложений в нескольких регионах
Прежде чем углубляться в режимы отработки отказа, рассмотрим, как настроить приложение, чтобы воспользоваться преимуществами доступности нескольких регионов и меньше зависеть от отработок отказа между регионами.

* Сначала разверните приложение в нескольких регионах.
* Чтобы обеспечить высокоскоростной доступ из каждого региона, где развернуто приложение, настройте соответствующий [список предпочтительных регионов](https://msdn.microsoft.com/library/microsoft.azure.documents.client.connectionpolicy.preferredlocations.aspx#P:Microsoft.Azure.Documents.Client.ConnectionPolicy.PreferredLocations) для каждого региона с помощью одного из поддерживаемых пакетов SDK.

В следующем фрагменте показано, как инициализировать приложение, работающее в нескольких регионах. В используемой учетной записи DocumentDB `contoso.documents.azure.com` настроены два региона: "Западная часть США" и "Северная Европа". 

* Приложение развертывается в западной части США (например, с помощью службы приложений Azure). 
* `West US` настроен как первый предпочтительный регион для операций чтения с низкой задержкой.
* `North Europe` настроен как второй предпочтительный регион (для обеспечения высокой доступности во время региональных сбоев).

В .NET эта конфигурация выглядит, как показано ниже.

    ConnectionPolicy usConnectionPolicy = new ConnectionPolicy 
    { 
        ConnectionMode = ConnectionMode.Direct,
        ConnectionProtocol = Protocol.Tcp
    };

    usConnectionPolicy.PreferredLocations.Add(LocationNames.WestUS);
    usConnectionPolicy.PreferredLocations.Add(LocationNames.NorthEurope);

    DocumentClient usClient = new DocumentClient(
        new Uri("https://contosodb.documents.azure.com"),
        "memf7qfF89n6KL9vcb7rIQl6tfgZsRt5gY5dh3BIjesarJanYIcg2Edn9uPOUIVwgkAugOb2zUdCR2h0PTtMrA==",
        usConnectionPolicy);

Приложение также развертывается в Северной Европе с обратным порядком предпочтительных регионов. То есть Северная Европа указывается первой для операций чтения с низкой задержкой. Затем западная часть США указывается как второй предпочтительный регион для обеспечения высокой доступности во время региональных сбоев.

На следующей схеме архитектуры показано развертывание приложения в нескольких регионах, где DocumentDB и приложение настроены таким образом, чтобы быть доступными в четырех географических регионах Azure.  

![Глобально распределенное развертывание приложений с помощью Azure DocumentDB](./media/documentdb-regional-failovers/app-deployment.png)

Теперь давайте рассмотрим, как служба DocumentDB обрабатывает региональные сбои путем автоматического перехода на другой ресурс. 

## <a name="a-idautomaticfailoversaautomatic-failovers"></a><a id="AutomaticFailovers"></a>Автоматический переход на другой ресурс
В редких случаях регионального сбоя Azure DocumentDB автоматически инициирует переход на другой ресурс для всех учетных записей DocumentDB, находящихся в пострадавшем регионе. 

**Что произойдет, если произойдет сбой региона чтения?**

Учетные записи DocumentDB с регионом чтения, находящимся в одном из пострадавших регионов, автоматически отключаются от своего региона записи и помечаются как отключенные. Пакеты SDK DocumentDB реализуют региональный протокол обнаружения, позволяющий автоматически определять, когда регион доступен, и перенаправлять вызовы чтения к следующему доступному региону в списке предпочтительных регионов. Если ни один из регионов в списке предпочтительных регионов недоступен, вызовы автоматически будут перенаправлены к текущему региону записи. Для обработки отказа между регионами изменения в коде приложения не требуются. Гарантии согласованности продолжают учитываться в DocumentDB в течение всего процесса.

![Сбои региона чтения в Azure DocumentDB](./media/documentdb-regional-failovers/read-region-failures.png)

После восстановления пострадавшего региона служба автоматически восстанавливает все пострадавшие учетные записи DocumentDB в регионе. Учетные записи DocumentDB, имеющие регион чтения в пострадавшем регионе, будут автоматически синхронизированы с текущим регионом записи и вернутся в оперативный режим. Пакеты SDK DocumentDB обнаруживают доступность нового региона и оценивают, будет ли выбран регион в качестве текущего региона чтения на основе списка предпочтительных регионов, настроенного с помощью приложения. Последующие операции чтения перенаправляются в восстановленный регион без каких-либо изменений в коде приложения.

**Что произойдет в случае сбоя региона записи?**

Если пострадавший регион является текущим регионом записи для данной учетной записи Azure DocumentDB, он автоматически помечается как отключенный. Затем альтернативный регион повышается до региона записи каждой учетной записи DocumentDB. Вы можете полностью контролировать порядок выбора регионов для учетных записей DocumentDB на портале Azure или [программно](https://docs.microsoft.com/rest/api/documentdbresourceprovider/databaseaccounts#DatabaseAccounts_FailoverPriorityChange). 

![Приоритеты при отработке отказа для Azure DocumentDB](./media/documentdb-regional-failovers/failover-priorities.png)

Во время автоматической отработки отказа DocumentDB автоматически выбирает следующий регион записи для данной учетной записи Azure DocumentDB на основе указанного порядка приоритета. 

![Сбои региона записи в Azure DocumentDB](./media/documentdb-regional-failovers/write-region-failures.png)

После восстановления пострадавшего региона служба автоматически восстанавливает все пострадавшие учетные записи DocumentDB в регионе. 

* Учетные записи DocumentDB вместе с предыдущим регионом записи, который находился в пострадавшем регионе, даже после восстановления региона остаются в автономном режиме с доступностью для чтения. 
* Можно запросить этот регион для вычисления нереплицированных записей во время сбоя путем сравнения с данными, доступными в текущем регионе записи. В зависимости от потребностей приложения можно выполнить слияние и (или) разрешение конфликтов и записать последний набор изменений обратно в текущий регион записи. 
* После завершения слияния изменений пострадавший регион можно вернуть обратно в оперативный режим, удалив и повторно добавив регион в учетную запись DocumentDB. После того как регион будет добавлен обратно, можно снова настроить его в качестве региона записи путем выполнения ручного перехода на другой ресурс на портале Azure или [программно](https://docs.microsoft.com/rest/api/documentdbresourceprovider/databaseaccounts#DatabaseAccounts_CreateOrUpdate).

## <a name="a-idmanualfailoversamanual-failovers"></a><a id="ManualFailovers"></a>Ручной переход на другой ресурс

Помимо автоматического перехода на другой ресурс текущий регион записи данной учетной записи DocumentDB можно динамически изменять вручную на один из существующих регионов чтения. Ручной переход на другой ресурс можно запустить на портале Azure или [программно](https://docs.microsoft.com/rest/api/documentdbresourceprovider/databaseaccounts#DatabaseAccounts_CreateOrUpdate). 

Ручной переход на другой ресурс обеспечивает **нулевую потерю данных** и **нулевую потерю доступности**, корректно передавая состояние записи из старого региона записи в новый для указанной учетной записи DocumentDB. Аналогично автоматическому переходу на другой ресурс во время ручного перехода пакет SDK Azure DocumentDB автоматически обрабатывает изменения региона записи и гарантирует, что вызовы автоматически перенаправляются в новый регион записи. Для управления переходом на другой ресурс изменения кода или конфигурации приложения не требуются. 

![Ручной переход на другой ресурс в Azure DocumentDB](./media/documentdb-regional-failovers/manual-failovers.png)

Ниже приведены некоторые из распространенных сценариев, где может быть полезен ручной переход на другой ресурс.

**Часовая модель.** Если приложения имеют прогнозируемые шаблоны трафика в разное время суток, можно периодически изменять состояние записи для самого активного географического региона в зависимости от времени суток.

**Служебное обновление.** Определенное глобально распределенное развертывание приложения может включать в себя перенаправление трафика в другой регион через диспетчер трафика во время планового служебного обновления. Для такого развертывания приложений теперь может использоваться ручной переход на другой ресурс, чтобы сохранить состояние записи для региона, где будет активный трафик во время периода служебного обновления.

**Отработки непрерывности бизнес-процессов и аварийного восстановления (BCDR).** Во время разработки и выпуска большинства корпоративных приложений выполняются тесты непрерывности бизнес-процессов. Тестирование BCDR часто является важным шагом для сертифицирования соответствия и гарантирования доступности службы в случае региональных сбоев. Чтобы проверить готовность BCDR приложений, использующих DocumentDB для хранения, можно запустить ручной переход на другой ресурс для своей учетной записи DocumentDB и (или) динамически добавить и удалить регион.

В этой статье мы рассмотрели, как работает ручной и автоматический переход на другой ресурс в Azure DocumentDB и как можно сделать учетные записи DocumentDB и приложения глобально доступными. С помощью поддержки глобальной репликации Azure DocumentDB можно сократить совокупную задержку и обеспечить высокую доступность даже в случае сбоев региона. 

## <a name="a-idnextstepsanext-steps"></a><a id="NextSteps"></a>Дальнейшие действия
* Дополнительные сведения о поддержке [глобального распространения](documentdb-distribute-data-globally.md) в DocumentDB
* Дополнительные сведения о [глобальной согласованности в DocumentDB](documentdb-consistency-levels.md)
* Разработка с использованием нескольких регионов с помощью [пакета SDK Azure DocumentDB](documentdb-developing-with-multiple-regions.md)
* Сведения о разработке [архитектуры записи в нескольких регионах](documentdb-multi-region-writers.md) с помощью Azure DocumentDB




<!--HONumber=Feb17_HO2-->


