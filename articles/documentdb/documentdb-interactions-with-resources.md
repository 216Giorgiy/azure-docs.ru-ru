<properties 
	pageTitle="Взаимодействия с ресурсами DocumentDB с поддержкой REST | Azure" 
	description="Сведения о выполнении взаимодействий с ресурсами Microsoft Azure DocumentDB с поддержкой REST с использованием глаголов HTTP." 
	services="documentdb" 
	authors="h0n" 
	manager="jhubbard" 
	editor="monicar" 
	documentationCenter=""/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/08/2015" 
	ms.author="h0n"/>

# REST-взаимодействия с ресурсами DocumentDB 

DocumentDB поддерживает использование методов HTTP для создания, чтения, замены, получения и удаления ресурсов DocumentDB.

Прочитав данную статью, вы сможете ответить на следующие вопросы.

- Как работают стандартные методы HTTP с ресурсами DocumentDB?
- Как создавать новый ресурс с помощью метода POST?
- Как зарегистрировать новую хранимую процедуру с помощью метода POST?
- Как DocumentDB поддерживает управление параллелизмом?
- Какие имеются параметры подключения для протоколов HTTPS и TCP?

## Обзор HTTP-команд
Ресурсы DocumentDB поддерживают следующие команды HTTP с их стандартной интерпретацией.

1.	POST обозначает создание нового элемента ресурса. 
2.	GET обозначает чтение существующего элемента или потока ресурса 
3.	PUT обозначает замену существующего элемента ресурса 
4.	DELETE обозначает удаление существующего элемента ресурса
5.	HEAD означает ответ команды GET без полезной нагрузки (т.е. только заголовки) 

>[AZURE.NOTE]В будущем мы намерены добавить поддержку избирательных обновлений с помощью метода PATCH.

Как показано на диаграмме ниже, метод POST можно вызывать только для потокового ресурса, методы PUT и DELETE можно вызывать только для ресурса с элементами, методы GET и HEAD можно вызывать для ресурсов обоих видов.

![][1]

**Модель взаимодействий с использованием стандартных методов HTTP**

## Создание нового ресурса с помощью метода POST 
Чтобы получить лучшее представление о модели взаимодействия, давайте рассмотрим случай создания нового ресурса (INSERT). Для того чтобы создать требуемый новый ресурс, необходимо выдать запрос HTTP POST с текстом запроса, содержащим представление ресурса относительно URI контейнера, которому принадлежит ресурс. Единственный обязательный признак для запроса — это идентификатор ресурса.

Например, чтобы создать новую базу данных, вы используете метод POST для ресурса базы данных (путем установки свойства идентификатора с уникальным именем) в отношении /dbs. Аналогично, чтобы создать новую коллекцию, вы используете метод POST для коллекции ресурсов в отношении к /dbs/_rid/colls/и т. д. Ответ будет содержать полностью завершенный ресурс со сгенерированными системой свойствами, включая ссылку ресурса _self, с помощью которой вы можете перемещаться к другим ресурсам. В качестве примера простой модели взаимодействия, основанной на HTTP, клиент может оформить HTTP-запрос, чтобы создать новую базу данных в учетной записи. 

	POST https://fabrikam.documents.azure.com/dbs
	{
	      "id":"MyDb"
	}

Служба DocumentDB ответит об успешном завершении операции и передаст код состояния, указывающий на успешное создание базы данных.

	HTTP/1.1 201 Created
	Content-Type: application/json
	x-ms-request-charge: 4.95
	...

	{
	      "id": "MyDb",
	      "_rid": "UoEi5w==",
	      "_self": "dbs/UoEi5w==/",
	      "_ts": 1407370063,
	      "_etag": "00000100-0000-0000-0000-54b636600000",
	      "_colls": "colls/",
	      "_users": "users/"
	}
  
## Регистрация хранимой процедуры с помощью метода POST
В качестве другого примера создания и выполнения ресурса рассмотрим простую хранимую процедуру "HelloWorld", написанную полностью на JavaScript.

 	function HelloWorld() {
 	var context = getContext();
 	var response = context.getResponse();
 	
        response.setBody("Hello, World");
     }

Хранимая процедура может быть зарегистрирована в коллекции под MyDB путем выдачи команды POST с параметрами /dbs/_rid-db/colls/_rid-coll/sprocs.

	POST https://fabrikam.documents.azure.com/dbs/UoEi5w==/colls/UoEi5w+upwA=/sprocs HTTP/1.1
	
	{
	  "id": "HelloWorld",
	  "body": "function HelloWorld() {
	           var context = getContext();
 	           var response = context.getResponse();
 	           
 	           response.setBody("Hello, World");
        	   }"
	}
Служба DocumentDB ответит об успешном завершении операции и передаст код состояния, указывающий на успешную регистрацию хранимой процедуры.

	HTTP/1.1 201 Created
	Content-Type: application/json
	x-ms-request-charge: 4.95
	...

	{
	       "body": "function HelloWorld() {
	           var context = getContext();
 	           var response = context.getResponse();
 	           
 	           response.setBody("Hello, World");
        	   }",
	      "id": "HelloWorld"
	      "_rid": "UoEi5w+upwABAAAAAAAAgA==",
	      "_ts" :  1421227641
	      "_self": "dbs/UoEi5w==/colls/UoEi5w+upwA=/sprocs/UoEi5w+upwABAAAAAAAAgA==/",
	      "_etag": "00002100-0000-0000-0000-50f71fda0000"
	}

## Выполнение хранимой процедуры с помощью метода POST
Наконец, для выполнения хранимой процедуры в приведенном выше примере необходимо сформировать запрос POST в отношении URI ресурса хранимой процедуры (/dbs/UoEi5w==/colls/UoEi5w+upwA=/sprocs/UoEi5w+upwABAAAAAAAAgA==/), как это изображено ниже.

	POST https://fabrikam.documents.azure.com/dbs/UoEi5w==/colls/UoEi5w+upwA=/sprocs/UoEi5w+upwABAAAAAAAAgA== HTTP/1.1
	
Служба DocumentDB отвечает следующим образом.

	HTTP/1.1 200 OK
	
	"Hello World"

Обратите внимание, что команда POST используется для создания нового ресурса, для выполнения хранимой процедуры, а также для выдачи запросов SQL. Чтобы проиллюстрировать выполнение SQL запросов, необходимо учитывать следующее.

	POST https://fabrikam.documents.azure.com/dbs/UoEi5w==/colls/UoEi5w+upwA=/docs HTTP/1.1
	...
	x-ms-documentdb-isquery: True
	x-ms-documentdb-query-enable-scan: True
	Content-Type: application/query+json
	...
	
	{"query":"SELECT f.LastName AS Name, f.Address.City AS City FROM Families f WHERE f.id='AndersenFamily' OR f.Address.City='NY'"}

Ответ службы является результатом выполнения запроса SQL.

	HTTP/1.1 200 Ok
	...
	x-ms-activity-id: 83f9992c-abae-4eb1-b8f0-9f2420c520d2
	x-ms-item-count: 2
	x-ms-session-token: 4
	x-ms-request-charge: 3.1
	Content-Type: application/json1
	...
	{"_rid":"UoEi5w+upwA=","Documents":[{"Name":"Andersen","City":"Seattle"},{"Name":"Wakefield","City":"NY"}],"_count":2}



## Использование команд PUT, GET и DELETE
Замена или чтение группы ресурсов осуществляется соответственно командами PUT (с правильным телом запроса) и GET к ссылке ресурса _self. Кроме того, для удаления ресурса используется команда DELETE к ссылке ресурса _self. Стоит отметить, что иерархическая организация ресурсов в ресурсной модели DocumentDB требует поддержки каскадного удаления, при котором удаление владельца ресурса влечет за собой и удаление самого ресурса. Зависимые ресурсы могут быть распределены по другим узлам, отличающимся от узлов владельца и, таким образом, удаление может произойти независимо. Независимо от механизма сбора мусора, при удалении ресурса, квота мгновенно освобождается и доступна для повторного использования. Следует отметить, что в системе сохраняется ссылочная целостность. Например, вы не можете вставить коллекцию в базу данных, которая уже удалена, а также заменить или запросить несуществующий документ. 
 
Выполнение команды GET над потоком ресурсов или запрос коллекции может привести к возможному результату, включающему миллионы элементов, что делает нецелесообразным как для сервера, чтобы материализовать их, так и для клиента, чтобы использовать их как части единого запроса и ответа или обмена. Для решения этой проблемы, DocumentDB позволяет клиентам разбивать на результаты запросов страницы в реальном времени. Клиенты могут использовать заголовок ответа [x-ms-continuation] в качестве курсора для перехода к следующей странице.

## Оптимистичное управление параллелизмом
Большинство веб-приложений основано на управлении оптимистичным параллелизмом на базе меток, чтобы избежать печально известных ошибок «потерянное обновление» и «потерянное удаление». Метка сущностей соответствует требованиям HTTP, логическая временная метка связывается с ресурсом. DocumentDB изначально поддерживает оптимистическое управление параллелизмом, гарантируя, что каждый ответ HTTP содержит версию (надежно), связанную с конкретным ресурсом. Конфликты управления параллелизмом правильно обнаруживаются в следующих случаях:

1.	Если два клиента одновременно формируют запросы на изменение (с помощью команд PUT/DELETE) ресурса с текущей версией ресурса (указывается в разделе [if-match] заголовка запроса), ядро ​​базы данных DocumentDB передает их управлению транзакционного параллелизма.
2.	Если клиент представляет старую версию ресурса (указывается в разделе [if-match] заголовка запроса), его запрос будет отклонен.  

## Варианты подключений
DocumentDB предлагает модель логической адресации, где каждый ресурс имеет логический и статический идентификатор URI по ссылке _self. В распределенной системе хранения информация распределена по регионам, ресурсы различных учетных записей баз данных в DocumentDB разбиваются по многочисленным серверам и каждый раздел реплицируется для обеспечения высокой доступности. Реплики, управляющие ресурсами данного раздела, регистрируют физические адреса. В то время как физические адреса могут меняться в течение времени по причине сбоев, их логические адреса остаются стабильными и постоянным. Соответствие логического и физического адресов хранится в таблице маршрутизации, которая также внутренне доступна в качестве ресурса. DocumentDB предоставляет два режима подключения: 

1.	**Режим шлюза.** Клиенты не узнают о трансляции логических адресов в физические или деталей маршрутизации; они просто работают с логическими URI и переходят по модели ресурса по принципу RESTful. Клиенты формируют запросы, используя логические URI, а пограничные узлы осуществляют перевод логических URI в физический адрес реплики, которая управляет ресурсом, и пересылают запрос. Маршрутизация запросов чрезвычайно эффективно при использовании кэширования таблицы маршрутизации на пограничных узлах (и периодическом ее обновлении). 
2.	**Прямой режим подключения.** Клиенты непосредственно управляют таблицей маршрутизации в собственном пространстве обработки и периодически обновляют ее. Клиент может сразу подключиться к репликам и обойти пограничные компьютеры.   


<table width="300">
    <tbody>
        <tr>
            <td width="120" valign="top">
                <p>
                    <strong>Режим подключения</strong>
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    <strong>Протокол</strong>
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    <strong>Дополнительные сведения</strong>
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    <strong>Пакеты SDK DocumentDB</strong>
                </p>
            </td>
        </tr>
        <tr>
            <td width="120" valign="top">
                <p>
                    Шлюз
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    HTTPS
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    Приложения непосредственно соединяется с пограничными узлами, используя логические идентификаторы URI. При этом добавляется дополнительный сетевой узел для перехода.
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    REST API, .NET, Node.js, Java, Python, JavaScript
                </p>
            </td>
        </tr>
        <tr>
            <td width="120" valign="top">
                <p>
                    Прямое подключение
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    HTTPS и
                </p>
                <p>
                    TCP
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    Приложения могут получить непосредственный доступ к таблице маршрутизации и выполнить маршрутизацию на стороне клиента для прямого подключения к репликам.
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    .NET
                </p>
            </td>
        </tr>
    </tbody>
</table>

## Дальнейшие действия
Изучите [Справочник по API REST Azure DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx), чтобы узнать больше о работе с ресурсами с использованием интерфейса API REST.

## Ссылки
- [Справочник по API REST Azure использования documentdb по плану](https://msdn.microsoft.com/library/azure/dn781481.aspx) 
- [Запросы DocumentDB](../documentdb-sql-query/)
- [Справочник по языку SQL DocumentDB](https://msdn.microsoft.com/library/azure/dn782250.aspx)
- [Программирование DocumentDB. Хранимые процедуры, триггеры и определяемые пользователем функции](../documentdb-programming/)
- [Справочная документация по DocumentDB](https://msdn.microsoft.com/library/azure/dn781482.aspx)
- REST [http://ru.wikipedia.org/wiki/REST](http://en.wikipedia.org/wiki/Representational_state_transfer)
- Спецификация JSON [http://www.ietf.org/rfc/rfc4627.txt](http://www.ietf.org/rfc/rfc4627.txt)
- Спецификация HTTP [http://www.w3.org/Protocols/rfc2616/rfc2616.html](http://www.w3.org/Protocols/rfc2616/rfc2616.html)
- Теги объекта [http://ru.wikipedia.org/wiki/HTTP_ETag](http://en.wikipedia.org/wiki/HTTP_ETag)


[1]: ./media/documentdb-interactions-with-resources/interactions-with-resources2.png
 

<!---HONumber=July15_HO3-->