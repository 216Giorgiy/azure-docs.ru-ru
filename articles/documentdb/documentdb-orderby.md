<properties 
	pageTitle="Сортировка данных DocumentDB с помощью Order By | Azure" 
	description="Узнайте, как использовать предложение ORDER BY в запросах DocumentDB с LINQ и SQL и как задать политику индексации для запросов ORDER BY." 
	services="documentdb" 
	authors="arramac" 
	manager="jhubbard" 
	editor="cgronlun" 
	documentationCenter=""/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="07/19/2015" 
	ms.author="arramac"/>

# Сортировка данных DocumentDB с помощью Order By
Служба Microsoft Azure DocumentDB поддерживает запросы документов с помощью SQL через документы JSON. Результаты запроса можно упорядочить с помощью предложения ORDER BY в инструкции запроса SQL.

Ознакомившись с данной статьей, вы сможете ответить на следующие вопросы.

- Как реализовать запрос с помощью предложения Order By?
- Как настроить политику индексации для предложения Order By?
- Что дальше?

Вы также найдете [образцы](#samples) и [часто задаваемые вопросы](#faq).

Более подробные сведения о запросах SQL см. в [учебнике по запросам DocumentDB](documentdb-sql-query.md).

## Реализация запроса с помощью предложения Order By
Как и в ANSI-SQL, вы теперь можете включать необязательное предложение Order By в инструкции SQL при запросе DocumentDB. Предложение может включать необязательный аргумент ASC/DESC, указывающий порядок, в котором должны быть получены результаты.

### Упорядочение с помощью SQL
Например, вот запрос для получения книг с сортировкой их заголовков в порядке убывания.

    SELECT * 
    FROM Books 
    ORDER BY Books.Title DESC

### Упорядочение с помощью SQL с фильтрацией
Можно упорядочить результаты с помощью любого вложенного свойства в рамках документов, например Books.ShippingDetails.Weight. Кроме того, можно указать дополнительный фильтр в предложении WHERE в сочетании с предложением Order By, как в этом примере:

    SELECT * 
    FROM Books 
	WHERE Books.SalePrice > 4000
    ORDER BY Books.ShippingDetails.Weight

### Упорядочение с помощью поставщика LINQ для .NET
С помощью пакета SDK для .NET версии 1.2.0 и выше можно использовать предложение OrderBy() или OrderByDescending() в запросах LINQ, как в этом примере:

    foreach (Book book in client.CreateDocumentQuery<Book>(booksCollection.SelfLink)
        .OrderBy(b => b.PublishTimestamp)) 
    {
        // Iterate through books
    }

### Упорядочение по страницам с помощью пакета SDK для .NET
С помощью встроенной поддержки разбиения по страницам пакетов SDK для DocumentDB можно получать по одной странице результатов, как в следующем фрагменте кода .NET. Здесь мы получаем до 10 результатов одновременно с помощью FeedOptions.MaxItemCount и интерфейса IDocumentQuery.

    var booksQuery = client.CreateDocumentQuery<Book>(
        booksCollection.SelfLink,
        "SELECT * FROM Books ORDER BY Books.PublishTimestamp DESC"
        new FeedOptions { MaxItemCount = 10 })
      .AsDocumentQuery();
            
    while (booksQuery.HasMoreResults) 
    {
        foreach(Book book in await booksQuery.ExecuteNextAsync<Book>())
        {
            // Iterate through books
        }
    }

DocumentDB поддерживает сортировку по одиночному числу, строке или логическому свойству для каждого запроса. В ближайшем будущем ожидается поддержка дополнительных типов запросов. Подробнее см. в разделе [Что дальше?](#Whats_coming_next).

## Настройка политики индексации для предложения Order By

Помните, что DocumentDB поддерживает два вида индексов (хэш и диапазон), которые можно задать для конкретных путей/свойств, типов данных (строковых/числовых) и с различной точностью значения (максимальная точность или значение с фиксированной точностью). Поскольку по умолчанию DocumentDB использует хэш-индексацию, то для использования Order By вам необходимо создать новую коллекцию с пользовательской политикой диапазонной индексации на числах, строках или и числах, и строках.

>[AZURE.NOTE]Строковые диапазонные индексы были представлены 7 июля 2015 года вместе с REST API версии 2015-06-03. Чтобы создать политики для Order By к строкам, необходимо использовать пакет .NET SDK версии 1.2.0 либо пакеты Python, Node.js или Java SDK версии 1.1.0.
>
>До REST API версии 2015-06-03 политикой индексации коллекций по умолчанию был хэш для строк и чисел. Она была изменена на хэш-индексацию для строк и диапазонную индексацию для чисел

Подробнее см. в разделе [Политики индексации DocumentDB](documentdb-indexing-policies.md).

### Индексирование в предложении Order By для всех свойств
Далее описывается как можно создать коллекцию с индексацией по "Всему диапазону" в предложении Order By для любых/всех числовых или строковых свойств, отображаемых в документах JSON. Здесь "/\*" представляет собой все свойства и пути JSON в пределах коллекции, а –1 — максимальную точность.
                   
    booksCollection.IndexingPolicy.IncludedPaths.Add(
        new IncludedPath { 
            Path = "/*", 
            Indexes = new Collection<Index> { 
                new RangeIndex(DataType.String) { Precision = -1 }, 
                new RangeIndex(DataType.Number) { Precision = -1 }
            }
        });

    await client.CreateDocumentCollectionAsync(databaseLink, 
        booksCollection);  

>[AZURE.NOTE]Обратите внимание, что предложение Order By будет возвращать только типы данных (строковые и числовые), индексируемые с RangeIndex. Например, если у вас есть политика индексации по умолчанию, имеющая в числах только RangeIndex, предложение Order By по отношению к пути со строковыми значениями не вернет никаких документов.

### Индексирование Order By для одного свойства
Вот как можно создать коллекцию с индексированием предложения Order By только для строкового свойства Title. Существует два пути: один для свойства Title ("/Title/?") с индексацией диапазона, а другой — для всех свойств со схемой индексации по умолчанию, где для строк используется хеш-индексация, а для чисел — диапазонная индексация.
    
    booksCollection.IndexingPolicy.IncludedPaths.Add(
        new IncludedPath { 
            Path = "/Title/?", 
            Indexes = new Collection<Index> { 
                new RangeIndex(DataType.String) { Precision = -1 } } 
            });
    
    // Use defaults which are:
    // (a) for strings, use Hash with precision 3 (just equality queries)
    // (b) for numbers, use Range with max precision (for equality, range and order by queries)
    booksCollection.IndexingPolicy.IncludedPaths.Add(
        new IncludedPath { 
            Path = "/*",
            Indexes = new Collection<Index> { 
                new HashIndex(DataType.String) { Precision = 3 }, 
                new RangeIndex(DataType.Number) { Precision = -1 }
            }            
        });

## Примеры
Обратите внимание на этот [проект образцов Github](https://github.com/Azure/azure-documentdb-net/tree/master/samples/orderby), который показывает, как использовать Order By, включая создание политик индексации и разбиение по страницам с помощью Order By. Образцы содержат открытый исходный код, и мы рекомендуем вам отправлять запросы с материалами, которые могут принести пользу другим разработчикам DocumentDB. Инструкции о том, как принять участие, см. в разделе [Рекомендации по участию](https://github.com/Azure/azure-documentdb-net/blob/master/Contributing.md).

## Что дальше?

Будущие обновления службы будут включать поддержку предложения Order By, представленного здесь. Мы работаем над следующими дополнениями и будем определять приоритет выпуска этих улучшений на основе ваших отзывов.

- Политики динамической индексации: поддержка изменения политики индексации после создания коллекции и на портале Azure
- Поддержка составных индексов для повышения эффективности Order By и Order By с несколькими свойствами.

## Часто задаваемые вопросы

**Какие платформы и версии SDK поддерживают упорядочение?**

Чтобы создать коллекции с политикой индексации, требуемой для предложения Order By, необходимо загрузить последние удаления пакета SDK (1.2.0 для .NET и 1.1.0 для Node.js, JavaScript, Python и Java). Кроме того, чтобы использовать OrderBy() и OrderByDescending() в выражениях LINQ, требуется пакет .NET SDK 1.2.0.


**Какой расход единиц запроса (RU) ожидается для запросов Order By?**

Поскольку предложение Order By использует индекс DocumentDB для уточняющих запросов, количество единиц запроса, используемых запросами Order By, аналогично таковому эквивалентных запросов без Order By. Как и в случае любой другой операции DocumentDB, число единиц запроса зависит от размера и формы документов, а также от сложности запроса.


**Каковы ожидаемые затраты на индексирование для Order By?**

Затраты хранилища индексирования будут пропорциональны количеству свойств. В худшем случае затраты индексирования составят 100 % данных. Нет никакой разницы в затратах по пропускной способности (единицы запроса), между индексированием Range/Order By и индексированием Hash по умолчанию.

**Как запросить существующие данные в DocumentDB с помощью Order By?**

Эта возможность будет поддерживаться за счет доступности улучшения политик динамической индексации, упомянутого в разделе [Что дальше?](what's-coming-next). В настоящее время для этого необходимо экспортировать данные и повторно импортировать их в новую коллекцию DocumentDB, созданную с индексом Range/Order By. Средство импорта DocumentDB можно использовать для переноса данных между коллекциями.

**Каковы текущие ограничения Order By?**

Предложение Order By можно указать только для числовых или строковых свойств при индексированном диапазоне с максимальной точностью (-1).

Невозможно выполнить следующие задачи.
 
- Использовать Order By с внутренними строковыми свойствами, такими как id, _rid и _self (ожидается вскоре). - Использовать Order By со свойствами, полученными в результате объединения внутри документа (ожидается вскоре).
- Использовать Order By с несколькими свойствами (ожидается вскоре).
- Использовать Order By с запросами к базам данных, коллекциям, пользователям, разрешениям или вложениям (ожидается в скором времени).
- Использовать Order By с вычисляемыми свойствами, например, с результатом выражения или с определяемой пользователем или встроенной функцией.

## Дальнейшие действия

Скопируйте [проект образцов Github](https://github.com/Azure/azure-documentdb-net/tree/master/samples/orderby) и запустите упорядочение данных!

## Ссылки
* [Справочник по запросам DocumentDB](documentdb-sql-query.md)
* [Справочник по политике индексации DocumentDB](documentdb-indexing-policies.md)
* [Справочник по языку SQL DocumentDB](https://msdn.microsoft.com/library/azure/dn782250.aspx)
* [Образцы Order By в DocumentDB](https://github.com/Azure/azure-documentdb-net/tree/master/samples/orderby)
 

<!---HONumber=July15_HO5-->