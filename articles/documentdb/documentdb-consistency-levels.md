<properties 
	pageTitle="Уровни согласованности в DocumentDB | Microsoft Azure" 
	description="В DocumentDB есть четыре уровня согласованности с соответствующими уровнями производительности. Это позволяет идти на прогнозируемые компромиссы между окончательной согласованностью, доступностью и задержками." 
	keywords="eventual consistency, documentdb, azure, Microsoft azure"
	services="documentdb" 
	authors="mimig1" 
	manager="jhubbard" 
	editor="cgronlun" 
	documentationCenter=""/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="06/25/2015" 
	ms.author="mimig"/>

# Использование уровней согласованности для обеспечения максимальной доступности и производительности в DocumentDB

Разработчики часто сталкиваются с проблемой, какой из двух противоположных вариантов уровня согласованности выбрать, «строгая» или «в конечном счете». В реальности между этими двумя крайними уровнями существует масса промежуточных уровней согласованности. В большинстве реальных сценариев использования приложения выигрывают от создания точно выверенных компромиссов между согласованностью, доступностью и уровнем задержки. DocumentDB предлагает четыре четко определенных уровня согласованности с соответствующими уровнями производительности. Это позволяет разработчикам приложений сделать предсказуемый компромисс между согласованностью, доступностью и временем ожидания.
 
Все системные ресурсы, включая учетные записи базы данных, базы данных, коллекции, пользователей и разрешения, всегда являются строго согласованными для операция чтения и запросов. Уровни согласованности применяются только к определяемым пользователем ресурсам. Для запросов и операций чтения определенных пользователем ресурсов, в том числе документов, вложений, хранимых процедур, триггеров и пользовательских функций, DocumentDB предлагает четыре различных уровня согласованности:

 - Строгая согласованность
 - Ограниченная согласованность с запаздыванием
 - Согласованность сеанса
 - Окончательная согласованность

Эти детальные, четко определенные уровни согласованности позволяют принимать обоснованные компромиссы между согласованностью, доступностью и задержками. Эти уровни согласованности подкреплены предсказуемыми уровнями производительности, что обеспечивает получение устойчивых результатов для вашего приложения.

## Уровни согласованности для баз данных

Вы можете настроить уровень согласованности по умолчанию для учетной записи базы данных, который будет распространяться на все коллекции (через все базы данных) под вашей учетной записью базы данных. По умолчанию все операции чтения и запросов к определенным пользователем ресурсам будут использовать уровень согласованности по умолчанию, заданный в учетной записи базы данных. Но можно снизить уровень согласованности конкретного запроса (на чтение или запрос), задав заголовок запроса [x-ms-consistency-level]. Есть четыре типа уровней согласованности, поддерживаемых протоколом репликации DocumentDB; они кратко описаны ниже.

>[AZURE.NOTE]В следующих выпусках мы намерены внедрить поддержку переопределения уровня согласованности по умолчанию для каждой коллекции.

**Сильный**: сильный уровень согласованности гарантирует, что операция записи отображается только после ее завершения большинством необходимого набора реплик. Запись либо синхронно завершается первичной и необходимым набором вторичных реплик, либо прерывается. Операция чтения всегда признается большинством необходимого набора чтения, клиент никогда не сможет увидеть незафиксированную или частичную запись и всегда гарантированно получит последние записанные данные.
 
Сильный уровень согласованности обеспечивает абсолютную гарантию согласованности данных, но предлагает самый низкий уровень производительности операций чтения и записи.

**Ограниченная с запаздыванием**: ограниченная согласованность с запаздыванием гарантирует общий порядок распространения операций записи, при чтении возможно возникновение задержек от записи не более чем на К префиксов. Чтение всегда признается большинством необходимого набора реплик. Ответ на запрос чтения определяет ее относительную «свежесть» (в пересчете на К).

Ограниченная согласованность с запаздыванием обеспечивает более предсказуемое поведение согласованности чтения, предлагая самые низкие задержки для записи. Так как операции чтения подтверждаются кворумом большинства, время задержки чтения не самое низкое их тех, что предлагаются системой.

>[AZURE.NOTE]Ограниченная согласованность с запаздыванием гарантирует монотонное чтение только для явных запросов на чтение. Возвращаемый ответ сервера для запросов на запись не гарантирует ограниченную согласованность с запаздыванием.

**Сеансовый**: в отличие от глобальных моделей согласованности, предлагаемых сильной и ограниченной согласованностью, уровень «сеанса» подходит специально для конкретного сеанса клиента. Согласованности на уровне сеанса, как правило, достаточно, так как это обеспечивает гарантированное монотонные операции чтения и записи данных, способность читать собственные записи. Запрос чтения для согласованности на уровне сеанса формируется для реплик, которые могут обслужить запрошенную клиентом версию (является частью файла cookie сеанса).

Сеансовая согласованность предоставляет предсказуемую согласованность чтения данных для сеанса, предлагая самые низкие задержки при записи. Операции чтения также имеют низкое время ожидания, за исключением тех редких случаев, когда они обслуживаются одной репликой.

**В конечном счете**: согласованность «в конечном счете» является самой слабой формой согласованности, когда клиент может получить значения, которые являются более старыми по отношению к полученным ранее, в течение времени. В отсутствие любых последующих операций записи реплики в группе в конечном счете сходятся. Запрос на чтение обрабатывается с помощью любого вторичного индекса.

Согласованность «в конечном счете» оказывается самой слабо связанной согласованностью чтения, но предлагает наименьшую задержку как для чтения, так и для записи.

### Изменение уровня согласованности базы данных

1.  На [портале предварительной версии Azure](https://portal.azure.com/) нажмите кнопку **Просмотреть все**.

2.  В колонке **Просмотреть все** щелкните **Учетные записи DocumentDB**.

3. В колонке **Учетные записи DocumentDB** выберите учетную запись базы данных для изменения.

4. В колонке учетной записи в области **Конфигурация** щелкните плитку **Согласованность по умолчанию**.

5. Выберите новый уровень согласованности и нажмите кнопку **Сохранить**.

	![Снимок экрана, на котором выделены плитка согласованности по умолчанию, параметры согласованности и кнопка «Сохранить»](./media/documentdb-consistency-levels/database-consistency-level.png)

## Уровни согласованности для запросов

По умолчанию для пользовательских ресурсов уровень согласованности для запросов совпадает с уровнем согласованности для операций чтения. По умолчанию индекс обновляется синхронно при каждой операции вставки, замены или удаления документа в коллекции. Это позволяет выполнять запросы с уровнем согласованности, как и в документе. В то время как DocumentDB оптимизирован для операций записи и поддерживает устойчивые объемы записей документов вместе с синхронным обслуживанием индекса и обслуживанием согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления своих ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших объемов данных.

Режим индексирования|	Операции чтения|	Запросы  
-------------|-------|---------
Режим согласованности (по умолчанию)|	Выбор из Strong (сильная), Bounded-Staleness (ограниченное запаздывание), Session (уровень сеанса) и Eventual (согласованное в конечном счете)|	Выбор из Strong (сильная), Bounded-Staleness (ограниченное запаздывание), Session (уровень сеанса) и Eventual (согласованное в конечном счете)|
Отложенная|	Выбор из Strong (сильная), Bounded-Staleness (ограниченное запаздывание), Session (уровень сеанса) и Eventual (согласованное в конечном счете)|	В конечном счете  

Как и для запросов на чтение, можно снизить уровень согласованности конкретного запроса, задав заголовок запроса [x-ms-consistency-level].

## Дальнейшие действия

Если вы хотите получить дополнительные сведения об уровнях согласованности и компромиссах, рекомендуем ознакомиться со следующими ресурсами:

-	Даг Терри. Объяснение согласованности при репликации данных на примере игры в бейсбол (Replicated Data Consistency explained through baseball). [http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf](http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf)
-	Даг Терри. Гарантии на уровне сеанса для репликации слабо согласованных данных. [http://dl.acm.org/citation.cfm?id=383631](http://dl.acm.org/citation.cfm?id=383631)
-	Дэниэл Абади. Компромиссы согласованности в современных распределенных системах проектирования баз данных: распределенных: ограничением является частью статьи: теорема CAP — это только начало...". [http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html](http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html) 
-	Питер Бейлис, Шиварам Венкатараман, Майкл Дж. Франклин, Джозеф М. Хеллерштейн, Ион Стойка (Peter Bailis, Shivaram Venkataraman, Michael J. Franklin, Joseph M. Hellerstein, Ion Stoica). Вероятностное ограниченное запаздывание (PBS) для практических неполных кворумов. (Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums.) [http://vldb.org/pvldb/vol5/p776\_peterbailis\_vldb2012.pdf](http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
-	Вернер Вогелс. Возвращаясь к вопросу о согласованности в конечном счете. (Eventual Consistent - Revisited.). [http://allthingsdistributed.com/2008/12/eventually\_consistent.html](http://allthingsdistributed.com/2008/12/eventually_consistent.html)
 

<!---HONumber=Sept15_HO3-->