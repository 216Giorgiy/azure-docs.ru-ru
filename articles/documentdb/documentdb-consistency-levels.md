<properties
	pageTitle="Уровни согласованности в DocumentDB | Microsoft Azure"
	description="В DocumentDB есть четыре уровня согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном итоге, доступностью и задержками."
	keywords="окончательная согласованность, documentdb, azure, Microsoft azure"
	services="documentdb"
	authors="mimig1"
	manager="jhubbard"
	editor="cgronlun"
	documentationCenter=""/>

<tags
	ms.service="documentdb"
	ms.workload="data-services"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="06/15/2016"
	ms.author="mimig"/>

# Уровни согласованности в DocumentDB

Служба DocumentDB была разработана "с нуля", при этом в ее основу заложены возможности глобального распространения данных. Она предлагает гарантии прогнозируемой низкой задержки, соглашение об уровне обслуживания, обеспечивающее 99,99 % доступности, и нескольких четко определенных моделей нестрогой согласованности. Сейчас DocumentDB поддерживает четыре уровня согласованности: строгий, с ограниченным устареванием, уровня сеанса и согласованность в конечном счете. Помимо **строгой** модели и модели **согласованности в конечном счете**, обычно предусмотренных в других базах данных NoSQL, DocumentDB также предлагает две тщательно кодифицированные и реализованные практически модели согласованности — **ограниченное устаревание** и **уровня сеанса**, эффективность которых была подтверждена реальными случаями использования. Все вместе эти четыре уровня согласованности позволяют принимать обоснованные компромиссы между показателями согласованности, доступности и задержки.

## Область действия согласованности

Степень детализации согласованности ограничивается запросом одного пользователя. Запрос записи может соответствовать транзакции Insert, Replace, Upsert или Delete (с выполнением или без выполнения связанного триггера, активируемого до или после транзакции). Или же запрос записи может соответствовать транзакционному выполнению хранимой процедуры JavaScript, оперирующей с несколькими документами в секции. Как и запись, транзакция чтения или запроса также ограничена одним запросом пользователя. Пользователю может потребоваться разбить на страницы большой результирующий набор, охватывающий нескольких секций, но каждая транзакция чтения ограничена одной страницей и обслуживается в одной секции.

## Уровни согласованности

Вы можете настроить уровень согласованности по умолчанию для учетной записи базы данных, который будет распространяться на все коллекции (через все базы данных) под вашей учетной записью базы данных. По умолчанию все операции чтения и запросов к определенным пользователем ресурсам будут использовать уровень согласованности по умолчанию, заданный в учетной записи базы данных. Тем не менее можно снизить уровень согласованности конкретного запроса (на чтение или операцию), задав заголовок запроса [[x-ms-consistency-level]](https://msdn.microsoft.com/library/azure/mt632096.aspx). Существует четыре типа уровней согласованности, поддерживаемых протоколом репликации DocumentDB, которые обеспечивают четкий компромисс между определенными гарантиями целостности и производительности, как описано ниже.

![DocumentDB предлагает несколько четко определенных моделей согласованности (нестрогой) на ваш выбор.][1]

**Уровень согласованности Strong (сильная)**:

- Строгая согласованность предлагает гарантию [линеаризации](https://aphyr.com/posts/313-strong-consistency-models), обеспечивающую возвращение самой последней версии документа операциями чтения. 
- Сильный уровень согласованности гарантирует, что операция записи отображается только после ее завершения большинством необходимого набора реплик. Операция записи либо синхронно фиксируется первичной репликой и кворумом вторичных реплик, либо прерывается. Операция чтения всегда признается большинством кворума чтения, клиент никогда не сможет увидеть незафиксированную или частичную запись и всегда гарантированно считает последние подтвержденные записанные данные. 
- Учетную запись DocumentDB, настроенную для использования строгой согласованности, нельзя связать более чем с одним регионом Azure. 
- Затраты на операцию чтения (в используемых [единицах запроса](documentdb-request-units.md)) при строгой согласованности выше, чем при согласованности уровня сеанса и согласованности в конечном счете, но не отличаются от затрат при согласованности с ограниченным устареванием.
 

**Ограниченное устаревание**

- Согласованность с ограниченным устареванием гарантирует, что операции чтения могут отставать от записи не более чем на *K* версий или префиксов документа или на интервал времени *t*. 
- Следовательно, при выборе ограниченного устаревания это самое "устаревание" можно настроить двумя способами. 
    - Можно указать количество *K* версий документа, на которое операции чтения могут отставать от операций записи.
    - Можно задать интервал времени *t*. 
- Согласованность с ограниченным устареванием обеспечивает общий глобальный порядок в пределах "окна устаревания". Обратите внимание, что гарантии монотонных операций чтения в регионе существуют как в пределах "окна устаревания", так и вне его. 
- Модель ограниченного устаревания обеспечивает более надежную гарантию согласованности, чем согласованность уровня сеанса и согласованность в конечном счете. Для глобально распределенных приложений мы рекомендуем использовать ограниченное устаревание в ситуациях, где требуется строгая согласованность, но при этом необходима доступность порядка 99,99 % и низкая задержка. 
- С учетными записями DocumentDB, для которых настроена согласованность с ограниченным устареванием, можно связать любое количество регионов Azure. 
- Затраты на операцию чтения (в используемых единицах запроса) при согласованности с ограниченным устареванием выше, чем при согласованности уровня сеанса и согласованности в конечном счете, но не отличаются от затрат при строгой согласованности.

**Уровень согласованности Session (сеанс)**:

- В отличие от глобальных моделей согласованности, предлагаемых уровнями строгой согласованности и согласованности с ограниченным устареванием, согласованность уровня сеанса ограничена сеансом клиента. 
- Согласованность уровня сеанса идеально подходит для всех сценариев, включающих в себя сеанс устройства или пользователя, так как она гарантирует монотонное чтение и монотонную запись, а также гарантирует чтение собственных записей (RYW). 
- Согласованность уровня сеанса обеспечивает предсказуемую согласованность для сеанса и максимальную пропускную способность, предлагая самые низкие задержки при записи и чтении. 
- С учетными записями DocumentDB, для которых настроена согласованность уровня сеанса, можно связать любое количество регионов Azure. 
- Затраты на операцию чтения (в используемых единицах запроса) для модели согласованности уровня сеанса меньше, чем для строгой согласованности или согласованности с ограниченным устареванием, но больше, чем для согласованности в конечном счете.
 

**Уровень согласованности Eventual (в конечном счете)**:

- Согласованность в конечном итоге гарантирует, что в отсутствие каких-либо последующих операций записи реплики в группе в конечном счете сходятся. 
- Согласованность в конечном счете является самой нестрогой формой согласованности, при которой клиент может получить значения, которые являются более старыми по отношению к полученным ранее.
- Согласованность «в конечном счете» оказывается самой слабо связанной согласованностью чтения, но предлагает наименьшую задержку как для чтения, так и для записи.
- С учетными записями DocumentDB, для которых настроена согласованность в конечном счете, можно связать любое количество регионов Azure. 
- Затраты на операцию чтения (в используемых единицах запроса) для уровня согласованности в конечном счете являются самыми низкими среди уровней согласованности DocumentDB.


## Гарантии согласованности

В следующей таблице указаны различные гарантии согласованности, соответствующие четырем уровням согласованности.

| Гарантия | Строгая | Ограниченное запаздывание | Сеанс | В конечном счете |
|----------------------------------------------------------|-------------------------------------------------|------------------------------------------------------------------------------------------------|--------------------------------------------------|--------------------------------------------------|
| **Общий глобальный порядок** | Да | Да, вне "окна устаревания". | Нет, частичный "сеансовый" порядок. | Нет |
| **Гарантируется согласованность префиксов** | Да | Да | Да | Да |
| **Монотонное чтение** | Да | Да, в регионах вне "окна устаревания" и постоянно в регионе. | Да, для заданного сеанса. | Нет |
| **Монотонная запись** | Да | Да | Да | Да |
| **Чтение своих записей** | Да | Да | Да (в регионе записи). | Нет |


## Настройка уровня согласованности по умолчанию

1.  На панели быстрых переходов [портала Azure](https://portal.azure.com/) щелкните **Учетные записи DocumentDB**.

2. В колонке **Учетные записи DocumentDB** выберите учетную запись базы данных для изменения.

3. Если колонка **Все параметры** еще не открыта, в колонке учетной записи щелкните значок **Параметры** на панели команд вверху.

4. В колонке **Все параметры** щелкните запись **Согласованность по умолчанию**, расположенную в разделе **Функция**.

	![Снимок экрана, на котором показан значок "Параметры" и запись "Согласованность по умолчанию"](./media/documentdb-consistency-levels/database-consistency-level-1.png)

5. В колонке **Согласованность по умолчанию** выберите новый уровень согласованности и нажмите кнопку **ОК**.

	![Снимок экрана, на котором показан уровень согласованности и кнопка "ОК"](./media/documentdb-consistency-levels/database-consistency-level-2.png)

## Уровни согласованности для запросов

По умолчанию для определенных пользователем ресурсов уровень согласованности запросов совпадает с уровнем согласованности операций чтения. По умолчанию индекс обновляется синхронно при каждой операции вставки, замены или удаления документа в коллекции. Это позволяет выполнять запросы с уровнем согласованности, как и в документе. В то время как служба DocumentDB оптимизирована для операций записи и поддерживает устойчивые объемы операций записи документов, синхронное обслуживание индекса и обслуживание согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления их ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших объемов данных.

Режим индексирования|	Операции чтения|	Запросы  
-------------|-------|---------
Режим согласованности (по умолчанию)|	Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса и согласованность в конечном счете.|	Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса и согласованность в конечном счете.|
Отложенная|	Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса и согласованность в конечном счете.|	В конечном счете  

Как и для запросов на чтение, можно снизить уровень согласованности конкретного запроса, задав заголовок запроса [x-ms-consistency-level](https://msdn.microsoft.com/library/azure/mt632096.aspx).

## Дальнейшие действия

Если вы хотите получить дополнительные сведения об уровнях согласованности и компромиссах, рекомендуем ознакомиться со следующими ресурсами:

-	Даг Терри. Объяснение согласованности при репликации данных на примере бейсбола (видео). [https://www.youtube.com/watch?v=gluIh8zd26I](https://www.youtube.com/watch?v=gluIh8zd26I)
-	Даг Терри. Объяснение согласованности при репликации данных на примере игры в бейсбол (Replicated Data Consistency explained through baseball). [http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf](http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf)
-	Даг Терри. Гарантии на уровне сеанса для репликации слабо согласованных данных. [http://dl.acm.org/citation.cfm?id=383631](http://dl.acm.org/citation.cfm?id=383631)
-	Дэниэл Абади. Компромиссы согласованности в современных распределенных системах проектирования баз данных: распределенных: ограничением является частью статьи: теорема CAP — это только начало...". [http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html](http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html)
-	Питер Бейлис, Шиварам Венкатараман, Майкл Дж. Франклин, Джозеф М. Хеллерштейн, Ион Стойка (Peter Bailis, Shivaram Venkataraman, Michael J. Franklin, Joseph M. Hellerstein, Ion Stoica). Вероятностное ограниченное запаздывание (PBS) для практических неполных кворумов. (Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums.) [http://vldb.org/pvldb/vol5/p776\_peterbailis\_vldb2012.pdf](http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
-	Вернер Вогелс. Возвращаясь к вопросу о согласованности в конечном счете. (Eventual Consistent - Revisited.). [http://allthingsdistributed.com/2008/12/eventually\_consistent.html](http://allthingsdistributed.com/2008/12/eventually_consistent.html)


[1]: ./media/documentdb-consistency-levels/consistency-tradeoffs.png

<!---HONumber=AcomDC_0615_2016-->