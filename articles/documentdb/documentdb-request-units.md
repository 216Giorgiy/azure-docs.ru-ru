<properties 
	pageTitle="Единицы запросов в DocumentDB | Microsoft Azure" 
	description="Узнайте о том, как понять факторы, задать количество запросов и оценить количество необходимых единиц запросов в DocumentDB." 
	services="documentdb" 
	authors="stephbaron" 
	manager="jhubbard" 
	editor="mimig" 
	documentationCenter=""/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="03/30/2016" 
	ms.author="stbaro"/>

#Единицы запросов в DocumentDB

В этой статье приведены общие сведения об единицах запросов в [Microsoft Azure DocumentDB](https://azure.microsoft.com/services/documentdb/).

Ознакомившись с данной статьей, вы сможете ответить на следующие вопросы.

-	Что такое единицы запросов и затраты на запросы?
-	Как задать количество единиц запросов для одной коллекции?
-	Как оценить приемлемое количество единиц запросов для моего приложения?
-	Что произойдет, если превысить максимальное количество единиц запросов для одной коллекции?


##Единицы запросов и затраты на запросы
DocumentDB обеспечивает высокую прогнозируемую производительность за счет *резервирования* ресурсов для удовлетворения требований к пропускной способности приложения. Так как нагрузка приложения и шаблоны доступа могут со временем меняться, DocumentDB позволяет легко увеличивать или уменьшать зарезервированную пропускную способность для приложения.

В DocumentDB зарезервированная пропускная способность указывается в обрабатываемых единицах запросов в секунду. Так как пропускная способность зависит от единиц запросов, вы можете *зарезервировать* для приложения гарантированное количество единиц запросов в секунду. Каждая операция в DocumentDB (например создание документа, выполнение запроса, обновление документа) сопровождается потреблением ресурсов ЦП, объема памяти и выполнением операций ввода-вывода. Иными словами, при выполнении каждой операции взимается *плата за запрос*, которая выражается в *единицах запросов*. Зная факторы, которые влияют на затраты единиц запросов, и требования приложения к пропускной способности, вы сможете значительно снизить затраты на работу приложения.

##Указание количества единиц запросов
При создании коллекции DocumentDB нужно указать количество единиц запросов в секунду (ЕЗ), которое вы хотите зарезервировать. После создания коллекции для нее выделяются все зарезервированные единицы запросов. Для каждой коллекции гарантированно выделяется и изолируется определенная пропускная способность.

Обратите внимание, что DocumentDB работает на базе модели резервирования. Иными словами, вы получаете счет за *зарезервированную* пропускную способность для коллекции независимо от фактических показателей *использования*. Так как нагрузка, данные и шаблоны использования приложения меняются, вы можете без труда увеличивать или уменьшать количество зарезервированных единиц запросов с помощью пакетов SDK для DocumentDB или [портала Azure](https://portal.azure.com). Дополнительные сведения об увеличении и уменьшении пропускной способности см. в статье [Уровни производительности в DocumentDB](documentdb-performance-levels.md).

##Рекомендации по оценке необходимого количества единиц запросов
При оценке количества единиц запросов, которое нужно зарезервировать для коллекции DocumentDB, важно учитывать следующие рекомендации:

- **Размер документа**. По мере увеличения размера документа увеличивается и число единиц запросов, расходуемых на чтение или запись данных.
- **Число свойств документа**. Если все свойства индексируются, число единиц запросов, расходуемых на запись документа, увеличивается вместе с увеличением количества свойств.
- **Согласованность данных**. При использовании уровней согласованности данных Strong или Bounded Staleness на чтение документов расходуются дополнительные единицы запросов.
- **Индексируемые свойства**. Свойства, которые индексируются по умолчанию, определяются политикой индексирования для каждой коллекции. Вы можете сократить потребление единиц запросов, ограничив количество индексируемых свойств или включив отложенное индексирование.
- **Индексирование документов**. По умолчанию каждый документ индексируется автоматически. Исключение некоторых документов из этого процесса позволяет сэкономить единицы запросов.
- **Шаблоны запросов**. Сложность запроса влияет на количество потребляемых единиц запросов для операции. Количество предикатов и их характер, проекции, количество определяемых пользователем функций и размер набора исходных данных — все это влияет на плату за операции запроса.
- **Использование скриптов**. Так же как и запросы, хранимые процедуры и триггеры расходуют единицы запросов с учетом сложности выполняемых операций. При разработке приложения проверяйте заголовок со стоимостью в единицах запросов, чтобы лучше понять, как эти ресурсы используются каждой из операций.

##Оценка требований к пропускной способности
Единица запроса — это нормализованная мера стоимости обработки запросов. Одна единица запроса соответствует вычислительной мощности, необходимой для чтения (через ссылку self или идентификатор) документа JSON размером 1 КБ, содержащего 10 уникальных значений свойств (кроме свойств системы). Запрос на создание (вставку), замену или удаление того же документа будет использовать дополнительные вычислительные ресурсы службы и поэтому потребует больше единиц запросов.

> [AZURE.NOTE] Базовый план 1 единицы запроса для документа размером 1 КБ соответствует простой команде GET по ссылке self или идентификатору этого документа.

Каждый ответ от службы DocumentDB включает пользовательский заголовок (x-ms-request-charge), который содержит количество затрачиваемых на данный запрос единиц запросов. Этот заголовок также доступен и в пакетах SDK для DocumentDB. В пакете .NET SDK RequestCharge является свойством объекта ResourceResponse. В обозревателе запросов DocumentDB на портале Azure содержится информация о затратах на выполненные запросы.

![Анализ затрат единиц расходов в обозревателе запросов][1]

Исходя из этого, один из методов оценки необходимого для приложения объема зарезервированной пропускной способности — записать затраты единиц запросов на выполнение стандартных операций для определенного документа, который используется приложением, а затем оценить предполагаемое количество операций в секунду. Не забудьте учесть стандартные запросы и скрипт DocumentDB, а также выполнить их оценку.

>[AZURE.NOTE]Если размеры и количество индексированных свойств типов документов существенно отличаются, запишите затраты единиц запросов в отношении выполняемой операции для каждого *типа* стандартного документа.

Например:

1. Запишите затраты единиц запросов на создание (вставку) стандартного документа. 
2. Запишите затраты единиц запросов на чтение стандартного документа.
3. Запишите затраты единиц запросов на обновление стандартного документа.
3. Запишите затраты единиц запросов на выполнение стандартных, общих запросов документа.
4. Запишите затраты единиц запросов на все настраиваемые скрипты (хранимые процедуры, триггеры, определяемые пользователем функции), которые используются приложением.
5. Рассчитайте необходимое количество единиц запросов для операций, которые вы планируете выполнять каждую секунду.

##Пример оценки количества единиц запросов
Рассмотрим следующий документ размером примерно 1 КБ.

	{
	 "id": "08259",
  	"description": "Cereals ready-to-eat, KELLOGG, KELLOGG'S CRISPIX",
  	"tags": [
    	{
      	"name": "cereals ready-to-eat"
    	},
    	{
      	"name": "kellogg"
    	},
    	{
      	"name": "kellogg's crispix"
    	}
	],
  	"version": 1,
  	"commonName": "Includes USDA Commodity B855",
  	"manufacturerName": "Kellogg, Co.",
  	"isFromSurvey": false,
  	"foodGroup": "Breakfast Cereals",
  	"nutrients": [
    	{
      	"id": "262",
      	"description": "Caffeine",
      	"nutritionValue": 0,
      	"units": "mg"
    	},
    	{
      	"id": "307",
      	"description": "Sodium, Na",
      	"nutritionValue": 611,
      	"units": "mg"
    	},
    	{
      	"id": "309",
      	"description": "Zinc, Zn",
      	"nutritionValue": 5.2,
      	"units": "mg"
    	}
  	],
  	"servings": [
    	{
      	"amount": 1,
      	"description": "cup (1 NLEA serving)",
      	"weightInGrams": 29
    	}
  	]
	}

>[AZURE.NOTE]В DocumentDB документы минифицированы, поэтому их размер в системе немного меньше 1 КБ.


В следующей таблице показаны приблизительные затраты единиц запросов на выполнение стандартных операций в этом документе (при оценке приблизительных затрат на единицы запросов предполагается, что уровень согласованности для учетной записи имеет значение "Сеанс" и что все документы индексируются автоматически):

Операция|Затраты единиц запросов 
---|---
Создание документа|~ 15 ЕЗ 
Чтение документа|~ 1 ЕЗ
Запрос документа по идентификатору|~ 2,5 ЕЗ

Кроме того, эта таблица содержит приблизительные затраты единиц запросов для стандартных запросов, используемых в приложении:

Запрос|Затраты единиц запросов|Количество возвращенных документов
---|---|--- 
Выбор продуктов питания по идентификатору|~ 2,5 ЕЗ|1 
Выбор продуктов питания по производителю|~ 7 ЕЗ|7
Выбор группы продуктов питания и сортировка по весу|~ 70 ЕЗ|100
Выбор десяти первых продуктов питания в группе|~ 10 ЕЗ|10

>[AZURE.NOTE]Затраты единиц запросов зависят от количества возвращенных документов.

На основе этой информации можно оценить количество необходимых единиц запросов для приложения в зависимости от предполагаемого количества операций и запросов в секунду:

Операции и запросы|Предполагаемое количество в секунду|Необходимые единицы запросов 
---|---|--- 
Создание документа|10|150 
Чтение документа|100|100 
Выбор продуктов питания по производителю|25|175 
Выбор продуктов питания по группе|10|700 
Выбор первых десяти продуктов питания|15|Всего 150|155|1275

В этом случае ожидается, что для средней пропускной способности необходимо 1,275 единиц запросов в секунду. Если округлить значение до сотен, получается, что для коллекции этого приложения мы должны подготовить 1300 единиц запросов в секунду.

##Превышение лимита зарезервированной пропускной способности
Обратите внимание, что удельный расход единиц запросов оценивается в расчете на одну секунду. Для приложений, которые превышают подготовленный показатель единиц запросов для коллекции, будет применяться функция регулирования запросов до тех пор, пока их значение не станет ниже зарезервированного уровня. В случае применения этой функции сервер заблаговременно завершит запрос с ошибкой RequestRateTooLarge (код состояния HTTP: 429) и вернет заголовок x-x-ms-retry-after-ms, указывая время (в миллисекундах), спустя которое можно повторно выполнить запрос.

	HTTP Status 429
	Status Line: RequestRateTooLarge
	x-ms-retry-after-ms :100

Если вы используете клиентский пакет SDK для .NET и запросы LINQ, в большинстве случаев вам никогда не придется иметь дело с этим исключением. Текущая версия клиентского пакета SDK для .NET перехватит этот ответ, обработает заголовок "retry-after", указанный сервером, и отправит запрос повторно. Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.

В случае, если к вашей учетной записи имеют доступ несколько клиентов и они выполняют запросы одновременно, процедуры отправки повторного запроса по умолчанию может быть недостаточно, и клиент выдаст для приложения исключение DocumentClientException с кодом состояния 429. В таких случаях рекомендуется обработать алгоритм поведения при отправке повторных запросов и логику для процедуры обработки ошибок приложения или увеличить зарезервированную пропускную способность для коллекции.

##Дальнейшие действия

Дополнительные сведения о резервировании пропускной способности с помощью Azure DocumentDB см. в следующих ресурсах:
 
- [Цены на DocumentDB](https://azure.microsoft.com/pricing/details/documentdb/)
- [Управление емкостью DocumentDB](documentdb-manage.md) 
- [Моделирование данных в DocumentDB](documentdb-modeling-data.md)
- [Уровни производительности в DocumentDB](documentdb-partition-data.md)

Дополнительные сведения о DocumentDB можно найти в [документации](https://azure.microsoft.com/documentation/services/documentdb/) по Azure DocumentDB.

[1]: ./media/documentdb-request-units/queryexplorer.png

<!---HONumber=AcomDC_0330_2016-->