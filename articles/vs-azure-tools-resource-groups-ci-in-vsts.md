<properties
	pageTitle="Непрерывная интеграция в Visual Studio Team Services с использованием проектов группы ресурсов Azure | Microsoft Azure"
	description="Здесь описывается, как настроить непрерывную интеграцию в Visual Studio Team Services с использованием проектов развертывания группы ресурсов Azure в Visual Studio."
	services="visual-studio-online"
	documentationCenter="na"
	authors="tfitzmac"
	manager="timlt"
	editor="" />

 <tags
	ms.service="azure-resource-manager"
	ms.devlang="multiple"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="na"
	ms.date="04/19/2016"
	ms.author="tomfitz" />

# Непрерывная интеграция в Visual Studio Team Services с использованием проектов развертывания группы ресурсов Azure

Чтобы развернуть шаблон Azure, необходимо выполнить задачи на различных этапах: сборка, тестирование, копирование в Azure (также называется "помещением на промежуточное хранение") и развертывание шаблона. В Visual Studio Team Services (VSTS) это можно сделать двумя разными способами. Оба метода обеспечивают одинаковые результаты, поэтому выберите самый оптимальный для своего рабочего процесса.

-	Добавьте один этап в определение сборки, которое запускает сценарий PowerShell, содержащийся в проекте развертывания группы ресурсов Azure (Deploy-AzureResourceGroup.ps1). Этот сценарий копирует артефакты и развертывает шаблон.
-	Добавьте несколько этапов сборки VSTS, на каждом из которых выполняется одна задача этапа.

В этой статье показано, как использовать первый вариант (использование определения сборки для запуска сценария PowerShell). Одно из преимуществ этого варианта заключается в том, что в VSTS используется сценарий, используемый разработчиками в Visual Studio. Эта процедура предполагает, что проект развертывания Visual Studio добавлен в VSTS.

## Копирование артефактов в Azure 

Независимо от сценария при наличии артефактов, требуемых для развертывания шаблона, необходимо предоставить диспетчеру ресурсов Azure доступ к ним. Эти артефакты могут включить такие файлы:

-	вложенные шаблоны;
-	сценарии конфигурации и DSC;
-	двоичные файлы приложения.

### Вложенные шаблоны и сценарии конфигурации
При использовании шаблонов, предоставляемых Visual Studio (или созданных с помощью фрагментов кода Visual Studio), сценарий PowerShell не только размещает артефакты, но и параметризует URI ресурсов для различных развертываний. Затем сценарий копирует артефакты в безопасный контейнер в Azure, создает соответствующий маркер SaS и передает эти сведения развертыванию шаблона. Дополнительные сведения о вложенных шаблонах см. в разделе [Создание шаблона-развертывания](https://msdn.microsoft.com/library/azure/dn790564.aspx).

## Настройка непрерывного развертывания в VSTS

Чтобы вызвать сценарий PowerShell в VSTS, необходимо обновить определение сборки. Вкратце, нужно выполнить следующее:

1.	Изменить определение сборки.
1.	Настроить авторизацию Azure в VSTS.
1.	Добавить этап сборки Azure PowerShell, который ссылается на сценарий PowerShell в проекте развертывания группы ресурсов Azure.
1.	Задать значение параметра *-ArtifactsStagingDirectory* для работы с проектом, созданным в VSTS.

### Подробное пошаговое руководство

Ниже приведены шаги, необходимые для настройки непрерывного развертывания в VSTS.

1.	Измените определение сборки VSTS и добавьте этап сборки Azure PowerShell. В категории **Определения сборок** выберите определение сборки, а затем щелкните ссылку **Изменить**.

    ![][0]

1.	Добавьте новый этап сборки **Azure PowerShell** в определение сборки, а затем нажмите кнопку **Добавить шаг сборки...**.

    ![][1]

1.	Выберите категорию задачи **Развертывание**, а затем выберите задачу **Azure PowerShell** и нажмите кнопку **Добавить** возле нее.

    ![][2]

1.	Выберите этап сборки **Azure PowerShell** и укажите соответствующие значения.

    1.	Если в VSTS уже добавлена конечная точка службы, в раскрывающемся списке **Подписка Azure** выберите подписку, а затем перейдите к следующему разделу.

        Если в VSTS нет конечной точки службы Azure, ее необходимо добавить. В этом подразделе описывается этот процесс. Если учетная запись Azure использует учетную запись Майкрософт (например, Hotmail), необходимо выполнить действия ниже для проверки подлинности субъекта-службы.

    1.	Щелкните ссылку **Управление** возле раскрывающегося списка **Подписка Azure**.

        ![][3]

    1. В раскрывающемся списке **Создать конечную точку службы** выберите пункт **Azure**.

        ![][4]

    1.	В диалоговом окне **Добавление подписки Azure** установите переключатель **Субъект-служба**.

        ![][5]

    1.	В диалоговом окне **Добавление подписки Azure** добавьте сведения о подписке Azure. Потребуется указать следующие элементы:
        -	идентификатор подписки;
        -	Название подписки
        -	идентификатор субъекта-службы;
        -	ключ субъекта-службы;
        -	Идентификатор клиента

    1.	В поле имени **Подписка** укажите выбранное имя. Это значение в дальнейшем будет отображаться в раскрывающемся списке **Подписка Azure** в VSTS.

    1.	Если вы не знаете свой идентификатор подписки Azure, его можно получить, выполнив одну из следующих команд.
        
        Для сценариев Azure PowerShell:

        `Get-AzureRmSubscription`

        Для интерфейса командной строки Azure:

        `azure account show`
    

    1.	Чтобы получить идентификатор субъекта-службы, ключ субъекта-службы и идентификатор клиента, выполните процедуры в статье [Создание приложения Active Directory и субъекта-службы с помощью портала](resource-group-create-service-principal-portal.md) или [Проверка подлинности субъекта-службы в диспетчере ресурсов Azure](resource-group-authenticate-service-principal.md).

    1.	В диалоговом окне **Добавление подписки Azure** добавьте значения идентификатора субъекта-службы, ключа субъекта-службы и идентификатора клиента, а затем нажмите кнопку **ОК**.

        Теперь у вас есть допустимый субъект-служба для выполнения сценария Azure PowerShell.

1.	Измените определение сборки и выберите этап сборки **Azure PowerShell**. В раскрывающемся списке **Подписка Azure** выберите подписку. (Если подписка не отображается, нажмите кнопку **Обновить** возле ссылки **Управление**.)

    ![][8]

1.	Укажите путь к сценарию PowerShell Deploy-AzureResourceGroup.ps1. Для этого возле поля **Путь к сценарию** нажмите кнопку с многоточием (...), перейдите к сценарию PowerShell Deploy-AzureResourceGroup.ps1 в папке проекта **Сценарии**, выберите его и нажмите кнопку **ОК**.

    ![][9]

1. Выбрав сценарий, обновите путь к нему, чтобы он выполнялся из каталога Build.StagingDirectory (тот же каталог, который настроен для *ArtifactsLocation*). Для этого добавьте $(Build.StagingDirectory)/ в начале пути к сценарию.

    ![][10]

1.	В поле **Аргументы сценария** введите приведенные ниже параметры (в одной строке). При выполнении сценария в Visual Studio можно увидеть, как VS использует параметры в окне **Вывод**. С этого можно начать установку значений параметров на этапе сборки.

    | Параметр | Описание|
    |---|---|
    | -ResourceGroupLocation | Значение географического расположения, в котором находится группа ресурсов, например **eastus** или **East US**. (Добавьте одинарные кавычки, если в имени есть пробел.) Дополнительные сведения см. в разделе [Регионы Azure](https://azure.microsoft.com/ru-RU/regions/).| |
    | -ResourceGroupName | Имя группы ресурсов, используемой для этого развертывания.| |
    | -UploadArtifacts | Этот параметр (если он присутствует) указывает, что артефакты следует отправлять в Azure из локальной системы. Этот параметр нужно задать, только если шаблон развертывания требует дополнительных артефактов, которые нужно разместить с помощью сценария PowerShell (например, сценарии настройки или вложенные шаблоны). |
    | -StorageAccountName | Имя учетной записи хранения, используемой для размещения артефактов при этом развертывании. Этот параметр является обязательным только при копировании артефактов в Azure. Эта учетная запись хранения не создается автоматически при развертывании. Ее нужно создать заранее.| |
    | -StorageAccountResourceGroupName | Имя группы ресурсов, связанной с учетной записью хранения. Этот параметр является обязательным только при копировании артефактов в Azure.| |
    | -TemplateFile | Путь к файлу шаблона в проекте развертывания группы ресурсов Azure. Для большей гибкости укажите для этого параметра путь, который соотносится с расположением сценария PowerShell, а не абсолютный путь.|
    | -TemplateParametersFile | Путь к файлу параметров в проекте развертывания группы ресурсов Azure. Для большей гибкости укажите для этого параметра путь, который соотносится с расположением сценария PowerShell, а не абсолютный путь.|
    | -ArtifactStagingDirectory | Этот параметр позволяет сценарию PowerShell определить папку, из которой нужно скопировать двоичные файлы проекта. Это значение переопределяет значение по умолчанию, используемое сценарием PowerShell. Для VSTS задайте значение ArtifactStagingDirectory $(Build.StagingDirectory). |

    Ниже приведен пример аргументов сценария (разрывы строк — для удобства чтения):

    ```	
    -ResourceGroupName 'MyGroup' -ResourceGroupLocation 'eastus' -TemplateFile '..\templates\azuredeploy.json' 
    -TemplateParametersFile '..\templates\azuredeploy.parameters.json' -UploadArtifacts -StorageAccountName 'mystorageacct' 
    –StorageAccountResourceGroupName 'Default-Storage-EastUS' -ArtifactStagingDirectory '$(Build.StagingDirectory)'	
    ```

    После завершения работы поле **Аргументы сценария** должно выглядеть следующим образом:

    ![][11]

1.	Добавив все необходимые элементы на этапе сборки Azure PowerShell, нажмите кнопку **Очередь**, чтобы создать проект. На экране **Сборка** отобразится вывод сценария PowerShell.

## Дальнейшие действия

Дополнительные сведения о диспетчере ресурсов Azure и группах ресурсов Azure см. в статье [Общие сведения о диспетчере ресурсов Azure](resource-group-overview.md).


[0]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough1.png
[1]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough2.png
[2]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough3.png
[3]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough4.png
[4]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough5.png
[5]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough6.png
[8]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough9.png
[9]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough10.png
[10]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough11b.png
[11]: ./media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough12.png

<!---HONumber=AcomDC_0713_2016-->