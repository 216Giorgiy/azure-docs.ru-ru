---
title: Шифрование дисков Azure для виртуальных машин IaaS под управлением Windows и Linux | Документация Майкрософт
description: В этой статье приведен обзор шифрования дисков Microsoft Azure для виртуальных машин IaaS под управлением Windows и Linux.
services: security
documentationcenter: na
author: DevTiw
manager: avibm
editor: barclayn
ms.assetid: d3fac8bb-4829-405e-8701-fa7229fb1725
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 03/13/2018
ms.author: devtiw
ms.openlocfilehash: 813124ae7c0dd76a27dcbaea6f0d7aa19bc1e49c
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
---
# <a name="azure-disk-encryption-for-windows-and-linux-iaas-vms"></a>Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux
Microsoft Azure обеспечивает конфиденциальность и независимость ваших данных всеми возможными способами. К данным, размещенным в Azure, можно применять целый ряд современных технологий для шифрования данных, контроля ключей шифрования и управления ими, а также контроля и аудита доступа к данным. Благодаря этому клиенты Azure получают гибкость в выборе решения, которое лучше всего соответствует потребностям их компании. В этом документе описывается новое технологическое решение «Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux», которое защитит ваши данные в соответствии с корпоративными критериями безопасности и соответствия. Этот документ содержит подробные инструкции по использованию возможностей дискового шифрования Azure, а также описывает поддерживаемые сценарии и взаимодействие с пользователем.

> [!NOTE]
> Выполнение некоторых приведенных рекомендаций может привести к более интенсивному использованию данных, сети или вычислительных ресурсов, а следовательно к дополнительным затратам на лицензии или подписки.

## <a name="overview"></a>Обзор
Шифрование дисков Azure — это новая функция, которая помогает зашифровать диски виртуальных машин IaaS под управлением Windows и Linux. Шифрование дисков Azure использует стандартные для отрасли функции — [BitLocker](https://technet.microsoft.com/library/cc732774.aspx) в Windows и [DM-Crypt](https://en.wikipedia.org/wiki/Dm-crypt) в Linux, — которые обеспечивают шифрование томов для системных дисков и дисков данных. Шифрование дисков Azure интегрировано в [Azure Key Vault](https://azure.microsoft.com/documentation/services/key-vault/), что позволяет управлять секретами и ключами шифрования дисков в подписке Key Vault и контролировать их. Данное решение обеспечивает шифрование всех неактивных данных на дисках виртуальной машины в службе хранилища Azure.

Теперь **общедоступная версия** шифрования дисков Azure представлена во всех общедоступных регионах Azure и регионах AzureGov для виртуальных машин IaaS с ОС Windows и Linux уровня "Стандартный" или c хранилищем класса "Премиум".

### <a name="encryption-scenarios"></a>Сценарии шифрования
Шифрование дисков Azure поддерживает следующие сценарии взаимодействия с клиентом:

* включение шифрования для новых виртуальных машин IaaS, для создания которых используются предварительно зашифрованные виртуальные жесткие диски и ключи шифрования;
* включение шифрования для новых виртуальных машин IaaS, созданных из поддерживаемых образов коллекции Azure;
* включение шифрования в имеющихся виртуальных машинах IaaS, запущенных в Azure;
* отключение шифрования на виртуальных машинах IaaS под управлением Windows;
* отключение шифрования на дисках данных виртуальных машин IaaS под управлением Linux;
* включение шифрования виртуальных машин с управляемыми дисками;
* обновление параметров шифрования существующей зашифрованной виртуальной машины с хранилищем класса "Премиум" и не из этого класса;
* резервное копирование и восстановление зашифрованных виртуальных машин.

В решениях, которые появляются в Microsoft Azure, реализована поддержка следующих возможностей для виртуальных машин IaaS:

* интеграция с хранилищем ключей Azure;
* виртуальные машины IaaS серий [A, D, DS, G, GS, F и т. д.](https://azure.microsoft.com/pricing/details/virtual-machines/) уровня "Стандартный";
* включение шифрования для новых виртуальных машин IaaS под управлением Windows и Linux и управляемых дисков виртуальных машин, созданных из поддерживаемых образов коллекции Azure;
* отключение шифрования на дисках данных и в операционной системе виртуальных машин IaaS с ОС Windows и виртуальных машин с управляемыми дисками;
* отключение шифрования на дисках данных виртуальных машин IaaS с ОС Windows и виртуальных машин с управляемыми дисками;
* включение шифрования на виртуальных машинах IaaS под управлением клиентской ОС Windows;
* включение шифрования для томов с путями подключения.
* включение шифрования на виртуальных машинах Linux с чередованием дисков RAID с помощью программы mdadm;
* включение шифрования на виртуальных машинах Linux с использованием диспетчера логических томов для дисков данных;
* включение шифрования на диспетчере логических томов версии 7.3 Linux для ОС и дисков данных; 
* включение шифрования на виртуальных машинах Windows с дисковыми пространствами;
* обновление параметров шифрования существующей зашифрованной виртуальной машины с хранилищем класса "Премиум" и не из этого класса;
* резервное копирование и восстановление зашифрованных виртуальных машин для сценариев с ключом шифрования ключей и без него;
* поддерживаются все общедоступные регионы Azure и регионы AzureGov.

В этом решении не поддерживаются следующие сценарии, функции и технологии:

* виртуальные машины уровня "Базовый";
* отключение шифрования диска ОС виртуальных машин IaaS под управлением Linux;
* отключение шифрования на диске с данными, если диск ОС зашифрован, для виртуальных машин Iaas под управлением Linux;
* виртуальные машины IaaS, созданные с помощью классической модели развертывания;
* включение шифрования для виртуальных машин IaaS под управлением Windows и Linux, созданных из пользовательских образов НЕ поддерживается.
* интеграция с локальной службой управления ключами;
* служба файлов Azure (общая файловая система), NFS, динамические тома, виртуальные машины Windows с программными системами RAID.

### <a name="encryption-features"></a>Функции шифрования
Когда вы включите и развернете шифрование дисков Azure для виртуальных машин IaaS в Azure, в зависимости от конфигурации решения будут доступны следующие возможности:

* шифрование тома операционной системы для защиты загрузочного тома, размещенного в вашем хранилище;
* шифрование томов данных для защиты неактивных томов данных, размещенных в вашем хранилище;
* отключение шифрования дисков данных и дисков ОС виртуальных машин IaaS под управлением Windows;
* отключение шифрования дисков данных виртуальных машин IaaS под управлением Linux (только в тех случаях, когда диск ОС не зашифрован);
* защита ключей шифрования и секретов в вашей подписке хранилища ключей;
* информирование о состоянии шифрования зашифрованных виртуальных машин IaaS;
* удаление настроек шифрования дисков из виртуальной машины IaaS;
* архивация и восстановление зашифрованных виртуальных машин с помощью службы архивации Azure.

Решения для шифрования дисков Azure для виртуальных машин IaaS под управлением Windows и Linux включает в себя следующее:

* расширение для шифрования дисков для Windows;
* расширение для шифрования дисков для Linux;
* командлеты PowerShell для шифрования дисков;
* командлеты интерфейса командной строки Azure (Azure CLI) для шифрования дисков;
* шаблоны Azure Resource Manager для шифрования дисков.

Решение для шифрования дисков Azure поддерживается на виртуальных машинах IaaS под управлением ОС Windows или Linux. Дополнительные сведения о поддерживаемых операционных системах приведены в разделе "Предварительные условия".

> [!NOTE]
> Дополнительная плата за шифрование дисков Azure для виртуальных машин не взимается.

### <a name="value-proposition"></a>Предлагаемые преимущества
Применяя решение для управления шифрованием дисков Azure, можно удовлетворять приведенные ниже потребности организации.

* Неактивные виртуальные машины IaaS в хранилище защищаются с помощью стандартной отраслевой технологии шифрования, которая отвечает корпоративным требованиям безопасности и соответствия.
* Загрузка виртуальных машин IaaS выполняется в соответствии с ключами и политиками, которыми управляет клиент. Можно также проводить аудит их использования в хранилище ключей.

### <a name="encryption-workflow"></a>Рабочий процесс шифрования
Чтобы включить шифрование дисков для виртуальных машин Windows и Linux, выполните следующее.

1. Выберите сценарий шифрования из перечисленных выше.
2. Дайте согласие на включение шифрования дисков с помощью шаблона Resource Manager, командлетов PowerShell или команды интерфейса командной строки для шифрования дисков Azure, а также укажите конфигурацию шифрования.

   * В случае использования зашифрованного клиентом виртуального жесткого диска передайте этот диск в свою учетную запись хранения, а ключевой материал шифрования — в хранилище ключей. Затем укажите конфигурацию шифрования, чтобы включить шифрование для новой виртуальной машины IaaS.
   * Чтобы включить шифрование для виртуальных машин IaaS, создаваемых из образов Marketplace, и для существующих виртуальных машин, которые уже работают в Azure, укажите конфигурацию шифрования.

3. Предоставьте платформе Azure доступ на чтение ключевого материала (ключи шифрования BitLocker для систем Windows или парольная фраза для Linux) из хранилища ключей, чтобы включить шифрование для виртуальной машины IaaS.

4. Укажите идентификатор приложения Azure Active Directory (Azure AD) для записи ключевого материала шифрования в хранилище ключей. Таким образом включается шифрование для виртуальной машины IaaS в сценариях, упомянутых на шаге 2.

5. Azure вносит изменения в модель службы виртуальной машины на основе конфигурации шифрования и хранилища ключей, а затем подготавливает вашу зашифрованную виртуальную машину.

 ![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig1.png)

### <a name="decryption-workflow"></a>Рабочий процесс расшифровки
Далее описаны общие действия, которые нужно выполнить, чтобы отключить шифрование дисков виртуальной машины IaaS.

1. Выберите метод отключения шифрования (расшифровки) для виртуальной машины IaaS, работающей в Azure (при помощи шаблона Resource Manager или командлетов PowerShell для шифрования дисков Azure) и задайте конфигурацию расшифровки.

 На этом этапе для работающей виртуальной машины IaaS под управлением Windows отключается шифрование тома операционной системы и (или) тома данных. Однако, как отмечено в предыдущем разделе, отключение шифрования диска ОС Linux не поддерживается. Расшифровать диски данных можно только на виртуальных машинах Linux и только в тех случаях, когда диск ОС не зашифрован.
2. Azure обновляет модель службы виртуальной машины, и виртуальная машина IaaS помечается как расшифрованная. Неактивное содержимое виртуальной машины больше не шифруется.

> [!NOTE]
> При операции отключения шифрования хранилище ключей и ключевой материал шифрования (ключи шифрования BitLocker для Windows или парольная фраза для Linux) не удаляются.
 > Отключение шифрования диска операционной системы для Linux не поддерживается. Расшифровать можно только диски данных на виртуальных машинах Linux.
Отключение шифрования диска данных для Linux не поддерживается, если диск ОС зашифрован.

## <a name="prerequisites"></a>предварительным требованиям
Ниже перечислены предварительные требования для включения шифрования дисков Azure для виртуальных машин IaaS в Azure в соответствии со сценариями, перечисленными в разделе "Обзор".

* Необходима действующая подписка Azure, которая позволяет создавать ресурсы Azure в поддерживаемых регионах.
* Шифрование дисков Azure доступно для следующих версий Windows Server: Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2 и Windows Server 2016.
* Шифрование дисков Azure поддерживается в следующих версиях клиента Windows: клиент Windows 8 и клиент Windows 10.

> [!NOTE]
> Для Windows Server 2008 R2 перед включением шифрования в Azure требуется установить .NET Framework 4.5. Для этого установите необязательное обновление Microsoft .NET Framework 4.5.2 для Windows Server 2008 R2 для 64-разрядных систем ([KB2901983](https://support.microsoft.com/kb/2901983)) из Центра обновления Windows.

* Шифрование дисков Azure поддерживается только для определенных дистрибутивов и версий серверов Linux из коллекции Azure.  Список поддерживаемых сейчас версий см. в статье [Шифрование дисков Azure: часто задаваемые вопросы](https://docs.microsoft.com/azure/security/azure-security-disk-encryption-faq).

* Для шифрования дисков Azure требуется, чтобы хранилище ключей и виртуальные машины находились в одном регионе и подписке Azure.

> [!NOTE]
> Настройка ресурсов в отдельных регионах приведет к сбою при включении функции шифрования дисков Azure.

* Сведения об установке и настройке хранилища ключей для шифрования дисков Azure см. в подразделе **Установка и настройка хранилища ключей для шифрования дисков Azure** раздела *Предварительные требования* этой статьи.
* Сведения об установке и настройке приложения Azure AD в Azure Active Directory для использования шифрования дисков Azure см. в подразделе **Настройка приложения Azure AD в Azure Active Directory** раздела *Предварительные требования* этой статьи.
* Сведения об установке и настройке политики доступа к хранилищу ключей для приложения Azure AD см. в подразделе **Настройка политики доступа к хранилищу ключей для приложения Azure AD** раздела *Предварительные требования* этой статьи.
* Сведения о подготовке предварительно зашифрованного виртуального жесткого диска Windows см. в разделе **Подготовка предварительно зашифрованного виртуального жесткого диска Windows** в *приложении*.
* Сведения о подготовке предварительно зашифрованного виртуального жесткого диска Linux см. в разделе **Подготовка предварительно зашифрованного виртуального жесткого диска Linux** в *приложении*.
* Платформа Azure должна иметь доступ к ключам шифрования или секретам, расположенным в вашем хранилище ключей, чтобы предоставлять их виртуальной машине при ее загрузке для расшифровки тома операционной системы. Чтобы предоставить разрешения платформе Azure, задайте свойство **EnabledForDiskEncryption** в хранилище ключей. Дополнительные сведения см. в разделе **Установка и настройка хранилища ключей для шифрования дисков Azure** в приложении.
* Для URL-адресов секрета и ключа шифрования ключей (KEK) хранилища ключей необходимо включить управление версиями. Это требование Azure. Ниже приведены примеры действительных URL-адресов секрета и ключа шифрования ключей.

  * Пример допустимого URL-адреса секрета: *https://contosovault.vault.azure.net/secrets/BitLockerEncryptionSecretWithKek/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.
  * Пример допустимого URL-адреса ключа шифрования ключей: *https://contosovault.vault.azure.net/keys/diskencryptionkek/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.

* Шифрование дисков Azure не поддерживает указание номеров портов в URL-адресах секрета и ключа шифрования ключей для хранилища ключей. Ниже приведены примеры недопустимых и допустимых URL-адресов хранилища ключей.

  * Неприемлемый URL-адрес хранилища ключей: *https://contosovault.vault.azure.net:443/secrets/contososecret/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.
  * Приемлемый URL-адрес хранилища ключей: *https://contosovault.vault.azure.net/secrets/contososecret/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.

* Чтобы использовать функцию шифрования дисков Azure, конфигурация конечной точки виртуальной машины IaaS должна соответствовать приведенным ниже требованиям.
  * Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке Azure Active Directory \[login.microsoftonline.com\], чтобы получить маркер для подключения к хранилищу ключей.
  * Для записи ключей шифрования в ваше хранилище ключей виртуальная машина IaaS должна иметь возможность подключиться к конечной точке хранилища ключей.
  * Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке службы хранилища Azure, в которой размещен репозиторий расширений Azure, и к учетной записи хранения Azure, в которой размещены VHD-файлы.

  > [!NOTE]
  > Если ваша политика безопасности ограничивает доступ к Интернету с виртуальных машин Azure, можно разрешить указанный выше универсальный код ресурса (URI) и настроить определенное правило, чтобы разрешить исходящие подключения к данным IP-адресам.
  >
  >Ознакомьтесь со сведениями о настройке Azure Key Vault с защитой брандмауэра и доступе к нему (https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall).

* Для настройки шифрования диска Azure используйте последнюю версию пакета SDK для Azure PowerShell. Скачайте последнюю версию [Azure PowerShell](https://github.com/Azure/azure-powershell/releases).

 > [!NOTE]
  > Шифрование дисков Azure не поддерживается в [пакете SDK для Azure PowerShell версии 1.1.0](https://github.com/Azure/azure-powershell/releases/tag/v1.1.0-January2016). При возникновении ошибок, связанных с использованием Azure PowerShell 1.1.0, ознакомьтесь с записью блога [Azure Disk Encryption Error Related to Azure PowerShell 1.1.0](http://blogs.msdn.com/b/azuresecurity/archive/2016/02/10/azure-disk-encryption-error-related-to-azure-powershell-1-1-0.aspx) (Ошибки шифрования дисков Azure, связанные с Azure PowerShell 1.1.0).

* Чтобы запустить какую-либо команду Azure CLI и связать ее с подпиской Azure, необходимо сначала установить Azure CLI.
  * Чтобы установить Azure CLI и связать его с подпиской Azure, изучите статью [Установка Azure CLI](../cli-install-nodejs.md).
  * Чтобы использовать Azure CLI для Mac, Linux и Windows с Azure Resource Manager, ознакомьтесь с разделом [Команды Azure CLI в режиме Resource Manager](../virtual-machines/azure-cli-arm-commands.md).

* При шифровании управляемого диска до начала этого процесса обязательным предварительным требованием является создание моментального снимка управляемого диска или его резервной копии вне шифрования дисков Azure.  Без резервной копии при любом непредвиденном сбое во время шифрования диски и виртуальная машина могут стать недоступными без варианта восстановления.  Сейчас командлет Set-AzureRmVMDiskEncryptionExtension не архивирует управляемые диски, поэтому если использовать его с этими дисками, командлет не выполнится, пока не будет указан параметр -skipVmBackup.  Этот параметр небезопасно использовать, если резервная копия не сделана вне шифрования дисков Azure.   Если параметр - skipVmBackup указан, командлет не будет создавать резервную копию управляемого диска до шифрования.  Поэтому необходимо обязательно убедиться, что архивация управляемого диска виртуальной машины сделана до включения шифрования дисков Azure, так как она может потребоваться для восстановления.  
> [!NOTE]
 > Параметр -skipVmBackup никогда не должен использоваться, если моментальный снимок или резервная копия не были сделаны вне шифрования дисков Azure. 

* Решение шифрования дисков Azure использует внешний предохранитель ключа BitLocker для виртуальных машин IaaS под управлением Windows. Если виртуальные машины присоединены к домену, не применяйте групповые политики, требующие использования предохранителей TPM. Сведения о групповой политике "Разрешить использование BitLocker без совместимого TPM" см. в [справке по групповым политикам BitLocker](https://technet.microsoft.com/library/ee706521).
* Политика Bitlocker на виртуальных машинах, присоединенных к домену, с пользовательской групповой политикой должна включать следующий параметр: `Configure user storage of bitlocker recovery information -> Allow 256-bit recovery key`. Шифрование дисков Azure завершится с ошибкой, если параметры пользовательской групповой политики для Bitlocker несовместимы. На компьютерах без соответствующего параметра политики может потребоваться применить новую политику, принудительно обновить ее (gpupdate.exe /force) и перезагрузить компьютер.  
* Чтобы создать приложение Azure AD, создать или настроить имеющееся хранилище ключей, а также включить шифрование, требуется сценарий PowerShell для шифрования дисков Azure, который находится [здесь](https://github.com/Azure/azure-powershell/blob/master/src/ResourceManager/Compute/Commands.Compute/Extension/AzureDiskEncryption/Scripts/AzureDiskEncryptionPreRequisiteSetup.ps1).
* Для настройки необходимых компонентов шифрования дисков с помощью Azure CLI ознакомьтесь с [этим сценарием Bash](https://github.com/ejarvi/ade-cli-getting-started).
* Чтобы использовать службу архивации Azure для архивации и восстановления зашифрованных виртуальных машин, использующих шифрование дисков Azure, необходимо шифровать виртуальные машины с помощью конфигурации с ключом шифрования для шифрования дисков Azure. Служба Backup поддерживает только виртуальные машины, зашифрованные с помощью конфигурации с ключом шифрования ключей (KEK) или без него. См. раздел [Архивация и восстановление зашифрованных виртуальных машин с помощью службы архивации Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-encryption).

* Обратите внимание, что сейчас после завершения шифрования тома операционной системы Linux нужно перезагрузить виртуальную машину. Это можно сделать через портал, а также с использованием PowerShell или интерфейса командной строки.   Чтобы отслеживать ход шифрования, периодически подавайте запрос на сообщение о состоянии, возвращаемое методом Get-AzureRmVMDiskEncryptionStatus https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus.  По завершении шифрования эта команда вернет соответствующее сообщение. Например, "Сообщение о ходе выполнения: диск ОС успешно зашифрован, перезапустите виртуальную машину". На этом этапе виртуальную машину можно перезапустить и использовать.  

* До шифрования дисков Azure для Linux необходимо, чтобы диски данных были подключены к файловой системе Linux.

* Рекурсивно подключенные диски данных не поддерживаются при шифровании дисков Azure для Linux. Например, если в целевой системе диск подключен к узлу /foo/bar, а другой к — /foo/bar/baz, шифрование /foo/bar/baz завершится успешно, а /foo/bar завершится ошибкой. 

* Шифрование дисков Azure поддерживается только для образов из коллекции Azure, соответствующих упомянутым выше требованиям. Пользовательские образы не поддерживаются, потому что в этих образах могут использоваться пользовательские схемы секционирования и поведения процессов. Кроме того, даже виртуальные машины, созданные по образу из коллекции, который изначально соответствовал предварительным требованиям, но был изменен во время создания, могут быть несовместимы.  Поэтому процедуру шифрования виртуальной машины Linux предлагается начать с чистого образа коллекции, шифрования виртуальной машины, а затем, при необходимости, добавления на нее пользовательского программного обеспечения или данных.  

* Том локальных данных и шифрование дисков Azure — том Bek для виртуальных машин IaaS Windows и /mnt/azure_bek_disk для виртуальных машин IaaS Linux, который безопасно хранит ключ шифрования. Не удаляйте и не изменяйте содержимое на этом диске. Не отключайте диск, так как ключ шифрования необходим для любой операции шифрования на виртуальной машине IaaS. Файл README тома содержит дополнительные сведения.

#### <a name="set-up-the-azure-ad-application-in-azure-active-directory"></a>Настройка приложения Azure AD в Azure Active Directory
Если шифрование нужно включить для виртуальной машины, работающей в Azure, то служба шифрования дисков Azure создает ключи шифрования и записывает их в ваше хранилище ключей. Для управления ключами шифрования в хранилище ключей требуется аутентификация Azure AD.

Для этой цели создайте приложение Azure AD. Подробные инструкции по регистрации приложения можно найти в разделе "Get an identity for the application" (Получение удостоверения для приложения) записи блога [Azure Key Vault - Step by Step](http://blogs.technet.com/b/kv/archive/2015/06/02/azure-key-vault-step-by-step.aspx) (Пошаговая инструкция для Azure Key Vault). В этой записи вы также найдете несколько полезных примеров подготовки и настройки хранилища ключей. Можно использовать аутентификацию на основе секрета клиента или на основе сертификата клиента в Azure AD.

#### <a name="client-secret-based-authentication-for-azure-ad"></a>Аутентификация в Azure AD на основе секрета клиента
В следующих разделах приведены инструкции по настройке аутентификации в Azure AD на основе секрета клиента.

##### <a name="create-an-azure-ad-application-by-using-azure-powershell"></a>Создание приложения Azure AD с помощью Azure PowerShell
Введите следующий командлет PowerShell, чтобы создать приложение Azure AD.

    $aadClientSecret = "yourSecret"
    $azureAdApplication = New-AzureRmADApplication -DisplayName "<Your Application Display Name>" -HomePage "<https://YourApplicationHomePage>" -IdentifierUris "<https://YouApplicationUri>" -Password $aadClientSecret
    $servicePrincipal = New-AzureRmADServicePrincipal –ApplicationId $azureAdApplication.ApplicationId

> [!NOTE]
> $azureAdApplication.ApplicationId — это идентификатор ClientID Azure AD, а $aadClientSecret — секрет клиента, который потребуется позднее для включения шифрования дисков Azure. Секрет клиента Azure AD следует хранить с соблюдением мер предосторожности.

##### <a name="setting-up-the-azure-ad-client-id-and-secret-from-the-azure-portal"></a>Настройка идентификатора и секрета клиента Azure AD на портале Azure
Можно также настроить идентификатор и секрет клиента Azure AD с помощью портала Azure. Для этого выполните следующее.

1. Последовательно выберите **Все службы > Azure Active Directory**

 ![Дисковое шифрование Azure](./media/azure-security-disk-encryption/aad-service.png)

2. Последовательно выберите **Регистрация приложений > Регистрация нового приложения**

 ![Дисковое шифрование Azure](./media/azure-security-disk-encryption/aad-app-registration.png)

3. Укажите запрашиваемые сведения и создайте приложение:

 ![Дисковое шифрование Azure](./media/azure-security-disk-encryption/aad-create-app.png)

4. Выберите только что созданное приложение, чтобы просмотреть его свойства, включая идентификатор приложения.  Чтобы создать ключ для приложения, последовательно выберите **Параметры > Ключи**, добавьте описание и срок действия ключа, а затем щелкните **Сохранить**

 ![Дисковое шифрование Azure](./media/azure-security-disk-encryption/aad-create-pw.png)

5. Скопируйте созданное значение секрета и сохраните его с соблюдением мер предосторожности.

 ![Дисковое шифрование Azure](./media/azure-security-disk-encryption/aad-save-pw.png)


##### <a name="use-an-existing-application"></a>Использование существующего приложения
Чтобы выполнить приведенные ниже команды, нужно получить и использовать [модуль PowerShell для Azure AD](https://technet.microsoft.com/library/jj151815.aspx).

> [!NOTE]
> Приведенные команды нужно выполнять в новом окне PowerShell. Не вводите эти команды в окне Azure PowerShell или Azure Resource Manager. Мы рекомендуем поступить так, потому что эти командлеты находятся в модуле MSOnline или модуле Azure AD для PowerShell.

    $clientSecret = ‘<yourAadClientSecret>’
    $aadClientID = '<Client ID of your Azure AD application>'
    connect-msolservice
    New-MsolServicePrincipalCredential -AppPrincipalId $aadClientID -Type password -Value $clientSecret

#### <a name="certificate-based-authentication-for-azure-ad"></a>Аутентификация на основе сертификата в Azure AD
> [!NOTE]
> В настоящее время аутентификация на основе сертификата Azure AD на виртуальных машинах Linux не поддерживается.

В следующих разделах приведены инструкции по настройке аутентификации на основе сертификата в Azure AD.

##### <a name="create-an-azure-ad-application"></a>Создание приложения Azure AD
Введите приведенные ниже командлеты PowerShell, чтобы создать приложение Azure AD.

> [!NOTE]
> Замените строку `yourpassword` в приведенном ниже коде своим надежным паролем и обеспечьте сохранность этого пароля.

    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate("C:\certificates\examplecert.pfx", "yourpassword")
    $keyValue = [System.Convert]::ToBase64String($cert.GetRawCertData())
    $azureAdApplication = New-AzureRmADApplication -DisplayName "<Your Application Display Name>" -HomePage "<https://YourApplicationHomePage>" -IdentifierUris "<https://YouApplicationUri>" -KeyValue $keyValue -KeyType AsymmetricX509Cert
    $servicePrincipal = New-AzureRmADServicePrincipal –ApplicationId $azureAdApplication.ApplicationId

Завершив этот шаг, передайте PFX-файл в хранилище ключей и включите политику доступа, которая необходима для развертывания этого сертификата на виртуальной машине.

##### <a name="use-an-existing-azure-ad-application"></a>Использование существующего приложения Azure AD
Если вы настраиваете аутентификацию на основе сертификата для существующего приложения, используйте приведенные ниже командлеты PowerShell. Обязательно выполняйте их в новом окне PowerShell.

    $certLocalPath = 'C:\certs\myaadapp.cer'
    $aadClientID = '<Client ID of your Azure AD application>'
    connect-msolservice
    $cer = New-Object System.Security.Cryptography.X509Certificates.X509Certificate
    $cer.Import($certLocalPath)
    $binCert = $cer.GetRawCertData()
    $credValue = [System.Convert]::ToBase64String($binCert);
    New-MsolServicePrincipalCredential -AppPrincipalId $aadClientID -Type asymmetric -Value $credValue -Usage verify

Завершив этот шаг, передайте PFX-файл в хранилище ключей и включите политику доступа, необходимую для развертывания этого сертификата на виртуальной машине.

##### <a name="upload-a-pfx-file-to-your-key-vault"></a>Передача PFX-файла в хранилище ключей
Подробное описание этого процесса см. в [официальном блоге команды разработчиков Azure Key Vault](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx). Тем не менее, чтобы выполнить эту задачу, вам потребуются только командлеты PowerShell, которые приведены ниже. Обязательно выполняйте их из консоли Azure PowerShell.

> [!NOTE]
> Замените строку `yourpassword` в приведенном ниже коде своим надежным паролем и обеспечьте сохранность этого пароля.

    $certLocalPath = 'C:\certs\myaadapp.pfx'
    $certPassword = "yourpassword"
    $resourceGroupName = ‘yourResourceGroup’
    $keyVaultName = ‘yourKeyVaultName’
    $keyVaultSecretName = ‘yourAadCertSecretName’

    $fileContentBytes = get-content $certLocalPath -Encoding Byte
    $fileContentEncoded = [System.Convert]::ToBase64String($fileContentBytes)

    $jsonObject = @"
    {
    "data": "$filecontentencoded",
    "dataType" :"pfx",
    "password": "$certPassword"
    }
    "@

    $jsonObjectBytes = [System.Text.Encoding]::UTF8.GetBytes($jsonObject)
    $jsonEncoded = [System.Convert]::ToBase64String($jsonObjectBytes)

    Switch-AzureMode -Name AzureResourceManager
    $secret = ConvertTo-SecureString -String $jsonEncoded -AsPlainText -Force
    Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecretName -SecretValue $secret
    Set-AzureRmKeyVaultAccessPolicy -VaultName $keyVaultName -ResourceGroupName $resourceGroupName –EnabledForDeployment

##### <a name="deploy-a-certificate-in-your-key-vault-to-an-existing-vm"></a>Развертывание сертификата из хранилища ключей на существующей виртуальной машине
После передачи PFX-файла разверните сертификат из хранилища ключей на существующей виртуальной машины, выполнив следующие командлеты.
 ```
    $resourceGroupName = ‘yourResourceGroup’
    $keyVaultName = ‘yourKeyVaultName’
    $keyVaultSecretName = ‘yourAadCertSecretName’
    $vmName = ‘yourVMName’
    $certUrl = (Get-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecretName).Id
    $sourceVaultId = (Get-AzureRmKeyVault -VaultName $keyVaultName -ResourceGroupName $resourceGroupName).ResourceId
    $vm = Get-AzureRmVM -ResourceGroupName $resourceGroupName -Name $vmName
    $vm = Add-AzureRmVMSecret -VM $vm -SourceVaultId $sourceVaultId -CertificateStore "My" -CertificateUrl $certUrl
    Update-AzureRmVM -VM $vm  -ResourceGroupName $resourceGroupName
 ```

#### <a name="set-up-the-key-vault-access-policy-for-the-azure-ad-application"></a>Настройка политики доступа к хранилищу ключей для приложения Azure AD
Приложению Azure AD нужны права на доступ к ключам и секретам, которые размещены в хранилище. Используйте командлет [`Set-AzureKeyVaultAccessPolicy`](/powershell/module/azure/set-azurekeyvaultaccesspolicy?view=azuresmps-3.7.0), чтобы предоставить приложению необходимые разрешения. Здесь в качестве значения параметра _–ServicePrincipalName_ следует использовать идентификатор клиента, созданный при регистрации приложения. Чтобы узнать больше, ознакомьтесь с записью блога [Azure Key Vault - Step by Ste](http://blogs.technet.com/b/kv/archive/2015/06/02/azure-key-vault-step-by-step.aspx) (Пошаговая инструкция для Azure Key Vault). Ниже приведен пример выполнения этой задачи с помощью PowerShell.

    $keyVaultName = '<yourKeyVaultName>'
    $aadClientID = '<yourAadAppClientID>'
    $rgname = '<yourResourceGroup>'
    Set-AzureRmKeyVaultAccessPolicy -VaultName $keyVaultName -ServicePrincipalName $aadClientID -PermissionsToKeys 'WrapKey' -PermissionsToSecrets 'Set' -ResourceGroupName $rgname

> [!NOTE]
> Для шифрования дисков Azure требуется настроить в клиентском приложении Azure AD следующие политики доступа: разрешения _WrapKey_ и _Set_.

## <a name="terminology"></a>Терминология
Приведенная ниже таблица терминов позволит вам понять некоторые общие термины, которые применяются в этой технологии.

| Терминология | Определение |
| --- | --- |
| Azure AD | Azure AD — это сокращенное обозначение [Azure Active Directory](https://azure.microsoft.com/documentation/services/active-directory/). Учетная запись Azure AD необходима для аутентификации, хранения секретов в хранилище ключей и извлечения их из него. |
| Хранилище ключей Azure | Key Vault представляет собой службу управления криптографическими ключами. Она основана на аппаратных модулях безопасности, соответствующих Федеральному стандарту обработки информации (FIPS), и позволяет надежно хранить криптографические ключи и конфиденциальные данные. Дополнительные сведения см. в документации по [Key Vault](https://azure.microsoft.com/services/key-vault/). |
| ARM | Диспетчер ресурсов Azure |
| BitLocker |[BitLocker](https://technet.microsoft.com/library/hh831713.aspx) является общепризнанной отраслевой технологией шифрования томов Windows, используемой при шифровании дисков на виртуальных машинах IaaS под управлением Windows. |
| BEK | Ключи шифрования BitLocker (BEK) используются для шифрования загрузочного тома ОС и томов данных. Ключи BitLocker хранятся в хранилище ключей в виде секретов. |
| Интерфейс командной строки | Ознакомьтесь с разделом [Интерфейс командной строки Azure](../cli-install-nodejs.md). |
| DM-Crypt |[DM-Crypt](https://en.wikipedia.org/wiki/Dm-crypt) — прозрачная подсистема шифрования дисков на платформе Linux, используемая для шифрования дисков виртуальных машин IaaS под управлением Linux. |
| KEK | Ключ шифрования ключей представляет собой асимметричный ключ (RSA 2048), который применяется для защиты секрета или помещения его в оболочку. Вы можете использовать защищенный HSM-ключ или ключ с программной защитой. Дополнительные сведения см. в документации по [Azure Key Vault](https://azure.microsoft.com/services/key-vault/). |
| Командлеты PS | Ознакомьтесь с [командлетами Azure PowerShell](/powershell/azure/overview). |

### <a name="set-up-and-configure-your-key-vault-for-azure-disk-encryption"></a>Установка и настройка хранилища ключей для шифрования дисков Azure
Служба шифрование дисков Azure помогает надежно защитить ключи шифрования дисков и секреты в вашем хранилище ключей. Чтобы настроить хранилище ключей для шифрования дисков Azure, выполните действия, описанные в следующих разделах.

#### <a name="create-a-key-vault"></a>Создайте хранилище ключей.
Чтобы создать хранилище ключей, используйте один из следующих вариантов:

* [Шаблон Resource Manager 101-Key-Vault-Create](https://github.com/Azure/azure-quickstart-templates/tree/master/101-key-vault-create)
* [командлеты Azure PowerShell для хранилища ключей](/powershell/module/azurerm.keyvault/#key_vault);
* Диспетчер ресурсов Azure
* [Защита хранилища ключей](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault)

> [!NOTE]
> Если вы уже настроили хранилище ключей для своей подписки, перейдите к следующему разделу.

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig1.png)

#### <a name="set-up-a-key-encryption-key-optional"></a>Настройка ключа шифрования ключей (необязательно)
Если вы хотите использовать ключ шифрования ключей (KEK), чтобы добавить уровень безопасности ключей шифрования BitLocker, поместите ключ шифрования ключей в хранилище ключей. Используйте командлет [`Add-AzureKeyVaultKey`](/powershell/module/azurerm.keyvault/add-azurermkeyvaultkey) для создания ключа шифрования ключей в хранилище ключей. Кроме того, KEK можно импортировать из своего локального модуля HSM службы управления ключами. Дополнительные сведения см. в [документации по Key Vault](https://azure.microsoft.com/documentation/services/key-vault/).

    Add-AzureKeyVaultKey [-VaultName] <string> [-Name] <string> -Destination <string> {HSM | Software}

Можно добавить ключ шифрования ключей, перейдя в Azure Resource Manager либо воспользовавшись интерфейсом хранилища ключей.

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig2.png)

#### <a name="set-key-vault-permissions"></a>Задание разрешений хранилища ключей
Платформа Azure должна иметь доступ к ключам шифрования или секретам, расположенным в вашем хранилище ключей, чтобы предоставлять их виртуальной машине при ее загрузке для расшифровки томов. Чтобы предоставить платформе Azure необходимые разрешения, задайте свойство **enabledForDiskEncryption** для хранилища ключей. Для этого выполните приведенный ниже командлет Azure PowerShell для хранилища ключей.

    Set-AzureRmKeyVaultAccessPolicy -VaultName <yourVaultName> -ResourceGroupName <yourResourceGroup> -EnabledForDiskEncryption

Кроме того, свойство **enabledForDiskEncryption** можно задать с помощью [обозревателя ресурсов Azure](https://resources.azure.com).

Как уже упоминалось, для своего хранилища ключей следует задать свойство **enabledForDiskEncryption**. В противном случае развертывание завершится ошибкой.

Политики доступа для приложения Azure AD можно задать с помощью интерфейса хранилища ключей, как показано ниже.

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig3.png)

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig3b.png)

На вкладке **Политики расширенного доступа** убедитесь, что для вашего хранилища ключей настроено использование шифрования дисков Azure.

![Azure Key Vault](./media/azure-security-disk-encryption/keyvault-portal-fig4.png)

## <a name="disk-encryption-deployment-scenarios-and-user-experiences"></a>Сценарии развертывания шифрования дисков и взаимодействие с пользователем
Возможно несколько сценариев включения шифрования дисков, и последовательность действий для каждого может отличаться. В следующих разделах эти сценарии описаны более подробно.

### <a name="enable-encryption-on-new-iaas-vms-that-are-created-from-the-marketplace"></a>Включение шифрования на новых виртуальных машинах IaaS, созданных с помощью Marketplace
Включить шифрование дисков на новой виртуальной машине IaaS под управлением Windows, созданной из образа Marketplace в Azure, можно с помощью [шаблона Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-create-new-vm-gallery-image).

1. В шаблоне быстрого запуска Azure щелкните **Развертывание в Azure**, введите параметры шифрования в колонке **Параметры** и нажмите кнопку **ОК**.

2. Выберите подписку, группу ресурсов, расположение группы ресурсов, юридические условия и соглашение, а затем нажмите кнопку **Создать**, чтобы включить шифрование для новой виртуальной машины IaaS.

> [!NOTE]
> Этот шаблон создает зашифрованную виртуальную машину Windows на основе образа из коллекции Windows Server 2012.

Шифрование дисков на новой виртуальной машине IaaS под управлением RedHat Linux 7.2 с 200 ГБ массивом RAID-0 можно включить с помощью этого [шаблона Resource Manager](https://aka.ms/fde-rhel). После развертывания шаблона проверьте состояние шифрования виртуальной машины с помощью командлета `Get-AzureRmVmDiskEncryptionStatus`, как описано в разделе [Шифрование диска операционной системы на работающей виртуальной машине Linux](#encrypting-os-drive-on-a-running-linux-vm). Когда виртуальная машина вернется в состояние _VMRestartPending_, перезапустите ее.

В следующей таблице перечислены параметры шаблона Resource Manager для новых виртуальных машин, создаваемых с помощью Marketplace, которые используют идентификатор клиента Azure AD.

| Параметр | ОПИСАНИЕ |
| --- | --- |
| adminUserName | Имя пользователя администратора виртуальной машины. |
| adminPassword | Пароль администратора виртуальной машины. |
| newStorageAccountName | Имя учетной записи хранения, в которой будут размещены виртуальные жесткие диски операционной системы и данных. |
| vmSize | Размер виртуальной машины. Сейчас поддерживаются только серии A, D и G уровня "Стандартный". |
| virtualNetworkName | Имя виртуальной сети, которой будет принадлежать сетевая карта виртуальной машины. |
| subnetName | Имя подсети виртуальной сети, которой будет принадлежать сетевая карта виртуальной машины. |
| AADClientID | Идентификатор клиента приложения Azure AD, которое имеет разрешения на запись секретов в ваше хранилище ключей. |
| AADClientSecret | Секрет клиента приложения Azure AD, которое имеет разрешения на запись секретов в ваше хранилище ключей. |
| keyVaultURL | URL-адрес хранилища ключей, в которое будет передан ключ BitLocker. Его можно получить с помощью командлета `(Get-AzureRmKeyVault -VaultName,-ResourceGroupName ).VaultURI`. |
| keyEncryptionKeyURL | URL-адрес ключа шифрования ключей, который используется для шифрования созданного ключа BitLocker (необязательно). |
| keyVaultResourceGroup | Группа ресурсов хранилища ключей. |
| vmName | Имя виртуальной машины, для которой будет выполняться шифрование. |

> [!NOTE]
> _KeyEncryptionKeyURL_ является необязательным параметром. Вы можете добавить собственный ключ шифрования ключей, чтобы дополнительно защитить ключ шифрования данных (секрет в виде парольной фразы) в своем хранилище ключей.

### <a name="enable-encryption-on-new-iaas-vms-that-are-created-from-customer-encrypted-vhd-and-encryption-keys"></a>Включение шифрования для новых виртуальных машин IaaS, при создании которых используются пользовательские зашифрованные виртуальные жесткие диски и ключи шифрования
В этом сценарии шифрование можно включить с помощью шаблона Resource Manager, командлетов PowerShell или команд интерфейса командной строки. В следующих разделах более подробно описаны шаблон Resource Manager и команды интерфейса командной строки.

Следуйте инструкциям, приведенным в одном из этих разделов, чтобы подготовить предварительно зашифрованные образы, которые можно использовать в Azure. После создания образа выполните действия, описанные в следующем разделе, чтобы создать зашифрованную виртуальную машину Azure.

* [Подготовка предварительно зашифрованного виртуального жесткого диска Windows](#preparing-a-pre-encrypted-windows-vhd)
* [Подготовка предварительно зашифрованного виртуального жесткого диска Linux](#preparing-a-pre-encrypted-linux-vhd)

#### <a name="using-the-resource-manager-template"></a>Использование шаблона Resource Manager
Можно включить шифрование дисков для зашифрованного виртуального жесткого диска с помощью [шаблона Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-create-pre-encrypted-vm).

1. В шаблоне быстрого запуска Azure щелкните **Развертывание в Azure**, введите параметры шифрования в колонке **Параметры** и нажмите кнопку **ОК**.

2. Выберите подписку, группу ресурсов, расположение группы ресурсов, юридические условия и соглашение, а затем нажмите кнопку **Создать**, чтобы включить шифрование на новой виртуальной машине IaaS.

В следующей таблице перечислены параметры шаблона Resource Manager для зашифрованного виртуального жесткого диска.

| Параметр | ОПИСАНИЕ |
| --- | --- |
| newStorageAccountName | Имя учетной записи хранения, в которой будет размещен зашифрованный виртуальный жесткий диск ОС. Эта учетная запись хранения уже должна быть создана в той же группе ресурсов и в том же расположении, что и виртуальная машина. |
| osVhdUri | Универсальный код ресурса (URI) виртуального жесткого диска ОС в учетной записи хранения. |
| osType | Тип продукта ОС (Windows, Linux). |
| virtualNetworkName | Имя виртуальной сети, которой будет принадлежать сетевая карта виртуальной машины. Это имя уже должно быть создано в той же группе ресурсов и в том же расположении, что и виртуальная машина. |
| subnetName | Имя подсети виртуальной сети, которой будет принадлежать сетевая карта виртуальной машины. |
| vmSize | Размер виртуальной машины. Сейчас поддерживаются только серии A, D и G уровня "Стандартный". |
| keyVaultResourceID | Идентификатор ресурса, определяющий ресурс хранилища ключей в Azure Resource Manager. Его можно получить с помощью командлета PowerShell `(Get-AzureRmKeyVault -VaultName &lt;yourKeyVaultName&gt; -ResourceGroupName &lt;yourResourceGroupName&gt;).ResourceId`. |
| keyVaultSecretUrl | URL-адрес ключа шифрования дисков, настроенного в хранилище ключей. |
| keyVaultKekUrl | URL-адрес ключа шифрования ключей, с помощью которого шифруется созданный ключ шифрования дисков. |
| vmName | Имя виртуальной машины IaaS. |

#### <a name="using-powershell-cmdlets"></a>Использование командлетов PowerShell
Можно включить шифрование дисков для зашифрованного виртуального жесткого диска с помощью командлета PowerShell [`Set-AzureRmVMOSDisk`](/powershell/module/azurerm.compute/set-azurermvmosdisk).  

#### <a name="using-cli-commands"></a>Использование команд интерфейса командной строки
Чтобы включить шифрование диска с помощью команд интерфейса командной строки, сделайте следующее.

1. Задайте политики доступа в хранилище ключей.

   * Установите флажок **EnabledForDiskEncryption**.

    `azure keyvault set-policy --vault-name <keyVaultName> --enabled-for-disk-encryption true`
   * Установите для приложения Azure AD разрешения на запись секретов в ваше хранилище ключей.

    `azure keyvault set-policy --vault-name <keyVaultName> --spn <aadClientID> --perms-to-keys '["wrapKey"]' --perms-to-secrets '["set"]'`

2. Чтобы включить шифрование на существующей или запущенной виртуальной машине, введите следующую команду.

 `azure vm enable-disk-encryption --resource-group <resourceGroupName> --name <vmName> --aad-client-id <aadClientId> --aad-client-secret <aadClientSecret> --disk-encryption-key-vault-url <keyVaultURL> --disk-encryption-key-vault-id <keyVaultResourceId> --volume-type [All|OS|Data]`

3. Получите состояние шифрования, введя следующую команду.

 `azure vm show-disk-encryption-status --resource-group <resourceGroupName> --name <vmName> --json`

4. Чтобы включить шифрование на новой виртуальной машине, созданной с использованием вашего зашифрованного виртуального жесткого диска, используйте команду `azure vm create` с приведенными ниже параметрами.

 ```
   * disk-encryption-key-vault-id <disk-encryption-key-vault-id>
   * disk-encryption-key-url <disk-encryption-key-url>
   * key-encryption-key-vault-id <key-encryption-key-vault-id>
   * key-encryption-key-url <key-encryption-key-url>
 ```

### <a name="enable-encryption-on-existing-or-running-iaas-windows-vm-in-azure"></a>Включение шифрования на виртуальной машине IaaS Windows, которая уже существует или работает в Azure
В этом сценарии шифрование можно включить с помощью шаблона Resource Manager, командлетов PowerShell или команд интерфейса командной строки. В следующих разделах более подробно описано, как включить шифрование с помощью шаблона Resource Manager и команды интерфейса командной строки.

#### <a name="using-the-resource-manager-template"></a>Использование шаблона Resource Manager
Включить шифрование дисков на существующих или работающих виртуальных машинах IaaS под управлением Windows в Azure можно с помощью [шаблона Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-running-windows-vm).

1. В шаблоне быстрого запуска Azure щелкните **Развертывание в Azure**, введите параметры шифрования в колонке **Параметры** и нажмите кнопку **ОК**.

2. Выберите подписку, группу ресурсов, расположение группы ресурсов, юридические условия и соглашение, а затем нажмите кнопку **Создать**, чтобы включить шифрование на существующей или работающей виртуальной машине IaaS.

В следующей таблице перечислены параметры шаблона Resource Manager для существующих или работающих виртуальных машин, которые используют идентификатор клиента Azure AD.

| Параметр | ОПИСАНИЕ |
| --- | --- |
| AADClientID | Идентификатор клиента приложения Azure AD, которое имеет разрешения на запись секретов в хранилище ключей. |
| AADClientSecret | Секрет клиента приложения Azure AD, которое имеет разрешения на запись секретов в хранилище ключей. |
| keyVaultName | Имя хранилища ключей, в которое будет передан ключ BitLocker. Его можно получить с помощью командлета `(Get-AzureRmKeyVault -ResourceGroupName <yourResourceGroupName>). Vaultname`. |
|  keyEncryptionKeyURL | URL-адрес ключа шифрования ключей, который используется для шифрования созданного ключа BitLocker. Это необязательный параметр, если выбрать **nokek** из раскрывающегося списка UseExistingKek. Если из раскрывающегося списка UseExistingKek выбрано значение **kek**, то потребуется ввести значение _keyEncryptionKeyURL_. |
| volumeType | Тип тома, для которого будет выполняться шифрование. Допустимые значения: _OS_, _Data_ и _All_. |
| sequenceVersion | Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда шифрование диска выполняется на той же виртуальной машине. |
| vmName | Имя виртуальной машины, для которой будет выполняться шифрование. |

> [!NOTE]
> _KeyEncryptionKeyURL_ является необязательным параметром. Вы можете добавить собственный ключ шифрования ключей, чтобы дополнительно защитить ключ шифрования данных (секрет шифрования BitLocker) в хранилище ключей.

#### <a name="using-powershell-cmdlets"></a>Использование командлетов PowerShell
Сведения о включении шифрования дисков Azure с помощью командлетов PowerShell см. в статьях [Explore Azure Disk Encryption with Azure Powershell](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/17/explore-azure-disk-encryption-with-azure-powershell.aspx) (Изучение возможностей шифрования дисков Azure с помощью PowerShell) и [Explore Azure Disk Encryption with Azure PowerShell – Part 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx) (Изучение возможностей шифрования дисков Azure с помощью PowerShell. Часть 2).

#### <a name="using-cli-commands"></a>Использование команд интерфейса командной строки
Чтобы с помощью команд интерфейса командной строки включить шифрование на виртуальной машине IaaS под управлением Windows, которая уже существует или работает в Azure, сделайте следующее.

1. Вот как можно задать политики доступа в хранилище ключей.
   * Установите флажок **EnabledForDiskEncryption**.

    `azure keyvault set-policy --vault-name <keyVaultName> --enabled-for-disk-encryption true`
   * Установите для приложения Azure AD разрешения на запись секретов в ваше хранилище ключей.

    `azure keyvault set-policy --vault-name <keyVaultName> --spn <aadClientID> --perms-to-keys '["wrapKey"]' --perms-to-secrets '["set"]'`
2. Чтобы включить шифрование на существующей или запущенной виртуальной машине, введите следующую команду.

 `azure vm enable-disk-encryption --resource-group <resourceGroupName> --name <vmName> --aad-client-id <aadClientId> --aad-client-secret <aadClientSecret> --disk-encryption-key-vault-url <keyVaultURL> --disk-encryption-key-vault-id <keyVaultResourceId> --volume-type [All|OS|Data]`
3. Чтобы получить состояние шифрования, введите следующую команду.

 `azure vm show-disk-encryption-status --resource-group <resourceGroupName> --name <vmName> --json`
4. Чтобы включить шифрование на новой виртуальной машине, созданной с использованием вашего зашифрованного виртуального жесткого диска, используйте команду `azure vm create` с приведенными ниже параметрами.

 ```
   * disk-encryption-key-vault-id <disk-encryption-key-vault-id>
   * disk-encryption-key-url <disk-encryption-key-url>
   * key-encryption-key-vault-id <key-encryption-key-vault-id>
   * key-encryption-key-url <key-encryption-key-url>
 ```

### <a name="enable-encryption-on-an-existing-or-running-iaas-linux-vm-in-azure"></a>Включение шифрования на виртуальной машине IaaS под управлением Linux, которая уже существует или работает в Azure
Включить шифрование дисков на существующих или работающих виртуальных машинах IaaS под управлением Linux в Azure можно с помощью [шаблона Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-running-linux-vm).

1. В шаблоне быстрого запуска Azure щелкните **Развертывание в Azure**, введите параметры шифрования в колонке **Параметры** и нажмите кнопку **ОК**.

2. Выберите подписку, группу ресурсов, расположение группы ресурсов, юридические условия и соглашение, а затем нажмите кнопку **Создать**, чтобы включить шифрование на существующей или работающей виртуальной машине IaaS.

В следующей таблице перечислены параметры шаблона Resource Manager для существующих или работающих виртуальных машин, которые используют идентификатор клиента Azure AD.

| Параметр | ОПИСАНИЕ |
| --- | --- |
| AADClientID | Идентификатор клиента приложения Azure AD, которое имеет разрешения на запись секретов в хранилище ключей. |
| AADClientSecret | Секрет клиента приложения Azure AD, которое имеет разрешения на запись секретов в ваше хранилище ключей. |
| keyVaultName | Имя хранилища ключей, в которое будет передан ключ BitLocker. Его можно получить с помощью командлета `(Get-AzureRmKeyVault -ResourceGroupName <yourResourceGroupName>). Vaultname`. |
|  keyEncryptionKeyURL | URL-адрес ключа шифрования ключей, который используется для шифрования созданного ключа BitLocker. Это необязательный параметр, если выбрать **nokek** из раскрывающегося списка UseExistingKek. Если из раскрывающегося списка UseExistingKek выбрано значение **kek**, то потребуется ввести значение _keyEncryptionKeyURL_. |
| volumeType | Тип тома, для которого будет выполняться шифрование. Допустимые поддерживаемые значения — _ОС_ или _Все_ (поддерживаемые дистрибутивы Linux и их версии для ОС и дисков данных можно просмотреть в разделе предварительных требований выше). |
| sequenceVersion | Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда шифрование диска выполняется на той же виртуальной машине. |
| vmName | Имя виртуальной машины, для которой будет выполняться шифрование. |
| passPhrase | Введите надежную парольную фразу, которая будет служить ключом шифрования данных. |

> [!NOTE]
> _KeyEncryptionKeyURL_ является необязательным параметром. Вы можете добавить собственный ключ шифрования ключей, чтобы дополнительно защитить ключ шифрования данных (секрет в виде парольной фразы) в своем хранилище ключей.

#### <a name="cli-commands"></a>Команды интерфейса командной строки
Можно включить шифрование дисков для зашифрованного виртуального жесткого диска, установив [интерфейс командной строки](../cli-install-nodejs.md) и используя его команды. Чтобы с помощью команд интерфейса командной строки включить шифрование на виртуальных машинах IaaS под управлением Linux, которые уже существуют или работают в Azure, сделайте следующее.

1. Задайте политики доступа в хранилище ключей.

 * Установите флажок **EnabledForDiskEncryption**.

    `azure keyvault set-policy --vault-name <keyVaultName> --enabled-for-disk-encryption true`
 * Установите для приложения Azure AD разрешения на запись секретов в ваше хранилище ключей.

    `azure keyvault set-policy --vault-name <keyVaultName> --spn <aadClientID> --perms-to-keys '["wrapKey"]' --perms-to-secrets '["set"]'`

2. Чтобы включить шифрование на существующей или запущенной виртуальной машине, введите следующую команду.

 `azure vm enable-disk-encryption --resource-group <resourceGroupName> --name <vmName> --aad-client-id <aadClientId> --aad-client-secret <aadClientSecret> --disk-encryption-key-vault-url <keyVaultURL> --disk-encryption-key-vault-id <keyVaultResourceId> --volume-type [All|OS|Data]`

3. Получите состояние шифрования, введя следующую команду.

 `azure vm show-disk-encryption-status --resource-group <resourceGroupName> --name <vmName> --json`

4. Чтобы включить шифрование на новой виртуальной машине, созданной с использованием вашего зашифрованного виртуального жесткого диска, используйте команду `azure vm create` с приведенными ниже параметрами.
 ```
   * disk-encryption-key-vault-id <disk-encryption-key-vault-id>
   * disk-encryption-key-url <disk-encryption-key-url>
   * key-encryption-key-vault-id <key-encryption-key-vault-id>
   * key-encryption-key-url <key-encryption-key-url>
 ```

### <a name="get-the-encryption-status-of-an-encrypted-iaas-vm"></a>Получение состояния шифрования зашифрованной виртуальной машины IaaS
Состояние шифрования можно узнать с помощью Azure Resource Manager, [командлетов PowerShell](/powershell/azure/overview) или команд интерфейса командной строки. В следующих разделах описано, как использовать портал Azure и команды интерфейса командной строки, чтобы получить состояние шифрования.

#### <a name="get-the-encryption-status-of-an-encrypted-windows-vm-by-using-azure-resource-manager"></a>Получение состояния шифрования зашифрованной виртуальной машины Windows с помощью Azure Resource Manager
Состояние шифрования виртуальной машины IaaS можно узнать с помощью Azure Resource Manager, выполнив следующее.

1. Войдите на [портал Azure](https://portal.azure.com/) и щелкните **Виртуальные машины** в левой области, чтобы просмотреть представление сводки по виртуальным машинам в своей подписке. Вы можете отфильтровать представление виртуальных машин, выбрав имя подписки из раскрывающегося списка **Подписка**.

2. В верхней части страницы **Виртуальные машины** щелкните **Столбцы**.

3. В колонке **Choose column** (Выбор столбца) выберите столбец **Disk Encryption** (Шифрование дисков) и нажмите кнопку **Обновить**. Вы увидите, что в столбце шифрования дисков отображается состояние шифрования (_Включено_ или _Не включено_) для каждой виртуальной машины, как показано на рисунке ниже.

 ![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig2.png)

#### <a name="get-the-encryption-status-of-an-encrypted-windowslinux-iaas-vm-by-using-the-disk-encryption-powershell-cmdlet"></a>Получение состояния шифрования зашифрованной виртуальной машины IaaS (Windows или Linux) с помощью командлета PowerShell для шифрования дисков
Состояние шифрования виртуальной машины IaaS можно узнать с помощью командлета PowerShell для шифрования дисков `Get-AzureRmVMDiskEncryptionStatus`. Чтобы получить параметры шифрования виртуальной машины, введите следующую команду.

    C:\> Get-AzureRmVmDiskEncryptionStatus  -ResourceGroupName $ResourceGroupName -VMName $VMName
    -ExtensionName $ExtensionName

    OsVolumeEncrypted          : NotEncrypted
    DataVolumesEncrypted       : Encrypted
    OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
    ProgressMessage            : https://rheltest1keyvault.vault.azure.net/secrets/bdb6bfb1-5431-4c28-af46-b18d0025ef2a/abebacb83d864a5fa729508315020f8a

В выходных данных _Get-AzureRmVMDiskEncryptionStatus_ можно получить URL-адреса ключей шифрования.

    C:\> $status = Get-AzureRmVmDiskEncryptionStatus  -ResourceGroupName $ResourceGroupName -VMName
    e $VMName -ExtensionName $ExtensionName
    C:\> $status.OsVolumeEncryptionSettings

    DiskEncryptionKey                                                 KeyEncryptionKey                                               Enabled
    -----------------                                                 ----------------                                               -------
    Microsoft.Azure.Management.Compute.Models.KeyVaultSecretReference Microsoft.Azure.Management.Compute.Models.KeyVaultKeyReference    True


    C:\> $status.OsVolumeEncryptionSettings.DiskEncryptionKey.SecretUrl
    https://rheltest1keyvault.vault.azure.net/secrets/bdb6bfb1-5431-4c28-af46-b18d0025ef2a/abebacb83d864a5fa729508315020f8a
    C:\> $status.OsVolumeEncryptionSettings.DiskEncryptionKey

    SecretUrl                                                                                                               SourceVault
    ---------                                                                                                               -----------
    https://rheltest1keyvault.vault.azure.net/secrets/bdb6bfb1-5431-4c28-af46-b18d0025ef2a/abebacb83d864a5fa729508315020f8a Microsoft.Azure.Management....

Параметры OSVolumeEncrypted и DataVolumesEncrypted имеют значения _Encrypted_. Это означает, что оба тома зашифрованы с помощью шифрования дисков Azure. Сведения о включении шифрования дисков Azure с помощью командлетов PowerShell см. в статьях [Explore Azure Disk Encryption with Azure Powershell](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/17/explore-azure-disk-encryption-with-azure-powershell.aspx) (Изучение возможностей шифрования дисков Azure с помощью PowerShell) и [Explore Azure Disk Encryption with Azure PowerShell – Part 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx) (Изучение возможностей шифрования дисков Azure с помощью PowerShell. Часть 2).

> [!NOTE]
> На виртуальных машинах Linux отчет о состоянии шифрования появляется через три или четыре минуты после выполнения командлета `Get-AzureRmVMDiskEncryptionStatus`.

#### <a name="get-the-encryption-status-of-the-iaas-vm-from-the-disk-encryption-cli-command"></a>Получение состояния шифрования виртуальной машины IaaS с помощью команды интерфейса командной строки для шифрования дисков
Состояние шифрования виртуальной машины IaaS можно получить с помощью следующей команды интерфейса командной строки для шифрования дисков: `azure vm show-disk-encryption-status`. Чтобы получить параметры шифрования для виртуальной машины, введите в сеансе Azure CLI приведенную ниже команду.

    azure vm show-disk-encryption-status --resource-group <yourResourceGroupName> --name <yourVMName> --json  

#### <a name="disable-encryption-on-running-windows-iaas-vm"></a>Отключение шифрования на работающей виртуальной машине IaaS под управлением Windows
Шифрование на работающей виртуальной машине IaaS под управлением Windows или Linux можно отключить при помощи шаблона Resource Manager для шифрования дисков Azure или командлетов PowerShell и задать конфигурацию расшифровки.

##### <a name="windows-vm"></a>Виртуальная машина Windows
На этом этапе для работающей виртуальной машины IaaS под управлением Windows отключается шифрование тома ОС и (или) тома данных. Невозможно отключить том ОС и оставить том данных зашифрованным. После отключения шифрования классическая модель развертывания Azure обновляет модель службы виртуальной машины, и виртуальная машина IaaS под управлением Windows помечается как расшифрованная. Неактивное содержимое виртуальной машины больше не шифруется. Шифрование не приводит к удалению хранилища ключей и ключевого материала шифрования (ключи шифрования BitLocker для Windows или парольная фраза для Linux).

##### <a name="linux-vm"></a>Виртуальная машина Linux
На этом этапе для работающей виртуальной машины IaaS под управлением Linux отключается шифрование тома данных. Этот шаг работает только в том случае, если диск ОС не зашифрован.

> [!NOTE]
> Отключение шифрования диска ОС на виртуальных машинах Linux не поддерживается.

##### <a name="disable-encryption-on-an-existing-or-running-iaas-vm"></a>Отключение шифрования на существующей или запущенной виртуальной машине IaaS
Шифрование дисков для работающей виртуальной машины IaaS под управлением Windows можно отключить с помощью [шаблона Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-decrypt-running-windows-vm).

1. В шаблоне быстрого запуска Azure щелкните **Развертывание в Azure**, введите параметры расшифровки в колонке **Параметры** и нажмите кнопку **ОК**.

2. Выберите подписку, группу ресурсов, расположение группы ресурсов, юридические условия и соглашение, а затем нажмите кнопку **Создать**, чтобы включить шифрование для новой виртуальной машины IaaS.

На виртуальных машинах Linux отключить шифрование можно с помощью этого шаблона [отключения шифрования на работающей виртуальной машине Linux](https://aka.ms/decrypt-linuxvm).

В следующей таблице перечислены параметры шаблона Resource Manager для отключения шифрования на работающей виртуальной машине IaaS.

| Параметр | ОПИСАНИЕ |
| --- | --- |
| vmName | Имя виртуальной машины, для которой будет выполняться шифрование.
| volumeType | Тип тома, для которого будет выполняться расшифровка. Допустимые значения: _OS_, _Data_ и _All_. Невозможно отключить шифрование тома ОС или загрузочного тома на работающей виртуальной машине IaaS под управлением Windows, не отключив шифрование для тома _данных_. Также имейте ввиду, что отключение шифрования диска ОС на виртуальных машинах Linux не поддерживается. |
| sequenceVersion | Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда расшифровка диска выполняется на той же виртуальной машине. |

##### <a name="disable-encryption-on-an-existing-or-running-iaas-vm"></a>Отключение шифрования на существующей или запущенной виртуальной машине IaaS
Отключение шифрования на запущенной или работающей виртуальной машине IaaS с помощью командлета PowerShell описывается в разделе [`Disable-AzureRmVMDiskEncryption`](/powershell/module/azurerm.compute/disable-azurermvmdiskencryption). Этот командлет поддерживает виртуальные машины Linux и Windows. Этот командлет устанавливает на виртуальной машине расширение для отключения шифрования. Если для параметра _Name_ не указано значение, создается расширение с именем по умолчанию _AzureDiskEncryption for Windows VMs_.

На виртуальных машинах Linux используется расширение AzureDiskEncryptionForLinux.

> [!NOTE]
> Этот командлет перезагружает виртуальную машину.

### <a name="enable-encryption-on-pre-encrypted-iaas-vm-with-azure-managed-disk"></a>Включение шифрования для предварительно зашифрованной виртуальной машины IaaS с управляемым диском Azure
Для создания зашифрованной виртуальной машины на основе предварительно зашифрованного виртуального жесткого диска используйте шаблон ARM управляемого диска Azure, расположенный на странице   
[Create a new encrypted managed disk from a pre-encrypted VHD/storage blob (Создание нового зашифрованного управляемого диска из предварительно зашифрованного виртуального жесткого диска или большого двоичного объекта хранилища)] (https://github.com/Azure/azure-quickstart-templates/tree/master/201-create-encrypted-managed-disk).

### <a name="enable-encryption-on-a-new-linux-iaas-vm-with-azure-managed-disk"></a>Включение шифрования для новой виртуальной машины IaaS с ОС Linux и управляемым диском Azure
Для создания зашифрованной виртуальной машины IaaS с ОС Linux используйте шаблон ARM управляемого диска Azure, расположенный на странице   
[Deployment of RHEL 7.2 with full disk encryption (Развертывание RHEL 7.2 с полным шифрованием диска)] (https://github.com/Azure/azure-quickstart-templates/tree/master/101-vm-full-disk-encrypted-rhel).

### <a name="enable-encryption-on-a-new-windows-iaas-vm-with-azure-managed-disk"></a>Включение шифрования для новой виртуальной машины IaaS с ОС Windows и управляемым диском Azure
 Для создания зашифрованной виртуальной машины IaaS с ОС Linux используйте шаблон ARM управляемого диска Azure, расположенный на странице   
 [Create a new encrypted Windows IaaS Managed Disk VM from gallery image (Создание новой зашифрованной виртуальной машины с управляемым диском Windows IaaS на основе образа из коллекции)] (https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-create-new-vm-gallery-image-managed-disks).

  > [!NOTE]
  >Нужно обязательно создать образ или резервную копию экземпляра виртуальной машины на основе управляемого диска вне шифрования дисков Azure и перед включением этой функции.  Моментальный снимок управляемого диска можно создать с портала или использовать для этого Azure Backup.  Резервные копии обеспечивают возможность восстановления при любом непредвиденном сбое во время шифрования.  После создания резервной копии можно зашифровать управляемые диски с помощью командлета Set-AzureRmVMDiskEncryptionExtension, указав параметр -skipVmBackup.  Эта команда будет завершаться ошибкой при использовании с виртуальными машинами на основе управляемых дисков, пока не будет сделана резервная копия и указан определенный параметр.    
 
### <a name="update-encryption-settings-of-an-existing-encrypted-non-premium-vm"></a>Изменение параметров шифрования существующей зашифрованной виртуальной машины не класса "Премиум"
  Для изменения параметров шифрования, таких как идентификатор или секрет клиента AAD, ключ шифрования ключей (KEK), ключ шифрования BitLocker для виртуальной машины Windows или парольная фраза для виртуальной машины VM и т. д., используйте существующие поддерживаемые интерфейсы шифрования дисков Azure для виртуальной машины (командлеты PowerShell, интерфейс командной строки или шаблоны ARM). Изменение параметров шифрования поддерживается для виртуальных машин на основе хранилища класса Premium и других классов.

## <a name="appendix"></a>Приложение
### <a name="connect-to-your-subscription"></a>Подключение к подписке
Прежде чем продолжить, просмотрите раздел *Предварительные требования* этой статьи. Убедившись, что выполнены все предварительные требования, подключитесь к своей подписке, выполнив следующее.

1. Запустите сеанс Azure PowerShell и войдите в учетную запись Azure, используя следующую команду.

    `Connect-AzureRmAccount`

2. Если у вас несколько подписок и нужно указать, какая из них будет использоваться, введите приведенную ниже команду, чтобы увидеть подписки своей учетной записи.

    `Get-AzureRmSubscription`

3. Чтобы указать подписку, которую нужно использовать, введите следующую команду.

    `Select-AzureRmSubscription -SubscriptionName <Yoursubscriptionname>`

4. Чтобы проверить, правильно ли настроена подписка, введите следующую команду.

    `Get-AzureRmSubscription`

5. Чтобы убедиться, что командлеты шифрования дисков Azure установлены, введите следующую команду.

    `Get-command *diskencryption*`

6. Ниже приведен результат, подтверждающий, что командлеты PowerShell для шифрования дисков Azure установлены правильно.

```
    PS C:\Windows\System32\WindowsPowerShell\v1.0> get-command *diskencryption*
    CommandType  Name                                         Source                                                             
    Cmdlet       Get-AzureRmVMDiskEncryptionStatus            AzureRM.Compute                                                    
    Cmdlet       Disable-AzureRmVMDiskEncryption              AzureRM.Compute                                                    
    Cmdlet       Set-AzureRmVMDiskEncryptionExtension         AzureRM.Compute                                                     
```

### <a name="prepare-a-pre-encrypted-windows-vhd"></a>Подготовка предварительно зашифрованного виртуального жесткого диска Windows
В следующем разделе приведены инструкции по подготовке предварительно зашифрованного виртуального жесткого диска Windows к развертыванию в качестве зашифрованного виртуального жесткого диска в IaaS Azure. Используйте эти сведения, чтобы подготовить и загрузить новую виртуальную машину Windows (VHD) в Azure Site Recovery Azure или Azure.

#### <a name="update-group-policy-to-allow-non-tpm-for-os-protection"></a>Обновление групповой политики с целью разрешить защиту ОС без TPM
Настройте параметр групповой политики BitLocker, который называется **Шифрование дисков BitLocker**. Для этого выберите **Политика локального компьютера** > **Конфигурация компьютера** > **Административные шаблоны** > **Компоненты Windows**. Задайте для этого параметра такое значение: **Диски операционной системы** > **Обязательная дополнительная проверка подлинности при запуске** > **Разрешить использование BitLocker без совместимого TPM**, как показано на рисунке ниже.

![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig8.png)

#### <a name="install-bitlocker-feature-components"></a>Установка компонентов BitLocker
Для Windows Server 2012 или более поздней версии используйте следующую команду.

    dism /online /Enable-Feature /all /FeatureName:BitLocker /quiet /norestart

Для Windows Server 2008 R2 используйте следующую команду.

    ServerManagerCmd -install BitLockers

#### <a name="prepare-the-os-volume-for-bitlocker-by-using-bdehdcfg"></a>Подготовка тома операционной системы для BitLocker с помощью `bdehdcfg`
Выполните следующую команду, чтобы сжать раздел операционной системы и подготовить компьютер к использованию BitLocker.

    bdehdcfg -target c: shrink -quiet

#### <a name="protect-the-os-volume-by-using-bitlocker"></a>Защита тома операционной системы с помощью BitLocker
Используйте команду [`manage-bde`](https://technet.microsoft.com/library/ff829849.aspx), чтобы включить шифрование на загрузочном томе с использованием внешнего предохранителя ключа. Можно также поместить внешний ключ (BEK-файл) на внешний диск или том. Шифрование будет включено для системного или загрузочного тома после перезагрузки.

    manage-bde -on %systemdrive% -sk [ExternalDriveOrVolume]
    reboot

> [!NOTE]
> Чтобы получить внешний ключ с использованием BitLocker, подготовьте виртуальную машину с отдельным виртуальным жестким диском для данных и ресурсов.

#### <a name="encrypting-an-os-drive-on-a-running-linux-vm"></a>Шифрование диска ОС на работающей виртуальной машине Linux

##### <a name="prerequisites-for-os-disk-encryption"></a>Предварительные требования для шифрования диска ОС

* Виртуальная машина должна использовать дистрибутив, который совместим с шифрованием диска ОС. Список дистрибутивов приведен в разделе [Какие дистрибутивы Linux поддерживает шифрование дисков Azure?](https://docs.microsoft.com/azure/security/azure-security-disk-encryption-faq#what-linux-distributions-does-azure-disk-encryption-support) 
* Виртуальная машина должна быть создана из образа Marketplace в Azure Resource Manager.
* Виртуальная машина Azure по крайней мере с 4 ГБ ОЗУ (рекомендуемый размер — 7 ГБ).
* (Для RHEL и CentOS.) Отключите SELinux. Чтобы отключить SELinux на виртуальной машине, ознакомьтесь с разделом "4.4.2. Disabling SELinux" (4.4.2. Отключение SELinux) [руководства пользователя и администратора SELinux](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/sect-Security-Enhanced_Linux-Working_with_SELinux-Changing_SELinux_Modes.html#sect-Security-Enhanced_Linux-Enabling_and_Disabling_SELinux-Disabling_SELinux).
* После отключения SELinux перезагрузите виртуальную машину по крайней мере один раз.

##### <a name="steps"></a>Действия
1. Создайте виртуальную машину с помощью одного из дистрибутивов, указанных ранее.

 Для CentOS 7.2 шифрование диска операционной системы можно включить через специальный образ. Чтобы использовать этот образ, задайте при создании виртуальной машины для параметра SKU значение 7.2n.
 ```
    Set-AzureRmVMSourceImage -VM $VirtualMachine -PublisherName "OpenLogic" -Offer "CentOS" -Skus "7.2n" -Version "latest"
 ```
2. Настройте виртуальную машину в соответствии с потребностями. Если вы собираетесь включить шифрование всех дисков (диска ОС и дисков данных), то диски данных необходимо указать и подключить в файле /etc/fstab.

 > [!NOTE]
 > Чтобы указать диски данных в файле /etc/fstab, используйте значение UUID=... (в этом случае не нужно указывать имя блочного устройства, например /dev/sdb1). В процессе шифрования порядок дисков на виртуальной машине изменится. Если на виртуальной машине используется определенный порядок блочных устройств, то при их подключении после шифрования произойдет сбой.

3. Выйдите из сеансов SSH.

4. Чтобы зашифровать ОС, задайте при [включении шифрования](#enable-encryption-on-existing-or-running-iaas-linux-vm-in-azure) для параметра volumeType значение **All** или **OS**.

 > [!NOTE]
 > Все пользовательские процессы, не запущенные как службы `systemd`, необходимо завершить с помощью `SIGKILL`. Перезагрузите виртуальную машину. В случае включения шифрования диска ОС на работающей виртуальной запланируйте период простоя.

5. Периодически отслеживайте ход выполнения шифрования, следуя инструкциям из [следующего раздела](#monitoring-os-encryption-progress).

6. Как только командлет Get-AzureRmVmDiskEncryptionStatus вернет значение VMRestartPending, перезапустите виртуальную машину, войдя в нее, либо с помощью портала, PowerShell или интерфейса командной строки.
    ```
    C:\> Get-AzureRmVmDiskEncryptionStatus  -ResourceGroupName $ResourceGroupName -VMName $VMName
    -ExtensionName $ExtensionName

    OsVolumeEncrypted          : VMRestartPending
    DataVolumesEncrypted       : NotMounted
    OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
    ProgressMessage            : OS disk successfully encrypted, reboot the VM
    ```
Перед перезагрузкой рекомендуется сохранить [диагностические данные загрузки](https://azure.microsoft.com/blog/boot-diagnostics-for-virtual-machines-v2/) виртуальной машины.

#### <a name="monitoring-os-encryption-progress"></a>Мониторинг хода выполнения шифрования операционной системы
Мониторинг хода выполнения шифрования ОС можно выполнять тремя способами.

* Используйте командлет `Get-AzureRmVmDiskEncryptionStatus` и просмотрите поле ProgressMessage.
    ```
    OsVolumeEncrypted          : EncryptionInProgress
    DataVolumesEncrypted       : NotMounted
    OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
    ProgressMessage            : OS disk encryption started
    ```
 На виртуальных машинах уровня "Премиум" шифрование диска ОС длится 40–50 минут с момента появления сообщения "OS disk encryption started" (Начато шифрование диска ОС).

 В связи с [ошибкой № 388](https://github.com/Azure/WALinuxAgent/issues/388) в WALinuxAgent в некоторых дистрибутивах `OsVolumeEncrypted` и `DataVolumesEncrypted` отображаются как `Unknown`. В WALinuxAgent 2.1.5 и более поздних версиях эта проблема исправляется автоматически. Если в выходных данных отображается `Unknown`, состояние шифрования дисков можно проверить с помощью обозревателя ресурсов Azure.

 Откройте [обозреватель ресурсов Azure](https://resources.azure.com/) и на панели выбора слева разверните иерархическую структуру, как показано ниже.

 ~~~~
 |-- subscriptions
     |-- [Your subscription]
          |-- resourceGroups
               |-- [Your resource group]
                    |-- providers
                         |-- Microsoft.Compute
                              |-- virtualMachines
                                   |-- [Your virtual machine]
                                        |-- InstanceView
~~~~                

 В InstanceView прокрутите вниз, чтобы увидеть состояние шифрования дисков.

 ![Представление экземпляра виртуальной машины](./media/azure-security-disk-encryption/vm-instanceview.png)

* Просмотрите [диагностические данные загрузки](https://azure.microsoft.com/blog/boot-diagnostics-for-virtual-machines-v2/). Сообщения расширения шифрования дисков Azure должны начинаться с `[AzureDiskEncryption]`.

* Выполните вход на виртуальную машину с помощью протокола SSH и скопируйте журнал расширения, расположенный по следующему пути:

    /var/log/azure/Microsoft.Azure.Security.AzureDiskEncryptionForLinux

 Мы советуем не входить на виртуальную машину, пока шифруется ее диск ОС. Копируйте журналы только в том случае, когда два других способа не дали результата.

#### <a name="prepare-a-pre-encrypted-linux-vhd"></a>Подготовка предварительно зашифрованного виртуального жесткого диска Linux
##### <a name="ubuntu-16"></a>Ubuntu 16
Настройте шифрование во время установки дистрибутива следующим образом.

1. Во время настройки разделов дисков выберите **Configure encrypted volumes** (Настройка зашифрованных томов).

 ![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig1.png)

2. Создайте отдельный загрузочный диск (незашифрованный). Зашифруйте корневой диск.

 ![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig2.png)

3. Укажите парольную фразу. Это парольная фраза, которую необходимо будет передать в хранилище ключей.

 ![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig3.png)

4. Завершите настройку разделов.

 ![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig4.png)

5. После загрузки виртуальной машины отобразится запрос парольной фразы. Введите парольную фразу, указанную на шаге 3.

 ![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig5.png)

6. Подготовьте виртуальную машину к передаче в Azure, следуя [этим инструкциям](https://azure.microsoft.com/documentation/articles/virtual-machines-linux-create-upload-ubuntu/). Пока не выполняйте последний шаг (отзыв виртуальной машины).

Настройте шифрование для Azure, выполнив следующее.

1. Создайте файл /usr/local/sbin/azure_crypt_key.sh с приведенным ниже содержимым. Обратите внимание на параметр KeyFileName — это имя файла парольной фразы, используемое Azure.

    ```
    #!/bin/sh
    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint
    modprobe vfat >/dev/null 2>&1
    modprobe ntfs >/dev/null 2>&1
    sleep 2
    OPENED=0
    cd /sys/block
    for DEV in sd*; do

        echo "> Trying device: $DEV ..." >&2
        mount -t vfat -r /dev/${DEV}1 $MountPoint >/dev/null||
        mount -t ntfs -r /dev/${DEV}1 $MountPoint >/dev/null
        if [ -f $MountPoint/$KeyFileName ]; then
                cat $MountPoint/$KeyFileName
                umount $MountPoint 2>/dev/null
                OPENED=1
                break
        fi
        umount $MountPoint 2>/dev/null
    done

      if [ $OPENED -eq 0 ]; then
        echo "FAILED to find suitable passphrase file ..." >&2
        echo -n "Try to enter your password: " >&2
        read -s -r A </dev/console
        echo -n "$A"
     else
        echo "Success loading keyfile!" >&2
    fi
```

2. Измените настройки шифрования в */etc/crypttab*. Результат будет выглядеть так:
 ```
    xxx_crypt uuid=xxxxxxxxxxxxxxxxxxxxx none luks,discard,keyscript=/usr/local/sbin/azure_crypt_key.sh
    ```

3. Если вы редактировали файл *azure_crypt_key.sh* в Windows и скопировали его Linux, выполните `dos2unix /usr/local/sbin/azure_crypt_key.sh`.

4. Добавьте в сценарий разрешения для исполняемого файла.
 ```
    chmod +x /usr/local/sbin/azure_crypt_key.sh
 ```
5. Измените */etc/initramfs-tools/modules*, добавив приведенные ниже строки.
 ```
    vfat
    ntfs
    nls_cp437
    nls_utf8
    nls_iso8859-1
```
6. Выполните `update-initramfs -u -k all` и обновите initramfs, чтобы `keyscript` вступил в действие.

7. Теперь виртуальную машину можно отозвать.

 ![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig6.png)

8. Перейдите к следующему шагу и [передайте свой виртуальный жесткий диск](#upload-encrypted-vhd-to-an-azure-storage-account) в Azure.

##### <a name="opensuse-132"></a>openSUSE 13.2
Чтобы настроить шифрование во время установки дистрибутива, сделайте следующее.
1. При настройке разделов дисков выберите **Encrypt Volume Group** (Шифрование группы томов), а затем введите пароль. Это пароль, который потребуется передать в хранилище ключей.

 ![Настройка openSUSE 13.2](./media/azure-security-disk-encryption/opensuse-encrypt-fig1.png)

2. Загрузите виртуальную машину, используя указанный пароль.

 ![Настройка openSUSE 13.2](./media/azure-security-disk-encryption/opensuse-encrypt-fig2.png)

3. Подготовьте виртуальную машину для передачи в Azure, следуя инструкциям в разделе [Подготовка виртуальной машины SLES или openSUSE для Azure](https://azure.microsoft.com/documentation/articles/virtual-machines-linux-suse-create-upload-vhd/#prepare-opensuse-131). Пока не выполняйте последний шаг (отзыв виртуальной машины).

Настройте шифрование для Azure, выполнив следующее.
1. Измените файл /etc/dracut.conf и добавьте приведенную ниже строку.
    ```
    add_drivers+=" vfat ntfs nls_cp437 nls_iso8859-1"
    ```
2. Закомментируйте приведенные строки в конце файла /usr/lib/dracut/modules.d/90crypt/module-setup.sh.
 ```
    #        inst_multiple -o \
    #        $systemdutildir/system-generators/systemd-cryptsetup-generator \
    #        $systemdutildir/systemd-cryptsetup \
    #        $systemdsystemunitdir/systemd-ask-password-console.path \
    #        $systemdsystemunitdir/systemd-ask-password-console.service \
    #        $systemdsystemunitdir/cryptsetup.target \
    #        $systemdsystemunitdir/sysinit.target.wants/cryptsetup.target \
    #        systemd-ask-password systemd-tty-ask-password-agent
    #        inst_script "$moddir"/crypt-run-generator.sh /sbin/crypt-run-generator
 ```

3. В начале файла /usr/lib/dracut/modules.d/90crypt/parse-crypt.sh добавьте следующую строку.
 ```
    DRACUT_SYSTEMD=0
 ```
Затем измените все вхождения
 ```
    if [ -z "$DRACUT_SYSTEMD" ]; then
 ```
на:
```
    if [ 1 ]; then
```
4. Измените файл /usr/lib/dracut/modules.d/90crypt/cryptroot-ask.sh, добавив следующий текст после строки # Open LUKS device.

    ```
    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint >&2
    modprobe vfat >/dev/null >&2
    modprobe ntfs >/dev/null >&2
    for SFS in /dev/sd*; do
    echo "> Trying device:$SFS..." >&2
    mount ${SFS}1 $MountPoint -t vfat -r >&2 ||
    mount ${SFS}1 $MountPoint -t ntfs -r >&2
    if [ -f $MountPoint/$KeyFileName ]; then
        echo "> keyfile got..." >&2
        cp $MountPoint/$KeyFileName /tmp-keyfile >&2
        luksfile=/tmp-keyfile
        umount $MountPoint >&2
        break
    fi
    done
    ```
5. Выполните `/usr/sbin/dracut -f -v`, чтобы обновить initrd.

6. Теперь виртуальную машину можно отозвать и [передать свой виртуальный жесткий диск](#upload-encrypted-vhd-to-an-azure-storage-account) в Azure.

##### <a name="centos-7"></a>CentOS 7
Чтобы настроить шифрование во время установки дистрибутива, сделайте следующее.
1. Во время настройки разделов дисков выберите **Encrypt my data** (Шифрование личных данных).

 ![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig1.png)

2. Включите шифрование для корневого раздела (параметр **Encrypt**).

 ![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig2.png)

3. Укажите парольную фразу. Это парольная фраза, которую потребуется передать в хранилище ключей.

 ![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig3.png)

4. После загрузки виртуальной машины отобразится запрос парольной фразы. Введите парольную фразу, указанную на шаге 3.

 ![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig4.png)

5. Подготовьте виртуальную машину для передачи в Azure, следуя инструкциям в разделе "CentOS 7.0+" статьи [Подготовка виртуальной машины на основе CentOS для Azure](https://azure.microsoft.com/documentation/articles/virtual-machines-linux-create-upload-centos/#centos-70). Пока не выполняйте последний шаг (отзыв виртуальной машины).

6. Теперь виртуальную машину можно отозвать и [передать свой виртуальный жесткий диск](#upload-encrypted-vhd-to-an-azure-storage-account) в Azure.

Настройте шифрование для Azure, выполнив следующее.

1. Измените файл /etc/dracut.conf и добавьте приведенную ниже строку.
    ```
    add_drivers+=" vfat ntfs nls_cp437 nls_iso8859-1"
    ```

2. Закомментируйте приведенные строки в конце файла /usr/lib/dracut/modules.d/90crypt/module-setup.sh.
```
    #        inst_multiple -o \
    #        $systemdutildir/system-generators/systemd-cryptsetup-generator \
    #        $systemdutildir/systemd-cryptsetup \
    #        $systemdsystemunitdir/systemd-ask-password-console.path \
    #        $systemdsystemunitdir/systemd-ask-password-console.service \
    #        $systemdsystemunitdir/cryptsetup.target \
    #        $systemdsystemunitdir/sysinit.target.wants/cryptsetup.target \
    #        systemd-ask-password systemd-tty-ask-password-agent
    #        inst_script "$moddir"/crypt-run-generator.sh /sbin/crypt-run-generator
```

3. В начале файла /usr/lib/dracut/modules.d/90crypt/parse-crypt.sh добавьте следующую строку.
```
    DRACUT_SYSTEMD=0
```
Затем измените все вхождения
```
    if [ -z "$DRACUT_SYSTEMD" ]; then
```
значение
```
    if [ 1 ]; then
```
4. Измените файл /usr/lib/dracut/modules.d/90crypt/cryptroot-ask.sh, добавив следующий текст после строки # Open LUKS device.
    ```
    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint >&2
    modprobe vfat >/dev/null >&2
    modprobe ntfs >/dev/null >&2
    for SFS in /dev/sd*; do
    echo "> Trying device:$SFS..." >&2
    mount ${SFS}1 $MountPoint -t vfat -r >&2 ||
    mount ${SFS}1 $MountPoint -t ntfs -r >&2
    if [ -f $MountPoint/$KeyFileName ]; then
        echo "> keyfile got..." >&2
        cp $MountPoint/$KeyFileName /tmp-keyfile >&2
        luksfile=/tmp-keyfile
        umount $MountPoint >&2
        break
    fi
    done
    ```    
5. Выполните команду /usr/sbin/dracut -f -v, чтобы обновить initrd.

![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig5.png)

### <a name="upload-encrypted-vhd-to-an-azure-storage-account"></a>Передача зашифрованного виртуального жесткого диска в учетную запись хранения Azure
После включения шифрования BitLocker или DM-Crypt следует передать локальный зашифрованный виртуальный жесткий диск в учетную запись хранения.

    Add-AzureRmVhd [-Destination] <Uri> [-LocalFilePath] <FileInfo> [[-NumberOfUploaderThreads] <Int32> ] [[-BaseImageUriToPatch] <Uri> ] [[-OverWrite]] [ <CommonParameters>]

### <a name="upload-the-disk-encryption-secret-for-the-pre-encrypted-vm-to-your-key-vault"></a>Передача секрета шифрования дисков для предварительно зашифрованной виртуальной машины в хранилище ключей
Секрет шифрования дисков, полученный ранее, необходимо передать в хранилище ключей в качестве секрета. В хранилище ключей нужно включить разрешения для клиента Azure AD и шифрование дисков.

    $AadClientId = "YourAADClientId"
    $AadClientSecret = "YourAADClientSecret"

    $key vault = New-AzureRmKeyVault -VaultName $KeyVaultName -ResourceGroupName $ResourceGroupName -Location $Location

    Set-AzureRmKeyVaultAccessPolicy -VaultName $KeyVaultName -ResourceGroupName $ResourceGroupName -ServicePrincipalName $AadClientId -PermissionsToKeys all -PermissionsToSecrets all
    Set-AzureRmKeyVaultAccessPolicy -VaultName $KeyVaultName -ResourceGroupName $ResourceGroupName -EnabledForDiskEncryption


#### <a name="disk-encryption-secret-not-encrypted-with-a-kek"></a>Секрет дискового шифрования не шифруется с помощью KEK
Используйте командлет [Set-AzureKeyVaultSecret](/powershell/module/azurerm.keyvault/set-azurekeyvaultsecret), чтобы настроить секрет в хранилище ключей. Если вы используете виртуальную машину Windows, то с помощью командлета `Set-AzureKeyVaultSecret` можно закодировать BEK-файл как строку Base64 и передать его в хранилище ключей. Если используется виртуальная машина Linux, то парольную фразу можно закодировать как строку Base64, а затем передать в хранилище ключей. Убедитесь также, что при создании секрета в хранилище ключей были установлены следующие теги.

    # This is the passphrase that was provided for encryption during the distribution installation
    $passphrase = "contoso-password"

    $tags = @{"DiskEncryptionKeyEncryptionAlgorithm" = "RSA-OAEP"; "DiskEncryptionKeyFileName" = "LinuxPassPhraseFileName"}
    $secretName = [guid]::NewGuid().ToString()
    $secretValue = [Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($passphrase))
    $secureSecretValue = ConvertTo-SecureString $secretValue -AsPlainText -Force

    $secret = Set-AzureKeyVaultSecret -VaultName $KeyVaultName -Name $secretName -SecretValue $secureSecretValue -tags $tags
    $secretUrl = $secret.Id

На следующем шаге используйте `$secretUrl`, чтобы [подключить диск ОС, не применяя ключ шифрования ключей](#without-using-a-kek).

#### <a name="disk-encryption-secret-encrypted-with-a-kek"></a>Секрет дискового шифрования, зашифрованный с помощью KEK
Перед передачей секрета в хранилище ключей его можно дополнительно зашифровать с помощью ключа шифрования ключей. Используйте [API](https://msdn.microsoft.com/library/azure/dn878066.aspx) для создания оболочки, чтобы сначала зашифровать секрет с использованием ключа шифрования ключей. Эта операция возвращает значения, закодированные как строка URL-адреса в кодировке Base64, которые затем передаются в качестве секрета с помощью командлета [`Set-AzureKeyVaultSecret`](/powershell/module/azurerm.keyvault/set-azurekeyvaultsecret).

    # This is the passphrase that was provided for encryption during the distribution installation
    $passphrase = "contoso-password"

    Add-AzureKeyVaultKey -VaultName $KeyVaultName -Name "keyencryptionkey" -Destination Software
    $KeyEncryptionKey = Get-AzureKeyVaultKey -VaultName $KeyVault.OriginalVault.Name -Name "keyencryptionkey"

    $apiversion = "2015-06-01"

    ##############################
    # Get Auth URI
    ##############################

    $uri = $KeyVault.VaultUri + "/keys"
    $headers = @{}

    $response = try { Invoke-RestMethod -Method GET -Uri $uri -Headers $headers } catch { $_.Exception.Response }

    $authHeader = $response.Headers["www-authenticate"]
    $authUri = [regex]::match($authHeader, 'authorization="(.*?)"').Groups[1].Value

    Write-Host "Got Auth URI successfully"

    ##############################
    # Get Auth Token
    ##############################

    $uri = $authUri + "/oauth2/token"
    $body = "grant_type=client_credentials"
    $body += "&client_id=" + $AadClientId
    $body += "&client_secret=" + [Uri]::EscapeDataString($AadClientSecret)
    $body += "&resource=" + [Uri]::EscapeDataString("https://vault.azure.net")
    $headers = @{}

    $response = Invoke-RestMethod -Method POST -Uri $uri -Headers $headers -Body $body

    $access_token = $response.access_token

    Write-Host "Got Auth Token successfully"

    ##############################
    # Get KEK info
    ##############################

    $uri = $KeyEncryptionKey.Id + "?api-version=" + $apiversion
    $headers = @{"Authorization" = "Bearer " + $access_token}

    $response = Invoke-RestMethod -Method GET -Uri $uri -Headers $headers

    $keyid = $response.key.kid

    Write-Host "Got KEK info successfully"

    ##############################
    # Encrypt passphrase using KEK
    ##############################

    $passphraseB64 = [Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($Passphrase))
    $uri = $keyid + "/encrypt?api-version=" + $apiversion
    $headers = @{"Authorization" = "Bearer " + $access_token; "Content-Type" = "application/json"}
    $bodyObj = @{"alg" = "RSA-OAEP"; "value" = $passphraseB64}
    $body = $bodyObj | ConvertTo-Json

    $response = Invoke-RestMethod -Method POST -Uri $uri -Headers $headers -Body $body

    $wrappedSecret = $response.value

    Write-Host "Encrypted passphrase successfully"

    ##############################
    # Store secret
    ##############################

    $secretName = [guid]::NewGuid().ToString()
    $uri = $KeyVault.VaultUri + "/secrets/" + $secretName + "?api-version=" + $apiversion
    $secretAttributes = @{"enabled" = $true}
    $secretTags = @{"DiskEncryptionKeyEncryptionAlgorithm" = "RSA-OAEP"; "DiskEncryptionKeyFileName" = "LinuxPassPhraseFileName"}
    $headers = @{"Authorization" = "Bearer " + $access_token; "Content-Type" = "application/json"}
    $bodyObj = @{"value" = $wrappedSecret; "attributes" = $secretAttributes; "tags" = $secretTags}
    $body = $bodyObj | ConvertTo-Json

    $response = Invoke-RestMethod -Method PUT -Uri $uri -Headers $headers -Body $body

    Write-Host "Stored secret successfully"

    $secretUrl = $response.id

На следующем шаге мы используем `$KeyEncryptionKey` и `$secretUrl`, чтобы [подключить диск ОС, применив ключ шифрования ключей](#using-a-kek).

### <a name="specify-a-secret-url-when-you-attach-an-os-disk"></a>Указание URL-адреса секрета при подключении диска ОС
#### <a name="without-using-a-kek"></a>Без использования ключа шифрования ключа
При подключении диска ОС необходимо передать `$secretUrl`. Этот URL-адрес был создан в разделе "Секрет шифрования дисков, не зашифрованный с помощью ключа шифрования ключей".

    Set-AzureRmVMOSDisk `
            -VM $VirtualMachine `
            -Name $OSDiskName `
            -SourceImageUri $VhdUri `
            -VhdUri $OSDiskUri `
            -Linux `
            -CreateOption FromImage `
            -DiskEncryptionKeyVaultId $KeyVault.ResourceId `
            -DiskEncryptionKeyUrl $SecretUrl

#### <a name="using-a-kek"></a>С использованием ключа шифрования ключа
При подключении диска ОС передайте `$KeyEncryptionKey` и `$secretUrl`. Этот URL-адрес был создан в разделе "Секрет шифрования дисков, не зашифрованный с помощью ключа шифрования ключей".

    Set-AzureRmVMOSDisk `
            -VM $VirtualMachine `
            -Name $OSDiskName `
            -SourceImageUri $CopiedTemplateBlobUri `
            -VhdUri $OSDiskUri `
            -Linux `
            -CreateOption FromImage `
            -DiskEncryptionKeyVaultId $KeyVault.ResourceId `
            -DiskEncryptionKeyUrl $SecretUrl `
            -KeyEncryptionKeyVaultId $KeyVault.ResourceId `
            -KeyEncryptionKeyURL $KeyEncryptionKey.Id

## <a name="for-more-information"></a>Дополнительные сведения
[Explore Azure Disk Encryption with Azure PowerShell](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/16/explore-azure-disk-encryption-with-azure-powershell.aspx?wa=wsignin1.0) (Изучение возможностей шифрования дисков Azure с помощью PowerShell)  
[Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell — часть 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx)
