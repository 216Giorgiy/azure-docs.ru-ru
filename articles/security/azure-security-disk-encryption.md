---
title: "Шифрование дисков Azure для виртуальных машин IaaS под управлением Windows и Linux | Документация Майкрософт"
description: "В этом документе описано шифрование дисков Microsoft Azure для виртуальных машин IaaS под управлением Windows и Linux."
services: security
documentationcenter: na
author: YuriDio
manager: swadhwa
editor: TomSh
ms.assetid: d3fac8bb-4829-405e-8701-fa7229fb1725
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 09/26/2016
ms.author: krkhan
translationtype: Human Translation
ms.sourcegitcommit: ca5b12c90814b9906389a12e8c72e2b4c266483f
ms.openlocfilehash: 3eb295e0ccec9a9410c0bb64e6ead10202b30289


---
# <a name="azure-disk-encryption-for-windows-and-linux-iaas-vms"></a>Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux
Microsoft Azure обеспечивает конфиденциальность и независимость ваших данных всеми возможными способами. К данным, размещенным в Azure, можно применять целый ряд современных технологий для шифрования данных, контроля ключей шифрования и управления ими, а также контроля и аудита доступа к данным. Благодаря этому клиенты Azure получают гибкость в выборе решения, которое лучше всего соответствует потребностям их компании. В этом документе описывается новое технологическое решение «Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux», которое защитит ваши данные в соответствии с корпоративными критериями безопасности и соответствия. Этот документ содержит подробные инструкции по использованию возможностей дискового шифрования Azure, а также описывает поддерживаемые сценарии и взаимодействие с пользователем.

**Примечание.** Выполнение некоторых рекомендаций из этого документа может привести к более интенсивному использованию хранилища, сетевых или вычислительных ресурсов, а следовательно к дополнительным затратам на лицензии или подписки.

## <a name="overview"></a>Обзор
Дисковое шифрование Azure позволяет зашифровать диски виртуальных машин IaaS под управлением Windows и Linux. Шифрование дисков Azure использует стандартные для отрасли функции — [BitLocker](https://technet.microsoft.com/library/cc732774.aspx) в Windows и [DM-Crypt](https://en.wikipedia.org/wiki/Dm-crypt) в Linux, — которые обеспечивают шифрование томов для системных дисков и дисков данных. Это решение интегрировано с [хранилищем ключей Azure](https://azure.microsoft.com/documentation/services/key-vault/), то есть позволяет управлять ключами и секретами дискового шифрования через подписку хранилища ключей. Шифрование выполняется для всех данных на дисках виртуальных машин в хранилище Azure.

Теперь **общедоступная версия** шифрования дисков Azure представлена во всех общедоступных регионах для виртуальных машин IaaS под управлением Windows и Linux уровня "Стандартный" или c хранилищем класса Premium.

### <a name="encryption-scenarios"></a>Сценарии шифрования
Шифрование дисков Azure поддерживает следующие сценарии взаимодействия с клиентом:

* включение шифрования для новых виртуальных машин IaaS, для создания которых используются предварительно зашифрованные виртуальные жесткие диски и ключи шифрования;
* включение шифрования для новых виртуальных машин IaaS, созданных из коллекции образов Azure;
* включение шифрования в имеющихся виртуальных машинах IaaS, запущенных в Azure;
* отключение шифрования на виртуальных машинах IaaS под управлением Windows;
* отключение шифрования на дисках данных виртуальных машин IaaS под управлением Linux.

Когда решение появляется в Microsoft Azure, оно поддерживает следующие возможности для виртуальных машин IaaS:

* интеграция с хранилищем ключей Azure;
* виртуальные машины IaaS серий [A, D, DS, G, GS и т. д.](https://azure.microsoft.com/pricing/details/virtual-machines/) уровня "Стандартный";
* включение шифрования для виртуальных машин IaaS под управлением Windows и Linux;
* отключение шифрования на дисках данных и в операционной системе виртуальных машин IaaS под управлением Windows;
* отключение шифрования на дисках данных виртуальных машин IaaS под управлением Linux;
* включение шифрования на виртуальных машинах IaaS под управлением клиентской ОС Windows;
* включение шифрования для томов с путями подключения.
* включение шифрования на виртуальных машинах Linux с чередованием дисков RAID с помощью программы mdadm;
* включение шифрования на виртуальных машинах Linux с использованием диспетчера логических томов для дисков данных;
* включение шифрования на виртуальных машинах Windows с дисковыми пространствами;
* поддерживаются все общедоступные регионы Azure.

В выпуске решения не поддерживаются следующие сценарии, функции и технологии:

* виртуальные машины уровня "Базовый";
* отключение шифрования на диске операционной системы виртуальных машин IaaS под управлением Linux;
* виртуальные машины IaaS, созданные с использованием классического метода создания VM;
* интеграция с локальной службой управления ключами;
* служба файлов Azure (файловый ресурс Azure), NFS, динамические тома, виртуальные машины Windows с программными системами RAID.

### <a name="encryption-features"></a>Функции шифрования
Когда вы включите и развернете дисковое шифрование Azure для виртуальных машин IaaS Azure, в зависимости от конфигурации решения будут доступны следующие возможности:

* шифрование тома операционной системы для защиты загрузочного тома, размещенного в хранилище клиента;
* шифрование томов данных для защиты данных, размещенных в хранилище клиента;
* отключение шифрования на дисках данных и в операционной системе виртуальных машин IaaS под управлением Windows;
* отключение шифрования на дисках данных виртуальных машин IaaS под управлением Linux;
* защита ключей шифрования и секретов в клиентской подписке хранилища ключей Azure;
* информирование о состоянии шифрования зашифрованных виртуальных машин IaaS;
* удаление настроек дискового шифрования из виртуальной машины IaaS.

Дисковое шифрование Azure для виртуальных машин IaaS Windows и Linux предлагается в виде комплексного решения, которое включает расширение дискового шифрования для Windows, расширение дискового шифрования для Linux, командлеты PowerShell для дискового шифрования, командлеты CLI для дискового шифрования и шаблоны диспетчера ресурсов Azure для дискового шифрования. Решение дискового шифрования Azure поддерживается на виртуальных машинах IaaS под управлением ОС Windows или Linux. Дополнительные сведения о поддерживаемых операционных системах приведены ниже в разделе предварительных условий.

**Примечание.** Дополнительная плата за шифрование дисков Azure для виртуальных машин не взимается.

### <a name="value-proposition"></a>Предлагаемые преимущества
Решение управления дисковым шифрованием Azure позволяет решать в облаке следующие задачи:

* При хранении виртуальные машины IaaS защищаются с помощью стандартных отраслевых технологий шифрования, которые отвечают корпоративным требованиям безопасности и соответствия.
* Загрузка виртуальных машин IaaS выполняется в соответствии с ключами и политиками, которыми управляет клиент. Можно также проводить аудит их использования в хранилище ключей.

### <a name="encryption-workflow"></a>Рабочий процесс шифрования
Далее описаны основные шаги, которые нужно выполнить, чтобы включить дисковое шифрование для VM под управлением Windows и Linux.

1. Клиент выбирает один из сценариев шифрования, перечисленных выше.
2. Клиент соглашается на включение шифрования дисков с помощью шаблона Resource Manager шифрования дисков Azure, командлетов PowerShell или команд интерфейса командной строки, а также указывает настройки шифрования.
   
   * Если клиент выбрал сценарий зашифрованного виртуального жесткого диска, он передает зашифрованный виртуальный жесткий диск в свою учетную запись хранения, а ключи шифрования — в хранилище ключей. Также он указывает настройки шифрования, чтобы включить шифрование на новой виртуальной машине IaaS.
   * Если клиент создает виртуальную машину из коллекции Azure или использует существующую виртуальную машину, которая уже работает в Azure, он указывает настройки шифрования, чтобы включить шифрование на виртуальной машине IaaS.
3. Клиент предоставляет платформе Azure доступ на чтение материала ключа (ключи шифрования BitLocker для среды Windows или парольная фраза для Linux) из хранилища ключей, чтобы включить шифрование виртуальной машины IaaS.
4. Клиент предоставляет удостоверение приложения Azure AD, используемое для записи материала ключа шифрования в хранилище ключей, чтобы включить шифрование на виртуальной машине IaaS в сценариях, указанных в пункте 2 выше.
5. Azure вносит изменения в модель службы виртуальной машины на основе конфигурации шифрования и хранилища ключей, а затем подготавливает для клиента зашифрованную виртуальную машину.

![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig1.png)

### <a name="decryption-workflow"></a>Рабочий процесс расшифровки
Далее описаны основные шаги, которые нужно выполнить, чтобы отключить шифрование дисков виртуальной машины IaaS.

1. Клиент должен выбрать метод отключения шифрования (расшифровки) на виртуальной машине IaaS, работающей в Azure (при помощи шаблона Resource Manager для шифрования дисков Azure или командлетов PowerShell), и задать конфигурацию расшифровки.
2. На этом этапе для работающей виртуальной машины IaaS под управлением Windows отключается шифрование операционной системы и/или тома данных. Однако отключение шифрования диска операционной системы Linux с применением указанных выше методов не поддерживается. Отключить шифрование можно только для дисков данных на виртуальных машинах Linux. 
3. Azure обновляет модель службы виртуальной машины, и виртуальная машина IaaS помечается как расшифрованная. Содержимое виртуальной машины больше не шифруется при хранении.
4. При отключении операции шифрования хранилище ключей клиента и материал ключа шифрования (ключи шифрования BitLocker для Windows или парольная фраза для Linux) не удаляются.

## <a name="prerequisites"></a>Предварительные требования
Ниже перечислены обязательные условия для включения дискового шифрования Azure на виртуальных машинах Azure IaaS в соответствии со сценариями, перечисленными в разделе общих сведений.

* Необходима действующая подписка Azure, которая позволяет создавать ресурсы Azure в поддерживаемых регионах.
* Шифрование дисков Azure доступно для следующих номеров SKU Windows Server: Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2 и Windows Server 2016.
* Шифрование диска Azure поддерживается в клиентах Windows SKU для Windows 8 и Windows 10.

**Примечание.** Прежде чем включать шифрование Azure для Windows Server 2008 R2, необходимо установить .NET Framework 4.5. Для этого установите необязательное обновление Microsoft .NET Framework 4.5.2 для Windows Server 2008 R2 для 64-разрядных систем ([KB2901983](https://support.microsoft.com/kb/2901983)) из Центра обновления Windows.

* Шифрование дисков Azure доступно для следующих SKU Linux: Ubuntu, CentOS, SUSE, SUSE Linux Enterprise Server (SLES) и Red Hat Enterprise Linux.

**Примечание.** В настоящее время шифрование диска операционной системы Linux поддерживается для следующих дистрибутивов Linux: RHEL 7.2, CentOS 7.2, Ubuntu 16.04.

* Все ресурсы (хранилище ключей, учетная запись хранения, виртуальная машина, виртуальная сеть и т. д.) должны относиться к одному региону и одной подписке Azure.

**Примечание.** Для шифрования дисков Azure требуется, чтобы хранилище ключей и виртуальные машины находились в одном регионе Azure. Их настройка в отдельных регионах приведет к ошибкам при включении функции дискового шифрования Azure.

* Сведения об установке и настройке хранилища ключей Azure для использования шифрования дисков Azure см. в подразделе **Подключение и настройка хранилища ключей Azure для дискового шифрования Azure** раздела *Предварительные требования* этой статьи.
* Сведения об установке и настройке приложения Azure AD в Azure Active Directory для использования шифрования дисков Azure см. в подразделе **Настройка приложения Azure AD в Azure Active Directory** раздела *Предварительные требования* этой статьи.
* Сведения об установке и настройке политики доступа к хранилищу ключей для приложения Azure AD см. в подразделе **Настройка политики доступа к хранилищу ключей для приложения Azure AD** раздела *Предварительные требования* этой статьи.
* Сведения о подготовке предварительно зашифрованного виртуального жесткого диска Windows см. в разделе **Подготовка предварительно зашифрованного виртуального жесткого диска Windows** приложения к этой статье.
* Сведения о подготовке предварительно зашифрованного виртуального жесткого диска Linux см. в разделе **Подготовка предварительно зашифрованного виртуального жесткого диска Linux** приложения к этой статье.
* Платформа Azure должна иметь доступ к ключам шифрования или секретам, расположенным в клиентском хранилище ключей Azure. Это необходимо для загрузки и расшифровки тома операционной системы виртуальной машины. Чтобы предоставить платформе Azure разрешения на доступ к клиентскому хранилищу ключей, задайте для хранилища ключей свойство **enabledForDiskEncryption**. Дополнительные сведения см. в разделе **Подключение и настройка хранилища ключей Azure для дискового шифрования Azure** приложения к этой статье.
* Для URL-адресов секрета и ключа шифрования ключа (KEK) хранилища ключей необходимо включить управление версиями. Это требование Azure. Ниже приведены примеры допустимых URL-адресов секрета и KEK.
  * Пример допустимого URL-адреса секрета:   *https://contosovault.vault.azure.net/secrets/BitLockerEncryptionSecretWithKek/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.
  * Пример допустимого ключа шифрования ключей для ключа восстановления ключей:   *https://contosovault.vault.azure.net/keys/diskencryptionkek/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.
* Шифрование диска Azure не поддерживает указание номеров портов в URL-адресах секрета и KEK хранилища ключей. Ниже приведены примеры поддерживаемых URL-адресов хранилища ключей.
  * Недопустимый URL-адрес хранилища ключей:  *https://contosovault.vault.azure.net:443/secrets/contososecret/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.
    * Допустимый URL-адрес хранилища ключей: *https://contosovault.vault.azure.net/secrets/contososecret/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*.
* Чтобы использовать функцию дискового шифрования Azure, конфигурация конечной точки VM IaaS должна соответствовать следующим требованиям: 
  * Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке Azure Active Directory \[Login.windows.net\], чтобы получить маркер для подключения к хранилищу ключей Azure.
  * Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке хранилища ключей Azure, чтобы записать ключи шифрования в хранилище ключей клиента.
  * Виртуальная машина IaaS должна иметь возможность подключиться к конечной точке хранилища Azure, в котором размещен репозиторий расширений Azure, и к учетной записи хранения Azure, в которой размещены файлы виртуального жесткого диска.

**Примечание.** Если ваша политика безопасности ограничивает доступ к Интернету из виртуальных машин Azure, можно разрешить указанный выше URI, с которым требуется взаимодействовать, и настроить определенное правило, чтобы разрешить исходящие подключения к данным IP-адресам.

* Для настройки шифрования диска Azure используйте последнюю версию пакета SDK для Azure PowerShell. Скачайте последнюю версию [Azure PowerShell](https://github.com/Azure/azure-powershell/releases).

**Примечание.** Шифрование дисков Azure не поддерживается в [пакете SDK для Azure PowerShell версии 1.1.0](https://github.com/Azure/azure-powershell/releases/tag/v1.1.0-January2016). При возникновении ошибок, связанных с использованием Azure PowerShell 1.1.0, ознакомьтесь с записью блога [Azure Disk Encryption Error Related to Azure PowerShell 1.1.0](http://blogs.msdn.com/b/azuresecurity/archive/2016/02/10/azure-disk-encryption-error-related-to-azure-powershell-1-1-0.aspx) (Ошибки шифрования дисков Azure, связанные с Azure PowerShell 1.1.0).

* Чтобы запустить какую-либо команду Azure CLI и связать ее с подпиской Azure, необходимо установить версию Azure CLI.
  * Чтобы установить Azure CLI и связать его с подпиской Azure, см. [эту статью](../xplat-cli-install.md).
  * Использование Azure CLI для Mac, Linux и Windows с Azure Resource Manager описано [здесь](../virtual-machines/azure-cli-arm-commands.md).
* Решение дискового шифрования Azure использует предохранитель внешнего ключа BitLocker для виртуальных машин IaaS под управлением Windows. Если ваши виртуальные машины объединены в домен, не применяйте групповые политики, требующие использования предохранителей TPM. Изучите [эту статью](https://technet.microsoft.com/library/ee706521), чтобы узнать о групповой политике "Разрешить использование BitLocker без совместимого TPM".
* Чтобы создать приложение Azure AD, создать хранилище ключей или настроить имеющееся, а также включить шифрование, требуется сценарий PowerShell для шифрования дисков Azure, который находится [здесь](https://github.com/Azure/azure-powershell/blob/dev/src/ResourceManager/Compute/Commands.Compute/Extension/AzureDiskEncryption/Scripts/AzureDiskEncryptionPreRequisiteSetup.ps1).

#### <a name="setup-the-azure-ad-application-in-azure-active-directory"></a>Настройка приложения Azure AD в Azure Active Directory
Если шифрование нужно включить на виртуальной машине, уже работающей в Azure, функция дискового шифрования Azure создает ключи шифрования и сохраняет их в хранилище ключей. Чтобы управлять ключами шифрования в хранилище ключей, нужно пройти проверку подлинности Azure AD.

Для этой цели следует создать приложение Azure AD. Подробные инструкции по регистрации приложения можно найти в разделе "Получение удостоверения для приложения" этой [записи блога](http://blogs.technet.com/b/kv/archive/2015/06/02/azure-key-vault-step-by-step.aspx).  В этой записи вы также найдете несколько полезных примеров подготовки и настройки хранилища ключей. Можно использовать проверку подлинности на основе секрета клиента или на основе сертификата клиента в Azure AD.

##### <a name="client-secret-based-authentication-for-azure-ad"></a>Проверка подлинности в Azure AD на основе секрета клиента
В следующем разделе описаны действия, необходимые для настройки проверки подлинности в Azure AD на основе секрета клиента.

##### <a name="create-a-new-azure-ad-app-using-azure-powershell"></a>Создание нового приложения Azure AD с помощью Azure PowerShell
Используйте этот командлет PowerShell, чтобы создать новое приложение Azure AD:

    $aadClientSecret = “yourSecret”
    $azureAdApplication = New-AzureRmADApplication -DisplayName "<Your Application Display Name>" -HomePage "<https://YourApplicationHomePage>" -IdentifierUris "<https://YouApplicationUri>" -Password $aadClientSecret
    $servicePrincipal = New-AzureRmADServicePrincipal –ApplicationId $azureAdApplication.ApplicationId

**Примечание.** $azureAdApplication.ApplicationId — это идентификатор ClientID Azure AD, а $aadClientSecret — секрет клиента, который потребуется позднее для включения дискового шифрования Azure. Секрет клиента Azure AD следует хранить с соблюдением мер предосторожности.

##### <a name="provisioning-the-azure-ad-client-id-and-secret-from-the-azure-classic-deployment-model-portal"></a>Подготовка идентификатора и секрета клиента Azure AD на портале классической модели развертывания Azure
Идентификатор и секрет клиента Azure AD можно подготовить также с помощью портала классической модели развертывания Azure по адресу https://manage.windowsazure.com. Для этого нужно сделать следующее:

1. Перейдите на вкладку Active Directory, как показано ниже.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig3.png)

2. Нажмите кнопку «Добавить приложение» и введите имя приложения.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig4.png)

3. Нажмите кнопку со стрелкой и настройте свойства приложения, как показано ниже.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig5.png)

4. Щелкните флажок в правом нижнем углу, чтобы завершить процесс. Отобразится страница конфигурации приложения. Обратите внимание, что в нижней части страницы есть идентификатор клиента Azure AD, как показано ниже.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig6.png)

5. Сохраните секрет клиента Azure AD, щелкнув кнопку «Сохранить». Нажмите кнопку "Сохранить" и запишите секретный код из текстового поля ключа. Это и есть секрет клиента Azure AD. Секрет клиента Azure AD следует хранить с соблюдением мер предосторожности.

![Дисковое шифрование Azure](./media/azure-security-disk-encryption/disk-encryption-fig7.png)

**Примечание.** Описанный выше процесс не поддерживается на портале.

##### <a name="use-an-existing-app"></a>Использование существующего приложения
Для выполнения команд, приведенных ниже, вам потребуется модуль PowerShell Azure AD, который можно получить [здесь](https://technet.microsoft.com/library/jj151815.aspx).

**Примечание.** Эти команды нужно выполнять в новом окне PowerShell. Не вводите эти команды в окне Azure PowerShell или в окне диспетчера ресурсов Azure. Дело в том, что эти командлеты находятся в модуле MSOnline или PowerShell Azure AD.

    $clientSecret = ‘<yourAadClientSecret>’
    $aadClientID = '<Client ID of your AAD app>'
    connect-msolservice
    New-MsolServicePrincipalCredential -AppPrincipalId $aadClientID -Type password -Value $clientSecret

#### <a name="certificate-based-authentication-for-azure-ad"></a>Проверка подлинности в Azure AD на основе сертификата
> [!NOTE]
> В настоящее время проверка подлинности на основе сертификата AAD на виртуальных машинах Linux не поддерживается.
> 
> 

В следующем разделе описаны действия, необходимые для настройки проверки подлинности в Azure AD на основе сертификата.

##### <a name="create-a-new-azure-ad-app"></a>Создание нового приложения Azure AD
Выполните эти командлеты PowerShell, чтобы создать новое приложение Azure AD:

**Примечание.** Замените строку `yourpassword` в приведенном ниже коде на свой надежный пароль и обеспечьте защиту этого пароля.

    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate("C:\certificates\examplecert.pfx", "yourpassword")
    $keyValue = [System.Convert]::ToBase64String($cert.GetRawCertData())
    $azureAdApplication = New-AzureRmADApplication -DisplayName "<Your Application Display Name>" -HomePage "<https://YourApplicationHomePage>" -IdentifierUris "<https://YouApplicationUri>" -KeyValue $keyValue -KeyType AsymmetricX509Cert
    $servicePrincipal = New-AzureRmADServicePrincipal –ApplicationId $azureAdApplication.ApplicationId

Завершив этот шаг, передайте PFX-файл в хранилище ключей и включите политику доступа, которая необходима для развертывания этого сертификата на виртуальной машине.

##### <a name="use-an-existing-azure-ad-app"></a>Использование существующего приложения Azure AD
Если вы настраиваете проверку подлинности на основе сертификата для существующего приложения, используйте приведенные ниже командлеты PowerShell. Обязательно выполняйте их в новом окне PowerShell.

    $certLocalPath = 'C:\certs\myaadapp.cer'
    $aadClientID = '<Client ID of your AAD app>'
    connect-msolservice
    $cer = New-Object System.Security.Cryptography.X509Certificates.X509Certificate
    $cer.Import($certLocalPath)
    $binCert = $cer.GetRawCertData()
    $credValue = [System.Convert]::ToBase64String($binCert);
    New-MsolServicePrincipalCredential -AppPrincipalId $aadClientID -Type asymmetric -Value $credValue -Usage verify

Завершив этот шаг, передайте PFX-файл в хранилище ключей и включите политику доступа, которая необходима для развертывания этого сертификата на виртуальной машине.

##### <a name="upload-a-pfx-file-to-key-vault"></a>Передача PFX-файла в хранилище ключей
Вы можете ознакомиться с [записью блога](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx), где подробно описана суть этого процесса. Чтобы его выполнить, вам потребуются только командлеты PowerShell, которые приведены ниже. Обязательно выполняйте их из консоли Azure PowerShell:

**Примечание.** Замените строку `yourpassword` в приведенном ниже коде на свой надежный пароль и обеспечьте защиту этого пароля.

    $certLocalPath = 'C:\certs\myaadapp.pfx'
    $certPassword = "yourpassword"
    $resourceGroupName = ‘yourResourceGroup’
    $keyVaultName = ‘yourKeyVaultName’
    $keyVaultSecretName = ‘yourAadCertSecretName’

    $fileContentBytes = get-content $certLocalPath -Encoding Byte
    $fileContentEncoded = [System.Convert]::ToBase64String($fileContentBytes)

    $jsonObject = @"
    {
    "data": "$filecontentencoded",
    "dataType" :"pfx",
    "password": "$certPassword"
    }
    "@

    $jsonObjectBytes = [System.Text.Encoding]::UTF8.GetBytes($jsonObject)
    $jsonEncoded = [System.Convert]::ToBase64String($jsonObjectBytes)

    Switch-AzureMode -Name AzureResourceManager
    $secret = ConvertTo-SecureString -String $jsonEncoded -AsPlainText -Force
    Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecretName -SecretValue $secret
    Set-AzureRmKeyVaultAccessPolicy -VaultName $keyVaultName -ResourceGroupName $resourceGroupName –EnabledForDeployment

##### <a name="deploy-a-certificate-in-key-vault-to-an-existing-vm"></a>Развертывание сертификата из хранилища ключей на существующей виртуальной машине
Передав PFX-файл, выполните следующие действия, чтобы развернуть сертификат из хранилища ключей на существующей виртуальной машине.

    $resourceGroupName = ‘yourResourceGroup’
    $keyVaultName = ‘yourKeyVaultName’
    $keyVaultSecretName = ‘yourAadCertSecretName’
    $vmName = ‘yourVMName’
    $certUrl = (Get-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecretName).Id
    $sourceVaultId = (Get-AzureRmKeyVault -VaultName $keyVaultName -ResourceGroupName $resourceGroupName).ResourceId
    $vm = Get-AzureRmVM -ResourceGroupName $resourceGroupName -Name $vmName
    $vm = Add-AzureRmVMSecret -VM $vm -SourceVaultId $sourceVaultId -CertificateStore "My" -CertificateUrl $certUrl
    Update-AzureRmVM -VM $vm  -ResourceGroupName $resourceGroupName


#### <a name="setting-key-vault-access-policy-for-the-azure-ad-application"></a>Настройка политики доступа к хранилищу ключей для приложения Azure AD
Приложению Azure AD нужны права на доступ к ключам и секретам, которые размещены в хранилище. Используйте командлет [Set-AzureKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/dn903607.aspx), чтобы предоставить приложению необходимые разрешения. Здесь в качестве значения параметра –ServicePrincipalName следует использовать идентификатор клиента, созданный при регистрации приложения. Примеры такой операции можно найти в [этой записи блога](http://blogs.technet.com/b/kv/archive/2015/06/02/azure-key-vault-step-by-step.aspx). Ниже также приведен пример того, как выполнить эту задачу с помощью PowerShell:

    $keyVaultName = '<yourKeyVaultName>'
    $aadClientID = '<yourAadAppClientID>'
    $rgname = '<yourResourceGroup>'
    Set-AzureRmKeyVaultAccessPolicy -VaultName $keyVaultName -ServicePrincipalName $aadClientID -PermissionsToKeys 'WrapKey' -PermissionsToSecrets 'Set' -ResourceGroupName $rgname

**Примечание.** Для шифрования дисков Azure требуется настроить в клиентском приложении AAD следующие политики доступа: разрешения WrapKey и Set.

## <a name="terminology"></a>Терминология
Эта таблица терминов позволит вам понять некоторые общие термины, которые применяются в этой технологии.

| Терминология | Определение |
| --- | --- |
| Azure AD |Azure AD — это сокращенное обозначение [Azure Active Directory](https://azure.microsoft.com/documentation/services/active-directory/). Учетная запись Azure AD необходима для проверки подлинности, хранения и извлечения секретов из хранилища ключей. |
| Хранилище ключей Azure [AKV] |Хранилище ключей Azure представляет собой службу управления криптографическими ключами. Она основана на аппаратных модулях безопасности, подтвержденных FIPS, и позволяет надежно хранить криптографические ключи и конфиденциальные данные. Подробнее служба описана в документации по [хранилищу ключей](https://azure.microsoft.com/services/key-vault/). |
| ARM |Диспетчер ресурсов Azure |
| BitLocker |[BitLocker](https://technet.microsoft.com/library/hh831713.aspx) является общепризнанной отраслевой технологией шифрования томов Windows, используемой при дисковом шифровании на виртуальных машинах IaaS Windows. |
| BEK |Ключи шифрования BitLocker (BEK) используются для шифрования загрузочного тома ОС и томов данных. Ключи BitLocker хранятся в клиентском хранилище ключей Azure в виде секретов. |
| Интерфейс командной строки |[Интерфейс командной строки Azure](../xplat-cli-install.md) |
| DM-Crypt |[DM-Crypt](https://en.wikipedia.org/wiki/Dm-crypt) — прозрачная подсистема дискового шифрования на платформе Linux, использующаяся для дискового шифрования на виртуальных машинах IaaS Linux. |
| KEK |Ключ шифрования ключа представляет собой асимметричный ключ (RSA 2048), который применяется для защиты секрета или помещения его в оболочку. Вы можете использовать защищенный HSM-ключ или ключ с программной защитой. Дополнительные сведения см. в документации по [хранилищу ключей Azure](https://azure.microsoft.com/services/key-vault/). |
| Командлеты PS |[Командлеты Azure PowerShell](../powershell-install-configure.md) |

### <a name="setting-and-configuring-azure-key-vault-for-azure-disk-encryption-usage"></a>Подключение и настройка хранилища ключей Azure для дискового шифрования Azure
Дисковое шифрование Azure хранит ключи дискового шифрования и секреты в вашем хранилище ключей Azure. Выполните действия, указанные в каждом из разделов ниже, чтобы настроить хранилище ключей для использования с дисковым шифрованием Azure.

#### <a name="create-a-new-key-vault"></a>Создание нового хранилища ключей
Чтобы создать хранилище ключей, используйте одно из следующих средств:

* шаблон Resource Manager 101-Create-KeyVault, размещенный [здесь](https://github.com/Azure/azure-quickstart-templates/blob/master/101-create-key-vault/azuredeploy.json);
* [командлеты PowerShell хранилища ключей Azure](https://msdn.microsoft.com/library/dn868052.aspx);
* портал Azure Resource Manager.

**Примечание.** Если для вашей подписки уже настроено хранилище ключей, перейдите к следующему разделу.

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig1.png)

#### <a name="provisioning-a-key-encryption-key-optional"></a>Подготовка ключа шифрования ключа (необязательно)
Если вы хотите использовать ключ шифрования ключа (KEK), добавьте в хранилище ключей KEK, который будет использован в процессе подготовки. KEK используется как оболочка для ключей шифрования BitLocker, дополнительно повышающая безопасность.  Используйте командлет [Add-AzureKeyVaultKey](https://msdn.microsoft.com/library/dn868048.aspx), чтобы создать ключ шифрования ключа в хранилище ключей. Кроме того, KEK можно импортировать из своего аппаратного модуля безопасности локальной службы управления ключами. Дополнительные сведения см. в [документации по хранилищу ключей](https://azure.microsoft.com/documentation/services/key-vault/).

    Add-AzureKeyVaultKey [-VaultName] <string> [-Name] <string> -Destination <string> {HSM | Software}

KEK можно добавить на портале Azure Resource Manager, а также через интерфейс хранилища ключей Azure.

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig2.png)

#### <a name="set-key-vault-permissions-to-allow-the-azure-platform-access-to-the-keys-and-secrets"></a>Настройка разрешений для хранилища ключей, предоставляющих платформе Azure доступ к ключам и секретам
Платформа Azure должна иметь доступ к ключам шифрования или секретам, которые расположены в хранилище ключей Azure. Это необходимо для загрузки и расшифровки томов виртуальной машины. Чтобы предоставить платформе Azure доступ к хранилищу ключей, задайте свойство *enabledForDiskEncryption* для хранилища ключей. Это можно сделать с помощью командлета PS хранилища ключей:

    Set-AzureRmKeyVaultAccessPolicy -VaultName <yourVaultName> -ResourceGroupName <yourResourceGroup> -EnabledForDiskEncryption

Кроме того, свойство *enabledForDiskEncryption* также можно задать на странице https://resources.azure.com. Для хранилища ключей следует задать свойство *enabledForDiskEncryption*, как указано выше. В противном случае подготовка завершится с ошибкой.

Политики доступа для приложения AAD можно настроить через интерфейс хранилища ключей.

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig3.png)

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig3b.png)

В разделе "Политики расширенного доступа" включите шифрование дисков для хранилища ключей.

![Хранилище ключей Azure](./media/azure-security-disk-encryption/keyvault-portal-fig4.png)

## <a name="disk-encryption-deployment-scenarios-and-user-experiences"></a>Сценарии развертывания дискового шифрования и взаимодействие с пользователем
Есть несколько сценариев включения дискового шифрования, и последовательность действий будет для них различной. В последующих разделах эти сценарии рассматриваются подробнее.

### <a name="enable-encryption-on-new-iaas-vms-created-from-the-azure-gallery"></a>Включение шифрования для новых виртуальных машин IaaS, созданных из коллекции Azure
Шифрование дисков можно включить для новой виртуальной машины IaaS под управлением Windows, созданной из коллекции Azure, с помощью шаблона Resource Manager, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-create-new-vm-gallery-image). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для новой виртуальной машины IaaS.

**Примечание.** Этот шаблон создает зашифрованную виртуальную машину Windows на основе образа из коллекции Windows Server 2012.

Шифрование дисков на новой виртуальной машине IaaS RedHat Linux 7.2 с 200 ГБ памяти и поддержкой массива RAID-0 можно включить с помощью шаблона Resource Manager, представленного [здесь](https://aka.ms/fde-rhel). После развертывания шаблона проверьте состояние шифрования виртуальной машины с помощью командлета `Get-AzureRmVmDiskEncryptionStatus`, как описано в разделе [Шифрование диска операционной системы на работающей виртуальной машине Linux](#encrypting-os-drive-on-a-running-linux-vm). Когда компьютер вернет состояние `VMRestartPending`, перезапустите виртуальную машину.

В следующей таблице описаны параметры шаблона Resource Manager для сценария создания виртуальной машины из коллекции Azure с помощью идентификатора клиента Azure AD.

| Параметр | Описание |
| --- | --- |
| adminUserName |Имя пользователя администратора виртуальной машины |
| adminPassword |Пароль администратора виртуальной машины |
| newStorageAccountName |Имя учетной записи хранения, в которой будут размещены виртуальные жесткие диски операционной системы и данных |
| vmSize |Размер виртуальной машины. Сейчас поддерживаются только серии A, D и G категории «Стандартный» |
| virtualNetworkName |Имя виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины |
| subnetName |Имя подсети виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины |
| AADClientID |Идентификатор клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| AADClientSecret |Секрет клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| keyVaultURL |URL-адрес хранилища ключей, в которое будет передан ключ BitLocker. Значение этого параметра можно получить с помощью командлета PowerShell: (Get-AzureRmKeyVault -VaultName,-ResourceGroupName).VaultURI |
| keyEncryptionKeyURL |URL-адрес ключа шифрования ключа, который используется для шифрования созданного ключа BitLocker. Это необязательно. |
| keyVaultResourceGroup |Группа ресурсов хранилища ключей |
| vmName |Имя виртуальной машины, на которой будет выполняться шифрование |

**Примечание.** KeyEncryptionKeyURL является необязательным параметром. Вы можете добавить собственный ключ шифрования ключа, чтобы дополнительно защитить ключ шифрования данных (секрет в виде парольной фразы) в хранилище ключей.

### <a name="enable-encryption-on-new-iaas-vms-created-from-customer-encrypted-vhd-and-encryption-keys"></a>Включение шифрования для новых виртуальных машин IaaS, при создании которых используются зашифрованные виртуальные жесткие диски и ключи шифрования
В этом сценарии шифрование можно включить с помощью шаблона Resource Manager, командлетов PowerShell или команд интерфейса командной строки. В следующих разделах подробно описаны шаблон Resource Manager и команды интерфейса командной строки.

Следуйте инструкциям, приведенным в одном из этих разделов, чтобы подготовить предварительно зашифрованные образы, которые можно использовать в Azure. Затем выполните действия, описанные в следующем разделе, чтобы создать зашифрованную виртуальную машину Azure.

* [Подготовка предварительно зашифрованного виртуального жесткого диска Windows](#preparing-a-pre-encrypted-windows-vhd)
* [Подготовка предварительно зашифрованного виртуального жесткого диска Linux](#preparing-a-pre-encrypted-linux-vhd)

#### <a name="using-resource-manager-template"></a>Шаблон Resource Manager
Шифрование дисков для клиентского зашифрованного виртуального диска можно включить, используя шаблон Resource Manager, опубликованный [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-create-pre-encrypted-vm). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для новой виртуальной машины IaaS.

В следующей таблице описаны параметры шаблона Resource Manager для сценария с использованием клиентского зашифрованного виртуального диска.

| Параметр | Описание |
| --- | --- |
| newStorageAccountName |Имя учетной записи хранения, в которой будет размещен зашифрованный виртуальный жесткий диск операционной системы. Эта учетная запись хранения уже должна быть создана в той же группе ресурсов и в том же расположении, что и виртуальная машина |
| osVhdUri |URI виртуального жесткого диска ОС в учетной записи хранения |
| osType |Тип продукта ОС (Windows, Linux) |
| virtualNetworkName |Имя виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины Она должна уже быть создана в той же группе ресурсов и в том же расположении, что и виртуальная машина |
| subnetName |Имя подсети виртуальной сети, к которой будет принадлежать сетевой адаптер виртуальной машины |
| vmSize |Размер виртуальной машины. Сейчас поддерживаются только серии A, D и G категории «Стандартный» |
| keyVaultResourceID |Идентификатор ресурса, который обозначает конкретный ресурс хранилища ключей в ARM. Значение этого параметра можно получить с помощью командлета PowerShell: (Get-AzureRmKeyVault -VaultName &lt;yourKeyVaultName&gt; -ResourceGroupName &lt;yourResourceGroupName&gt;).ResourceId |
| keyVaultSecretUrl |URL-адрес ключа дискового шифрования, подготовленного в хранилище ключей |
| keyVaultKekUrl |URL-адрес ключа шифрования ключа, с помощью которого шифруется созданный ключ шифрования диска |
| vmName |Имя виртуальной машины IaaS |

#### <a name="using-powershell-cmdlets"></a>Использование командлетов PowerShell
Дисковое шифрование для клиентского зашифрованного виртуального диска можно включить с помощью командлетов PowerShell, опубликованных [здесь](https://msdn.microsoft.com/library/azure/mt603746.aspx).  

#### <a name="using-cli-commands"></a>С помощью команд CLI
Выполните следующие действия, чтобы включить шифрование диска с помощью команд CLI.

1. Задайте политики доступа к хранилищу ключей:
   * Установите флажок EnabledForDiskEncryption: `azure keyvault set-policy --vault-name <keyVaultName> --enabled-for-disk-encryption true`.
   * Предоставьте приложению Azure AD разрешения на запись секретов в хранилище ключей: `azure keyvault set-policy --vault-name <keyVaultName> --spn <aadClientID> --perms-to-keys [\"all\"] --perms-to-secrets [\"all\"]`.
2. Чтобы включить шифрование на имеющейся или работающей виртуальной машине, введите команду:  *azure vm enable-disk-encryption --resource-group <resourceGroupName> --name <vmName> --aad-client-id <aadClientId> --aad-client-secret <aadClientSecret> --disk-encryption-key-vault-url <keyVaultURL> --disk-encryption-key-vault-id <keyVaultResourceId>*.
3. Узнайте состояние шифрования: *azure vm show-disk-encryption-status --resource-group <resourceGroupName> --name <vmName> --json*.
4. Чтобы включить шифрование на новой виртуальной машине с использованием клиентского зашифрованного виртуального жесткого диска, используйте команду azure vm create с такими параметрами:
   * disk-encryption-key-vault-id <ИД_хранилища_ключей_для_шифрования_дисков>
   * disk-encryption-key-url <URL-адрес_хранилища_ключей_для_шифрования_дисков>
   * key-encryption-key-vault-id <ИД_хранилища_ключей_для_шифрования_кючей>
   * key-encryption-key-url <URL-адрес_хранилища_ключей_для_шифрования_ключей>

### <a name="enable-encryption-on-existing-or-running-iaas-windows-vm-in-azure"></a>Включение шифрования на виртуальной машине IaaS Windows, которая уже существует или работает в Azure
В этом сценарии шифрование можно включить с помощью шаблона Resource Manager, командлетов PowerShell или команд интерфейса командной строки. В следующем разделе подробно описано, как это сделать с помощью шаблона Resource Manager и команд CLI.

#### <a name="using-resource-manager-template"></a>Шаблон Resource Manager
Шифрование дисков можно включить для виртуальной машины IaaS под управлением Windows, которая уже существует или работает в Azure, с помощью шаблона Resource Manager, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-running-windows-vm). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для существующей или работающей виртуальной машины IaaS.

В следующей таблице описаны параметры шаблона Resource Manager для сценария шифрования виртуальной машины, которая уже существует или работает, с помощью идентификатора клиента Azure AD.

| Параметр | Описание |
| --- | --- |
| AADClientID |Идентификатор клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| AADClientSecret |Секрет клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| keyVaultName |Имя хранилища ключей, в которое будет передан ключ BitLocker. Значение этого параметра можно получить с помощью командлета: (Get-AzureRmKeyVault -ResourceGroupName<yourResourceGroupName>). Vaultname |
|  keyEncryptionKeyURL |URL-адрес ключа шифрования ключа, который используется для шифрования созданного ключа BitLocker. Это необязательный параметр, если выбрать `nokek` в раскрывающемся списке UseExistingKek. При выборе `kek` требуется указать значение keyEncryptionKeyURL. |
| volumeType |Тип тома, для которого будет выполняться шифрование. Допустимые значения: «ОС», «Данные», «Все» |
| sequenceVersion |Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда шифрование диска выполняется на той же VM |
| vmName |Имя виртуальной машины, на которой будет выполняться шифрование |

**Примечание.** KeyEncryptionKeyURL является необязательным параметром. Вы можете добавить собственный ключ шифрования ключа, чтобы дополнительно защитить ключ шифрования данных (секрет шифрования BitLocker) в хранилище ключей.

#### <a name="using-powershell-cmdlets"></a>Использование командлетов PowerShell
Дополнительные сведения о том, как включить шифрование на базе дискового шифрования Azure с помощью командлетов PowerShell, см. в [части 1](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/17/explore-azure-disk-encryption-with-azure-powershell.aspx) и [части 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx) записи блога **Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell**.

#### <a name="using-cli-commands"></a>С помощью команд CLI
Выполните следующие действия, чтобы включить шифрование на виртуальной машине IaaS Windows, которая уже существует или работает в Azure, с помощью команд CLI:

1. Задайте политики доступа к хранилищу ключей:
   * Задайте флаг "EnabledForDiskEncryption": azure keyvault set-policy --vault-name <keyVaultName> --enabled-for-disk-encryption true.
   * Предоставьте приложению Azure AD разрешения на запись секретов в хранилище ключей: azure keyvault set-policy --vault-name <keyVaultName> --spn <aadClientID> --perms-to-keys [\"all\"] --perms-to-secrets [\"all\"].
2. Чтобы включить шифрование на имеющейся или работающей виртуальной машине, введите команду:  *azure vm enable-disk-encryption --resource-group <resourceGroupName> --name <vmName> --aad-client-id <aadClientId> --aad-client-secret <aadClientSecret> --disk-encryption-key-vault-url <keyVaultURL> --disk-encryption-key-vault-id <keyVaultResourceId>*.
3. Узнайте состояние шифрования: *azure vm show-disk-encryption-status --resource-group <resourceGroupName> --name <vmName> --json*.
4. Чтобы включить шифрование на новой виртуальной машине с использованием клиентского зашифрованного виртуального жесткого диска, используйте команду azure vm create с такими параметрами:
   * disk-encryption-key-vault-id <ИД_хранилища_ключей_для_шифрования_дисков>
   * disk-encryption-key-url <URL-адрес_хранилища_ключей_для_шифрования_дисков>
   * key-encryption-key-vault-id <ИД_хранилища_ключей_для_шифрования_кючей>
   * key-encryption-key-url <URL-адрес_хранилища_ключей_для_шифрования_ключей>

### <a name="enable-encryption-on-existing-or-running-iaas-linux-vm-in-azure"></a>Включение шифрования на виртуальной машине IaaS Linux, которая уже существует или работает в Azure
Шифрование дисков можно включить для виртуальной машины IaaS под управлением Linux, которая уже существует или работает в Azure, с помощью шаблона Resource Manager, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-encrypt-running-linux-vm). В шаблоне быстрого запуска Azure нажмите кнопку «Развернуть в Azure», введите параметры шифрования в колонке параметров и нажмите кнопку «ОК». Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для существующей или работающей виртуальной машины IaaS.

В следующей таблице описаны параметры шаблона Resource Manager для сценария шифрования виртуальной машины, которая уже существует или работает, с помощью идентификатора клиента Azure AD.

| Параметр | Описание |
| --- | --- |
| AADClientID |Идентификатор клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| AADClientSecret |Секрет клиента приложения Azure AD, который имеет разрешения на запись секретов в хранилище ключей |
| keyVaultName |Имя хранилища ключей, в которое будет передан ключ BitLocker. Значение этого параметра можно получить с помощью командлета: (Get-AzureRmKeyVault -ResourceGroupName<yourResourceGroupName>). Vaultname |
|  keyEncryptionKeyURL |URL-адрес ключа шифрования ключа, который используется для шифрования созданного ключа BitLocker. Это необязательный параметр, если выбрать nokek в раскрывающемся списке UseExistingKek. При выборе kek в раскрывающемся списке UseExistingKek требуется указать значение keyEncryptionKeyURL |
| volumeType |Тип тома, для которого будет выполняться шифрование. Поддерживаемые допустимые значения: "ОС" или "Все" (для RHEL 7.2, CentOS 7.2 и Ubuntu 16.04) и "Данные" (для всех остальных дистрибутивов). |
| sequenceVersion |Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда шифрование диска выполняется на той же VM |
| vmName |Имя виртуальной машины, на которой будет выполняться шифрование |
| passPhrase |Введите надежную парольную фразу, которая будет служить ключом шифрования |

**Примечание.** KeyEncryptionKeyURL является необязательным параметром. Вы можете добавить собственный ключ шифрования ключа, чтобы дополнительно защитить ключ шифрования данных (секрет в виде парольной фразы) в хранилище ключей.

#### <a name="cli-commands"></a>Команды CLI
Дисковое шифрование для клиентского зашифрованного виртуального диска можно включить с помощью команды интерфейса командной строки (сведения об установке интерфейса командной строки см. [здесь](../xplat-cli-install.md)). Выполните следующие действия, чтобы включить шифрование на виртуальной машине IaaS Linux, которая уже существует или работает в Azure, с помощью команд CLI.

1. Задайте политики доступа к хранилищу ключей:
   * Задайте флаг "EnabledForDiskEncryption": azure keyvault set-policy --vault-name <keyVaultName> --enabled-for-disk-encryption true.
   * Предоставьте приложению Azure AD разрешения на запись секретов в хранилище ключей: azure keyvault set-policy --vault-name <keyVaultName> --spn <aadClientID> --perms-to-keys [\"all\"] --perms-to-secrets [\"all\"].
2. Чтобы включить шифрование на имеющейся или работающей виртуальной машине, введите команду:  *azure vm enable-disk-encryption --resource-group <resourceGroupName> --name <vmName> --aad-client-id <aadClientId> --aad-client-secret <aadClientSecret> --disk-encryption-key-vault-url <keyVaultURL> --disk-encryption-key-vault-id <keyVaultResourceId>*.
3. Узнайте состояние шифрования: azure vm show-disk-encryption-status --resource-group <resourceGroupName> --name <vmName> --json.
4. Чтобы включить шифрование на новой виртуальной машине с использованием клиентского зашифрованного виртуального жесткого диска, используйте команду azure vm create с такими параметрами:
   * *disk-encryption-key-vault-id <идентификатор_хранилища_ключей_для_шифрования_дисков>*
   * *disk-encryption-key-url <URL-адрес_хранилища_ключей_для_шифрования_дисков>*
   * *key-encryption-key-vault-id <идентификатор_хранилища_ключей_для_шифрования_кючей>*
   * *key-encryption-key-url <URL-адрес_хранилища_ключей_для_шифрования_ключей>*

### <a name="get-encryption-status-of-an-encrypted-iaas-vm"></a>Получение состояния шифрования зашифрованной виртуальной машины IaaS
Состояние шифрования можно узнать на портале Azure Resource Manager, а также с помощью [командлетов PowerShell](https://msdn.microsoft.com/library/azure/mt622700.aspx) или команд интерфейса командной строки. В разделах ниже описано, как использовать портал Azure и команды CLI, чтобы получить состояние шифрования.

#### <a name="get-encryption-status-of-an-encrypted-windows-vm-using-azure-resource-manager-portal"></a>Получение состояния шифрования зашифрованной виртуальной машины Windows на портале Azure Resource Manager
Состояние шифрования виртуальной машины IaaS можно узнать на портале Azure Resource Manager. Войдите на портал Azure по адресу https://portal.azure.com/ и щелкните ссылку "Виртуальные машины" в меню слева. Отобразится сводное представление всех виртуальных машин в вашей подписке. Вы можете отфильтровать представление виртуальных машин, выбрав имя подписки из раскрывающегося списка подписок. Щелкните «Столбцы» в верхней части страницы «Виртуальные машины». В колонке выбора столбца выберите столбец «Шифрование диска» и нажмите кнопку «Обновить». Вы увидите, что в столбце шифрования диска отображается состояние шифрования («Включено» или «Не включено») для каждой виртуальной машины, как показано на рисунке ниже.

![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig2.png)

#### <a name="get-encryption-status-of-an-encrypted-windowslinux-iaas-vm-using-disk-encryption-ps-cmdlet"></a>Получение состояния шифрования зашифрованной виртуальной машины IaaS (под управлением Windows или Linux) с помощью командлетов PowerShell для шифрования дисков
Состояние шифрования для VM IaaS можно узнать с помощью командлета PS дискового шифрования Get-AzureRmVMDiskEncryptionStatus. Чтобы получить параметры шифрования виртуальной машины, введите в сеансе Azure PowerShell следующую команду:

    C:\> Get-AzureRmVmDiskEncryptionStatus  -ResourceGroupName $ResourceGroupName -VMName $VMName
    -ExtensionName $ExtensionName

    OsVolumeEncrypted          : NotEncrypted
    DataVolumesEncrypted       : Encrypted
    OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
    ProgressMessage            : https://rheltest1keyvault.vault.azure.net/secrets/bdb6bfb1-5431-4c28-af46-b18d0025ef2a/abebacb83d864a5fa729508315020f8a

В выходных данных Get-AzureRmVMDiskEncryptionStatus можно получить URL-адреса ключей шифрования.

    C:\> $status = Get-AzureRmVmDiskEncryptionStatus  -ResourceGroupName $ResourceGroupName -VMNam
    e $VMName -ExtensionName $ExtensionName
    C:\> $status.OsVolumeEncryptionSettings

    DiskEncryptionKey                                                 KeyEncryptionKey                                               Enabled
    -----------------                                                 ----------------                                               -------
    Microsoft.Azure.Management.Compute.Models.KeyVaultSecretReference Microsoft.Azure.Management.Compute.Models.KeyVaultKeyReference    True


    C:\> $status.OsVolumeEncryptionSettings.DiskEncryptionKey.SecretUrl
    https://rheltest1keyvault.vault.azure.net/secrets/bdb6bfb1-5431-4c28-af46-b18d0025ef2a/abebacb83d864a5fa729508315020f8a
    C:\> $status.OsVolumeEncryptionSettings.DiskEncryptionKey

    SecretUrl                                                                                                               SourceVault
    ---------                                                                                                               -----------
    https://rheltest1keyvault.vault.azure.net/secrets/bdb6bfb1-5431-4c28-af46-b18d0025ef2a/abebacb83d864a5fa729508315020f8a Microsoft.Azure.Management....

Параметры OSVolumeEncrypted и DataVolumesEncrypted имеют значения Encrypted. Это означает, что оба тома зашифрованы с помощью шифрования дисков Azure. Дополнительные сведения о том, как включить шифрование на базе дискового шифрования Azure с помощью командлетов PowerShell, см. в [части 1](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/17/explore-azure-disk-encryption-with-azure-powershell.aspx) и [части 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx) записи блога **Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell**.

**Примечание.** На виртуальных машинах Linux результаты выполнения командлета `Get-AzureRmVMDiskEncryptionStatus` отображаются в течение 3–4 минут.

#### <a name="get-encryption-status-of-the-iaas-vm-from-disk-encryption-cli-command"></a>Получение состояния шифрования VM IaaS с помощью команды CLI для дискового шифрования
Состояние шифрования для виртуальной машины IaaS можно узнать с помощью команды интерфейса командной строки для дискового шифрования *azure vm show-disk-encryption-status*. Чтобы получить параметры шифрования для виртуальной машины, введите в сеансе Azure CLI такую команду:

    azure vm show-disk-encryption-status --resource-group <yourResourceGroupName> --name <yourVMName> --json  

#### <a name="disable-encryption-on-running-windows-iaas-vm"></a>Отключение шифрования на работающих виртуальных машинах IaaS под управлением Windows
Шифрование на работающей виртуальной машине IaaS под управлением Windows или Linux можно отключить при помощи шаблона Resource Manager для шифрования дисков Azure или командлетов PowerShell и задать конфигурацию расшифровки.

##### <a name="windows-vm"></a>Виртуальная машина Windows
На этом этапе для работающей виртуальной машины IaaS под управлением Windows отключается шифрование операционной системы и/или тома данных. Невозможно отключить том ОС и оставить том данных зашифрованным. После выполнения этапа отключения шифрования классическая модель развертывания Azure обновляет модель службы виртуальной машины, и виртуальная машина IaaS под управлением Windows помечается как расшифрованная. Содержимое виртуальной машины больше не шифруется при хранении. При отключении шифрования не удаляется хранилище ключей клиента и материал ключа шифрования (ключи шифрования BitLocker для Windows и парольная фраза для Linux). 

##### <a name="linux-vm"></a>Виртуальная машина Linux
На этом этапе для работающей виртуальной машины IaaS под управлением Linux отключается шифрование тома данных.

**Примечание.** Отключение шифрования диска операционной системы на виртуальных машинах Linux не поддерживается.

##### <a name="disable-encryption-on-existingrunning-iaas-vm-in-azure-using-resource-manager-template"></a>Отключение шифрования на имеющейся или работающей в Azure виртуальной машине IaaS с помощью командлета шаблона Resource Manager
Шифрование дисков для работающей виртуальной машины IaaS под управлением Windows можно отключить с помощью шаблона Resource Manager, опубликованного [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-decrypt-running-windows-vm). В шаблоне быстрого запуска Azure нажмите кнопку "Развернуть в Azure", введите параметры расшифровки в колонке параметров и нажмите кнопку "ОК". Выберите подписку, группу ресурсов, расположение группы ресурсов, условия и соглашения, а затем нажмите кнопку «Создать», чтобы включить шифрование для новой виртуальной машины IaaS.

Для отключения шифрования на виртуальных машинах Linux можно использовать шаблон, опубликованный [здесь](https://aka.ms/decrypt-linuxvm).

В следующей таблице представлены сведения о параметрах шаблона Resource Manager для отключения шифрования на работающей виртуальной машине IaaS под управлением Windows.

| vmName | Имя виртуальной машины, на которой будет выполняться шифрование |
| --- | --- |
| volumeType |Тип тома, для которого будет выполняться расшифровка. Допустимые значения: "ОС", "Данные", "Все". **Примечание.** Невозможно отключить шифрование тома ОС или загрузочного тома на работающей виртуальной машине IaaS под управлением Windows, не отключив шифрование для тома данных. **Примечание.** Отключение шифрования диска операционной системы на виртуальных машинах Linux не поддерживается. |
| sequenceVersion |Версия последовательности операций с BitLocker. Этот номер версии увеличивается каждый раз, когда расшифровка диска выполняется на той же ВМ. |

##### <a name="disable-encryption-on-existingrunning-iaas-vm-in-azure-using-ps-cmdlet"></a>Отключение шифрования на имеющейся или работающей в Azure виртуальной машине IaaS с помощью командлета PowerShell
Командлет PS [Disable-AzureRmVMDiskEncryption](https://msdn.microsoft.com/library/azure/mt715776.aspx) отключает шифрование дисков на виртуальной машине IaaS. Этот командлет поддерживает виртуальные машины Linux и Windows. Этот командлет устанавливает на виртуальной машине расширение для отключения шифрования. Если для параметра "Имя" не указано значение, создается расширение с именем по умолчанию "AzureDiskEncryption для виртуальных машин под управлением Windows". 

На виртуальных машинах Linux используется расширение AzureDiskEncryptionForLinux.

**Примечание.** Этот командлет перезагружает виртуальную машину. 

## <a name="appendix"></a>Приложение
### <a name="connect-to-your-subscription"></a>Подключение к подписке
Прежде чем продолжить, внимательно изучите раздел *предварительных требований* в этом документе. Убедитесь, что выполняются все обязательные требования, а затем подключитесь к подписке, выполнив следующие действия.

1. Запустите сеанс Azure PowerShell и войдите в учетную запись Azure, используя следующую команду:

    Login-AzureRmAccount

2. Если у вас несколько подписок и нужно указать, какая из них будет использоваться, введите следующую команду, чтобы увидеть подписки своей учетной записи:

    Get-AzureRmSubscription

3. Чтобы указать подписку, которую нужно использовать, введите:

    Select-AzureRmSubscription -SubscriptionName <Yoursubscriptionname>

4. Чтобы проверить, правильно ли настроена подписка, введите:

    Get-AzureRmSubscription

5. Чтобы убедиться, что командлеты дискового шифрования Azure установлены, введите:

    Get-command *diskencryption*

6. Если вы увидите такие выходные данные, значит командлеты PowerShell для дискового шифрования Azure установлены правильно:

    PS C:\Windows\System32\WindowsPowerShell\v1.0> get-command *diskencryption*
    CommandType  Name                                         Source                                                             
    Cmdlet       Get-AzureRmVMDiskEncryptionStatus            AzureRM.Compute                                                    
    Cmdlet       Disable-AzureRmVMDiskEncryption              AzureRM.Compute                                                    
    Cmdlet       Set-AzureRmVMDiskEncryptionExtension         AzureRM.Compute                                                     

### <a name="preparing-a-pre-encrypted-windows-vhd"></a>Подготовка предварительно зашифрованного виртуального жесткого диска Windows
В следующем разделе описаны действия, необходимые для подготовки предварительно зашифрованного виртуального жесткого диска Windows к развертыванию в качестве зашифрованного виртуального жесткого диска в Azure IaaS. Эти действия позволяют подготовить и загрузить чистую виртуальную машину Windows (виртуальный жесткий диск) в Hyper-V или Azure.

#### <a name="update-group-policy-to-allow-non-tpm-for-os-protection"></a>Обновление групповой политики с целью разрешить защиту ОС без TPM
Вам необходимо настроить параметр групповой политики BitLocker, который называется «Дисковое шифрование BitLocker». Он расположен в разделе «Политика локального компьютера\Конфигурация компьютера\Административные шаблоны\Компоненты Windows». Задайте для этого параметра такое значение: *Диски операционной системы — Обязательная дополнительная проверка подлинности при запуске — Разрешить использование BitLocker без совместимого TPM*, как показано на рисунке ниже:

![Антивредоносное ПО Майкрософт в Azure](./media/azure-security-disk-encryption/disk-encryption-fig8.png)

#### <a name="install-bitlocker-feature-components"></a>Установка компонентов BitLocker
Для Windows Server 2012 и более поздних версий используйте такую команду:

    dism /online /Enable-Feature /all /FeatureName:Bitlocker /quiet /norestart

Для Windows Server 2008 R2 используйте такую команду:

    ServerManagerCmd -install BitLockers

#### <a name="prepare-os-volume-for-bitlocker-using-bdehdcfg"></a>Подготовка тома операционной системы для BitLocker с помощью `bdehdcfg`
Выполните следующую команду, чтобы сжать раздел операционной системы и подготовить компьютер к использованию BitLocker.

    bdehdcfg -target c: shrink -quiet

#### <a name="using-bitlocker-to-protect-the-os-volume"></a>Использование BitLocker для защиты тома операционной системы
Используйте команду [`manage-bde`](https://technet.microsoft.com/library/ff829849.aspx), чтобы включить шифрование на загрузочном томе с использованием предохранителя внешнего ключа, и поместите внешний ключ (BEK-файл) на внешний диск или том. Шифрование будет включено для системного или загрузочного тома после перезагрузки.

    manage-bde -on %systemdrive% -sk [ExternalDriveOrVolume]
    reboot

**Примечание.** Чтобы получить внешний ключ с использованием BitLocker, виртуальную машину нужно подготовить с отдельным виртуальным жестким диском для данных и ресурсов.

#### <a name="encrypting-os-drive-on-a-running-linux-vm"></a>Шифрование диска операционной системы на работающей виртуальной машине Linux
Шифрование диска операционной системы работающей виртуальной машины Linux поддерживается на следующих дистрибутивах:

* RHEL 7.2;
* CentOS 7.2;
* Ubuntu 16.04.

Предварительные требования для шифрования диска операционной системы:

* Виртуальная машина должна быть создана на основе образа из коллекции Azure на портале Azure Resource Manager.
* Виртуальная машина Azure по крайней мере с 4 ГБ ОЗУ (рекомендуемый размер — 7 ГБ).
* На виртуальной машине должен быть [отключен](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/sect-Security-Enhanced_Linux-Working_with_SELinux-Changing_SELinux_Modes.html#sect-Security-Enhanced_Linux-Enabling_and_Disabling_SELinux-Disabling_SELinux) инструмент SELinux (для RHEL и CentOS). После отключения SELinux виртуальную машину необходимо перезагрузить хотя бы один раз.

##### <a name="steps"></a>Действия
1. Создайте виртуальную машину, используя один из указанных выше дистрибутивов.

Для CentOS 7.2 шифрование диска операционной системы можно включить через специальный образ. Чтобы использовать этот образ, задайте при создании виртуальной машины для параметра Sku значение 7.2n.

    Set-AzureRmVMSourceImage -VM $VirtualMachine -PublisherName "OpenLogic" -Offer "CentOS" -Skus "7.2n" -Version "latest"

2. Настройте виртуальную машину должным образом. Если вы собираетесь включить шифрование всех дисков (диска операционной системы и дисков данных), диски данных необходимо указать и присоединить в файле /etc/fstab.

> [!NOTE]
> Чтобы указать диски данных в файле /etc/fstab, используйте значение UUID=... (в этом случае не нужно указывать имя блочного устройства, например /dev/sdb1). В процессе шифрования порядок дисков на виртуальной машине изменится. Если на виртуальной машине используется определенный порядок блочных устройств, при присоединении их после шифрования произойдет сбой.
> 
> 

3. Завершите сеансы SSH.

4. Чтобы [включить шифрование](#enable-encryption-on-existing-or-running-iaas-linux-vm-in-azure) операционной системы, задайте при включении для параметра volumeType значение "Все" или "ОС".

> [!NOTE]
> Все пользовательские процессы, не запущенные как службы `systemd`, необходимо завершить с помощью `SIGKILL`. После этого виртуальная машина должна быть перезагружена. При включении шифрования диска операционной системы на работающей виртуальной машине необходимо запланировать время простоя.
> 
> 

5. Периодически отслеживайте ход выполнения шифрования, следуя инструкциям из [следующего раздела](#monitoring-os-encryption-progress).

6. Как только командлет Get-AzureRmVmDiskEncryptionStatus вернет значение VMRestartPending, перезапустите виртуальную машину вручную либо с помощью портала, PowerShell или интерфейса командной строки.

    C:\> Get-AzureRmVmDiskEncryptionStatus  -ResourceGroupName $ResourceGroupName -VMName $VMName
    -ExtensionName $ExtensionName

    OsVolumeEncrypted          : VMRestartPending
    DataVolumesEncrypted       : NotMounted
    OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
    ProgressMessage            : OS disk successfully encrypted, please reboot the VM

*Прежде* чем перезагружать виртуальную машину, советуем сохранить [данные диагностики загрузки](https://azure.microsoft.com/en-us/blog/boot-diagnostics-for-virtual-machines-v2/).

#### <a name="monitoring-os-encryption-progress"></a>Мониторинг хода выполнения шифрования операционной системы
Мониторинг хода выполнения шифрования операционной системы можно выполнять тремя способами.

1. Используйте командлет Get-AzureRmVmDiskEncryptionStatus и просмотрите поле ProgressMessage. 

    OsVolumeEncrypted          : EncryptionInProgress
    DataVolumesEncrypted       : NotMounted
    OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
    ProgressMessage            : OS disk encryption started

На виртуальных машинах, заархивированных в хранилище класса Premium, процесс шифрования диска операционной системы длится 40–50 минут с момента начала.

В связи с [ошибкой 388](https://github.com/Azure/WALinuxAgent/issues/388) в WALinuxAgent в некоторых дистрибутивах `OsVolumeEncrypted` и `DataVolumesEncrypted` отобразится как `Unknown`. В WALinuxAgent версии 2.1.5 и более поздних эта проблема будет исправлена автоматически. Если в выходных данных отобразится `Unknown`, состояние выполнения шифрования можно проверить с помощью средства просмотра ресурсов Azure.

Откройте [инструмент просмотра ресурсов Azure](https://resources.azure.com/) и на панели выбора слева разверните иерархию, как показано ниже:

~~~~
 |-- subscriptions
     |-- [Your subscription]
          |-- resourceGroups
               |-- [Your resource group]
                    |-- providers
                         |-- Microsoft.Compute
                              |-- virtualMachines
                                   |-- [Your virtual machine]
                                        |-- InstanceView
~~~~                

В InstanceView прокрутите вниз, чтобы увидеть состояние шифрования дисков.

![Представление экземпляра виртуальной машины](./media/azure-security-disk-encryption/vm-instanceview.png)

2. Просмотрите [данные диагностики загрузки](https://azure.microsoft.com/en-us/blog/boot-diagnostics-for-virtual-machines-v2/). Сообщения от расширения шифрования дисков Azure должны начинаться с `[AzureDiskEncryption]`.

3. Выполните вход на виртуальную машину через SSH и скопируйте журнал расширения, расположенный по следующему пути:

    /var/log/azure/Microsoft.Azure.Security.AzureDiskEncryptionForLinux

Мы советуем не входить в систему виртуальной машины во время выполнения шифрования операционной системы. Поэтому журналы следует копировать, только если не удалось выполнить предыдущие два метода.

#### <a name="preparing-a-pre-encrypted-linux-vhd"></a>Подготовка предварительно зашифрованного виртуального жесткого диска Linux
##### <a name="ubuntu-16"></a>Ubuntu 16
###### <a name="configure-encryption-during-distro-install"></a>Настройка шифрования во время установки дистрибутива
1. Во время секционирования дисков выберите значение Configure encrypted volumes (Настройка зашифрованных томов).

![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig1.png)

2. Создайте отдельный загрузочный диск (незашифрованный). Зашифруйте корневой диск.

![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig2.png)

3. Укажите парольную фразу. Это парольная фраза, которую затем необходимо будет передать в хранилище ключей.

![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig3.png)

4. Завершите секционирование.

![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig4.png)

5. При загрузке виртуальной машины появится запрос на ввод парольной фразы. Введите парольную фразу, указанную на шаге 3.

![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig5.png)

6. Подготовьте виртуальную машину к отправке в Azure, используя [приведенные здесь инструкции](https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-linux-create-upload-ubuntu/). Пока не выполняйте последний шаг (отзыв виртуальной машины).

###### <a name="configure-encryption-to-work-with-azure"></a>Настройка шифрования в Azure
1. Создайте в каталоге /usr/local/sbin/azure_crypt_key.sh файл с приведенным ниже содержимым. Обратите внимание на параметр KeyFileName — это имя файла пароля, которое создает Azure.

    #!/bin/sh
    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint
    modprobe vfat >/dev/null 2>&1
    modprobe ntfs >/dev/null 2>&1
    sleep 2
    OPENED=0
    cd /sys/block
    for DEV in sd*; do
        echo "> Trying device: $DEV ..." >&2
        mount -t vfat -r /dev/${DEV}1 $MountPoint >/dev/null||
        mount -t ntfs -r /dev/${DEV}1 $MountPoint >/dev/null
        if [ -f $MountPoint/$KeyFileName ]; then
                cat $MountPoint/$KeyFileName
                umount $MountPoint 2>/dev/null
                OPENED=1
                break
        fi
        umount $MountPoint 2>/dev/null
    done

      if [ $OPENED -eq 0 ]; then
        echo "FAILED to find suitable passphrase file ..." >&2
        echo -n "Try to enter your password: " >&2
        read -s -r A </dev/console
        echo -n "$A"
     else
        echo "Success loading keyfile!" >&2
    fi


2. Измените настройки шифрования в */etc/crypttab*. Результат будет выглядеть так:

    xxx_crypt uuid=xxxxxxxxxxxxxxxxxxxxx none luks,discard,keyscript=/usr/local/sbin/azure_crypt_key.sh

3. Если вы изменяете файл *azure_crypt_key.sh* в Windows, а затем копируете его в Linux, не забудьте выполнить команду *dos2unix /usr/local/sbin/azure_crypt_key.sh*.

4. Добавьте в сценарий исполняемые расширения.

    chmod +x /usr/local/sbin/azure_crypt_key.sh

4. Измените */etc/initramfs-tools/modules*, добавив приведенные ниже строки.

    vfat
    ntfs
    nls_cp437
    nls_utf8
    nls_iso8859-1

5. Запустите `update-initramfs -u -k all` и обновите initramfs для выполнения `keyscript`.
6. Теперь виртуальную машину можно отозвать.

![Настройка Ubuntu 16.04](./media/azure-security-disk-encryption/ubuntu-1604-preencrypted-fig6.png)

7. Перейдите к следующему шагу и [передайте свой виртуальный жесткий диск](#upload-encrypted-vhd-to-an-azure-storage-account) в Azure.

##### <a name="opensuse-132"></a>openSUSE 13.2
###### <a name="configure-encryption-during-distro-install"></a>Настройка шифрования во время установки дистрибутива
1. Во время секционирования дисков выберите значение Encrypt Volume Group (Шифрование группы томов). Укажите парольную фразу. Это парольная фраза, которую затем необходимо будет передать в хранилище ключей.

![Настройка openSUSE 13.2](./media/azure-security-disk-encryption/opensuse-encrypt-fig1.png)

2. Загрузите виртуальную машину, используя указанную парольную фразу.

![Настройка openSUSE 13.2](./media/azure-security-disk-encryption/opensuse-encrypt-fig2.png)

3. Подготовьте виртуальную машину к отправке в Azure, используя [приведенные здесь инструкции](https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-linux-suse-create-upload-vhd/#prepare-opensuse-131). Пока не выполняйте последний шаг (отзыв виртуальной машины).

###### <a name="configure-encryption-to-work-with-azure"></a>Настройка шифрования в Azure
1. Измените файл /etc/dracut.conf и добавьте следующую строку:

    add_drivers+=" vfat ntfs nls_cp437 nls_iso8859-1"

2. Закомментируйте следующие строки в конце файла /usr/lib/dracut/modules.d/90crypt/module-setup.sh:

    #        inst_multiple -o \
    #        $systemdutildir/system-generators/systemd-cryptsetup-generator \
    #        $systemdutildir/systemd-cryptsetup \
    #        $systemdsystemunitdir/systemd-ask-password-console.path \
    #        $systemdsystemunitdir/systemd-ask-password-console.service \
    #        $systemdsystemunitdir/cryptsetup.target \
    #        $systemdsystemunitdir/sysinit.target.wants/cryptsetup.target \
    #        systemd-ask-password systemd-tty-ask-password-agent
    #        inst_script "$moddir"/crypt-run-generator.sh /sbin/crypt-run-generator



3. В начале файла /usr/lib/dracut/modules.d/90crypt/parse-crypt.sh добавьте следующую строку:

    DRACUT_SYSTEMD=0

Затем измените все вхождения

    if [ -z "$DRACUT_SYSTEMD" ]; then

значение

    if [ 1 ]; then

4. Измените файл /usr/lib/dracut/modules.d/90crypt/cryptroot-ask.sh, добавив следующий текст после строки # Open LUKS device.

    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint >&2
    modprobe vfat >/dev/null >&2
    modprobe ntfs >/dev/null >&2
    for SFS in /dev/sd*; do
    echo "> Trying device:$SFS..." >&2
    mount ${SFS}1 $MountPoint -t vfat -r >&2 ||
    mount ${SFS}1 $MountPoint -t ntfs -r >&2
    if [ -f $MountPoint/$KeyFileName ]; then
        echo "> keyfile got..." >&2
        cp $MountPoint/$KeyFileName /tmp-keyfile >&2
        luksfile=/tmp-keyfile
        umount $MountPoint >&2
        break
    fi
    done


5. Запустите /usr/sbin/dracut -f -v, чтобы обновить initrd.

6. Теперь виртуальную машину можно отозвать и [передать свой виртуальный жесткий диск](#upload-encrypted-vhd-to-an-azure-storage-account) в Azure.

##### <a name="centos-7"></a>CentOS 7
###### <a name="configure-encryption-during-distro-install"></a>Настройка шифрования во время установки дистрибутива
1. Во время секционирования дисков выберите значение Encrypt my data (Шифрование личных данных).

![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig1.png)

2. Включите шифрование для корневого раздела.

![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig2.png)

3. Укажите парольную фразу. Это парольная фраза, которую затем необходимо будет передать в хранилище ключей.

![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig3.png)

4. При загрузке виртуальной машины появится запрос на ввод парольной фразы. Введите парольную фразу, указанную на шаге 3.

![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig4.png)

5. Подготовьте виртуальную машину к отправке в Azure, используя [приведенные здесь инструкции](https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-linux-create-upload-centos/#centos-70). Пока не выполняйте последний шаг (отзыв виртуальной машины).

6. Теперь виртуальную машину можно отозвать и [передать свой виртуальный жесткий диск](#upload-encrypted-vhd-to-an-azure-storage-account) в Azure.

###### <a name="configure-encryption-to-work-with-azure"></a>Настройка шифрования в Azure
1. Измените файл /etc/dracut.conf и добавьте следующую строку:

    add_drivers+=" vfat ntfs nls_cp437 nls_iso8859-1"

2. Закомментируйте следующие строки в конце файла /usr/lib/dracut/modules.d/90crypt/module-setup.sh:

    #        inst_multiple -o \
    #        $systemdutildir/system-generators/systemd-cryptsetup-generator \
    #        $systemdutildir/systemd-cryptsetup \
    #        $systemdsystemunitdir/systemd-ask-password-console.path \
    #        $systemdsystemunitdir/systemd-ask-password-console.service \
    #        $systemdsystemunitdir/cryptsetup.target \
    #        $systemdsystemunitdir/sysinit.target.wants/cryptsetup.target \
    #        systemd-ask-password systemd-tty-ask-password-agent
    #        inst_script "$moddir"/crypt-run-generator.sh /sbin/crypt-run-generator



3. В начале файла /usr/lib/dracut/modules.d/90crypt/parse-crypt.sh добавьте следующую строку:

    DRACUT_SYSTEMD=0

Затем измените все вхождения

    if [ -z "$DRACUT_SYSTEMD" ]; then

значение

    if [ 1 ]; then

4. Измените файл /usr/lib/dracut/modules.d/90crypt/cryptroot-ask.sh, добавив следующий текст после строки # Open LUKS device.

    MountPoint=/tmp-keydisk-mount
    KeyFileName=LinuxPassPhraseFileName
    echo "Trying to get the key from disks ..." >&2
    mkdir -p $MountPoint >&2
    modprobe vfat >/dev/null >&2
    modprobe ntfs >/dev/null >&2
    for SFS in /dev/sd*; do
    echo "> Trying device:$SFS..." >&2
    mount ${SFS}1 $MountPoint -t vfat -r >&2 ||
    mount ${SFS}1 $MountPoint -t ntfs -r >&2
    if [ -f $MountPoint/$KeyFileName ]; then
        echo "> keyfile got..." >&2
        cp $MountPoint/$KeyFileName /tmp-keyfile >&2
        luksfile=/tmp-keyfile
        umount $MountPoint >&2
        break
    fi
    done


5. Запустите /usr/sbin/dracut -f -v, чтобы обновить initrd.

![Настройка CentOS 7](./media/azure-security-disk-encryption/centos-encrypt-fig5.png)

### <a name="upload-encrypted-vhd-to-an-azure-storage-account"></a>Передача зашифрованного виртуального жесткого диска в учетную запись хранения Azure
После включения шифрования BitLocker или DM-Crypt следует передать зашифрованный виртуальный жесткий диск в учетную запись хранения.

    Add-AzureRmVhd [-Destination] <Uri> [-LocalFilePath] <FileInfo> [[-NumberOfUploaderThreads] <Int32> ] [[-BaseImageUriToPatch] <Uri> ] [[-OverWrite]] [ <CommonParameters>]

### <a name="upload-disk-encryption-secret-for-the-pre-encrypted-vm-to-key-vault"></a>Передача секрета дискового шифрования для предварительно зашифрованной виртуальной машины в хранилище ключей
Секрет дискового шифрования, полученный ранее, необходимо передать в хранилище ключей в качестве секрета. В хранилище ключей нужно включить разрешения для клиента AAD, а также шифрование дисков.

    $AadClientId = "YourAADClientId"
    $AadClientSecret = "YourAADClientSecret"

    $KeyVault = New-AzureRmKeyVault -VaultName $KeyVaultName -ResourceGroupName $ResourceGroupName -Location $Location

    Set-AzureRmKeyVaultAccessPolicy -VaultName $KeyVaultName -ResourceGroupName $ResourceGroupName -ServicePrincipalName $AadClientId -PermissionsToKeys all -PermissionsToSecrets all
    Set-AzureRmKeyVaultAccessPolicy -VaultName $KeyVaultName -ResourceGroupName $ResourceGroupName -EnabledForDiskEncryption


#### <a name="disk-encryption-secret-not-encrypted-with-a-kek"></a>Секрет дискового шифрования не шифруется с помощью KEK
Используйте [Set-AzureKeyVaultSecret](https://msdn.microsoft.com/library/dn868050.aspx), чтобы подготовить секрет в хранилище ключей. Если вы используете виртуальную машину Windows, с помощью командлета Set-AzureKeyVaultSecret закодируйте BEK-файл как строку Base64 и передайте его в хранилище ключей. Если используется виртуальная машина Linux, пароль кодируется как строка Base64, а затем передается в хранилище ключей. Убедитесь также, что при создании секрета в хранилище ключей были установлены следующие теги.

    # This is the passphrase that was provided for encryption during distro install
    $passphrase = "contoso-password"

    $tags = @{"DiskEncryptionKeyEncryptionAlgorithm" = "RSA-OAEP"; "DiskEncryptionKeyFileName" = "LinuxPassPhraseFileName"}
    $secretName = [guid]::NewGuid().ToString()
    $secretValue = [Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($passphrase))
    $secureSecretValue = ConvertTo-SecureString $secretValue -AsPlainText -Force

    $secret = Set-AzureKeyVaultSecret -VaultName $KeyVaultName -Name $secretName -SecretValue $secureSecretValue -tags $tags
    $secretUrl = $secret.Id

На следующем шаге мы используем `$secretUrl`, чтобы [присоединить диск операционной системы, не используя ключ шифрования ключей](#without-using-a-kek).

#### <a name="disk-encryption-secret-encrypted-with-a-kek"></a>Секрет дискового шифрования, зашифрованный с помощью KEK
Перед передачей в хранилище ключей секрет можно зашифровать с помощью ключа шифрования ключа (необязательно). Сначала используйте [API](https://msdn.microsoft.com/library/azure/dn878066.aspx) для создания оболочки, чтобы зашифровать секрет с использованием ключа шифрования ключа. Эта операция возвращает значения, закодированные как URL-адрес в кодировке Base64, которые затем передаются в качестве секрета с помощью командлета [Set-AzureKeyVaultSecret](https://msdn.microsoft.com/library/dn868050.aspx).

    # This is the passphrase that was provided for encryption during distro install
    $passphrase = "contoso-password"

    Add-AzureKeyVaultKey -VaultName $KeyVaultName -Name "keyencryptionkey" -Destination Software
    $KeyEncryptionKey = Get-AzureKeyVaultKey -VaultName $KeyVault.OriginalVault.Name -Name "keyencryptionkey"

    $apiversion = "2015-06-01"

    ##############################
    # Get Auth URI
    ##############################

    $uri = $KeyVault.VaultUri + "/keys"
    $headers = @{}

    $response = try { Invoke-RestMethod -Method GET -Uri $uri -Headers $headers } catch { $_.Exception.Response }

    $authHeader = $response.Headers["www-authenticate"]
    $authUri = [regex]::match($authHeader, 'authorization="(.*?)"').Groups[1].Value

    Write-Host "Got Auth URI successfully"

    ##############################
    # Get Auth Token
    ##############################

    $uri = $authUri + "/oauth2/token"
    $body = "grant_type=client_credentials"
    $body += "&client_id=" + $AadClientId
    $body += "&client_secret=" + [Uri]::EscapeDataString($AadClientSecret)
    $body += "&resource=" + [Uri]::EscapeDataString("https://vault.azure.net")
    $headers = @{}

    $response = Invoke-RestMethod -Method POST -Uri $uri -Headers $headers -Body $body

    $access_token = $response.access_token

    Write-Host "Got Auth Token successfully"

    ##############################
    # Get KEK info
    ##############################

    $uri = $KeyEncryptionKey.Id + "?api-version=" + $apiversion
    $headers = @{"Authorization" = "Bearer " + $access_token}

    $response = Invoke-RestMethod -Method GET -Uri $uri -Headers $headers

    $keyid = $response.key.kid

    Write-Host "Got KEK info successfully"

    ##############################
    # Encrypt passphrase using KEK
    ##############################

    $passphraseB64 = [Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($Passphrase))
    $uri = $keyid + "/encrypt?api-version=" + $apiversion
    $headers = @{"Authorization" = "Bearer " + $access_token; "Content-Type" = "application/json"}
    $bodyObj = @{"alg" = "RSA-OAEP"; "value" = $passphraseB64}
    $body = $bodyObj | ConvertTo-Json

    $response = Invoke-RestMethod -Method POST -Uri $uri -Headers $headers -Body $body

    $wrappedSecret = $response.value

    Write-Host "Encrypted passphrase successfully"

    ##############################
    # Store secret
    ##############################

    $secretName = [guid]::NewGuid().ToString()
    $uri = $KeyVault.VaultUri + "/secrets/" + $secretName + "?api-version=" + $apiversion
    $secretAttributes = @{"enabled" = $true}
    $secretTags = @{"DiskEncryptionKeyEncryptionAlgorithm" = "RSA-OAEP"; "DiskEncryptionKeyFileName" = "LinuxPassPhraseFileName"}
    $headers = @{"Authorization" = "Bearer " + $access_token; "Content-Type" = "application/json"}
    $bodyObj = @{"value" = $wrappedSecret; "attributes" = $secretAttributes; "tags" = $secretTags}
    $body = $bodyObj | ConvertTo-Json

    $response = Invoke-RestMethod -Method PUT -Uri $uri -Headers $headers -Body $body

    Write-Host "Stored secret successfully"

    $secretUrl = $response.id

На следующем шаге мы используем `$KeyEncryptionKey` и `$secretUrl`, чтобы [присоединить диск операционной системы, используя ключ шифрования ключей](#using-a-kek).

### <a name="specify-secret-url-when-attaching-os-disk"></a>Указание URL-адреса секрета при присоединении диска операционной системы
#### <a name="without-using-a-kek"></a>Без использования ключа шифрования ключа
При присоединении диска операционной системы необходимо передать `$secretUrl`. Этот URL-адрес был создан в разделе [Секрет шифрования дисков, не зашифрованный с помощью ключа шифрования ключей](#disk-encryption-secret-not-encrypted-with-a-kek).

    Set-AzureRmVMOSDisk `
            -VM $VirtualMachine `
            -Name $OSDiskName `
            -SourceImageUri $VhdUri `
            -VhdUri $OSDiskUri `
            -Linux `
            -CreateOption FromImage `
            -DiskEncryptionKeyVaultId $KeyVault.ResourceId `
            -DiskEncryptionKeyUrl $SecretUrl

#### <a name="using-a-kek"></a>С использованием ключа шифрования ключа
При присоединении диска операционной системы необходимо передать `$KeyEncryptionKey` и `$secretUrl`. Этот URL-адрес был создан в разделе [Секрет шифрования дисков, зашифрованный с помощью ключа шифрования ключей](#disk-encryption-secret-encrypted-with-a-kek).

    Set-AzureRmVMOSDisk `
            -VM $VirtualMachine `
            -Name $OSDiskName `
            -SourceImageUri $CopiedTemplateBlobUri `
            -VhdUri $OSDiskUri `
            -Linux `
            -CreateOption FromImage `
            -DiskEncryptionKeyVaultId $KeyVault.ResourceId `
            -DiskEncryptionKeyUrl $SecretUrl `
            -KeyEncryptionKeyVaultId $KeyVault.ResourceId `
            -KeyEncryptionKeyURL $KeyEncryptionKey.Id

## <a name="download-this-guide"></a>Скачивание руководства
Это руководство можно скачать из [коллекции TechNet](https://gallery.technet.microsoft.com/Azure-Disk-Encryption-for-a0018eb0).

## <a name="for-more-information"></a>Дополнительные сведения
[Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/16/explore-azure-disk-encryption-with-azure-powershell.aspx?wa=wsignin1.0)

[Изучение возможностей дискового шифрования Azure с помощью Azure PowerShell — часть 2](http://blogs.msdn.com/b/azuresecurity/archive/2015/11/21/explore-azure-disk-encryption-with-azure-powershell-part-2.aspx)




<!--HONumber=Nov16_HO4-->


