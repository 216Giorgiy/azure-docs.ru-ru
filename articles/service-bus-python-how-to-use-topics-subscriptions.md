<properties urlDisplayName="Service Bus Topics" pageTitle="Использование разделов Service Bus (Python) - Azure" metaKeywords="Начало работы с разделами Azure Service Bus, публикация, подписки, сообщения, Python" description="Узнайте, как использовать разделы и подписки Service Bus в Azure. Примеры кода написаны для приложений Python." metaCanonical="" services="service-bus" documentationCenter="Python" title="How to Use Service Bus Topics/Subscriptions" authors="huvalo" solutions="" manager="wpickett" editor="" />

<tags ms.service="service-bus" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="python" ms.topic="article" ms.date="09/19/2014" ms.author="huvalo" />





# Использование разделов и подписок Service Bus
В этом руководстве показано, как использовать разделы и подписки Service Bus из приложений на Python. В этой статье описаны такие сценарии, как **создание разделов и подписок, создание фильтров подписок, отправка сообщений** в раздел, **получение сообщений от подписки** и **удаление разделов и подписок**. Дополнительные сведения о разделах и подписках см. в разделе [Дальнейшие действия](#Next_Steps).

## Оглавление

-   [Что такое разделы и подписки Service Bus?](#what-are-service-bus-topics)
-   [Создание пространства имен службы](#create-a-service-namespace)
-   [Получение учетных данных управления по умолчанию для пространства имен](#obtain-default-credentials)
-   [Практическое руководство. Создание раздела](#How_to_Create_a_Topic)
-   [Практическое руководство. Создание подписок](#How_to_Create_Subscriptions)
-   [Практическое руководство. Отправка сообщений в раздел](#How_to_Send_Messages_to_a_Topic)
-   [Практическое руководство. Получение сообщений от подписки](#How_to_Receive_Messages_from_a_Subscription)
-   [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений](#How_to_Handle_Application_Crashes_and_Unreadable_Messages)
-   [Практическое руководство. Удаление разделов и подписок](#How_to_Delete_Topics_and_Subscriptions)
-   [Дальнейшие действия](#Next_Steps)


[WACOM.INCLUDE [howto-service-bus-topics](../includes/howto-service-bus-topics.md)]

**Примечание.** Если нужно установить клиентские библиотеки или Python, см. [Руководство по установке Python](../python-how-to-install/).


##<a name="How_to_Create_a_Topic"></a>Создание раздела

Объект **ServiceBusService** позволяет работать с разделами. Добавьте следующий код в начало любого файла Python, из которого планируется получать доступ к Service Bus Azure программным способом:

	from azure.servicebus import ServiceBusService, Message, Topic, Rule, DEFAULT_RULE_NAME

Следующий код создает объект **ServiceBusService**. Замените "mynamespace", "sharedaccesskeyname" и "sharedaccesskey" настоящим пространством имен, именем и значением ключа подписанного URL-адреса (SAS).

	bus_service = ServiceBusService(
		service_namespace='mynamespace',
		shared_access_key_name='sharedaccesskeyname',
		shared_access_key_value='sharedaccesskey')

Значения для имени и параметра ключа SAS можно найти в сведениях о подключении к порталу Azure или в окне "Свойства" Visual Studio при выборе пространства имен шины обслуживания в обозревателе сервера (как показано в предыдущем разделе).

	bus_service.create_topic('mytopic')

**create\_topic** также поддерживает дополнительные параметры, которые
позволяют переопределить параметры раздела по умолчанию, например срок существования сообщения
или максимальный размер раздела. В следующем примере продемонстрировано
задание максимального размера раздела 5 ГБ со сроком существования 1 минута:

	topic_options = Topic()
	topic_options.max_size_in_megabytes = '5120'
	topic_options.default_message_time_to_live = 'PT1M'

	bus_service.create_topic('mytopic', topic_options)

##<a name="How_to_Create_Subscriptions"></a>Создание подписок

Подписки на разделы также создаются с помощью объекта **ServiceBusService**. Подписки имеют имена и могут использовать дополнительный фильтр, который ограничивает набор сообщений, доставляемых в виртуальную очередь подписки.

**Примечание**. Подписки являются постоянными и продолжают существовать либо до их удаления, либо до удаления раздела, с которым они связаны.

### Создание подписки с фильтром по умолчанию (MatchAll)

Фильтр **MatchAll** является фильтром по умолчанию, которые используется, если при создании новой подписки не указан фильтр. Если используется фильтр **MatchAll**, все сообщения, опубликованные в разделе, помещаются в виртуальную очередь подписки. В следующем примере создается подписка с именем "AllMessages" и используется фильтр по умолчанию **MatchAll**.

	bus_service.create_subscription('mytopic', 'AllMessages')

### Создание подписок с фильтрами

Можно также настроить фильтры, позволяющие определять, какие сообщения, отправленные
в раздел, должны отображаться в определенной подписке раздела.

Самый гибкий тип фильтра, который поддерживается подписками, - это **SqlFilter**, реализующий подмножество SQL92. Фильтры SQL работают со свойствами сообщений, которые опубликованы в разделе. Дополнительные сведения о выражениях, которые можно использовать с фильтром SQL, см. в описании синтаксиса [SqlFilter.SqlExpression][].

Фильтры в подписку можно добавить с помощью метода **create\_rule** объекта **ServiceBusService**. Этот метод позволяет добавлять новые фильтры в существующую подписку.

**Примечание**. Ко всем новым подпискам автоматически применяется фильтр по умолчанию, поэтому сначала необходимо удалить фильтр по умолчанию, иначе **MatchAll** изменит поведение всех остальных заданных вами фильтров. Вы можете удалить правило по умолчанию с помощью метода **delete_rule** объекта **ServiceBusService**.

В следующем примере создается подписка с именем "HighMessages" и фильтром **SqlFilter**, который выбирает только сообщения, значение пользовательского свойства **messagenumber** у которых превышает 3:

	bus_service.create_subscription('mytopic', 'HighMessages')

	rule = Rule()
	rule.filter_type = 'SqlFilter'
	rule.filter_expression = 'messagenumber > 3'

	bus_service.create_rule('mytopic', 'HighMessages', 'HighMessageFilter', rule)
	bus_service.delete_rule('mytopic', 'HighMessages', DEFAULT_RULE_NAME)

Аналогичным образом в следующем примере создается подписка с именем
"LowMessages" с **SqlFilter**, который выбирает только сообщения, значение свойства **messagenumber** у которых меньше или равно 3: 
	bus_service.create_subscription('mytopic', 'LowMessages')

	rule = Rule()
	rule.filter_type = 'SqlFilter'
	rule.filter_expression = 'messagenumber <= 3'

	bus_service.create_rule('mytopic', 'LowMessages', 'LowMessageFilter', rule)
	bus_service.delete_rule('mytopic', 'LowMessages', DEFAULT_RULE_NAME)

Если теперь сообщение будет отправлено в раздел "mytopic", оно всегда будет доставляться получателям, подписанным на подписку раздела "AllMessages", и выборочно доставляться получателям, подписанным на подписки разделов "HighMessages" и "LowMessages" (в зависимости от содержимого сообщений).

##<a name="How_to_Send_Messages_to_a_Topic"></a>Отправка сообщений в раздел

Чтобы отправить сообщение в раздел Service Bus, ваше приложение должно использовать метод **send\_topic\_message** объекта **ServiceBusService**.

В следующем примере показано, как отправить пять тестовых сообщений в раздел "mytopic". Обратите внимание, что значение настраиваемого свойства **messagenumber** каждого сообщения зависит от итераций цикла (таким образом определяется, какие из подписок получат сообщение).

	for i in range(5):
		msg = Message('Msg {0}'.format(i).encode('utf-8'), custom_properties={'messagenumber':i})
		bus_service.send_topic_message('mytopic', msg)

Разделы Service Bus поддерживают максимальный размер сообщения 256 МБ (максимальный размер заголовка, который содержит стандартные и настраиваемые свойства приложения, - 64 МБ). Ограничения на количество сообщений в разделе нет, но есть максимальный общий размер сообщений, содержащихся в разделе. Этот размер задается при создании с верхним пределом 5 ГБ.

##<a name="How_to_Receive_Messages_from_a_Subscription"></a>Получение сообщений от подписки

Сообщения извлекаются из подписки с помощью метода **receive\_subscription\_message** объекта **ServiceBusService**:

	msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=False)
	print(msg.body)

Прочитанные сообщения будут удаляться из подписки, когда значение параметра **peek_lock** будет установлено в **False**. Вы можете прочитать (peek) и зафиксировать сообщение, не удаляя его из очереди, присвоив параметру **peek\_lock** значение **True**.

Поведение по умолчанию - чтение и удаление сообщения как часть операции получения - является простейшей моделью, оптимальной для сценариев, в которых приложение может не обрабатывать сообщение в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку шина обслуживания помечает сообщение как используемое, то после того как приложение перезапускается и снова начинает обрабатывать сообщения, оно пропустит сообщение, которое использовалось до сбоя.


Если параметр **peek\_lock** имеет значение **True**, получение становится операцией из двух этапов, что позволяет поддерживать приложения, неустойчивые к пропуску сообщений. Получив запрос, Service Bus находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению. Заканчивая обработку сообщения (или надежно сохраняя его для будущей обработки), приложение завершает второй этап процесса получения, вызывая метод **delete** объекта **Message**. Метод **delete** помечает сообщение как используемое и удаляет его из подписки.

	msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=True)
	print(msg.body)

	msg.delete()


  ##<a name="How_to_Handle_Application_Crashes_and_Unreadable_Messages"></a>Обработка сбоев приложения и нечитаемых сообщений

Служебная шина предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock** объекта **Message**. После этого служебная шина разблокирует сообщение в подписке и сделает его доступным для приема тем же приложением или другим приложением.

Кроме того, с сообщением, заблокированным в подписке, связано время ожидания. Если приложение не может обработать сообщение в течение времени ожидания с блокировкой (например, при сбое приложения), служебная шина Service Bus разблокирует сообщение автоматически и сделает его доступным для приема.

Если в приложении происходит сбой после обработки сообщения, но до вызова метода **delete**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют **Обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью свойства **MessageId** сообщения, которое остается постоянным для различных попыток доставки.

##<a name="How_to_Delete_Topics_and_Subscriptions"></a>Удаление разделов и подписок

Разделы и подписки являются постоянными, поэтому их требуется удалять явным образом
либо через портал управления Azure, либо программным путем.
В приведенном ниже примере показано, как удалить раздел с именем "mytopic":

	bus_service.delete_topic('mytopic')

При удалении раздела также удаляются все подписки, которые зарегистрированы в разделе. Подписки также можно удалять по отдельности. В следующем примере кода показано, как удалить подписку с именем "HighMessages" из раздела "mytopic":

	bus_service.delete_subscription('mytopic', 'HighMessages')

##<a name="Next_Steps"></a>Дальнейшие действия

Теперь, когда вы получили основные сведения о разделах Service Bus, перейдите
по ссылкам на дополнительные сведения.

-   Справочник MSDN: [Очереди, разделы и подписки][].
-     Справочник по API для [SqlFilter][].

  [Дальнейшие действия]: #nextsteps
  [Что такое разделы и подписки Service Bus?]: #what-are-service-bus-topics
  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Практическое руководство. Создание раздела]: #How_to_Create_a_Topic
  [Практическое руководство. Создание подписок]: #How_to_Create_Subscriptions
  [Практическое руководство. Отправка сообщений в раздел]: #How_to_Send_Messages_to_a_Topic
  [Практическое руководство. Получение сообщений от подписки]: #How_to_Receive_Messages_from_a_Subscription
  [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]: #How_to_Handle_Application_Crashes_and_Unreadable_Messages
  [Практическое руководство. Удаление разделов и подписок]: #How_to_Delete_Topics_and_Subscriptions
  
  [Основные понятия раздела]: ../../../DevCenter/dotNet/Media/sb-topics-01.png
  [Портал управления Azure]: http://manage.windowsazure.com
  
  
  
  
  
  
  [очереди, разделы и подписки]: http://msdn.microsoft.com/ru-ru/library/hh367516.aspx
  [SqlFilter]: http://msdn.microsoft.com/ru-ru/library/windowsazure/microsoft.servicebus.messaging.sqlfilter.aspx
