<properties 
	pageTitle="Использование разделов служебной шины (Python) - Azure" 
	description="Узнайте, как использовать разделы и подписки служебной шины в Python." 
	services="service-bus" 
	documentationCenter="python" 
	authors="huguesv" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="service-bus" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="na" 
	ms.devlang="python" 
	ms.topic="article" 
	ms.date="02/09/2015" 
	ms.author="huvalo"/>





# Использование разделов и подписок служебной шины
Из этого руководства вы узнаете, как использовать разделы и подписки служебной шины. Примеры написаны на Python и используют [пакет Python для Azure][]. В этой статье описаны такие сценарии, как **создание разделов и подписок, создание фильтров подписок, отправка сообщений** в раздел, **получение сообщений из подписки** и
**Удаление разделов и подписок**. Дополнительную информацию о разделах и подписках см. в разделе [Дальнейшие действия](#Next_Steps) .

[AZURE.INCLUDE [howto-service-bus-topics](../includes/howto-service-bus-topics.md)]

**Примечание.** Если требуется установить Python или [пакет Azure для Python][пакет Python для Azure], см. [Руководство по установке Python](../python-how-to-install/).


## Как создать раздел

Работать с разделами позволяет объект **ServiceBusService**. Добавьте следующий код в начало любого файла Python, из которого планируется получать доступ к служебной шине Azure программным способом:

	from azure.servicebus import ServiceBusService, Message, Topic, Rule, DEFAULT_RULE_NAME

Следующий код создает объект **ServiceBusService**. Замените 'mynamespace', 'sharedaccesskeyname' и 'sharedaccesskey' настоящим пространством имен, именем и значением ключа SAS.

	bus_service = ServiceBusService(
		service_namespace='mynamespace',
		shared_access_key_name='sharedaccesskeyname',
		shared_access_key_value='sharedaccesskey')

Значения для имени и параметра ключа SAS можно найти в сведениях о подключении к порталу Azure или в окне "Свойства" Visual Studio при выборе пространства имен шины обслуживания в обозревателе сервера (как показано в предыдущем разделе).

	bus_service.create_topic('mytopic')

**create\_topic**  также поддерживает дополнительные параметры, позволяющие переопределить настройки раздела по умолчанию, такие как срок жизни или максимальный размер раздела. В следующем примере показано, как установить максимальный размер раздела 5 ГБ и срок жизни 1 минута:

	topic_options = Topic()
	topic_options.max_size_in_megabytes = '5120'
	topic_options.default_message_time_to_live = 'PT1M'

	bus_service.create_topic('mytopic', topic_options)

## Как создавать подписки

Подписки раздела также создаются с помощью объекта **ServiceBusService**. У подписок есть имена, и они могут использовать дополнительный фильтр, ограничивающий набор сообщений, доставляемых в виртуальную очередь подписки.

**Примечание**. Подписки являются постоянными и продолжают существовать либо до их удаления, либо до удаления раздела, с которым они связаны.

### Создание подписки с фильтром по умолчанию (MatchAll)

Фильтр **MatchAll** является фильтром по умолчанию, используемым, если при создании новой подписки не указан фильтр. Если используется фильтр **MatchAll**, все сообщения, опубликованные в разделе, помещаются в виртуальную очередь подписки. В следующем примере создается подписка с именем 'AllMessages' и используется фильтр по умолчанию **MatchAll**.

	bus_service.create_subscription('mytopic', 'AllMessages')

### Создание подписок с фильтрами

Вы также можете настроить фильтры, позволяющие определять, какие сообщения, отправленные в раздел, будут отображаться в определенной подписке раздела.

Самым гибким типом фильтра, поддерживаемым подписками, является
**SqlFilter**, реализующий подмножество SQL92. Фильтры SQL работают со свойствами сообщений, которые опубликованы в разделе. Дополнительную информацию о выражениях, которые можно использовать с фильтром SQL, см. в описании синтаксиса [SqlFilter.SqlExpression][].

Фильтры в подписку можно добавить с помощью метода **create\_rule** объекта **ServiceBusService**. Этот метод позволяет добавлять новые фильтры в существующую подписку.

**Примечание**. Так как фильтр по умолчанию автоматически применяется ко всем новым подпискам, необходимо сначала удалить фильтр по умолчанию. Иначе
**MatchAll** изменит поведение всех остальных заданных фильтров. Правило по умолчанию можно переопределить с помощью метода **delete\_rule**
объекта **ServiceBusService**.

В следующем примере создается подписка с именем  'HighMessages' и фильтром
**SqlFilter**, который выбирает только сообщения, у которых значение пользовательского свойства
**messagenumber** больше 3:

	bus_service.create_subscription('mytopic', 'HighMessages')

	rule = Rule()
	rule.filter_type = 'SqlFilter'
	rule.filter_expression = 'messagenumber > 3'

	bus_service.create_rule('mytopic', 'HighMessages', 'HighMessageFilter', rule)
	bus_service.delete_rule('mytopic', 'HighMessages', DEFAULT_RULE_NAME)

Аналогично, в следующем примере создается подписка с именем
"LowMessages" с **SqlFilter**, который выбирает только сообщения, значение свойства **messagenumber** у которых меньше или равно 3:

	bus_service.create_subscription('mytopic', 'LowMessages')

	rule = Rule()
	rule.filter_type = 'SqlFilter'
	rule.filter_expression = 'messagenumber <= 3'

	bus_service.create_rule('mytopic', 'LowMessages', 'LowMessageFilter', rule)
	bus_service.delete_rule('mytopic', 'LowMessages', DEFAULT_RULE_NAME)

Если сообщение отправляется в раздел  'mytopic', оно всегда будет доставляться в приемники, подписанные на подписку раздела  'AllMessages', и в отдельные приемники, подписанные на подписки разделов  'HighMessages' и 'LowMessages' (в зависимости от содержимого сообщений).

## Как отправлять сообщения в раздел

Чтобы отправить сообщение в раздел служебной шины, ваше приложение должно использовать метод **send\_topic\_message** объекта **ServiceBusService**.

В следующем примере показано, как отправить пять тестовых сообщений в 'mytopic'. Обратите внимание: значения свойств **messagenumber** сообщений зависят от итерации цикла (это определяет получающую подписку).

	for i in range(5):
		msg = Message('Msg {0}'.format(i).encode('utf-8'), custom_properties={'messagenumber':i})
		bus_service.send_topic_message('mytopic', msg)

Разделы служебной шины поддерживают максимальный размер сообщения в 256 МБ (максимальный размер заголовка, содержащего стандартные и настраиваемые свойства приложения - 64 МБ). Ограничения на количество сообщений в разделе нет, но есть максимальный общий размер сообщений, содержащихся в разделе. Этот размер раздела определяется при создании с верхним пределом 5 ГБ.

## Как получать сообщения из подписки

Для получения сообщений от подписки используется метод
метод **receive\_subscription\_message** объекта **ServiceBusService**:

	msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=False)
	print(msg.body)

Сообщения удаляются из подписки по мере их прочтения, когда параметр
**peek\_lock** установлен в **False**. Вы можете читать (заглядывать), извлекать и блокировать сообщение, не удаляя его из очереди, настроив для параметра
**peek\_lock** значение **True**.

Поведение по умолчанию - чтение и удаление сообщения как часть операции получения - является простейшей моделью, оптимальной для сценариев, в которых приложение может не обрабатывать сообщение в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку служебная шина помечает сообщение как использованное, то, когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.


Если параметр **peek\_lock** имеет значение **True**, получение становится операцией из двух этапов, что позволяет поддерживать приложения, неустойчивые к пропуску сообщений. Получив запрос, служебная шина находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению.
Заканчивая обработку сообщения (или надежно сохраняя его для будущей обработки), приложение завершает второй этап процесса получения, вызывая метод **delete** объекта **Message**.
Метод **delete** помечает сообщение как используемое и удаляет его из подписки.

	msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=True)
	print(msg.body)

	msg.delete()


## Как обрабатывать сбои приложения и нечитаемые сообщения

Служебная шина предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock** для объекта **Message**. После этого служебная шина разблокирует сообщение в подписке и снова сделает его доступным для получения тем же или другим приложением.

Кроме того, с сообщением, заблокированным в подписке, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), то
Служебная шина разблокирует сообщение автоматически и снова сделает его доступным для получения.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода **delete**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют
**обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью
свойства **MessageId** сообщения, которое остается постоянным для различных попыток доставки.

## Как удалять разделы и подписки

Разделы и подписки хранятся постоянно, и их нужно удалять явным образом на портале управления Azure или программными средствами.
В приведенном ниже примере показано, как удалить раздел 'mytopic':

	bus_service.delete_topic('mytopic')

При удалении раздела также удаляются все подписки, зарегистрированные в этом разделе. Подписки также можно удалять по отдельности. В следующем примере кода показано, как удалить подписку с именем
HighMessages из раздела  'mytopic':

	bus_service.delete_subscription('mytopic', 'HighMessages')

## Дальнейшие действия

Вы узнали основные сведения о разделах служебной шины. Для получения дополнительных сведений используйте следующие ссылки.

-   См. справочник MSDN: [Очереди, разделы и подписки][].
-   Справочник по [SqlFilter.SqlExpression][].

[Портал управления Azure]: http://manage.windowsazure.com
[пакет Python для Azure]: https://pypi.python.org/pypi/azure  
[Очереди, разделы и подписки]: http://msdn.microsoft.com/library/hh367516.aspx
[SqlFilter.SqlExpression]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.sqlfilter.sqlexpression.aspx

<!--HONumber=47-->
