<properties linkid="develop-python-service-bus-topics" urlDisplayName="Разделы Service Bus" pageTitle="Использование разделов Service Bus (Python) — Azure" metaKeywords="приступая к работе с разделами Service Bus Azure, публикация сообщений подписки Python" description="Узнайте, как использовать разделы и подписки Service Bus в Azure. Примеры кода написаны для приложений Python." metaCanonical="" services="service-bus" documentationCenter="Python" title="Использование разделов и подписок Service Bus" authors="" solutions="" manager="" editor="" />





# Использование разделов и подписок Service Bus
В этом руководстве показано, как использовать разделы и подписки Service Bus в приложениях Python. В этой статье описаны такие сценарии, как **создание разделов и подписок, создание фильтров подписок, отправка сообщений** в раздел, **получение сообщений из подписки** и
**удаление разделов и подписок**. Дополнительные сведения о разделах и подписках см. в разделе [Дальнейшие действия](#Next_Steps).

## Оглавление

-   [Что такое разделы и подписки Service Bus?](#what-are-service-bus-topics)
-   [Создание пространства имен службы](#create-a-service-namespace)
-   [Получение учетных данных управления по умолчанию для пространства имен](#obtain-default-credentials)
-   [Практическое руководство. Создание раздела](#How_to_Create_a_Topic)
-   [Практическое руководство. Создание подписок](#How_to_Create_Subscriptions)
-   [Практическое руководство. Отправка сообщений в раздел](#How_to_Send_Messages_to_a_Topic)
-   [Практическое руководство. Получение сообщений от подписки](#How_to_Receive_Messages_from_a_Subscription)
-   [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений](#How_to_Handle_Application_Crashes_and_Unreadable_Messages)
-   [Практическое руководство. Удаление разделов и подписок](#How_to_Delete_Topics_and_Subscriptions)
-   [Следующие шаги](#Next_Steps)


[WACOM.INCLUDE [howto-service-bus-topics](../includes/howto-service-bus-topics.md)]

**Примечание.** Если нужно установить клиентские библиотеки или Python, см. [руководство по установке Python](../python-how-to-install/)


##<a name="How_to_Create_a_Topic"></a>Создание раздела

Работать с разделами позволяет объект **ServiceBusService**. Добавьте следующий код в начало любого файла Python, из которого планируется получать доступ к Service Bus Azure программным способом:

	from azure.servicebus import *

Следующий код создает объект **ServiceBusService**. Замените атрибуты mynamespace, mykey и myissuer на фактические значения пространства имен, ключа и издателя.

	bus_service = ServiceBusService(service_namespace='mynamespace', account_key='mykey', issuer='myissuer')

	bus_service.create_topic('mytopic')

**create\_topic** также поддерживает дополнительные параметры,
позволяющие переопределить настройки раздела по умолчанию, такие как срок жизни
или максимальный размер раздела. В следующем примере показано, как установить максимальный размер раздела 5 ГБ и срок жизни 1 минута:

	topic_options = Topic()
	topic_options.max_size_in_megabytes = '5120'
	topic_options.default_message_time_to_live = 'PT1M'

	bus_service.create_topic('mytopic', topic_options)

##<a name="How_to_Create_Subscriptions"></a>Создание подписок

Подписки на разделы также создаются с помощью объекта **ServiceBusService**. У подписок есть имена, и они могут использовать дополнительный фильтр, ограничивающий набор сообщений, доставляемых в виртуальную очередь подписки.

**Примечание**. Подписки сохраняются и продолжают существовать до их удаления
или удаления раздела, с которым они связаны.

### Создание подписки с фильтром по умолчанию (MatchAll)

Фильтр **MatchAll** является фильтром по умолчанию, используемым, если при создании новой подписки не указан фильтр. Если используется фильтр **MatchAll**, все сообщения, опубликованные в разделе, помещаются в виртуальную очередь подписки. В следующем примере создается подписка с именем "AllMessages" и используется фильтр по умолчанию **MatchAll**.

	bus_service.create_subscription('mytopic', 'AllMessages')

### Создание подписок с фильтрами

Также можно настроить фильтры, позволяющие определять, какие сообщения, отправленные в раздел, должны появляться в конкретной подписке раздела.

Самым гибким типом фильтра, поддерживаемым подписками, является
**SqlFilter**, реализующий подмножество SQL92. SQL-фильтры работают со свойствами сообщений, опубликованных в разделе. Дополнительные сведения о выражениях, которые можно использовать с SQL-фильтром, см. в описании синтаксиса [SqlFilter.SqlExpression][].

Фильтры в подписку можно добавить с помощью метода **create\_rule**
объекта **ServiceBusService**. Этот метод позволяет добавлять новые фильтры в существующую подписку.

**Примечание**. Поскольку ко всем новым подпискам автоматически применяется
фильтр по умолчанию, сначала необходимо удалить фильтр по умолчанию, либо
**MatchAll** изменит поведение всех остальных заданных фильтров. Правило
по умолчанию можно переопределить с помощью метода **delete\_rule**
объекта **ServiceBusService**.

В следующем примере создается подписка с именем "HighMessages" и фильтром
**SqlFilter**, которая выбирает только сообщения со значением пользовательского свойства
**messagenumber** больше 3:

	bus_service.create_subscription('mytopic', 'HighMessages')

	rule = Rule()
	rule.filter_type = 'SqlFilter'
	rule.filter_expression = 'messagenumber > 3'

	bus_service.create_rule('mytopic', 'HighMessages', 'HighMessageFilter', rule)
	bus_service.delete_rule('mytopic', 'HighMessages', DEFAULT_RULE_NAME)

Аналогично, следующий пример создает подписку с именем "LowMessages" и фильтром **SqlFilter**, который выбирает только сообщения, у которых значение свойства **messagenumber** меньше или равно 3:

	bus_service.create_subscription('mytopic', 'LowMessages')

	rule = Rule()
	rule.filter_type = 'SqlFilter'
	rule.filter_expression = 'messagenumber <= 3'

	bus_service.create_rule('mytopic', 'LowMessages', 'LowMessageFilter', rule)
	bus_service.delete_rule('mytopic', 'LowMessages', DEFAULT_RULE_NAME)

Теперь, если сообщение будет отправлено в раздел "mytopic", оно всегда будет доставляться
получателям, подписанным на подписку раздела "AllMessages", и выборочно доставляться
получателям, подписанным на подписки разделов "HighMessages" и "LowMessages"
(в зависимости от содержимого сообщений).

##<a name="How_to_Send_Messages_to_a_Topic"></a>Отправка сообщений в раздел

Чтобы отправить сообщение в разделе Service Bus, приложение должно использовать
метод **send\_topic\_message** объекта **ServiceBusService**.

В следующем примере показано, как отправить пять тестовых сообщений в раздел
"mytopic". Обратите внимание, что значение свойства **messagenumber** каждого сообщения зависит от итерации цикла (определяет, какие подписки получат это сообщение).

	for i in range(5):
		msg = Message('Msg ' + str(i), custom_properties={'messagenumber':i})
		bus_service.send_topic_message('mytopic', msg)

Разделы Service Bus поддерживают максимальный размер сообщения 256 МБ (максимальный размер заголовка, содержащего стандартные и настраиваемые свойства приложения — 64 МБ). Ограничения на количество сообщений в разделе нет, но есть ограничение на максимальный общий размер сообщений в разделе. Этот размер раздела определяется при создании с верхним пределом 5 ГБ.

##<a name="How_to_Receive_Messages_from_a_Subscription"></a>Получение сообщений от подписки

Для получения сообщений от подписки используется метод
**receive\_subscription\_message** объекта
**ServiceBusService**:

	msg = bus_service.receive_subscription_message('mytopic', 'LowMessages')
	print(msg.body)

Прочитанные сообщения удаляются из подписки.
Но можно прочитать (извлечь) сообщение и заблокировать его
удаление из подписки, задав для необязательного
параметра **peek\_lock** значение **True**.

Поведение по умолчанию — чтение и удаление сообщения как часть операции получения — является простейшей моделью, оптимальной для сценариев, в которых приложение может не обрабатывать сообщение в случае сбоя. Чтобы разобраться, рассмотрим сценарий, в котором приложение-получатель выдает запрос на получение, после чего происходит сбой этого приложения еще до обработки сообщения. Поскольку Service Bus помечает сообщение как использованное, то когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.

	
Если параметр **peek\_lock** имеет значение **True**, получение становится
операцией из двух этапов, что позволяет поддерживать приложения,
не устойчивые к пропуску сообщений. Получив запрос, Service Bus находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению.
Когда приложение завершает обработку сообщения (или сохраняет его для будущей
обработки), шина Service Bus завершает второй этап процесса получения,
вызывая метод **delete** объекта **Message**. Метод **delete** помечает
сообщение как использованное и удаляет его из подписки.

	msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=True)
	print(msg.body)
	
	msg.delete()
	

##<a name="How_to_Handle_Application_Crashes_and_Unreadable_Messages"></a>Обработка сбоев приложения и нечитаемых сообщений

Service Bus предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если
приложение-получатель по каким-либо причинам не может обработать сообщение,
то оно может вызвать метод **unlock**
объекта **Message**. После этого Service Bus разблокирует сообщение в подписке и снова сделает его доступным для получения тем же или другим приложением.

Кроме того, с сообщением, заблокированным в подписке, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), Service Bus автоматически разблокирует сообщение и сделает его доступным для приема.

Если сбой приложения происходит после обработки сообщения, но перед вызовом
метода **delete**, это сообщение будет повторно доставлено в приложение
после его перезапуска. Часто этот подход называют
**обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны предусмотреть дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью
свойства **MessageId** сообщения, которое остается постоянным для различных попыток доставки.

##<a name="How_to_Delete_Topics_and_Subscriptions"></a>Удаление разделов и подписок

Разделы и подписки являются постоянными, и их необходимо удалять явным образом на портале управления Azure или программными средствами.
В приведенном ниже примере показано, как удалить раздел с именем "mytopic":

	bus_service.delete_topic('mytopic')

При удалении раздела также удаляются все подписки, зарегистрированные в этом разделе. Подписки также можно удалять по отдельности. В
следующем примере кода показано, как удалить подписку с именем
"HighMessages" из раздела "mytopic":

	bus_service.delete_subscription('mytopic', 'HighMessages')

##<a name="Next_Steps"></a>Дальнейшие действия

Вы узнали основные сведения о разделах Service Bus. Для получения дополнительных сведений используйте следующие ссылки.

-   См. справочник MSDN: [Очереди, разделы и подписки][].
-   Справочник по API для [SqlFilter][].

  [Следующие шаги]: #nextsteps
  [Что такое разделы и подписки Service Bus?]: #what-are-service-bus-topics
  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Практическое руководство. Создание раздела]: #How_to_Create_a_Topic
  [Практическое руководство. Создание подписок]: #How_to_Create_Subscriptions
  [Практическое руководство. Отправка сообщений в раздел]: #How_to_Send_Messages_to_a_Topic
  [Практическое руководство. Получение сообщений от подписки]: #How_to_Receive_Messages_from_a_Subscription
  [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]: #How_to_Handle_Application_Crashes_and_Unreadable_Messages
  [Удаление разделов и подписок]: #How_to_Delete_Topics_and_Subscriptions
  
  [Основные понятия раздела]: ../../../DevCenter/dotNet/Media/sb-topics-01.png
  [Портал управления Azure]: http://manage.windowsazure.com
  
  
  
  
  
  
  [очереди, разделы и подписки]: http://msdn.microsoft.com/ru-ru/library/hh367516.aspx
  [SqlFilter]: http://msdn.microsoft.com/ru-ru/library/windowsazure/microsoft.servicebus.messaging.sqlfilter.aspx

