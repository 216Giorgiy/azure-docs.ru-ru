<properties linkid="develop-python-service-bus-topics" urlDisplayName="Service Bus Topics" pageTitle="How to use Service Bus topics (Python) - Azure" metaKeywords="Get started Azure Service Bus topics publising subscribe messaging Python" description="Learn how to use Service Bus topics and subscriptions in Azure. Code samples are written for Python applications." metaCanonical="" services="service-bus" documentationCenter="Python" title="How to Use Service Bus Topics/Subscriptions" authors="huvalo" solutions="" manager="" editor="" />

<tags ms.service="service-bus" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="python" ms.topic="article" ms.date="01/01/1900" ms.author="huvalo" />

# Использование разделов и подписок Service Bus

В этом руководстве показано,
как использовать разделы и подписки Service Bus в приложениях Ruby. В этой статье описаны такие сценарии, как
**создание разделов и подписок, создание фильтров подписок,
отправка сообщений** в раздел,
**получение сообщений от подписки** и **удаление разделов и подписок**. Дополнительные сведения о разделах и подписках
см. в разделе [Дальнейшие действия][Дальнейшие действия].

## Оглавление

-   [Что такое разделы и подписки Service Bus?][Что такое разделы и подписки Service Bus?]
-   [Создание пространства имен службы][Создание пространства имен службы]
-   [Получение учетных данных управления по умолчанию для пространства имен][Получение учетных данных управления по умолчанию для пространства имен]
-   [Практическое руководство. Создание раздела][Практическое руководство. Создание раздела]
-   [Практическое руководство. Создание подписок][Практическое руководство. Создание подписок]
-   [Практическое руководство. Отправка сообщений в раздел][Практическое руководство. Отправка сообщений в раздел]
-   [Практическое руководство. Получение сообщений от подписки][Практическое руководство. Получение сообщений от подписки]
-   [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений][Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]
-   [Практическое руководство. Удаление разделов и подписок][Практическое руководство. Удаление разделов и подписок]
-   [Дальнейшие действия][Дальнейшие действия]

[WACOM.INCLUDE [руководство-разделы-service-bus](../includes/howto-service-bus-topics.md)]

**Примечание.** Если нужно установить клиентские библиотеки или Python, см. [Руководство по установке Python][Руководство по установке Python].

## <a name="How_to_Create_a_Topic"></a>Создание раздела

Работать с разделами позволяет объект **ServiceBusService**. Добавьте следующий код в начало любого файла Python, из которого планируется получать доступ к Service Bus Azure программным способом:

    from azure.servicebus import *

Следующий код создает объект **ServiceBusService**. Замените "пространство\_имен", "имя ключа общего доступа" и "ключ общего доступа" настоящим пространством имен, именем и параметром ключа подписи общего доступа (shared access signature (SAS)).

    bus_service = ServiceBusService(
        service_namespace='mynamespace',
        shared_access_key_name='sharedaccesskeyname',
        shared_access_key_value='sharedaccesskey')

Значения для имени и параметра ключа SAS можно найти в сведениях о подключении к порталу Azure или в окне "Свойства" Visual Studio при выборе пространства имен шины обслуживания в обозревателе сервера (как показано в предыдущем разделе).

    bus_service.create_topic('mytopic')

**create\_topic** также поддерживает дополнительные параметры,
позволяющие переопределить настройки раздела по умолчанию,
такие как срок жизни или максимальный размер раздела. В следующем примере показано,
как установить максимальный размер раздела 5 ГБ и срок жизни 1 минута.

    topic_options = Topic()
    topic_options.max_size_in_megabytes = '5120'
    topic_options.default_message_time_to_live = 'PT1M'

    bus_service.create_topic('mytopic', topic_options)

## <a name="How_to_Create_Subscriptions"></a>Создание подписок

Подписки на разделы также создаются с помощью объекта **ServiceBusService**
. Подписки имеют имена и могут использовать дополнительный фильтр,
который ограничивает набор сообщений,
доставляемых в виртуальную очередь подписки.

**Примечание**. Подписки являются постоянными и продолжают существовать либо до их удаления,
либо до удаления раздела, с которым они связаны.

### Создание подписки с фильтром по умолчанию (MatchAll)

Фильтр **MatchAll** является фильтром по умолчанию,
используемым, если при создании новой подписки не указан фильтр. Если используется фильтр **MatchAll**,
все сообщения, опубликованные в разделе,
размещаются в виртуальной очереди подписки. В следующем примере
создается подписка с именем AllMessages
и используется фильтр по умолчанию **MatchAll**.

    bus_service.create_subscription('mytopic', 'AllMessages')

### Создание подписок с фильтрами

Вы также можете настроить фильтры, позволяющие определять,
какие сообщения, отправленные в раздел, будут отображаться в определенной подписке раздела.

Самый гибкий тип фильтра, который поддерживается подписками, — это
**SqlFilter**, реализующий подмножество SQL92. Фильтры SQL работают со свойствами сообщений,
которые опубликованы в разделе. Дополнительные сведения о выражениях,
которые можно использовать с SQL-фильтром,
см. в описании синтаксиса [SqlFilter.SqlExpression][SqlFilter.SqlExpression].

Фильтры в подписку можно добавить с помощью метода **create\_rule**
объекта **ServiceBusService**. Этот метод позволяет добавлять новые фильтры
в существующую подписку.

**Примечание**. Поскольку ко всем новым подпискам автоматически применяется фильтр по умолчанию,
сначала необходимо удалить фильтр по умолчанию либо
**MatchAll** изменит поведение всех остальных заданных фильтров. Вы можете удалить правило по умолчанию
с помощью метода **delete\_rule** объекта
**ServiceBusService**.

В следующем примере создается подписка с именем "HighMessages" и фильтром
**SqlFilter**, который только выбирает сообщения, у которых значение пользовательского свойства
**messagenumber** превышает 3:

    bus_service.create_subscription('mytopic', 'HighMessages')

    rule = Rule()
    rule.filter_type = 'SqlFilter'
    rule.filter_expression = 'messagenumber > 3'

    bus_service.create_rule('mytopic', 'HighMessages', 'HighMessageFilter', rule)
    bus_service.delete_rule('mytopic', 'HighMessages', DEFAULT_RULE_NAME)

Аналогично следующий пример создает подписку
с именем LowMessages и фильтром **SqlFilter**, который выбирает только сообщения,
у которых значение свойства **messagenumber** меньше или равно 3.

    bus_service.create_subscription('mytopic', 'LowMessages')

    rule = Rule()
    rule.filter_type = 'SqlFilter'
    rule.filter_expression = 'messagenumber <= 3'

    bus_service.create_rule('mytopic', 'LowMessages', 'LowMessageFilter', rule)
    bus_service.delete_rule('mytopic', 'LowMessages', DEFAULT_RULE_NAME)

Теперь, если сообщение будет отправлено в раздел mytopic,
оно всегда будет доставляться получателям, подписанным на подписку раздела AllMessages,
и выборочно доставляться получателям, подписанным на подписки разделов
HighMessages и LowMessages (в зависимости от содержимого сообщений).

## <a name="How_to_Send_Messages_to_a_Topic"></a>Отправка сообщений в раздел

Чтобы отправить сообщение в раздел Service Bus, приложение должно использовать
метод **sendTopicMessage** объекта **ServiceBusService**.

В следующем примере показано,
как отправить пять тестовых сообщений в раздел mytopic. Обратите внимание,
что значение настраиваемого свойства **messagenumber** каждого сообщения
зависит от итерации цикла (это определяет, получит ли подписка сообщение).

    for i in range(5):
        msg = Message('Msg ' + str(i), custom_properties={'messagenumber':i})
        bus_service.send_topic_message('mytopic', msg)

Разделы Service Bus поддерживают максимальный размер сообщения 256 МБ
(максимальный размер заголовка, который содержит стандартные
и настраиваемые свойства приложения, — 64 МБ). Ограничения на количество сообщений в разделе нет,
но есть максимальный общий объем сообщений,
содержащихся в разделе. Этот максимальный объем задается при создании
с верхним пределом 5 ГБ.

## <a name="How_to_Receive_Messages_from_a_Subscription"></a>Получение сообщений из подписки

Сообщения извлекаются из очереди методом
**receive\_subscription\_message** объекта
**ServiceBusService**.

    msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=False)
    print(msg.body)

Прочитанные сообщения будут удаляться из подписки, если значение параметра
**peek\_lock** установлено на **False**. Вы можете читать, извлекать и блокировать сообщение,
не удаляя его из очереди, настроив значение параметра
**peek\_lock** на **True**.

Поведение по умолчанию — чтение и удаление сообщения
как часть операции получения — является простейшей моделью,
оптимальной для сценариев, в которых приложение может не обрабатывать сообщение
в случае сбоя. Чтобы это понять, рассмотрим сценарий,
в котором объект-получатель выдает запрос на получение и выходит из строя
до его обработки. Поскольку Service Bus помечает сообщение как используемое,
то, когда после перезапуска приложение снова начинает обрабатывать сообщения,
оно пропустит то из них, которое использовалось до сбоя.

Если параметр **peek\_lock** имеет значение **True**,
получение становится операцией из двух этапов, что позволяет поддерживать приложения,
неустойчивые к пропуску сообщений. Получив запрос, Service Bus находит следующее сообщение,
блокирует его, чтобы предотвратить его получение другими получателями,
и возвращает его приложению.
Когда приложение завершает обработку сообщения
(или сохраняет его для будущей обработки), она завершает второй этап процесса получения,
вызывая метод **delete** объекта **Message**.
Метод **delete** помечает сообщение как использованное
и удаляет его из подписки.

    msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=True)
    print(msg.body)

    msg.delete()

\#\#<a name="How_to_Handle_Application_Crashes_and_Unreadable_Messages"></a>Обработка сбоев приложения и нечитаемых сообщений

Service Bus предоставляет функции,
помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель
по каким-либо причинам не может обработать сообщение,
то оно может вызвать метод **unlock** объекта
**Message**. После этого Service Bus
разблокирует сообщение в подписке
и сделает его доступным для приема либо тем же,
либо другим приложением.

Кроме того,
с сообщением, заблокированным в очереди, связано время ожидания.
Если приложение не сможет обработать сообщение в течение времени ожидания
(например, при сбое приложения), Service Bus разблокирует сообщение автоматически
и сделает его доступным для приема.

Если в приложении происходит сбой после обработки сообщения,
но перед вызовом метода **delete**,
сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют
**обработать хотя бы один раз**,
т. е. каждое сообщение будет обрабатываться по крайней мере один раз,
но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима,
разработчики приложения должны добавить дополнительную логику
для обработки повторной доставки сообщений. Часто это достигается с помощью свойства
**MessageId** сообщения,
которое остается постоянным для различных попыток доставки.

## <a name="How_to_Delete_Topics_and_Subscriptions"></a>Удаление разделов и подписок

Разделы и подписки являются постоянными,
и их необходимо удалять явным образом на портале управления Azure или программными средствами.
В приведенном ниже примере показано, как удалить раздел с именем mytopic.

    bus_service.delete_topic('mytopic')

При удалении раздела также удаляются все подписки,
зарегистрированные в этом разделе. Подписки также можно удалять по отдельности. В следующем примере кода показано,
как удалить подписку с именем HighMessages
из раздела mytopic.

    bus_service.delete_subscription('mytopic', 'HighMessages')

## <a name="Next_Steps"></a> Дальнейшие действия

Вы узнали основные сведения о разделах Service Bus.
Для получения дополнительных сведений используйте следующие ссылки:

-   См. справочник MSDN: [Очереди, разделы и подписки][Очереди, разделы и подписки].
-   Справочник API для [SqlFilter][SqlFilter].

  [Дальнейшие действия]: #Next_Steps
  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Практическое руководство. Создание раздела]: #How_to_Create_a_Topic
  [Практическое руководство. Создание подписок]: #How_to_Create_Subscriptions
  [Практическое руководство. Отправка сообщений в раздел]: #How_to_Send_Messages_to_a_Topic
  [Практическое руководство. Получение сообщений от подписки]: #How_to_Receive_Messages_from_a_Subscription
  [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]: #How_to_Handle_Application_Crashes_and_Unreadable_Messages
  [Практическое руководство. Удаление разделов и подписок]: #How_to_Delete_Topics_and_Subscriptions
  [Руководство по установке Python]: ../python-how-to-install/
  [Очереди, разделы и подписки]: http://msdn.microsoft.com/ru-ru/library/hh367516.aspx
  [SqlFilter]: http://msdn.microsoft.com/ru-ru/library/windowsazure/microsoft.servicebus.messaging.sqlfilter.aspx
