<properties 
   pageTitle="Обзор определяемых пользователем маршрутов и IP-пересылки"
   description="Обзор определяемых пользователем маршрутов (UDR) и IP-пересылки"
   services="virtual-networks"
   documentationCenter="na"
   authors="telmosampaio"
   manager="adinah"
   editor="tysonn" /> <tags 
   ms.service="virtual-networks"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="04/22/2015"
   ms.author="telmos" />

# Определяемые пользователем маршруты и IP-пересылка
Azure использует таблицу маршрутизации, чтобы определить, как пересылать IP-трафик на основе места назначения каждого пакета. Хотя Azure предоставляет таблицу маршрута по умолчанию на основе заданных параметров виртуальной сети, в нее может потребоваться добавить пользовательские маршруты. Чаще всего потребность в пользовательских записях в таблице маршрутов связана с использованием виртуального устройства в среде Azure. Рассмотрите сценарий, показанный на рисунке ниже. Предположим, что нужно убедиться, что весь трафик, направленный в подсети среднего уровня и резервные подсети, инициируемый из подсети интерфейса, проходит через брандмауэр виртуального устройства. Это не получится сделать, просто добавив устройство в виртуальную сеть и подключив его к разным подсетям. Необходимо также изменить таблицу маршрутизации, применяемую к подсети, чтобы пакеты перенаправлялись в брандмауэр виртуального устройства.

Это так же верно, если вы внедрили виртуальное устройство NAT для контроля трафика между виртуальной сетью Azure и Интернетом. Чтобы убедиться, что виртуальное устройство используется, необходимо создать маршрут, указав, что весь трафик, предназначенный для Интернета, должен передаваться в виртуальное устройство.

## Маршрутизация
Пакеты маршрутизируются по сети TCP/IP на основе таблицы маршрутов, определенной на каждом узле физической сети. Таблица маршрутов — набор отдельных маршрутов, с помощью которой определяется, куда пересылать пакеты по IP-адресу назначения. Маршрут состоит из следующих частей:

- **Префикс адреса**. Маршрутизация CIDR назначения, к которой относится маршрут, например 10.1.0.0/16.
- **Тип следующего прыжка**. Тип прыжка Azure, куда должны отправляться пакеты. Возможные значения:
	- **Локальный**. Представляет локальную виртуальную сеть. Например, при наличии двух подсетей, 10.1.0.0/16 и 10.2.0.0/16, в одной виртуальной сети маршрут для каждой подсети в таблице маршрутов будет значение *Локальный* для следующего прыжка.
	- **Шлюз VPN**. Представляет шлюз VPN типа «сеть-сеть» Azure. 
	- **Интернет**. Представляет используемый по умолчанию шлюз Интернета, предоставленный инфраструктурой Azure. 
	- **Виртуальное устройство**. Представляет виртуальное устройство, добавленное в виртуальную сеть Azure.
	- **NULL**. Представляет «черную дыру». Пакеты, пересылаемые в «черную дыру», вообще никуда не пересылаются.
- **Значение следующего прыжка**. Значение следующего прыжка содержит IP-адрес, на который должны быть переадресованы пакеты. Значения следующего прыжка допускаются только в маршрутах, где следующий тип перехода — *Виртуальное устройство*.

## Маршруты по умолчанию
Каждая подсеть, создаваемая в виртуальной сети, автоматически связывается с таблицей маршрутов, содержащей следующие правила маршрута по умолчанию:- **Правило локальной виртуальной сети**: это правило создается автоматически для каждой подсети в виртуальной сети. Оно указывает, что существует прямая связь между виртуальными машинами в виртуальной сети, без промежуточного следующего прыжка. - **Правило локальной среды**: это правило применяется для всего трафика, предназначенного для локального диапазона адресов, и использует шлюз VPN в качестве следующего прыжка назначения. - **Правило Интернета**: это правило обрабатывает весь трафик, направляемый в общедоступный Интернет, и использует шлюз Интернета инфраструктуры как следующий прыжок для всего трафика, предназначенного для Интернета.

## Маршруты BGP
При наличии подключения ExpressRoute между локальной сетью и Azure  можно включить BGP, чтобы распространить маршруты из локальной сети в Azure. Эти маршруты BGP используются так же, как и маршруты по умолчанию и определенные пользователем маршруты в каждой подсети Azure. Дополнительную информацию см. в разделе [Введение в ExpressRoute](../expressroute-introduction).

[AZURE.IMPORTANT]Вы можете настроить среду Azure для использования принудительного туннелирования через локальную сеть, создав определяемый пользователем маршрут для подсети 0.0.0.0/0, использующий в качестве следующего прыжка шлюз VPN. Тем не менее, это работает только при использовании шлюза VPN, не ExpressRoute. Для ExpressRoute принудительное туннелирование настраивается с помощью BGP.

## Определяемые пользователем маршруты
Невозможно просмотреть маршруты по умолчанию, указанных выше, в среде Azure, и для большинства сред достаточно только этих маршрутов. Тем не менее, в конкретных случаях может потребоваться создать таблицу маршрутов и добавить один или несколько маршрутов, например:

- Принудительное туннелирование для доступа к Интернету через вашу локальную сеть.
- Использование виртуальных устройств в среде Azure.
- 
В приведенном выше сценарии необходимо будет создать таблицу маршрутов и добавить в нее определяемые пользователем маршруты. Можно использовать несколько таблиц маршрутов, и одна таблица маршрутов может быть связана с одной или несколькими подсетями. А каждая подсеть может быть связана только с одной таблицей маршрутов. Все виртуальные машины и облачные службы в подсети используют таблицу маршрутов, связанную с этой подсетью.

Пока подсетью не связана таблица маршрутов, она использует маршруты по умолчанию. После того, как эта связь установлена, маршрутизация выполняется по совпадению наиболее длинного префикса (LPM) среди определяемых пользователем маршрутов и маршрутов по умолчанию. При наличии более одного маршрута с одинаковыми совпадающими значениями LPM маршрут выбирается по источнику в следующем порядке:

1. определяемый пользователем маршрут;
1. маршрут BGP (если используется ExpressRoute);
1. маршрут по умолчанию.

[AZURE.IMPORTANT]Определяемые пользователем маршруты применяются только для виртуальных машин и облачных служб Azure. Например, если вы хотите добавить виртуальное устройство брандмауэра между локальной сетью и Azure, потребуется создать определяемый пользователем маршрут для таблиц маршрутов Azure и перенаправлять весь трафик, передаваемый в локальное адресное пространство, в виртуальное устройство. Однако входящий трафик из локального адресного пространства будет проходить через ваш шлюз VPN или канал ExpressRoute непосредственно в среду Azure, обходя виртуальное устройство.

## IP-пересылка
Как описано выше, одной из основных причин для создания определяемого пользователем маршрута является переадресация трафика в виртуальное устройство. Виртуальное устройство — это просто виртуальная машина, которая запускает приложение, используемое для обработки сетевого трафика определенным образом, например, как брандмауэр или устройство NAT.

Эта виртуальная машина виртуального устройства должна иметь возможность получать входящий трафик, предназначенный не ей. Чтобы разрешить виртуальной машине получать трафик, направленный в другие назначения, в ней необходимо включить IP-пересылку.

## См. также

[Как создать маршруты и включить IP-пересылку в Azure](../virtual-networks-udr-how-to)

[Общедоступный IP-адрес уровня экземпляра (ILIP)](../virtual-networks-instance-level-public-ip)

[Обзор виртуальной сети](https://msdn.microsoft.com/library/azure/jj156007.aspx)

<!--HONumber=52-->
