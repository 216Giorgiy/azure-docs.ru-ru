<properties linkid="develop-net-tutorials-multi-tier-web-site-1-overview" urlDisplayName="Шаг 1. Обзор" pageTitle="Многоуровневое веб-приложение ASP.NET в Azure - шаг 1: обзор" metaKeywords="учебник Azure, приложение службы списка сообщений, архитектура службы электронной почты, обзор учебника Azure, многоуровневые Azure, хранилище Azure, BLOB-объекты Azure, таблицы Azure, очереди Azure" description="Ознакомьтесь с учебником в 5 частях по многоуровневому веб-приложению Azure." metaCanonical="" services="cloud-services,storage" documentationCenter=".NET" title="Учебник по многоуровневому веб-сайту ASP.NET MVC - шаг 1: обзор" authors="tdykstra,riande" solutions="" manager="wpickett" editor="mollybos" />

# Многоуровневое веб-приложение ASP.NET, использующее таблицы, очереди и BLOB-объекты хранилища Azure - 1 из 5

В этой серии учебников показано, как создать многоуровневое веб-приложение ASP.NET MVC, использующее таблицы, очереди и BLOB-объекты хранилища Azure, и развернуть его в облачной службе Azure. Учебники разработаны для читателей, не имеющих опыта использования платформы Azure. После завершения данной серии вы узнаете, как построить отказоустойчивое и масштабируемое веб-приложение, управляемое данными, и развернуть его в облаке.

Этот материал доступен в качестве бесплатной электронной книги в 
[коллекции электронных книг TechNet](http://social.technet.microsoft.com/wiki/contents/articles/11608.e-book-gallery-for-microsoft-technologies.aspx#ASPNETMultiTierWindowsAzureApplicationUsingStorageTablesQueuesandBlobs).

<h2><a name="whatyoulllearn"></a><span class="short-header">Изучаемые темы</span>Изучаемые темы</h2>

В данной серии учебников вы узнаете следующее:

* Как подготовить компьютер к разработке для Azure путем установки пакета Azure SDK.
* Как создать облачный проект Visual Studio с веб-ролью ASP.NET MVC и двумя рабочими ролями.
* Как опубликовать облачный проект в облачной службе Azure.
* Как при необходимости опубликовать проект MVC на веб-сайте Azure и продолжить использовать рабочие роли в облачной службе.
* Как использовать службу хранилища очередей Azure для связи между уровнями или рабочими ролями.
* Как использовать службу хранилища таблиц Azure в качестве масштабируемого хранилища нереляционных структурированных данных.
* Как использовать службу BLOB-объектов Azure для хранения файлов в облаке.
* Как просмотреть и изменить таблицы, очереди и BLOB-объекты Azure с помощью Visual Studio или обозревателя хранилища Azure.
* Как использовать SendGrid для отправки сообщения электронной почты.
* Как настроить трассировку и просматривать данные трассировки.
* Как масштабировать приложение, увеличивая число экземпляров рабочих ролей.

<h2><a name="frontendoverview"></a><span class="short-header">Обзор внешнего интерфейса</span>Обзор внешнего интерфейса</h2>

Приложение, которое вы построите, представляет собой службу списка сообщений электронной почты. Внешний интерфейс многоуровневого приложения включает в себя веб-страницы, которые администраторы службы используют для управления списками электронной почты.

![Страница индексов списков рассылки][mtas-mailing-list-index-page]

![Страница индексов подписчиков][mtas-subscribers-index-page]

Имеется также набор страниц, которые администраторы используют для создания сообщений, отправляемых в список электронной почты.

![Страница индексов сообщений][mtas-message-index-page]

![Страница создания сообщения][mtas-message-create-page]

Клиенты службы — это компании, которые предоставляют своим клиентам возможность подписаться на список рассылки на клиентском веб-сайте. Например, администратор настраивает список для объявлений отдела истории университета Contoso. Когда студент, заинтересованный в объявлениях отдела истории, щелкает ссылку на веб-сайте университета Contoso, университет Contoso выполняет вызов веб-службы в приложение службы электронной почты Azure. Метод обслуживания приводит к отправке сообщения электронной почты клиенту. Сообщение электронной почты содержит гиперссылку, и когда получатель выбирает эту ссылку, отображается страница, приглашающая клиента в список объявлений отдела истории.

![Подтверждение по электронной почте][mtas-subscribe-email]

![Страница приветствия для списка][mtas-subscribe-confirmation-page]

Каждое отправляемое службой сообщение электронной почты (за исключением подтверждения подписки) содержится гиперссылка, которая может использоваться для отмены подписки. Когда получатель выбирает эту ссылку, на веб-странице отображается запрос на подтверждение отказа от подписки. 

![Страница подтверждения отмены подписки][mtas-unsubscribe-query-page]

Если получатель нажимает кнопку **Подтвердить**, отображается страница, подтверждающая удаление пользователя из списка.

![Страница с подтверждением отмены подписки][mtas-unsubscribe-confirmation-page]




<h2><a name="whyanemaillistapp"></a><span class="short-header">Учебники</span>Серии учебников</h2>

Здесь приведен список учебников со сводкой их содержания:

1. **Введение в приложение службы электронной почты Azure** (этот учебник). Обзор приложения и его архитектуры.
2. [Настройка и развертывание приложения службы электронной почты Azure][tut2] Процедура загрузки примера приложения, его настройки, локального тестирования, развертывания и тестирования в облаке.  
3. [Создание веб-роли для приложения службы электронной почты Azure][tut3] Процедура создания компонентов MVC 4 приложения и их локального тестирования.
4. [Создание рабочей роли A (планировщик электронной почты) для приложения службы электронной почты Azure][tut4]. Процедура построения серверного компонента, который создает очередь рабочих элементов для отправки сообщений электронной почты, и его локального тестирования.
5. [Создание рабочей роли B (отправитель электронной почты) для приложения службы электронной почты Azure][tut5]. Процедура построения серверного компонента, который обрабатывает очередь рабочих элементов для отправки сообщений электронной почты, и его локального тестирования.

Если нужно просто загрузить приложение и опробовать его, вам нужно пройти два первых учебника.  Если требуется ознакомиться со всеми этапами построения приложения "с нуля", пройдите три оставшихся учебника после прохождения двух первых.



<h2><a name="whyanemaillistapp"></a><span class="short-header">Аргументы в пользу данного приложения</span>Аргументы в пользу приложения службы списка электронной почты</h2>

Мы выбрали службу списка электронной почты для этого примера приложения, поскольку этот тип приложения должен быть устойчивым к сбоям и масштабируемым, благодаря чему он отлично подходит для Azure.  

### Устойчивость 

В случае сбоя сервера при отправке сообщений электронной почты в крупный список необходимо иметь возможность легко и быстро подключить новый сервер и оперативно продолжить прерванную работу приложения без потери и дублирования сообщений электронной почты. В случае сбоя экземпляр веб-роли или рабочей роли (виртуальная машина) облачной службы Azure автоматически заменяется. А очереди и таблицы хранилища Azure позволяют реализовать такую связь между серверами, которая при сбое не утрачивает работоспособность.

### Масштабируемость

Служба электронной почты также должна обрабатывать пиковые нагрузки, поскольку иногда вы отправляете сообщения в совсем маленькие списки, а иногда — в очень большие.  Во многих средах размещения необходимо приобрести и поддерживать достаточный парк оборудования для обработки пиковых рабочих нагрузок, и вы оплачиваете эти ресурсы 100 % всего времени, хотя можете использовать их только 5 % времени.  Благодаря Azure вы платите только за необходимый объем вычислительной мощности и только тогда, когда нуждаетесь в этих ресурсах.  Чтобы осуществить вертикальное масштабирование для расширения почтовой системы, вы просто изменяете параметр конфигурации для увеличения числа серверов, доступных для обработки рабочей нагрузки, при этом можно пользоваться и программными средствами.  Например, можно настроить приложение таким образом, чтобы количество элементов в очереди превышало определенное число, при этом Azure автоматически запускает дополнительные экземпляры рабочей роли, обрабатывающие эти рабочие элементы.




<h2><a name="backendoverview"></a><span class="short-header">Обзор серверной части</span>Обзор серверной части</h2>

Внешний интерфейс хранит в таблицах Azure списки адресов электронной почты и сообщения для отправки по ним. Когда администратор планирует отправку сообщения, в таблицу `message` добавляется строка с запланированной датой и другими данными, например строкой темы. Рабочая роль периодически сканирует таблицу `message` на предмет сообщений, которые необходимо отправить (мы назовем ее рабочей ролью A). 

Когда рабочая роль A находит сообщение для отправки, она выполняет следующие задачи:

* Получает все адреса электронной почты в списке конечных адресов электронной почты.
* Помещает в таблицу `message` сведения, необходимые для отправки каждого сообщения электронной почты.
* Создает очередь рабочих элементов для каждого сообщения электронной почты, которое нужно отправить. 

Вторая рабочая роль (рабочая роль B) опрашивает эту очередь на наличие рабочих элементов. Когда рабочая роль B находит рабочий элемент, оно обрабатывает его, отправив сообщение электронной почты, а затем удаляет из очереди. На следующей схеме показаны соответствующие взаимосвязи.

![Обработка сообщений электронной почты][mtas-worker-roles-a-and-b]

Если рабочая роль B отключается и требуется перезапуска, пропуск сообщений отсутствует, поскольку рабочий элемент очереди для сообщения электронной почты удаляется только после отправки сообщения. В серверной части также реализована обработка таблиц, которая предотвращает отправку нескольких сообщений, когда происходит сбой рабочей роли A и требуется ее перезапуск. В этом случае для конечного адреса электронной почты в очереди может быть создано несколько рабочих элементов. Но для каждого конечного адреса электронной почты строка в таблице `message` указывает, было ли отправлено данное сообщение электронной почты. В зависимости от времени перезапуска и обработки электронной почты эту строку использует рабочая роль A , чтобы избежать создания второго рабочего элемента в очереди, либо рабочая роль B, чтобы избежать отправки второго сообщения электронной почты.

![Предотвращение дублирования сообщений электронной почты][mtas-message-processing]

Рабочая роль B также опрашивает очередь подписки на наличие рабочих элементов, помещенных туда методом службы веб-API для новых подписок. При нахождении такого элемента она отправляет письмо с подтверждением. 

![Обработка сообщений очереди подписки][mtas-subscribe-diagram]





<h2><a name="tables"></a><span class="short-header">Таблицы</span>Таблицы Azure</h2>

Приложение службы электронной почты Azure хранит данные в таблицах хранилища Azure. Таблицы Azure — это хранилище данных NoSQL, а не реляционная база данных, такая как [база данных SQL Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee336279.aspx). Это делает их хорошим выбором, когда эффективность и масштабируемость важнее нормализации данных и реляционной целостности. Например, в этом приложении одна рабочая роль создает строку при каждом создании рабочего элемента очереди, а другая получает и обновляет строку каждый раз при отправке сообщения электронной почты, что может вызывать проблемы с производительностью при использовании реляционной базы данных. Кроме того, таблицы Azure дешевле, чем Azure SQL.  Дополнительные сведения о таблицах Azure см. в ресурсах, перечисленных в конце [последнего учебника данной серии][tut5].

В следующих разделах описывается содержимое таблиц Azure, используемых приложением службы электронной почты Azure. Схема с таблицами и их взаимосвязями приведена в подразделе [Схема данных службы электронной почты Azure](#datadiagram) ниже на этой странице.

### Таблица "mailinglist" ###

В таблице `mailinglist` хранятся сведения о списках рассылки и их подписчиках. (Для задания имен в таблице Azure рекомендуется использовать только строчные буквы.) Администраторы используют веб-страницы для создания и редактирования списков рассылки, а клиенты и подписчики используют набор веб-страниц и метод обслуживания для подписки и отказа от нее. 

Различные строки в таблицах NoSQL могут иметь разные схемы, и такая гибкость обычно используется для хранения данных, которым в реляционной базе данных может потребоваться несколько таблиц, в одной таблице. Например, для хранения данных списка рассылки в базе данных SQL можно использовать три таблицы: таблицу `mailinglist`, которая содержит сведения о списке, таблицу `subscriber`, которая содержит сведения о подписчиках, и таблицу `mailinglistsubscriber`, которая сопоставляет списки рассылки с подписчиками и наоборот. В таблице NoSQL этого приложения все эти функции выполняет одна таблица с именем `mailinglist`. 

В таблице Azure каждая строка имеет *ключ раздела* и *ключ строки*, однозначно определяющие эту строку. Ключ раздела делит таблицу на логические разделы. Ключ строки однозначно определяет строку в разделе. Нет никаких вторичных индексов. Поэтому чтобы убедиться, что приложение будет масштабируемым, важно разрабатывать таблицы таким образом, чтобы всегда можно было указать ключи строки и раздела в предложении запросов Where.

Ключ раздела для таблицы `mailinglist` — это имя списка рассылки. 

Ключ строки для таблицы `mailinglist` может быть одним из двух следующих значений: константа "mailinglist" или адрес электронной почты подписчика. Строки с ключом строки "mailinglist" содержат сведения о списке рассылки. Строки, для которых в качестве ключа строки выступает адрес электронной почты, содержат сведения о подписчиках для списка.

Другими словами, строки с ключом строки "mailinglist" эквивалентны таблице `mailinglist` в реляционной базе данных. Строки с адресом электронной почты в качестве ключа строки эквивалентны таблице `subscriber` и таблице сопоставлений `mailinglistsubscriber` в реляционной базе данных.

Использование одной таблицы для выполнения нескольких функций позволило повысить производительность. В реляционной базе данных потребовалось бы считать три таблицы, а также отсортировать и сравнить друг с другом три набора строк, что требует времени. В данном случае считывается только одна таблица, а ее строки автоматически возвращаются в порядке ключа раздела и ключа строки.

В следующей таблице приведены свойства строки для строк, содержащих сведения о списке рассылки (ключ строки = "MailingList").

<table border="1">

<tr bgcolor="lightgray">
<th>Свойство</th>
<th>Тип данных</th>
<th>Описание</th>
</tr>

<tr>
<td>PartitionKey</td>
<td>Строка</td>
<td>ListName: уникальный идентификатор для списка рассылки, например contoso1. Таблица обычно используется для получения всех сведений о конкретном списке рассылки, поэтому использование имени списка представляет собой эффективный способ секционирования таблицы.</td>
</tr>

<tr>
<td>RowKey</td>
<td>Строка</td>
<td>Константа "mailinglist".</td>
</tr>

<tr>
<td>Описание</td>
<td>Строка</td>
<td>Описание списка рассылки, например "Объявления отдела истории университета Contoso".</td>
</tr>

<tr>
<td>FromEmailAddress</td>
<td>Строка</td>
<td>Адрес "От" в сообщениях электронной почты, отправляемых в этот список, например donotreply@contoso.edu.</td>
</tr>

</table>

В следующей таблице приведены свойства строки для строк, содержащих сведения о подписчике для списка (ключ строки = адрес электронной почты).

<table border="1">

<tr bgcolor="lightgray">
<th>Свойство</th>
<th>Тип данных</th>
<th>Описание</th>
</tr>

<tr>
<td>PartitionKey</td>
<td>Строка</td>
<td>ListName: имя (уникальный идентификатор) списка рассылки, например contoso1.</td>
</tr>

<tr>
<td>RowKey</td>
<td>Строка</td>
<td>EmailAddress: адрес электронной почты подписчика, например student1@contoso.edu.</td>
</tr>

<tr>
<td>SubscriberGUID</td>
<td>Строка</td>
<td>Создается, когда адрес электронной почты добавляется в список. Используется в ссылках на подписку или отказ от нее, чтобы затруднить использование этих возможностей с адреса электронной почты другого пользователя. 
<br/><br/>
Некоторые запросы для веб-страниц подписки и отказа от подписки указывают только PartitionKey и это свойство. Запрос раздела без использования RowKey ограничивает масштабируемость приложения, поскольку запросы выполняются дольше из-за увеличения размера списков рассылки. Один из способов улучшения масштабируемости заключается в добавлении строк поиска, содержащих в свойстве RowKey значение SubscriberGUID. Например, для каждого адреса электронной почты одна строка может иметь в RowKey значение "email:student1@domain.com", а другая — значение "guid:6f32b03b-90ed-41a9-b8ac-c1310c67b66a". Это легко реализовать благодаря простоте программирования атомарного пакета транзакций по строкам в разделе. Мы надеемся реализовать это в следующей версии примера приложения. Дополнительные сведения см. в разделе <a href="http://msdn.microsoft.com/ru-ru/library/windowsazure/hh508997.aspx">Реальный мир: разработка масштабируемой стратегии секционирования для хранилища таблиц Azure</a>
</td>
</tr>

<tr>
<td>Проверено</td>
<td>Логический</td>
<td>При первоначальном создании строки для нового подписчика это значение равно false. Оно изменяется на true только после того, как новый подписчик выбирает гиперссылку подтверждения в приветственном сообщении либо администратор задает для него значение true. Если сообщение отправляется в список, пока значение "Проверено" для одного из его подписчиков равно false, сообщения электронной почты этому подписчику не отправляется.</td>
</tr>

</table>

Ниже приведен пример того, как могут выглядеть данные в таблице.

<table border="1">
<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>contoso1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>mailinglist</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Описание</th>
<td>Объявления отдела истории университета Contoso</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">FromEmailAddress</th>
<td>donotreply@contoso.edu</td>
</tr>

</table>

<hr/>

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>contoso1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>student1@domain.com</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubscriberGUID</th>
<td>6f32b03b-90ed-41a9-b8ac-c1310c67b66a</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Проверено</th>
<td>true</td>
</tr>

</table>

<hr/>

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>contoso1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>student2@domain.com</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubscriberGUID</th>
<td>01234567-90ed-41a9-b8ac-c1310c67b66a</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Проверено</th>
<td>нет</td>
</tr>

</table>

<hr/>

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>fabrikam1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>mailinglist</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Описание</th>
<td>Открытые инженерные вакансии Fabrikam</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">FromEmailAddress</th>
<td>donotreply@fabrikam.com</td>
</tr>

</table>

<hr/>

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>fabrikam1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>applicant1@domain.com</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubscriberGUID</th>
<td>76543210-90ed-41a9-b8ac-c1310c67b66a</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Проверено</th>
<td>true</td>
</tr>

</table>

### Таблица "message" ###

Таблица `message` содержит сведения о сообщениях, которые планируется отправить в список рассылки. Администраторы создают и изменяют строк в этой таблице с помощью веб-страниц, а рабочие роли используют ее для передачи сведений о каждом сообщении электронной почты из рабочей роли A в рабочую роль B.

Ключ раздела для таблицы "message" — это дата запланированной отправки сообщения электронной почты в формате гггг-мм-дд. Это позволяет оптимизировать таблицу для запроса, который чаще всего выполняется для данной таблицы, при этом выбираются строки, у которых значение `ScheduledDate` соответствует сегодняшнему дню или более раннему времени. Однако это создает потенциальные проблемы с производительностью, поскольку максимальная пропускная способность таблиц хранилища Azure составляет 500 сущностей в секунду для раздела.  Для каждого отправляемого сообщения электронной почты приложение записывает строку таблицы `message`, считывает строку и удаляет строку. Таким образом, кратчайший срок для обработки 1 000 000 сообщений электронной почты, запланированных на один день, составляет почти два часа независимо от того, сколько рабочих ролей добавляется для обработки повышенной нагрузки. 

Ключ строки для таблицы `message` может иметь одно из двух значений: константа "message" с уникальным ключом `MessageRef` для сообщения или значение `MessageRef` с адресом электронной почты подписчика. Строки с ключом строки, который начинается с "message", включают сведения о сообщении, например, список рассылки, в который его требуется отправить, и время отправки. Строки, для которых в качестве ключа строки используются значение `MessageRef` и адрес электронной почты, содержат все сведения, необходимые для отправки сообщения электронной почты на этот адрес электронной почты.

В терминах реляционной базы данных строки с ключом строки, начинающимся с "message", эквивалентны таблице `message`. Строки с ключом строки, состоящим из значения `MessageRef` и адреса электронной почты, эквивалентны представлению запроса на присоединение, содержащему сведения `mailinglist`, `message` и `subscriber`. 

В следующей таблице показаны свойства строки для строк таблицы `message`, содержащие сведения о самом сообщении.

<table border="1">

<tr bgcolor="lightgray">
<th>Свойство</th>
<th>Тип данных</th>
<th>Описание</th>
</tr>

<tr>
<td>PartitionKey</td>
<td>Строка</td>
<td>Дата, на которую запланирована отправка сообщения, в формате гггг-мм-дд.</td>
</tr>

<tr>
<td>RowKey</td>
<td>Строка</td>
<td>Константа "message", объединенная со значением <code>MessageRef</code>. <code>MessageRef</code> — это уникальное значение, созданное путем получения значения <code>Ticks</code> из <code>DateTime.Now</code> при создании строки. <br/><br/>Примечание. Объемные многопоточные приложения с несколькими экземплярами следует подготовить к обработке повторяющихся исключений RowKey при использовании тактов. Уникальность тактов не гарантируется.</td>
</tr>

<tr>
<td>ScheduledDate</td>
<td>Дата</td>
<td>Дата, на которую запланирована отправка сообщения. (Аналогично <code>PartitionKey</code>, но в формате даты.)</td>
</tr>

<tr>
<td>SubjectLine</td>
<td>Строка</td>
<td>Строка темы сообщения электронной почты.</td>
</tr>

<tr>
<td>ListName</td>
<td>Строка</td>
<td>Список, в который отправляется это сообщение.</td>
</tr>

<tr>
<td>Состояние</td>
<td>Строка</td>
<td><ul>
<li>"Ожидание" — рабочая роль A еще не запущена, чтобы можно было создать сообщения очереди для планирования сообщений электронной почты.</li>
<li>"Организация очереди" — рабочая роль A уже запущена, чтобы можно было создать сообщения очереди для планирования сообщений электронной почты.</li>
<li>"Обработка" — рабочая роль A создала рабочие элементы очереди для всех сообщений электронной почты в списке, однако пока отправлены не все сообщения электронной почты.</li>
<li>"Завершено" — рабочая роль B завершила обработку всех рабочих элементов очереди (все сообщения электронной почты были отправлены). Строки с завершенным состоянием архивируются в таблицу <code>messagearchive</code>, как описано ниже. Мы надеемся, что в следующем выпуске это свойство получит тип <code>enum</code>.</li></ul></td>
</tr>

</table>

Когда рабочая роль A создает сообщение очереди для сообщения электронной почты, отправляемого в список, она создает в таблице `message` строку электронной почты. Когда рабочая роль B отправляет сообщение электронной почты, она перемещает строку электронной почты в таблицу `messagearchive` и изменяет свойство `EmailSent` на значение `true`. После архивации всех строк электронной почты для сообщения в состоянии "Обработка" рабочая роль A задает состояние "Завершено" и перемещает строку `message` в таблицу `messagearchive`.

В следующей таблице показаны свойства строки для строк электронной почты в таблице `message`.  

<table border="1">

<tr bgcolor="lightgray">
<th>Свойство</th>
<th>Тип данных</th>
<th>Описание</th>
</tr>

<tr>
<td>PartitionKey</td>
<td>Строка</td>
<td>Дата, на которую запланирована отправка сообщения, в формате гггг-мм-дд.</td>
</tr>

<tr>
<td>RowKey</td>
<td>Строка</td>
<td>Значение <code>MessageRef</code> и конечный адрес электронной почты из строки <code>subscriber</code> таблицы <code>mailinglist</code>.
</td>
</tr>

<tr>
<td>MessageRef</td>
<td>Длинное целое</td>
<td>Аналогично компоненту <code>MessageRef</code> элемента <code>RowKey</code>.</td>
</tr>

<tr>
<td>ScheduledDate</td>
<td>Дата</td>
<td>Запланированная дата из строки <code>message</code> таблицы <code>message</code>. (Аналогично <code>PartitionKey</code>, но в формате даты.)</td>
</tr>

<tr>
<td>SubjectLine</td>
<td>Строка</td>
<td>Строка темы сообщения электронной почты из строки <code>message</code> таблицы <code>message</code>.</td>
</tr>

<tr>
<td>ListName</td>
<td>Строка</td>
<td>Имя списка рассылки из таблицы <code>mailinglist</code>.</td>
</tr>

<tr>
<td>From EmailAddress</td>
<td>Строка</td>
<td>Адрес "От" сообщения электронной почты из строки <code>mailinglist</code> таблицы <code>mailinglist</code>.</td>
</tr>

<tr>
<td>EmailAddress</td>
<td>Строка</td>
<td>Адрес электронной почты из строки <code>subscriber</code> таблицы <code>mailinglist</code>.</td>
</tr>

<tr>
<td>SubscriberGUID</td>
<td>Строка</td>
<td>GUID подписчика из строки <code>subscriber</code> таблицы <code>mailinglist</code>.</td>
</tr>

<tr>
<td>EmailSent</td>
<td>Логический</td>
<td>Значение false указывает на то, что сообщение электронной почты еще не было отправлено; значение true указывает на то, что сообщение электронной почты было отправлено.</td>
</tr>

</table>

В этих строках присутствует избыточность данных, которой следует избегать в реляционной базе данных. Но в этом случае взамен определенных недостатков, связанных с избыточностью данных, вы получаете увеличение эффективности обработки и масштабируемости.  Так как все данные, необходимые для сообщения электронной почты, присутствуют в одной из этих строк, рабочей роли B требуется только считать одну строку для отправки сообщения электронной почты, после чего она выводит рабочий элемент из очереди.

Может возникнуть вопрос, откуда получается текст сообщения электронной почты. Эти строки не имеют ссылок на BLOB-объекты для файлов, которые содержат текст сообщения электронной почты, поскольку это значение получается из значения `MessageRef`. Например, если `MessageRef` имеет значение 634852858215726983, BLOB-объекты имеют названия 634852858215726983.htm и 634852858215726983.txt.

Ниже приведен пример того, как могут выглядеть данные в таблице.

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>2012-10-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>message634852858215726983</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">MessageRef</th>
<td>634852858215726983</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ScheduledDate</th>
<td>2012-10-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubjectLine</th>
<td>Новая серия лекций</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ListName</th>
<td>contoso1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Состояние</th>
<td>Обработка</td>
</tr>

</table>

<hr/>

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>2012-10-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>634852858215726983student1@contoso.edu</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">MessageRef</th>
<td>634852858215726983</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ScheduledDate</th>
<td>2012-10-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubjectLine</th>
<td>Новая серия лекций</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ListName</th>
<td>contoso1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">FromEmailAddress</th>
<td>donotreply@contoso.edu</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">EmailAddress</th>
<td>student1@contoso.edu</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubscriberGUID</th>
<td>76543210-90ed-41a9-b8ac-c1310c67b66a</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">EmailSent</th>
<td>true</td>
</tr>

</table>

<hr/>

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>2012-10-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>634852858215726983student2@contoso.edu</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">MessageRef</th>
<td>634852858215726983</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ScheduledDate</th>
<td>2012-10-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubjectLine</th>
<td>Новая серия лекций</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ListName</th>
<td>contoso1</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">FromEmailAddress</th>
<td>donotreply@contoso.edu</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">EmailAddress</th>
<td>student2@contoso.edu</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubscriberGUID</th>
<td>12345678-90ed-41a9-b8ac-c1310c679876</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">EmailSent</th>
<td>true</td>
</tr>

</table>


<hr/>

<table border="1">

<tr>
<th width="200" align="right" bgcolor="lightgray">Ключ раздела</th>
<td>2012-11-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Ключ строки</th>
<td>message124852858215726999</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">MessageRef</th>
<td>124852858215726999</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ScheduledDate</th>
<td>2012-11-15</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">SubjectLine</th>
<td>Разноски новых заданий</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">ListName</th>
<td>fabrikam</td>
</tr>

<tr>
<th align="right" bgcolor="lightgray">Состояние</th>
<td>Ожидает</td>
</tr>

</table>

<br/>
<br/>

### Таблица "messagearchive" ###

Одна из стратегий по обеспечению эффективного выполнения запросов, особенно в том случае, когда требуется искать в полях, отличных от `PartitionKey` и `RowKey`, заключается в ограничении размера таблицы. Запрос в рабочей роли A, проверяющий, все ли сообщения электронной почты были отправлены для сообщения, должен найти в таблице `message` строки электронной почты, для которых `EmailSent` имеет значение "false". Значение `EmailSent` отличается от "PartitionKey" или "RowKey", поэтому такой запрос будет неэффективен для сообщения с большим количеством строк электронной почты. Поэтому по мере отправки сообщений электронной почты приложение перемещает строки электронной почты в таблицу `messagearchive`. В результате запросу, проверяющему отправку всех сообщений электронной почты для сообщения, достаточно запросить `PartitionKey` и `RowKey` в таблице "message", поскольку обнаружение любых строк электронной почты для сообщения будет означать, что имеются неотправленные сообщения и сообщению нельзя присвоить состояние `Завершено`. 

Схема строк в таблице `messagearchive` идентична схеме строк в таблице `message`. В зависимости от того, что требуется сделать с этими архивными данными, можно ограничить их размеры и расходы за счет сокращения числа свойств, сохраненных для каждой строки, и удаления строк старше определенного срока.



<h2><a name="queues"></a><span class="short-header">Очереди</span>Очереди Azure</h2>

Очереди Azure облегчают взаимодействие между уровнями этого многоуровневого приложения, а также между рабочими ролями на серверном уровне. 
Очереди используются для связи между рабочими ролями A и B, чтобы сделать приложение масштабируемым. Рабочая роль A может создать строку в таблице "Message" для каждого сообщения электронной почты, а рабочая роль B может просматривать таблицу на предмет строк, соответствующих неотправленным сообщениям электронной почты, однако вы не сможете добавить дополнительные экземпляры рабочей роли B, чтобы поделить работу. Проблема с использованием строк таблицы для координации работы между рабочими ролями A и B заключается в том, что нет способа гарантировать, чтобы только один экземпляр рабочей роли получал одну конкретную строку таблицы для обработки. Очереди дают такую гарантию. Когда экземпляр рабочей роли получает рабочий элемент из очереди, служба очереди гарантирует, что никакой другой экземпляр рабочей роли не сможет получить тот же рабочий элемент. Такая возможность эксклюзивной аренды у очередей Azure упрощает распределение рабочей нагрузки между несколькими экземплярами рабочей роли.

Azure также предоставляет службу очередей Service Bus. Дополнительные сведения об очередях хранилища Azure и очередях Service Bus см. в ресурсах, перечисленных в конце [последнего учебника данной серии][tut5].

Приложение службы электронной почты Azure использует две очереди с именами `AzureMailQueue` и `AzureMailSubscribeQueue`.

### AzureMailQueue ###

Очередь `AzureMailQueue` координирует отправку сообщений электронной почты по спискам электронной почты.  Рабочая роль A помещает в очередь рабочий элемент для каждого отправляемого сообщения электронной, а рабочая роль B получает рабочий элемент из очереди и отправляет сообщение электронной почты. 

Рабочий элемент очереди содержит строку с разделителями-запятыми, состоящую из запланированной даты сообщения (ключ раздела для таблицы `message`) и значений `MessageRef` и `EmailAddress` (ключ строки для таблицы `message`), а также флага, указывающего, создается ли элемент после завершения работы и перезапуска рабочей роли, например:

      2012-10-15,634852858215726983,student1@contoso.edu,0

Рабочая роль B использует эти значения для поиска в таблице `message` строки со всеми сведениями, необходимыми для отправки сообщения электронной почты. Если флаг перезапуска указывает на перезапуск, перед отправкой сообщения электронной почты рабочая роль B проверяет, не было ли оно уже отправлено.

При наличии пиковых нагрузок по трафику облачную службу можно перенастроить, чтобы создать несколько экземпляров рабочей роли B, каждый из которых независимо извлекает рабочие элементы из очереди.

### AzureMailSubscribeQueue ###

Очередь `AzureMailSubscribeQueue` координирует отправку сообщений электронной почты с подтверждением подписки.  В ответ на вызов метода службы этот метод помещает рабочий элемент в очередь.  Рабочая роль B получает рабочий элемент из очереди и отправляет сообщение электронной почты с подтверждением подписки. 

Рабочий элемент очереди содержит GUID подписчика.  Данное значение однозначно идентифицирует адрес электронной почты и список для оформления подписки — это все, что нужно рабочей роли B для отправки сообщения электронной почты с подтверждением подписки. Как упоминалось ранее, для этого требуется запрос по полю, отличному от `PartitionKey` или `RowKey`, что оказывается неэффективным. Чтобы сделать приложение более масштабируемым, потребуется изменить структуру таблицы `mailinglist`, включив GUID подписчика в `RowKey`.




<h2><a name="datadiagram"></a><span class="short-header">Схема данных</span>Схема данных службы электронной почты Azure</h2>

На следующей показаны таблицы и очереди, а также их взаимосвязи.

   ![Схема данных для приложения службы электронной почты Azure][mtas-datadiagram]





<h2><a name="blobs"></a><span class="short-header">BLOB-объекты</span>BLOB-объекты Azure</h2>

BLOB-объекты — это "большие двоичные объекты". Служба BLOB-объектов Azure предназначена для передачи и сохранения файлов в облаке. Дополнительные сведения о BLOB-объектах Azure см. в ресурсах, перечисленных в конце [последнего учебника данной серии][tut5].

Администраторы почтовой службы Azure помещают текст сообщения электронной почты в формате HTML в *HTM-файл*, а в формате обычного текста — в *TXT-файл*. При планировании сообщения электронной почты они загружают эти файлы на веб-страницу **Создание сообщения**, а контроллер ASP.NET MVC для страницы сохраняет переданный файл в BLOB-объекте Azure.

BLOB-объекты хранятся в контейнерах BLOB-объектов, подобно тому, как файлы хранятся в папках. Приложение почтовой службы Azure использует один контейнер BLOB-объектов с именем **azuremailblobcontainer**.  Имя BLOB-объектов в контейнере формируется путем объединения значения MessageRef с расширением файла, например: 
634852858215726983.htm и 634852858215726983.txt.

Поскольку сообщения в формате HTML или простого текста по существу являются строками, мы можем разработать приложение для хранения текста сообщения электронной почты в свойствах строки в таблице `Message`, а не в BLOB-объектах. Тем не менее размер свойства в строке таблицы ограничен 64 КБ, поэтому использование BLOB-объектов позволяет избежать ограничения размера текста сообщения электронной почты. (64 КБ — это максимальный общий размер свойства, после разрешения кодирования служебных данных максимальный размер сохраняемой строки приближается к 48 КБ.)




<h2><a name="wawsvswacs"></a><span class="short-header">Сравнение облачной службы и веб-сайта</span>Сравнение облачной службы Azure и веб-сайта Azure</h2>

При загрузке службы электронной почты Azure она настраивается для запуска серверной и интерфейсной частей в одной облачной службе Azure.

![Обзор архитектуры приложения][mtas-architecture-overview]

Альтернативная архитектура заключается в запуске интерфейсной части на веб-сайте Azure. 

![Альтернативная архитектура приложения][mtas-alternative-architecture]

Помещение всех компонентов в облачную службу упрощает настройку и развертывание. При создании приложения с внешним интерфейсом ASP.NET MVC на веб-сайте Azure происходит два развертывания — на веб-сайте Azure и в облачной службе Azure. Кроме того, веб-роли облачной службы Azure предоставляют следующие возможности, недоступные для веб-сайтов Azure:

- Поддержка пользовательских сертификатов и сертификатов с подстановочными знаками.
- Полный контроль над конфигурации служб IIS. Многие возможности служб IIS нельзя включить на веб-сайтах Azure. С помощью веб-ролей Azure можно задать команду запуска программы [AppCmd](http://www.iis.net/learn/get-started/getting-started-with-iis/getting-started-with-appcmdexe "appCmd") для изменения параметров IIS, которые невозможно настроить в файле *Web.config*. Дополнительные сведения см. в разделах [Процедура настройки компонентов служб IIS в Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg433059.aspx) и [Процедура блокировки доступа к веб-роли с определенных IP-адресов
](http://msdn.microsoft.com/ru-ru/library/windowsazure/jj154098.aspx).
- Поддержка автоматического масштабирования веб-приложения с помощью [блока приложений автоматического масштабирования][autoscalingappblock]
- Возможность запуска скриптов с повышенными правами для установки приложений, изменения параметров реестра, установки счетчиков производительности и т. д.
- Сетевая изоляция для использования с [Azure Connect](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg433122.aspx) и [виртуальной сетью Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/jj156007.aspx).
- Доступ к удаленному рабочему столу для отладки и расширенной диагностики.
- Развертывание обновлений с помощью [переключения виртуального IP-адреса](http://msdn.microsoft.com/ru-ru/library/windowsazure/ee517253.aspx "VIP swap"). Эта функция позволяет переключаться между содержимым промежуточного и рабочего развертываний. 

Альтернативная архитектура может быть выгоднее по цене, поскольку при идентичной нагрузке использование веб-сайта Azure может обходиться дешевле по сравнению с веб-ролью, выполняемой в облачной службе. В последующих учебниках серии подробно описаны различия внедрения двух этих архитектур.

Дополнительные сведения о выборе между веб-сайтами Azure или облачными службами Azure см. в разделе [Модели выполнения Azure](http://www.windowsazure.com/ru-ru/manage/windows/fundamentals/compute/).




<h2><a name="cost"></a><span class="short-header">Стоимость</span>Стоимость</h2>

Этот раздел содержит краткий обзор затрат на выполнение примера приложения в Azure по ставкам, которые действовали на момент публикации учебника — в декабре 2012. Перед принятием бизнес-решений на основе затрат не забудьте уточнить текущие ставки на следующих веб-страницах:

* [Калькулятор цен Azure](http://www.windowsazure.com/ru-ru/pricing/calculator/)
* [SendGrid Azure](http://sendgrid.com/windowsazure.html)

Затраты зависят от числа экземпляров веб-ролей и рабочих ролей, которые вы решите использовать. Чтобы получить право на [соглашение об уровне обслуживания (SLA) облачной службы Azure с доступностью 99,95 %](https://www.windowsazure.com/ru-ru/support/legal/sla/ "SLA"), необходимо развернуть два или более экземпляров каждой роли. Одна из причин, по которым необходимо запустить по крайней мере два экземпляра роли, связана с тем, что виртуальные машины с вашим приложением перезапускаются примерно два раза в месяц для обновления операционной системы. (Дополнительные сведения об обновлениях ОС см. в разделе [Перезапуск экземпляра роли из-за обновлений ОС](http://blogs.msdn.com/b/kwill/archive/2012/09/19/role-instance-restarts-due-to-os-upgrades.aspx).) 

Работа, выполняемая двумя рабочими ролями в этом примере, не является критичной по времени и не требует соглашение об уровне обслуживания с доступностью 99,5 %. Таким образом, возможно использовать один экземпляр каждой роли при условии, что один экземпляр справляется с рабочей нагрузкой. Для экземпляра веб-роли время имеет значение, так как пользователи ожидают от веб-сайта бесперебойной работы, поэтому рабочее приложение должно иметь по крайней мере два экземпляра веб-роли.

В следующей таблице показаны затраты на архитектуру по умолчанию для примера приложения службы электронной почты Azure в условиях минимальной рабочей нагрузки. Показанные затраты основаны на использовании очень мелкой (общей) виртуальной машины. По умолчанию при создании облачного проекта Visual Studio используется малый размер виртуальной машины, который примерно в шесть раз дороже очень мелкого размера.
  
<table border="1">

<tr bgcolor="lightgray">
<th>Компонент или служба</th>
<th>Тариф</th>
<th>Стоимость в месяц</th>
</tr>

<tr>
<td>Веб-роль</td>
<td>2 экземпляра по 0,02 долл. США в час для очень мелких экземпляров</td>
<td>$29.00</td>
</tr>

<tr>
<td>рабочая роль A (планирует отправляемые сообщения электронной почты)</td>
<td>1 экземпляр по 0,02 долл. США в час для очень мелкого экземпляра</td>
<td>$14.50
</td>
</tr>

<tr>
<td>Рабочая роль B (отправляет сообщения электронной почты)</td>
<td>1 экземпляр по 0,02 долл. США в час для очень мелкого экземпляра</td>
<td>$14.50</td>
</tr>

<tr>
<td>Транзакции с хранилищем Azure</td>
<td>1 миллион транзакций в месяц по ставке 0,1 долл. США за миллион (каждый запрос считается транзакцией, рабочая роль A постоянно отправляет запросы в таблицы на предмет сообщений, которые необходимо отправить. Приложение также настроено на запись диагностических данных в хранилище Azure, и каждая такая операция считается транзакцией).</td>
<td>$0.10</td>
</tr>

<tr>
<td>Локально избыточное хранилище Azure</td>
<td>2,33 долл. США за 25 Гб (включая хранилище для таблиц приложения и диагностических данных).</td>
<td>$2.33</td>
</tr>

<tr>
<td>Пропускная способность</td>
<td>5 ГБ бесплатного исходящего трафика</td>
<td>Бесплатно</td>
</tr>

<tr>
<td>SendGrid</td>
<td>Клиенты Azure могут отправлять 25 000 бесплатных сообщений электронной почты каждый месяц</td>
<td>Бесплатно</td>
</tr>

<tr>
<td colspan="2">Всего</td>
<td>$60.43</td>
</tr>

</table>

Как вы видите, экземпляры роли являются основной составляющей общей стоимости. Экземпляры роли требуют затрат, даже если они остановлены; необходимо удалить экземпляр роли, чтобы перестать тратить на него средства. Один из экономичных подходов заключается в перемещении всего кода из рабочих ролей A и B в одну рабочую роль. В рамках этих учебников мы намеренно решаем реализовать два экземпляра рабочей роли для упрощения горизонтального масштабирования. Работа, выполняемая рабочей ролью B, координируется службой очередей Azure, то есть для масштабирования рабочей роли B достаточно увеличить число ее экземпляров. (Рабочая роль B является ограничивающим фактором при высокой нагрузке.) Работа, выполняемая рабочей ролью А, не координируется очередями, поэтому нельзя запустить несколько экземпляров рабочей роли A. Если бы две рабочих роли функционировали совместно и нужно было выполнить горизонтальное масштабирование, потребовалось бы реализовать механизм, обеспечивающий выполнение заданий рабочей роли A только в одном экземпляре. (Один из таких механизмов обеспечивается [CloudFx](http://nuget.org/packages/Microsoft.Experience.CloudFx "CloudFX"). См. раздел [Пример WorkerRole.cs](http://code.msdn.microsoft.com/windowsazure/CloudFx-Samples-60c3a852/sourcecode?fileId=57087&pathId=528472169).)

Можно также переместить весь код из двух рабочих ролей в веб-роль, чтобы все выполнялось именно в ней. Однако выполнение фоновых задач в ASP.NET не поддерживается или считается ненадежным, кроме того, такая архитектура может затруднить масштабирование. Дополнительные сведения см. в разделе [Опасность реализации повторяющихся фоновых задач в ASP.NET](http://haacked.com/archive/2011/10/16/the-dangers-of-implementing-recurring-background-tasks-in-asp-net.aspx). См. также разделы [Процедура объединения рабочей роли и веб-роли в Azure](http://www.31a2ba2a-b718-11dc-8314-0800200c9a66.com/2010/12/how-to-combine-worker-and-web-role-in.html) и [Объединение нескольких рабочих ролей Azure в веб-роль Azure](http://www.31a2ba2a-b718-11dc-8314-0800200c9a66.com/2012/02/combining-multiple-azure-worker-roles.html).


Другой альтернативной архитектурой, позволяющей снизить затраты, является использование [блока приложений автоматического масштабирования][autoscalingappblock] для автоматического развертывания рабочих ролей только во время запланированных периодов и удаления их после выполнения работы. Дополнительные сведения об автоматическом масштабировании см. по ссылкам, приведенным в конце [последнего учебника данной серии][tut5].

В будущем Azure может предоставлять механизм уведомления для запланированных перезагрузок, который позволил бы запускать дополнительный экземпляр веб-роли только на период перезагрузки. Вы не сможете претендовать на соглашение об уровне обслуживания доступностью 99,95 %, однако это позволит почти вполовину сократить расходы и обеспечить доступность веб-приложения во время перезагрузки.


<h2><a name="auth"></a><span class="short-header">Проверка подлинности и авторизация</span>Проверка подлинности и авторизация</h2>

В рабочем приложении необходимо реализовать механизм проверки подлинности и авторизации, такой как система членства ASP.NET для интерфейсной веб-части ASP.NET MVC, включая метод обслуживания веб-API ASP.NET. Существуют также другие варианты, например использование общего секрета для обеспечения безопасности метода обслуживания веб-API. В целях простоты настройки и развертывания из примера приложения были исключены функциональные возможности проверки подлинности и авторизации. (Во втором учебнике серии показана реализация IP-ограничений, которые не дают посторонним людям использовать приложение при его развертывании в облаке.) 

Дополнительные сведения о реализации проверки подлинности и авторизации в веб-проекте ASP.NET MVC см. в следующих ресурсах:

* [Проверка подлинности и авторизация в веб-API ASP.NET](http://www.asp.net/web-api/overview/security/authentication-and-authorization/authentication-and-authorization-in-aspnet-web-api)
* [Музыкальный магазин, часть 7. Членство и авторизация](http://www.asp.net/mvc/tutorials/mvc-music-store/mvc-music-store-part-7)

**Примечание**. Мы планировали включить механизм защиты метода службы веб-API с использованием общего секрета, но он еще не был готов на момент первоначального выпуска. Поэтому в третьем учебнике не показано, как создать контроллер веб-API для процесса подписки. Мы надеемся включить инструкции по реализации безопасного процесса подписки в следующую версию этого учебника. До тех пор вы можете протестировать приложение, используя веб-страницы администратора для подписки адресов электронной почты на списки.




<h2><a name="nextsteps"></a><span class="short-header">Дальнейшие действия</span>Дальнейшие действия</h2>

В [следующем учебнике][tut2] вы загрузите пример проекта, настроите среду разработки, настроите проект для своей среды и протестируете его локально и в облаке.  В последующих учебниках вы увидите, как создать проект "с нуля".

Ссылки на дополнительные ресурсы по работе с таблицами, очередями и BLOB-объектами хранилища Azure приведены в конце [последнего учебника данной серии][tut5].

<div><a href="/ru-ru/develop/net/tutorials/multi-tier-web-site/2-download-and-run/" class="site-arrowboxcta download-cta">Учебник 2</a></div>

[tut2]: /ru-ru/develop/net/tutorials/multi-tier-web-site/2-download-and-run/
[tut3]: /ru-ru/develop/net/tutorials/multi-tier-web-site/3-web-role/
[tut4]: /ru-ru/develop/net/tutorials/multi-tier-web-site/4-worker-role-a/
[tut5]: /ru-ru/develop/net/tutorials/multi-tier-web-site/5-worker-role-b/
[autoscalingappblock]: /ru-ru/develop/net/how-to-guides/autoscaling/




[mtas-architecture-overview]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-architecture-overview.png
[mtas-alternative-architecture]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-alternative-architecture.png
[mtas-mailing-list-index-page]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-mailing-list-index-page.png
[mtas-subscribers-index-page]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-subscribers-index-page.png
[mtas-message-index-page]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-message-index-page.png
[mtas-message-create-page]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-message-create-page.png
[mtas-subscribe-confirmation-page]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-subscribe-confirmation-page.png
[mtas-unsubscribe-query-page]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-unsubscribe-query-page.png
[mtas-unsubscribe-confirmation-page]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-unsubscribe-confirmation-page.png
[mtas-worker-roles-a-and-b]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-worker-roles-a-and-b.png
[mtas-message-processing]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-message-processing.png
[mtas-subscribe-email]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-subscribe-email.png
[mtas-subscribe-diagram]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-subscribe-diagram.png
[mtas-datadiagram]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-overview/mtas-datadiagram.png


