<properties 
	pageTitle="Миграция из мобильных служб в мобильное приложение службы приложений" 
	description="Простая миграция приложения мобильных служб в мобильное приложение службы приложений" 
	services="app-service\mobile" 
	documentationCenter="" 
	authors="mattchenderson" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="app-service" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile" 
	ms.devlang="dotnet" 
	ms.topic="article" 
	ms.date="03/22/2015" 
	ms.author="mahender"/>

# Миграция существующей мобильной службы Azure в мобильное приложение службы приложений Azure

В этом разделе показано, как выполнить миграцию существующего приложения из мобильных служб Azure в новое мобильное приложение службы приложений. Все существующие приложения мобильных служб можно легко перенести в новое мобильное приложение службы приложений. Во время миграции существующее приложение мобильных служб может продолжить работать. Со временем процесс миграции станет еще проще, но тем, кому нужно выполнить миграцию сейчас, можно использовать следующие действия.

>[AZURE.NOTE]Миграции в настоящее время поддерживаются только для клиентов, использующих внутренний сервер .NET мобильных служб. Приложениям, использующим внутренний сервер Node.JS, потребуется остаться в мобильных службах.

##<a name="understand"></a>Общие сведения о мобильных приложениях службы приложений

Мобильные приложения службы приложений — это новый способ сборки мобильных приложений с помощью Microsoft Azure. Дополнительные сведения о мобильных приложениях см. в разделе [Что такое мобильные приложения].

При миграции в мобильные службы все существующие функции приложений (и код) можно сохранить. Более того, в приложении доступны новые функции. В модели мобильных служб код фактически выполняется в веб-приложении (новая версия веб-сайтов Azure). Вы получите полный контроль над веб-приложением и его работой. Кроме того, теперь можно использовать функции веб-приложений, которые были ранее недоступны в мобильных службах, например диспетчер трафика и слоты развертывания.

Новая модель также направлена на одну из основных сложностей работы с мобильными службами. Теперь любая версия пакета NuGet может быть развернута без возникновения конфликтов зависимостей. Дополнительные сведения о преимуществах миграции см. в разделе [Я уже использую веб-сайты и мобильные службы, как служба приложений может помочь мне?].

При создании мобильного приложения службы приложений вы получите:

- ресурс мобильного приложения, который содержит новые функции; 
- сайт кода мобильного приложения, который запускает проект веб-API, используя пакет SDK для сервера мобильных приложений;
- шлюз службы приложений, который обрабатывает вход и позволяет добавить приложения API службы приложений в приложение.

##<a name="overview"></a>Общие сведения о миграции
Самый простой способ миграции — это создание нового экземпляра мобильного приложения службы приложений. Во многих случаях миграция будет такой же простой, как и переключение на новый пакет SDK для сервера и повторная публикация кода в новое мобильное приложение. Однако существует несколько сценариев, в которых потребуется дополнительная настройка, например расширенные сценарии проверки подлинности и работа с запланированными заданиями. Все они описываются в следующих разделах.

>[AZURE.NOTE]Рекомендуется полностью ознакомиться с остальной частью раздела перед тем, как начинать миграцию. Запишите все используемые функции, которые вызываются ниже.

Вы можете перемещать и тестировать код с удобной для вас скоростью. По готовности внутреннего сервера мобильных приложений вы можете выпустить новую версию клиентского приложения. На этом этапе вы получите две копии приложения, выполняющиеся одновременно. Необходимо убедиться, что вносимые исправления ошибок применяются к обеим копиям. Наконец, после обновления до последней версии вы можете удалить исходную мобильную службу.

Далее приводится полный набор действий для этой миграции.

1. Создание и настройка новой мобильной службы.
2. Устранение проблем с проверкой подлинности.
3. Выпуск новой версии клиентского приложения.
4. Удаление исходного экземпляра мобильных служб.


##<a name="mobile-app-version"></a>Настройка версии мобильного приложения для вашего приложения
Первый шаг миграции — создание службы приложений, на которой будет размещаться новая версия приложения. Вы можете создать новое мобильное приложение на [портале предварительной версии Azure]. Дополнительные сведения см. в разделе [Создание мобильного приложения].

Скорее всего, вы захотите использовать ту же базу данных и концентратор уведомлений, которые использовали в мобильных службах. Вы можете скопировать эти значения с вкладки **Настройка** раздела мобильных служб на [портале управления Azure]. В разделе **Строки подключения** скопируйте `MS_NotificationHubConnectionString` и `MS_TableConnectionString`. Перейдите на сайт кода мобильного приложения, последовательно выберите пункты **Параметры** и **Параметры приложения**, а затем добавьте эти строки подключения, перезаписав существующие значения. Кроме того, следует добавить эти значения в ресурс мобильных служб. Для этого перейдите в колонку мобильного приложения, щелкните пункт **Параметры**, а затем выберите пункт **Свойства**. Щелкните ссылку с меткой **Узел приложения API**, чтобы просмотреть сайт, на котором размещается ваш ресурс мобильного приложения. Последовательно выберите в меню пункты **Параметры**, **Параметры приложения** и вставьте строки подключения, как на сайте кода. Не изменяйте другие значения, так как это может нарушить работу функций мобильного приложения. Обратите внимание, что сейчас в колонке мобильного приложения продолжат отображаться существующие подключения, даже после этого этапа настройки. После обновления интерфейса мобильных приложений может потребоваться дополнительное действие.

Мобильные приложения предоставляют новый [пакет SDK для сервера мобильных приложений], который предоставляет практически те же функции, что и среда выполнения мобильных служб. Следует удалить пакет NuGet мобильных служб из существующего проекта и включить вместо него пакет SDK для сервера. Возможно, потребуется изменить некоторые операторы using с помощью Visual Studio. Основной элемент, который может отсутствовать в пакете SDK для сервера, — это класс PushRegistrationHandler. Регистрации в мобильных приложениях обрабатываются немного по-другому, и способы регистрации без тегов включены по умолчанию. Управление тегами осуществляется с помощью пользовательских API. Дополнительные сведения см. в разделе [Добавление push-уведомлений в мобильное приложение].

Запланированные задания не встраиваются в мобильные приложения, поэтому все существующие задания на внутреннем сервере .NET потребуется перенести по отдельности. Один из вариантов — создать запланированное [веб-задание] на сайте кода мобильных приложений. Можно также настроить контроллер, содержащий код задания, и задать в [планировщике Azure] вызов конечной точки по ожидаемому расписанию.


##<a name="authentication"></a>Рекомендации по проверке подлинности
Одно из основных различий между мобильными приложениями и мобильными службами — то, что вход в мобильные приложения обрабатывается шлюзом службы приложений, а не сайтом кода. Для большинства приложений дополнительных действий не потребуется, но существует несколько расширенных сценариев, которые следует учитывать.

Для большинства приложений достаточно просто использовать новый способ регистрации с целевым поставщиком удостоверений; дополнительные сведения о добавлении удостоверения в приложение службы приложений см. в учебнике [Добавление проверки подлинности в мобильное приложение].

Если приложение получает зависимости в идентификаторах пользователей, например сохраняет их в базе данных, важно обратить внимание на то, что идентификаторы пользователей в мобильных службах и мобильных приложениях служб приложений отличаются. Однако можно получить идентификатор пользователя мобильных служб в мобильном приложении службы приложений следующим образом (в качестве примера используется Facebook):

    ServiceUser user = (ServiceUser) this.User;
    FacebookCredentials creds = (await user.GetIdentitiesAsync()).OfType< FacebookCredentials >().FirstOrDefault();
    string mobileServicesUserId = creds.Provider + ":" + creds.UserId;

Дополнительно, если вы получаете зависимости для идентификаторов пользователей, важно использовать тот же способ регистрации и того же поставщика удостоверений, если это возможно. Идентификаторы пользователей обычно относятся к использованному способу регистрации приложений, поэтому новый способ регистрации может вызвать проблемы с сопоставлением пользователей с их данными. Если приложению по какой-либо причине нужно использовать тот же способ регистрации поставщика удостоверений, выполните следующие действия:

1. Скопируйте сведения о подключении идентификатора и секрета клиента для каждого поставщика, использованного в приложении.
2. Добавьте конечные точки шлюза или входа* в качестве дополнительных URI перенаправления для каждого поставщика. 

>[AZURE.NOTE]Некоторые поставщики, например Twitter и учетная запись Майкрософт, не позволяют указать несколько URI перенаправления в разных доменах. Если приложение использует одного из этих поставщиков и получает зависимость для идентификаторов пользователя, рекомендуется не выполнять миграцию.

##<a name="updating clients"></a>Обновление клиентов
После получения рабочего внутреннего сервера мобильных приложений вы можете обновить клиентское приложение, чтобы оно использовало новое мобильное приложение. В мобильные приложения будет также входить новая версия пакетов SDK для клиента мобильных служб, которая позволит разработчикам получить преимущество использования новых функций службы приложений. После получения версии мобильного приложения внутреннего сервера вы можете выпустить новую версию клиентского приложения, которая использует новую версию пакета SDK.

Основное изменение, которое потребуется внести в код клиента, находится в конструкторе. Кроме URL-адреса сайта кода мобильного приложения и ключа приложения, необходимо предоставить URL-адрес шлюза службы приложений, на котором размещаются параметры проверки подлинности:

    public static MobileServiceClient MobileService = new MobileServiceClient(
        "https://contoso-code.azurewebsites.net", //URL of the Mobile App Code
        "https://contosogateway.azurewebsites.net", //URL of the App Service Gateway
        "983682c4-f043-483e-a75b-8a8545fc1846"
    );

Это позволит клиенту перенаправлять запросы в компоненты мобильного приложения. Дополнительные сведения по конкретной целевой платформе см. в соответствующем разделе [Создание мобильного приложения].

В том же обновлении вам потребуется настроить все выполняемые вызовы регистрации push-уведомлений. Существуют новые API, которые вносят усовершенствования в процесс регистрации (в качестве примера используется Windows):

    var channel = await PushNotificationChannelManager.CreatePushNotificationChannelForApplicationAsync();
    await MobileService.GetPush().Register(channel.Uri); 

Дополнительные сведения о конкретной целевой платформе см. в разделах [Добавление push-уведомлений в мобильное приложение] и [Отправка кроссплатформенных push-уведомлений].

После того как клиенты смогут получить эти обновления, вы можете удалить версию мобильных служб приложения. На этом этапе вы выполнили полную миграцию в мобильное приложение служб приложений.

<!-- URLs. -->

[портале предварительной версии Azure]: https://portal.azure.com/
[портале управления Azure]: https://manage.windowsazure.com/
[Что такое мобильные приложения]: app-service-mobile-value-prop-preview.md
[Я уже использую веб-сайты и мобильные службы, как служба приложений может помочь мне?]: /ru-ru/documentation/articles/app-service-mobile-value-prop-migration-from-mobile-services-preview
[пакет SDK для сервера мобильных приложений]: http://www.nuget.org/packages/microsoft.azure.mobile.server
[Создание мобильного приложения]: app-service-mobile-dotnet-backend-xamarin-ios-get-started-preview.md
[Добавление push-уведомлений в мобильное приложение]: app-service-mobile-dotnet-backend-xamarin-ios-get-started-push-preview.md
[Добавление проверки подлинности в мобильное приложение]: app-service-mobile-dotnet-backend-xamarin-ios-get-started-users-preview.md
[планировщике Azure]: /ru-ru/documentation/services/scheduler/
[веб-задание]: websites-webjobs-resources.md
[Отправка кроссплатформенных push-уведомлений]: app-service-mobile-dotnet-backend-xamarin-ios-push-notifications-to-user-preview.md
<!--HONumber=54-->