---
title: Управление жизненным циклом хранилища Azure
description: Узнайте, как создать правила для политики жизненного цикла, чтобы перемещать данные из горячего уровня доступа на холодный и далее на архивный.
services: storage
author: yzheng-msft
ms.service: storage
ms.topic: article
ms.date: 04/30/2018
ms.author: yzheng
ms.component: common
ms.openlocfilehash: a3208152ddf198d00c0a158e466c9d024c17b4d6
ms.sourcegitcommit: 9819e9782be4a943534829d5b77cf60dea4290a2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2018
ms.locfileid: "39528449"
---
# <a name="managing-the-azure-blob-storage-lifecycle-preview"></a>Управление жизненным циклом хранилища BLOB-объектов Azure (предварительная версия)

Для каждого набора данных существуют уникальные требования к жизненному циклу. Некоторые данные часто используются только на ранних этапах жизненного цикла, а по мере их устаревания количество обращений резко снижается. Некоторые данные хранятся в облаке почти без использования, к ним обращаются крайне редко. Некоторые данные становятся устаревшими через несколько дней или месяцев после их создания, а другие наборы данных активно считываются и изменяются на протяжении всего их времени существования. Для управления жизненным циклом в хранилище BLOB-объектов Azure (предварительная версия) используется политика с широкими возможностями на основе правил, позволяющая настроить перенос данных на оптимальный уровень доступа и действия, выполняемые с данными в конце жизненного цикла.

Политика управления жизненным циклом предоставляет следующие возможности.

- Перемещение больших двоичных объектов на более холодный уровень доступа (с горячего на холодный, с горячего на архивный, с холодного на архивный) для оптимального баланса производительности и стоимости.
- Удаление больших двоичных объектов в конце их жизненных циклов.
- Определение правил, которые ежедневно выполняются на каждом уровне учетной записи хранения (поддерживаются учетные записи хранения GPv2 и больших двоичных объектов).
- Применение правил к контейнерам или подмножествам больших двоичных объектов (с префиксами в качестве фильтров).

В качестве примера давайте рассмотрим некоторый набор данных, который часто запрашивается на ранней стадии жизненного цикла, по истечении двух недель используется лишь время от времени, а через месяц и далее почти не используется. В этом сценарии на ранних этапах следует использовать горячий уровень хранилища, для нерегулярного доступа можно переместить данные на холодный уровень, а через месяц лучше всего воспользоваться архивным уровнем доступа. Выбирая уровни хранилища в зависимости от возраста данных, вы сможете создать наиболее экономичный вариант хранилища для конкретных потребностей. Для организации перемещения данных на более холодные уровни вы можете использовать политики управления жизненным циклом.

## <a name="storage-account-support"></a>Поддержка учетных записей хранения

Политика управления жизненным циклом поддерживает учетные записи GPv2 (общего назначения, версия 2) и учетные записи хранилища BLOB-объектов. Вы можете преобразовать существующую учетную запись GPv1 в учетную записью GPv2 на портале Azure, запустив простой процесс одним щелчком мыши. Дополнительные сведения см. в статье [Варианты учетной записи хранения Azure](../common/storage-account-options.md).  

## <a name="pricing"></a>Цены 

Функция управления жизненным циклом предоставляется в режиме предварительного просмотра бесплатно. Клиенты оплачивают только обычную стоимость вызовов API [Отображение BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/list-blobs) и [Установка уровня BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/set-blob-tier). Дополнительные сведения о ценах см. на [странице цен на блочные BLOB-объекты](https://azure.microsoft.com/pricing/details/storage/blobs/).

## <a name="register-for-preview"></a>Регистрация для использования предварительной версии 
Чтобы зарегистрироваться для участия в общедоступной предварительной версии, следует отправить запрос на регистрацию этой функции в вашей подписке. Когда запрос будет утвержден (это занимает несколько дней), функция будет включена для всех существующих и новых учетных записей хранения GPv2 или BLOB-объектов в регионах "западная часть США 2" и "центрально-западная часть США". В режиме предварительного просмотра поддерживаются только блочные BLOB-объекты. Как и другие функции в режиме предварительного просмотра, не следует использовать эту возможность для производственных рабочих нагрузок, пока не будет готова общедоступная версия.

Чтобы отправить запрос, выполните следующие команды в PowerShell или интерфейсе командной строки.

### <a name="powershell"></a>PowerShell

Отправка запроса:

```powershell
Register-AzureRmProviderFeature -FeatureName DLM -ProviderNamespace Microsoft.Storage 
```
Состояние утверждения для регистрации можно проверить, выполнив следующую команду:
```powershell
Get-AzureRmProviderFeature -FeatureName DLM -ProviderNamespace Microsoft.Storage
```
Когда функция будут утверждена и полностью зарегистрирована, в ответе вы получите состояние Registered (Зарегистрировано).

### <a name="cli-20"></a>CLI 2.0

Отправка запроса: 
```cli
az feature register --namespace Microsoft.Storage --name DLM
```
Состояние утверждения для регистрации можно проверить, выполнив следующую команду:
```cli
az feature show --namespace Microsoft.Storage --name DLM
```
Когда функция будут утверждена и полностью зарегистрирована, в ответе вы получите состояние Registered (Зарегистрировано). 


## <a name="add-or-remove-policies"></a>Добавление или удаление политик 

Вы можете добавлять, изменять и (или) удалять политики с помощью портала Azure, [PowerShell](https://www.powershellgallery.com/packages/AzureRM.Storage/5.0.3-preview), [REST API](https://docs.microsoft.com/en-us/rest/api/storagerp/storageaccounts/createorupdatemanagementpolicies) или клиентских средств на следующих языках: [.NET](https://www.nuget.org/packages/Microsoft.Azure.Management.Storage/8.0.0-preview), [Python](https://pypi.org/project/azure-mgmt-storage/2.0.0rc3/), [Node.js]( https://www.npmjs.com/package/azure-arm-storage/v/5.0.0), [Ruby]( https://rubygems.org/gems/azure_mgmt_storage/versions/0.16.2). 

### <a name="azure-portal"></a>Портал Azure

1. Войдите на [портале Azure](https://portal.azure.com).

2. Чтобы перейти к вашей учетной записи хранения, выберите "Все ресурсы", а затем — необходимую учетную запись хранения.

3. В колонке "Параметры" щелкните **Управление жизненным циклом** под службой BLOB-объектов, чтобы просмотреть или изменить политики.

### <a name="powershell"></a>PowerShell

```powershell
$rules = '{ ... }' 

Set-AzureRmStorageAccountManagementPolicy -ResourceGroupName [resourceGroupName] -StorageAccountName [storageAccountName] -Policy $rules 

Get-AzureRmStorageAccountManagementPolicy -ResourceGroupName [resourceGroupName] -StorageAccountName [storageAccountName]
```

> [!NOTE]
Если вы настроили для учетной записи хранения правила брандмауэра, запросы на управление жизненным циклом могут быть заблокированы. Разблокируйте их, предоставив соответствующие исключения. Дополнительные сведения см. в разделе об исключениях статьи [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions).

## <a name="policies"></a>Политики

Политика управления жизненным циклом представляет собой набор правил, оформленный в виде документа JSON.

```json
{
  "version": "0.5",
  "rules": [
    {
      "name": "rule1",
      "type": "Lifecycle",
      "definition": {...}
    },
    {
      "name": "rule2",
      "type": "Lifecycle",
      "definition": {...}
    }
  ]
}
```


В политике есть два обязательных параметра.

| Имя параметра | Тип параметра | Примечания |
|----------------|----------------|-------|
| версия        | Строка, выраженная в виде `x.x` | Предварительная версия выпущена с номером 0.5 |
| правила          | Массив объектов правил | Для каждой политики должно существовать хотя бы одно правило. В режиме предварительного просмотра для каждой политики можно указать до четырех правил. |

В правиле определяются следующие обязательные параметры.

| Имя параметра | Тип параметра | Примечания |
|----------------|----------------|-------|
| ИМЯ           | Строка | Имя правила может содержать любое сочетание буквенно-цифровых символов. В именах правил учитывается регистр. Имя должно быть уникальным в пределах политики. |
| Тип           | Значение перечисления | В режиме предварительной версии допускается значение `Lifecycle` |
| Определение     | Объект, который определяет правило жизненного цикла | Каждое определение состоит из набора фильтров и набора действий. |

## <a name="rules"></a>Правила

Каждое определение правила состоит из набора фильтров и набора действий. Следующий пример правила изменяет уровень для базовых блочных BLOB-объектов с префиксом имени `container1/foo`. В политике эти правила определяются следующим образом:

- установить для BLOB-объекта холодный уровень доступа через 30 дней после последнего изменения;
- установить для BLOB-объекта архивный уровень доступа через 90 дней после последнего изменения;
- удалить BLOB-объект спустя 2555 дней (7 лет) после последнего изменения;
- удалить моментальный снимок BLOB-объекта через 90 дней после создания моментального снимка.

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "ruleFoo", 
      "type": "Lifecycle", 
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 },
            "delete": { "daysAfterModificationGreaterThan": 2555 }
          },
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}

```

### <a name="rule-filters"></a>Фильтры правила

Фильтры ограничивают действие правила определенным подмножеством BLOB-объектов в учетной записи хранения. Если определены несколько фильтров, к ним применяется логическая операция `AND`.

В период предварительной версии поддерживаются следующие фильтры.

| Имя фильтра | Тип фильтра | Примечания | Обязательный |
|-------------|-------------|-------|-------------|
| blobTypes   | Массив предустановленных значений перечисления. | Для предварительного выпуска поддерживается только `blockBlob`. | Yes |
| prefixMatch | Массив строк, по которым выполняется сопоставление префиксов. Строка префикса должно начинаться с имени контейнера. Например, если все большие двоичные объекты в разделе https://myaccount.blob.core.windows.net/mycontainer/mydir/... должны совпадать для правила, префикс будет mycontainer/mydir. | Если массив не определен, правило применяется ко всем BLOB-объектам в учетной записи. | Нет  |

### <a name="rule-actions"></a>Действия правила

Действия применяются к BLOB-объектам, для которых выполняются все условия фильтров выполнения.

В режиме предварительного просмотра управление жизненным циклом поддерживает изменение уровня доступа и удаление для BLOB-объектов и моментальных снимков BLOB-объектов. Для каждого правила должно быть определено хотя бы одно действие для BLOB-объектов или моментальных снимков BLOB-объектов.

| Действие        | Базовый BLOB-объект                                   | Снимок      |
|---------------|---------------------------------------------|---------------|
| tierToCool    | Поддерживает BLOB-объекты, размещенные на горячем уровне доступа         | Не поддерживается |
| tierToArchive | Поддерживает BLOB-объекты, размещенные на горячем или холодном уровне доступа | Не поддерживается |
| удалить        | Поддерживаются                                   | Поддерживаются     |

>[!NOTE] 
Если для одного BLOB-объекта определено более одного действия, управление жизненным циклом применяет к нему самое дешевое из этих действий. (например, действие `delete` дешевле, чем действие `tierToArchive`; а действие `tierToArchive` дешевле, чем действие `tierToCool`.)

В режиме предварительного просмотра все условия выполнения действий основываются на возрасте объекта. Возраст для базового BLOB-объекта определяется по времени последнего изменения, а для моментального снимка BLOB-объекта — по времени создания.

| Условие выполнения действия | Значение условия | ОПИСАНИЕ |
|----------------------------|-----------------|-------------|
| daysAfterModificationGreaterThan | Целочисленное значение, указывающее возраст в днях | Допустимое условие для действий с базовым BLOB-объектом |
| daysAfterCreationGreaterThan     | Целочисленное значение, указывающее возраст в днях | Допустимое условие для действий с моментальным снимком BLOB-объекта | 

## <a name="examples"></a>Примеры
Следующие примеры демонстрируют несколько типичных сценариев для правил политики жизненного цикла.

### <a name="move-aging-data-to-a-cooler-tier"></a>Перемещение старых данных на более холодный уровень

Следующий пример демонстрирует перемещение блочных BLOB-объектов с префиксом имени `container1/foo` или `container2/bar`. Эта политика перемещает BLOB-объекты, которые не изменялись более 30 дней, на холодный уровень, а которые не изменялись в течение 90 дней — на архивный уровень:

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "agingRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ],
            "prefixMatch": [ "container1/foo", "container2/bar" ]
          },
          "actions": {
            "baseBlob": {
              "tierToCool": { "daysAfterModificationGreaterThan": 30 },
              "tierToArchive": { "daysAfterModificationGreaterThan": 90 }
            }
          }
        }      
    }
  ]
}
```

### <a name="archive-data-at-ingest"></a>Архивация данных при поступлении 

Третьи данные не используют или делают это редко, возможно даже единожды за весь срок хранения. Такие данные лучше архивировать сразу при поступлении в хранилище. Следующая политика жизненного цикла настроена так, чтобы архивировать данные при приеме. Этот пример перемещает поступающие в учетную запись BLOB-объекты в пределах контейнера `archivecontainer` сразу на архивный уровень доступа. Для немедленного перемещения настраиваются действия, которые применяются к BLOB-объектов возрастом 0 дней после последнего изменения:

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "archiveRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ],
            "prefixMatch": [ "archivecontainer" ]
          },
          "actions": {
            "baseBlob": { 
                "tierToArchive": { "daysAfterModificationGreaterThan": 0 }
            }
          }
        }      
    }
  ]
}

```

### <a name="expire-data-based-on-age"></a>Устаревание данных на основе возраста

Иногда данные необходимо удалять через несколько дней или месяцев после их создания, чтобы снизить затраты на хранение или соблюдать требования законодательства. Вы можете настроить политику управления жизненным циклом, так чтобы удалять устаревшие данные при достижении определенного возраста. В следующем примере представлена политика, которая удаляет все BLOB-объекты (префикс не указан) старше 365 дней.

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "expirationRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ]
          },
          "actions": {
            "baseBlob": {
              "delete": { "daysAfterModificationGreaterThan": 365 }
            }
          }
        }      
    }
  ]
}
```

### <a name="delete-old-snapshots"></a>Удаление старых моментальных снимков

Для данных, которые часто изменяются и используются на протяжении их существования, часто используются моментальные снимки для отслеживания ранних версий данных. Вы можете создать политику, которая удаляет старые моментальные снимки при достижении определенного возраста. Возраст моментального снимка определяется от момента создания моментального снимка. Это правило политики удаляет моментальные снимки BLOB-объектов в пределах контейнера `activedata`, с момента создания которых прошло 90 или более дней.

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "snapshotRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ],
            "prefixMatch": [ "activedata" ]
          },
          "actions": {            
            "snapshot": {
              "delete": { "daysAfterCreationGreaterThan": 90 }
            }
          }
        }      
    }
  ]
}
```

## <a name="next-steps"></a>Дополнительная информация

Узнайте, как восстанавливать данные после случайного удаления:

- [Обратимое удаление больших двоичных объектов службы хранилища Azure](../blobs/storage-blob-soft-delete.md)
