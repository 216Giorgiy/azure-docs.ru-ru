---
title: Шифрование службы хранилища Azure с помощью управляемых клиентом ключей в Azure Key Vault | Документация Майкрософт
description: С помощью функции шифрования службы хранилища Azure можно шифровать хранилище BLOB-объектов Azure на стороне службы при сохранении данных и расшифровывать его при извлечении данных с помощью управляемых клиентом ключей.
services: storage
author: lakasa
manager: jeconnoc
ms.service: storage
ms.topic: article
ms.date: 03/07/2018
ms.author: lakasa
ms.openlocfilehash: 1360d8bb0911c424747209c69b830fc1ee461798
ms.sourcegitcommit: 8aab1aab0135fad24987a311b42a1c25a839e9f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2018
---
# <a name="storage-service-encryption-using-customer-managed-keys-in-azure-key-vault"></a>Шифрование службы хранилища с помощью управляемых клиентом ключей в Azure Key Vault

Microsoft Azure прилагает все усилия, чтобы защитить данные согласно обязательствам по безопасности и соответствию, установленным в вашей организации. Один из способов защиты данных с помощью службы хранилища Azure — использование функции шифрования службы хранилища (SSE), которая шифрует данные при записи в хранилище и расшифровывает их при извлечении. Шифрование и расшифровка выполняются автоматически и прозрачно. Для этого используется 256-битный [алгоритм шифрования AES](https://wikipedia.org/wiki/Advanced_Encryption_Standard) — один из наиболее сложных среди доступных блочных шифров.

Можно использовать ключи шифрования с SSE, управляемые корпорацией Майкрософт, или собственные ключи шифрования. В этой статье описывается использование собственных ключей шифрования. Дополнительные сведения об использовании ключей, управляемых корпорацией Майкрософт, и о SSE в целом см. в статье [Шифрование службы хранилища Azure для неактивных данных (предварительная версия)](storage-service-encryption.md).

Функция SSE для хранилища BLOB-объектов и файлового хранилища интегрируется с Azure Key Vault, чтобы обеспечить возможность использования хранилища ключей для управления ключами шифрования. Вы можете создать собственные ключи шифрования и сохранить их в хранилище ключей или использовать интерфейсы API Azure Key Vault, чтобы генерировать ключи шифрования. С помощью Azure Key Vault вы можете контролировать ключи и управлять ими, а также выполнять аудит их использования.

Зачем нужно создавать собственные ключи? Пользовательские ключи обеспечивают большую гибкость, позволяя создавать, сменять, отключать и определять элементы управления доступом, а также предоставляют возможность выполнять аудит ключей шифрования, используемых для защиты данных.

## <a name="get-started-with-customer-managed-keys"></a>Начало работы с ключами, управляемыми клиентом

Чтобы использовать ключи, управляемые клиентом, можно создать хранилище ключей и ключ или использовать имеющиеся. Учетная запись хранения и Key Vault должны быть расположены в одном регионе, но могут находиться в разных подписках. 

### <a name="step-1-create-a-storage-account"></a>Шаг 1. Создание учетной записи хранения

Если у вас еще нет учетной записи хранения, создайте ее. Дополнительные сведения см. в статье [Создайте учетную запись хранения](storage-quickstart-create-account.md).

### <a name="step-2-enable-sse-for-blob-and-file-storage"></a>Шаг 2. Включение SSE для хранилища BLOB-объектов и хранилища файлов

Чтобы включить SSE с помощью ключей, управляемых пользователем, необходимо также активировать две функции защиты ключей: обратимого удаления и Do Not Purge (Не очищать). Эти параметры гарантируют, что ключи не будут случайно или намерено удалены. Максимальный срок хранения ключей составляет 90 дней. Пользователи защищены от злоумышленников и шантажистов.

Если вы хотите активировать ключи, управляемые клиентом, для SSE с помощью программных средств, вы можете использовать [REST API поставщика ресурсов службы хранилища Azure](https://docs.microsoft.com/rest/api/storagerp), [клиентскую библиотеку поставщика ресурсов хранилища для .NET](https://docs.microsoft.com/dotnet/api), [Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview) или [Azure CLI](https://docs.microsoft.com/azure/storage/storage-azure-cli).

Чтобы использовать управляемые клиентом ключи с помощью SSE, необходимо назначить удостоверение учетной записи хранения. Чтобы настроить удостоверение, выполните следующую команду PowerShell:

```powershell
Set-AzureRmStorageAccount -ResourceGroupName \$resourceGroup -Name \$accountName -AssignIdentity
```

Чтобы включить функции обратимого удаления и Do Not Purge (Не очищать), выполните следующие команды PowerShell:

```powershell
($resource = Get-AzureRmResource -ResourceId (Get-AzureRmKeyVault -VaultName
$vaultName).ResourceId).Properties | Add-Member -MemberType NoteProperty -Name
enableSoftDelete -Value 'True'

Set-AzureRmResource -resourceid $resource.ResourceId -Properties
$resource.Properties

($resource = Get-AzureRmResource -ResourceId (Get-AzureRmKeyVault -VaultName
$vaultName).ResourceId).Properties | Add-Member -MemberType NoteProperty -Name
enablePurgeProtection -Value 'True'

Set-AzureRmResource -resourceid $resource.ResourceId -Properties
$resource.Properties
```

### <a name="step-3-enable-encryption-with-customer-managed-keys"></a>Шаг 3. Включение шифрования с помощью управляемых клиентом ключей

По умолчанию SSE использует ключи, управляемые корпорацией Майкрософт. Включить SSE с помощью управляемых пользователем ключей для учетной записи хранения можно на [портале Azure](https://portal.azure.com/). В колоне **параметров** для учетной записи хранения выберите **Шифрование**. Выберите параметр **Использовать собственный ключ**, как показано на следующем рисунке.

![Снимок экрана портала с параметром шифрования](./media/storage-service-encryption-customer-managed-keys/ssecmk1.png)

### <a name="step-4-select-your-key"></a>Шаг 4. Выбор ключа

Вы можете указать ключ в качестве универсального кода ресурса (URI) или выбрать из хранилища ключей.

#### <a name="specify-a-key-as-a-uri"></a>Указание ключа в качестве URI

Чтобы указать ключ из URI, сделайте следующее.

1. Выберите параметр **Введите URI ключа**.  
2. В поле **Ключевой URI** укажите URI.

    ![Снимок экрана портала с окном SSE, в котором выбрано указание универсального кода ресурса (URI) ключа](./media/storage-service-encryption-customer-managed-keys/ssecmk2.png)


#### <a name="specify-a-key-from-a-key-vault"></a>Указание ключа из хранилища ключей 

Чтобы указать ключ из хранилища ключей, сделайте следующее.

1. Выберите параметр **Выбрать в Key Vault**.  
2. Выберите хранилище ключей, содержащее ключ, который вы хотите использовать.
3. Выберите ключ из хранилища ключей.

    ![Снимок экрана портала с окном SSE, в котором выбрано использование собственного ключа](./media/storage-service-encryption-customer-managed-keys/ssecmk3.png)

Если в учетной записи хранения нет доступа к хранилищу ключей, можно выполнить команду Azure PowerShell, показанную на рисунке ниже, чтобы предоставить доступ.

![Снимок экрана портала, показывающий отказ в доступе к Key Vault](./media/storage-service-encryption-customer-managed-keys/ssecmk4.png)

Вы также можете предоставить доступ с помощью портала Azure, перейдя к Azure Key Vault на портале Azure и предоставив доступ учетной записи хранения.


Указанный выше ключ можно связать с существующей учетной записи хранения с помощью следующих команд PowerShell:
```powershell
$storageAccount = Get-AzureRmStorageAccount -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount"
$keyVault = Get-AzureRmKeyVault -VaultName "mykeyvault"
$key = Get-AzureKeyVaultKey -VaultName $keyVault.VaultName -Name "keytoencrypt"
Set-AzureRmKeyVaultAccessPolicy -VaultName $keyVault.VaultName -ObjectId $storageAccount.Identity.PrincipalId -PermissionsToKeys wrapkey,unwrapkey,get
Set-AzureRmStorageAccount -ResourceGroupName $storageAccount.ResourceGroupName -AccountName $storageAccount.StorageAccountName -EnableEncryptionService "Blob" -KeyvaultEncryption -KeyName $key.Name -KeyVersion $key.Version -KeyVaultUri $keyVault.VaultUri
```


### <a name="step-5-copy-data-to-storage-account"></a>Этап 5. Копирование данных в учетную запись хранения

Чтобы передать данные в учетную запись хранения для шифрования, ознакомьтесь с шагом 3 статьи [Шифрование службы хранилища Azure для неактивных данных (предварительная версия)](storage-service-encryption.md#step-3-copy-data-to-storage-account).

### <a name="step-6-query-the-status-of-the-encrypted-data"></a>Шаг 6. Запрос состояния зашифрованных данных

Чтобы подать запрос на состояние зашифрованных данных, ознакомьтесь с шагом 4 статьи [Шифрование службы хранилища Azure для неактивных данных (предварительная версия)](storage-service-encryption.md#step-4-query-the-status-of-the-encrypted-data).

## <a name="faq-for-sse-with-customer-managed-keys"></a>Часто задаваемые вопросы о SSE для управляемых клиентом ключей

**Вопрос. Я использую хранилище уровня "Премиум". Могу ли я использовать управляемые клиентом ключи с функцией SSE?**

Ответ. Да, функцию SSE можно использовать с ключами, управляемыми корпорацией Майкрософт, и управляемыми клиентом ключами в хранилищах уровня "Стандартный" и "Премиум".

**Вопрос. Можно ли создавать учетные записи хранения с включенной функцией SSE, используя управляемые клиентом ключи, с помощью Azure PowerShell и Azure CLI?**

Ответ. Да.

**Вопрос. Насколько дороже обходится служба хранилища Azure, если я использую управляемые клиентом ключи с функцией SSE?**

Ответ. Вы платите за использование Azure Key Vault. Дополнительные сведения см. на [странице цен на Key Vault](https://azure.microsoft.com/pricing/details/key-vault/). За использование SSE дополнительная плата не требуется. Это включено для всех учетных записей хранения.

**Вопрос. Можно ли отменить доступ к ключам шифрования?**

Ответ. Да, вы можете отменить доступ в любое время. Отменить доступ к ключам можно несколькими способами. Чтобы получить дополнительные сведения, обратитесь к разделам [Azure​RM.​Key​Vault](https://docs.microsoft.com/powershell/module/azurerm.keyvault/) и [Key Vault - az keyvault](https://docs.microsoft.com/cli/azure/keyvault). Отмена доступа фактически заблокирует доступ ко всем большим двоичным объектам в учетной записи хранения, так как ключ шифрования учетной записи станет недоступен службе хранилища Azure.

**Вопрос. Могу ли я создать учетную запись хранения и ключ в разных регионах?**

Ответ. Нет, учетная запись хранения, Azure Key Vault и ключ должны находиться в одном регионе.

**Вопрос. Могу ли я включить управляемые клиентом ключи для функции SSE при создании учетной записи хранения?**

О. Нет. При первом создании учетной записи хранения для функции SSE доступны только ключи, управляемые корпорацией Майкрософт. Чтобы использовать управляемые клиентом ключи, вам потребуется обновить свойства учетной записи хранения. Вы можете использовать REST или одну из клиентских библиотек службы хранилища, чтобы обновить учетную запись хранения программными средствами. Также можно обновить свойства учетной записи хранения с помощью портала Azure после ее создания.

**Вопрос. Могу ли я отключить шифрование при использовании управляемых клиентом ключей с функцией SSE?**

Ответ. Нет, отключить шифрование невозможно. Шифрование включено автоматически для всех служб (хранилища BLOB-объектов, хранилища файлов, таблиц и очередей). При необходимости вы можете перейти от использования ключей, управляемых корпорацией Майкрософт, на использование управляемых клиентом ключей и наоборот.

**Вопрос. Включается ли SSE по умолчанию при создании учетной записи хранения?**

Ответ. SSE включено автоматически для всех учетных записей хранения и всех служб (хранилища BLOB-объектов, хранилища файлов, таблиц и очередей).

**Вопрос. Мне не удается включить функцию SSE с помощью управляемых клиентом ключей в своей учетной записи хранения.**

Ответ. Это учетная запись хранения Azure Resource Manager? Классические учетные записи хранения не поддерживаются с управляемыми клиентом ключами. Функцию SSE с управляемыми клиентом ключами можно включить только в учетных записях хранения Resource Manager.

**Вопрос. Что такое функция обратимого удаления и Do Not Purge (Не очищать)? Нужно ли включить этот параметр, чтобы использовать SSE с управляемыми клиентом ключами?**

Ответ. Чтобы использовать управляемые клиентом ключи, необходимо включить функцию обратимого удаления и Do Not Purge (Не очищать). Эти параметры гарантируют, что ключ не будет случайно или намерено удален. Максимальный срок хранения ключей составляет 90 дней. Пользователи защищены от злоумышленников и шантажистов. Этот параметр нельзя отключить.

**Вопрос. Функция SSE с управляемыми клиентом ключами доступна только в определенных регионах?**

Ответ. Функция SSE с управляемыми клиентом ключами доступна во всех регионах для хранилища BLOB-объектов и хранилища файлов.

**Вопрос. Куда обратиться, чтобы задать вопрос или оставить отзыв?**

Ответ. По любым вопросам, связанным с шифрованием службы хранилища, обращайтесь по адресу [ssediscussions@microsoft.com](mailto:ssediscussions@microsoft.com).

## <a name="next-steps"></a>Дополнительная информация

-   Дополнительные сведения о комплексном наборе функций, помогающем разработчикам создавать безопасные приложения, см. в разделе [Руководство по безопасности службы хранилища Azure](storage-security-guide.md).

-   Общие сведения о Azure Key Vault см. в статье [Что такое хранилище ключей Azure?](https://docs.microsoft.com/azure/key-vault/key-vault-whatis)

-   О том, как приступить к работе с Azure Key Vault, рассказывается в разделе [Приступая к работе с хранилищем ключей Azure](https://docs.microsoft.com/azure/key-vault/key-vault-get-started).
