<properties
	pageTitle="Использование подписанных URL-адресов (SAS) | Microsoft Azure"
	description="Дополнительные сведения о делегировании доступа к ресурсам службы хранилища Azure, включая большие двоичные объекты, очереди, таблицы и файлы, с помощью подписанного URL-адреса (SAS)."
	services="storage"
	documentationCenter=""
	authors="tamram"
	manager="carmonm"
	editor="tysonn"/>

<tags
	ms.service="storage"
	ms.workload="storage"
	ms.tgt_pltfrm="na"
	ms.devlang="dotnet"
	ms.topic="article"
	ms.date="09/07/2016"
	ms.author="tamram"/>



# Использование подписанных URL-адресов (SAS)

## Обзор

Подписанный URL-адрес (SAS) — это эффективное средство для предоставления другим клиентам ограниченного доступа к объектам в вашей учетной записи хранения без предоставления ключа вашей учетной записи. Первая часть этого учебника по подписям общего доступа содержит обзор модели SAS и рекомендации по использованию SAS. [Часть 2](storage-dotnet-shared-access-signature-part-2.md) этого учебника содержит пошаговое описание процесса создания подписей общего доступа с помощью службы BLOB-объектов.

## Что такое подписанный URL-адрес?

Подпись общего доступа обеспечивает делегированный доступ к ресурсам в вашей учетной записи хранения. Это означает, что клиенту можно предоставить ограниченное право на работу с объектами в вашей учетной записи хранения на определенный период времени и с определенным набором разрешений, не сообщая ему ключи доступа к своей учетной записи. Подпись общего доступа — это URI, который в своих параметрах запроса содержит все сведения, необходимые доступа к ресурсу хранилища с прохождением проверки подлинности. Для доступа к ресурсам хранилища с помощью SAS клиенту достаточно передать SAS в соответствующий конструктор или метод.

## Когда следует использовать подписанный URL-адрес?

Подпись общего доступа можно использовать, когда доступ к ресурсам в вашей учетной записи хранения требуется предоставить клиенту, которому нельзя доверить ключ учетной записи. Ключи вашей учетной записи хранения включают в себя как первичный, так и вторичный ключ, и оба этих ключа предоставляют административный доступ к вашей учетной записи и всем ее ресурсам. Предоставление любого из ключей учетной записи делает ее уязвимой вредоносного или небрежного использования. Подписи общего доступа обеспечивают безопасную альтернативу, позволяющую другим клиентам считывать, записывать и удалять данные в вашей учетной записи хранения в соответствии с выданными вами разрешениями и без потребности в ключе учетной записи.

Распространенным сценарием использования подписей общего доступа является служба, где пользователи считывают и записывают собственные данные в вашей учетной записи хранения. В сценарии, где в учетной записи хранения хранятся пользовательские данные, существует два направления разработки:


1\. Клиенты отправляют и загружают данные с помощью службы интерфейсного прокси-сервера, выполняющей проверку подлинности. Эта служба интерфейсного прокси-сервера позволяет проверять бизнес-правила, однако для больших объемов данных или крупных транзакций создание службы, поддерживающей масштабирование в соответствии с потребностями, может оказаться дорогостоящей или сложной задачей.

![sas-storage-fe-proxy-service][sas-storage-fe-proxy-service]

2) Облегченная служба проверяет подлинность клиента по мере необходимости и затем создает подпись общего доступа. Клиент, получив эту подпись общего доступа, может осуществлять прямой доступ к ресурсам учетной записи хранения с разрешениями, определенными в подписи, и в течение разрешенного подписью периода времени. Подпись общего доступа уменьшает потребность в маршрутизации всех данных через службу интерфейсного прокси-сервера.

![sas-storage-provider-service][sas-storage-provider-service]

Многие реальные службы могут совмещать эти два подхода в зависимости от ситуации: некоторые данные обрабатываются и проверяются через интерфейсный прокси-сервер, а другие данные сохраняются и/или считываются непосредственно с помощью подписи общего доступа.

Кроме того, SAS потребуется использовать для проверки подлинности исходного объекта в операции копирования при определенных сценариях:

- При копировании большого двоичного объекта в другой большой двоичный объект, который относится к другой учетной записи, необходимо использовать SAS для проверки подлинности исходного большого двоичного объекта. Начиная с версии от 5 апреля 2015 г. вы можете по желанию использовать SAS также для проверки подлинности конечного BLOB-объекта.
- При копировании файла в другой файл, который относится к другой учетной записи, необходимо использовать SAS для проверки подлинности исходного файла. Начиная с версии от 5 апреля 2015 г. вы можете по желанию использовать SAS также для проверки подлинности конечного файла.
- При копировании большого двоичного объекта в файл или файла в большой двоичный объект, необходимо использовать SAS для проверки подлинности исходного объекта, даже если исходный и конечный объекты относятся к одной и той же учетной записи хранения.

## Типы подписанных URL-адресов

В версии службы хранилища Azure от 5 апреля 2015 г. появился новый тип подписанного URL-адреса — подписанный URL-адрес учетной записи. Теперь вы можете создавать подписанные URL-адреса двух типов:

- **SAS учетной записи.** SAS учетной записи делегирует доступ к ресурсам в одной или нескольких службах хранилища. SAS учетной записи предоставляет доступ ко всем операциям, которые доступны через SAS службы. Кроме того, SAS учетной записи позволяет делегировать доступ к операциям, относящимся к конкретной службе, таким как **получение и установка свойств службы** или **получение статистики службы**. Вы также можете делегировать доступ к операциям чтения, записи и удаления в контейнерах BLOB-объектов, таблицах, очередях и общих папках, что невозможно при использовании SAS службы. Подробные сведения о создании маркера SAS учетной записи см. в статье [Создание SAS учетной записи](https://msdn.microsoft.com/library/mt584140.aspx).

- **SAS службы.** SAS службы делегирует доступ к ресурсу только в одной из служб хранилища: в службе BLOB-объектов, очередей, таблиц или файлов. Подробные сведения о создании маркеров SAS службы см. в статьях [Создание универсального кода ресурса (URI) подписанного URL-адреса](https://msdn.microsoft.com/library/dn140255.aspx) и [Примеры подписей общего доступа](https://msdn.microsoft.com/library/dn140256.aspx).

## Принцип работы подписанного URL-адреса

Подписанный URL-адрес представляет собой универсальный код ресурса (URI), который указывает на один или несколько ресурсов хранилища и содержит маркер с особым набором параметров запроса. Маркер определяет способы доступа к ресурсам, предоставляемые клиенту. Один из параметров запроса (подпись) состоит из параметров SAS и подписывается с помощью ключа учетной записи. Эта подпись используется хранилищем Azure для проверки подлинности подписи общего доступа.

Некоторые параметры маркеров SAS учетной записи и SAS службы совпадают, но есть и параметры, которые различаются.

### Параметры, общие для маркеров SAS учетной записи и SAS службы

- **Версия API.** Необязательный параметр, который указывает версию службы хранилища для выполнения запроса.
- **Версия службы.** Обязательный параметр, который указывает версию службы хранилища для аутентификации запроса.
- **Время начала.** Это время, когда подпись общего доступа становится действительной. Время начала для подписи общего доступа не является обязательным; если этот параметр опущен, подпись общего доступа вступает в силу немедленно. Время должно быть выражено в формате UTC с соответствующим указателем ("Z"), т. е. 1994-11-05T13:15:30Z.
- **Время окончания срока действия.** Это время, после которого подпись общего доступа перестает быть действительной. Рекомендуется указать время окончания срока действия для подписи общего доступа или связать ее с хранимой политикой доступа. Время должно быть выражено в формате UTC с соответствующим указателем ("Z"), т. е. 1994-11-05T13:15:30Z (дополнительные сведения см. ниже).
- **Разрешения.** Разрешения, заданные для подписи общего доступа, указывают операции, которые клиент может выполнять для ресурсов хранилища с помощью этой подписи общего доступа. Разрешения, доступные для SAS учетной записи и SAS службы, различаются.
- **IP-адрес.** Необязательный параметр, который указывает IP-адрес или диапазон IP-адресов за пределами Azure (см. раздел [Состояние конфигурации сеанса маршрутизации](../expressroute/expressroute-workflows.md#routing-session-configuration-state) для ExpressRoute), с которых следует принимать запросы.
- **Протокол.** Необязательный параметр, который задает допустимый протокол для запроса. Параметр может иметь значение "HTTPS, HTTP" (принимаются протоколы HTTPS и HTTP, это значение используется по умолчанию) или "HTTPS" (только протокол HTTPS). Обратите внимание, что использовать только протокол HTTP нельзя.
- **Подпись.** Подпись составляется из других параметров, указанных в маркере, а затем шифруется. Она используется для проверки подлинности SAS.

### Параметры маркера SAS учетной записи

- **Служба или службы.** SAS учетной записи может делегировать доступ к одной или нескольким службам хранилища. Например, вы можете создать подписанный URL-адрес учетной записи, делегирующий доступ к службе BLOB-объектов или службе файлов. Также вы можете создать подписанный URL-адрес, делегирующий доступ ко всем четырем службам (BLOB-объектов, очередей, таблиц и файлов).
- **Типы ресурсов хранилища.** SAS учетной записи применяется к одному или нескольким классам ресурсов хранилища, а не к конкретному ресурсу. С помощью SAS учетной записи можно делегировать доступ к следующим типам ресурсов:
	- API-интерфейсы уровня службы, которые вызываются для ресурсов учетной записи хранения. Вот некоторые примеры: **Get/Set Service Properties**, **Get Service Stats** и **List Containers/Queues/Tables/Shares**.
	- API-интерфейсы уровня контейнеров, которые вызываются для объектов-контейнеров каждой службы: BLOB-контейнеров, очередей, таблиц и общих папок. Вот некоторые примеры: **Create/Delete Container**, **Create/Delete Queue**, **Create/Delete Table**, **Create/Delete Share** и **List Blobs/Files and Directories**.
	- API-интерфейсы уровня объектов, которые вызываются для больших двоичных объектов, сообщений в очереди, сущностей таблицы и отдельных файлов. Например: **Put Blob**, **Query Entity**, **Get Messages** и **Create File**.

### Параметры маркера SAS службы

- **Ресурс хранилища.** SAS службы позволяет делегировать доступ к следующим ресурсам хранилища:
	- контейнеры и большие двоичные объекты;
	- Общие папки и файлы
	- Очереди
	- Таблицы и диапазоны сущностей таблицы

## Примеры универсального кода ресурса (URI) подписанного URL-адреса

В примере ниже универсальный код ресурса (URI) подписанного URL-адреса службы предоставляет разрешения на чтение и запись для BLOB-объекта. В таблице описана каждая из частей URI, чтобы можно было понять ее роль в работе подписи общего доступа:

	https://myaccount.blob.core.windows.net/sascontainer/sasblob.txt?sv=2015-04-05&st=2015-04-29T22%3A18%3A26Z&se=2015-04-30T02%3A23%3A26Z&sr=b&sp=rw&sip=168.1.5.60-168.1.5.70&spr=https&sig=Z%2FRHIX5Xcg0Mq2rqI3OlWTjEg2tYkboXr1P9ZUXDtkk%3D

Имя|Сегмент SAS|Описание
---|---|---
URI BLOB-объекта|https://myaccount.blob.core.windows.net/sascontainer/sasblob.txt |Адрес BLOB-объекта. Обратите внимание, что настоятельно рекомендуется использовать HTTPS.
Версия служб хранилища|sv=2015-04-05|Для служб хранилища версии 2012-02-12 и более поздней этот параметр указывает используемую версию.
Время начала|st=2015-04-29T22%3A18%3A26Z|Указывается в формате UTC. Чтобы подпись общего доступа вступала в силу сразу же, не указывайте время начала действия.
Время окончания срока действия|se=2015-04-30T02%3A23%3A26Z|Указывается в формате UTC.
Resource (Ресурс)|sr=b|Ресурс является BLOB-объектом.
Разрешения|sp=rw|Разрешения, предоставляемые подписью общего доступа, включают в себя чтение (r) и запись (w).
Диапазон IP-адресов|sip=168.1.5.60-168.1.5.70|Диапазон IP-адресов, с которых будут приниматься запросы.
Протокол|spr=https|Разрешены запросы только по протоколу HTTPS.
Подпись|sig=Z%2FRHIX5Xcg0Mq2rqI3OlWTjEg2tYkboXr1P9ZUXDtkk%3D|Используется для проверки подлинности доступа к BLOB-объекту. Подпись представляет собой код HMAC, рассчитанный по алгоритму SHA256 с использованием ключа и преобразования строки в символы. Полученное значение преобразуется в кодировку Base64.

А в этом примере представлен SAS учетной записи c теми же общими параметрами маркера. Описание этих параметров приведено выше. В следующей таблице указаны только те параметры, которые относятся к SAS учетной записи.

	https://myaccount.blob.core.windows.net/?restype=service&comp=properties&sv=2015-04-05&ss=bf&srt=s&st=2015-04-29T22%3A18%3A26Z&se=2015-04-30T02%3A23%3A26Z&sr=b&sp=rw&sip=168.1.5.60-168.1.5.70&spr=https&sig=F%6GRVAZ5Cdj2Pw4tgU7IlSTkWgn7bUkkAg8P6HESXwmf%4B

Имя|Сегмент SAS|Описание
---|---|---
Универсальный код ресурса (URI)|https://myaccount.blob.core.windows.net/?restype=service&comp=properties|The Конечная точка службы BLOB-объектов с параметрами для получения свойств службы (для запроса GET) или задания свойств службы (для запроса SET).
Службы|ss=bf|SAS применяется к службам больших двоичных объектов и службам файлов.
Типы ресурсов|srt=s|SAS применяется к операциям на уровне службы.
Разрешения|sp=rw|Разрешения предоставляют доступ к операциям чтения и записи.  

Так как разрешения ограничены уровнем служб, этот SAS позволяет выполнять такие операции: **Get Blob Service Properties** (чтение) и **Set Blob Service Properties** (запись). Этот же токен SAS с другим универсальным кодом ресурса (URI) ресурса будет предоставлять доступ к операции **Получение статистики службы BLOB-объектов** (чтение).

## Использование хранимой политики доступа для управления SAS ##

Подпись общего доступа может принимать одну из двух форм:

- **Нерегламентированная SAS:** при создании нерегламентированной SAS время начала, время окончания срока действия и разрешения для SAS указываются в URI SAS (или подразумеваются в случае, когда опускается время начала). Этот тип можно использовать для SAS учетной записи и SAS службы.

- **SAS с хранимой политикой доступа.** Хранимая политика доступа определяется в контейнере ресурсов (контейнере больших двоичных объектов, таблице, очереди или общей папке) и может использоваться для управления ограничениями одного или нескольких подписанных URL-адресов. При сопоставлении подписи общего доступа с хранимой политикой доступа эта подпись наследует ограничения (время начала, время окончания и разрешения), определенные для данной хранимой политики доступа.

>[AZURE.NOTE] На данный момент SAS учетной записи может быть только нерегламентированным. Хранимые политики доступа для SAS учетной записи пока не поддерживаются.

Различие между этими двумя формами важно для одного ключевого сценария — отзыва. Подпись общего доступа — это URL-адрес, этой подписью может воспользоваться любой человек, который ее получил, независимо от того, кто изначально запрашивал такую подпись. Размещенный в свободном доступе подписанный URL-адрес сможет использовать любой человек. Распространяемая подпись общего доступа действительна до тех пор, пока не произойдет одно из четырех возможных событий:

1.	Наступает время истечения срока действия, указанное для данной подписи общего доступа.
2.	Наступает время истечения срока действия, указанное в хранимой политике доступа, на которую ссылается подпись общего доступа (если имеется ссылка на хранимую политику доступа, в которой задано время окончания срока действия). Это может произойти либо из-за истечения заданного времени, либо из-за изменения хранимой политики доступа и переноса времени окончания срока действия в прошлое, что является одним из способов отозвать подпись общего доступа.
3.	Удаляется хранимая политика доступа, на которую ссылается подпись, что является другим способом отозвать подпись общего доступа. Заметьте, что при повторном создании хранимой политики доступа с таким же именем все существующие маркеры подписи общего доступа снова станут действительными в соответствии с разрешениями, связанными с этой хранимой политикой доступа (предполагается, что время окончания срока действия для подписи общего доступа еще не истекло). Если планируется отозвать подпись общего доступа, следует использовать другое имя при повторном создании политики доступа, у которой время окончания срока действия относится к будущему.
4.	Повторно создается ключ учетной записи, который был использован для создания подписи общего доступа. Обратите внимание, что это приведет к неспособности всех компонентов приложения, которые используют этот ключ учетной записи, пройти проверку подлинности до тех пор, пока они не будут обновлены для использования другого действительного ключа учетной записи или вновь созданного ключа учетной записи.

>[AZURE.IMPORTANT] URI подписанного URL-адреса связан с ключом учетной записи, который использовался для создания подписи и соответствующей хранимой политики доступа (при наличии таковой). Если хранимая политика доступа не указана, то единственный способ отменить подписанный URL-адрес — изменить ключ учетной записи.

## Примеры. Создание и использование подписанных URL-адресов

Ниже приведены примеры подписанных URL-адресов обоих типов: SAS учетной записи и SAS службы.

Чтобы запустить эти примеры, необходимо скачать такие пакеты и использовать их:

- [Клиентская библиотека службы хранилища Azure для .NET](http://www.nuget.org/packages/WindowsAzure.Storage) версии 6.0 или более поздней (для использования учетной записи SAS).
- [Диспетчер конфигураций Azure](http://www.nuget.org/packages/Microsoft.WindowsAzure.ConfigurationManager)

### Пример. Учетная запись SAS

В следующем примере кода показано создание подписанного URL-адреса учетной записи, который действует для службы BLOB-объектов или службы файлов и предоставляет клиенту права на чтение, запись и получение списков через API-интерфейсы уровня службы. В SAS учетной записи указано ограничение на использование протоколов, поэтому запрос должен быть выполнен с помощью протокола HTTPS.

    static string GetAccountSASToken()
    {
        // To create the account SAS, you need to use your shared key credentials. Modify for your account.
	    const string ConnectionString = "DefaultEndpointsProtocol=https;AccountName=account-name;AccountKey=account-key";
	    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(ConnectionString);

        // Create a new access policy for the account.
        SharedAccessAccountPolicy policy = new SharedAccessAccountPolicy()
            {
                Permissions = SharedAccessAccountPermissions.Read | SharedAccessAccountPermissions.Write | SharedAccessAccountPermissions.List,
                Services = SharedAccessAccountServices.Blob | SharedAccessAccountServices.File,
                ResourceTypes = SharedAccessAccountResourceTypes.Service,
                SharedAccessExpiryTime = DateTime.UtcNow.AddHours(24),
                Protocols = SharedAccessProtocol.HttpsOnly
            };

        // Return the SAS token.
        return storageAccount.GetSharedAccessSignature(policy);
    }

Чтобы использовать SAS учетной записи для доступа к API-интерфейсам уровня службы для службы BLOB-объектов, создайте клиентский BLOB-объект с помощью SAS и конечной точки хранилища BLOB-объектов для вашей учетной записи хранения.

    static void UseAccountSAS(string sasToken)
    {
        // In this case, we have access to the shared key credentials, so we'll use them
        // to get the Blob service endpoint.
	    const string ConnectionString = "DefaultEndpointsProtocol=https;AccountName=account-name;AccountKey=account-key";
	    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(ConnectionString);
        CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();

        // Create new storage credentials using the SAS token.
        StorageCredentials accountSAS = new StorageCredentials(sasToken);
        // Use these credentials and the Blob storage endpoint to create a new Blob service client.
        CloudStorageAccount accountWithSAS = new CloudStorageAccount(accountSAS, blobClient.StorageUri, null, null, null);
        CloudBlobClient blobClientWithSAS = accountWithSAS.CreateCloudBlobClient();

        // Now set the service properties for the Blob client created with the SAS.
        blobClientWithSAS.SetServiceProperties(new ServiceProperties()
        {
            HourMetrics = new MetricsProperties()
            {
                MetricsLevel = MetricsLevel.ServiceAndApi,
                RetentionDays = 7,
                Version = "1.0"
            },
            MinuteMetrics = new MetricsProperties()
            {
                MetricsLevel = MetricsLevel.ServiceAndApi,
                RetentionDays = 7,
                Version = "1.0"
            },
            Logging = new LoggingProperties()
            {
                LoggingOperations = LoggingOperations.All,
                RetentionDays = 14,
                Version = "1.0"
            }
        });

        // The permissions granted by the account SAS also permit you to retrieve service properties.
        ServiceProperties serviceProperties = blobClientWithSAS.GetServiceProperties();
        Console.WriteLine(serviceProperties.HourMetrics.MetricsLevel);
        Console.WriteLine(serviceProperties.HourMetrics.RetentionDays);
        Console.WriteLine(serviceProperties.HourMetrics.Version);
    }

### Пример. Служба SAS с хранимой политикой доступа

В следующем примере кода показано создание хранимой политики доступа для контейнера и последующее создание SAS службы для этого контейнера. Затем SAS можно передавать клиентам, чтобы предоставить им разрешения на чтение и запись в контейнере. Измените код, чтобы использовать имя своей учетной записи:

    // Parse the connection string for the storage account.
    const string ConnectionString = "DefaultEndpointsProtocol=https;AccountName=account-name;AccountKey=account-key";
    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(ConnectionString);

    // Create the storage account with the connection string.
    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(storageConnectionString);

    // Create the blob client object.
    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();

    // Get a reference to the container for which shared access signature will be created.
    CloudBlobContainer container = blobClient.GetContainerReference("mycontainer");
    container.CreateIfNotExists();

    // Get the current permissions for the blob container.
    BlobContainerPermissions blobPermissions = container.GetPermissions();

    // Clear the container's shared access policies to avoid naming conflicts.
    blobPermissions.SharedAccessPolicies.Clear();

    // The new shared access policy provides read/write access to the container for 24 hours.
    blobPermissions.SharedAccessPolicies.Add("mypolicy", new SharedAccessBlobPolicy()
    {
       // To ensure SAS is valid immediately, don’t set the start time.
       // This way, you can avoid failures caused by small clock differences.
       SharedAccessExpiryTime = DateTime.UtcNow.AddHours(24),
       Permissions = SharedAccessBlobPermissions.Write | SharedAccessBlobPermissions.Read | SharedAccessBlobPermissions.Create | SharedAccessBlobPermissions.Add
    });

    // The public access setting explicitly specifies that
    // the container is private, so that it can't be accessed anonymously.
    blobPermissions.PublicAccess = BlobContainerPublicAccessType.Off;

    // Set the new stored access policy on the container.
    container.SetPermissions(blobPermissions);

    // Get the shared access signature token to share with users.
    string sasToken =
       container.GetSharedAccessSignature(new SharedAccessBlobPolicy(), "mypolicy");

Клиент, которому принадлежит подписанный URL-адрес службы, может использовать его в своем коде для подтверждения подлинности запроса на чтение или запись в BLOB-объекте в этом контейнере. Например, следующий код создает с помощью маркера SAS новый блочный BLOB-объект в контейнере. Измените код, чтобы использовать имя своей учетной записи:

    Uri blobUri = new Uri("https://<myaccount>.blob.core.windows.net/mycontainer/myblob.txt");

    // Create credentials with the SAS token. The SAS token was created in previous example.
    StorageCredentials credentials = new StorageCredentials(sasToken);

    // Create a new blob.
    CloudBlockBlob blob = new CloudBlockBlob(blobUri, credentials);

    // Upload the blob.
    // If the blob does not yet exist, it will be created.
    // If the blob does exist, its existing content will be overwritten.
    using (var fileStream = System.IO.File.OpenRead(@"c:\Temp\myblob.txt"))
    {
    	blob.UploadFromStream(fileStream);
    }


## Рекомендации по использованию подписанных URL-адресов

При использовании подписей общего доступа в приложениях необходимо иметь в виду две потенциальные проблемы:

- В случае утечки подписи ей сможет пользоваться любой человек, что потенциально может нарушить безопасность вашей учетной записи хранения.
- Если срок действия подписи, предоставленной клиентскому приложению, истекает и приложение не может получить новую подпись из вашей службы, это может нарушить работу приложения.

Следующие рекомендации по использованию подписи общего доступа помогут нейтрализовать эти риски:

1. **Всегда используйте HTTPS** для создания подписи общего доступа или ее распространения. Если подпись передается по протоколу HTTP и перехватывается, посредством атак "злоумышленник в середине" злоумышленник сможет считать подпись и затем использовать ее вместо предполагаемого пользователя, что может привести к раскрытию конфиденциальных данных или к повреждению данных злоумышленником.
2. **Ссылайтесь на хранимые политики доступа, где это возможно.** Хранимые политики доступа дают возможность отозвать разрешения без повторного создания ключей учетной записи хранения. Задайте для них очень большой (или бесконечный) срок действия и убедитесь, что он регулярно переносится на будущее время.
3. **Используйте небольшой срок для нерегламентированной SAS.** Даже если безопасность подписи будет тайно нарушена, эта подпись будет служить источником уязвимости лишь непродолжительное время. Это особенно важно в случаях, когда нельзя ссылаться на хранимую политику доступа. Такой подход также позволяет ограничить объем данных, который может быть записан в BLOB-объект, путем ограничения времени на отправку этих данных.
4. **Запрограммируйте автоматическое обновление подписи клиентами при необходимости.** Клиенты должны обновлять подпись задолго до ожидаемого окончания ее срока действия, чтобы оставить время для повторных попыток в случае недоступности службы подписей общего доступа. Если ваша подпись будет использоваться для небольшого числа кратковременных операций, которые должны быть завершены в течение заданного срока действия, такая мера может оказаться лишней, так как обновление подписи не предусматривается. Однако если имеется клиент, регулярно выполняющий запросы через подпись, то возможность истечения срока действия следует принять во внимание. Рекомендуется сбалансировать требование к кратковременности использования подписи (как указано выше) с требованием того, чтобы клиент запрашивал обновление достаточно рано во избежание проблем, связанных с истечением срока действия подписи до завершения обновления.
5. **Будьте осторожны с временем начала действия подписи.** Если задать для времени начала действия подписи значение **now**, из-за разницы во времени (между текущим временем на разных компьютерах) могут наблюдаться периодические сбои в течение первых нескольких минут. В общем случае устанавливайте время начала действия на 15 минут или более в прошлом времени или не задавайте вообще, что сделает подпись действительной во всех случаях. То же касается и времени истечения срока действия. Помните, что для каждого запроса может наблюдаться рассинхронизация по времени до 15 минут в любом направлении. Для клиентов, использующих версию REST, предшествующую версии 2012-02-12, максимальный срок действия подписи общего доступа, которая не ссылается на хранимую политику, составляет 1 час, а все политики, где указано большее время, вызовут сбой.
6.	**Четко указывайте ресурс, к которому осуществляется доступ.** В общем случае рекомендуется предоставить пользователю минимально необходимый набор прав. Если пользователю требуется только доступ для чтения к отдельной сущности, предоставьте доступ на чтение к этой сущности, а не доступ на чтение, запись и удаление для всех сущностей. Это также помогает избежать угрозы раскрытия подписи и сокращает возможности получившего ее злоумышленника.
7.	**Учитывайте, что ваша учетная запись тарифицируется за любое использование, включая то, что осуществляется посредством SAS.** Если вы предоставляете доступ на запись к BLOB-объекту, пользователь может отправить BLOB-объект размером 200 ГБ. Если вы также предоставляете доступ на чтение, пользователь может загрузить его 10 раз, в результате чего вам потребуется оплачивать исходящий трафик объемом 2 ТБ. Опять же, ограниченные разрешения помогают сузить спектр возможностей злоумышленников. Используйте краткосрочные подписи, чтобы снизить угрозу (но помните о влиянии рассинхронизации часов на время окончания действия).
8.	**Проверьте данные, записанные с помощью SAS.** Когда клиентское приложение записывает данные в вашу учетную запись хранения, помните, что эти данные могут стать источником проблем. Если приложение требует проверять достоверность или подлинность данных перед их использованием, такую проверку следует выполнять после записи данных и перед их использованием в приложении. Такой подход также обеспечивает защиту от поврежденных или вредоносных данных, записываемых в вашу учетную запись как пользователем, который получил подпись правомерно, так и пользователем, использующим подпись после ее утечки.
9. **Не следует всегда использовать SAS.** Иногда риски для вашей учетной записи хранения, связанные с конкретной операцией, перевешивают преимущества подписи общего доступа. Для таких операций создавайте службу среднего уровня, которая записывает данные в вашу учетную запись хранения после выполнения проверки, проверки подлинности и аудита на основании бизнес-правил. Кроме того, иногда проще организовать управление доступом другим образом. Например, если вы хотите сделать все BLOB-объекты в контейнере общедоступными для чтения, можно сделать этот контейнер открытым, не предоставляя всем клиентам подпись общего доступа.
10.	**Используйте аналитику хранилища для мониторинга приложения.** Вы можете использовать ведение журнала и метрики, чтобы определять всплески сбоев проверки подлинности, вызванных сбоем в службе поставщика подписей общего доступа или непреднамеренным удалением хранимой политики доступа. Дополнительные сведения см. в [блоге группы разработчиков хранилища Azure](http://blogs.msdn.com/b/windowsazurestorage/archive/2011/08/03/windows-azure-storage-logging-using-logs-to-track-storage-requests.aspx).

## Заключение ##

Подписи общего доступа удобно применять в целях предоставления ограниченных разрешений для вашей учетной записи хранения тем клиентам, которые нельзя передавать ключ учетной записи. Таким образом, они являются важной частью модели обеспечения безопасности для любого приложения, использующего хранилище Azure. Если следовать указанным здесь рекомендациям, подписи общего доступа позволяют повысить гибкость доступа к ресурсам в вашей учетной записи хранения без ущерба для безопасности приложения.

## Дальнейшие действия ##

- Подписанные URL-адреса. Часть 2: создание и использование подписанного URL-адреса в службе BLOB-объектов
- [Приступая к работе с хранилищем файлов Azure в Windows](storage-dotnet-how-to-use-files.md)
- [Управление анонимным доступом на чтение к контейнерам и большим двоичным объектам](storage-manage-access-to-resources.md)
- [Делегирование доступа с помощью подписанного URL-адреса](http://msdn.microsoft.com/library/azure/ee395415.aspx)
- [Введение в использование SAS таблиц и очередей](http://blogs.msdn.com/b/windowsazurestorage/archive/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas.aspx)
[sas-storage-fe-proxy-service]: ./media/storage-dotnet-shared-access-signature-part-1/sas-storage-fe-proxy-service.png
[sas-storage-provider-service]: ./media/storage-dotnet-shared-access-signature-part-1/sas-storage-provider-service.png

<!---HONumber=AcomDC_0914_2016-->