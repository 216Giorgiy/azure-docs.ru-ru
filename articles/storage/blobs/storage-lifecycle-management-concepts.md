---
title: Управление жизненным циклом хранилища Azure
description: Узнайте, как создать правила для политики жизненного цикла, чтобы перевести данные из горячего уровня доступа на холодный и архивный.
services: storage
author: yzheng-msft
ms.service: storage
ms.topic: article
ms.date: 11/04/2018
ms.author: yzheng
ms.component: common
ms.openlocfilehash: 5c77d7d8f1ce3b4a13e497d461244aae5b34d08c
ms.sourcegitcommit: c94cf3840db42f099b4dc858cd0c77c4e3e4c436
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2018
ms.locfileid: "53631368"
---
# <a name="managing-the-azure-blob-storage-lifecycle-preview"></a>Управление жизненным циклом хранилища BLOB-объектов Azure (предварительная версия)

Для каждого набора данных существуют уникальные требования к жизненному циклу. На ранних этапах жизненного цикла данных обращение к ним происходит часто. Но по мере устаревания данных потребность в доступе снижается очень быстро. Некоторые данные хранятся в облаке почти без использования, и после сохранения к ним обращаются крайне редко. Некоторые данные устаревают через несколько дней или месяцев после их создания, а другие наборы данных активно считываются и изменяются на протяжении всего времени существования. Управление жизненным циклом хранилища BLOB-объектов Azure (предварительная версия) предоставляет многофункциональные политики на основе правил для учетных записей GPv2 и хранилища BLOB-объектов. Эти политики позволяют переводить данные на новые уровни доступа и удалять их по завершении жизненного цикла.

Политика управления жизненным циклом поддерживает следующие возможности.

- Перемещение больших двоичных объектов на более холодный уровень доступа (с горячего на холодный, с горячего на архивный, с холодного на архивный) для оптимального баланса производительности и стоимости.
- Удаление больших двоичных объектов в конце их жизненных циклов.
- Определение правил, выполняемых раз в день, на уровне учетной записи хранения.
- Применение правил к контейнерам или подмножествам больших двоичных объектов (с префиксами в качестве фильтров).

В качестве примера давайте рассмотрим набор данных, доступ к которому осуществляется очень часто на ранних этапах жизненного цикла, но по истечении двух недель становится эпизодическим. Данные, которые хранятся больше месяца, запрашиваются крайне редко. В этом сценарии для ранних этапов лучше всего выбрать горячий уровень хранилища. Для нерегулярного доступа можно переместить данные на холодный уровень, а через месяц лучше всего воспользоваться архивным уровнем доступа. Выбирая уровни хранилища в зависимости от возраста данных, вы сможете создать наиболее экономичный вариант хранилища для конкретных потребностей. Чтобы достичь перемещения данных на более холодные уровни, можно использовать правила политики управления жизненным циклом.

## <a name="storage-account-support"></a>Поддержка учетных записей хранения

Политика управления жизненным циклом поддерживает учетные записи GPv2 (общего назначения, версия 2) и учетные записи хранилища BLOB-объектов. На портале Azure вы можете преобразовать существующую учетную запись GPv1 в учетную записью GPv2, запустив простой процесс одним щелчком мыши. Дополнительные сведения об учетных записях хранения см. в статье [Общие сведения об учетной записи хранения](../common/storage-account-overview.md).  

## <a name="pricing"></a>Цены 

На этапе предварительной версии функция управления жизненным циклом предоставляется бесплатно. Клиенты оплачивают только обычную стоимость вызовов API [Отображение BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/list-blobs) и [Установка уровня BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/set-blob-tier). Дополнительные сведения см. на странице [цен на блочные BLOB-объекты](https://azure.microsoft.com/pricing/details/storage/blobs/).

## <a name="register-for-preview"></a>Регистрация для использования предварительной версии 
Чтобы зарегистрироваться для использования общедоступной предварительной версии, отправьте запрос на регистрацию этой функции в вашей подписке. Запросы обычно утверждаются в течение двух недель. После утверждения эта возможность становится доступной для всех существующих и новых учетных записей GPv2 и хранилища BLOB-объектов в следующих регионах: Западная часть США 2, Западно-Центральная часть США, Восточная часть США 2 и Западная Европа. В предварительной версии поддерживаются только BLOB-объекты блочного типа. Как и другие функции в предварительной версии, не используйте эту возможность для рабочих нагрузок в рабочей среде, пока не будет выпущена общедоступная версия.

Чтобы отправить запрос, выполните следующие команды в PowerShell или интерфейсе командной строки.

### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Отправка запроса:

```powershell
Register-AzProviderFeature -FeatureName DLM -ProviderNamespace Microsoft.Storage 
```
Состояние утверждения для регистрации можно проверить, выполнив следующую команду:
```powershell
Get-AzProviderFeature -FeatureName DLM -ProviderNamespace Microsoft.Storage
```
После утверждения и правильной регистрации вы получите состояние *Зарегистрировано* при отправке описанных выше запросов.

### <a name="azure-cli"></a>Инфраструктура CLI Azure

Отправка запроса: 
```cli
az feature register --namespace Microsoft.Storage --name DLM
```
Состояние утверждения для регистрации можно проверить, выполнив следующую команду:
```cli
az feature show --namespace Microsoft.Storage --name DLM
```
После утверждения и правильной регистрации вы получите состояние *Зарегистрировано* при отправке описанных выше запросов.


## <a name="add-or-remove-a-policy"></a>Добавление или удаление политики 

Вы можете добавлять, изменять и (или) удалять политики с помощью портала Azure, [PowerShell](https://www.powershellgallery.com/packages/Az.Storage), [Azure CLI](https://docs.microsoft.com/cli/azure/ext/storage-preview/storage/account/management-policy?view=azure-cli-latest#ext-storage-preview-az-storage-account-management-policy-create), [REST API](https://docs.microsoft.com/rest/api/storagerp/managementpolicies/createorupdate) или клиентских средств на следующих языках: [.NET](https://www.nuget.org/packages/Microsoft.Azure.Management.Storage/8.0.0-preview), [Python](https://pypi.org/project/azure-mgmt-storage/2.0.0rc3/), [Node.js]( https://www.npmjs.com/package/azure-arm-storage/v/5.0.0), [Ruby](https://rubygems.org/gems/azure_mgmt_storage/versions/0.16.2). 

### <a name="azure-portal"></a>Портал Azure

1. Войдите на [портале Azure](https://portal.azure.com).

2. Выберите **Все ресурсы** и щелкните нужную учетную запись хранения.

3. Щелкните **Управление жизненным циклом (предварительная версия)** в узле службы BLOB-объектов, чтобы просмотреть или изменить политику.

### <a name="powershell"></a>PowerShell

```powershell
$rules = '{ ... }' 

Set-AzStorageAccountManagementPolicy -ResourceGroupName [resourceGroupName] -StorageAccountName [storageAccountName] -Policy $rules 

Get-AzStorageAccountManagementPolicy -ResourceGroupName [resourceGroupName] -StorageAccountName [storageAccountName]
```

### <a name="azure-cli"></a>Инфраструктура CLI Azure

```
az account set --subscription "[subscriptionName]”
az extension add --name storage-preview
az storage account management-policy show --resource-group [resourceGroupName] --account-name [accountName]
```

> [!NOTE]
Если вы настроили для учетной записи хранения правила брандмауэра, запросы на управление жизненным циклом могут быть заблокированы. Их можно разблокировать, настроив исключения. Дополнительные сведения см. в разделе об исключениях в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions).

## <a name="policy"></a>Политика

Политика управления жизненным циклом представляет собой набор правил, оформленный в виде документа JSON.

```json
{
  "version": "0.5",
  "rules": [
    {
      "name": "rule1",
      "type": "Lifecycle",
      "definition": {...}
    },
    {
      "name": "rule2",
      "type": "Lifecycle",
      "definition": {...}
    }
  ]
}
```


Для политики обязательно задайте два параметра.

| Имя параметра | Тип параметра | Примечания |
|----------------|----------------|-------|
| версия        | Строка, выраженная в виде `x.x` | Предварительная версия выпущена с номером 0.5 |
| правила          | Массив объектов правил | Для каждой политики должно существовать хотя бы одно правило. В режиме предварительного просмотра для каждой политики можно указать до четырех правил. |

Для каждого правила в политике требуется задать три параметра.

| Имя параметра | Тип параметра | Примечания |
|----------------|----------------|-------|
| ИМЯ           | Строка | Имя правила может содержать любое сочетание буквенно-цифровых символов. В именах правил учитывается регистр. Имя должно быть уникальным в пределах политики. |
| Тип           | Значение перечисления | В предварительной версии допускается значение `Lifecycle`. |
| Определение     | Объект, который определяет правило жизненного цикла | Каждое определение состоит из набора фильтров и набора действий. |

## <a name="rules"></a>Правила

Каждое определение правила состоит из набора фильтров и набора действий. [Набор фильтров](#rule-filters) ограничивает действие правила определенным набором объектов в контейнере или имен объектов. [Набор операций](#rule-actions) вводит в действие уровень или удаляет действия в отфильтрованном наборе объектов.

### <a name="sample-rule"></a>Пример правила
Следующий пример правила фильтрует учетную запись так, чтобы она выполняла действия только на `container1/foo`. Для всех объектов, которые существуют внутри `container1` **и** имена которых начинаются с `foo`, выполняются следующие действия: 

- установить для BLOB-объекта холодный уровень доступа через 30 дней после последнего изменения;
- установить для BLOB-объекта архивный уровень доступа через 90 дней после последнего изменения;
- удалить BLOB-объект спустя 2555 дней (7 лет) после последнего изменения;
- удалить моментальный снимок BLOB-объекта через 90 дней после создания моментального снимка.

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "ruleFoo", 
      "type": "Lifecycle", 
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 },
            "delete": { "daysAfterModificationGreaterThan": 2555 }
          },
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}

```

### <a name="rule-filters"></a>Фильтры правила

Фильтры ограничивают действие правила определенным подмножеством BLOB-объектов в учетной записи хранения. Если определено несколько фильтров, для всех фильтров применяется логическая операция `AND`.

В период предварительной версии поддерживаются следующие фильтры.

| Имя фильтра | Тип фильтра | Примечания | Обязательный |
|-------------|-------------|-------|-------------|
| blobTypes   | Массив предустановленных значений перечисления. | В режиме предварительной версии поддерживается только `blockBlob`. | Yes |
| prefixMatch | Массив строк, по которым выполняется сопоставление префиксов. Строка префикса должно начинаться с имени контейнера. Например, если вы хотите применить правило ко всем большим двоичным объектам в разделе "https://myaccount.blob.core.windows.net/container1/foo/...", укажите для prefixMatch значение `container1/foo`. | Если параметр prefixMatch не определен, то правила применяются для всех BLOB-объектов в учетной записи. | Нет  |

### <a name="rule-actions"></a>Действия правила

Действия применяются к BLOB-объектам, для которых выполняются все условия фильтров выполнения.

В режиме предварительной версии управление жизненным циклом поддерживает изменение уровня доступа и удаление BLOB-объектов и удаление моментальных снимков BLOB-объектов. Определите в каждом правиле хотя бы одно действие для BLOB-объектов или моментальных снимков BLOB-объектов.

| Действие        | Базовый BLOB-объект                                   | Снимок      |
|---------------|---------------------------------------------|---------------|
| tierToCool    | Поддержка BLOB-объектов, размещенных на горячем уровне доступа         | Не поддерживается |
| tierToArchive | Поддержка BLOB-объектов, размещенных на горячем или холодном уровне доступа | Не поддерживается |
| удалить        | Поддерживаются                                   | Поддерживаются     |

>[!NOTE] 
Если для одного BLOB-объекта определено более одного действия, управление жизненным циклом применяет к нему более дешевое из этих действий. Например, действие `delete` дешевле, чем действие `tierToArchive`; а действие `tierToArchive` дешевле, чем действие `tierToCool`.

В режиме предварительного просмотра все условия выполнения действий основываются на возрасте объекта. Возраст для базового BLOB-объекта определяется по времени последнего изменения, а для моментального снимка BLOB-объекта — по времени создания.

| Условие выполнения действия | Значение условия | ОПИСАНИЕ |
|----------------------------|-----------------|-------------|
| daysAfterModificationGreaterThan | Целочисленное значение, указывающее возраст в днях | Допустимое условие для действий с базовым BLOB-объектом |
| daysAfterCreationGreaterThan     | Целочисленное значение, указывающее возраст в днях | Допустимое условие для действий с моментальным снимком BLOB-объекта | 

## <a name="examples"></a>Примеры
Следующие примеры демонстрируют несколько типичных сценариев для правил политики жизненного цикла.

### <a name="move-aging-data-to-a-cooler-tier"></a>Перемещение старых данных на более холодный уровень

В следующем примере показано перемещение блочных BLOB-объектов с префиксом имени `container1/foo` или `container2/bar`. Эта политика перемещает BLOB-объекты, которые не изменялись более 30 дней, на холодный уровень, а которые не изменялись в течение 90 дней — на архивный уровень:

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "agingRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ],
            "prefixMatch": [ "container1/foo", "container2/bar" ]
          },
          "actions": {
            "baseBlob": {
              "tierToCool": { "daysAfterModificationGreaterThan": 30 },
              "tierToArchive": { "daysAfterModificationGreaterThan": 90 }
            }
          }
        }      
    }
  ]
}
```

### <a name="archive-data-at-ingest"></a>Архивация данных при поступлении 

Некоторые данные хранятся в облаке почти без использования. Такие данные лучше помещать на архивный уровень сразу же после приема. Следующая политика жизненного цикла настроена так, чтобы архивировать данные при приеме. Этот пример перемещает поступающие в учетную запись BLOB-объекты в пределах контейнера `archivecontainer` сразу на архивный уровень доступа. Для немедленного перемещения настраиваются действия, которые применяются к BLOB-объектов возрастом 0 дней после последнего изменения:

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "archiveRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ],
            "prefixMatch": [ "archivecontainer" ]
          },
          "actions": {
            "baseBlob": { 
                "tierToArchive": { "daysAfterModificationGreaterThan": 0 }
            }
          }
        }      
    }
  ]
}

```

### <a name="expire-data-based-on-age"></a>Устаревание данных на основе возраста

Некоторые данные нужно удалять через определенное число дней или месяцев после их создания, чтобы снизить затраты на хранение или выполнить требования законодательства. Вы можете настроить политику управления жизненным циклом, чтобы удалять устаревшие данные при достижении определенного возраста. В следующем примере представлена политика, которая удаляет все BLOB-объекты (префикс не указан) старше 365 дней.

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "expirationRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ]
          },
          "actions": {
            "baseBlob": {
              "delete": { "daysAfterModificationGreaterThan": 365 }
            }
          }
        }      
    }
  ]
}
```

### <a name="delete-old-snapshots"></a>Удаление старых моментальных снимков

Для данных, которые часто изменяются и используются на протяжении их существования, часто используются моментальные снимки для отслеживания ранних версий данных. Вы можете создать политику, которая удаляет старые моментальные снимки при достижении определенного возраста. Возраст моментального снимка определяется от момента создания моментального снимка. Это правило политики удаляет моментальные снимки BLOB-объектов в пределах контейнера `activedata`, с момента создания которых прошло 90 или более дней.

```json
{
  "version": "0.5",
  "rules": [ 
    {
      "name": "snapshotRule", 
      "type": "Lifecycle", 
      "definition": 
        {
          "filters": {
            "blobTypes": [ "blockBlob" ],
            "prefixMatch": [ "activedata" ]
          },
          "actions": {            
            "snapshot": {
              "delete": { "daysAfterCreationGreaterThan": 90 }
            }
          }
        }      
    }
  ]
}
```
## <a name="faq---i-created-a-new-policy-why-are-the-actions-not-run-immediately"></a>Вопрос. Мною создана политика, но указанные действия не выполняются немедленно. Почему? 

Платформа выполняет политики жизненного цикла один раз в день. После настройки новой политики запуск и выполнение некоторых действий (например, распределения по уровням и удаления) может занять до 24 часов.  

## <a name="next-steps"></a>Дополнительная информация

Узнайте, как восстанавливать данные после случайного удаления:

- [Обратимое удаление больших двоичных объектов службы хранилища Azure](../blobs/storage-blob-soft-delete.md)
