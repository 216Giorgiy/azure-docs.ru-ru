<properties 
	pageTitle="Создание моментального снимка большого двоичного объекта" 
	description="Практическое руководство по созданию моментальных снимков больших двоичных объектов хранилища Azure" 
	services="storage" 
	documentationCenter="" 
	authors="tamram" 
	manager="adinah" 
	editor=""/>

<tags 
	ms.service="storage" 
	ms.workload="storage" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/27/2015" 
	ms.author="tamram"/>

# Создание моментального снимка BLOB-объекта

## Обзор

Моментальный снимок — это версия BLOB-объекта только для чтения, сделанная в определенный момент времени. Моментальные снимки полезны для архивации BLOB-объектов. После создания моментального снимка его можно прочитать, скопировать или удалить, но вы не можете изменять его.

Моментальный снимок большого двоичного объекта имеет то же имя, что и базовый большой двоичный объект, с добавленным значением **DateTime**, указывающим время моментального снимка. Например, если URI страничного BLOB-объекта является `http://storagesample.core.blob.windows.net/mydrives/myvhd`, URI снимка будет аналогичен `http://storagesample.core.blob.windows.net/mydrives/myvhd?snapshot=2011-03-09T01:42:34.9360000Z`. Всем моментальным снимкам BLOB-объекта присваивается его URI. Снимки отличаются только добавленными значениями **DateTime**.

Большой двоичный объект может иметь любое количество моментальных снимков. Моментальные снимки хранятся до тех пор, пока не будут явно удалены. Обратите внимание, что при удалении исходного BLOB-объекта моментальный снимок будет также удален. Чтобы отследить текущие моментальные снимки, можно перечислить моментальные снимки, связанные с большим двоичным объектом.

При создании моментального снимка BLOB-объекта его системные свойства и их значения копируются в снимок.

Свойства аренды, связанные с базовым BLOB-объектом, не влияют на моментальный снимок. Вы не можете получить аренду в моментальном снимке.

## Копирование моментальных снимков 

Операции копирования больших двоичных объектов и моментальных снимков подчиняются следующим правилам.

- Можно скопировать моментальный снимок и заменить им исходный большой двоичный объект. Повысив уровень моментального снимка до базового большого двоичного объекта, можно восстановить более раннюю версию большого двоичного объекта. Моментальный снимок остается, но базовый BLOB-объект перезаписывается с помощью копии моментального снимка, допускающей запись.

- Можно скопировать моментальный снимок в целевой большой двоичный объект с другим именем. Полученный целевой BLOB-объект не станет моментальным снимком, а будет BLOB-объектом, доступным для записи.

- Если копируется исходный большой двоичный объект, его моментальные снимки не копируются. Если целевой BLOB-объект перезаписывается копией, это не влияет на связанные с ним во время записи моментальные снимки.

- При создании моментального снимка блочного BLOB-объекта в снимок также копируется его список зафиксированных блоков. Незафиксированные блоки не копируются.

## Назначение условий доступа 

Можно указать условие доступа, чтобы моментальный снимок создавался только в том случае, если данное условие выполняется. Чтобы это сделать, воспользуйтесь свойством AccessCondition. При невыполнении этого условия моментальный снимок не будет создан, а служба BLOB-объектов вернет код состояния HTTPStatusCode.PreconditionFailed.

## Удаление моментальных снимков 

Большой двоичный объект с моментальными снимками нельзя удалить, пока не удалены все его снимки. Можно удалить моментальные снимки по отдельности или воспользоваться функцией службы хранилища и удалить все снимки одновременно с исходным большим двоичным объектом. Если вы попытаетесь удалить большой двоичный объект, у которого все еще есть моментальные снимки, появится ошибка.

## Моментальные снимки и хранилище Premium
Использование моментальных снимков с помощью хранилища Premium подчиняется следующим правилам.

- Учетная запись хранения Premium поддерживает до 100 моментальных снимков на каждый страничный BLOB-объект. При превышении этого предела операция Snapshot Blob возвращает код ошибки 409 (**SnapshotCountExceeded**).

- При использовании учетной записи хранения Premium каждые десять минут можно создать один моментальный снимок страничного BLOB-объекта. При превышении этого значения операция Snapshot Blob возвращает код ошибки 409 (**SnaphotOperationRateExceeded**).

- При использовании учетной записи хранения Premium чтение моментальных снимков страничного BLOB-объекта с помощью операции Get Blob не поддерживается. Вызов Get Blob для моментального снимка в учетной записи хранения класса Premium возвращает код ошибки 400 (**InvalidOperation**). Однако для моментальных снимков поддерживаются операции Get Blob Properties и Get Blob Metadata.

- Для чтения моментального снимка вы можете воспользоваться операцией Copy Blob, чтобы скопировать его в другой страничный BLOB-объект в пределах учетной записи. При этом в целевом большом двоичном объекте, выбранном для копирования, не должно быть других моментальных снимков. Если у целевого BLOB-объекта есть моментальные снимки, операция Copy Blob возвращает код ошибки 409 (**SnapshotsPresent**).

## Возвращается абсолютный URI для моментального снимка 

Данный пример кода C# создает новый моментальный снимок и записывает абсолютный URI для первичного расположения.

    //Create the blob service client object.
    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting("StorageConnectionString"));
    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();
    
    //Get a reference to a container.
    CloudBlobContainer container = blobClient.GetContainerReference("sample-container");
    container.CreateIfNotExists();

    //Get a reference to a blob.
    CloudBlockBlob blob = container.GetBlockBlobReference("sampleblob.txt");
    blob.UploadText("This is a blob.");

    //Create a snapshot of the blob and write out its primary URI.
    CloudBlockBlob blobSnapshot = blob.CreateSnapshot();
    Console.WriteLine(blobSnapshot.SnapshotQualifiedStorageUri.PrimaryUri);

## Общая информация о том, как моментальные снимки увеличивают плату

Создание моментальных снимков, представляющих собой копии больших двоичных объектов с доступом только для чтения, может привести к дополнительной плате за хранение данных в вашей учетной записи. При проектировании приложения важно учитывать, как эта плата может накапливаться, чтобы минимизировать ненужные затраты.

### Важные вопросы о выставлении счетов

Следующий список включает ключевые пункты, которые следует рассмотреть при создании моментального снимка.

- Плата взимается за уникальные блоки и страницы независимо от того, где они находятся: в большом двоичном объекте или в моментальном снимке. Ваша учетная запись не влечет за собой дополнительных затрат на моментальные снимки, связанные с большим двоичным объектом, пока большой двоичный объект, на котором они основаны, не будет обновлен. После обновления базового большого двоичного объекта он расходится со своими моментальными снимками и вам придется оплачивать уникальные блоки и страницы в каждом большом двоичном объекте или моментальном снимке.

- Когда вы заменяете блок в блочном большом двоичном объекте, за этот блок начинает взиматься плата как за уникальный. Это произойдет, даже если у блока тот же идентификатор блока и те же данные, что и в моментальном снимке. Как только блок фиксируется заново, он расходится со всеми своими дубликатами во всех моментальных снимках и вы будете оплачивать его данные. Это же происходит и для страницы в страничном большом двоичном объекте, обновляемом идентичными данными.

- Замещение блочного большого двоичного объекта путем вызова метода UploadFile, UploadText, UploadStream или UploadByteArray заменяет все блоки в этом большом двоичном объекте. При наличии моментального снимка, связанного с этим большим двоичным объектом, все блоки в базовом большом двоичном объекте и моментальном снимке разойдутся и вы будете оплачивать ресурсы всех блоков в обоих больших двоичных объектах. Это произойдет, даже если данные базового большого двоичного объекта и моментального снимка останутся идентичными.

- В службе BLOB-объектов Azure нет средств, позволяющих определить, содержат ли два блока идентичные данные. Каждый блок, который был загружен и зафиксирован, обрабатывается как уникальный, даже если он содержит те же данные и имеет тот же идентификатор блока. Так как плата добавляется за уникальные блоки, важно иметь в виду, что обновление большого двоичного объекта, содержащего моментальные снимки, приведет к появлению дополнительных уникальных блоков и дополнительным расходам.

> [AZURE.NOTE]Рекомендуется управлять моментальными снимками осторожно, чтобы избежать наценок. Мы советуем управлять моментальными снимками следующим образом.

> - Удаляйте и повторно создавайте моментальные снимки, связанные с большим двоичным объектом, при обновлении этого объекта, даже если вы обновляете его идентичными данными, если только структура вашего приложения не требует сохранения моментальных снимков. За счет удаления и повторного создания моментальных снимков больших двоичных объектов можно исключить расхождение большого двоичного объекта с моментальными снимками.

> - Если необходимо хранить моментальные снимки для больших двоичных объектов, старайтесь не вызывать UploadFile, UploadText, UploadStream или UploadByteArray, чтобы обновить большой двоичный объект, так как эти методы заменяют все блоки в большом двоичном объекте. Вместо этого обновляйте наименьшее возможное количество блоков с помощью методов PutBlock и PutBlockList.


### Сценарии выставления счетов за моментальные снимки


В следующих сценариях показано, как добавляется плата за большой двоичный объект и его моментальные снимки.

В сценарии 1 базовый большой двоичный объект не обновлялся с момента создания моментального снимка, поэтому плата начисляется только за уникальные блоки 1, 2 и 3.

![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-1.png)

В сценарии 2 базовый большой двоичный объект был обновлен, а моментальный снимок — нет. Блок 3 был обновлен, и, хотя он содержит такие же данные и тот же идентификатор, он отличается от блока 3 в моментальном снимке. В результате плата в учетной записи взимается за четыре блока.

![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-2.png)

В сценарии 3 базовый большой двоичный объект изменился, а моментальный снимок — нет. Блок 3 был заменен блоком 4 в базовом большом двоичном объекте, но моментальный снимок по-прежнему отражает блок 3. В результате плата в учетной записи взимается за четыре блока.
 
![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-3.png)

В сценарии 4 базовый большой двоичный объект был полностью обновлен и не содержит никаких первоначальных блоков. В результате плата в учетной записи взимается за все восемь уникальных блоков. Этот сценарий может произойти при использовании такого методов обновления, как UploadFile, UploadText, UploadFromStream или UploadByteArray, так как эти методы заменяют все содержимое больших двоичных объектов.

![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-4.png)

<!---HONumber=July15_HO1-->