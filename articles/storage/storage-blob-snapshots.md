<properties
	pageTitle="Создание моментального снимка большого двоичного объекта только для чтения | Microsoft Azure"
	description="Узнайте, как создать моментальный снимок большого двоичного объекта для резервного копирования данных BLOB-объектов в конкретный момент времени. Узнайте, как выставляются счета за моментальные снимки и как их можно использовать для сокращения расходов емкости."
	services="storage"
	documentationCenter=""
	authors="tamram"
	manager="carmonm"
	editor="tysonn"/>

<tags
	ms.service="storage"
	ms.workload="storage"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/07/2016"
	ms.author="tamram"/>

# Создание моментального снимка BLOB-объекта

## Обзор

Моментальный снимок — это версия BLOB-объекта только для чтения, сделанная в определенный момент времени. Моментальные снимки полезны для архивации BLOB-объектов. После создания моментального снимка его можно прочитать, скопировать или удалить, но вы не можете изменять его.

Моментальный снимок большого двоичного объекта идентичен объекту, на основе которого он создан. Единственное исключение: к URI большого двоичного объекта добавляется значение **DateTime**, которое указывает время создания снимка. Например, если страничный BLOB-объект имеет URI `http://storagesample.core.blob.windows.net/mydrives/myvhd`, то URI снимка будет иметь такой вид: `http://storagesample.core.blob.windows.net/mydrives/myvhd?snapshot=2011-03-09T01:42:34.9360000Z`.

> [AZURE.NOTE] Все моментальные снимки имеют одинаковый URI базового большого двоичного объекта. Большой двоичный объект и его моментальный снимок отличаются только добавлением значения **DateTime**.

Большой двоичный объект может иметь любое количество моментальных снимков. Моментальные снимки хранятся до тех пор, пока не будут явно удалены. При удалении исходного BLOB-объекта моментальный снимок будет также удален. Чтобы было удобнее контролировать моментальные снимки большого двоичного объекта, их можно пронумеровать.

При создании моментального снимка BLOB-объекта его системные свойства и их значения копируются в снимок. Метаданные базового большого двоичного объекта также копируются в моментальный снимок, если при его создании не были указаны отдельные метаданные для снимка.

Свойства аренды, связанные с базовым BLOB-объектом, не влияют на моментальный снимок. Вы не можете получить аренду в моментальном снимке.

## Создание моментального снимка

В следующем примере кода показано создание моментального снимка в .NET. В этом примере мы указываем отдельные метаданные для моментального снимка при его создании.

    private static async Task CreateBlockBlobSnapshot(CloudBlobContainer container)
    {
        // Create a new block blob in the container.
        CloudBlockBlob baseBlob = container.GetBlockBlobReference("sample-base-blob.txt");

        // Add blob metadata.
        baseBlob.Metadata.Add("ApproxBlobCreatedDate", DateTime.UtcNow.ToString());

        try
        {
            // Upload the blob to create it, with its metadata.
            await baseBlob.UploadTextAsync(string.Format("Base blob: {0}", baseBlob.Uri.ToString()));

            // Sleep 5 seconds.
            System.Threading.Thread.Sleep(5000);

            // Create a snapshot of the base blob.
            // Specify metadata at the time that the snapshot is created to specify unique metadata for the snapshot.
            // If no metadata is specified when the snapshot is created, the base blob's metadata is copied to the snapshot.
            Dictionary<string, string> metadata = new Dictionary<string, string>();
            metadata.Add("ApproxSnapshotCreatedDate", DateTime.UtcNow.ToString());
            await baseBlob.CreateSnapshotAsync(metadata, null, null, null);
        }
        catch (StorageException e)
        {
            Console.WriteLine(e.Message);
            Console.ReadLine();
            throw;
        }
    }
 

## Копирование моментальных снимков

Операции копирования больших двоичных объектов и моментальных снимков подчиняются следующим правилам.

- Можно скопировать моментальный снимок и заменить им исходный большой двоичный объект. Повысив уровень моментального снимка до базового большого двоичного объекта, можно восстановить более раннюю версию большого двоичного объекта. Моментальный снимок остается, но базовый BLOB-объект перезаписывается с помощью копии моментального снимка, допускающей запись.

- Можно скопировать моментальный снимок в целевой большой двоичный объект с другим именем. Полученный целевой BLOB-объект не станет моментальным снимком, а будет BLOB-объектом, доступным для записи.

- Если копируется исходный большой двоичный объект, его моментальные снимки не копируются. Если большой двоичный объект восстанавливается из его копии, это не влияет на связанные с ним моментальные снимки.

- При создании моментального снимка блочного BLOB-объекта в снимок также копируется его список зафиксированных блоков. Незафиксированные блоки не копируются.

## Назначение условий доступа

Можно указать условие доступа, чтобы моментальный снимок создавался только в том случае, если данное условие выполняется. Чтобы это сделать, воспользуйтесь свойством **AccessCondition**. При невыполнении этого условия моментальный снимок не будет создан, а служба BLOB-объектов вернет код состояния HTTPStatusCode.PreconditionFailed.

## Удаление моментальных снимков

Большой двоичный объект с моментальными снимками нельзя удалить, пока не будут удалены все его снимки. Можно удалить моментальный снимок отдельно или указать, чтобы при удалении исходного большого двоичного объекта были удалены и все его моментальные снимки. Попытка удалить большой двоичный объект, у которого еще есть моментальные снимки, завершится ошибкой.

В следующем коде показан пример удаления большого двоичного объекта и его моментальных снимков в .NET, где `blockBlob` является переменной типа **CloudBlockBlob**:

	await blockBlob.DeleteIfExistsAsync(DeleteSnapshotsOption.IncludeSnapshots, null, null, null);

## Моментальные снимки и хранилище Azure Premium

Использование моментальных снимков с помощью хранилища Premium подчиняется следующим правилам.

- Учетная запись хранения класса Premium поддерживает до 100 моментальных снимков на каждый страничный BLOB-объект. При превышении этого предела операция Snapshot Blob возвращает код ошибки 409 (**SnapshotCountExceeded**).

- При использовании учетной записи хранения класса Premium каждые десять минут можно создавать один моментальный снимок страничного BLOB-объекта. При превышении этого значения операция Snapshot Blob возвращает код ошибки 409 (**SnaphotOperationRateExceeded**).

- При использовании учетной записи хранения класса Premium чтение моментальных снимков страничного BLOB-объекта с помощью операции Get Blob не поддерживается. Вызов Get Blob для моментального снимка в учетной записи хранения класса Premium возвращает код ошибки 400 (**InvalidOperation**). Однако в учетной записи хранения класса Premium для моментального снимка можно вызывать операции Get Blob Properties и Get Blob Metadata.

- Для чтения моментального снимка вы можете воспользоваться операцией Copy Blob, чтобы скопировать его в другой страничный BLOB-объект в пределах учетной записи. При этом в целевом большом двоичном объекте, выбранном для копирования, не должно быть других моментальных снимков. Если у целевого большого двоичного объекта есть моментальные снимки, операция Copy Blob возвращает код ошибки 409 (**SnapshotsPresent**).

## Возврат абсолютного URI для моментального снимка

Этот пример кода C# создает новый моментальный снимок и записывает абсолютный URI для первичного расположения.

    //Create the blob service client object.
    const string ConnectionString = "DefaultEndpointsProtocol=https;AccountName=account-name;AccountKey=account-key";

    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(ConnectionString);
    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();

    //Get a reference to a container.
    CloudBlobContainer container = blobClient.GetContainerReference("sample-container");
    container.CreateIfNotExists();

    //Get a reference to a blob.
    CloudBlockBlob blob = container.GetBlockBlobReference("sampleblob.txt");
    blob.UploadText("This is a blob.");

    //Create a snapshot of the blob and write out its primary URI.
    CloudBlockBlob blobSnapshot = blob.CreateSnapshot();
    Console.WriteLine(blobSnapshot.SnapshotQualifiedStorageUri.PrimaryUri);

## Общая информация о том, как моментальные снимки увеличивают плату

Создание моментальных снимков, представляющих собой копии больших двоичных объектов с доступом только для чтения, может привести к дополнительной плате за хранение данных в вашей учетной записи. При проектировании приложения важно учитывать, как эта плата может накапливаться, чтобы минимизировать ненужные затраты.

### Важные вопросы о выставлении счетов

Следующий список включает ключевые пункты, которые следует рассмотреть при создании моментального снимка.

- Плата взимается за уникальные блоки и страницы независимо от того, где они находятся: в большом двоичном объекте или в моментальном снимке. Ваша учетная запись не влечет за собой дополнительных затрат на моментальные снимки, связанные с большим двоичным объектом, пока большой двоичный объект, на котором они основаны, не будет обновлен. После изменения базового большого двоичного объекта он начнет отличаться от своих моментальных снимков. Теперь вы будете оплачивать все уникальные блоки и страницы в каждом большом двоичном объекте или моментальном снимке.

- Когда вы заменяете блок в блочном большом двоичном объекте, за этот блок начинает взиматься плата как за уникальный. Это произойдет, даже если у блока тот же идентификатор блока и те же данные, что и в моментальном снимке. Как только блок фиксируется заново, он расходится со всеми своими дубликатами во всех моментальных снимках и вы будете оплачивать его данные. Это же происходит и для страницы в страничном большом двоичном объекте, обновляемом идентичными данными.

- Замещение блочного BLOB-объекта путем вызова метода **UploadFile**, **UploadText**, **UploadStream** или **UploadByteArray** заменяет все блоки в этом большом двоичном объекте. Если с этим большим двоичным объектом связаны моментальные снимки, все блоки в базовом большом двоичном объекте перестанут совпадать с блоками в моментальном снимке, и вы будете оплачивать хранение всех блоков в обоих больших двоичных объектах. Это произойдет, даже если данные базового большого двоичного объекта и моментального снимка останутся идентичными.

- В службе BLOB-объектов Azure нет средств, позволяющих определить, содержат ли два блока идентичные данные. Каждый блок, который был загружен и зафиксирован, обрабатывается как уникальный, даже если он содержит те же данные и имеет тот же идентификатор блока. Так как плата добавляется за уникальные блоки, важно иметь в виду, что обновление большого двоичного объекта, содержащего моментальные снимки, приведет к появлению дополнительных уникальных блоков и дополнительным расходам.

> [AZURE.NOTE] Рекомендуется управлять моментальными снимками осторожно, чтобы избежать наценок. Мы рекомендуем управлять моментальными снимками описанным образом.

> - Удаляйте и повторно создавайте моментальные снимки, связанные с большим двоичным объектом, при обновлении этого объекта, даже если вы обновляете его идентичными данными, если только структура вашего приложения не требует сохранения моментальных снимков. За счет удаления и повторного создания моментальных снимков больших двоичных объектов можно исключить расхождение большого двоичного объекта с моментальными снимками.

> - Если необходимо хранить моментальные снимки для больших двоичных объектов, не вызывайте для их обновления методы **UploadFile**, **UploadText**, **UploadStream** или **UploadByteArray**. Эти методы заменяют все блоки в большом двоичном объекте, и после этого базовый большой двоичный объект начинает значительно отличаться от своих моментальных снимков. Вместо этого обновляйте наименьшее возможное количество блоков с помощью методов **PutBlock** и **PutBlockList**.


### Сценарии выставления счетов за моментальные снимки


В следующих сценариях показано, как добавляется плата за большой двоичный объект и его моментальные снимки.

В сценарии 1 базовый большой двоичный объект создания моментального снимка не обновлялся, поэтому плата начисляется только за уникальные блоки 1, 2 и 3.

![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-1.png)

В сценарии 2 базовый большой двоичный объект изменился, а моментальный снимок — нет. Блок 3 был обновлен, и, хотя он содержит такие же данные и тот же идентификатор, он отличается от блока 3 в моментальном снимке. В результате плата в учетной записи взимается за четыре блока.

![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-2.png)

В сценарии 3 базовый большой двоичный объект изменился, а моментальный снимок — нет. Блок 3 был заменен блоком 4 в базовом большом двоичном объекте, но моментальный снимок по-прежнему отражает блок 3. В результате плата в учетной записи взимается за четыре блока.

![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-3.png)

В сценарии 4 базовый большой двоичный объект был полностью обновлен и не содержит никаких первоначальных блоков. В результате плата в учетной записи взимается за все восемь уникальных блоков. Этот сценарий может произойти при использовании такого методов обновления, как **UploadFile**, **UploadText**, **UploadFromStream** или **UploadByteArray**, так как эти методы заменяют все содержимое больших двоичных объектов.

![Ресурсы хранилища Azure](./media/storage-blob-snapshots/storage-blob-snapshots-billing-scenario-4.png)

## Дальнейшие действия

Дополнительные примеры использования хранилища BLOB-объектов см. на странице с [примерами кода Azure](https://azure.microsoft.com/documentation/samples/?service=storage&term=blob). Вы можете скачать пример приложения и запустить его или просмотреть код на GitHub.

<!---HONumber=AcomDC_0914_2016-->