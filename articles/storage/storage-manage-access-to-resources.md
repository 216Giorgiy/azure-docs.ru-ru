<properties 
	pageTitle="Управление доступом к ресурсам хранилища Azure" 
	description="Информация о различных способах управления доступом к ресурсам службы хранилища Azure." 
	services="storage" 
	documentationCenter="" 
	authors="micurd,tamram" 
	manager="jahogg" 
	editor=""/>

<tags 
	ms.service="storage" 
	ms.workload="storage" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="02/20/2015" 
	ms.author="micurd"/>

# Управление доступом к ресурсам хранилища Azure

## Обзор

По умолчанию только владелец учетной записи хранения может обращаться к большим двоичным объектам, таблицам и очередям в пределах этой учетной записи. Если вашей службе или приложению нужно сделать эти ресурсы доступными другим клиентам без совместного использования ключа доступа, вы можете воспользоваться следующими вариантами предоставления доступа.

- Можно задать такие разрешения контейнера, которые предоставляют анонимный доступ для чтения контейнера и его больших двоичных объектов. Такие разрешения нельзя задать для таблиц и очередей.

- Можно предоставить доступ к ресурсу с помощью подписанного URL-адреса, что позволяет делегировать ограниченный доступ к ресурсам контейнера, большего двоичного объекта, таблицы или очереди, указав интервал, во время которого будут доступны ресурсы, и разрешения, которые получает для них клиент на время этого интервала.

- Можно управлять подписанными URL-адресами контейнера и его больших двоичных объектов, очередей и таблиц с помощью хранимых политик доступа. Хранимые политики доступа предоставляют дополнительную меру контроля над подписанными URL-адресами, а также средства их отмены.

## Ограничение доступа к контейнерам и BLOB-объектам

По умолчанию контейнер и все большие двоичные объекты внутри него доступны только владельцу учетной записи хранения. Если нужно предоставить анонимным пользователями доступ на их чтение, следует разрешить общий доступ к контейнеру. Анонимные пользователи могут считывать данные большого двоичного объекта из общедоступного контейнера, при этом их запросы не будут проходить аутентификацию.

Доступны следующие возможности управления доступом к контейнеру.

- Полный общий доступ для чтения. Контейнер и данные больших двоичных объектов можно считывать с помощью анонимного запроса. Клиенты могут перечислять BLOB-объекты внутри контейнера с помощью анонимного запроса, но не могут перечислять контейнеры в учетной записи хранения.

- Общий доступ для чтения только больших двоичных объектов. Данные BLOB-объектов в этом контейнере можно считать с помощью анонимного запроса, но данные контейнера недоступны. Клиенты не могут перечислять BLOB-объекты внутри с помощью анонимного запроса.

- Без общего доступа для чтения. Контейнер и данные больших двоичных объектов может считывать только владелец учетной записи.

>[AZURE.NOTE]Если вашей службе требуется более точный контроль над большими двоичными объектами или если нужно предоставить разрешения для других операций, помимо операции чтения, можно использовать подписанный URL-адрес, чтобы сделать ресурс доступным для пользователей. 

### Функции, доступные анонимным пользователям
В следующей таблице приведены операции, которые могут быть вызваны анонимными пользователями, если в списке управления доступом к контейнеру разрешен общий доступ.

| Операция REST                                         | Разрешение с полным общим доступом для чтения | Разрешение с общим доступом для чтения только для BLOB-объектов |
|--------------------------------------------------------|-----------------------------------------|---------------------------------------------------|
| List Containers                                        | Только владелец                              | Только владелец                                        |
| Create Container                                       | Только владелец                              | Только владелец                                        |
| Get Container Properties                               | Все                                     | Только владелец                                        |
| Get Container Metadata                                 | Все                                     | Только владелец                                        |
| Set Container Metadata                                 | Только владелец                              | Только владелец                                        |
| Get Container ACL                                      | Только владелец                              | Только владелец                                        |
| Set Container ACL                                      | Только владелец                              | Только владелец                                        |
| Delete Container                                       | Только владелец                              | Только владелец                                        |
| List Blobs                                             | Все                                     | Только владелец                                        |
| Put Blob                                               | Только владелец                              | Только владелец                                        |
| Get Blob                                               | Все                                     | Все                                               |
| Get Blob Properties                                    | Все                                     | Все                                               |
| Set Blob Properties                                    | Только владелец                              | Только владелец                                        |
| Get Blob Metadata                                      | Все                                     | Все                                               |
| Set Blob Metadata                                      | Только владелец                              | Только владелец                                        |
| Put Block                                              | Только владелец                              | Только владелец                                        |
| Get Block List (только зафиксированные блоки)                 | Все                                     | Все                                               |
| Get Block List (только незафиксированные блоки или все блоки) | Только владелец                              | Только владелец                                        |
| Put Block List                                         | Только владелец                              | Только владелец                                        |
| Delete Blob                                            | Только владелец                              | Только владелец                                        |
| Copy Blob                                              | Только владелец                              | Только владелец                                        |
| Snapshot Blob                                          | Только владелец                              | Только владелец                                        |
| Lease Blob                                             | Только владелец                              | Только владелец                                        |
| Put Page                                               | Только владелец                              | Только владелец                                        |
| Get Page Ranges                                        | Все                                     | Все                                                  |

## Создание и использование подписанного URL-адреса
Подписанный URL-адрес - универсальный код ресурса (URI), обеспечивающий ограниченные права доступа к контейнерам, большим двоичным объектам, очередям и таблицам в заданный интервал времени. С помощью этого URL-адреса вы можете разрешить клиенту доступ к ресурсам в вашей учетной записи хранения, не предоставляя ключ своей записи.

>[AZURE.NOTE] Подробный концептуальный обзор подписанных URL-адресов и учебник по их использованию см. в статье [Подписанные URL-адреса](storage-dotnet-shared-access-signature-part-1.md).

Для подписанного URL-адреса поддерживаются следующие операции.

- Чтение и запись содержимого страничных или блочных больших двоичных объектов, списков блоков, свойств и метаданных.

- Удаление, аренда и создание моментальных снимков BLOB-объекта.

- Перечисление BLOB-объектов в контейнере.

- Добавление, извлечение, обновление и удаление сообщений очереди (в клиентской библиотеке хранилища версии 2.0 и более поздней версии).

- Получение метаданных очереди, включая количество сообщений (в клиентской библиотеке хранилища версии 2.0 и более поздней версии).

- Запрос, добавление, обновление, удаление и вставка сущностей таблицы (в клиентской библиотеке хранилища версии 2.0 и более поздней версии).

Параметры запроса URI подписанного URL-адреса включают всю информацию, необходимую для предоставления контролируемого доступа к ресурсу хранилища. Параметры запроса URI указывают интервал времени, в течение которого подписанный URL-адрес является действительным, разрешения, которые он предоставляет, ресурс, который должен быть доступным по нему, и подпись, по которой службы хранилища будут аутентифицировать запрос.

Кроме того, URI подписанного URL-адреса может ссылаться на хранимую политику доступа, которая обеспечивает дополнительный уровень контроля над набором подписей, включая возможность изменять или отменять доступ к ресурсу при необходимости. 

Дополнительные сведения о формате универсального кода ресурса (URI) подписанного URL-адреса см. в разделе [Делегирование доступа с помощью подписанного URL-адреса](https://msdn.microsoft.com/library/ee395415.aspx).

### Безопасное использование подписанных URL-адресов
Подписанный URL-адрес предоставляет доступ к ресурсу согласно разрешениям, предоставляемым URI. Для создания URI подписанного URL-адреса следует использовать протокол HTTPS. Использование протокола HTTP с подписанными URL-адресами может сделать вашу учетную запись хранения уязвимой к атакам злоумышленников.

Если подписанный URL-адрес должен предоставлять доступ, не предназначенный для широкой публики, его следует создать с наименьшим количеством разрешений. Кроме того, подписанный URL-адрес необходимо предоставить клиентам по безопасному подключению и связать с хранимой политикой доступа, что позволяет при необходимости отозвать ее. Также должен быть определен наименьший возможный период действия подписи.

>[AZURE.NOTE] URI подписанного URL-адреса связан с ключом учетной записи, который использовался для создания подписи и соответствующей хранимой политики доступа (при наличии таковой). Если хранимая политика доступа не указана, то единственный способ отменить подписанный URL-адрес - изменить ключ учетной записи. 

### Создание подписанного URL-адреса
В следующем примере кода показано создание политики доступа к контейнеру и формирование подписанного URL-адреса для этого контейнера. Этот подписанный URL-адрес можно затем предоставить клиентам:

    // Строка подключения для учетной записи хранения.  Измените ее для своей учетной записи.
    string storageConnectionString =
       DefaultEndpointsProtocol=https; +
       AccountName=myaccount; +
       AccountKey=<account-key>;
    
    // В качестве альтернативы можно вернуть сведения об учетной записи хранения из файла app.config. 
    // Это один из способов хранения и извлечения строки подключения, если вы 
    // создаете приложение, которое будет выполняться локально, а не в Microsoft Azure.
    
    // string storageConnectionString = ConfigurationManager.AppSettings["StorageAccountConnectionString"];
    
    // Создайте учетную запись хранения со строкой подключения.
    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(storageConnectionString);
       
    // Создайте клиентский BLOB-объект.
    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();
    
    // Получите ссылку на контейнер, из которого будет создан подписанный URL-адрес.
    CloudBlobContainer container = blobClient.GetContainerReference(mycontainer);
    container.CreateIfNotExists();
    
    // Создайте разрешения контейнера BLOB-объектов, состоящие из политики общего доступа 
    // и параметра общего доступа. 
    BlobContainerPermissions blobPermissions = new BlobContainerPermissions();
    
    // Политика общего доступа предоставляет 
    // доступ для чтения или записи в контейнер в течение 10 часов.
    blobPermissions.SharedAccessPolicies.Add(mypolicy, new SharedAccessBlobPolicy()
    {
       // Чтобы сразу убедиться в том, что SAS допустим, не задавайте время начала.
       // Таким образом вы избежите сбоев, вызванных незначительной разницей во времени.
       SharedAccessExpiryTime = DateTime.UtcNow.AddHours(10),
       Permissions = SharedAccessBlobPermissions.Write |
      SharedAccessBlobPermissions.Read
    });
    
    // Параметр общего доступа явно указывает, что 
    // контейнер является закрытым, поэтому анонимный доступ к нему запрещен.
    blobPermissions.PublicAccess = BlobContainerPublicAccessType.Off;
    
    // Задайте политику разрешений в контейнере.
    container.SetPermissions(blobPermissions);
    
    // Получите подписанный URL-адрес и поделитесь им с пользователями.
    string sasToken =
       container.GetSharedAccessSignature(new SharedAccessBlobPolicy(), mypolicy);

### Использование подписанного URL-адреса
Клиент, который получает подписанный URL-адрес, может использовать его в своем коде для создания объекта типа [StorageCredentials](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.auth.storagecredentials.aspx). Эти учетные данные можно затем использовать для создания объекта [CloudStorageAccount](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.cloudstorageaccount.aspx) или [CloudBlobClient](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.blob.cloudblobclient.aspx) для работы с ресурсом, как показано в следующем примере:

    Uri blobUri = new Uri(https://myaccount.blob.core.windows.net/mycontainer/myblob.txt);
    
    // Создайте учетные данные с помощью токена SAS. Токен SAS был создан в предыдущем примере.
    StorageCredentials credentials = new StorageCredentials(sasToken);
    
    // Создайте новый BLOB-объект.
    CloudBlockBlob blob = new CloudBlockBlob(blobUri, credentials);
    
    // Отправьте BLOB-объект. 
    // Если BLOB-объект еще не существует, он будет создан. 
    // Если BLOB-объект существует, его содержимое будет перезаписано.
    using (var fileStream = System.IO.File.OpenRead(@"c:\Test\myblob.txt))
    {
    blob.UploadFromStream(fileStream);
    }

## Использование хранимой политики доступа
Хранимая политика доступа предоставляет дополнительный уровень контроля над подписанными URL-адресами на стороне сервера. Задание хранимой политики доступа обеспечивает группирование подписанных URL-адресов и создание дополнительных ограничений для подписей, привязанных к этой политике. С помощью хранимой политики доступа можно изменить время начала, срок действия и разрешения для подписи, а также отменить подпись после ее выдачи.

Хранимая политика доступа предоставляет больший контроль над выданными подписанными URL-адресами. Вместо указания времени существования подписи и разрешений для URL-адреса можно указать эти параметры в политике доступа, хранимой в большом двоичном объекте, контейнере, очереди или таблице, к которым открыт общий доступ. Чтобы изменить эти параметры для одной или нескольких подписей, следует изменить хранимую политику доступа, при этом не нужно перевыпускать подписи. Можно также быстро отозвать подпись, изменив хранимую политику доступа.

Например, предположим, что вы выдали подписанный URL-адрес, который связан с хранимой политикой доступа. Если вы указали время истечения срока действия в хранимой политике доступа, вы можете изменить политику доступа, чтобы продлить срок действия подписи без повторного выпуска новой подписи.

Рекомендуется указывать хранимую политику доступа к каждому подписанному ресурсу, для которого вы выдаете подписанный URL-адрес, так как хранимую политику можно использовать для изменения и отмены подписи после ее выдачи. Если вы не указываете хранимую политику, рекомендуется ограничить время существования подписи для минимизации возможного риска взлома ресурсов вашей учетной записи хранения. 

### Связывание подписанного URL-адреса с хранимой политикой доступа
Хранимая политика доступа включает имя длиной до 64 символов, которое является уникальным в пределах контейнера, очереди или таблицы. Чтобы сопоставить подписанный URL-адрес с хранимой политикой доступа, следует указать этот идентификатор при создании подписанного URL-адреса. Поле  *signedidentifier* в URI подписанного URL-адреса задает идентификатор для хранимой политики доступа.

Контейнер, очередь и таблица могут включать до 5 хранимых политик доступа. Каждая политика может использоваться любым количеством подписанных URL-адресов.

>[AZURE.NOTE]Для ввода в действие хранимой политики доступа в контейнере, очереди или таблице после настройки может потребоваться до 30 секунд. В этот промежуток времени попытка применения подписанного URL-адреса, связанного с хранимой политикой доступа, будет завершаться ошибкой с кодом состояния 403 (запрещено), пока политика доступа не станет активной.

### Задание параметров политики доступа для политики общего доступа
Хранимая политика доступа может определять следующие параметры политики доступа для подписей, с которыми она связана:

- Время начала

- Время окончания срока действия

- Разрешения

В зависимости от требуемого способа управления доступом к ресурсу хранилища вы можете указать все эти параметры в хранимой политике доступа или исключить их из подписанного URL-адреса. Это позволяет изменить поведение связанной подписи в любое время, а также отменить ее. Вы также можете указать один или несколько параметров политики доступа в хранимой политике доступа, а остальные параметры - в URL-адресе. И, наконец, вы можете указать все параметры в URL-адресе. В этом случае с помощью хранимой политики доступа можно отменить подпись, но нельзя изменить ее поведение.

Подписанный URL-адрес и хранимая политика доступа должны содержать все поля, необходимые для аутентификации подписи. Если какие-либо обязательные поля отсутствуют, попытка выполнения запроса завершится ошибкой с кодом состояния 403 (запрещено). Аналогично, если поле указано и в подписанном URL-адресе, и в хранимой политике доступа, запрос завершится ошибкой с кодом состояния 403 (ошибочный запрос). Дополнительную информацию о полях, составляющих подпись, см. в разделе "Создание и использование подписанного URL-адреса".

### Изменение или отмена хранимой политики доступа

Чтобы отозвать доступ к подписанным URL-адресам, использующим одну хранимую политику доступа, удалите хранимую политику из ресурса хранилища, перезаписав список хранимых политик новым списком, в котором не содержится имя этой политики. Чтобы изменить параметры доступа хранимой политики, перезапишите список хранимых политик новым списком, в котором содержится политика с таким же именем, но с новыми параметрами управления доступом.


<!--HONumber=52--> 