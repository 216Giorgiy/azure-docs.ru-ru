---
title: "Устранение неполадок службы синхронизации файлов Azure (предварительная версия) | Документация Майкрософт"
description: "Эта статья содержит сведения о том, как устранять распространенные неполадки службы синхронизации файлов Azure."
services: storage
documentationcenter: 
author: wmgries
manager: klaasl
editor: jgerend
ms.assetid: 297f3a14-6b3a-48b0-9da4-db5907827fb5
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/08/2017
ms.author: wgries
ms.openlocfilehash: 6bc5f2da2b8628671037b9257db746e73cd3afad
ms.sourcegitcommit: 76a3cbac40337ce88f41f9c21a388e21bbd9c13f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/25/2017
---
# <a name="troubleshoot-azure-file-sync-preview"></a>Устранение неполадок службы синхронизации файлов Azure (предварительная версия)
Служба "Синхронизация файлов Azure" (предварительная версия) позволяет централизовано хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Это достигается путем преобразования серверов Windows Server в быстрый кэш общего файлового ресурса Azure. Для локального доступа к данным вы можете использовать любой протокол (в том числе SMB, NFS и FTPS), доступный в Windows Server. Кроме того, вы можете создать любое число кэшей в любом регионе.

Эта статья поможет диагностировать и устранить проблемы, возникающие при развертывании службы синхронизации файлов Azure. Если это не дало результатов, в этом руководстве показано, как собирать важные журналы из системы, которые помогают более подробно разобраться в проблемах. Если вы не видите ответ на свой вопрос, обратитесь к нам, используя следующие каналы (в порядке эскалации):

1. Раздел комментариев этой статьи.
2. [Форум службы хранилища Azure](https://social.msdn.microsoft.com/Forums/home?forum=windowsazuredata).
3. [UserVoice службы "Файлы Azure"](https://feedback.azure.com/forums/217298-storage/category/180670-files). 
4. Служба поддержки Майкрософт. Чтобы создать запрос в службу поддержки, перейдите на вкладку "Справка и поддержка" на портале Azure и выберите "Новый запрос на поддержку".

## <a name="agent-installation-and-server-registration"></a>Установка агента и регистрация сервера
<a id="agent-installation-failures"></a>**Устранение неполадок при установке агента**  
Если при установке агента службы синхронизации файлов Azure произошел сбой, выполните указанную ниже команду в командной строке с повышенными привилегиями, чтобы включить ведение журнала во время установки агента.

```
StorageSyncAgent.msi /l*v Installer.log
```

После сбоя установки просмотрите журнал установки, чтобы определить причину сбоя. 

> [!Note]  
> Установка агента завершится ошибкой, если было выбрано использование центра обновления Майкрософт, но при этом служба "Центр обновления Windows" не запущена.

<a id="server-registration-missing"></a>**Сервер не указан в списке зарегистрированных серверов на портале Azure**  
Если сервер не указан в списке зарегистрированных серверов службы синхронизации хранилища, сделайте следующее:
1. Войдите на сервер, который необходимо зарегистрировать.
2. Откройте обозреватель файлов и перейдите к каталогу установки агента службы синхронизации хранилища (расположение по умолчанию — `C:\Program Files\Azure\StorageSyncAgent`). 
3. Запустите ServerRegistration.exe и следуйте указаниям мастера, чтобы зарегистрировать сервер в службе синхронизации хранилища.

<a id="server-already-registered"></a>**При регистрации сервера после установки агента службы синхронизации файлов отображается следующее сообщение: This server is already registered (Сервер уже зарегистрирован)**  
![Снимок экрана диалогового окна регистрации сервера с сообщением об ошибке Server is already registered (Сервер уже зарегистрирован)](media/storage-sync-files-troubleshoot/server-registration-1.png)

Это сообщение отображается, если сервер был зарегистрирован в службе синхронизации хранилища ранее. Чтобы отменить регистрацию сервера в текущей службе синхронизации хранилища и зарегистрировать его в новой службе, выполните действия, указанные в [этом разделе](storage-sync-files-server-registration.md#unregister-the-server-with-storage-sync-service).

Если сервер не указан в списке "Зарегистрированные серверы" в службе синхронизации хранилища, выполните следующие команды PowerShell на сервере, регистрацию которого вы хотите отменить:

```PowerShell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Reset-StorageSyncServer
```

> [!Note]  
> Если сервер входит в состав кластера, имеется дополнительный параметр `Reset-StorageSyncServer -CleanClusterRegistration`, который также удалит регистрацию кластера.

<a id="web-site-not-trusted"></a>**При регистрации сервера получено несколько ответов, что веб-сайт не является доверенным. В чем причина?**  
Эта ошибка возникает, если во время регистрации сервера включена политика **усиленной безопасности Internet Explorer**. Дополнительные сведения о том, как правильно отключить политику **усиленной безопасности Internet Explorer**, см. в разделе [Подготовка серверов Windows к работе со службой синхронизации файлов Azure](storage-sync-files-deployment-guide.md#prepare-windows-servers-for-use-with-azure-file-sync) в статье [Как развернуть службу синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md).

## <a name="sync-group-management"></a>Управление группами синхронизации
<a id="cloud-endpoint-using-share"></a>**Создание облачной конечной точки завершается сбоем со следующей ошибкой: The specified Azure FileShare is already in use by a different CloudEndpoint (Указанный общий файловый ресурс Azure уже используется другой облачной конечной точкой)**  
Эта ошибка возникает, если общий файловый ресурс Azure уже используется другой облачной конечной точкой. 

Если при возникновении этой ошибки общий файловый ресурс Azure в настоящее время не используется облачной конечной точкой, выполните следующие действия, чтобы очистить метаданные службы "Синхронизация файлов Azure" в общих файловых ресурсах Azure:

> [!Warning]  
> Удаление метаданных в общих файловых ресурсах Azure, которые в настоящее время используются облачной конечной точкой, приведет к сбою операций синхронизации службы "Синхронизация файлов Azure". 

1. На портале Azure перейдите к общему файловому ресурсу Azure.  
2. Щелкните общий файловый ресурс Azure правой кнопкой мыши и выберите **Изменить метаданные**.
3. Щелкните SyncService правой кнопкой мыши и выберите **Удалить**.

<a id="cloud-endpoint-authfailed"></a>**Создание облачной конечной точки завершается сбоем со следующей ошибкой: AuthorizationFailed**  
Эта проблема возникает, если учетная запись пользователя не имеет соответствующих прав на создание конечной точки облака. 

Чтобы создать конечную точку облака, ваша учетная запись пользователя должна иметь следующие разрешения авторизации Майкрософт:  
* Чтение. Получение определения роли.
* Запись. Создание или изменение определения пользовательской роли.
* Чтение. Получение назначения роли.
* Запись. Создание назначения роли.

Следующие встроенные роли имеют соответствующие разрешения авторизации Майкрософт:  
* Владелец
* Администратор доступа пользователей

Чтобы определить, имеет ли учетная запись пользователя соответствующие разрешения, сделайте следующее:  
* На портале Azure щелкните **Группы ресурсов**.
* Выберите группу ресурсов, в которой расположена учетная запись хранения, и **Управление доступом (IAM)**.
* Щелкните **роль** (например, владелец или участник) для учетной записи пользователя.
* В списке **Поставщик ресурсов** выберите **Авторизация Майкрософт**. 
* **Назначение ролей** должно иметь разрешения на **чтение** и **запись**.
* **Определение роли** должно иметь разрешения на **чтение** и **запись**.

<a id="cloud-endpoint-deleteinternalerror"></a>**Удаление конечной точки завершается сбоем со следующей ошибкой: MgmtInternalError**  
Эта проблема может возникать, если общий файловый ресурс Azure или учетная запись хранения были удалены перед удалением конечной точки облака. Она будет исправлена в будущем обновлении и конечную точку облака можно будет удалить.

Чтобы предотвратить возникновение этой проблемы, удалите конечную точку облака перед удалением общей папки Azure или учетной записи хранения.

## <a name="sync"></a>Sync
<a id="afs-change-detection"></a>**Если файл был создан непосредственно в файловом ресурсе Azure через SMB или портал, то через какое время этот файл синхронизируется с серверами в группе синхронизации?**  
[!INCLUDE [storage-sync-files-change-detection](../../../includes/storage-sync-files-change-detection.md)]

<a id="broken-sync"></a>**Устранение неполадок при сбое синхронизации на сервере**  
Если на сервере произошел сбой при синхронизации, сделайте следующее:
- Убедитесь, что конечная точка сервера существует на портале Azure для каталога, с которым вы хотите синхронизировать файловый ресурс Azure:
    
    ![Снимок экрана группы синхронизации с конечной точкой облака и сервера на портале Azure](media/storage-sync-files-troubleshoot/sync-troubleshoot-1.png)

- Просмотрите журналы событий операций и диагностики с помощью решения "Просмотр событий", расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`.
- Убедитесь, что сервер имеет подключение к Интернету.
- Убедитесь, что служба синхронизации файлов Azure выполняется на сервере. Для этого откройте оснастку MMC "Службы" и убедитесь, что служба агента синхронизации хранилища (FileSyncSvc) выполняется.

<a id="replica-not-ready"></a>**Синхронизация завершается ошибкой: 0x80c8300f - The replica is not ready to perform the required operation (0x80c8300f. Реплика не готова для выполнения требуемой операции)**  
Эта ошибка возникает, если вы создали конечную точку облака и используете общую папку Azure, содержащую данные. После завершения обнаружения изменений в общем файловом ресурсе Azure (может занять до 24 часов) синхронизация должна начать работать правильно.

<a id="broken-sync-files"></a>**Устранение неполадок при сбое синхронизации отдельных файлов**  
Если отдельные файлы не удалось синхронизировать, сделайте следующее:
- Просмотрите журналы событий операций и диагностики, расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`, с помощью средства просмотра событий.
- Убедитесь, что в файле нет открытых дескрипторов.
    - Примечание. Служба синхронизации файлов Azure будет периодически делать моментальные снимки VSS, чтобы синхронизировать файлы с открытыми дескрипторами.

## <a name="cloud-tiering"></a>Распределение по уровням облака 
<a id="files-fail-tiering"></a>**Устранение неполадок при распределении файлов по уровням**  
Если файлы не удается распределить по уровням в службе файлов Azure, сделайте следующее:

- Убедитесь, что файлы существуют в файловом ресурсе Azure.
    - Примечание. Файлы должны быть синхронизированы с файловыми ресурсами Azure, прежде чем их можно будет распределить по уровням.
- Просмотрите журналы событий операций и диагностики, расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`, с помощью решения "Просмотр событий".
- Убедитесь, что сервер имеет подключение к Интернету. 
- Убедитесь, что выполняются драйверы фильтра службы синхронизации файлов Azure (StorageSync.sys и StorageSyncGuard.sys).
    - Откройте командную строку с повышенными привилегиями, запустите `fltmc` и убедитесь, что указаны драйверы фильтра файловой системы StorageSync.sys и StorageSyncGuard.sys.

<a id="files-fail-recall"></a>**Устранение неполадок в файлах, которые не удалось отозвать**  
Если файлы не удается отозвать, сделайте следующее:
- Просмотрите журналы событий операций и диагностики, расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`, с помощью решения "Просмотр событий".
- Убедитесь, что файлы существуют в файловом ресурсе Azure.
- Убедитесь, что сервер имеет подключение к Интернету. 
- Убедитесь, что выполняются драйверы фильтра службы синхронизации файлов Azure (StorageSync.sys и StorageSyncGuard.sys).
    - Откройте командную строку с повышенными привилегиями, запустите `fltmc` и убедитесь, что указаны драйверы фильтра файловой системы StorageSync.sys и StorageSyncGuard.sys.

<a id="files-unexpectedly-recalled"></a>**Способы устранения проблем, если файлы были неожиданно отозваны на сервере**  
Антивирусные программы, приложения архивации, а также другие приложения, которые считывают большое количество файлов, вызывают нежелательные отзывы, если они не учитывают автономный атрибут и пропускают чтение содержимого этих файлов. Пропуск автономных файлов для продуктов, которые их поддерживают, поможет избежать нежелательных отзывов при выполнении операций, таких как сканирование антивирусными программами или задания резервного копирования.

Обратитесь к поставщику программного обеспечения за информацией о том, как настроить решение, чтобы пропустить чтение автономных файлов.

Дополнительные нежелательные отзывы могут возникнуть и в других сценариях, например просмотр файлов в обозревателе файлов. Открытие папки с облачными многоуровневыми файлами в обозревателе файлов на сервере может вызвать больше нежелательных отзывов, чем антивирусная программа, которая включена на сервере.

## <a name="general-troubleshooting"></a>Общие действия по устранению неполадок
При возникновении проблем со службой синхронизации файлов Azure на сервере для начала сделайте следующее:
- Просмотрите журналы событий диагностики и операций с помощью решения "Просмотр событий".
    - Проблемы синхронизации, распределения по уровням и отзывов записываются в журналы событий диагностики и операций по адресу `Applications and Services\Microsoft\FileSync\Agent`.
    - Проблемы при управлении сервером (например, параметры конфигурации) записываются в журналы событий диагностики и операций по адресу `Applications and Services\Microsoft\FileSync\Management`.
- Убедитесь, что служба синхронизации файлов Azure выполняется на сервере.
    - Откройте оснастку MMC "Службы" и убедитесь, что служба агента синхронизации хранилища (FileSyncSvc) выполняется.
- Убедитесь, что выполняются драйверы фильтра службы синхронизации файлов Azure (StorageSync.sys и StorageSyncGuard.sys).
    - Откройте командную строку с повышенными привилегиями, выполните команду fltmc и убедитесь, что указаны драйверы фильтра файловой системы StorageSync.sys и StorageSyncGuard.sys.

Если после этого проблема не устранена, запустите инструмент AFSDiag, сделав следующее:
1. Создайте каталог, который будет использоваться для сохранения выходных данных AFSDiag (например, c:\output).
2. Откройте окно PowerShell с повышенными привилегиями и выполните указанные ниже команды (нажмите клавишу ВВОД после каждой команды).

    ```PowerShell
    cd "c:\Program Files\Azure\StorageSyncAgent"
    Import-Module .\afsdiag.ps1
    Debug-Afs c:\output # Note: use the path created in step 1
    ```

3. Для службы синхронизации файлов Azure в режиме ядра на уровне трассировки введите 1 (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
4. Для службы синхронизации файлов Azure в пользовательском режиме на уровне трассировки введите 1 (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
5. Воспроизведите проблему и нажмите клавишу D по окончании.
6. ZIP-файл, содержащий журналы и файлы трассировки, будет находиться в указанном выходном каталоге.

## <a name="see-also"></a>См. также
- [Часто задаваемые вопросы о службе "Файлы Azure"](storage-files-faq.md)
- [Устранение неполадок службы файлов Azure в Windows](storage-troubleshoot-windows-file-connection-problems.md)
- [Устранение неполадок службы файлов Azure в Linux](storage-troubleshoot-linux-file-connection-problems.md)
