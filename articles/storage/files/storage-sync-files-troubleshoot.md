---
title: "Устранение неполадок службы синхронизации файлов Azure (предварительная версия) | Документация Майкрософт"
description: "Эта статья содержит сведения о том, как устранять распространенные неполадки службы синхронизации файлов Azure."
services: storage
documentationcenter: 
author: wmgries
manager: klaasl
editor: jgerend
ms.assetid: 297f3a14-6b3a-48b0-9da4-db5907827fb5
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/08/2017
ms.author: wgries
ms.openlocfilehash: 1ea7956e92dbc85f62383e4b041c4c830599f765
ms.sourcegitcommit: 51ea178c8205726e8772f8c6f53637b0d43259c6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="troubleshoot-azure-file-sync-preview"></a>Устранение неполадок службы синхронизации файлов Azure (предварительная версия)
Служба "Синхронизация файлов Azure" (предварительная версия) позволяет централизовано хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Это достигается путем преобразования серверов Windows Server в быстрый кэш общего файлового ресурса Azure. Для локального доступа к данным вы можете использовать любой протокол (в том числе SMB, NFS и FTPS), доступный в Windows Server. Кроме того, вы можете создать любое количество кэшей в любом регионе.

Эта статья поможет диагностировать и устранить проблемы, возникающие при развертывании службы синхронизации файлов Azure. Если это не дало результатов, в этом руководстве показано, как собирать важные журналы из системы, которые помогают более подробно разобраться в проблемах. Чтобы получать поддержу для службы синхронизации файлов Azure, используйте следующие ресурсы:

- Служба поддержки Майкрософт. Чтобы создать запрос в службу поддержки, перейдите на вкладку "Справка и поддержка" на портале Azure и выберите "Новый запрос на поддержку".
- [Форум службы хранилища Azure](https://social.msdn.microsoft.com/Forums/en-US/home?forum=windowsazuredata).

## <a name="how-to-troubleshoot-agent-installation-failures"></a>Устранение неполадок при установке агента
Если при установке агента службы синхронизации файлов Azure произошел сбой, выполните указанную ниже команду в командной строке с повышенными привилегиями, чтобы включить ведение журнала во время установки агента.

```
StorageSyncAgent.msi /l*v Installer.log
```

После сбоя установки просмотрите журнал установки, чтобы определить причину сбоя. 

> [!Note]  
> Установка агента завершится ошибкой, если было выбрано использование центра обновления Майкрософт, но при этом служба "Центр обновления Windows" не запущена.

## <a name="cloud-endpoint-creation-fails-with-the-following-error-the-specified-azure-fileshare-is-already-in-use-by-a-different-cloudendpoint"></a>Создание облачной конечной точки завершается сбоем со следующей ошибкой: The specified Azure FileShare is already in use by a different CloudEndpoint (Указанный общий файловый ресурс Azure уже используется другой облачной конечной точкой)
Эта ошибка возникает, если общий файловый ресурс Azure уже используется другой облачной конечной точкой. 

Если при возникновении этой ошибки общий файловый ресурс Azure в настоящее время не используется облачной конечной точкой, выполните следующие действия, чтобы очистить метаданные службы "Синхронизация файлов Azure" в общих файловых ресурсах Azure:

> [!Warning]  
> Удаление метаданных в общих файловых ресурсах Azure, которые в настоящее время используются облачной конечной точкой, приведет к сбою операций синхронизации службы "Синхронизация файлов Azure". 

1. На портале Azure перейдите к общему файловому ресурсу Azure.  
2. Щелкните общий файловый ресурс Azure правой кнопкой мыши и выберите **Изменить метаданные**.
3. Щелкните SyncService правой кнопкой мыши и выберите **Удалить**.

## <a name="server-is-not-listed-under-registered-servers-in-the-azure-portal"></a>Сервер не указан в списке зарегистрированных серверов на портале Azure
Если сервер не указан в списке зарегистрированных серверов службы синхронизации хранилища, сделайте следующее:
1. Войдите на сервер, который необходимо зарегистрировать.
2. Откройте обозреватель файлов и перейдите к каталогу установки агента службы синхронизации хранилища (расположение по умолчанию — `C:\Program Files\Azure\StorageSyncAgent`). 
3. Запустите ServerRegistration.exe и следуйте указаниям мастера, чтобы зарегистрировать сервер в службе синхронизации хранилища.

## <a name="server-registration-displays-the-following-message-after-installing-the-azure-file-sync-agent-this-server-is-already-registered"></a>При регистрации сервера после установки агента службы синхронизации файлов отображается следующее сообщение: This server is already registered (Сервер уже зарегистрирован)
![Снимок экрана диалогового окна регистрации сервера с сообщением об ошибке Server is already registered (Сервер уже зарегистрирован)](media/storage-sync-files-troubleshoot/server-registration-1.png)

Это сообщение отображается, если сервер был зарегистрирован в службе синхронизации хранилища ранее. Чтобы отменить регистрацию сервера в текущей службе синхронизации хранилища и зарегистрировать его в новой службе, выполните действия, указанные в [этом разделе](storage-sync-files-server-registration.md#unregister-the-server-with-storage-sync-service).

Если сервер не указан в списке "Зарегистрированные серверы" в службе синхронизации хранилища, выполните следующие команды PowerShell на сервере, регистрацию которого вы хотите отменить:

```PowerShell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Reset-StorageSyncServer
```

> [!Note]  
> Если сервер входит в состав кластера, имеется дополнительный параметр `Reset-StorageSyncServer -CleanClusterRegistration`, который также удалит регистрацию кластера. Этот параметр следует использовать при отмене регистрации последнего узла в кластере.

## <a name="how-to-troubleshoot-sync-not-working-on-a-server"></a>Устранение неполадок при сбое синхронизации на сервере
Если на сервере произошел сбой при синхронизации, сделайте следующее:
- Убедитесь, что конечная точка сервера существует на портале Azure для каталога, с которым вы хотите синхронизировать файловый ресурс Azure:
    
    ![Снимок экрана группы синхронизации с конечной точкой облака и сервера на портале Azure](media/storage-sync-files-troubleshoot/sync-troubleshoot-1.png)

- Просмотрите журналы событий операций и диагностики с помощью решения "Просмотр событий", расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`.
- Убедитесь, что сервер имеет подключение к Интернету.
- Убедитесь, что служба синхронизации файлов Azure выполняется на сервере. Для этого откройте оснастку MMC "Службы" и убедитесь, что служба агента синхронизации хранилища (FileSyncSvc) выполняется.

## <a name="how-to-troubleshoot-individual-files-failing-to-sync"></a>Устранение неполадок при сбое синхронизации отдельных файлов 
Если отдельные файлы не удалось синхронизировать, сделайте следующее:
- Просмотрите журналы событий операций и диагностики, расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`, с помощью средства просмотра событий.
- Убедитесь, что в файле нет открытых дескрипторов.
    - Примечание. Служба синхронизации файлов Azure будет периодически делать моментальные снимки VSS, чтобы синхронизировать файлы с открытыми дескрипторами.

## <a name="how-to-troubleshoot-files-that-fail-to-tier"></a>Устранение неполадок при распределении файлов по уровням
Если файлы не удается распределить по уровням в службе файлов Azure, сделайте следующее:

- Убедитесь, что файлы существуют в файловом ресурсе Azure.
    - Примечание. Файлы должны быть синхронизированы с файловыми ресурсами Azure, прежде чем их можно будет распределить по уровням.
- Просмотрите журналы событий операций и диагностики, расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`, с помощью решения "Просмотр событий".
- Убедитесь, что сервер имеет подключение к Интернету. 
- Убедитесь, что выполняются драйверы фильтра службы синхронизации файлов Azure (StorageSync.sys и StorageSyncGuard.sys).
    - Откройте командную строку с повышенными привилегиями, запустите `fltmc` и убедитесь, что указаны драйверы фильтра файловой системы StorageSync.sys и StorageSyncGuard.sys.

## <a name="how-to-troubleshoot-files-that-fail-to-be-recalled"></a>Устранение неполадок в файлах, которые не удалось отозвать
Если файлы не удается отозвать, сделайте следующее:
- Просмотрите журналы событий операций и диагностики, расположенные по этому пути `Applications and Services\Microsoft\FileSync\Agent`, с помощью решения "Просмотр событий".
- Убедитесь, что файлы существуют в файловом ресурсе Azure.
- Убедитесь, что сервер имеет подключение к Интернету. 
- Убедитесь, что выполняются драйверы фильтра службы синхронизации файлов Azure (StorageSync.sys и StorageSyncGuard.sys).
    - Откройте командную строку с повышенными привилегиями, запустите `fltmc` и убедитесь, что указаны драйверы фильтра файловой системы StorageSync.sys и StorageSyncGuard.sys.

## <a name="how-to-troubleshoot-files-being-unexpectedly-recalled-on-a-server"></a>Способы устранения проблем, если файлы были неожиданно отозваны на сервере
Антивирусные программы, приложения архивации, а также другие приложения, которые считывают большое количество файлов, вызывают нежелательные отзывы, если они не учитывают автономный атрибут и пропускают чтение содержимого этих файлов. Пропуск автономных файлов для продуктов, которые их поддерживают, поможет избежать нежелательных отзывов при выполнении операций, таких как сканирование антивирусными программами или задания резервного копирования.

Обратитесь к поставщику программного обеспечения за информацией о том, как настроить решение, чтобы пропустить чтение автономных файлов.

Дополнительные нежелательные отзывы могут возникнуть и в других сценариях, например просмотр файлов в обозревателе файлов. Открытие папки с облачными многоуровневыми файлами в обозревателе файлов на сервере может вызвать больше нежелательных отзывов, чем антивирусная программа, которая включена на сервере.

## <a name="general-troubleshooting"></a>Общие действия по устранению неполадок
При возникновении проблем со службой синхронизации файлов Azure на сервере для начала сделайте следующее:
- Просмотрите журналы событий диагностики и операций с помощью решения "Просмотр событий".
    - Проблемы синхронизации, распределения по уровням и отзывов записываются в журналы событий диагностики и операций по адресу `Applications and Services\Microsoft\FileSync\Agent`.
    - Проблемы при управлении сервером (например, параметры конфигурации) записываются в журналы событий диагностики и операций по адресу `Applications and Services\Microsoft\FileSync\Management`.
- Убедитесь, что служба синхронизации файлов Azure выполняется на сервере.
    - Откройте оснастку MMC "Службы" и убедитесь, что служба агента синхронизации хранилища (FileSyncSvc) выполняется.
- Убедитесь, что выполняются драйверы фильтра службы синхронизации файлов Azure (StorageSync.sys и StorageSyncGuard.sys).
    - Откройте командную строку с повышенными привилегиями, выполните команду fltmc и убедитесь, что указаны драйверы фильтра файловой системы StorageSync.sys и StorageSyncGuard.sys.

Если после этого проблема не устранена, запустите инструмент AFSDiag, сделав следующее:
1. Создайте каталог, который будет использоваться для сохранения выходных данных AFSDiag (например, c:\output).
2. Откройте окно PowerShell с повышенными привилегиями и выполните указанные ниже команды (нажмите клавишу ВВОД после каждой команды).

    ```PowerShell
    cd "c:\Program Files\Azure\StorageSyncAgent"
    Import-Module .\afsdiag.ps1
    Debug-Afs c:\output # Note: use the path created in step 1
    ```

3. Для службы синхронизации файлов Azure в режиме ядра на уровне трассировки введите 1 (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
4. Для службы синхронизации файлов Azure в пользовательском режиме на уровне трассировки введите 1 (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
5. Воспроизведите проблему и нажмите клавишу D по окончании.
6. ZIP-файл, содержащий журналы и файлы трассировки, будет находиться в указанном выходном каталоге.