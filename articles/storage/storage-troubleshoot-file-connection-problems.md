---
title: "Устранение неполадок хранилища файлов Azure | Документация Майкрософт"
description: "Устранение проблем с хранилищем файлов Azure"
services: storage
documentationcenter: 
author: genlin
manager: felixwu
editor: na
tags: storage
ms.assetid: fbc5f600-131e-4b99-828a-42d0de85fff7
ms.service: storage
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/15/2017
ms.author: genli
translationtype: Human Translation
ms.sourcegitcommit: 7aa2a60f2a02e0f9d837b5b1cecc03709f040898
ms.openlocfilehash: cce72f374e2cc6f1a42428d9f8e1f3ab8be50f7b
ms.lasthandoff: 02/28/2017


---
# <a name="troubleshooting-azure-file-storage-problems"></a>Устранение проблем с хранилищем файлов Azure
В этой статье приведен список распространенных проблем, возникающих в хранилище файлов Microsoft Azure при подключении с клиентов Windows и Linux. Кроме того, здесь представлены возможные причины этих проблем и способы их устранения.

**Общие проблемы (возникают в клиентах Windows и Linux)**

* [Ошибка квоты при попытке открыть файл](#quotaerror)
* [Низкая производительность при доступе к хранилищу файлов Azure из Windows или Linux](#slowboth)
* [Как отслеживать операции чтения и записи в хранилище файлов Azure](#traceop)

**Проблемы клиента Windows**

* [Низкая производительность при доступе к хранилищу файлов Azure из Windows 8.1 или Windows Server 2012 R2](#windowsslow)
* [Ошибка 53 при попытке подключения общей папки службы файлов Azure](#error53)
* [Ошибка 87. Неправильный параметр при попытке подключить файловый ресурс Azure](#error87)
* [Общая папка службы файлов Azure не отображается в проводнике после подключения с помощью команды net use](#netuse)
* [Учетная запись хранения содержит косую черту (/), в результате чего выполнение команды net use завершилось сбоем](#slashfails)
* [Приложение и (или) служба не может получить доступ к подключенному диску службы файлов Azure](#accessfiledrive)
* [Дополнительные рекомендации по оптимизации производительности](#additional)

**Проблемы клиента Linux**

* [Во время копирования или передачи файлов в службу файлов Azure произошла ошибка со следующим сообщением: "Вы копируете файл в место, которое не поддерживает шифрование"](#encryption)
* [Периодическая ошибка ввода-вывода. Отображается сообщение об ошибке "Узел не работает" в имеющихся файловых ресурсах или оболочка перестает отвечать на запросы при выполнении команд вывода списка в точке подключения.](#errorhold)
* [Ошибка подключения 115 при попытке подключения службы файлов Azure на виртуальной машине Linux](#error15)
* [При выполнении команд, таких как ls, на виртуальной машине Linux возникают случайные задержки](#delayproblem)
* [Ошибка 112: ошибка времени ожидания](#error112)

**Получение доступа из других приложений**

* [Можно ли указать ссылку на файловый ресурс Azure для приложения посредством веб-задания?](#webjobs)

<a id="quotaerror"></a>

## <a name="quota-error-when-trying-to-open-a-file"></a>Ошибка квоты при попытке открыть файл
Работая в Windows, вы получаете сообщения об ошибках, которые выглядят примерно следующим образом:

`1816 ERROR_NOT_ENOUGH_QUOTA <--> 0xc0000044`
`STATUS_QUOTA_EXCEEDED`
`Not enough quota is available to process this command`
`Invalid handle value GetLastError: 53`

Работая в Linux, вы получаете сообщения об ошибках, которые выглядят примерно следующим образом:

`<filename> [permission denied]`
`Disk quota exceeded`

### <a name="cause"></a>Причина:
Эта ошибка возникает, так как достигнуто максимально допустимое число открытых дескрипторов, разрешенных для файла.

### <a name="solution"></a>Решение
Сократите количество одновременно открытых дескрипторов, закрыв некоторые из них, и повторите попытку. Дополнительные сведения см. в статье [Производительность хранилища Microsoft Azure и контрольный список масштабируемости](storage-performance-checklist.md).

<a id="slowboth"></a>

## <a name="slow-performance-when-accessing-file-storage-from-windows-or-linux"></a>Низкая производительность при доступе к хранилищу файлов из Windows или Linux
* Если определенные требования к минимальному размеру операций ввода-вывода отсутствуют, для оптимальной производительности мы рекомендуем использовать 1 МБ.
* Если окончательный размер файла, в который выполняются операции записи, известен, а программное обеспечение не имеет проблем совместимости, пока еще не записанный заключительный фрагмент файла содержит нули, укажите размер файла заранее вместо того, чтобы расширять его для каждой операции записи.
* Используйте правильный метод копирования:
      * Используйте AZCopy для передачи данных между двумя файловыми ресурсами. Дополнительные сведения см. в статье [Приступая к работе со служебной программой командной строки AzCopy](https://docs.microsoft.com/en-us/azure/storage/storage-use-azcopy#file-copy).
      * Используйте Robocopy для передачи данных между файловом ресурсом и локальным компьютером. Дополнительные сведения см. в статье [Multi-threaded robocopy for faster copies](https://blogs.msdn.microsoft.com/granth/2009/12/07/multi-threaded-robocopy-for-faster-copies/) (Быстрое копирование с помощью многопоточного инструмента Robocopy).
<a id="windowsslow"></a>

## <a name="slow-performance-when-accessing-the-file-storage-from-windows-81-or-windows-server-2012-r2"></a>Низкая производительность при доступе к хранилищу файлов из Windows 8.1 или Windows Server 2012 R2
Для клиентов, использующих Windows 8.1 или Windows Server 2012 R2, установите исправление [KB3114025](https://support.microsoft.com/kb/3114025). Это исправление улучшает производительность операции создания и закрытия дескрипторов.

Выполните следующий скрипт, чтобы проверить, установлено ли это исправление.

`reg query HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters\Policies`

Если это так, выводятся следующие данные:

`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters\Policies`
`{96c345ef-3cac-477b-8fcd-bea1a564241c}    REG_DWORD    0x1`

> [!NOTE]
> Начиная с декабря 2015 г. в образах Windows Server 2012 R2, содержащихся в Azure Marketplace, исправление KB3114025 установлено по умолчанию.
>
>

<a id="traceop"></a>

### <a name="how-to-trace-the-read-and-write-operations-in-azure-file-storage"></a>Как отслеживать операции чтения и записи в хранилище файлов Azure

[Анализатор сообщений Майкрософт](https://www.microsoft.com/en-us/download/details.aspx?id=44226) имеет возможность показать вам запрос клиента виде открытого текста, и между передаваемыми запросами и транзакциями существует заметная взаимосвязь (при условии, что используется SMB, а не REST).  Недостатком является то, что эту операцию необходимо выполнять на каждом клиенте, что занимает много времени при наличии многих рабочих ролей виртуальных машин IaaS.

При использовании анализа сообщений с ProcMon можно получить хорошее представление о том, какой код приложения отвечает за транзакции.

<a id="additional"></a>

## <a name="additional-recommendations-to-optimize-performance"></a>Дополнительные рекомендации по оптимизации производительности
Никогда не создавайте и не открывайте файл кэшированных операций ввода-вывода, который запрашивает доступ только на запись. То есть, при вызове метода **CreateFile()** указывайте не **GENERIC_WRITE**, а **GENERIC_READ | GENERIC_WRITE**. Дескриптор, используемый только для записи, не может кэшировать маленькие операции записи локально, даже если в этом файле только один открытый дескриптор. Это может привести к некоторому снижению производительности небольших операций записи. Обратите внимание, что режим "а" в функции crt **fopen()** открывает дескриптор, используемый только для записи.

<a id="error53"></a>

## <a name="error-53-or-error-67-when-you-try-to-mount-or-unmount-an-azure-file-share"></a>Ошибка 53 или ошибка 67 при попытке подключения или отключения общей папки службы файлов Azure
Эта проблема может быть вызвана следующими причинами.

### <a name="cause-1"></a>Причина 1
Произошла системная ошибка 53, из-за чего запрещен доступ. По соображениям безопасности, если коммуникационный канал не зашифрован, а попытка подключения осуществляется не из того же центра обработки данных, в котором находятся общие папки службы файлов Azure, то подключение к службе файлов Azure будет заблокировано. Если ОС клиента пользователя не поддерживает шифрование SMB, шифрование коммуникационного канала не выполняется. В этом случае, когда пользователь пытается подключить общую папку из локальной среды или другого центра обработки данных отобразится следующее сообщение об ошибке: System error&53; has occurred. Access is denied (Произошла системная ошибка&53;. Доступ запрещен). Windows 8, Windows Server 2012 или более поздние версии этих ОС отправляют запрос на согласование, который включает протокол SMB 3.0, поддерживающий шифрование.

### <a name="solution-for-cause-1"></a>Решение для причины 1
Подключитесь из клиента, соответствующего требованиям Windows 8, Windows Server 2012 или более поздних версий, или из виртуальной машины, расположенной в том же центре обработки данных, что и учетная запись хранения Azure, используемая для общей папки службы файлов Azure.

### <a name="cause-2"></a>Причина 2
Системная ошибка 53 или системная ошибка 67 при подключении общей папки службы файлов Azure может быть вызвана, если исходящие подключения по порту 445 к центру обработки данных службы файлов Azure заблокировано. Чтобы просмотреть сведения о поставщиках услуг Интернета, поддерживающих (или не поддерживающих) подключение по порту 445, щелкните [здесь](http://social.technet.microsoft.com/wiki/contents/articles/32346.azure-summary-of-isps-that-allow-disallow-access-from-port-445.aspx).

Comcast и некоторые ИТ-организации блокируют этот порт. Чтобы определить, вызвана ли системная ошибка 53 этой причиной, отправьте запрос к конечной точке TCP:445 с помощью Portqry. Если конечная точка TCP:445 отображается как отфильтрованная, значит TCP-порт заблокирован. Вот пример запроса:

`g:\DataDump\Tools\Portqry>PortQry.exe -n [storage account name].file.core.windows.net -p TCP -e 445`

Если TCP-порт 445 заблокирован правилом для сетевого пути, вы увидите такой результат:

**TCP port 445 (microsoft-ds service): FILTERED**

Дополнительные сведения об использовании Portqry см. в статье [Описание запускаемого из командной строки средства Portqry.exe](https://support.microsoft.com/kb/310099).

### <a name="solution-for-cause-2"></a>Решение для причины 2
Обратитесь в ИТ-организацию, чтобы открыть исходящее подключение по порту 445 для [диапазонов IP-адресов Azure](https://www.microsoft.com/download/details.aspx?id=41653).

<a id="error87"></a>
### <a name="cause-3"></a>Причина 3
Системная ошибка 53 или 87 может также произойти, если в клиенте включена аутентификация NTLMv1. Протокол проверки подлинности NTLMv1 делает клиент менее безопасным, в результате чего связь для службы файлов Azure блокируется. Чтобы проверить, заключается ли причина ошибки в этом, убедитесь, что для следующего подраздела реестра задано значение 3:

HKLM\SYSTEM\CurrentControlSet\Control\Lsa > LmCompatibilityLevel.

Дополнительные сведения см. в статье [LmCompatibilityLevel](https://technet.microsoft.com/library/cc960646.aspx) на сайте TechNet.

### <a name="solution-for-cause-3"></a>Решение для причины 3
Чтобы устранить эту проблему, задайте для параметра LmCompatibilityLevel в разделе реестра HKLM\SYSTEM\CurrentControlSet\Control\Lsa значение 3.

Служба файлов Azure поддерживает только проверку подлинности NTLMv2. Примените к клиентам групповую политику. Это позволит предотвратить эту ошибку, а также улучшить безопасность. Дополнительные сведения см. в статье о [настройке проверки подлинности NTLMv2 в клиентах с помощью групповой политики](https://technet.microsoft.com/library/jj852207\(v=ws.11\).aspx).

Мы советуем использовать для политики параметр **Отправлять только NTLMv2 ответ**. Это соответствует значению 3 для реестра. Клиенты используют только проверку подлинности NTLMv2, а также сеансовую безопасность NTLMv2, если сервер ее поддерживает. Контроллеры домена принимают проверку подлинности LM, NTLM и NTLMv2.

<a id="netuse"></a>

## <a name="net-use-was-successful-but-dont-see-the-azure-file-share-mounted-in-windows-explorer"></a>Общая папка службы файлов Azure не отображается в проводнике после подключения с помощью команды net use
### <a name="cause"></a>Причина:
По умолчанию проводник не запускается от имени администратора. При запуске команды **net use** из командной строки администратора пользователь подключает сетевой диск от имени администратора. Подключенные диски ориентированы на пользователя. Если для их подключения использовалась одна учетная запись, а пользователь вошел в систему с помощью другой, то диски отображаться не будут.

### <a name="solution"></a>Решение
Подключите общую папку из командной строки без прав администратора. Кроме того, настройте значение регистра **EnableLinkedConnections**, следуя указаниям в [этой статье TechNet](https://technet.microsoft.com/library/ee844140.aspx).

<a id="slashfails"></a>

## <a name="my-storage-account-contains--and-the-net-use-command-fails"></a>Учетная запись хранения содержит косую черту (/), в результате чего выполнение команды net use завершилось сбоем
### <a name="cause"></a>Причина:
Если команда **net use** выполняется в командной строке (cmd.exe), при ее анализе добавляется косая черта (/) в качестве параметра командной строки. В результате подключение диска завершается сбоем.

### <a name="solution"></a>Решение
Чтобы обойти эту проблему, выполните одно из следующих действий.

• Используйте следующую команду PowerShell.

`New-SmbMapping -LocalPath y: -RemotePath \\server\share  -UserName acountName -Password "password can contain / and \ etc"`

В пакетном файле это можно сделать следующим образом:

`Echo new-smbMapping ... | powershell -command –`

• Заключите значение ключа в двойные прямые кавычки (если первый символ не является косой чертой). Если значение ключа начинается с косой черты (/), используйте интерактивный режим и введите пароль отдельно или повторно создайте ключи, которые не начинаются с этого символа.

<a id="accessfiledrive"></a>

## <a name="my-applicationservice-cannot-access-mounted-azure-files-drive"></a>Приложение и (или) служба не может получить доступ к подключенному диску службы файлов Azure
### <a name="cause"></a>Причина:
Диски подключаются для каждого пользователя. Если приложение или служба выполняется под другой учетной записью, диски не отображаются.

### <a name="solution"></a>Решение
Используйте для подключения дисков и выполнения приложений одну и ту же учетную запись пользователя. Это можно сделать с помощью таких средств, как psexec.

Кроме того, можно создать нового пользователя с теми же привилегиями, что у сетевой службы или системной учетной записи, а затем выполнить команду **cmdkey** и **net use** под этой учетной записью. В качестве имени пользователя необходимо использовать имя учетной записи хранения, а в качестве пароля — ключ учетной записи хранения. Для команды **net use** доступен еще один вариант. Передайте имя и ключ учетной записи хранения в параметры имени пользователя и пароля команды **net use**.

Пользователь может получить следующее сообщение об ошибке: System error 1312 has occurred. A specified logon session does not exist. It may already have been terminated (Произошла системная ошибка&1312;. Указанный сеанс работы не существует. Возможно, он уже завершен). Это сообщение возникает после выполнения команды **net use** для учетной записи сетевой или системной службы. В этом случае убедитесь, что имя пользователя, переданное в **net use**, содержит сведения о домене (например, [имя_учетной_записи_хранения].file.core.windows.net).

<a id="encryption"></a>

## <a name="error-you-are-copying-a-file-to-a-destination-that-does-not-support-encryption"></a>Ошибка "Вы копируете файл в место, которое не поддерживает шифрование"
### <a name="cause"></a>Причина:
Файлы с шифрованием BitLocker нельзя копировать в службу файлов Azure. Однако хранилище файлов не поддерживает шифрованную файловую систему (EFS) NTFS. Поэтому в этом случае, скорее всего, используется файловая система EFS. При наличии файлов, зашифрованных с помощью EFS, операция копирования может завершиться сбоем, если команда копирования не выполняет расшифровку копируемого файла.

### <a name="workaround"></a>Возможное решение
Чтобы скопировать файл в хранилище файлов, его сначала необходимо расшифровать. Это можно сделать с помощью одного из следующих методов:

• используйте **copy /d**;

• настройте следующий раздел реестра:

* Path=HKLM\Software\Policies\Microsoft\Windows\System;
* Value type=DWORD;
* Name = CopyFileAllowDecryptedRemoteDestination;
* Value = 1.

Однако обратите внимание, что настройка раздела реестра влияет на все операции копирования в сетевые общие папки.

<a id="errorhold"></a>

## <a name="host-is-down-error-on-existing-file-shares-or-the-shell-hangs-when-you-run-list-commands-on-the-mount-point"></a>Отображается сообщение об ошибке "Узел не работает" в имеющихся общих папках или оболочка перестает отвечать после выполнения списка команд в точке подключения
### <a name="cause"></a>Причина:
Эта ошибка возникает в клиенте Linux, если он бездействует в течение длительного времени. При возникновении этой ошибки клиент отключается и время ожидания его подключения истекает.

### <a name="solution"></a>Решение
В настоящее время эта проблема устранена в ядре Linux в рамках [набора изменений](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/fs/cifs?id=4fcd1813e6404dd4420c7d12fb483f9320f0bf93), которые будут внесены в дистрибутиве Linux.

Чтобы обойти эту проблему, поддерживайте подключение, избегайте перехода в состояние простоя и храните файлы в общей папке службы файлов Azure, в которую периодически записываются данные. Это должна быть операция записи, такая как перезапись созданных или измененных данных в файл. В противном случае можно получить кэшированные результаты, в результате чего операция записи не активирует подключение.

<a id="error15"></a>

## <a name="mount-error-115-when-you-try-to-mount-azure-files-on-the-linux-vm"></a>Ошибка подключения 115 при попытке подключения службы файлов Azure на виртуальной машине Linux
### <a name="cause"></a>Причина:
В настоящее время дистрибутивы Linux не поддерживают функцию шифрования в SMB 3.0. В некоторых дистрибутивах при попытке подключения службы файлов Azure с помощью SMB 3.0 пользователь может получить сообщение об ошибке 115. Это связано с отсутствием функции шифрования.

### <a name="solution"></a>Решение
Если используемый SMB-клиент Linux не поддерживает шифрование, то следует подключить службу файлов Azure с помощью SMB 2.1 из виртуальной машины Linux, расположенной в том же центре обработки данных, что и учетная запись хранения службы файлов.

<a id="delayproblem"></a>

## <a name="linux-vm-experiencing-random-delays-in-commands-like-ls"></a>При выполнении команд, таких как ls, на виртуальной машине Linux возникают случайные задержки
### <a name="cause"></a>Причина:
Это может произойти, если в команде подключения не указан параметр **serverino**. Без параметра **serverino** команда ls выполняет команду **stat** в каждом файле.

### <a name="solution"></a>Решение
Проверьте наличие параметра **serverino** в записи /etc/fstab:

`//azureuser.file.core.windows.net/cifs        /cifs   cifs vers=3.0,serverino,username=xxx,password=xxx,dir_mode=0777,file_mode=0777`

Проверить, используется ли этот параметр, можно также, просто выполнив команду **sudo mount | grep cifs** и просмотрев ее результат.

`//mabiccacifs.file.core.windows.net/cifs on /cifs type cifs (rw,relatime,vers=3.0,sec=ntlmssp,username=xxx,domain=X,uid=0,noforceuid,gid=0,noforcegid,addr=192.168.10.1,file_mode=0777,dir_mode=0777,persistenthandles,nounix,serverino,mapposix,rsize=1048576,wsize=1048576,actimeo=1)`

Если параметр **serverino** отсутствует, отключите службу файлов Azure и подключите ее снова, добавив параметр **serverino**.

Другой причиной снижения производительности может быть отключенное кэширование. Чтобы проверить, включено ли кэширование, найдите параметр "cache=".  *cache=none* означает, что кэширование отключено. Повторно подключите общий ресурс, введя команду mount по умолчанию или явно добавив в нее параметр **cache=strict**, чтобы включить режим кэширования по умолчанию или "строгий" режим кэширования соответственно.

<a id="error112"></a>
## <a name="error-112---timeout-error"></a>Ошибка 112: ошибка времени ожидания

Эта ошибка означает наличие сбоев связи, которые мешают повторно установить подключение TCP к серверу, если используется режим мягкого подключения (режим по умолчанию).

### <a name="cause"></a>Причина:

Эта ошибка может быть вызвана проблемой при повторном подключении в Linux или другими проблемами, препятствующими повторному подключению, такими как ошибки сети. Если указать жесткое подключение, это вынудит клиента ждать, пока подключение не будет установлено или прервано явным образом. Это может использоваться для предотвращения ошибок из-за истечения времени ожидания сети. Тем не менее пользователи должны понимать, что это может привести к неопределенности времени ожидания, и при необходимости обрабатывать остановку подключения.


### <a name="workaround"></a>Возможное решение

Проблема в Linux была исправлена, но еще не перенесена в дистрибутивы Linux. Если проблема вызвана сбоем повторного подключения в Linux, ее можно обойти, предотвращая переход в состояние простоя. Для этого поместите в файловый ресурс Azure какой-либо файл и перезаписывайте его каждые 30 секунд (или чаще). Это должна быть операция записи, такая как перезапись созданных или измененных данных в файл. В противном случае можно получить кэшированные результаты, в результате чего операция записи не активирует подключение. Вот список популярных ядер Linux, в которых исправлены эти и другие ошибки повторного подключения: 4.4.40 и более поздние версии, 4.8.16 и более поздние версии, 4.9.1 и более поздние версии.

<a id="webjobs"></a>

## <a name="accessing-from-other-applications"></a>Получение доступа из других приложений
### <a name="can-i-reference-the-azure-file-share-for-my-application-through-a-webjob"></a>Можно ли указать ссылку на файловый ресурс Azure для приложения посредством веб-задания?
Невозможно подключить общие ресурсы SMB в песочнице службы приложений. Чтобы обойти эту особенность, можно сопоставить файловый ресурс Azure как подключенный диск и разрешить приложению доступ к нему по букве диска.
## <a name="learn-more"></a>Подробнее
* [Приступая к работе с хранилищем файлов Azure в Windows](storage-dotnet-how-to-use-files.md)
* [Использование хранилища файлов Azure в Linux](storage-how-to-use-files-linux.md)

