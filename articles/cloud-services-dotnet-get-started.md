<properties pageTitle="Начинаем работу с облачными службами Azure и ASP.NET" metaKeywords="Azure tutorial, Azure storage tutorial, Azure multi-tier tutorial, MVC Web Role tutorial, Azure worker role tutorial, Azure blobs tutorial, Azure queues tutorial" description="Узнайте, как можно создать многоуровневое приложение с помощью ASP.NET MVC и Azure. Такое приложение выполняется в облачной службе и обладает веб-ролью и рабочей ролью. В его работе используются: Entity Framework, база данных SQL, очереди хранилища Azure и BLOB-объекты." metaCanonical="" services="cloud-services,storage" documentationCenter=".NET" title="Начинаем работу с облачными службами Azure и ASP.NET" authors="tdykstra,riande" solutions="" manager="wpickett" editor="mollybos" />

<tags ms.service="cloud-services" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="dotnet" ms.topic="article" ms.date="10/27/2014" ms.author="tdykstra,riande" />

# Начинаем работу с облачными службами Azure и ASP.NET

Это руководство описывает, как создавать многоуровневое приложение .NET с внешним ASP.NET MVC и как развернуть его в [облачной службе Azure][облачной службе Azure]. Приложение использует [базу данных Azure SQL][базу данных Azure SQL], [службу BLOB-объектов Azure][службу BLOB-объектов Azure] и [службу очередей Azure][службу очередей Azure]. Можно [загрузить проект Visual Studio][загрузить проект Visual Studio] из галереи кода MSDN.

### Приложение Contoso Ads

Приложение представляет собой рекламную доску объявлений. Пользователи создают рекламу, вводя текст и загружая изображения. Они могут видеть список рекламы по эскизам изображений, и они могут видеть изображения в полном размере, когда выбирают рекламу для просмотра деталей. Ниже приведен снимок экрана:

![Список рекламы][Список рекламы]

Приложение использует [рабочий шаблон на основе очередей][службу очередей Azure] для разгрузки процессора от задач создания эскизов в фоновом режиме.

### Альтернативная архитектура: веб-сайты и веб-задания

Это руководство описывает, как запускать фоновые и интерфейсные компоненты в облачной службе Azure. Альтернативой является запуск интерфейсного компонента на [веб-сайте Azure][веб-сайте Azure] и использование [веб-заданий][веб-заданий] (пока предварительной версии) для фонового компонента. Учебник по веб-заданиям см. в разделе [Начинаем работу с Azure WebJobs SDK][Начинаем работу с Azure WebJobs SDK]. Сведения о том, как выбрать службы, см. в разделе [Сравнение веб-сайтов, облачных служб и виртуальных машин Azure][Сравнение веб-сайтов, облачных служб и виртуальных машин Azure].

### Вы узнаете:

-   Как подготовить компьютер к разработке для Azure путем установки пакета Azure SDK.
-   Как создать облачный проект Visual Studio с веб-ролью ASP.NET MVC и рабочей ролью ASP.NET MVC.
-   Как тестировать локально проект облачной службы, используя эмулятор хранилища Azure.
-   Как опубликовать облачный проект в облачной службе Azure и тестировать его с использованием учетной записи хранилища Azure.
-   Как отправлять файлы и хранить их в службе BLOB-объектов Azure.
-   Как использовать службу очередей Azure для связи между уровнями.

### Предварительные требования

В руководстве предполагается, что вы понимаете [базовые концепции облачной службы Azure][базовые концепции облачной службы Azure], такие как термины *веб-роль* и *рабочая роль*. Также предполагается, что вы знаете, как работать с проектами [ASP.NET MVC][ASP.NET MVC] или [веб-форм][веб-форм] в Visual Studio. Пример приложения использует MVC, но многое в руководство также применимо к веб-формам.

Можно запускать приложение локально без подписки Azure, но она понадобится для развертывания приложения в облаке. Если у вас нет учетной записи, можно [активировать преимущества для подписчиков MSDN][активировать преимущества для подписчиков MSDN] или [подписаться на бесплатную пробную версию][подписаться на бесплатную пробную версию].

Инструкции руководства применимы со следующими продуктами:

-   Visual Studio 2013
-   Visual Studio 2013 Express для Web

Если у вас нет одного из них, Visual Studio 2013 Express для Web установится автоматически, когда будет установлен Azure SDK.

### Разделы этого руководства

Руководство показывает, как строить и запускать приложения локально, как разворачивать его в Azure и запускать в облаке, и наконец, как создавать его с нуля. Можно начать с построения с нуля и затем выполнить шаги по тестированию и развертыванию по желанию.

-   [Архитектура приложения][Архитектура приложения]
-   [Настройка среды разработки][Настройка среды разработки]
-   [Загрузка и запуск готового решения][Загрузка и запуск готового решения]
-   [Развертывание приложения в Azure][Развертывание приложения в Azure]
-   [Создание приложения с самого начала][Создание приложения с самого начала]
-   [Диагностика][Диагностика] (перейдите сюда, если сталкиваетесь с проблемами при запуске примера)
-   [Дальнейшие действия][Дальнейшие действия]

## Архитектура приложения

Приложение хранит рекламу в базе данных SQL, используя Entity Framework Code First для создания таблиц и доступа к данным. Для каждой части рекламы база данных хранит два URL-адреса: один для полноразмерного изображения, другой для эскиза.

![Таблица рекламы][Таблица рекламы]

Когда пользователь отправляет изображение, внешнее приложение, работающее в веб-роли, сохраняет его в [большой двоичный объект Azure][службу BLOB-объектов Azure], а информацию о рекламе с URL-адресом, который указывает на большой двоичный объект, — в базе данных. В это же время оно записывает сообщение в очередь Azure. Фоновый процесс, работающий в рабочей роли, периодически опрашивает очередь о новых сообщениях. Когда появляется новое сообщение, рабочая роль создает эскиз для изображения и обновляет поле базы данных с URL-адресом эскиза для этой рекламы. Вот диаграмма, которая показывает, как взаимодействуют части приложения:

![Архитектура Contoso Ads][Архитектура Contoso Ads]

[WACOM.INCLUDE [установка-sdk-2013-только](../includes/install-sdk-2013-only.md)]

## Загрузка и запуск готового решения

1.  Загрузите и распакуйте [готовое решение][загрузить проект Visual Studio].

2.  Запустите Visual Studio.

3.  В меню **Файл** выберите **Открыть проект**, перейти к папке, куда вы загрузили решение, а затем откройте файл решения.

4.  Чтобы построить решение, нажмите CTRL+SHIFT+B.

    По умолчанию Visual Studio автоматически запускает содержимое пакета NuGet, которое не включено в файл *.zip* Если пакеты не восстановлены, установите их вручную, перейдя к диалогу **Управление пакетами для NuGet решения** и нажав кнопку **Восстановить** вверху справа.

5.  В **обозревателе решений** убедитесь, что **ContosoAdsCloudService** выбран в качестве запускаемого проекта.

6.  Для запуска приложения нажмите сочетание клавиш CTRL+F5.

    Когда запускаете локально проект облачной службы, Visual Studio автоматически вызывает *эмулятор вычислений* Azure и *эмулятор хранилища* Azure. Эмулятор хранилища использует ресурсы компьютера для эмуляции сред рабочей и веб-ролей. Эмулятор хранилища использует базу данных [SQL Server Express LocalDB][SQL Server Express LocalDB] для эмуляции работы хранилища Azure в облаке.

    При первом запуске проекта облачной службы, запуск эмулятора займет минуту или около того. После завершения работы эмулятора стандартный браузер открывается с домашней страницей приложения.

    ![Архитектура Contoso Ads][1]

7.  Нажмите кнопку **Create an Ad**.

8.  Введите тестовые данные, выберите файл изображения с расширением *.jpg*, предназначенный для загрузки, и нажмите **Создать**.

    ![Страница создания][Страница создания]

    Приложение переходит к странице индексации, но не показывает эскиз для новой рекламы, поскольку индексирование еще не проводилось.

9.  Подождите немного и затем обновите страницу индексации, чтобы увидеть эскиз.

    ![Страница индексации][Список рекламы]

10. Щелкните **Details**, чтобы увидеть рекламу в полный размер.

    ![Страница сведений][Страница сведений]

Приложение запущено полностью локально, без соединения с облаком. Эмулятор хранилища сохраняет очередь и данные большого двоичного объекта в базе данных SQL Server Express LocalDB, и приложение хранит данные рекламы в другой базе данных LocalDB. Entity Framework Code First автоматически создает базу данных рекламы в первый раз при обращении приложения к ней.

В следующем разделе будет настроено решение для использования ресурсов облака Azure для очередей, больших двоичных объектов и базы данных приложения, когда оно работает в облаке. При желании можно запускать приложение локально и далее, но можно делать это, используя облачные ресурсы хранилища и базы данных. Все зависит только от задания строк подключения, что показано далее.

## Развертывание приложения в Azure

Чтобы запустить приложение в облаке, выполните следующие действия:

-   Создание облачной службы Azure
-   Создание базы данных SQL Azure
-   Создание учетной записи хранения Azure
-   Настройка приложения для использования базы данных Azure SQL, когда оно работает в облаке Azure
-   Настройка приложения для использования вашей учетной записи хранения при запуске в Azure
-   Развертывание проекта в облачной службе Azure

### Создание облачной службы Azure

Облачная служба Azure — это среда, в которой запускают приложение.

1.  Откройте в браузере [портал управления Azure][портал управления Azure].

2.  Щелкните **Создать** и **Вычисления**, выберите пункт **Облачная служба**, а затем щелкните **Быстрое создание**.

3.  В поле ввода URL-адреса введите префикс URL-адреса.

    Этот URL-адрес должен быть уникальным. Появится сообщение об ошибке, если выбранный префикс уже где-то использован.

4.  Задайте регион, в котором требуется развернуть приложение.

    Это поле указывает, в каком центре обработки данных будет размещена облачная служба. Для рабочего приложения выбирают регион, ближайший к потребителям. Выберите здесь ближайший к вам регион.

5.  Выберите **Создать облачную службу**.

    На следующем рисунке создается облачная служба с использованием URL-адреса contosoads.cloudapp.net.

    ![Новая облачная служба][Новая облачная служба]

### Создание базы данных SQL Azure

Когда приложение запускается в облаке, оно использует расположенную в облаке базу данных.

1.  Войдите на портал управления Azure и последовательно выберите пункты **Создать**, **Службы данных**, **База данных SQL**, **Быстрое создание**.

2.  В поле **Имя базы данных** введите *contosoads*.

3.  В списке **Сервер** выберите **Создать сервер базы данных SQL**.

    Если в подписке уже есть сервер, можно выбрать его в раскрывающемся списке.

4.  Выберите тот же **Регион**, что и для облачной службы.

    Когда облачная служба и база данных находятся в разных центрах обработки данных (различных регионах), увеличивается задержка и вам потребуется оплачивать пропускную способность за пределами центра обработки данных. Пропускная способность в рамках центра обработки данных предоставляется бесплатно.

5.  Введите **Имя для входа в систему** и **Пароль** администратора.

    Если выбрано действие **Создать сервер базы данных SQL**, не используйте здесь существующие имя и пароль, введите новые, которые в дальнейшем будут использоваться при обращении к базе данных. Если выбран созданный ранее сервер, появится запрос на ввод пароля для ранее созданной административной учетной записи.

6.  Щелкните **Создать базу данных SQL**.

    ![Новая база данных SQL][Новая база данных SQL]

7.  После создания базы данных с помощью Azure откройте вкладку **Базы данных SQL** в левой области портала, а затем щелкните по имени новой базы данных.

8.  Щелкните вкладку **Панель мониторинга**.

9.  Щелкните **Управление разрешенными IP-адресами**.

10. В разделе **Разрешенные службы** измените значение параметра **Службы Azure** на **Да**.

11. Щелкните **Сохранить**.

### Создание учетной записи хранения Azure

Учетная запись хранилища Azure обеспечивает ресурсы для хранения данных очередей и больших двоичных объектов в облаке.

В реальном приложении обычно создают отдельные учетные записи для данных приложения и данных журналов, а также отдельные учетные записи для тестовых данных и рабочих данных. В этом учебнике будет использоваться одна запись.

1.  Войдите на портал управления Azure и последовательно выберите пункты **Создать**, **Службы данных**, **Хранилище**, **Быстрое создание**.

2.  В поле ввода **URL-адреса** введите префикс URL-адреса.

    Этот префикс в сочетании с текстом, который отображается под полем, будет уникальным URL-адресом для вашей учетной записи хранения. Если введенный префикс уже использован где-либо, придется выбрать другой.

3.  В раскрывающемся списке **Регион** выберите тот же регион, который выбрали для веб-сайта.

    Когда облачная служба и учетная запись хранения находятся в разных центрах обработки данных (различных областях), увеличивается задержка и вам потребуется оплачивать пропускную способность за пределами центра обработки данных. Пропускная способность в рамках центра обработки данных предоставляется бесплатно.

    Территориальные группы Azure обеспечивают механизм для минимизации расстояния между ресурсами в центре обработки данных, что позволяет уменьшить задержку. В этом учебнике территориальные группы не используются. Дополнительные сведения см. в разделе [Создание территориальной группы в Azure][Создание территориальной группы в Azure].

4.  В раскрывающемся списке **Репликация** установите значение **Локально избыточное**.

    При включении георепликации для учетной записи хранения хранящиеся данные реплицируются в дополнительный центр обработки данных для обеспечения возможности отработки отказа в это расположение в случае крупной аварии в основном расположении. Георепликация может потребовать дополнительных затрат. Для учетных записей тестирования и разработки оплачивать георепликацию обычно не требуется. Дополнительные сведения см. в разделе [Управление учетными записями хранения][Управление учетными записями хранения].

5.  Щелкните **Создать учетную запись хранения**.

    ![Новая учетная запись хранения][Новая учетная запись хранения]

    На следующем рисунке показано создание учетной записи хранилища с URL-адресом `contosoads.core.windows.net`.

### Настройка приложения для использования базы данных Azure SQL, когда оно работает в облаке Azure

Веб-проект и проект рабочей роли имеют свои строки подключения к базе данных, и обе они должны указывать на базу данных SQL Azure, когда приложение работает в Azure.

Мы используем [преобразование Web.config][преобразование Web.config] для веб-роли и настройку среды облачной службы для рабочей роли.

> [WACOM.NOTE] В этом разделе и следующем учетные данные хранятся в файлах проекта. [Не сохраняйте важные данные в общедоступном репозитории исходного кода][Не сохраняйте важные данные в общедоступном репозитории исходного кода].

1.  В проекте ContosoAdsWeb откройте файл преобразования *Web.Release.config* для файла приложения *Web.config*, удалите блок комментариев с элементом `<connectionStrings>` и вставьте вместо него следующий код.

        <connectionStrings>
            <add name="ContosoAdsContext" connectionString="{connectionstring}"
            providerName="System.Data.SqlClient" xdt:Transform="SetAttributes" xdt:Locator="Match(name)"/>
        </connectionStrings>

    Оставьте файл открытым для редактирования.

2.  На портале управления Azure щелкните **Базы данных SQL** в левой панели, щелкните созданную базу данных для этого руководства, щелкните вкладку **Панель мониторинга**, а затем — **Показать строки подключения**.

    ![Показать строки подключения][Показать строки подключения]

    Портал выведет строки подключения со звездочками вместо пароля.

    ![Строки подключения][Строки подключения]

3.  В файле преобразования *Web.Release.config* удалите `{connectionstring}` и вставьте на это место строку подключения ADO.NET с портала управления.

4.  В строке подключения, вставленной в файл преобразования *Web.Release.config*, замените `{your_password_here}` паролем, созданным для новой базы данных SQL.

5.  Сохраните файл.

6.  Выберите и скопируйте строку подключения (без знаков кавычек) для использования на следующих шагах настройки проекта с рабочей ролью.

7.  В разделе **Роли** **обозревателя решений** щелкните правой кнопкой мыши **ContosoAdsWorker** и выберите пункт **Свойства**.

    ![Свойства роли][Свойства роли]

8.  Перейдите на вкладку **Параметры**.

9.  Измените **конфигурацию службы** на **Облако**.

10. Выберите текст в параметре `ContosoAdsDbConnectionString` и вставьте строку подключения, которую скопировали в предыдущем разделе руководства.

    ![Строка подключения базы данных для рабочей роли][Строка подключения базы данных для рабочей роли]

11. Сохраните изменения.

### Настройка приложения для использования вашей учетной записи хранения при запуске в Azure

Строки подключения учетной записи хранения Azure для проектов рабочей роли и веб-роли сохраняются в настройках среды в проекте облачной службы. Для каждого проекта используется отдельный набор настроек, если приложение запущено локально или в облаке. Следует обновить настройки облачной среды для проектов рабочей роли и веб-роли.

1.  В **Обозревателе решений** щелкните правой кнопкой мыши элемент **ContosoAdsWeb** в области **Роли** проекта **ContosoAdsCloudService**, а затем щелкните пункт **Свойства**.

    ![Свойства роли][2]

2.  Перейдите на вкладку **Параметры**. В раскрывающемся списке **Конфигурация службы** выберите значение **Облако**.

    ![Конфигурация облака][Конфигурация облака]

3.  Выберите запись **StorageConnectionString**, и вы увидите кнопку с многоточием (**...**) в правом конце строки. Нажмите эту кнопку с многоточием, чтобы открыть диалоговое окно **Создание строки подключения учетной записи хранения**.

    ![Откройте окно создания строки подключения][Откройте окно создания строки подключения]

4.  В диалоговом окне **Создать строку подключения хранилища** щелкните переключатель **Подключиться, используя подписку**, выберите учетную запись, созданную ранее, и нажмите кнопку **ОК**. Если вы еще не вошли, появится запрос на ввод учетных данных Azure.

    ![Создайте строку подключения хранилища][Создайте строку подключения хранилища]

5.  Сохраните изменения.

6.  Следуйте той же процедуре, которую использовали для строки подключения `StorageConnectionString`, чтобы задать строку подключения `Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString`.

    Эта строка подключения используется для журнала.

7.  Выполните ту же процедуру, которую использовали для роли **ContosoAdsWeb**, чтобы задать строки подключения для роли **ContosoAdsWorker**. Измените **конфигурацию службы** на **Облако**.

Настройки среды роли, которые были заданы с использованием интерфейса Visual Studio, сохраняются в следующих файлах в проекте ContosoAdsCloudService:

-   *ServiceDefinition.csdef* - определяет имена настроек.
-   *ServiceConfiguration.Cloud.cscfg* - предоставляет значения для приложения при запуске в облаке.
-   *ServiceConfiguration.Cloud.cscfg* - предоставляет значения для приложения при локальном запуске.

Например, ServiceDefinition.csdef включает такие определения:

        <ConfigurationSettings>
          <Setting name="StorageConnectionString" />
          <Setting name="ContosoAdsDbConnectionString" />
        </ConfigurationSettings>

Файл *ServiceConfiguration.Cloud.cscfg* включает значения, которые были введены для этих настроек в Visual Studio:

        <Role name="ContosoAdsWorker">
          <Instances count="1" />
          <ConfigurationSettings>
            <Setting name="StorageConnectionString" value="{yourconnectionstring}" />
            <Setting name="ContosoAdsDbConnectionString" value="{yourconnectionstring}" />
            <!-- other settings not shown -->
          </ConfigurationSettings>
          <!-- other settings not shown -->
        </Role>

Параметр `<Instances>` задает число виртуальных машин, которые Azure запустит для исполнения кода рабочей роли. В раздел [Дальнейшие действия][Дальнейшие действия] включены ссылки на дополнительную информацию по масштабированию вширь облачной службы.

### Развертывание проекта в Azure

1.  В **обозревателе решений** щелкните правой кнопкой мыши проект **ContosoAdsCloudService** и выберите **Опубликовать**.

    ![Меню публикации][Меню публикации]

2.  На этапе **Зарегистрироваться** в мастере **Публикация приложения Windows Azure** щелкните **Далее**.

    ![Этап входа][Этап входа]

3.  На этапе **Настройки** мастера щелкните **Далее**.

    ![Этап настроек][Этап настроек]

    Заданные на вкладке **Дополнительно** значения по умолчанию подходят для работы с этим учебником. Дополнительные сведения о вкладке "Дополнительно" см. в разделе [Мастер публикации приложения Azure][Мастер публикации приложения Azure].

4.  На этапе **Сводка** щелкните **Опубликовать**.

    ![Сводка действий][Сводка действий]

В Visual Studio открывается окно **Журнал действий Azure**.

1.  Нажмите значок со стрелкой вправо, чтобы развернуть сведения о развертывании.

    Развертывание может занять около 5 минут и более.

    ![Окно журнал действий Azure][Окно журнал действий Azure]

2.  После завершения развертывания щелкните элемент **URL-адрес веб-сайта** для запуска приложения.

3.  Можно теперь протестировать приложение, создавая, просматривая и редактируя некоторые элементы рекламы так же, как это происходило при локальном запуске приложения.

> [WACOM.NOTE] После завершения тестирования удалите или остановите облачную службу. Даже если облачная служба не используется, плата за нее начисляется, поскольку ресурсы виртуальной машины для нее зарезервированы. Если оставить ее работающей, любой кто найдет этот URL-адрес, сможет создать и просмотреть рекламу. На портале управления Azure перейдите на вкладку **Панель мониторинга** для облачной службы и нажмите кнопку **Удалить** внизу страницы. Если необходимо временно предотвратить доступ посторонних к сайту, вместо этого щелкните **Остановить**. В этом случае плата будет взиматься. Можно повторить эту же процедуру для удаления базы данных SQL и учетной записи хранилища, если они больше не нужны.

## Создание приложения с самого начала

Если
[завершенное приложение][загрузить проект Visual Studio] еще не загружено, сделайте это сейчас. Скопируйте файлы из загруженного проекта в новый проект.

Создание приложения Contoso Ads состоит из следующих шагов:

-   Создайте новое решение облачной службы в Visual Studio
-   Обновите и добавьте пакеты NuGet
-   Установите ссылки проекта
-   Настройте строки подключения
-   Добавьте файлы кода

После создания решения просмотрите код, уникальный для проектов облачных служб, больших двоичных объектов и очередей Azure.

### Создайте новое решение облачной службы в Visual Studio

1.  В Visual Studio выберите **Новый проект** в меню **Файл**.

2.  В левой панели диалогового окна **Новый проект** разверните **Visual C\#** и выберите шаблоны **Облако**, а затем выберите шаблон **Облачная служба Windows Azure**.

3.  Присвойте проекту имя ContosoAdsCloudService и нажмите кнопку **ОК**.

    ![Новый проект][Новый проект]

4.  В диалоговом окне **Новая облачная служба Azure** добавьте веб-роль и рабочую роль. Присвойте веб-роли имя ContosoAdsWeb, а рабочей роли — ContosoAdsWorker. (Используйте значок карандаша на правой панели для изменения имен ролей по умолчанию.)

    ![Проект новой облачной службы][Проект новой облачной службы]

5.  Когда появится диалоговое окно **Новый проект ASP.NET** для веб-роли, выберите шаблон MVC и щелкните **Изменить проверку подлинности**.

    ![Измените проверку подлинности][Измените проверку подлинности]

6.  В диалоговом окне "Изменить проверку подлинности" щелкните **Без проверки** и нажмите кнопку **ОК**.

    ![Без аутентификации][Без аутентификации]

7.  В диалоговом окне **Новый проект ASP.NET** нажмите кнопку **ОК**.

8.  в **обозревателе решений** щелкните правой кнопкой мыши решение (не проект) и выберите **Добавить новый проект**.

9.  В диалоговом окне **Добавление нового проекта** выберите **Настольная ОС Windows** в разделе **Visual C\#** в левой панели, а затем щелкните шаблон **Библиотека классов**.

10. Присвойте проекту имя *ContosoAdsCommon* и нажмите кнопку **ОК**.

    Необходимо сослаться на контекст и модель данных Entity Framework в обоих проектах — веб-роли и рабочей роли. Как вариант, можно определить связанные с EF классы в проекте веб-роли и сослаться на этот проект из проекта рабочей роли. Но при этом в проекте рабочей роли будет ссылка на веб-сборки, которые ему не нужны.

### Обновите и добавьте пакеты NuGet

1.  Откройте диалоговое окно **Управление пакетами NuGet** для решения.

2.  В левой области щелкните **Обновления**.

3.  Найдите пакет *Хранилище Azure*, а если его нет в списке, щелкните **Обновить** для получения последней версии клиентской библиотеки хранилища.

    ![Обновление SCL][Обновление SCL]

    Клиентская библиотека хранилища обновляется чаще, чем шаблоны проектов Visual Studio, поэтому часто происходит так, что версию во вновь создаваемых проектах необходимо обновить.

4.  В левой области щелкните **В сети**.

5.  Найдите пакет NuGet *EntityFramework* и установите его во все проекты.

### Установите ссылки проекта

1.  Задайте в проекте ContosoAdsWeb ссылку на проект ContosoAdsCommon. Щелкните правой кнопкой мыши проект ContosoAdsWeb и выберите пункты **Ссылки** — **Добавить ссылку**. В диалоговом окне **Диспетчер ссылок** выберите пункты **Решение — Проекты** в левой панели, выберите ContosoAdsCommon и затем нажмите **ОК**.

2.  Задайте в проекте ContosoAdsWorker ссылку на проект ContosoAdsCommon.

    ContosoAdsCommon будет содержать модель данных и контекстный класс Entity Framework, который будет использован как фоновой, так и интерфейсной службой.

3.  Задайте в проекте ContosoAdsWorker ссылку на `System.Drawing`.

    Сборка используется внутренней службой для преобразования изображений в эскизы.

### Настройте строки подключения

В этом разделе настройте хранилище Azure и строки подключения SQL для локального тестирования. Инструкции по развертыванию ранее в этом руководстве объясняют, как установить строки подключения в случае, когда приложение работает в облаке.

1.  В проекте ContosoAdsWeb откройте файл приложения Web.config и вставьте следующий элемент `connectionStrings` после элемента `configSections`:

        <connectionStrings>
          <add name="ContosoAdsContext" connectionString="Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;" providerName="System.Data.SqlClient" />
        </connectionStrings>

2.  Сохраните изменения.

3.  В проекте ContosoAdsCloudService щелкните правой кнопкой мыши ContosoAdsWeb в разделе **Роли**, а затем щелкните **Свойства**.

    ![Свойства роли][2]

4.  В окне свойств **ContosAdsWeb [роль]** щелкните вкладку **Настройки** и затем щелкните **Добавить настройку**.

    Оставьте **конфигурацию службы** установленной как **Все конфигурации**.

5.  Добавьте новую настройку с именем *StorageConnectionString*. Задайте **Тип** как *ConnectionString* и установите **Значение** как *UseDevelopmentStorage=true*.

    ![Новая строка подключения][Новая строка подключения]

6.  Сохраните изменения.

7.  Следуйте этой же процедуре для добавления строки подключения хранилища в свойства роли ContosoAdsWorker.

8.  Там же в окне свойств **ContosoAdsWorker [роль]** добавьте другую строку подключения:

    -   Имя: ContosoAdsDbConnectionString
    -   Введите: Строка
    -   Значение: вставьте ту же строку подключения, что была использована для проекта веб-роли.

            Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;

### Добавьте файлы кода

В этом разделе скопируйте файлы кода из загруженного решения в новое решение. Следующие разделы покажут и объяснят важные части этого кода.

Чтобы добавить файлы в проект или папку, щелкните правой кнопкой мыши проект или папку и щелкните **Добавить** - **Существующий элемент**. Выберите необходимые файлы и щелкните **Добавить**. При запросе о том, заменять ли существующие файлы, щелкните **Да**.

1.  В проекте ContosoAdsCommon удалите файл *Class1.cs* и добавьте на его место файлы *Ad.cs* и *ContosoAdscontext.cs* из загруженного проекта.

2.  В проекте ContosoAdsCommon добавьте следующие файлы из загруженного проекта.

    -   *Global.asax.cs*
    -   В папку *Views\\Shared*: *\_Layout.cshtml*.
    -   В папку *Views\\Home*: *Index.cshtml*.
    -   В папку *Controllers*: *AdController.cs*.
    -   В папку *Views\\Ad* (вначале создайте эту папку): пять файлов *.cshtml*.

3.  В проекте ContosoAdsCommon добавьте *WorkerRole.cs* из загруженного проекта.

Теперь можно создать и запустить приложение, как описывали инструкции ранее в этом руководстве, и приложение будет использовать локальные ресурсы эмуляторов базы данных и хранилища.

В следующих разделах объясняется код, связанный с работой среды Azure, больших двоичных объектов и очередей. В руководстве не объясняется, как создавать контроллеры и представления MVC, используя формирование шаблонов, как писать код Entity Framework, который работает с базой данных SQL Server, или основы асинхронного программирования в ASP.NET 4.5. Сведения по этим темам смотрите в следующих ресурсах:

-   [Начинаем работу с MVC 5][ASP.NET MVC]
-   [Начинаем работу с EF 6 и MVC 5][Начинаем работу с EF 6 и MVC 5]
-   [Введение в асинхронное программирование в .NET 4.5][Введение в асинхронное программирование в .NET 4.5]

### ContosoAdsCommon - Ad.cs

Файл Ad.cs определяет перечисляемый тип для класса Ad и класс сущностей POCO для информации в рекламе.

        public enum Category
        {
            Cars,
            [Display(Name="Real Estate")]
            RealEstate,
            [Display(Name = "Free Stuff")]
            FreeStuff
        }

        public class Ad
        {
            public int AdId { get; set; }

            [StringLength(100)]
            public string Title { get; set; }

            public int Price { get; set; }

            [StringLength(1000)]
            [DataType(DataType.MultilineText)]
            public string Description { get; set; }

            [StringLength(1000)]
            [DisplayName("Full-size Image")]
            public string ImageURL { get; set; }

            [StringLength(1000)]
            [DisplayName("Thumbnail")]
            public string ThumbnailURL { get; set; }

            [DataType(DataType.Date)]
            [DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}", ApplyFormatInEditMode = true)]
            public DateTime PostedDate { get; set; }

            public Category? Category { get; set; }
            [StringLength(12)]
            public string Phone { get; set; }
        }

### ContosoAdsCommon - ContosoAdsContext.cs

Класс ContosoAdsContext указывает, что класс Ad используется коллекцией DbSet, которую Entity Framework хранит в базе данных SQL.

        public class ContosoAdsContext : DbContext
        {
            public ContosoAdsContext() : base("name=ContosoAdsContext")
            {
            }
            public ContosoAdsContext(string connString)
                : base(connString)
            {
            }
            public System.Data.Entity.DbSet<Ad> Ads { get; set; }
        }

Класс имеет два конструктора. Первый из них используется веб-проектом и указывает имя строки подключения, которая сохранена в файле Web.config Второй конструктор дает возможность передачи действующей строки подключения. Это необходимо проекту рабочей роли, поскольку он не имеет файла Web.config. Ранее было показано, где хранится строка подключения, а потом будет показано, как код извлекает строку подключения, когда он создает экземпляр класса DbContext.

### ContosoAdsWeb - Global.asax.cs

Код, который вызывается из метода `Application_Start`, создает контейнер большого двоичного объекта *images* и очередь *images*, если они еще не существуют. Это гарантирует, что при начале использования новой учетной записи хранилища или эмулятора хранилища на новом компьютере требуемый контейнер больших двоичных объектов и очередь создаются автоматически.

Код получает доступ к учетной записи хранилища, используя строку подключения из файла *.cscfg*.

        var storageAccount = CloudStorageAccount.Parse
            (RoleEnvironment.GetConfigurationSettingValue("StorageConnectionString"));

Затем он получает ссылку на контейнер больших двоичных объектов *images*, создает контейнер, если он еще не существует, и устанавливает разрешения доступа к новому контейнеру. По умолчанию новые контейнеры разрешают доступ к большим двоичным объектам только клиентам с учетными данными записи хранилища. Веб-сайту требуются общедоступные большие двоичные объекты, чтобы он мог выводить изображения с использованием URL-адресов, которые указывают на объекты изображений.

        var blobClient = storageAccount.CreateCloudBlobClient();
        var imagesBlobContainer = blobClient.GetContainerReference("images");
        if (imagesBlobContainer.CreateIfNotExists())
        {
            imagesBlobContainer.SetPermissions(
                new BlobContainerPermissions
                {
                    PublicAccess =BlobContainerPublicAccessType.Blob
                });
        }

Аналогичный код получает ссылку на очередь *images* и создает новую очередь В этом случае изменений разрешений не требуется.

        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
        var imagesQueue = queueClient.GetQueueReference("images");
        imagesQueue.CreateIfNotExists();

### ContosoAdsWeb - \_Layout.cshtml

Файл \*\_Layout.cshtml\* устанавливает имя приложения в заголовке и нижнем колонтитуле и создает запись меню "Ads".

### ContosoAdsWeb - Views\\Home\\Index.cshtml

Файл *Views\\Home\\Index.cshtml* выводит ссылки категорий на домашней странице. Ссылки передают целое значение перечисляемого типа `Category` в переменную querystring на странице индекса Ads.

        <li>@Html.ActionLink("Cars", "Index", "Ad", new { category = (int)Category.Cars }, null)</li>
        <li>@Html.ActionLink("Real estate", "Index", "Ad", new { category = (int)Category.RealEstate }, null)</li>
        <li>@Html.ActionLink("Free stuff", "Index", "Ad", new { category = (int)Category.FreeStuff }, null)</li>
        <li>@Html.ActionLink("All", "Index", "Ad", null, null)</li>

### ContosoAdsWeb - AdController.cs

В файле *AdController.cs* конструктор вызывает метод `InitializeStorage` для создания объектов клиентской библиотеки хранилища Azure, который предоставляет API для работы с большими двоичными объектами и очередями.

Затем код получает ссылку на контейнер больших двоичных объектов *images*, как показано ранее в *Global.asax.cs*. При этом он устанавливает [политику повторения][политику повторения] по умолчанию, подходящую для веб-приложения. Политика повторения с экспоненциальной задержкой по умолчанию может застопорить веб-приложение более чем на минуту при повторяющихся повторах во время кратковременного сбоя. Политика повторения здесь указывает ожидание в 3 секунды после каждой попытки, всего до 3 повторений.

        var blobClient = storageAccount.CreateCloudBlobClient();
        blobClient.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
        imagesBlobContainer = blobClient.GetContainerReference("images");

Аналогичный код получает ссылку на очередь *images*.

        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
        queueClient.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
        imagesQueue = queueClient.GetQueueReference("images");

Большая часть кода контроллера обычна для работы с моделью данных Entity Framework с использованием класса DbContext. Исключением является метод `Create` HttpPost, который отправляет файл и сохраняет его в хранилище больших двоичных объектов. Связыватель модели предоставляет объект [HttpPostedFileBase][HttpPostedFileBase] для метода.

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> Create(
            [Bind(Include = "Title,Price,Description,Category,Phone")] Ad ad,
            HttpPostedFileBase imageFile)

При выбора файла для отправки код отправляет его, сохраняет его в большом двоичном объекте и обновляет запись базы данных URL-адресом, который указывает на большой двоичный объект.

        if (imageFile != null && imageFile.ContentLength != 0)
        {
            blob = await UploadAndSaveBlobAsync(imageFile);
            ad.ImageURL = blob.Uri.ToString();
        }

Код отправки содержится в методе `UploadAndSaveBlobAsync`. Он создает имя GUID для большого двоичного объекта, отправляет и сохраняет файл, а также возвращает ссылку на сохраненный большой двоичный объект.

        private async Task<CloudBlockBlob> UploadAndSaveBlobAsync(HttpPostedFileBase imageFile)
        {
            string blobName = Guid.NewGuid().ToString() + Path.GetExtension(imageFile.FileName);
            CloudBlockBlob imageBlob = imagesBlobContainer.GetBlockBlobReference(blobName);
            using (var fileStream = imageFile.InputStream)
            {
                await imageBlob.UploadFromStreamAsync(fileStream);
            }
            return imageBlob;
        }

После того, как метод `Create` HttpPost отправляет большой двоичный объект и обновляет базу данных, он создает сообщение в очереди для информирования фонового процесса о том, что изображение готово для конвертации в эскиз.

        string queueMessageString = ad.AdId.ToString();
        var queueMessage = new CloudQueueMessage(queueMessageString);
        await queue.AddMessageAsync(queueMessage);

Код для метода `Edit` HttpPost аналогичен за одним исключением — если пользователь выбирает новый файл изображения, все большие двоичные объекты, которые уже существуют, должны быть удалены.

        if (imageFile != null && imageFile.ContentLength != 0)
        {
            await DeleteAdBlobsAsync(ad);
            imageBlob = await UploadAndSaveBlobAsync(imageFile);
            ad.ImageURL = imageBlob.Uri.ToString();
        }

Вот код, который удаляет большие двоичные объекты при удалении элемента рекламы:

        private async Task DeleteAdBlobsAsync(Ad ad)
        {
            if (!string.IsNullOrWhiteSpace(ad.ImageURL))
            {
                Uri blobUri = new Uri(ad.ImageURL);
                await DeleteAdBlobAsync(blobUri);
            }
            if (!string.IsNullOrWhiteSpace(ad.ThumbnailURL))
            {
                Uri blobUri = new Uri(ad.ThumbnailURL);
                await DeleteAdBlobAsync(blobUri);
            }
        }
        private static async Task DeleteAdBlobAsync(Uri blobUri)
        {
            string blobName = blobUri.Segments[blobUri.Segments.Length - 1];
            CloudBlockBlob blobToDelete = imagesBlobContainer.GetBlockBlobReference(blobName);
            await blobToDelete.DeleteAsync();
        }

### ContosoAdsWeb - Views\\Ad\\Index.cshtml и Details.cshtml

Файл *Index.cshtml* выводит эскиз с другими данными рекламы:

        <img  src="@Html.Raw(item.ThumbnailURL)" />

Файл *Details.cshtml* выводит изображение в полном размере:

        <img src="@Html.Raw(Model.ImageURL)" />

### ContosoAdsWeb - Views\\Ad\\Create.cshtml и Edit.cshtml

Файлы *Create.cshtml* и *Edit.cshtml* указывают кодирование формы, которое дает возможность контроллеру получить объект `HttpPostedFileBase`.

        @using (Html.BeginForm("Create", "Ad", FormMethod.Post, new { enctype = "multipart/form-data" }))

Элемент `<input>` сообщает браузеру, что нужно открыть диалоговое окно выбора файла.

        <input type="file" name="imageFile" accept="image/*" class="form-control fileupload" />

### ContosoAdsWorker - WorkerRole.cs - метод OnStart

Среда рабочей роли Azure вызывает метод `OnStart` в классе `WorkerRole`, когда рабочая роль начинает работу, и вызывает метод `Run`, когда метод `OnStart` завершает работу.

Метод `OnStart` получает строку подключения базы данных из файла *.cscfg* и передает ее в класс Entity Framework DbContext. Поставщик SQLClient используется по умолчанию, поэтому поставщик не нужно указывать.

        var dbConnString = CloudConfigurationManager.GetSetting("ContosoAdsDbConnectionString");
        db = new ContosoAdsContext(dbConnString);

Затем метод получит ссылку на учетную запись хранилища и создаст контейнер больших двоичных объектов и очередь, если они не существуют. Этот код похож на тот, что показан в методе `Application_Start` веб-роли.

### ContosoAdsWorker - WorkerRole.cs - метод Run

Метод `Run` вызывается, когда метод `OnStart` завершает свою начальную работу. Метод выполняет бесконечный цикл, в котором ждет новые сообщения в очереди и обрабатывает их, когда они прибывают.

        public override void Run()
        {
            CloudQueueMessage msg = null;
        
            while (true)
            {
                try
                {
                    msg = this.imagesQueue.GetMessage();
                    if (msg != null)
                    {
                        ProcessQueueMessage(msg);
                    }
                    else
                    {
                        System.Threading.Thread.Sleep(1000);
                    }
                }
                catch (StorageException e)
                {
                    if (msg != null && msg.DequeueCount > 5)
                    {
                        this.imagesQueue.DeleteMessage(msg);
                    }
                    System.Threading.Thread.Sleep(5000);
                }
            }
        }

После каждой итерации цикла, если сообщение найдено в очереди, программа останавливается на секунду. Это защищает рабочую роль от создания ненужных затрат при использовании времени процессора и транзакций в хранилище. Команда Microsoft Customer Advisory рассказывала о разработчике, который забыл включить этот функционал, развернул код в рабочей среде и ушел в отпуск. Когда он вернулся, то выяснил, что забывчивость встала ему в копеечку.

Иногда содержимое сообщения очереди вызывает ошибку при обработке. Это *ядовитое сообщение* — если ошибка только протоколируется и цикл будет перезапущен, то сообщение можно обрабатывать бесконечно. Поэтому блок catch включает правило if, которое проверяет, сколько раз приложение пыталось обработать текущее сообщение. Если уже насчитано 5 раз, сообщение удаляется из очереди.

`ProcessQueueMessage` вызывается, когда сообщение найдено в очереди.

        private void ProcessQueueMessage(CloudQueueMessage msg)
        {
            var adId = int.Parse(msg.AsString);
            Ad ad = db.Ads.Find(adId);
            if (ad == null)
            {
                throw new Exception(String.Format("AdId {0} not found, can't create thumbnail", adId.ToString()));
            }
        
            CloudBlockBlob inputBlob = this.imagesBlobContainer.GetBlockBlobReference(ad.ImageURL);
        
            string thumbnailName = Path.GetFileNameWithoutExtension(inputBlob.Name) + "thumb.jpg";
            CloudBlockBlob outputBlob = this.imagesBlobContainer.GetBlockBlobReference(thumbnailName);
        
            using (Stream input = inputBlob.OpenRead())
            using (Stream output = outputBlob.OpenWrite())
            {
                ConvertImageToThumbnailJPG(input, output);
                outputBlob.Properties.ContentType = "image/jpeg";
            }
        
            ad.ThumbnailURL = outputBlob.Uri.ToString();
            db.SaveChanges();
        
            this.imagesQueue.DeleteMessage(msg);
        }

Код читает базу данных для получения URL-адреса изображения, конвертирует изображение в эскиз, сохраняет эскиз в большой двоичный объект, добавляет в базу данных URL-адрес большого двоичного объекта эскиза и удаляет сообщение из очереди.

> [WACOM.NOTE] Код в методе `ConvertImageToThumbnailJPG` использует классы в пространстве имен System.Drawing для простоты. Однако классы в этом пространстве имен были спроектированы для использования с формами Windows. Они не поддерживаются в службе Windows или ASP.NET.

## Устранение неполадок

У вас что-то не работает, когда вы выполняете инструкции из этого руководства? Вот несколько общих ошибок и способы их устранения.

### ServiceRuntime.RoleEnvironmentException

Объект `RoleEnvironment` предоставляется Azure, когда приложение запущено в Azure или локально с использованием эмулятора вычислений Azure. Если сообщение об этой ошибке появляется при локальном выполнении, убедитесь, что проект ContosoAdsCloudService установлен как начальный. Это настраивает проект для запуска с использованием эмулятора вычислений Azure.

Одной из причин, по которым приложение использует RoleEnvironment в Azure, — это получение значений строки подключения, которые что они хранятся в файлах *.cscfg*, поэтому другой причиной этого исключения является отсутствие строки подключения. Убедитесь, что настройка StorageConnectionString создана для вариантов "Облако" и "Локально" в проекте ContosoAdsWeb, и что созданы обе строки подключения для обоих вариантов в проекте ContosoAdsWorker. Выполните поиск **Найти все** по StorageConnectionString во всем решении; запись должна появиться 9 раз в 6 файлах.

### Невозможно переопределить на порт ххх. Новый порт ниже минимально разрешенного значения 8080 для протокола http

Попробуйте изменить номер порта, используемый веб-проектом. Щелкните правой кнопкой мыши проект ContosoAdsWeb и выберите пункт **Свойства**. Щелкните вкладку **Веб** и измените номер порта в настройке **URL-адрес проекта**.

Другим вариантом может быть решение в следующем разделе.

### Другие ошибки при работе локально

По умолчанию новые проекты облачной службы используют облегченный эмулятор вычислений Azure для имитации среды Azure. Это облегченная версия полнофункционального эмулятора вычислений; при некоторых условиях полнофункциональный эмулятор будет работать, а облегченный — нет.

Для переключения проекта на использование полнофункционального эмулятора щелкните правой кнопкой мыши проект ContosoAdsCloudService и выберите **Свойства**. В окне **Свойства** щелкните вкладку **Веб** и затем выберите переключатель **Использовать полный эмулятор**.

Для запуска приложения с полным эмулятором следует открыть Visual Studio с правами администратора.

## Дальнейшие действия

Приложение Contoso Ads намеренно сделано простым для руководства по началу работы. Например, оно не реализует [вставку зависимостей][вставку зависимостей] или [репозиторий и блок рабочих шаблонов][репозиторий и блок рабочих шаблонов], не [использует интерфейс для журналов][использует интерфейс для журналов], не использует [EF Code First Migrations][EF Code First Migrations] для управления изменениями модели данных или [EF Connection Resiliency][EF Connection Resiliency] для управления кратковременными ошибками сети и т. д.

Есть несколько примеров приложений облачной службы, которые демонстрируют более жизненные примеры кодирования — от менее сложных к более сложным:

-   [PhluffyFotos][PhluffyFotos]. Похоже на Contoso Ads, но реализует больше функций и больше примеров реального кода.
-   [Многоуровневое облачное приложение Azure с таблицами, квотами, и большими двоичными объектами][Многоуровневое облачное приложение Azure с таблицами, квотами, и большими двоичными объектами]. Описывает таблицы хранилища Azure наряду с большими двоичными объектами и очередями, поставляется с [пошаговым руководством][пошаговым руководством].
-   [Основы облачных служб в Windows Azure][Основы облачных служб в Windows Azure]. Полный пример для демонстрации широкого набора приемов, применяемых группой Microsoft Patterns and Practices.

Общие сведения по разработке для облака см. в разделе [Построение реальных облачных приложений с Windows Azure][Построение реальных облачных приложений с Windows Azure].

Видеоинструкции по рекомендациям для хранилища Azure см. в разделе [Хранилище Microsoft — новости, рекомендации и шаблоны][Хранилище Microsoft — новости, рекомендации и шаблоны].

Для получения дополнительных сведений см. следующие ресурсы:

-   [Облачные службы Azure, часть 1: введение][Облачные службы Azure, часть 1: введение]
-   [Облачные службы Azure][Облачные службы Azure]
-   [Хранилище Azure][Хранилище Azure]
-   [Использование хранилища BLOB-объектов из .NET][Использование хранилища BLOB-объектов из .NET]
-   [Использование хранилища очередей из .NET][Использование хранилища очередей из .NET]

  [облачной службе Azure]: /ru-ru/documentation/articles/fundamentals-application-models/#CloudServices
  [базу данных Azure SQL]: http://msdn.microsoft.com/library/azure/ee336279
  [службу BLOB-объектов Azure]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage
  [службу очередей Azure]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern
  [загрузить проект Visual Studio]: http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4
  [Список рекламы]: ./media/cloud-services-dotnet-get-started/list.png
  [веб-сайте Azure]: /ru-ru/services/web-sites/
  [веб-заданий]: http://go.microsoft.com/fwlink/?LinkId=390226
  [Начинаем работу с Azure WebJobs SDK]: /ru-ru/documentation/articles/websites-dotnet-webjobs-sdk-get-started/
  [Сравнение веб-сайтов, облачных служб и виртуальных машин Azure]: http://azure.microsoft.com/ru-ru/documentation/articles/choose-web-site-cloud-service-vm/
  [базовые концепции облачной службы Azure]: http://azure.microsoft.com/ru-ru/documentation/articles/fundamentals-application-models/#CloudServices
  [ASP.NET MVC]: http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started
  [веб-форм]: http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview
  [активировать преимущества для подписчиков MSDN]: /ru-ru/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A55E3C668
  [подписаться на бесплатную пробную версию]: /ru-ru/pricing/free-trial/?WT.mc_id=A55E3C668
  [Архитектура приложения]: #application-architecture
  [Настройка среды разработки]: #setupdevenv
  [Загрузка и запуск готового решения]: #download-and-run-the-completed-solution
  [Развертывание приложения в Azure]: #deploy-the-application-to-azure
  [Создание приложения с самого начала]: #create-the-application-from-scratch
  [Диагностика]: #troubleshooting
  [Дальнейшие действия]: #next-steps
  [Таблица рекламы]: ./media/cloud-services-dotnet-get-started/adtable.png
  [Архитектура Contoso Ads]: ./media/cloud-services-dotnet-get-started/apparchitecture.png
  [SQL Server Express LocalDB]: http://msdn.microsoft.com/ru-ru/library/hh510202.aspx
  [1]: ./media/cloud-services-dotnet-get-started/home.png
  [Страница создания]: ./media/cloud-services-dotnet-get-started/create.png
  [Страница сведений]: ./media/cloud-services-dotnet-get-started/details.png
  [портал управления Azure]: http://manage.windowsazure.com
  [Новая облачная служба]: ./media/cloud-services-dotnet-get-started/newcs.png
  [Новая база данных SQL]: ./media/cloud-services-dotnet-get-started/newdb.png
  [Создание территориальной группы в Azure]: http://msdn.microsoft.com/ru-ru/library/jj156209.aspx
  [Управление учетными записями хранения]: /ru-ru/documentation/articles/storage-manage-storage-account/
  [Новая учетная запись хранения]: ./media/cloud-services-dotnet-get-started/newstorage.png
  [преобразование Web.config]: http://www.asp.net/mvc/tutorials/deployment/visual-studio-web-deployment/web-config-transformations
  [Не сохраняйте важные данные в общедоступном репозитории исходного кода]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets
  [Показать строки подключения]: ./media/cloud-services-dotnet-get-started/showcs.png
  [Строки подключения]: ./media/cloud-services-dotnet-get-started/connstrings.png
  [Свойства роли]: ./media/cloud-services-dotnet-get-started/rolepropertiesworker.png
  [Строка подключения базы данных для рабочей роли]: ./media/cloud-services-dotnet-get-started/workerdbcs.png
  [2]: ./media/cloud-services-dotnet-get-started/roleproperties.png
  [Конфигурация облака]: ./media/cloud-services-dotnet-get-started/sccloud.png
  [Откройте окно создания строки подключения]: ./media/cloud-services-dotnet-get-started/opencscreate.png
  [Создайте строку подключения хранилища]: ./media/cloud-services-dotnet-get-started/createstoragecs.png
  [Меню публикации]: ./media/cloud-services-dotnet-get-started/pubmenu.png
  [Этап входа]: ./media/cloud-services-dotnet-get-started/pubsignin.png
  [Этап настроек]: ./media/cloud-services-dotnet-get-started/pubsettings.png
  [Мастер публикации приложения Azure]: http://msdn.microsoft.com/library/windowsazure/hh535756.aspx
  [Сводка действий]: ./media/cloud-services-dotnet-get-started/pubsummary.png
  [Окно журнал действий Azure]: ./media/cloud-services-dotnet-get-started/waal.png
  [Новый проект]: ./media/cloud-services-dotnet-get-started/newproject.png
  [Проект новой облачной службы]: ./media/cloud-services-dotnet-get-started/newcsproj.png
  [Измените проверку подлинности]: ./media/cloud-services-dotnet-get-started/chgauth.png
  [Без аутентификации]: ./media/cloud-services-dotnet-get-started/noauth.png
  [Обновление SCL]: ./media/cloud-services-dotnet-get-started/updstg.png
  [Новая строка подключения]: ./media/cloud-services-dotnet-get-started/scall.png
  [Начинаем работу с EF 6 и MVC 5]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc
  [Введение в асинхронное программирование в .NET 4.5]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async
  [политику повторения]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling
  [HttpPostedFileBase]: http://msdn.microsoft.com/ru-ru/library/system.web.httppostedfilebase.aspx
  [вставку зависимостей]: http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection
  [репозиторий и блок рабочих шаблонов]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo
  [использует интерфейс для журналов]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log
  [EF Code First Migrations]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
  [EF Connection Resiliency]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application
  [PhluffyFotos]: http://code.msdn.microsoft.com/PhluffyFotos-Sample-7ecffd31
  [Многоуровневое облачное приложение Azure с таблицами, квотами, и большими двоичными объектами]: http://code.msdn.microsoft.com/windowsazure/Windows-Azure-Multi-Tier-eadceb36
  [пошаговым руководством]: http://azure.microsoft.com/ru-ru/documentation/articles/cloud-services-dotnet-multi-tier-app-storage-1-overview/
  [Основы облачных служб в Windows Azure]: http://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649
  [Построение реальных облачных приложений с Windows Azure]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction
  [Хранилище Microsoft — новости, рекомендации и шаблоны]: http://channel9.msdn.com/Events/Build/2014/3-628
  [Облачные службы Azure, часть 1: введение]: http://justazure.com/microsoft-azure-cloud-services-part-1-introduction/
  [Облачные службы Azure]: /ru-ru/documentation/services/cloud-services/
  [Хранилище Azure]: /ru-ru/documentation/services/storage/
  [Использование хранилища BLOB-объектов из .NET]: /ru-ru/documentation/articles/storage-dotnet-how-to-use-blobs/
  [Использование хранилища очередей из .NET]: /ru-ru/documentation/articles/storage-dotnet-how-to-use-queues/
