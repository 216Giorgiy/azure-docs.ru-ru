<properties
   pageTitle="Использование ключей SSH с Hadoop в HDInsight на платформе Linux из Linux, Unix или OS X | Azure"
   description="Узнайте, как создавать и использовать ключи SSH для аутентификации в кластерах HDInsight на основе Linux."
   services="hdinsight"
   documentationCenter=""
   authors="Blackmist"
   manager="paulettm"
   editor="cgronlun"/>

<tags
   ms.service="hdinsight"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="big-data"
   ms.date="03/20/2015"
   ms.author="larryfr"/>

#Использование SSH с Hadoop в HDInsight на платформе Linux в Linux, Unix или OS X (предварительная версия)

> [AZURE.SELECTOR]
- [Windows](hdinsight-hadoop-linux-use-ssh-windows.md)
- [Linux, Unix, OS X](hdinsight-hadoop-linux-use-ssh-unix.md)

Кластеры Azure HDInsight под управлением Linux предоставляют возможность защиты доступа по протоколу Secure Shell с помощью пароля или ключа SSH. В этом документе содержатся сведения об использовании SSH с HDInsight из клиентов OS X, Linux и Unix.

> [AZURE.NOTE]При описаний действий в данной статье предполагается, что вы используете клиент OS X, Linux или Unix. Хотя то же самое можно сделать и на клиентах Windows после установки пакета, который предоставляет `ssh` и `ssh-keygen` (например, Git для Windows), на таких клиентах рекомендуется выполнить действия, описанные в статье [Использование SSH с кластерами HDInsight (Hadoop) под управлением Linux в Windows](hdinsight-hadoop-linux-use-ssh-windows.md).

##Предварительные требования

* **ssh-keygen** и **ssh** для клиентов Linux, Unix и OS X. Эти служебные программы обычно входят в состав операционной системы или доступны через систему управления пакетами.

* Современный веб-браузер, который поддерживает HTML5.

ИЛИ

* [Интерфейс командной строки Azure для Mac, Linux и Windows](xplat-cli.md).

##Что такое SSH?

SSH — это служебная программа для входа в систему и удаленного выполнения команд на удаленном сервере. Используя HDInsight под управлением Linux, SSH устанавливает безопасное подключение к головному узлу кластера и предоставляет окно командной строки, используемое для ввода команд. Команды выполняются непосредственно на сервере.

##Создание ключа SSH (необязательно)

При создании кластера HDInsight под управлением Linux в случае использования SSH вы можете использовать пароль или ключ SSH для аутентификации на сервере. Ключи SSH считаются более надежными, так как они основаны на сертификатах. Если вы планируете использовать ключи SSH на своем кластере, используйте следующую информацию.

1. Откройте сеанс терминала и введите следующую команду, чтобы определить наличие существующих ключей SSH:

		ls -al ~/.ssh

	Найдите следующие файлы в листинге каталога. Это общие имена для открытых ключей SSH.

	* id_dsa.pub
	* id_ecdsa.pub
	* id_ed25519.pub
	* id_rsa.pub

2. Если вы не хотите использовать существующий файл или у вас нет ключей SSH, создайте новый ключ с помощью следующей команды:

		ssh-keygen -t rsa

	Вам будет предложено ввести следующую информацию:

	* расположение файла — по умолчанию используется ~/.ssh/id_rsa;
	* парольная фраза — появится запрос на повторный ввод.

		> [AZURE.NOTE]Мы настоятельно рекомендуем использовать безопасную парольную фразу для ключа. Однако если вы забудете парольную фразу, восстановить ее будет невозможно.

	После выполнения команды у вас будет два новых файла: закрытый ключ (например, **id_rsa**) и открытый ключ (например, **id_rsa.pub**).

##Создание кластера HDInsight на основе Linux

При создании кластера HDInsight на основе Linux необходимо предоставить открытый ключ, созданный ранее. Из клиентов OS X, Unix и Linux кластер HDInsight можно создать двумя способами:

* **Портал управления Azure** — для создания кластера используется веб-портал.

* **Интерфейс командной строки Azure для Mac, Linux и Windows** — для создания кластера используются команды командной строки.

Для каждого из этих способов потребуется пароль или открытый ключ. Полную информацию о создании кластера HDInsight под управлением Linux см. в статье <a href="/documentation/articles/hdinsight-hadoop-provision-linux-clusters/" target="_blank">Подготовка кластеров HDInsight под управлением Linux</a>.

###Портал Azure

При использовании портала для создания кластера HDInsight под управлением Linux необходимо ввести значение в поле **ИМЯ ПОЛЬЗОВАТЕЛЯ SSH** и выбрать параметр **ПАРОЛЬ** или **ОТКРЫТЫЙ КЛЮЧ SSH**, для которых необходимо ввести значение. Если выбран параметр **ОТКРЫТЫЙ КЛЮЧ SSH**, необходимо вставить открытый ключ (содержащийся в файле с расширением **PUB**) в следующую форму:

![Изображение формы запроса на открытый ключ](./media/hdinsight-hadoop-linux-use-ssh-unix/ssh-key.png)

> [AZURE.NOTE]Файл ключа — это обычный текстовый файл. Содержимое должно выглядеть следующим образом: ```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCelfkjrpYHYiks4TM+r1LVsTYQ4jAXXGeOAF9Vv/KGz90pgMk3VRJk4PEUSELfXKxP3NtsVwLVPN1l09utI/tKHQ6WL3qy89WVVVLiwzL7tfJ2B08Gmcw8mC/YoieT/YG+4I4oAgPEmim+6/F9S0lU2I2CuFBX9JzauX8n1Y9kWzTARST+ERx2hysyA5ObLv97Xe4C2CQvGE01LGAXkw2ffP9vI+emUM+VeYrf0q3w/b1o/COKbFVZ2IpEcJ8G2SLlNsHWXofWhOKQRi64TMxT7LLoohD61q2aWNKdaE4oQdiuo8TGnt4zWLEPjzjIYIEIZGk00HiQD+KCB5pxoVtp user@system
> ```

При этом для указанного пользователя создается имя для входа с использованием заданного пароля или предоставленного открытого ключа.

###Интерфейс командной строки Azure для Mac, Linux и Windows

Вы можете использовать [интерфейс командной строки Azure для Mac, Linux и Windows](xplat.md) для создания нового кластера с помощью команды `azure hdinsight cluster create`.

Дополнительную информацию об использовании этой команды см. в статье <a href="../hdinsight-hadoop-provision-linux-clusters/" target="_blank">Подготовка кластеров Hadoop под управлением Linux в HDInsight с помощью настраиваемых параметров</a>.

##Подключение к кластеру HDInsight на основе Linux

В сеансе терминала воспользуйтесь командой SSH для подключения к головному узлу кластера, указав имя пользователя и адрес.

* **Адрес SSH** — это имя кластера с добавленным в конце суффиксом **-ssh.azurehdinsight.net**. Например, **mycluster-ssh.azurehdinsight.net**.

* **Имя пользователя** — имя пользователя SSH, указанное при создании кластера.

В следующем примере выполняется подключение к кластеру **mycluster** с именем пользователя **me**:

	ssh me@mycluster-ssh.azurehdinsight.net

Если для учетной записи пользователя использовался пароль, будет предложено ввести пароль.

Если вы использовали ключ SSH, защищенный парольной фразой, появится запрос на ввод парольной фразы. В противном случае SSH попытается автоматически выполнить аутентификацию с помощью одного из локальных закрытых ключей на клиенте.

> [AZURE.NOTE]Если SSH не выполнит аутентификацию автоматически с правильным закрытым ключом, используйте параметр **-i** и укажите путь к закрытому ключу. В следующем примере выполняется загрузка закрытого ключа из файла `~/.ssh/id_rsa`:
>
> `ssh -i ~/.ssh/id_rsa me@mycluster-ssh.azurehdinsight.net`

###Подключение к рабочим узлам

К рабочим узлам нельзя получить прямой доступ за пределами центра обработки данных Azure, но к ним можно получить доступ с головного узла кластера через SSH.

Если для аутентификации учетной записи пользователя используется ключ SSH, на клиенте нужно выполнить следующие действия:

1. Откройте в текстовом редакторе файл `~/.ssh/config`. Если этот файл не существует, вы можете создать его, введя команду `touch ~/.ssh/config` в терминале.

2. Добавьте в файл следующий код. Замените *CLUSTERNAME* именем кластера HDInsight.

        Host CLUSTERNAME-ssh.azurehdinsight.net
          ForwardAgent yes

    Это позволяет настроить перенаправление агента SSH для кластера HDInsight.

3. Чтобы проверить перенаправление агента SSH, выполните следующую команду в терминале:

        echo "$SSH_AUTH_SOCK"

    Эта команда возвращает следующую информацию:

        /tmp/ssh-rfSUL1ldCldQ/agent.1792

    Если информация не возвращается, это означает, что **агент SSH** не работает. Конкретные действия по установке и настройке **агента SSH** см. в документации по операционной системе или в разделе <a href="http://mah.everybody.org/docs/ssh" target="_blank">Использование агента SSH с помощью протокола SSH</a>.

4. Убедившись в том, что **агент SSH** запущен, используйте следующую команду, чтобы добавить закрытый ключ SSH для агента:

        ssh-add ~/.ssh/id_rsa

    Если закрытый ключ хранится в другом файле, замените `~/.ssh/id_rsa` на путь к файлу.

Чтобы подключиться к рабочим узлам кластера, выполните следующие действия.

> [AZURE.IMPORTANT]Если для аутентификации учетной записи используется ключ SSH, выполните предыдущие шаги, чтобы убедиться, что перенаправление агента работает.

1. Подключитесь к кластеру HDInsight с помощью протокола SSH, как описано выше.

2. После подключения выполните следующую команду, чтобы получить список узлов в кластере. Замените *ADMINPASSWORD* паролем учетной записи администратора кластера. Замените *CLUSTERNAME* именем кластера.

        curl --user admin:ADMINPASSWORD https://CLUSTERNAME.azurehdinsight.net/api/v1/hosts

    В результате будет возвращена информация в формате JSON для узлов кластера, включая `host_name`, в котором содержится полное доменное имя (FQDN) каждого узла. Ниже приведен пример записи `host_name`, возвращенной командой **curl**:

        "host_name" : "workernode0.workernode-0-e2f35e63355b4f15a31c460b6d4e1230.j1.internal.cloudapp.net"

3. После создания списка рабочих узлов, к которым необходимо подключиться, используйте следующую команду из сеанса SSH на сервере для подключения к рабочему узлу:

        ssh USERNAME@FQDN

    Замените *USERNAME* своим именем пользователя SSH, а *FQDN* — полным доменным именем рабочего узла. Например, `workernode0.workernode-0-e2f35e63355b4f15a31c460b6d4e1230.j1.internal.cloudapp.net`.

    > [AZURE.NOTE]При использовании пароля для аутентификации сеанса SSH появится запрос на повторный ввод пароля. При использовании ключа SSH подключение завершается без запросов.

4. После установки сеанса строка терминала изменится с `username@headnode` на `username@workernode`, чтобы указать, что вы подключены к рабочему узлу. Все команды на этом этапе выполняются на рабочем узле.

4. После выполнения всех действий на рабочем узле закройте сеанс рабочего узла с помощью команды `exit`. Таким образом вы вернетесь к запросу `username@headnode`.

##Добавление дополнительных учетных записей

1. Создайте новый открытый ключ и закрытый ключ для новой учетной записи пользователя, как описано в разделе [Создание ключа SSH](#create-an-ssh-key-optional).

	> [AZURE.NOTE]Закрытый ключ должен быть создан на клиенте, который пользователи будут использовать для подключения к кластеру, или безопасно передан на такой клиент после создания.

1. Из сеанса SSH добавьте в кластер нового пользователя с помощью следующей команды:

		sudo adduser --disabled-password <username>

	Она создаст новую учетную запись пользователя, но отключит проверку пароля.

2. Создайте каталог и файлы для хранения ключа, используя следующие команды:

		sudo mkdir -p /home/<username>/.ssh
		sudo touch /home/<username>/.ssh/authorized_keys
		sudo nano /home/<username>/.ssh/authorized_keys

3. Когда откроется редактор nano, скопируйте и вставьте в него содержимое открытого ключа для новой учетной записи пользователя. Наконец, нажмите клавиши **Ctrl-X**, чтобы сохранить файл и закрыть редактор.

	![изображение редактора Nano с примером ключа](./media/hdinsight-hadoop-linux-use-ssh-unix/nano.png)

4. Используйте следующую команду, чтобы изменить владельца папки в формате SSH и ее содержимого на новую учетную запись пользователя:

		sudo chown -hR <username>:<username> /home/<username>/.ssh

5. Теперь можно будет проходить аутентификацию на сервере с новой учетной записью пользователя и закрытым ключом.

##<a id="tunnel"></a>Туннелирование SSH

SSH может также использоваться для туннелирования локальных запросов, например веб-запросов, к кластеру HDInsight. Запрос будет затем перенаправлен к запрошенному ресурсу, как если бы исходил от головного узла кластера HDInsight.

Это может пригодиться при доступе к веб-службам в кластере HDInsight, использующим внутренние доменные имена для головного или рабочих узлов в кластере. Например, некоторые части веб-страницы Ambari используют внутренние доменные имена, например **headnode0.mycluster.d1.internal.cloudapp.net**. Эти имена нельзя разрешить вне кластера, но запросы, туннелированные через SSH, создаются внутри кластера и будут разрешены правильно.

Выполните следующие действия, чтобы создать туннель SSH и настроить браузер, чтобы использовать его для подключения к кластеру.

1. Следующая команда используется для создания туннеля SSH на головном узле кластера:

		ssh -C2qTnNf -D 9876 username@clustername-ssh.azurehdinsight.net

	В результате создается подключение, которое направляет трафик, поступающий на локальный порт 9876, в кластер по протоколу SSH. Доступны следующие параметры.

	* **D 8080** — локальный порт, используемый для направления трафика через туннель;

	* **C** — сжатие всех данных, так как веб-трафик преимущественно состоит из текста;

	* **2** — принудительная попытка использовать только протокол SSH версии 2;

	* **q** — тихий режим;

	* **T** — отключение распределения псевдотелетайпа, так как выполняется только перенаправление порта;

	* **n** — предотвращение считывания с STDIN, так как выполняется только перенаправление порта;

	* **N** — запрет на выполнение удаленной команды, так как выполняется только перенаправление порта;

	* **f** — выполнение в фоновом режиме.

	При настройке кластера с ключом SSH может потребоваться использовать параметр `-i` и указать путь к закрытому ключу SSH.

	После завершения команды трафик, отправленный на порт 9876 на локальном компьютере, будет направляться с использованием SSL на головной узел кластера и выглядеть так, будто его источником является головной узел.

2. Настройте клиентскую программу, например Firefox, чтобы использовать **localhost:9876** в качестве прокси-сервера **SOCKS v5**. Вот как выглядят параметры Firefox:

	![изображение параметров Firefox](./media/hdinsight-hadoop-linux-use-ssh-unix/socks.png)

	> [AZURE.NOTE]Если выбрать параметр **Удаленная служба DNS**, то запросы DNS будут разрешаться с помощью кластера HDInsight. Если этот параметр не выбран, запросы DNS будут разрешаться локально.

	Вы можете убедиться, что трафик направляется через туннель, посетив сайт, например <a href="http://www.whatismyip.com/" target="_blank">http://www.whatismyip.com/</a>, при включенных и выключенных параметрах прокси в Firefox. Если настройки включены, IP-адрес будет относиться к компьютеру в центре обработки данных Microsoft Azure.

###Расширения браузера

Обычно при настройке браузера для использования туннеля вы не хотите направлять через туннель весь трафик. Расширения браузера, такие как <a href="http://getfoxyproxy.org/" target="_blank">FoxyProxy</a>, поддерживают сопоставление шаблонов для запросов URL-адресов (только FoxyProxy Standard или Plus), что позволяет отправлять через туннель только запросы определенных URL-адресов.

Если вы установили FoxyProxy Standard, выполните следующие действия, чтобы настроить его для перенаправления через туннель только трафика для HDInsight:

1. Откройте расширение FoxyProxy в браузере. Например, в Firefox щелкните значок FoxyProxy рядом с полем адреса.

	![значок FoxyProxy](./media/hdinsight-hadoop-linux-use-ssh-unix/foxyproxy.png)

2. Щелкните **Добавить новый прокси-сервер**, а затем выберите вкладку **Общие** и введите имя прокси-сервера **HDInsightProxy**.

	![вкладка «Общие» FoxyProxy](./media/hdinsight-hadoop-linux-use-ssh-unix/foxygeneral.png)

3. Выберите вкладку **Сведения о прокси** и заполните следующие поля.

	* **Хост или IP-адрес** — необходимо указать значение localhost, так как мы используем туннель SSH на локальном компьютере.

	* **Порт** — порт, используемый для туннеля SSH.

	* **Прокси-сервер SOCKS** — выберите этот параметр, чтобы позволить браузеру использовать туннель в качестве прокси-сервера.

	* **SOCKS v5** — выберите этот параметр, чтобы задать требуемую версию прокси-сервера.

	![прокси-сервер FoxyProxy](./media/hdinsight-hadoop-linux-use-ssh-unix/foxyproxyproxy.png)

4. Выберите вкладку **Шаблоны URL-адреса**, а затем нажмите кнопку **Добавить новый шаблон**. Используйте следующие значения параметров, чтобы определить шаблон, а затем нажмите кнопку **ОК**:

	* **Имя шаблона** — **headnode** (это просто понятное имя для шаблона);

	* **Шаблон URL** — ***headnode*** — определяет шаблон, которому соответствует любой URL-адрес со словом **headnode**.

	![шаблон FoxyProxy](./media/hdinsight-hadoop-linux-use-ssh-unix/foxypattern.png)

4. Нажмите кнопку **ОК**, чтобы добавить прокси-сервер и закрыть окно **Параметры прокси-сервера**.

5. В верхней части диалогового окна FoxyProxy в раскрывающемся списке **Выбрать режим** выберите пункт **Использовать прокси-серверы на основе шаблонов и приоритетов**, а затем нажмите кнопку **Закрыть**.

	![выбор режима FoxyProxy](./media/hdinsight-hadoop-linux-use-ssh-unix/selectmode.png)

После выполнения этих действий только запросы URL-адресов, которые содержат строку **headnode**, будут направляться через туннель SSL.

##Дальнейшие действия

Теперь, когда вы знаете, как пройти аутентификацию с помощью ключа SSH, узнайте, как использовать MapReduce с Hadoop в HDInsight.

* [Использование Hive с HDInsight](hdinsight-use-hive.md)

* [Использование Pig с HDInsight](hdinsight-use-pig.md)

* [Использование заданий MapReduce с HDInsight](hdinsight-use-mapreduce.md)

<!--HONumber=54-->