<properties
   pageTitle="Использование ключей SSH с Hadoop в HDInsight на платформе Linux из Linux, Unix или OS X | Aure"
   description="Узнайте, как создавать и использовать ключи SSH для аутентификации в кластерах HDInsight на основе Linux."
   services="hdinsight"
   documentationCenter=""
   authors="Blackmist"
   manager="paulettm"
   editor="cgronlun"/>

<tags
   ms.service="hdinsight"
   ms.devlang=""
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="big-data"
   ms.date="02/18/2015"
   ms.author="larryfr"/>

##Использование SSH с Hadoop в HDInsight на платформе Linux из Linux, Unix или OS X (предварительная версия)

Кластеры HDInsight на основе Linux предоставляют возможность защиты доступа по протоколу SSH с помощью пароля или ключа SSH. В этом документе содержатся сведения об использовании SSH с HDInsight из клиентов OS X, Linux и Unix.

> [AZURE.NOTE] При описаний действий в данной статье предполагается, что вы используете клиент OS X, Linux или Unix. Хотя то же самое можно сделать и на клиентах Windows после установки пакета, который предоставляет `ssh` и `ssh-keygen` (например, Git для Windows), на таких клиентах рекомендуется выполнить действия, описанные в статье [Использование SSH с HDInsight (Hadoop) на платформе Linux в ОС Windows](/documentation/articles/hdinsight-hadoop-linux-use-ssh-windows/).

##Предварительные требования

* **ssh-keygen** и **ssh** для клиентов Linux, Unix и OS X. Эта служебная программа обычно входит в состав операционной системы или доступна через систему управления пакетами.

* Современный браузер, который поддерживает HTML5

ИЛИ

* кроссплатформенные программы командной строки Azure.

##Что такое SSH?

SSH - это служебная программа для входа в систему и удаленного выполнения команд на удаленном сервере. Используя HDInsight на основе Linux, SSH устанавливает безопасное подключение к головному узлу кластера и предоставляет окно командной строки, используемое для ввода команд. Команды выполняются непосредственно на сервере.

##Создание ключа SSH (необязательно)

При создании кластера HDInsight на основе Linux вы можете использовать пароль или ключ SSH для аутентификации на сервере, если используется SSH. Ключи SSH считаются более надежными, так как они основаны на сертификатах. Если вы планируете использовать ключи SSH на своем кластере, используйте следующую информацию.

1. Откройте сеанс терминала и введите следующую команду, чтобы определить наличие любых имеющихся ключей SSH:

		ls -al ~/.ssh

	Найдите следующие файлы в листинге каталога. Это общие имена для открытых ключей SSH.

	* id\_dsa.pub
	* id\_ecdsa.pub
	* id\_ed25519.pub
	* id\_rsa.pub

2. Если вы не хотите использовать имеющийся файл или у вас нет ключей SSH, создайте новый ключ следующим образом.

		ssh-keygen -t rsa

	Вам будет предложено ввести следующую информацию:

	* Расположение файла - по умолчанию ~/.ssh/id\_rsa.
	* Парольная фраза - вам будет предложено ввести ее повторно.
	
		> [AZURE.NOTE] Мы настоятельно рекомендуем использовать безопасную парольную фразу для ключа. Однако если вы забудете парольную фразу, восстановить ее будет невозможно.

	После выполнения команды у вас будет два новых файла: закрытый ключ (например, **id\_rsa**) и открытый ключ (например, **id\_rsa.pub**).

##Создание кластера HDInsight на основе Linux

При создании кластера HDInsight на основе Linux необходимо предоставить **открытый ключ**, созданный ранее. Из клиентов OS X, Unix и Linux кластер HDInsight можно создать двумя способами:

* **Портал управления Azure** - для создания кластера используется веб-портал.

* **Межплатформенный интерфейс командной строки Azure (xplat-cli)** - для создания кластера используются команды командной строки.

Для каждого из этих способов потребуется **пароль** или **открытый ключ**. Полную информацию о создании кластера HDInsight под управлением Linux см. в разделе <a href="/documentation/articles/hdinsight-hadoop-provision-linux-clusters/" target="_blank">Подготовка кластеров HDInsight под управлением Linux</a>.

###Портал управления Azure

При использовании портала для создания кластера HDInsight на платформе Linux необходимо ввести **имя пользователя SSH** и ввести **пароль** или использовать **открытый ключ SSH**. Если выбран **открытый ключ SSH**, необходимо вставить открытый ключ (содержащийся в файле с расширением **PUB**) в следующую форму.

![Image of form asking for public key](./media/hdinsight-hadoop-linux-use-ssh-unix/ssh-key.png)

> [AZURE.NOTE] Файл ключа - это обычный текстовый файл. Содержимое должно выглядеть аналогично следующему:
> ```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCelfkjrpYHYiks4TM+r1LVsTYQ4jAXXGeOAF9Vv/KGz90pgMk3VRJk4PEUSELfXKxP3NtsVwLVPN1l09utI/tKHQ6WL3qy89WVVVLiwzL7tfJ2B08Gmcw8mC/YoieT/YG+4I4oAgPEmim+6/F9S0lU2I2CuFBX9JzauX8n1Y9kWzTARST+ERx2hysyA5ObLv97Xe4C2CQvGE01LGAXkw2ffP9vI+emUM+VeYrf0q3w/b1o/COKbFVZ2IpEcJ8G2SLlNsHWXofWhOKQRi64TMxT7LLoohD61q2aWNKdaE4oQdiuo8TGnt4zWLEPjzjIYIEIZGk00HiQD+KCB5pxoVtp user@system
> ```

При этом для указанного пользователя создается имя для входа с использованием заданного пароля или предоставленного открытого ключа.

###Кроссплатформенный интерфейс командной строки Azure

Можно использовать <a href="../xplat-cli/" target="_brad">Межплатформенный интерфейс командной строки Azure</a>, чтобы создать новый кластер с помощью команды `Создать кластер azure hdinsight`.

Дополнительные сведения об использовании этой команды см. в разделе <a href="../hdinsight-hadoop-provision-linux-clusters/" target="_blank">Подготовка кластеров Hadoop Linux в HDInsight с помощью настраиваемых параметров</a>

##Подключение к кластеру HDInsight на основе Linux

В сеансе терминалов воспользуйтесь командой SSH для подключения к кластеру, указав имя пользователя и адрес кластера.

* **Адрес SSH** - это имя кластера с добавленным в конце суффиксом **-ssh.azurehdinsight.net**. Например, **mycluster-ssh.azurehdinsight.net**.

* **Имя пользователя** - имя пользователя SSH, указанное при создании кластера.

В следующем примере выполняется подключение к кластеру **mycluster** с именем пользователя **me**.

	ssh me@mycluster-ssh.azurehdinsight.net

Если для учетной записи пользователя использовался **пароль**, будет предложено ввести пароль.

Если использовался **ключ SSH**, защищенный парольной фразой, будет предложено ввести парольную фразу. В противном случае SSH попытается автоматически выполнить аутентификацию с помощью одного из локальных закрытых ключей на клиенте.

> [AZURE.NOTE] Если SSH не выполнит аутентификацию автоматически с правильным **закрытым ключом**, используйте параметр **-i** и укажите путь к закрытому ключу. В следующем примере выполняется загрузка **закрытого ключа** из `~/.ssh/id_rsa`.
> 
> `ssh -i ~/.ssh/id_rsa me@mycluster-ssh.azurehdinsight.net`

##Добавление дополнительных учетных записей

2. Создайте новый **открытый ключ** и **закрытый ключ** для новой учетной записи пользователя, как описано в разделе [Создание ключа SSH](#create) .

	> [AZURE.NOTE] Закрытый ключ должен быть создан на клиенте, который пользователи будут использовать для подключения к кластеру, или безопасно передан на такой клиент после создания.

1. Из сеанса SSH в кластер добавьте нового пользователя с помощью следующей команды.

		sudo adduser --disabled-password <username> 

	Она создаст новую учетную запись пользователя, но отключит проверку пароля.

2. Создайте каталог и файлы для хранения ключа, воспользовавшись следующими командами.

		sudo mkdir -p /home/<username>/.ssh
		sudo touch /home/<username>/.ssh/authorized_keys
		sudo nano /home/<username>/.ssh/authorized_keys

3. Когда откроется редактор nano, скопируйте и вставьте в него содержимое **открытого ключа** для новой учетной записи пользователя. Наконец, используйте **Ctrl-X**, чтобы сохранить файл и закрыть редактор.

	![image of nano editor with example key](./media/hdinsight-hadoop-linux-use-ssh-unix/nano.png)

4. Используйте следующую команду, чтобы изменить владельца папки .ssh и ее содержимого на новую учетную запись пользователя.

		sudo chown -hR <username>:<username> /home/<username>/.ssh

5. Теперь можно будет проходить аутентификацию на сервере с новой учетной записью пользователя и **закрытым ключом**.

##<a id="tunnel"></a>Туннелирование SSH

SSH может также использоваться для туннелирования локальных запросов, например веб-запросов, к кластеру HDInsight. Запрос будет затем перенаправлен к запрошенному ресурсу, как если бы исходил от головного узла кластера HDInsight.

Это может пригодиться при доступе к веб-службам в кластере HDInsight, использующим внутренние доменные имена для головного или рабочих узлов в кластере. Например, некоторые части веб-страницы Ambari используют внутренние доменные имена, например **headnode0.mycluster.d1.internal.cloudapp.net**. Эти имена нельзя разрешить извне кластера, однако запросы, туннелированные через SSH, создаются внутри кластера и будут разрешены правильно.

Выполните следующие действия, чтобы создать туннель SSH и настроить браузер, чтобы использовать его для подключения к кластеру.

1. Следующая команда используется для создания туннеля SSH на головном узле кластера.

		ssh -C2qTnNf -D 9876 username@clustername-ssh.azurehdinsight.net

	В результате создается подключение, которое направляет трафик, поступающий на локальный порт 9876, в кластер по протоколу SSH. Доступны следующие параметры.

	* **D 8080** - локальный порт, используемый для направления трафика через туннель.

	* **C** - сжатие всех данных, поскольку веб-трафик преимущественно состоит из текста.

	* **2** - принудительная попытка использовать только протокол SSH версии 2.

	* **q** - тихий режим.

	* **T** - отключение распределения псевдотелетайпа, поскольку выполняется только перенаправление порта.
	
	* **n** - предотвращение чтения с STDIN, поскольку выполняется только перенаправление порта.

	* **N** - запрет на выполнение удаленной команды, поскольку выполняется только перенаправление порта.

	* **f** - выполнение в фоновом режиме.

	При настройка кластера с **ключом SSH** можно использовать параметр `-i`  и указать путь к закрытому ключу SSH.

	После завершения команды трафик, отправленный на порт 9876 на локальном компьютере, будет направляться с использованием SSL на головной узел кластера и выглядеть так, будто его источником является головной узел.

2. Настройте клиентскую программу, например Firefox, чтобы использовать **localhost:9876** в качестве прокси-сервера **SOCKS v5**. Вот как выглядят параметры Firefox.

	![image of Firefox settings](./media/hdinsight-hadoop-linux-use-ssh-unix/socks.png)

	> [AZURE.NOTE] Если выбрать параметр **Удаленная служба DNS**, то запросы DNS будут разрешаться с использованием кластера HDInsight. Если этот параметр не выбран, запросы DNS будут разрешаться локально.

	Можно убедиться, что трафик направляется через туннель, посетив сайт, например <a href="http://www.whatismyip.com/" target="_blank">http://www.whatismyip.com/</a>, с помощью включения и выключения параметров прокси в Firefox. Если он включен, IP-адрес будет относиться к компьютеру в центре обработки данных Microsoft Azure.

###Расширения браузера

Обычно при настройке браузера для использования туннеля вы не хотите направлять через туннель весь трафик. Расширения браузера, такие как <a href="http://getfoxyproxy.org/" target="_blank">FoxyProxy</a>, поддерживают сопоставление шаблонов для запросов URL-адресов (только FoxyProxy Standard или Plus), что позволяет отправлять через туннель только запросы определенных URL-адресов.

Если вы установили **FoxyProxy Standard**, выполните следующие действия, чтобы настроить его для перенаправления через туннель только трафика для HDInsight.

1. Откройте расширение FoxyProxy в браузере. Например, в Firefox щелкните значок FoxyProxy рядом с полем адреса.

	![foxyproxy icon](./media/hdinsight-hadoop-linux-use-ssh-unix/foxyproxy.png)

2. На вкладке **Общие** нажмите кнопку **Добавить**, а затем введите имя прокси-сервера **HDInsight**.

	![foxyproxy general](./media/hdinsight-hadoop-linux-use-ssh-unix/foxygeneral.png)

3. Выберите **вкладку информации о прокси-сервере** и заполните следующие поля.

	* **Хост или IP-адрес** - localhost, так как мы используем туннель SSH на локальном компьютере.

	* **Порт** - порт, используемый для туннеля SSH.

	* **SOCKS-прокси** - выберите этот параметр, чтобы позволить браузеру использовать туннель в качестве прокси-сервера.

	* **SOCKS v5** - выберите этот параметр, чтобы установить требуемую версию прокси-сервера.

	![foxyproxy proxy](./media/hdinsight-hadoop-linux-use-ssh-unix/foxyproxyproxy.png)

4. Выберите вкладку **Шаблоны URL**, а затем нажмите кнопку **Добавить**. Используйте следующие параметры, чтобы определить шаблон, а затем нажмите кнопку **ОК**.

	* **Имя шаблона** - **headnode**, это просто понятное имя для шаблона.

	* **Шаблон URL-адреса** - **\*headnode\*** - определяет шаблон, которому соответствует любой URL- адрес со словом **headnode** в нем.

	![foxyproxy pattern](./media/hdinsight-hadoop-linux-use-ssh-unix/foxypattern.png)

4. Нажмите кнопку **ОК**, чтобы добавить прокси-сервер и закрыть окно **Параметры прокси**.

5. В верхней части диалогового окна FoxyProxy в раскрывающемся списке **Выбран режим** выберите пункт **Использовать прокси, основанные на шаблонах**, а затем нажмите кнопку **Выйти**.

	![foxyproxy select mode](./media/hdinsight-hadoop-linux-use-ssh-unix/selectmode.png)

После выполнения этих действий только запросы URL-адресов, которые содержат строку **headnode**, будут направляться через туннель SSL.

##Дальнейшие действия

Теперь, когда вы знаете, как пройти аутентификацию помощью ключа SSH, узнайте, как использовать MapReduce с Hadoop в HDInsight.

* [Использование Hive с HDInsight](../hdinsight-use-hive/)

* [Использование Pig с HDInsight](../hdinsight-use-pig/)

* [Использование заданий MapReduce с HDInsight](../hdinsight-use-mapreduce/)
 
<!--HONumber=47-->
