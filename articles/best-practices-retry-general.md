<properties
   pageTitle="Общие рекомендации по повторным попыткам | Microsoft Azure"
   description="Рекомендации по работе с повторными попытками для обработки временных сбоев."
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="12/22/2015"
   ms.author="masashin"/>

# Общие рекомендации по повторным попыткам

![](media/best-practices-retry-general/pnp-logo.png)

## Обзор

Все приложения, взаимодействующие с удаленными службами и ресурсами, должны быть чувствительны ко временным сбоям. Это особенно важно для приложений, работающих в облаке, поскольку в этом случае подобные ошибки возникают чаще из-за природы среды и использования подключения через Интернет. Временные сбои включают в себя кратковременную потерю сетевого подключения для компонентов и служб, временную недоступность службы или наличие времени ожидания, вызванного занятостью службы. Эти ошибки часто устраняются без вмешательства со стороны пользователя, поэтому если повторить действие через некоторый промежуток времени, оно с большой вероятностью будет выполнено успешно.

В этом документе рассматриваются общие рекомендации по обработке временных ошибок. Сведения об обработке временных сбоев при использовании служб Microsoft Azure см. в разделе [Рекомендации по повторным попыткам для служб Azure](best-practices-retry-service-specific.md).

## Почему временные сбои возникают в облаке?

Временные сбои могут возникать в любой среде, на любой платформе, в любой операционной системе и в приложении любого типа. В решениях, выполняющихся в локальной инфраструктуре, производительность и доступность приложения и его компонентов обычно поддерживается за счет аппаратного резервирования, которое дорого обходится и часто приводит к неэффективному использованию ресурсов, а компоненты и ресурсы расположены рядом друг с другом. Хотя это снижает вероятность сбоя, временные сбои все равно происходят, возможен даже простой, вызванный непредвиденным событием, таким как проблемы с внешним источником питания или сетью, либо при возникновении других аварийных ситуаций.

Размещение в облаке, включая системы на базе частного облака, предлагает повышенную общую доступность благодаря использованию общих ресурсов, резервированию, автоматической отработке отказа и динамическому распределению ресурсов между огромным количеством стандартных вычислительных узлов. Однако по своей природе такие среды больше предрасположены к возникновению временных сбоев. Для этого существует несколько причин.

* Многие ресурсы в облачной среде являются общими, и доступ к этим ресурсам может регулироваться в целях защиты ресурса. Некоторые службы отклоняют подключения, когда нагрузка возрастает до определенного уровня или достигается максимальная пропускная способность, чтобы обеспечить обработку существующих запросов и поддерживать уровень производительности службы для всех пользователей. Регулирование помогает обеспечить качество обслуживания для соседних узлов и других клиентов с помощью общего ресурса.
* Облачные среды состоят из большого числа стандартных аппаратных блоков. Они обеспечивают производительность путем динамического распределения нагрузки между несколькими вычислительными блоками и компонентами инфраструктуры, а также надежность благодаря автоматическому перезапуску или замене неисправных блоков. Такой динамический характер подразумевает периодическое возникновение временных сбоев и ошибок подключения.
* Часто в таких средах между приложением и используемыми им ресурсами и службами применяется больше аппаратных компонентов, включая сетевую инфраструктуру, например маршрутизаторы и подсистемы балансировки нагрузки. Эта дополнительная инфраструктура иногда может стать причиной дополнительной задержки подключения и временных сбоев соединения.
* Состояние сети между клиентом и сервером может изменяться, особенно в том случае, когда связь осуществляется через Интернет. Даже в локальных средах значительные объемы трафика могут замедлить взаимодействие и привести к сбоям промежуточных соединений.

## Сложности
Временные сбои могут оказывать крайне негативное влияние на воспринимаемый пользователями уровень доступности приложения, даже если оно тщательно протестировано во всех ожидаемых обстоятельствах. Для обеспечения надежной работы размещенных в облаке приложений они должны отвечать следующим требованиям.

* Приложение должно иметь возможность обнаруживать ошибки при их возникновения и определять, являются ли эти ошибки временными, долгосрочными или окончательными. Разные ресурсы, скорее всего, возвращают разные отклики при возникновении сбоя, кроме того, такие отклики могут зависеть и от контекста операции. Например, отклик на ошибку при чтении из хранилища может отличаться от отклика на ошибку при записи в хранилище. Многие ресурсы и службы имеют хорошо задокументированные контракты временного сбоя. Однако в случае отсутствия таких сведений часто бывает трудно определить характер ошибки, как и то, является ли она временной.
* Приложение должно иметь возможность повторить операцию, если оно определяет, что сбой с большой вероятностью является временным, и отслеживать количество повторных попыток выполнения операции.
* Приложение должно использовать соответствующую стратегию в отношении повторных попыток. Эта стратегия указывает количество допустимых повторных попыток, задержку между попытками и действия, которые следует предпринять после неудачной попытки. Часто подходящее количество попыток и задержку между ними бывает трудно определить, поскольку эти значения зависят от типа ресурса, текущих условий работы ресурса и самого приложения.

## Общие рекомендации
Следующие рекомендации помогут вам разработать подходящий механизм обработки временных сбоев для своих приложений.

* **Определите, имеется ли встроенный механизм повторных попыток.**
  * Многие службы предоставляют пакет SDK или клиентскую библиотеку с механизмом обработки временных сбоев. Политика повторов, как правило, специально подгоняется под характер и требования целевой службы. Кроме того, интерфейсы REST для служб могут возвращать сведения, которые помогают определить, уместна ли повторная попытка и как долго следует ожидать следующей попытки.
  * Используйте встроенный механизм повтора при его наличии, если только у вас нет четких и понятных требований, описывающих иную процедуру выполнения повторных попыток.
* **Определите, подходит ли для операция для повторной попытки**.
  * Операции следует повторять только в том случае, когда ошибки являются временными (обычно на это указывает характер ошибки) и имеется хотя бы некоторая вероятность того, что при повторной попытке операция будет выполнена успешно. Нет смысла в повторным выполнении недопустимых операций, например обновления несуществующего элемента в базе данных либо запросов к службе или ресурсу, в которых произошла неустранимая ошибка.
  * Как правило, повторные попытки следует предпринимать только в том случае, когда можно определить все последствия, а условия хорошо понятны и могут быть проверены. В противном случае повторные попытки должен реализовать вызывающий код. Помните, что ошибки, возвращенные из неподконтрольных вам ресурсов и служб, могут видоизменяться с течением времени, поэтому вам может потребоваться пересматривать свою логическую схему обнаружения временных ошибок.
  * При создании служб или компонентов рассмотрите возможность реализации кодов ошибок и сообщений, которые помогут клиентам определить потребность в повторном выполнении неудачных операций. В частности укажите, должен ли клиент повторить операцию (возможно, возвратив значение **isTransient**), и предложите подходящую задержку перед следующей повторной попыткой. При создании веб-службы рассмотрите возможность возврата настраиваемых ошибок, определенных в сервисных контрактах. Хотя эти сведения не смогут считать универсальные клиенты, они будут полезны при создании пользовательских клиентов.
* **Определите соответствующее число повторных попыток и интервал между ними.**
  * Крайне важно оптимизировать число повторных попыток и интервал согласно типу варианта использования. Если не предпринять достаточное количество повторных попыток, приложение не сможет завершить операцию, в результате чего возникнет сбой. Если предпринять слишком много повторных попыток или установить слишком короткий интервал между ними, приложение может длительно занимать такие ресурсы, как потоки, подключения и память, что отрицательно повлияет на работоспособность приложения.
  * Соответствующие значения для интервала времени и количества повторных попыток зависят от типа предпринятой операции. Например, если операция является частью взаимодействия с пользователем, следует использовать короткий интервал и всего несколько повторных попыток, чтобы не заставлять пользователя дожидаться отклика (при этом удерживается открытым подключение и может снижаться доступность для других пользователей). Если операция является частью длительного или критически важного рабочего процесса, отмена и перезапуск которого выливаются в значительные затраты или требуют много времени, рекомендуется увеличить время ожидания между повторными попытками и число самих попыток.
  * Определение соответствующих интервалов между повторными попытками является самой сложной задачей при разработке успешной стратегии. В типичных стратегиях применяются следующие типы интервала между повторными попытками.
      * **Экспоненциальная задержка**. Перед первой повторной попыткой приложение выдерживает небольшой интервал, а для каждой последующей попытки интервал увеличивается по экспоненциальному закону. Например, повторные попытки выполнения операции могут предприниматься через 3 секунды, 12 секунд, 30 секунд и так далее.
      * **Интервалы с приращениями**. Перед первой повторной попыткой приложение выдерживает небольшой интервал, а для каждой последующей попытки интервал увеличивается с определенными приращениями. Например, повторные попытки выполнения операции могут предприниматься через 3 секунды, 7 секунд, 13 секунд и так далее.
      * **Постоянные интервалы**. Для всех повторных попыток применяется одинаковый интервал. Например, повторные попытки выполнения операции могут предприниматься через каждые 3 секунды.
      * **Немедленный повтор**. Иногда временный сбой имеет крайне малую продолжительность, что может быть вызвано определенным событием, таким как конфликт сетевых пакетов или всплеск нагрузки на аппаратном компоненте. В этом случае имеет смысл повторить операцию немедленно, поскольку она может завершиться успешно, если ошибка устраняется за то время, пока приложение подготавливает и отправляет следующий запрос. Однако в любой ситуации следует предпринимать не более одной немедленной повторной попытки, а в случае ее неудачи необходимо переключиться на альтернативные стратегии, такие как экспоненциальная задержка, или на резервные действия.
      * **Случайный выбор**. Любая из указанных выше стратегий может включать в себя элемент случайности, чтобы предотвратить ситуацию, когда несколько экземпляров клиента одновременно предпринимают последовательные повторные попытки. Например, один экземпляр может повторять операцию через 3 секунды, 11 секунд, 28 секунд и так далее, а другой — через 4 секунды, 12 секунд, 26 секунд и так далее. Случайный выбор является полезным приемом, который можно совместить с другими стратегиями.  
  * В общем случае используйте стратегию экспоненциальной задержки для фоновых операций и стратегии немедленного повтора или постоянных интервалов для интерактивных операций. В обоих случаях необходимо выбрать задержку и число повторных попыток таким образом, чтобы максимальная задержка для всех повторных попыток находилась в пределах требуемой общей задержки.
  * Принимайте во внимание сочетание всех факторов, влияющих на общее максимальное время ожидания для выполняемой повторно операции. Эти факторы включают в себя время, требуемое на выдачу отклика при сбое соединения (обычно оно задается значением времени ожидания на стороне клиента), а также задержку между повторными попытками и максимальное число повторных попыток. Совместно все эти значения времени могут приводить к очень большой общей продолжительности операции, особенно когда применяется стратегия экспоненциальной задержки, при которой интервал между повторными попытками значительно увеличивается после каждой ошибки. Если процесс должен соответствовать определенному соглашению об уровне обслуживания, общая длительность операции, включая все время ожидания и все задержки, должна находиться в пределах, заданных этим соглашением.
  * Чрезмерно агрессивные стратегии повторных попыток, имеющие слишком короткие интервалы или слишком большое число попыток, могут отрицательно влиять на целевой ресурс или службу. Такая стратегия может мешать восстановлению ресурса или службы из состояния перегрузки, в результате чего они будут продолжать блокировать или отклонять запросы. Образуется замкнутый круг, когда ресурсу или службе отправляется все больше и больше запросов, что все больше ухудшает их способность к восстановлению.
  * При выборе интервалов повтора учитывайте время ожидания операций, чтобы предотвратить немедленное выполнение последующей попытки (например, если период ожидания равен интервалу между попытками). Также принимайте во внимание, должен ли общий возможный период (время ожидания плюс интервалы повтора) быть меньше определенного общего времени. Наличие слишком короткого или слишком длинного времени ожидания может оказывать влияние на длительность ожидания и частоту повторения операции.
  * Используйте тип исключения и все содержащиеся в нем данные или коды ошибок и сообщения, возвращаемые службой, для оптимизации интервала и числа повторных попыток. Например, некоторые исключения или коды ошибок (такие как код HTTP 503 «Служба недоступна» с заголовком Retry-After в ответе) могут указывать длительность ошибки либо сообщать о том, что в службе произошел сбой, из-за чего она не будет отвечать на все последующие попытки.
* **Избегайте антишаблонов**.
  * В подавляющем большинстве случаев следует избегать реализаций, которые включают в себя повторяющиеся слои кода повторных попыток. Избегайте схем, включающих в себя каскадные механизмы повторных попыток или реализующих повтор на каждом этапе операции, включающей в себя иерархию запросов, если только для этого нет отдельных требований. В этих исключительных случаях используйте политики, предотвращающие чрезмерное количество повторных попыток и периодов задержки, и убедитесь, что вы хорошо осознаете последствия. Например, если один компонент выполняет запрос к другому компоненту, который затем обращается к целевой службе, и вы разрешаете три повторных попытки для обоих вызовов, общее число повторных попыток для этой службы будет равно девяти. Многие службы и ресурсы реализуют встроенный механизм повторных попыток, и вам следует выяснить, как отключить или изменить его, если необходимо реализовать повторные попытки на более высоком уровне.
  *  Никогда не применяйте механизм с бесконечными повторными попытками. Это с большой вероятностью приведет к неспособности ресурса или службы восстановиться из состояния перегрузки, в результате чего регулирование и отклонение подключений будут продолжаться дольше. Используйте конечное число повторных попыток или реализуйте шаблон, такой как [прерыватель](http://msdn.microsoft.com/library/dn589784.aspx), чтобы дать службе возможность восстановления.
  * Никогда не выполняйте немедленный повтор больше одного раза.
  * При доступе к службам и ресурсам в Azure избегайте использования постоянного интервала, особенно при наличии большого количества повторных попыток. Оптимальным подходом в данном сценарии является стратегия экспоненциальной задержки с возможностью прерывания.
  * Не допускайте ситуации, когда несколько экземпляров одного клиента или несколько экземпляров разных клиентов выполняют повторные попытки одновременно. Если существует вероятность возникновения такой ситуации, введите в интервалы повтора элемент случайности.
* **Протестируйте стратегию повторных попыток и ее реализацию.**
  * Обязательно полностью протестируйте реализацию стратегии повторных попыток в обширном спектре условий, особенно если и приложение, и используемые им целевые ресурсы или службы находятся под чрезмерной нагрузкой. Чтобы проверить поведение во время тестирования, можно сделать следующее.
      * Внесите в службу временные и не временные ошибки. Например, отправьте недопустимые запросы или добавьте код, который обнаруживает тестовые запросы и дает отклик с различными типами ошибок. Пример использования TestApi см. в разделе [Тестирование с внесением ошибок на базе TestApi](http://msdn.microsoft.com/magazine/ff898404.aspx) и [Введение в TestApi. Часть 5: API-интерфейсы для внесения ошибок в управляемый код](http://blogs.msdn.com/b/ivo_manolov/archive/2009/11/25/9928447.aspx).
      * Создайте макет ресурса или службы, возвращающий диапазон ошибок, которые может возвращать реальная служба. Убедитесь, что охвачены все типы ошибок, которые ваша стратегия повторных попыток должна определять.
      * Принудительно вызовите появление временных ошибок, кратковременно отключив или перегрузив службу, если это пользовательская служба, созданная и развернутая вами (при этом, конечно же, не следует пытаться перегрузить общие ресурсы или общие службы в Azure).
      * Для API на основе HTTP рекомендуется применять библиотеку FiddlerCore в рамках автоматических тестов, чтобы изменять результат HTTP-запросов, добавляя дополнительное время циклического прохождения или меняя отклик (например, код состояния HTTP, заголовки, текст или другие факторы). Это позволяет осуществить детерминированное тестирование подмножества условий сбоя для временных ошибок или других типов ошибок. Дополнительную информацию см. в описании [FiddlerCore](http://www.telerik.com/fiddler/fiddlercore). Примеры использования библиотеки, в частности класса **HttpMangler**, см. в [исходном коде для пакета SDK службы хранилища Azure](https://github.com/Azure/azure-storage-net/tree/master/Test).
      * Выполняйте тесты с высокой нагрузкой и параллельные тесты, чтобы убедиться, что механизм и стратегия повторных попыток работают правильно в данных условиях, не оказывают неблагоприятного воздействия на работу клиента и не вызывают перекрестных конфликтов между запросами.
* **Управляйте конфигурациями политики повторных попыток.**
  * _Политика повторных попыток_ представляет собой сочетание всех элементов вашей стратегии повторных попыток. Она указывает механизм обнаружения, который определяет, является ли ошибка временной, задает используемый тип интервала (например, постоянный, экспоненциальный и случайный), фактические значения интервала и количество повторных попыток.
  * Повторные попытки требуется реализовать во многих местах даже самого простого приложения и на каждом слое более сложных приложений. Вместо того чтобы жестко запрограммировать элементы каждой политики в нескольких местах, рекомендуется использовать центральное расположение для хранения всех политик. Например, храните такие значения, как интервал и число попыток, в файлах конфигурации приложения, считывайте их во время выполнения и формируйте политики повторных попыток программным образом. Это упрощает управление параметрами, а также изменение и настройку значений, когда требуется обеспечить соответствие изменяющимся требованиям и сценариям. Однако если получить значения из конфигурации нельзя, разрабатывайте систему таким образом, чтобы хранить значения вместо считывания файла конфигурации, и обеспечьте использование подходящих значений по умолчанию.
  * В приложении облачных служб Azure рекомендуется хранить значения, которые используются для формирования политики повторных попыток во время выполнения, в файле конфигурации службы, чтобы их можно было изменить без перезапуска приложения.
  * Используйте преимущества встроенной стратегии повторных попыток или стратегий по умолчанию, доступных в используемых клиентских API, но только тогда, когда они подходят для вашего сценария. Эти стратегии обычно имеют общее назначение. Иногда их может быть вполне достаточно, однако в других случаях они не обеспечивают полный спектр необходимых вам возможностей. Необходимо понимать, как параметры влияют на приложение, и проводить тестирование для определения наиболее подходящих значений.
* **Регистрируйте и отслеживайте временные и не временные ошибки.**
  * Включите в состав стратегии повторных попыток обработку исключений и другое инструментирование, регистрирующие предпринимаемые повторные попытки. Хотя нерегулярные временные сбои и повторные попытки являются ожидаемыми и не указывают на наличие проблем, увеличение числа регулярных повторных попыток часто указывает на наличие проблемы, которая негативно влияет на производительность и доступность приложения либо может привести к сбою.
  * Регистрируйте временные сбои, такие как предупреждения, а не ошибки, чтобы системы мониторинга не определяли их как ошибки приложений, способные вызвать ложные оповещения.
  * Рекомендуется сохранять в записях журнала значение, указывающее, были ли повторные попытки вызваны регулированием в службе или другими типами сбоев, такими как ошибки подключения, чтобы можно было различить их во время анализа данных. Увеличение числа ошибок регулирования часто указывает на ошибку проектирования приложения или на необходимость перехода на платную службу, предоставляющую выделенное оборудование.  
  * Рекомендуется замерять и регистрировать общее время выполнения операций, включающих в себя механизм повторных попыток. Это хороший показатель общего влияния временных сбоев на время отклика для пользователя, задержку процесса и эффективность вариантов использования приложения. Кроме того, регистрируйте количество предпринятых повторных попыток, чтобы понять, какие факторы влияют на время отклика.
  * Рекомендуется реализовать систему телеметрии и мониторинга, способную выдавать предупреждения в случае увеличения числа и частоты возникновения сбоев, среднего числа повторных попыток или общего времени, затрачиваемого на успешное выполнение операций.
* **Управляйте операциями, которые постоянно завершаются неудачей.**
  * Возникнут обстоятельства, в которых операция продолжает завершаться ошибкой при каждой попытке, и крайне важно предусмотреть способ обработки такой ситуации.
      * Хотя стратегия повторных попыток будет определять максимальное число повторных попыток выполнения операции, она не запрещает приложению выполнить операцию еще раз с тем же числом повторных попыток. Например, если в службе обработки заказов возникает неустранимая ошибка, после чего служба становится полностью неработоспособной, стратегия повторных попыток может обнаруживать время ожидания подключения и расценивать его как временную ошибку. Код попытается повторить операцию указанное число раз и затем остановится. Однако при размещении заказа другим клиентом попытка выполнения операции будет предпринята снова, даже если она все равно закончится неудачей.
      * Чтобы предотвратить постоянные повторные попытки выполнения операций, которые каждый раз заканчиваются неудачей, рекомендуется реализовать [шаблон прерывателя](http://msdn.microsoft.com/library/dn589784.aspx). Если при таком шаблоне число ошибок за определенный период превышает пороговое значение, запросы сразу же возвращаются вызывающему объекту в виде ошибок без попытки доступа к ресурсу или службе, где возник сбой.
      * Приложение может периодически тестировать службу с очень длинными интервалами между запросами, чтобы определить, когда она станет доступной. Соответствующий интервал зависит от сценария, например от важности операции и характера службы, и может быть любым — от нескольких минут до нескольких часов. После успешного выполнения теста приложение может продолжить работу и передавать запросы в недавно восстановленную службу.
      * Тем временем можно переключиться на другой экземпляр службы (возможно, расположенный в другом центре обработки данных или другом приложении), использовать аналогичную службу с совместимой (возможно, упрощенной) функциональностью или выполнить некоторые альтернативные операции, в расчете, что служба станет доступной в ближайшее время. Например, может быть уместным сохранить запросы для службы в очереди или хранилище данных и позже воспроизвести их. Кроме того, вы можете перенаправить пользователя в альтернативный экземпляр приложения, снизив производительность этого приложения, однако предоставив необходимые функциональные возможности, либо просто возвратить пользователю сообщение о том, что приложение в настоящее время не доступно.

* **Дополнительные рекомендации**
  * При выборе значений для числа повторных попыток и интервалов повтора в политике следует учитывать, является ли операция для службы или ресурса частью длительной или многоэтапной операции. Для компенсаций всех выполненных этапов операции после сбоя одного из них может потребоваться много ресурсов или усилий. В этом случае может быть приемлемым использование очень большого интервала и очень большого количества повторных попыток, если только это не приводит к блокировке других операций из-за удержания дефицитных ресурсов.
  * Определите, может ли повторная попытка выполнения операции привести к несогласованности данных. Если повторяются некоторые части многоэтапного процесса, а соответствующие операции не являются идемпотентными, это может привести к возникновению несогласованности. Например, повторение операции, которая обеспечивает приращение значения, даст неверный результат. Повторение операции, которая отправляет сообщение в очередь, может вызвать несогласованность у получателя сообщения, если он не способен обнаруживать дублирующиеся сообщения. Во избежание этого убедитесь, что каждый этап проектируется в виде идемпотентной операции. Дополнительные сведения о идемпотентности см. в разделе [Шаблоны идемпотентности](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/).
  * Учитывайте область действия операций, которые будут повторяться. Например, может быть проще реализовать код повторных попыток на уровне, охватывающем несколько операций, и повторять все операции в случае сбоя одной из них. Однако это может привести к проблемам идемпотентности или ненужным операциям отката.
  * В случае выбора области повторных попыток, охватывающей несколько операций, учитывайте общую задержку всех этих операций при определении интервалов повтора, при отслеживании длительности выполнения и перед выдачей оповещений об ошибках.
  * Определите, как ваша стратегия повторных попыток может повлиять на соседние узлы и других клиентов в общем приложении или при использовании общих ресурсов и служб. Агрессивные политики повторных попыток могут привести к увеличению числа временных сбоев для других пользователей и приложений, совместно использующих ресурсы и службы. Аналогичным образом на ваше приложение могут оказывать влияние политики повторных попыток, внедренные другими пользователями этих ресурсов и служб. Для критически важных приложений можно использовать платные службы, которые не являются общими. Это значительно расширяет возможности управления загрузкой и соответствующим регулированием этих ресурсов и служб, что может оправдать дополнительные затраты.

## Дополнительные сведения

* [Рекомендации по повторным попыткам для служб Azure](best-practices-retry-service-specific.md)
* [Блок приложения для обработки временной ошибки](http://msdn.microsoft.com/library/hh680934.aspx)
* [Шаблон прерывателя](http://msdn.microsoft.com/library/dn589784.aspx)
* [Шаблон компенсации транзакций](http://msdn.microsoft.com/library/dn589804.aspx)
* [Шаблоны идемпотентности](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/)

<!---HONumber=AcomDC_0107_2016-->