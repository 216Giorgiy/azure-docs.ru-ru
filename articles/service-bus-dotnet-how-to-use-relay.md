<properties 
	pageTitle="Использование ретрансляции служебной шины (.NET) - Azure" 
	description="Узнайте, как использовать службу ретрансляции служебной шины Azure для соединения двух приложений, размещенных в разных расположениях." 
	services="service-bus" 
	documentationCenter=".net" 
	authors="sethmanheim" 
	manager="timlt" 
	editor="mattshel"/>

<tags 
	ms.service="service-bus" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="na" 
	ms.devlang="dotnet" 
	ms.topic="article" 
	ms.date="02/10/2015" 
	ms.author="sethm"/>







# Как использовать службу ретрансляции служебной шины

В этом руководстве описано создание службы ретрансляции служебной шины.
Примеры написаны на языке C# и используют интерфейс Windows Communication.
Foundation API с расширениями, содержащимися в сборке служебной шины, которая входит в состав пакета Azure SDK для .NET. Дополнительные сведения о ретрансляторе служебной шины см. в разделе "Дальнейшие действия".

[AZURE.INCLUDE [create-account-note](../includes/create-account-note.md)]

## Описание ретрансляции служебной шины

Служба **ретранслятора** служебной шины позволяет создавать **гибридные приложения**, которые можно запускать как в центре обработки данных Azure, так и в локальной корпоративной среде. Ретрансляция служебной шины упрощает этот процесс, позволяя безопасно предоставлять службы Windows Communication (WCF), используемые в корпоративной сети предприятия и в общедоступном облаке, без необходимости открывать подключения брандмауэра или вносить значительные изменения в инфраструктуру корпоративной сети.

![Relay Concepts](./media/service-bus-dotnet-how-to-use-relay/sb-relay-01.png)

Ретранслятор служебной шины позволяет размещать службы WCF в уже существующей среде предприятия. Затем можно делегировать прослушивание входящих сеансов и запросов этих служб WCF служебной шине, запущенной в Azure. Таким образом, доступ к этим службам могут получать код приложения, работающего в Azure, мобильные сотрудники или среды партнерских экстрасетей. Служебная шина позволяет безопасно управлять доступом к этим службам с высокой точностью. Это обеспечивает эффективный и безопасный способ предоставления функциональных возможностей приложения и данных из существующих корпоративных решений и использовать их из облака

В этом руководстве описано использование ретранслятора служебной шины для создания веб-службы WCF, доступной с помощью привязки канала TCP, который обеспечивает безопасную передачу данных между двумя сторонами.

## Создание пространства имен службы

Прежде чем использовать ретранслятор служебной шины в Azure, необходимо создать пространство имен службы. Пространство имен предоставляет контейнер для адресации ресурсов служебной шины в вашем приложении.

Создание пространства имен службы:

1.  Выполните вход на [портал управления Azure][Портал управления Azure].

2.  В левой области навигации портала управления щелкните **Служебная шина**.

3.  В нижней части портала управления нажмите кнопку **Создать**.

	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-13.png)

4.  В диалоговом окне **Добавить новое пространство имен** введите имя пространства имен.  Система немедленно проверяет, доступно ли оно.   

	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-04.png)


5.  Убедившись, что имя пространства имен доступно, выберите страну или регион, в котором будет размещено ваше пространство имен (необходимо указать страну и регион развертывания своих вычислительных ресурсов).

	Важно! Выберите **регион**, в котором будет развернуто ваше приложение. Это обеспечит наилучшую производительность.

6.	Оставьте в остальных полях диалогового окна значений по умолчанию (**Обмен сообщениями** и **Уровень Standard**), затем установите флажок. Теперь система создает пространство имен и включает его. Вероятно, придется подождать несколько минут, пока система не выделит ресурсы для вашей учетной записи.

	![](./media/service-bus-dotnet-how-to-use-relay/getting-started-multi-tier-27.png)

	Созданное пространство имен появится на портале управления; для его активации потребуется некоторое время. Прежде чем продолжать, подождите, пока состояние не изменится на **Активное**.

## Получение учетных данных управления по умолчанию для пространства имен

Для выполнения операций управления, таких как создание подключения к ретранслятору, над новым пространством имен необходимо настроить правило авторизации подписанного URL-адреса для пространства имен. Дополнительные сведения о подписанном URL-адресе см. в статье [Проверка подлинности подписанного URL-адреса с помощью служебной шины][Проверка подлинности подписи при общем доступе с помощью служебной шины].

1.  В левой части области навигации щелкните узел **Service Bus**, чтобы отобразить список доступных пространств имен.

	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-13.png)

2.  Дважды щелкните имя созданного пространства имен в следующем списке:   

	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-09.png)

3.  Выберите вкладку **Configure** (Настройка) вверху страницы.   
 
4.  Если пространство имен "Служебная шина" подготовлено, правило **SharedAccessAuthorizationRule** со значением **RootManageSharedAccessKey**, установленным для параметра **KeyName**, создается по умолчанию. На этой странице отображается ключ, а также первичные и вторичные ключи для правила по умолчанию.

## Получение пакета NuGet для служебной шины

Пакет **NuGet** служебной шины - это самый простой способ получить интерфейс API служебной шины и настроить свое приложение с учетом всех зависимостей служебной шины. Расширение NuGet для Visual Studio упрощает установку и обновление библиотек и инструментов в Visual Studio и Visual Studio Express. Пакет NuGet для служебной шины является самым простым способом получить интерфейс API служебной шины и настроить свое приложение с учетом всех зависимостей служебной шины.

Для установки пакета NuGet в приложении выполните следующие действия:

1.  В обозревателе решений щелкните правой кнопкой мыши **Ссылки**, затем выберите команду **Управление пакетами NuGet**.
2.  Выполните поиск по строке "служебная шина" и выберите элемент **Microsoft Azure Service Bus**. Нажмите кнопку **Установить**, чтобы выполнить установку, а затем закройте диалоговое окно.

	![](./media/service-bus-dotnet-how-to-use-relay/getting-started-multi-tier-13.png)

## Использование служебной шины для предоставления и потребления веб-службы SOAP с помощью TCP

Чтобы предоставить существующую веб-службу WCF SOAP для внешнего использования, необходимо внести изменения в привязки службы и адреса. Для этого может потребоваться изменить файл конфигурации либо внести изменения в код, в зависимости от способа установки и настройки служб WCF. Обратите внимание: служба WCF позволяет использовать несколько сетевых конечных точек для одной службы, поэтому при добавлении конечных точек служебной шины для внешнего доступа можно одновременно сохранить существующие внутренние конечные точки.

В этом примере потребуется создать простую службу WCF и добавить в нее прослушиватель служебной шины. Это предполагает определенное знакомство с Visual Studio, поэтому рассматриваются не все подробности создания проекта. Вместо этого в центре внимания оказывается код.

Прежде чем выполнить описанные ниже действия, сделайте следующее, чтобы настроить свою среду:

1.  В Visual Studio создайте в рамках решения консольное приложение, содержащее два проекта, Client и Service.
2.  Добавьте пакет **Azure Service Bus NuGet** в оба проекта. Это добавит в проекты все необходимые ссылки на сборки.

### Создание службы

Прежде всего, создайте саму службу. Любая служба WCF состроит из трех или более различных частей.

-   Определение контракта, который описывает передаваемые сообщения и вызываемые операции. 
-   Реализация указанного контракта.
-   Узел, на котором размещается эта служба и который предоставляет несколько конечных точек.

Примеры кода в этом разделе описывают каждый из этих компонентов.

Контракт определяет одну операцию, **AddNumbers**, которая складывает два числа и возвращает результат. Интерфейс **IProblemSolverChannel** упрощает для клиента управление временем жизни прокси-сервера. Рекомендуется создать этот интерфейс. Мы советуем поместить это определение контракта в отдельный файл, на который можно ссылаться из проектов Client и Service. Кроме того, можно скопировать код в оба проекта:

        using System.ServiceModel;
     
        [ServiceContract(Namespace = "urn:ps")]
        interface IProblemSolver
        {
            [OperationContract]
            int AddNumbers(int a, int b);
        }
     
        interface IProblemSolverChannel : IProblemSolver, IClientChannel {}

При наличии контракта реализация предельно проста:

        class ProblemSolver : IProblemSolver
        {
            public int AddNumbers(int a, int b)
            {
                return a + b;
            }
        }

### Программная настройка узла службы

После создания контракта и его реализации можно разместить службу. Размещение происходит внутри объекта **System.ServiceModel.ServiceHost**, который отвечает за управление экземплярами службы и в котором размещаются конечные точки, прослушивающие сообщения. Приведенный ниже код настраивает для службы обычную локальную конечную точку и конечную точку служебной шины для параллельного представления внутренних и внешних конечных точек. Замените строку  *namespace* вашим именем пространства имен и  *yourKey* ключом SAS, полученным на предыдущем этапе установки. 

    ServiceHost sh = new ServiceHost(typeof(ProblemSolver));

    sh.AddServiceEndpoint(
       typeof (IProblemSolver), new NetTcpBinding(), 
       "net.tcp://localhost:9358/solver");

    sh.AddServiceEndpoint(
       typeof(IProblemSolver), new NetTcpRelayBinding(), 
       ServiceBusEnvironment.CreateServiceUri("sb", "namespace", "solver"))
        .Behaviors.Add(new TransportClientEndpointBehavior {
              TokenProvider = TokenProvider.CreateSharedAccessSignatureTokenProvider("RootManageSharedAccessKey", "yourKey")});

    sh.Open();

    Console.WriteLine("Press ENTER to close");
    Console.ReadLine();

    sh.Close();

В приведенном примере создаются две конечные точки, предназначенные для одной и той же реализации контракта. Одна из них является локальной, а вторая проецируется через служебную шину. Отличаются они, главным образом, привязками (**NetTcpBinding** у локальной конечной точки и **NetTcpRelayBinding** у конечной точки служебной шины) и адресами. Для локальной конечной точки используется локальный сетевой адрес с отдельным портом. Адрес конечной точки служебной шины включает в себя строку sb, имя вашего пространства имен и путь solver. Поэтому URI имеет вид sb: / /[serviceNamespace].servicebus.windows.net/solver и определяет конечную точку службы как конечную точку TCP служебной шины с полным внешним именем DNS. Если в функции **Main** приложения Service вместо заполнителей использовать код так, как показано выше, будет создана функциональная служба. Если нужно, чтобы ваша служба прослушивала только служебную шину, удалите объявление локальной конечной точки.

### Настройка узла службы в файле App.config

С помощью файла App.config также можно настроить узел. В этом случае код размещения службы выглядит так:

    ServiceHost sh = new ServiceHost(typeof(ProblemSolver));
    sh.Open();
    Console.WriteLine("Press ENTER to close");
    Console.ReadLine();
    sh.Close();

Определения конечных точек перемещаются в файл App.config. Обратите внимание: пакет **NuGet** уже добавил ряд определений в файл App.config, которые являются необходимыми расширениями конфигурации для служебной шины. Приведенный ниже фрагмент кода, точно соответствующий указанному выше коду, должен отображаться непосредственно под элементом **system.serviceModel**. В этом фрагменте предполагается, что пространство имен C\# вашего проекта называется Service.
Замените заполнители на пространство имен служб и ключ SAS.

    <services>
        <service name="Service.ProblemSolver">
            <endpoint contract="Service.IProblemSolver"
                      binding="netTcpBinding"
                      address="net.tcp://localhost:9358/solver"/>
            <endpoint contract="Service.IProblemSolver"
                      binding="netTcpRelayBinding"
                      address="sb://namespace.servicebus.windows.net/solver"
                      behaviorConfiguration="sbTokenProvider"/>
        </service>
    </services>
    <behaviors>
        <endpointBehaviors>
            <behavior name="sbTokenProvider">
                <transportClientEndpointBehavior>
                    <tokenProvider>
                        <sharedAccessSignature keyName="RootManageSharedAccessKey" key="yourKey" />
                    </tokenProvider>
                </transportClientEndpointBehavior>
            </behavior>
        </endpointBehaviors>
    </behaviors>

После этих изменений служба запускается как и раньше, но с двумя работающими конечными точками: одной локальной и одной прослушивающей в облаке.

### Создание клиента

#### Программная настройка клиента

Для использования службы можно создать клиент WCF с помощью объекта **ChannelFactory**. Служебная шина использует модель безопасности на основе утверждений, реализуемую с помощью службы контроля доступа (ACS) Класс **TokenProvider** представляет собой поставщика маркеров безопасности со встроенными методами генерации, которые возвращают ряд хорошо известных поставщиков маркеров. В приведенном ниже примере используется поставщик **SharedSecretTokenProvider** для хранения учетных данных общего секрета и управления получением соответствующих маркеров из службы контроля доступа. Значения имени и ключа наследуются с портала, как описано в предыдущем разделе.

Сначала создайте в проекте клиента ссылку на код контракта **IProblemSolver** или скопируйте его со службы.

Затем замените код в методе **Main** клиента, снова подставив имя пространства имен служебной шины и ключ SAS вместо текста заполнителя:

    var cf = new ChannelFactory<IProblemSolverChannel>(
        new NetTcpRelayBinding(), 
        new EndpointAddress(ServiceBusEnvironment.CreateServiceUri("sb", "namespace", "solver")));

    cf.Endpoint.Behaviors.Add(new TransportClientEndpointBehavior
                { TokenProvider = TokenProvider.CreateSharedAccessSignatureTokenProvider("RootManageSharedAccessKey","yourKey") });
     
    using (var ch = cf.CreateChannel())
    {
        Console.WriteLine(ch.AddNumbers(4, 5));
    }

Теперь можно скомпилировать клиент и службу, а затем запустить их (сначала запустите службу). После этого клиент вызовет службу и выведет "9". Можно запустить клиент и сервер на разных компьютерах, даже в разных сетях, и связь по-прежнему будет работать. Код клиента также может работать в облаке или локально.

#### Настройка клиента в файле App.config

Клиент также можно настроить с помощью файла App.config. Клиентский код для в этом случае будет выглядеть так:

    var cf = new ChannelFactory<IProblemSolverChannel>("solver");
    using (var ch = cf.CreateChannel())
    {
        Console.WriteLine(ch.AddNumbers(4, 5));
    }

Определения конечных точек перемещаются в файл App.config. Следующий фрагмент кода, который полностью эквивалентен приведенному выше коду, должен находиться непосредственно под элементом **system.serviceModel**. Здесь снова необходимо заменить заполнители пространством имен служебной шины и ключом SAS.

    <client>
        <endpoint name="solver" contract="Service.IProblemSolver"
                  binding="netTcpRelayBinding"
                  address="sb://namespace.servicebus.windows.net/solver"
                  behaviorConfiguration="sbTokenProvider"/>
    </client>
    <behaviors>
        <endpointBehaviors>
            <behavior name="sbTokenProvider">
                <transportClientEndpointBehavior>
                    <tokenProvider>
                        <sharedAccessSignature keyName="RootManageSharedAccessKey" key="yourKey" />
                    </tokenProvider>
                </transportClientEndpointBehavior>
            </behavior>
        </endpointBehaviors>
    </behaviors>

## Дальнейшие действия

Теперь, когда вы изучили основы использования службы **ретрансляции** служебной шины, воспользуйтесь следующими ссылками, чтобы получить дополнительную информацию.

-   Создание службы: [создание службы для служебной шины][Создание службы для служебной шины].
-   Создание клиента: [создание клиентского приложения служебной шины][Создание клиентского приложения служебной шины].
-   Примеры служебной шины: загрузка со страницы [Примеры Azure].

  [Создание пространства имен службы]: #create_namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain_credentials
  [Получение пакета NuGet для служебной шины]: #get_nuget_package
  [Практическое руководство. Использование служебной шины для предоставления и получения веб-службы SOAP  с помощью TCP]: #how_soap
  [Портал управления Azure]: http://manage.windowsazure.com
  [Проверка подлинности подписи при общем доступе с помощью служебной шины]: http://msdn.microsoft.com/library/dn170477.aspx
  [Создание службы для служебной шины]: http://msdn.microsoft.com/library/ee173564.aspx
  [Создание клиентского приложения служебной шины]: http://msdn.microsoft.com/library/ee173543.aspx
  [Примеры Azure]: http://code.msdn.microsoft.com/windowsazure

<!--HONumber=47-->
