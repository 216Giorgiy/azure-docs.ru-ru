<properties urlDisplayName="Service Bus Relay" pageTitle="Использование ретрансляции служебной шины (.NET) - Azure" metaKeywords="Приступая к работе с ретрансляцией служебной шины Azure в C# " description="Learn how to use the Azure Service Bus relay service to connect two applications hosted in different locations." metaCanonical="" services="service-bus" documentationCenter=".NET" title="How to Use the Service Bus Relay Service" authors="sethm" solutions="" manager="timlt" editor="mattshel" />

<tags ms.service="service-bus" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="dotnet" ms.topic="article" ms.date="09/24/2014" ms.author="sethm" />







# Как использовать службу ретрансляции Service Bus

В данном руководстве описывается использование службы ретрансляции служебной шины. Примеры написаны на C# и используют интерфейс платформы Windows Communication Foundation и расширения, содержащиеся в сборке Service Bus, являющейся частью библиотек .NET для Azure. Для получения дополнительной информации о ретрансляции служебной шины, см. раздел [Дальнейшие действия][].

[WACOM.INCLUDE [create-account-note](../includes/create-account-note.md)]

<h2>Описание ретрансляции Service Bus</h2>

Служба **Ретрансляции** служебной шины дает возможность собирать **гибридные приложения**, работающие как на базе данных Azure, так и в вашей локальной среде предприятия. Ретрансляция облегчает эту задачу благодаря возможности обеспечения надежной работы служб Windows Communication Foundation (WCF), находящихся в публичном облаке корпоративной среды предприятия, без необходимости открытия подключения в брандмауэре и внесения серьезных изменений в корпоративную сетевую инфраструктуру.

![Relay Concepts](./media/service-bus-dotnet-how-to-use-relay/sb-relay-01.png)

Ретрансляция служебной шины позволяет размещать службы WCF в уже существующей среде предприятия. Затем можно делегировать служебной шине, работающей в Azure, прослушивание входящих сеансов и запросов к этим службам WCF. Это дает возможность адаптировать эти службы к коду приложения, работающего в Azure, к мобильным рабочим средам или партнерским средам в расширенных сетях. Служебная шина позволяет безопасно управлять доступом к этим услугам на детальном уровне. Это обеспечивает мощный и безопасный способ отделить функции вашего приложения и данные от существующих решений предприятия, чтобы воспользоваться преимуществами работы с облаком.

В данном руководстве демонстрируется использование ретрансляции для создания веб-службы WCF, работающей с привязкой к каналу TCP, что предполагает безопасное взаимодействие двух сторон.

<h2>Создание пространства имен службы</h2>

Чтобы приступить к работе с ретрансляцией служебной шины в Azure, прежде всего необходимо создать пространство имен службы. Пространство имен службы формирует контейнер областей для обращения к ресурсам служебной шины внутри вашего приложения.

Создание пространства имен службы:

1.  Войдите на [Портал управления Azure][].

2.  В левой части области навигации портала управления щелкните
    **Service Bus**.

3.  В нижней части области навигации портала управления нажмите кнопку **Создать**.   

	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-13.png)

4.  В диалоговом окне **Добавить новое пространство имен** введите имя пространства имен.
    Система мгновенно проверит, доступно ли это имя.   

	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-04.png)


5.  Убедившись, что имя пространства имен доступно, выберите
 страну или регион, где будет размещаться ваше пространство имен (убедитесь в том, что это та же страна или регион, где развернуты ваши компьютерные ресурсы).

	ВАЖНО! Выберите **тот же регион**, который собираетесь выбрать для развертывания приложения. Это обеспечит наилучшую производительность.

6.	Установите флажок для продолжения. Теперь система создает пространство имен службы и включает его. Возможно, вам придется подождать несколько минут, пока система выделит ресурсы для вашей учетной записи.

	![](./media/service-bus-dotnet-how-to-use-relay/getting-started-multi-tier-27.png)

	Пространство имен, которое вы создали, появится в портале управления, и будет активировано через несколько секунд. Подождите, пока статус не сменится на **Активный**, а затем продолжайте.

<h2>Получение учетных данных управления по умолчанию для пространства имен</h2>

Для выполнения операций управления, таких как подключение ретрансляции, над новым пространством имен необходимо получить учетные данные управления для пространства имен.

1.  В левой части области навигации щелкните узел **Service Bus**, чтобы
    отобразить список доступных пространств имен.   
	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-13.png)


2.  Выберите пространство имен, которое вы только что создали из появившегося списка:   
	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-09.png)


3.  Щелкните **Сведения о подключении**.   
	![](./media/service-bus-dotnet-how-to-use-relay/sb-queues-06.png)
 
4.  В диалоговом окне **Доступ информации о подключении** найдите записи **Издатель по умолчанию** и **Ключ по умолчанию**. Запишите эти значения, они понадобятся вам в дальнейшем для выполнения операций с пространством имен.

<h2>Получение пакета NuGet шины Service Bus</h2>

Пакет **NuGet** служебной шины является самым простым способом получить API шины и настроить для приложения все зависимости шины. Расширение NuGet для Visual Studio упрощает установку и обновление библиотек и инструментов в Visual Studio и Visual Studio Express 2012 для Web. Пакет NuGet служебной шины является самым простым способом получить API служебной шины и настроить для приложения все зависимости.

Для установки пакета NuGet в приложении выполните следующие действия:

1.  В обозревателе решений щелкните правой кнопкой мыши **Ссылки**, затем нажмите **Управление пакетами NuGet**.
2.  Выполните поиск по "Windows Azure" и выберите пункт **Шина Azure Service Bus**. Щелкните **Установить**, чтобы выполнить установку, а затем закройте это диалоговое окно.

	![](./media/service-bus-dotnet-how-to-use-relay/getting-started-multi-tier-13.png)
  

<h2>Использование шины Service Bus для предоставления и получения веб-службы SOAP с TCP</h2>

Для предоставления существующей веб-службы SOAP для внешнего использования, необходимо внести изменения в привязки и адреса службы. Это может потребовать изменения файла конфигурации или кода, в зависимости от настроек и конфигурации ваших служб WCF. Обратите внимание на то, что WCF разрешает использование нескольких конечных точек сети в одной и той же службе, так что вы можете с одной стороны, сохранить внутренние конечные точки, а с другой, добавить конечные точки шины Service Bus.

В данной задаче вы создадите простую службу WCF и добавите к ней прослушиватель шины Service Bus. Это упражнение предполагает определенное знакомство с Visual Studio 2012, поэтому рассматриваются не все подробности создания проекта. Вместо этого главная роль уделяется коду.

Перед выполнением нижеследующих шагов, выполните эту процедуру для настройки вашей среды:

1.  В Vistual Studio создайте приложение консоли, содержащее два
    проекта: Client и Service в одном решении.
2.  Установите целевую платформу для обоих проектов:.NET Framework 4.
3.  Добавьте пакет **Azure Service Bus NuGet** в оба проекта.
    Это добавит в проекты все необходимые ссылки на сборки.

### Как создать службу

Прежде всего, создайте саму службу. Любая служба WCF состроит из трех или более различных частей.

-   Определение контракта, описывающего, обмен какими сообщениями
    производится, и какие операции должны быть вызваны. 
-   Реализация указанного контракта.
-   Хост, на котором размещена служба, и имеющий ряд
    конечных точек.

Примеры кода в данном разделе обращаются к каждому из названных компонентов.

Контракт определяет единичную операцию **AddNumbers**, которая добавляет два числа и возвращает результат. Интерфейс **IProblemSolverChannel**упрощает для клиента управление временем жизни прокси-сервера. Рекомендуется создать этот интерфейс. Очень удобно размещение определения контракта в отдельном файле, так что вы можете к нему обратиться как из проекта Client, так и Service, а также скопировать код в оба проекта:

        using System.ServiceModel;
     
        [ServiceContract(Namespace = "urn:ps")]
        interface IProblemSolver
        {
            [OperationContract]
            int AddNumbers(int a, int b);
        }
     
        interface IProblemSolverChannel : IProblemSolver, IClientChannel {}

При наличии контракта реализация предельно проста:

        class ProblemSolver : IProblemSolver
        {
            public int AddNumbers(int a, int b)
            {
                return a + b;
            }
        }

**Программная настройка узла службы**

При правильно размещенном контракте и исполнении, вы можете приступать к размещению службы. Размещение имеет место внутри объекта **System.ServiceModel.ServiceHost**, отвечающего за управление экземплярами служб и размещение конечных точек, прослушивающих сообщения. Код, приведенный ниже, настраивает службу как с обычной локальной конечной точкой, так и с конечной точкой Service Bus, чтобы проиллюстрировать параллельное появление внутренних и внешних конечных точек. Замените строку "\*\*namespace\*\*" именем вашего пространства имен и "\*\*key\*\*" ключом издателя, который вы получили на предыдущем этапе настройки. 

    ServiceHost sh = new ServiceHost(typeof(ProblemSolver));

    sh.AddServiceEndpoint(
       typeof (IProblemSolver), new NetTcpBinding(), 
       "net.tcp://localhost:9358/solver");

    sh.AddServiceEndpoint(
       typeof(IProblemSolver), new NetTcpRelayBinding(), 
       ServiceBusEnvironment.CreateServiceUri("sb", "**namespace**", "solver"))
        .Behaviors.Add(new TransportClientEndpointBehavior {
              TokenProvider = TokenProvider.CreateSharedSecretTokenProvider( "owner", "**key**")});

    sh.Open();

    Console.WriteLine("Press ENTER to close");
    Console.ReadLine();

    sh.Close();

В этом примере вы создаете две конечных точки в рамках одного и того же исполнения контракта. Одна является локальной, а другая проецируется посредством шины Service Bus. Основное различие между ними заключается в привязках: **NetTcpBinding** для локальной, и **NetTcpRelayBinding** для конечной точки и адресов шины Service Bus. У локальной конечной точки есть локальный сетевой адрес с отдельным портом. Конечная точка шины Service Bus имеет адрес, составленный из строки "sb", имени вашего пространства имен и пути "solver". Это отображается в URI "sb://[serviceNamespace].servicebus.windows.net/solver", определяющем служебную конечную точку как конечную точку Service Bus TCP с полноценным именем внешнего DNS. Если вы разместите код, заменив им заполнители, как указано выше, в функции **Main** приложения Service появится функциональная служба. Если вы хотите, чтобы ваша служба прослушивала исключительно шину Service Bus, удалите объявление локальной конечной точки.

**Как настроить узел службы в файле App.config**

Вы также можете настроить размещение с помощью файла App.config. Код размещения службы в этом случае будет следующим:

    ServiceHost sh = new ServiceHost(typeof(ProblemSolver));
    sh.Open();
    Console.WriteLine("Press ENTER to close");
    Console.ReadLine();
    sh.Close();

Определения конечных точек перемещаются в файл App.config. Обратите внимание на то, что пакет **NuGet** уже добавил ряд определений в файл App.config, являющихся требуемыми расширениями конфигурации для шины Service Bus. Нижеследующий фрагмент кода, абсолютно эквивалентный приведенному выше коду, должен автоматически появляться под элементом **system.serviceModel**. Фрагмент имеет допущение, что C\# пространство имен вашего проекта называется Service. Замените заполнители пространством имен и ключом вашей службы Service Bus.

    <services>
        <service name="Service.ProblemSolver">
            <endpoint contract="Service.IProblemSolver"
                      binding="netTcpBinding"
                      address="net.tcp://localhost:9358/solver"/>
            <endpoint contract="Service.IProblemSolver"
                      binding="netTcpRelayBinding"
                      address="sb://**namespace**.servicebus.windows.net/solver"
                      behaviorConfiguration="sbTokenProvider"/>
        </service>
    </services>
    <behaviors>
        <endpointBehaviors>
            <behavior name="sbTokenProvider">
                <transportClientEndpointBehavior>
                    <tokenProvider>
                        <sharedSecret issuerName="owner" issuerSecret="**key**" />
                    </tokenProvider>
                </transportClientEndpointBehavior>
            </behavior>
        </endpointBehaviors>
    </behaviors>

После внесения этих изменений, служба возобновит работу, но уже с двумя динамичными конечными точками: локальной и прослушивающей облако. 

### Как создать клиент

**Программная настройка клиента**

Для использования службы вы можете создать клиент WCF, работающей с объектом **ChannelFactory**. Шина Service Bus использует модель безопасности на основе утверждений с применением службы управления Azure (ACS). Класс **TokenProvider** представляет собой поставщика токена безопасности со встроенными заводскими методами, которые возвращают некоторые хорошо известные поставщики токенов. В примере ниже используется **SharedSecretTokenProvider** для сохранения общих секретных учетных данных и осуществления получения соответствующих токенов от службы управления Azure. Имя и ключ - это данные, полученные от портала, как описано в предыдущем разделе. 

Прежде всего, установите ссылку или скопируйте код контракта **IProblemSolver** из службы в клиентский проект.

Теперь замените код в клиентском методе **Main**, снова введя в заполнители текст с вашим пространством имен и ключом Service Bus:

    var cf = new ChannelFactory<IProblemSolverChannel>(
        new NetTcpRelayBinding(), 
        new EndpointAddress(ServiceBusEnvironment.CreateServiceUri("sb", "**namespace**", "solver")));

    cf.Endpoint.Behaviors.Add(new TransportClientEndpointBehavior
                { TokenProvider = TokenProvider.CreateSharedSecretTokenProvider("owner","**key**") });
     
    using (var ch = cf.CreateChannel())
    {
        Console.WriteLine(ch.AddNumbers(4, 5));
    }

Если вы не можете скомпилировать клиент и службу, запустите их (сначала запустите службу), а затем клиент вызовет службу и напечатает "9". Можно запустить клиент и сервер на разных компьютерах, даже в разных сетях, и связь по-прежнему будет работать. Клиентский код может работать как в облаке, так и локально.

**Настройка клиента в файле App.config**

Вы также можете настроить клиент с помощью файла App.config. Клиентский код для в этом случае будет выглядеть так:

    var cf = new ChannelFactory<IProblemSolverChannel>("solver");
    using (var ch = cf.CreateChannel())
    {
        Console.WriteLine(ch.AddNumbers(4, 5));
    }

Определения конечных точек перемещаются в файл App.config. Следующий фрагмент, идентичный приведенному выше, должен появиться сразу под элементом **system.serviceModel**. Здесь, как и в предыдущих случаях, вы должны заменить заполнители вашим пространством имен и ключом Service Bus.

    <client>
        <endpoint name="solver" contract="Service.IProblemSolver"
                  binding="netTcpRelayBinding"
                  address="sb://**namespace**.servicebus.windows.net/solver"
                  behaviorConfiguration="sbTokenProvider"/>
    </client>
    <behaviors>
        <endpointBehaviors>
            <behavior name="sbTokenProvider">
                <transportClientEndpointBehavior>
                    <tokenProvider>
                        <sharedSecret issuerName="owner" issuerSecret="**key**" />
                    </tokenProvider>
                </transportClientEndpointBehavior>
            </behavior>
        </endpointBehaviors>
    </behaviors>

<h2>Дальнейшие действия</h2>

Теперь вы имеете базовое представление о службе шины обслуживания **Relay**. Для получения дополнительных сведений используйте следующие ссылки.

-   Создание службы: [Создание службы для шины Service Bus][].
-   Создание клиента: [Сборка клиентского приложения Service Bus][].
-   Примеры Service Bus: загрузите из [Примеры Azure][].

  [Дальнейшие действия]: #next_steps
  [Описание ретрансляции Service Bus]: #what-is
  [Создание пространства имен службы]: #create_namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain_credentials
  [Получение пакета NuGet шины Service Bus]: #get_nuget_package
  [Практическое руководство. Использование шины Service Bus для предоставления и получения веб-службы SOAP с TCP]: #how_soap
  [Портал управления Azure]: http://manage.windowsazure.com
   [Создание службы для Service Bus]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee173564.aspx
  [Создание клиентского приложения Service Bus]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee173543.aspx
  [Примеры Azure]: http://code.msdn.microsoft.com/windowsazure
