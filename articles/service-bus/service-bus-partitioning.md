<properties 
   pageTitle="Секционированные сущности обмена сообщениями | Microsoft Azure"
   description="В этой статье описывается, как секционировать сущности обмена сообщениями с помощью нескольких посредников сообщений."
   services="service-bus"
   documentationCenter="na"
   authors="sethmanheim"
   manager="timlt"
   editor="tysonn" /> 
<tags 
   ms.service="service-bus"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="09/18/2015"
   ms.author="sethm" />

# Секционированные сущности обмена сообщениями

Служебная шина Azure использует несколько посредников сообщений для обработки сообщений и несколько хранилищ сообщений для их хранения. Обычная очередь или раздел обрабатываются одним посредником сообщений и сохраняются в одном хранилище сообщений. Служебная шина также позволяет разделять (секционировать) очереди или разделы между несколькими посредниками сообщений и хранилищами сообщений. Это означает, что общая пропускная способность секционированной очереди или раздела больше не ограничивается производительностью одного посредника сообщений или хранилища сообщений. Кроме того, при возникновении временного сбоя хранилища сообщений секционированная очередь или раздел останутся доступными. Секционированные очереди и разделы могут включать все расширенные функции служебной шины, такие как поддержка транзакций и сеансов.

Дополнительные сведения о внутренних компонентах служебной шины см. в разделе [Архитектура служебной шины][].

## Секционированные очереди и разделы

Каждая секционированная очередь или раздел состоит из нескольких фрагментов. Фрагменты хранятся в разных хранилищах сообщений и обрабатываются разными посредниками сообщений. При отправке сообщения в секционированную очередь или раздел служебная шина присваивает сообщение одному из фрагментов. Выбор фрагмента осуществляется произвольно или по ключу секции, который может указать отправитель.

Если клиент хочет получить сообщение из секционированной очереди или подписки секционированного раздела, служебная шина выполняет запросы всех фрагментов сообщений и возвращает получателю первое сообщение, которое возвращается из любого хранилища. Служебная шина кэширует другие сообщения и возвращает их при получении дополнительных запросов. Клиент ничего не знает о секционировании, для него поведение секционированных очередей или разделов (например, чтение, завершение, откладывание, недоставление или предварительная выборка) аналогично поведению обычной сущности.

При отправке или получении сообщения из секционированной очереди или раздела не возникает никаких дополнительных затрат.

## Включение секционирования

Для использования секционированных очередей и разделов служебной шины Microsoft Azure необходимо использовать пакет SDK Azure версии 2.2 или более поздней версии или указать `api-version=2013-10` в HTTP-запросах.

Можно создавать очереди и разделы служебной шины размером 1, 2, 3, 4 или 5 ГБ (по умолчанию — 1 ГБ). Если секционирование включено, то для каждого гигабайта служебной шиной создается 16 секций. Поэтому при создании очереди размером 5 ГБ с 16 разделами максимальный размер очереди составит 80 ГБ (5 х 16). Чтобы просмотреть максимальный размер секционированной очереди или раздела, откройте соответствующую запись на [классическом портале Azure][].

Создать секционированную очередь или раздел можно несколькими способами. При создании очереди или раздела из приложения можно включить секционирование очереди или раздела, установив значение свойства соответственно [QueueDescription.EnablePartitioning][] или [TopicDescription.EnablePartitioning][] в **true**. Эти свойства должны быть заданы при создании очереди или раздела. Для существующих очереди или раздела изменить эти свойства невозможно. Например:

```
// Create partitioned topic
NamespaceManager ns = NamespaceManager.CreateFromConnectionString(myConnectionString);
TopicDescription td = new TopicDescription(TopicName);
td.EnablePartitioning = true;
ns.CreateTopic(td);
```

Кроме того, секционированную очередь или раздел можно создать в Visual Studio или на [классическом портале Azure][]. При создании новой очереди или раздела на портале установите флажок **Включить секционирование** на вкладке **Настройка** окна очереди или раздела. В Visual Studio установите флажок **Включить секционирование** в диалоговом окне **Новая очередь** или **Новый раздел**.

## Использование ключей секции

Когда сообщение добавляется в секционированную очередь или раздел, служебная шина проверяет наличие ключа секции. Если ключ есть, то фрагмент выбирается на основе этого ключа. Если ключа нет, то фрагмент выбирается на основе внутреннего алгоритма.

### Использование ключа секции

В некоторых сценариях, например для сессий или транзакций, необходимо, чтобы сообщения хранились в определенном фрагменте. Для всех этих сценариев необходимо использовать ключ секции. Все сообщения, использующие один и тот же ключ секции, назначаются одному и тому же фрагменту. Если фрагмент временно недоступен, служебная шина возвращает ошибку.

В зависимости от сценария в качестве ключа секции используются разные свойства сообщения:

**SessionId**: Если для сообщения установлено свойство [BrokeredMessage.SessionId][], то служебная шина использует это свойство в качестве ключа секции. Таким образом, все сообщения, которые относятся к одному сеансу, обрабатываются одним и тем же посредником сообщений. Это позволяет служебной шине гарантировать порядок сообщений и согласованность состояний сеансов.

**PartitionKey**: Если для сообщения установлено свойство [BrokeredMessage.PartitionKey][], но не установлено свойство [BrokeredMessage.SessionId][], то служебная шина использует свойство [PartitionKey][] в качестве ключа секции. Если для сообщения установлены оба свойства [SessionId][] и [PartitionKey][], то их значения должны совпадать. Если значение свойства [PartitionKey][] отличается от значения свойства [SessionId][], служебная шина возвращает исключение **InvalidOperationException**. Свойство [PartitionKey][] нужно использовать, если отправитель отправляет транзактные сообщения без учета сеансов. Ключ секции гарантирует, что все сообщения, отправленные в транзакции, будут обработаны одним и тем же посредником сообщений.

**MessageId**: Если для очереди или раздела свойство [QueueDescription.RequiresDuplicateDetection][] установлено в **true** и свойства [BrokeredMessage.SessionId][] или [BrokeredMessage.PartitionKey][] не заданы, то в качестве ключа секции выступает свойство [BrokeredMessage.MessageId][]. (Обратите внимание, что библиотеки Microsoft .NET и AMQP назначают идентификатор сообщения автоматически, если отправляющее приложение этого не сделало). В этом случае все копии одного сообщения обрабатываются одним и тем же посредником сообщений. Это позволяет служебной шине находить и исключать повторяющиеся сообщения. Если свойство [QueueDescription.RequiresDuplicateDetection][] не установлено в **true**, служебная шина не рассматривает свойство [MessageId][] в качестве ключа секции.

### Неиспользование ключа секции

При отсутствии ключа секции служебная шина распределяет сообщение по принципу циклического перебора всем фрагментам секционированных очереди или раздела. Если выбранный фрагмент недоступен, служебная шина назначает сообщение другому фрагменту. Таким образом, операция отправки выполняется даже при временной недоступности хранилища сообщений.

Чтобы у служебной шины было достаточно времени для того, чтобы поместить сообщение в другой фрагмент, значение свойства [MessagingFactorySettings.OperationTimeout][], указываемое клиентом, который отправляет сообщение, должно быть больше 15 секунд. Рекомендуется установить свойство [OperationTimeout][] в значение по умолчанию 60 секунд.

Обратите внимание, что ключ секции "прикрепляет" сообщение к определенному фрагменту. Если хранилище сообщений, содержащее этот фрагмент, недоступно, служебная шина возвращает ошибку. При отсутствии ключа секции служебная шина может выбрать другой фрагмент, и операция будет выполнена успешно. Поэтому рекомендуется не указывать ключ раздела, если он не является обязательным.

## Дополнительные разделы: использование транзакций и секционированных сущностей

Сообщения, отправленные в рамках транзакции, должны указать ключ секции. Это может быть одно из следующих свойств: [BrokeredMessage.SessionId][], [BrokeredMessage.PartitionKey][] или [BrokeredMessage.MessageId][]. Сообщения, отправляемые в рамках одной транзакции, должны иметь один и тот же ключ секции. При попытке отправить сообщение без ключа секции в рамках транзакции служебная шина возвращает исключение **InvalidOperationException**. При попытке отправить несколько сообщений с различными ключами секции в рамках одной транзакции служебная шина возвращает исключение **InvalidOperationException**. Например:

```
CommittableTransaction committableTransaction = new CommittableTransaction();
using (TransactionScope ts = new TransactionScope(committableTransaction))
{
    BrokeredMessage msg = new BrokeredMessage("This is a message");
    msg.PartitionKey = "myPartitionKey";
    messageSender.Send(msg); 
    ts.Complete();
}
committableTransaction.Commit();
```

Если установлено любое из свойств, которые служат в качестве ключа секции, служебная шина прикрепляет сообщение к определенному фрагменту. Это происходит независимо от того, используется ли транзакция. Рекомендуется не указывать ключ секции, если в этом нет необходимости.

## Использование сеансов и секционированных сущностей

Чтобы отправить транзактное сообщение в раздел или очередь с учетом сеансов, у сообщения должно быть установлено свойство [BrokeredMessage.SessionId][]. Если также установлено свойство [BrokeredMessage.PartitionKey][], оно должно быть идентично свойству [SessionId][]. Если они различаются, служебная шина возвращает исключение **InvalidOperationException**.

В отличие от обычных (несекционированных) очередей и разделов использовать одну транзакцию для отправки нескольких сообщений в различные сеансы невозможно. При попытке это сделать служебная шина возвращает исключение **InvalidOperationException**. Например:

```
CommittableTransaction committableTransaction = new CommittableTransaction();
using (TransactionScope ts = new TransactionScope(committableTransaction))
{
    BrokeredMessage msg = new BrokeredMessage("This is a message");
    msg.SessionId = "mySession";
    messageSender.Send(msg); 
    ts.Complete();
}
committableTransaction.Commit();
```

## Автоматическая переадресация сообщений для секционированных сущностей

Служебная шина Azure поддерживает автоматическую переадресацию сообщений в секционированные сущности, из них или между ними. Чтобы включить автоматическую переадресацию сообщений, установите свойство [QueueDescription.ForwardTo][] исходной очереди или подписки. Если в сообщении указан ключ секции ([SessionId][], [PartitionKey][] или [MessageId][]), то этот ключ секции используется для сущности назначения.

## Ограничения секционированных сущностей

В текущей реализации служебная шина налагает следующие ограничения на секционированные очереди и разделы:

-   Секционированные очереди и разделы доступны через SBMP или HTTP/HTTPS, а также AMQP.

-   Секционированные очереди и разделы не поддерживают отправку сообщений, принадлежащих разным сеансам, в одной транзакции.

-   В настоящее время служебная шина обеспечивает до 100 секционированных очередей или разделов на пространство имен. Каждая секционированная очередь или раздел учитывается в квоте в 10 000 сущностей на пространство имен.

-   Секционированные очереди и разделы не поддерживаются в служебной шине для Windows Server версий 1.0 и 1.1.

## Дальнейшие действия

Для получения дополнительных сведений о секционированных сущностях обмена сообщениями см. обсуждение поддержки AMQP 1.0 для секционированных очередей и разделов служебной шины (ожидается в ближайшее время!).

  [Архитектура служебной шины]: service-bus-architecture.md
  [классическом портале Azure]: http://manage.windowsazure.com
  [QueueDescription.EnablePartitioning]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queuedescription.enablepartitioning.aspx
  [TopicDescription.EnablePartitioning]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.topicdescription.enablepartitioning.aspx
  [BrokeredMessage.SessionId]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.sessionid.aspx
  [BrokeredMessage.PartitionKey]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.partitionkey.aspx
  [SessionId]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.sessionid.aspx
  [PartitionKey]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.partitionkey.aspx
  [QueueDescription.RequiresDuplicateDetection]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queuedescription.requiresduplicatedetection.aspx
  [BrokeredMessage.MessageId]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.messageid.aspx
  [MessageId]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.messageid.aspx
  [QueueDescription.RequiresDuplicateDetection]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queuedescription.requiresduplicatedetection.aspx
  [MessagingFactorySettings.OperationTimeout]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagingfactorysettings.operationtimeout.aspx
  [OperationTimeout]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagingfactorysettings.operationtimeout.aspx
  [QueueDescription.ForwardTo]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queuedescription.forwardto.aspx
  [AMQP 1.0 support for Service Bus partitioned queues and topics]: service-bus-partitioned-entities-amqp-overview.md

<!---HONumber=AcomDC_1203_2015-->