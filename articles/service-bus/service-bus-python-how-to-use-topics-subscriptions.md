<properties 
	pageTitle="Использование разделов служебной шины (Python) | Microsoft Azure" 
	description="Узнайте, как использовать разделы и подписки служебной шины в Python." 
	services="service-bus" 
	documentationCenter="python" 
	authors="sethmanheim" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="service-bus" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="na" 
	ms.devlang="python" 
	ms.topic="article" 
	ms.date="10/08/2015" 
	ms.author="sethm"/>

# Использование разделов и подписок служебной шины

В этой статье описывается использование разделов и подписок служебной шины. Примеры написаны на Python и используют пакет [Azure для Python][]. В этой статье описаны такие сценарии, как **создание разделов и подписок**, **создание фильтров подписок**, **отправка сообщений в раздел**, **получение сообщений из подписки** и **удаление разделов и подписок**. Дополнительные сведения о разделах и подписках см. в разделе [Дальнейшие действия](#next-steps).

[AZURE.INCLUDE [howto-service-bus-topics](../../includes/howto-service-bus-topics.md)]

**Примечание.** Если требуется установить Python или [пакет Azure для Python][], см. [Руководство по установке Python](../python-how-to-install.md).

## Создание раздела

Объект **ServiceBusService** позволяет работать с разделами. Добавьте следующий код в начало любого файла Python, из которого планируется получать доступ к служебной шине программным способом:

```
from azure.servicebus import ServiceBusService, Message, Topic, Rule, DEFAULT_RULE_NAME
```

Следующий код создает объект **ServiceBusService**. Замените `mynamespace`, `sharedaccesskeyname` и `sharedaccesskey` своим пространством имен, именем и значением ключа подписанного URL-адреса (SAS).

```
bus_service = ServiceBusService(
	service_namespace='mynamespace',
	shared_access_key_name='sharedaccesskeyname',
	shared_access_key_value='sharedaccesskey')
```

Можно получить значения для имени ключа SAS и значение из [портал Azure][] **сведения о соединении** окна.

```
bus_service.create_topic('mytopic')
```

**create\_topic** также поддерживает дополнительные параметры, позволяющие переопределить настройки раздела по умолчанию, такие как срок жизни или максимальный размер раздела. В следующем примере показано, как установить максимальный размер раздела 5 ГБ и значение срока жизни (TTL) в 1 минуту:

```
topic_options = Topic()
topic_options.max_size_in_megabytes = '5120'
topic_options.default_message_time_to_live = 'PT1M'

bus_service.create_topic('mytopic', topic_options)
```

## Создание подписок

Подписки на разделы также создаются с помощью объекта **ServiceBusService**. У подписок есть имена, и они могут использовать дополнительный фильтр, ограничивающий набор сообщений, доставляемых в виртуальную очередь подписки.

> [AZURE.NOTE]Подписки хранятся постоянно и продолжают существовать либо до их удаления, либо до удаления раздела, на который они подписаны.

### Создание подписки с фильтром по умолчанию (MatchAll)

Фильтр **MatchAll** является фильтром по умолчанию, используемым, если при создании новой подписки не указан фильтр. Если используется фильтр **MatchAll**, все сообщения, опубликованные в разделе, помещаются в виртуальную очередь подписки. В следующем примере создается подписка с именем AllMessages и фильтром по умолчанию **MatchAll**.

```
bus_service.create_subscription('mytopic', 'AllMessages')
```

### Создание подписок с фильтрами

Можно также задавать фильтры, позволяющие определять, какие посылаемые в раздел сообщения должны отображаться в рамках конкретной подписки.

Самый гибкий тип фильтра, который поддерживается подписками, — это **SqlFilter**, реализующий подмножество SQL92. Фильтры SQL работают со свойствами сообщений, которые опубликованы в разделе. Дополнительные сведения о выражениях, которые можно использовать с SQL-фильтром, см. в описании синтаксиса [SqlFilter.SqlExpression][].

Фильтры можно добавить в подписку с помощью метода **create\_rule** объекта **ServiceBusService**. Этот метод позволяет добавлять новые фильтры в существующую подписку.

> [AZURE.NOTE]Поскольку ко всем новым подпискам автоматически применяется фильтр по умолчанию, сначала необходимо удалить фильтр по умолчанию, либо **MatchAll** переопределит поведение всех остальных заданных фильтров. Вы можете удалить правило по умолчанию с помощью метода **delete\_rule** объекта **ServiceBusService**.

В следующем примере создается подписка с именем `HighMessages`, содержащая объект **SqlFilter**, который выбирает только сообщения, значение настраиваемого свойства **MessageNumber** которых превышает 3.

```
bus_service.create_subscription('mytopic', 'HighMessages')

rule = Rule()
rule.filter_type = 'SqlFilter'
rule.filter_expression = 'messagenumber > 3'

bus_service.create_rule('mytopic', 'HighMessages', 'HighMessageFilter', rule)
bus_service.delete_rule('mytopic', 'HighMessages', DEFAULT_RULE_NAME)
```

Аналогичным образом в следующем примере создается подписка с именем `LowMessages` и фильтром **SqlFilter**, который выбирает только те сообщения, у которых значение свойства **messagenumber** меньше или равно 3.

```
bus_service.create_subscription('mytopic', 'LowMessages')

rule = Rule()
rule.filter_type = 'SqlFilter'
rule.filter_expression = 'messagenumber <= 3'

bus_service.create_rule('mytopic', 'LowMessages', 'LowMessageFilter', rule)
bus_service.delete_rule('mytopic', 'LowMessages', DEFAULT_RULE_NAME)
```

Теперь, когда в раздел `mytopic` отправляется сообщение, оно будет всегда доставляться получателям, подписанным на раздел **AllMessages**, и выборочно доставляться получателям, подписанным на разделы **HighMessages** и **LowMessages** в зависимости от содержания сообщения.

## Отправка сообщений в раздел

Чтобы отправить сообщение в раздел служебной шины, в приложении должен использоваться метод **send\_topic\_message** объекта **ServiceBusService**.

В следующем примере показано, как отправить пять тестовых сообщений в `mytopic`. Обратите внимание, что значение свойства **messagenumber** сообщений зависит от итерации цикла (определяет, какие подписки получают их):

```
for i in range(5):
	msg = Message('Msg {0}'.format(i).encode('utf-8'), custom_properties={'messagenumber':i})
	bus_service.send_topic_message('mytopic', msg)
```

Разделы служебной шины поддерживают максимальный размер сообщения 256 МБ (максимальный размер заголовка, содержащего стандартные и настраиваемые свойства приложения — 64 МБ). Ограничения на количество сообщений в разделе нет, но есть максимальный общий размер сообщений, содержащихся в разделе. Этот размер задается при создании с верхним пределом 5 ГБ. Дополнительные сведения о квотах см. в статье [Очереди Azure и очереди служебной шины][].

## Получение сообщений от подписки

Сообщения извлекаются из подписки с помощью метода **receive\_subscription\_message** объекта **ServiceBusService**:

```
msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=False)
print(msg.body)
```

Прочитанные сообщения будут удаляться из подписки, если значение параметра **peek\_lock** установлено на **False**. Вы можете прочитать (извлечь) и заблокировать сообщение, не удаляя его из очереди, присвоив параметру **peek\_lock** значение **True**.

Поведение по умолчанию — чтение и удаление сообщения как часть операции получения — является простейшей моделью, оптимальной для сценариев, в которых приложение может не обрабатывать сообщение в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку служебная шина помечает сообщение как использованное, то когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.

Если параметр **peek\_lock** имеет значение **True**, получение становится операцией из двух этапов, что позволяет поддерживать приложения, неустойчивые к пропуску сообщений. Получив запрос, служебная шина находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению. Заканчивая обработку сообщения (или надежно сохраняя его для будущей обработки), приложение завершает второй этап процесса получения, вызывая метод **delete** объекта **Message**. Метод **delete** помечает сообщение как использованное и удаляет его из подписки.

```
msg = bus_service.receive_subscription_message('mytopic', 'LowMessages', peek_lock=True)
print(msg.body)

msg.delete()
```

## Как обрабатывать сбои приложения и нечитаемые сообщения

служебная шина предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock** объекта **Message**. Таким образом, служебная шина разблокирует сообщение в подписке и сделает его доступным для приема тем же или другим приложением.

Существует также определенное связанное с сообщением время ожидания в рамках подписки, и если приложение не может обработать сообщение до истечения этого времени (например, аварийно завершит работу), то Service Bus автоматически разблокирует сообщение и делает его доступным для повторного получения.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода **delete**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют **обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью свойства **MessageId** сообщения, которое остается постоянным для различных попыток доставки.

## Удаление разделов и подписок

Разделы и подписки хранятся постоянно, и их нужно удалять явным образом на портале Azure или с помощью программных средств. В следующем примере показано, как удалить раздел с именем `mytopic`:

```
bus_service.delete_topic('mytopic')
```

При удалении раздела также удаляются все подписки, зарегистрированные в этом разделе. Подписки также можно удалять по отдельности. В следующем примере кода показано, как удалить подписку с именем `HighMessages` из раздела `mytopic`:

```
bus_service.delete_subscription('mytopic', 'HighMessages')
```

## Дальнейшие действия

Вы узнали основные сведения о разделах служебной шины. Для получения дополнительных сведений используйте следующие ссылки.

-   См. статью [Очереди, темы и подписки][].
-   Справочник по [SqlFilter.SqlExpression][].

[портал Azure]: http://manage.windowsazure.com
[Azure для Python]: https://pypi.python.org/pypi/azure
[пакет Azure для Python]: https://pypi.python.org/pypi/azure
[Очереди, темы и подписки]: service-bus-queues-topics-subscriptions.md
[SqlFilter.SqlExpression]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.sqlfilter.sqlexpression.aspx
[Очереди Azure и очереди служебной шины]: service-bus-azure-and-service-bus-queues-compared-contrasted.md#capacity-and-quotas

<!---HONumber=Oct15_HO3-->