<properties 
   pageTitle="Очереди Azure и очереди служебной шины: сходства и различия"
   description="Анализ сходства и различий между двумя типами очередей, предлагаемых в Azure."
   services="service-bus"
   documentationCenter="na"
   authors="sethmanheim"
   manager="timlt"
   editor="tysonn" />
<tags 
   ms.service="service-bus"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="tbd"
   ms.date="09/11/2015"
   ms.author="sethm" />

# Очереди Azure и очереди служебной шины: сходства и различия

В этой статье рассматриваются сходства и различия между двумя типами очередей, предлагаемых Microsoft Azure: очередями Azure и очередями служебной шины. Эти сведения помогут вам сопоставить эти технологии и выбрать решение, которое лучше всего отвечает вашим требованиям.

## Введение

Microsoft Azure поддерживает два типа очередей: **очереди Azure** и **очереди служебной шины**.

**Очереди Azure** являются частью [инфраструктуры хранения Azure](http://azure.microsoft.com/services/storage/) и предоставляют простой REST-интерфейс с операциями извлечения, помещения в очередь и просмотра для надежного обмена сообщениями внутри служб и между ними.

**Очереди служебной шины** входят в более обширную [инфраструктуру обмена сообщениями Azure](http://azure.microsoft.com/services/messaging/), поддерживающую очереди, публикации и подписки, удаленное взаимодействие с веб-службами и шаблоны интеграции. Дополнительные сведения об очередях служебной шины, темах, подписках и ретрансляциях см. в статье [Общие сведения о схемах обмена сообщениями служебной шины](https://msdn.microsoft.com/library/hh410103.aspx).

Несмотря на то что описываемые технологии очередей существуют параллельно, очереди Azure появились раньше как выделенный механизм хранения очередей на базе служб хранилища Azure. Очереди служебной шины разработаны на базе более масштабной инфраструктуры "обмена сообщениями через посредника", предназначенной для интеграции приложений или их компонентов и охватывающей различные протоколы связи, контракты данных, доверенные домены и сети.

В этой статье мы рассмотрим две технологии очередей, предлагаемые в службе Azure, перечислим различия в поведении и реализации возможностей каждой из них, а также дадим рекомендации по выбору функций, которые лучше всего подойдут для разработки ваших приложений.

## Рекомендации по выбору технологии

И очереди Azure, и очереди служебной шины являются вариантами реализации службы очередей сообщений, доступной в настоящее время в Microsoft Azure. Предлагаемые ими наборы функций немного различаются, поэтому вы можете использовать как один, так и оба варианта в зависимости от потребностей конкретного решения либо бизнес- или технической задачи, которую вы пытаетесь решить.

При выборе технологии очередей под конкретные цели и задачи архитекторам и разработчикам решений следует принимать во внимание приведенные ниже рекомендации. Дополнительные сведения см. в следующем разделе.

Архитекторам и разработчикам решений **рекомендуется использовать очереди Azure**, если:

- Приложение должно хранить в очереди более 80 ГБ сообщений со сроком существования менее 7 дней.

- Вы хотите, чтобы приложение отслеживало ход обработки сообщения внутри очереди. В этом случае при сбое рабочего процесса, обрабатывающего сообщения, следующий рабочий процесс сможет использовать полученную информацию, чтобы продолжить обработку с того места, где произошел сбой предыдущего обработчика.

- Вам требуются серверные журналы всех примененных к очередям транзакций.

Архитекторам и разработчикам решений **рекомендуется использовать очереди служебной шины**, если:

- Решение должно иметь возможность получать сообщения, не опрашивая очередь. Это можно обеспечить за счет применения операции получения с продолжительным опросом на основе протоколов TCP, поддерживаемых служебной шиной.

- В решении требуется, чтобы очередь гарантированно доставляла сообщения в порядке их добавления в очередь (FIFO).

- Вы хотите, чтобы Azure и Windows Server работали симметрично (частное облако). Дополнительные сведения см. в статье [Служебная шина для Windows Server](https://msdn.microsoft.com/library/dn282144.aspx).

- Необходимо, чтобы решение поддерживало автоматическое обнаружение дубликатов.

- Вы хотите, чтобы приложение обрабатывало сообщения как параллельные долговременные потоки (сообщения связываются с потоком с помощью свойства [SessionId](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.sessionid.aspx) сообщения). В этой модели каждый узел принимающего приложения конкурирует за потоки, а не за сообщения. Когда для принимающего узла выделяется поток, узел может проверить состояние потока приложения с помощью транзакций.

- В решении требуется реализовать транзакционный режим работы и атомарность при отправке или получении нескольких сообщений из очереди.

- Срок жизни (TTL) рабочей нагрузки конкретного приложения может превышать 7 дней.

- Ваше приложение обрабатывает сообщения, размер которых может превышать 64 КБ, но вряд ли приблизится к пределу в 256 КБ.

- Вам требуется обеспечить доступ к очередям на основе ролей, а также предусмотреть различные права или разрешения для отправителей и получателей.

- Размер очереди не будет превышать 80 ГБ.

- Вы хотите использовать брокер обмена сообщениями на основе стандартов AMQP 1.0. Дополнительные сведения об AMQP см. в статье [Общие сведения о протоколе AMQP для служебной шины](https://msdn.microsoft.com/library/jj841072.aspx).

- Вы предполагаете, что впоследствии перейдете от двухточечной коммуникации на основе очередей к модели обмена сообщениями, позволяющей надежно интегрировать дополнительных получателей (подписчиков), каждый из которых получает независимые копии отдельных или всех сообщений, отправленных в очередь. Последнее относится к предусмотренным в служебной шине функциям публикации и подписки.

- Ваше решение для обмена сообщениями должно поддерживать гарантированную доставку "без повторов" без добавления новых компонентов в инфраструктуру.

- Вам нужна возможность пакетной публикации и потребления сообщений.

- Вам требуется полная интеграция с коммуникационным стеком Windows Communication Foundation (WCF) в .NET Framework.

## Сравнение очередей Azure и служебной шины

Для удобства сравнения в следующих разделах функции очередей Azure и служебной шины сгруппированы логически и представлены в виде таблиц.

## Основные возможности

В этом разделе сравниваются некоторые из основных возможностей, предоставляемых очередями служебной шины и Azure.

|Критерии сравнения|Очереди Azure|Очереди служебной шины|
|---|---|---|
|Гарантированный метод упорядочивания|**Нет** <br/><br>Дополнительные сведения см. в первом примечании в разделе "Дополнительные сведения".</br>|**Да, в порядке добавления (FIFO)**<br/><br>(используются сеансы обмена сообщениями)|
|Гарантированный метод доставки|**Как минимум один раз**|**Как минимум один раз**<br/><br/>**Без повторов**|
|Поддержка транзакций|**Нет**|**Да**<br/><br/>(используются локальные транзакции)|
|Поведение при получении|**Без блокировки**<br/><br/>(немедленно завершается, если новые сообщения не найдены)|**Блокировка со временем ожидания или без него**<br/><br/>(продолжительный опрос или [метод Comet](http://go.microsoft.com/fwlink/?LinkId=613759))<br/><br/>**Без блокировки**<br/><br/>(только с помощью управляемого интерфейса API для .NET)|
|API push-уведомлений|**Нет**|**Да**<br/><br/>[OnMessage](https://msdn.microsoft.com/library/jj908682.aspx) и [сеансы OnMessage](https://msdn.microsoft.com/library/dn790528.aspx) в API для .NET.|
|Режим получения|**Просмотр и аренда**|**Просмотр и блокировка**<br/><br/>**Получение и удаление**|
|Режим монопольного доступа|**На основе аренды**|**На основе блокировки**|
|Продолжительность аренды или блокировки|**30 секунд (по умолчанию)**<br/><br/>**7 дней (максимум)** (можно продлить или отменить аренду сообщения с помощью метода API [UpdateMessage](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.storage.queue.cloudqueue.updatemessage.aspx).)|**60 секунд (по умолчанию)**<br/><br/>Можно возобновить блокировку сообщения с помощью метода API [RenewLock](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.renewlock.aspx).|
|Степень детализации аренды или блокировки|**Уровень сообщений**<br/><br/>(у сообщений могут быть уникальные значения времени ожидания; при необходимости их можно обновлять в процессе обработки сообщения с помощью метода API [UpdateMessage](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.updatemessage.aspx))|**Уровень очереди**<br/><br/>(для каждой очереди определена степень детализации блокировки, применяемая ко всем сообщениям в ней, однако блокировку можно продлить с помощью метода API [RenewLock](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.renewlock.aspx))|
|Получение в пакетном режиме|**Да**<br/><br/>(явно, путем указания количества сообщений при их извлечении; до 32 сообщений)|**Да**<br/><br/>(неявно, путем включения свойства предварительной выборки, или явно, с помощью транзакций)|
|Отправка в пакетном режиме|**Нет**|**Да**<br/><br/>(с помощью транзакций или пакетной обработки на стороне клиента)|

### Дополнительная информация

- Сообщения в очередях Azure обычно располагаются в порядке их добавления (FIFO), но иногда очередность может нарушаться. Например, в результате сбоя при обработке на стороне клиентского приложения может закончиться время ожидания видимости сообщения. По истечении времени ожидания сообщение снова становится видимым, и следующий рабочий процесс может вывести его из очереди. При этом вновь ставшее видимым сообщение может быть помещено в очередь (чтобы снова быть выведенным из нее) после сообщения, которое изначально располагалось в очереди за ним.

- Если вы уже используете хранилище больших двоичных объектов или таблицы Azure и начинаете использовать очереди, гарантированная доступность службы составляет 99,9 %. Если большие двоичные объекты и таблицы используются с очередями служебной шины, доступность будет ниже.

- Для гарантированного упорядочения сообщений по методу FIFO в очередях служебной шины необходимо использовать сеансы обмена сообщениями. Если во время обработки сообщения, получаемого в режиме **Просмотр и блокировка**, произойдет сбой приложения, в следующем сеансе обмена сообщениями получатель очереди начнет работу с сообщения, на котором произошел сбой, после истечения срока жизни (TTL) этого сообщения.

- Очереди Azure поддерживают стандартные сценарии использования очередей, например разделение компонентов приложений для повышения масштабируемости и отказоустойчивости, выравнивание нагрузки и создание рабочих процессов.

- Очереди служебной шины поддерживают гарантию доставки *как минимум один раз*. Также можно добавить поддержку семантики *без повторов*. Для этого используется состояние сеанса для хранения состояния приложения и транзакции — для атомарного получения сообщений и обновления состояния сеанса. Этот метод используется в службе рабочего процесса Azure для гарантированной доставки без повторов.

- Очереди Azure предоставляют единообразную и согласованную модель программирования для очередей, таблиц и больших двоичных объектов как разработчикам, так и специалистам по эксплуатации.

- Очереди служебной шины обеспечивают поддержку локальных транзакций в контексте одной очереди.

- Режим *Получение и удаление*, поддерживаемый служебной шиной, позволяет сократить число операций обмена сообщениями (и связанные с этим расходы) за счет понижения уровня гарантии доставки.

- Очереди Azure поддерживают аренду сообщений с возможностью продления, благодаря чему рабочие процессы могут использовать краткосрочную аренду. В случае сбоя одного рабочего процесса сообщение может быть быстро обработано другим рабочим процессом. Кроме того, рабочий процесс может продлить аренду сообщения, если для его обработки требуется время, превышающее текущее время аренды.

- Очереди Azure поддерживают время ожидания видимости, которое можно задавать при добавлении сообщения в очередь или выведении из нее. Вы можете обновлять значения аренды сообщения в рабочем режиме, а также использовать разные значения для разных сообщений в рамках одной очереди. При использовании служебной шины время ожидания блокировки задается в метаданных очереди, однако блокировку можно возобновить с помощью метода [RenewLock](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.renewlock.aspx).

- Максимальное время ожидания для операции получения с блокировкой в очередях служебной шины составляет 24 дня. Однако для очередей на основе REST время ожидания не может превышать 55 секунд.

- Служебная шина позволяет выполнять пакетную обработку на стороне клиента. Это означает, что клиент очереди может отправлять несколько сообщений в рамках одной операции отправки. Пакетная обработка возможна только для операций асинхронной отправки.

- Верхнее ограничение в 200 ТБ (при виртуализации учетных записей — больше) для очередей Azure или полное отсутствие ограничений делают эти службы идеальной платформой для поставщиков SaaS.

- Очереди Azure предоставляют гибкий и эффективный механизм управления делегированным доступом.

## Расширенные возможности

В этом разделе сравниваются расширенные возможности очередей Azure и очередей служебной шины.

|Критерии сравнения|Очереди Azure|Очереди служебной шины|
|---|---|---|
|Доставка по расписанию|**Да**|**Да**|
|Автоматическое перемещение в "мертвую очередь"|**Нет**|**Да**|
|Увеличение срока жизни очереди|**Да**<br/><br/>(посредством обновления времени ожидания видимости "на месте")|**Да**<br/><br/>(используется выделенная функция API)|
|Поддержка сообщений о сбое|**Да**|**Да**|
|Обновление "на месте"|**Да**|**Да**|
|Журнал транзакций на стороне сервера|**Да**|**Нет**|
|Метрики хранения|**Да**<br/><br/>**Точные метрики**: в реальном времени отслеживаются доступность, TPS, количество вызовов API, количество ошибок и многое другое (данные агрегируются поминутно и доступны уже через несколько минут после того, как происходит то или иное событие в рабочей среде). Дополнительные сведения см. в статье [О метриках аналитики хранилища](https://msdn.microsoft.com/library/hh343258.aspx).|**Да**<br/><br/>(массовые запросы путем вызова [GetQueues](https://msdn.microsoft.com/library/hh293128.aspx))|
|Управление данными о состоянии|**Нет**|**Да**<br/><br/>[Microsoft.ServiceBus.Messaging.EntityStatus.Active](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.entitystatus.aspx), [Microsoft.ServiceBus.Messaging.EntityStatus.Disabled](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.entitystatus.aspx), [Microsoft.ServiceBus.Messaging.EntityStatus.SendDisabled](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.entitystatus.aspx), [Microsoft.ServiceBus.Messaging.EntityStatus.ReceiveDisabled](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.entitystatus.aspx)|
|Автоматическая пересылка сообщений|**Нет**|**Да**|
|Функция очистки очереди|**Да**|**Нет**|
|Группы сообщений|**Нет**|**Да**<br/><br/>(используются сеансы обмена сообщениями)|
|Состояние приложений по группам сообщений|**Нет**|**Да**|
|Обнаружение дубликатов|**Нет**|**Да**<br/><br/>(настраивается на стороне отправителя)|
|Интеграция с WCF|**Нет**|**Да**<br/><br/>(предлагаются заранее реализованные привязки к WCF)|
|Интеграция с WF|**Настраиваемая**<br/><br/>(требуется создать специальное действие WF)|**Встроенная**<br/><br/>(предлагаются заранее реализованные действия WF)|
|Просмотр групп сообщений|**Нет**|**Да**|
|Выборка сеансов сообщений по идентификатору|**Нет**|**Да**|

### Дополнительная информация

- Обе технологии очередей позволяют запланировать доставку сообщения в более позднее время.

- Автоматическая пересылка позволяет тысячам очередей автоматически перенаправлять сообщения в одну очередь, из которой их забирает получающее приложение. Этот механизм можно использовать для обеспечения безопасности, управления потоком и изоляции хранилищ разных создателей сообщений.

- Очереди Azure поддерживают обновление содержимого сообщений. Вы можете использовать эту возможность для сохранения в сообщении сведений о состоянии и поэтапного обновления хода выполнения операций. Это позволит продолжать обработку сообщений с последней известной контрольной точки, а не с самого начала. В очередях служебной шины тот же сценарий реализуется с использованием сеансов сообщений. Сеансы позволяют сохранять и извлекать состояние обработки приложения (с помощью методов [SetState](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.setstate.aspx) и [GetState](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.getstate.aspx)).

- Перемещение сообщений в "мертвую очередь", поддерживаемое только очередями служебной шины, может применяться для изоляции сообщений, которые не удается успешно обработать получающему приложению, или в том случае, когда сообщения не могут достичь цели из-за истечения срока жизни (TTL). Значение TTL определяет время, в течение которого сообщение остается в очереди. Если используется служебная шина, после истечения срока жизни сообщение перемещается в специальную очередь $DeadLetterQueue.

- Чтобы найти в очередях Azure "подозрительные" сообщения, при выведении сообщения из очереди приложение проверяет его свойство DequeueCount. Если значение превышает заданный порог, сообщение перемещается в определяемую приложением "мертвую очередь".

- Очереди Azure позволяют получить подробный журнал всех транзакций, примененных к очереди, а также агрегированные метрики. Обе функции полезны для отладки и понимания принципов использования очередей Azure в приложении. Они также помогают оптимизировать производительность приложения и сократить расходы, связанные с использованием очередей.

- Сеансы сообщений, поддерживаемые очередями служебной шины, позволяют связывать сообщения в определенной логической группе с конкретным получателем, создавая так называемое "сходство". Чтобы включить эту функцию в служебной шине, нужно задать свойство [SessionID](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.sessionid.aspx) сообщения. Получатели смогут выполнять прослушку по конкретному идентификатору сеанса и получать сообщения с этим идентификатором.

- Функция обнаружения дубликатов, поддерживаемая очередями служебной шины, автоматически удаляет дубликаты сообщений, отправленные в очередь или тему, на основании значения свойства [MessageID](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.brokeredmessage.messageid.aspx).

## Емкость и квоты

В этом разделе сравниваются допустимые значения емкости и квот, которые могут использоваться в очередях служебной шины и Azure.

|Критерии сравнения|Очереди Azure|Очереди служебной шины|
|---|---|---|
|Максимальный размер очереди|**200 ТБ**<br/><br/>(в рамках емкости одной учетной записи хранения)|**1–80 ГБ**<br/><br/>(определяется при создании очереди и [включении секционирования](https://msdn.microsoft.com/library/dn520246.aspx); см. раздел "Дополнительные сведения")|
|Максимальный размер сообщения|**64 КБ**<br/><br/>(при использовании кодирования **Base64** — 48 КБ)<br/><br/>Azure поддерживает большие сообщения за счет сочетания очередей и больших двоичных объектов; благодаря этому можно поставить в очередь до 200 ГБ на один элемент.|**256 КБ**<br/><br/>(включая заголовок и текст; максимальный размер заголовка — 64 КБ)|
|Максимальный срок жизни сообщения|**7 дней**|**Без ограничений**|
|Максимальное количество очередей|**Без ограничений**|**10 000**<br/><br/>(для каждого пространства имен службы; может быть увеличено)|
|Максимальное количество параллельных клиентов|**Без ограничений**|**Без ограничений**<br/><br/>(к взаимодействию на основе протокола TCP применяется ограничение в 100 одновременных подключений)|

### Дополнительная информация

- В служебной шине ограничения по размеру применяются принудительно. Максимальный размер очереди задается при создании очереди и может иметь значение в диапазоне от 1 до 80 ГБ. При достижении размера очереди, заданного при ее создании, последующие входящие сообщения отклоняются, а вызывающий код получает исключение. Дополнительные сведения о квотах в служебной шине см. в статье [Квоты служебной шины](https://msdn.microsoft.com/library/ee732538.aspx).

- Можно создавать очереди служебной шины размером 1, 2, 3, 4 или 5 ГБ (по умолчанию — 1 ГБ). Если секционирование включено (по умолчанию), служебная шина создает на каждый гигабайт 16 секций. То есть если вы создаете очередь размером 5 ГБ, за счет секционирования ее максимальный размер составит 80 ГБ (5 х 16). Чтобы просмотреть максимальный размер секционированной очереди или темы, откройте соответствующую запись на портале управления Azure.

- При использовании очередей Azure содержимое сообщений, небезопасное с точки зрения XML, должно кодироваться методом **Base64**. В этом случае размер полезных данных может достигать 48 KБ (а не 64 КБ).

- Каждое сообщение, сохраненное в очереди служебной шины, состоит из двух частей: заголовка и текста. Общий размер сообщения не может превышать 256 КБ.

- Когда клиенты взаимодействуют с очередями служебной шины по протоколу TCP, максимальное количество одновременных подключений к отдельной очереди служебной шины не может превышать 100. Это число распределяется между отправителями и получателями. После достижения квоты запросы на дополнительные соединения отклоняются, а вызывающий код получает исключение. Это ограничение не применяется к клиентам, подключающимся к очередям с помощью интерфейса API на основе REST.

- Если требуется более 10 000 очередей в одном пространстве имен служебной шины, можно отправить запрос на увеличение в службу поддержки Azure. Чтобы увеличить количество очередей служебной шины сверх ограничения в 10 000, вы можете также создать дополнительные пространства имен службы на портале управления Azure.

## Управление и использование

В этом разделе сравниваются возможности управления, предоставляемые очередями служебной шины и Azure.

|Критерии сравнения|Очереди Azure|Очереди служебной шины|
|---|---|---|
|Протокол управления|**REST по протоколу HTTP/HTTPS**|**REST по протоколу HTTPS**|
|Протокол выполнения|**REST по протоколу HTTP/HTTPS**|**REST по протоколу HTTPS**<br/><br/>**Стандарт AMQP 1.0 (TCP с TLS)**| |Управляемый интерфейс API для .NET|**Да**<br/><br/>(Управляемый интерфейс API клиента хранилища для .NET)|**Да**<br/><br/>(управляемый интерфейс API для .NET для обмена сообщениями через посредника)|
|Машинный C++|**Да**|**Нет**|
|API-интерфейс Java|**Да**|**Да**|
|API для PHP|**Да**|**Да**|
|API для Node.js|**Да**|**Да**|
|Поддержка произвольных метаданных|**Да**|**Нет**|
|Правила именования очередей|**До 63 символов**<br/><br/>(буквы в имени очереди должны быть строчными)|**До 260 символов**<br/><br/>(в именах очередей регистр не учитывается)|
|Функция получения длины очереди|**Да**<br/><br/>(приблизительное значение, если сообщение не удаляется после истечения срока жизни)|**Да**<br/><br/>(точное значение в определенный момент времени)|
|Функция просмотра|**Да**|**Да**|

### Дополнительная информация

- Очереди Azure поддерживают произвольные атрибуты, которые могут применяться к описанию очереди, в формате пары "имя/значение"

- Обе технологии также позволяют просматривать сообщения без их блокировки, что может пригодиться при реализации браузера или проводника для очередей.

- В API для .NET для обмена сообщениями через посредника, предоставляемых служебной шиной, используются дуплексные TCP-соединения, позволяющие повысить производительность по сравнению с REST через HTTP. Они также поддерживают стандарт AMQP 1.0.

- Имена очередей Azure могут содержать от 3 до 63 символов, включая строчные буквы, цифры и дефис (-). Дополнительные сведения см. в статье [Именование очередей и метаданных](https://msdn.microsoft.com/library/dd179349.aspx).

- Имя очереди служебной шины может содержать до 260 символов. При этом действуют менее жесткие правила именования: имя может содержать буквы, цифры, точки (.), дефисы (-) и знаки подчеркивания (\_).

## Производительность

В данном разделе сравнивается производительность очередей служебной шины и Azure.

|Критерии сравнения|Очереди Azure|Очереди служебной шины|
|---|---|---|
|Максимальная пропускная способность|**До 2000 сообщений в секунду**<br/><br/>(на основе теста производительности с сообщениями 1 КБ)|**До 2000 сообщений в секунду**<br/><br/>(на основе теста производительности с сообщениями 1 КБ)|
|Среднее время задержки|**10 мс**<br/><br/>(при отключенном [алгоритме Нейгла для TCP](http://blogs.msdn.com/b/windowsazurestorage/archive/2010/06/25/nagle-s-algorithm-is-not-friendly-towards-small-requests.aspx))|**20–25 мс**|
|Поведение при регулировании|**Отклонение с кодом HTTP 503**<br/><br/>(отклоненные запросы не считаются оплачиваемыми)|**Отклонение с исключением/HTTP 503**<br/><br/>(отклоненные запросы не считаются оплачиваемыми)|

### Дополнительная информация

- Одна очередь Azure может обрабатывать до 2000 транзакций в секунду. Под транзакцией подразумевается операция **Put**, **Get** или **Delete**. Отправка одного сообщения в очередь (**Put**) считается одной транзакцией, однако получение сообщения часто происходит в два этапа, включая извлечение (**Get**) и последующий запрос на удаление сообщения из очереди (**Delete**). Как следствие, успешная операция выведения из очереди, как правило, включает в себя две транзакции. Извлечение нескольких сообщений в пакетном режиме может сократить количество транзакций: с помощью операции **Get** можно извлечь до 32 сообщений в одной транзакции, а после вызвать операцию **Delete** для каждого из них. Для повышения производительности вы можете создать несколько очередей (учетная запись хранения поддерживает неограниченное их количество).

- Когда приложение достигает максимальной пропускной способности для очереди Azure, служба очередей обычно возвращает сообщение "HTTP 503, сервер занят". В этом случае приложение должно вызвать логику повторных попыток с экспоненциальным увеличением отсрочки.

- При обработке небольших сообщений (менее 10 КБ) от службы, размещенной в том же регионе, что и учетная запись хранения, время задержки для очередей Azure в среднем составляет 10 мс.

- Как очереди Azure, так и очереди служебной шины обеспечивают регулирование за счет отклонения запросов к регулируемой очереди. В обоих случаях отклоненные запросы не считаются оплачиваемыми.

- Тесты производительности очередей служебной шины показали, что с помощью одной очереди можно обеспечить пропускную способность до 2000 сообщений в секунду при размере сообщений около 1 КБ. Чтобы повысить пропускную способность, используйте несколько очередей. Дополнительные сведения об оптимизации производительности с помощью служебной шины см. в статье [Советы и рекомендации по повышению производительности с помощью обмена сообщениями через посредника служебной шины](https://msdn.microsoft.com/library/hh528527.aspx).

- При достижении максимальной пропускной способности очереди служебной шины клиент очереди получает исключение [ServerBusyException](https://msdn.microsoft.com/library/microsoft.servicebus.messaging.serverbusyexception.aspx) (при использовании интерфейса API для .NET для обмена сообщениями через посредника) или HTTP 503 (при использовании интерфейса API на основе REST). Это означает, что очередь регулируется.

## Аутентификация и авторизация

В этом разделе рассматриваются функции аутентификации и авторизации, поддерживаемые очередями служебной шины и Azure.

|Критерии сравнения|Очереди Azure|Очереди служебной шины|
|---|---|---|
|Аутентификация|**Симметричный ключ**|**Симметричный ключ**|
|Модель безопасности|Делегирование доступа через маркеры SAS|SAS|
|Федерация поставщика удостоверений|**Нет**|**Да**|

### Дополнительная информация

- В обеих технологиях очередей требуется аутентификация при каждом запросе. Общие очереди с анонимным доступом не поддерживаются. При использовании SAS вы можете публиковать SAS только для записи, SAS только для чтения или даже SAS для полного доступа.

- Аутентификация в очередях Azure основана на использовании симметричного ключа, который представляет собой хэш-код аутентификации сообщения (HMAC), вычисляемый по алгоритму SHA-256 и кодируемый в виде строки **Base64**. Дополнительные сведения о соответствующем протоколе см. в статье [Аутентификация при доступе к учетной записи хранения](https://msdn.microsoft.com/library/hh225339.aspx). Очереди служебной шины поддерживают аналогичную модель с использованием симметричных ключей. Дополнительные сведения см. в статье [Проверка подлинности подписанного URL-адреса с помощью служебной шины](https://msdn.microsoft.com/library/dn170477.aspx).

## Стоимость

В этом разделе сравнивается стоимость очередей служебной шины и Azure.

|Критерии сравнения|Очереди Azure|Очереди служебной шины|
|---|---|---|
|Стоимость транзакции с очередью|**0,0036 долл. США**<br/><br/>(за 100 000 транзакций)|**Уровень Basic**: **0,05 долл. США**<br/><br/>(за миллион операций)|
|Оплачиваемые операции|**Все**|**Только отправка и получение**<br/><br/>(другие операции не оплачиваются)|
|Транзакции в состоянии простоя|**Подлежат оплате**<br/><br/>(запрос к пустой очереди считается оплачиваемой операцией)|**Подлежат оплате**<br/><br/>(операция получения, применяемая к пустой очереди, считается оплачиваемой)|
|Стоимость хранения|**0,07 долл. США**<br/><br/>(за ГБ/месяц)|**0,00 долл. США**|
|Стоимость передачи исходящих данных|**0,12–0,19 долл. США**<br/><br/>(в зависимости от региона)|**0,12–0,19 долл. США**<br/><br/>(в зависимости от региона)|

### Дополнительная информация

- Передача данных оплачивается на основе общего объема данных, исходящего из центров обработки данных Azure через Интернет за определенный расчетный период.

- За передачу данных между службами Azure, расположенными в пределах одного региона, плата не взимается.

- На момент написания данной статьи плата за входящие данные не взимается.

- С учетом поддержки продолжительного опроса использование очередей служебной шины может быть выгодно в сценариях, когда требуется обеспечить доставку с малым временем задержки.

>[AZURE.NOTE]Информация о ценах может быть изменена. В таблице представлены цены на момент написания статьи без учета действующих специальных предложений. Обновленную информацию о ценах Azure см. на странице [Цены Azure](http://azure.microsoft.com/pricing/). Дополнительные сведения о ценах на использование служебной шины см. в статье [Служебная шина: цены](http://azure.microsoft.com/pricing/details/service-bus/).

## Заключение

Глубокое понимание описанных технологий поможет вам сделать более обоснованный выбор. Решение о том, когда следует использовать очереди Azure, а когда очереди служебной шины, зависит от целого ряда факторов. Все они могут в значительной степени зависеть от конкретных требований приложения и его архитектуры. Если в приложении уже используются основные возможности Microsoft Azure, предпочтительным может оказаться использование очередей Azure, особенно если необходимы базовые функции обмена информацией и сообщениями между службами или требуется работа с очередями размером более 80 ГБ.

Так как очереди служебной шины предлагают ряд расширенных функций (в том числе сеансы, транзакции, обнаружение дубликатов, автоматическое перемещение в "мертвую очередь", возможности публикации или подписки), они могут оказаться предпочтительнее для построения гибридного приложения или если в приложении они требуются по каким-либо другим причинам.

## Дальнейшие действия

Для получения подробной информации и рекомендаций по использованию очередей служебной шины и Azure см. следующие статьи:

- [Использование очередей служебной шины](service-bus-dotnet-how-to-use-queues.md)
- [Использование службы хранения очередей](../storage-dotnet-how-to-use-queues.md)
- [Советы и рекомендации по повышению производительности с помощью обмена сообщениями через посредника служебной шины](https://msdn.microsoft.com/library/hh528527.aspx)
- [Общие сведения об очередях служебной шины Azure](http://www.code-magazine.com/article.aspx?quickid=1112041)
- [Руководство разработчика по служебной шине](http://www.cloudcasts.net/devguide/)
- [Таблицы и очереди Azure: глубокое погружение](http://www.microsoftpdc.com/2009/SVC09)
- [Архитектура хранилища Azure](http://blogs.msdn.com/b/windowsazurestorage/archive/2011/11/20/windows-azure-storage-a-highly-available-cloud-storage-service-with-strong-consistency.aspx)
- [Использование службы очередей в Azure ](http://www.developerfusion.com/article/120197/using-the-queuing-service-in-windows-azure/)
- [Общая информация о плате за использование хранилища Azure: пропускная способность, транзакции и емкость](http://blogs.msdn.com/b/windowsazurestorage/archive/2010/07/09/understanding-windows-azure-storage-billing-bandwidth-transactions-and-capacity.aspx)
 

<!---HONumber=Oct15_HO3-->