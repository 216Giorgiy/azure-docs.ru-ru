<properties 
   pageTitle="Архитектура служебной шины | Microsoft Azure"
   description="В данном разделе описывается архитектура обработки сообщений, которая используется служебной шиной Azure."
   services="service-bus"
   documentationCenter="na"
   authors="sethmanheim"
   manager="timlt"
   editor="tysonn" />
<tags 
   ms.service="service-bus"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="11/06/2015"
   ms.author="sethm" />

# Архитектура служебной шины

В этой статье описывается архитектура обработки сообщений, которая используется служебной шиной Azure.

## Единицы масштабирования служебной шины

Содержимое служебной шины упорядочено по *единицам масштабирования*. Единица масштабирования — это единица развертывания, которая содержит все компоненты, необходимые для запуска службы. Для каждой области развертывается одна или несколько единиц масштабирования служебной шины.

С единицей масштабирования сопоставляется пространство имен служебной шины. Единица масштабирования обрабатывает все типы сущностей служебной шины: ретрансляции и обмен сообщениями через брокер (очереди, разделы, подписки). Единица масштабирования служебной шины состоит из следующих компонентов.

- **Набор узлов шлюза.** Узлы шлюза проверяют подлинность входящих запросов и обрабатывают запросы на ретрансляцию. У каждого узла шлюза есть общедоступный IP-адрес.

- **Набор узлов брокера сообщений.** Узлы брокера сообщений обрабатывают запросы к сущностям обмена сообщениями.

- **Набор узлов уведомлений.** Узлы уведомлений отправляют push-уведомления на все зарегистрированные устройства.

- **Единое хранилище шлюза.** Хранилище шлюза содержит данные по каждой сущности, определенной в соответствующей единице масштабирования. Хранилище шлюза реализуется на основе базы данных SQL Azure.

- **Множество хранилищ сообщений.** Хранилища сообщений содержат сообщения из всех очередей, разделов и подписок, определенных в соответствующей единице масштабирования. Здесь же хранятся все данные подписки. Если не включены [секционированные сущности обмена сообщениями](service-bus-partitioning.md), каждая очередь или раздел сопоставляется с одним хранилищем сообщений. Подписки хранятся в том же хранилище сообщений, что и соответствующий родительский раздел. Кроме [обмена сообщениями (цен. категория "Премиум")](service-bus-premium-messaging.md) служебной шины, хранилища сообщений реализуются на основе Баз данных SQL Azure.

- **Несколько хранилищ регистрационных данных.** Хранилища регистрационных данных содержат регистрационные данные устройств для всех центров уведомлений, определенных в соответствующей единице масштабирования. Хранилища регистрационных данных реализуются на основе баз данных SQL Azure.

## Контейнеры

Каждой сущности обмена сообщениями назначается определенный контейнер. Контейнер — это логическая конструкция, которая использует одно единственное хранилище сообщений для хранения всех соответствующих данных в этом контейнере. Каждый контейнер назначается узлу брокера сообщений. Обычно контейнеров больше, чем узлов брокера сообщений. Таким образом, каждый узел брокера сообщений загружает несколько контейнеров. Контейнеры назначаются узлу брокера сообщений таким образом, чтобы все узлы брокера сообщений были загружены в равной мере. Если шаблон нагрузки меняется (например, один из контейнеров загружается слишком сильно) или узел брокера сообщений становится временно недоступным, контейнеры перераспределяются между узлами брокера сообщений.

## Обработка входящих запросов обмена сообщениями

Когда клиент отправляет запрос на служебную шину, подсистема балансировки нагрузки Azure передает его в один из узлов шлюза. Узел шлюза авторизует запрос. Если запрос относится к сущности обмена сообщениями (очереди, разделу или подписке), узел шлюза выполняет поиск этой сущности в хранилище шлюза и определяет, в каком хранилище сообщений она находится. Затем он определяет, какой узел брокера сообщений обслуживает данный контейнер в настоящий момент, и отправляет запрос на этот узел брокера сообщений. Узел брокера сообщений обрабатывает запрос и обновляет состояние сущности в хранилище контейнера. Узел брокера сообщений отправляет ответ обратно на узел шлюза, который пересылает соответствующий ответ клиенту, отправившему исходный запрос.

![Обработка входящих запросов обмена сообщениями](./media/service-bus-architecture/IC690644.png)

## Обработка входящих запросов на ретрансляцию

Когда клиент отправляет запрос на служебную шину, подсистема балансировки нагрузки Azure передает его в один из узлов шлюза. Если запрос связан с прослушиванием, узел шлюза создает новую ретрансляцию. Если запрос связан с подключением к определенной ретрансляции, узел шлюза переадресовывает его на узел шлюза, которому принадлежит ретрансляция. Узел шлюза, которому принадлежит ретрансляция, отправляет запрос о подключении клиенту прослушивания, чтобы прослушиватель создал временный канал к узлу шлюза, получившему запрос на подключение.

Как только подключение ретрансляции будет установлено, клиенты смогут обмениваться сообщениями через узел шлюза, используемый для связи.

![Обработка входящих запросов на ретрансляцию](./media/service-bus-architecture/IC690645.png)

## Обработка входящих запросов концентратора уведомлений

Когда клиент отправляет запрос на служебную шину, подсистема балансировки нагрузки Azure передает его в один из узлов шлюза. Если запрос содержит регистрационные данные устройства в существующем концентраторе уведомлений, узел шлюза записывает регистрационные данные в хранилище регистрационных данных и отправляет ответ вызывающему устройству. Если запрос представляет собой уведомление, узел шлюза добавляет его в очередь уведомлений. Один из узлов уведомлений извлекает сообщение из очереди уведомлений и отправляет его на все устройства, зарегистрированные в хранилище регистрационных данных. Если сообщение должно быть получено большим количеством устройств, оно отправляется на устройства через несколько узлов уведомлений.

![Обработка входящих запросов концентратора уведомлений](./media/service-bus-architecture/IC690646.png)

## Дальнейшие действия

Теперь, когда вы ознакомились с основными принципами работы служебной шины, изучите следующие статьи.

- [Основные сведения об обмене сообщениями через служебную шину](service-bus-messaging-overview.md)
- [Базовая информация о Service Bus](service-bus-fundamentals-hybrid-solutions.md)
- [Решение для обмена сообщениями в очереди при помощи очередей служебной шины](service-bus-dotnet-multi-tier-app-using-service-bus-queues.md)

<!---HONumber=Nov15_HO3-->