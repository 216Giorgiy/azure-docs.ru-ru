<properties
	pageTitle="Использование очередей служебной шины (Ruby) | Microsoft Azure"
	description="Узнайте, как использовать очереди служебной шины в Azure. Примеры кода написаны на Ruby."
	services="service-bus"
	documentationCenter="ruby"
	authors="sethmanheim"
	manager="timlt"
	editor=""/>

<tags
	ms.service="service-bus"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="ruby"
	ms.topic="article"
	ms.date="03/09/2016"
	ms.author="sethm"/>

# Как использовать очереди служебной шины

[AZURE.INCLUDE [service-bus-selector-queues](../../includes/service-bus-selector-queues.md)]

В этом руководстве показано, как использовать очереди служебной шины. Примеры написаны с помощью Ruby и используют пакет Azure. Здесь описаны такие сценарии, как **создание очередей, отправка и получение сообщений**, а также **удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие действия](#next-steps).

## Что такое очереди служебной шины?

Очереди служебной шины поддерживают модель *обмена сообщениями через посредника*. При использовании очередей компоненты распределенного приложения не взаимодействуют между собой напрямую, а обмениваются сообщениями через очередь, которая выступает в качестве посредника. Производитель (отправитель) передает сообщение в очередь, а затем продолжает его обработку. Потребитель сообщения (получатель) асинхронно извлекает сообщение из очереди и обрабатывает его. Поставщику не нужно ждать ответа от потребителя, чтобы продолжить обработку и отправку дальнейших сообщений. Очереди предлагают доставку сообщений конкурирующим потребителям по типу **FIFO** (первым пришел, первым вышел). То есть обычно получатели принимают и обрабатывают сообщения в том порядке, в котором они были добавлены в очередь, и каждое сообщение принимается и обрабатывается только одним потребителем сообщений.

![QueueConcepts](./media/service-bus-ruby-how-to-use-queues/sb-queues-08.png)

Очереди служебной шины — это технология общего назначения, которая может использоваться для разнообразных сценариев:

-   взаимодействие между веб-ролью и рабочей ролью в [многоуровневом приложении Azure](service-bus-dotnet-multi-tier-app-using-service-bus-queues.md);
-   взаимодействие между локальными приложениями и приложениями, размещенными в Azure, в [гибридном решении](service-bus-dotnet-hybrid-app-using-service-bus-relay.md).
-   Связь между компонентами распределенного приложения, которое работает в другой организации или в другом подразделении данной организации.

С помощью очередей можно лучше масштабировать приложения и придать вашей архитектуре большую устойчивость.

## Создание пространства имен службы

Чтобы начать использовать очереди служебной шины в Azure, необходимо сначала создать пространство имен службы. Это пространство имен службы предоставляет контейнер для адресации ресурсов служебной шины в вашем приложении. Так как классический портал Azure не создает пространство имен с подключением ACS, необходимо создать пространство имен через интерфейс командной строки.

Создание пространства имен службы:

1. Откройте консоль Azure Powershell.

2. Введите следующую команду, чтобы создать пространство имен служебной шины. Укажите собственное значение пространства имен и укажите ту же область, что и у приложения.

    ```
	New-AzureSBNamespace -Name 'yourexamplenamespace' -Location 'West US' -NamespaceType 'Messaging' -CreateACSNamespace $true

    ![Create Namespace](./media/service-bus-ruby-how-to-use-queues/showcmdcreate.png)
	```

## Получение учетных данных управления для пространства имен

Для выполнения операций управления, таких как создание очереди в новом пространстве имен, необходимо получить учетные данные управления для пространства имен.

Командлет PowerShell, выполненный с целью создания пространства имен служебной шины Azure, отображает ключ, который можно использовать для управления пространством имен. Скопируйте значение **DefaultKey**. Оно понадобится в коде дальше в этом учебнике.

![Копирование ключа](./media/service-bus-ruby-how-to-use-queues/defaultkey.png)

> [AZURE.NOTE] Этот ключ также можно найти на [классическом портале Azure](http://manage.windowsazure.com/) в разделе сведений о подключении для пространства имен служебной шины.

## Создание приложения Ruby

Создайте приложение Ruby. Инструкции см. в разделе [Создание приложения Ruby в Azure](/develop/ruby/tutorials/web-app-with-linux-vm/).

## Настройка приложения для использования служебной шины

Для использования служебной шины Azure скачайте и используйте пакет Ruby Azure, который содержит набор библиотек, взаимодействующих со службами REST хранилища.

### Использование RubyGems для получения пакета

1. Используйте интерфейс командной строки, например **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix).

2. Введите "gem install azure" в окне командной строки, чтобы установить пакеты и зависимости.

### Импорт пакета

Используйте свой любимый текстовый редактор, чтобы добавить следующий код в начало файла Ruby, где планируется использовать хранилище.

```
require "azure"
```

## Настройка подключения к служебной шине Azure

Модуль Azure считывает переменные среды **AZURE\_SERVICEBUS\_NAMESPACE** и **AZURE\_SERVICEBUS\_ACCESS\_KEY** для получения данных, необходимых для подключения к вашему пространству имен служебной шины. Если эти переменные среды не заданы, необходимо указать сведения о пространстве имен перед использованием **Azure::ServiceBusService** с помощью следующего кода:

```
Azure.config.sb_namespace = "<your azure service bus namespace>"
Azure.config.sb_access_key = "<your azure service bus access key>"
```

Задайте для пространства имен только созданное значение, а не весь URL-адрес. Например, используйте **yourexamplenamespace**, а не yourexamplenamespace.servicebus.windows.net.

## Как создать очередь

Объект **Azure::ServiceBusService** позволяет работать с очередями. Чтобы создать очередь, используйте метод **create\_queue()**. В следующем примере создается очередь или выводится ошибка, если она возникла.

```
azure_service_bus_service = Azure::ServiceBusService.new
begin
  queue = azure_service_bus_service.create_queue("test-queue")
rescue
  puts $!
end
```

Можно также передать объект **Azure::ServiceBus::Queue** с дополнительными параметрами, которые позволяют переопределить параметры очереди по умолчанию, например срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить максимальный размер очереди в 5 ГБ и срок жизни в 1 минуту.

```
queue = Azure::ServiceBus::Queue.new("test-queue")
queue.max_size_in_megabytes = 5120
queue.default_message_time_to_live = "PT1M"

queue = azure_service_bus_service.create_queue(queue)
```

## Как отправлять сообщения в очередь

Чтобы отправить сообщение в очередь служебной шины, ваше приложение вызывает метод **send\_queue\_message()** для объекта **Azure::ServiceBusService**. Сообщения, отправленные (и полученные) из очередей служебной шины — это объекты **Azure::ServiceBus::BrokeredMessage**. У них есть набор стандартных свойств (например, **label** и **time\_to\_live**), словарь, используемый для хранения настраиваемых свойств приложения, и текст произвольных данных приложения. Приложение может задать текст сообщения, передав строковое значение как сообщение, а все необходимые стандартные свойства будут заполнены значениями по умолчанию.

В следующем примере показано, как отправить тестовое сообщение в очередь test-queue с помощью метода **send\_queue\_message()**:

```
message = Azure::ServiceBus::BrokeredMessage.new("test queue message")
message.correlation_id = "test-correlation-id"
azure_service_bus_service.send_queue_message("test-queue", message)
```

Очереди служебной шины поддерживают максимальный размер сообщения 256 КБ (максимальный размер заголовка, который содержит стандартные и настраиваемые свойства приложения, — 64 КБ). Ограничения на количество сообщений в очереди нет, но есть максимальный общий размер сообщений, содержащихся в очереди. Этот размер очереди, определяемый в момент ее создания, не должен превышать 5 ГБ.

## Как получать сообщения из очереди

Сообщения извлекаются из очереди с помощью метода **receive\_queue\_message()** объекта **Azure::ServiceBusService**. По умолчанию сообщения считываются и блокируются без удаления из очереди. Однако вы можете удалить сообщения из очереди после их чтения, установив для параметра **:peek\_lock** значение **false**.

По умолчанию чтение и удаление выполняются в два этапа, что позволяет поддерживать приложения, не способные обрабатывать отсутствующие сообщения. Получив запрос, служебная шина находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению. Когда приложение завершает обработку сообщения (или сохраняет его для будущей обработки), она завершает второй этап процесса получения, вызывая метод **delete\_queue\_message()** и указывая сообщение для удаления в качестве параметра. Метод **delete\_queue\_message()** помечает сообщение как используемое и удаляет его из очереди.

Если параметр **:peek\_lock** имеет значение **false**, чтение и удаление сообщения становится очень простым процессом и оптимально подходит для сценариев, в которых приложение может не обработать сообщение в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку служебная шина помечает сообщение как использованное, то когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.

В следующем примере показано, как получать и обрабатывать сообщения с помощью **receive\_queue\_message()**. Сначала пример получает и удаляет сообщение с помощью параметра **:peek\_lock**, для которого задано значение **false**, затем он получает другое сообщение и удаляет его с помощью метода **delete\_queue\_message()**.

```
message = azure_service_bus_service.receive_queue_message("test-queue",
  { :peek_lock => false })
message = azure_service_bus_service.receive_queue_message("test-queue")
azure_service_bus_service.delete_queue_message(message)
```

## Как обрабатывать сбои приложения и нечитаемые сообщения

служебная шина предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock\_queue\_message()** объекта **Azure::ServiceBusService**. После этого служебная шина разблокирует сообщение в очереди и сделает его доступным для приема тем же или другим приложением-пользователем.

Кроме того, с сообщением, блокированным в очереди, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), служебная шина автоматически разблокирует сообщение и снова сделает его доступным для получения.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода **delete\_queue\_message()**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют **обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться минимум один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью свойства **message\_id** сообщения, которое остается постоянным в ходе разных попыток доставки.

## Дальнейшие действия

Вы узнали основные сведения об очередях служебной шины. Для получения дополнительных сведений используйте следующие ссылки.

-   Обзор [очередей, разделов и подписок](service-bus-queues-topics-subscriptions.md).
-   Посетите репозиторий [пакетов SDK Azure для Ruby](https://github.com/Azure/azure-sdk-for-ruby) на веб-сайте GitHub.

Сравнение очередей служебной шины Azure, описанных в этой статье, и очередей служебной шины Azure, описанных в статье [Использование хранилища очередей из Ruby](../storage/storage-ruby-how-to-use-queue-storage.md), см. в статье [Очереди Azure и очереди служебной шины: сходства и различия](service-bus-azure-and-service-bus-queues-compared-contrasted.md).
 

<!---HONumber=AcomDC_0316_2016-->