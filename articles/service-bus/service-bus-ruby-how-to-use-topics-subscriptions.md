<properties
	pageTitle="Использование разделов служебной шины (Ruby): Azure"
	description="Узнайте, как использовать разделы и подписки служебной шины в Azure. Примеры кода написаны для приложений Ruby."
	services="service-bus"
	documentationCenter="ruby"
	authors="tfitzmac"
	manager="wpickett"
	editor=""/>

<tags
	ms.service="service-bus"
	ms.workload="tbd"
	ms.tgt_pltfrm="na"
	ms.devlang="ruby"
	ms.topic="article"
	ms.date="03/20/2015"
	ms.author="tomfitz"/>





# Использование разделов и подписок служебной шины

В этом руководстве показано, как использовать разделы и подписки служебной шины в приложениях Ruby. В этой статье описаны такие сценарии, как **создание разделов и подписок, создание фильтров подписок, отправка сообщений** в раздел, **получение сообщений от подписки** и **удаление разделов и подписок**. Дополнительные сведения о разделах и подписках см. в разделе [Дальнейшие действия](#NextSteps).

## Общая информация о разделах и подписках служебной шины

Разделы и подписки служебной шины поддерживают модель **обмена сообщениями публикации или подписки**. При использовании разделов и подписок компоненты распределенного приложения не взаимодействуют между собой напрямую, а обмениваются сообщениями через раздел, который выступает в качестве посредника.

![TopicConcepts](./media/service-bus-ruby-how-to-use-topics-subscriptions/sb-topics-01.png)

В отличие от очередей служебной шины, где каждое сообщение обрабатывается одним потребителем, разделы и подписки предоставляют вид связи **один ко многим** с помощью шаблона публикации или подписки. Можно зарегистрировать несколько подписок на раздел. Когда сообщение отправляется в раздел, оно затем может обрабатываться независимо каждой подпиской.

Раздел подписки напоминает виртуальную очередь, которая получает копии сообщений, отправленных в раздел. Вы можете зарегистрировать правила фильтрации для раздела на основе подписки, которые позволят указать, какие сообщения и от каких подписок могут быть получены разделом.

Разделы и подписки служебной шины обеспечивают возможность масштабирования для обработки очень большого количества сообщений для очень большого количества пользователей и приложений.

## Создание пространства имен службы

Чтобы начать использовать очереди служебной шины в Azure, необходимо сначала создать пространство имен службы. Это пространство имен службы предоставляет контейнер для адресации ресурсов служебной шины в вашем приложении. Так как портал не создает служебную шину с помощью подключения ACS, необходимо создать пространство имен через интерфейс командной строки.

Создание пространства имен службы:

1. Откройте консоль Azure Powershell.

2. Введите команду для создания пространства имен служебной шины Azure, как показано ниже. Укажите собственное значение пространства имен и укажите ту же область, что и у приложения.

      New-AzureSBNamespace -Name 'yourexamplenamespace' -Location 'West US' -NamespaceType 'Messaging' -CreateACSNamespace $true

      ![Создание пространства имен](./media/service-bus-ruby-how-to-use-topics-subscriptions/showcmdcreate.png)

## Получение учетных данных управления по умолчанию для пространства имен

Для выполнения операций управления, таких как создание очереди в новом пространстве имен, необходимо получить учетные данные управления для пространства имен.

Командлет PowerShell, выполненный с целью создания пространства имен служебной шины Azure, отображает ключ, который можно использовать для управления пространством имен. Скопируйте значение **DefaultKey**. Оно понадобится в коде дальше в этом учебнике.

      ![Copy key](./media/service-bus-ruby-how-to-use-topics-subscriptions/defaultkey.png)

> [AZURE.NOTE]Этот ключ можно также найти при входе на [портал управления Azure](http://manage.windowsazure.com/) и перейти к сведениям о подключении для пространства имен вашей служебной шины.

## Создание приложения Ruby

Создайте приложение Ruby. Инструкции см. в разделе [Создание приложения Ruby в Azure](/develop/ruby/tutorials/web-app-with-linux-vm/).

## Настройка приложения для использования служебной шины

Для использования служебной шины Azure необходимо загрузить и использовать пакет Ruby Azure, который содержит набор библиотек, взаимодействующих со службами REST хранилища.

### Использование RubyGems для получения пакета

1. Используйте интерфейс командной строки, например **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix).

2. Введите "gem install azure" в окне командной строки, чтобы установить пакеты и зависимости.

### Импорт пакета

Используйте свой любимый текстовый редактор, чтобы добавить следующий код в начало файла Ruby, где планируется использовать хранилище.

    require "azure"

## Настройка подключения к служебной шине Azure

Модуль Azure выполнит чтение переменных среды **AZURE_SERVICEBUS_NAMESPACE** и **AZURE_SERVICEBUS_ACCESS_KEY** для получения информации, необходимой для подключения к пространству имен служебной шины Azure. Если эти переменные среды не заданы, необходимо указать сведения о пространстве имен перед использованием **Azure::ServiceBusService** с помощью следующего кода:

    Azure.config.sb_namespace = "<your azure service bus namespace>"
    Azure.config.sb_access_key = "<your azure service bus access key>"

Задайте для пространства имен служебной шины только созданное значение, а не весь URL-адрес. Например, используйте **yourexamplenamespace**, а не yourexamplenamespace.servicebus.windows.net.

## Как создать раздел

Объект **Azure::ServiceBusService** позволяет работать с разделами. Следующий код создает объект **Azure::ServiceBusService**. Чтобы создать раздел, используйте метод **create_topic()**. В следующем примере создается раздел или выводится ошибка, если она возникла.

	azure_service_bus_service = Azure::ServiceBusService.new
	begin
      topic = azure_service_bus_service.create_queue("test-topic")
    rescue
      puts $!
    end

Можно также передать объект **Azure::ServiceBus::Topic** с дополнительными параметрами, которые позволяют переопределить параметры раздела по умолчанию, например срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить максимальный размер очереди 5 ГБ и срок жизни 1 минута.

	topic = Azure::ServiceBus::Topic.new("test-topic")
    topic.max_size_in_megabytes = 5120
    topic.default_message_time_to_live = "PT1M"

    topic = azure_service_bus_service.create_topic(topic)

## Создание подписок

Подписки разделов также создаются с помощью объекта **Azure::ServiceBusService**. У подписок есть имена, и они могут использовать дополнительный фильтр, ограничивающий набор сообщений, доставляемых в виртуальную очередь подписки.

Подписки являются постоянными и продолжают существовать либо до их удаления, либо до удаления раздела, с которым они связаны. Если приложение содержит логику для создания подписки, оно сначала должно проверить, существует ли подписка, используя метод getSubscription.

### Создание подписки с фильтром по умолчанию (MatchAll)

Фильтр **MatchAll** является фильтром по умолчанию, используемым, если при создании новой подписки не указан фильтр. Если используется фильтр **MatchAll**, все сообщения, опубликованные в разделе, помещаются в виртуальную очередь подписки. В следующем примере создается подписка с именем "all-messages" и используется фильтр по умолчанию **MatchAll**.

	subscription = azure_service_bus_service.create_subscription("test-topic",
	  "all-messages")

### <a id="how-to-create-subscriptions"></a>Создание подписок с фильтрами

Вы также можете настроить фильтры, позволяющие определять, какие сообщения, отправленные в раздел, будут отображаться в определенной подписке раздела.

Самый гибкий тип фильтра, который поддерживается подписками, — это **Azure::ServiceBus::SqlFilter**, реализующий подмножество SQL92. Фильтры SQL работают со свойствами сообщений, которые опубликованы в разделе. Дополнительные сведения о выражениях, которые можно использовать с SQL-фильтром, см. в описании синтаксиса [SqlFilter.SqlExpression](http://msdn.microsoft.com/library/windowsazure/microsoft.servicebus.messaging.sqlfilter.sqlexpression.aspx).

Фильтры можно добавить в подписку с помощью метода **create_rule()** объекта **Azure::ServiceBusService**. Этот метод позволяет добавлять новые фильтры в существующую подписку.

Так как ко всем новым подпискам автоматически применяется фильтр по умолчанию, сначала необходимо удалить фильтр по умолчанию либо **MatchAll** переопределит поведение всех остальных заданных фильтров. Вы можете удалить правило по умолчанию с помощью метода **delete_rule()** объекта **Azure::ServiceBusService**.

В примерах ниже создается подписка с именем high-messages с фильтром **Azure::ServiceBus::SqlFilter**, который выбирает только сообщения, значение настраиваемого свойства **message_number** которых больше 3.

	subscription = azure_service_bus_service.create_subscription("test-topic",
	  "high-messages")
	azure_service_bus_service.delete_rule("test-topic", "high-messages",
	  "$Default")

	rule = Azure::ServiceBus::Rule.new("high-messages-rule")
	rule.topic = "test-topic"
	rule.subscription = "high-messages"
	rule.filter = Azure::ServiceBus::SqlFilter.new({
	  :sql_expression => "message_number > 3" })
	rule = azure_service_bus_service.create_rule(rule)

Следующий пример создает подписку с именем low-messages с фильтром **Azure::ServiceBus::SqlFilter**, который выбирает только сообщения, значение свойства **message_number** которых меньше или равно 3.

	subscription = azure_service_bus_service.create_subscription("test-topic",
	  "low-messages")
	azure_service_bus_service.delete_rule("test-topic", "low-messages",
	  "$Default")

	rule = Azure::ServiceBus::Rule.new("low-messages-rule")
	rule.topic = "test-topic"
	rule.subscription = "low-messages"
	rule.filter = Azure::ServiceBus::SqlFilter.new({
	  :sql_expression => "message_number <= 3" })
	rule = azure_service_bus_service.create_rule(rule)

Если сообщение будет отправлено в раздел "test-topic", оно всегда будет доставляться в приемники, подписанные на подписку раздела "all-messages", и в отдельные приемники, подписанные на подписки разделов "high-messages" и "low-messages" (в зависимости от содержимого сообщений).

## Как отправлять сообщения в раздел

Чтобы отправить сообщение в раздел служебной шины, приложение должно использовать метод **send_topic_message()** объекта **Azure::ServiceBusService**. Сообщения, отправленные в разделы служебной шины — это объекты **Azure::ServiceBus::BrokeredMessage**. У объектов **Azure::ServiceBus::BrokeredMessage** есть набор стандартных свойств (например, **label** и **time_to_live**), словарь, используемый для хранения настраиваемых свойств приложения, и текст из строковых данных. Приложение может задать текст сообщения, передав строковое значение в метод **send_topic_message()**, а все необходимые стандартные свойства будут заполнены значениями по умолчанию.

В следующем примере показано, как отправить 5 тестовых сообщений в раздел "test-topic". Обратите внимание, что значение настраиваемого свойства **message_number** каждого сообщения зависит от итерации цикла (это определяет, получит ли подписка сообщение).

	5.times do |i|
	  message = Azure::ServiceBus::BrokeredMessage.new("test message " + i,
	    { :message_number => i })
	  azure_service_bus_service.send_topic_message("test-topic", message)
	end

Разделы служебной шины поддерживают максимальный размер сообщения 256 МБ (максимальный размер заголовка, содержащего стандартные и настраиваемые свойства приложения — 64 МБ). Ограничения на количество сообщений в разделе нет, но есть максимальный общий размер сообщений, содержащихся в разделе. Этот размер задается при создании с верхним пределом 5 ГБ.

## Как получать сообщения из подписки

Сообщения извлекаются из подписки с помощью метода **receive_subscription_message()** объекта **Azure::ServiceBusService**. По умолчанию сообщения считываются и блокируются без удаления из подписки. Вы можете читать сообщения и удалять их из подписки, установив для параметра **peek_lock** значение **false**.

По умолчанию чтение и удаление выполняются в 2 этапа, что позволяет поддерживать приложения, не способные обрабатывать отсутствующие сообщения. Получив запрос, служебная шина находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению. Когда приложение завершает обработку сообщения (или сохраняет его для будущей обработки), она завершает второй этап процесса получения, вызывая метод **delete_subscription_message()** и указывая сообщение для удаления в качестве параметра. Метод **delete_subscription_message()** помечает сообщение как используемое и удаляет его из подписки.

Если параметр **:peek_lock** имеет значение **false**, чтение и удаление сообщения становится очень простым процессом и оптимально подходит для сценариев, в которых приложение может не обработать сообщение в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку служебная шина помечает сообщение как использованное, то когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.

В примере ниже показано, как можно получать и обрабатывать сообщения с помощью метода **receive_subscription_message()**. Этот пример сначала получает и удаляет сообщение из подписки low-messages, установив для параметра **:peek_lock** значение **false**, а затем получает другое сообщение из high-messages и удаляет сообщение с помощью метода **delete_subscription_message()**.

    message = azure_service_bus_service.receive_subscription_message(
	  "test-topic", "low-messages", { :peek_lock => false })
    message = azure_service_bus_service.receive_subscription_message(
	  "test-topic", "high-messages")
    azure_service_bus_service.delete_subscription_message(message)

## Как обрабатывать сбои приложения и нечитаемые сообщения

Служебная шина предоставляет функции, помогающие правильно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock_subscription_message()** объекта **Azure::ServiceBusService**. После этого служебная шина разблокирует сообщение в подписке и снова сделает его доступным для получения тем же или другим приложением.

Кроме того, с сообщением, заблокированным в подписке, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), служебная шина разблокирует сообщение автоматически и сделает его доступным для приема.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода **delete_subscription_message()**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют **обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью свойства **message_id** сообщения, которое остается константным для различных попыток доставки.

## Как удалять разделы и подписки

Разделы и подписки являются постоянными, и их необходимо удалять явным образом на [портале управления Azure](https://manage.windowsazure.com) или программными средствами. В приведенном ниже примере показано, как удалить раздел с именем "test-topic".

	azure_service_bus_service.delete_topic("test-topic")

При удалении раздела также удаляются все подписки, зарегистрированные в этом разделе. Подписки также можно удалять по отдельности. В следующем примере кода показано, как удалить подписку с именем "high-messages" из раздела "test-topic":

	azure_service_bus_service.delete_subscription("test-topic", "high-messages")

## Дальнейшие действия

Вы узнали основные сведения о разделах служебной шины. Для получения дополнительных сведений используйте следующие ссылки.

-   См. справочник MSDN: [Очереди, разделы и подписки](http://msdn.microsoft.com/library/windowsazure/hh367516.aspx)
-   Справочник API для [SqlFilter](http://msdn.microsoft.com/library/windowsazure/microsoft.servicebus.messaging.sqlfilter.aspx)
-	Посетите репозиторий [Azure SDK для Ruby](https://github.com/WindowsAzure/azure-sdk-for-ruby) на веб-сайте GitHub
 

<!---HONumber=July15_HO3-->