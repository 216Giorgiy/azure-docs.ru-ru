<properties 
    pageTitle="Руководство по использованию протокола AMQP 1.0 в служебной шине и концентраторах событий Azure | Microsoft Azure" 
    description="Руководство по использованию протоколов, в котором рассматривается выражение и описание протокола AMQP 1.0 в служебной шине и концентраторах событий Azure" 
    services="service-bus,event-hubs" 
    documentationCenter=".net" 
    authors="clemensv" 
    manager="timlt" 
    editor=""/>

<tags
    ms.service="service-bus"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="na" 
    ms.date="07/01/2016"
    ms.author="clemensv;jotaub;hillaryc;sethm"/>

# Руководство по использованию протокола AMQP 1.0 в служебной шине и концентраторах событий Azure

Улучшенный протокол очередей сообщений (AMQP) 1.0 — это стандартный протокол кадрирования и передачи, который обеспечивает асинхронную безопасную и надежную передачу сообщений между двумя сторонами. Это основной протокол, применяемый для обмена сообщениями служебной шины Azure и концентраторов событий Azure. Обе службы также поддерживают протокол HTTPS. Защищаемый протокол SBMP, который также поддерживается, постепенно вытесняется в пользу протокола AMQP.

Протокол AMQP 1.0 — это результат совместной работы в разных отраслях, которая объединила таких производителей ПО промежуточного слоя, как корпорация Майкрософт и Red Hat, с большим количеством пользователей ПО промежуточного слоя для обмена сообщениями, например компанией JP Morgan Chase, представляющей собой индустрию финансовых услуг. На форуме OASIS по технической стандартизации официально утверждено, что спецификации протокола и расширения AMQP соответствуют международному стандарту ISO/IEC 19494.

## Цели

В этой статье кратко представлены основные понятия спецификации обмена сообщениями по протоколу AMQP 1.0, а также небольшой набор спецификаций черновых расширений, которые дорабатываются в техническом комитете OASIS по AMQP. Здесь также объясняется, как служебная шина Azure реализует и использует эти спецификации.

Цель заключается в том, чтобы все разработчики, использующие любой имеющийся стек клиента AMQP 1.0 на любой платформе, могли взаимодействовать со служебной шиной Azure через протокол AMQP 1.0.

Распространенные стеки общего назначения AMQP 1.0, например Apache Proton или AMQP.NET Lite, уже реализуют все основные жесты AMQP 1.0. Для этих базовых жестов иногда в качестве оболочки используется API более высокого уровня. В Apache Proton предусмотрены два API: императивный API Messenger и реактивный API Reactor.

Далее предполагается, что управление подключениями, сеансами и связями AMQP, а также обработка передачи кадров и управление потоком осуществляются с помощью соответствующего стека (например, Apache Proton-C) и для этого не требуется особое внимание со стороны разработчиков приложений. Кроме того, абстрактно предполагается, что доступны несколько примитивных возможностей API, например возможность подключения и создания абстрактных объектов *отправителя* (sender) и *получателя* (receiver), которые затем приобретают форму операций `send()` и `receive()` соответственно.

Расширенные возможности служебной шины Azure, например просмотр сообщений или управление сеансами, будут описываться на основе AMQP, а также как многоуровневая псевдореализация на базе этой предполагаемой абстракции API.

## Что такое AMQP?

AMQP — это протокол передачи и кадрирования. Под кадрированием подразумевается предоставление структуры для потоков двоичных данных, которые передаются в любом направлении в рамках сетевого подключения. Структура разграничивает отдельные блоки данных — кадры — для обмена между сторонами подключения. Возможности передачи предусматривают, что обе взаимодействующие стороны могут узнать время передачи и завершения передачи кадров.

В отличие от более ранних черновых версий с истекшим сроком действия, созданных рабочей группой AMQP, которые все еще используют несколько брокеров сообщений, окончательная версия стандартизированного протокола AMQP 1.0 не предусматривает наличие брокера сообщений или какой-либо определенной топологии для объектов внутри этого брокера.

Протокол можно использовать для симметричного однорангового обмена данными и взаимодействия с брокерами сообщений, поддерживающими очереди и объекты публикаций и подписок, например со служебной шиной Azure. Его можно также использовать для взаимодействия с инфраструктурой обмена сообщениями, в которой шаблоны взаимодействия отличаются от обычных очередей, как в случае с концентраторами событий Azure. При получении событий концентратор событий выполняет роль очереди, но когда события считываются из него, он действует скорее как служба последовательного хранения. Это отчасти напоминает ленточный накопитель. Клиент выбирает смещение в доступном потоке данных, а затем обрабатывает все события, начиная с этого смещения до последнего доступного.

Протокол AMQP 1.0 предусматривает возможность расширения, то есть его возможности можно улучшить с помощью дополнительных спецификаций. Три спецификации расширения, которые будут рассмотрены в этом документе, иллюстрируют это. Для обмена данными через имеющуюся инфраструктуру HTTPS или WebSockets, когда настройка собственных TCP-портов по протоколу AMQP может быть очень сложной, спецификация привязки определяет способ наложения протокола AMQP поверх инфраструктуры WebSockets. Чтобы обеспечить взаимодействие с инфраструктурой обмена сообщениями в режиме "запрос-ответ" для управления или предоставления дополнительных функций, спецификация управления AMQP определяет основные примитивные возможности взаимодействия. Для интеграции модели федеративной авторизации спецификация AMQP с безопасностью на основе утверждений определяет способ связывания и обновления маркеров авторизации, сопоставленных со связями.

## Основные сценарии использования протокола AMQP

В этом разделе описываются основные сценарии использования протокола AMQP 1.0 со служебной шиной Azure, что включает в себя создание подключений, сеансов и связей, а также передачу сообщений в объекты служебной шины (очереди, разделы, подписки) и из них.

Самый авторитетный источник сведений о принципах работы протокола AMQP — спецификация AMQP 1.0. Но эта спецификация представляет собой руководство по реализации, а не по использованию протокола. В этом разделе рассматриваются все термины, необходимые для описания использования протокола AMQP 1.0 в служебной шине. Дополнительные сведения о протоколе AMQP, а также подробное обсуждение AMQP 1.0 см. в [этом видеокурсе][].

### Подключения и сеансы

![][1]

AMQP вызывает *контейнеры* взаимодействующих программ. В них содержатся *узлы*, которые являются взаимодействующими объектами внутри этих контейнеров. Таким узлом может выступать очередь. Протокол AMQP предусматривает мультиплексирование, что позволяет использовать одно подключение для многих путей передачи данных между узлами. Например, клиент приложения может одновременно получать данные из одной очереди и отправлять их в другую очередь через одно и то же сетевое подключение.

Таким образом, сетевое подключение привязывается к контейнеру. Его инициирует контейнер в роли клиента. При этом устанавливается исходящее подключение TCP через сокет к контейнеру в роли получателя, который прослушивает и принимает входящие подключения TCP. Подтверждение подключения включает в себя согласование версии протокола, объявление или согласование использования безопасности транспортного уровня (TLS/SSL) и подтверждение проверки подлинности или авторизации на уровне подключения, основанном на SASL.

Для служебной шины Azure обязательно использование TLS. Он поддерживает подключения через TCP-порт 5671, когда перед вводом подтверждения протокола AMQP на подключение TCP сначала накладывается TLS, а также подключения через TCP-порт 5672, когда сервер незамедлительно предлагает обязательные обновления подключения к TLS с использованием модели, предписанной AMQP. Привязка AMQP WebSockets создает туннель через TCP-порт 443, что эквивалентно подключениям по протоколу AMQP 5671.

После настройки подключения и TLS в служебной шине применяется один из двух вариантов механизма SASL.

-   SASL PLAIN, как правило, используется для передачи имени пользователя и пароля на сервер. В служебной шине нет учетных записей, но есть связанные с ключом именованные [правила безопасности общего доступа](service-bus-shared-access-signature-authentication.md), которые присваивают права. Имя правила используется в качестве имени пользователя, а ключ (текст в кодировке Base64) — в качестве пароля. Права, связанные с выбранным правилом, определяют операции, разрешенные для подключения.

-   SASL ANONYMOUS используется для обхода авторизации SASL, когда клиент хочет использовать модель безопасности на основе утверждений (CBS), которая будет описана далее в этой статье. Используя этот вариант, подключение клиента можно установить анонимно на короткий период времени, в течение которого он может взаимодействовать только с конечной точкой CBS. При этом необходимо выполнить подтверждение CBS.

После установки транспортного подключения каждый контейнер объявляет максимальный размер кадра, который он готов обработать, и время ожидания простоя, по истечении которого он отключится в одностороннем порядке, если подключение будет неактивно.

Они также объявляют количество поддерживаемых параллельных каналов. Канал — это однонаправленный исходящий виртуальный путь передачи на основе подключения. Сеанс принимает канал из каждого из взаимосвязанных контейнеров для формирования двустороннего пути обмена данными.

В сеансах предусмотрена модель управления потоком на основе окна. После создания сеанса каждая сторона объявляет количество кадров, которое она готова принять в окне получения. Пока стороны обмениваются кадрами, передаваемые кадры заполняют окно. После заполнения окна передача прекращается и возобновляется только после сброса или развертывания окна с помощью *перформатива потока* (*перформатив* — это термин AMQP, обозначающий жесты на уровне протокола, передаваемые между двумя сторонами).

Эта модель на основе окна является приблизительным аналогом концепции TCP управления потоком на основе окна, но на уровне сеанса в сокете. Благодаря поддержке нескольких параллельных сеансов в рамках протокола регулируемый обычный трафик может сменяться трафиком с высоким приоритетом, как на полосе дорожного движения.

Сейчас в служебной шине Azure для каждого подключения используется только один сеанс. Максимальный размер кадра служебной шины — 262 144 байт (256 КБ) для служебной шины уровня Standard и концентраторов событий. Для служебной шины уровня Premium он составляет 1 048 576 (1 МБ). В служебной шине не установлены определенные окна регулирования на уровне сеанса, но предусмотрен регулярный сброс окна в рамках управления потоком на уровне связи (см. [следующий раздел](#links)).

Подключения, каналы и сеансы являются временными. Если базовое подключение прерывается, подключения, туннель TLS, контекст авторизации SASL и сеансы необходимо установить заново.

### Ссылки

![][2]

AMQP обеспечивает передачу сообщений через связи. Связь — это созданный в рамках сеанса путь передачи, который позволяет передавать сообщения в одном направлении. Согласование состояния передачи выполняется через связь и является двусторонним между сторонами подключения.

Связи могут создаваться в контейнерах в любое время в рамках активного сеанса, что отличает протокол AMQP от многих других протоколов, включая HTTP и MQTT, где инициирование передачи и путь передачи является привилегией стороны, которая создает подключение через сокет.

Контейнер, инициирующий связь, отправляет в противоположный контейнер запрос на принятие связи и выбирает роль отправителя или получателя. Таким образом, контейнер может инициировать создание односторонних или двусторонних путей передачи, которые моделируются в виде пары связей.

У связей есть имена, и они сопоставлены с узлами. Как уже говорилось в начале, узлы являются взаимодействующими объектами внутри контейнера.

В служебной шине Azure узел соответствует непосредственно очереди, разделу, подписке или подочереди недоставленных сообщений из очереди или подписки. Имя узла, используемое в AMQP, — это относительное имя объекта в пространстве имен служебной шины. Имя очереди (например, **myqueue**) является также именем узла AMQP этой очереди. Подписка раздела соответствует условиям соглашения HTTP API, так как она относится к коллекции ресурсов "подписки". Следовательно, имя узла AMQP подписки **sub** или раздела **mytopic** — **mytopic/subscriptions/sub**.

Для создания связей подключающийся клиент должен использовать имя локального узла. Служебная шина не предписывает использование этих имен узлов и не будет их интерпретировать. В стеках клиента AMQP 1.0, как правило, используется схема, в соответствии с которой эти временные имена узлов являются уникальными в области клиента.

### Передачи

![][3]

Как только связь будет установлена, через нее можно передавать сообщения. В AMQP передача выполняется с помощью жеста явного протокола (перформатив *передачи*), который перемещает сообщение отправителя к получателю через связь. Передача завершается после "сопоставления", то есть когда обе стороны узнали результат этой передачи.

В самом простом случае отправитель может отправлять сообщения "предварительно сопоставленными". Это означает, что клиент не заинтересован в результатах и получатель не предоставляет отчет о результатах операции. Этот режим поддерживается служебной шиной Azure на уровне протокола AMQP, но не представлен ни в одном из клиентских интерфейсов API.

В обычном случае сообщения отправляются несопоставленными, а затем получатель принимает или отклоняет их с помощью перформатива *обработки*. Сообщения отклоняются, когда получатель не может принять их по какой-либо причине. В этом случае в сообщении об отклонении содержатся сведения о причине, которой является структура ошибки, определенная AMQP. Если сообщения отклоняются из-за внутренних ошибок в служебной шине Azure, служба возвращает дополнительные сведения в этой структуре. Эти сведения можно предоставлять в качестве подсказок для диагностики в службу технической поддержки при заполнении запросов на поддержку. Дополнительные сведения об ошибках приведены далее.

Состояние *released* (Освобождено) — это особая форма отклонения, которая означает, что у получателя не возникает технических проблем в связи с передачей, но он не заинтересован в ее сопоставлении. Такое бывает, например, когда сообщение доставляется клиенту служебной шины и клиент выбирает команду "Отклонить", так как он не может выполнить работу, возникающую в результате обработки сообщения, в то время как доставка сообщения сама по себе не является ошибкой. Вариант этого состояния — состояние *modified* (Изменено), которое позволяет вносить изменения в сообщение, когда оно освобождается. Это состояние сейчас не используется в служебной шине.

Спецификация AMQP 1.0 определяет дополнительное состояние обработки — *received* (Получено). В этом состоянии можно выполнять восстановление связи. Таким образом можно восстановить состояние связи и ожидающие доставки на основе нового подключения и сеанса, если предыдущее подключение и сеанс потеряны.

В служебной шине Azure восстановление связи не поддерживается. Если клиент потеряет подключение к служебной шине и получит сообщение об ожидании несопоставленной передачи, эта передача сообщения теряется и клиенту необходимо повторно установить подключение, восстановить связь и повторить попытку передачи.

Таким образом, служебная шина и концентраторы событий Azure поддерживают передачи "как минимум один раз", при которых отправитель может быть уверен, что сообщения приняты и сохранены. Но передачи "только один раз" на уровне AMQP, при которых система будет пытаться восстановить связь и согласовать состояние доставки, чтобы избежать дублирования передачи сообщений, не поддерживаются.

Чтобы компенсировать возможные дублированные отправки, служебная шина Azure поддерживает выявление дубликатов в качестве дополнительной функции в очередях и разделах. При обнаружении дубликатов записываются идентификаторы всех входящих сообщений за определенный пользователем период времени и автоматически удаляются все сообщения, отправленные с одним и тем же идентификатором в течение этого периода.

### Управление потоком

![][4]

В дополнение к модели управления потоком на уровне сеанса, которая уже обсуждалась ранее, каждая связь предусматривает свою собственную модель управления потоком. Благодаря управлению потоком на уровне сеанса контейнеру не приходится обрабатывать слишком много кадров за раз. Благодаря управлению потоком на уровне связей приложение определяет количество поступающих через связь сообщений, которые оно может обработать, а также время обработки.

Передачи через связь могут произойти, только если у отправителя достаточно разрешений на передачу. Разрешения на передачу — это счетчик, устанавливаемый получателем с помощью перформатива *потока*, предусмотренного для связи. Пока у отправителя есть разрешения на передачу, будут выполняться попытки использования этих разрешений путем доставки сообщений. С каждой доставкой сообщения оставшееся количество разрешений на передачу будет уменьшаться на одно разрешение. После использования всех разрешений на передачу доставки прекращаются.

Когда служебная шина выполняет роль получателя, она незамедлительно предоставляет отправителю достаточное количество разрешений на передачу. Таким образом, сообщения можно отправлять сразу. По мере использования разрешений на передачу служебная шина периодически отправляет отправителю перформатив *потока*, чтобы обновить остаток разрешений на передачу.

Выполняя роль отправителя, служебная шина будет активно отправлять сообщения, чтобы использовать все оставшиеся разрешения на передачу.

Вызов получения на уровне API преобразуется в перформатив *потока*, который клиент отправляет в служебную шину. Чтобы использовать эти разрешения, служебная шина берет первое доступное разблокированное сообщение из очереди, а затем блокирует и передает его. Если сообщений, доступных для доставки, нет, все неиспользованные разрешения любой связи, установленные с помощью определенного объекта, будут оставаться записанными в порядке поступления. Сообщения будут блокироваться и передаваться, как только они станут доступными для использования любыми оставшимися разрешениями.

Блокировка сообщения снимается, когда передача переходит в одно из конечных состояний: *accepted* (Принято), *rejected* (Отклонено) или *released* (Освобождено). Сообщение удаляется из служебной шины, если передача переходит в конечное состояние *accepted* (Принято). Оно остается в служебной шине и будет доставлено следующему получателю, когда передача перейдет в какое-либо из других состояний. Служебная шина автоматически переместит сообщение в очередь недоставленных сообщений объекта, когда будет достигнуто максимальное число доставок, разрешенное для объекта из-за повторяющихся отклонений или освобождений.

В официальных API служебной шины такой вариант сейчас не предоставляется напрямую. Несмотря на это, клиент протокола AMQP нижнего уровня может использовать модель разрешений на передачу, чтобы изменить взаимодействие с извлечением, при котором выдается одно разрешение для каждого запроса на получение, на модель с отправлением, при которой выдается очень большое количество разрешений на передачу. После этого можно получать сообщения, как только они станут доступными, не выполняя никаких дополнительных действий. Поддержка модели с отправлением зависит от значения свойства [MessagingFactory.PrefetchCount](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagingfactory.prefetchcount.aspx) или [MessageReceiver.PrefetchCount](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagereceiver.prefetchcount.aspx). Если их значения отличны от нуля, клиент AMQP использует их в качестве разрешений на передачу.

В этом контексте важно понимать, что время истечения срока действия блокировки сообщения внутри объекта отсчитывается с того момента, когда сообщение извлекается из объекта, а не когда сообщение поступает в сеть. Каждый раз, когда клиент указывает о готовности к приему сообщений путем выдачи разрешений на передачу, ожидается, что он может активно получать сообщения через сеть и готов их обрабатывать. В противном случае срок действия блокировки сообщения может истечь еще до доставки сообщения. Использование управления потоком разрешений на передачу должно непосредственно отображать немедленную готовность к работе с доступными сообщениями, отправляемыми получателю.

В следующих разделах предоставляется схематический обзор потока перформатива во время взаимодействия различных API. В каждом разделе описывается отдельная логическая операция. Некоторые из этих взаимодействий могут быть "ленивыми". Это означает, что они могут выполняться только по требованию. Сетевое взаимодействие не всегда возникает в результате создания отправителя сообщения. Оно возникает при отправлении или запросе первого сообщения.

Стрелки указывают на направление потока перформатива.

#### Создание получателя сообщения

| Клиент | Service Bus |
|---------------------------------------------------------------------------------------------------------------------------------------------------	|--------------------------------------------------------------------------------------------------------------------------------------------	|
| --> attach(<br/>name={имя связи},<br/>handle={числовой дескриптор},<br/>role=**receiver**,<br/>source={имя объекта},<br/>target={идентификатор связи клиента}<br/>) | Клиент подключается к объекту в качестве получателя |
| Служебная шина подключает конец его связи | <-- attach(<br/>name={имя связи},<br/>handle={числовой дескриптор},<br/>role=**sender**,<br/>source={имя объекта},<br/>target={идентификатор связи клиента}<br/>) |

#### Создание отправителя сообщения

| Клиент | Service Bus |
|------------------------------------------------------------------------------------------------------------------	|--------------------------------------------------------------------------------------------------------------------	|
| --> attach(<br/>name={имя связи},<br/>handle={числовой дескриптор},<br/>role=**sender**,<br/>source={идентификатор связи клиента},<br/>target={имя объекта}<br/>) | Нет действий |
| Нет действий | <-- attach(<br/>name={имя связи},<br/>handle={числовой дескриптор},<br/>role=**receiver**,<br/>source={идентификатор связи клиента},<br/>target={имя объекта}<br/>) |

#### Создание отправителя сообщения (ошибка)

| Клиент | Service Bus |
|------------------------------------------------------------------------------------------------------------------	|---------------------------------------------------------------------	|
| --> attach(<br/>name={имя связи},<br/>handle={числовой дескриптор},<br/>role=**sender**,<br/>source={идентификатор связи клиента},<br/>target={имя объекта}<br/>) | Нет действий |
| Нет действий | <-- attach(<br/>name={имя ссылки},<br/>handle={числовой дескриптор},<br/>role=**receiver**,<br/>source=null,<br/>target=null<br/>)<br/><br/><-- detach(<br/>handle={числовой дескриптор},<br/>closed=**true**,<br/>error={сведения об ошибке}<br/>) |

#### Закрытие получателя или отправителя сообщений

| Клиент | Service Bus |
|-------------------------------------------------	|-------------------------------------------------	|
| --> detach (<br/>handle={числовой дескриптор}<br/>closed=**true**<br/>) | Нет действий |
| Нет действий | <-- detach(<br/>handle={числовой дескриптор}<br/>closed=**true**<br/>) |

#### Отправление (успешно)

| Клиент | Service Bus |
|------------------------------------------------------------------------------------------------------------------------------	|------------------------------------------------------------------------------------------------------	|
| --> transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,,more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) | Нет действий |
| Нет действий | <-- disposition(<br/>role=receiver,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки},<br/>settled=**true**,<br/>state=**accepted**<br/>) |

#### Отправление (ошибка)

| Клиент | Service Bus |
|------------------------------------------------------------------------------------------------------------------------------	|-----------------------------------------------------------------------------------------------------------------------------	|
| --> transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,,more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) | Нет действий |
| Нет действий | <-- disposition(<br/>role=receiver,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки},<br/>settled=**true**,<br/>state=**rejected**(<br/>error={сведения об ошибке}<br/>)<br/>) |

#### Получение

| Клиент | Service Bus |
|------------------------------------------------------------------------------------------------------	|------------------------------------------------------------------------------------------------------------------------------	|
| --> flow(<br/>link-credit=1<br/>) | Нет действий |
| Нет действий | < transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| --> disposition(<br/>role=**receiver**,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки},<br/>settled=**true**,<br/>state=**accepted**<br/>) | Нет действий |

#### Получение нескольких сообщений

| Клиент | Service Bus |
|--------------------------------------------------------------------------------------------------------	|--------------------------------------------------------------------------------------------------------------------------------	|
| --> flow(<br/>link-credit=3<br/>) | Нет действий |
| Нет действий | < transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| Нет действий | < transfer(<br/>delivery-id={числовой дескриптор+1},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| Нет действий | < transfer(<br/>delivery-id={числовой дескриптор+2},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| --> disposition(<br/>role=receiver,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки+2},<br/>settled=**true**,<br/>state=**accepted**<br/>) | Нет действий |

### Сообщения

В следующих разделах объясняется, какие свойства из стандартных разделов сообщений AMQP использует служебная шина, а также рассматривается способ их сопоставления с официальными API служебной шины.

#### Верхний колонтитул

| Имя поля | Использование | Имя API |
|----------------	|-------------------------------	|---------------	|
| durable | — | — | 
| priority | — | — | 
| ttl | Срок действия сообщения | [TimeToLive](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.timetolive.aspx) | 
| first-acquirer | — | — | 
| delivery-count | — | [DeliveryCount](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.deliverycount.aspx) |

#### properties

| Имя поля | Использование | Имя API |
|----------------------	|---------------------------------------------------------------------------------------------------------------------------------	|--------------------------------------------	|
| message-id | Определяемый приложением идентификатор свободной формы для этого сообщения. Используется для обнаружения дубликатов. | [MessageId](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.messageid.aspx) |
| user-id | Определяемый приложением идентификатор пользователя, который не интерпретируется служебной шиной. | Недоступно через API служебной шины. |
| значение | Определяемый приложением идентификатор назначения, который не интерпретируется служебной шиной. | [Кому](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.to.aspx) |
| subject | Определяемый приложением идентификатор назначения сообщения, который не интерпретируется служебной шиной. | [Метка](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.label.aspx) |
| reply-to | Определяемый приложением индикатор пути ответа, который не интерпретируется служебной шиной. | [ReplyTo](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.replyto.aspx) |
| correlation-id | Определяемый приложением идентификатор корреляции, который не интерпретируется служебной шиной. | [CorrelationId](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.correlationid.aspx) |
| content-type | Определяемый приложением индикатор типа содержимого, который не интерпретируется служебной шиной. | [ContentType](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.contenttype.aspx) |
| content-encoding | Определяемый приложением индикатор кодирования содержимого, который не интерпретируется служебной шиной. | Недоступно через API служебной шины. |
| absolute-expiry-time | Объявляет абсолютное время истечения срока действия сообщения. Игнорируется во входных данных (отмечается значение ttl заголовка), учитывается в выходных данных. | [ExpiresAtUtc](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.expiresatutc.aspx) |
| creation-time | Объявляет время создания сообщения. Не используется служебной шиной. | Недоступно через API служебной шины. |
| group-id | Определяемый приложением идентификатор связанного набора сообщений. Используется для сеансов служебной шины. | [SessionId](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.sessionid.aspx) |
| group-sequence | Счетчик, определяющий относительный порядковый номер сообщения в сеансе. Игнорируется служебной шиной. | Недоступно через API служебной шины. |
| reply-to-group-id | — | [ReplyToSessionId](https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.replytosessionid.aspx) |

## Расширенные возможности служебной шины

В этом разделе рассматриваются расширенные возможности служебной шины Azure, основанные на черновых расширениях AMQP, которые сейчас разрабатываются в техническом комитете OASIS для AMQP. Служебная шина Azure реализует последнее состояние этих черновиков и внедряет внесенные изменения, как только эти черновики переходят в стандартное состояние.

> [AZURE.NOTE] Дополнительные операции обмена сообщениями служебной шины поддерживаются с помощью шаблона "запрос — ответ". Дополнительные сведения об этих операциях см. в документе [AMQP 1.0 in Service Bus: request/response-based operations](https://msdn.microsoft.com/library/azure/mt727956.aspx) (AMQP 1.0 в служебной шине: операции на основе шаблона "запрос — ответ").

### Управление AMQP

Спецификация управления AMQP — это первое черновое расширение, которое мы обсудим. Эта спецификация определяет набор жестов протокола, расположенных над уровнем протокола AMQP, которые позволяют выполнять взаимодействия по управлению с инфраструктурой обмена сообщениями по протоколу AMQP. Спецификация определяет такие универсальные операции, как *создание*, *чтение*, *обновление* и *удаление*, для управления объектами в инфраструктуре обмена сообщениями, а также набор операций запросов.

Для всех этих жестов требуется взаимодействие "запрос-ответ" между клиентом и инфраструктурой обмена сообщениями. Поэтому спецификация определяет способ моделирования этого шаблона взаимодействия на основе AMQP: клиент подключается к инфраструктуре обмена сообщениями, инициирует сеанс, а затем создает пару связей. В одной связи клиент выступает в роли отправителя, а в другой — в качестве получателя, тем самым создавая пару связей, которая может выполнять роль двустороннего канала.

| Логическая операция | Клиент | Service Bus |
|------------------------------|-----------------------------|-----------------------------|
| Создание пути "запрос-ответ" | --> attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**sender**,<br/>source=**null**,<br/>target=”myentity/$management”<br/>) |Нет действий |
|Создание пути "запрос-ответ" |Нет действий | <-- attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**receiver**,<br/>source=null,<br/>target=”myentity”<br/>) |
|Создание пути "запрос-ответ" | --> attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**receiver**,<br/>source=”myentity/$management”,<br/>target=”myclient$id”<br/>) | |Нет действий
|Создание пути "запрос-ответ" |Нет действий | <-- attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**sender**,<br/>source=”myentity”,<br/>target=”myclient$id”<br/>) |

При наличии этой пары связей реализация по типу "запрос-ответ" выполняется очень просто: запрос — это сообщение, отправленное в объект в инфраструктуре обмена сообщениями, которая распознает этот шаблон. В этом запросе-сообщении для поля *reply-to* в разделе *properties* установлен *целевой* идентификатор для связи, через которую отправляется ответ. Объект обработки обрабатывает запрос и предоставляет ответ через связь, *целевой* идентификатор которой соответствует указанному идентификатору в поле *reply-to*.

Для шаблона требуется, чтобы контейнер клиента и созданный клиентом идентификатор для назначения ответа были уникальными среди всех клиентов. Кроме того, по соображениям безопасности его должно быть сложно предугадать.

Операции обмена сообщениями, используемые для протокола управления и всех остальных протоколов, в которых используется один и тот же шаблон, происходят на уровне приложения. Они не определяют новые жесты на уровне протокола AMQP. Это не просто так. Таким образом в приложениях можно воспользоваться преимуществами этих расширений с совместимыми стеками AMQP 1.0.

В служебной шине Azure сейчас не реализованы основные функции спецификации управления, но шаблон "запрос-ответ", определенный в этой спецификации, крайне важен для функции безопасности на основе утверждений и почти для всех расширенных возможностей, которые будут рассматриваться в следующих разделах.

### Авторизация на основе утверждений

Черновик спецификации авторизации на основе утверждений (CBS) AMQP основан на шаблоне "запрос-ответ" спецификации управления и описывает обобщенную модель использования маркеров федеративной безопасности с протоколом AMQP.

Модель безопасности AMQP по умолчанию, описанная во введении, основана на SASL и интегрируется при помощи подтверждения подключения AMQP. При использовании SASL предоставляется расширяемая модель, для которой определен набор механизмов. Любой протокол, в котором используется SASL, может использовать этот набор. К этим механизмам относятся следующие: PLAIN для передачи имен пользователей и паролей, EXTERNAL для привязки к безопасности на уровне TLS, ANONYMOUS для выражения отсутствия явной проверки подлинности или авторизации и широкий набор дополнительных механизмов, позволяющих пройти проверку подлинности и/или авторизацию для учетных данных или маркеров.

Интеграция SASL в протоколе AMQP имеет два недостатка:

-   Все учетные данные и маркеры ограничены подключением. Инфраструктура обмена сообщениями может предоставлять дифференцированный контроль доступа на основе объектов. Например, можно разрешить носителю токена отправлять сообщения в очередь A, а не в очередь Б. Если контекст авторизации привязан к подключению, нельзя использовать одно и то же подключение и различные маркеры доступа для очередей А и Б.

-   Как правило, маркеры доступа действительны в течение ограниченного периода времени. Из-за этого пользователю приходится периодически повторно получать маркеры. Кроме того, из-за этого поставщик маркеров может отклонить выдачу нового маркера, если разрешения пользователя на доступ изменены. Подключения AMQP могут быть действительными в течение продолжительного периода времени. Модель SASL предоставляет возможность задать маркер только во время подключения. Это означает, что инфраструктура обмена сообщениями должна либо отключить клиент по истечении срока действия маркера, либо принять риск продолжительного обмена данными с клиентом, в течение которого права доступа клиента могут быть отозваны.

Спецификация CBS AMQP, реализуемая служебной шиной Azure, обеспечивает элегантное решение обеих этих проблем: клиент может связать маркеры доступа с каждым узлом и обновить их до истечения срока действия, не прерывая поток сообщений.

CBS определяет виртуальный узел управления *$cbs*, который должна предоставить инфраструктура обмена сообщениями. Узел управления принимает маркеры от имени других узлов в инфраструктуре обмена сообщениями.

Жест протокола — это обмен данными по типу "запрос-ответ", как определено в спецификации управления. Это означает, что клиент устанавливает пару связей с узлом *$cbs*, а затем передает запрос в исходящую связь, после чего ожидает ответа во входящей связи.

Сообщение запроса обладает следующими свойствами приложения.

| Ключ | Необязательно | Тип значения | Содержимое значения |
|------------|----------|------------|--------------------------------------------|
| операция | Нет | string | **put-token** |
| type | Нет | string | Тип размещаемого маркера. |
| name | Нет | string | "Аудитория", к которой относится маркер. |
| expiration | Да | Timestamp | Время окончания срока действия маркера. |

Свойство *name* определяет объект, с которым необходимо связать маркер. В служебной шине это путь к очереди, разделу или подписке. Свойство *type* определяет тип маркера.

| Тип маркера | Описание маркера | Тип текста | Примечания |
|---------------------------------|------------------------|---------------------|----------------------------------------------------------|
| amqp:jwt | JSON Web Token (JWT) | Значение AMQP (строка) | Пока недоступно. |
| amqp:swt | Простой веб-маркер (SWT) | Значение AMQP (строка) | Поддерживается только для маркеров SWT, выданных AAD или ACS |
| servicebus.windows.net:sastoken | Маркер SAS служебной шины | Значение AMQP (строка) | — |

Маркеры предоставляют права. Служебная шина распознает три основные вида прав: право "Отправление" позволяет отправлять, право "Прослушивание" — принимать, а право "Управление" — управлять объектами. Маркеры SWT, выданные AAD или ACS, явно включают в себя эти права в качестве утверждений. Маркеры SAS служебной шины ссылаются на правила, настроенные в пространстве имен или объекте, и эти правила настраиваются с помощью этих прав. Таким образом, если подписать маркер с помощью ключа, связанного с этим правилом, он предоставит соответствующие права. Маркер, связанный с объектом с помощью *put-token*, позволит подключенному клиенту взаимодействовать с объектом, используя права маркера. Для связи, в которой клиент принимает роль *отправителя*, требуются права на отправку, а для роли *получателя* — права на прослушивание.

Для сообщения ответа предусмотрены следующие значения *свойств приложения*.

| Ключ | Необязательно | Тип значения | Содержимое значения |
|--------------------|----------|------------|-----------------------------------|
| status-code | Нет | int | Код ответа HTTP **[RFC2616]**. |
| status-description | Да | string | Описание состояния. |

Клиент может вызвать запрос *put-token* несколько раз для любого объекта в инфраструктуре обмена сообщениями. Маркеры ограничиваются текущим клиентом и привязываются к текущему подключению. Это означает, что сервер удаляет хранимые маркеры после разрыва подключения.

Текущая реализация служебной шины предусматривает использование CBS только в сочетании с методом SASL ANONYMOUS. Подключение SSL/TLS всегда необходимо устанавливать до подтверждения SASL.

Таким образом, выбранный клиент AMQP 1.0 должен поддерживать механизм ANONYMOUS. Анонимный доступ означает, что при подтверждении первого подключения и создании первого сеанса в служебную шину не поступают сведения о том, кто устанавливает подключение.

После установки подключения и создания сеанса единственными допустимыми операциями являются подключение связей к узлу *$cbs* и отправка запроса *put-token*. Для определенного узла объекта в течение 20 секунд после установки подключения необходимо задать допустимый маркер с помощью запроса *put-token*. В противном случае служебная шина разорвет подключение в одностороннем порядке.

После этого клиент отвечает за отслеживание срока действия маркеров. По истечении срока действия маркера служебная шина незамедлительно разрывает все связи в рамках подключения к соответствующему объекту. Чтобы избежать этого, клиент может в любое время заменить маркер для узла новым маркером через виртуальный узел управления *$cbs* с помощью того же запроса *put-token*, при этом не препятствуя трафику полезных данных, который поступает в разных связях.

## Дальнейшие действия

Дополнительные сведения о AMQP см. в следующих статьях:

- [Протокол AMQP служебной шины — обзор]
- [Поддержка AMQP 1.0 для секционированных очередей и разделов служебной шины]
- [Протокол AMQP служебной шины для Windows Server]

[этом видеокурсе]: https://www.youtube.com/playlist?list=PLmE4bZU0qx-wAP02i0I7PJWvDWoCytEjD
[1]: ./media/service-bus-amqp/amqp1.png
[2]: ./media/service-bus-amqp/amqp2.png
[3]: ./media/service-bus-amqp/amqp3.png
[4]: ./media/service-bus-amqp/amqp4.png

[Протокол AMQP служебной шины — обзор]: service-bus-amqp-overview.md
[Поддержка AMQP 1.0 для секционированных очередей и разделов служебной шины]: service-bus-partitioned-queues-and-topics-amqp-overview.md
[Протокол AMQP служебной шины для Windows Server]: https://msdn.microsoft.com/library/dn574799.aspx

<!---HONumber=AcomDC_0713_2016-->