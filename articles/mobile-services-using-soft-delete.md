<properties urlDisplayName="Using Soft Delete" pageTitle="Использование удаления с возможностью восстановления в мобильных службах (магазин Windows) | Центр мобильных разработок" metaKeywords="" description="Узнайте, как использовать функцию удаления с возможностью восстановления в мобильных службах Azure для вашего приложения" metaCanonical="" disqusComments="1" umbracoNaviHide="1" documentationCenter="Mobile" title="Использование удаления с возможностью восстановления в мобильных службах" authors="wesmc" manager="dwrede" />

<tags ms.service="mobile-services" ms.workload="mobile" ms.tgt_pltfrm="mobile-windows-store" ms.devlang="dotnet" ms.topic="article" ms.date="09/25/2014" ms.author="wesmc" />

# Использование удаления с возможностью восстановления в мобильных службах

Для таблиц, созданных с помощью JavaScript или серверной части .NET, можно включить удаление с возможностью восстановления. При использовании удаления с возможностью восстановления в базу данных добавляется новый столбец с именем \*\_\_deleted\* и типом [SQL bit][SQL bit]. Если функция удаления с возможностью восстановления включена, операция удаления физически не удаляет строки из базы данных, а устанавливает для удаленного столбца значение TRUE.

При запросах записей в таблице с включенной функций удаления с возможностью восстановления удаленные строки по умолчанию не возвращаются в запросе. Для запроса этих строк необходимо передать параметр запроса \*\_\_includeDeleted=true\* в [операции запроса REST][операции запроса REST]. В пакете SDK клиента .NET также можно использовать вспомогательный метод `IMobileServiceTable.IncludeDeleted()`.

Поддержка удаления с возможностью восстановления для серверной части .NET впервые реализована в версии 1.0.402 серверной части .NET для мобильных служб Microsoft Azure. Последние пакеты NuGet доступны здесь: [Серверная часть .NET для мобильных служб Microsoft Azure][Серверная часть .NET для мобильных служб Microsoft Azure].

Ниже описаны потенциальные преимущества использования удаления с возможностью восстановления.

-   При использовании компонента [Автономная синхронизация данных для мобильных служб][Автономная синхронизация данных для мобильных служб] пакет SDK клиента автоматически запрашивает удаленные записи и удаляет их из локальной базы данных. Если функция удаления с возможностью восстановления не включена, необходимо написать дополнительный код для серверной части, который будет предоставлять пакету SDK клиента сведения, какие записи следует удалить из локального хранилища. В противном случае локальное хранилище клиента и серверная часть будут не согласованы, и для очистки локального хранилища необходимо будет вызвать метод `PurgeAsync()` клиента.
-   В некоторых приложениях существует требование никогда не удалять данные физически либо удалять данные только после их аудита. В таком сценарии удобно использовать функцию удаления с возможностью восстановления.
-   Функцию удаления с возможностью восстановления можно использовать для реализации функции "undelete", чтобы обеспечить возможность восстановления случайно удаленных данных.
    Однако удаленные таким образом записи занимают пространство в базе данных, поэтому следует рассмотреть возможность создания планового задания для их периодического окончательного удаления. Примеры см. в разделах [Использование удаления с возможностью восстановления в серверной части .NET][Использование удаления с возможностью восстановления в серверной части .NET] и [Использование удаления с возможностью восстановления в серверной части JavaScript][Использование удаления с возможностью восстановления в серверной части JavaScript]. Клиентский код должен периодически вызывать функцию `PurgeAsync()`, чтобы записи, удаленные без возможности восстановления, не оставались в локальном хранилище устройства.

Описание раздела:

1.  [Включение удаления с возможностью восстановления для серверной части .NET][Включение удаления с возможностью восстановления для серверной части .NET]
2.  [Включение удаления с возможностью восстановления для серверной части JavaScript][Включение удаления с возможностью восстановления для серверной части JavaScript]
3.  [Использование удаления с возможностью восстановления для серверной части .NET][Использование удаления с возможностью восстановления в серверной части .NET]
4.  [Использование удаления с возможностью восстановления для серверной части JavaScript][Использование удаления с возможностью восстановления в серверной части JavaScript]

## <a name="enable-for-dotnet"></a>Включение удаления с возможностью восстановления для серверной части .NET

Поддержка удаления с возможностью восстановления для серверной части .NET впервые реализована в версии 1.0.402 серверной части .NET для мобильных служб Microsoft Azure. Последние пакеты NuGet доступны здесь: [Серверная часть .NET для мобильных служб Microsoft Azure][Серверная часть .NET для мобильных служб Microsoft Azure].

В следующем пошаговом руководстве описано включение удаления с возможностью восстановления для мобильной службы серверной части .NET.

1.  Откройте проект серверной мобильной службы .NET в Visual Studio.
2.  Щелкните правой кнопкой мыши проект серверной части .NET и выберите **Управление пакетами NuGet**.
3.  В диалоговом окне диспетчера пакетов щелкните **Nuget.org** в разделе обновлений и установите версию 1.0.402 (или более позднюю) пакетов NuGet для [серверной части.NET мобильных служб Microsoft Azure][Серверная часть .NET для мобильных служб Microsoft Azure].
4.  В обозревателе решений для Visual Studio разверните узел **Контроллеры** в проекте серверной части .NET и откройте источник контроллера. Например, *TodoItemController.cs*.
5.  В методе `Initialize()` контроллера передайте параметр `enableSoftDelete: true` в конструктор EntityDomainManager.

        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            MobileService1Context context = new MobileService1Context();
            DomainManager = new EntityDomainManager<TodoItem>(context, Request, Services, enableSoftDelete: true);
        }

## <a name="enable-for-javascript"></a>Включение удаления с возможностью восстановления для серверной части JavaScript

На странице создания новой таблицы для мобильной службы можно включить удаление с возможностью восстановления.

![][0]

Включение удаления с возможностью восстановления для существующей таблицы в серверной части JavaScript:

1.  На [портале управления][портале управления] щелкните мобильную службу. Затем перейдите на вкладку "Данные".
2.  На странице данных щелкните для выбора нужной таблицы. На панели команд нажмите кнопку **Включить удаление с возможностью восстановления**. Если в таблице уже включена эта функция, кнопка будет недоступна, но на вкладках **Обзор** или **Столбцы** таблицы будет виден столбец \*\_\_deleted\*.

    ![][1]

    Чтобы выключить удаление с возможностью восстановления для таблицы, перейдите на вкладку **Столбцы**, щелкните столбец \*\_\_deleted\* и нажмите кнопку **Удалить**.

    ![][2]

## <a name="using-with-dotnet"></a>Использование удаления с возможностью восстановления для серверной части .NET

Следующее запланированное задание очищает записи, удаленные с возможностью восстановления, которые созданы более месяца назад:

    public class SampleJob : ScheduledJob
    {
        private MobileService1Context context;
     
        protected override void Initialize(ScheduledJobDescriptor scheduledJobDescriptor, 
            CancellationToken cancellationToken)
        {
            base.Initialize(scheduledJobDescriptor, cancellationToken);
            context = new MobileService1Context();
        }
     
        public override Task ExecuteAsync()
        {
            Services.Log.Info("Purging old records");
            var monthAgo = DateTimeOffset.UtcNow.AddDays(-30);
     
            var toDelete = context.TodoItems.Where(x => x.Deleted == true && x.UpdatedAt <= monthAgo).ToArray();
            context.TodoItems.RemoveRange(toDelete);
            context.SaveChanges();
     
            return Task.FromResult(true);
        }
    }

Дополнительные сведения о планировании заданий в мобильных службах серверной части .NET см. в разделе [Планирование повторяющихся заданий в мобильных службах сервера JavaScript][Планирование повторяющихся заданий в мобильных службах сервера JavaScript]

## <a name="using-with-javascript"></a>Использование удаления с возможностью восстановления для серверной части JavaScript

С помощью сценариев таблицы можно добавить логику функции удаления с возможностью восстановления с помощью мобильных служб сервера JavaScript.

Для обнаружения запроса о восстановлении используйте свойство "undelete" в сценарии обновления таблицы:

    function update(item, user, request) {
        if (request.undelete) { /* any undelete specific code */; }
    }

Чтобы включить удаленные записи в результат запроса в сценарии, установите для параметра "includeDeleted" значение true:

    tables.getTable('softdelete_scenarios').read({
        includeDeleted: true,
        success: function (results) {
            request.respond(200, results)
        }
    });

Для извлечения удаленных записей в запросе HTTP добавьте параметр запроса "\_\_includedeleted=true":

    http://youservice.azure-mobile.net/tables/todoitem?__includedeleted=true

### Пример запланированного задания для очистки записей, удаленных с возможностью восстановления.

Пример запланированного задания, которое удаляет записи с последним обновлением до определенной даты:

    function purgedeleted() {
         mssql.query('DELETE FROM softdelete WHERE __deleted=1', {
            success: function(results) {
                console.log(results);
            },
            error: function(err) {
                console.log("error is: " + err);
        }});
    }

Дополнительные сведения о запланированных заданиях в мобильных службах серверной части JavaScript см. в разделе [Планирование повторяющихся заданий в мобильных службах сервера JavaScript][3].

 <!-- Images --> 

  [SQL bit]: http://msdn.microsoft.com/ru-ru/library/ms177603.aspx
  [операции запроса REST]: http://msdn.microsoft.com/ru-ru/library/azure/jj677199.aspx
  [Серверная часть .NET для мобильных служб Microsoft Azure]: http://go.microsoft.com/fwlink/?LinkId=513165
  [Автономная синхронизация данных для мобильных служб]: /ru-ru/documentation/articles/mobile-services-windows-store-dotnet-get-started-offline-data/
  [Использование удаления с возможностью восстановления в серверной части .NET]: #using-with-dotnet
  [Использование удаления с возможностью восстановления в серверной части JavaScript]: #using-with-javascript
  [Включение удаления с возможностью восстановления для серверной части .NET]: #enable-for-dotnet
  [Включение удаления с возможностью восстановления для серверной части JavaScript]: #enable-for-javascript
  [0]: ./media/mobile-services-using-soft-delete/enable-soft-delete-new-table.png
  [портале управления]: https://manage.windowsazure.com/
  [1]: ./media/mobile-services-using-soft-delete/enable-soft-delete-button.png
  [2]: ./media/mobile-services-using-soft-delete/disable-soft-delete.png
  [Планирование повторяющихся заданий в мобильных службах сервера JavaScript]: /ru-ru/documentation/articles/mobile-services-dotnet-backend-schedule-recurring-tasks/
  [3]: /ru-ru/documentation/articles/mobile-services-schedule-recurring-tasks/
