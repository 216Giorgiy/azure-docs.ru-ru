<properties title="How to create a hybrid deployment of RemoteApp" pageTitle="How to create a hybrid deployment of RemoteApp" description="Learn how to create a deployment of RemoteApp that connects to your internal network." metaKeywords="" services="" solutions="" documentationCenter="" authors="elizapo"  />

<tags ms.service="remoteapp" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="elizapo"></tags>

# Как создать гибридное развертывание RemoteApp

Существует два типа развертывания RemoteApp.

-   Облачное: размещается полностью в Azure и создается с помощью параметра **Быстрое создание** на портале управления Azure.
-   Гибридное: включает виртуальную сеть для локального доступа и создается с помощью параметра **Создать с VPN** на портале управления.

В этом учебнике содержится пошаговое руководство по созданию гибридного развертывания. Для этого необходимо выполнить семь шагов:

1.  Создать образ шаблона RemoteApp.
2.  Создание службы RemoteApp.
3.  связаться с виртуальной сетью.
4.  связаться с образом шаблона.
5.  настроить синхронизацию каталога. RemoteApp это требуется для синхронизации пользователей, групп, контактов и паролей между локальной службой Active Directory и клиентом службы Azure Active Directory.
6.  Публикация программ RemoteApp.
7.  Настройка доступа пользователей.

**Перед началом работы**

Перед созданием службы необходимо выполнить следующие действия.

-   установить [необходимые обновления][] для улучшения производительности Azure RemoteApp.
-   подписаться на [предварительную версию RemoteApp][].
-   создать учетную запись пользователя в Active Directory для использования в качестве учетной записи службы RemoteApp. ограничить разрешения для этой учетной записи, чтобы она могла только присоединять машины к домену.
-   собрать информацию о своей локальной сети: информацию об IP-адресе и сведения о VPN-устройстве.
-   установить модуль [Azure PowerShell][].
-   Собрать сведения о пользователях и группах, которым требуется предоставить доступ. Это могут быть сведения об учетных записях Майкрософт или учетных записях в организации Active Directory для пользователей и групп.

## **Шаг 1: создание образа шаблона**

Azure RemoteApp использует образ шаблона Windows Server 2012 R2 для размещения всех программ, которыми вы планируете делиться с пользователями. Чтобы создать образ шаблона RemoteApp, можно использовать существующий образ или создать новый. К образу, который может быть передан для использования с Azure RemoteApp, предъявляются следующие требования:

-   он должен быть помещен в VHD-файл (файлы VHDX в настоящее время не поддерживаются).
-   виртуальный жесткий диск VHD должен быть либо фиксированного размера, либо иметь возможность динамического расширения. Рекомендуется использовать VHD с динамическим расширением, поскольку на его передачу в Azure уходит меньше времени, чем на передачу VHD-файла с фиксированным размером.
-   Диск должен быть инициализирован с использованием стиля разделов основной загрузочной записи (MBR). Стиль разделов (GPT) таблицы разделов GUID не поддерживается.
-   VHD должен содержать одну установку Windows Server 2012 R2. Он может содержать несколько томов, но только один из них может содержать установку Windows.
-   Должны быть установлены роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола».
-   Шифрующая файловая система (EFS) должна быть выключена.
-   Образ должен быть обработан командой SYSPREP с использованием параметров **/oobe /generalize /shutdown** (запуск при первом включении компьютера/ обобщить/ выключить) (НЕ ИСПОЛЬЗУЙТЕ параметр **/mode:vm** (Режим виртуальной машины)).

Чтобы создать образ шаблона с самого начала, необходимо выполнить следующие действия:

1.  найдите Windows Server 2012 R2 DVD или ISO-образ;
2.  создать VHD-файл;
3.  установить Windows Server 2012 R2;
4.  установить роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола»;
5.  установить дополнительные функции, необходимые для приложений;
6.  установить и настроить ваши приложения;
7.  Выполните любые дополнительные настройки Windows, необходимые для приложений.
8.  Выключите шифрующую файловую систему (EFS).
9.  Обработайте образ командой SYSPREP.

Ниже приводится подробное описание шагов для создания нового образа:

1.  найдите Windows Server 2012 R2 DVD или ISO-образ;
2.  создайте VHD-файл с помощью управления дисками;

    1.  запустите управление дисками (diskmgmt.msc);
    2.  создайте динамически расширяющийся VHD размером 40 ГБ или более; (Оцените объем дискового пространства, необходимый для Windows, ваших приложений и настроек. Установленный Windows Server с ролью RDSH и компонент «Возможности рабочего стола» требуют приблизительно 10 ГБ дискового пространства.)

        1.  нажмите **Action \> Create VHD** (Действие \> Создать VHD);
        2.  определите местоположение, размер и формат VHD; выберите **Dynamically expanding** (Динамически расширяющийся) и нажмите **OK**.

            Процесс создания диска занимает несколько секунд. После окончания создания VHD вы должны увидеть новый диск без буквы диска в состоянии Not initialized (Не инициализирован) на консоли управления дисками.

        -   Щелкните диск правой кнопкой мыши (а не свободное место) и нажмите **Initialize Disk** (Инициализировать диск). Выберите **MBR** (Основная загрузочная запись) в качестве стиля разделов и нажмите **OK**.
        -   Создайте новую таблицу: нажмите правой кнопкой мыши нераспределенное место, а затем нажмите **New Simple Volume** (Создать простой том). В мастере можно принять параметры по умолчанию, однако не забудьте присвоить букву диска, чтобы избежать возможных проблем при передаче образа шаблона.
        -   Щелкните диск правой кнопкой мыши, а затем нажмите **Detach VHD** (Отсоединить VHD).

3.  Установите Windows Server 2012 R2.

    1.  Создайте новую виртуальную машину. Используйте Мастер новой виртуальной машины в диспетчере Hyper-V или клиент Hyper-V.

        1.  На странице «Подключить виртуальный жесткий диск» выберите параметр **Use an existing virtual hard disk** (Использовать существующий виртуальный жесткий диск) и перейдите к VHD, который был создан на предыдущем шаге.
        2.  На странице «Параметры установки» выберите **Install an operating system from a boot CD/DVD\_ROM** (Установить операционную систему с загрузочного CD/DVD\_ROM), а затем выберите местоположение установочного носителя Windows Server 2012 R2.
        3.  Выберите другие параметры в мастере, которые необходимы для установки Windows и ваших приложений. Завершите работу мастера.

    2.  После завершения работы мастера измените параметры ВМ и проделайте другие необходимые изменения для установки Windows и ваших программ, например количество виртуальных машин, а затем нажмите **OK**.
    3.  Подключитесь к ВМ и установите Windows Server 2012 R2.

4.  Установите роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола»:

    1.  Запустите диспетчер сервера.
    2.  Нажмите **Add Roles and features** (Добавить роли и компоненты) на экране Добро пожаловать или из меню **Manage** (Управление).
    3.  Нажмите **Next** (Далее) на странице «Перед началом работы».
    4.  Выберите **Role-based or feature-based installation** (Установка на основе ролей или функций), а затем нажмите **Next**.
    5.  Выберите локальный компьютер из списка и нажмите **Next**.
    6.  Выберите **Remote Desktop Services** (Службы удаленных рабочих столов), а затем нажмите **Next**.
    7.  Разверните список **User Interfaces and Infrastructure** (Пользовательские интерфейсы и инфраструктура) и выберите **Desktop Experience** (Возможности рабочего стола).
    8.  Нажмите **Add Features** (Добавить компоненты), а затем нажмите **Next**.
    9.  На странице служб удаленных рабочих столов нажмите **Next**.
    10. Нажмите **Remote Desktop Session Host** (Узел сеансов удаленных рабочих столов).
    11. Нажмите **Add Features** (Добавить компоненты), а затем нажмите **Next**.
    12. На странице подтверждения выбранных параметров установки выберите **Restart the destination server automatically if required** (Перезапустить целевой сервер автоматически, если требуется), а затем нажмите **Yes** (Да) в предупреждении о перезапуске.
    13. Нажмите **Install** (Установить). Компьютер перезапустится.

5.  Установите такие необходимые для приложений дополнительные компоненты, как .NET Framework 3.5. Чтобы установить компоненты, запустите мастер добавления ролей и компонентов.
6.  Установите и настройте программы и приложения, которые будут публиковаться через RemoteApp.

    **Важно!** Майкрософт рекомендует установить роль RDSH перед установкой приложений, чтобы обнаружить все проблемы с совместимостью приложений до передачи образа в RemoteApp.

7.  Выполните любые дополнительные настройки Windows, необходимые для приложений.
8.  Выключите шифрующую файловую систему (EFS). Выполните следующую команду в окне команд с повышенными привилегиями:

        Fsutil behavior set disableencryption 1

    Вместо этого можно задать или добавить следующее значение DWORD в реестре:

        HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1

9.  Если создается образ в **Виртуальной машине Azure**, необходимо удалить или переименовать файл **\\Windows\\Panther\\Unattend.xml**, поскольку он будет блокировать передачу скрипта, который используется позже во время работы.
10. Обработайте образ командой SYSPREP. В командной строке с повышенными привилегиями выполните следующую команду:

    **C:\\Windows\\System32\\sysprep\\sysprep.exe /generalize /oobe /shutdown**

    **Примечание.** не используйте переключатель **/mode:vm** команды SYSPREP, несмотря на то что это виртуальная машина.

## **Шаг 2: создание службы RemoteApp**

1.  На [Портале управления Azure][] перейдите на страницу RemoteApp.
2.  Нажмите **New \> Create with VPN** (Новая \> Создать с VPN).
3.  Введите имя для службы и нажмите **Create RemoteApp service** (Создать службу RemoteApp).

После создания службы RemoteApp перейдите на страницу **быстрого запуска** RemoteApp, чтобы продолжить действия по настройке.

## **Шаг 3: установка связи с виртуальной сетью**

Виртуальная сеть позволяет пользователям получать доступ к данным в локальной сети через удаленные ресурсы RemoteApp. Чтобы установить связь с виртуальной сетью, выполните следующие четыре шага:

1.  На странице быстрого запуска нажмите **link a remoteapp virtual network** (Связаться с виртуальной сетью remoteapp).
2.  Выберите создание новой виртуальной сети или использование существующей. В этом учебнике мы создадим новую виртуальную сеть.
3.  Предоставьте следующую информацию для своей сети:

    -   Имя
    -   Адресное пространство виртуальной сети
    -   Локальное адресное пространство
    -   IP-адрес DNS-сервера
    -   IP-адрес VPN

    Дополнительную информацию см. в разделе [Настройка VPN «сеть-сеть» на портале управления][].

4.  Далее снова на странице быстрого запуска нажмите **get script** (Получить скрипт), чтобы загрузить скрипт для настройки VPN-устройства и подключиться к виртуальной сети, которая была только что создана. Вам понадобится следующая информация о VPN-устройстве:

    -   поставщик
    -   платформа
    -   операционная система

    Сохраните скрипт и выполните его на VPN-устройстве.

    **Примечание.** после выполнения этого скрипта виртуальная сеть перейдет в состояние «Готово» — на это может уйти 5–7 минут. До тех пор, пока сеть не готова, вы не сможете ее использовать.

5.  И наконец, снова на странице быстрого запуска нажмите **join local domain** (Присоединить локальный домен). Добавьте учетную запись службы RemoteApp в локальный домен Active Directory. Вам понадобится имя домена, организационное подразделение, имя пользователя и пароль учетной записи службы.

## **Шаг 4: связь с образом шаблона RemoteApp**

Образ шаблона RemoteApp содержит программы, которыми вы хотите поделиться с пользователями. Можно передать новый образ шаблона, созданный на шаге 1, или связаться с существующим шаблоном (уже переданным на платформу Azure).

Если передается новый шаблон, необходимо ввести имя и выбрать местоположение для образа. На следующей странице мастера находится набор командлетов PowerShell. Чтобы передать выбранный образ, необходимо скопировать эти командлеты и выполнить их из строки с повышенными привилегиями Azure PowerShell.

При установке связи с существующим образом шаблона достаточно просто указать имя, местоположение и связанную подписку Azure.

## **Шаг 5: настройка синхронизации каталога Active Directory**

Удаленное приложение RemoteApp требует синхронизации между Azure Active Directory и локальным Active Directory, чтобы выполнить синхронизацию пользователей, групп, контактов и паролей с вашим клиентом Azure Active Directory. Сведения о планировании и подробные действия см. в статье [Стратегия синхронизации каталогов][].

## **Шаг 6: публикация программ RemoteApp**

Программа RemoteApp — это приложение или программа, которая предоставляется пользователям. Она располагается в образе шаблона, отправленном для службы. Когда пользователь вызывает программу RemoteApp, эта программа появляется как запущенная в локальной среде, но на самом деле запускается в Azure.

Прежде чем пользователи смогут получить доступ к программам RemoteApp, необходимо их опубликовать в канале для конечных пользователей — списке доступных программ, доступ к которым пользователи получают через портал Azure.

В службе RemoteApp можно опубликовать несколько программ. На странице программ RemoteApp нажмите **Опубликовать**, чтобы добавить программу. Публиковать программу можно либо из меню "Пуск" образа шаблона, либо путем задания пути в образе шаблона для программы. Если решено использовать меню "Пуск", выберите программу для публикации. Если выбран вариант указания пути к программе, предоставьте имя программы и путь, по которому эта программа устанавливается в образе шаблона.

## **Шаг 7: настройка доступа пользователей**

Теперь, когда служба RemoteApp создана, необходимо добавить пользователей и группы, которым требуется предоставить доступ к удаленным ресурсам. Пользователи или группы, которым предоставляется доступ, должны существовать в клиенте Active Directory, связанном с подпиской, используемой для создания службы RemoteApp.

1.  На странице быстрого запуска щелкните элемент **Настроить доступ пользователей**.
2.  Введите либо учетную запись в организации или имя группы (для Active Directory), либо учетную запись Майкрософт, для которой планируется предоставить доступ.

    Для пользователей необходимо использовать формат "<user@domain.com>". Для групп укажите имя группы.

3.  После проверки пользователей или групп нажмите кнопку **Сохранить**.

## Дальнейшие действия

Вот и все. Вы успешно создали и развернули гибридное развертывание RemoteApp. Далее пользователи должны загрузить и установить клиент удаленного рабочего стола. URL-адрес для клиента можно найти на странице быстрого запуска RemoteApp. Затем пользователи должны войти в Azure и вызвать опубликованные программы RemoteApp.

  [необходимые обновления]: http://support.microsoft.com/kb/2977219
  [предварительную версию RemoteApp]: http://azure.microsoft.com/en-us/services/remoteapp/
  [Azure PowerShell]: http://azure.microsoft.com/ru-ru/documentation/articles/install-configure-powershell/
  [Портале управления Azure]: http://manage.windowsazure.com
  [Настройка VPN «сеть-сеть» на портале управления]: http://msdn.microsoft.com/library/azure/dn133795.aspx
  [Стратегия синхронизации каталогов]: http://msdn.microsoft.com//library/azure/hh967642.aspx
