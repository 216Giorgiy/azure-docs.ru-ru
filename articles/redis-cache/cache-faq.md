<properties 
	pageTitle="Кэш Redis для Azure. Вопросы и ответы" 
	description="Ответы на часто задаваемые вопросы, шаблоны и рекомендации для кэша Redis для Azure." 
	services="redis-cache" 
	documentationCenter="" 
	authors="steved0x" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="cache" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="cache-redis" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="07/24/2015" 
	ms.author="sdanie"/>

# Кэш Redis для Azure. Вопросы и ответы

Ответы на часто задаваемые вопросы, шаблоны и рекомендации для кэша Redis для Azure.

<a name="cache-size"></a>
## Какое предложение и размер кэша Redis мне следует использовать?

Все предложения кэша Azure Redis обеспечивают разные уровни параметров **размера**, **пропускной способности**, **высокой доступности** и **соглашения об уровне обслуживания**.

-	SKU Basic — один узел, без репликации или соглашения об уровне обслуживания, объем кэша от 250 МБ до 53 ГБ.
-	SKU Standard — первичный и вторичный узлы с автоматической репликацией, соглашение об уровне обслуживания 99,9 %, объем кэша от 250 МБ до 53 ГБ.

Если вам требуется высокая доступность, выберите предложение Standard, в котором предусмотрено соглашение об уровне обслуживания (SLA) 99,9 %. Для разработки и создания прототипов или в сценариях, где SLA не требуется, может лучше всего подходить предложение Basic.

Объем кэша и пропускная способность приблизительно соответствуют размерам и пропускной способности виртуальных машин, на которых размещен кэш. Размеры 250 МБ для предложений Basic и Standard размещаются на виртуальных машинах минимального (A0) размера, которые используют общие ядра, а другие размеры размещаются с использованием выделенных ядер. Объем кэша 1 ГБ выделяется на виртуальных машинах небольшого (A1) размера, которые имеют 1 выделенное виртуальное ядро, используемое для обслуживания как операционной системы, так и кэша redis. Больший объем кэша размещается на большем числе экземпляров ВМ с несколькими выделенными виртуальными ядрами.

Если ваш кэш имеет высокую пропускную способность, выберите объем не менее 1 ГБ, чтобы кэш выполнялся с использованием выделенных ядер. Объем кэша 1 ГБ размещается на виртуальной машине с 1 ядром. Это ядро используется для обслуживания и операционной системы, и кэша. Кэш объемом больше 1 ГБ запускается на виртуальных машинах с несколькими ядрами, и кэш Redis использует выделенное ядро, которое не используется совместно с ОС.

**Redis является однопотоковым**, поэтому наличие более двух ядер не предоставляет дополнительных преимуществ по сравнению с только двумя ядрами, но **ВМ большего размера обычно имеют большую пропускную способность, чем ВМ меньшего размера**. Если кэш сервера или клиента достигает пределов пропускной способности, вы получите простои на стороне клиента.

В следующей таблице показаны максимальные значения пропускной способности, наблюдаемые при тестировании разных размеров кэша Redis для Azure с помощью `redis-benchmark.exe` из ВМ Iaas для конечной точки кэша Redis для Azure. Обратите внимание, что эти значения не гарантируются и для них не предусмотрено SLA, однако такие значения должны быть типичными. Чтобы определить подходящий объем кэша для вашего приложения, вам следует загрузить его тестирование.

<table>
  <tr>
    <th>Имя кэша</th>
    <th>Объем кэша</th>
    <th>Get/с (простые вызовы GET значений в 1 КБ)</th>
    <th>Пропускная способность (Мбит/с)</th>
  </tr>
  <tr>
    <td>C0</td>
    <td>250 МБ</td>
    <td>610</td>
    <td>5</td>
  </tr>
  <tr>
    <td>C1</td>
    <td>1 GB</td>
    <td>12 200</td>
    <td>100</td>
  </tr>
  <tr>
    <td>C2</td>
    <td>2,5&#160;ГБ</td>
    <td>24 300</td>
    <td>200</td>
  </tr>
  <tr>
    <td>C3</td>
    <td>6&#160;ГБ</td>
    <td>48 875</td>
    <td>400</td>
  </tr>
  <tr>
    <td>C4</td>
    <td>13 ГБ</td>
    <td>61 350</td>
    <td>500</td>
  </tr>
  <tr>
    <td>C5</td>
    <td>26&#160;ГБ</td>
    <td>112 275</td>
    <td>1000</td>
  </tr>
  <tr>
    <td>C6</td>
    <td>53&#160;ГБ</td>
    <td>153 219</td>
    <td>1000 +</td>
  </tr>
</table>

Инструкции по загрузке инструментов Redis, таких как `redis-benchmark.exe`, см. в разделе [Как выполнять команды Redis?](#cache-commands).

<a name="cache-region"></a>
## В каком регионе следует размещать мой кэш?

Для лучшей производительности и минимальной задержки размещайте свой кэш Redis для Azure в одном регионе с вашим кэшируемым клиентским приложением.

<a name="cache-billing"></a>
## Как выставляются счета за использование кэша Redis для Azure?

Цены на кэш Redis для Azure приведены [здесь](http://azure.microsoft.com/pricing/details/cache/). На странице указаны расценки в виде почасового тарифа. Выставляемые счета за использование кэшей рассчитываются на поминутной основе. Они охватывают интервал времени между созданием кэшей и их удалением. Остановить или приостановить выставление счета за использование кэша нельзя.

<a name="cache-timeouts"></a>
## Почему я наблюдаю простои?

Простои происходят на клиенте, который вы используете для обращения к Redis. В основном сервер Redis не простаивает. Когда команда отправляется на сервер Redis, она помещается в очередь, и со временем сервер Redis выбирает команду и выполняет его. Однако во время этого процесса клиент может простаивать, и в этом случае на вызывающей стороне возникает исключение. Дополнительные сведения об устранении проблем с простоями см. в статье [Исследование исключений таймаута в StackExchange.Redis для кэша Redis для Azure](http://azure.microsoft.com/blog/2015/02/10/investigating-timeout-exceptions-in-stackexchange-redis-for-azure-redis-cache/).

<a name="cache-monitor"></a>
## Как отслеживать работоспособность и производительность моего кэша?

За экземплярами кэша Redis для Microsoft Azure можно наблюдать на [портале предварительной версии Azure](https://portal.azure.com). Вы можете просматривать метрики, закреплять диаграммы метрик на начальной панели, настраивать диапазоны дат и времени для диаграмм мониторинга, добавлять и удалять метрики в диаграммах, а также настраивать отправку оповещений при выполнении определенных условий. Эти инструменты позволяют наблюдать за работоспособностью экземпляров кэша Redis для Azure и помогают управлять кэшируемыми приложениями. Дополнительные сведения о мониторинге кэша см. в разделе [Мониторинг кэша Redis для Azure](https://msdn.microsoft.com/library/azure/dn763945.aspx).

<a name="cache-disconnect"></a>
## Почему мой клиент был отключен от кэша?

Ниже приведены некоторые распространенные причины отключения кэша.

-	Причины на стороне клиента
	-	Клиентское приложение было развернуто повторно.
	-	Клиентское приложение выполняло операцию масштабирования.
		-	В случае облачных служб или веб-приложений это может быть следствием автоматического масштабирования.
	-	Изменен сетевой уровень на стороне клиента.
	-	Возникла временная ошибка на клиенте или в узлах сети между клиентом и сервером.
	-	Было достигнуто предельное пороговое значение пропускной способности.
	-	Выполнение операций, связанных с ЦП, заняло слишком много времени.
-	Причины на стороне сервера
	-	В предложении кэша Standard служба кэша Redis для Azure инициировала отработку отказа с переходом с основного узла на вторичный узел.
	-	В Azure было выполнено исправление экземпляра, в котором был развернут кэш.
		-	Это могли быть обновления сервера Redis или обычное обслуживание ВМ.

<a name="cache-configuration"></a>
## Что делают параметры конфигурации StackExchange.Redis?

StackExchange.Redis имеет много параметров. В этом разделе рассказывается о некоторых распространенных параметрах. Более подробные сведения о параметрах StackExchange.Redis см. в статье [Конфигурация StackExchange.Redis](https://github.com/StackExchange/StackExchange.Redis/blob/master/Docs/Configuration.md).

<table>
  <tr>
    <th>Параметры конфигурации</th>
    <th>Описание</th>
    <th>Рекомендации</th>
  </tr>
  <tr>
    <td>AbortOnConnectFail</td>
    <td>Если задано значение true, соединение не будет восстанавливаться после сбоя сети.</td>
    <td>Установите значение false и позвольте StackExchange.Redis автоматически восстанавливать соединение.</td>
  </tr>
  <tr>
    <td>ConnectRetry</td>
    <td>Количество повторных попыток подключения во время первоначального подключения.</td>
    <td></td>
  </tr>
  <tr>
    <td>ConnectTimeout</td>
    <td>Время ожидания в миллисекундах для операций подключения.</td>
    <td></td>
  </tr>
</table>

В большинстве случаев подходят значения по умолчанию для клиента. Вы можете точнее настроить параметры в зависимости от вашей рабочей нагрузки.

-	Повторы
	-	Общая рекомендация для ConnectRetry и ConnectTimeout — быстрое прекращение и повторение попытки. Это зависит от вашей рабочей нагрузки и от того, сколько времени в среднем занимает в вашем клиенте выдача команды Redis и получение ответа.
	-	Вам не нужно проверять состояние и подключаться самостоятельно — StackExchange.Redis переподключается автоматически. **Избегайте использования свойства ConnectionMultiplexer.IsConnected**.
	-	Снежный ком — иногда возникает проблема, когда вы повторяете снова и снова, это нарастает и никогда не исправляется. В этом случае следует использовать алгоритм экспоненциальной отсрочки повтора, как описано в [общем руководстве по повторам](https://github.com/mspnp/azure-guidance/blob/master/Retry-General.md), опубликованном группой Microsoft Patterns & Practices.
-	Значения времени ожидания
	-	Исследуйте вашу рабочую нагрузку и установите соответствующие значения. Если вы храните большие значения, установите более высокое значение времени ожидания.
		-	Установите для параметра ABortOnConnectFail значение false и разрешите StackExchange.Redis переподключаться за вас.
-	Используйте один экземпляр ConnectionMultiplexer для приложения. Вы можете применять LazyConnection, чтобы создать один экземпляр, который возвращается свойством Connection, как показано в разделе [Подключение к кэшу с использованием класса ConnectionMultiplexer](https://msdn.microsoft.com/library/azure/dn690521.aspx#Connect).
-	Задайте в свойстве `ConnectionMultiplexer.ClientName` уникальное имя экземпляра приложения в целях диагностики.
-	Используйте несколько экземпляров `ConnectionMultiplexer` для пользовательских рабочих нагрузок.
	-	Вы можете следовать этой модели, если в приложении имеется меняющаяся нагрузка. Например:
		-	можно иметь один мультиплексор для работы с большими ключами; 
		-	можно иметь один мультиплексор для работы с небольшими ключами; 
		-	можно задать разные значения времени ожидания подключения и логики повторов для каждого используемого ConnectionMultiplexer.
		-	Установите свойство `ClientName` в каждом мультиплексоре для облегчения диагностики. 
		-	Это обеспечит более оптимизированную задержку на каждый класс `ConnectionMultiplexer`.

<a name="cache-redis-commands"></a>
## Какие факторы следует учитывать при использовании общих команд Redis?

-	Прежде чем запускать определенные команды Redis, которые выполняются слишком долго, необходимо понять влияние этих команд.
	-	Например, не выполняйте команду [KEYS](http://redis.io/commands/keys) в рабочей среде, поскольку ее выполнение может занять очень много времени, в зависимости от количества ключей. Redis является однопотоковым сервером и обрабатывает команды по одной. Если вы выдадите после KEYS другие команды, они не будут обрабатываться, пока Redis обрабатывает команду KEYS.
-	Размеры ключей — следует использовать пары «ключ-значение» небольшого или большого размера? В целом это зависит от сценария. Если в сценарии требуются большие ключи, то можно настроить значения повторов и ConnectionTimeout, а также настроить логику повторов. С точки зрения сервера Redis чем меньше значения, тем лучше производительность.
	-	Это не означает, что в Redis нельзя хранить большие значения; вы должны учитывать следующие факторы. Задержки будут выше. Если имеется один большой и один небольшой набор данных, можно использовать несколько экземпляров ConnectionMultiplexer, настроенных с разным набором значений времени ожидания и повторов, как описано в предыдущем разделе [Что делают параметры конфигурации StackExchange.Redis](#cache-configuration).


<a name="cache-ssl"></a>
## Когда следует включать порт, не являющийся портом SSL, для подключения к Redis?

Сервер Redis не имеет встроенной поддержки SSL, но кэш Redis для Azure имеет. Если вы подключаетесь к кэшу Redis для Azure и ваш клиент поддерживает протокол SSL, например StackExchange.Redis, то следует использовать SSL.

Обратите внимание, что для новых экземпляров кэша Redis для Azure все порты, кроме SSL, отключены по умолчанию. Если ваш клиент не поддерживает SSL, то необходимо включить порт, не являющийся портом SSL, следуя указаниям, приведенным в разделе [Порты доступа](https://msdn.microsoft.com/library/azure/dn793612.aspx#AccessPorts) статьи [Настройка кэша в кэше Redis для Azure](https://msdn.microsoft.com/library/azure/dn793612.aspx).

Инструменты Redis, такие как `redis-cli`, не работают с портом SSL, но можно использовать программу, например `stunnel`, для безопасного подключения инструментов к порту SSL в соответствии с указаниями в записи блога [Объявление о поставщике состояний сеансов ASP.NET для предварительной версии Redis](http://blogs.msdn.com/b/webdev/archive/2014/05/12/announcing-asp-net-session-state-provider-for-redis-preview-release.aspx).

Инструкции по загрузке инструментов Redis см. в разделе [Как выполнять команды Redis?](#cache-commands).

<a name="cache-benchmarking"></a>
## Как измерить и протестировать производительность моего кэша?

-	[Включите диагностику кэша](https://msdn.microsoft.com/library/azure/dn763945.aspx#EnableDiagnostics), чтобы можно было [наблюдать](https://msdn.microsoft.com/library/azure/dn763945.aspx) за работоспособностью кэша. Метрики можно просмотреть на портале; кроме того, их можно [загружать и просматривать](https://github.com/rustd/RedisSamples/tree/master/CustomMonitoring) с помощью подходящих средств.
-	Для нагрузочного теста сервера Redis можно использовать benchmark.exe.
	-	Убедитесь, что клиент нагрузочного тестирования и кэш Redis находятся в одном регионе.
-	Используйте redis-cli.exe и наблюдайте за кэшем с помощью команды INFO.
	-	Если ваша нагрузка приводит к высокой степени фрагментации памяти, то необходимо масштабирование до большего размера кэша.
-	Инструкции по загрузке инструментов Redis см. в разделе [Как выполнять команды Redis?](#cache-commands).

<a name="cache-commands"></a>
## Как выполнять команды Redis?

Можно использовать любые из команд, перечисленных в разделе [Команды Redis](http://redis.io/commands#), за исключением команд, перечисленных в разделе [Команды Redis, не поддерживаемые в кэше Redis для Azure](cache-configure.md#redis-commands-not-supported-in-azure-redis-cache). Выполнять команды Redis можно несколькими способами.

-	При наличии кэша Standard команды Redis можно выполнять с помощью [консоли Redis](cache-configure.md#redis-console). Это — защищенный способ выполнения команд Redis на портале Azure.
-	Также можно использовать средства командной строки Redis. Чтобы воспользоваться ими, выполните следующие действия.
	-	Загрузите [программы командной строки Redis](https://github.com/MSOpenTech/redis/releases/download/win-2.8.19.1/redis-2.8.19.zip).
	-	Подключитесь к кэшу с помощью `redis-cli.exe`. Передайте конечную точку кэша, используя параметр -h и ключ с параметром -a, как показано в следующем примере.
		-	`redis-cli -h <your cache name>.redis.cache.windows.net -a <key>`
	-	Обратите внимание, что программы командной строки Redis не работают с портом SSL, но можно использовать программу, такую как `stunnel`, для безопасного подключения этих программ к порту SSL в соответствии с указаниями в записи блога [Объявление о поставщике состояний сеансов ASP.NET для предварительной версии Redis](http://blogs.msdn.com/b/webdev/archive/2014/05/12/announcing-asp-net-session-state-provider-for-redis-preview-release.aspx).

<a name="cache-common-patterns"></a>
## Приведите некоторые распространенные шаблоны кэша и рекомендации.

-	Группа Microsoft Patterns & Practices имеет следующие руководства.
	-	[Руководство по кэшированию](https://github.com/mspnp/azure-guidance/blob/master/Caching.md).
	-	[Руководство по проектированию и реализации облачных приложений Azure](https://github.com/mspnp/azure-guidance)
-	[Распространенные шаблоны кэша в кэше Redis для Azure](cache-howto-common-cache-patterns.md)

<a name="cache-reference"></a>
## Почему в кэше Redis для Azure отсутствует ссылка на библиотеку классов MSDN, как в некоторых других службах Azure?

Кэш Redis для Azure построен на распространенном кэше Redis с открытым исходным кодом, что предоставляет вас доступ к защищенному выделенному кэшу Redis, которым управляет Майкрософт. Различные [клиенты Redis](http://redis.io/clients) доступны для многих языков программирования. Каждый клиент имеет собственный API, который вызывает экземпляр кэша Redis с помощью [команд Redis](http://redis.io/commands).

Поскольку все клиенты разные, отсутствует одна централизованная ссылка на классы в MSDN; вместо этого каждый клиент поддерживает свою собственную справочную документацию. Помимо справочной документации на веб-сайте Azure.com на странице [документации по кэшу Redis](http://azure.microsoft.com/documentatgion/services/redis-cache/) имеется несколько учебников, показывающих, как приступить к работе с кэшем Redis для Azure, используя разные языки и клиенты кэша.

<!---HONumber=July15_HO5-->