<properties 
	pageTitle="Как отслеживать кэш Redis для Azure | Microsoft Azure" 
	description="Узнайте, как отслеживать работоспособность и производительность экземпляров кэша Redis для Azure." 
	services="redis-cache" 
	documentationCenter="" 
	authors="steved0x" 
	manager="douge" 
	editor=""/>

<tags 
	ms.service="cache" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="cache-redis" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/10/2016" 
	ms.author="sdanie"/>

# Как отслеживать кэш Redis для Azure

В системе кэша Redis для Azure предусмотрены различные возможности для отслеживания экземпляров кэша. Вы можете просматривать метрики, закреплять диаграммы метрик на начальной панели, настраивать диапазоны дат и времени для диаграмм мониторинга, добавлять и удалять метрики в диаграммах, а также настраивать отправку оповещений при выполнении определенных условий. Эти инструменты позволяют наблюдать за работоспособностью экземпляров кэша Redis для Azure и помогают управлять кэшируемыми приложениями.

Когда включена диагностика кэша, сбор и сохранение метрик кэша Redis для Azure осуществляется примерно каждые 30 секунд. Затем эти данные можно отображать на диаграммах метрик и оценивать на соответствие правилам оповещения.

Для сбора метрик кэша используется команда [INFO](http://redis.io/commands/info) Redis. Дополнительные сведения о различных вариантах INFO-команды, используемой для каждой метрики кэша, см. в разделе [Доступные метрики и интервалы отчетности](#available-metrics-and-reporting-intervals).

Чтобы просмотреть метрики кэша, [перейдите](cache-configure.md) к своему экземпляру кэша на [портале Azure](https://portal.azure.com). Метрики экземпляров кэша Redis для Azure доступны в колонке **Кэш Redis**.

![Монитор][redis-cache-monitor-overview]

>[AZURE.IMPORTANT] Если на портале Azure отображается показанное ниже сообщение, включите диагностику кэша с помощью действий, описанных в разделе [Включение диагностики кэша](#enable-cache-diagnostics).
>
>`Monitoring may not be enabled. Click here to turn on Diagnostics.`

В колонке **Кэш Redis** есть диаграммы **Мониторинг** и **Использование**, в которых отображаются метрики кэша. Каждую из этих диаграмм можно настроить путем добавления и удаления метрик либо изменения интервала отчетности. В колонке **Кэш Redis** также есть раздел **Операции** , в котором отображаются объекты **Events** и **Правила оповещений** для кэша.

## Включение диагностики кэша

В кэше Redis для Azure можно настроить сохранение диагностических данных в учетной записи хранения, после чего с ними можно непосредственно работать с использованием любого подходящего инструмента. Для сбора, хранения и отображения диагностических данных кэша на портале Azure необходимо настроить учетную запись хранения. Для экземпляров кэша в одном регионе и в рамках одной подписки используется общая учетная запись хранения диагностических данных, и в случае изменения конфигурации новые настройки применяются ко всем кэшам в подписке, входящим в данный регион.

Чтобы включить и настроить диагностику кэша, перейдите в колонку **Кэш Redis** для своего экземпляра. Если диагностика еще не включена, вместо ее диаграммы отобразится соответствующее сообщение.

![Включение диагностики кэша][redis-cache-enable-diagnostics]

Щелкните одну из диаграмм мониторинга, например **Попадания и промахи**, чтобы отобразить колонку **Метрика**, а затем щелкните **Параметры диагностики**, чтобы включить и настроить параметры диагностики для данного экземпляра службы кэша.

![Параметры диагностики][redis-cache-diagnostic-settings]

![Настройка диагностики][redis-cache-configure-diagnostics]

Нажмите кнопку **Вкл.**, чтобы включить диагностику кэша и отобразить ее конфигурацию.

Щелкните стрелку справа от элемента **Учетная запись хранения**, чтобы выбрать учетную запись, в которой будут храниться диагностические данные. Для максимальной производительности учетная запись хранения должна находиться в том же регионе, что и кэш.

Настроив параметры диагностики, нажмите кнопку **Сохранить**, чтобы сохранить конфигурацию. Обратите внимание на то, что для вступления изменений в силу может потребоваться несколько минут.

>[AZURE.IMPORTANT] Для экземпляров кэша в одном регионе и в рамках одной подписки используется общая учетная запись хранения диагностических данных, и в случае изменения конфигурации новые настройки применяются ко всем кэшам в подписке, входящим в данный регион.

Просмотреть сохраненные метрики можно в таблицах в учетной записи хранения, названия которых начинаются со строки `WADMetrics`. Дополнительные сведения о доступе к сохраненным показателям из-за пределов портала Azure см. в образце [Доступ к данным мониторинга кэша Redis](https://github.com/rustd/RedisSamples/tree/master/CustomMonitoring).

>[AZURE.NOTE] На портале Azure отображаются только метрики, которые хранятся в выбранной учетной записи. В случае ее смены данные из прежней учетной записи хранения можно будет скачать, однако они не будут отображаться на портале Azure.

## Доступные метрики и интервалы отчетности

Показатели кэша регистрируются с определенной периодичностью: **за последний час**, **за сегодня**, **за последнюю неделю** и с **настраиваемым** интервалом. В колонке **Метрика** для каждой диаграммы метрик отображаются среднее, минимальное и максимальное значения каждой метрики на данной диаграмме, а для некоторых также можно увидеть суммарное значение за весь интервал отчетности.

Каждый показатель имеет две версии. Один показатель измеряет производительность для всего кэша, а также для кэшей, использующих [кластеризацию](cache-how-to-premium-clustering.md), а вторая версия, имя которой содержит `(Shard 0-9)`, измеряет производительность отдельного сегмента в кэше. Например если кэш содержит 4 сегмента, `Cache Hits` отражает общее количество попаданий для всего кэша, а `Cache Hits (Shard 3)` — количество попаданий для отдельного сегмента кэша.

>[AZURE.NOTE] Даже когда кэш неактивен и к нему не подключены активные клиентские приложения, вы можете наблюдать определенную активность (подключенных клиентов, использование памяти и выполнение операций). Это нормальное явление в штатном режиме работы экземпляра кэша Redis для Azure.

| Метрика | Описание |
|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Попаданий в кэш | Количество успешных операций поиска по ключу за указанный интервал отчетности. Это значение соответствует INFO-команде `keyspace_hits command` Redis. |
| Промахов в кэше | Количество неудачных операций поиска по ключу за указанный интервал отчетности. Это значение соответствует INFO-команде `keyspace_misses` Redis. Промахи в кэше не означают, что с кэшем возникли какие-то неполадки. Например, при использовании шаблона программирования "Отдельно от кэша" приложение сначала ищет элемент в кэше. Если он там отсутствует (то есть фиксируется промах), элемент извлекается из базы данных и добавляется в кэш. Промахи в кэше – нормальное явление для программирования на базе шаблона "Отдельно от кэше". Если количество промахов в кэше больше, чем предполагается, проанализируйте алгоритм приложения, который заполняет кэш и считывает оттуда значения. Промахи также могут возникать в случае удаления из кэша элементов из-за нехватки памяти, однако для контроля состояния памяти лучше использовать метрики `Used Memory` и `Evicted Keys`. |
| Подключенные клиенты | Количество подключенных к кэшу клиентов за указанный интервал отчетности. Это значение соответствует INFO-команде `connected_clients` Redis. Для числа подключенных клиентов установлено ограничение в 10 000, и при его достижении последующие попытки подключения к кэшу завершаются ошибкой. Обратите внимание на то, что даже при отсутствии активных клиентских приложений к кэшу может быть подключено несколько клиентов, которые соответствуют внутренним процессам и подключениям. |
| Исключенные ключи | Количество ключей, исключенных из кэша за указанный интервал отчетности из-за ограничения `maxmemory`. Это значение соответствует INFO-команде `evicted_keys` Redis. |
| Ключи с истекшим сроком действия | Количество ключей, для которых истек срок действия за указанный интервал отчетности. Это значение соответствует INFO-команде `expired_keys` Redis. |
| Операций считывания | Количество операций считывания из кэша за указанный интервал отчетности. Эта метрика представляет собой сумму следующих значений INFO-команды Redis: `cmdstat_get`, `cmdstat_hget`, `cmdstat_hgetall`, `cmdstat_hmget`, `cmdstat_mget`, `cmdstat_getbit` и `cmdstat_getrange` Она эквивалентна сумме попаданий и промахов за указанный интервал отчетности. |
| Загрузка сервера Redis | Процентная доля циклов, в течение которых сервер Redis занят обработкой и не находится в неактивном состоянии, ожидая поступления сообщений. Если эта метрика достигает значения 100, это говорит о том, что сервер Redis достиг максимальной производительности и ЦП не может работать быстрее. При высоком показателе загрузки сервера Redis в клиенте возникают исключения из-за истечения времени ожидания. В этом случае имеет смысл увеличить масштаб или сегментировать данные на несколько экземпляров кэша. |
| Операций записи | Количество операций записи в кэш за указанный интервал отчетности. Эта метрика представляет собой сумму следующих значений INFO-команды all Redis: `cmdstat_set`, `cmdstat_hset`, `cmdstat_hmset`, `cmdstat_hsetnx`, `cmdstat_lset`, `cmdstat_mset`, `cmdstat_msetnx`, `cmdstat_setbit`, `cmdstat_setex`, `cmdstat_setrange` и `cmdstat_setnx`. |
| Всего операций | Общее количество команд, обработанных сервером кэша за указанный интервал отчетности. Это значение соответствует INFO-команде `total_commands_processed` Redis. Обратите внимание на то, что при использовании кэша Redis для Azure исключительно в режиме pub/sub метрики `Cache Hits`, `Cache Misses`, `Gets` и `Sets` не отслеживаются. Вместо них фиксируется метрика `Total Operations`, которая отражает использование кэша операциями pub/sub. |
| Используемая память | Объем памяти кэша, используемой для хранения пар «ключ — значение» (в МБ), за указанный интервал отчетности. Это значение соответствует INFO-команде `used_memory` Redis. Не содержит метаданных или фрагментации. |
| RSS используемой памяти | Объем используемой памяти кэша (в МБ) за указанный интервал отчетности с учетом фрагментации и метаданных. Это значение соответствует INFO-команде `used_memory_rss` Redis. |
| CPU (ЦП) | Использование ресурсов ЦП сервером кэша Redis для Azure (в виде процентной доли) за указанный интервал отчетности. Это значение соответствует счетчику производительности `\Processor(_Total)\% Processor Time` в операционной системе. |
| Чтение из кэша | Объем данных (в МБ/с), считанных из кэша за указанный интервал отчетности. Это значение рассчитывается на основе трафика сетевых адаптеров, поддерживающих виртуальную машину, на которой размещен кэш, и не связано непосредственно с системой Redis. ** Это значение соответствует пропускной способности сети для этого кэша. Если вы хотите настроить оповещения об ограничениях пропускной способности сети на стороне сервера, создайте их с помощью этого счетчика `Cache Read`. В [этой таблице](cache-faq.md#cache-performance) приводятся наблюдаемые ограничения пропускной способности для различных ценовых категорий и размеров кэша. ** |
| Запись в кэш | Объем данных (в МБ/с), записываемых в кэш за указанный интервал отчетности. Это значение рассчитывается на основе трафика сетевых адаптеров, поддерживающих виртуальную машину, на которой размещен кэш, и не связано непосредственно с системой Redis. Это значение соответствует пропускной способности сети в отношении данных, отправляемых из кэша клиенту. |

## Диаграммы мониторинга

В разделе **Мониторинг** представлены диаграммы **Попадания и промахи**, **Считывание и запись**, **Подключения** и **Всего команд**.

![Диаграммы мониторинга][redis-cache-monitoring-part]

На диаграммах **мониторинга** отображаются перечисленные ниже метрики.

| Диаграмма мониторинга | Метрики кэша |
|------------------|-------------------|
| Промахи и попадания | Попаданий в кэш |
| | Промахов в кэше |
| Считывание и запись | Операций считывания |
| | Операций записи |
| Подключения | Подключенные клиенты |
| Всего команд | Всего операций |

Сведения о просмотре метрик и настройке отдельных диаграмм см. в [соответствующем разделе](#how-to-view-metrics-and-customize-charts).

## Диаграммы использования

В разделе **Использование** представлены диаграммы **Загрузка сервера Redis**, **Использование памяти**, **Пропускная способность сети** и **Использование ЦП**, а также указана **ценовая категория** для данного экземпляра кэша.

![Диаграммы использования][redis-cache-usage-part]

В разделе **Ценовая категория** отображается ценовая категория кэша, и здесь его можно [перевести](cache-how-to-scale.md) в другую категорию.

На диаграммах **использования** отображаются перечисленные ниже метрики.

| Диаграмма использования | Метрики кэша |
|-------------------|---------------|
| Загрузка сервера Redis | Загрузка сервера |
| Использование памяти | Используемая память |
| Пропускная способность сети | Запись в кэш |
| Загрузка ЦП | ЦП |

Сведения о просмотре метрик и настройке отдельных диаграмм см. в [соответствующем разделе](#how-to-view-metrics-and-customize-charts).

## Просмотр метрик и настройка диаграмм

Обзор метрик представлен в колонке **Кэш Redis** на диаграммах **мониторинга** и **использования**, описанных в предыдущих разделах. Чтобы детальнее изучить метрики, представленные на той или иной диаграмме, либо настроить ее, щелкните нужную диаграмму в колонке **Кэш Redis**, и для нее появится колонка **Метрика**.

![Выноска "Метрика"][redis-cache-metric-blade]

Все оповещения, настроенные для метрик на данной диаграмме, отображаются в нижней части соответствующей колонки **Метрика**.

Чтобы добавить или удалить метрику либо изменить интервал отчетности, щелкните диаграмму правой кнопкой мыши и выберите команду **Изменить диаграмму**. Редактировать диаграммы также можно непосредственно из колонки **Кэш Redis**: для этого нужно щелкнуть диаграмму правой кнопкой мыши и выбрать команду **Изменить диаграмму**.

Чтобы добавить на диаграмму метрику или удалить ее оттуда, установите или снимите флажок рядом с названием соответствующей метрики. Чтобы изменить интервал отчетности, щелкните нужный интервал. Чтобы изменить **тип диаграммы**, щелкните нужный вариант. После внесения всех изменений нажмите кнопку **Сохранить**.

![Изменение диаграммы][redis-cache-edit-chart]

При нажатии кнопки **Сохранить** изменения сохраняются до выхода из колонки **Метрика**. При последующем открытии этой колонки снова будут видны первоначальные метрика и диапазон времени. Дополнительные сведения о настройке диаграмм см. в статье [Настройка мониторинга](../azure-portal/insights-how-to-customize-monitoring.md).

Чтобы просмотреть на диаграмме метрики за определенный период, наведите указатель мыши на полосу или точку диаграммы, которая соответствует нужному интервалу, и на экране отобразится метрика для этого периода.

![Просмотр подробных сведений о диаграмме][redis-cache-view-chart-details]

## Как наблюдать за кэшем (цен. категория «Премиум») с кластеризацией

Кэши (цен. категория «Премиум»), использующие [кластеризацию](cache-how-to-premium-clustering.md), могут содержать до 10 сегментов. У каждого сегмента есть свои собственные метрики, которые объединяются, чтобы представить метрики кэша в целом. Каждый показатель имеет две версии. Одна метрика измеряет производительность всего кэша, а вторая версия метрики, имя которой содержит `(Shard 0-9)`, измеряет производительность отдельного сегмента в кэше. Например, если кэш содержит 3 сегмента, `Cache Hits` отражает общее количество попаданий для всего кэша, а `Cache Hits (Shard 2)` — количество попаданий для отдельного сегмента кэша.

Каждая диаграмма мониторинга отображает общие метрики для кэша, а также метрики для каждого сегмента в кэше.

![Монитор][redis-cache-premium-monitor]

При наведении указателя мыши на точку данных отображаются сведения для этой точки времени.

![Монитор][redis-cache-premium-point-summary]

Обычно большие значения — это объединенные значения для кэша, тогда как небольшие значения относятся к отдельным метрикам для сегмента. Обратите внимание, что в этом примере имеется три сегмента, и попадания в кэш равномерно распределены по сегментам.

![Монитор][redis-cache-premium-point-shard]

Для просмотра дополнительных сведений щелкните диаграмму, чтобы отобразить развернутое представление в колонке **Метрика**.

![Монитор][redis-cache-premium-chart-detail]

По умолчанию каждая диаграмма включает в себя общий счетчик производительности кэша, а также счетчики производительности для отдельных сегментов. Их можно настроить в колонке **Изменение диаграммы**.

![Монитор][redis-cache-premium-edit]

Дополнительные сведения о доступных счетчиках производительности см. в разделе [Доступные метрики и интервалы отчетности](#available-metrics-and-reporting-intervals).


## Операции и оповещения

Раздел **Операции** состоит из подразделов **События** и **Правила оповещений**.

![Операции][redis-cache-operations-events]

Чтобы просмотреть список недавних операций с кэшем, щелкните диаграмму **События**, в результате чего появится колонка **События**. В число операций входят извлечение и повторное создание ключей доступа, а также активация и разрешение правил оповещения. Чтобы просмотреть дополнительные сведения об определенном событии, щелкните его в колонке **События**.

Дополнительные сведения о событиях см. в статье [Мониторинг событий, влияющих на используемые ресурсы или группы ресурсов Azure](../azure-portal/insights-debugging-with-events.md).

В разделе **Правила оповещений** отображается количество оповещений для экземпляра кэша. Правило оповещения позволяет вести мониторинг экземпляра и получать уведомления по электронной почте при достижении значением определенной метрики заданного в правиле порога.

Правила оповещений проверяются приблизительно каждые пять минут, и при их активации отправляются все настроенные уведомления. Активация правила и уведомления обрабатываются не мгновенно; с момента активации до момента отправки оповещения может пройти несколько минут.

Правила оповещений можно просмотреть и настроить в колонке **Метрика** определенной диаграммы мониторинга либо в колонке **Правила оповещений**.

Правила оповещений обладают перечисленными ниже свойствами.

| Свойство правила оповещения | Описание |
|-------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Resource (Ресурс) | Ресурс, проверяемый правилом оповещения. При создании правила из кэша Redis ресурсом является кэш. |
| Name (Имя) | Имя, уникальным образом идентифицирующее правило оповещения в текущем экземпляре кэша. |
| Description (Описание) | Необязательное описание правила оповещения. |
| Metric (Метрика) | Метрика, отслеживаемая с помощью правила. Список всех метрик кэша см. в разделе "Доступные метрики и интервалы отчетности". |
| Условие | Оператор условия для правила оповещения. Возможные варианты: больше, больше или равно, меньше, меньше или равно. |
| Threshold (Пороговое значение) | Значение, с которым сравнивается метрика с использованием оператора, заданного с помощью свойства "Условие". В зависимости от метрики это значение может измеряться в байтах в секунду, байтах, процентах или штуках. |
| Период | Период, за который рассчитывается среднее значение показателя, используемое при сравнении в правиле оповещения. Например, для периода "за последний час" среднее значение метрики, используемое для сравнения, рассчитывается за предыдущий часовой интервал. Чтобы получать оповещения о достижении пороговых показателей из-за пиков активности, нужно задать более короткий период. Для получения оповещений о стабильном превышении порогового показателя используется более длительный период. |
| Сообщать администратору службы и соадминистраторам | Если для этого свойства задано значение "true", при срабатывании оповещения по электронной почте уведомляются администратор службы и соадминистраторы. |
| Адрес электронной почты дополнительного администратора | Необязательный адрес электронной почты дополнительного администратора, которого нужно уведомлять в случае активации оповещения. |

Для каждого срабатывания правила отправляется только одно уведомление. После достижения порогового значения и отправки оповещения правило больше не проверяется до тех пор, пока значение метрики снова не опустится ниже порога. Если после этого метрика снова превышает пороговый показатель, оповещение активируется повторно и отправляется новое уведомление.

Чтобы просмотреть все правила для экземпляра кэша, щелкните часть **Правила оповещений** в колонке **Кэш Redis**. Чтобы просмотреть только правила, использующие определенную метрику, перейдите в колонку **Метрика** для диаграммы, которая содержит данную метрику.

![Правила оповещения][redis-cache-alert-rules]

Чтобы добавить правило оповещения, щелкните **Добавить правило** в колонке **Метрика** или **Правила оповещений**.

Задайте условия правила в колонке **Добавление правила оповещения** и нажмите кнопку **ОК**.

![Добавление правила оповещения][redis-cache-add-alert]

>[AZURE.NOTE] При создании правила с помощью команды **Добавить правило** из колонки **Метрика** в раскрывающемся меню **Метрика** появляются только метрики, отображаемые на диаграмме в данной колонке. При создании правила с помощью команды **Добавить правило** из колонки **Правила оповещений** в раскрывающемся меню **Метрика** появляются все метрики кэша.

Сохраненное правило оповещения появляется в колонке **Правила оповещений**, а также в колонке **Метрика** для всех диаграмм, на которых отображается метрика, используемая в этом правиле. Чтобы изменить правило оповещения, щелкните его имя, в результате чего появится колонка **Изменение правила**. В колонке **Изменение правила** можно отредактировать свойства правила, удалить или отключить его, а также повторно включить ранее отключенное правило.

>[AZURE.NOTE] Все изменения, внесенные в свойства правила, отражаются в колонках **Правила оповещений** и **Метрика** через непродолжительное время.

При активации правила отправляется сообщение электронной почты на основе его настроек, а в части **Правила оповещений** в колонке **Кэш Redis** появляется значок оповещения.

Оповещение считается разрешенным, когда для вызвавшего его условия больше не возвращается значение "true". После разрешения правила значок оповещения заменяется значком галочки. Чтобы просмотреть подробные сведения о срабатывании и разрешении оповещений, щелкните часть **События** в колонке **Кэш Redis**, и в колонке **События** появятся соответствующие события.

Дополнительные сведения об оповещениях в среде Azure см. в статье [Получение уведомлений об оповещениях](../azure-portal/insights-receive-alert-notifications.md).
  
<!-- IMAGES -->
[redis-cache-monitor-overview]: ./media/cache-how-to-monitor/redis-cache-monitor-overview.png

[redis-cache-enable-diagnostics]: ./media/cache-how-to-monitor/redis-cache-enable-diagnostics.png

[redis-cache-diagnostic-settings]: ./media/cache-how-to-monitor/redis-cache-diagnostic-settings.png

[redis-cache-configure-diagnostics]: ./media/cache-how-to-monitor/redis-cache-configure-diagnostics.png

[redis-cache-monitoring-part]: ./media/cache-how-to-monitor/redis-cache-monitoring-part.png

[redis-cache-usage-part]: ./media/cache-how-to-monitor/redis-cache-usage-part.png

[redis-cache-metric-blade]: ./media/cache-how-to-monitor/redis-cache-metric-blade.png

[redis-cache-edit-chart]: ./media/cache-how-to-monitor/redis-cache-edit-chart.png

[redis-cache-view-chart-details]: ./media/cache-how-to-monitor/redis-cache-view-chart-details.png

[redis-cache-operations-events]: ./media/cache-how-to-monitor/redis-cache-operations-events.png

[redis-cache-alert-rules]: ./media/cache-how-to-monitor/redis-cache-alert-rules.png

[redis-cache-add-alert]: ./media/cache-how-to-monitor/redis-cache-add-alert.png

[redis-cache-premium-monitor]: ./media/cache-how-to-monitor/redis-cache-premium-monitor.png

[redis-cache-premium-edit]: ./media/cache-how-to-monitor/redis-cache-premium-edit.png

[redis-cache-premium-chart-detail]: ./media/cache-how-to-monitor/redis-cache-premium-chart-detail.png

[redis-cache-premium-point-summary]: ./media/cache-how-to-monitor/redis-cache-premium-point-summary.png

[redis-cache-premium-point-shard]: ./media/cache-how-to-monitor/redis-cache-premium-point-shard.png

<!---HONumber=AcomDC_0518_2016-->