---
title: "Настройка виртуальной сети для кэша Redis для Azure уровня &quot;Премиум&quot; | Документация Майкрософт"
description: "Узнайте, как настроить поддержку виртуальной сети и управлять ей для экземпляров кэша Redis для Azure уровня Премиум"
services: redis-cache
documentationcenter: 
author: steved0x
manager: douge
editor: 
ms.assetid: 8b1e43a0-a70e-41e6-8994-0ac246d8bf7f
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache-redis
ms.devlang: na
ms.topic: article
ms.date: 05/11/2017
ms.author: sdanie
ms.translationtype: Human Translation
ms.sourcegitcommit: 97fa1d1d4dd81b055d5d3a10b6d812eaa9b86214
ms.openlocfilehash: 945da7ce2ab5f2d479d96a6ed2896a0ba7e0747e
ms.contentlocale: ru-ru
ms.lasthandoff: 05/11/2017


---
# <a name="how-to-configure-virtual-network-support-for-a-premium-azure-redis-cache"></a>Настройка поддержки виртуальной сети для кэша Redis для Azure уровня Премиум
Кэш Redis для Azure предлагает разные варианты кэша, которые обеспечивают гибкость в выборе размера и функций кэша, включая функции уровня "Премиум", такие как кластеризация, постоянное хранение данных и поддержка виртуальной сети. Виртуальная сеть — это частная сеть в облаке. В случае настройки экземпляра кэша Redis для Azure в виртуальной сети он не является общедоступным, а доступен только для виртуальных машин и приложений в этой виртуальной сети. В этой статье описана настройка поддержки виртуальной сети для экземпляра кэша Redis для Azure уровня "Премиум".

> [!NOTE]
> Кэш Redis для Azure поддерживает классические виртуальные сети и виртуальные сети Resource Manager.
> 
> 

Сведения о других функциях кэша уровня "Премиум" см. в статье [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md).

## <a name="why-vnet"></a>Зачем использовать виртуальные сети?
Развертывание [виртуальной сети Azure (VNet)](https://azure.microsoft.com/services/virtual-network/) обеспечивает улучшенную безопасность и изоляцию для кэша Redis для Azure. Такие развертывания позволяют определять подсети, настраивать политики контроля доступа и использовать другие функции ограничения доступа.

## <a name="virtual-network-support"></a>Поддержка виртуальной сети
Поддержка виртуальной сети настраивается во время создания кэша в колонке **Новый кэш Redis** . 

[!INCLUDE [redis-cache-create](../../includes/redis-cache-premium-create.md)]

После выбора ценовой категории "Премиум" можно настроить интеграцию виртуальной сети Redis, выбрав виртуальную сеть, которая находится в той же подписке и расположении, что и кэш. Чтобы использовать новую виртуальную сеть, сначала создайте ее, выполнив действия, описанные в статье [Создание виртуальной сети с помощью портала Azure](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [Создание (классической) виртуальной сети с помощью портала Azure](../virtual-network/virtual-networks-create-vnet-classic-portal.md), а затем вернитесь в колонку **Новый кэш Redis**, чтобы создать и настроить кэш уровня "Премиум".

Чтобы настроить виртуальную сеть для нового кэша, в колонке **Новый кэш Redis** щелкните **Виртуальная сеть** и в раскрывающемся списке выберите нужную виртуальную сеть.

![Виртуальная сеть][redis-cache-vnet]

Выберите нужную подсеть в раскрывающемся списке **Подсети** и укажите необходимый **статический IP-адрес**. При использовании классической виртуальной сети заполнять поле **Статический IP-адрес** не обязательно, а если этот адрес не задан, то он выбирается из указанной подсети.

> [!IMPORTANT]
> При развертывании кэша Redis для Azure в виртуальной сети Resource Manager он должен размещаться в выделенной подсети, которая не содержит других ресурсов, кроме экземпляров кэша Redis для Azure. Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, то это приведет к сбою операции.
> 
> 

![Виртуальная сеть][redis-cache-vnet-ip]

> [!IMPORTANT]
> Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)
> 
> Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса на сегмент и еще один IP-адрес для балансировщика нагрузки. Некластеризованный кэш считается имеющим один сегмент.
> 
> 

Создав кэш, конфигурацию виртуальной сети можно просмотреть, щелкнув **Виртуальная сеть** в **меню ресурсов**.

![Виртуальная сеть][redis-cache-vnet-info]

Чтобы подключиться к экземпляру кэша Redis для Azure при использовании виртуальной сети, укажите имя узла кэша в строке подключения, как показано в приведенном ниже примере.

    private static Lazy<ConnectionMultiplexer> lazyConnection = new Lazy<ConnectionMultiplexer>(() =>
    {
        return ConnectionMultiplexer.Connect("contoso5premium.redis.cache.windows.net,abortConnect=false,ssl=true,password=password");
    });

    public static ConnectionMultiplexer Connection
    {
        get
        {
            return lazyConnection.Value;
        }
    }

## <a name="azure-redis-cache-vnet-faq"></a>Часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure
Следующий список содержит ответы на часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure.

* [Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?](#what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets)
* [Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?](#can-i-use-vnets-with-a-standard-or-basic-cache)
* [Почему в одних подсетях не удается создать кэш Redis, а в других удается?](#why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others)
* [Каковы требования к адресному пространству подсети?](#what-are-the-subnet-address-space-requirements)
* [Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)](#do-all-cache-features-work-when-hosting-a-cache-in-a-vnet)

## <a name="what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets"></a>Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?
При размещении кэша Redis для Azure в виртуальной сети используются порты, указанные в следующих таблицах. 

>[!IMPORTANT]
>Если эти порты заблокированы, кэш может работать неправильно. Блокировка одного или нескольких из этих портов является самой распространенной проблемой неправильной настройки при использовании кэша Redis для Azure в виртуальной сети.
> 
> 

- [Обязательные порты для исходящего трафика](#outbound-port-requirements)
- [Обязательные порты для входящего трафика](#inbound-port-requirements)

### <a name="outbound-port-requirements"></a>Обязательные порты для исходящего трафика

Существует семь обязательных портов для исходящего трафика.

- При необходимости все исходящие подключения к Интернету осуществляются через устройство аудита в локальной среде клиента.
- Три порта направляют трафик к конечным точкам Azure, обслуживающим службу хранилища Azure и Azure DNS.
- Остальные диапазоны портов предназначены для внутреннего обмена данными в подсети Redis. Для внутреннего обмена данными в подсети Redis не требуются правила группы безопасности сети в подсети.

| Порты | Направление | Транспортный протокол | Назначение | Удаленный IP-адрес |
| --- | --- | --- | --- | --- |
| 80, 443 |Исходящие |TCP |Зависимости Redis в службе хранилища Azure или PKI (Интернет) |* |
| 53 |Исходящие |TCP/UDP |Зависимости Redis в DNS (Интернет/виртуальная сеть) |* |
| 8443 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |
| 10221-10231 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |
| 20226 |Исходящие |TCP |Внутренний обмен данными для Redis |(Подсеть Redis) |
| 13000-13999 |Исходящие |TCP |Внутренний обмен данными для Redis |(Подсеть Redis) |
| 15000-15999 |Исходящие |TCP |Внутренний обмен данными для Redis |(Подсеть Redis) |


### <a name="inbound-port-requirements"></a>Обязательные порты для входящего трафика

Существует восемь обязательных диапазонов портов для входящего трафика. Входящие запросы в этих диапазонах исходят от других служб, размещенных в той же виртуальной сети, или являются результатом внутреннего обмена данными в подсети Redis.

| Порты | Направление | Транспортный протокол | Назначение | Удаленный IP-адрес |
| --- | --- | --- | --- | --- |
| 6379, 6380 |Входящий трафик |TCP |Обмен данными между клиентом и Redis, балансировка нагрузки Azure |Виртуальная сеть, Azure Load Balancer |
| 8443 |Входящий трафик |TCP |Внутренний обмен данными для Redis |(Подсеть Redis) |
| 8500 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure |Azure Load Balancer |
| 10221-10231 |Входящий трафик |TCP |Внутренний обмен данными для Redis |(Подсеть Redis) Azure Load Balancer |
| 13000-13999 |Входящий трафик |TCP |Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure |Виртуальная сеть, Azure Load Balancer |
| 15000-15999 |Входящий трафик |TCP |Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure |Виртуальная сеть, Azure Load Balancer |
| 16001 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure |Azure Load Balancer |
| 20226 |Входящий трафик |TCP |Внутренний обмен данными для Redis |(Подсеть Redis) |

### <a name="additional-vnet-network-connectivity-requirements"></a>Дополнительные требования к подключению к виртуальной сети

Существуют требования к сетевому подключению кэша Redis для Azure, которым виртуальная сеть изначально может не соответствовать. Для правильной работы кэша Redis для Azure в виртуальной сети нужно выполнить все требования, перечисленные ниже.

* Исходящие сетевые подключения к конечным точкам хранилища Azure по всему миру. Это относится к конечным точкам, находящимся в одном регионе с экземпляром кэша Redis для Azure, а также к конечным точкам хранилища, расположенным в **других** регионах Azure. Конечные точки службы хранилища Azure разрешаются в следующих DNS-доменах: *table.core.windows.net*, *blob.core.windows.net*, *queue.core.windows.net* и *file.core.windows.net*. 
* Исходящие сетевые подключения к *ocsp.msocsp.com*, *mscrl.microsoft.com* и *crl.microsoft.com*. Такое подключение необходимо для поддержки функций протокола SSL.
* Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках. Эти требования DNS обеспечиваются за счет настройки допустимой инфраструктуры DNS и ее поддержания для виртуальной сети.
* Исходящие сетевые подключения к следующим конечным точкам мониторинга Azure, которые разрешаются в таких DNS-доменах: shoebox2-black.shoebox2.metrics.nsatc.net, north-prod2.prod2.metrics.nsatc.net, azglobal-black.azglobal.metrics.nsatc.net, shoebox2-red.shoebox2.metrics.nsatc.net, east-prod2.prod2.metrics.nsatc.net, azglobal-red.azglobal.metrics.nsatc.net.

### <a name="can-i-use-vnets-with-a-standard-or-basic-cache"></a>Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?
Виртуальные сети доступны только для кэшей уровня "Премиум".

### <a name="why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others"></a>Почему в одних подсетях не удается создать кэш Redis, а в других удается?
При развертывании кэша Redis для Azure в виртуальной сети Resource Manager он должен размещаться в выделенной подсети, которая не содержит ресурсов другого типа. Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, то это приведет к сбою операции. Прежде чем создать новый кэш Redis, необходимо удалить существующие ресурсы из подсети.

В классической виртуальной сети можно развернуть ресурсы нескольких типов, пока для них имеется достаточно доступных IP-адресов.

### <a name="what-are-the-subnet-address-space-requirements"></a>Каковы требования к адресному пространству подсети?
Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)

Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса на сегмент и еще один IP-адрес для балансировщика нагрузки. Некластеризованный кэш считается имеющим один сегмент.

### <a name="do-all-cache-features-work-when-hosting-a-cache-in-a-vnet"></a>Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)
Если кэш является частью виртуальной сети, то к нему могут обращаться только клиенты в этой виртуальной сети. Поэтому следующие функции управления кэшем в данный момент не работают.

* Консоль Redis. Так как консоль Redis работает в локальном браузере вне виртуальной сети, она не может подключиться к кэшу.

## <a name="use-expressroute-with-azure-redis-cache"></a>Использование ExpressRoute с кэшем Redis для Azure
Клиенты могут подключить канал [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) к своей инфраструктуре виртуальной сети, расширяя таким образом свою локальную сеть в Azure. 

По умолчанию только что созданный канал ExpressRoute объявляет основной маршрут, который позволяет создавать исходящее подключение к Интернету. При такой конфигурации клиентские приложения могут подключаться к другим конечным точкам Azure, включая кэш Redis для Azure.

Тем не менее в типовой клиентской конфигурации определяется собственный основной маршрут (0.0.0.0/0), который вместо этого направляет исходящий интернет-трафик в локальную среду. Этот поток трафика прерывает подключение к кэшу Redis для Azure, если исходящий трафик затем блокируется локально, так что экземпляр кэша Redis для Azure не может связаться со своими зависимыми компонентами.

Чтобы устранить эту проблему, следует указать один (или несколько) определяемый пользователем маршрут в подсети, которая содержит кэш Redis для Azure. Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.

При возможности рекомендуется использовать следующую конфигурацию:

* Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.
* Определяемый пользователем маршрут, примененный к подсети, содержащей кэш Redis для Azure, задает рабочий маршрут 0.0.0.0/0 для трафика TCP/IP, направляемого в общедоступный Интернет. Для этого может задаваться, например, следующий переход типа "Интернет".

В результате этих действий определяемый пользователем маршрут уровня подсети получает приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из кэша Redis для Azure.

Подключение к экземпляру кэша Redis для Azure из локального приложения с помощью ExpressRoute — нетипичная ситуация по соображениям производительности (для повышения производительности клиенты кэша Redis для Azure должны быть в том же регионе, что и кэш Redis для Azure).

>[!IMPORTANT] 
>Маршруты, указанные в UDR, **должны** быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute. В приведенном ниже примере используется широкий диапазон адресов 0.0.0.0/0, и, таким образом, он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.

>[!WARNING]  
>Кэш Redis для Azure не поддерживается с конфигурациями ExpressRoute, которые **неправильно осуществляют перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**. Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Если эти диапазоны адресов неправильно перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети экземпляра кэша Redis для Azure неправильно принудительно туннелируются в локальную сетевую инфраструктуру клиента. Этот сетевой поток нарушает работу кэша Redis для Azure. Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.


Справочные сведения об определяемых пользователем маршрутах см. в этом [обзоре](../virtual-network/virtual-networks-udr-overview.md).

Дополнительные сведения об ExpressRoute см. в статье [Технический обзор ExpressRoute](../expressroute/expressroute-introduction.md).

## <a name="next-steps"></a>Дальнейшие действия
Узнайте, как использовать расширенные функции кэша.

* [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md)

<!-- IMAGES -->

[redis-cache-vnet]: ./media/cache-how-to-premium-vnet/redis-cache-vnet.png

[redis-cache-vnet-ip]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-ip.png

[redis-cache-vnet-info]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-info.png


