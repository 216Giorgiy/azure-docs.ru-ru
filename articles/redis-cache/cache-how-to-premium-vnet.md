---
title: "Настройка виртуальной сети для кэша Redis для Azure уровня &quot;Премиум&quot; | Документация Майкрософт"
description: "Узнайте, как настроить поддержку виртуальной сети и управлять ей для экземпляров кэша Redis для Azure уровня Премиум"
services: redis-cache
documentationcenter: 
author: steved0x
manager: douge
editor: 
ms.assetid: 8b1e43a0-a70e-41e6-8994-0ac246d8bf7f
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache-redis
ms.devlang: na
ms.topic: article
ms.date: 02/09/2017
ms.author: sdanie
translationtype: Human Translation
ms.sourcegitcommit: 50d8db29ccce1244387f1fe0e3e42e610575e483
ms.openlocfilehash: 057affeccd955245ac07fc5e174447562e81b959


---
# <a name="how-to-configure-virtual-network-support-for-a-premium-azure-redis-cache"></a>Настройка поддержки виртуальной сети для кэша Redis для Azure уровня Премиум
Кэш Redis для Azure предлагает разные варианты кэша, которые обеспечивают гибкость в выборе размера и функций кэша, включая функции уровня "Премиум", такие как кластеризация, постоянное хранение данных и поддержка виртуальной сети. Виртуальная сеть — это частная сеть в облаке. В случае настройки экземпляра кэша Redis для Azure в виртуальной сети он не является общедоступным, а доступен только для виртуальных машин и приложений в этой виртуальной сети. В этой статье описана настройка поддержки виртуальной сети для экземпляра кэша Redis для Azure уровня "Премиум".

> [!NOTE]
> Кэш Redis для Azure поддерживает классические виртуальные сети и виртуальные сети ARM.
> 
> 

Сведения о других функциях кэша уровня "Премиум" см. в статье [Знакомство с кэшем Redis для Azure уровня "Премиум"](cache-premium-tier-intro.md).

## <a name="why-vnet"></a>Зачем использовать виртуальные сети?
[виртуальной сети Azure](https://azure.microsoft.com/services/virtual-network/) обеспечивает повышенную безопасность и изоляцию кэша Redis для Azure, а также подсети, политики контроля доступа и другие функции для дальнейшего ограничения доступа к кэшу Redis для Azure.

## <a name="virtual-network-support"></a>Поддержка виртуальной сети
Поддержка виртуальной сети настраивается во время создания кэша в колонке **Новый кэш Redis** . 

[!INCLUDE [redis-cache-create](../../includes/redis-cache-premium-create.md)]

После выбора ценовой категории "Премиум" можно настроить интеграцию виртуальной сети кэша Redis для Azure, выбрав виртуальную сеть, которая находится в той же подписке и расположении, что и кэш. Чтобы использовать новую виртуальную сеть, сначала создайте ее, выполнив действия, описанные в статье [Создание виртуальной сети с помощью портала Azure](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [Создание (классической) виртуальной сети с помощью портала Azure](../virtual-network/virtual-networks-create-vnet-classic-portal.md), а затем вернитесь в колонку **Новый кэш Redis**, чтобы создать и настроить кэш уровня "Премиум".

Чтобы настроить виртуальную сеть для нового кэша, в колонке **Новый кэш Redis** щелкните **Виртуальная сеть** и в раскрывающемся списке выберите нужную виртуальную сеть.

![Виртуальная сеть][redis-cache-vnet]

Выберите нужную подсеть в раскрывающемся списке **Подсети** и укажите необходимый **статический IP-адрес**. При использовании классической виртуальной сети заполнять поле **Статический IP-адрес** не обязательно, а если этот адрес не задан, то он выбирается из указанной подсети.

> [!IMPORTANT]
> При развертывании кэша Redis для Azure в виртуальной сети ARM он должен размещаться в выделенной подсети, которая не содержит других ресурсов, кроме экземпляров кэша Redis для Azure. Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети ARM, содержащей другие ресурсы, то это приведет к сбою операции.
> 
> 

![Виртуальная сеть][redis-cache-vnet-ip]

> [!IMPORTANT]
> Первые четыре адреса в подсети зарезервированы и не могут быть использованы. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)
> 
> 

Создав кэш, конфигурацию виртуальной сети можно просмотреть, щелкнув **Виртуальная сеть** в **меню ресурсов**.

![Виртуальная сеть][redis-cache-vnet-info]

Чтобы подключиться к экземпляру кэша Redis для Azure при использовании виртуальной сети, укажите имя узла кэша в строке подключения, как показано в следующем примере.

    private static Lazy<ConnectionMultiplexer> lazyConnection = new Lazy<ConnectionMultiplexer>(() =>
    {
        return ConnectionMultiplexer.Connect("contoso5premium.redis.cache.windows.net,abortConnect=false,ssl=true,password=password");
    });

    public static ConnectionMultiplexer Connection
    {
        get
        {
            return lazyConnection.Value;
        }
    }

## <a name="azure-redis-cache-vnet-faq"></a>Часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure
Следующий список содержит ответы на часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure.

* [Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?](#what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets)
* [Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?](#can-i-use-vnets-with-a-standard-or-basic-cache)
* [Почему в одних подсетях не удается создать кэш Redis, а в других удается?](#why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others)
* [Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)](#do-all-cache-features-work-when-hosting-a-cache-in-a-vnet)

## <a name="what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets"></a>Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?
При размещении кэша Redis для Azure в виртуальной сети используются порты, указанные в следующей таблице. Если эти порты заблокированы, кэш может работать неправильно. Блокировка одного или нескольких из этих портов является самой распространенной проблемой неправильной настройки при использовании кэша Redis для Azure в виртуальной сети.

| Порты | Направление | Транспортный протокол | Назначение | Удаленный IP-адрес |
| --- | --- | --- | --- | --- |
| 80, 443 |Исходящие |TCP |Зависимости Redis в службе хранилища Azure или PKI (Интернет) |* |
| 53 |Исходящие |TCP/UDP |Зависимости Redis в DNS (Интернет/виртуальная сеть) |* |
| 6379, 6380 |Входящий трафик |TCP |Подключение клиента к Redis, балансировка нагрузки Azure |VIRTUAL_NETWORK, AZURE_LOADBALANCER |
| 8443 |Входящий и исходящий трафик |TCP |Сведения о реализации для Redis |VIRTUAL_NETWORK |
| 8500 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure |AZURE_LOADBALANCER |
| 10221-10231 |Входящий и исходящий трафик |TCP |Сведения о реализации для Redis (можно ограничить удаленную конечную точку до VIRTUAL_NETWORK) |VIRTUAL_NETWORK, AZURE_LOADBALANCER |
| 13000-13999 |Входящий трафик |TCP |Подключение клиента к кластерам Redis, балансировка нагрузки Azure |VIRTUAL_NETWORK, AZURE_LOADBALANCER |
| 15000-15999 |Входящий трафик |TCP |Подключение клиента к кластерам Redis, балансировка нагрузки Azure |VIRTUAL_NETWORK, AZURE_LOADBALANCER |
| 16001 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure |AZURE_LOADBALANCER |
| 20226 |Входящий и исходящий трафик |TCP |Сведения о реализации для кластеров Redis |VIRTUAL_NETWORK |

Существуют требования к сетевому подключению кэша Redis для Azure, которым виртуальная сеть изначально может не соответствовать. Для правильной работы кэша Redis для Azure в виртуальной сети нужно выполнить все требования, перечисленные ниже.

* Исходящие сетевые подключения к конечным точкам хранилища Azure по всему миру. Это относится к конечным точкам, находящимся в одном регионе с экземпляром кэша Redis для Azure, а также к конечным точкам хранилища, расположенным в **других** регионах Azure. Конечные точки службы хранилища Azure разрешаются в следующих DNS-доменах: *table.core.windows.net*, *blob.core.windows.net*, *queue.core.windows.net* и *file.core.windows.net*. 
* Исходящие сетевые подключения к *ocsp.msocsp.com*, *mscrl.microsoft.com* и *crl.microsoft.com*. Такое подключение необходимо для поддержки функций протокола SSL.
* Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках. Эти требования DNS обеспечиваются за счет настройки допустимой инфраструктуры DNS и ее поддержания для виртуальной сети.
* Исходящие сетевые подключения к следующим конечным точкам мониторинга Azure, которые разрешаются в таких DNS-доменах: shoebox2-black.shoebox2.metrics.nsatc.net, north-prod2.prod2.metrics.nsatc.net, azglobal-black.azglobal.metrics.nsatc.net, shoebox2-red.shoebox2.metrics.nsatc.net, east-prod2.prod2.metrics.nsatc.net, azglobal-red.azglobal.metrics.nsatc.net.

### <a name="can-i-use-vnets-with-a-standard-or-basic-cache"></a>Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?
Виртуальные сети доступны только для кэшей уровня "Премиум".

### <a name="why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others"></a>Почему в одних подсетях не удается создать кэш Redis, а в других удается?
При развертывании кэша Redis для Azure в виртуальной сети ARM он должен размещаться в выделенной подсети, которая не содержит ресурсов другого типа. Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети ARM, содержащей другие ресурсы, то это приведет к сбою операции. Прежде чем создать новый кэш Redis, необходимо удалить существующие ресурсы из подсети.

В классической виртуальной сети можно развернуть ресурсы нескольких типов, пока для них имеется достаточно доступных IP-адресов.

### <a name="do-all-cache-features-work-when-hosting-a-cache-in-a-vnet"></a>Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)
Если кэш является частью виртуальной сети, то к нему могут обращаться только клиенты в этой виртуальной сети. Поэтому следующие функции управления кэшем в данный момент не работают.

* Консоль Redis — так как консоль Redis использует клиент redis-cli.exe, размещенный на виртуальных машинах, которые не входят в виртуальную сеть, она не может подключиться к кэшу.

## <a name="use-expressroute-with-azure-redis-cache"></a>Использование ExpressRoute с кэшем Redis для Azure
Клиенты могут подключить канал [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) к своей инфраструктуре виртуальной сети, расширяя таким образом свою локальную сеть в Azure. 

По умолчанию только что созданный канал ExpressRoute объявляет основной маршрут, который позволяет создавать исходящее подключение к Интернету. При такой конфигурации клиентские приложения могут подключаться к другим конечным точкам Azure, включая кэш Redis для Azure.

Тем не менее в типовой клиентской конфигурации определяется собственный основной маршрут (0.0.0.0/0), который вместо этого направляет исходящий интернет-трафик в локальную среду. Этот поток трафика неизменно прерывает подключение к кэшу Redis для Azure, так как исходящий трафик или заблокирован локально, или преобразован с помощью NAT в нераспознаваемый набор адресов, которые больше не относятся к различным конечным точкам Azure.

Чтобы устранить эту проблему, следует указать один (или несколько) определяемый пользователем маршрут в подсети, которая содержит кэш Redis для Azure. Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.

При возможности рекомендуется использовать следующую конфигурацию:

* Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.
* Определяемый пользователем маршрут, примененный к подсети, содержащей кэш Redis для Azure, задает маршрут 0.0.0.0/0 со следующим переходом типа "Интернет" (пример см. ниже в этой статье).

В результате этих действий определяемый пользователем маршрут уровня подсети получает приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из кэша Redis для Azure.

Хотя подключение к экземпляру кэша Redis для Azure из локального приложения с помощью ExpressRoute — не типичная ситуация по соображениям производительности (для повышения производительности клиенты кэша Redis для Azure должны быть в том же регионе, что и кэш Redis для Azure), в данном случае путь для исходящих сетевых подключений не может проходить через внутренние корпоративные прокси-серверы и не может принудительно туннелироваться в локальную среду. Дело в том, что в этом случае меняется действующий адрес NAT для исходящего сетевого трафика из кэша Redis для Azure. Изменение адреса NAT для исходящего сетевого трафика экземпляра кэша Redis для Azure приводит к проблемам при подключении ко многим указанным выше конечным точкам. Из-за этого будет невозможно создавать кэши Redis для Azure.

>[!IMPORTANT] 
>Маршруты, указанные в UDR, **должны** быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute. В приведенном ниже примере используется широкий диапазон адресов 0.0.0.0/0, и, таким образом, он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.

>[!WARNING]  
>Кэш Redis для Azure не поддерживается с конфигурациями ExpressRoute, которые **неправильно осуществляют перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**. Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Если эти диапазоны адресов неправильно перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети кэша Redis для Azure неправильно принудительно туннелируются в локальную сетевую инфраструктуру клиента. Этот сетевой поток нарушает работу кэша Redis для Azure. Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.


Справочные сведения об определяемых пользователем маршрутах см. в этом [обзоре](../virtual-network/virtual-networks-udr-overview.md).

Дополнительные сведения об ExpressRoute см. в статье [Технический обзор ExpressRoute](../expressroute/expressroute-introduction.md).

## <a name="next-steps"></a>Дальнейшие действия
Узнайте, как использовать расширенные функции кэша.

* [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md)

<!-- IMAGES -->

[redis-cache-vnet]: ./media/cache-how-to-premium-vnet/redis-cache-vnet.png

[redis-cache-vnet-ip]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-ip.png

[redis-cache-vnet-info]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-info.png




<!--HONumber=Feb17_HO2-->


