<properties
   pageTitle="Руководство по автоматическому масштабированию | Microsoft Azure"
   description="Рекомендации относительно автоматического масштабирования для динамического распределения ресурсов, необходимых приложению."
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="03/28/2016"
   ms.author="masashin"/>

# Руководство по автоматическому масштабированию

![логотип для шаблонов и рекомендаций](media/best-practices-auto-scaling/pnp-logo.png)

## Обзор
Автоматическое масштабирование — это процесс динамического выделения ресурсов, необходимых приложению для обеспечения соответствия требованиям к производительности и требованиям соглашений об уровне обслуживания (SLA) при одновременном сведении к минимуму затрат на выполнение. При увеличении объема работы приложению могут потребоваться дополнительные ресурсы, чтобы оно могло выполнять свои задачи своевременно. По мере уменьшения объема работы можно отменить выделение ресурсов, чтобы сократить затраты без ущерба для производительности и показателей, необходимых для соответствия требованиям соглашений об уровне обслуживания. Автоматическое масштабирование использует преимущества эластичности облачной среды и сокращает издержки на управление, так как оператору можно реже отслеживать производительность системы и принимать решения о добавлении или удалении ресурсов.
<br\>

>[AZURE.NOTE] Автоматическое масштабирование применяется ко всем ресурсам, используемым приложением, а не только вычислительным ресурсам. Например, если в системе используется очередь сообщений для отправки и получения сведений, она может создать дополнительные очереди по мере увеличения нагрузки.

## Типы масштабирования
Масштабирование обычно бывает двух видов.

- **Вертикальное масштабирование** (часто называется _увеличением и уменьшением масштаба_). Этот вид масштабирования требует внесения изменений в оборудование (расширение или сокращение емкости и производительности) или повторного развертывания решения с помощью альтернативного оборудования, предоставляющего соответствующую емкость и производительность. В облачной среде аппаратная платформа обычно является виртуализированной средой. За исключением случаев, когда исходное оборудование имеет значительный избыточный резерв, включающий последующие авансовые капитальные затраты, вертикальное масштабирование в этой среде включает в себя подготовку ресурсов более мощных ресурсов и последующий перенос системы на эти новые ресурсы. Вертикальное масштабирование чаще всего приводит к нарушению работы системы, в результате чего система становится временно недоступна, пока выполняется развертывание. Можно сделать так, чтобы исходная система продолжала работать во время подготовки нового оборудования и была переведена в режим онлайн, однако при этом вероятнее всего будут возникать некоторые прерывания во время обработки переходов из старой среды в новую. Автоматическое масштабирование редко используют для реализации стратегии вертикального масштабирования.
- **Горизонтальное масштабирование** (часто называется _развертыванием и свертыванием_). Этот вид масштабирования требует развертывания решения на дополнительных ресурсах или на ресурсах меньшего объема, которыми обычно являются ресурсы снабжения, а не мощные системы. Во время подготовки этих ресурсов решение может продолжать работать без прерывания. По завершении процесса подготовки копии элементов, составляющие решение, можно развернуть на этих дополнительных ресурсах и сделать их доступными. Когда спрос на ресурсы снижается, дополнительные ресурсы можно освободить, после того как работа использующих их элементов была завершена без ошибок. Многие облачные системы, включая Microsoft Azure, поддерживают автоматизацию масштабирования этого вида.

## Реализация стратегий автоматического масштабирования
Реализация стратегий автоматического масштабирования обычно включает в себя следующие компоненты и процессы:

- Системы инструментирования и мониторинга на уровне приложения, службы и инфраструктуры. Эти системы фиксируют такие ключевые метрики, как время ответа, длина очередей, использование ЦП и памяти.
- Логика принятия решений, которая помогает оценить отслеживаемые коэффициенты масштабирования относительно стандартных системных пороговых значений или расписаний, а также понять, нужно ли выполнять масштабирование.
- Компоненты, которые отвечают за выполнение задач, связанных с масштабированием системы (например, за подготовку или отмену подготовки ресурсов).
- Тестирование, мониторинг и настройка стратегии автоматического масштабирования, чтобы убедиться в том, что она работает ожидаемым образом.

В большинстве облачных сред, таких как Azure, есть встроенные механизмы автоматического масштабирования, которые подходят для распространенных сценариев. Если среда или служба, которую вы используете, не предоставляет необходимые функции автоматического масштабирования или имеющихся возможностей недостаточно для решения этой задачи, может потребоваться настраиваемая реализация. Используйте настраиваемую реализацию для сбора рабочих и системных метрик и их анализа, чтобы определить необходимые данные и выполнить последующее масштабирование ресурсов соответствующим образом.

## Рекомендации относительно реализации автоматического масштабирования
Автоматическое масштабирование не реализуется мгновенно. Простое добавление ресурсов в систему или ввод в эксплуатацию большего числа экземпляров процесса не гарантирует, что это приведет к повышению производительности системы. При разработке стратегии автоматического масштабирования необходимо учитывать следующее.

- Система должна поддерживать возможность горизонтального масштабирования. Избегайте делать предположения относительно определения экземпляра; не создавайте решения, которые требуют, чтобы код всегда выполнялся в конкретном экземпляре процесса. При масштабировании облачной службы или веб-сайта не следует предполагать, что последовательность запросов из одного и того же источника всегда будет направляться в один и тот же экземпляр. По этой же причине службы следует разрабатывать без сохранения состояния. Это позволит избежать того, чтобы серия запросов из приложения всегда направлялась в тот же экземпляр службы. При разработке службы, которая считывает сообщения из очереди и обрабатывает их, не делайте никаких предположений о том, какой экземпляр службы обрабатывает определенное сообщение. Функция автоматического масштабирования может запустить дополнительные экземпляры службы при увеличении длины очереди. В статье [Competing Consumers Pattern](http://msdn.microsoft.com/library/dn568101.aspx) (Шаблон конкурирующих потребителей) описывается, как обрабатывать этот сценарий.
- Если решение реализует длительно выполняемую задачу, то такую задачу следует создать так, чтобы она поддерживала как масштабирование наружу, так и масштабирование внутрь. Без соответствующей разработки такая задача может помешать аккуратному завершению работы экземпляра процесса при свертывании системы или привести к потере данных, если процесс принудительно завершен. В идеале для длительно выполняемой задачи следует выполнить рефакторинг и разбить процесс обработки, которую он выполняет, на отдельные фрагменты. В статье [Pipes and Filters Pattern](http://msdn.microsoft.com/library/dn568100.aspx) (Шаблон каналов и фильтров) представлен пример того, как этого можно добиться.

 Кроме того, можно реализовать механизм контрольных точек, который регулярно записывает сведения о состоянии задачи через определенные интервалы времени, а затем сохраняет это состояние в долговременном хранилище, доступ к которому может получить любой экземпляр процесса, выполняющего задачу. Таким образом, если процесс завершен, работу, которую он выполнял, можно возобновить с последней контрольной точки с помощью другого экземпляра.
- Когда фоновые задачи выполняются в отдельных вычислительных операциях, таких как рабочие роли облачных служб, в которых размещено приложение, может потребоваться масштабирование различных частей приложения с использованием различных политик масштабирования. Например, может потребоваться развернуть дополнительные вычислительные операции пользовательского интерфейса без увеличения числа фоновых экземпляров вычислительных операций или наоборот. Если предлагаются различные уровни обслуживания (например, пакеты служб Basic и Premium), может потребоваться масштабировать вычислительные ресурсы для пакетов служб Premium активнее, чем для пакета служб Basic, чтобы обеспечить соблюдение требований соглашения об уровне обслуживания.
- Рассмотрите возможность использования длины очереди, через которую взаимодействуют пользовательский интерфейс и фоновые вычислительные операции, в качестве ведущего критерия стратегии автоматического масштабирования. Это лучший показатель несоответствия или различия между текущей нагрузкой и производительностью обработки фоновой задачи.
- Если стратегия автоматического масштабирования основана на счетчиках, измеряющих бизнес-процессы (например, количество заказов, размещенных в час, или среднее время выполнения сложной транзакции), убедитесь в том, что вы полностью понимаете связь между результатами, получаемыми от этих типов счетчиков, и требованиями к фактической емкости вычислительных ресурсов. В ответ на изменения в данных, поступаемых от счетчиков бизнес-процессов, может потребоваться масштабировать несколько компонентов или единиц вычисления.  
- Чтобы предотвратить попытки системы выполнить чрезмерное масштабирование и избежать затрат, связанных с выполнением тысяч экземпляров, рекомендуется ограничить максимальное количество экземпляров, которые можно добавлять автоматически. Большинство механизмов автоматического масштабирования позволяют указать минимальное и максимальное число экземпляров для правила. Кроме того, рекомендуется корректно снизить функциональные возможности системы, если развернуто максимальное количество экземпляров, но система по-прежнему перегружена.
- Помните, что автоматическое масштабирование может оказаться не таким уж и полезным механизмом в случае внезапного резкого увеличения рабочей нагрузки. Для подготовки и запуска новых экземпляров службы или добавления ресурсов в систему требуется время, а к моменту, когда эти дополнительные ресурсы станут доступны, пик нагрузки может пройти. В этом случае лучше всего подходит регулирование службы. Дополнительные сведения см. в статье [Throttling Pattern](http://msdn.microsoft.com/library/dn589798.aspx) (Шаблон регулирования).
- И наоборот, если требуется вычислительная мощность для обработки всех запросов, когда объем изменяется достаточно быстро, а стоимость не является определяющим фактором, рассмотрите возможность использования стратегии агрессивного автоматического масштабирования, в рамках которой дополнительные экземпляры запускаются быстрее. Можно также использовать вариант применения запланированной политики, которая запускает достаточное количество экземпляров для обработки максимальной нагрузки до того, когда эта нагрузка ожидается.
- Механизм автоматического масштабирования должен контролировать процесс автоматического масштабирования и фиксировать подробные сведения о каждом событии (что стало причиной, какие ресурсы были добавлены или удалены и когда). При создании настраиваемого механизма автоматического масштабирования обязательно реализуйте в нем эту функциональную возможность. Полученные сведения можно проанализировать, чтобы измерить эффективность стратегии автоматического масштабирования и при необходимости адаптировать ее. Ее можно настроить как в краткосрочной перспективе, по мере того, как шаблоны использования становятся более очевидными, так и в долгосрочной перспективе, по мере расширения бизнеса или изменения требований приложения. Если приложение достигает верхнего предела, определенного для автоматического масштабирования, механизм может также оповестить оператора, который может при необходимости вручную запустить дополнительные ресурсы. Обратите внимание, что при этих обстоятельствах оператор также может отвечать за удаление этих ресурсов вручную после снижения рабочей нагрузки.

## Автоматическое масштабирование в решении Azure
Существует несколько вариантов настройки автоматического масштабирования для решений Azure.

- Функция **автоматического масштабирования Azure** поддерживает наиболее распространенные сценарии масштабирования по расписанию, а также дополнительно запущенные операции масштабирования на основе метрик среды выполнения (таких как загрузка процессора, длина очереди, а также данные, получаемые от встроенных и настраиваемых счетчиков). C помощью портала Azure можно быстро и легко настроить простые политики автоматического масштабирования для решения. Для более точного контроля можно использовать [REST API управления службами Azure](https://msdn.microsoft.com/library/azure/ee460799.aspx) или [REST API Azure Resource Manager](https://msdn.microsoft.com//library/azure/dn790568.aspx). [Библиотека управления служб мониторинга Azure](http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Monitoring) и [библиотека аналитики Microsoft](https://www.nuget.org/packages/Microsoft.Azure.Insights/) (в предварительной версии) представляют собой пакеты SDK, которые позволяют собирать показатели для различных ресурсов и выполнять автоматическое масштабирование, используя REST API. Для ресурсов, которые не поддерживают Azure Resource Manager, или при использовании облачных служб Azure для автоматического масштабирования можно воспользоваться REST API управления службами. Во всех остальных случаях для автоматического масштабирования рекомендуется применять Azure Resource Manager.
- В **пользовательском решении** на основе инструментария приложения можно использовать функции управления Azure. Например, можно применить диагностику Azure или другие методы инструментария в своем приложении вместе с пользовательским кодом для постоянного отслеживания и экспорта показателей приложения. Можно создать пользовательские правила, которые работают на этих метриках и используют REST API управления службами и Resource Manager для запуска автоматического масштабирования. Метриками для запуска операции масштабирования могут стать любые встроенные или пользовательские счетчики, а также другой инструментарий, реализованный в приложении. Однако пользовательское решение не так просто реализовать, и его следует рассматривать только в том случае, если ни один из предыдущих подходов вас не устраивает. Использование этого подхода описывается в статье [Autoscaling Application Block](http://msdn.microsoft.com/library/hh680892%28v=pandp.50%29.aspx) (Блок приложения автоматического масштабирования).
- **Сторонние службы**, такие как [Paraleap AzureWatch](http://www.paraleap.com/AzureWatch), позволяющие масштабировать решение на основе расписания, индикаторов производительности системы и загрузки служб, а также настраиваемых правил и сочетаний различных типов правил.

При выборе решения автоматического масштабирования, которое следует реализовать, следует учитывать следующие моменты.

- Используйте встроенные функции автоматического масштабирования платформы, если они отвечают вашим требованиям. Если нет, подумайте, действительно ли вам требуются более сложные функции масштабирования. Некоторые примеры дополнительных требований могут включать более тщательный контроль, различные способы обнаружения событий-триггеров для масштабирования, масштабирование в рамках подписок и масштабирование других типов ресурсов.
- Определите, есть ли у вас возможность прогнозировать нагрузку на приложение с достаточной точностью, чтобы реализовать исключительно запланированное автоматическое масштабирование (добавление и удаление экземпляров в соответствии с ожидаемыми периодами пиковой нагрузки). Когда это возможно, используйте реактивное автоматическое масштабирование на основе метрик, собранных во время выполнения приложения, для обработки непрогнозируемых изменений спроса. Но обычно мы советуем объединить эти подходы. Так, можно создать стратегию, которая добавляет ресурсы (например вычислительные или ресурсы хранения) и ставит их в очередь на основе расписания периодов времени, когда известно, что приложение наиболее загружено. Это позволяет гарантировать, что производительность доступна именно тогда, когда она нужна, и без задержки, возникающей при запуске новых экземпляров. Кроме того, для каждого запланированного правила следует определить метрики, которые позволяют использовать функции реактивного автоматического масштабирования в течение этого периода времени, чтобы гарантировать, что приложение может справляться с постоянными, но непредсказуемыми пиками нагрузки.
- Зачастую сложно понять связь между метриками и требованиями к мощности, особенно в случае, если приложение изначально развернуто. Предпочтительней обеспечить небольшой запас мощности в начале, а затем организовать наблюдение за правилами автоматического масштабирования и их настройку, чтобы приблизить имеющуюся емкость к реальной нагрузке.

### Использование автоматического масштабирования Azure
Автоматическое масштабирование позволяет настроить варианты развертывания и свертывания решения. Функция автоматического масштабирования может автоматически добавлять и удалять экземпляры веб-ролей и рабочих ролей облачных служб Azure, мобильных служб Azure и компонентов веб-приложений в службе приложений Azure. Автоматическое масштабирование можно также включить путем запуска и остановки экземпляров виртуальных машин Azure. Стратегия автоматического масштабирования Azure включает в себя два набора факторов:

- Автоматическое масштабирование на основе расписания, которое позволяет обеспечить доступность дополнительных экземпляров в ожидаемые периоды пиковой нагрузки, а также обеспечить масштабирование внутрь по прошествии периода пиковой нагрузки. Это позволяет обеспечить наличие достаточного количества уже запущенных экземпляров без ожидания реакции системы на повышение нагрузки.
- Автоматическое масштабирование на основе метрик, которое реагирует на такие показатели, как средняя загрузка ЦП за последний час или невыполненная работа в отношении сообщений, которые решение обрабатывает в службе хранилища или в очереди служебной шины Azure. Это позволяет приложению реагировать отдельно от правила запланированного автоматического масштабирования в соответствии с непредвиденными или незапланированными изменениями в нагрузке.

При использовании автоматического масштабирования придерживайтесь следующих рекомендаций.

- Стратегия автоматического масштабирования объединяет в себе масштабирование по расписанию и масштабирование на основе метрик. Можно указать оба типа правил для службы.
- Необходимо настроить правила автоматического масштабирования, а затем организовать отслеживание производительности приложения со временем. Используйте результаты такого отслеживания для настройки способа масштабирования системы при необходимости. Однако помните, что автоматическое масштабирование не выполняется мгновенно. Требуется время, чтобы среагировать на метрики, такие как средняя загрузка ЦП, превышающая указанное пороговое значение (или находящаяся ниже него).
- Правила автоматического масштабирования, использующие механизм обнаружения на основе измеренного атрибута триггера (например, загрузка ЦП или длина очереди), применяют агрегированное значение по времени, а не конкретное значение, чтобы запустить действие автоматического масштабирования. По умолчанию агрегированное значение — это среднее значение. Это позволяет предотвратить слишком быстрое реагирование системы или появление быстрых колебаний. При этом новым экземплярам, которые запускаются автоматически, также предоставляется время на переход в режим выполнения, что предотвращает выполнение дополнительных действий автоматического масштабирования в то время, когда происходит запуск новых экземпляров. Для облачных служб и виртуальных машин Azure период агрегирования по умолчанию составляет 45 минут, поэтому для запуска метрикой автоматического масштабирования в ответ на пиковую нагрузку может потребоваться как раз такое время. Можно изменить период агрегирования с помощью пакета SDK, однако имейте в виду, что если период длится менее 25 минут, это может привести к непредсказуемым результатам (дополнительные сведения см. в статье [Auto Scaling Cloud Services on CPU Percentage with the Azure Monitoring Services Management Library](http://rickrainey.com/2013/12/15/auto-scaling-cloud-services-on-cpu-percentage-with-the-windows-azure-monitoring-services-management-library/) (Автоматическое масштабирование облачных служб на основе загрузки ЦП с помощью библиотеки управления служб мониторинга Azure)). Для веб-приложений средний период намного меньше, благодаря чему новые экземпляры доступны приблизительно в течение пяти минут после изменения среднего показателя триггера.
- Если настроить автоматическое масштабирование с помощью пакета SDK, а не на веб-портале, можно указать более подробное расписание, во время которого активны правила. Можно также создать свои собственные метрики и использовать их как отдельно, так и в сочетании с любыми метриками, существующими в правилах автоматического масштабирования. Например, можно использовать альтернативные счетчики (числа запросов в секунду, объема доступной памяти и т. д.), либо настраиваемые счетчики, измеряющие определенные бизнес-процессы.
- При автоматическом масштабировании виртуальных машин Azure необходимо развернуть несколько экземпляров виртуальной машины, число которых равно максимальному значению, при котором разрешается запуск автоматического масштабирования. Эти экземпляры должны входить в одну и ту же группу доступности. Механизм автоматического масштабирования виртуальных машин не создает и не удаляет экземпляры виртуальной машины; вместо этого правила автоматического масштабирования, которые можно настроить, запускают и останавливают соответствующее количество этих экземпляров. Дополнительные сведения см. в статье [Автоматическое масштабирование приложения, выполняющего веб-роли, рабочие роли или виртуальные машины](./cloud-services/cloud-services-how-to-scale.md).
- Если не удается запустить новые экземпляры по причине возможного достижения максимального значения для подписки или из-за ошибки во время запуска, на портале может быть указано, что операция автоматического масштабирования успешно выполнена. Однако последующие события **ChangeDeploymentConfiguration**, отображаемые на портале, будут свидетельствовать только о запросе запуска службы.На портале будут отсутствовать события, указывающие на успешное завершение операции.
- Можно использовать пользовательский интерфейс веб-портала, чтобы связать ресурсы (такие как экземпляры базы данных SQL и очереди) с экземпляром службы вычислений. Это позволяет упростить доступ к отдельным вариантам конфигурации масштабирования вручную и автоматически для всех связанных ресурсов. Дополнительные сведения см. в разделе [Практическое руководство. Привязка ресурсов к облачной службе](cloud-services-how-to-manage.md#linkresources) и в статье [Автомасштабирование приложения](./cloud-services/cloud-services-how-to-scale.md).
- При настройке нескольких политик и правил существует вероятность, что они могут конфликтовать друг с другом. Функция автоматического масштабирования использует следующие правила разрешения конфликтов, чтобы гарантировать, что всегда будет достаточное количество экземпляров.
  - Операции масштабирования наружу всегда имеют приоритет над операциями масштабирования внутрь.
  - При возникновении конфликта операций масштабирования наружу приоритет имеет правило, которое инициирует наибольшее увеличение числа экземпляров.
  - При возникновении конфликта операций масштабирования внутрь приоритет имеет правило, которое инициирует наименьшее уменьшение числа экземпляров.

<a name="the-azure-monitoring-services-management-library"></a>


## Связанные шаблоны и рекомендации
При реализации автоматического масштабирования рекомендуется принять во внимание следующие шаблоны и рекомендации.

- [Шаблон регулирования.](http://msdn.microsoft.com/library/dn589798.aspx) Этот шаблон описывает, каким образом приложение может продолжить работать и обеспечивать выполнение требований соглашений об уровне обслуживания по мере увеличения нагрузки на ресурсы. Регулирование можно использовать совместно с автоматическим масштабированием для предотвращения перегрузки системы во время ее масштабирования наружу.
- [Шаблон конкурирующих потребителей.](http://msdn.microsoft.com/library/dn568101.aspx) Этот шаблон описывает то, как реализуется пул экземпляров службы, которые могут обрабатывать сообщения от любого экземпляра приложения. Автоматическое масштабирование можно использовать для запуска и остановки экземпляров службы в соответствии с ожидаемой рабочей нагрузкой. Такой подход позволяет обрабатывать несколько сообщений одновременно, чтобы оптимизировать пропускную способность для повышения масштабируемости и доступности, а также для распределения рабочей нагрузки в системе.
- [Руководство по инструментированию и телеметрии.](http://msdn.microsoft.com/library/dn589775.aspx) Инструментирование и телеметрия очень важны для сбора информации, которая требуется в процессе автоматического масштабирования.

## Дополнительные сведения
- [Масштабирование приложения](./cloud-services/cloud-services-how-to-scale.md)
- [Автоматическое масштабирование приложения, выполняющего веб-роли, рабочие роли или виртуальные машины](cloud-services-how-to-manage.md#linkresources)
- [Практическое руководство. Привязка ресурсов к облачной службе](cloud-services-how-to-manage.md#linkresources)
- [Масштабирование связанных ресурсов](./cloud-services/cloud-services-how-to-scale.md#scale-link-resources)
- [Библиотека управления служб мониторинга Azure](http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Monitoring)
- [Интерфейс API REST управления службой Azure](http://msdn.microsoft.com/library/azure/ee460799.aspx)
- [API REST диспетчера ресурсов Azure](https://msdn.microsoft.com/library/azure/dn790568.aspx)
- [Библиотека аналитики Microsoft](https://www.nuget.org/packages/Microsoft.Azure.Insights/)
- [Операции автоматического масштабирования](http://msdn.microsoft.com/library/azure/dn510374.aspx)
- [Пространство имен Microsoft.WindowsAzure.Management.Monitoring.Autoscale](http://msdn.microsoft.com/library/azure/microsoft.windowsazure.management.monitoring.autoscale.aspx)

<!----HONumber=AcomDC_0330_2016-->