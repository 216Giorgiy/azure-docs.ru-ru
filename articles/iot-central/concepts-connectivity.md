---
title: Подключение устройства в Azure IoT Central | Документация Майкрософт
description: В этой статье описаны ключевые понятия, связанные с подключением устройства в Azure IoT Central.
author: dominicbetts
ms.author: dobett
ms.date: 11/30/2017
ms.topic: conceptual
ms.service: iot-central
services: iot-central
manager: timlt
ms.openlocfilehash: ae57fc5366e1ed99febcd9a9d08e7f95f3bbf196
ms.sourcegitcommit: 5978d82c619762ac05b19668379a37a40ba5755b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2019
ms.locfileid: "55487359"
---
# <a name="device-connectivity-in-azure-iot-central"></a>Подключение устройства в Azure IoT Central

В этой статье описаны ключевые понятия, связанные с подключением устройства в Microsoft Azure IoT Central.

Azure IoT Central использует [Службу подготовки устройств (DPS) к добавлению в центр Интернета вещей Azure](https://docs.microsoft.com/azure/iot-dps/about-iot-dps), поэтому IoT Central поддерживает подключение устройств в нужном масштабе.

-   Теперь клиенты могут создавать учетные данные устройства и настраивать устройства в автономном режиме, и им не нужно сначала регистрировать устройства в IoT Central
-   IoT Central поддерживает подключение устройства по рекомендованному отраслевому стандарту X509 на основе сертификатов, а также продолжает поддерживать и оптимизировать подключения с подписанным URL-адресом (SAS).
-   Клиенты IoT Central теперь могут регистрировать в IoT Central собственные устройства по идентификатору и без лишних усилий интегрировать их в существующие корпоративные системы.
-   Существует единая процедура подключения устройств к IoT Central 

>[!NOTE]
>IoT Central использует службы подготовки устройств (DPS) в Azure под всеми регистрациями и подключениями устройства. [Дополнительные сведения о DPS](https://docs.microsoft.com/azure/iot-dps/about-iot-dps).

Следуйте инструкциям по подключению устройств к IoT Central в зависимости от варианта использования
1. [Быстрое подключение одного устройства (с помощью подписанного URL-адреса)](#connect-a-single-device)
1. [Подключение устройств в нужном масштабе с помощью подписанного URL-адреса (SAS)](#connect-devices-at-scale-using-shared-access-signatures)
1. [Подключение устройств в нужном масштабе с помощью сертификатов X509](#connect-devices-using-x509-certificates) **рекомендуется для производственных рабочих нагрузок**
1. [Подключение без предварительной регистрации устройства](#connect-without-first-registering-devices) 


>[!NOTE]
>Глобальная конечная точка для подключения и подготовки устройств: **global.azure-devices-provisioning.net**.

## <a name="connect-a-single-device"></a>Подключение одного устройства
Подключить одно устройство к IoT Central с помощью SAS очень просто. Достаточно выполнить всего несколько действий. 
1. Добавьте **реальное устройство** из Device Explorer — нажмите **+ Создать > Реальное**, чтобы добавить реальное устройство.
    * Введите идентификатор устройства **<span style="color:Red">(должен состоять из символов нижнего регистра)</span>** или используйте предложенный идентификатор устройства.
    * Введите имя устройства или используйте предложенное имя   
    ![Add Device (Добавление устройства)](media/concepts-connectivity/add-device.png)
1. Получите сведения о подключении, например **идентификатор области, идентификатор устройства и первичный ключ**, для добавленного устройства, нажав кнопку **Подключить** на странице устройства.
    * **[Идентификатор области](https://docs.microsoft.com/azure/iot-dps/concepts-device#id-scope)** предоставляется для каждого приложения IoT Central и создается DPS, чтобы обеспечить уникальный идентификатор устройства в приложении.
    * **Идентификатор устройства** — это уникальный идентификатор устройства в приложении. Устройство отправляет свой идентификатор при регистрации.   
    * **Первичный ключ** является маркером SAS, созданным IoT Central для конкретного устройства. 
    ![Сведения о подключении](media/concepts-connectivity/device-connect.PNG)
1. Используйте эти сведения о подключении **удостоверение устройства, имя устройства и первичный ключ устройства** в коде устройства, чтобы подготовить и подключить устройство и сразу приступить к просмотру потока данных. Если вы используете устройство MxChip, следуйте [пошаговым инструкциям](howto-connect-devkit.md#add-a-real-device) — начните с раздела **Подготовка устройства DevKit**.   

    Ниже приведены ссылки для других языков, которые можно использовать.

    *   **Язык C**. Если вы используете C, выполните [этот пример клиента устройства на C](https://github.com/Azure/azure-iot-sdk-c/blob/master/provisioning_client/devdoc/using_provisioning_client.md) для подключения тестового устройства. Используйте в примере следующие параметры.   

         ```c
         hsm_type = SECURE_DEVICE_TYPE_SYMMETRIC_KEY;

         ## Enter the Device Id and Symmetric keys 
         prov_dev_set_symmetric_key_info("<Device Id>", "<Enter Primary Symmetric key here>");
        ```

    *   **Node.JS**.  Если вы намерены использовать Node.js, следуйте [этим пошаговым инструкциям](tutorial-add-device.md#prepare-the-client-code), начиная с раздела **Подготовка клиентского кода**.



## <a name="connect-devices-at-scale-using-shared-access-signatures"></a>Подключение устройств в нужном масштабе с помощью подписанного URL-адреса

Чтобы подключить любое количество устройств к IoT Central с помощью SAS, выполните два действия. 
1. **Зарегистрируйте устройства**, импортировав их в IoT Central через CSV-файл, и экспортируйте устройства со сведениями о подключении устройств для подключения ваших устройств
1. **Настройте устройство**. Устройство программируется на основе сведений о подключении (**идентификатор области, идентификатор устройства и первичный ключ**). При включении устройство вызывает службу подготовки для получения сведений о подключении и назначении приложения IoT Central.

>[!NOTE]
>Доступен расширенный вариант, когда вы подключаете устройства без предварительной регистрации в IoT Central. [Дополнительные сведения](https://docs.microsoft.com/azure/iot-dps/about-iot-dps).

**Регистрация устройств**

Для подключения к приложению большого количества устройств Azure IoT Central предоставляет функцию массового импорта устройств с помощью CSV-файла. 

Требования к файлу CSV: Файл CSV должен содержать следующие столбцы (и заголовки)
1.  IOTC_DeviceID **<span style="color:Red">(должен состоять из символов нижнего регистра)</span>**
1.  IOTC_DeviceName (необязательно)



Импорт устройств для их регистрации в приложении
1.  В меню навигации слева щелкните **Explorer**.
1.  На левой панели выберите шаблон устройства, для которого требуется выполнить массовое создание устройств. 
1.  Нажмите **Импорт**, выберите CSV-файл, содержащий список идентификаторов устройств, которые нужно импортировать.
Файл CSV должен содержать следующие столбцы (и заголовки)
    *   IOTC_DeviceID **<span style="color:Red">(должен состоять из символов нижнего регистра)</span>**
    *   IOTC_DeviceName (необязательно)
1.  После завершения импорта в сетке устройств отображается сообщение об успешном выполнении.

Экспортируйте устройства, чтобы получить сведения о подключении. При экспорте создается CSV-файл с идентификатором устройства, именем устройства и ключом устройства. Используйте эти сведения, чтобы подключить устройство к IoT Central.
Чтобы выполнить массовый экспорт устройств из приложения, сделайте следующее:
1.  В меню навигации слева щелкните **Explorer**.
1.  Выберите устройства, которые требуется экспортировать, а затем щелкните действие **Экспорт**.
1.  После завершения экспорта отобразится сообщение об успешном выполнении и ссылка для скачивания созданного файла.
1.  Щелкните сообщение об успешном выполнении, чтобы скачать файл в локальную папку на диске.
1.  В экспортированном CSV-файле будут содержаться столбцы со следующей информацией: **идентификатор устройства, имя устройства, первичный или вторичный ключи устройства и первичный или вторичный отпечатки сертификатов**.
    *   IOTC_DEVICEID
    *   IOTC_DEVICENAME
    *   IOTC_SASKEY_PRIMARY
    *   IOTC_SASKEY_SECONDARY
    *   IOTC_X509THUMBPRINT_PRIMARY 
    *   IOTC_X509THUMBPRINT_SECONDARY


**Настройка устройства**

Используйте эти сведения о подключении **удостоверение устройства (IOTC_DEVICEID), первичный ключ устройства (IOTC_SASKEY_PRIMARY) и идентификатора области** в коде устройства для подготовки и подключения устройства. Если вы еще этого не сделали, получите **идентификатор области** из приложения IoT Central: **Администрирование > Подключение устройства > Идентификатор области**.
Если вы используете устройство **MxChip**, следуйте [пошаговым инструкциям](howto-connect-devkit.md#add-a-real-device) — начните с раздела **Подготовка устройства DevKit**.   

Ниже приведены ссылки для других языков, которые можно использовать.

   *   **Язык C**. Если вы используете C, выполните [этот пример клиента устройства на C](https://github.com/Azure/azure-iot-sdk-c/blob/master/provisioning_client/devdoc/using_provisioning_client.md) для подключения тестового устройства. Используйте в примере следующие параметры.   
         ```c
         hsm_type = SECURE_DEVICE_TYPE_SYMMETRIC_KEY;

         ## Enter the Device Id and Symmetric keys 
         prov_dev_set_symmetric_key_info("<Device Id>", "<Enter Primary Symmetric key here>");
        ```
    * **Node.JS**.  Если вы намерены использовать Node.js, следуйте [этим пошаговым инструкциям](tutorial-add-device.md#prepare-the-client-code), начиная с раздела **Подготовка клиентского кода**.


## <a name="connect-devices-using-x509-certificates"></a>Подключение устройств с помощью сертификатов X509

Применение сертификатов X.509 в качестве механизма аттестации позволяет легко масштабировать **производство** и упростить подготовку устройств к работе. Сертификаты X.509 обычно организуются в цепочки доверия, в которых каждый сертификат подписан закрытым ключом от сертификата следующего уровня. На самом верху цепочки расположен самозаверяющий корневой сертификат. Такая цепочка создает систему делегированного доверия от корневого сертификата, созданного доверенным корневым центром сертификации (ЦС), через все промежуточные ЦС вплоть до сертификата конечного объекта, установленного на устройстве. Дополнительные сведения см. в статье [Device Authentication using X.509 CA Certificates](https://docs.microsoft.com/azure/iot-hub/iot-hub-x509ca-overview) (Аутентификация устройств с помощью сертификатов ЦС X.509). 

Чтобы подключить устройство к IoT Central с помощью сертификатов X509, выполните три действия. 
1. **Настройте параметры подключения** в приложении IoT Central путем добавления/проверки корневого или промежуточного сертификата X509, используемого для создания сертификатов устройства.  Выполните два действия для настройки параметров подключения для сертификатов X509.  

    *   **Добавление корневого или промежуточного сертификата X509**, который вы используете для создания сертификатов конечного устройства. Перейдите в раздел "Администрирование > Подключение устройства > Сертификаты". 
    
        ![Параметры подключения](media/concepts-connectivity/connection-settings.PNG)
    *   **Проверка сертификата**. Проверка владельца сертификата подтверждает, что отправитель сертификата действительно является владельцем закрытого ключа этого сертификата. Проверка сертификата
        *  Создайте код проверки — нажмите кнопку рядом с полем "Код проверки", чтобы создать код проверки. 
        *  Создайте сертификат проверки X.509 с кодом проверки, сохраните сертификат как CER-файл. 
        *  Загрузите подписанный сертификат проверки и нажмите "Проверить".

        ![Параметры подключения](media/concepts-connectivity/verify-cert.png)
    *   **Вторичный сертификат**. В течение жизненного цикла вашего решения Центра Интернета вещей вам нужно будет развертывать сертификаты. В основном это необходимо делать по двум причинам: бреши в системе безопасности и истечение срока действия сертификата. Дополнительные сертификаты позволяют сократить время простоя при подготовке устройств, пока вы обновляете основной сертификат.

    **ТОЛЬКО В ЦЕЛЯХ ТЕСТИРОВАНИЯ** 
    
    Ниже приведены некоторые средства командной строки, которые можно использовать для создания сертификатов ЦС и сертификатов устройств.

    * Если вы используете MxChip, это [средство командной строки](https://aka.ms/iotcentral-docs-dicetool) подходит для создания сертификатов ЦС — добавьте его в приложение IoT Central и проверяйте сертификаты. 

    *   Используйте это [средство командной строки](https://github.com/Azure/azure-iot-sdk-c/blob/master/tools/CACertificates/CACertificateOverview.md ), чтобы
        * Создать цепочку сертификатов (выполните шаг 2 в документации GitHub). 
         Сохранить сертификаты как CER-файлы и отправить в IoT Central (основной).   
        * Получить код проверки из приложения IoT Central, создать сертификат (выполните шаг 3 в документации GitHub) и отправить для проверки. 
        * Создать конечные сертификаты с помощью идентификатора устройства в качестве параметра для средства (выполните шаг 4). Сохранить сертификат и использовать его на устройстве.     

1. **Зарегистрируйте устройства**, импортировав их в IoT Central с помощью CSV-файла.

1. **Настройка устройства**. Создайте конечные сертификаты, используя переданный корневой сертификат. Убедитесь, что используете **идентификатор устройства** как CNAME в конечных сертификатах и он состоит только из символов **нижнего регистра**. Вот [средство командной строки](https://github.com/Azure/azure-iot-sdk-c/blob/master/tools/CACertificates/CACertificateOverview.md ) для создания конечных сертификатов/сертификатов устройства **ТОЛЬКО В ЦЕЛЯХ ТЕСТИРОВАНИЯ**.

    Запрограммируйте устройство с помощью сведений службы подготовки, включив получение сведений о соединении и назначении приложения IoT Central при включении устройства.    

    **Дополнительные ссылки** 
    *   Пример реализации для [RaspberryPi.](https://aka.ms/iotcentral-docs-Raspi-releases)  

    *   [Пример клиента устройства на языке C.](https://github.com/Azure/azure-iot-sdk-c/blob/dps_symm_key/provisioning_client/devdoc/using_provisioning_client.md)

>[!NOTE]
>Используйте **идентификатор устройства** как CNAME при создании конечных сертификатов для устройств.

>[!NOTE]
>**Идентификатор устройства** должен состоять из символов нижнего регистра 
 
## <a name="connect-without-first-registering-devices"></a>Подключение без предварительной регистрации устройства
Один из основных сценариев IoT Central позволяет изготовителям оборудования массово производить устройства, создавать учетные данные и настраивать их на фабрике, чтобы устройства не пришлось регистрировать в IoT Central. Когда вы включите устройство и подключите его к IoT Central, оператор разрешает устройству подключиться к приложению IoT Central.

Ниже приведен поток для подключения устройств с помощью этой функции

![Параметры подключения](media/concepts-connectivity/device-connection-flow.PNG)


Выполните действия в зависимости от выбранной схемы проверки подлинности устройства (X509/SAS)

1. **Параметры подключения** 
    * **Сертификаты X509**. [Добавьте и проверьте корневой или промежуточный сертификат](#connect-devices-using-x509-certificates) и используйте его для создания сертификатов устройств на следующем шаге.
    * **SAS**. Скопируйте первичный ключ (который является ключом группы SAS для этого приложения IoT Central) и используйте его для создания ключей SAS устройства на следующем шаге. 
![Параметры подключения SAS](media/concepts-connectivity/connection-settings-sas.png)

1. **Создайте учетные данные устройств** 
    *   **Сертификаты (X.509)**. Создайте конечные сертификаты для устройств с помощью корневого или промежуточного сертификата, добавленного в это приложение. Убедитесь, что используете **идентификатор устройства** как CNAME в конечных сертификатах и он состоит только из символов **<span style="color:Red">нижнего регистра</span>**. Вот [средство командной строки](https://github.com/Azure/azure-iot-sdk-c/blob/master/tools/CACertificates/CACertificateOverview.md ) для создания конечных сертификатов/сертификатов устройства для тестирования.
    *   **SAS**: ключи SAS для устройства создаются с помощью этого [средства командной строки](https://www.npmjs.com/package/dps-keygen). Используйте первичный ключ SAS (ключ SAS группы) из предыдущего шага. Убедитесь, что идентификатор устройства состоит из символов **<span style="color:Red">нижнего регистра</span>**.

        Выполните следующие инструкции, чтобы создать ключ SAS для устройства           

        ```
        npm i -g dps-keygen
        ```
    
        **Использование**
                        
        ```
        dps-keygen <Primary_Key(GroupSAS)> <device_id>
        ```

1. **Настройка устройства** 
    
     Передайте на устройство **идентификатор области, идентификатор устройства, сертификат/ключ SAS устройства** и включите устройство для подключения к приложению IoT Central.

1. **Подключение устройства к IoT Central**. После включения устройство подключается к DPS или IoT Central для регистрации.

1. **Связывание устройства с шаблоном.** Подключенное устройство появится в узле **Несвязанные устройства** в **Device Explorer**. Состояние подготовки устройства — **Зарегистрировано**. **Привяжите** устройство к подходящему шаблону устройства и разрешите устройству подключаться к приложению IoT Central. Устройство получает сведения о подключении для приложения IoT Central, подключается и начинает отправку данных. Подготовка устройства завершена, *состояние подготовки* меняется на **Подготовлено**.

## <a name="device-provisioning-status"></a>Состояние подготовки устройств
При подключении реального устройства к Azure IoT Central необходимо выполнить ряд действий 
1. **Зарегистрировано**. Первым делом устройство **регистрируется**, то есть создается в IoT Central и получает идентификатор устройства.
Устройство зарегистрировано в таких случаях:  
    *   Новое реальное устройство добавлено в **Explorer**.
    *   Добавлен набор устройств с помощью **импорта** в **Explorer**.
    *   Устройство, которое не было зарегистрировано, но подключается с действительными учетными данными и отображается в группе **несвязанных** устройств. 

    Во всех указанных случаях *Состояние подготовки* — **Зарегистрировано**

1. **Подготовлено**. На следующем шаге устройство подключается с действительными учетными данными, а IoT Central выполняет этап подготовки (создает устройство в центре Интернета вещей). На устройство возвращается строка подключения, чтобы оно подключилось и приступило к отправке данных. *Состояние подготовки* меняется с **Зарегистрировано** на **Подготовлено**.

1.  **Заблокировано**. Оператор может заблокировать устройство. Заблокированное устройство не может отправлять данные в IoT Central, пока не будет сброшено. Заблокированные устройства имеют *Состояние подготовки* **Заблокировано**. Оператор может разблокировать устройство. После разблокировки устройства *Состояние подготовки* снова меняется на предыдущее *Состояние подготовки* ("Зарегистрировано" или "Подготовлено"). 

## <a name="getting-device-connection-string"></a>Получение строки подключения устройства
Вы можете получить строку подключения устройства к центру Интернета вещей, выполнив следующие действия. 
1. Получите сведения о подключении, например **идентификатор области, идентификатор устройства и первичный ключ** со страницы устройства (перейдите на страницу устройства и нажмите "Подключить"). 

    ![Сведения о подключении](media/concepts-connectivity/device-connect.PNG)

1. Получите строку подключения устройства с помощью указанной ниже программы командной строки.
    Следуйте инструкциям, чтобы получить строку подключения устройства  

    ```cmd/sh
    npm i -g dps-keygen
    ```
    **Использование**

    Чтобы создать строку подключения, найдите двоичный файл в папке bin/
    ```cmd/sh
    dps_cstr <scope_id> <device_id> <Primary Key(for device)>
    ```
    Узнайте больше о [dps-keygen tool here.](https://www.npmjs.com/package/dps-keygen)

## <a name="sdk-support"></a>Поддержка пакетов SDK

Пакеты SDK для устройств Azure предлагают самый простой способ реализации кода на устройствах, подключаемых к приложению Azure IoT Central. Доступны следующие пакеты SDK для устройств:

- [Пакет SDK для Azure IoT для C](https://github.com/azure/azure-iot-sdk-c).
- [Пакет SDK для Azure IoT для Python](https://github.com/azure/azure-iot-sdk-python).
- [Пакет SDK для Azure IoT для Node.js](https://github.com/azure/azure-iot-sdk-node).
- [Пакет SDK для Azure IoT для Java](https://github.com/azure/azure-iot-sdk-java).
- [Пакет SDK для Azure IoT для .NET](https://github.com/azure/azure-iot-sdk-csharp).

Каждое устройство подключается с помощью уникальной строки подключения, идентифицирующей устройство. Устройство может подключаться только к тому Центру Интернета вещей, в котором оно зарегистрировано. При создании реального устройства в приложении Azure IoT Central приложение создает строку подключения для использования.

## <a name="sdk-features-and-iot-hub-connectivity"></a>Функции пакета SDK и возможность подключения Центра Интернета вещей

Для всего обмена данными устройства с Центром Интернета вещей используются следующие варианты подключения Центра Интернета вещей:

- [передача сообщений с устройства в облако](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-messages-d2c);
- [Двойники устройств](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-device-twins)

В следующей таблице содержатся сведения о том, каким образом возможности устройства Azure IoT Central сопоставляются с возможностями Центра Интернета вещей.

| Azure IoT Central | Центр Интернета вещей Azure |
| ----------- | ------- |
| Измерения Телеметрия | Передача сообщений с устройства в облако |
| Свойства устройства | Сообщаемые свойства двойника устройства |
| Параметры | Требуемые и передаваемые свойства двойника устройства |

Чтобы узнать больше об использовании пакетов SDK для устройств, см. пример кода в одной из следующих статей:

- [Подключение универсального клиентского приложения к приложению Azure IoT Central (Node.js)](howto-connect-nodejs.md)
- [Подключение Raspberry Pi к приложению Azure IoT Central (Python)](howto-connect-raspberry-pi-python.md)
- [Подключение устройства MXChip IoT DevKit к приложению Azure IoT Central](howto-connect-devkit.md)


## <a name="protocols"></a>Протоколы

Пакеты SDK для устройства поддерживают следующие сетевые протоколы для подключения к Центру Интернета вещей.

- MQTT
- AMQP
- HTTPS

Дополнительные сведения об этих разных протоколах и рекомендации по их выбору см. в статье [Справочник — выбор протокола связи](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-protocols).

Если ваше устройство не может использовать любой из поддерживаемых протоколов, вы можете использовать Azure IoT Edge для преобразования протокола. IoT Edge поддерживает другие сценарии интеллектуальной обработки на пограничном устройстве, позволяющие снизить нагрузку на пограничное устройство из приложения Azure IoT Central.

## <a name="security"></a>Безопасность

Все данные, передаваемые между устройствами и Azure IoT Central, зашифрованы. Центр Интернета вещей выполняет проверку подлинности каждого запроса с устройства, которое подключается к любой конечной точке Центра Интернета вещей, обращенной к устройству. Чтобы избежать обмена учетными данными по сети, для проверки подлинности устройство использует подписанные маркеры. Дополнительные сведения см. в статье [Управление доступом к Центру Интернета вещей](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-security).

> [!NOTE]
> Сейчас устройства, подключающиеся к Azure IoT Central, должны использовать маркеры SAS. Использование сертификатов X.509 не поддерживается.

## <a name="next-steps"></a>Дополнительная информация

После изучения возможности подключения устройств в Azure IoT Central вы можете перейти к следующим шагам:

- [Подготовка и подключение устройства DevKit](howto-connect-devkit.md)
- [Подготовка и подключение Raspberry Pi](howto-connect-raspberry-pi-python.md)
- [Подключение универсального клиентского приложения к приложению Azure IoT Central (Node.js)](howto-connect-nodejs.md)
