---
title: Изучение клиентской библиотеки JavaScript для службы "Аналитика временных рядов Azure"
description: Сведения о клиентской библиотеке JavaScript для службы "Аналитика временных рядов Azure" и соответствующей модели программирования.
documentationcenter: ''
services: time-series-insights
author: BryanLa
manager: timlt
editor: ''
tags: ''
ms.assetid: ''
ms.service: time-series-insights
ms.workload: na
ms.tgt_pltfrm: ''
ms.devlang: na
ms.topic: tutorial
ms.date: 05/10/2018
ms.author: bryanla
ms.openlocfilehash: 5b845f36dbb65b38d0e4ac2a118277027239b3d6
ms.sourcegitcommit: d78bcecd983ca2a7473fff23371c8cfed0d89627
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2018
---
# <a name="tutorial-explore-the-time-series-insights-javascript-client-library"></a>Руководство по изучению клиентской библиотеки JavaScript для службы "Аналитика временных рядов Azure"

Чтобы помочь разработчикам запрашивать и визуализировать данные, хранящиеся в службе "Аналитика временных рядов Azure" (TSI), мы разработали библиотеку управления на основе JavaScript D3, которая упрощает эти задачи. В этом руководстве вы сможете изучить клиентскую библиотеку TSI JavaScript и соответствующую модель программирования, используя пример веб-приложения. 

Рассматриваемые здесь разделы предоставляют вам возможность поэкспериментировать и получить более глубокое представление о том, как обращаться к данным TSI и использовать элементы управления диаграммой для обработки и визуализации данных. Здесь вы получите достаточно сведений, чтобы использовать библиотеку в собственном веб-приложении.

В этом руководстве вы рассмотрите следующее:

> [!div class="checklist"]
> * пример приложения TSI; 
> * клиентскую библиотеку TSI JavaScript;
> * как пример приложения использует библиотеку для визуализации данных TSI.

## <a name="prerequisites"></a>предварительным требованиям

В этом руководстве используется функция "Средства для разработчиков" (также известная как DevTools или F12), которая доступна в большинстве современных веб-браузеров, таких как [Edge](/microsoft-edge/devtools-guide), [Chrome](https://developers.google.com/web/tools/chrome-devtools/), [FireFox](https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_are_browser_developer_tools), [Safari](https://developer.apple.com/safari/tools/) и другие. Если вы еще не знакомы с ней, вы можете изучить эту функцию в своем браузере, прежде чем продолжить. 

## <a name="the-time-series-insights-sample-application"></a>Пример приложения TSI

В этом руководстве пример приложения TSI приведен для изучения исходного кода приложения, включая использование клиентской библиотеки TSI JavaScript. Мы рассмотрим одностраничное веб-приложение (SPA), демонстрирующее использование библиотеки для запросов и визуализации данных из примера среды TSI. 

1. Перейдите к примеру приложения [TSI](https://insights.timeseries.azure.com/clientsample). Вы увидите страницу, похожую на приведенную ниже, с запросом на вход в систему: ![Запрос входа в систему клиента TSI](media/tutorial-explore-js-client-lib/tcs-sign-in.png)

2. Нажмите кнопку "Вход" и введите или выберите свои учетные данные. Вы можете использовать учетную запись предприятия или организации (Azure Active Directory) либо личную учетную запись (учетная запись Майкрософт или MSA). 

   ![Запрос учетных данных клиента TSI](media/tutorial-explore-js-client-lib/tcs-sign-in-enter-account.png)

3. После регистрации вы увидите страницу, похожую на следующую, содержащую несколько примеров диаграмм разных стилей с данными TSI. Также обратите внимание на свою учетную запись пользователя и ссылку для выхода из системы в правом верхнем углу: ![Главная страница клиента TSI после входа в систему](media/tutorial-explore-js-client-lib/tcs-main-after-signin.png)

### <a name="page-source-and-structure"></a>Исходный код страницы и ее структура

Сначала давайте рассмотрим исходный код HTML и JavaScript страницы, отображаемой в вашем браузере. Мы не рассмотрим все элементы, а только основные разделы, которые дадут вам представление о том, как работает страница:

1. Откройте средства для разработчиков в браузере и просмотрите элементы HTML, из которых состоит текущая страница, также известные как дерево HTML или DOM.

2. Разверните элементы `<head>` и `<body>` и обратите внимание на следующие разделы:
   - В разделе `<head>` вы найдете вспомогательные элементы, которые извлекают дополнительные файлы:
     - Элемент `<script>` для ссылки на библиотеку аутентификации Azure Active Directory (adal.min.js), также известную как ADAL. Это библиотека JavaScript, которая обеспечивает аутентификацию OAuth 2.0 (вход) и получение маркеров для доступа к API.
     - Элементы `<link>` для таблиц стилей (sampleStyles.css, tsiclient.css), также известные как CSS. Они используются для управления визуальными деталями оформления страниц, такими как цвета, шрифты, интервал и т. д. 
     - Элемент `<script>` для ссылки на клиенсткую библиотеку TSI (tsiclient.js) — библиотеку JavaScript, используемую страницей для вызова API-интерфейсов службы TSI и отображения элементов управления диаграммой на странице.

     >[!NOTE]
     > Исходный код библиотеки ADAL JavaScript можно найти в репозитории [azure-activedirectory-library-for-js](https://github.com/AzureAD/azure-activedirectory-library-for-js).  
     > Исходный код библиотеки клиента JavaScript TSI доступен в репозитории [tsiclient](https://github.com/Microsoft/tsiclient).

   - В разделе `<body>` вы найдете элементы `<div>`, которые действуют как контейнеры для определения макета элементов на странице, и другой элемент `<script>`:
     - Первый элемент `<div>` указывает диалоговое окно входа (`id="loginModal"`).
     - Второй элемент `<div>` выступает в качестве родительского для:
       - заголовка `<div>`, используемого для сообщений о состоянии и сведений о входе в верхней части страницы (`class="header"`);
       - элемента `<div>` для остальных элементов текста страницы, включая все диаграммы (`class="chartsWrapper"`);
       - раздела `<script>`, который содержит весь код JavaScript, используемый для управления страницей.

   [![Пример клиента TSI с DevTools](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-head-body.png)](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-head-body.png#lightbox)

3. Разверните элемент `<div class="chartsWrapper">`, и вы найдете много дочерних элементов `<div>`, используемых для размещения каждого примера элемента управления диаграммой. Обратите внимание, что существует несколько пар элементов `<div>`, по одному для каждого примера диаграммы:
   - Первый элемент (`class="rowOfCardsTitle"`) содержит описательное название содержимого, отображаемого на диаграмме. Например, "Статические графики с полноразмерными условными обозначениями".
   - Второй элемент (`class="rowOfCards"`) является родительским и содержит дополнительные дочерние элементы `<div>`, которые позиционируют фактический элемент управления диаграммой в строке. 

  ![Просмотр текста элементов div](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-body-divs.png)

4. Теперь разверните элемент `<script type="text/javascript">` непосредственно под элементом `<div class="chartsWrapper">`. Вы увидите начало раздела JavaScript на уровне страницы, используемого для обработки всей логики страницы, включая аутентификацию, вызов API-интерфейсов TSI, рендеринг элементов управления диаграммой и многое другое:

  ![Просмотр текста скрипта](media/tutorial-explore-js-client-lib/tcs-devtools-callouts-body-script.png)

## <a name="tsi-client-javascript-library-concepts"></a>Концепции библиотеки клиента JavaScript TSI

Хотя мы не рассматриваем ее подробно, по своей сути клиентская библиотека TSI (tsclient.js) обеспечивает абстракцию для двух важных категорий:

- **Методы программы-оболочки для вызова API-интерфейсов для запросов TSI**. REST API, которые позволяют запрашивать данные TSI с использованием статистических выражений и организованы в пространстве имен `TsiClient.Server` библиотеки. 
- **Методы создания и заполнения нескольких типов элементов управления диаграммами**. Используются для отображения агрегированных данных TSI на веб-странице и организованы в пространстве имен `TsiClient.UX` библиотеки. 

Следующие концепции универсальны и применимы к API-интерфейсам клиентской библиотеки TSI в целом. 

### <a name="authentication"></a>Authentication

Как упоминалось ранее, этот пример является одностраничным приложением, в котором используется поддержка OAuth 2.0 в ADAL для аутентификации пользователей. Вот некоторые важные моменты в этом разделе скрипта:

1. Для использования ADAL для аутентификации требуется, чтобы клиентское приложение регистрировалось в реестре приложений Azure Active Directory (Azure AD). Это одностраничное приложение зарегистрировано для использования "неявного" потока предоставления авторизации OAuth 2.0. Соответственно, приложение определяет некоторые свойства регистрации во время выполнения, такие как идентификатор GUID клиента (`clientId`) и URI перенаправления (`postLogoutRedirectUri`), и передает их в поток.

2. Позже приложение запрашивает маркер доступа от Azure AD. Маркер доступа выдается для конечного набора разрешений идентификатору определенной службы или API (https://insights.timeseries.azure.com), также известным как аудитория маркера. Разрешения для маркеров выдаются от имени пользователя, выполнившего вход в систему. Идентификатором службы или API является еще одно свойство, содержащееся в данных регистрации Azure AD приложения. Когда ADAL возвращает маркер доступа приложению, он передается как маркер носителя при доступе к API-интерфейсам TSI. 

   [!code-javascript[head-sample](~/samples-javascript/pages/index.html?range=140-199&highlight=4-9,36-39)]

### <a name="control-identification"></a>Идентификация элементов управления

Как обсуждалось ранее, элементы `<div>` в `<body>` обеспечивают компоновку всех элементов управления диаграммой, представленных на странице. Каждый из них определяет свойства для размещения и визуальные атрибуты элемента управления диаграммой, включая свойство `id`. Свойство `id` предоставляет уникальный идентификатор, который используется в коде JavaScript для идентификации и привязки к каждому элементу управления для рендеринга и обновления. 

### <a name="aggregate-expressions"></a>Статистические выражения

API-интерфейсы клиентской библиотеки TSI широко используют статистические выражения. Статистическое выражение предоставляет возможность создать один или несколько условий поиска. API применяет эти условия аналогично тому, как [TSI Explorer](https://insights.timeseries.azure.com/demo) использует диапазон поиска, предикат WHERE, меры и значение разбиения. Большинство API-интерфейсов библиотеки принимают массив статистических выражений, которые используются службой для создания запроса данных TSI.

### <a name="call-pattern"></a>Шаблон вызова

Заполнение и рендеринг элементов управления диаграммой следуют общему шаблону. Этот шаблон используется по всему коду JavaScript страницы. Он создает и загружает элементы управления примера приложения TSI:

1. Объявите массив для хранения одного или нескольких статистических выражений TSI.  

   ```javascript
   var aes =  [];
   ```

2. Создайте объекты статистических выражений с 1 по n и добавьте их в массив.  

   ```javascript
   var ae = new tsiClient.ux.aggregateExpression(predicateObject, measureObject, measureTypes, searchSpan, splitByObject, color, alias, contextMenuActions);
   aes.push(ae);
   ```
   **Параметры aggregateExpression**

   | Параметр | ОПИСАНИЕ | Пример |
   | --------- | ----------- | ------- |
   | predicateObject | Выражение для фильтрации данных. |`{predicateString: "Factory = 'Factory3'"}` |
   | measureObject   | Имя свойства используемой меры. | `{property: 'Temperature', type: "Double"}` |
   | measureTypes    | Желаемые агрегаты свойства меры. | `['avg', 'min']` |
   | searchSpan      | Длительность и размер интервала статистического выражения. | `{from: startDate, to: endDate, bucketSize: '2m'}` |
   | splitByObject   | Свойство строки, по которому необходимо выполнить разбиение (необязательно, может принимать значение Null). | `{property: 'Station', type: 'String'}` |
   | color           | Цвет объектов, которые вы хотите отобразить. | `'pink'` |
   | alias           | Понятное имя для статистического выражения. | `'Factory3Temperature'` |
   | contextMenuActions | Массив действий, которые следует связать с объектами временных рядов в визуализации (необязательно). | См. раздел [Всплывающие контекстные меню](#popup-context-menus). |

3. Вызовите запрос TSI, используя API-интерфейсы `TsiClient.Server`, чтобы запросить статистические данные.  

   ```javascript
   tsiClient.server.getAggregates(token, envFQDN, aeTsxArray);
   ```
   **параметры getAggregates**

   | Параметр | ОПИСАНИЕ | Пример |
   | --------- | ----------- | ------- |
   | token     | Маркер доступа для API-интерфейса TSI | `authContext.getTsiToken()`. См. раздел об [аутентификации](#authentication). |
   | envFQDN     | Полное доменное имя среды TSI | На портале Azure, например `10000000-0000-0000-0000-100000000108.env.timeseries.azure.com`. |
   | aeTsxArray | Массив выражений запросов TSI | Используйте переменную `aes`, как было описано выше: `aes.map(function(ae){return ae.toTsx()}` |

4. Преобразуйте сжатые выходные данные, возвращенные из запроса TSI, в JSON для визуализации.

   ```javascript
   var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aes);
   ```

5. Создайте элемент управления диаграммой с помощью API-интерфейсов `TsiClient.UX` и привяжите его к одному из элементов `<div>` на странице.

   ```javascript
   var lineChart = new tsiClient.ux.BarChart(document.getElementById('chart3'));
   ```

6. Заполните элемент управления диаграммой преобразованными объектами данных JSON и отобразите его на странице.

   ```javascript
   lineChart.render(transformedResult, {grid: true, legend: 'compact', theme: 'light'}, aes);
   ```

## <a name="rendering-controls"></a>Элементы управления рендерингом

В настоящее время библиотека предоставляет восемь уникальных элементов управления аналитикой. Они включают в себя график, круговую, линейчатую диаграмму, тепловую карту, элементы управления иерархией, доступную сетку, временные шкалы дискретных событий и временные шкалы перехода состояния.   

### <a name="line-bar-pie-chart-examples"></a>Примеры графиков, линейчатых и круговых диаграмм 

Сначала давайте посмотрим на код, стоящий за некоторыми стандартными элементами управления диаграммами, продемонстрированными в приложении, и на модель и шаблоны программирования для их создания. В частности, просмотрите раздел HTML под комментарием `// Example 3/4/5`, который отображает элементы управления со значениями идентификаторов `chart3`, `chart4` и `chart5`. 

Вспомните шаг 3 в разделе [Исходный код страницы и ее структура](#page-source-and-structure). Элементы управления диаграммой расположены в строках на странице, каждая из которых имеет описательную строку заголовка. В этом примере три заполняемые диаграммы находятся под элементом заголовка `<div>` "Несколько типов диаграмм из тех же данных", связанного с тремя расположенными под ними элементами `<div>`:

[!code-javascript[code-sample1-line-bar-pie](~/samples-javascript/pages/index.html?range=60-74&highlight=1,5,9,13)]

В следующем разделе кода JavaScript используется описанный ранее шаблон для создания статистических выражений TSI, применения их для запроса данных TSI и отображения трех диаграмм. Обратите внимание на три типа, используемые из пространства имен `tsiClient.ux` (`LineChart`, `BarChart` и `PieChart`) для создания и отображения соответствующих диаграмм. Также обратите внимание, что все три диаграммы могут использовать одни и те же данные статистических выражений (`transformedResult`):

[!code-javascript[code-sample2-line-bar-pie](~/samples-javascript/pages/index.html?range=236-257&highlight=13-14,16-17,19-20)]

При отображении три диаграммы выглядят следующим образом:

[![Несколько типов диаграммы из тех же данных](media/tutorial-explore-js-client-lib/tcs-multiple-chart-types-from-the-same-data.png)](media/tutorial-explore-js-client-lib/tcs-multiple-chart-types-from-the-same-data.png#lightbox)

## <a name="advanced-features"></a>Дополнительные функции

Библиотека также предоставляет некоторые необязательные дополнительные функции, которые вы можете использовать.  

### <a name="states-and-events"></a>Состояния и события

Одним из примеров расширенной функциональности является возможность добавления переходов состояний и дискретных событий в диаграммы. Эта функция полезна для выделения инцидентов, оповещений и переключений состояний, таких как включение и выключение. 

Здесь вы видите программный код раздела HTML под комментарием `// Example 10`. Код отрисовывает элемент управления графика в заголовке "Графики с несколькими типами рядов", привязанном к `<div>` со значением идентификатора `chart10`:

1. Сначала определяется структура с именем `events4`, содержащая отслеживаемые элементы изменений состояния. Она содержит следующие виртуальные машины:
   - Ключ строки с именем `"Component States"`. 
   - Массив объектов-значений, представляющих состояния, каждый из которых включает в себя:
     - ключ строки, содержащий метку времени JavaScript ISO;
     - массив, содержащий характеристики состояния:
       - цвет;
       - описание.

2. Затем определяется структура `events5` для `"Incidents"`, которая содержит массив элементов событий, подлежащих отслеживанию. Структура массива имеет ту же форму, что и `events4`. 

3. Наконец, визуализируется график и передаются две структуры с параметрами настроек диаграммы: `events:` и `states:`. Обратите внимание на другие параметры настроек для указания `tooltip:`, `theme:` или `grid:`. 

[!code-javascript[code-sample-states-events](~/samples-javascript/pages/index.html?range=332-384&highlight=5,26,51)]

Визуально маркеры в форме ромбов и всплывающие окна используются для обозначения инцидентов, а цветные полосы и всплывающие окна на шкале времени отображают изменения состояния:

[![Графики с несколькими типами рядов](media/tutorial-explore-js-client-lib/tcs-line-charts-with-multiple-series-types.png)](media/tutorial-explore-js-client-lib/tcs-line-charts-with-multiple-series-types.png#lightbox)

### <a name="popup-context-menus"></a>Всплывающие контекстные меню

Другим примером дополнительной функциональной возможности являются настраиваемые контекстные меню (открываются щелчком правой кнопки мыши), которые полезны для включения действий и последующих логических шагов в рамках вашего приложения.

Рассмотрим код, лежащий в основе HTML в разделе `// Example 13/14/15`. Этот код изначально отрисовывает график с заголовком "Графики с контекстным меню для создания круговой или линейчатой диаграммы", привязанный к элементу `<div>` ​​с идентификатором `chart13`. График позволяет с помощью контекстных меню динамически создавать круговую и линейчатую диаграмму, привязанные к элементам `<div>` с идентификаторами `chart14` и `chart15`. Кроме того, круговые и линейчатые диаграммы также используют контекстные меню для возможности копировать данные из круговой диаграммы в линейчатую и выводить данные линейчатой диаграммы в окно консоли браузера соответственно.

1. Сначала определяется ряд пользовательских действий. Каждое из них содержит массив с одним или несколькими элементами, каждый из которых определяет один пункт контекстного меню: 
   - `barChartActions`: определяет контекстное меню для круговой диаграммы, которое содержит один элемент для определения одного пункта:
     - `name`: текст, используемый для пункта меню: "Вывод параметров на консоль".
     - `action`: связанное с пунктом меню действие, которое всегда является анонимной функцией, которая принимает три аргумента, основанные на статистическом выражении, используемом для создания диаграммы. В этом случае аргументы записываются в окно консоли браузера:
       - `ae`: массив статистических выражений.
       - `splitBy`: значение, используемое для разделения.
       - `timestamp`: метка времени.
   - `pieChartActions`: определяет контекстное меню линейчатой диаграммы, которое содержит один элемент для определения одного пункта. Форма и схема аналогичны предыдущему элементу `barChartActions`, но обратите внимание, что функция `action` сильно отличается, так как она создает и отрисовывает линейчатую диаграмму. Также обратите внимание, что используется аргумент `ae`, чтобы указать массив статистических выражений, переданный во время выполнения при появлении пункта меню. Функция также устанавливает свойство `ae.contextMenu` для контекстного меню `barChartActions`.
   - `contextMenuActions`: определяет контекстное меню для графика, которое содержит три элемента для определения трех пунктов меню. Форма и схема для каждого элемента аналогичны предыдущим. Как и `barChartActions`, первый элемент записывает три аргумента функции в окно консоли браузера. Подобно `pieChartActions`, два следующих элемента создают экземпляр и отрисовывают круговую и линейчатую диаграммы соответственно. Два следующих элемента также устанавливают свойства `ae.contextMenu` для контекстных меню `pieChartActions` и `barChartActions` соответственно.

2. Затем два статистических выражения помещаются в массив `aes` с указанием массива `contextMenuActions` для каждого их них. Они используются с элементом управления графика.

3. Наконец, сначала выводится только график, из которого во время выполнения можно отрисовать круговую и линейчатую диаграммы.

[!code-javascript[code-sample-context-menus](~/samples-javascript/pages/index.html?range=456-535&highlight=7,16,29,61-64,78)]

На снимке экрана показаны графики с соответствующими всплывающими контекстными меню. Круговая и линейчатая диаграмма были созданы динамически с использованием параметров контекстного меню графика:

[![График с контекстным меню для создания круговой или линейчатой диаграммы](media/tutorial-explore-js-client-lib/tcs-line-chart-with-context-menu-to-create-pie-bar-chart.png)](media/tutorial-explore-js-client-lib/tcs-line-chart-with-context-menu-to-create-pie-bar-chart.png#lightbox)

### <a name="brushes"></a>Кисти

С помощью кистей можно указать диапазон времени для применения таких действий, как масштабирование и рассмотрение. 

Код, используемый для отображения кистей, также показан в предыдущем примере "График с контекстным меню для создания круговой или линейчатой диаграммы" в разделе [Всплывающие контекстные меню](#popup-context-menus-section). 

1. Действия кистей очень похожи на контекстное меню, определяющее ряд пользовательских действий для кисти. Каждое из них содержит массив с одним или несколькими элементами, каждый из которых определяет один пункт контекстного меню:
   - `name`: текст, используемый для пункта меню: "Вывод параметров на консоль".
   - `action`: действие, связанное с пунктом меню, которое всегда является анонимной функцией, принимающей два аргумента. В этом случае аргументы записываются в окно консоли браузера:
      - `fromTime`: метка времени "от" выбора кисти.
      - `toTime`: метка времени "до" выбора кисти.

2. Действия кисти добавляются как еще одно свойство параметра диаграммы. Обратите внимание, что свойство `brushContextMenuActions: brushActions` передается в вызов `linechart.Render`.

[!code-javascript[code-sample-brushes](~/samples-javascript/pages/index.html?range=521-535&highlight=1,13)]

![График с контекстным меню для создания круговой или линейчатой диаграммы с использованием кистей](media/tutorial-explore-js-client-lib/tcs-line-chart-with-context-menu-to-create-pie-bar-chart-brushes.png)

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Выполнить вход в систему и изучить пример приложения TSI и его исходный код.
> * Использовать API-интерфейсы в клиентской библиотеке TSI JavaScript.
> * Использовать JavaScript для создания элементов управления диаграммами и заполнения их данными TSI.

Как описано выше, пример приложения TSI использует демонстрационный набор данных. Чтобы узнать больше о том, как создать собственную среду и набор данных TSI, перейдите к следующей статье:

> [!div class="nextstepaction"]
> [Планирование среды Аналитики временных рядов Azure](time-series-insights-environment-planning.md)


