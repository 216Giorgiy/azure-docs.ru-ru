<properties 
	pageTitle="Обнаружение, рассмотрение, диагностика" 
	description="Анализируйте сбои, отслеживайте и устраняйте проблемы производительности в приложениях" 
	authors="alancameronwills" 
	services="application-insights" 
    documentationCenter=""
	manager="keboyd"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/02/2015" 
	ms.author="awills"/>

# Обнаружение, рассмотрение и диагностика с помощью Application Insights

*Доступна только предварительная версия Application Insights.*


После опубликования приложения служба Application Insights поможет убедиться, что приложение работает и имеет нормальную производительность. При наличии проблемы необходимо узнать о ней как можно быстрее, а затем выяснить способы решения.

* *"Несколько дней назад мы развернули минимальное исправление. Мы не проводили широкое тестирование, но, к сожалению, возникли неожиданные изменения в полезных данных, что привело к несовместимости между внешним и внутренним интерфейсами. Сразу же возросло число исключений сервера и сработало оповещение, которое и уведомило нас о ситуации. В несколько щелчков на портале Application Insights мы получили достаточно информации из стека вызовов исключений, чтобы сузить круг причины проблемы. Мы сразу же выполнили откат и тем самым сократили ущерб.  Благодаря Application Insights эта часть цикла разработки стала очень простой и реально выполнимой".*

Данную часть цикла разработки можно представить в виде конвейера:

![Обнаружение — рассмотрение — диагностика](./media/app-insights-detect-triage-diagnose/01-pipe1.png)


Как только проблема диагностирована, становится известно, на что следует направить усилия: отладка кода, выделение памяти или работа с зависимостью. Наконец, можно проверить, что действия по исправлению возымели эффект:



![Исправление — проверка](./media/app-insights-detect-triage-diagnose/02-pipe2.png)


Давайте посмотрим, как Application Insights работает на каждом этапе конвейера.

Служба Application Insights работает как с приложениями на устройствах, так и с веб-приложениями. В этом пошаговом руководстве мы сосредоточимся на веб-приложениях. Мы будем наблюдать за действиями команды по обслуживанию онлайн-банкинга в Банке Fabrikam. Они включили службу Application Insights в число своих веб-проектов.


![Типовой веб-сайт банка](./media/app-insights-detect-triage-diagnose/03-bank.png)



## Обнаружение низкой доступности 


Маргарита Маркова — специалист по тестированию в команде онлайн-банкинга. Она также отвечает за мониторинг производительности сети. Маргарита настраивает несколько [веб-тестов][availability]\:

* Тест с одним URL-адресом для основной целевой страницы приложения — http://fabrikambank.com/onlinebanking/. Она задает в качестве условия получение кода состояния HTTP 200 и текста "Добро пожаловать!". Если данный тест завершается ошибкой, это говорит о серьезном сбое в работе сети или серверов или же о проблемах с развертыванием. \(Возможно, кто-то изменил сообщение "Добро пожаловать" на странице и не поставил Маргариту в известность.\) 


* Глубокий многоэтапный тест, во время которого выполняется вход в систему и создается список текущих учетных записей, а также проверяется несколько ключевых пунктов на каждой странице. Этот тест позволяет проверить, работает ли ссылка на базу учетных записей. Маргарита использует идентификатор вымышленного пользователя: несколько таких пользователей создано специально для тестирования.


Благодаря этим тестам она уверена, что команда сможет быстро узнать о любом сбое в системе.


Ошибки отображаются в виде красных точек на общей диаграмме веб-теста:

![Отображение веб-тестов, выполненных за предыдущий период](./media/app-insights-detect-triage-diagnose/04-webtests.png)


Но еще важнее другое: команда разработчиков будет получать тревожное оповещение о любом сбое по электронной почте. Таким образом, специалисты узнают о проблеме раньше почти всех клиентов.


## Мониторинг метрик производительности 


На странице обзора с диаграммой доступности содержится еще одна диаграмма, отображающая разнообразные [ключевые метрики][perf].


![Различные метрики](./media/app-insights-detect-triage-diagnose/05-perfMetrics.png)

Время обработки клиента выводится на основе данных телеметрии, отправляемых непосредственно с веб-страниц. Другие значения отображают показатели, расчет которых выполняется на веб-серверах.


Число неудачно завершенных запросов показывает случаи, когда ошибка была видна пользователям — обычно такое случается из-за исключений в коде. Возможно, пользователи увидят сообщение "К сожалению, сейчас невозможно обновить ваши данные" или, в худшем случае, по вине веб-сервера на экране отобразится дамп стека.


Маргарита любит время от времени смотреть на эти диаграммы. Постоянный поток неудачно завершенных запросов немного удручает, но команда уже работает над этой ошибкой, так что вскоре сбои прекратятся.  Но если число запросов или какой-то другой показатель, например время отклика сервера, начнет резко повышаться, Маргарита хочет узнать об этом незамедлительно. Это может свидетельствовать о непредвиденной проблеме, вызванной выпуском кода, или сбоем в зависимости, к примеру, в базе данных, или же внезапной реакцией на высокое число запросов.

#### Оповещения

Поэтому она задает два [оповещения][metrics]\: одно для времени отклика, превышающего обычное пороговое значение, а другое — для количества неудачно завершенных запросов, превосходящего текущий уровень.


Наряду с оповещением о доступности эти два оповещения позволяют Маргарите быть уверенной в том, что она моментально узнает о любой возникшей неисправности.


Можно также настроить оповещения для множества других метрик. Например, получать уведомление по электронной почте в случае увеличения числа исключений, нехватки памяти или при пиковых значениях числа клиентских запросов.



![Добавление колонки оповещений](./media/app-insights-detect-triage-diagnose/07-alerts.png)




## Определение исключений


Application Insights получает информацию об исключениях путем вызова [TrackException\(\)][api]\:

    var telemetry = new TelemetryClient();
    ...
    try 
    { ...
    }
    catch (Exception ex)
    {
       // Set up some properties:
       var properties = new Dictionary <string, string> 
         {{"Game", currentGame.Name}};

       var measurements = new Dictionary <string, double>
         {{"Users", currentGame.Users.Count}};

       // Send the exception telemetry:
       telemetry.TrackException(ex, properties, measurements);
    }


В команде Банка Fabrikam сложилась практика всегда отправлять телеметрические данные об исключении, если отсутствует очевидный способ восстановления.

В реальности их стратегия даже шире: данные телеметрии отправляются во всех случаях, когда клиент не удовлетворен результатом операции, которую он выполнял в онлайн-банке, — и неважно, имеет это отношение к исключению в коде или нет. Например, если сторонняя система межбанковских переводов отображает сообщение "невозможно выполнить данную операцию" по какой-то внутренней причине \(не по вине клиента\), команда отслеживает это событие.

    var successCode = AttemptTransfer(transferAmount, ...);
    if (successCode < 0)
    {
       var properties = new Dictionary <string, string> 
            {{ "Code", returnCode, ... }};
       var measurements = new Dictionary <string, double>
         {{"Value", transferAmount}};
       telemetry.TrackEvent("transfer failed", properties, measurements);
    }

TrackException служит для сообщения об исключениях путем отправки копии стека, а также для информирования о других событиях. Можно прикреплять любые свойства, которые могут пригодиться при диагностике.

Исключения и события отображаются в колонке [Поиск по журналу диагностики][diagnostic]. Можно также проанализировать исключения, просмотрев дополнительные свойства и трассировку стека.

![В колонке "Поиске по журналам диагностики" можно использовать фильтры для отображения определенных типов данных](./media/appinsights/appinsights-333facets.png)

## Мониторинг благоприятных событий 


Команда разработчиков Fabrikam отслеживает не только опасные, но и благоприятные, хорошие события. Частично потому, что приятно осознавать, сколько всего хорошего происходит вокруг; и кроме того, когда хорошие события перестают происходить — это само по себе проблема.


Например, многие пользователи просматривают сайт по принципу воронки продаж: почти все клиенты смотрят на различные способы кредитования, лишь некоторые из них заполняют форму запроса стоимости, а из заполнивших только часть идет дальше и получает кредит.


Команда разработчиков добавляет вызовы TrackMetric\(\) на каждом уровне этой воронки. В обозревателе метрик архитектор бизнес-процессов Борис может сравнивать значения каждой метрики и оценивать, насколько хорошо система продает кредиты.


Помимо Бориса за благоприятными показателями также следит Ирина, UX-специалист компании. Если диаграмма показывает внезапное падение на каком-либо уровне воронки, это свидетельствует о проблеме. Возможно, клиентам сложно найти нужную кнопку на странице или ее содержание не очень побуждает к действию. Или возникла реальная ошибка: пользователи нажимают на кнопку, но ничего не происходит.


## Упреждающий мониторинг  


Маргарита не просто сидит на месте в ожидании тревожных оповещений. Вскоре после каждого повторного развертывания она просматривает [время отклика][perf] — как общее значение, так и таблицу с самыми медленными запросами, а также количество исключений.



![Диаграмма и сетка значений времени отклика сервера.](./media/app-insights-detect-triage-diagnose/09-dependencies.png)

Она может оценить изменение производительности после  каждого развертывания, сравнивая результаты с данными за предыдущую неделю. При резком ухудшении показателей она сообщает о проблеме разработчикам.


## Рассмотрение 


Рассмотрение — оценка важности и глубины проблемы — является первым шагом после обнаружения. Стоит ли собирать команду посреди ночи? Или можно поместить проблему в список невыполненных задач и решить ее при первой удобной возможности? Процесс рассмотрения предполагает ответы на некоторые ключевые вопросы.


Каков масштаб проблемы? Диаграммы в колонке "Общая информация" позволяют достаточно глубоко оценить ситуацию. Например, за ночь приложение Fabrikam создало четыре тревожных оповещения, связанных с веб-тестами. Утром, взглянув на диаграмму, сотрудники увидели на ней соответствующие красные точки, при этом большая часть тестов была выполнена успешно, о чем свидетельствовали точки зеленого цвета. При детальном изучении диаграммы стало ясно, что все эти временные проблемы связаны с одним тестом. Очевидно, возникшая в сети проблема затронула только один маршрут, после чего самоустранилась. 


В то же время значительный и непрерывный рост на диаграмме исключений или времени отклика явно свидетельствует о серьезной проблеме.


Полезная тактика — выполнять рассмотрение самостоятельно. Потому что при повторном возникновении этой проблемы вы будете знать, что нужно делать.


Какая часть пользователей пострадала от проблемы? Чтобы получить приблизительный ответ, разделите число сбоев на число сеансов.


![Диаграммы неудачно завершенных запросов и сеансов](./media/app-insights-detect-triage-diagnose/10-failureRate.png)

В случае медленного отклика сравните таблицу самых медленных запросов с частотой использования каждой страницы.


Насколько важен заблокированный сценарий? Это функциональная проблема блокирует только одну конкретную пользовательскую историю? Насколько она серьезна? Если клиенты не могут оплачивать свои счета, это серьезно; если не получается изменить настройки цвета экрана — возможно, это может подождать. Подробные сведения о событии, исключении или идентификация медленной страницы подскажет вам, в каком месте пользователи сталкиваются с проблемой.


## Диагностика 


Диагностика — это не совсем то же самое, что и отладка. Прежде чем приступить к отслеживанию через код, необходимо иметь примерное представление о причинах, месте и времени возникновения проблемы.


**Когда это происходит?** Просмотр журналов событий и диаграмм с метриками упрощает соотнесение последствий с возможными причинами. В случае периодического увеличения времени отклика или числа исключений взгляните на счетчик запросов: если пиковые значения достигаются в одно и то же время, это говорит о проблеме с ресурсами. Необходимо выделить дополнительные ЦП или память? Или это зависимость, которая не может справиться с нагрузкой?


**Или причина в нас?** При внезапном падении производительности отдельного типа запросов — например, получение клиентом выписки по счету — проблема с большей вероятностью будет заключаться во внешней подсистеме, а не в вашем веб-приложении. В обозревателе метрик выберите показатели "Сбой зависимости" и "Длительность зависимости", после чего сравните их журналы за последние несколько часов или дней с момента возникновения проблемы. Если присутствуют взаимообусловленные изменения, причиной сбоя может являться внешняя подсистема.


![Диаграммы сбоя зависимостей и длительности вызовов зависимостей](./media/app-insights-detect-triage-diagnose/11-dependencies.png)

Иногда проблемы с медленными зависимостями возникают вследствие недоработок, связанных с географическим расположением. В Банке Fabrikam используются виртуальные машины Azure, и однажды обнаружилось, что банк непреднамеренно разместил свой веб-сервер и сервер учетных записей в разных странах. Перенос одного из них позволил добиться резкого улучшения в работе.


**Что мы сделали?** Если проблема не в зависимости и если она не проявлялась ранее, то, возможно, причиной является последнее изменение. Благодаря наличию исторической справки в диаграммах показателей и событий можно легко соотносить внезапные изменения с развертываниями. Это значительно сужает круг поиска причины проблемы.


**В чем причина?** Некоторые ошибки возникают крайне редко и их сложно отследить при тестировании в автономном режиме. Все, что можно сделать в таком случае, — попытаться записать ошибку при ее возникновении в реальном времени. Можно проверить дампы стека в отчетах об исключениях. Кроме того, можно написать трассировочные вызовы с использованием привычной платформы ведения журналов либо задействовать TrackTrace\(\) или TrackEvent\(\).


В Банке Fabrikam периодически возникала проблема с переводами между учетными записями, при этом были затронуты только записи определенного типа. Чтобы лучше разобраться в происходящем, они вставили вызовы TrackTrace\(\) в ключевые точки кода, добавив тип учетной записи в виде свойства к каждому вызову. Это позволило легко отсортировать нужные трассировки в колонке "Поиск по журналу диагностики". Они также присоединили значения параметров в виде свойств и измерений к трассировочным вызовам.


## Устранение проблемы 


Как только проблема диагностирована, нужно составить план по ее исправлению. Возможно, потребуется выполнить откат последнего изменения или же устранить ошибку обычным образом. После исправления проблемы служба Application Insights сообщит об успешном результате.


Благодаря применению Application Insights команда разработчиков Банка Fabrikam выработала более структурированный подход к измерению производительности.

* На странице общей информации Application Insights они задали целевые значения производительности по отдельным показателям. 

* В приложение были встроены показатели производительности, работающие уже с момента запуска. Среди них — показатели, отслеживающие продвижение пользователей через воронки продаж сайта.




## Использование

Служба Application Insights также собирает информацию о том, как пользователи используют приложение. Если оно работает без сбоев, разработчикам важно знать, какие из функций наиболее популярны, с чем у пользователей возникают сложности и как часто они возвращаются к приложению. Это позволяет правильно расставить приоритеты для предстоящей работы. Также можно запланировать измерение эффективности каждой функции в качестве отдельной части цикла разработки. [Подробная информация][usage].

## Ваши приложения

Вот как одна команда использует службу Application Insights не только для устранения отдельных проблем, но и для улучшения жизненного цикла разработки в целом. Надеюсь, вы получили некоторые соображения относительно того, как Application Insights может помочь  в повышении производительности вашего приложения.

## Видео

[AZURE.VIDEO app-insights-performance-monitoring]

<!--Link references-->

[api]: app-insights-api-custom-events-metrics.md
[availability]: app-insights-monitor-web-app-availability.md
[diagnostic]: app-insights-diagnostic-search.md
[metrics]: app-insights-metrics-explorer.md
[perf]: app-insights-web-monitor-performance.md
[usage]: app-insights-web-track-usage.md


<!--HONumber=54-->