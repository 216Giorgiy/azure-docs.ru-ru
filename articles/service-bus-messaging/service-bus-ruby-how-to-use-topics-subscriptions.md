<properties
    pageTitle="Использование разделов служебной шины (Ruby) | Microsoft Azure"
    description="Узнайте, как использовать разделы и подписки служебной шины в Azure. Примеры кода написаны для приложений Ruby."
    services="service-bus"
    documentationCenter="ruby"
    authors="sethmanheim"
    manager="timlt"
    editor=""/>

<tags
    ms.service="service-bus"
    ms.workload="na"
    ms.tgt_pltfrm="na"
    ms.devlang="ruby"
    ms.topic="article"
    ms.date="10/04/2016"
    ms.author="sethm"/>


# <a name="how-to-use-service-bus-topics/subscriptions"></a>Использование разделов и подписок служебной шины

[AZURE.INCLUDE [service-bus-selector-topics](../../includes/service-bus-selector-topics.md)]

В этой статье показано, как использовать разделы и подписки служебной шины в приложениях Ruby. В этой статье описаны такие сценарии, как **создание разделов и подписок, создание фильтров подписок, отправка сообщений** в раздел, **получение сообщений из подписки** и **удаление разделов и подписок**. Дополнительные сведения о разделах и подписках см. в разделе [Дальнейшие действия](#next-steps).

## <a name="service-bus-topics-and-subscriptions"></a>Разделы и подписки служебной шины

Разделы и подписки служебной шины поддерживают модель обмена сообщениями *публикации/подписки* . При использовании разделов и подписок компоненты распределенного приложения не взаимодействуют между собой напрямую, а обмениваются сообщениями через раздел, который выступает в качестве посредника.

![TopicConcepts](./media/service-bus-ruby-how-to-use-topics-subscriptions/sb-topics-01.png)

В отличие от очередей служебной шины, где каждое сообщение обрабатывается одним потребителем, разделы и подписки предоставляют вид связи **один ко многим** с помощью шаблона публикации или подписки. Можно зарегистрировать несколько подписок на раздел. Когда сообщение отправляется в раздел, оно затем может обрабатываться независимо каждой подпиской.

Подписка раздела напоминает виртуальную очередь, которая получает копии сообщений, отправленных в раздел. Вы можете зарегистрировать в разделе правила фильтрации для отдельных подписок, которые позволят определить, какие подписки раздела будут получать те или иные сообщения из раздела.

Разделы и подписки служебной шины обеспечивают возможность масштабирования для обработки большого количества сообщений для большого количества пользователей и приложений.

## <a name="create-a-namespace"></a>Создание пространства имен

Чтобы начать использовать очереди служебной шины в Azure, необходимо сначала создать пространство имен. Пространство имен предоставляет контейнер для адресации ресурсов служебной шины в вашем приложении. Так как [портал Azure][] не создает пространство имен с помощью подключения ACS, необходимо создать пространство имен через интерфейс командной строки.

Создание пространства имен службы:

1. Откройте окно консоли Azure PowerShell.

2. Введите следующую команду, чтобы создать пространство имен. Укажите собственное значение пространства имен и укажите ту же область, что и у приложения.

    ```
    New-AzureSBNamespace -Name 'yourexamplenamespace' -Location 'West US' -NamespaceType 'Messaging' -CreateACSNamespace $true
    ```

    ![Создание пространства имен](./media/service-bus-ruby-how-to-use-topics-subscriptions/showcmdcreate.png)

## <a name="obtain-default-management-credentials-for-the-namespace"></a>Получение учетных данных управления по умолчанию для пространства имен

Для выполнения операций управления, таких как создание очереди в новом пространстве имен, необходимо получить учетные данные управления для пространства имен.

Командлет PowerShell, выполненный с целью создания пространства имен служебной шины, отображает ключ, который можно использовать для управления пространством имен. Скопируйте значение **DefaultKey**. Оно понадобится в коде дальше в этом учебнике.

![Копирование ключа](./media/service-bus-ruby-how-to-use-topics-subscriptions/defaultkey.png)

> [AZURE.NOTE]
> Этот ключ также можно найти на [портале Azure][] в разделе сведений о подключении для вашего пространства имен.

## <a name="create-a-ruby-application"></a>Создание приложения Ruby

Инструкции см. в разделе [Создание приложения Ruby в Azure](../virtual-machines/virtual-machines-linux-classic-ruby-rails-web-app.md).

## <a name="configure-your-application-to-use-service-bus"></a>Настройка приложения для использования служебной шины

Для использования служебной шины скачайте и используйте пакет Ruby Azure, который содержит набор библиотек, взаимодействующих со службами REST хранилища.

### <a name="use-rubygems-to-obtain-the-package"></a>Использование RubyGems для получения пакета

1. Используйте интерфейс командной строки, например **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix).

2. Введите "gem install azure" в окне командной строки, чтобы установить пакеты и зависимости.

### <a name="import-the-package"></a>Импорт пакета

Используйте свой любимый текстовый редактор, чтобы добавить следующий код в начало файла Ruby, где планируется использовать хранилище.

```
require "azure"
```

## <a name="set-up-a-service-bus-connection"></a>Настройка подключения к Service Bus

Модуль Azure считывает переменные среды **AZURE\_SERVICEBUS\_NAMESPACE** и **AZURE\_SERVICEBUS\_ACCESS\_KEY**, в которых содержатся сведения, необходимые для подключения к служебной шине. Если эти переменные среды не заданы, необходимо указать сведения о пространстве имен перед использованием **Azure::ServiceBusService** с помощью следующего кода:

```
Azure.config.sb_namespace = "<your azure service bus namespace>"
Azure.config.sb_access_key = "<your azure service bus access key>"
```

Задайте для пространства имен только созданное значение, а не весь URL-адрес. Например, используйте **yourexamplenamespace**, а не yourexamplenamespace.servicebus.windows.net.

## <a name="create-a-topic"></a>Создание раздела

Объект **Azure::ServiceBusService** позволяет работать с разделами. Следующий код создает объект **Azure::ServiceBusService**. Чтобы создать раздел, используйте метод **create\_topic()**. В следующем примере создается раздел или выводятся возникающие ошибки.

```
azure_service_bus_service = Azure::ServiceBusService.new
begin
  topic = azure_service_bus_service.create_queue("test-topic")
rescue
  puts $!
end
```

Также можно передать объект **Azure::ServiceBus::Topic** с дополнительными параметрами, которые позволяют переопределить параметры раздела по умолчанию, например срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить максимальный размер очереди 5 ГБ и срок жизни 1 минута.

```
topic = Azure::ServiceBus::Topic.new("test-topic")
topic.max_size_in_megabytes = 5120
topic.default_message_time_to_live = "PT1M"

topic = azure_service_bus_service.create_topic(topic)
```

## <a name="create-subscriptions"></a>Создание подписок

Подписки разделов также создаются с помощью объекта **Azure::ServiceBusService**. Подписки имеют имена и могут использовать дополнительный фильтр, который ограничивает набор сообщений, доставляемых в виртуальную очередь подписки.

Подписки являются постоянными и продолжают существовать либо до их удаления, либо до удаления раздела, с которым они связаны. Если приложение содержит логику для создания подписки, оно сначала должно проверить, существует ли подписка, используя метод getSubscription.

### <a name="create-a-subscription-with-the-default-(matchall)-filter"></a>Создание подписки с фильтром по умолчанию (MatchAll)

Фильтр **MatchAll** является фильтром по умолчанию, используемым, если при создании новой подписки не указан фильтр. Если используется фильтр **MatchAll**, то все сообщения, опубликованные в разделе, помещаются в виртуальную очередь подписки. В следующем примере создается подписка с именем "all-messages" и используется фильтр по умолчанию **MatchAll**.

```
subscription = azure_service_bus_service.create_subscription("test-topic", "all-messages")
```

### <a name="create-subscriptions-with-filters"></a>Создание подписок с фильтрами

Можно также задавать фильтры, позволяющие определять, какие посылаемые в раздел сообщения должны отображаться в рамках конкретной подписки.

Самый гибкий тип фильтра, который поддерживается подписками, — это **Azure::ServiceBus::SqlFilter**, реализующий подмножество SQL92. Фильтры SQL работают со свойствами сообщений, которые опубликованы в разделе. Дополнительные сведения о выражениях, которые можно использовать с фильтром SQL, см. в описании синтаксиса [SqlFilter.SqlExpression](http://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.sqlfilter.sqlexpression.aspx).

Фильтры можно добавить в подписку с помощью метода **create\_rule()** объекта **Azure::ServiceBusService** . Этот метод позволяет добавлять новые фильтры в существующую подписку.

Так как ко всем новым подпискам автоматически применяется фильтр по умолчанию, сначала необходимо удалить фильтр по умолчанию, иначе **MatchAll** будет действовать вместо любых других заданных фильтров. Вы можете удалить правило по умолчанию с помощью метода **delete\_rule()** объекта **Azure::ServiceBusService**.

В приведенном ниже примере создается подписка с именем high-messages с фильтром **Azure::ServiceBus::SqlFilter**, который выбирает только те сообщения, значение настраиваемого свойства **message\_number** которых больше 3.

```
subscription = azure_service_bus_service.create_subscription("test-topic", "high-messages")
azure_service_bus_service.delete_rule("test-topic", "high-messages", "$Default")

rule = Azure::ServiceBus::Rule.new("high-messages-rule")
rule.topic = "test-topic"
rule.subscription = "high-messages"
rule.filter = Azure::ServiceBus::SqlFilter.new({
  :sql_expression => "message_number > 3" })
rule = azure_service_bus_service.create_rule(rule)
```

В следующем примере создается подписка с именем low-messages с фильтром **Azure::ServiceBus::SqlFilter**, выбирающим только те сообщения, значение свойства **message_number** которых меньше или равно 3.

```
subscription = azure_service_bus_service.create_subscription("test-topic", "low-messages")
azure_service_bus_service.delete_rule("test-topic", "low-messages", "$Default")

rule = Azure::ServiceBus::Rule.new("low-messages-rule")
rule.topic = "test-topic"
rule.subscription = "low-messages"
rule.filter = Azure::ServiceBus::SqlFilter.new({
  :sql_expression => "message_number <= 3" })
rule = azure_service_bus_service.create_rule(rule)
```

Если сообщение отправляется в раздел test-topic, оно всегда доставляется в приемники с подпиской раздела all-messages, а также в отдельные приемники с подписками разделов high-messages и low-messages (в зависимости от содержимого сообщений).

## <a name="send-messages-to-a-topic"></a>Отправка сообщений в раздел

Чтобы отправить сообщение в раздел служебной шины, приложение должно использовать метод **send\_topic\_message()** в объекте **Azure::ServiceBusService**. Сообщения, отправленные в разделы служебной шины, представляют собой экземпляры объектов **Azure::ServiceBus::BrokeredMessage**. У объектов **Azure::ServiceBus::BrokeredMessage** есть набор стандартных свойств (например, **label** и **time\_to\_live**), словарь, используемый для хранения настраиваемых свойств приложения, и набор строковых данных. Приложение может задавать текст сообщения, передавая строковое значение в метод **send\_topic\_message()**, и все обязательные стандартные свойства будут заполнены значениями по умолчанию.

В следующем примере показано, как отправить пять тестовых сообщений в раздел test-topic. Обратите внимание, что значение настраиваемого свойства **message_number** каждого сообщения зависит от итерации цикла (это определяет подписку, которая получит это сообщение).

```
5.times do |i|
  message = Azure::ServiceBus::BrokeredMessage.new("test message " + i,
    { :message_number => i })
  azure_service_bus_service.send_topic_message("test-topic", message)
end
```

Разделы служебной шины поддерживают максимальный размер сообщения 256 КБ для [уровня "Стандартный"](service-bus-premium-messaging.md) и 1 МБ для [уровня Premium](service-bus-premium-messaging.md). Максимальный размер заголовка, который содержит стандартные и настраиваемые свойства приложения, — 64 КБ. Ограничения на количество сообщений в разделе нет, но есть максимальный общий размер сообщений, содержащихся в разделе. Этот размер раздела определяется при создании с верхним пределом 5 ГБ.

## <a name="receive-messages-from-a-subscription"></a>Получение сообщений из подписки

Сообщения извлекаются из подписки с помощью метода **receive\_subscription\_message()** объекта **Azure::ServiceBusService**. По умолчанию сообщения считываются (просматриваются) и блокируются без удаления из подписки. Вы можете читать сообщения и удалять их из подписки, установив для параметра **peek\_lock** значение **false**.

По умолчанию чтение и удаление выполняются в два этапа, что позволяет поддерживать приложения, не способные обрабатывать отсутствующие сообщения. Получив запрос, служебная шина находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению. Когда приложение завершает обработку сообщения (или сохраняет его для будущей обработки), оно завершает второй этап процесса получения, вызывая метод **delete\_subscription\_message()** и указывая сообщение для удаления в качестве параметра. Метод **delete\_subscription\_message()** помечает сообщение как прочитанное и удаляет его из подписки.

Если параметр **:peek\_lock** имеет значение **false**, чтение и удаление сообщения осуществляется очень просто. Этот метод оптимально подходит для сценариев, в которых приложение может пропустить обработку сообщения без последствий в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку служебная шина помечает сообщение как использованное, то когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.

В следующем примере показаны получение и обработка сообщений с помощью метода **receive\_subscription**message()\_. В этом примере сначала получается и удаляется сообщение из подписки low-messages (для этого параметру **:peek\_lock** присваивается значение **false**), а затем получается другое сообщение из high-messages, которое удаляется с помощью метода **delete\_subscription\_message()**.

```
message = azure_service_bus_service.receive_subscription_message(
  "test-topic", "low-messages", { :peek_lock => false })
message = azure_service_bus_service.receive_subscription_message(
  "test-topic", "high-messages")
azure_service_bus_service.delete_subscription_message(message)
```

## <a name="handle-application-crashes-and-unreadable-messages"></a>Обработка сбоев приложения и нечитаемых сообщений

служебная шина предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock\_subscription\_message()** объекта **Azure::ServiceBusService**. После этого служебная шина разблокирует сообщение в подписке и снова сделает его доступным для получения тем же или другим приложением.

Кроме того, с сообщением, заблокированным в подписке, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), служебная шина автоматически разблокирует сообщение и сделает его доступным для повторного приема.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода **delete\_subscription\_message()**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют **обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Часто это реализуется с помощью свойства **message\_id** сообщения, которое остается постоянным для различных попыток доставки.

## <a name="delete-topics-and-subscriptions"></a>Удаление разделов и подписок

Разделы и подписки хранятся постоянно, и их нужно удалять явным образом на [портале Azure][] или с помощью программных средств. В приведенном ниже примере показано, как удалить раздел с именем test-topic.

```
azure_service_bus_service.delete_topic("test-topic")
```

При удалении раздела также удаляются все подписки, зарегистрированные в этом разделе. Подписки также можно удалять по отдельности. В следующем примере кода показано, как удалить подписку с именем high-messages из раздела test-topic:

```
azure_service_bus_service.delete_subscription("test-topic", "high-messages")
```

## <a name="next-steps"></a>Дальнейшие действия

Вы узнали основные сведения о разделах служебной шины. Для получения дополнительных сведений используйте следующие ссылки.

- См. статью [Очереди, разделы и подписки](service-bus-queues-topics-subscriptions.md).
- Справочник API для [SqlFilter](http://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.sqlfilter.aspx).
- Посетите репозиторий [Azure SDK для Ruby](https://github.com/Azure/azure-sdk-for-ruby) на веб-сайте GitHub.
 
[портал Azure]: https://portal.azure.com



<!--HONumber=Oct16_HO2-->


