---
title: Устранение ошибок c помощью модулей Runbook службы автоматизации Azure
description: Подробные сведения об устранении ошибок c помощью модулей Runbook службы автоматизации Azure
services: automation
author: georgewallace
ms.author: gwallace
ms.date: 07/13/2018
ms.topic: conceptual
ms.service: automation
manager: carmonm
ms.openlocfilehash: 53b35fbdc469639b1fdc09293e05247bcc5d8c31
ms.sourcegitcommit: d16b7d22dddef6da8b6cfdf412b1a668ab436c1f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/08/2018
ms.locfileid: "39714491"
---
# <a name="troubleshoot-errors-with-runbooks"></a>Устранение ошибок c помощью модулей Runbook

## <a name="authentication-errors-when-working-with-azure-automation-runbooks"></a>Ошибки, связанные с аутентификацией, при работе с модулями Runbook службы автоматизации Azure

### <a name="sign-in-failed"></a>Сценарий: не удается войти в учетную запись Azure

#### <a name="issue"></a>Проблема

При работе с командлетом `Add-AzureAccount` или `Connect-AzureRmAccount` будет получена следующая ошибка.
:

```
Unknown_user_type: Unknown User Type
```

#### <a name="cause"></a>Причина:

Ошибка возникает, если указаны недопустимые имя ресурса учетных данных или имя пользователя и пароль, которые использовались для настройки ресурса учетных данных службы автоматизации.

#### <a name="resolution"></a>Способы устранения:

Чтобы определить источник проблемы, необходимо выполнить следующие действия.  

1. Убедитесь, что в имени ресурса-контейнера учетных данных службы автоматизации, используемом для подключения к Azure, отсутствуют специальные знаки, включая **@** .  
2. Убедитесь, что вы можете использовать имя пользователя и пароль, которые хранятся в учетных данных службы автоматизации Azure в редакторе локальной интегрированной среды сценариев PowerShell. Для этого в интегрированной среде сценариев PowerShell выполните следующие командлеты:  

   ```powershell
   $Cred = Get-Credential  
   #Using Azure Service Management
   Add-AzureAccount –Credential $Cred  
   #Using Azure Resource Manager  
   Connect-AzureRmAccount –Credential $Cred
   ```

3. Локальный сбой проверки подлинности означает, что учетные данные Azure Active Directory были указаны неправильно. Сведения о том, как правильно настроить учетную запись Azure Active Directory, см. в записи блога об [аутентификации в Azure с помощью Azure Active Directory](https://azure.microsoft.com/blog/azure-automation-authenticating-to-azure-using-azure-active-directory/).  

4. Если это временная ошибка, попробуйте добавить логику повторных попыток в процедуру проверки подлинности, чтобы сделать ее более надежной.

   ```powershell
   # Get the connection "AzureRunAsConnection"
   $connectionName = "AzureRunAsConnection"
   $servicePrincipalConnection = Get-AutomationConnection -Name $connectionName

   $logonAttempt = 0
   $logonResult = $False

   while(!($connectionResult) -And ($logonAttempt -le 10))
   {
   $LogonAttempt++
   # Logging in to Azure...
   $connectionResult = Connect-AzureRmAccount `
      -ServicePrincipal `
      -TenantId $servicePrincipalConnection.TenantId `
      -ApplicationId $servicePrincipalConnection.ApplicationId `
      -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint

   Start-Sleep -Seconds 30
   }
   ```

### <a name="unable-to-find-subscription"></a>Сценарий: не удается найти подписку Azure

#### <a name="issue"></a>Проблема

При работе с командлетом `Select-AzureSubscription` или `Select-AzureRmSubscription` будет получена следующая ошибка.

```
The subscription named <subscription name> cannot be found.
```

#### <a name="error"></a>Ошибка

Эта ошибка возникает, если указано недействительное имя подписки, а также если пользователь Azure Active Directory, который пытается получить сведения о подписке, не является ее администратором.

#### <a name="resolution"></a>Способы устранения:

Чтобы определить, что проверка подлинности в Azure пройдена и доступ к требуемой подписке получен, сделайте следующее.  

1. Убедитесь, что вы выполняете командлет **Add-AzureAccount** перед командлетом **Select-AzureSubscription**.  
2. Если это сообщение об ошибке не исчезло, измените код, добавив командлет **Get-AzureSubscription** после командлета **Add-AzureAccount**, а затем выполните код. Теперь проверьте, содержат ли выходные данные командлета Get-AzureSubscription сведения о подписке.  

   * Если вы не видите сведения о подписке в выходных данных, это означает, что подписка еще не инициализирована.  
   * Если сведения о подписке отображаются в выходных данных, убедитесь, что с командлетом **Select-AzureSubscription** используется правильное имя или идентификатор подписки.

### <a name="auth-failed-mfa"></a>Сценарий: не удается выполнить проверку подлинности в Azure из-за включенной многофакторной проверки подлинности

#### <a name="issue"></a>Проблема

При аутентификации в Azure с помощью своего имени и пароля вы получаете следующую ошибку:

```
Add-AzureAccount: AADSTS50079: Strong authentication enrollment (proof-up) is required
```

#### <a name="cause"></a>Причина:

Если в учетной записи Azure активирована многофакторная проверка подлинности, применять учетную запись пользователя Azure Active Directory для аутентификации в Azure нельзя. Вместо этого при проверке подлинности в Azure используйте сертификат или субъект-службу.

#### <a name="resolution"></a>Способы устранения:

Сведения об использовании сертификата с командлетами классической модели развертывания Azure см. в руководстве по [созданию и добавлению сертификатов для управления службами Azure](http://blogs.technet.com/b/orchestrator/archive/2014/04/11/managing-azure-services-with-the-microsoft-azure-automation-preview-service.aspx) Сведения об использовании субъекта-службы с командлетами диспетчера ресурсов Azure см. в статьях о [создании субъекта-службы с помощью портала Azure](../../azure-resource-manager/resource-group-create-service-principal-portal.md) и [аутентификации субъекта-службы в диспетчере ресурсов Azure](../../azure-resource-manager/resource-group-authenticate-service-principal.md).

## <a name="common-errors-when-working-with-runbooks"></a>Распространенные ошибки при работе с модулями Runbook

### <a name="task-was-cancelled"></a>Сценарий. Выполнение модуля Runbook завершается ошибкой отмены задачи

#### <a name="issue"></a>Проблема

В модуле Runbook возникает ошибка, аналогичная приведенной ниже:

```
Exception: A task was canceled.
```

#### <a name="cause"></a>Причина:

Это ошибка может быть вызвана использованием устаревших модулей Azure.

#### <a name="resolution"></a>Способы устранения:

Эту ошибку можно устранить, обновив модули Azure до последней версии.

В учетной записи службы автоматизации щелкните **Модули** и **Обновить модули Azure**. Обновление занимает примерно 15 минут. После его завершения перезапустите проблемный модуль.

### <a name="not-recognized-as-cmdlet"></a>Сценарий: сбой модуля Runbook из-за отсутствующего командлета

#### <a name="issue"></a>Проблема

В модуле Runbook возникает ошибка, аналогичная приведенной ниже:

```
The term 'Connect-AzureRmAccount' is not recognized as the name of a cmdlet, function, script file, or operable program.  Check the spelling of the name, or if the path was included verify that the path is correct and try again.
```

#### <a name="cause"></a>Причина:

Ошибка может быть вызвана следующими причинами.

1. Модуль, содержащий командлет, не импортирован в учетную запись службы автоматизации
2. Модуль, содержащий командлет, импортирован, но устарел

#### <a name="resolution"></a>Способы устранения:

Эту ошибку можно устранить, выполнив одну из следующих задач:

Если модуль является модулем Azure, см. раздел [Как обновить модули Azure PowerShell в службе автоматизации Azure](../automation-update-azure-modules.md), чтобы узнать, как обновить модули в учетной записи службы автоматизации.

Если это отдельный модуль, убедитесь, что он импортирован в учетную запись службы автоматизации.

### <a name="job-attempted-3-times"></a>Сценарий: было предпринято три попытки запуска задания Runbook, но все они были неудачными

#### <a name="issue"></a>Проблема

Выполнение модуля Runbook завершилось ошибкой.

```
The job was tried three times but it failed
```

#### <a name="cause"></a>Причина:

Ошибка может быть вызвана следующими причинами.

1. Предельный объем памяти. Есть [ограничения](../../azure-subscription-service-limits.md#automation-limits) на объемы памяти, выделяемые для песочницы службы автоматизации, поэтому задание может завершиться ошибкой, если оно использует более 400 МБ памяти.

2. Модуль несовместим. Такая ситуация может возникать, если зависимости модуля заданы неправильно. В этом случае модуль Runbook обычно возвращает сообщение об ошибке "Команда не найдена" или "Не удается привязать параметр".

#### <a name="resolution"></a>Способы устранения:

Эту проблему можно устранить одним из следующих способов.

* Чтобы работа выполнялась в заданных пределах объема памяти, рекомендуется разделить рабочую нагрузку между несколькими модулями Runbook, не обрабатывать слишком большой объем данных в памяти, не записывать ненужные выходные данные из модулей Runbook или учитывать, сколько контрольных точек записывается в модули Runbook рабочих процессов PowerShell.  

* Обновите модули Azure с помощью действий, описанных в статье [How to update Azure PowerShell modules in Azure Automation](../automation-update-azure-modules.md) (Как обновить модули Azure PowerShell в службе автоматизации Azure).  

### <a name="fails-deserialized-object"></a>Сценарий: сбой модуля Runbook из-за десериализованного объекта

#### <a name="issue"></a>Проблема

Выполнение модуля Runbook завершилось ошибкой.

```
Cannot bind parameter <ParameterName>.

Cannot convert the <ParameterType> value of type Deserialized <ParameterType> to type <ParameterType>.
```

#### <a name="cause"></a>Причина:

Когда модуль Runbook является рабочим процессом PowerShell, он хранит сложные объекты в десериализированном формате. Это позволяет сохранить состояние модуля при приостановке рабочего процесса.

#### <a name="resolution"></a>Способы устранения:

При использовании одного из трех следующих способов проблема будет устранена.

1. Если сложные объекты передаются от одного командлета к другому через конвейер, включите эти командлеты в InlineScript.
2. Передайте только требуемое имя или значение сложного объекта, а не весь объект.
3. Используйте модуль Runbook PowerShell, а не модуль Runbook рабочего процесса PowerShell.

### <a name="quota-exceeded"></a>Сценарий: не удается выполнить задание модуля Runbook из-за превышения выделенной квоты

#### <a name="issue"></a>Проблема

Выполнение задания Runbook завершилось ошибкой.

```
The quota for the monthly total job run time has been reached for this subscription
```

#### <a name="cause"></a>Причина:

Эта ошибка возникает, когда время выполнения задания превышает квоту для учетной записи в 500 бесплатных минут. Эта квота применяется ко всем типам задач при выполнении задания, включая тестирование задания, запуск задания на портале, выполнение задания с помощью веб-перехватчиков, а также планирование задания с помощью портала Azure или центра обработки данных. Дополнительные сведения см. на странице [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

#### <a name="resolution"></a>Способы устранения:

Если на обработку задач вам требуется более 500 минут в месяц, выберите для подписки уровень "Базовый" вместо уровня "Бесплатный". Это можно сделать так.  

1. Войдите в свою подписку Azure.  
2. Выберите учетную запись службы автоматизации, которую вы хотите обновить.  
3. Щелкните **Параметры** > **Цены**.
4. Нажмите кнопку **Включить** в нижней части страницы, чтобы обновить свою учетную запись до уровня **Базовый**.

### <a name="cmdlet-not-recognized"></a>Сценарий: не удается распознать командлет при выполнении модуля Runbook

#### <a name="issue"></a>Проблема

Выполнение задания Runbook завершилось ошибкой.

```
<cmdlet name>: The term <cmdlet name> is not recognized as the name of a cmdlet, function, script file, or operable program.
```

#### <a name="cause"></a>Причина:

Эта ошибка возникает, когда модулю PowerShell не удается найти командлет, который используется в модуле Runbook. Такое случается, когда в учетной записи отсутствует модуль, содержащий командлет, когда возникает конфликт имен с именем модуля Runbook, а также когда командлет существует и в другом модуле, а службе автоматизации не удается разрешить имя.

#### <a name="resolution"></a>Способы устранения:

Эту проблему можно устранить одним из следующих способов.  

* Проверьте правильность ввода имени командлета.  
* Убедитесь, что командлет существует в учетной записи службы автоматизации, а конфликты отсутствуют. Чтобы проверить наличие командлета, откройте модуль Runbook в режиме редактирования и найдите требуемый командлет в библиотеке или выполните команду `Get-Command <CommandName>`. Убедившись в наличии командлета в учетной записи и отсутствии конфликта имен с другими командлетами или модулями Runbook, добавьте его на холст. При этом в модуле Runbook должен использоваться допустимый набор параметров.  
* Если обнаружен конфликт имен, а сам командлет доступен в двух разных модулях, проблему можно решить использованием полного имени командлета. Например, можно использовать следующий формат: **имя_модуля\имя_командлета**.  
* Если модуль Runbook выполняется на локальном компьютере в гибридном компоненте Worker, на компьютере с гибридным компонентом Worker должен быть установлен соответствующий модуль или командлет.

### <a name="evicted-from-checkpoint"></a>Сценарий: долго работающий модуль Runbook постоянно выдает исключение "Невозможно продолжить выполнение задания, поскольку оно было несколько раз прекращено по достижении той же самой контрольной точки"

#### <a name="issue"></a>Проблема

Эта реакция на событие связана с мониторингом "справедливого распределения" процессов в службе автоматизации Azure, которая автоматически приостанавливает любой модуль Runbook, который выполняется дольше 3 часов. В то же время сообщение об ошибке не дает пользователю варианты дальнейших действий.

#### <a name="cause"></a>Причина:

Модуль Runbook может быть приостановлен по целому ряду причин. Чаще всего приостановка связана с какой-либо ошибкой. Например, неперехваченное исключение в модуле Runbook, сетевая ошибка или сбой компонента Runbook Worker в модуле Runbook приводят к его остановке. При возобновлении модуль запускается с последней контрольной точки.

#### <a name="resolution"></a>Способы устранения:

Задокументированный способ предотвращения этой проблемы — использовать в рабочем процессе контрольные точки. Дополнительные сведения см. в статье [Изучение рабочего процесса Windows PowerShell](../automation-powershell-workflow.md#checkpoints). Более подробно справедливое распределение процессов и контрольные точки описываются в записи блога [Azure Automation: Reliable, Fault-Tolerant Runbook Execution Using Checkpoints](https://azure.microsoft.com/blog/azure-automation-reliable-fault-tolerant-runbook-execution-using-checkpoints/) (Служба автоматизации Azure: надежное и отказоустойчивое выполнение модулей Runbook с помощью контрольных точек).

### <a name="long-running-runbook"></a>Сценарий. Длительный модуль Runbook не выполняется

#### <a name="issue"></a>Проблема

Эта реакция на событие в песочницах Azure связана с мониторингом "справедливого распределения" процессов в службе автоматизации Azure, которая автоматически приостанавливает любой модуль Runbook, который выполняется дольше 3 часов.

#### <a name="cause"></a>Причина:

Модуль Runbook выполнялся дольше трехчасового ограничения, заданного справедливым распределением в песочнице Azure

#### <a name="resolution"></a>Способы устранения:

Рекомендуемое решение — запустить модуль Runbook в [гибридной рабочей роли Runbook](../automation-hrw-run-runbooks.md). Гибридные рабочие роли не ограничены тремя часами [справедливого распределения](../automation-runbook-execution.md#fair-share), как в песочницах Azure.

## <a name="common-errors-when-importing-modules"></a>Распространенные ошибки при импорте модулей

### <a name="module-fails-to-import"></a>Сценарий: не удается импортировать модуль или после импорта не выполняются командлеты

#### <a name="issue"></a>Проблема

Модулю не удается осуществить импорт, либо импорт выполнен успешно, но командлеты не извлекаются.

#### <a name="cause"></a>Причина:

Ниже приведены наиболее распространенные причины, из-за которых модуль не может успешно завершить импорт в службу автоматизации Azure.

* Структура не соответствует той, которая требуется для службы автоматизации.
* Модуль зависит от другого модуля, который не был развернут для учетной записи службы автоматизации.
* В папке отсутствуют зависимости модуля.
* Командлет `New-AzureRmAutomationModule` используется для передачи модуля, при этом полный путь для хранения не указан или модуль не загружен с помощью общедоступного URL-адреса.

#### <a name="resolution"></a>Способы устранения:

Эту проблему можно устранить одним из следующих способов.

* Убедитесь, что модуль имеет следующий формат: имя_модуля.Zip **->** имя_модуля или номер_версии **->** (ModuleName.psm1, ModuleName.psd1).
* Откройте файл PSD1 и проверьте, есть ли у модуля зависимости. Если зависимости есть, отправьте эти модули в учетную запись службы автоматизации.
* Убедитесь, что все указанные библиотеки DLL находятся в папке модуля.

## <a name="next-steps"></a>Дополнительная информация

Если вы не видите своего варианта проблемы или вам не удается ее решить, дополнительные сведения можно получить, посетив один из следующих каналов.

* Получите ответы специалистов Azure на [форумах Azure](https://azure.microsoft.com/support/forums/).
* Подключитесь к [@AzureSupport](https://twitter.com/azuresupport) — официальной учетной записи Microsoft Azure. Она помогает оптимизировать работу пользователей благодаря возможности доступа к ресурсам сообщества Azure (ответы на вопросы, поддержка и консультации специалистов).
* Если вам нужна дополнительная помощь, отправьте запрос в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**.