<properties
    pageTitle="Решение для запуска и остановки виртуальных машин в нерабочее время [предварительная версия] | Microsoft Azure"
    description="Решения по управлению запуском и остановкой виртуальных машин Azure Resource Manager по расписанию и упреждающему мониторингу с помощью Log Analytics."
    services="automation"
    documentationCenter=""
    authors="MGoedtel"
    manager="jwhit"
    editor=""
	/>
<tags
    ms.service="automation"
    ms.workload="tbd"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="get-started-article"
    ms.date="10/04/2016"
    ms.author="magoedte"/>

# Решение для запуска и остановки виртуальных машин в нерабочее время [предварительная версия] в службе автоматизации

Решение для запуска и остановки виртуальных машин в нерабочее время (предварительная версия) позволяет запускать и останавливать виртуальные машины Azure Resource Manager по определенному пользователем расписанию, а также предоставляет сведения о состоянии заданий службы автоматизации по запуску и остановке ВМ с помощью OMS Log Analytics.

## Предварительные требования

- Для проверки подлинности модулей Runbook используется [учетная запись запуска от имени Azure](automation-sec-configure-azure-runas-account.md). Этот метод проверки подлинности считается самым оптимальным, так как он использует сертификат, а не пароль, который может устареть или часто меняться.

- С помощью этого решения можно управлять только теми виртуальными машинами, которые принадлежат к той же подписке или группе ресурсов, что и учетная запись службы автоматизации.

- Это решение можно развернуть в следующих регионах: юго-восточная Австралия, восточная часть США, Юго-Восточная Азия и Западная Европа. Модули Runbook, используемые для управления расписанием, могут определять виртуальные машины в любом регионе.

- Чтобы настроить отправление электронных уведомлений о выполнении модулями Runbook заданий остановки и запуска виртуальной машины, требуется подписка Office 365 бизнес-класса.

## Компоненты решения

В состав этого решения входят следующие ресурсы, которые импортируются и добавляются в учетную запись службы автоматизации.

### Модули Runbook

Модуль Runbook | Описание|
--------|------------|
CleanSolution-MS-Mgmt-VM | Удаляет все содержащиеся ресурсы и планирует время удаления решения из подписки.|  
SendMailO365-MS-Mgmt | Отправляет сообщение электронной почты с помощью Office 365 Exchange.|
StartByResourceGroup-MS-Mgmt-VM | Запускает виртуальные машины (классические и ARM), которые находятся в определенном списке групп ресурсов Azure.
StopByResourceGroup-MS-Mgmt-VM | Останавливает виртуальные машины (классические и ARM), которые находятся в определенном списке групп ресурсов Azure.|
<br>

### Переменные

Переменная | Описание|
---------|------------|
Модуль Runbook **SendMailO365-MS-Mgmt** ||
SendMailO365-IsSendEmail-MS-Mgmt | Определяет, могут ли модули Runbook StartByResourceGroup-MS-Mgmt-VM и StopByResourceGroup-MS-Mgmt-VM отправлять уведомления по электронной почте после завершения. Чтобы включить отправление оповещений по электронной почте, выберите значение **True**, а чтобы отключить — **False**. Значение по умолчанию — **False**.| 
Модуль Runbook **StartByResourceGroup-MS-Mgmt-VM** ||
StartByResourceGroup-ExcludeList-MS-Mgmt-VM | Введите имена виртуальных машин, которые нужно исключить из операции управления, используя в качестве разделителя точку с запятой (;). В значениях учитывается регистр и может использоваться подстановочный знак (звездочка).|
StartByResourceGroup-SendMailO365-EmailBodyPreFix-MS-Mgmt | Текст, который можно добавить в начало сообщения электронной почты.|
StartByResourceGroup-SendMailO365-EmailRunBookAccount-MS-Mgmt | Указывает имя учетной записи службы автоматизации, содержащей модуль Runbook для электронной почты. **Не изменяйте эту переменную.**|
StartByResourceGroup-SendMailO365-EmailRunbookName-MS-Mgmt | Указывает имя модуля Runbook для электронной почты. Используется модулями Runbook StartByResourceGroup-MS-Mgmt-VM и StopByResourceGroup-MS-Mgmt-VM для отправки сообщений электронной почты. **Не изменяйте эту переменную.**|
StartByResourceGroup-SendMailO365-EmailRunbookResourceGroup-MS-Mgmt | Указывает имя группы ресурсов, содержащей модуль Runbook для электронной почты. **Не изменяйте эту переменную.**|
StartByResourceGroup-SendMailO365-EmailSubject-MS-Mgmt | Указывает текст темы сообщения электронной почты.|  
StartByResourceGroup-SendMailO365-EmailToAddress-MS-Mgmt | Указывает получателей сообщения электронной почты. В качестве разделителя имен используйте точку с запятой (;).|
StartByResourceGroup-TargetResourceGroups-MS-Mgmt-VM | Введите имена виртуальных машин, которые нужно исключить из операции управления, используя в качестве разделителя точку с запятой (;). В значениях учитывается регистр и может использоваться подстановочный знак (звездочка). При использовании значения по умолчанию (звездочка) в подписку будут включены все группы ресурсов.|
StartByResourceGroup-TargetSubscriptionID-MS-Mgmt-VM | Указывает подписку, содержащую виртуальные машины, управление которыми будет осуществляться с помощью этого решения. Это должна быть та же подписка, в которой находится учетная запись службы автоматизации этого решения.|
Модуль Runbook **StopByResourceGroup-MS-Mgmt-VM** ||
StopByResourceGroup-ExcludeList-MS-Mgmt-VM | Введите имена виртуальных машин, которые нужно исключить из операции управления, используя в качестве разделителя точку с запятой (;). В значениях учитывается регистр и может использоваться подстановочный знак (звездочка).|
StopByResourceGroup-SendMailO365-EmailBodyPreFix-MS-Mgmt | Текст, который можно добавить в начало сообщения электронной почты.|
StopByResourceGroup-SendMailO365-EmailRunBookAccount-MS-Mgmt | Указывает имя учетной записи службы автоматизации, содержащей модуль Runbook для электронной почты. **Не изменяйте эту переменную.**|
StopByResourceGroup-SendMailO365-EmailRunbookResourceGroup-MS-Mgmt | Указывает имя группы ресурсов, содержащей модуль Runbook для электронной почты. **Не изменяйте эту переменную.**|
StopByResourceGroup-SendMailO365-EmailSubject-MS-Mgmt | Указывает текст темы сообщения электронной почты.|  
StopByResourceGroup-SendMailO365-EmailToAddress-MS-Mgmt | Указывает получателей сообщения электронной почты. В качестве разделителя имен используйте точку с запятой (;).|
StopByResourceGroup-TargetResourceGroups-MS-Mgmt-VM | Введите имена виртуальных машин, которые нужно исключить из операции управления, используя в качестве разделителя точку с запятой (;). В значениях учитывается регистр и может использоваться подстановочный знак (звездочка). При использовании значения по умолчанию (звездочка) в подписку будут включены все группы ресурсов.|
StopByResourceGroup-TargetSubscriptionID-MS-Mgmt-VM | Указывает подписку, содержащую виртуальные машины, управление которыми будет осуществляться с помощью этого решения. Это должна быть та же подписка, в которой находится учетная запись службы автоматизации этого решения.|  
<br>

### Расписания

Расписание | Описание|
---------|------------|
StartByResourceGroup-Schedule-MS-Mgmt | Расписание выполнения модуля Runbook StartByResourceGroup.|
StopByResourceGroup-Schedule-MS-Mgmt | Расписание выполнения модуля Runbook StopByResourceGroup.|

### Учетные данные

Учетные данные | Описание|
-----------|------------|
O365Credential | Указывает действительную учетную запись пользователя Office 365 для отправки сообщения электронной почты. Требуется, только если для переменной SendMailO365-IsSendEmail-MS-Mgmt задано значение **True**.

## Конфигурация

Выполните следующие действия, чтобы добавить решение для запуска и остановки виртуальных машин в нерабочее время [предварительная версия] в собственную учетную запись службы автоматизации, а затем настроить его.

1. На начальном экране портала Azure выберите плитку **Магазин**. Если эта плитка не закреплена на начальном экране, на панели навигации слева выберите **Создать**.
2. В колонке "Магазин" в поле поиска введите **Start VM** (Запустить виртуальную машину), а затем в результатах поиска выберите **Start/Stop VMs during off-hours [Preview]** (Запустить или остановить виртуальные машины в нерабочее время [предварительная версия]).
3. В колонке **Start/Stop VMs during off-hours [Preview]** (Запуск или остановка виртуальных машин в нерабочее время [предварительная версия]) просмотрите сводные данные для выбранного решения и щелкните **Создать**.
4. Откроется колонка **Добавление решения**, где можно настроить решение перед его отправкой в подписку службы автоматизации.<br><br> ![Колонка "Добавление решения" в решении по управлению виртуальными машинами](media/automation-solution-vm-management/vm-management-solution-add-solution-blade.png)<br><br>
5.  В колонке **Добавление решения** щелкните **Рабочая область** и выберите рабочую область OMS, связанную с подпиской Azure, в которой находится учетная запись службы автоматизации, или создайте новую. Если у вас нет рабочей области OMS, выберите **Создать рабочую область** и в колонке **OMS Workspace** (Рабочая область OMS) выполните следующие действия:
   - Укажите имя новой **рабочей области OMS**.
   - Выберите в раскрывающемся списке **подписку**, с которой нужно связать рабочую область, если выбранная по умолчанию не подходит.
   - В качестве **группы ресурсов** можно использовать имеющуюся группу или создать новую.
   - Выберите **расположение**. В настоящее время поддерживаются следующие расположения: **юго-восточная Австралия**, **восточная часть США**, **Юго-Восточная Азия** и **Западная Европа**.
   - Выберите **ценовую категорию**. Решение предоставляется на двух уровнях: бесплатном и платном (OMS). Бесплатный уровень имеет ограничение на ежедневный сбор данных, срок хранения и время выполнения задания Runbook. На платном уровне (OMS) ограничение по объему ежедневно собираемых данных отсутствует.

        > [AZURE.NOTE]
        > While the Stadalone paid tier is displayed as an option, it is not applicable.  If you select it and proceed with the creation of this solution in your subscription, it will fail.  This will be addressed when this solution is officially released.<br>If you use this solution, it will only use automation job minutes and log ingestion.  The solution does not add additional OMS nodes to your environment.  

6. После ввода необходимых сведений в колонке **OMS Workspace** (Рабочая область OMS) щелкните **Создать**. Пока проверяются данные, ход создания рабочей области можно проверить в разделе **Уведомления** в меню. Затем вы вернитесь в колонку **Добавление решения**.
7. В колонке **Добавление решения** выберите **Учетная запись автоматизации**. При создании рабочей области OMS требуется также создать новую учетную запись службы автоматизации, которая будет связана с указанной ранее новой рабочей областью OMS, в том числе подписку Azure, группу ресурсов и регион. Выберите **Создать учетную запись службы автоматизации** и в колонке **Добавление учетной записи службы автоматизации** укажите следующие данные:
  - В поле **Имя** введите имя учетной записи службы автоматизации.

    Все остальные параметры заполняются автоматически в зависимости от выбранной рабочей области OMS, и их нельзя изменить. По умолчанию проверка подлинности модулей Runbook, добавленных в это решение, осуществляется с помощью учетной записи запуска от имени Azure. Нажмите кнопку **OК**, чтобы проверить параметры конфигурации и создать учетную запись службы автоматизации. Ход создания можно просмотреть в разделе **Уведомления** в меню.

    В противном случае можно выбрать имеющуюся учетную запись запуска от имени службы автоматизации. Обратите внимание, что выбранная учетная запись не может быть связана с другой рабочей областью OMS. Если она уже связана, в колонке отобразится сообщение. В этом случае нужно выбрать другую учетную запись запуска от имени службы автоматизации или создать новую.<br><br> ![Учетная запись службы автоматизации, связанная с рабочей областью OMS](media/automation-solution-vm-management/vm-management-solution-add-solution-blade-autoacct-warning.png)<br>

8. Наконец, в колонке **Добавление решения** выберите **Конфигурация**. Откроется колонка **Параметры**. В колонке **Параметры** вам будет предложено:
   - Указать **имена целевых групп ресурсов** — имена групп ресурсов, содержащих виртуальные машины, управление которыми будет осуществляться с помощью этого решения. Вы можете указать несколько имен, используя в качестве разделителя точку с запятой (в значениях учитывается регистр). Если необходимо использовать виртуальные машины во всех группах ресурсов в рамках подписки, используйте подстановочный знак.
   - Выбрать **расписание** — повторяющуюся дату и время запуска (остановки) виртуальных машин в целевых группах ресурсов.

10. Завершив начальную настройку параметров решения, щелкните **Создать**. После этого будут проверены все параметры, а также будет произведена попытка развернуть решение в подписку. Этот процесс может занять несколько секунд. Ход его выполнения можно просмотреть в разделе **Уведомления** в меню.

## Частота сбора

Журнал заданий службы автоматизации и потоковые данные заданий отправляются в репозиторий OMS каждые пять минут.

## Использование решения

При добавлении решения по управлению виртуальными машинами в рабочую область OMS на панель мониторинга OMS добавляется плитка **StartStopVM View** (Представление запуска и остановки виртуальных машин). Здесь отображаются сведения о количестве заданий Runbook для запущенного и завершенного решения, а также их графическое представление.<br><br> ![Плитка StartStopVM View (Представление запуска и остановки виртуальных машин) в решении по управлению виртуальными машинами](media/automation-solution-vm-management/vm-management-solution-startstopvm-view-tile.png)

Чтобы открыть решение и управлять им, выберите в учетной записи службы автоматизации плитку **Решения**, а затем в колонке **Решения** выберите в списке **Start-Stop-VM[Workspace]**.<br><br> ![Список решений службы автоматизации](media/automation-solution-vm-management/vm-management-solution-autoaccount-solution-list.png)

После этого откроется колонка решения **Start-Stop-VM[Workspace]**, где можно просмотреть важные сведения, например отображаемые на плитке **StartStopVM View** (Представление запуска и остановки виртуальных машин), как в рабочей области OMS (то есть сведения о количестве заданий Runbook для запущенного и завершенного решения, а также их графическое представление).<br><br> ![Колонка решения для запуска и остановки виртуальных машин в службе автоматизации](media/automation-solution-vm-management/vm-management-solution-solution-blade.png)

### Настройка получения уведомлений по электронной почте

Чтобы включить получение электронных уведомлений о выполнении модулями Runbook заданий остановки и запуска виртуальной машины, необходимо изменить учетные данные **O365Credential** и задать по крайней мере следующие переменные:

 - SendMailO365-IsSendEmail-MS-Mgmt;
 - StartByResourceGroup-SendMailO365-EmailToAddress-MS-Mgmt;
 - StopByResourceGroup-SendMailO365-EmailToAddress-MS-Mgmt.

Чтобы настроить учетные данные **O365Credential**, выполните следующие действия:

1. Из учетной записи службы автоматизации щелкните **Все параметры** в верхней части окна.
2. В колонке **Параметры** в разделе **Ресурсы службы автоматизации** выберите **Ресурсы**.
3. В колонке **Ресурсы** щелкните плитку **Учетные данные** и в **открывшейся колонке** выберите **O365Credential**.
4. Введите допустимое имя пользователя и пароль Office 365, а затем щелкните **Сохранить**, чтобы сохранить изменения.

Чтобы настроить переменные, упомянутые ранее, выполните следующие действия:

1. Из учетной записи службы автоматизации щелкните **Все параметры** в верхней части окна.
2. В колонке **Параметры** в разделе **Ресурсы службы автоматизации** выберите **Ресурсы**.
3. В колонке **Ресурсы** щелкните плитку **Переменные** и в **открывшейся колонке** выберите указанную выше переменную и измените ее значение, следуя описанию в разделе [Переменная](##variables).
4. Чтобы сохранить изменения, щелкните **Сохранить**.

## Записи Log Analytics

Служба автоматизации создает в репозитории OMS записи двух типов.

### Журналы заданий

Свойство | Описание|
----------|----------|
Caller | Сторона, инициировавшая операцию. Допустимые значения: электронный адрес или system для запланированных заданий.|
Категория | Классификация типа данных. Для службы автоматизации значением является JobLogs.|
CorrelationId | GUID, представляющий собой идентификатор корреляции задания Runbook.|
JobId | GUID, представляющий собой идентификатор задания Runbook.|
operationName | Указывает тип операции, выполняемой в Azure. Для службы автоматизации значением будет Job.|
resourceId | Указывает тип ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
ResourceGroup | Указывает имя группы ресурсов задания Runbook.|
ResourceProvider | Указывает службу Azure, которая предоставляет ресурсы для развертывания и управления. Для службы автоматизации значением будет Azure Automation.|
ResourceType | Указывает тип ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
resultType | Состояние задания Runbook. Возможные значения:<br>- Started<br>- Stopped<br>- Suspended<br>- Failed<br>- Succeeded.|
resultDescription | Описывает состояние результата задания Runbook. Возможные значения:<br>- Job is started<br>- Job Failed<br>- Job Completed.|
RunbookName | Указывает имя модуля Runbook.|
SourceSystem | Указывает исходную систему для отправленных данных. Для службы автоматизации значением будет :OpsManager.|
StreamType | Задает тип события. Возможные значения:<br>— Verbose;<br>— Output;<br>— Error;<br>— Warning.|
SubscriptionId | Указывает идентификатор подписки задания.
Время | Дата и время выполнения задания Runbook.|


### Потоки заданий

Свойство | Описание|
----------|----------|
Caller | Сторона, инициировавшая операцию. Допустимые значения: электронный адрес или system для запланированных заданий.|
Категория | Классификация типа данных. Для службы автоматизации значением является JobStreams.|
JobId | GUID, представляющий собой идентификатор задания Runbook.|
operationName | Указывает тип операции, выполняемой в Azure. Для службы автоматизации значением будет Job.|
ResourceGroup | Указывает имя группы ресурсов задания Runbook.|
resourceId | Указывает идентификатор ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
ResourceProvider | Указывает службу Azure, которая предоставляет ресурсы для развертывания и управления. Для службы автоматизации значением будет Azure Automation.|
ResourceType | Указывает тип ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
resultType | Результат задания Runbook во время создания события. Допустимые значения:<br>- InProgress.|
resultDescription | Включает в себя выходной поток из Runbook.|
RunbookName | Имя Runbook.|
SourceSystem | Указывает исходную систему для отправленных данных. Для службы автоматизации значением будет OpsManager.|
StreamType | Тип потока задания. Допустимые значения:<br>-Progress<br>- Output<br>- Warning<br>- Error<br>- Debug<br>- Verbose.|
Время | Дата и время выполнения задания Runbook.|

При выполнении поиска по журналу, в результате которого возвращаются записи категории **JobLogs** или **JobStreams**, можно выбрать представление **JobLogs** или **JobStreams**. Эти представления отображают набор плиток с перечнем обновлений, возвращенных в результатах поиска.

## Пример поисков журналов

Следующая таблица содержит примеры поисков по журналу для получения записей заданий, собранных этим решением.

Запрос | Описание|
----------|----------|
Поиск заданий для успешно завершенного модуля Runbook StartVM | Category=JobLogs RunbookName\_s="StartByResourceGroup-MS-Mgmt-VM" ResultType=Succeeded | measure count() by JobId\_g|
Поиск заданий для успешно завершенного модуля Runbook StopVM | Category=JobLogs RunbookName\_s="StartByResourceGroup-MS-Mgmt-VM" ResultType=Failed | measure count() by JobId\_g
Показать состояние задания по времени для модулей Runbook StartVM и StopVM | Category=JobLogs RunbookName\_s="StartByResourceGroup-MS-Mgmt-VM" OR "StopByResourceGroup-MS-Mgmt-VM" NOT(ResultType="started") | measure Count() by ResultType interval 1day|

## Дальнейшие действия

- Чтобы узнать больше о том, как создавать различные поисковые запросы и просматривать журналы заданий службы автоматизации с помощью Log Analytics, ознакомьтесь с разделом [Поиск по журналам в Log Analytics](../log-analytics/log-analytics-log-searches.md).
- Чтобы узнать больше о выполнении модулей Runbook, отслеживании заданий Runbook и других технических деталях, ознакомьтесь с [отслеживанием задания Runbook](automation-runbook-execution.md).
- Чтобы узнать больше о Log Analytics (OMS) и источниках сбора данных, ознакомьтесь с разделом [Подключение службы Azure к Log Analytics](../log-analytics/log-analytics-azure-storage.md)






   

<!---HONumber=AcomDC_1005_2016-->