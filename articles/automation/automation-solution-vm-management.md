---
title: Решение для запуска и остановки виртуальных машин в нерабочее время (предварительная версия)
description: Решение по управлению виртуальными машинами запускает и останавливает виртуальные машины Azure Resource Manager по расписанию и осуществляет упреждающий мониторинг с помощью Log Analytics.
services: automation
ms.service: automation
author: georgewallace
ms.author: gwallace
ms.date: 03/16/2018
ms.topic: article
manager: carmonm
ms.openlocfilehash: ec15859a92527c4e084075b40d3439d7a19fea1a
ms.sourcegitcommit: a36a1ae91968de3fd68ff2f0c1697effbb210ba8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/17/2018
---
# <a name="startstop-vms-during-off-hours-solution-preview-in-azure-automation"></a>Решение для запуска и остановки виртуальных машин в нерабочее время (предварительная версия) в службе автоматизации Azure

Решение для запуска и остановки виртуальных машин в нерабочее время запускает и останавливает виртуальные машины Azure согласно определенным пользователем расписаниям, предоставляет важные сведения с помощью Azure Log Analytics и отправляет необязательные электронные сообщения с помощью [SendGrid](https://azuremarketplace.microsoft.com/marketplace/apps/SendGrid.SendGrid?tab=Overview). В большинстве сценариев оно поддерживает виртуальные машины Azure Resource Manager и классические виртуальные машины. 

Данное решение предоставляет возможность децентрализованной автоматизации пользователям, которым необходимо снизить расходы, используя бессерверные ресурсы, требующие меньших затрат. Это решение обеспечивает следующие возможности:

* планирование запуска и остановки виртуальных машин;
* планирование запуска и остановки виртуальных машин в возрастающем порядке с помощью тегов Azure (не поддерживается для классических виртуальных машин);
* автоматическая остановка виртуальных машин при низком уровне использования ЦП.

## <a name="prerequisites"></a>предварительным требованиям

- Для проверки подлинности модулей Runbook используется [учетная запись запуска от имени Azure](automation-offering-get-started.md#authentication-methods).  Этот метод аутентификации является предпочтительным, так как в нем используется сертификат, а не пароль, который может устареть или часто меняться.  

- С помощью этого решения можно управлять только теми виртуальными машинами, которые принадлежат к той же подписке, что и ваша учетная запись службы автоматизации Azure.  

- Это решение можно развернуть только в следующих регионах Azure: юго-восточная Австралия, центральная Канада, центральная Индия, восточная часть США, восточная Япония, Юго-Восточная Азия, южная часть Соединенного Королевства и Западная Европа.  
    
    > [!NOTE]
    > Модули Runbook, используемые для управления расписанием виртуальных машин, могут быть нацелены на виртуальные машины в любом регионе.  

- Для отправки уведомлений по электронной почте о выполнении модулей runbook для запуска и остановки виртуальных машин при подключении из Azure Marketplace необходимо выбрать **Да**, чтобы развернуть SendGrid. 

    > [!IMPORTANT]
    > SendGrid является сторонней службой. Для получения помощи обратитесь к службе поддержки [SendGrid](https://sendgrid.com/contact/).  
    >
   
    Ниже перечислены ограничения при использовании SendGrid.

    * Можно использовать не более одной учетной записи SendGrid на пользователя в подписке.
    * Можно использовать не более двух учетных записей SendGrid на подписку.

Если вы развернули предыдущую версию этого решения, потребуется сначала удалить его из учетной записи, а затем развернуть этот выпуск.  

## <a name="solution-components"></a>Компоненты решения

Это решение включает в себя предварительно настроенные модули runbook, расписания и интеграцию с Log Analytics. Это позволяет точно настроить запуск и завершение работы виртуальных машин в соответствии с потребностями компании. 

### <a name="runbooks"></a>Модули Runbook

В таблице ниже перечислены модули runbook, развертываемые в вашей учетной записи службы автоматизации.  Не следует вносить изменения в код runbook. Вместо этого напишите собственный runbook для новых функциональных возможностей.

> [!IMPORTANT]
> Не следует напрямую запускать какой-либо runbook со словом "child" в имени.
>

Все родительские модули runbook содержат параметр *WhatIf*. Если параметр *WhatIf* имеет значение **True**, то он обеспечивает подробное описание реакции runbook на событие при запуске без параметра *WhatIf* и проверяет правильность выбора целевых виртуальных машин.  Модули runbook выполняют определенные в них действия, только если параметр *WhatIf* имеет значение **False**. 

|**Runbook** | **Параметры** | **Описание**|
| --- | --- | ---| 
|AutoStop_CreateAlert_Child | VMObject <br> AlertAction <br> WebHookURI | Вызывается только из родительского runbook. Создает оповещения для каждого ресурса для сценария AutoStop.| 
|AutoStop_CreateAlert_Parent | WhatIf: true или false. <br> VMList | Создает или обновляет правила генерации оповещений Azure для виртуальных машин в целевой подписке или группах ресурсов. <br> VMList: разделенный запятыми список виртуальных машин.  Например, *ВМ1,ВМ2,ВМ3*.| 
|AutoStop_Disable | Нет | Отключает оповещения AutoStop и расписание по умолчанию.| 
|AutoStop_StopVM_Child | WebHookData | Вызывается только из родительского runbook. Правила генерации оповещений вызывают этот runbook, чтобы остановить виртуальную машину.|  
|Bootstrap_Main | Нет | Используется один раз для установки конфигураций начальной загрузки, например webhookURI, которые, как правило, недоступны в Azure Resource Manager. Этот runbook автоматически удаляется после успешного развертывания.|  
|ScheduledStartStop_Child | VMName <br> Action: Stop или Start. <br> ResourceGroupName | Вызывается только из родительского runbook. Выполняет остановку или запуск после запланированной остановки.|  
|ScheduledStartStop_Parent | Action: Stop или Start. <br> WhatIf: true или false. | Это влияет на все виртуальные машины в подписке. Измените **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**, ограничив выполнение только этими целевыми группами ресурсов. Можно также исключить определенные виртуальные машины, обновив переменную **External_ExcludeVMNames**. *WhatIf* работает так же, как и в других runbook.|  
|SequencedStartStop_Parent | Action: Stop или Start. <br> WhatIf: true или false. | Создайте теги **SequenceStart** и **SequenceStop** для каждой виртуальной машины, для которой требуется использовать действие последовательного запуска и остановки. Значением тега должно быть положительное целое число (1, 2, 3 и т. д.), которое соответствует очередности запуска или остановки. *WhatIf* работает так же, как и в других runbook. <br> **Примечание**. Виртуальные машины должны находиться в группах ресурсов, определенных в переменных службы автоматизации Azure External_Start_ResourceGroupNames, External_Stop_ResourceGroupNames и External_ExcludeVMNames. Чтобы эти действия выполнялись, они должны иметь соответствующие теги.|

### <a name="variables"></a>Переменные

В таблице ниже перечислены переменные, создаваемые в вашей учетной записи службы автоматизации.  Следует изменять только переменные с префиксом **External**. Изменение переменных с префиксом **Internal** приведет к нежелательным последствиям.  

|**Variable** | **Описание**|
---------|------------|
|External_AutoStop_Condition | Условный оператор, необходимый для настройки условия перед активацией оповещения. Допустимые значения: **GreaterThan**, **GreaterThanOrEqual**, **LessThan** и **LessThanOrEqual**.|  
|External_AutoStop_Description | Оповещение для остановки виртуальной машины в случае, если процент использования ЦП превышает пороговое значение.|  
|External_AutoStop_MetricName; | Имя метрики производительности, для которой настраивается правило генерации оповещений Azure.| 
|External_AutoStop_Threshold; | Пороговое значение для правила генерации оповещений Azure, указанного в переменной *External_AutoStop_MetricName*. Процентные значения могут находиться в диапазоне от 1 до 100.|  
|External_AutoStop_TimeAggregationOperator; | Оператор агрегата времени, который будет применяться к выбранному интервалу для оценки условия. Допустимые значения: **Average**, **Minimum**, **Maximum**, **Total** и **Last**.|  
|External_AutoStop_TimeWindow. | Размер интервала, на котором Azure анализирует выбранные метрики для активации оповещения. Этот параметр принимает входные данные в формате временного диапазона. Допустимые значения составляют от 5 минут до 6 часов.|  
|External_EmailFromAddress | Указывает отправителя сообщения электронной почты.|  
|External_EmailSubject | Указывает текст темы сообщения электронной почты.|  
|External_EmailToAddress | Указывает получателей электронного сообщения. Разделяйте их имена запятыми.|  
|External_ExcludeVMNames | Введите имена виртуальных машин, которые должны быть исключены, разделяя их запятыми без пробелов.|  
|External_IsSendEmail | Задает параметр для отправки уведомления по электронной почте по завершении.  Укажите **Yes**, чтобы отправлять уведомление, и **No**, чтобы не отправлять его.  Этот параметр должен иметь значение **No**, если вы не включили уведомления по электронной почте во время начального развертывания.|  
|External_Start_ResourceGroupNames | Позволяет указать одну или несколько групп ресурсов через запятую для действий запуска.|  
|External_Stop_ResourceGroupNames | Позволяет указать одну или несколько групп ресурсов через запятую для действий остановки.|  
|Internal_AutomationAccountName | Задает имя учетной записи службы автоматизации Azure.|  
|Internal_AutoSnooze_WebhookUri | Указывает универсальный код ресурса (URI) веб-перехватчика, вызываемого в сценарии AutoStop.|  
|Internal_AzureSubscriptionId | Указывает идентификатор подписки Azure.|  
|Internal_ResourceGroupName | Указывает имя группы ресурсов учетной записи службы автоматизации.|  
|Internal_SendGridAccountName | Указывает имя учетной записи SendGrid.|  
|Internal_SendGridPassword | Указывает пароль учетной записи SendGrid.|  

<br>

Во всех сценариях переменные **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames** необходимы для нацеливания на виртуальные машины, если только не предоставляется разделенный запятыми список виртуальных машин для runbook **AutoStop_CreateAlert_Parent**. То есть виртуальные машины должны находиться в целевых группах ресурсов, чтобы выполнялись действия запуска и остановки. Эта логика немного напоминает политику Azure тем, что можно выбрать целевую подписку или группу ресурсов, после чего действия будут наследоваться создаваемыми в ней виртуальными машинами. Такой подход позволяет избежать необходимости использовать отдельное расписание для каждой виртуальной машины и управлять запуском и остановкой в соответствующем масштабе.

### <a name="schedules"></a>Расписания

В таблице ниже перечислены расписания по умолчанию, создаваемые в вашей учетной записи службы автоматизации.  Можно изменить их или создать собственные пользовательские расписания.  По умолчанию все эти расписания отключены, за исключением **Scheduled_StartVM** и **Scheduled-StopVM**.

Не следует включать все расписания, так как это может привести к перекрытию действий расписаний. Лучше определить, какие оптимизации нужно выполнить, и внести соответствующие изменения.  Дополнительные пояснения можно получить, ознакомившись с примерами сценариев в разделе "Обзор".   

|**Имя расписания** | **Frequency** | **Описание**|
|--- | --- | ---|
|Schedule_AutoStop_CreateAlert_Parent | Каждые 8 часов | Каждые 8 часов запускает runbook AutoStop_CreateAlert_Parent, который, в свою очередь, останавливает виртуальные машины на основе значений переменных службы автоматизации Azure External_Start_ResourceGroupNames, External_Stop_ResourceGroupNames и External_ExcludeVMNames.  Кроме того, можно указать разделенный запятыми список виртуальных машин с помощью параметра VMList.|  
|Scheduled_StopVM | Определяется пользователем, ежедневно | Запускает runbook Scheduled_Parent с параметром *Stop* каждый день в указанное время.  Автоматически останавливает все виртуальные машины, удовлетворяющие правилам, определенным с помощью переменных ресурса. Следует включить связанное расписание, **Scheduled-StartVM**.|  
|Scheduled_StartVM | Определяется пользователем, ежедневно | Запускает runbook Scheduled_Parent с параметром *Start* каждый день в указанное время.  Автоматически запускает все виртуальные машины, соответствующие определенным правилам и указанные в соответствующих переменных.  Следует включить связанное расписание, **Scheduled-StopVM**.|
|Sequenced-StopVM | 01:00 (UTC), каждую пятницу | Запускает runbook Scheduled_Parent с параметром *Stop* каждую пятницу в указанное время.  Последовательно (по возрастанию) останавливает все виртуальные машины с тегом **SequenceStop**, которые указаны в соответствующих переменных.  Ознакомьтесь с разделом "Модули Runbook", чтобы получить дополнительные сведения о значениях тегов и переменных ресурсов.  Следует включить связанное расписание, **Sequenced-StartVM**.|
|Sequenced-StartVM | 13:00 (UTC), каждый понедельник | Запускает runbook Scheduled_Parent с параметром *Start* каждый понедельник в указанное время. Последовательно (по убыванию) запускает все виртуальные машины с тегом **SequenceStart**, которые указаны в соответствующих переменных.  Ознакомьтесь с разделом "Модули Runbook", чтобы получить дополнительные сведения о значениях тегов и переменных ресурсов.  Следует включить связанное расписание, **Sequenced-StopVM**.|

<br>

## <a name="configuration"></a>Параметр Configuration

Выполните следующие действия, чтобы добавить решение для запуска и остановки виртуальных машин в нерабочее время в свою учетную запись службы автоматизации, а затем настроить его.

1. На портале Azure щелкните **Создать ресурс**.<br> ![портал Azure](media/automation-solution-vm-management/azure-portal-01.png)<br>  
2. В области "Marketplace" введите ключевое слово, например **Start** или **Start/Stop**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Кроме того, можно ввести одно или несколько ключевых слов из полного имени решения и нажать клавишу ВВОД.  Выберите **Запуск и остановка виртуальных машин в нерабочее время [предварительная версия]** в результатах поиска.  
3. В области **Запуск и остановка виртуальных машин в нерабочее время [предварительная версия]** просмотрите сводные данные для выбранного решения и щелкните **Создать**.  
4. Появится область **Добавление решения**. В ней будет предложено настроить решение перед его импортом в подписку службы автоматизации.<br><br> ![Колонка "Добавление решения" в решении по управлению виртуальными машинами](media/automation-solution-vm-management/azure-portal-add-solution-01.png)<br><br>
5.  В области **Добавление решения** выберите **Рабочая область**. Выберите рабочую область OMS, связанную с подпиской Azure, в которой находится учетная запись службы автоматизации. Если у вас нет рабочей области, выберите **Создать рабочую область**. В области **Рабочая область OMS** выполните следующие действия. 
   - Укажите имя новой **рабочей области OMS**.
   - Выберите из раскрывающегося списка **подписку**, с которой нужно связать рабочую область, если выбранная по умолчанию подписка не подходит.
   - В качестве **группы ресурсов** можно использовать имеющуюся группу или создать новую.  
   - Выберите **расположение**.  В настоящее время можно выбрать только следующие расположения: **Юго-восточная Австралия**, **Центральная Канада**, **Центральная Индия**, **Восточная часть США**, **Восточная Япония**, **Юго-Восточная Азия**, **Южная часть Соединенного Королевства** и **Западная Европа**.
   - Выберите **ценовую категорию**.  Решение предоставляется на двух уровнях: бесплатном и платном (OMS).  Бесплатный уровень имеет ограничение на ежедневный сбор данных, срок хранения и время выполнения задания runbook.  На платном уровне (OMS) ограничение по объему ежедневно собираемых данных отсутствует.  

        > [!NOTE]
        > Хотя платный уровень "За ГБ (отдельный)" отображается, его не следует использовать.  Если вы выберите его и продолжите создание этого решения в подписке, процедура завершится ошибкой.  Это будет исправлено в официальном выпуске решения.<br>В этом решении используются только функции времени выполнения заданий автоматизации (в минутах) и приема данных журнала.  Оно не добавляет в вашу среду дополнительные узлы OMS.  

6. После ввода необходимых сведений в области **Рабочая область OMS** щелкните **Создать**.  Вы можете отслеживать ход выполнения, выбрав в меню **Уведомления**. После завершения вновь отобразится область **Добавление решения**.  
7. В области **Добавление решения** выберите **Учетная запись службы автоматизации**.  Если вы создаете рабочую область OMS, необходимо также создать учетную запись автоматизации, которая будет связана с этой рабочей областью.  Выберите **Создать учетную запись службы автоматизации** и в области **Добавление учетной записи службы автоматизации** укажите следующие сведения. 
  - В поле **Имя** введите имя учетной записи службы автоматизации.

    Все остальные параметры заполняются автоматически в зависимости от выбранной рабочей области OMS, Эти параметры невозможно изменить.  По умолчанию проверка подлинности модулей Runbook, добавленных в это решение, осуществляется с помощью учетной записи запуска от имени Azure.  Нажмите кнопку **ОК**, чтобы проверить параметры конфигурации и создать учетную запись службы автоматизации.  Ход создания можно просмотреть в разделе **Уведомления** в меню. 

    В противном случае можно выбрать имеющуюся учетную запись запуска от имени службы автоматизации.  Обратите внимание на то, что выбранная учетная запись не может быть связана с другой рабочей областью OMS. Если она уже связана, отобразится соответствующее сообщение. В этом случае нужно будет выбрать другую учетную запись запуска от имени службы автоматизации или создать новую.<br><br> ![Учетная запись службы автоматизации, связанная с рабочей областью OMS](media/automation-solution-vm-management/vm-management-solution-add-solution-blade-autoacct-warning.png)<br>

8. Наконец, в области **Добавление решения** выберите **Конфигурация**. Появится область **Параметры**.<br><br> ![Область параметров решения](media/automation-solution-vm-management/azure-portal-add-solution-02.png)<br><br>  В ней будет предложено выполнить следующие действия.  
   - Укажите значение **Target ResourceGroup Names** (Имена целевых групп ресурсов). Это имена групп ресурсов с виртуальными машинами, которыми должно управлять данное решение.  Вы можете указать несколько имен, используя в качестве разделителя запятые (в именах не учитывается регистр).  Если необходимо использовать виртуальные машины во всех группах ресурсов в рамках подписки, используйте подстановочный знак.
   - Укажите значение **VM Exclude List (string)** (Список исключаемых виртуальных машин (строка)). Это список, содержащий одну или несколько виртуальных машин из целевой группы ресурсов.  Вы можете указать несколько имен, используя в качестве разделителя запятые (в именах не учитывается регистр).  Поддерживается использование подстановочных знаков.
   - Выберите значение **Расписание**. Это повторяющиеся дата и время запуска и остановки виртуальных машин в целевых группах ресурсов.  По умолчанию расписание настраивается для часового пояса UTC. Выбрать другой регион невозможно.  Чтобы настроить для расписания использование конкретного часового пояса после настройки решения, ознакомьтесь с разделом [Изменение расписания запуска и завершения работы](#modifying-the-startup-and-shutdown-schedule).
   - Чтобы получать **уведомления по электронной почте** из SendGrid, оставьте значение по умолчанию **Да** и укажите адрес электронной почты. Если вы указали значение **No**, но впоследствии решили, что вы хотите получать уведомления по электронной почте, то вы можете изменить переменную **External_EmailToAddress**, добавив допустимые адреса электронной почты, разделенные запятыми, а затем задать для переменной **External_IsSendEmail** значение **Yes**.  

9. Завершив начальную настройку обязательных параметров решения, щелкните **Создать**.  После проверки всех параметров решение будет развернуто в вашей подписке.  Этот процесс может занять несколько секунд. Ход его выполнения можно просмотреть в разделе меню **Уведомления**. 

## <a name="collection-frequency"></a>Частота сбора

Журнал заданий службы автоматизации и потоковые данные заданий принимаются в репозитории Log Analytics каждые 5 минут.  

## <a name="using-the-solution"></a>Использование решения

При добавлении решения по управлению виртуальными машинами в рабочую область Log Analytics с портала Azure на панель мониторинга добавляется элемент **StartStopVMView** (Представление запуска и остановки виртуальных машин).  В нем отображаются сведения о количестве заданий runbook, которые были запущены и завершены для решения, а также их графическое представление.<br><br> ![Плитка StartStopVM View (Представление запуска и остановки виртуальных машин) в решении по управлению виртуальными машинами](media/automation-solution-vm-management/vm-management-solution-startstopvm-view-tile.png)  

В учетной записи службы автоматизации вы можете получить доступ к решению и управлять им, выбрав **Рабочая область**. На странице "Log Analytics" в левой области выберите **Решения**.  На странице **Решения** выберите решение **Start-Stop-VM[рабочая_область]** из списка.<br><br> ![Список решений в Log Analytics](media/automation-solution-vm-management/azure-portal-select-solution-01.png)  

При выборе решения отобразится область решения **Start-Stop-VM[рабочая_область]**. В ней можно просмотреть важные сведения, в том числе элемент **StartStopVM**. Как и в рабочей области Log Analytics, в нем отображаются сведения о количестве заданий runbook, которые были запущены и завершены для решения, а также их графическое представление.<br><br> ![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-portal-vmupdate-solution-01.png)  

Здесь можно открыть рабочую область OMS для дальнейшего анализа записей заданий. Для этого следует щелкнуть элемент "Кольцо". На панели мониторинга решения отображается журнал заданий и предварительно определенные запросы поиска по журналам. Переключитесь на расширенный портал Log Analytics для поиска с помощью поисковых запросов.  

Все родительские модули runbook содержат параметр *WhatIf*. Если этот параметр имеет значение **True**, то он обеспечивает подробное описание реакции runbook на событие при запуске без параметра *WhatIf* и проверяет правильность выбора целевых виртуальных машин. Модули runbook выполняют определенные в них действия, только если параметр *WhatIf* имеет значение **False**.  


### <a name="scenario-1-daily-startstop-vms-across-a-subscription-or-target-resource-groups"></a>Сценарий 1. Ежедневная остановка и запуск виртуальных машин в подписке или целевых группах ресурсов 

Это конфигурация по умолчанию, используемая после первого развертывания решения.  Например, можно настроить ее, чтобы останавливать все виртуальные машины в подписке вечером, когда вы уходите с работы, и запускать их утром, когда вы возвращаетесь в офис. Если настроить расписания **Scheduled-StartVM** и **Scheduled-StopVM** во время развертывания, они будут запускать и останавливать целевые виртуальные машины.
>[!NOTE]
>Используется часовой пояс, указанный при настройке параметра времени расписания. Однако он хранится в службе автоматизации Azure в формате UTC.  Нет необходимости преобразовывать часовой пояс, так как это делается во время развертывания.

Можно выбрать виртуальные машины в области действия с помощью переменных **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames**.  

>[!NOTE]
> Значение переменной **Target ResourceGroup Names** (Имена целевых групп ресурсов) хранится в качестве значений переменных **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**. Чтобы увеличить степень детализации, можно изменить эти переменные для различных групп ресурсов.  Для действия запуска используйте **External_Start_ResourceGroupNames**, а для действия остановки — **External_Stop_ResourceGroupNames**. Виртуальные машины автоматически добавляются в расписания запуска и остановки.

Чтобы тестировать и проверить конфигурацию, вручную запустите runbook **ScheduledStartStop_Parent** и задайте для параметра ACTION значение **Start** или **Stop**, а для параметра WHATIF — значение **True**.<br><br> ![Настройка параметров для runbook](media/automation-solution-vm-management/solution-startrunbook-parameters-01.png)


 Просмотрите запланированное действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин.  Можно вручную запустить runbook с параметром, имеющим значение **False**, или позволить автоматический запуск расписаний службы автоматизации **Schedule-StartVM** и **Schedule-StopVM**, которые вы задали.

### <a name="scenario-2-sequence-the-startstop-vms-across-a-subscription-by-using-tags"></a>Сценарий 2. Последовательная остановка и запуск виртуальных машин в подписке с помощью тегов
В среде, которая включает в себя два или более компонентов, работающих на нескольких виртуальных машинах, которые поддерживают распределенную рабочую нагрузку, важно наличие поддержки последовательного запуска и остановки компонентов в нужном порядке.  Чтобы обеспечить это, выполните следующие действия.

1. Добавьте теги **SequenceStart** и **SequenceStop**, значением которых является положительное целое число, для виртуальных машин, указанных в переменных **External_Start_ResourceGroupNames**и **External_Stop_ResourceGroupNames**.  Действия запуска и остановки будут выполняться в порядке возрастания.  Чтобы узнать, как добавить тег к виртуальной машине, ознакомьтесь с разделами [Пометка виртуальной машины Windows в Azure](../virtual-machines/windows/tag.md) и [Пометка виртуальной машины Linux в Azure](../virtual-machines/linux/tag.md).
2. Измените расписания **Sequenced-StartVM** и **Sequenced-StopVM**, указав даты и время в соответствии со своими требованиями, после чего включите эти расписания.  

Для тестирования и проверки конфигурации вручную запустите runbook **SequencedStartStop_Parent**. Задайте для параметра ACTION значение **start** или **stop**, а для параметра WHATIF — значение **True**.<br><br> ![Настройка параметров для runbook](media/automation-solution-vm-management/solution-startrunbook-parameters-01.png)<br> Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин.  Когда все будет готово, можно будет вручную запустить runbook с параметром, имеющим значение **False**. Можно также позволить автоматический запуск расписаний службы автоматизации **Sequenced-StartVM** и **Sequenced-StopVM**, которые вы задали.  

### <a name="scenario-3-automate-startstop-vms-across-a-subscription-based-on-cpu-utilization"></a>Сценарий 3. Автоматический запуск и остановка виртуальных машин в подписке в зависимости от использования ЦП
Это решение поможет контролировать затраты на работающие виртуальные машины в подписке, оценивая виртуальные машины Azure, которые не используются в периоды небольшой нагрузки, например в нерабочее время, и автоматически завершая их работу в случае, если процент использования процессора меньше x %.  

По умолчанию это решение предварительно настроено для оценки метрики "Загрузка ЦП", и оно проверяет, составляет ли средняя загрузка 5 % или меньше.  Для управления используются следующие переменные, которые могут быть изменены, если их значения по умолчанию не удовлетворяют вашим требованиям:

* External_AutoStop_MetricName;
* External_AutoStop_Threshold;
* External_AutoStop_TimeAggregationOperator;
* External_AutoStop_TimeWindow.

Действие можно нацелить или на подписку и группу ресурсов, или на определенный список виртуальных машин.  

#### <a name="target-the-stop-action-against-a-subscription-and-resource-group"></a>Нацеливание действия Stop на подписку и группу ресурсов

1. Настройте переменные **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames** для указания целевых виртуальных машин.  
2. Включите и обновите расписание **Schedule_AutoStop_CreateAlert_Parent**.
3. Запустите runbook **AutoStop_CreateAlert_Parent**, указав для параметра ACTION значение **start**, а для параметра WHATIF — значение **True**, чтобы воспользоваться предварительным просмотром изменений.

#### <a name="target-the-stop-action-by-vm-list"></a>Нацеливание действия остановки на список виртуальных машин

1. Запустите runbook **AutoStop_CreateAlert_Parent**, указав для параметра ACTION значение **start**, добавьте разделенный запятыми список виртуальных машин в параметр *VMList* и укажите для параметра WHATIF значение **True**. Воспользуйтесь предварительным просмотром изменений.  
2. Настройте параметр **External_ExcludeVMNames**, указав разделенный запятыми список виртуальных машин (ВМ1,ВМ2,ВМ3).
3. В этом сценарии переменные **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupnames** не учитываются.  Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

Теперь, имея расписание для остановки виртуальных машин в соответствии с загрузкой ЦП, необходимо включить одно из приведенных ниже расписания для запуска.

* Нацельте действие запуска на подписку и группу ресурсов.  В [сценарии 1](#scenario-1:-daily-stop/start-vms-across-a-subscription-or-target-resource-groups) приведены инструкции по тестированию и включению расписания **Scheduled-StartVM**. Ознакомьтесь с ними.
* Нацельте действие запуска на подписку, группу ресурсов и тег.  В [сценарии 2](#scenario-2:-sequence-the-stop/start-vms-across-a-subscription-using-tags) приведены инструкции по тестированию и включению расписания **Sequenced-StartVM**. Ознакомьтесь с ними.


### <a name="configuring-email-notifications"></a>Настройка уведомлений по электронной почте

Чтобы настроить уведомления по электронной почте после развертывания решения, можно изменить следующие три переменные:

* External_EmailFromAddress — укажите адрес электронной почты отправителя;
* External_EmailToAddress — укажите список адресов электронной почты, разделенных запятыми (user@hotmail.com, user@outlook.com), для получения уведомлений по электронной почте;
* External_IsSendEmail — укажите значение **Yes** для получения электронных сообщений. Чтобы отключить уведомления по электронной почте, задайте значение **No**.   


### <a name="modifying-the-startup-and-shutdown-schedules"></a>Изменение расписаний запуска и завершения работы

Действия по управлению расписанием запуска и завершения работы в этом решении аналогичны описанным в статье [Создание расписания для Runbook в службе автоматизации Azure](automation-schedules.md).     

## <a name="log-analytics-records"></a>Записи Log Analytics

Служба автоматизации создает в репозитории OMS записи двух типов: журналы заданий и потоки заданий.

### <a name="job-logs"></a>Журналы заданий

Свойство | ОПИСАНИЕ|
----------|----------|
Caller |  Сторона, инициировавшая операцию.  Допустимые значения: электронный адрес или system для запланированных заданий.|
Категория | Классификация типа данных.  Для службы автоматизации значением является JobLogs.|
CorrelationId | GUID, представляющий собой идентификатор корреляции задания Runbook.|
JobId | GUID, представляющий собой идентификатор задания Runbook.|
operationName | Указывает тип операции, выполняемой в Azure.  Для службы автоматизации значением является Job.|
ResourceId | Указывает тип ресурса в Azure.  Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
ResourceGroup | Указывает имя группы ресурсов задания Runbook.|
ResourceProvider | Указывает службу Azure, которая предоставляет ресурсы для развертывания и управления.  Для службы автоматизации значением будет Azure Automation.|
ResourceType | Указывает тип ресурса в Azure.  Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
resultType | Состояние задания Runbook.  Возможные значения:<br>Started<br>- Остановлена<br>Приостановлено<br>Сбой<br>- Succeeded.|
resultDescription | Описывает состояние результата задания Runbook.  Возможные значения:<br>— Job is started;<br>— Job Failed;<br>- Job Completed.|
RunbookName | Указывает имя модуля Runbook.|
SourceSystem | Указывает исходную систему для отправленных данных.  Для службы автоматизации значением является OpsManager.|
StreamType | Задает тип события. Возможные значения:<br>- Verbose.<br>— Output;<br>error<br>Предупреждение|
SubscriptionId | Указывает идентификатор подписки задания.
Время | Дата и время выполнения задания Runbook.|


### <a name="job-streams"></a>Потоки заданий

Свойство | ОПИСАНИЕ|
----------|----------|
Caller |  Сторона, инициировавшая операцию.  Допустимые значения: электронный адрес или system для запланированных заданий.|
Категория | Классификация типа данных.  Для службы автоматизации значением является JobStreams.|
JobId | GUID, представляющий собой идентификатор задания Runbook.|
operationName | Указывает тип операции, выполняемой в Azure.  Для службы автоматизации значением является Job.|
ResourceGroup | Указывает имя группы ресурсов задания Runbook.|
ResourceId | Указывает идентификатор ресурса в Azure.  Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
ResourceProvider | Указывает службу Azure, которая предоставляет ресурсы для развертывания и управления.  Для службы автоматизации значением будет Azure Automation.|
ResourceType | Указывает тип ресурса в Azure.  Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
resultType | Результат задания Runbook во время создания события. Возможное значение:<br>- InProgress.|
resultDescription | Включает в себя выходной поток из Runbook.|
RunbookName | Имя Runbook.|
SourceSystem | Указывает исходную систему для отправленных данных.  Для службы автоматизации значением является OpsManager.|
StreamType | Тип потока задания. Возможные значения:<br>- Progress<br>Выходные данные<br>Предупреждение<br>error<br>debug<br>- Verbose.|
Время | Дата и время выполнения задания Runbook.|

При выполнении поиска по журналам, в результате которого возвращаются записи категории **JobLogs** или **JobStreams**, можно выбрать представление **JobLogs** или **JobStreams**. Эти представления отображают набор элементов с перечнем обновлений, возвращенных в результатах поиска.

## <a name="sample-log-searches"></a>Пример поисков журналов

Следующая таблица содержит примеры поисков по журналу для получения записей заданий, собранных этим решением. 

Запрос | ОПИСАНИЕ|
----------|----------|
Поиск успешно выполненных заданий runbook ScheduledStartStop_Parent. | search Category == "JobLogs" &#124; where ( RunbookName_s == "ScheduledStartStop_Parent" ) &#124; where ( ResultType == "Completed" )  &#124; summarize AggregatedValue = count() by ResultType, bin(TimeGenerated, 1h) &#124; sort by TimeGenerated desc|
Поиск успешно выполненных заданий runbook SequencedStartStop_Parent. | search Category == "JobLogs" &#124; where ( RunbookName_s == "SequencedStartStop_Parent" ) &#124; where ( ResultType == "Completed" )  &#124; summarize AggregatedValue = count() by ResultType, bin(TimeGenerated, 1h) &#124; sort by TimeGenerated desc

## <a name="removing-the-solution"></a>Удаление решения

Если решение больше не нужно, его можно удалить из учетной записи службы автоматизации.  При этом удаляются только модули runbook. Расписания или переменные, которые были созданы при добавлении решения, не удаляются.  Эти ресурсы понадобится удалить вручную, если они не используются в других модулях runbook.  

Чтобы удалить решение, сделайте следующее:

1.  Используя свою учетную запись службы автоматизации, выберите **Рабочая область** в левой области.  
2.  На странице **Решения** выберите решение **Start-Stop-VM[Workspace]**.  На странице **VMManagementSolution[рабочая_область]** в меню щелкните **Удалить**.<br><br> ![Удаление решения VMManagement](media/automation-solution-vm-management/vm-management-solution-delete.png)
3.  В окне **Удаление решения** подтвердите удаление решения.
4.  Пока проверяются данные, ход удаления решения можно проверить в разделе **Уведомления** в меню.  После того, как начнется процесс удаления решения, вы вернетесь на страницу **Решения**.  

В ходе этого процесса рабочая область Log Analytics и учетная запись службы автоматизации не удаляются.  Если вы не хотите сохранить рабочую область Log Analytics, необходимо удалить ее вручную.  Это можно сделать на портале Azure.

1.    На домашней странице портала Azure выберите **Log Analytics**.
2. В области **Log Analytics** выберите рабочую область.
3. В меню, расположенном в области параметров рабочей области, выберите **Удалить**.  
      
## <a name="next-steps"></a>Дополнительная информация

- Чтобы узнать больше о том, как создавать различные поисковые запросы и просматривать журналы заданий службы автоматизации с помощью Log Analytics, ознакомьтесь с разделом [Поиск по журналам в Log Analytics](../log-analytics/log-analytics-log-searches.md).
- Дополнительные сведения о выполнении модулей Runbook, отслеживании заданий модуля Runbook и других технических деталях см. в статье [Выполнение модуля Runbook в службе автоматизации Azure](automation-runbook-execution.md).
- Чтобы узнать больше о Log Analytics и источниках собираемых данных, ознакомьтесь с разделом [Подключение службы Azure к Log Analytics](../log-analytics/log-analytics-azure-storage.md).






   

