<properties
   pageTitle="Гибридные компоненты Runbook Worker в службе автоматизации Azure"
   description="В этой статье содержатся сведения об установке и использовании гибридного компонента Runbook Worker, который является элементом службы автоматизации Azure, позволяющей запускать модули Runbook на компьютерах в локальном центре обработки данных."
   services="automation"
   documentationCenter=""
   authors="bwren"
   manager="stevenka"
   editor="tysonn" />
<tags
   ms.service="automation"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="04/11/2016"
   ms.author="bwren" />

# Гибридные компоненты Runbook Worker в службе автоматизации Azure

Модули Runbook в службе автоматизации Azure не могут получить доступ к ресурсам локального центра обработки данных, поскольку они выполняются в облаке Azure. Функция гибридных компонентов Runbook Worker службы автоматизации Azure позволяет запускать модули Runbook на компьютерах, расположенных в центре обработки данных, для управления локальными ресурсами. Модули Runbook сохраняются и управляются в службе автоматизации Azure, а затем передаются на один или несколько локальных компьютеров.

Эта функция проиллюстрирована на следующем изображении.

![Обзор гибридного компонента Runbook Worker](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-overview.png)

Вы можете назначить один или несколько компьютеров в вашем центре обработки данных в качестве гибридного компонента Runbook Worker и запускать модули Runbook при помощи службы автоматизации Azure. Каждая рабочая роль требует наличия агента управления Майкрософт с подключением к Microsoft Operations Management Suite \(OMS\) и среды Runbook службы автоматизации Azure. OMS используется только для установки и обслуживания агента управления, а также для отслеживания работы функций рабочей роли. Предоставление элементов Runbook и инструкций по их запуску выполняется службой автоматизации Azure.

![Компоненты гибридного компонента Runbook Worker](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-components.png)

Для поддержки гибридных компонентов Runbook Worker отсутствуют требования к брандмауэру для входящих подключений. Агент на локальном компьютере инициирует весь обмен данными со службой автоматизации Azure в облаке. При запуске модуля Runbook служба автоматизации Azure создает инструкцию, которая извлекается агентом. После этого агент извлекает модуль Runbook и все сопутствующие параметры, применяемые перед запуском модуля. Кроме того, из службы автоматизации Azure извлекаются все [средства](http://msdn.microsoft.com/library/dn939988.aspx), которые используются в модуле Runbook.

>[AZURE.NOTE] Гибридные рабочие роли Runbook в настоящее время не поддерживают [конфигурации DSC](automation-dsc-overview.md).

## Группы гибридных компонентов Runbook Worker

Каждый гибридный компонент Runbook Worker является членом группы гибридных компонентов Runbook Worker, которая указывается при установке агента. Группа может включать одного агента, но в нее можно установить несколько агентов для обеспечения высокого уровня доступности.

При запуске модуля Runbook в гибридном компоненте Runbook Worker указывается группа, в которой он будет выполнен. Члены группы будут определять, какой компонент Worker будет обслуживать запрос. Указание конкретного компонента Worker для выполнения конкретной задачи не предусмотрено.

## Требования к гибридному компоненту Runbook

Для выполнения заданий гибридного компонента Runbook необходимо назначить хотя бы один локальный компьютер. На компьютере должны быть установлены:

- Windows Server 2012 или более поздней версии;
- Windows PowerShell 4.0 или более поздней версии.

При работе с гибридными компонентами Worker учтите следующие рекомендации:

- Назначьте несколько гибридных компонентов Worker в каждой группе, чтобы обеспечить высокую доступность.  
- Гибридные компоненты Worker могут сосуществовать с серверами Runbook Service Management Automation и System Center Orchestrator.
- Рассмотрите возможность использования компьютера, физически расположенного в регионе вашей учетной записи автоматизации или рядом с ним, поскольку данные выполненного задания возвращаются в службу автоматизации Azure.

Требования к брандмауэру

- Локальный компьютер, на котором выполняется гибридная рабочая роль Runbook, должен иметь исходящий доступ к \*.cloudapp.net на портах 443, 9354 и с 30000 по 30199.

## Установка гибридного компонента Runbook Worker
Ниже описана процедура установки и настройки гибридного компонента Runbook Worker. Выполните первые два шага для среды автоматизации, а затем повторите остальные шаги для каждого компьютера с компонентом Worker.

### 1\. Создание рабочей области OMS
Если у вас нет еще рабочей области OMS, создайте ее, следуя инструкциям, которые можно найти в [библиотеке TechNet](https://technet.microsoft.com/library/mt484119.aspx). Если у вас уже есть рабочая область, вы можете использовать ее.

### 2\. Добавление решения службы автоматизации в рабочую область OMS
Решения добавляют функциональные возможности в OMS. Решение автоматизации расширяет функциональные возможности службы автоматизации Azure, включая поддержку гибридных компонентов Runbook Worker. При добавлении решения в рабочую область она автоматически загружает компоненты Worker на компьютер агента, который вы установите на следующем этапе.

Следуйте инструкциям в разделе [Добавление решения](https://technet.microsoft.com/library/mt674635.aspx), чтобы добавить решение **службы автоматизации** в рабочую область OMS.

### 3\. Установите агент управления Майкрософт
Агент управления Майкрософт подключает компьютеры к OMS. Когда агент устанавливается на локальный компьютер и подключается к рабочей области, он автоматически загружает компоненты, необходимые для гибридных модулей Runbook Worker.

Установите агент на локальный компьютер, следуя инструкциям в статье [Прямое подключение компьютеров Windows к OMS](https://technet.microsoft.com/library/mt484108.aspx). Выполните эту процедуру на нескольких компьютерах, чтобы добавить в среду несколько компонентов Worker.

Агент, успешно подключенный к OMS, появится на вкладке **Connected Sources** \(Подключенные источники\) в области **Settings** \(Параметры\) OMS. Если агент загрузил решение службы автоматизации правильно, в каталоге C:\\Program Files\\Microsoft Monitoring Agent\\Agent появится папка **AzureAutomationFiles**.

### 4\. Установите среду модулей Runbook и выполните подключение к службе автоматизации Azure
При добавлении агента в OMSuite решение службы автоматизации устанавливает модуль PowerShell **HybridRegistration**, который содержит командлет **Add-HybridRunbookWorker**. Этот командлет используется для установки среды модулей Runbook на компьютере и ее регистрации в службе автоматизации Azure.

Откройте сеанс PowerShell с правами администратора и импортируйте модуль, выполнив указанные ниже команды.

	cd "C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\<version>\HybridRegistration"
	Import-Module HybridRegistration.psd1


После этого запустите командлет **Add-HybridRunbookWorker**, используя следующий синтаксис:

	Add-HybridRunbookWorker –Name <String> -EndPoint <Url> -Token <String>

Данные, необходимые для этого командлета, можно найти в колонке **Управление ключами** на портале Azure. Откройте эту колонку, щелкнув значок ключа на панели элементов в учетной записи службы автоматизации.

![Обзор гибридного компонента Runbook Worker](media/automation-hybrid-runbook-worker/elements-panel-keys.png)

- **Имя** — это имя группы гибридных компонентов Runbook Worker. Если эта группа уже существует в учетной записи автоматизации, то к ней добавляется текущий компьютер. Если она еще не существует, то выполняется ее добавление.
- **Конечная точка** — это поле **URL-адрес** в колонке **Управление ключами**.
- **Токен** — **первичный ключ доступа** в колонке **Управление ключами**.  

Для получения подробных сведений об установке используйте параметр **-Verbose** с командлетом **Add-HybridRunbookWorker**.

### 5\. Установка модулей PowerShell
Модули Runbook могут использовать любые из действий и командлетов, которые определены в модулях, установленных в вашей среде службы автоматизации Azure. Эти модули не разворачиваются на локальных машинах автоматически, поэтому их необходимо устанавливать вручную. Исключением является модуль Azure, который устанавливается по умолчанию и предоставляет доступ к командлетам для всех служб и действий службы автоматизации Azure.

Поскольку главной целью функции гибридного компонента Runbook Worker является управление локальными ресурсами, скорее всего, вам потребуется установить модули, которые поддерживают эти ресурсы. Сведения об установке модулей Windows PowerShell можно найти в разделе [Установка модулей](http://msdn.microsoft.com/library/dd878350.aspx).

## Удаление гибридного компонента Runbook Worker

Гибридную рабочую роль Runbook можно удалить с локального компьютера, выполнив на нем командлет **Remove-HybridRunbookWorker**. Получить подробный журнал процедуры удаления можно с помощью параметра **-Verbose**.

## Запуск модулей Runbook на гибридном компоненте Runbook Worker

В разделе [Запуск модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md) описываются различные методы запуска модуля Runbook. Гибридный компонент Runbook Worker добавляет параметр **RunOn**, при помощи которого можно указать имя группы гибридных компонентов Runbook Worker. При указании группы модуль Runbook извлекается и запускается компонентами Worker в этой группе. Если этот параметр не указан, то он будет запущен в службе автоматизации Azure в обычном режиме.

При запуске модуля Runbook на портале Azure отобразится параметр **Запуск в**, для которого вы можете выбрать значение **Azure** или **Гибридная рабочая роль**. При выборе значения **Гибридный компонент Worker** можно выбрать группу из раскрывающегося списка.

Используйте параметр **RunOn**. Вы можете использовать следующую команду для запуска модуля Runbook с названием Test-Runbook в группе гибридных компонентов Runbook Worker с именем MyHybridGroup при помощи Windows PowerShell.

	Start-AzureAutomationRunbook –AutomationAccountName "MyAutomationAccount" –Name "Test-Runbook" -RunOn "MyHybridGroup"

>[AZURE.NOTE] Параметр **RunOn** был добавлен в командлет **Start-AzureAutomationRunbook** в Microsoft Azure PowerShell версии 0.9.1. Если у вас установлена более ранняя версия, следует [загрузить последнюю версию](https://azure.microsoft.com/downloads/). Вам потребуется установить эту версию на рабочую станцию, на которой вы будете запускать модуль Runbook из Windows PowerShell. Вам не нужно устанавливать его на компьютер с компонентом Worker, если вы не собираетесь запускать модули Runbooks с этого компьютера. В настоящий момент вы не можете запускать модуль Runbook в гибридном компоненте Runbook Worker из другого модуля Runbook, поскольку для этого потребуется установить последнюю версию Azure Powershell в учетной записи службы автоматизации. Последняя версия будет автоматически обновлена в службе автоматизации Azure и будет автоматически принудительно установлена в компонентах Worker.

## Разрешения для модулей Runbook

Так как модули Runbook, запущенные в гибридной рабочей роли, будут осуществлять доступ к ресурсам за пределами Azure, они не могут использовать [метод, который обычно используется для модулей Runbook при аутентификации в ресурсах Azure](automation-configuring.md#configuring-authentication-to-azure-resources). Модуль Runbook может предоставить собственную проверку подлинности для локальных ресурсов. Также можно указать учетную запись запуска от имени, чтобы предоставить контекст пользователя для всех модулей.

### Проверка подлинности модуля Runbook

По умолчанию модули Runbook выполняются в контексте локальной системной учетной записи на локальном компьютере. Поэтому они должны предоставлять собственные средства проверки подлинности при доступе к требуемым ресурсам.

В модуле Runbook можно использовать элементы [Учетные данные](http://msdn.microsoft.com/library/dn940015.aspx) и [Сертификат](http://msdn.microsoft.com/library/dn940013.aspx) с командлетами, позволяющими указать учетные данных для проверки подлинности в различных ресурсах. В следующем примере показана часть модуля Runbook, предназначенная для перезапуска компьютера. Он извлекает учетные данные из набора учетных данных, а также имя компьютера из набора переменных, после чего использует эти значения в сочетании с командлетом Restart-Computer.

	$Cred = Get-AutomationCredential "MyCredential"
	$Computer = Get-AutomationVariable "ComputerName"

	Restart-Computer -ComputerName $Computer  -Credential $Cred

Вы можете также использовать [InlineScript](automation-powershell-workflow.md#inline-script), который позволяет запускать блоки кода на другом компьютере с учетными данными, указанными в [общем параметре PSCredential](http://technet.microsoft.com/library/jj129719.aspx).

### Учетная запись запуска от имени

Кроме варианта, когда модули Runbook предоставляют собственную аутентификацию для локальных ресурсов, можно также указать учетную запись **запуска от имени** для гибридной рабочей роли. Когда вы указываете [ресурс учетных данных](automation-credentials.md) с доступом к локальным ресурсам, все модули Runbook будут выполняться с использованием этих учетных данных в гибридной рабочей роли Runbook в группе.

Имя пользователя для учетных данных должно быть представлено в одном из следующих форматов:

- домен\\имя пользователя;
- username@domain
- имя пользователя \(для локальных учетных записей на локальном компьютере\).


Указать учетную запись запуска от имени для гибридной рабочей роли можно так.

1. Создайте [ресурс учетных данных](automation-credentials.md) с доступом к локальным ресурсам.
2. На портале Azure откройте учетную запись службы автоматизации.
2. Щелкните элемент **Гибридные рабочие роли** и выберите группу.
3. Щелкните **Все параметры** и **Параметры гибридной рабочей роли**.
4. Измените для параметра **Запуск от имени** значение **По умолчанию** на **Пользовательский**.
5. Выберите учетные данные и нажмите кнопку **Сохранить**.


## Создание модулей Runbook для гибридного компонента Runbook Worker

В структуре модулей Runbook, которые работают в службе автоматизации Azure, отсутствует разница между ними и теми модулями, которые работают в гибридном компоненте Runbook Worker. Модули Runbook, которые будут использоваться в каждом из этих вариантов, скорее всего, будут значительно различаться, поскольку модули Runbook для гибридного компонента Runbook Worker будут обычно управлять локальными ресурсами в вашем центре обработки данных, в то время как модули Runbook в службе автоматизации Azure будут управлять ресурсами в облаке Azure.

Вы можете отредактировать модуль Runbook для гибридного компонента Runbook Worker в службе автоматизации Azure, однако вы можете столкнуться с трудностями при попытке тестирования модуля Runbook в редакторе. Модули PowerShell, которые осуществляют доступ к локальным ресурсам, не могут устанавливаться в среде службы автоматизации Azure; если это будет сделано, успешное тестирование станет невозможным. Если вы все же установите необходимые модули, то модуль Runbook будет запущен, однако он не сможет получить доступ к локальным ресурсам в степени, необходимой для завершения тестирования.

## Устранение неполадок с модулями Runbook в гибридном компоненте Runbook Worker

[Выходные данные Runbook и сообщения](automation-runbook-output-and-messages.md) отправляются в службу автоматизации Azure из гибридных рабочих ролей точно так же, как задания Runbook, которые выполняются в облаке. Потоки Verbose и Progress можно активировать точно так же, как и для других модулей Runbook.

Журналы сохраняются локально в каждом гибридном компоненте Worker по адресу C:\\ProgramData\\Microsoft\\System Center\\Orchestrator\\7.2\\SMA\\Sandboxes.


## Связь с автоматизацией управления службами

Решение [Service Management Automation \(SMA\)](https://technet.microsoft.com/library/dn469260.aspx) — это компонент пакета Microsoft Azure, который позволяет запускать модули Runbook, поддерживаемые службой автоматизации Azure, в локальном центре обработки данных. В отличие от службы автоматизации Azure SMA предусматривает локальную установку, которая включает установку портала управления пакетом Microsoft Azure и базы данных для размещения модулей Runbook и конфигурации SMA. Служба автоматизации Azure предоставляет эти службы в облаке, для чего необходимо поддерживать гибридные компоненты Runbook Worker в локальной среде.

Если вы являетесь существующим пользователем SMA, вы можете переместить ваши модели Runbook в службу автоматизации Azure, чтобы затем их использовать с гибридным компонентом Runbook Worker без изменений, предполагая, что они будут выполнять собственную проверку подлинности по отношению к ресурсам, как это описано в разделе [Создание модулей Runbook для гибридного компонента Runbook Worker](#creating-runbooks-for-hybrid-runbook-worker). Модули Runbook в SMA выполняются в контексте учетной записи службы на сервере компонентов Worker, который может обеспечивать проверку подлинности для модулей Runbook.

Вы можете воспользоваться следующими критериями, чтобы определить, что больше подходит под ваши требования: служба автоматизации Azure с гибридным компонентом Runbook Worker или автоматизация управления службами \(SMA\).

- Для SMA необходима локальная установка пакета Microsoft Azure. В ней используется значительно больше локальных ресурсов с большими затратами на обслуживание, чем в службе автоматизации Azure, которой необходим только агент, установленный в локальных рабочих ролях Runbook. Агенты управляются при помощи OMS, что позволяет дополнительно снизить затраты на обслуживание.
- Служба автоматизации Azure сохраняет свои модули Runbook в облаке и предоставляет их локальным гибридным компонентам Runbooks Worker. Если ваша политика безопасности не допускает развертывания такой модели, тогда необходимо использовать SMA.
- Пакет Microsoft Azure можно загрузить бесплатно; за использование службы автоматизации Azure может взиматься плата по подписке.
- Служба автоматизации Azure с гибридным компонентом Runbook Worker позволяет управлять модулями Runbook для облачных ресурсов и локальных ресурсов из одного места в отличие от модели с отдельным управлением службой автоматизации Azure и SMA.
- Служба автоматизации Azure обладает расширенными функциями, такими как создание графических компонентов, которые недоступны в SMA.


## Связанные статьи

- [Запуск модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md)
- [Редактирование модуля Runbook в службе автоматизации Azure](https://msdn.microsoft.com/library/dn879137.aspx)

<!---HONumber=AcomDC_0413_2016-->