<properties
   pageTitle="Гибридные компоненты Runbook Worker в службе автоматизации Azure"
   description="В этой статье содержатся сведения об установке и использовании гибридного компонента Runbook Worker, который является элементом службы автоматизации Azure, позволяющей запускать модули Runbook на компьютерах в локальном центре обработки данных."
   services="automation"
   documentationCenter=""
   authors="bwren"
   manager="stevenka"
   editor="tysonn" />
<tags
   ms.service="automation"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="09/17/2015"
   ms.author="bwren" />

# Гибридные компоненты Runbook Worker в службе автоматизации Azure

Модули Runbook в службе автоматизации Azure не могут получить доступ к ресурсам локального центра обработки данных, поскольку они выполняются в облаке Azure. Функция гибридных компонентов Runbook Worker службы автоматизации Azure позволяет запускать модули Runbook на компьютерах, расположенных в центре обработки данных, для управления локальными ресурсами. Модули Runbook хранятся и управляются службой автоматизации Azure, а затем доставляются в одну или несколько локальных машин, где они выполняются.

Эта функция проиллюстрирована на следующем изображении.

![Обзор гибридного компонента Runbook Worker](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-overview.png)

Вы можете назначить один или несколько компьютеров в вашем центре обработки данных в качестве гибридного компонента Runbook Worker и запускать модули Runbook при помощи службы автоматизации Azure. Каждый компонент Worker требует наличия агента управления Майкрософт с подключением к Microsoft Operations Management Suite и средой Runbook службы автоматизации Azure. Operations Management Suite используется только для установки и технического обслуживания агента управления, а также для отслеживания работы функций компонента Worker. Предоставление элементов Runbook и инструкций по их запуску выполняется службой автоматизации Azure.

![Компоненты гибридного компонента Runbook Worker](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-components.png)

>[AZURE.NOTE]В настоящее время идет процесс интеграции Operational Insights с Operations Management Suite, поэтому на портале и в документации вы можете встретить и то, и другое название.

Для поддержки гибридных компонентов Runbook Worker отсутствуют требования к брандмауэру для входящих подключений. Агент на локальном компьютере инициирует весь обмен данными со службой автоматизации Azure в облаке. При запуске модуля Runbook служба автоматизации Azure создает инструкцию, которая извлекается агентом. После этого агент извлекает модуль Runbook и все сопутствующие параметры, применяемые перед запуском модуля. Кроме того, из службы автоматизации Azure извлекаются все [средства](http://msdn.microsoft.com/library/dn939988.aspx), которые используются в модуле Runbook.

## Группы гибридных компонентов Runbook Worker

Каждый гибридный компонент Runbook Worker является членом группы гибридных компонентов Runbook Worker, которая указывается при установке агента. Группа может включать одного агента, но в нее можно установить несколько агентов для обеспечения высокого уровня доступности.

При запуске модуля Runbook в гибридном компоненте Runbook Worker указывается группа, в которой он будет выполнен. Члены группы будут определять, какой компонент Worker будет обслуживать запрос. Указание конкретного компонента Worker для выполнения конкретной задачи не предусмотрено.

## Требования к гибридному компоненту Runbook

Для выполнения заданий гибридного компонента Runbook необходимо назначить хотя бы один локальный компьютер. На компьютере должны быть установлены:

- Windows Server 2012 или более поздней версии;
- Windows PowerShell 4.0 или более поздней версии.

При работе с гибридными компонентами Worker учтите следующие рекомендации:

- Назначьте несколько гибридных компонентов Worker в каждой группе, чтобы обеспечить высокую доступность.  
- Гибридные компоненты Worker могут сосуществовать с серверами Runbook Service Management Automation и System Center Orchestrator.
- Рассмотрите возможность использования компьютера, физически расположенного в регионе вашей учетной записи автоматизации или рядом с ним, поскольку данные выполненного задания возвращаются в службу автоматизации Azure.

## Установка гибридного компонента Runbook Worker
Ниже описана процедура установки и настройки гибридного компонента Runbook Worker. Выполните первые два шага для среды автоматизации, а затем повторите остальные шаги для каждого компьютера с компонентом Worker.

### 1\. Создайте рабочую область Operations Management Suite
Если у вас еще нет рабочей области Operations Management Suite, создайте ее согласно инструкциям в статье [Создание рабочей области Operational Insights](../operational-insights/operational-insights-onboard-in-minutes.md). Если у вас уже есть рабочая область, вы можете использовать ее.

### 2\. Добавьте решение автоматизации в рабочую область Operations Management Suite
Решения расширяют функциональные возможности Operations Management Suite. Решение автоматизации расширяет функциональные возможности службы автоматизации Azure, включая поддержку гибридных компонентов Runbook Worker. При добавлении решения в рабочую область она автоматически загружает компоненты Worker на компьютер агента, который вы установите на следующем этапе.

Выполните инструкции в статье [Добавление решения с использованием коллекции решений](../operational-insights/operational-insights-setup-workspace.md#1-add-solutions), чтобы добавить решение **автоматизации** в рабочую область Operations Management Suite.

### 3\. Установите агент управления Майкрософт
Агент управления Microsoft подключает компьютеры к Operations Management Suite. Когда агент устанавливается на локальный компьютер и подключается к рабочей области, он автоматически загружает компоненты, необходимые для гибридных модулей Runbook Worker.

Установите агент на локальный компьютер согласно инструкциям в статье [Подключение компьютеров напрямую к Operational Insights](../operational-insights/operational-insights-direct-agent.md). Выполните эту процедуру на нескольких компьютерах, чтобы добавить в среду несколько компонентов Worker.

Агент, успешно подключенный к Operations Management Suite, появится на вкладке **Подключенные источники** в области **Параметры** Operations Management Suite. Если агент загрузил решение автоматизации правильно, в каталоге C:\\Program Files\\Microsoft Monitoring Agent\\Agent появится папка **AzureAutomationFiles**.

### 4\. Установите среду модулей Runbook и выполните подключение к службе автоматизации Azure
При добавлении агента в Operational Management Suite решение автоматизации устанавливает модуль PowerShell **HybridRegistration**, который содержит командлет **Add-HybridRunbookWorker**. Этот командлет используется для установки среды модулей Runbook на компьютере и ее регистрации в службе автоматизации Azure.

Откройте сеанс PowerShell с правами администратора и импортируйте модуль, выполнив указанные ниже команды.

	cd "C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\5.2.20826.0\HybridRegistration"
	Import-Module HybridRegistration.psd1


После этого запустите командлет **Add-HybridRunbookWorker**, используя следующий синтаксис:

	Add-HybridRunbookWorker –Name <String> -EndPoint <Url> -Token <String>

Данные, необходимые для этого командлета, можно найти в колонке **Управление ключами** на портале предварительной версии Azure. Откройте эту колонку, щелкнув значок ключа на панели элементов в учетной записи службы автоматизации.

![Обзор гибридного компонента Runbook Worker](media/automation-hybrid-runbook-worker/elements-panel-keys.png)

- **Имя** — это имя группы гибридных компонентов Runbook Worker. Если эта группа уже существует в учетной записи автоматизации, то к ней добавляется текущий компьютер. Если она еще не существует, то выполняется ее добавление.
- **Конечная точка** — это поле **URL-адрес** в колонке **Управление ключами**.
- **Токен** — **первичный ключ доступа** в колонке **Управление ключами**.  

Для получения подробных сведений об установке используйте переключатель **-Verbose** с параметром **Add-HybridRunbookWorker**.

### 5\. Установка модулей PowerShell
Модули Runbook могут использовать любые из действий и командлетов, которые определены в модулях, установленных в вашей среде службы автоматизации Azure. Эти модули не разворачиваются на локальных машинах автоматически, поэтому их необходимо устанавливать вручную. Исключением является модуль Azure, который устанавливается по умолчанию и предоставляет доступ к командлетам для всех служб и действий службы автоматизации Azure.

Поскольку главной целью функции гибридного компонента Runbook Worker является управление локальными ресурсами, скорее всего, вам потребуется установить модули, которые поддерживают эти ресурсы. Сведения об установке модулей Windows PowerShell можно найти в разделе [Установка модулей](http://msdn.microsoft.com/library/dd878350.aspx).

## Удаление гибридного компонента Runbook Worker

Компонент Hybrid Worker можно удалить с локального компьютера, выполнив на нем командлет **Remove-HybridRunbookWorker**. Получить подробный журнал процедуры удаления можно с помощью переключателя **-Verbose**.

## Запуск модулей Runbook на гибридном компоненте Runbook Worker

В разделе [Запуск модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md) описываются различные методы запуска модуля Runbook. Гибридный компонент Runbook Worker добавляет параметр **RunOn**, при помощи которого можно указать имя группы гибридных компонентов Runbook Worker. При указании группы модуль Runbook извлекается и запускается компонентами Worker в этой группе. Если этот параметр не указан, то он будет запущен в службе автоматизации Azure в обычном режиме.

При запуске модуля Runbook на портале предварительной версии Azure для вас будет выведен параметр **Запуск в**, в котором можно выбрать **Azure** или **Гибридный компонент Worker**. При выборе значения **Гибридный компонент Worker** можно выбрать группу из раскрывающегося списка.

Используйте параметр **RunOn**. Вы можете использовать следующую команду для запуска модуля Runbook с названием Test-Runbook в группе гибридных компонентов Runbook Worker с именем MyHybridGroup при помощи Windows PowerShell.

	Start-AzureAutomationRunbook –AutomationAccountName "MyAutomationAccount" –Name "Test-Runbook" -RunOn "MyHybridGroup"

>[AZURE.NOTE]Параметр **RunOn** был добавлен в командлет **Start-AzureAutomationRunbook** в Microsoft Azure PowerShell версии 0.9.1. Если у вас установлена более ранняя версия, следует [загрузить последнюю версию](http://azure.microsoft.com/downloads). Вам потребуется установить эту версию на рабочую станцию, на которой вы будете запускать модуль Runbook из Windows PowerShell. Вам не нужно устанавливать его на компьютер с компонентом Worker, если вы не собираетесь запускать модули Runbooks с этого компьютера. В настоящий момент вы не можете запускать модуль Runbook в гибридном компоненте Runbook Worker из другого модуля Runbook, поскольку для этого потребуется установить последнюю версию Azure Powershell в учетной записи службы автоматизации. Последняя версия будет автоматически обновлена в службе автоматизации Azure и будет автоматически принудительно установлена в компонентах Worker.

>[AZURE.NOTE]Гибридный компонента Runbook Worker можно запускать только в [графических модулях Runbook и модулях Runbook рабочих процессов PowerShell](automation-runbook-types.md). В настоящее время запустить [модуль Runbook PowerShell](automation-runbook-types.md) в гибридном компоненте Runbook нельзя.

## Устранение неполадок с модулями Runbook в гибридном компоненте Runbook Worker

[Выходные данные Runbook и сообщения](automation-runbook-output-and-messages.md) отправляются в службу автоматизации Azure из гибридных компонентов Worker точно так же, как задания Runbook, которые выполняются в облаке. Потоки Verbose и Progress можно активировать точно так же, как и для других модулей Runbook.

Журналы сохраняются локально в каждом гибридном компоненте Worker по адресу C:\\ProgramData\\Microsoft\\System Center\\Orchestrator\\7.2\\SMA\\Sandboxes.


## Создание модулей Runbook для гибридного компонента Runbook Worker

В структуре модулей Runbook, которые работают в службе автоматизации Azure, отсутствует разница между ними и теми модулями, которые работают в гибридном компоненте Runbook Worker. Модули Runbook, которые будут использоваться в каждом из этих вариантов, скорее всего, будут значительно различаться, поскольку модули Runbook для гибридного компонента Runbook Worker будут обычно управлять локальными ресурсами в вашем центре обработки данных, в то время как модули Runbook в службе автоматизации Azure будут управлять ресурсами в облаке Azure.

### Разрешения для модулей Runbook

Модели Runbook будут работать в контексте локальной системной учетной записи в гибридном компоненте Runbook Worker, поэтому они должна предоставлять свои собственные средства проверки подлинности по отношению к ресурсам, к которым планируется осуществлять доступ. Они не могут использовать тот же [метод, который обычно используется для модулей Runbook, для которых выполняется проверка подлинности в ресурсах Azure](automation-configuring.md#configuring-authentication-to-azure-resources), поскольку планируется их доступ к ресурсам за пределами Azure.

В модуле Runbook можно использовать элементы [Учетные данные](http://msdn.microsoft.com/library/dn940015.aspx) и [Сертификат](http://msdn.microsoft.com/library/dn940013.aspx) с командлетами, позволяющими указать учетные данных для проверки подлинности в различных ресурсах. В следующем примере показана часть модуля Runbook, предназначенная для перезапуска компьютера. Он извлекает учетные данные из набора учетных данных, а также имя компьютера из набора переменных, после чего использует эти значения в сочетании с командлетом Restart-Computer.

	$Cred = Get-AutomationCredential "MyCredential"
	$Computer = Get-AutomationVariable "ComputerName"

	Restart-Computer -ComputerName $Computer  -Credential $Cred

Вы можете также использовать [InlineScript](automation-powershell-workflow.md#inline-script), который позволяет запускать блоки кода на другом компьютере с учетными данными, указанными в [общем параметре PSCredential](http://technet.microsoft.com/library/jj129719.aspx).


### Создание и тестирование модулей Runbook

Вы можете отредактировать модуль Runbook для гибридного компонента Runbook Worker в службе автоматизации Azure, однако вы можете столкнуться с трудностями при попытке тестирования модуля Runbook в редакторе. Модули PowerShell, которые осуществляют доступ к локальным ресурсам, не могут устанавливаться в среде службы автоматизации Azure; если это будет сделано, успешное тестирование станет невозможным. Если вы все же установите необходимые модули, то модуль Runbook будет запущен, однако он не сможет получить доступ к локальным ресурсам в степени, необходимой для завершения тестирования.

## Связь с автоматизацией управления службами

[Автоматизация управления службами (SMA)](https://technet.microsoft.com/library/dn469260.aspx) представляет собой компонент пакета Microsoft Azure, который позволяет запускать те же модули Runbook, которые поддерживаются в службе автоматизации Azure в локальном центре обработки данных. В отличие от службы автоматизации Azure, SMA требует локальной установки с включением портала управления пакетом Microsoft Azure и базы данных для размещения модулей Runbook и конфигурации SMA. Служба автоматизации Azure предоставляет эти службы в облаке, для чего необходимо поддерживать гибридные компоненты Runbook Worker в локальной среде.

Если вы являетесь существующим пользователем SMA, вы можете переместить ваши модели Runbook в службу автоматизации Azure, чтобы затем их использовать с гибридным компонентом Runbook Worker без изменений, предполагая, что они будут выполнять собственную проверку подлинности по отношению к ресурсам, как это описано в разделе [Создание модулей Runbook для гибридного компонента Runbook Worker](#creating-runbooks-for-hybrid-runbook-worker). Модули Runbook в SMA выполняются в контексте учетной записи службы на сервере компонентов Worker, который может обеспечивать проверку подлинности для модулей Runbook.

Вы можете воспользоваться следующими критериями, чтобы определить, что больше подходит под ваши требования: служба автоматизации Azure с гибридным компонентом Runbook Worker или автоматизация управления службами (SMA).

- Для SMA необходима локальная установка пакета Microsoft Azure, в которой используется значительно больше локальных ресурсов с большими затратами на обслуживание, чем в службе автоматизации Azure, которой необходим лишь агент, установленный на локальных компонентах Runbook Worker. Агенты управляются при помощи Operations Management Suite, что позволяет дополнительно снизить затраты на обслуживание.
- Служба автоматизации Azure сохраняет свои модули Runbook в облаке и предоставляет их локальным гибридным компонентам Runbooks Worker. Если ваша политика безопасности не допускает развертывания такой модели, тогда необходимо использовать SMA.
- Пакет Microsoft Azure бесплатен для загрузки, в то время как в отношении службы автоматизации Azure может взиматься плата по подписке. Azure. Для SMA необходимо поддерживать несколько баз данных.
- Служба автоматизации Azure с гибридным компонентом Runbook Worker позволяет управлять модулями Runbook для облачных ресурсов и локальных ресурсов из одного места в отличие от модели с отдельным управлением службой автоматизации Azure и SMA.
- Служба автоматизации Azure обладает расширенными функциями, такими как создание графических компонентов, которые недоступны в SMA.


## Связанные статьи

- [Запуск модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md)
- [Редактирование модуля Runbook в службе автоматизации Azure](https://msdn.microsoft.com/library/dn879137.aspx)
 

<!---HONumber=Oct15_HO3-->