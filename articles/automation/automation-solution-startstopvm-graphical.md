<properties 
	pageTitle="Запуск и остановка виртуальных машин — графические модули | Microsoft Azure"
	description="Версия решения службы автоматизации Azure с рабочим процессом PowerShell включает модули Runbook для запуска и остановки классических виртуальных машин."
	services="automation"
	documentationCenter=""
	authors="bwren"
	manager="stevenka"
	editor="tysonn" />
<tags 
	ms.service="automation"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="infrastructure-services"
	ms.date="01/27/2016"
	ms.author="bwren" />

# Решение для службы автоматизации Azure: запуск и остановка виртуальных машин

В это решение для службы автоматизации Azure входят модули Runbook для запуска и остановки классических виртуальных машин. С этим решением вы можете:

- использовать модули Runbook без внесения изменений в свою рабочую среду; 
- реализовать дополнительные функциональные возможности посредством изменения модулей Runbook;  
- вызывать модули Runbook из другого модуля Runbook в рамках общего решения; 
- Использовать модули Runbook в качестве учебников для ознакомления с основными понятиями Runbook. 

> [AZURE.SELECTOR]
- [Graphical](automation-solution-startstopvm-graphical.md)
- [PowerShell Workflow](automation-solution-startstopvm-psworkflow.md)

Это версия решения с графическим модулем Runbook. Доступно также решение с использованием [модулей Runbook рабочего процесса PowerShell](automation-solution-startstopvm-psworkflow.md).

## Получение решения

Это решение состоит из двух графических модулей Runbook, которые можно загрузить по указанным ниже ссылкам. Ссылки на модули Runnbook рабочего процесса PowerShell см. в разделе [Версия с рабочим процессом PowerShell](automation-solution-startstopvm-psworkflow.md).


| Модуль Runbook | Ссылка | Тип | Описание |
|:---|:---|:---|:---|
| StartAzureClassicVM | [Запуск графического модуля Runbook классической виртуальной машины Azure](https://gallery.technet.microsoft.com/scriptcenter/Start-Azure-Classic-VM-c6067b3d) | Графический модуль | Запуск всех классических виртуальных машин в подписке Azure или всех виртуальных машин с определенным именем службы. |
| StopAzureClassicVM | [Остановка графического модуля Runbook классической виртуальной машины Azure](https://gallery.technet.microsoft.com/scriptcenter/Stop-Azure-Classic-VM-397819bd) | Графический модуль | Остановка всех классических виртуальных машин в учетной записи автоматизации или всех виртуальных машин с определенным именем службы. |


## Установка решения

### 1\. Установите модули Runbook.

После загрузки модулей Runbook вы можете импортировать их с помощью процедуры, описанной в статье [Процедуры графических модулей Runbook](automation-graphical-authoring-intro.md#graphical-runbook-procedures).

### 2\. Просмотрите описание и требования
Модуль Runbook включает действие с именем **Read Me**, содержащее описание и необходимые ресурсы. Чтобы просмотреть эти сведения, выберите действие **Read Me**, а затем параметр **Сценарий рабочего процесса**. Аналогичную информацию можно получить из этой статьи.

### 3\. Настройка ресурсов
Модулям Runbook требуются следующие ресурсы, которые необходимо создать и заполнить соответствующими значениями. Имена присваиваются по умолчанию. Чтобы использовать ресурсы с другими, при запуске модуля Runbook укажите эти имена во [входных параметрах](#using-the-solution).

| Тип ресурса | Имя по умолчанию | Описание |
|:---|:---|:---|:---|
| [Учетные данные](automation-credentials.md) | AzureCredential | Содержит учетные данные для учетной записи, имеющей полномочия для запуска и остановки виртуальных машин в подписке Azure. |
| [Переменная](automation-variables.md) | AzureSubscriptionId | Содержит идентификатор вашей подписки Azure. |

## Использование решения

### Параметры

Модули Runbooks имеют следующие [входные параметры](automation-starting-a-runbook#runbook-parameters). Вам потребуется указать значения всех обязательных параметров и, при необходимости, указать значения дополнительных параметров.

| Параметр | Тип | Обязательно | Описание |
|:---|:---|:---|:---|
| ServiceName | string | Нет | Если значение указано, запускаются или останавливаются все виртуальные машины с таким именем службы. Если значение не указано, запускаются или останавливаются все классические виртуальные машины в подписке Azure. |
| AzureSubscriptionIdAssetName | string | Нет | Содержит имя [ресурса переменной](#installing-the-solution), в котором указан идентификатор вашей подписки Azure. Если значение не указано, используется значение *AzureSubscriptionId*. |
| AzureCredentialAssetName | string | Нет | Содержит имя [ресурса учетных данных](#installing-the-solution), в котором указаны учетные данные используемого модуля Runbook. Если не указать это значение, будет использоваться значение *AzureCredential*. |

### Запуск модулей Runbook

Для запуска любого модуля Runbook в решении вы можете использовать любой из методов, описанных в статье [Запуск модулей Runbook в службе автоматизации Azure](automation-starting-a-runbook.md).

Приведенные ниже команды использует Windows PowerShell для запуска модуля **StartAzureClassicVM**, который запускает все виртуальные машины с именем службы *MyVMService*.

	$params = @{"ServiceName"="MyVMService"}
	Start-AzureAutomationRunbook –AutomationAccountName "MyAutomationAccount" –Name "StartAzureClassicVM" –Parameters $params

### Выходные данные

При выполнении модулей выводятся [сообщения](automation-runbook-output-and-messages.md) для каждой виртуальной машины. Из них можно узнать о результатах инструкций запуска или остановки. Чтобы определить результат выполнения каждого модуля Runbook, найдите в выходных данных соответствующую строку. В следующей таблице перечислены возможные варианты выходных данных.

| Модуль Runbook | Условие | Сообщение |
|:---|:---|:---|
| StartAzureClassicVM | Виртуальная машина уже запущена | MyVM is already running |
| StartAzureClassicVM | Запрос запуска виртуальной машины успешно отправлен | MyVM запущена |
| StartAzureClassicVM | Не удалось выполнить запрос запуска виртуальной машины | Не удалось запустить MyVM |
| StopAzureClassicVM | Виртуальная машина уже запущена | MyVM уже остановлена |
| StopAzureClassicVM | Запрос запуска виртуальной машины успешно отправлен | MyVM запущена |
| StopAzureClassicVM | Не удалось выполнить запрос запуска виртуальной машины | Не удалось запустить MyVM |


Ниже показано использование **StartAzureClassicVM** в качестве [дочернего модуля Runbook](automation-child-runbooks.md) в образце графического модуля Runbook. При этом используются условное ссылки, приведенные в следующей таблице.

| Ссылка | Критерии |
|:---|:---|
| Рабочая ссылка | $ActivityOutput['StartAzureClassicVM'] -like "* запущена" |
| Ошибочная ссылка | $ActivityOutput['StartAzureClassicVM'] -notlike "* запущена" |

![Пример дочернего модуля Runbook](media/automation-solution-startstopvm/graphical-childrunbook-example.png)


## Подробный разбор

Ниже приведен подробный разбор модулей Runbook из этого решения. Вы можете использовать эти сведения для настройки модулей Runbook или просто для их изучения с целью создания собственных решений.
 

### Аутентификация

![Аутентификация](media/automation-solution-startstopvm/graphical-authentication.png)

После запуска модуль Runbook выполняет действия, устанавливающие [учетные данные](automation-configuring.md#configuring-authentication-to-azure-resources) и подписку Azure, которая будет использоваться для остальной части модуля Runbook.

Первые два действия **Get Subscription Id** (Получить идентификатор подписки) и **Get Azure Credential** (Получить учетные данные Azure), получают [ресурсы](#installing-the-solution), которые используются в следующих двух действиях. Эти действия могут определять ресурсы напрямую, но для этого им нужны имена ресурсов. Поскольку мы позволяем пользователю указать эти имена во [входных параметрах](#using-the-solution), нужно сделать так, чтобы эти ресурсы извлекали ресурсы с именем, определенным входным параметром.

Командлет **Add-AzureAccount** определяет, какие учетные данные будут использоваться в остальной части модуля Runbook. Ресурс учетных данных, извлекаемый из модуля **Get Azure Credential** (Получить учетные данные Azure), должен иметь доступ для запуска и остановки виртуальных машин в подписке Azure. Используется подписка, выбранная командлетом **Select-AzureSubscription**, которая использует идентификатор подписки из метода **Get Subscription Id** (Получить идентификатор подписки).

### Получение виртуальных машин

![Получение виртуальных машин](media/automation-solution-startstopvm/graphical-getvms.png)

Модуль Runbook должен определить, с какими виртуальными машинами он будет работать, а также запущены они или остановлены (в зависимости от модуля Runbook). Одно из двух действий извлечет виртуальные машины. Действие **Get VMs in Service** (Получить ВМ в службе) будет выполняться, если входной параметр *ServiceName* для модуля Runbook содержит значение. Действие **Get All VMs** (Получить все ВМ) будет выполняться, если входной параметр *ServiceName* для модуля Runbook не содержит значение. Эта логика выполняется с помощью условных связей, предшествующих каждому действию.

Оба действия используют командлет **Get-AzureVM**. Действие **Get All VMs** (Получить все ВМ) использует набор параметров **ListAllVMs** для возврата всех виртуальных машин. В действии **Get VMs in Service** (Получить ВМ в службе) используется набор параметров **GetVMByServiceAndVMName** и предоставляет входной параметр **ServiceName** для параметра **ServiceName**.

### Объединение виртуальных машин

![Объединение виртуальных машин](media/automation-solution-startstopvm/graphical-mergevms.png)

Действие **Merge VMs** (Объединить ВМ) должно обеспечивать входные данные для действия **Start-AzureVM**, для запуска которого требуются имя и имя службы. Входные данные могут быть получены из действия **Get All VMs** (Получить все ВМ) или **Get VMs in Service** (Получить ВМ в службе), но **Start-AzureVM** позволяет указать в качестве источника только одно из этих действий.

Решение заключается в создании действия **Merge VMs** (Объединить ВМ), которое выполняет командлет **Write-Output**. Параметром **InputObject** для этого командлета является выражение PowerShell, объединяющее выходные параметры двух предыдущих действий. Только одно из этих действий будет выполнено, так что результатом станет только один набор выходных файлов. Командлет **Start-AzureVM** может использовать его как входные параметры.

### Запуск и остановка виртуальных машин

![Запуск виртуальных машин](media/automation-solution-startstopvm/graphical-startvm.png) ![Остановка виртуальных машин](media/automation-solution-startstopvm/graphical-stopvm.png)

Дальнейшие действия попытаются запустить или остановить модуль Runbook с помощью командлета **Start-AzureVM** или **Stop-AzureVM** в зависимости от типа этого модуля. Поскольку действию предшествует конвейерная связь, оно будет выполнено по одному разу для каждого объекта, полученного из метода **Merge VMs** (Объединить ВМ). Эта связь условна, так что действие будет выполняться только в том случае, если параметр *RunningState* (Состояние выполнения) виртуальной машины имеет значение *Stopped* (Остановлена) для командлета **Start-AzureVM** или *Started* (Запущена) для командлета **Stop-AzureVM**. Если это условие не соблюдено, выполняется действие **Notify Already Started** (Сообщить, что уже запущена) или **Notify Already Stopped** (Сообщить, что уже остановлена), отправляющее сообщение с помощью команды **Write-Output** (Записать выходные данные).

### Передача выходных данных

![Сообщение о запуске ВМ](media/automation-solution-startstopvm/graphical-notifystart.png) ![Сообщение об остановке ВМ](media/automation-solution-startstopvm/graphical-notifystop.png)

Последний шаг в модуле — это передача выходных данных об успешности выполнения запроса о запуске или остановке каждой виртуальной машины. Для каждой машины создается отдельное действие **Write-Output** (Записать выходные данные) и определяется, какая из них будет запущена с условными связями.После Действие **Notify VM Started** (Сообщить о запуске ВМ) или **Notify VM Stopped** (Сообщить об остановке ВМ), если параметр *OperationStatus* (Состояние операции) имеет значение *Succeeded* (Успешно). Если параметр *OperationStatus* (Состояние операции) имеет другое значение, выполняется действие **Notify Failed To Start** (Сообщить о сбое запуска) или **Notify Failed to Stop** (Сообщить о сбое остановки).


## Связанные статьи

- [Графическая разработка в службе автоматизации Azure](automation-graphical-authoring-intro.md)
- [Дочерние модули Runbook в службе автоматизации Azure](automation-child-runbooks.md) 
- [Выходные данные и сообщения Runbook в службе автоматизации Azure](automation-runbook-output-and-messages.md)

<!---HONumber=AcomDC_0204_2016-->