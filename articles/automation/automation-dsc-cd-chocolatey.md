<properties
   pageTitle="Непрерывное развертывание с помощью Automation DSC Azure и Chocolatey | Microsoft Azure"
   description="Непрерывное развертывание DevOps с помощью Automation DSC Azure и диспетчера пакетов Chocolatey. Пример с полным шаблоном ARM в формате JSON и исходным кодом PowerShell."
   services="automation"
   documentationCenter=""
   authors="sebastus"
   manager="stevenka"
   editor=""/>

<tags
   ms.service="automation"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="vm-windows"
   ms.workload="na"
   ms.date="10/07/2015"
   ms.author="golive"/>

# Непрерывное развертывание на виртуальных машинах IaaS с помощью Automation DSC Azure и Chocolatey

В среде DevOps существует множество средств, которые упрощают различные аспекты процесса непрерывной интеграции. Платформа для настройки требуемого состояния службы автоматизации Azure (далее — Automation DSC Azure) — это долгожданная новая функция, которую могут использовать команды разработчиков DevOps. В этой статье показана настройка непрерывного развертывания для компьютера Windows. Применение этого метода можно легко расширить, включив любое количество компьютеров Windows, необходимое для роли (например, веб-сайта), а также дополнительные роли.

Метаданные. Эта статья написана в сентябре 2015 г. Здесь рассматривается версия Visual Studio 2015. [Средства PowerShell для Visual Studio](http://adamdriscoll.github.io/poshtools/) установлены и упрощают работу с PowerShell благодаря недавно добавленной подсветке синтаксиса и технологии Intellisense. В настоящее время Automation DSC Azure существует в предварительной версии для всеобщего ознакомления, поэтому в официальной общедоступной версии возможны изменения. Пример [полного исходного кода](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) на GitHub.

![Непрерывное развертывание для виртуальных машин IaaS](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

## На высоком уровне

Эта схема включает немало действий, но, к счастью, их можно разбить на два основных процесса:

  - написание и тестирование кода, после чего следуют создание и публикация пакетов установки для основной и вспомогательной версий системы; 
  - создание виртуальных машин, которые установят и выполнят код в пакетах, и управление этими виртуальными машинами.  

Выполнив эти основные процессы, можно переходить к автоматическому обновлению пакета, который выполняется на любой отдельно взятой виртуальной машине, по мере создания и развертывания новых версий.

## Обзор компонентов

Диспетчеры пакетов, такие как [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool), хорошо известны среди разработчиков Linux и гораздо меньше — среди тех, кто работает с Windows. К таким диспетчерам пакетов относится [Chocolatey](https://chocolatey.org/), общие сведения о котором изложены в [записи блога](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) Скотта Ханселмана (Scott Hanselman). В двух словах, Chocolatey позволяет устанавливать пакеты из центрального репозитория пакетов в системе Windows с помощью командной строки. Вы можете создать собственный репозиторий и управлять им, а Chocolatey будет устанавливать пакеты из любого указанного вами количества репозиториев.

Настройка требуемого состояния (DSC) ([обзор](https://technet.microsoft.com/ru-RU/library/dn249912.aspx)) — это средство PowerShell, которое позволяет объявить конфигурацию, необходимую для компьютера. Например, вы можете указать, что нужно установить Chocolatey и IIS, открыть порт 80 и установить версию 1.0.0 вашего веб-сайта. Локальный диспетчер конфигураций DSC реализует эту конфигурацию. Опрашивающий сервер DSC содержит хранилище конфигураций для компьютеров. Локальный диспетчер конфигураций на каждом компьютере периодически проверяет, совпадает ли его конфигурация с сохраненной конфигурацией. Он либо сообщает о состоянии, либо пытается привести компьютер в соответствие с сохраненной конфигурацией. Сохраненную конфигурацию на опрашивающем сервере можно изменить, чтобы привести компьютер или набор компьютеров в соответствие с измененной конфигурацией.

Служба автоматизации Azure — это управляемая служба в Microsoft Azure, которая позволяет автоматизировать различные задачи с помощью модулей Runbook и других ресурсов, таких как узлы, учетные данные и т. д. Automation DSC Azure расширяет возможности автоматизации, которые теперь включают средства DSC PowerShell. Вот прекрасный [обзор](automation-dsc-overview.md) на эту тему.

Ресурс DSC — это модуль кода, который имеет определенные возможности, такие как управление сетевыми подключениями, Active Directory или SQL Server. Ресурс DSC Chocolatey может получать доступ к серверу NuGet, загружать и устанавливать пакеты и т. д. Существует также множество других ресурсов DSC, доступных в [коллекции PowerShell](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title). Эти модули установлены на опрашивающем сервере Automation DSC Azure (вручную), поэтому их можно использовать в ваших конфигурациях.

Шаблоны ARM предоставляют декларативный способ создания инфраструктуры с помощью сетей, подсетей, сетевой безопасности и маршрутизации, балансировщиков нагрузки, сетевых карт, виртуальных машин и т. д. В этой [статье](../resource-manager-deployment-model.md) сравнивается декларативная модель развертывания ARM и принудительная модель развертывания управления службами Azure (ASM, или классическая). Вот еще одна [статья](../virtual-machines\virtual-machines-azurerm-versus-azuresm.md) об основных поставщиках ресурсов, вычислениях, хранилище и сети.

Одной из ключевых особенностей шаблона ARM является возможность установить на виртуальной машине расширение VM во время подготовки. Расширение VM предоставляет определенные возможности, такие как выполнение пользовательского сценария, установка антивирусного программного обеспечения или выполнение сценария конфигурации DSC. Существует много других типов расширений VM.

## Краткий обзор схемы

Если начинать сначала, вы пишете код, выполняете сборку и тестирование, а затем создаете пакет установки. Chocolatey может обрабатывать пакеты установки различных типов, например MSI, MSU и ZIP. Кроме того, в вашем распоряжении имеются все возможности PowerShell для фактической установки, если возможностей Chocolatey недостаточно. Поместите пакет в легкодоступное место — репозиторий пакетов. Он может располагаться где угодно. Например, я использую общую папку в своей учетной записи хранилища BLOB-объектов Azure. Chocolatey работает непосредственно с серверами NuGet и некоторыми другими серверами в рамках управления метаданными пакета. Возможные варианты описаны в [этой статье](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed). В нашем примере используется сервер NuGet. Nuspec — это метаданные о пакетах. Метаданные Nuspec «компилируются» в файлы NuPkg и хранятся на сервере NuGet. Когда конфигурация запрашивает пакет по имени и ссылается на сервер NuGet, ресурс DSC Chocolatey (установленный на виртуальной машине) извлекает пакет и устанавливает его автоматически. Можно также запросить определенную версию пакета.

В левой нижней части схемы упоминается шаблон диспетчера ресурсов Azure (ARM). В этом примере расширение VM регистрирует виртуальную машину на опрашивающем сервере Automation DSC Azure как узел. Конфигурация хранится на опрашивающем сервере. На самом деле это двойное хранение: в виде обычного текста и в виде компиляции в MOF-файле (для тех, кто имеет опыт работы с такими файлами). На портале MOF-файл указывается как «конфигурация узла» (а не просто «конфигурация»). Это связанный с узлом артефакт, сообщающий узлу его конфигурацию. Ниже объясняется, как назначить узлу конфигурацию узла.

Скорее всего, вы уже выполнили действия в верхней части схемы или большую их часть. Создание метаданных Nuspec, их компиляция и сохранение на сервере NuGet — несложная задача. Кроме того, вы уже управляете виртуальными машинами. Чтобы выполнить следующий шаг для непрерывного развертывания, необходимо настроить опрашивающий сервер (один раз), зарегистрировать на нем узлы (один раз), а также создать и сохранить на нем конфигурацию (первоначально). Затем, по мере обновления и развертывания пакетов в репозитории, обновляйте конфигурацию на опрашивающем сервере (повторяйте при необходимости).

Начинать работу с шаблона ARM не обязательно. Существуют командлеты PowerShell, которые помогут вам зарегистрировать виртуальные машины на опрашивающем сервере и выполнить все остальные действия.


## Шаг 1. Настройка опрашивающего сервера и учетной записи службы автоматизации

В командной строке PowerShell с проверкой подлинности (Add-AzureAccount) выполните следующую команду (настройка опрашивающего сервера может занять несколько минут):

    Switch-AzureMode -Name AzureResourceManager 
    Register-AzureProvider –ProviderNamespace Microsoft.Automation 
    Register-AzureProviderFeature -FeatureName dsc -ProviderNamespace Microsoft.Automation 
    New-AzureResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
    New-AzureAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT 

Учетная запись службы автоматизации может располагаться в любом регионе (местоположении) из следующего списка: Восточная Япония, Восток США 2, Западная Европа, Юго-Восточная Азия, Юг и центр США. Конечно, следует убедиться, что ваша группа ресурсов службы автоматизации находится в том же регионе, что и учетная запись службы автоматизации.

## Шаг 2. Оптимизация расширения VM в шаблоне ARM

Сведения о регистрации виртуальных машин (с помощью расширения VM PowerShell DSC) можно найти в этом [кратком руководстве по шаблонам Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver). На этом шаге новая виртуальная машина регистрируется на опрашивающем сервере в списке узлов DSC.

## Шаг 3. Добавление требуемых ресурсов DSC на опрашивающий сервер

Коллекция PowerShell содержит средства для установки ресурсов DSC в учетной записи службы автоматизации Azure. Перейдите к нужному ресурсу и нажмите кнопку «Развернуть в службе автоматизации Azure».

![Пример из коллекции PowerShell](./media/automation-dsc-cd-chocolatey/cchoco.png)

Также это можно сделать вручную. Структура папок модуля интеграции PowerShell для компьютеров Windows немного отличается от структуры папок, ожидаемой опрашивающим сервером Automation DSC Azure. Некоторые параметры вам придется настроить самостоятельно. Но эту процедуру нужно выполнить только один раз для каждого ресурса (если вы не планируете обновлять его в будущем), и в ней нет ничего сложного.

-   Установите модуль, необходимый на рабочей станции, следующим образом:
    -   Установите [Windows Management Framework v5](http://aka.ms/wmf5latest). 
    -   `Install-Module  –ModuleName MODULENAME` <— извлекает модуль из галереи PowerShell. 
-   Скопируйте папку модуля из `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` во временную папку. 
-   Удалите примеры и документацию из основной папки. 
-   Запакуйте основную папку, присвоив ZIP-файлу точно такое же имя, как у папки. 
-   Поместите ZIP-файл в легкодоступное расположение HTTP. 
-   Выполните эту команду PowerShell:

        New-AzureAutomationModule ``
            -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT ``
            -Name MODULE-NAME –ContentLink "https://STORAGE-URI/public/MODULE-NAME.zip"
        

Приведенный здесь пример выполняет эти действия для cChoco и xNetworking.

## Шаг 4. Добавление конфигурации узла к опрашивающему серверу

В первоначальном импорте конфигурации на опрашивающий сервер и ее компиляции нет ничего особенного. Все последующие операции импорта и компиляции с этой конфигурацией выполняются аналогичным образом. Каждый раз, когда вам нужно обновить пакет и передать его в рабочую среду, выполняйте этот шаг, предварительно проверив правильность файла конфигурации (включая новую версию пакета). Вот файл конфигурации и команда PowerShell:

    Configuration ISVBoxConfig 
    { 
        Import-DscResource -ModuleName cChoco 
        Import-DscResource -ModuleName xNetworking
    
        Node "isvbox" {   <— node must be named, $AllNodes.NodeName won’t work.
    
            cChocoInstaller installChoco 
            { 
                InstallDir = "C:\choco" 
            }
    
            WindowsFeature installIIS 
            { 
                Ensure="Present" 
                Name="Web-Server" 
            }
    
            xFirewall WebFirewallRule 
            { 
                Direction = "Inbound" 
                Name = "Web-Server-TCP-In" 
                DisplayName = "Web Server (TCP-In)" 
                Description = "IIS allow incoming web site traffic." 
                DisplayGroup = "IIS Incoming Traffic" 
                State = "Enabled" 
                Access = "Allow" 
                Protocol = "TCP" 
                LocalPort = "80" 
                Ensure = "Present" 
            }
    
            cChocoPackageInstaller trivialWeb 
            {            
                Name = "trivialweb" 
                Version = "1.0.0" 
                Source = “MY-NUGET-SERVER-ADDRESS” 
                DependsOn = "[cChocoInstaller]installChoco", 
                "[WindowsFeature]installIIS" 
            } 
        }    
    }

    Import-AzureAutomationDscConfiguration ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 ` 
        -Published –Force
    
    $jobData = Start-AzureAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -ConfigurationName ISVBoxConfig 
    
    $compilationJobId = $jobData.Id
    
    Get-AzureAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -Id $compilationJobId

В результате этих действий будет создана новая конфигурация узла с именем ISVBoxConfig.isvbox. Имя задается в формате «имя\_конфигурации.имя\_узла».

## Шаг 5. Назначение узлу конфигурации узла

Для этого шага на опрашивающий сервер необходимо отправить запрос, чтобы получить идентификатор новой виртуальной машины после ее регистрации. Это можно сделать с помощью командлета Get-AzureAutomationDscNode. В нем есть несколько подходящих фильтров, но в общем случае требуется передать выходные данные через фильтр, который будет извлекать виртуальные машины с шаблоном имени. Если вы создаете виртуальные машины только для одной роли, вы можете извлечь все VM, у которых параметр NodeConfigurationName имеет значение ConfigureLCMforAAPull.isvbox. Это имя конфигурации любой недавно зарегистрированной виртуальной машины (если вы следуете инструкциям в этом примере). Получив список идентификаторов, используйте следующий командлет:

    Set-AzureAutomationDscNode ` 
        -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -NodeConfigurationName ISVBoxConfig.isvbox -Id $theId

## Шаг 6. Куда поместить этот сценарий PowerShell?

При создании настраиваемых шаблонов ARM существует сценарий PowerShell, предоставляемый Visual Studio, который вызывает шаблон. К этому сценарию можно добавить командлеты для импорта и компиляции конфигурации, получения идентификаторов виртуальных машин и т. д. Пример исходного кода можно просмотреть на GitHub. Для действий, которые выполняются каждый раз при обновлении пакета, следует внедрить необходимые команды в конвейер непрерывной интеграции.

## Шаг 7. Создание и поддержка метаданных пакета

Для описания каждого пакета, который помещается в репозиторий пакетов, необходимы метаданные Nuspec. Эти метаданные Nuspec следует компилировать и хранить на сервере NuGet. Этот процесс описан [здесь](http://docs.nuget.org/create/creating-and-publishing-a-package). В качестве сервера NuGet можно использовать сайт MyGet.org. Это платная служба, но начальные единицы хранения предоставляются бесплатно. На сайте NuGet.org вы найдете инструкции по установке сервера NuGet для закрытых пакетов.

## Примечания

В начале этого примера создается виртуальная машина с помощью универсального образа Windows 2012 R2 из коллекции Azure. Ее можно запустить из любого сохраненного образа, а затем настроить, используя конфигурацию DSC.

Для использования этого метода на виртуальных машинах не обязательно использовать шаблон ARM и расширение VM. Кроме того, виртуальные машины на которых должно выполняться непрерывное развертывание, не обязательно должны размещаться Azure. На виртуальной машине достаточно установить Chocolatey и настроить локальный диспетчер конфигураций, чтобы указать для нее расположение опрашивающего сервера.

Конечно, на время обновления пакета на виртуальной машине в рабочей среде эту виртуальную машину придется вывести из эксплуатации. Это можно сделать разными способами. Например, на виртуальной машине, которая находится под контролем балансировщика нагрузки Azure, можно добавить настраиваемый зонд. При обновлении виртуальной машины конечная точка зонда должна возвращать значение 400. Настройка, необходимая для этого изменения, может содержаться в вашей конфигурации, и после завершения обновления вы сможете снова переключиться на возвращение значения 200.

Полный исходный код для этого примера хранится в [этом проекте Visual Studio](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) на сайте GitHub.

<!---HONumber=Oct15_HO3-->