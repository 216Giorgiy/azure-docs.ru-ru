<properties
   pageTitle="Выходные данные и сообщения Runbook в службе автоматизации Azure | Microsoft Azure"
   description="Описывает способы создания и извлечения выходных данных и сообщений об ошибках из модулей Runbook в службе автоматизации Azure."
   services="automation"
   documentationCenter=""
   authors="mgoedtel"
   manager="stevenka"
   editor="tysonn" />
<tags
   ms.service="automation"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/03/2016"
   ms.author="magoedte;bwren" />

# Выходные данные и сообщения Runbook в службе автоматизации Azure

У большинства Runbook службы автоматизации Azure будут выходные данные какого-либо вида, например сообщение об ошибке для пользователя или сложный объект, предназначенный для использования другим рабочим процессом. Windows PowerShell предоставляет [несколько потоков](http://blogs.technet.com/heyscriptingguy/archive/2014/03/30/understanding-streams-redirection-and-write-host-in-powershell.aspx) для отправки выходных данных из сценария или рабочего процесса. Служба автоматизации Azure по-разному работает с каждым из этих потоков, и необходимо следовать рекомендациям по их использованию при создании Runbook.

Следующая таблица содержит краткое описание каждого из потоков и их поведение на портале управления Azure при выполнении опубликованного Runbook и при [тестировании Runbook](http://msdn.microsoft.com/library/azure/dn879147.aspx). В последующих разделах приведены дополнительные сведения о каждом потоке.

| Поток | Описание | Опубликовано | Тест|
|:---|:---|:---|:---|
|Выходные данные|Объекты, предназначенные для использования другими Runbook.|Записывается в журнал заданий.|Отображается в области вывода теста.|
|Предупреждение|Предупреждающее сообщение, предназначенное для пользователя.|Записывается в журнал заданий.|Отображается в области вывода теста.|
|Ошибка|Сообщение об ошибке, предназначенное для пользователя. В отличие от исключения, по умолчанию Runbook продолжит работу после сообщения об ошибке.|Записывается в журнал заданий.|Отображается в области вывода теста.|
|Подробная информация|Сообщения, содержащие общую или отладочную информацию.|Записывается в журнал заданий только в том случае, если для Runbook включено подробное ведение журнала.|Отображается в области вывода теста только в том случае, если в Runbook для $VerbosePreference задано значение Continue.|
|Ход выполнения|До и после каждого действия в Runbook автоматически создаются записи. Модулю Runbook не следует пытаться создать свои собственные записи хода выполнения, так как они предназначены для интерактивного пользователя.|Записывается в журнал заданий только в том случае, если для Runbook включено ведение журнала хода выполнения.|Не отображается в области вывода теста.|
|Отладка|Сообщения, предназначенные для интерактивного пользователя. Не следует использовать в Runbook.|Не записывается в журнал заданий.|Не записывается в область вывода теста.|

## Поток вывода

Поток вывода предназначен для вывода объектов, созданных сценарием или рабочим процессом, когда он работает правильно. В службе автоматизации Azure этот поток в основном используется для объектов, которые предназначены для использования [родительским Runbook, вызывающим текущий Runbook](automation-child-runbooks.md). Если вы [используете встроенный вызов Runbook](automation-child-runbooks.md/#InlineExecution) из родительского Runbook, он возвращает данные из потока вывода в родительский Runbook. Для передачи информации пользователю следует использовать только поток вывода, если известно, что Runbook никогда не будет вызван другим Runbook. Однако в обычном случае для передачи информации пользователю рекомендуется использовать [подробный поток](#Verbose).

Можно записать данные в поток вывода с помощью [Write-Output](http://technet.microsoft.com/library/hh849921.aspx) или поместив объект в отдельную строку в Runbook.

	#The following lines both write an object to the output stream.
	Write-Output –InputObject $object
	$object

### Выходные данные функции

При записи в поток вывода в функции, которая находится в Runbook, выходные данные передаются обратно в Runbook. Если Runbook присваивает эти выходные данные переменной, то они не записываются в поток вывода. Запись в любые другие потоки из функции приведет к записи в соответствующий поток для Runbook.

Рассмотрим следующий пример Runbook.

	Workflow Test-Runbook
	{
	   Write-Verbose "Verbose outside of function"
	   Write-Output "Output outside of function"
	   $functionOutput = Test-Function

	   Function Test-Function
	   {
	      Write-Verbose "Verbose inside of function"
	      Write-Output "Output inside of function"
	   }
	}

Поток вывода для задания Runbook будет следующим:

	Output outside of function

Подробный поток для задания Runbook будет следующим:

	Verbose outside of function
	Verbose inside of function

### Объявление типа выходных данных

Рабочий процесс может указать тип выходных данных с помощью [атрибута OutputType](http://technet.microsoft.com/library/hh847785.aspx). Этот атрибут не оказывает влияния во время выполнения, но содержит указание об ожидаемых выходных данных Runbook для автора Runbook во время разработки. Так как набор инструментов для Runbook продолжает увеличиваться, растет и важность объявления типов выходных данных во время разработки. Поэтому рекомендуется включать это объявление во все создаваемые вами Runbook.

Следующий пример Runbook выводит строковый объект и включает в себя объявление типа выходных данных. Если Runbook выводит массив определенного типа, все равно следует указать его тип, а не массив типа.

	Workflow Test-Runbook
	{
	   [OutputType([string])]

	   $output = "This is some string output."
	   Write-Output $output
	}

## Потоки сообщений

В отличие от потока вывода потоки сообщений предназначены для передачи информации пользователю. Существует несколько потоков сообщений для различных типов информации, и каждый по-разному обрабатываются службой автоматизации Azure.

### Потоки предупреждений и ошибок

Потоки предупреждений и ошибок предназначены для ведения журнала проблем, возникающих в Runbook. Они записываются в журнал заданий при выполнении Runbook и добавляются в область вывода теста на портале управления Azure при тестировании Runbook. По умолчанию Runbook продолжит выполнение после предупреждения или ошибки. Можно указать, что Runbook должен быть приостановлен при предупреждении или ошибке, задав [привилегированную переменную](#PreferenceVariables) в Runbook перед созданием сообщения. Например, чтобы приостановить Runbook при ошибке, как при исключении, присвойте **$ErrorActionPreference** значение Stop.

Создайте предупреждение или сообщение об ошибке с помощью командлета [Write-Warning](https://technet.microsoft.com/library/hh849931.aspx) или [Write-Error](http://technet.microsoft.com/library/hh849962.aspx). Действия также могут записывать данные в эти потоки.

	#The following lines create a warning message and then an error message that will suspend the runbook.

	$ErrorActionPreference = "Stop"
	Write-Warning –Message "This is a warning message."
	Write-Error –Message "This is an error message that will stop the runbook because of the preference variable."

### Подробный поток

Поток подробных сообщений предназначен для общей информации о работе Runbook. Так как в Runbook недоступен [поток отладки](#Debug), подробные сообщения следует использовать для отладки. По умолчанию подробные сообщения из опубликованных Runbook не будут сохраняться в журнале заданий. Чтобы сохранять подробные сообщения, настройте для опубликованных Runbook добавление подробных записей в журнал на вкладке «Настройка» Runbook на портале управления Azure. В большинстве случаев для Runbook следует оставить значение по умолчанию, при котором подробные записи не добавляются в журнал. Это обусловлено вопросами производительности. Включайте этот параметр только для устранения неполадок и отладки Runbook.

При [тестировании Runbook](http://msdn.microsoft.com/library/azure/dn879147.aspx) подробные сообщения не отображаются, даже если для Runbook настроено добавление подробных записей в журнал. Для отображения подробных сообщений при [тестировании Runbook](http://msdn.microsoft.com/library/azure/dn879147.aspx) необходимо переменной $VerbosePreference присвоить значение Continue. После этого подробные сообщения будут показаны в области вывода теста на портале управления Azure.

Для создания подробного сообщения используется командлет [Write-Verbose](http://technet.microsoft.com/library/hh849951.aspx).

	#The following line creates a verbose message.

	Write-Verbose –Message "This is a verbose message."

### Поток отладки

Поток отладки предназначен для использования интерактивным пользователем и не должен использоваться в модулях Runbook.

## Записи о ходе выполнения

Если настроить Runbook для ведения журнала хода выполнения (на вкладке «Настройка» Runbook на портале управления Azure), то до и после выполнения каждого действия в журнал заданий будет добавляться соответствующая запись. В большинстве случаев для Runbook следует оставить значение по умолчанию, при котором записи о ходе выполнения не добавляются в журнал. Это позволит получить максимальную производительность. Включайте этот параметр только для устранения неполадок и отладки Runbook. При тестировании Runbook сообщения о ходе выполнения не отображаются, даже если для него настроено добавление записей о ходе выполнения в журнал.

Командлет [Write-Progress](http://technet.microsoft.com/library/hh849902.aspx) недействителен в Runbook, так как предназначен для использования интерактивным пользователем.

## Привилегированные переменные

Windows PowerShell использует [привилегированные переменные](http://technet.microsoft.com/library/hh847796.aspx), чтобы определить, как реагировать на данные, отправляемые в различные потоки вывода. Вы можете задать эти переменные в Runbook, чтобы управлять его реакцией на данные, отправляемые в разные потоки.

В следующей таблице перечислены привилегированные переменные, которые могут использоваться в модулях Runbook, а также их допустимые значения и значения по умолчанию. Обратите внимание, что эта таблица содержит только значения, которые являются допустимыми в Runbook. Дополнительные значения привилегированных переменных допускаются при использовании в Windows PowerShell за пределами службы автоматизации Azure.

| Переменная| Значение по умолчанию| Допустимые значения|
|:---|:---|:---|
|WarningPreference|Continue|Stop<br>Continue<br>SilentlyContinue|
|ErrorActionPreference|Continue|Stop<br>Continue<br>SilentlyContinue|
|VerbosePreference|SilentlyContinue|Stop<br>Continue<br>SilentlyContinue|

В следующей таблице представлено поведение для соответствующих значений привилегированных переменных, допустимых в Runbook.

| Значение| Поведение|
|:---|:---|
|Continue|Записывает сообщение в журнал и продолжает выполнение Runbook.|
|SilentlyContinue|Продолжает выполнение Runbook без добавления сообщения в журнал. То есть сообщение игнорируется.|
|Остановить|Записывает сообщение в журнал и приостанавливает выполнение Runbook.|

## Извлечение выходных данных и сообщений Runbook

### Портал управления Azure

На портале управления Azure на вкладке «Задания» Runbook можно просмотреть подробную информацию о задании Runbook. Помимо общей информации о задании, сводка задания будет содержать входные параметры и [поток вывода](#Output), а также все возникшие исключения. Кроме [подробного потока](#Verbose) и [записей о ходе выполнения](#Progress) журнал будет содержать сообщения из [потока вывода](#Output) и [потоков предупреждений и ошибок](#WarningError), если для Runbook настроено добавление в журнал подробных сообщений и записей о ходе выполнения.

### Windows PowerShell

В Windows PowerShell выходные данные и сообщения из Runbook можно извлечь с помощью командлета [Get AzureAutomationJobOutput](http://msdn.microsoft.com/library/dn690268.aspx). Для этого командлета требуется идентификатор задания, также у него есть параметр Stream, в котором указывается возвращаемый поток. Можно указать значение Any для возврата всех потоков для задания.

В следующем примере запускается пример Runbook и ожидается его завершение. После завершения его поток вывода собирается из задания.

	$job = Start-AzureAutomationRunbook –AutomationAccountName "MyAutomationAccount" –Name "Test-Runbook"

	$doLoop = $true
	While ($doLoop) {
	   $job = Get-AzureAutomationJob –AutomationAccountName "MyAutomationAccount" -Id $job.Id
	   $status = $job.Status
	   $doLoop = (($status -ne "Completed") -and ($status -ne "Failed") -and ($status -ne "Suspended") -and ($status -ne "Stopped")
	}

	Get-AzureAutomationJobOutput –AutomationAccountName "MyAutomationAccount" -Id $job.Id –Stream Output

### Графическая разработка

Для графических модулей Runbook дополнительное ведение журнала доступно в виде трассировки на уровне действий. Существует два уровня трассировки: базовая и подробная. Базовая трассировка включает время начала и окончания каждого действия в модуле Runbook, а также сведения обо всех повторных действиях, включая число попыток и время начала. Подробная трассировка включает те же данные, что и базовая, плюс входные и выходные данные каждого действия. В настоящее время записи трассировки ведутся с использованием подробного потока, поэтому при включении трассировки необходимо также включать подробное ведение журнала. Для графических модулей Runbook с включенной трассировкой ведение записей о ходе выполнения не требуется, поскольку базовая трассировка не только решает эту задачу, но и является более информативной.

![Представление потоков заданий графической разработки](media/automation-runbook-output-and-messages/job-streams-view-blade.png)

На приведенном выше снимке экрана видно, что при включении подробного журнала и трассировки для графических модулей Runbook представление потоков заданий в рабочей среде содержит гораздо больше данных. Эти дополнительные сведения могут пригодиться во время поиска и устранения неисправностей, связанных с модулем Runbook. Включайте их только для этой цели, в обычном режиме подобная детализация не требуется. Записи трассировки могут быть очень многочисленными. При трассировке графических модулей Runbook создается от двух до четырех записей на каждое действие в зависимости от того, какая выбрана трассировка — базовая или подробная. Если эти данные не требуются для контроля за выполнением модуля Runbook в целях устранения неисправностей, трассировку можно отключить.

**Чтобы включить трассировку на уровне действий, выполните указанные ниже действия.**

 1. На портале Azure выберите свою учетную запись в службе автоматизации.

 2. Щелкните плитку **Модули Runbook**, чтобы открыть список модулей Runbook.

 3. В колонке "Модули Runbook" выберите графический модуль Runbook.

 4. В колонке "Параметры" для выбранного модуля щелкните **Ведение журнала и трассировка**.

 5. В разделе "Записи ведения журнала" колонки "Ведение журнала и трассировка" щелкните **Включить**, чтобы включить подробное ведение журнала, а в колонке "Трассировка на уровне действий" измените уровень трассировки с **Базовой** на **Подробную** в зависимости от того, какой уровень трассировки вам требуется.<br>

    ![Колонка ведения журналов и трассировки графической разработки](media/automation-runbook-output-and-messages/logging-and-tracing-settings-blade.png)

## Связанные статьи

- [Отслеживание задания Runbook](automation-runbook-execution.md)
- [Дочерние Runbook](http://msdn.microsoft.com/library/azure/dn857355.aspx)

<!---HONumber=AcomDC_0309_2016-->