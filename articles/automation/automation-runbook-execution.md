---
title: Выполнение модуля Runbook в службе автоматизации Azure
description: Рассматривается обработка модуля Runbook в службе автоматизации Azure.
services: automation
ms.service: automation
ms.component: process-automation
author: georgewallace
ms.author: gwallace
ms.date: 05/08/2018
ms.topic: conceptual
manager: carmonm
ms.openlocfilehash: ff58e22f8b9b837ec272cd2cd6193da80a7b718e
ms.sourcegitcommit: eb75f177fc59d90b1b667afcfe64ac51936e2638
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2018
ms.locfileid: "34195426"
---
# <a name="runbook-execution-in-azure-automation"></a>Выполнение модуля Runbook в службе автоматизации Azure

При запуске модуля Runbook в службе автоматизации Azure создается задание. Задание — это одиночный выполняемый экземпляр модуля Runbook. Рабочий процесс службы автоматизации Azure назначается для выполнения каждого задания. Пока рабочие процессы используются несколькими учетными записями Azure, задания от различных учетных записей службы автоматизации изолируются друг от друга. Вы не контролируете, какая рабочая роль обслуживает запрос для вашего задания. В одном модуле Runbook могут иметься несколько запущенных заданий одновременно. Можно повторно использовать среду выполнения для заданий из одной учетной записи службы автоматизации. При просмотре списка модулей Runbook на портале Azure в нем отобразится список состояний всех заданий для каждого модуля Runbook. Можно просматривать список заданий для каждого модуля Runbook и отслеживать состояние каждого из них. Описание различных состояний заданий см. в разделе [Состояния заданий](#job-statuses).

[!INCLUDE [gdpr-dsr-and-stp-note.md](../../includes/gdpr-dsr-and-stp-note.md)]

На следующей схеме показан жизненный цикл задания Runbook для [графических модулей Runbook](automation-runbook-types.md#graphical-runbooks) и [модулей Runbook рабочих процессов PowerShell](automation-runbook-types.md#powershell-workflow-runbooks).

![Состояния задания — рабочий процесс PowerShell](./media/automation-runbook-execution/job-statuses.png)

На следующей схеме показан жизненный цикл задания Runbook для [модулей Runbook PowerShell](automation-runbook-types.md#powershell-runbooks).

![Состояния задания — сценарий PowerShell](./media/automation-runbook-execution/job-statuses-script.png)

Задания имеют доступ к ресурсам Azure за счет подключения к ресурсам подписки Azure. Задания имеют доступ только к ресурсам в центре обработки данных, если эти ресурсы доступны из общедоступного облака.

## <a name="job-statuses"></a>Состояния заданий

Следующая таблица содержит описание различных состояний задания.

| Status | ОПИСАНИЕ |
|:--- |:--- |
| Завершено |Задание успешно выполнено. |
| Failed |Для [графических модулей Runbook и модулей Runbook рабочих процессов PowerShell](automation-runbook-types.md): не удалось скомпилировать модуль Runbook. Для [модулей Runbook сценариев PowerShell](automation-runbook-types.md): не удалось запустить Runbook или задание породило исключение. |
| Задание не выполнено. Ожидание ресурсов. |Задание не выполнено, так как задание превысило ограничение [доли](#fair-share) три раза и было запущено с той же контрольной точки или с момента запуска модуля Runbook. |
| Поставлено в очередь |Задание ожидает появления доступных ресурсов в очереди автоматизации, которые позволят запустить задание. |
| Запуск |Задание было назначено рабочему процессу, и система скоро его запустит. |
| Возобновление |Система находится в процессе возобновления задания после его приостановки. |
| Выполнение |Задание выполняется. |
| Задание выполняется. Ожидание ресурсов. |Задание выгружено, поскольку превышено ограничение [доли](#fair-share) . Задание будет возобновлено позже с его последней контрольной точки. |
| Остановлено |Задание было остановлено пользователем до его завершения. |
| Остановка |Система находится в процессе остановки задания. |
| Приостановлено |Задание было приостановлено пользователем, системой или с помощью команды в модуле Runbook. Приостановленное задание можно запустить снова. При этом оно возобновится с последней контрольной точки или с запуска модуля Runbook, если задание не имеет контрольных точек. Runbook будет приостановлен системой только при возникновении исключения. По умолчанию переменная ErrorActionPreference имеет значение **Продолжить**, то есть задание продолжит работу при возникновении ошибки. Если для этой переменной задать значение **Остановить**, задание будет приостановлено при возникновении ошибки. Применяется только к [графическим модулям Runbook и модулям Runbook рабочих процессов PowerShell](automation-runbook-types.md) . |
| Приостановка |Система пытается приостановить задание по запросу пользователя. Модуль Runbook должен достичь следующей контрольной точки, прежде чем задание может быть приостановлено. Если последняя контрольная точка уже пройдена, задание будет завершено, прежде чем оно будет приостановлено. Применяется только к [графическим модулям Runbook и модулям Runbook рабочих процессов PowerShell](automation-runbook-types.md) . |

## <a name="viewing-job-status-from-the-azure-portal"></a>Просмотр состояний заданий на портале Azure

Вы можете просматривать сводные данные о состоянии всех заданий Runbook или детализировать сведения об определенном задании на портале Azure. Также можно настроить интеграцию с рабочей областью Log Analytics для пересылки состояния задания и потоков заданий Runbook. Дополнительные сведения об интеграции с Log Analytics в OMS см. в статье [Пересылка состояния задания и потоков заданий из службы автоматизации в Log Analytics](automation-manage-send-joblogs-log-analytics.md).

### <a name="automation-runbook-jobs-summary"></a>Сводные данные заданий Runbook службы автоматизации

В правой части выбранной учетной записи службы автоматизации Azure можно посмотреть сводные данные о всех заданиях Runbook для этой учетной записи на плитке **Статистика по заданиям**.

![Элемент "Статистика по заданиям"](./media/automation-runbook-execution/automation-account-job-status-summary.png).

В этом элементе отображается количество и графическое представление состояний всех выполненных заданий.

Щелкните плитку, чтобы открылась колонка **Задания**, в которой представлен общий список всех выполненных заданий с указанием их состояния, времени начала и завершения выполнения.

![Колонка "Задания" учетной записи службы автоматизации](./media/automation-runbook-execution/automation-account-jobs-status-blade.png)

Чтобы отфильтровать список заданий, выберите **Фильтровать задания** и укажите критерий фильтрации. Для этого введите определенное имя модуля Runbook, выберите состояние задания или диапазон дат и времени из раскрывающегося списка.

![Фильтрация по состоянию задания](./media/automation-runbook-execution/automation-account-jobs-filter.png)

Кроме того, для просмотра сводных данных о состоянии заданий определенного модуля Runbook можно выбрать этот модуль в колонке **Модули Runbook** учетной записи службы автоматизации, а затем выбрать элемент **Задания**. Отобразится колонка **Задания**, в которой можно выбрать конкретную запись и просмотреть подробные сведения о задании и его выходные данные.

![Колонка "Задания" учетной записи службы автоматизации](./media/automation-runbook-execution/automation-runbook-job-summary-blade.png)

### <a name="job-summary"></a>Сводные данные задания

Можно просмотреть список всех заданий, которые были созданы для конкретного модуля Runbook, и их последнее состояние. Можно фильтровать список по состоянию заданий и изменять диапазон дат для последнего изменения задания. Чтобы просмотреть подробные сведения и результаты выполнения для задания, щелкните его имя. Подробное представление задания содержит значения параметров Runbook, которые были указаны для этого задания.

Чтобы просмотреть задания для модуля Runbook, выполните следующие шаги.

1. На портале Azure щелкните **Автоматизация**, а затем выберите имя учетной записи службы автоматизации.
2. В концентраторе выберите **Модули Runbook**, а затем в колонке **Модули Runbook** выберите нужный модуль Runbook.
3. В колонке для выбранного модуля Runbook щелкните плитку **Задания**.
4. Щелкните одно из заданий в списке, и вы сможете просмотреть сведения о нем и выходные данные в колонке сведений о задании модуля Runbook.

## <a name="retrieving-job-status-using-windows-powershell"></a>Получение состояния задания с помощью Windows PowerShell

Чтобы получить сведения о созданных для модуля Runbook заданиях и о конкретном задании, воспользуйтесь командлетом [Get-AzureRmAutomationJob](https://msdn.microsoft.com/library/mt619440.aspx). Если запустить модуль Runbook с помощью Windows PowerShell, то команда [Start-AzureRmAutomationRunbook](https://msdn.microsoft.com/library/mt603661.aspx) вернет результирующее задание. Получить выходные данные задания можно с помощью команды [Get-AzureRmAutomationJob](https://msdn.microsoft.com/library/mt619440.aspx).

Приведенные ниже примеры команд получают сведения о последнем задании для примера runbook и отображают его состояние, значения параметров runbook, а также выходные данные этого задания.

```azurepowershell-interactive
$job = (Get-AzureRmAutomationJob –AutomationAccountName "MyAutomationAccount" `
–RunbookName "Test-Runbook" -ResourceGroupName "ResourceGroup01" | sort LastModifiedDate –desc)[0]
$job.Status
$job.JobParameters
Get-AzureRmAutomationJobOutput -ResourceGroupName "ResourceGroup01" `
–AutomationAccountName "MyAutomationAcct" -Id $job.JobId –Stream Output
```

В следующем примере извлекаются выходные данные для конкретного задания и возвращается каждая запись. Если для одной из записей возникает исключение, оно записывается вместо значения. Это полезно, так как исключения могут предоставлять дополнительные сведения, которые могли не записаться обычно во время вывода.

```azurepowershell-interactive
$output = Get-AzureRmAutomationJobOutput -AutomationAccountName <AutomationAccountName> -Id <jobID> -ResourceGroupName <ResourceGroupName> -Stream "Any"
foreach($item in $output)
{
    $fullRecord = Get-AzureRmAutomationJobOutputRecord -AutomationAccountName <AutomationAccountName> -ResourceGroupName <ResourceGroupName> -JobId <jobID> -Id $item.StreamRecordId
    if ($fullRecord.Type -eq "Error")
    {
        $fullRecord.Value.Exception
    }
    else
    {
    $fullRecord.Value
    }
}
```

## <a name="get-details-from-activity-log"></a>Получение сведений из журнала действий

Другие сведения, например пользователь или учетная запись, которая была использована для запуска runbook, можно получить из журнала действий учетной записи службы автоматизации. В следующем примере PowerShell определяется последний пользователь, выполнивший указанный runbook.

```powershell-interactive
$SubID = "00000000-0000-0000-0000-000000000000"
$rg = "ResourceGroup01"
$AutomationAccount = "MyAutomationAccount"
$RunbookName = "Test-Runbook"
$JobResourceID = "/subscriptions/$subid/resourcegroups/$rg/providers/Microsoft.Automation/automationAccounts/$AutomationAccount/jobs"

Get-AzureRmLog -ResourceId $JobResourceID -MaxRecord 1 | Select Caller
```

## <a name="fair-share"></a>доли

Для совместного использования ресурсов всеми модулями Runbook в облаке служба автоматизации Azure временно выгружает любое задание после того, как его выполнение продолжалось в течение трех часов. В течение этого времени задания для [модулей runbook на основе PowerShell](automation-runbook-types.md#powershell-runbooks) останавливаются и не будут перезапускаться. Состояние задания отображается как **Остановлено**. Этот тип модулей Runbook всегда перезапускается с самого начала, так как не поддерживает контрольные точки.

[Модули runbook на основе рабочего процесса PowerShell](automation-runbook-types.md#powershell-workflow-runbooks) возобновляются с последней [контрольной точки](https://docs.microsoft.com/system-center/sma/overview-powershell-workflows#bk_Checkpoints). После трех часового выполнения задание модуля Runbook будет приостановлено службой, а его состояние будет показывать **Running, waiting for resources** (Выполняется, ожидание ресурсов). Если песочница станет доступна, runbook будет автоматически перезапущен службой автоматизации Azure, и его работа возобновится с последней контрольной точки. Это нормальное поведение рабочего процесса PowerShell для приостановки или перезапуска. Если модуль Runbook еще раз превышает три часа работы среды выполнения, процесс повторяется до трех раз. После третьего перезапуска, если модуль Runbook все еще не завершен спустя три часа, задание модуля Runbook завершается сбоем, а состояние задания отображается как **Failed, waiting for resources** (Сбой, ожидание ресурсов). В этом случае возникает следующее исключение со сбоем.

*Невозможно продолжить выполнение задания, так как оно было несколько раз прекращено до достижения контрольной точки. Убедитесь, что модуль Runbook не выполняет продолжительные операции без сохранения состояния.*

Это необходимо, чтобы защитить службу от постоянного перезапуска модулей Runbook без завершения их работы, так как они не смогут достигнуть следующей контрольной точки без повторной выгрузки.

Если модуль Runbook не имеет контрольных точек или задание не дошло до первой контрольной точки перед выгрузкой, то оно будет перезапущено с самого начала.

При создании модуля Runbook следует убедиться, что время для выполнения всех действий между двумя контрольными точками не превышает трех часов. При необходимости добавьте контрольные точки в runbook, чтобы выполнение задач в нем не превышало трех часов, или разбейте продолжительные операции. Например, модуль Runbook может выполнять повторную индексацию в крупной базе данных SQL. Если эта одиночная операция не завершится с учетом справедливого распределения ресурсов, то задание выгружается и перезапускается с самого начала. В этом случае следует разбить операцию повторного индексирования на несколько шагов, например повторное индексирование одной таблицы, после чего выполняется вставка контрольной точки после каждой операции, чтобы задание могло возобновиться после завершения последней операции.

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения о разных методах запуска модуля Runbook см. в статье [Запуск модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md).
