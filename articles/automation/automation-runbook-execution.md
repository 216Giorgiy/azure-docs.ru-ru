<properties
   pageTitle="Выполнение модуля Runbook в службе автоматизации Azure"
   description="Рассматривается обработка модуля Runbook в службе автоматизации Azure."
   services="automation"
   documentationCenter=""
   authors="bwren"
   manager="stevenka"
   editor="tysonn" />
<tags
   ms.service="automation"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="02/09/2016"
   ms.author="bwren" />

# Выполнение модуля Runbook в службе автоматизации Azure


При запуске модуля Runbook в службе автоматизации Azure создается задание. Задание — это одиночный выполняемый экземпляр модуля Runbook. Рабочий процесс службы автоматизации Azure назначается для выполнения каждого задания. Пока рабочие процессы используются несколькими учетными записями Azure, задания от различных учетных записей службы автоматизации изолируются друг от друга. Вы не контролируете, какой рабочий процесс будет обслуживать запрос для вашего задания. В одном модуле Runbook могут иметься несколько запущенных заданий одновременно. При просмотре списка модулей Runbook на портале Azure в нем отобразится список состояний последнего задания для каждого модуля Runbook. Можно просматривать список заданий для каждого модуля Runbook и отслеживать состояние каждого из них. Описание различных состояний заданий см. в разделе [Состояния заданий](#job-statuses).

На следующей схеме показан жизненный цикл задания Runbook для [графических модулей Runbook](automation-runbook-types.md#graphical-runbooks) и [модулей Runbook рабочих процессов PowerShell](automation-runbook-types.md#powershell-workflow-runbooks).

![Состояния задания — рабочий процесс PowerShell](./media/automation-runbook-execution/job-statuses.png)

На следующей схеме показан жизненный цикл задания Runbook для [модулей Runbook PowerShell](automation-runbook-types.md#powershell-runbooks).

![Состояния задания — сценарий PowerShell](./media/automation-runbook-execution/job-statuses-script.png)


Задания будут иметь доступ к ресурсам Azure за счет подключения к ресурсам подписки Azure. Задания получают доступ к ресурсам в центре обработки данных, если эти ресурсы доступны из общедоступного облака.

## Состояния заданий

Следующая таблица содержит описание различных состояний задания.

| Состояние| Описание|
|:---|:---|
|Завершено|Задание успешно выполнено.|
|Failed| Для [графических модулей Runbook и модулей Runbook рабочих процессов PowerShell](automation-runbook-types.md): не удалось скомпилировать модуль Runbook. Для [модулей Runbook сценариев PowerShell](automation-runbook-types.md): не удалось запустить Runbook или задание породило исключение. |
|Задание не выполнено. Ожидание ресурсов.|Задание не выполнено, так как задание превысило ограничение [доли](#fairshare) три раза и было запущено с той же контрольной точки или с момента запуска модуля Runbook.|
|Поставлено в очередь|Задание ожидает появления доступных ресурсов в очереди автоматизации, которые позволят запустить задание.|
|Запуск|Задание было назначено рабочему процессу, и система скоро его запустит.|
|Возобновление|Система находится в процессе возобновления задания после его приостановки.|
|Выполнение|Задание выполняется.|
|Задание выполняется. Ожидание ресурсов.|Задание выгружено, поскольку превышено ограничение [доли](#fairshare). Задание будет возобновлено позже с его последней контрольной точки.|
|Остановка|Задание было остановлено пользователем до его завершения.|
|Остановка|Система находится в процессе остановки задания.|
|Приостановлено|Задание было приостановлено пользователем, системой или с помощью команды в модуле Runbook. Приостановленное задание можно запустить снова, при этом оно возобновится с последней контрольной точки или с запуска модуля Runbook, если задание не имеет контрольных точек. Модуль Runbook будет приостановлен системой только при возникновении исключения. По умолчанию переменная ErrorActionPreference имеет значение **Продолжить**, то есть задание продолжит работу при возникновении ошибки. Если для этой переменной задать значение **Остановить**, задание будет приостановлено при возникновении ошибки. Применяется только к [графическим модулям Runbook и модулям Runbook рабочих процессов PowerShell](automation-runbook-types.md).|
|Приостановка|Система пытается приостановить задание по запросу пользователя. Модуль Runbook должен достичь следующей контрольной точки, прежде чем задание может быть приостановлено. Если последняя контрольная точка уже пройдена, задание будет завершено, прежде чем оно будет приостановлено. Применяется только к [графическим модулям Runbook и модулям Runbook рабочих процессов PowerShell](automation-runbook-types.md).|

## Просмотр состояния задания с помощью портала управления Azure

### Панель мониторинга автоматизации

Панель мониторинга автоматизации показывает сводку всех модулей Runbook для определенной учетной записи в службе автоматизации. Панель также содержит обзор использования учетной записи. Сводный график отображает общее количество заданий для всех модулей Runbook, которые прошли все состояния в течение определенного количества дней или часов. Временной диапазон можно выбрать в правом верхнем углу графика. Ось времени графика меняется в зависимости от типа выбираемого временного диапазона. Чтобы показать кривую для определенного состояния, щелкните это состояние в верхней части экрана.

Чтобы отобразить панель мониторинга автоматизации, выполните следующие действия.

1. На портале управления Azure выберите **Служба автоматизации** и затем имя учетной записи службы автоматизации.
1. Перейдите на вкладку **Панель мониторинга**.

### Панель мониторинга модуля Runbook

На панели мониторинга модуля Runbook отображается сводка для отдельного модуля. Сводный график отображает общее количество заданий для модуля Runbook, которые прошли все состояния в течение определенного количества дней или часов. Временной диапазон можно выбрать в правом верхнем углу графика. Ось времени графика меняется в зависимости от типа выбираемого временного диапазона. Чтобы показать кривую для определенного состояния, щелкните это состояние в верхней части экрана.

Чтобы отобразить панель мониторинга модуля Runbook, выполните следующие действия.

1. На портале управления Azure выберите **Служба автоматизации** и затем имя учетной записи службы автоматизации.
1. Щелкните имя модуля Runbook.
1. Перейдите на вкладку **Панель мониторинга**.

### Сводные данные задания

Можно просмотреть список всех заданий, которые были созданы для конкретного модуля Runbook, и их последнее состояние. Можно фильтровать список по состоянию заданий и изменять диапазон дат для последнего изменения задания. Щелкните имя задания для просмотра его подробных сведений и результатов выполнения. Подробное представление задания содержит значения параметров Runbook, которые были указаны для этого задания.

Чтобы просмотреть задания для модуля Runbook, выполните следующие шаги.

1. На портале управления Azure выберите **Служба автоматизации** и затем имя учетной записи службы автоматизации.
1. Щелкните имя модуля Runbook.
1. Перейдите на вкладку **Задания**.
1. Щелкните столбец **Созданное задание**, чтобы просмотреть подробные сведения и результаты задания.

## Получение состояния задания с помощью Windows PowerShell

Чтобы получить созданные задания для модуля Runbook и сведения о конкретном задании, воспользуйтесь командлетом [Get-AzureAutomationJob](http://msdn.microsoft.com/library/azure/dn690263.aspx). Если запустить модуль Runbook с помощью Windows PowerShell, команда [Start-AzureAutomationRunbook](http://msdn.microsoft.com/library/azure/dn690259.aspx) возвращает результирующее задание. Получить результаты задания можно с помощью команды [Get-AzureAutomationJob](http://msdn.microsoft.com/library/azure/dn690263.aspx).

Приведенные ниже примеры команд извлекают последнее задание для образца модуля и отображают его состояние, значения параметров Runbook, а также результат выполнения задания.

	$job = (Get-AzureAutomationJob –AutomationAccountName "MyAutomationAccount" –Name "Test-Runbook" | sort LastModifiedDate –desc)[0]
	$job.Status
	$job.JobParameters
	Get-AzureAutomationJobOutput –AutomationAccountName "MyAutomationAccount" -Id $job.Id –Stream Output

## Fair share

Для совместного использования ресурсов всеми модулями Runbook в облаке служба автоматизации Azure временно выгружает любое задание после того, как его выполнение продолжалось в течение 3 часов. [Графические модули](automation-runbook-types.md#graphical-runbooks) Runbook и модули Runbook [рабочего процесса PowerShell](automation-runbook-types.md#powershell-workflow-runbooks) будут возобновлены из последней [контрольной точки](http://technet.microsoft.com/library/dn469257.aspx#bk_Checkpoints). В течение этого времени для задания отображается состояние "Выполнение, ожидание ресурсов". Если модуль Runbook не имеет контрольных точек или задание не дошло до первой контрольной точки перед выгрузкой, то оно будет перезапущено с самого начала. Модули Runbook [PowerShell](automation-runbook-types.md#powershell-runbooks) всегда перезапускаются с самого начала, поскольку не поддерживают контрольные точки.

Если модуль Runbook перезапускается с той же контрольной точки или с самого начала три раза подряд, его работа принудительно завершается и модулю присваивается состояние "Сбой, ожидание ресурсов". Это необходимо, чтобы защитить систему от постоянного перезапуска модулей Runbook без завершения их работы, поскольку они не смогут достигнуть следующей контрольной точки без повторной выгрузки. В этом случае возникает следующее исключение со сбоем.

*Невозможно продолжить выполнение задания, поскольку оно было несколько раз прекращено до достижения контрольной точки. Убедитесь, что модуль Runbook не выполняет продолжительные операции без сохранения состояния.*

При создании модуля Runbook следует убедиться, что время для выполнения всех действий между двумя контрольными точками не превышает 3 часов. При необходимости добавьте контрольные точки в модуль Runbook, чтобы выполнение задач в нем не превышало 3 часов, или разбейте продолжительные операции. Например, модуль Runbook может выполнять повторную индексацию в крупной базе данных SQL. Если эта одиночная операция не завершится с учетом справедливого распределения ресурсов, то задание будет выгружено и перезапущено с самого начала. В этом случае следует разбить операцию повторного индексирования на несколько шагов, например повторное индексирование одной таблицы, после чего выполняется вставка контрольной точки после каждой операции, чтобы задание могло возобновиться после завершения последней операции.



## Связанные статьи

- [Запуск модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md)

<!---HONumber=AcomDC_0211_2016-->