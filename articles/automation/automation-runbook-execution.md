---
title: Выполнение модуля Runbook в службе автоматизации Azure
description: Рассматривается обработка модуля Runbook в службе автоматизации Azure.
services: automation
ms.service: automation
ms.component: process-automation
author: georgewallace
ms.author: gwallace
ms.date: 10/30/2018
ms.topic: conceptual
manager: carmonm
ms.openlocfilehash: bb6236203a1165361505c8699ba94bff54e41c2a
ms.sourcegitcommit: 1d3353b95e0de04d4aec2d0d6f84ec45deaaf6ae
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2018
ms.locfileid: "50247356"
---
# <a name="runbook-execution-in-azure-automation"></a>Выполнение модуля Runbook в службе автоматизации Azure

При запуске модуля Runbook в службе автоматизации Azure создается задание. Задание — это одиночный выполняемый экземпляр модуля Runbook. Рабочий процесс службы автоматизации Azure назначается для выполнения каждого задания. Пока рабочие роли используются многими учетными записями Azure, задания от различных учетных записей службы автоматизации изолируются друг от друга. Вы не контролируете, какая рабочая роль обслуживает запрос для вашего задания. В одном модуле Runbook может быть запущено множество заданий одновременно. Можно повторно использовать среду выполнения для заданий из одной учетной записи службы автоматизации. Чем больше заданий выполняются одновременно, тем вероятнее, что они будут отправлены в одну и ту же песочницу. Задания, которые выполняются в рамках одного процесса песочницы, могут влиять друг на друга (как, например, при выполнении командлета `Disconnect-AzureRMAccount`). Если запустить этот командлет, то все задания runbook в общем процессе песочницы будут отключены. При просмотре списка модулей Runbook на портале Azure в нем отобразится список состояний всех заданий для каждого модуля Runbook. Вы можете просматривать список заданий для каждого модуля Runbook и отслеживать состояние каждого из них. Журналы задания хранятся не более 30 дней. Описание различных состояний заданий см. в разделе [Состояния заданий](#job-statuses).

[!INCLUDE [GDPR-related guidance](../../includes/gdpr-dsr-and-stp-note.md)]

На следующей схеме показан жизненный цикл задания Runbook для [графических модулей Runbook](automation-runbook-types.md#graphical-runbooks) и [модулей Runbook рабочих процессов PowerShell](automation-runbook-types.md#powershell-workflow-runbooks).

![Состояния задания — рабочий процесс PowerShell](./media/automation-runbook-execution/job-statuses.png)

На следующей схеме показан жизненный цикл задания Runbook для [модулей Runbook PowerShell](automation-runbook-types.md#powershell-runbooks).

![Состояния задания — сценарий PowerShell](./media/automation-runbook-execution/job-statuses-script.png)

Задания имеют доступ к ресурсам Azure за счет подключения к ресурсам подписки Azure. Задания имеют доступ только к ресурсам в центре обработки данных, если эти ресурсы доступны из общедоступного облака.

## <a name="job-statuses"></a>Состояния заданий

Следующая таблица содержит описание различных состояний задания. В PowerShell возникает два типа ошибок: устранимые и неустранимые. При устранимой ошибке для состояния модуля Runbook задается значение **Failed**. Если возникают неустранимые ошибки, сценарий все равно продолжает выполняться. Для примера неустранимой ошибки используется командлет `Get-ChildItem` с отсутствующим путем. PowerShell видит, что путь не существует, выдает ошибку и переходит к следующей папке. При этой ошибке для состояния модуля runbook не будет задаваться значение **Failed** и оно может быть помечено состоянием **Завершено**. Чтобы выполнить принудительную остановку модуля Runbook при неустранимой ошибке, вы можете использовать `-ErrorAction Stop` в командлете.

| Status | ОПИСАНИЕ |
|:--- |:--- |
| Завершено |Задание успешно выполнено. |
| Failed |Для [графических модулей Runbook и модулей Runbook рабочих процессов PowerShell](automation-runbook-types.md): не удалось скомпилировать модуль Runbook. Для [модулей Runbook сценариев PowerShell](automation-runbook-types.md): не удалось запустить Runbook или в задании возникло исключение. |
| Задание не выполнено. Ожидание ресурсов. |Задание не выполнено, так как задание превысило ограничение [доли](#fair-share) три раза и было запущено с той же контрольной точки или с момента запуска модуля Runbook. |
| Поставлено в очередь |Задание ожидает появления доступных ресурсов в очереди автоматизации, которые позволят запустить задание. |
| Запуск |Задание было назначено рабочей роли, и система его запускает. |
| Возобновление |Система возобновляет задание после его приостановки. |
| Выполнение |Задание выполняется. |
| Задание выполняется. Ожидание ресурсов. |Задание выгружено, поскольку превышено ограничение [доли](#fair-share) . Задание будет возобновлено позже с его последней контрольной точки. |
| Остановлено |Задание было остановлено пользователем до его завершения. |
| Остановка |Система останавливает задание. |
| Приостановлено |Задание было приостановлено пользователем, системой или с помощью команды в модуле Runbook. Если в модуле Runbook нет контрольной точки, задание начнется с начала модуля. Если в модуле есть контрольная точка, задание возобновится с последней контрольной точки. Runbook будет приостановлен системой только при возникновении исключения. По умолчанию переменная ErrorActionPreference имеет значение **Продолжить**, то есть задание продолжит работу при возникновении ошибки. Если для этой переменной задать значение **Остановить**, задание будет приостановлено при возникновении ошибки. Применяется только к [графическим модулям Runbook и модулям Runbook рабочих процессов PowerShell](automation-runbook-types.md) . |
| Приостановка |Система пытается приостановить задание по запросу пользователя. Модуль Runbook должен достичь следующей контрольной точки, прежде чем задание может быть приостановлено. Если последняя контрольная точка уже пройдена, задание будет завершено, прежде чем оно будет приостановлено. Применяется только к [графическим модулям Runbook и модулям Runbook рабочих процессов PowerShell](automation-runbook-types.md) . |

## <a name="viewing-job-status-from-the-azure-portal"></a>Просмотр состояний заданий на портале Azure

Вы можете просмотреть сводку по состоянию всех заданий Runbook или просмотреть подробные сведения об определенном задании на портале Azure. Вы также можете настроить интеграцию с рабочей областью Log Analytics для пересылки состояния задания и потоков задания модуля Runbook. Дополнительные сведения об интеграции с Log Analytics в OMS см. в статье [Пересылка состояния задания и потоков заданий из службы автоматизации в Log Analytics](automation-manage-send-joblogs-log-analytics.md).

### <a name="automation-runbook-jobs-summary"></a>Сводные данные заданий Runbook службы автоматизации

В правой части выбранной учетной записи службы автоматизации можно посмотреть сводные данные о всех заданиях Runbook на плитке **Статистика по заданиям**.

![Элемент "Статистика по заданиям"](./media/automation-runbook-execution/automation-account-job-status-summary.png)

В этом элементе отображается количество и графическое представление состояний всех выполненных заданий.

Щелкните плитку, чтобы открылась страница **Задания**, на которой представлен сводный список всех выполненных заданий. На этой странице отображаются: состояние, время начала и завершения выполнения.

![Страница "Задания" учетной записи службы автоматизации](./media/automation-runbook-execution/automation-account-jobs-status-blade.png)

Чтобы отфильтровать список заданий, выберите **Фильтровать задания** и укажите критерий фильтрации. Для этого введите определенное имя модуля Runbook, выберите состояние задания и диапазон дат и времени из раскрывающегося списка.

![Фильтрация по состоянию задания](./media/automation-runbook-execution/automation-account-jobs-filter.png)

Кроме того, для просмотра сводных данных о состоянии заданий определенного модуля Runbook можно выбрать этот модуль на странице **Модули Runbook** учетной записи службы автоматизации, а затем выбрать элемент **Задания**. Отобразится страница **Задания**, на которой можно выбрать конкретную запись и просмотреть подробные сведения о задании и его выходные данные.

![Страница "Задания" учетной записи службы автоматизации](./media/automation-runbook-execution/automation-runbook-job-summary-blade.png)

### <a name="job-summary"></a>Сводные данные задания

Можно просмотреть список всех заданий, которые были созданы для конкретного модуля Runbook, и их последнее состояние. Можно фильтровать список по состоянию заданий и изменять диапазон дат для последнего изменения задания. Чтобы просмотреть подробные сведения и результаты выполнения для задания, щелкните его имя. Подробное представление задания содержит значения параметров Runbook, которые были указаны для этого задания.

Чтобы просмотреть задания для модуля Runbook, выполните следующие шаги.

1. На портале Azure щелкните **Автоматизация**, а затем выберите имя учетной записи службы автоматизации.
2. В центре выберите **Модули Runbook**, а затем на странице **Модули Runbook** выберите нужный модуль Runbook.
3. На странице для выбранного модуля Runbook щелкните плитку **Задания**.
4. Щелкните одно из заданий в списке, и вы сможете просмотреть сведения о нем и выходные данные на странице сведений о задании модуля Runbook.

## <a name="retrieving-job-status-using-windows-powershell"></a>Получение состояния задания с помощью Windows PowerShell

Чтобы получить сведения о созданных для модуля Runbook заданиях и о конкретном задании, воспользуйтесь командлетом [Get-AzureRmAutomationJob](https://docs.microsoft.com/powershell/module/azurerm.automation/get-azurermautomationjob). Если запустить модуль Runbook с помощью Windows PowerShell, то команда [Start-AzureRmAutomationRunbook](https://docs.microsoft.com/powershell/module/azurerm.automation/start-azurermautomationrunbook) вернет результирующее задание. Получить выходные данные задания можно с помощью команды [Get-AzureRmAutomationJobOutput](https://docs.microsoft.com/powershell/module/azurerm.automation/get-azurermautomationjoboutput).

Приведенные ниже примеры команд получают сведения о последнем задании для примера runbook и отображают его состояние, значения параметров runbook, а также выходные данные этого задания.

```azurepowershell-interactive
$job = (Get-AzureRmAutomationJob –AutomationAccountName "MyAutomationAccount" `
–RunbookName "Test-Runbook" -ResourceGroupName "ResourceGroup01" | sort LastModifiedDate –desc)[0]
$job.Status
$job.JobParameters
Get-AzureRmAutomationJobOutput -ResourceGroupName "ResourceGroup01" `
–AutomationAccountName "MyAutomationAcct" -Id $job.JobId –Stream Output
```

В следующем примере извлекаются выходные данные для конкретного задания и возвращается каждая запись. Если для одной из записей возникает исключение, оно записывается вместо значения. Это полезно, так как исключения могут предоставлять дополнительные сведения, которые могли не записаться обычно во время вывода.

```azurepowershell-interactive
$output = Get-AzureRmAutomationJobOutput -AutomationAccountName <AutomationAccountName> -Id <jobID> -ResourceGroupName <ResourceGroupName> -Stream "Any"
foreach($item in $output)
{
    $fullRecord = Get-AzureRmAutomationJobOutputRecord -AutomationAccountName <AutomationAccountName> -ResourceGroupName <ResourceGroupName> -JobId <jobID> -Id $item.StreamRecordId
    if ($fullRecord.Type -eq "Error")
    {
        $fullRecord.Value.Exception
    }
    else
    {
    $fullRecord.Value
    }
}
```

## <a name="get-details-from-activity-log"></a>Получение сведений из журнала действий

Другие сведения, например пользователь или учетная запись, которая была использована для запуска runbook, можно получить из журнала действий учетной записи службы автоматизации. В следующем примере PowerShell определяется последний пользователь, выполнивший указанный runbook.

```powershell-interactive
$SubID = "00000000-0000-0000-0000-000000000000"
$rg = "ResourceGroup01"
$AutomationAccount = "MyAutomationAccount"
$RunbookName = "Test-Runbook"
$JobResourceID = "/subscriptions/$subid/resourcegroups/$rg/providers/Microsoft.Automation/automationAccounts/$AutomationAccount/jobs"

Get-AzureRmLog -ResourceId $JobResourceID -MaxRecord 1 | Select Caller
```

## <a name="fair-share"></a>доли

Для совместного использования ресурсов всеми модулями Runbook в облаке служба автоматизации Azure временно выгружает или останавливает любое задание после того, как его выполнение продолжалось больше трех часов. Задания для [модулей Runbook на основе PowerShell](automation-runbook-types.md#powershell-runbooks) и [модулей Runbook Python](automation-runbook-types.md#python-runbooks) остановлены и не перезапускаются, а состояние задания отображается как "Остановлено".

Для долго выполняющихся задач рекомендуется использовать [гибридную рабочую роль Runbook](automation-hrw-run-runbooks.md#job-behavior). Гибридные рабочие роли Runbook не ограничены равномерным распределением и могут выполняться сколько угодно. Другие [границы](../azure-subscription-service-limits.md#automation-limits) заданий применимы к песочницам Azure и к гибридным рабочим ролям Runbook. Гибридные рабочие роли Runbook не ограничены 3-часовым равномерным распределением, но модули Runbook все равно нужно разрабатывать с поддержкой способов перезапуска при неожиданных проблемах с локальной инфраструктурой.

Еще один вариант — оптимизировать модуль Runbook с помощью дочерних модулей. Если модуль Runbook циклически выполняет одну и ту же функцию для ряда ресурсов, например определенную операцию в нескольких базах данных, такую функцию можно переместить в [дочерний модуль Runbook](automation-child-runbooks.md) и вызвать ее с помощью командлета [Start-AzureRMAutomationRunbook](/powershell/module/azurerm.automation/start-azurermautomationrunbook). Все эти дочерние модули runbook параллельно выполняются в отдельных процессах. В результате общее время выполнения родительского модуля runbook уменьшается. Вы можете использовать командлет [Get-AzureRmAutomationJob](/powershell/module/azurerm.automation/Get-AzureRmAutomationJob) в модуле Runbook, чтобы проверить состояние задания для каждого дочернего элемента, если есть операции, которые нужно выполнить после выполнения дочернего модуля Runbook.

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения о разных методах запуска модуля Runbook см. в статье [Запуск модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md).
