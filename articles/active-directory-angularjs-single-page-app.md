<properties 
	pageTitle="Создание одностраничного приложения AngularJS в Azure AD" 
	description="Показан пример использования библиотеки проверки подлинности Azure Active Directory (ADAL) для Javascript с целью защиты одностраничного приложения на основе AngularJS, реализованного с серверной частью ASP.NET Web API, которая вызывает другой ASP.NET Web API через CORS." 
	services="active-directory" 
	documentationCenter="" 
	authors="Justinha" 
	manager="terrylan" 
	editor="LisaToft"/>

<tags 
	ms.service="active-directory" 
	ms.devlang="javascript" 
	ms.topic="hero-article" 
	ms.tgt_pltfrm="na" 
	ms.workload="identity" 
	ms.date="04/01/2015" 
	ms.author="justinha"/>


# Создание одностраничного приложения AngularJS в Azure AD 

В этом учебнике показан пример использования библиотеки проверки подлинности Azure Active Directory (ADAL) для Javascript с целью защиты одностраничного приложения на базе AngularJS, реализованного с серверной частью ASP.NET Web API, которая вызывает другой ASP.NET Web API через CORS. Чтобы просмотреть пример кода, который использовался для этого учебника, см. [AzureADSamples/SinglePageApp-AngularJS-DotNet](https://github.com/AzureADSamples/SinglePageApp-AngularJS-DotNet) на сайте github.

ADAL для Javascript представляет собой библиотеку с открытым исходным кодом.  С вариантами распространения, исходным кодом и вкладом участников сообщества можно ознакомиться в [репозитории ADAL JS](https://github.com/AzureAD/azure-activedirectory-library-for-js).

Дополнительные сведения о применении протоколов в этом и других сценариях см. в разделе [Сценарии проверки подлинности для Azure AD](http://go.microsoft.com/fwlink/?LinkId=394414).

## Запуск этого примера

Начать очень легко!  Для запуска этого примера вам потребуется:

- Visual Studio 2013
- Подключение к Интернету
- Подписка Azure (достаточно [бесплатного пробного периода](https://account.windowsazure.com/organization))

У каждой подписки Azure имеется связанный клиент Azure Active Directory (Azure AD). Все компоненты Azure AD, используемые в данном примере, являются бесплатными.

## Клонируйте или загрузите этот репозиторий

из консоли или командной строки:
`git clone https://github.com/AzureADSamples/SinglePageApp-WebAPI-AngularJS-DotNet.git`

## Зарегистрируйте службу API To Go с помощью клиента Azure Active Directory.

1. Войдите на [портал управления Azure](https://manage.windowsazure.com).
2. Нажмите **Active Directory** в левой панели навигации.
3. Выберите каталог, в котором нужно зарегистрировать пример приложения.
4. Откройте вкладку **Приложения**.
5. На выдвижной панели нажмите **Добавить**.
6. Щелкните **Добавить приложение, которое разрабатывает моя организация**.
7. Введите понятное имя для приложения, например To Do API, выберите **Веб-приложение** и (или) **Веб-интерфейс API** и нажмите кнопку **Далее**.
8. В качестве URL-адреса единого входа введите базовый URL-адрес для примера, который по умолчанию равен `https://localhost:44327/`.
9. В качестве URI идентификатора приложения введите `https://<your_directory_name>/ToGoAPI`, заменив `<your_directory_name>` на имя вашего каталога Azure AD. Сохраните конфигурацию.

Все готово!  Перед следующим шагом необходимо найти URI идентификатора приложения для API.

1. Не выходя из портала Azure, нажмите вкладку **Конфигурация** вашего приложения.
2. Найдите значение URI идентификатора приложения и скопируйте его в буфер обмена.

## Настройте To Go API для использования с клиентом Azure Active Directory

1. Откройте решение в Visual Studio 2013.
2. В проекте ToGoAPI откройте файл `web.config`.
3. Найдите ключ приложения `ida:Tenant` и замените его значение на имя клиента Azure AD.
4. Найдите ключ приложения `ida:Audience` и замените его значение на URI идентификатора приложения, скопированного с портала Azure.
5. Также в проекте ToGoAPI откройте файл `Controllers/ToGoListController.cs`.  В атрибуте `[EnableCors...]` введите расположение клиента To Do SPA.  По умолчанию он расположен в `https://localhost:44326`.  Не забудьте удалить косую черту в конце.
5. В проекте TodoSPA откройте файл `App/Scripts/App.js` и найдите объявление объекта  `endpoints`.
6. Введите сопоставление расположения конечной точки API To Go ее идентификатору ресурса или URI идентификатора приложения.  Имя свойства объекта `endpoints` должно представлять собой расположение API To Go.  По умолчанию  `https://localhost:44327/`. . Значение этого свойства должно представлять собой URI идентификатора приложения, скопированного с портала, например `https://<your_tenant_name>/ToGoAPI`.
8. Об остальных значениях параметров в этом файле пока не беспокойтесь, мы еще вернемся к ним в дальнейшем.
9. Также в проекте TodoSPA откройте файл `App/Scripts/toGoListSvc.js`.  Замените значение переменной `apiEndpoint` на расположение API To Go.  По умолчанию он расположен в `https://localhost:44327/`.

## Зарегистрируйте одностраничное приложение To Go с помощью клиента Azure Active Directory

1. Снова войдите на [портал управления Azure](https://manage.windowsazure.com).
2. Нажмите **Active Directory** на левой панели навигации.
3. Выберите клиента, в котором нужно зарегистрировать пример приложения.
4. Откройте вкладку **Приложения**.
5. На выдвижной панели нажмите **Добавить**.
6. Щелкните **Добавить приложение, которое разрабатывает моя организация**.
7. Введите понятное имя для приложения, например To Do SPA, выберите **Веб-приложение и (или) Web API** и нажмите **Далее**.
8. В качестве URL-адреса единого входа введите базовый URL-адрес для примера, который по умолчанию равен `https://localhost:44326/`.
9. В качестве URI идентификатора приложения введите//<your_directory_name>/ToDoSPA`, заменив `<your_directory_name>` на имя вашего каталога Azure AD.
10. В разделе **Разрешения для других приложений** нажмите **Добавить приложение**.  Выберите **Другое** из раскрывающегося списка **Показать** и щелкните флажок вверху страницы.  Найдите и выберите To Go API, затем щелкните флажок в нижней части страницы для того, чтобы добавить приложение.  Выберите **Доступ к To Go API** из раскрывающегося списка **Делегированные разрешения** и сохраните конфигурацию.

Все готово!  Перед переходом к следующему шагу необходимо найти идентификатор клиента вашего приложения.

1. Не выходя из портала Azure, нажмите вкладку **Конфигурация** вашего приложения.
2. Найдите значение идентификатора клиента и скопируйте его в буфер обмена.


## Включение явного разрешения OAuth2 для приложения

По умолчанию приложения, подготовленные в Azure AD, не могут использовать подразумеваемое разрешение OAuth2. Чтобы выполнить этот пример, необходимо явно выбрать.

1. При выполнении предыдущих шагов в браузере должен остаться открытым портал управления Azure, отображающий вкладку **Конфигурация** приложения.
2. С помощью кнопки **Управление манифестом** на вкладке загрузите файл манифеста для приложения и сохраните его на диске.
3. Откройте файл манифеста в текстовом редакторе. Найдите свойство `oauth2AllowImplicitFlow`. Вы увидите, что оно имеет значение `false`; измените его значение на `true` и сохраните файл.
4. С помощью кнопки **Управление манифестом** отправьте обновленный файл манифеста. Сохраните конфигурацию приложения.

## Настройте To Go SPA для использования с клиентом Azure Active Directory

1. Откройте решение в Visual Studio 2013.
2. В проекте TodoSPA откройте файл `web.config`.
3. Найдите ключ приложения `ida:Tenant` и замените его значение именем каталога Azure AD.
4. Найдите ключ приложения `ida:Audience` и замените его значение идентификатором клиента с портала Azure.
5. Также в проекте TodoSPA снова откройте файл `App/Scripts/App.js` и найдите строку `adalAuthenticationServiceProvider.init(`.
6. Замените значение `tenant` именем каталога Azure AD.
7. Замените значение `clientId` идентификатором клиента с портала Azure.

## Запуск примера

Очистите решение, повторно соберите и запустите его. 

Можно переключить способ входа в систему: либо нажатием ссылки для входа в правом верхнем углу, либо непосредственно нажатием вкладок **Список задач** или **Список поездок**.  Просмотрите пример, войдя в него, добавляя элементы в список задач, удаляя учетную запись пользователя и начиная сначала.  Добавляйте места в список поездок, выполняйте операции CRUD через интерфейс To Go API с помощью CORS.

## Развертывание примера в Azure

Для развертывания примеров To Do SPA и To Go API на веб-сайтах Azure необходимо создать два веб-сайта, опубликовать каждый проект на веб-сайте и обновить оба проекта, чтобы они ссылались на новые расположения вместо IIS Express.

### Создание веб-сайта Azure "To Go SPA"

1. Войдите на [портал управления Azure](https://manage.windowsazure.com).
2. Нажмите **Веб-сайты** в левой панели навигации.
3. Нажмите **Создать** в левом нижнем углу, выберите **Вычисления** > **Веб-сайты** > **Создание со своими настройками**. Выберите план размещения и регион, а также присвойте веб-сайту имя, например togo-contoso.azurewebsites.net.  Выберите базу данных для использования или создайте новую.  Щелкните **Создать веб-сайт**.
4. После создания веб-сайта выберите его для управления.  Для этого набора шагов необходимо загрузить и сохранить файл PUBLISHSETTINGS.  Также можно использовать иные механизмы развертывания, например из системы управления версиями. Дополнительные сведения об использовании файла PUBLISHSETTINGS см. в разделе [Практическое руководство. Подключение к подписке](http://azure.microsoft.com/documentation/articles/install-configure-powershell/#Connect). 

### Создание веб-сайта Azure "To Do SPA"

1. Перейдите на [портал управления Azure](https://manage.windowsazure.com).
2. Нажмите **Веб-сайты** в левой панели навигации.
3. Нажмите **Создать** в левом нижнем углу, выберите **Вычисления** > **Веб-сайты** > **Создание со своими настройками**. Выберите план размещения и регион, а также присвойте веб-сайту имя, например todo-contoso.azurewebsites.net.   Выберите используемую базу данных; подойдет та же база данных, которая используется для интерфейса To Go API.  Щелкните **Создать веб-сайт**.
4. После создания веб-сайта выберите его для управления.  Заново загрузите файл PUBLISHSETTINGS для этого сайта и сохраните его.

### Обновление проектов для использования веб-сайтов Azure

1. В Visual Studio выберите проект TodoSPA.
2. Потребуется внести два изменения.  В `App\Scripts\app.js` замените имя свойства объекта `endpoints` на новое расположение интерфейса API To Go, например `https://togo-contoso.azurewebsites.net/`.  . В `App\Scripts\toGoListSvc.js` замените переменную `apiEndpoint` тем же значением.
3. В проекте ToGoAPI нужно внести одно изменение. В `Controllers\ToGoListController.cs` обновите атрибут `[EnableCors...]`, чтобы он соответствовал новому расположению To Do SPA, например `https://todo-contoso.azurewebsites.net`.  Снова не забудьте удалить косую черту в конце.

### Публикация интерфейса To Go API на веб-сайтах Azure

1. Переключитесь в Visual Studio и перейдите к проекту ToGoAPI.  Щелкните правой кнопкой мыши проект в обозревателе решений и выберите **Опубликовать**. Нажмите **Импорт** и импортируйте профиль публикации To Go API, который был загружен.
6. На вкладке **Подключение** обновите URL-адрес назначения, чтобы он содержал https, например https://togo-constoso.azurewebsites.net. Нажмите кнопку **Далее**.
7. На вкладке **Параметры** проверьте, что пункт **Включить проверку подлинности в организации** НЕ выбран.  Щелкните **Опубликовать**.
8. Visual Studio опубликует проект и автоматически откроет браузер на URL-адресе проекта.  Публикация успешно завершена, если открыта веб-страница проекта по умолчанию.

### Публикация To Do SPA на веб-сайтах Azure

1. Переключитесь в Visual Studio и перейдите к проекту ToDoSPA.  Щелкните правой кнопкой мыши проект в обозревателе решений и выберите **Опубликовать**.  Нажмите **Импорт** и импортируйте загруженный файл PUBLISHSETTINGS для To Do SPA.
6. На вкладке **Подключение** обновите URL-адрес назначения, чтобы он содержал https, например https://todo-contoso.azurewebsites.net.  Нажмите кнопку **Далее**.
7. На вкладке **Параметры** проверьте, что пункт **Включить проверку подлинности в организации** НЕ выбран.  Щелкните **Опубликовать**.
8. Visual Studio опубликует проект и автоматически откроет браузер на URL-адресе проекта.  Публикация успешно завершена, если открыта веб-страница проекта по умолчанию.

### Обновление конфигурации To Do SPA в клиенте каталога

1. Перейдите на [портал управления Azure](https://manage.windowsazure.com).
2. В панели навигации слева нажмите **Active Directory** и выберите клиента.
3. На вкладке **Приложения** выберите приложение **To Do SPA**.
4. На вкладке **Конфигурация** обновите поля **URL-адрес единого входа** и **URL-адрес ответа** на адрес SPA, например https://todo-contoso.azurewebsites.net.  Сохраните конфигурацию.

## О коде

Ключевые файлы содержат логику проверки подлинности, как указано ниже:

- **App.js**: вводит зависимости модулей ADAL, предоставляет значения конфигурации приложения, используемые ADAL для обеспечения взаимодействия протокола с Azure AD, и указывает, какие маршруты не должны быть доступны без предварительной проверки подлинности.

- **index.html**: содержит ссылку на adal.js.

- **HomeController.js**: показывает, как воспользоваться преимуществами методов login() и logOut() в ADAL.

- **UserDataController.js**: показывает, как извлечь информацию о пользователе из кэшированного токена id_token.
   
Отдельная благодарность выражается @matvelloso за помощь в создании этого учебного пособия.


## Дальнейшие действия

Для добавления проверки подлинности и авторизации в веб-приложения и веб-интерфейсы API для использования Azure AD можно использовать следующие дополнительные ресурсы: 

+ [Примеры кода Azure Active Directory](https://msdn.microsoft.com/library/azure/dn646737.aspx)
+ [Сценарии проверки подлинности в Azure AD](https://msdn.microsoft.com/library/azure/dn499820.aspx)





<!--HONumber=52-->