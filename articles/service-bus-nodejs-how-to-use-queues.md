<properties linkid="dev-nodejs-how-to-service-bus-queues" urlDisplayName="Очереди Service Bus" pageTitle="Использование очередей Service Bus (Node.js) — Azure" metaKeywords="Очереди Service Bus Azure, очереди Azure, обмен сообщениями Azure, очереди Azure Node.js" description="Сведения об использовании очередей Service Bus в Azure. Примеры кода написаны на Node.js." metaCanonical="" services="service-bus" documentationCenter="Node.js" title="Использование очередей Service Bus" authors="" solutions="" manager="" editor="" />





# Использование очередей Service Bus

В этом руководстве показано, как использовать очереди Service Bus. Примеры
написаны на JavaScript и используют модуль Node.js для Azure. Здесь описаны
такие сценарии, как **создание очередей, отправка и получение сообщений**, а также
**удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие действия].

## Оглавление

-   [Что такое очереди шины обслуживания?][]
-   [Создание пространства имен службы][]
-   [Получение учетных данных управления по умолчанию для пространства имен][]
-   [Создание приложения Node.js](#create-app)
-   [Настройка приложения для использования шины обслуживания](#configure-app)
-   [Практическое руководство. Создание очереди](#create-queue)
-   [Практическое руководство. Отправка сообщений в очередь](#send-messages)
-   [Практическое руководство. Получение сообщений из очереди](#receive-messages)
-   [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений](#handle-crashes)
-   [Следующие шаги](#next-steps)

[WACOM.INCLUDE [howto-service-bus-queues](../includes/howto-service-bus-queues.md)]

## <a name="create-app"> </a>Создание приложения Node.js

Создайте пустое приложение Node.js. Инструкции по созданию приложения Node.js см. в статьях [Создание и развертывание приложения Node.js на веб-сайте Azure], [Облачная служба Node.js] (с помощью Windows PowerShell) или [Веб-сайт с WebMatrix].

## <a name="configure-app"> </a>Настройка приложения для использования Service Bus

Чтобы использовать Azure Service Bus, необходимо загрузить и использовать пакет azure Node.js. Он содержит набор удобных библиотек, взаимодействующих со службами REST Service Bus.

### Использование диспетчера пакета Node (NPM) для получения пакета

1.  Используя окно командной строки **Windows PowerShell для Node.js**,
    перейдите в папку **c:\\node\\sbqueues\\WebRole1**,
    в которой создан пример приложения.

2.  Введите в командной строке **npm install azure**, что должно привести к результату, аналогичному следующему:

        azure@0.7.5 node_modules\azure
		d ateformat@1.0.2-1.2.3
		 xmlbuilder@0.4.2
		 node-uuid@1.2.0
		 mime@1.2.9
		 underscore@1.4.4
		 validator@1.1.1
		 tunnel@0.0.2
		 wns@0.5.3
		 xml2js@0.2.7 (sax@0.5.2)
		 request@2.21.0 (json-stringify-safe@4.0.0, forever-agent@0.5.0, aws-sign@0.3.0, tunnel-agent@0.3.0, oauth-sign@0.3.0, qs@0.6.5, cookie-jar@0.3.0, node-uuid@1.4.0, http-signature@0.9.11, form-data@0.0.8, hawk@0.13.1)

3.  Можно вручную выполнить команду **ls**, чтобы убедиться в создании папки
    **node\_modules**. В этой папке находится пакет
    **azure**, содержащий библиотеки, необходимые для доступа
    к очередям Service Bus.

### Импорт модуля

С помощью программы "Блокнот" или другого текстового редактора добавьте следующее в начало файла **server.js** приложения:

    var azure = require('azure');

### Настройка подключения к Service Bus Azure

Модуль azure будет считывать переменные среды AZURE\_SERVICEBUS\_NAMESPACE и AZURE\_SERVICEBUS\_ACCESS\_KEY для получения сведений, необходимых для подключения к Service Bus в Azure. Если эти переменные среды не заданы, при вызове **createServiceBusService** необходимо указать сведения об учетной записи.

Пример настройки переменных среды в файле конфигурации для облачной службы Azure см. в статье [Облачная служба Node.js с хранилищем]

Пример настройки переменных среды на портале управления для веб-сайта Azure см. в статье [Веб-приложение Node.js с хранилищем]

## <a name="create-queue"> </a>Создание очереди

Объект **ServiceBusService** позволяет работать с очередями. Следующий код создает объект **ServiceBusService**. Добавьте его в начало файла **server.js** после инструкции импорта модуля azure:

    var serviceBusService = azure.createServiceBusService();

Вызов **createQueueIfNotExists** для объекта **ServiceBusService**
возвратит указанную очередь (если она существует) или создаст новую
очередь с указанным именем. Следующий код использует
метод **createTopicIfNotExists**, чтобы создать очередь с именем "myqueue" или подключиться к ней:

    serviceBusService.createQueueIfNotExists('myqueue', function(error){
        if(!error){
            // Queue exists
        }
    });

**createServiceBusService** также поддерживает дополнительные параметры, позволяющие переопределить настройки очереди по умолчанию, такие как срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить максимальный размер очереди 5 ГБ и срок жизни 1 минуту.

    var queueOptions = {
          MaxSizeInMegabytes: '5120',
          DefaultMessageTimeToLive: 'PT1M'
        };

    serviceBusService.createQueueIfNotExists('myqueue', queueOptions, function(error){
        if(!error){
            // Queue exists
        }
    });

###Фильтры

Дополнительные операции фильтрации можно применить к выполняемым операциям, используя **ServiceBusService** К операциям фильтрации могут относиться ведение журнала, автоматически повтор и т. д. Фильтры являются объектами, реализующими метод со следующей сигнатурой:

		function handle (requestOptions, next)

Выполнив предварительную обработку параметров запроса, метод должен вызвать "next", передавая обратный вызов со следующей сигнатурой:

		function (returnObject, finalCallback, next)

В этой функции обратного вызова и после обработки returnObject (ответ на запрос к серверу) функция обратного вызова должна либо вызвать "next", если он существует, чтобы продолжить обработку других фильтров, либо в противном случае просто вызвать "finalCallback" для завершения обращения к службе.

В Azure SDK для Node.js включены два фильтра, реализующие логику повторных попыток: **ExponentialRetryPolicyFilter** и **LinearRetryPolicyFilter** Следующий код создает объект **ServiceBusService**, использующий **ExponentialRetryPolicyFilter**

	var retryOperations = new azure.ExponentialRetryPolicyFilter();
	var serviceBusService = azure.createServiceBusService().withFilter(retryOperations);

## <a name="send-messages"> </a>Отправка сообщений в очередь

Чтобы отправить сообщение в очередь Service Bus, приложение вызывает
метод **sendQueueMessage** объекта **ServiceBusService**.
Сообщения, отправляемые в очереди Service Bus и получаемые из них, — это
объекты **BrokeredMessage**, у которых есть набор стандартных свойств (например, **Label** и **TimeToLive**), словарь, используемый для хранения настраиваемых свойств приложения, и текст из произвольных данных приложения. Приложение может задать текст сообщения, передав строковое значение как сообщение, а все необходимые стандартные свойства будут заполнены значениями по умолчанию.

В следующем примере показано, как отправить тестовое сообщение с именем очереди "myqueue" с помощью **sendQueueMessage**:

    var message = {
        body: 'Test message',
        customProperties: {
            testproperty: 'TestValue'
        };
    serviceBusService.sendQueueMessage('myqueue', message, function(error){
        if(!error){
            // message sent
        }
    });

Очереди Service Bus поддерживают максимальный размер сообщения 256 КБ (максимальный размер заголовка, который содержит стандартные и настраиваемые свойства приложения, — 64 КБ). Ограничения на количество сообщений в очереди нет, но есть максимальный общий размер сообщений, содержащихся в очереди. Этот размер очереди, определяемый в момент ее создания, не должен превышать 5 ГБ.

## <a name="receive-messages"> </a>Получение сообщений из очереди

Сообщения извлекаются из очереди с помощью метода **receiveQueueMessage**
объекта **ServiceBusService**. По умолчанию прочитанные сообщения удаляются из очереди. Но можно прочитать (извлечь) сообщение и заблокировать его удаление из очереди, задав для необязательного параметра **isPeekLock** значение **true**.

Поведение по умолчанию — чтение и удаление сообщения как часть операции получения — является простейшей моделью, оптимальной для сценариев, в которых приложение может не обрабатывать сообщение в случае сбоя. Чтобы разобраться, рассмотрим сценарий, в котором приложение-получатель выдает запрос на получение, после чего происходит сбой этого приложения еще до обработки сообщения. Поскольку Service Bus помечает сообщение как использованное, то когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.

Если параметр **isPeekLock** равен **true**, получение становится
операцией из двух этапов, что позволяет поддерживать приложения,
не устойчивые к пропуску сообщений. Получив запрос, Service Bus находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению.
Закончив обработку сообщения (или надежно сохранив его для будущей обработки), приложение выполняет второй этап процесса получения, вызывая метод **deleteMessage** и указывая удаляемое сообщение в качестве параметра. Метод **deleteMessage** помечает сообщение как использованное и удаляет его из очереди.

В примере ниже показано, как можно получать и обрабатывать сообщения с помощью метода **receiveQueueMessage**. Сначала пример получает и удаляет сообщение с помощью параметра **isPeekLock**, для которого задано значение true, а затем удаляет сообщение с помощью метода **deleteMessage**:

    serviceBusService.receiveQueueMessage('taskqueue', function(error, receivedMessage){
        if(!error){
            // Message received and deleted
        }
    });
    serviceBusService.receiveQueueMessage(queueName, { isPeekLock: true }, function(error, lockedMessage){
        if(!error){
            // Message received and locked
            serviceBusService.deleteMessage(lockedMessage, function (deleteError){
                if(!deleteError){
                    // Message deleted
                }
            }
        }
    });

## <a name="handle-crashes"> </a>Обработка сбоев приложения и нечитаемых сообщений

Service Bus предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlockMessage**
объекта **ServiceBusService**. После этого Service Bus разблокирует сообщение в очереди и сделает его доступным для приема тем же или другим приложением-пользователем.

Кроме того, с сообщением, заблокированным в очереди, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), Service Bus разблокирует сообщение автоматически и сделает его доступным для приема.

Если сбой приложения происходит после обработки сообщения, но перед вызовом метода **deleteMessage** это сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют
**обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны предусмотреть дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью
свойства **MessageId** сообщения, которое остается постоянным для различных попыток доставки.

## <a name="next-steps"> </a>Дальнейшие действия

Вы узнали основные сведения об очередях Service Bus. Для получения дополнительных сведений используйте следующие далее ссылки.

-   См. справочник MSDN: [Очереди, разделы и подписки][].
-   Посетите репозиторий [Azure SDK для Node] на веб-сайте GitHub.

  [Azure SDK для Node]: https://github.com/WindowsAzure/azure-sdk-for-node
  [Дальнейшие действия]: #next-steps
  [Что такое очереди шины обслуживания?]: #what-are-service-bus-queues
  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Создание приложения Node.js]: #create-app
  [Настройка приложения для использования шины обслуживания]: #configure-app
  [Практическое руководство. Создание очереди]: #create-queue
  [Практическое руководство. Отправка сообщений в очередь]: #send-messages
  [Практическое руководство. Получение сообщений из очереди]: #receive-messages
  [Практическое руководство. Обработка сбоев приложения и нечитаемых сообщений]: #handle-crashes
  [Основные понятия очередей]: ../../dotNet/Media/sb-queues-08.png
  [Портал управления Azure]: http://manage.windowsazure.com
  
  
  
  
  
  [Облачная служба Node.js]: /ru-ru/documentation/articles/cloud-services-nodejs-develop-deploy-app/
  [Очереди, разделы и подписки]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh367516.aspx
  [Веб-сайт с WebMatrix]: /ru-ru/develop/nodejs/tutorials/web-site-with-webmatrix/
[Предыдущая версия портала управления]: ../../Shared/Media/previous-portal.png
  [Создание и развертывание приложения Node.js на веб-сайте Azure]: /ru-ru/develop/nodejs/tutorials/create-a-website-(mac)/
  [Облачная служба Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-app-with-storage/
  [Веб-приложение Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-site-with-storage/

