<properties linkid="dev-nodejs-how-to-service-bus-queues" urlDisplayName="Service Bus Queues" pageTitle="How to use Service Bus queues (Node.js) - Azure" metaKeywords="Azure Service Bus queues, Azure queues, Azure messaging, Azure queues Node.js" description="Learn how to use Service Bus queues in Azure. Code samples written in Node.js." metaCanonical="" services="service-bus" documentationCenter="nodejs" title="How to Use Service Bus Queues" authors="larryfr" solutions="" manager="" editor="" />

<tags ms.service="service-bus" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="nodejs" ms.topic="article" ms.date="09/17/2014" ms.author="larryfr" />

# Использование очередей Service Bus

В этом руководстве показано, как использовать очереди Service Bus. Примеры
написаны на JavaScript и используют модуль Node.js для Azure. Здесь описаны такие
сценарии, как **создание очередей, отправка и получение сообщений**, а также
**удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие
действия][Дальнейшие
действия].

## Оглавление

-   [Что такое очереди Service Bus?][Что такое очереди Service Bus?]
-   [Создание пространства имен службы][Создание пространства имен службы]
-   [Получение учетных данных управления по умолчанию для пространства имен][Получение учетных данных управления по умолчанию для пространства имен]
-   [Создание приложения Node.js][Создание приложения Node.js]
-   [Настройка приложения для использования шины обслуживания][Настройка приложения для использования шины обслуживания]
-   [Практическое руководство. Создать очередь][Практическое руководство. Создать очередь]
-   [Практическое руководство. Отправка сообщений в очередь][Практическое руководство. Отправка сообщений в очередь]
-   [Практическое руководство. Получение сообщений из очереди][Практическое руководство. Получение сообщений из очереди]
-   [Практическое руководство. Обработка сбоев приложений и нечитаемые сообщения][Практическое руководство. Обработка сбоев приложений и нечитаемые сообщения]
-   [Дальнейшие действия][Дальнейшие
    действия]

[WACOM.INCLUDE [howto-service-bus-queues](../includes/howto-service-bus-queues.md)]

## <a name="create-app"> </a>Создание приложения Node.js

Создайте пустое приложение Node.js. Инструкции по созданию приложения Node.js см. в статьях [Создание и развертывание приложения Node.js на веб-сайте Azure][Создание и развертывание приложения Node.js на веб-сайте Azure], [Облачная служба Node.js][Облачная служба Node.js] (с помощью Windows PowerShell) или [Веб-сайт с WebMatrix][Веб-сайт с WebMatrix].

## <a name="configure-app"> </a>Настройка приложения для использования Service Bus

Чтобы воспользоваться Azure Service Bus, вам потребуется загрузить и задействовать
пакет Azure Node.js. В него входит набор удобных библиотек, которые
сообщаются со службами Service Bus REST.

### Использование диспетчера пакета Node (NPM) для получения пакета

1.  Используя окно командной строки **Windows PowerShell для Node.js**, перейдите в
    папку **c:\\node\\sbqueues\\WebRole1**,
    в которой создан пример приложения.

2.  Введите в командной строке **npm install azure**, что должно привести
    к результату, аналогичному следующему:

        azure@0.7.5 node_modules\azure
        ├── dateformat@1.0.2-1.2.3
        ├── xmlbuilder@0.4.2
        ├── node-uuid@1.2.0
        ├── mime@1.2.9
        ├── underscore@1.4.4
        ├── validator@1.1.1
        ├── tunnel@0.0.2
        ├── wns@0.5.3
        ├── xml2js@0.2.7 (sax@0.5.2)
        └── request@2.21.0 (json-stringify-safe@4.0.0, forever-agent@0.5.0, aws-sign@0.3.0, tunnel-agent@0.3.0, oauth-sign@0.3.0, qs@0.6.5, cookie-jar@0.3.0, node-uuid@1.4.0, http-signature@0.9.11, form-data@0.0.8, hawk@0.13.1)

3.  Можно вручную выполнить команду **ls**, чтобы убедиться в создании папки
    **node\_modules**. В этой папке находится пакет
    **azure**, содержащий библиотеки, необходимые для получения доступа
    к очередям Service Bus.

### Импорт модуля

С помощью программы "Блокнот" или другого текстового редактора добавьте следующее
в начало файла **server.js** приложения:

    var azure = require('azure');

### Настройка подключения к Service Bus Azure

Модуль Azure будет читать переменные среды AZURE\_SERVICEBUS\_NAMESPACE и AZURE\_SERVICEBUS\_ACCESS\_KEY для получения сведений, необходимых для подключения к шине обслуживания Azure Service Bus. Если эти переменные среды не заданы, необходимо указать сведения учетной записи при вызове **createServiceBusService**.

Пример настройки переменных среды в файле конфигурации для облачной службы Azure см. в статье [Облачная служба Node.js с хранилищем][Облачная служба Node.js с хранилищем].

Пример настройки переменных среды на портале управления для веб-сайта Azure см. в статье [Веб-приложение Node.js с хранилищем][Веб-приложение Node.js с хранилищем]

## <a name="create-queue"> </a>Практическое руководство. Создание очереди

Объект **ServiceBusService** позволяет работать с очередями. Следующий
код создает объект **ServiceBusService**. Добавьте его в
начало файла **server.js** после инструкции импорта модуля
azure.

    var serviceBusService = azure.createServiceBusService();

Вызов **createQueueIfNotExists** для объекта **ServiceBusService**
возвратит указанную очередь (если она существует) или создаст новую
очередь с указанным именем. В этом коде используется метод
**createQueueIfNotExists**, чтобы создать очередь с именем
myqueue или подключиться к ней.

    serviceBusService.createQueueIfNotExists('myqueue', function(error){
        if(!error){
            // Queue exists
        }
    });

**createServiceBusService** также поддерживает дополнительные параметры,
позволяющие переопределить настройки очереди по умолчанию,
такие как срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить
максимальный размер очереди 5 ГБ и срок жизни 1 минуту.

    var queueOptions = {
          MaxSizeInMegabytes: '5120',
          DefaultMessageTimeToLive: 'PT1M'
        };

    serviceBusService.createQueueIfNotExists('myqueue', queueOptions, function(error){
        if(!error){
            // Queue exists
        }
    });

### Фильтры

Дополнительные операции фильтрации можно применить к выполняемым операциям, используя **ServiceBusService** К операциям фильтрации могут относиться ведение журнала, автоматически повтор и т. д. Фильтры являются объектами, реализующими метод со следующей сигнатурой:

        function handle (requestOptions, next)

Выполнив предварительную обработку параметров запроса, метод должен вызвать "next", передавая обратный вызов со следующей сигнатурой:

        function (returnObject, finalCallback, next)

В этой функции обратного вызова и после обработки returnObject (ответ на запрос к серверу) функция обратного вызова должна либо вызвать "next", если он существует, чтобы продолжить обработку других фильтров, либо в противном случае просто вызвать "finalCallback" для завершения обращения к службе.

В Azure SDK для Node.js включены два фильтра, реализующие логику повторных попыток: **ExponentialRetryPolicyFilter** и **LinearRetryPolicyFilter** Следующий код создает объект **ServiceBusService**, использующий **ExponentialRetryPolicyFilter**

    var retryOperations = new azure.ExponentialRetryPolicyFilter();
    var serviceBusService = azure.createServiceBusService().withFilter(retryOperations);

## <a name="send-messages"> </a>Практическое руководство. Отправка сообщений в очередь

Чтобы отправить сообщение в очередь Service Bus, приложение вызывает метод
**sendQueueMessage** на объекте **ServiceBusService**.
Сообщения, отправляемые в очереди Service Bus и получаемые из них — это объекты класса
**BrokeredMessage** со стандартным набором свойств (например,
**Label** и **TimeToLive**), словарем, который используется для хранения
свойств, связанных с пользовательским приложением, и массивом произвольных
данных приложения. Приложение может задать текст сообщения,
передав строковое значение как сообщение, а все необходимые стандартные
свойства будут заполнены значениями по умолчанию.

В следующем примере показано, как отправить тестовое сообщение
в очередь с именем myqueue с помощью **sendQueueMessage**.

    var message = {
        body: 'Test message',
        customProperties: {
            testproperty: 'TestValue'
        }};
    serviceBusService.sendQueueMessage('myqueue', message, function(error){
        if(!error){
            // message sent
        }
    });

Очереди Service Bus поддерживают максимальный размер сообщения 256 КБ (максимальный размер заголовка,
который содержит стандартные и настраиваемые
свойства приложения, составляет 64 КБ). Ограничения на количество сообщений
в очереди нет, но есть максимальный общий размер сообщений,
содержащихся в очереди. Этот размер очереди, определяемый в момент ее
создания, не должен превышать 5 ГБ.

## <a name="receive-messages"> </a>Практическое руководство. Получение сообщений из очереди

Сообщения извлекаются из очереди с помощью метода **receiveQueueMessage**
объекта **ServiceBusService**. По умолчанию прочитанные сообщения
удаляются из очереди. Но можно прочитать (извлечь)
сообщение и заблокировать его удаление из очереди, задав для
необязательного параметра **isPeekLock** значение **true**.

Поведение по умолчанию — чтение и удаление сообщения как часть
операции получения — является простейшей моделью, оптимальной для сценариев,
в которых приложение может не обрабатывать сообщение
в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором
объект-получатель выдает запрос на получение и выходит из строя до
его обработки. Поскольку шина обслуживания помечает сообщение как используемое,
то, после того как приложение перезапускается и снова начинает обрабатывать сообщения,
оно пропустит сообщение, которое использовалось до сбоя.

Если параметр **isPeekLock** равен **true**, получение становится
операцией из двух этапов, что позволяет поддерживать приложения,
неустойчивые к пропуску сообщений. Получив запрос, Service Bus находит
следующее сообщение, блокирует его, чтобы предотвратить
его получение другими получателями, и возвращает его приложению.
Когда приложение завершает обработку сообщения (или сохраняет его для будущей
обработки), шина Service Bus завершает второй этап
процесса получения, вызывая метод **deleteMessage**, и предоставляет
сообщение для удаления в качестве параметра. Метод **deleteMessage** помечает
сообщение как использованное и удаляет его из очереди.

В примере ниже показано, как можно получать и обрабатывать
сообщения с помощью метода **receiveQueueMessage**. Сначала пример получает и
удаляет сообщение с помощью параметра **isPeekLock**, для
которого задано значение true, а затем удаляет сообщение с помощью метода **deleteMessage**.

    serviceBusService.receiveQueueMessage('taskqueue', function(error, receivedMessage){
        if(!error){
            // Message received and deleted
        }
    });
    serviceBusService.receiveQueueMessage(queueName, { isPeekLock: true }, function(error, lockedMessage){
        if(!error){
            // Message received and locked
            serviceBusService.deleteMessage(lockedMessage, function (deleteError){
                if(!deleteError){
                    // Message deleted
                }
            }
        }
    });

## <a name="handle-crashes"> </a>Обработка сбоев приложения и нечитаемых сообщений

Service Bus предоставляет функции, помогающие корректно выполнить
восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если
приложение-получатель по каким-либо причинам не может обработать
сообщение, то оно может вызвать метод **unlockMessage** для объекта
**ServiceBusService**. После этого Service Bus разблокирует сообщение
в очереди и сделает его доступным для приема тем же или
другим приложением-
пользователем.

Кроме того, с сообщением, заблокированным в очереди, связано время
ожидания. Если приложение не сможет обработать сообщение
в течение времени ожидания (например, при сбое приложения), Service Bus разблокирует сообщение автоматически и сделает его
доступным для приема.

Если в приложении происходит сбой после обработки сообщения,
но до вызова метода **deleteMessage**, то сообщение будет повторно
доставлено в приложение после его перезапуска. Часто этот подход называют
**минимум одна обработка**, т. е. каждое сообщение
будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики
приложения должны добавить дополнительную логику для обработки
повторной доставки сообщений. Часто это достигается с помощью свойства
**MessageId** сообщения, которое остается постоянным для различных
попыток доставки.

## <a name="next-steps"> </a> Дальнейшие действия

Вы узнали основные сведения об очередях Service Bus. Для получения
дополнительных сведений используйте следующие ссылки:

-   См. справочник MSDN: [Очереди, разделы и подписки.][Очереди, разделы и подписки.]
-   Посетите репозиторий [Пакет SDK хранилища Azure для Node][Пакет SDK хранилища Azure для Node] на веб-сайте GitHub.

  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Создание приложения Node.js]: #create-app
  [Настройка приложения для использования шины обслуживания]: #configure-app
  [Практическое руководство. Создать очередь]: #create-queue
  [Практическое руководство. Отправка сообщений в очередь]: #send-messages
  [Практическое руководство. Получение сообщений из очереди]: #receive-messages
  [Практическое руководство. Обработка сбоев приложений и нечитаемые сообщения]: #handle-crashes
  [Создание и развертывание приложения Node.js на веб-сайте Azure]: /ru-ru/develop/nodejs/tutorials/create-a-website-(mac)/
  [Облачная служба Node.js]: /ru-ru/documentation/articles/cloud-services-nodejs-develop-deploy-app/
  [Веб-сайт с WebMatrix]: /ru-ru/develop/nodejs/tutorials/web-site-with-webmatrix/
  [Облачная служба Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-app-with-storage/
  [Веб-приложение Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-site-with-storage/
  [Очереди, разделы и подписки.]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh367516.aspx
  [Пакет SDK хранилища Azure для Node]: https://github.com/WindowsAzure/azure-sdk-for-node
