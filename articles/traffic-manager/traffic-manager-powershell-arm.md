<properties
   pageTitle="Предварительная поддержка диспетчера трафика Azure в диспетчере ресурсов Azure | Microsoft Azure"
   description="Использование PowerShell для работы с диспетчером трафика в диспетчере ресурсов Azure (ARM) (предварительная версия)"
   services="traffic-manager"
   documentationCenter="na"
   authors="joaoma"
   manager="adinah"
   editor="tysonn" />
<tags
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/27/2015"
   ms.author="joaoma" />






# Предварительная поддержка диспетчера трафика Azure в диспетчере ресурсов Azure
Диспетчер ресурсов Azure (ARM) представляет собой новую платформу управления для служб в Azure. Теперь профилями диспетчера трафика Azure можно управлять с помощью интерфейсов API и инструментов на основе диспетчера ресурсов Azure. Дополнительные сведения о диспетчере ресурсов Azure см. в статье [Использование групп ресурсов для управления ресурсами Azure](../azure-preview-portal-using-resource-groups.md).

>[AZURE.NOTE]Поддержка диспетчера трафика в ARM в настоящее время находится на этапе предварительной версии, включая API REST, Azure PowerShell, Azure CLI и пакет SDK для .NET.



## Модель ресурсов

Для настройки диспетчера трафика используется набор параметров, которые называются профилем. Он содержит параметры DNS, параметры маршрутизации трафика, параметры отслеживания конечных точек, а также список конечных точек службы, на которые будет выполняться маршрутизация трафика.

В ARM каждому профилю диспетчера трафика соответствует ресурс ARM типа TrafficManagerProfiles, для управления которым используется поставщик ресурсов Microsoft.Network. На уровне API REST каждый профиль имеет следующий URI:

	https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Network/trafficManagerProfiles/{profile-name}?api-version={api-version}

## Сравнение диспетчера трафика Azure с API управления службами

При настройке профилей диспетчера трафика с помощью ARM в нем доступны те же функциональные возможности, что и при использовании API управления службами (не ARM), за исключением перечисленных ниже ограничений предварительной версии.

Однако несмотря на одинаковый набор функций используются несколько иные термины:

- Метод балансировки нагрузки, который определяет, как именно диспетчер трафика выбирает конечную точку для маршрутизации трафика при ответе на определенный DNS-запрос, переименован в метод маршрутизации трафика.

- Метод маршрутизации трафика «циклический перебор» называется взвешенным.

- Метод маршрутизации трафика «отработка отказа» называется приоритетным.

## Ограничения предварительной версии
Поскольку поддержка диспетчера трафика в диспетчере ресурсов Azure находится на этапе предварительной версии, существует несколько ограничений.

- Профили диспетчера трафика, созданные с использованием существующих API управления службами (не ARM), инструментов и портала, недоступны в ARM, и наоборот. Перенос профилей, не связанных с ARM, в API-интерфейсы ARM пока не поддерживается.

- 	API REST не поддерживает изменение профилей диспетчера трафика с помощью метода PATCH. Чтобы изменить свойство профиля, необходимо сначала получить его с помощью метода GET, а затем отправить обратно с помощью метода PUT.
- 	Поддерживаются только внешние конечные точки. Их можно использовать для работы с диспетчером трафика на базе служб Azure, и в этом случае размер оплаты для них рассчитывается по внутреннему тарифу для конечных точек. (Единственным последствием использования внешних конечных точек является тот факт, что они не отключаются и не удаляются автоматически при отключении или удалении соответствующей службы Azure: их нужно отключать и удалять вручную.)
-	Диспетчер трафика Azure пока недоступен на портале Azure (он есть только на классической версии портала).

## Настройка Azure PowerShell

В этих инструкциях используется оболочка Microsoft Azure PowerShell, которую нужно настроить с помощью описанных ниже действий.

Те же самые операции можно выполнить и через другие интерфейсы.

### Шаг 1
Установите последнюю версию Azure PowerShell, которую можно скачать со страницы загружаемых файлов Azure.
### Шаг 2
Переведите PowerShell в режим использования командлетов ARM. Дополнительную информацию см. в статье «Использование Windows PowerShell с диспетчером ресурсов».

	PS C:\> Switch-AzureMode -Name AzureResourceManager
### Шаг 3
Войдите в свою учетную запись Azure.

	PS C:\> Add-AzureAccount

Вам будет предложено указать свои учетные данные для проверки подлинности.

### Шаг 4.
Выберите подписку Azure.

	PS C:\> Select-AzureSubscription -SubscriptionName "MySubscription"

Чтобы просмотреть перечень доступных подписок, воспользуйтесь командлетом Get-AzureSubscription.

### Шаг 5

 Для управления службой диспетчера трафика используется поставщик ресурсов Microsoft.Network. Прежде чем приступать к работе с диспетчером с помощью ARM, необходимо зарегистрировать подписку Azure для использования этого поставщика. Эта операция выполняется один раз для каждой подписки.

	PS C:\> Register-AzureProvider –ProviderNamespace Microsoft.Network

### Шаг 6
Создайте группу ресурсов (этот шаг можно пропустить, если вы используете существующую группу).

	PS C:\> New-AzureResourceGroup -Name MyAzureResourceGroup -location "West US"

В диспетчере ресурсов Azure для всех групп ресурсов должно быть указано расположение. Оно используется в качестве расположения по умолчанию для всех ресурсов данной группы. Однако поскольку ресурсы профилей диспетчера трафика являются глобальными, а не региональными, выбор расположения группы ресурсов никак не повлияет на работу диспетчера трафика Azure.

## Создание профиля диспетчера трафика

Чтобы создать профиль диспетчера трафика, воспользуйтесь командлетом New-AzureTrafficManagerProfile:

	PS C:\> $profile = New-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup -TrafficRoutingMethod Performance -RelativeDnsName contoso -Ttl 30 -MonitorProtocol HTTP -MonitorPort 80 -MonitorPath "/"

Он принимает перечисленные ниже параметры.

- Name: имя ресурса ARM для ресурса профиля диспетчера трафика. У профилей в одной группе ресурсов должны быть уникальные имена. Это имя отличается от имени DNS, которое используется в запросах DNS.

-	ResourceGroupName: имя группы ресурсов ARM, которая содержит ресурс профиля.

-	TrafficRoutingMethod: метод маршрутизации трафика, который определяет конечную точку, возвращаемую в ответ на поступающие запросы DNS. Возможные значения: Performance (производительный), Weighted (взвешенный) и Priority (приоритетный).

-	RelativeDnsName: относительное DNS-имя, предоставляемое этим профилем диспетчера трафика. Это значение объединяется с DNS-именем домена, с помощью которого диспетчер трафика Azure формирует полное доменное имя профиля. Например, для значения «contoso» будет создан профиль диспетчера трафика с полным доменным именем contoso.trafficmanager.net.

-	TTL: срок жизни запроса DNS в секундах. Это значение дает локальным сопоставителям DNS и DNS-клиентам понять, в течение какого срока нужно хранить в кэше ответы DNS, полученные от профиля диспетчера трафика.

-	MonitorProtocol: протокол, который следует использовать для контроля работоспособности конечных точек. Допустимые значения: HTTP и HTTPS.

-	MonitorPort: порт TCP, который следует использовать для контроля работоспособности конечных точек.

-	MonitorPath: путь относительно доменного имени конечной точки, который используется для проверки ее работоспособности.

Командлет создает профиль в диспетчере трафика Azure и возвращает соответствующий объект профиля. На этом этапе профиль не содержит никаких конечных точек. Инструкции по их добавлению см. в разделе [Изменение профиля диспетчера трафика](#update-a-traffic-manager-profile).

## Получение профиля диспетчера трафика

Получить существующий объект профиля диспетчера трафика можно с помощью командлета Get-AzureTrafficManagerProfle:

	PS C:\> $profile = Get-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup

Этот командлет возвращает профиль объекта трафика.

## Изменение профиля диспетчера трафика [](#update-traffic-manager-profile)

Изменение профилей диспетчера трафика (например, для добавления и удаления конечных точек либо изменения параметров) выполняется в три этапа, которые перечислены ниже.

1.	Получение профиля с помощью командлета Get-AzureTrafficManagerProfile (также можно использовать профиль, возвращенный командлетом New-AzureTrafficManagerProfile).

2.	Изменение профиля (добавление или удаление конечных точек, изменение параметров конечных точек и профиля). Эти изменения производятся в автономном режиме (только в локальном объекте, который соответствует данному профилю).

3.	Фиксация изменений с помощью командлета Set-AzureTrafficManagerProfile. Он заменяет существующий профиль в диспетчере трафика Azure указанным объектом профиля.

Эти этапы разъясняются подробнее в приведенных ниже примерах.

### Добавление конечных точек в профиль

Для добавления конечных точек в профиль диспетчера трафика можно использовать командлет Add-AzureTrafficManagerEndpointConfig:

	PS C:\> $profile = Get-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup
	PS C:\> Add-AzureTrafficManagerEndpointConfig –EndpointName site1 –TrafficManagerProfile $profile –Type ExternalEndpoints –Target site1.contoso.com –EndpointStatus Enabled –Weight 10 –Priority 1 –EndpointLocation “West US”
	PS C:\> Set-AzureTrafficManagerProfile –TrafficManagerProfile $profile

Add-AzureTrafficManagerEndpointConfig принимает перечисленные ниже параметры.

- EndpointName: имя конечной точки. У конечных точек в составе одного профиля должны быть уникальные имена. Это имя используется для ссылки на конечную точку при выполнении операций, связанных с управлением службой, и не является DNS-именем данной точки.

-	TrafficManagerProfile: объект профиля диспетчера трафика, в который добавляется конечная точка.

-	Type: тип конечной точки диспетчера трафика. В настоящее время в API ARM поддерживается только тип ExternalEndpoint (внешняя конечная точка) (см. раздел [Ограничения предварительной версии](#preview-limitations)).

-	Target: полное доменное DNS-имя конечной точки. Диспетчер трафика возвращает это значение в ответе DNS для направления трафика на эту точку.

-	EndpointStatus: состояние конечной точки. Если конечная точка включена (Enabled), она проверяется на предмет работоспособности и добавляется в список метода маршрутизации трафика. Допустимые значения: Enabled и Disabled.

-	Weight: вес, назначенный конечной точке. Это значение используется только в том случае, если диспетчер трафика настроен для использования взвешенного (weighted) метода маршрутизации. Допустимые значения: от 1 до 1000.

-	Priority: приоритет этой конечной точки при использовании приоритетного (priority) метода маршрутизации трафика. Допустимые значения приоритета — от 1 до 1000. Чем меньше значение, тем выше приоритет.

-	EndpointLocation: расположение внешней конечной точки для производительного (performance) метода маршрутизации трафика. Список доступных расположений можно получить с помощью командлета Get-AzureLocation.

Параметры Endpoint Status, Weight и Priority являются необязательными. Если они опущены, соответствующие значения не передаются из оболочки PowerShell и сервер использует значения по умолчанию.

### Удаление конечных точек из профиля

Чтобы удалить конечную точку из профиля, вызовите командлет Remove-AzureTrafficmanagerEndpointConfig, передав ему имя удаляемой точки:

	PS C:\> $profile = Get-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup
	PS C:\> Remove-AzureTrafficManagerEndpointConfig –EndpointName site1 –TrafficManagerProfile $profile
	PS C:\> Set-AzureTrafficManagerProfile –TrafficManagerProfile $profile

Операции для добавления и удаления конечных точек также можно объединить в последовательность, передавая объект профиля по каналу, а не в качестве параметра. Например:

	PS C:\> Get-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup | Remove-AzureTrafficManagerEndpointConfig –EndpointName site1 | Set-AzureTrafficManagerProfile

### Изменение параметров профиля и конечных точек

Параметры профиля и конечных точек можно изменить в автономном режиме, а затем зафиксировать изменения с помощью командлета Set-AzureTrafficManagerProfile. Единственное исключение связано с тем, что значение RelativeDnsName профиля невозможно изменить после его создания (для этого необходимо удалить и повторно создать профиль). Например, чтобы изменить TTL профиля и состояние первой конечной точки, выполните следующие команды:

	PS C:\> $profile = Get-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup
	PS C:\> $profile.Ttl = 300
	PS C:\> $profile.Endpoints[0].EndpointStatus = "Disabled"
	PS C:\> Set-AzureTrafficManagerProfile –TrafficManagerProfile $profile

### Удаление профиля диспетчера трафика
Чтобы удалить профиль диспетчера трафика, вызовите командлет Remove-AzureTrafficManagerProfile, передав ему имя профиля и имя группы ресурсов:

	PS C:\> Remove-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup [-Force]

Этот командлет запрашивает подтверждение. Чтобы отключить его, можно указать необязательный параметр -Force. Удаляемый профиль также можно указать с помощью объекта профиля:

	PS C:\> $profile = Get-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup
	PS C:\> Remove-AzureTrafficManagerProfile –TrafficManagerProfile $profile [-Force]

Эти операции также можно объединить в последовательность:

	PS C:\> Get-AzureTrafficManagerProfile –Name MyProfile -ResourceGroupName MyAzureResourceGroup | Remove-AzureTrafficManagerProfile [-Force]


## См. также

[Обзор диспетчера трафика](traffic-manager-overview.md)

[Начало работы с командлетами Azure](https://msdn.microsoft.com/library/jj554332.aspx)
 

<!---HONumber=August15_HO6-->