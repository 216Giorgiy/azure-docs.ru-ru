<properties 
   pageTitle="Что такое диспетчер трафика | Microsoft Azure"
   description="Эта статья поможет вам понять, что такое диспетчер трафика и как он работает."
   services="traffic-manager"
   documentationCenter=""
   authors="joaoma"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="12/01/2015"
   ms.author="joaoma" />

# Что такое диспетчер трафика

Диспетчер трафика Microsoft Azure позволяет управлять распределением пользовательского трафика для заданных конечных точек, то есть облачных служб Azure, веб-сайтов и других конечных точек. Диспетчер трафика применяет интеллектуальную подсистему политик в запросах системы доменных имен (DNS) для доменных имен ваших интернет-ресурсов. Облачные службы Azure или веб-сайты могут выполняться в разных центрах данных по всему миру.

Диспетчер трафика позволяет решать указанные ниже задачи.

- **Повышение доступности критически важных приложений.** Диспетчер трафика позволяет повысить доступность важных приложений за счет мониторинга конечных точек, работающих в службе Azure, и автоматической отработки отказа при сбоях в работе облачной службы Azure, веб-сайта Azure или другого расположения.
- **Повышение скорости реагирования высокопроизводительных приложений.** Платформа Azure дает возможность запускать облачные службы и веб-сайты в распределенных по всему миру центрах обработки данных. Диспетчер трафика может уменьшить время отклика приложений и возврата контента конечным пользователям, направляя их в конечную точку с наименьшим значением задержки сети для данного клиента.
- **Обновление и обслуживание без простоя.** Диспетчер трафика поддерживает расширенные сценарии для гибридных облачных и локальных развертываний, в том числе «обработка пиков в облаке», «миграция в облако» и «отработка отказа в облаке». Для выполнения планового обслуживания конечную точку следует отключить в диспетчере трафика, а затем подождать, пока она не завершит обслуживание существующих соединений. Если трафик в конечную точку больше не поступает, обновите службу в этой точке, протестируйте ее, а затем повторно включите в диспетчере трафика. Это поможет поддерживать и обновлять службы без простоя.
- **Распределение трафика в крупных и сложных развертываниях.** Благодаря вложенным профилям, в которых профиль диспетчера трафика может воспользоваться другим профилем в качестве конечной точки, вы можете создавать конфигурации, чтобы оптимизировать производительность и распределение в крупных, более сложных развертываниях. Подробнее см. в разделе [Вложенные профили](#nested-profiles).

## Как работает диспетчер трафика

При настройке профиля диспетчера трафика указываемые параметры предоставляют диспетчеру трафика информацию, необходимую для определения того, какая конечная точка должна обслужить запрос на основании запроса DNS. Сам трафик конечных точек не проходит через диспетчер трафика.

На *рис. 1* показано, как диспетчер трафика направляет пользователей в одну конечную точку из набора. Числа на рис. 1 соответствуют пронумерованным описаниям внизу.

![Как работает диспетчер трафика](./media/traffic-manager-overview/IC740854.jpg)

**Рисунок 1**

1. **Пользовательский трафик к домену компании:** клиент запрашивает информацию с помощью доменного имени компании. Целью является разрешение DNS-имени в IP-адрес. Домены компании должны быть зарезервированы с использованием нормальных регистраций доменных имен Интернета, которые обслуживаются вне диспетчера трафика. На рис. 1 приведен пример домена компании — *www.contoso.com*.
2. **От домена компании к домену диспетчера трафика:** запись ресурса DNS для домена компании указывает на домен диспетчера трафика, который обслуживается в диспетчере трафика Azure. Это достигается благодаря использованию записи ресурса CNAME, которая сопоставляет доменное имя компании с доменным именем диспетчера трафика. В примере доменное имя диспетчера трафика — *contoso.trafficmanager.net*.
3. **Домен и профиль диспетчера трафика:** домен диспетчера трафика входит в состав профиля диспетчера трафика. DNS-сервер пользователя отправляет новый запрос DNS на доменное имя диспетчера трафика (в нашем примере это *contoso.trafficmanager.net*), и этот запрос принимают серверы DNS-имен диспетчера трафика.
4. **Обработка правил профиля диспетчера трафика**: диспетчер трафика использует указанный метод маршрутизации трафика и данные мониторинга, чтобы определить, какая конечная точка Azure или другая конечная точка должна обработать запрос.
5. **Доменное имя конечной точки, отправляемое пользователю:** диспетчер трафика возвращает запись CNAME, которая сопоставляет доменные имена диспетчера трафика и конечной точки. DNS-сервер пользователя разрешает доменное имя конечной точки в ее IP-адрес и отправляет его пользователю.
6. **Пользователь вызывает конечную точку:** пользователь вызывает возвращенную конечную точку напрямую, используя ее IP-адрес.

Так как домен компании и разрешенный IP-адрес кэшируются в клиентском компьютере, пользователь продолжает взаимодействовать с выбранной конечной точкой, пока не истечет срок действия записи в локальном кэше DNS. Важно отметить, что DNS-клиент кэширует записи узла DNS в течение их срока жизни (TTL). Извлечение записей узлов из кэша DNS-клиента не затрагивает профиль диспетчера трафика, что может привести к задержке подключения, если конечная точка станет недоступна до истечения срока жизни. Если срок жизни DNS-записи узла в кэше клиента истекает и клиентскому компьютеру снова требуется разрешить доменное имя компании, он отправляет новый запрос DNS. Клиентский компьютер может получить IP-адрес другой конечной точки в зависимости от применяемого метода маршрутизации трафика и состояния работоспособности конечных точек во время запроса.

## Реализация диспетчера трафика

На *рис. 2* пошагово показано, что необходимо сделать для реализации диспетчера трафика. Эти шаги можно будет выполнять немного в другом порядке после получения ясного понимания конфигурации и рекомендаций по использованию диспетчера трафика. Числа на рис. 2 соответствуют пронумерованным описаниям внизу.

![Как настроить параметры диспетчера трафика](./media/traffic-manager-overview/IC740855.jpg)

**Рис. 2**

1. **Разверните в своей рабочей среде облачные службы и веб-сайты Azure либо другие конечные точки.** При создании профиля диспетчера трафика его необходимо связать с подпиской. Затем в рабочей среде добавьте конечные точки для веб-сайтов уровня Standard и облачных служб, которые входят в ту же подписку. Если конечная точка находится в промежуточной среде, а не в рабочей среде Azure, или не является частью той же подписки, ее можно добавить как внешнюю конечную точку. Дополнительную информацию об облачных службах см. в статье [Облачные службы](http://go.microsoft.com/fwlink/p/?LinkId=314074). Дополнительную информацию о веб-сайтах см. в статье [Веб-сайты](http://go.microsoft.com/fwlink/p/?LinkId=393327).
2. **Выберите имя для своего домена диспетчера трафика.** Придумайте имя для своего домена с уникальным префиксом. Последняя часть домена (trafficmanager.net) является постоянной. Дополнительную информацию см. в разделе [Рекомендации](#best-practices).
3. **Выберите конфигурацию мониторинга, которую вы хотите использовать.** Диспетчер трафика отслеживает конечные точки, чтобы гарантировать их доступность, какой бы метод маршрутизации трафика ни применялся. Когда параметры мониторинга настроены, диспетчер трафика передает трафик конечным точкам, которые, согласно системе мониторинга, находятся вне сети, только если обнаруживает, что все точки находятся вне сети, или если не может определить состояние какой-либо точки в профиле. Дополнительную информацию о мониторинге см. в разделе [Мониторинг диспетчера трафика](traffic-manager-monitoring.md).
4. **Выберите метод маршрутизации трафика, который вы хотите использовать.** Доступны три различных метода маршрутизации трафика. Найдите время, чтобы понять, какой метод вам подходит лучше всего. Если потребуется изменить метод позже, то это можно сделать в любое время. Обратите внимание, что каждый метод настраивается несколько по-разному. Информацию о методах маршрутизации трафика см. в статье [О методах маршрутизации трафика в диспетчере трафика](traffic-manager-load-balancing-methods.md).
5. **Создайте профиль и настройте параметры.** Для создания профиля диспетчера трафика и настройки параметров можно использовать интерфейсы REST API, Windows PowerShell или портал Azure. Дополнительную информацию см. в разделе [Как настроить параметры диспетчера трафика](#how-to-configure-traffic-manager-settings). Следующие шаги предполагают, что на портале Azure используется **быстрое создание**. 
   - **Создайте профиль диспетчера трафика.** Сведения о создании профиля с помощью указанной выше функции на портале Azure см. в статье [Управление профилями диспетчера трафика](traffic-manager-manage-profiles.md).
   - **Настройте параметры метода маршрутизации трафика** — при использовании функции "Быстрое создание" необходимо выбрать метод маршрутизации трафика для профиля. Этот параметр можно изменить в любой момент после завершения шагов «Быстрого создания». Чтобы ознакомиться с шагами по созданию конфигурации, см. раздел, посвященный выбранному методу маршрутизации трафика: [Настройка метода маршрутизации трафика для повышения производительности](traffic-manager-configure-performance-load-balancing.md), [Настройка метода маршрутизации трафика для отработки отказа](traffic-manager-configure-failover-load-balancing.md), [Настройка метода маршрутизации трафика с циклическим перебором](traffic-manager-configure-round-robin-load-balancing.md).
   
   >[AZURE.NOTE]Метод маршрутизации трафика с циклическим перебором теперь поддерживает взвешенное распределение сетевого трафика. Однако теперь следует использовать интерфейсы REST API или Windows PowerShell для настройки веса. Дополнительную информацию и пример конфигурации см. в статье [Внешние конечные точки диспетчера трафика Azure и взвешенный циклический перебор с помощью PowerShell](http://azure.microsoft.com/blog/2014/06/26/azure-traffic-manager-external-endpoints-and-weighted-round-robin-via-powershell/) в блоге Azure.

   - **Настройте конечные точки** — конечные точки не настраиваются во время быстрого создания. После создания профиля и указания метода маршрутизации трафика можно указать диспетчеру трафика конечные точки. Инструкции по настройке конечных точек см. в статье [Управление конечными точками в диспетчере трафика](traffic-manager-endpoints.md).

   - **Настройте параметры мониторинга** — параметры мониторинга не настраиваются во время быстрого создания. После создания профиля и указания метода маршрутизации трафика можно указать диспетчеру трафика, что следует отслеживать. Указания по настройке мониторинга см. в статье [Мониторинг диспетчера трафика](traffic-manager-monitoring.md).
6. **Проверьте профиль диспетчера трафика.** Убедитесь, что профиль и домен работают надлежащим образом. Информацию о том, как это сделать, см. в статье [Проверка параметров диспетчера трафика](traffic-manager-testing-settings.md).
7. **Укажите профиль в записи ресурса DNS доменного имени вашей компании, чтобы сделать его активным.** Дополнительную информацию см. в статье [Направление интернет-домена компании на домен диспетчера трафика](traffic-manager-point-internet-domain.md).

В примере на рис. 1 необходимо изменить запись ресурса DNS на серверах на следующее значение, чтобы направить доменное имя компании на доменное имя диспетчера трафика: www.contoso.com IN CNAME contoso.trafficmanager.net

## Настройка параметров диспетчера трафика

Параметры диспетчера трафика можно задать на портале Azure, с помощью интерфейсов REST API или командлетов Windows PowerShell.

Хотя на портале Azure отображаются не все элементы интерфейсов REST API, многие параметры можно задать с помощью обоих этих методов. Подробнее об использовании REST API см. в разделе [Операции диспетчером трафика (справочник по REST API)](http://go.microsoft.com/fwlink/p/?LinkId=313584).

Подробнее о командлетах Windows PowerShell для диспетчера трафика см. в разделе [Командлеты для диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769).

>[AZURE.NOTE]В текущий момент настройка внешних конечных точек (тип «Любые»), весов для метода маршрутизации трафика с циклическим перебором и вложенных профилей на портале Azure не поддерживается. Необходимо использовать REST (см. раздел [Создание определения](http://go.microsoft.com/fwlink/p/?LinkId=400772)) или Windows PowerShell (см. раздел [Add-AzureTrafficManagerEndpoint](https://msdn.microsoft.com/library/azure/dn690257.aspx)).

### Настройка параметров на портале Azure

На портале Azure с помощью функции быстрого создания можно создать собственный профиль диспетчера трафика. Функция быстрого создания позволяет создать базовый профиль. После создания профиля можно задать дополнительные параметры либо изменить параметры, которые были заданы ранее. Дополнительную информацию о создании профиля диспетчера трафика с помощью функции быстрого создания см. в статье [Управление профилями диспетчера трафика](traffic-manager-manage-profiles.md).

На портале Azure можно настроить следующие параметры.

- **Префикс DNS.** Уникальный префикс, который вы создаете. Профили отображаются на портале Azure по префиксам.
- **Срок жизни DNS.** Срок жизни DNS управляет тем, как часто клиентский локальный сервер кэширования имен будет запрашивать систему DNS диспетчера трафика Azure для обнаружения обновленных DNS-записей.
- **Подписка.** Выберите подписку, к которой будет относиться этот профиль. Обратите внимание, что этот параметр отображается только в том случае, если у вас несколько подписок.
- **Метод маршрутизации трафика.** Способ, посредством которого диспетчер трафика будет маршрутизировать трафик.
- **Порядок переключения.** При использовании метода маршрутизации трафика с отработкой отказа это порядок конечных точек.
- **Мониторинг.** Параметры мониторинга включают в себя протокол (HTTP или HTTPS), порт, относительный путь и имя файла.

### Настройка параметров с помощью интерфейсов REST API

Создать и настроить профиль диспетчера трафика можно с помощью интерфейсов REST API. Дополнительную информацию см. в разделе [Операции с диспетчером трафика (справочник по REST API)](http://go.microsoft.com/fwlink/?LinkId=313584).

- **Профиль.** Профиль, который содержит создаваемый префикс доменного имени. Каждый профиль соответствует подписке. Можно создать несколько профилей для одной подписки. Имя профиля отображается на портале Azure. Создаваемое имя, указанное в профиле, называется доменом диспетчера трафика.
- **Определение.** Содержит параметры политики и мониторов. Определение соответствует профилю. Для профиля может существовать только одно определение. Само определение не отображается на портале Azure, хотя многие из параметров в определении видны и могут быть настроены на портале.
- **Параметры DNS.** В каждом определении есть параметры DNS. Здесь настраивается время жизни DNS.
- **Мониторы.** В каждом определении содержатся параметры монитора. Здесь настраиваются протокол, порт, имя файла и относительный путь. Параметры мониторов отображаются и могут быть изменены на портале Azure. Дополнительную информацию см. в разделе [Мониторинг диспетчера трафика](traffic-manager-monitoring.md).
- **Политика.** Параметры политики содержатся в каждом определении. В политике задаются методы и конечные точки маршрутизации трафика. Сама политика не отображается на портале Azure, хотя многие из параметров политики видны и могут быть настроены на портале. Дополнительную информацию см. в разделе [О методах маршрутизации трафика в диспетчере трафика](traffic-manager-load-balancing-methods.md).

## Настройка параметров с помощью Windows PowerShell

Создать и настроить профиль диспетчера трафика можно с помощью Windows PowerShell. Дополнительную информацию см. в разделе [Командлеты для диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769).

## Рекомендации

- **Сделайте префиксы уникальными и легкими для понимания** — DNS-имя профиля диспетчера трафика должно быть уникальным. Можно изменять только первую часть DNS-имени. Доменное имя диспетчера трафика используется только для идентификации и направления клиентских запросов. Клиентские компьютеры никогда не отображают эти имена для конечных пользователей. Однако это доменное имя определяет профили, поэтому важно, чтобы его можно было быстро отличить от других доменных имен, перечисленных на портале Azure.
- **Используйте точки, чтобы обеспечить уникальность или облегчить чтение доменных имен** — также точки можно использовать для разделения частей префикса доменного имени. Если вы планируете создать несколько политик в диспетчере трафика, используйте согласованную иерархию, чтобы различать службы. Например, в Contoso присутствуют глобальные службы для работы в Интернете, выставления счетов и управления программами. Можно было бы использовать три политики: *web.contoso.trafficmanager.net*, *bill.contoso.trafficmanager.net* и *util.contoso.trafficmanager.net*. При настройке облачных служб и веб-сайтов используйте имена, которые указывают на местоположение. Например, *web-us-contoso.cloudapp.net* и *web-asia-contoso.cloudapp.net*. Ограничения накладываются системой DNS. Предположим, что доменное имя — это последовательность меток, разделенная точками (метка.метка.метка.метка. и т. д.). На момент написания этой документации в диспетчере трафика существовали следующие ограничения для доменных имен.
   - Длина каждой метки не может превышать 63 символа.
   - Нельзя иметь более 40 меток. Две метки заняты trafficmanager.net, поэтому для префикса остается 38.
   - Длина всего доменного имени не может превышать 253 символа. Не забывайте, что trafficmanager.net занимает 19 из этих символов.
- **Срок жизни DNS.** Значение срока жизни DNS управляет тем, как часто клиентский локальный сервер кэширования имен будет запрашивать систему DNS диспетчера трафика Azure для обнаружения обновленных DNS-записей. Для любого изменения, происходящего в пределах диспетчера трафика, например изменения профиля или изменения доступности конечной точки, потребуется этот промежуток времени, чтобы оно распространилось по глобальной системе DNS-серверов. Рекомендуется оставить для этого параметра значение по умолчанию — 300 секунд (5 минут). При задании более высокого значения увеличивается время хранения ответов DNS диспетчера трафика в кэше сопоставителями и клиентами DNS, благодаря чему общая задержка запросов DNS уменьшается. Однако если требуется быстрая отработка отказа, то лучше задать более низкое значение.
- **Конечные точки должны находиться в одной подписке.** Все конечные точки должны быть в той подписке, в которой создается профиль. Можно добавить конечные точки из разных подписок в профиль как внешние конечные точки, но Azure не удалит их автоматически, если отключить или удалить связанную службу. В результате внешние конечные точки сохранятся в профиле диспетчера трафика, и за них будет взиматься плата, если их вручную не удалить.
- **Только службы рабочей среды.** Доступны только конечные точки в рабочей среде. Нельзя направлять трафик на конечные точки, работающие в промежуточной среде. Обратите внимание, что, если переключить виртуальный IP-адрес (VIP), когда профиль направляет трафик, трафик будет использовать конечную точку, только что введенную в рабочую среду.
- **Назовите конечные точки так, чтобы потом их можно было легко идентифицировать.** Учитывайте префикс DNS. DNS-имя используется, поскольку его уникальность гарантируется в пределах подписки. Имя облачной службы или веб-сайта этого не гарантирует. Во избежание путаницы присваивайте облачным службам и веб-сайтам одинаковые или схожие имена и префиксы DNS. При наличии более 20 облачных служб и веб-сайтов плохой метод именования затрудняет поиск нужных конечных точек. Кроме того, плохо названные конечные точки затрудняют обслуживание профилей.
- **Все конечные точки в профиле должны обслуживать одни и те же операции и порты.** Если вы используете различающиеся в этом отношении конечные точки, возникает вероятность того, что клиент вызовет конечную точку, которая не сможет выполнить запрос.
- **Все облачные службы в профиле должны использовать одни и те же параметры мониторинга.** Можно выбрать только один путь и файл для отслеживания всех конечных точек в заданном определении. Можно ввести «/» в поле **Относительный путь и имя файла**, чтобы монитор попытался получить доступ к пути и имени файла по умолчанию.
- **Отключайте конечные точки для внесения временных изменений, а не меняйте конфигурацию.** Во многих случаях может потребоваться перевести конечную точку в режим «не в сети». Вместо удаления конечной точки из профиля просто отключите отдельную конечную точку в профиле. Эта операция оставляет конечную точку в рамках профиля, но при этом профиль действует так, как если бы конечная точка не была в него включена. Это полезно, если нужно временно удалить конечную точку, которая находится в режиме обслуживания или повторно развертывается. После повторного запуска конечной точки ее можно включить. Дополнительную информацию см. в статье [Управление конечными точками в диспетчере трафика](traffic-manager-endpoints.md).
- **Отключайте профиль для внесения временных изменений, а не удаляйте его.** Бывает необходимо перевести весь профиль в режим «вне сети», а не только отдельные конечные точки в нем. Для этого отключите профиль. При отключении профиля все параметры остаются доступными для правки на портале Azure. Позже, когда появится необходимость снова его использовать, профиль можно легко и просто перевести в режим «в сети». Дополнительную информацию см. в статье [Управление конечными точками в диспетчере трафика](traffic-manager-endpoints.md).
- **Хранилище.** При использовании диспетчера трафика очень важно правильно спланировать размещение и распределение данных в хранилище. Рассмотрите сквозную транзакцию и то, как данные будут перемещаться, при разработке и развертывании приложений для диспетчера трафика.
- **SQL Azure.** Когда вы расширяете конечные точки до нескольких географических регионов, то, как и при проектировании хранилища, проанализируйте состояние приложения и требования к данным для него.

## Вложенные профили

В качестве конечной точки можно указать имя другого профиля диспетчера трафика (это называется вложенными профилями). Именем профиля диспетчера трафика является соответствующее DNS-имя, например contoso-europe.trafficmanager.net.

Это позволяет настраивать диспетчер трафика так, чтобы входящие запросы DNS-имен анализировались в наборе уровней, чтобы запрашивающий клиент направлялся в правильный набор конечных точек. На *рис. 3* приведен пример.

![Пример вложенных профилей диспетчера трафика](./media/traffic-manager-overview/IC751072.png)

**Рис. 3**

Можно вложить до 10 уровней, и каждый профиль можно настраивать с разным методом маршрутизации трафика.

Например, можно создать конфигурацию для следующих задач.

- На верхнем уровне (профиль диспетчера трафика, который сопоставляется с внешним DNS-именем) можно настроить профиль с методом маршрутизации трафика по производительности.
- На среднем уровне набор профилей диспетчера трафика представляет собой разные центры обработки данных и использует метод маршрутизации трафика с циклическим перебором.
- На нижнем уровне запросы пользователя на трафик обслуживает набор конечных точек облачной службы в каждом центре обработки данных.

В результате пользователи направляются в свой региональный центр данных на основании производительности и в облачную службу в этом центре данных на основании равномерного или взвешенного распределения нагрузки. Например, для распределения небольшой доли трафика в новое или пробное развертывание для тестирования или получения отзывов пользователей может использоваться взвешивание.

На *рис. 4* показана эта конфигурация.

![Пример многоуровневых профилей диспетчера трафика](./media/traffic-manager-overview/IC751073.png)

**Рис. 4**

На *рис. 4* профиль диспетчера трафика на верхнем уровне является родительским профилем, а профили диспетчера трафика на среднем уровне — дочерними профилями.

Если диспетчер трафика направляет пользователей в дочерний профиль с небольшим количеством исправных конечных точек, то эти точки могут оказаться перегруженными, что приведет к проблемам с производительностью. Для предотвращения такой ситуации родительский профиль диспетчера трафика можно настроить с пороговым количеством исправных конечных точек, которое будет определять, может ли какая-либо из конечных точек в пределах дочерних профилей данного родительского элемента получать трафик. Например, если необходимо убедиться в том, что в дочерних профилях существуют по крайней мере три исправные конечные точки, установите пороговое значение 3. В примере на рис. 4 для этого порогового значения настроен профиль диспетчера трафика верхнего уровня.

Для добавления профиля диспетчера трафика в качестве конечной точки и настройки минимального количества исправных конечных точек необходимо использовать REST (см. раздел [Создание определения](http://go.microsoft.com/fwlink/p/?LinkId=400772)) или Windows PowerShell (см. раздел [Add-AzureTrafficManagerEndpoint](https://msdn.microsoft.com/library/azure/dn690257.aspx)). Использовать портал Azure нельзя.

## Схемы диспетчера трафика

Если вам нужны схемы, приведенные в этом разделе, для слайдов презентации PowerPoint по диспетчеру трафика или для изменения в личных целях, см. [схемы диспетчера трафика в документации MSDN](http://gallery.technet.microsoft.com/Traffic-Manager-figures-in-887e7c99).

## Дальнейшие действия

[Методы маршрутизации диспетчера трафика](traffic-manager-routing-methods.md)

[Мониторинг диспетчера трафика](traffic-manager-monitoring.md)

[Создание профиля](traffic-manager-manage-profiles.md)

[Командлеты для диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769)

<!---HONumber=AcomDC_1203_2015-->