<properties
   pageTitle="Мониторинг и отработка отказа конечной точки диспетчера трафика | Microsoft Azure"
   description="Из этой статьи вы узнаете, каким образом благодаря мониторингу и автоматической отработке отказа конечных точек в диспетчере трафика пользователи Azure могут развертывать высокодоступные приложения."
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="06/04/2016"
   ms.author="jtuliani" />

# Мониторинг и отработка отказов конечной точки диспетчера трафика

Диспетчер трафика Azure включает в себя встроенные возможности мониторинга и автоматическую отработку отказа конечных точек. Благодаря этому можно получать высокодоступные приложения, которые устойчивы к сбоям конечной точки, в том числе к сбоям региона Azure.

Диспетчер трафика периодически отправляет запросы к каждой конечной точке и проверяется полученные ответы. Если конечная точка не отправляет допустимый ответ, диспетчер трафика показывает, что ее функциональность понижена. Она больше не добавляется в ответы DNS, и вместо нее возвращается альтернативная доступная конечная точка. Таким образом трафик пользователей направляется в доступные конечные точки, обходя неисправные.

Проверки работоспособности для конечных точек с состоянием пониженной функциональности продолжают выполняться, и когда их работоспособность восстановится, эти конечные точки автоматически будут возвращены в работу.

## Настройка мониторинга конечных точек

Чтобы настроить мониторинг конечных точек, необходимо указать следующие параметры в профиле диспетчера трафика.

- **Протокол**. Выберите HTTP или HTTPS. Важно отметить, что мониторинг HTTPS проверяет действительность SSL-сертификата, а только его наличие.
- **Порт**. Выберите порт, используемый для запроса. Доступны стандартные порты HTTP и HTTPS.
- **Путь**. Введите относительный путь и имя веб-страницы или файла, к которому попытается получить доступ проверка работоспособности мониторинга. Обратите внимание, что косая черта (/) является допустимым относительным путем и указывает, что файл расположен в корневом каталоге (по умолчанию).

Чтобы проверить работоспособность каждой конечной точки, диспетчер трафика отправляет запрос GET к конечной точке, используя указанный протокол, порт и относительный путь.

Распространенной практикой является реализация пользовательской страницы в приложении, например /health.aspx. Настройте эту страницу так, чтобы она была путем для мониторинга конечных точек диспетчера трафика. На этой странице можно выполнять любые необходимые проверки приложений, например проверку доступности базы данных перед возвратом кода состояния HTTP 200 (если служба находится в работоспособном состоянии) или другого кода в случае неисправности.

Параметры мониторинга конечных точек настраиваются на уровне профиля диспетчера трафика, а не конечной точки. Поэтому для проверки работоспособности всех конечных точек используются одни и те же параметры. Если необходимо использовать разные параметры мониторинга для разных конечных точек, то можно воспользоваться [вложенными профилями диспетчера трафика](traffic-manager-nested-profiles.md#example-5-per-endpoint-monitoring-settings).

## Состояние конечной точки и профиля

Можно включать и отключать профили и конечные точки диспетчера трафика. Однако изменение состояния конечной точки также может произойти в результате автоматической настройки и процессов диспетчера трафика. Ниже приведены параметры и описано, как это функционирует.

### Состояние конечной точки

Состояние конечной точки — это параметр, управляемый пользователем, с помощью которого можно легко включить или отключить определенную конечную точку. Это не влияет на состояние базовой службы (которая может по-прежнему выполняться). Вместо этого данный параметр управляет доступностью определенной конечной точки с точки зрения диспетчера трафика. Если конечная точка отключена, то диспетчер трафика не проверяет ее работоспособность и эта конечная точка не указывается в ответе DNS.

### Состояние профиля

Состояние профиля — это также параметр, управляемый пользователем. С его помощью можно легко включить или отключить профиль. В то время как состояние конечной точки влияет на одну конечную точку, состояние профиля влияет на весь профиль, включая все конечные точки. Конечные точки в профиле, находящемся в отключенном состоянии, не проверяются на работоспособность и не указываются в ответе DNS (возвращается ответ NXDOMAIN).

### Отслеживаемое состояние конечной точки

Состояние монитора конечной точки — это параметр, создаваемый диспетчером трафика, который отражает текущее состояние конечной точки. Этот параметр нельзя изменить вручную. Состояние монитора конечной точки отражает текущий мониторинг конечной точки, а также другие сведения, такие как состояние конечной точки. В следующей таблице показаны возможные значения состояния монитора конечной точки. (Дополнительные сведения о вычислении состояния монитора конечной точки для вложенных конечных точек см. в статье [Вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).)

|Состояние профиля|Состояние конечной точки|Состояние монитора конечной точки (API и портал)|Примечания|
|---|---|---|---|
|Отключено|Включено|Неактивно|Профиль отключен пользователем. Хотя конечная точка может оставаться в состоянии "Включено", состояние профиля ("Отключено") имеет более высокий приоритет. Конечные точки в отключенных профилях не отслеживаются и не добавляются в ответы DNS (возвращается ответ NXDOMAIN).|
|& lt;Любое&gt;.|Отключено|Отключено|Конечная точка отключена пользователем. Конечная точка в отключенном состоянии не отслеживается. Она не добавляется в ответы DNS и поэтому не получает трафик.|
|Включено|Включено|В сети|Конечная точка отслеживается и работоспособна. Она может быть добавлена в ответы DNS и может получать трафик.|
|Включено|Включено|Деградация|Проверки работоспособности мониторинга конечной точки завершаются ошибкой. Эта конечная точка не добавляется в ответы DNS и поэтому не получает трафик.|
|Включено|Включено|Проверка конечной точки|Конечная точка отслеживается, но результаты первой пробы еще не получены. Это временное состояние, которое обычно возникает сразу после добавления в профиль новой конечной точки или включения конечной точки либо профиля. Конечная точка в таком состоянии может быть добавлена в ответы DNS и может получать трафик.|
|Включено|Включено|Остановлена|Облачная служба или веб-приложение, на которое указывает конечная точка, не работает. Проверьте параметры облачной службы или веб-приложения. Конечная точка в остановленном состоянии не отслеживается. Она не добавляется в ответы DNS и поэтому не получает трафик.|

### Состояние монитора профиля

Состояние монитора профиля — это сочетание значений состояния монитора для всех конечных точек в профиле и состояния настроенного профиля. Возможные значения приведены в следующей таблице.

|Состояние профиля (согласно настройкам)|Отслеживаемое состояние конечной точки|Состояние монитора профиля (API и портал)|Примечания|
|---|---|---|---|
|Отключено|& lt;Любое&gt;, или профиль без определенных конечных точек.|Отключено|Профиль отключен пользователем.|
|Включено|По крайней мере одна конечная точка находится в состоянии пониженной функциональности.|Деградация|Это признак того, что требуется действие клиента. Просмотрите значения состояния отдельных конечных точек, чтобы определить, какие конечные точки необходимо рассмотреть.|
|Включено|По крайней мере одна конечная точка находится в сети. Отсутствуют конечные точки в состоянии пониженной функциональности.|В сети|Служба принимает трафик, и от пользователя не требуется действий.|
|Включено|По крайней мере одна конечная точка находится в состоянии проверки конечной точки. Нет конечных точек, находящихся в сети или в состоянии пониженной функциональности.|Проверка конечных точек|Переходное состояние. Это обычно происходит сразу после создания или включения профиля и при первой проверке работоспособности конечных точек.|
|Включено|Все конечные точки, определенные в профиле, отключены или остановлены, либо в профиле не определены конечные точки.|Неактивно|Конечные точки не активны, но профиль включен.|

## Отработка отказа и восстановление размещения конечной точки

Рассмотрим сценарий, в котором ранее работоспособная конечная точка выходит из строя. Диспетчер трафика обнаруживает сбой, и конечная точка перестает использоваться. Позже работоспособность конечной точки восстанавливается. Диспетчер трафика обнаруживает это и возобновляет использование этой конечной точки.

>[AZURE.NOTE] Диспетчер трафика считает, что конечная точка в сети, только если возвращено сообщение "200 ОК". Любое из следующих условий диспетчер трафика рассматривает как сбой конечной точки при проверке работоспособности:

>- получен ответ, отличный от 200 (включая различные коды 2xx или перенаправление 301/302);
>- запрос на проверку подлинности клиента;
>- время ожидания (пороговое значение времени ожидания составляет 10 секунд);
>- не удается подключиться.

>Дополнительную информацию об устранении неполадок, вызвавших сбой при проверке, см. в разделе [Устранение неполадок с состоянием "Деградация" в диспетчере трафика Azure](traffic-manager-troubleshooting-degraded.md).

На следующей временной шкале показана подробная последовательность действий.

![Последовательность действий при отработке отказа и восстановлении после сбоя конечной точки диспетчера трафика](./media/traffic-manager-monitoring/timeline.png)

1. **GET**. Система мониторинга диспетчера трафика выполняет запрос GET для пути и файла, указанных в параметрах мониторинга. Это повторяется для каждой конечной точки.
2. **200 ОК**. Система мониторинга ожидает возврата сообщения HTTP "200 ОК" в течение 10 секунд. Получив этот ответ, система распознает облачную службу как доступную.
3. **30 секунд между проверками**. Проверка работоспособности конечной точки будет выполняться каждые 30 секунд.
4. **Служба недоступна**. Служба становится недоступной. Диспетчеру трафика станет известно об этом только при следующей проверке работоспособности.
5. **Выполняется попытка получения доступа к файлу мониторинга (4 попытки)**. Система мониторинга выполняет запрос GET, но не получает ответ в течение периода ожидания длительностью 10 секунд (также может быть получен ответ, отличный от 200). Затем она выполняет еще три попытки с интервалом в 30 секунд. Если одна из попыток оказывается успешной, число попыток сбрасывается.
6. **Устанавливается состояние пониженной функциональности**. После четырех последовательных неудачных попыток система мониторинга помечает недоступную конечную точку как находящуюся в состоянии пониженной функциональности.
7. **Трафик направляется на другие конечные точки**. DNS-серверы диспетчера трафика обновляются, и диспетчер трафика больше не возвращает эту конечную точку в ответ на запросы DNS. Новые подключения направляются к другим, доступным конечным точкам. Однако рекурсивные DNS-серверы и DNS-клиенты могут по-прежнему содержать в кэше предыдущие ответы DNS с этой конечной точкой. Из-за этого некоторые клиенты будут пытаться подключиться к ней. По истечении срока действия этого кэша клиенты создадут новые запросы DNS и будут направлены к другим конечным точкам. Длительность кэширования задается с помощью параметра срока жизни в профиле диспетчера трафика. Например, это может быть 30 секунд.
8. **Проверки работоспособности продолжаются**. Диспетчер трафика продолжает проверять работоспособность конечной точки, пока она находится в состоянии пониженной функциональности. Таким образом, он может определить, когда конечная точка вновь станет работоспособной.
9. **Служба возвращается в сеть**. Служба становится доступной. Конечная точка будет оставаться в состоянии пониженной функциональности в диспетчере трафика, пока система мониторинга не выполнит следующую проверку работоспособности.
10. **Возобновляется направление трафика к службе**. Диспетчер трафика отправляет запрос GET и получает ответ о состоянии "200 OK". Это означает, что служба вернулась в работоспособное состояние. Серверы имен диспетчера трафика снова обновляются и начинают передавать DNS-имя службы в ответах DNS. Трафик вернется к конечной точке, так как срок действия кэшированных ответов DNS, возвращающих другие конечные точки, истек, и существующие подключения к другим конечным точкам завершены.

>[AZURE.NOTE] Так как диспетчер трафика работает на уровне DNS, он не может влиять на существующие подключения к какой-либо конечной точке. При маршрутизации трафика между конечными точками (путем изменения параметров профиля либо во время отработки отказа или восстановления размещения) диспетчер трафика направляет новые подключения к доступным конечным точкам. Однако другие конечные точки могут по-прежнему получать трафик через имеющиеся подключения, пока эти сеансы не будут завершены. Чтобы трафик не проходил через имеющиеся подключения, для приложений следует ограничить продолжительность сеанса в каждой конечной точке.

## Конечные точки в состоянии "Деградация"

Когда конечная точка находится в состоянии пониженной функциональности, она больше не возвращается в ответе на запросы DNS (исключение из этого правила см. в примечании в конце этого раздела). Вместо этого выбирается и возвращается альтернативная конечная точка. Выбор альтернативной конечной точки зависит от настроенного метода маршрутизации трафика.

- **Приоритет**. Конечные точки формируют список по приоритетам. Всегда возвращается первая доступная конечная точка в списке. Если она переходит в состояние пониженной функциональности, то возвращается следующая доступная конечная точка.
- **Взвешивание**. Какая-либо из доступных конечных точек может быть возвращена и выбрана в произвольном порядке в зависимости от назначенного ей весового коэффициента и весовых коэффициентов других доступных конечных точек. Если конечная точка находится в состоянии пониженной функциональности, то конечная точка выбирается из оставшегося пула доступных конечных точек.
- **Производительность**. Возвращается ближайшая к конечному пользователю конечная точка (за исключением остановленных или отключенных конечных точек). Если эта конечная точка недоступна, возвращаемая конечная точка выбирается в произвольном порядке из всех остальных доступных конечных точек. (Это помогает избежать каскадных сбоев, которые потенциально могут возникнуть при перегрузке ближайшей конечной точки. Можно настроить альтернативные планы отработки отказа для маршрутизации трафика для повышения производительности с помощью [вложенных профилей диспетчера трафика](traffic-manager-nested-profiles.md#example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region).)

Дополнительные сведения см. в разделе [Методы маршрутизации трафика в диспетчере трафика](traffic-manager-routing-methods.md).

>[AZURE.NOTE] Что произойдет в случае сбоя проверки работоспособности всех конечных точек диспетчера трафика (за исключением отключенных и остановленных конечных точек) и их перехода в состояние пониженной функциональности?

>Как правило, это происходит из-за ошибки в конфигурации службы (например, список контроля доступа (ACL) блокирует проверки работоспособности диспетчера трафика) или ошибки в конфигурации профиля диспетчера трафика (например, задан неправильный путь для мониторинга).

>В этом случае диспетчер трафика по возможности *воспринимает конечные точки в состоянии пониженной функциональности как работающие и находящиеся в сети*. Это предпочтительнее альтернативного варианта — вообще не возвращать конечную точку в ответе DNS.

>В таком режиме, даже если проверки работоспособности диспетчера трафика настроены неправильно, с точки зрения маршрутизации трафика может показаться, что диспетчер трафика *работает правильно*. Кроме того, в этом случае при сбое конечной точки не происходит отработка отказа, что негативно влияет на общую доступность приложения. Чтобы этого не произошло, необходимо, чтобы профиль находился в сети, а не в состоянии пониженной функциональности. Это состояние указывает на то, что проверки работоспособности диспетчера трафика выполняются надлежащим образом.

Дополнительные сведения об устранении неполадок, вызвавших сбой при проверке работоспособности, см. в статье [Устранение неполадок, связанных со сбоем диспетчера трафика](traffic-manager-troubleshooting-degraded.md).

## Часто задаваемые вопросы

### Устойчив ли диспетчер трафика к сбоям в регионе Azure?

Благодаря встроенным возможностям проверки работоспособности и автоматической отработки отказа между регионами диспетчер трафика является ключевым компонентом для предоставления высокодоступных приложений в Azure, в том числе приложений, устойчивых к сбоям во всем регионе Azure.

Таким образом диспетчер трафика сам по себе должен обеспечивать исключительно высокий уровень доступности и устойчивость к региональных сбоям.

Несмотря на то, что некоторые компоненты диспетчера трафика выполняются в Azure, они распределены по регионам, а их архитектура предусматривает устойчивость к полному сбою любого региона Azure. Эта устойчивость применяется ко всем компонентам диспетчера трафика: DNS-серверам, API-интерфейсам, уровню хранилища и службе мониторинга конечных точек.

Таким образом, даже в случае общего сбоя всего региона Azure, что маловероятно, диспетчер трафика должен продолжать работать в обычном режиме, а пользователи, использующие приложения, развернутые в нескольких регионах Azure, могут быть уверены, что диспетчер трафика перенаправит трафик в доступный экземпляр их приложения.

### Каким образом выбор расположения группы ресурсов влияет на диспетчер трафика?

Диспетчер трафика — это единая глобальная служба. Она не является региональной. Выбор расположения группы ресурсов никак не влияет на профили диспетчера трафика, развернутые в этой группе ресурсов.

Для Azure Resource Manager требуется, чтобы все группы ресурсов указывали расположение, которое определяет расположение по умолчанию для ресурсов, развернутых в этой группе ресурсов. Если профиль диспетчера трафика создан на портале Azure, то при создании новой группы ресурсов вы получите запрос на ввод этого расположения.

Во всех профилях диспетчера трафика для расположения задано значение **Глобальный**. Этот параметр недоступен на портале Azure, в PowerShell или интерфейсе командной строки Azure (Azure CLI), так как это единственное допустимое значение. Это значение переопределяет значение по умолчанию группы ресурсов.

### Как определить текущую работоспособность каждой конечной точки?

На портале управления Azure отображается текущее состояние мониторинга для каждой конечной точки, а также всего профиля. Эти сведения также можно получить с помощью [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx) монитора трафика, [командлетов PowerShell](https://msdn.microsoft.com/library/mt125941.aspx) и [кроссплатформенного Azure CLI](../xplat-cli-install.md).

Невозможно просмотреть исторические сведения о прошедшей проверке работоспособности конечных точек, а также настроить оповещения об изменениях работоспособности конечных точек.

### Можно ли отслеживать конечные точки HTTPS?

Да. Диспетчер трафика поддерживает проверку по протоколу HTTPS. Просто настройте **HTTPS** в качестве протокола в конфигурации мониторинга. Обратите внимание на следующее.

- сертификат на стороне сервера не проверяется;
- сертификаты SNI на стороне сервера не поддерживаются;
- клиентские сертификаты не поддерживаются.

### Какой заголовок узла используется для проверки работоспособности конечной точки?

Заголовок узла, используемый для проверки работоспособности HTTP и HTTPS, — это DNS-имя, связанное с каждой конечной точкой. Он представлен в качестве цели конечной точки на портале Azure, [в командлетах PowerShell](https://msdn.microsoft.com/library/mt125941.aspx), [кроссплатформенном Azure CLI](../xplat-cli-install.md) и [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx).

Это значение является частью конфигурации конечной точки. Значение, используемое в заголовке узла, нельзя использовать отдельно от свойства цели.


## Дальнейшие действия

Узнайте о том, [как работает диспетчер трафика](traffic-manager-how-traffic-manager-works.md).

Узнайте больше о [методах маршрутизации трафика](traffic-manager-routing-methods.md), поддерживаемых в диспетчере трафика.

Узнайте, как [создать профиль диспетчера трафика](traffic-manager-manage-profiles.md).

Просмотрите сведения об [устранении неполадок с состоянием пониженной функциональности](traffic-manager-troubleshooting-degraded.md) конечной точки диспетчера трафика.

<!---HONumber=AcomDC_0622_2016-->