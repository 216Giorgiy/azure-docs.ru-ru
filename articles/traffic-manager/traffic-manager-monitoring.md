<properties 
   pageTitle="Мониторинг диспетчера трафика"
   description="Эта статья поможет понять и настроить мониторинг диспетчера трафика."
   services="traffic-manager"
   documentationCenter=""
   authors="joaoma"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/17/2016"
   ms.author="joaoma" />

# О мониторинге диспетчера трафика

Диспетчер трафика Azure отслеживает конечные точки, в том числе облачные службы и веб-сайты, чтобы получить информацию об их доступности. Чтобы мониторинг выполнялся правильно, его нужно настроить одинаково для каждой конечной точки, указанной в профиле диспетчера трафика. После настройки мониторинга диспетчер трафика будет отображать состояние для конечных точек и профиля на классическом портале Azure. Параметры мониторинга для профиля диспетчера трафика можно настроить на странице настройки классического портала Azure. Вот какие параметры вы можете настроить:

- **Протокол** — выберите HTTP или HTTPS. Важно отметить, что мониторинг HTTPS проверяет не действительность SSL-сертификата, а только его наличие.

- **Порт** — выберите порт, используемый для запроса. Доступны стандартные порты HTTP и HTTPS.

- **Относительный путь и имя файла** — введите путь и имя файла, к которому попытается получить доступ система мониторинга. Обратите внимание, что косая черта («/») является допустимым относительным путем и указывает на то, что файл расположен в корневом каталоге (по умолчанию).

## О мониторинге состояния работоспособности

Диспетчер трафика Azure показывает профиль и работоспособность службы конечной точки на классическом портале Azure. В столбце состояния для профиля и конечной точки отображается последнее наблюдаемое состояние. Вы можете ориентироваться на него, когда оцениваете работоспособность своих профилей согласно настройкам мониторинга диспетчера трафика. Если профиль работоспособен, запросы DNS будут распределяться между службами на основе параметров маршрутизации трафика для профиля ("Циклический перебор", "Производительность" или "Отработка отказа"). Когда система мониторинга диспетчера трафика обнаруживает, что состояние отслеживания изменилось, она обновляет запись о состоянии на классическом портале Azure. Для обновления состояния может потребоваться до 5 минут.

### Отслеживаемое состояние конечной точки

Отслеживаемое состояние конечной точки в таблице ниже основано на результатах проверок ее работоспособности, а также на конфигурациях вашего профиля и конечных точек.

|Состояние профиля|Состояние конечной точки|Состояние монитора конечной точки (API и портал)|Примечания|
|---|---|---|---|
|Отключено|Включено|Неактивно|Отключенные профили не отслеживаются. Однако состоянием конечной точки можно управлять и в отключенных профилях.|
|& lt;Любое&gt;.|Отключено|Отключено|Отключенные профили не отслеживаются. Однако состоянием конечной точки можно управлять и в отключенных профилях.|
|Включено|Включено|В сети|Конечная точка отслеживается и исправна.|
|Включено|Включено|Деградация|Конечная точка отслеживается и неисправна.|
|Включено|Включено|Проверка конечной точки|Конечная точка отслеживается, но результаты первой проверки еще не получены. Это временное состояние, когда в профиль недавно была добавлена новая конечная точка или включена конечная точка либо профиль.|
|Включено|Включено|Остановлена|Базовая облачная служба или веб-сайт не работает.|

### Отслеживаемое состояние профиля

Отслеживаемое состояние профиля в таблице ниже является сочетанием состояний монитора конечной точки и настроенного профиля.

|Состояние профиля (согласно настройкам)|Отслеживаемое состояние конечной точки|Состояние монитора профиля (API и портал)|Примечания|
|---|---|---|---|
|Отключено|& lt;Любое&gt;, или профиль без определенных конечных точек.|Отключено|Конечные точки не отслеживаются.|
|Включено|Состояние по крайней мере одной конечной точки — «Деградация».|Деградация|Это признак того, что требуется действие клиента.|
|Включено|Состояние по крайней мере одной конечной точки — «В сети». Нет конечных точек с состоянием «Деградация».|В сети|Служба принимает трафик, и от пользователя не требуется действий.|
|Включено|Состояние по крайней мере одной конечной точки — «Проверка конечной точки». Нет конечных точек с состоянием «В сети» или «Деградация».|Проверка конечных точек|Переходное состояние. Это обычно происходит, когда профиль только что был включен и проверяется работоспособность конечных точек.|
|Включено|Состояние всех конечных точек, определенных в профиле, либо «Отключено», либо «Остановлено», либо в профиле не определены конечные точки.|Неактивно|Конечные точки не активны, но профиль включен.|

## Принцип мониторинга

Ниже показан пример временной шкалы, на которой отображен процесс мониторинга одной облачной службы. В этом сценарии отображается следующее:

- Облачная служба доступна и принимает трафик ТОЛЬКО через этот профиль диспетчера трафика.

- Облачная служба становится недоступной.

- Облачная служба остается недоступной в течение времени, существенно превышающего срок жизни DNS (TTL).

- Облачная служба снова становится доступной.

- Облачная служба продолжает получать трафик ТОЛЬКО через этот профиль диспетчера трафика.

![Последовательность мониторинга диспетчера трафика](./media/traffic-manager-monitoring/IC697947.jpg)

**Рисунок 1**. Пример последовательности мониторинга Числа в диаграмме соответствуют пронумерованному объяснению, приведенному ниже.

1. **GET** — система мониторинга диспетчера трафика выполняет операцию GET для пути и файла, указанных в параметрах мониторинга.
2. **200 OK** — система мониторинга ожидает сообщение HTTP «200 ОК» в течение 10 секунд. Получив этот ответ, система предполагает, что облачная служба доступна. 

>[AZURE.NOTE] Диспетчер трафика считает, что конечная точка в сети, только если возвращено сообщение 200 ОК. Если он получает ответ, отличный от 200, конечная точка считается недоступной, а проверка — неудачной. Дополнительную информацию об устранении неполадок, вызвавших сбой при проверке, см. в разделе [Устранение неполадок с состоянием «Деградация» в диспетчере трафика Azure](traffic-manager-troubleshooting-degraded.md).

3. **30 секунд между проверками** — эта проверка будет выполняться каждые 30 секунд.
4. **Облачная служба недоступна** — облачная служба становится недоступной. Диспетчеру трафика это неизвестно до следующей проверки.
5. **Попытки получить доступ к файлу мониторинга (4 попытки)** — система мониторинга выполняет операцию GET, но не получает ответ в течение 10 секунд или менее. Затем она выполняет еще три попытки с интервалом в 30 секунд. Это означает, что, чтобы определить недоступность службы, системе мониторинга понадобится максимум около 1,5 минуты. Если одна из попыток оказывается успешной, число попыток сбрасывается. Хотя это не показано на диаграмме, если ответ 200 OK приходит через 10 секунд после выполнения GET, система мониторинга все равно будет считать эту проверку неудачной.
6. **Отмечено как «Деградация»** — после четырех неудачных попыток подряд система мониторинга пометит недоступную облачную службу как находящуюся в состоянии «Деградация». 

7. **Трафик к облачной службе уменьшается** — трафик к недоступной облачной службе может продолжать передаваться. Клиенты будут сталкиваться со сбоями, поскольку служба недоступна. Клиенты и дополнительные DNS-серверы кэшировали запись DNS для IP-адреса недоступной облачной службы. Они продолжат разрешать DNS-имя домена компании в IP-адрес службы. Кроме того, вторичные DNS-серверы могут продолжать выдавать данные DNS недоступной службы. Пока клиенты и вторичные DNS-серверы обновляются, трафик на IP-адрес недоступной службы замедляется. Система мониторинга продолжает выполнять проверки с интервалом в 30 секунд. В этом примере служба не отвечает и остается недоступной.
8. **Трафик к облачной службе прекращается** — к этому времени большинство DNS-серверов и клиентов должны быть обновлены и трафик к недоступной службе должен остановиться. Максимальный период времени до полного прекращения трафика зависит от срока жизни. По умолчанию срок жизни DNS составляет 300 секунд (5 минут). При использовании этого значения клиенты перестают использовать службу через 5 минут. Система мониторинга продолжает выполнять проверки с интервалом в 30 секунд, а облачная служба не отвечает.
9. **Облачная служба становится доступной и получает трафик** — служба становится доступной, но диспетчер трафика не имеет об этом информации, пока система мониторинга не выполнит проверку.
10. **Трафик к службе возобновляется** — диспетчер трафика отправляет инструкцию GET и получает ответ «200 OK» менее чем за 10 секунд. Затем он начинает передавать DNS-имя облачной службы на DNS-серверы по мере того, как они запрашивают обновления. В результате трафик снова начинает поступать в службу.

## Состояние дочерней и родительской конечных точек для вложенных профилей

В следующей таблице описывается поведение мониторинга дочернего и родительского профилей вложенного профиля и параметра minChildEndpoints. Дополнительную информацию см. в разделе [Что такое диспетчер трафика](traffic-manager-overview.md).

|Состояние монитора дочернего профиля|Состояние монитора родительской конечной точки|Примечания|
|---|---|---|
|"Отключено", потому что вы отключили профиль.|Остановлена|Состояние родительской конечной точки — «Остановлено», а не «Отключено». Состояние «Отключено» указывает, что вы отключили конечную точку в родительском профиле.|
|«Деградация» — как минимум одна дочерняя конечная точка находится в состоянии «Деградация».|Состояние «В сети», если число конечных точек «В сети» в дочернем профиле составляет не менее minChildEndpoints. Состояние «Проверка конечной точки», если сумма конечных точек в состоянии «В сети» и в состоянии «Проверка конечной точки» в дочернем профиле составляет не менее minChildEndpoints. Иначе — состояние «Деградация».|Трафик перенаправляется в конечную точку в состоянии «Проверка конечной точки». Если задано слишком большое значение minChildEndpoints, родительская конечная точка всегда будет в состоянии деградации.|
|«В сети» — как минимум одна дочерняя конечная точка находится в состоянии «В сети» и нет ни одной точки в состоянии «Деградация».|То же, что и выше.||
|«Проверка конечных точек» — как минимум одна точка находится в состоянии «Проверка конечной точки». Ни одна не находится в состоянии «В сети« или «Деградация».|То же, что и выше.||
|«Неактивно» — все конечные точки находятся в состоянии «Отключено» или «Остановлено», или в этом профиле нет конечных точек.|Остановлена||

## Настройка мониторинга для определенных пути и имени

1. В каждой конечной точке, которую вы планируете добавить в профиль, создайте файл с одним и тем же именем.
2. Для каждой конечной точки проверьте доступ к файлу с помощью веб-браузера. URL-адрес состоит из доменного имени той или иной конечной точки (облачной службы или веб-сайта), пути к файлу и имени файла. 
3. На классическом портале Azure в разделе **Параметры мониторинга** в поле **Относительный путь и имя файла** укажите путь и имя файла.
4. Изменив конфигурацию, в нижней части страницы нажмите кнопку **Сохранить**.

## См. также

[Создание профиля](traffic-manager-manage-profiles.md)

[Добавление конечной точки](traffic-manager-endpoints.md)

[Устранение неполадок с состоянием «Деградация» в диспетчере трафика Azure](traffic-manager-troubleshooting-degraded.md)
 

<!---HONumber=AcomDC_0323_2016-->