<properties 
   pageTitle="Мониторинг и отработка отказа конечной точки диспетчера трафика | Microsoft Azure"
   description="Из этой статьи вы узнаете, каким образом благодаря применению мониторинга и автоматической отработки отказа конечных точек в диспетчере трафика пользователи Azure могут развертывать приложения высокого уровня доступности"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="06/04/2016"
   ms.author="jtuliani" />

# Мониторинг и отработка отказов конечной точки диспетчера трафика

Диспетчер трафика Azure включает в себя встроенные возможности мониторинга и автоматическую отработку отказа конечных точек. Благодаря этому можно получать приложения с высоким уровнем доступности, которые устойчивы к сбоям конечной точки, в том числе к сбоям в регионе Azure.

Чтобы обеспечить эти возможности, к каждой конечной точке периодически отправляются запросы и проверяются полученные ответы. Если конечная точка не предоставляет допустимый ответ, для нее задается состояние "Деградация" и она больше не включается в ответы DNS, возвращающие вместо нее альтернативную доступную конечную точку. Таким образом, трафик пользователей направляется в доступные конечные точки, обходя неисправные.

Проверки работоспособности конечных точек продолжают выполняться для конечных точек с состоянием "Деградация", и когда эти конечные точки снова станут работоспособными, они автоматически будут переведены обратно в очередь.

## Настройка мониторинга конечных точек

Чтобы настроить мониторинг конечных точек, необходимо указать следующие параметры в профиле диспетчера трафика.

- **Протокол** — выберите HTTP или HTTPS. Важно отметить, что мониторинг HTTPS проверяет не действительность SSL-сертификата, а только его наличие.
- **Порт** — выберите порт, используемый для запроса. Доступны стандартные порты HTTP и HTTPS.
- **Путь** — введите относительный путь и имя веб-страницы или файла, к которому попытается получить доступ проверка работоспособности мониторинга. Обратите внимание, что косая черта («/») является допустимым относительным путем и указывает на то, что файл расположен в корневом каталоге (по умолчанию).

Чтобы проверить работоспособность каждой конечной точки, диспетчер трафика отправляет запрос GET к конечной точке, используя указанный протокол, порт и относительный путь.

Обычно в приложении реализовывается пользовательская страница, например /health.aspx, которая настраивается как путь мониторинга конечных точек диспетчера трафика. На этой странице можно выполнять любые необходимые проверки определенного приложения, например проверку доступности внутренней базы данных перед возвратом кода состояния HTTP 200 (если служба находится в работоспособном состоянии) или другого кода в случае неисправности.

Параметры мониторинга конечных точек настраиваются на уровне профиля диспетчера трафика, а не конечной точки. Поэтому для проверки работоспособности всех конечных точек используются одни и те же параметры. Если необходимо использовать разные параметры мониторинга для разных конечных точек, можно воспользоваться [вложенными профилями диспетчера трафика](traffic-manager-nested-profiles.md#example-5-per-endpoint-monitoring-settings).

## Состояние конечной точки и профиля

Пользователь может включать и отключать профили и конечные точки диспетчера трафика. Состояние также может измениться из-за проверок работоспособности конечных точек. Ниже приведены параметры и подробно описано соответствующее поведение.

### Состояние конечной точки

Состояние конечной точки — это параметр, настраиваемый пользователем, с помощью которого можно легко включить и отключить отдельные конечные точки. Он не влияет на состояние основной службы (которая может оставаться запущенной). Этот параметр управляет доступностью этой конечной точки с точки зрения диспетчера трафика. При отключении конечная точка не проверяется на работоспособность и не возвращается в ответе DNS.

### Состояние профиля

Состояние профиля — это параметр, настраиваемый пользователем, с помощью которого можно легко включить и отключить профиль. В то время как параметр состояния конечной точки влияет на одну конечную точку, параметр состояния профиля влияет на весь профиль, включая все конечные точки. Если этот параметр отключен, конечные точки не проверяются на работоспособность и не возвращаются в ответе DNS (вместо этого на запросы DNS приходят ответы NXDOMAIN).

### Отслеживаемое состояние конечной точки

Отслеживаемое состояние конечной точки — это параметр, создаваемый диспетчером трафика. Пользователь не может задать этот параметр. Он показывает текущее состояние конечной точки, отражающее данные текущего мониторинга, а также другие сведения, например состояние конечной точки. В следующей таблице показаны возможные значения отслеживаемого состояния конечной точки. (Дополнительные сведения о вычислении отслеживаемого состояния конечной точки для вложенных конечных точек см. в статье о [вложенных профилях диспетчера трафика](traffic-manager-nested-profiles.md).)

|Состояние профиля|Состояние конечной точки|Состояние монитора конечной точки (API и портал)|Примечания|
|---|---|---|---|
|Отключено|Включено|Неактивно|Профиль отключен пользователем. Хотя для параметра "Состояние конечной точки" по-прежнему может быть задано значение "Включено", параметр "Состояние профиля" имеет более высокий приоритет. Конечные точки в отключенных профилях не отслеживаются. В ответах DNS не возвращаются конечные точки (вместо них указывается ответ NXDOMAIN).|
|& lt;Любое&gt;.|Отключено|Отключено|Конечная точка отключена пользователем. Отключенные конечные точки не отслеживаются. Их нельзя включить в ответы DNS. Поэтому они не получают трафик.|
|Включено|Включено|В сети|Конечная точка отслеживается и исправна. Ее можно включить в ответы DNS. Поэтому она может получать трафик.|
|Включено|Включено|Деградация|Проверки работоспособности мониторинга конечной точки завершаются ошибкой. Конечную точку нельзя включить в ответы DNS. Поэтому она не получает трафик.|
|Включено|Включено|Проверка конечной точки|Конечная точка отслеживается, но результаты первой проверки еще не получены. Это временное состояние, которое возникает сразу после добавления в профиль новой конечной точки или включения конечной точки либо профиля. Конечные точки в этом состоянии можно включить в ответы DNS. Поэтому они могут получать трафик.|
|Включено|Включено|Остановлена|Облачная служба или веб-приложение, на которое указывает конечная точка, не работает. Проверьте параметры облачной службы или веб-приложения. Остановленные конечные точки не отслеживаются. Их нельзя включить в ответы DNS. Поэтому они не получают трафик.|

### Отслеживаемое состояние профиля

Отслеживаемое состояние профиля — это сочетание отслеживаемого состояния для всех конечных точек в профиле и состояния настроенного профиля. В следующей таблице приведены возможные значения.

|Состояние профиля (согласно настройкам)|Отслеживаемое состояние конечной точки|Состояние монитора профиля (API и портал)|Примечания|
|---|---|---|---|
|Отключено|& lt;Любое&gt;, или профиль без определенных конечных точек.|Отключено|Профиль отключен пользователем.|
|Включено|Состояние по крайней мере одной конечной точки — «Деградация».|Деградация|Это признак того, что требуется действие клиента. Просмотрите значения состояния отдельных конечных точек, чтобы определить, какие конечные точки необходимо рассмотреть.|
|Включено|Состояние по крайней мере одной конечной точки — «В сети». Нет конечных точек с состоянием «Деградация».|В сети|Служба принимает трафик, и от пользователя не требуется действий.|
|Включено|Состояние по крайней мере одной конечной точки — «Проверка конечной точки». Нет конечных точек с состоянием «В сети» или «Деградация».|Проверка конечных точек|Переходное состояние. Это обычно происходит сразу после создания или включения профиля и при первой проверке работоспособности конечных точек.|
|Включено|Состояние всех конечных точек, определенных в профиле, либо «Отключено», либо «Остановлено», либо в профиле не определены конечные точки.|Неактивно|Конечные точки не активны, но профиль включен.|

## Отработка отказа и восстановление конечной точки после сбоя

Рассмотрим сценарий, в котором происходит сбой ранее работоспособной конечной точки диспетчера трафика. Диспетчер трафика обнаруживает этот сбой, и конечная точка больше не используется. Затем конечная точка восстанавливается, что также определяет диспетчер трафика, и возвращается в список используемых.

>[AZURE.NOTE] Диспетчер трафика считает, что конечная точка в сети, только если возвращено сообщение 200 ОК. При возникновении любой из следующих ситуаций он будет считать эту проверку неудачной:

>- получен ответ, отличный от 200 (включая различные коды 2xx или перенаправление 301/302);
>- запрос на проверку подлинности клиента;
>- время ожидания (пороговое значение времени ожидания составляет 10 секунд);
>- не удается подключиться.

>Дополнительную информацию об устранении неполадок, вызвавших сбой при проверке, см. в разделе [Устранение неполадок с состоянием «Деградация» в диспетчере трафика Azure](traffic-manager-troubleshooting-degraded.md).

На следующей временной шкале показана подробная последовательность действий.

![Последовательность действий при отработке отказа и восстановлении после сбоя конечной точки диспетчера трафика](./media/traffic-manager-monitoring/timeline.png)

1. **GET** — система мониторинга диспетчера трафика выполняет операцию GET для пути и файла, указанных в параметрах мониторинга. Это повторяется для каждой конечной точки.
2. **200 OК** — система мониторинга ожидает возврата сообщения HTTP "200 ОК" в течение 10 секунд. Получив этот ответ, система распознает облачную службу как доступную.
3. **30 секунд между проверками** — проверка работоспособности конечной точки будет выполняться каждые 30 секунд.
4. **Служба недоступна** — служба становится недоступной. Диспетчеру трафика станет известно об этом только при следующей проверке работоспособности.
5. **Выполняется попытка получения доступа к файлу мониторинга (4 попытки)** — система мониторинга выполняет операцию GET, но не получает ответ в течение периода ожидания длительностью 10 секунд (также может быть получен ответ, отличный от 200). Затем она выполняет еще три попытки с интервалом в 30 секунд. Если одна из попыток оказывается успешной, число попыток сбрасывается.
6. **Отмечено как "Деградация"** — после четырех неудачных попыток подряд система мониторинга пометит недоступную конечную точку как находящуюся в состоянии "Деградация". 
7. **Трафик перенаправляется в другие конечные точки** — DNS-серверы диспетчера трафика обновляются и диспетчер трафика больше не будет возвращать конечную точку в ответе на запросы DNS. Поэтому новые подключения будут направляться в другие, доступные конечные точки. Однако рекурсивные DNS-серверы и DNS-клиенты могут по-прежнему кэшировать предыдущие ответы DNS, содержащие эту конечную точку, из-за чего некоторые клиенты будут выполнять попытки подключения к этой конечной точке. По истечении срока действия кэша клиенты создадут новые запросы DNS и будут направляться в различные конечные точки. Длительность кэширования задается с помощью параметра TTL в профиле диспетчера трафика, например 30 секунд. 
8. **Проверки работоспособности продолжаются** — диспетчер трафика продолжает проверять работоспособность конечной точки, пока она находится в состоянии "Деградация". Таким образом, он может определить, когда конечная точка вновь станет работоспособной.
9. **Служба снова появляется в сети** — служба становится доступной. Конечная точка будет оставаться в состоянии "Деградация" в диспетчере трафика, пока система мониторинга не выполнит следующую проверку работоспособности.
10. **Направление трафика к службе возобновляется** — диспетчер трафика отправляет инструкцию GET и получает ответ "200 ОК", указывающий на то, что служба снова находится в работоспособном состоянии. Серверы имен диспетчера трафика снова обновляются и начинают передавать DNS-имя службы в ответах DNS. Трафик снова вернется к конечной точке, так как срок действия кэшированных ответов DNS, возвращающих другие конечные точки, истек, и существующие подключения к другим конечным точкам прекращены.

>[AZURE.NOTE] Так как диспетчер трафика работает на уровне DNS, он не влияет на существующие подключения к какой-либо конечной точке. При направлении трафика между конечными точками (путем изменения параметров профиля либо во время отработки отказа или восстановления после сбоя) диспетчер трафика будет направлять новые подключения в доступные конечные точки. Однако другие конечные точки могут по-прежнему получать трафик через имеющиеся подключения, пока эти сеансы не будут прерваны. Чтобы трафик не проходил через имеющиеся подключения, для приложений следует ограничить продолжительность сеанса в каждой конечной точке.

## Конечные точки в состоянии "Деградация"

Когда конечная точка находится в состоянии "Деградация", она больше не возвращается в ответе на запросы DNS (исключение из этого правила см. в примечании ниже). Вместо этого выбирается и возвращается альтернативная конечная точка. Выбор альтернативной конечной точки зависит от настроенного метода маршрутизации трафика.

- **Приоритет** — конечные точки формируют список по приоритетам. Всегда возвращается первая доступная конечная точка в списке. Если она переходит в состояние "Деградация", возвращается следующая доступная конечная точка.
- **Взвешивание** — какая-либо из доступных конечных точек может быть возвращена и выбрана в произвольном порядке в зависимости от назначенного ей весового коэффициента и весовых коэффициентов других доступных конечных точек. Если конечная точка переходит в состояние "Деградация", конечная точка выбирается из оставшегося пула доступных конечных точек.
- **Производительность** — возвращается ближайшая к конечному пользователю конечная точка (за исключением остановленных или отключенных конечных точек). Если эта конечная точка недоступна, возвращаемая конечная точка выбирается в произвольном порядке из всех остальных доступных конечных точек. (Это помогает избежать каскадных сбоев, которые потенциально могут возникнуть при перегрузке ближайшей конечной точки. Альтернативные планы отработки отказа для маршрутизации трафика для повышения производительности можно настроить с помощью [вложенных профилей диспетчера трафика](traffic-manager-nested-profiles.md#example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region).)

Дополнительные сведения см. в статье [Методы маршрутизации диспетчера трафика](traffic-manager-routing-methods.md).

>[AZURE.NOTE] Что произойдет в случае сбоя проверки работоспособности всех конечных точек диспетчера трафика (за исключением конечных точек с состоянием "Отключено" или "Остановлено") или если каждой из них задано состояние "Деградация"?

>Как правило, это происходит из-за ошибки в конфигурации службы (например, список ACL блокирует проверки работоспособности диспетчера трафика) или ошибки в конфигурации профиля диспетчера трафика (к примеру, задан неправильный путь мониторинга).

>В этом случае диспетчер трафика по возможности *воспринимает конечные точки с состоянием "Деградация" как имеющие состояние "В сети"*. Это предпочтительнее альтернативного варианта — не возвращать конечную точку в ответе DNS.

>При таком поведении, даже если проверки работоспособности диспетчера трафика настроены неправильно, с точки зрения маршрутизации трафика может показаться, что диспетчер трафика работает правильно. Кроме того, в случае сбоя конечной точки не происходит отработка отказа, что влияет на общую доступность приложения. Чтобы этого не произошло, необходимо, чтобы в профиле отображалось состояние "В сети", а не "Деградация". Состояние "В сети" указывает на то, что проверки работоспособности диспетчера трафика выполняются надлежащим образом.

Дополнительные сведения об устранении неполадок, вызвавших сбой при проверке работоспособности, см. в статье [Устранение неполадок, связанных со сбоем диспетчера трафика](traffic-manager-troubleshooting-degraded.md).
 
## Часто задаваемые вопросы

### Устойчив ли диспетчер трафика к сбоям в регионе Azure?

Благодаря встроенным возможностям проверки работоспособности и автоматической отработки отказа между регионами диспетчер трафика является ключевым компонентом для предоставления приложений с высокой доступностью в Azure, в том числе приложений, устойчивых к сбоям во всем регионе Azure.

Таким образом, диспетчер трафика сам по себе должен обеспечивать исключительно высокий уровень доступности и устойчивость к региональных сбоям.

Несмотря на то, что некоторые компоненты диспетчера трафика выполняются в Azure, эти компоненты распределены по регионам, а их архитектура предусматривает устойчивость к полному сбою в любом регионе Azure. Эта устойчивость применяется ко всем компонентам диспетчера трафика: DNS-серверам, API-интерфейсам, уровню хранилища и службе мониторинга конечных точек.

Таким образом, даже в случае общего сбоя всего региона Azure, что маловероятно, диспетчер трафика продолжает работать в обычном режиме, а пользователи, использующие приложения, развернутые в нескольких регионах Azure, могут быть уверены, что диспетчер трафика перенаправит трафик в доступный экземпляр их приложения.

### Каким образом выбор расположения группы ресурсов влияет на диспетчер трафика?

Диспетчер трафика — это единая глобальная служба. Она не является региональной. Выбор расположения группы ресурсов никак не влияет на профили диспетчера трафика, развернутые в этой группе ресурсов.

Для Azure Resource Manager требуется, чтобы все группы ресурсов указывали расположение, которое определяет расположение по умолчанию для ресурсов, развернутых в этой группе ресурсов. Если профиль диспетчера трафика создан на портале Azure, при создании новой группы ресурсов вы получите запрос на ввод этого расположения.

Во всех профилях диспетчера трафика для расположения задано значение "Глобальное". Так как это единственное допустимое значение, этот параметр недоступен на портале Azure, PowerShell или в интерфейсе командной строки. Это значение переопределяет значение по умолчанию группы ресурсов.

### Как определить текущую работоспособность каждой конечной точки?

Текущее состояние мониторинга для каждой конечной точки и всего профиля отображается на портале управления Azure. Эти сведения также можно получить с помощью [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx) диспетчера трафика, [командлетов PowerShell](https://msdn.microsoft.com/library/mt125941.aspx) и [кроссплатформенного интерфейса командной строки Azure](../xplat-cli-install.md).

Сейчас невозможно просмотреть накопленные сведения о последней проверке работоспособности конечных точек, а также настроить оповещения об изменениях работоспособности конечных точек.

### Можно ли отслеживать конечные точки HTTPS?

Да. Диспетчер трафика поддерживает проверку по протоколу HTTPS. Просто настройте HTTPS в качестве протокола в конфигурации мониторинга. Обратите внимание на следующее.

- сертификат на стороне сервера не проверяется;
- сертификаты SNI на стороне сервера не поддерживаются;
- клиентские сертификаты не поддерживаются.

### Какой заголовок узла используется для проверки работоспособности конечной точки?

Заголовок узла, используемый для проверки работоспособности HTTP/S, — это DNS-имя, связанное с каждой конечной точкой. Он представлен в качестве "целевого объекта" конечной точки на портале Azure, [в командлетах PowerShell](https://msdn.microsoft.com/library/mt125941.aspx), [кроссплатформенном интерфейсе командной строки Azure](../xplat-cli-install.md) и [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx).

Это значение является частью конфигурации конечной точки. Значение, используемое в заголовке узла, нельзя использовать отдельно от свойства "целевого объекта".


## Дальнейшие действия

Узнайте больше о том, [как работает диспетчер трафика](traffic-manager-how-traffic-manager-works.md).

Узнайте больше о [методах маршрутизации трафика](traffic-manager-routing-methods.md), поддерживаемых в диспетчере трафика.

Узнайте, как [создать профиль диспетчера трафика](traffic-manager-manage-profiles.md).

Просмотрите сведения об [устранении неполадок с состоянием "Деградация"](traffic-manager-troubleshooting-degraded.md) в конечной точке диспетчера трафика.
 

<!---HONumber=AcomDC_0608_2016-->