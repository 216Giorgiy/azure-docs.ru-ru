<properties
    pageTitle="Мониторинг и отработка отказа конечной точки диспетчера трафика | Microsoft Azure"
    description="Из этой статьи вы узнаете, каким образом благодаря мониторингу и автоматической отработке отказа конечных точек в диспетчере трафика пользователи Azure могут развертывать высокодоступные приложения."
    services="traffic-manager"
    documentationCenter=""
    authors="sdwheeler"
    manager="carmonm"
    editor=""
/>
<tags
    ms.service="traffic-manager"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="infrastructure-services"
    ms.date="10/11/2016"
    ms.author="sewhee"
/>


# <a name="traffic-manager-endpoint-monitoring-and-failover"></a>Мониторинг и отработка отказов конечной точки диспетчера трафика

Диспетчер трафика Azure включает в себя встроенные возможности мониторинга и автоматическую отработку отказа конечных точек. Благодаря этому можно получать высокодоступные приложения, которые устойчивы к сбоям конечной точки, в том числе к сбоям региона Azure.


## <a name="configure-endpoint-monitoring"></a>Настройка мониторинга конечных точек

Чтобы настроить мониторинг конечных точек, необходимо указать следующие параметры в профиле диспетчера трафика.

- **Протокол**. Выберите HTTP или HTTPS. Важно отметить, что мониторинг HTTPS проверяет не действительность SSL-сертификата, а только его наличие.
- **Порт**. Выберите порт, используемый для запроса.
- **Путь**. Введите относительный путь и имя веб-страницы или файла, к которому обращается средство мониторинга. В качестве относительного пути можно указать косую черту (/). Это значение указывает, что файл находится в корневом каталоге (по умолчанию).

Чтобы проверить работоспособность каждой конечной точки, диспетчер трафика отправляет запрос GET к конечной точке, используя указанный протокол, порт и относительный путь.

Распространенной практикой является реализация пользовательской страницы в приложении, например /health.aspx. Используя этот путь для мониторинга, можно выполнить проверки для конкретного приложения, такие как проверка счетчиков производительности или проверка доступности базы данных. На основании этих пользовательских проверок страница возвращает соответствующий код состояния HTTP.

Все конечные точки в профиле диспетчера трафика имеют общие параметры мониторинга. Если необходимо использовать разные параметры мониторинга для разных конечных точек, можно создать [вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md#example-5-per-endpoint-monitoring-settings).

## <a name="endpoint-and-profile-status"></a>Состояние конечной точки и профиля

Можно включать и отключать профили и конечные точки диспетчера трафика. Однако изменение состояния конечной точки также может произойти в результате автоматической настройки и процессов диспетчера трафика.

### <a name="endpoint-status"></a>Состояние конечной точки

Можно включить или отключить определенную конечную точку. Это не повлияет на базовую службу, которая может остаться работоспособной. Изменение состояния конечной точки определяет ее доступность в профиле диспетчера трафика. Если конечная точка отключена, то диспетчер трафика не проверяет ее работоспособность и эта конечная точка не включается в ответ DNS.

### <a name="profile-status"></a>Состояние профиля

С помощью параметра "состояние профиля" можно включить или отключить определенный профиль. Если состояние конечной точки влияет на одну конечную точку, то состояние профиля влияет на весь профиль, включая все конечные точки. При отключении профиля конечные точки не проверяются на работоспособность и не включаются в ответ DNS. Для запроса DNS возвращается код ответа [NXDOMAIN](https://tools.ietf.org/html/rfc2308).

### <a name="endpoint-monitor-status"></a>Отслеживаемое состояние конечной точки

Отслеживаемое состояние конечной точки — это параметр, создаваемый диспетчером трафика, который отражает состояние конечной точки. Этот параметр нельзя изменить вручную. Отслеживаемое состояние конечной точки представляет собой сочетание отслеживания и настроенного состояния конечной точки. В следующей таблице показаны возможные значения отслеживаемого состояния конечной точки:

|Состояние профиля|Состояние конечной точки|Отслеживаемое состояние конечной точки|Примечания|
|---|---|---|---|
|Отключено|Включено|Неактивно|Профиль отключен. Хотя конечная точка остается в состоянии "Включено", состояние профиля ("Отключено") имеет более высокий приоритет. Конечные точки в отключенных профилях не отслеживаются. Для запроса DNS возвращается код ответа NXDOMAIN.|
|&lt;любой&gt;|Отключено|Отключено|Конечная точка отключена. Отключенные конечные точки не отслеживаются. Эта конечная точка не включается в ответы DNS и поэтому не получает трафик.|
|Включено|Включено|В сети|Конечная точка отслеживается и работоспособна. Она включается в ответы DNS и может получать трафик.|
|Включено|Включено|Деградация|Проверки работоспособности мониторинга конечной точки завершаются ошибкой. Эта конечная точка не включается в ответы DNS и поэтому не получает трафик.|
|Включено|Включено|Проверка конечной точки|Конечная точка отслеживается, но результаты первой проверки еще не получены. CheckingEndpoint — это временное состояние, которое обычно возникает сразу же после добавления конечной точки или ее включения в профиле. Конечная точка в таком состоянии включается в ответы DNS и может получать трафик.|
|Включено|Включено|Остановлено|Облачная служба или веб-приложение, на которое указывает конечная точка, не работает. Проверьте параметры облачной службы или веб-приложения. Конечная точка в остановленном состоянии не отслеживается. Она не включается в ответы DNS и поэтому не получает трафик.|

Дополнительные сведения о вычислении отслеживаемого состояния конечной точки для вложенных конечных точек см. в статье [Вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).

### <a name="profile-monitor-status"></a>Состояние монитора профиля

Отслеживаемое состояние профиля — это сочетание настроенного состояния профиля и отслеживаемых состояний для всех конечных точек. В следующей таблице приведены возможные значения.

|Состояние профиля (согласно настройкам)|Отслеживаемое состояние конечной точки|Состояние монитора профиля|Примечания|
|---|---|---|---|
|Отключено|&lt;любой&gt; или профиль без определенных конечных точек.|Отключено|Профиль отключен.|
|Включено|По крайней мере одна конечная точка находится в состоянии пониженной функциональности.|Деградация|Просмотрите значения состояния отдельных конечных точек, чтобы определить, какие конечные точки необходимо рассмотреть.|
|Включено|По крайней мере одна конечная точка находится в сети. Отсутствуют конечные точки в состоянии пониженной функциональности.|В сети|Служба принимает трафик. Никаких действий от пользователя не требуется.|
|Включено|По крайней мере одна конечная точка находится в состоянии проверки конечной точки. Нет конечных точек, находящихся в сети или в состоянии пониженной функциональности.|Проверка конечных точек|Это переходное состояние возникает при создании или включении профиля. Работоспособность конечной точки проверяется в первый раз.|
|Включено|Все конечные точки профиля отключены или остановлены, либо в профиле не определены конечные точки.|Неактивно|Конечные точки не активны, но профиль включен.|

## <a name="endpoint-failover-and-recovery"></a>Отработка отказа и восстановление конечной точки

Диспетчер трафика периодически проверяет работоспособность всех конечных точек, включая неработоспособные конечные точки. Он обнаруживает, когда конечная точка восстановила работоспособность, и возвращает ее в работу.

>[AZURE.NOTE] Диспетчер трафика считает, что конечная точка в сети, только если возвращено сообщение "200 ОК". Конечная точка считается неработоспособной при возникновении любого из следующих событий:

>- получен ответ, отличный от 200 (включая различные коды 2xx или перенаправление 301/302);
>- запрос на проверку подлинности клиента;
>- время ожидания (пороговое значение времени ожидания составляет 10 секунд);
>- не удается подключиться.

>Дополнительную информацию об устранении неполадок, вызвавших сбой при проверке, см. в разделе [Устранение неполадок с состоянием пониженной функциональности в диспетчере трафика Azure](traffic-manager-troubleshooting-degraded.md).

Следующая временная шкала представляет собой подробное описание процесса отслеживания.

![Последовательность действий при отработке отказа и восстановлении после сбоя конечной точки диспетчера трафика](./media/traffic-manager-monitoring/timeline.png)

1. **GET**. Для каждой конечной точки система мониторинга диспетчера трафика выполняет запрос GET для пути и файла, указанных в параметрах мониторинга.
2. **200 ОК**. Система мониторинга ожидает возврата сообщения HTTP "200 ОК" в течение 10 секунд. Получив этот ответ, система распознает облачную службу как доступную.
3. **30 секунд между проверками**. Проверка работоспособности конечной точки выполняется каждые 30 секунд.
4. **Служба недоступна**. Служба становится недоступной. Диспетчеру трафика станет известно об этом только при следующей проверке работоспособности.
5. **Выполняется попытка получения доступа к файлу мониторинга (4 попытки)**. Система мониторинга выполняет запрос GET, но не получает ответ в течение периода ожидания длительностью 10 секунд (также может быть получен ответ, отличный от 200). Затем выполняется еще три попытки с интервалом в 30 секунд. Если одна из попыток оказывается успешной, число попыток сбрасывается.
6. **Устанавливается состояние пониженной функциональности**. После четырех последовательных неудачных попыток система мониторинга помечает недоступную конечную точку как находящуюся в состоянии пониженной функциональности.
7. **Трафик направляется на другие конечные точки**. DNS-серверы диспетчера трафика обновляются, и диспетчер трафика больше не возвращает эту конечную точку в ответ на запросы DNS. Новые подключения направляются к другим, доступным конечным точкам. Однако рекурсивные DNS-серверы и DNS-клиенты могут по-прежнему содержать в кэше предыдущие ответы DNS с этой конечной точкой. Клиенты продолжат использовать конечную точку, пока не истечет срок действия кэша DNS. По истечении срока действия этого кэша клиенты создадут новые запросы DNS и будут направлены к другим конечным точкам. Длительность кэширования задается с помощью параметра срока жизни в профиле диспетчера трафика. Например, это может быть 30 секунд.
8. **Проверки работоспособности продолжаются**. Диспетчер трафика продолжает проверять работоспособность конечной точки, пока она находится в состоянии пониженной функциональности. Диспетчер трафика обнаруживает, когда конечная точка восстановила работоспособность.
9. **Служба возвращается в сеть**. Служба становится доступной. Конечная точка будет оставаться в состоянии пониженной функциональности в диспетчере трафика, пока система мониторинга не выполнит следующую проверку работоспособности.
10. **Возобновляется направление трафика к службе**. Диспетчер трафика отправляет запрос GET и получает ответ о состоянии "200 OK". Служба вернулась в работоспособное состояние. Серверы имен диспетчера трафика снова обновляются и начинают передавать DNS-имя службы в ответах DNS. Трафик вернется к конечной точке, так как срок действия кэшированных ответов DNS, возвращающих другие конечные точки, истек, и существующие подключения к другим конечным точкам завершены.

>[AZURE.NOTE] Так как диспетчер трафика работает на уровне DNS, он не может влиять на существующие подключения к какой-либо конечной точке. При маршрутизации трафика между конечными точками (путем изменения параметров профиля либо во время отработки отказа или восстановления размещения) диспетчер трафика направляет новые подключения к доступным конечным точкам. Однако другие конечные точки могут по-прежнему получать трафик через имеющиеся подключения, пока эти сеансы не будут завершены. Чтобы трафик не проходил через имеющиеся подключения, для приложений следует ограничить продолжительность сеанса в каждой конечной точке.

## <a name="traffic-routing-methods"></a>Методы маршрутизации трафика

Если конечная точка переходит в состояние пониженной функциональности, она больше не возвращается в ответ на запросы DNS. Вместо этого выбирается и возвращается альтернативная конечная точка. Метод маршрутизации трафика, заданный в профиле, определяет, как выбирается альтернативная конечная точка.

- **Приоритет**. Конечные точки формируют список по приоритетам. Всегда возвращается первая доступная конечная точка в списке. Если она переходит в состояние пониженной функциональности, то возвращается следующая доступная конечная точка.
- **Взвешивание**. Случайным образом выбирается любая доступная конечная точка в зависимости от назначенного ей весового коэффициента и весовых коэффициентов других доступных конечных точек.
- **Производительность**. Возвращается конечная точка, ближайшая к конечному пользователю. Если эта конечная точка недоступна, возвращаемая конечная точка выбирается в произвольном порядке из всех остальных доступных конечных точек. Случайный выбор конечной точки помогает избежать каскадных сбоев, которые могут возникнуть при перегрузке ближайшей конечной точки. С помощью [вложенных профилей диспетчера трафика](traffic-manager-nested-profiles.md#example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region) можно настроить альтернативные планы отработки отказа для повышения производительности маршрутизации.

Дополнительные сведения см. в разделе [Методы маршрутизации трафика диспетчером трафика](traffic-manager-routing-methods.md).

>[AZURE.NOTE] Единственное исключение для нормального поведения маршрутизации трафика возникает, когда все конечные точки находятся в состоянии пониженной функциональности. В этом случае диспетчер трафика по возможности *воспринимает конечные точки в состоянии пониженной функциональности как работающие и находящиеся в сети*. Такое поведение предпочтительнее альтернативного варианта — вообще не возвращать конечную точку в ответе DNS. Отключенные и остановленные конечные точки не отслеживаются, таким образом, они не считаются допустимыми для трафика.

>Это условие обычно вызвано неправильной конфигурацией службы, например:

>    - Проверки работоспособности диспетчера трафика блокируются списком управления доступом.
>    - Неправильная конфигурация пути мониторинга в профиле диспетчера трафика.

>В результате такого поведения, даже если проверки работоспособности диспетчера трафика настроены неправильно, с точки зрения маршрутизации трафика может показаться, что диспетчер трафика *работает правильно*. Кроме того, в этом случае при сбое конечной точки не происходит отработка отказа, что негативно влияет на общую доступность приложения. Поэтому важно убедиться, что профиль находится в сети, а не в состоянии пониженной функциональности. Состояние "В сети" указывает на то, что проверки работоспособности диспетчера трафика выполняются надлежащим образом.

Дополнительную информацию об устранении неполадок, вызвавших сбой при проверке работоспособности, см. в разделе [Устранение неполадок с состоянием пониженной функциональности в диспетчере трафика Azure](traffic-manager-troubleshooting-degraded.md).

## <a name="faq"></a>Часто задаваемые вопросы

### <a name="is-traffic-manager-resilient-to-azure-region-failures?"></a>Устойчив ли диспетчер трафика к сбоям в регионе Azure?

Диспетчер трафика является ключевым компонентом, обеспечивающим высокую доступность приложений в Azure.
Для обеспечения высокого уровня доступности диспетчер трафика должен иметь исключительно высокий уровень доступности и быть устойчивым к сбоям регионов.

По умолчанию компоненты диспетчера трафика отказоустойчивы к полному сбою любого региона Azure. Эта устойчивость применяется ко всем компонентам диспетчера трафика: DNS-серверам, API-интерфейсам, уровню хранилища и службе мониторинга конечных точек.

В маловероятном случае сбоя всего региона Azure диспетчер трафика должен продолжить нормальную работу. Приложения, развернутые в нескольких регионах Azure, могут положиться на диспетчер трафика, который перенаправит трафик к доступному экземпляру приложения.

### <a name="how-does-the-choice-of-resource-group-location-affect-traffic-manager?"></a>Каким образом выбор расположения группы ресурсов влияет на диспетчер трафика?

Диспетчер трафика — это единая глобальная служба. Она не является региональной. Выбор расположения группы ресурсов никак не влияет на профили диспетчера трафика, развернутые в этой группе ресурсов.

Для Azure Resource Manager требуется, чтобы все группы ресурсов указывали расположение, которое определяет расположение по умолчанию для ресурсов, развернутых в этой группе ресурсов. При создании профиля диспетчера трафика он создается в группе ресурсов. Во всех профилях диспетчера трафика в качестве расположения задано значение **Глобальный** (тем самым переопределяется группа ресурсов по умолчанию).

### <a name="how-do-i-determine-the-current-health-of-each-endpoint?"></a>Как определить текущую работоспособность каждой конечной точки?

На портале управления Azure отображается текущее состояние мониторинга для каждой конечной точки, а также всего профиля. Эти сведения также можно получить с помощью [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx) отслеживания трафика, [командлетов PowerShell](https://msdn.microsoft.com/library/mt125941.aspx) и [кроссплатформенного интерфейса командной строки Azure](../xplat-cli-install.md).

Azure не предоставляет информации о работоспособности конечной точки в прошлом и не позволяет выдавать предупреждения об изменении состояния конечной точки.

### <a name="can-i-monitor-https-endpoints?"></a>Можно ли отслеживать конечные точки HTTPS?

Да. Диспетчер трафика поддерживает проверку по протоколу HTTPS. Настройте **HTTPS** в качестве протокола в конфигурации мониторинга.

Диспетчер трафика не может предоставить проверку сертификатов. В частности:

- сертификаты на стороне сервера не проверяются;
- сертификаты SNI на стороне сервера не поддерживаются;
- клиентские сертификаты не поддерживаются.

### <a name="what-host-header-do-endpoint-health-checks-use?"></a>Какой заголовок узла используется для проверки работоспособности конечной точки?

Для проверки работоспособности HTTP и HTTPS диспетчер трафика использует заголовки узлов. Заголовок узла, используемый диспетчером трафика, представляет собой имя целевой конечной точки, настроенной в профиле. Значение, используемое в заголовке узла, нельзя использовать отдельно от свойства цели.

### <a name="what-are-the-ip-addresses-from-which-the-health-checks-originate?"></a>Что такое IP-адресов, используемые при проверке работоспособности?

Следующий список содержит IP-адреса, с которых диспетчер трафика может запускать проверку работоспособности. Этот список позволяет узнать, разрешены ли входящие подключения от этих адресов на конечных точках для проверки состояния их работоспособности.

- 13.75.153.124
- 13.75.152.253
- 191.232.214.62
- 191.232.208.52
- 52.172.155.168
- 52.172.158.37
- 13.75.124.254
- 13.75.127.63
- 137.135.82.249
- 137.135.80.149
- 104.41.190.203
- 104.41.187.209
- 65.52.217.19
- 23.96.236.252
- 40.87.147.10
- 40.87.151.34
- 104.215.91.84
- 13.84.222.37
- 40.68.30.66
- 40.68.31.178
- 137.135.47.215
- 137.135.46.163

## <a name="next-steps"></a>Дальнейшие действия

Узнайте о том, [как работает диспетчер трафика](traffic-manager-how-traffic-manager-works.md)

Узнайте больше о [методах маршрутизации трафика](traffic-manager-routing-methods.md) , поддерживаемых в диспетчере трафика.

Узнайте, как [создать профиль диспетчера трафика](traffic-manager-manage-profiles.md)

[устранении неполадок с состоянием пониженной функциональности](traffic-manager-troubleshooting-degraded.md) конечной точки диспетчера трафика.



<!--HONumber=Oct16_HO2-->


