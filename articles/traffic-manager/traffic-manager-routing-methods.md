<properties 
   pageTitle="Диспетчер трафика — маршрутизация трафика | Microsoft Azure"
   description="Эта статья поможет вам разобраться в различных методах маршрутизации трафика, используемых диспетчером трафика."
   services="traffic-manager"
   documentationCenter=""
   authors="sdwheeler"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/25/2016"
   ms.author="sewhee" />

# Методы маршрутизации трафика диспетчером трафика

На этой странице описываются методы маршрутизации трафика, поддерживаемые диспетчером трафика Azure. Они используются для направления пользователей к правильной конечной точке службы.

> [AZURE.NOTE] В API Azure Resource Manager (ARM) для диспетчера трафика и API управления службами Azure (ASM) используется разная терминология. Это изменение было внесено после отзыва клиента для повышения наглядности и уменьшения распространенных недоразумений. На этой странице мы будем использовать терминологию ARM. Различия описаны ниже.

>- В ARM используется термин "метод маршрутизации трафика" для описания алгоритма определения конечной точки, к которой должен быть направлен пользователь в конкретный момент времени. В ASM это называется методом балансировки нагрузки.

>- В ARM используется термин "со взвешиванием", относящийся к методу маршрутизации трафика, который распределяет трафик по всем доступным конечным точкам согласно весу, определенному для каждой из них. В ASM это называется циклическим перебором.
>- В ARM используется термин "по приоритету", относящийся к методу маршрутизации трафика, который направляет весь трафик в первую доступную конечную точку из упорядоченного списка. В ASM это называется отработкой отказа.

> Во всех случаях единственное отличие заключается в названии. Нет никакой разницы в функциональности.


Диспетчер трафика Azure поддерживает множество алгоритмов маршрутизации пользователей к различным конечным точкам службы. Они называются методами маршрутизации трафика. Метод маршрутизации трафика применяется к каждому полученному запросу DNS, чтобы определить, какую конечную точку нужно вернуть в ответе DNS.

В диспетчере трафика доступно три метода маршрутизации трафика.

- **По приоритету**. Выберите метод "По приоритету", если требуется использовать первичную конечную точку службы для всего трафика и предоставить резервные конечные точки на случай, если первичная или какие-либо резервные конечные точки станут недоступны. Дополнительные сведения см. в разделе [Метод маршрутизации трафика по приоритету](#priority-traffic-routing-method).

- **Со взвешиванием**. Выберите метод "Со взвешиванием", если требуется распределить трафик между несколькими конечными точками равномерно либо согласно определяемым вами весовым коэффициентам. Дополнительные сведения см. в разделе [Метод маршрутизации трафика со взвешиванием](#weighted-traffic-routing-method).

- **Производительность**. Выберите метод "Производительность", если конечные точки размещены в разных географических расположениях и нужно, чтобы клиенты использовали "ближайшие" с точки зрения минимальных задержек сети конечные точки. Дополнительные сведения см. в разделе [Метод маршрутизации трафика для повышения производительности](#performance-traffic-routing-method).

> [AZURE.NOTE] Все профили диспетчера трафика включают в себя постоянный мониторинг работоспособности конечных точек и их автоматическую отработку отказа. Эти функции поддерживаются для всех методов маршрутизации трафика. Дополнительные сведения см. в разделе [О мониторинге диспетчера трафика](traffic-manager-monitoring.md).

Отдельный профиль диспетчера трафика может использовать только один метод маршрутизации трафика. В любое время для профиля можно выбрать другой метод маршрутизации трафика. Изменения применяются в течение минуты, не приводя к простою. Методы маршрутизации трафика можно комбинировать с помощью вложенных профилей диспетчера трафика. Это позволяет создавать сложные и гибкие конфигурации маршрутизации трафика в соответствии с потребностями более крупных и сложных приложений. Дополнительную информацию см. в разделе [Вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).

## Метод маршрутизации трафика по приоритету

Нередко организация стремится обеспечить надежность своих служб, предоставляя для этого одну или нескольких резервных служб на случай, если основная служба выйдет из строя. Метод маршрутизации трафика "По приоритету" позволяет клиентам Azure легко реализовать эту схему отработки отказа.

![Диспетчер трафика Azure: метод маршрутизации трафика по приоритету][1]

В профиле диспетчера трафика настроен упорядоченный список конечных точек службы. По умолчанию весь трафик пользователей отправляется в первичную конечную точку (с наивысшим приоритетом). Если первичная конечная точка становится недоступна (согласно настроенному состоянию "Включено" или "Отключено" и текущим данным мониторинга конечных точек), то пользователи направляются ко вторичной конечной точке. Если и первичная, и вторичная конечные точки становятся недоступны, трафик направляется к третьей и т. д.

Настройка приоритетов конечных точек выполняется по-разному в интерфейсах API ARM (и на новом портале Azure) и интерфейсах API ASM (и на классическом портале).

- В интерфейсах API ARM приоритет конечной точки настраивается явно, с помощью свойства priority, определяемого для каждой конечной точки. Это свойство должно иметь значение от 1 до 1000, и чем ниже значение, тем выше приоритет. У двух конечных точек не может быть одинаковый приоритет. Данное свойство является необязательным. Если оно не указано, для конечной точки задается приоритет по умолчанию в соответствии с ее расположением в профиле.

- В интерфейсах API ASM приоритет конечной точки настраивается не явно, а на основе порядка, в котором перечислены конечные точки в определении профиля. Кроме того, вы можете настроить порядок отработки отказа на классическом портале Azure, на странице "Конфигурация" профиля.

## Метод маршрутизации трафика со взвешиванием

Распространенный подход к обеспечению высокого уровня доступности и максимального использования службы — предоставить набор конечных точек и распределять трафик по всем конечным точкам равномерно или согласно предварительно определенным весовым коэффициентам. Это обеспечивает метод маршрутизации трафика "Со взвешиванием".

![Диспетчер трафика Azure: метод маршрутизации трафика со взвешиванием][2]

В случае использования метода маршрутизации трафика со взвешиванием при настройке профиля диспетчера трафика каждой конечной точке назначается вес. Вес — это целое число от 1 до 1000. Этот параметр является необязательным, если он не указан, по умолчанию вес равен 1.
  
Трафик пользователей распределяется по всем доступным конечным точкам службы (согласно настроенному состоянию "Включено" или "Отключено" и текущим данным мониторинга конечных точек). Для каждого полученного запроса DNS доступная конечная точка выбирается произвольно, с вероятностью, вычисляемой на основе веса, назначенного этой конечной точке и другим доступным конечным точкам.

Если указать одинаковый вес для всех конечных точек, то трафик будет распределен равномерно. Это идеально подходит для согласованного использования набора идентичных конечных точек. Если задать больший (или меньший) вес для определенных конечных точек, они будут чаще (или реже) возвращаться в ответах DNS и, таким образом, чаще (или реже) получать трафик. Это позволяет реализовать ряд полезных сценариев.

- Постепенное обновление приложения: направляйте часть трафика в новую конечную точку и постепенно доведите объем трафика до 100 %.

- Миграция приложений в Azure: создайте профиль с конечными точками Azure и внешними конечными точками и укажите вес трафика, который направляется в каждую конечную точку.

- Повышение в облако для получения дополнительной емкости: быстро расширьте локальное развертывание в облако, изменив профиль диспетчера трафика. Если вам требуется дополнительная емкость в облаке, добавьте конечные точки и укажите, какая часть трафика направляется на ту или иную конечную точку.

Маршрутизацию трафика со взвешиванием можно настроить на новом портале Azure, однако на классическом портале нельзя настроить веса. Ее можно также настроить с помощью ARM и ASM, используя Azure PowerShell, Azure CLI и интерфейсы REST API Azure.

Примечание. Ответы DNS кэшируются клиентами и рекурсивными DNS-серверами, которые используются этими клиентами для выполнения запросов DNS. Важно понимать потенциальное воздействие этого кэширования на распределение трафика со взвешиванием. Если число клиентов и рекурсивных DNS-серверов велико, как в случае типичных приложений для Интернета, распределение трафика работает ожидаемым образом. Тем не менее при небольшом числе клиентов или рекурсивных DNS-серверов данное кэширование может значительно исказить распределение трафика. Вот некоторые наиболее распространенные случаи, в которых это может происходить:

- среды для разработки и тестирования;
- обмен данных между приложениями;
- приложения, предназначенные для узкого круга пользователей, использующих общую инфраструктуру рекурсивных DNS-серверов, например сотрудников организации.

Такое воздействие кэширования DNS характерно для всех систем маршрутизации трафика на основе DNS, а не только для диспетчера трафика. В некоторых случаях может помочь явная очистка кэша DNS. В других случаях более подходящим может оказаться альтернативный метод маршрутизации трафика.

## Метод маршрутизации трафика для повышения производительности

Скорость реагирования многих приложений можно повысить, развернув конечные точки в двух или больше расположениях по всему миру и направляя пользователей к ближайшему к ним расположению. Для этого и предназначен метод маршрутизации трафика "Производительность".

![Диспетчер трафика Azure: метод маршрутизации трафика для повышения производительности][3]

Чтобы обеспечить максимальную скорость реагирования, "ближайшая" конечная точка не обязательно должна быть ближайшей с точки зрения географического расстояния. Вместо этого метод маршрутизации трафика "Производительность" определяет, какая конечная точка является ближайшей к пользователю согласно измеренной задержке сети. Она определяется таблицей задержек Интернета, в которой отражается время кругового пути между диапазонами IP-адресов и каждым центром обработки данных Azure.

Диспетчер трафика проверяет каждый входящий запрос DNS и ищет исходный IP-адрес этого запроса в таблице задержек Интернета. Так определяется задержка между этим IP-адресом и каждым центром обработки данных Azure. Затем диспетчер трафика выбирает, какая из доступных конечных точек (согласно настроенному состоянию "Включено" или "Отключено" и текущим данным мониторинга конечных точек) имеет наименьшую задержку, и возвращает эту конечную точку в ответе DNS. Таким образом пользователь направляется в конечную точку, которая обеспечивает наименьшую задержку и, следовательно, максимальную производительность.

Как описано в разделе [Как работает диспетчер трафика](traffic-manager-how-traffic-manager-works.md), диспетчер трафика не получает запросы DNS от пользователей напрямую. Вместо этого он получает их от рекурсивной службы DNS, использование которой настроено для них. Таким образом IP-адрес, используемый для определения "ближайшей" конечной точки, это не IP-адрес пользователя, а IP-адрес рекурсивной службы DNS. На практике для этой цели данный IP-адрес является хорошим прокси-сервером для пользователя.

Чтобы учесть изменения в глобальной сети Интернет и добавление новых регионов Azure, диспетчер трафика регулярно обновляет таблицу задержек Интернета, которую он использует. Однако так нельзя в режиме реального времени учесть изменения производительности или загрузки в Интернете.

При маршрутизации трафика для повышения производительности не учитывается нагрузка на определенную конечную точку службы, хотя диспетчер трафика отслеживает конечные точки и не будет включать их в ответы на запросы DNS, если они недоступны.

Примечания:

- Если профиль содержит несколько конечных точек, расположенных в одном регионе Azure, то трафик, направленный в этот регион, распределяется равномерно между доступными конечными точками (согласно настроенному состоянию "Включено" или "Отключено" и текущим данным мониторинга конечных точек). Если требуется иначе распределять трафик в регионе, это можно сделать с помощью [вложенных профилей диспетчера трафика](traffic-manager-nested-profiles.md).

- Если функциональность всех включенных конечных точек в заданном регионе Azure понизится (согласно текущим данным мониторинга конечных точек), то трафик этих конечных точек будет распределяться по всем прочим доступным конечным точкам, которые указаны в профиле, а не только по соседним или ближайшим конечным точкам. Это помогает избежать каскадных сбоев, которые потенциально могут возникнуть при перегрузке ближайшей конечной точки. Если вы предпочитаете определить последовательность отработки отказа конечных точек, это можно сделать с помощью [вложенных профилей диспетчера трафика](traffic-manager-nested-profiles.md).

- При использовании метода маршрутизации трафика для повышения производительности с внешними или вложенными конечными точками потребуется указать их расположение. Выберите ближайший к вашему развертыванию регион Azure. Выбрать можно из регионов Azure, так как это расположения, совместимые с таблицы задержек Интернета.

- Алгоритм, по которому выбирается конечная точка, возвращаемая заданному пользователю, является детерминированным, то есть исключающим случайность. Повторные запросы DNS от одного клиента будут направляться к той же конечной точке. Однако не следует рассчитывать, что метод маршрутизации трафика для повышения производительности всегда будет направлять определенного пользователя в конкретное развертывание (что может потребоваться, например, если данные этого пользователя хранятся только в одном расположении). Причина этого в том, что когда пользователи находятся в пути, они обычно используют другие рекурсивные DNS-серверы, и поэтому могут быть перенаправлены к другой конечной точке. Кроме того, на выбор конечных точек могут влиять обновления таблицы задержек Интернета.

- После обновления таблицы задержек Интернета вы можете заметить, что некоторые клиенты стали направляться к другой конечной точке. Число затронутых пользователей должно быть минимальным. Это пользователи, маршрутизация для которых была уточнена согласно текущим данным задержек. Данные обновления необходимы, чтобы обеспечить точность маршрутизации трафика для повышения производительности, так как Интернет постоянно развивается.


## Дальнейшие действия

Узнайте, как разрабатывать высокодоступные приложения с помощью [мониторинга конечных точек диспетчером трафика](traffic-manager-monitoring.md).

Узнайте, как [создать профиль диспетчера трафика](traffic-manager-manage-profiles.md).


<!--Image references-->
[1]: ./media/traffic-manager-routing-methods/priority.png
[2]: ./media/traffic-manager-routing-methods/weighted.png
[3]: ./media/traffic-manager-routing-methods/performance.png

<!---HONumber=AcomDC_0824_2016-->