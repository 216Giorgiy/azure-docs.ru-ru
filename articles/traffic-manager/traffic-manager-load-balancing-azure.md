---
title: "Использование служб для балансировки нагрузки в облаке Azure | Документация Microsoft"
description: "В этом руководстве показано, как создать сценарий с использованием таких решений Azure для балансировки нагрузки, как диспетчер трафика, шлюз приложений и подсистема балансировки нагрузки."
services: traffic-manager
documentationcenter: 
author: liumichelle
manager: vitinnan
editor: 
ms.assetid: f89be3be-a16f-4d47-bcae-db2ab72ade17
ms.service: traffic-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 10/27/2016
ms.author: limichel
translationtype: Human Translation
ms.sourcegitcommit: 5919c477502767a32c535ace4ae4e9dffae4f44b
ms.openlocfilehash: 90918f6bb23f0f4e3c009506e1b12c028c45f02b

---

# <a name="using-load-balancing-services-in-the-azure-cloud"></a>Использование служб для балансировки нагрузки в облаке Azure

## <a name="introduction"></a>Введение

Microsoft Azure включает несколько служб, управляющих распределением сетевого трафика и балансировкой нагрузки. Вы можете использовать эти службы по отдельности или объединять с учетом требований к создаваемому решению.

В этом руководстве на примере клиентской системы мы узнаем, как можно повысить надежность и производительность решений с помощью таких систем Azure для балансировки нагрузки, как диспетчер трафика, шлюз приложений и подсистема балансировки нагрузки. Затем мы выполним пошаговые инструкции по созданию развертывания с географической избыточностью, распределением трафика между виртуальными машинами и дополнительными возможностями по управлению запросами разных типов.

На уровне решения каждая из этих служб занимает определенное место в иерархии системы балансировки нагрузки.

1. **Диспетчер трафика** выполняет глобальную балансировку нагрузки на уровне DNS.  Он изучает входящие запросы DNS и возвращает адрес работоспособной конечной точки в соответствии с политикой маршрутизации, выбранной клиентом. Используются следующие методы маршрутизации: маршрутизация для повышения производительности, которая направляет пользователя к ближайшей (с минимальной задержкой) конечной точке; маршрутизация по приоритетам, которая направляет весь трафик к одной конечной точке, тогда как остальные выполняют роль резервных конечных точек; и маршрутизация со взвешенным циклическим перебором, которая распределяет трафик в соответствии с весовыми коэффициентами, присвоенными каждой конечной точке. Клиент подключается напрямую к указанной конечной точке. Если конечная точка неработоспособна, диспетчер трафика Azure обнаружит это и перенаправит клиентов на другой (работающий) экземпляр. Подробнее эта служба описана в статье [Что такое диспетчер трафика](traffic-manager-overview.md).
2. **Шлюз приложений** предоставляет контроллер доставки приложений (ADC) как услугу, предлагая для приложения разные функции балансировки нагрузки уровня 7. Таким образом, пользователи могут оптимизировать производительность веб-фермы за счет выполнения операции завершения SSL-запросов, требующей интенсивного использования ЦП, на шлюзе приложений. Кроме того, пользователи получают другие возможности маршрутизации уровня 7, включая циклическое распределение входящего трафика, соответствие сеансу на основе файлов cookie, маршрутизацию на основе URL-путей и возможность размещения нескольких веб-сайтов за одним шлюзом приложений. Шлюз приложений можно настроить как шлюз с выходом в Интернет, внутренний шлюз или их сочетание. Шлюз приложений полностью управляем Azure, масштабируем и обладает высоким уровнем доступности. Для более эффективного управления предоставляется широкий набор возможностей ведения журнала и диагностики.
3. **Подсистема балансировки нагрузки** — это неотъемлемая часть стека Azure SDN. Подсистема балансировки нагрузки обеспечивает высокую производительность и балансировку нагрузки уровня 4 с низкой задержкой для всех протоколов UDP и TCP.  Она управляет и входящими, и исходящими подключениями.  Вы можете настроить открытые и внутренние конечные точки с балансировкой нагрузки, а также определить правила для сопоставления входящих подключений к узлам серверной части. Для управления доступностью служб используется проверка состояния по TCP и HTTP.

## <a name="scenario"></a>Сценарий

В этом примере мы используем простой веб-сайт, который предоставляет содержимое двух типов: изображения и динамически отображаемые веб-страницы. Этот веб-сайт должен быть географически избыточным. Он будет обслуживать пользователей из ближайших расположений (с наименьшей задержкой). Разработчик приложения решил, что все URL-адреса, которые соответствуют шаблону /images/*, должны обслуживаться выделенным пулом виртуальных машин, отделенных от остальной части веб-фермы.

Кроме того, пул виртуальных машин по умолчанию, который предоставляет динамически генерируемый контент, должен взаимодействовать с серверной базой данных, размещенной в высокодоступном кластере. Все это развертывание подготовлено с использованием Azure Resource Manager.

Использование диспетчера трафика, шлюза приложений и подсистемы балансировки нагрузки позволит реализовать для этого веб-сайта следующие проектные задачи.

1. **Высокая геоизбыточность**. Когда один регион выходит из строя, диспетчер трафика незамедлительно перенаправляет трафик в следующий ближайший регион без каких-либо действий со стороны владельца приложения.
2. **Снижение задержки**. Так как пользователь автоматически направляется диспетчером трафика в ближайший регион, гарантируется низкая задержка при запросе содержимого веб-страницы.
3. **Независимое масштабирование**. Разделив рабочие нагрузки приложения по типам содержимого, владелец приложения может масштабировать эти рабочие нагрузки независимо друг от друга. Шлюз приложений гарантирует, что трафик будет направлен в правильный пул в соответствии с установленными правилами и с учетом состояния работоспособности приложения.
4. **Внутренняя подсистема балансировки нагрузки**. Если разместить подсистему балансировки нагрузки перед высокодоступным кластером, приложение гарантированно будет обращаться только к работоспособным и активным конечным точкам базы данных.  Кроме того, администратор базы данных может оптимизировать рабочую нагрузку, размещая в кластере активные и пассивные реплики независимо от приложения переднего плана.  Подсистема балансировки нагрузки обеспечивает подключение к высокодоступному кластеру, гарантируя, что запросы на подключение будут получать только работоспособные базы данных.

На следующей схеме показана архитектура этой системы.

![Изображение схемы сценария](./media/traffic-manager-load-balancing-azure/scenario-diagram.png)

> [!NOTE]
> Этот пример демонстрирует лишь одну из многих возможных конфигураций, которые можно реализовать с использованием служб Azure для балансировки нагрузки. Диспетчер трафика, шлюз приложений и подсистему балансировки нагрузки можно использовать совместно в зависимости от ваших потребностей. Например, если вам не требуется разгрузка SSL или обработка уровня 7, вместо шлюза приложений можно применить подсистему балансировки нагрузки.

## <a name="setting-up-the-load-balancing-stack"></a>Настройка стека балансировки нагрузки

### <a name="step-1-create-a-traffic-manager-profile"></a>Шаг 1. Создание профиля диспетчера трафика

1. Перейдите на портал Azure, щелкните **Создать** и выполните в Marketplace поиск по запросу "профиль диспетчера трафика".
2. В колонке "Создание профиля диспетчера трафика" укажите основные сведения для профиля диспетчера трафика.

   * **Имя** — присвойте профилю диспетчера трафика уникальное имя префикса DNS.
   * [Метод маршрутизации](traffic-manager-routing-methods.md) — выберите подходящую политику маршрутизации. Дополнительные сведения об этих методах см. в статье **Методы маршрутизации трафика диспетчером трафика**.
   * **Подписка** — подписка, в которой хранится профиль.
   * **Группа ресурсов** — группа ресурсов, в которой будет сохранен профиль диспетчера трафика. Это может быть существующая или новая группа ресурсов.
   * **Расположение группы ресурсов** — служба диспетчера трафика является глобальной. Она не привязана к конкретному расположению. Но вам необходимо указать регион для группы, в которой будут храниться метаданные, связанные с профилем диспетчера трафика. Это расположение никак не влияет на доступность профиля.

3. Щелкните **Создать**, чтобы создать профиль диспетчера трафика.

    ![Колонка создания диспетчера трафика](./media/traffic-manager-load-balancing-azure/s1-create-tm-blade.png)

### <a name="step-2-create-the-application-gateways"></a>Шаг 2. Создание шлюзов приложений

1. Перейдите на портал Azure и выберите в меню слева пункты **Создать** > **Сети** > **Шлюз приложений**.
2. Далее введите основные сведения о шлюзе приложений. По завершении нажмите кнопку "ОК". Ниже приведены сведения, которые необходимо указать для основных параметров.

   * **Имя**. Имя подсети шлюза приложений.
   * **Размер SKU**. Этот параметр указывает размер шлюза приложений. Доступные значения: "Мелкий", "Средний" и "Крупный".
   * **Число экземпляров**. Число экземпляров от 2 до 10.
   * **Группа ресурсов**. Группа ресурсов для хранения шлюза приложений. Это может быть существующая или новая группа ресурсов.
   * **Расположение**. Регион для шлюза приложений. В нем же располагается группа ресурсов. Это расположение важно, так как виртуальная сеть и общедоступный IP-адрес должны быть в том же расположении, что и шлюз.

3. Теперь определите виртуальную сеть, подсеть, IP-адрес внешнего интерфейса и конфигурацию прослушивателя для шлюза приложений. В этом сценарии используется **открытый** IP-адрес внешнего интерфейса, который можно позже добавить в качестве конечной точки в профиле диспетчера трафика.
4. Далее следует конфигурация прослушивателя для шлюза приложений. Если используется протокол HTTP, дополнительные настройки не нужны. Можно нажать кнопку **ОК**. Для использования HTTPS нужно выполнить настройку, как описано в статье [Создание шлюза приложений](../application-gateway/application-gateway-create-gateway-portal.md), начиная с шага 9.

#### <a name="configure-url-routing-for-application-gateways"></a>Настройка маршрутизации URL-адресов для шлюзов приложений

Шлюз приложений, для которого настроено правило на основе пути, при выборе пула серверной части использует не только циклический перебор, но и формат URL-адреса в конкретном запросе. В нашем случае мы добавим правило на основе пути, которое будет направлять в пул серверов изображений все запросы на URL-адреса, содержащие строку /images/\*. Дополнительные сведения о настройке маршрутизации на основе URL-пути для шлюза приложений см. в статье [Create a Path-based rule for an application gateway by using the portal](../application-gateway/application-gateway-create-url-route-portal.md) (Создание правила на основе пути для шлюза приложений).

![Схема веб-уровня](./media/traffic-manager-load-balancing-azure/web-tier-diagram.png)

1. Перейдите к группе ресурсов и найдите экземпляр шлюза приложений, созданный на предыдущих шагах.
2. В списке параметров выберите **Серверные пулы**, затем нажмите "Добавить", чтобы добавить виртуальные машины, которые нужно связать с серверными пулами веб-уровня.
3. В колонке "Добавление серверного пула" введите имя пула и IP-адреса виртуальных машин, включенных в этот пул. В нашем примере мы подключаем два серверных пула виртуальных машин.

    ![Добавление серверного пула для шлюза приложений](./media/traffic-manager-load-balancing-azure/s2-appgw-add-bepool.png)

4. Далее в разделе "Параметры" для шлюза приложений выберите **Правила** и нажмите кнопку **На основе пути**, чтобы добавить новое правило.

    ![Добавление правила на основе пути для шлюза приложений](./media/traffic-manager-load-balancing-azure/s2-appgw-add-pathrule.png)

5. В колонке "Добавление правила на основе пути" укажите следующие сведения для настройки правила.

   * Основные параметры.
     + **Имя** — понятное имя правила, которое будет отображаться на портале.
     + **Прослушиватель** — прослушиватель для этого правила.
     + **Серверный пул по умолчанию** — серверный пул, который будет использоваться для правила по умолчанию.
     + **Параметры HTTP по умолчанию** — параметры HTTP, которые будут использоваться для правила по умолчанию.
   * Правила на основе пути.
     + **Имя** — понятное имя правила на основе пути.
     + **Пути** — правила на основе пути для направления трафика.
     + **Серверный пул** — серверный пул, который будет использоваться с этим правилом.
     + **Параметры HTTP** — параметры HTTP, которые будут использоваться для этого правила.

     > [!IMPORTANT]
     > Пути: допустимые пути должны начинаться с символа /. Использование подстановочного знака \* допускается только в конце. Примеры допустимых значений: /xyz, /xyz\* или /xyz/\*.

     ![Колонка добавления правила на основе пути для шлюза приложений](./media/traffic-manager-load-balancing-azure/s2-appgw-pathrule-blade.png)

### <a name="step-3-add-application-gateways-to-the-traffic-manager-endpoints"></a>Шаг 3. Добавление шлюзов приложений для конечных точек диспетчера трафика

В нашем примере диспетчер трафика подключается к экземплярам шлюза приложений (которые мы настроили на предыдущих шагах), которые расположены в разных регионах. Теперь, когда шлюзы приложений настроены, настало время подключить их к профилю диспетчера трафика.

1. Перейдите к экземпляру профиля диспетчера трафика (например, через группу ресурсов или выполнив поиск по имени профиля диспетчера трафика в разделе "Все ресурсы").
2. В открывшейся колонке выберите **Конечные точки**, затем **Добавить**, чтобы добавить новую конечную точку.

    ![Добавление конечной точки диспетчера трафика](./media/traffic-manager-load-balancing-azure/s3-tm-add-endpoint.png)

3. В колонке "Добавление конечной точки" укажите сведения, чтобы создать конечную точку.

   * **Тип** — это тип конечной точки, для которой выполняется балансировка нагрузки. Мы подключаемся к настроенным выше экземплярам шлюза приложений, поэтому используем конечную точку Azure.
   * **Имя** — имя этой конечной точки.
   * **Целевой тип ресурса** — выберите здесь общедоступный IP-адрес, а для параметра "Целевой ресурс" ниже выберите настроенный выше общедоступный IP-адрес шлюза приложений.

     ![Добавление конечной точки диспетчера трафика](./media/traffic-manager-load-balancing-azure/s3-tm-add-endpoint-blade.png)

4. Теперь вы можете проверить конфигурацию системы, обратившись к ней по имени DNS, указанному для профиля диспетчера трафика (в нашем примере это — TrafficManagerScenario.trafficmanager.net). При проверке вы можете повторно отправлять запросы, включать и отключать виртуальные машины и веб-серверы, созданные в разных регионах, а также изменять параметры профиля диспетчера трафика.

### <a name="step-4-create-the-load-balancer"></a>Шаг 4. Создание подсистемы балансировки нагрузки

В нашем примере подсистема балансировки нагрузки распределяет подключения, направляемые от веб-уровня к базам данных, размещенным в высокодоступном кластере.

Если высокодоступный кластер базы данных использует SQL AlwaysOn, настройте один или несколько [прослушивателей группы доступности Always On](../virtual-machines/virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

Дополнительные сведения о настройке внутреннего балансировщика нагрузки см. в статье [Создание подсистемы балансировки нагрузки на портале Azure](../load-balancer/load-balancer-get-started-ilb-arm-portal.md).

1. Перейдите на портал Azure и выберите в меню слева пункты **Создать** > **Сети** > **Подсистема балансировки нагрузки**.
2. В колонке "Создание подсистемы балансировки нагрузки" введите имя для балансировщика нагрузки.
3. Для параметра **Тип** укажите значение "Внутренний" и выберите виртуальную сеть и подсеть, в которой будет размещена подсистема балансировки нагрузки.
4. В разделе **Назначение IP-адресов** выберите вариант "Динамическое" или "Статическое".
5. Далее в разделе **Группа ресурсов** выберите группу ресурсов для подсистемы балансировки нагрузки.
6. В разделе **Расположение** выберите подходящий регион для подсистемы балансировки нагрузки.
7. Затем, нажмите кнопку **Создать**, чтобы создать подсистему балансировки нагрузки.

#### <a name="connect-backend-database-tier-to-load-balancer"></a>Подключение уровня серверов базы данных к подсистеме балансировки нагрузки

1. В группе ресурсов найдите подсистему балансировки нагрузки, созданную на предыдущих шагах.
2. В разделе "Параметры" щелкните **Серверные пулы** и **Добавить**, чтобы добавить новый серверный пул.
3. В колонке "Добавление серверного пула" введите имя пула.
4. Здесь можно добавить в серверный пул отдельные виртуальные машины или группу доступности.

   ![Добавление в пул подсистемы балансировки нагрузки](./media/traffic-manager-load-balancing-azure/s4-ilb-add-bepool.png)

#### <a name="configure-a-probe"></a>Настройка проверки

1. В параметрах подсистемы балансировки нагрузки щелкните **Пробы**, а затем нажмите кнопку **Добавить**, чтобы добавить новую проверку.
2. В колонке "Добавление пробы" введите **имя** для проверки.
3. Выберите **протокол** для проверки. Для базы данных вам больше подойдет проверка TCP, чем HTTP.   Дополнительные сведения о проверках для подсистемы балансировки нагрузки см. в [этой статье](../load-balancer/load-balancer-custom-probe-overview.md).
4. Затем укажите **порт** базы данных, который следует использовать для проверки.
5. В разделе **Интервал** укажите частоту проверки приложения.
6. В разделе **Порог состояния неработоспособности** укажите число последовательных сбоев проверки, после которого виртуальная машина серверного пула будет считаться неработоспособной.
7. Нажмите кнопку **ОК**, чтобы создать проверку.

   ![Проверка подсистемы балансировки нагрузки](./media/traffic-manager-load-balancing-azure/s4-ilb-add-probe.png)

#### <a name="configure-load-balancing-rules"></a>Настройка правил балансировки нагрузки

1. В параметрах подсистемы балансировки нагрузки выберите **Правила балансировки нагрузки** и нажмите **Добавить**, чтобы создать правило.
2. В колонке "Добавление правила балансировки нагрузки" введите **имя** для нового правила.
3. Укажите **внешний IP-адрес подсистемы балансировки нагрузки**, а затем — **протокол** и **порт**
4. В разделе **Внутренний порт** укажите порт, который будет использоваться в серверном пуле.
5. Выберите **серверный пул** и **пробу**, которые вы создали на предыдущих шагах и к которым будет применяться правило.
6. В разделе **Сохранение сеанса** выберите способ сохранения сеансов.
7. В разделе **Время ожидания простоя** укажите время ожидания (в минутах) до перехода в режим простоя.
8. Выберите для параметра **Плавающий IP-адрес** значение "Включен" или "Отключен".
9. Нажмите кнопку **ОК**, чтобы создать правило.

### <a name="step-5-connect-web-tier-vms-to-load-balancer"></a>Шаг 5. Подключение виртуальных машин веб-уровня к подсистеме балансировки нагрузки

Теперь мы настроим IP-адрес и внешний порт подсистемы балансировки нагрузки в приложениях, которые работают на виртуальных машинах веб-уровня и будут подключаться к базам данных. Процесс настройки будет разным в зависимости от конкретного используемого приложения. Чтобы настроить IP-адрес назначения и порт, изучите документацию к приложению. Чтобы узнать IP-адрес внешнего интерфейса, перейдите в раздел "Пул внешних IP-адресов" в колонке параметров подсистемы балансировки нагрузки на портале Azure.

![Пул внешних IP-адресов подсистемы балансировки нагрузки](./media/traffic-manager-load-balancing-azure/s5-ilb-frontend-ippool.png)

## <a name="next-steps"></a>Дальнейшие действия

* [Обзор диспетчера трафика](traffic-manager-overview.md)
* [Обзор шлюза приложений](../application-gateway/application-gateway-introduction.md)
* [Обзор Azure Load Balancer](../load-balancer/load-balancer-overview.md)



<!--HONumber=Nov16_HO3-->


