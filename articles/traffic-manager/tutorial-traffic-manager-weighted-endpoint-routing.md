---
title: Руководство. Перенаправление трафика к конечным точкам на основе весовых коэффициентов с помощью диспетчера трафика Azure
description: В этом руководстве описывается, как перенаправлять трафик к конечным точкам на основе весовых коэффициентов с помощью диспетчера трафика Azure.
services: traffic-manager
author: KumudD
Customer intent: As an IT Admin, I want to distribute traffic based on the weight assigned to a website endpoint so that I can control the user traffic to a given website.
ms.service: traffic-manager
ms.topic: tutorial
ms.date: 10/15/2018
ms.author: kumud
ms.openlocfilehash: f70f3804bb1c6f385081b56fe6139b1b680a95cf
ms.sourcegitcommit: d61faf71620a6a55dda014a665155f2a5dcd3fa2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2019
ms.locfileid: "54055019"
---
# <a name="tutorial-control-traffic-routing-with-weighted-endpoints-by-using-traffic-manager"></a>Руководство. Управление маршрутизацией трафика к конечным точкам на основе весовых коэффициентов с помощью диспетчера трафика 

В этом руководстве показано, как с помощью диспетчера трафика Azure управлять перенаправлением пользовательского трафика к конечным точкам на основе метода взвешенной маршрутизации. При использовании этого метода маршрутизации каждой конечной точке в профиле диспетчера трафика присваиваются определенные весовые коэффициенты. Пользовательский трафик перенаправляется на основе этих коэффициентов. Это целое число в диапазоне от 1 до 1000. Чем выше значение весового коэффициента, назначенного конечной точке, тем выше ее приоритет.

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание двух виртуальных машин для работы базового веб-сайта в IIS.
> * Создание двух тестовых виртуальных машин, чтобы увидеть работу диспетчера трафика в действии.
> * Настройка имени DNS для виртуальных машин, работающих под управлением IIS.
> * Создание профиля диспетчера трафика.
> * Добавление конечных точек виртуальной машины в профиль диспетчера трафика.
> * Просмотрите диспетчер трафика в действии.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования
Чтобы увидеть диспетчер трафика в действии, разверните следующее для работы с этим руководством:
- Два экземпляра базовых веб-сайтов, работающих в разных регионах Azure — восточная часть США и Западная Европа.
- Две тестовые виртуальные машины для тестирования диспетчера трафика: одну виртуальную машину в восточной части США и вторую в Западной Европе. Тестовые виртуальные машины используются, чтобы проиллюстрировать, как диспетчер трафика направляет пользовательский трафик на веб-сайт, конечной точке которого назначен более высокий весовой коэффициент.

### <a name="sign-in-to-azure"></a>Вход в Azure 

Войдите на [портале Azure](https://portal.azure.com).

### <a name="create-websites"></a>Создание веб-сайтов

В этом разделе вы создадите два экземпляра веб-сайта, которые предоставляют две конечные точки службы для профиля диспетчера трафика в двух регионах Azure. Чтобы создать два веб-сайта, выполните следующие действия:
1. Создайте две виртуальные машины для работающего базового веб-сайта: одну — в восточной части США, а другую — в Западной Европе.
2. Установите сервер IIS на каждой виртуальной машине. Обновите веб-страницу по умолчанию, отображающую имя виртуальной машины, к которой пользователь подключается при посещении веб-сайта.

#### <a name="create-vms-for-running-websites"></a>Создание виртуальных машин для работающих веб-сайтов
В этом разделе вы создадите две виртуальные машины (*myIISVMEastUS* и *myIISVMWEurope*) в регионах Azure "Восточная часть США" и "Западная Европа".

1. В верхнем левом углу окна портала Azure выберите **Создать ресурс** > **Вычисления** > **виртуальная машина Windows Server 2016**.
2. В колонке **Основные данные** введите или выберите следующие сведения. Оставьте значения по умолчанию для других параметров и выберите **Создать**.

    |Параметр|Значение|
    |---|---|
    |ИМЯ|Введите **myIISVMEastUS**.|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Группа ресурсов| Выберите **Создать**, а затем введите **myResourceGroupTM1**.|
    |Расположение| Выберите **Восточная часть США**.|
    |||
4. Выберите размер виртуальной машины в области **Выбор размера**.
5. В разделе **Параметры** выберите следующие значения и нажмите кнопку **ОК**.
    
    |Параметр|Значение|
    |---|---|
    |Виртуальная сеть| Щелкните **Виртуальная сеть**. В разделе **Создание виртуальной сети** для **имени** введите **myVNet1**. Для **подсети** введите **mySubnet**.|
    |Группа безопасности сети|Выберите **Базовый**. В раскрывающемся списке **Выберите общедоступные входящие порты** выберите **HTTP** и **RDP**. |
    |Диагностика загрузки|Выберите **Отключено**.|
    |||
6. В разделе **Создание** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины.

7. Повторите шаги 1–6 со следующими изменениями.

    |Параметр|Значение|
    |---|---|
    |Группа ресурсов | Выберите **Создать**, а затем введите **myResourceGroupTM2**.|
    |Расположение|Введите **Западная Европа**.|
    |Имя виртуальной машины | Введите **myIISVMWEurope**.|
    |Виртуальная сеть | Щелкните **Виртуальная сеть**. В разделе **Создание виртуальной сети** для **имени** введите **myVNet2**. Для **подсети** введите **mySubnet**.|
    |||
8. Создание виртуальных машин может занять несколько минут. Прежде чем выполнять другие шаги, обязательно дождитесь создания обеих виртуальных машин.

![Создание виртуальной машины](./media/tutorial-traffic-manager-improve-website-response/createVM.png)

#### <a name="install-iis-and-customize-the-default-webpage"></a>Установка IIS и настройка веб-страницы по умолчанию

В этом разделе вы установите сервер IIS на две виртуальные машины — &mdash;myIISVMEastUS и myIISVMWEurope&mdash;, а затем обновите веб-страницу по умолчанию. На настроенной веб-странице отображается имя виртуальной машины, к которой вы подключаетесь при посещении веб-сайта в веб-браузере.

1. Выберите **Все ресурсы** в меню слева. В списке ресурсов выберите **myIISVMEastUS** в группе ресурсов **myResourceGroupTM1**.
2. На странице **Обзор** выберите **Подключиться**. В разделе **Подключение к виртуальной машине** выберите **Скачать RDP-файл**. 
3. Откройте загруженный RDP-файл. При появлении запроса выберите **Подключиться**. Введите имя пользователя и пароль, которые вы указали при создании виртуальной машины. Возможно, потребуется выбрать **More choices** (Дополнительные варианты) > **Использовать другую учетную запись**, чтобы указать учетные данные, введенные при создании виртуальной машины. 
4. Нажмите кнопку **ОК**.
5. При входе в систему может появиться предупреждение о сертификате. Если вы получили предупреждение, выберите **Да** или **Продолжить**, чтобы продолжить процесс подключения.
6. На рабочем столе сервера перейдите к **Средства администрирования Windows** > **Диспетчер сервера**.
7. Откройте Windows PowerShell на VM1. Выполните в нем приведенные ниже команды, чтобы установить сервер IIS и изменить стандартный HTM-файл.
    ```powershell-interactive
    # Install IIS
      Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # Remove default .htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    #Add custom .htm file
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
    ```

     ![Установка IIS и настройка веб-страницы](./media/tutorial-traffic-manager-improve-website-response/deployiis.png)

8. Закройте RDP-подключение к **myIISVMEastUS**.
9. Повторите шаги 1–8. Создайте RDP-подключение к виртуальной машине **myIISVMWEurope** в группе ресурсов **myResourceGroupTM2**, чтобы установить IIS и настроить веб-страницу по умолчанию.

#### <a name="configure-dns-names-for-the-vms-running-iis"></a>Настройка имен DNS для виртуальных машин, работающих под управлением IIS

Диспетчер трафика направляет трафик пользователя на основе имени DNS конечных точек службы. В этом разделе вы настроите DNS-имена для серверов IIS myIISVMEastUS и myIISVMWEurope.

1. Выберите **Все ресурсы** в меню слева. В списке ресурсов выберите **myIISVMEastUS** в группе ресурсов **myResourceGroupTM1**.
2. На странице **Обзор** в разделе **DNS-имя** выберите **Настроить**.
3. На странице **Конфигурация** в разделе метки DNS-имени добавьте уникальное имя. Затем нажмите кнопку **Save** (Сохранить).
4. Повторите шаги 1–3 для виртуальной машины с именем **myIISVMWEurope**, расположенной в группе ресурсов **myResourceGroupTM1**.

### <a name="create-a-test-vm"></a>Создание тестовой виртуальной машины

В этом разделе показано, как создать виртуальную машину *mVMEastUS*. Вы используете ее, чтобы протестировать, как диспетчер трафика направляет трафик к конечной точке веб-сайта с более высоким весовым коэффициентом.

1. В верхнем левом углу окна портала Azure выберите **Создать ресурс** > **Вычисления** > **виртуальная машина Windows Server 2016**.
2. В колонке **Основные данные** введите или выберите следующие сведения. Оставьте значения по умолчанию для других параметров и выберите **Создать**:

    |Параметр|Значение|
    |---|---|
    |ИМЯ|Введите **myVMEastUS**.|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Группа ресурсов| Щелкните **Use existing** (Использовать существующую), а затем выберите **myResourceGroupTM1**.|
    |||

4. Выберите размер виртуальной машины в области **Выбор размера**.
5. В разделе **Параметры** выберите следующие значения и нажмите кнопку **ОК**.
    |Параметр|Значение|
    |---|---|
    |Виртуальная сеть| Щелкните **Виртуальная сеть**. В разделе **Создание виртуальной сети** для **имени** введите **myVNet3**. Для подсети введите **mySubnet**.|
    |Группа безопасности сети|Выберите **Базовый**. В раскрывающемся списке **Выберите общедоступные входящие порты** выберите **HTTP** и **RDP**. |
    |Диагностика загрузки|Выберите **Отключено**.|
    |||

6. В разделе **Создание** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины.
8. Создание виртуальной машины занимает несколько минут. Прежде чем выполнять другие шаги, обязательно дождитесь создания виртуальной машины.

## <a name="create-a-traffic-manager-profile"></a>Создание профиля диспетчера трафика
Создайте профиль диспетчера трафика на основе метода **взвешенной маршрутизации**.

1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Профиль диспетчера трафика** > **Создать**.
2. В разделе **Создание профиля диспетчера трафика** введите или выберите следующие сведения. Оставьте значения по умолчанию для других параметров и выберите **Создать**.

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | ИМЯ                   | Введите уникальное имя в пределах зоны trafficmanager.net. В результате у вас будет DNS-имя trafficmanager.net, которое используется для доступа к профилю диспетчера трафика.                                   |
    | Метод маршрутизации          | Выберите метод маршрутизации **Взвешенный**.                                       |
    | Подписка            | Выберите свою подписку.                          |
    | Группа ресурсов          | Щелкните **Use existing** (Использовать существующую), а затем выберите **myResourceGroupTM1**. |
    |        |   |

    ![Создание профиля диспетчера трафика](./media/tutorial-traffic-manager-weighted-endpoint-routing/create-traffic-manager-profile.png)

## <a name="add-traffic-manager-endpoints"></a>Добавление конечных точек диспетчера трафика

Добавьте две виртуальные машины под управлением сервера IIS myIISVMEastUS и myIISVMWEurope для маршрутизации трафика пользователя к ним.

1. На панели поиска портала выполните поиск имени профиля диспетчера трафика, созданного в предыдущем разделе. Выберите профиль в отображаемых результатах.
2. В колонке **Создание профиля диспетчера трафика** в разделе **Параметры** щелкните **Конечные точки** > **Добавить**.
3. Введите или выберите следующие сведения. Оставьте значения по умолчанию для других параметров и нажмите кнопку **ОК**.

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | type                    | Введите конечную точку Azure.                                   |
    | ИМЯ           | Введите **myEastUSEndpoint**.                                        |
    | Тип целевого ресурса           | Выберите **Общедоступный IP-адрес**.                          |
    | Целевой ресурс          | Выберите общедоступный IP-адрес, чтобы показать список ресурсов с общедоступными IP-адресами в этой же подписке. В разделе **Ресурс** выберите общедоступный IP-адрес с именем **myIISVMEastUS-ip**. Это общедоступный IP-адрес виртуальной машины сервера IIS в восточной части США.|
    |  Вес      | Введите **100**.        |
    |        |           |

4. Повторите шаги 2 и 3, чтобы добавить другую конечную точку с именем **myWestEuropeEndpoint** для общедоступного IP-адреса **myIISVMWEurope-ip**. Этот адрес связан с виртуальной машиной myIISVMWEurope сервера IIS. Для параметра **Вес** введите значение **25**. 
5.  После добавления обе конечные точки отобразятся в колонке "Профиль диспетчера трафика" с состоянием **В сети**.

## <a name="test-the-traffic-manager-profile"></a>Тестирование профиля диспетчера трафика
Чтобы увидеть диспетчер трафика в действии, выполните следующие действия:
1. Определите DNS-имя профиля диспетчера трафика.
2. Просмотрите диспетчер трафика в действии.

### <a name="determine-dns-name-of-traffic-manager-profile"></a>Определение DNS-имени профиля диспетчера трафика
В этом руководстве для простоты используется DNS-имя профиля диспетчера трафика для посещения веб-сайтов. 

Вы можете определить DNS-имя профиля диспетчера трафика следующим образом:

1.  На панели поиска портала выполните поиск имени профиля диспетчера трафика, созданного в предыдущем разделе. В отображенных результатах выберите профиль диспетчера трафика.
1. Щелкните **Обзор**.
2. Профиль диспетчера трафика отображает свое DNS-имя. В рабочей среде, используя запись DNS CNAME, настройте имя личного домена, которое указывает на имя домена диспетчера трафика.

   ![DNS-имя диспетчера трафика](./media/tutorial-traffic-manager-improve-website-response/traffic-manager-dns-name.png)

### <a name="view-traffic-manager-in-action"></a>Просмотр диспетчера трафика в действии
В этом разделе вы увидите диспетчер трафика в действии. 

1. Выберите **Все ресурсы** в меню слева. В списке ресурсов выберите **myVMEastUS** в группе ресурсов **myResourceGroupTM1**.
2. На странице **Обзор** выберите **Подключиться**. В разделе **Подключение к виртуальной машине** выберите **Скачать RDP-файл**. 
3. Откройте загруженный RDP-файл. При появлении запроса выберите **Подключиться**. Введите имя пользователя и пароль, указанные вами при создании виртуальной машины. Возможно, потребуется выбрать **More choices** (Дополнительные варианты) > **Использовать другую учетную запись**, чтобы указать учетные данные, введенные при создании виртуальной машины. 
4. Нажмите кнопку **ОК**.
5. При входе в систему может появиться предупреждение о сертификате. Если вы получили предупреждение, выберите **Да** или **Продолжить**, чтобы продолжить процесс подключения. 
6. В веб-браузере на виртуальной машине myVMEastUS введите DNS-имя вашего профиля диспетчера трафика, чтобы просмотреть веб-сайт. Вы будете перенаправлены на веб-сайт, размещенный на сервере IIS myIISVMEastUS, так как ему назначен более высокий весовой коэффициент (**100**). Конечной точке сервера IIS myIISVMWEurope назначен более низкий коэффициент — **25**.

   ![Тестирование профиля диспетчера трафика](./media/tutorial-traffic-manager-improve-website-response/eastus-traffic-manager-test.png)
   
## <a name="delete-the-traffic-manager-profile"></a>Удаление профиля диспетчера трафика
Если вам больше не нужны группы ресурсов, созданные для этого руководства, вы можете удалить их. Чтобы это сделать, выберите группу ресурсов (**ResourceGroupTM1** или **ResourceGroupTM2**), а затем щелкните **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Настройка метода маршрутизации трафика по географическому расположению с помощью диспетчера трафика](traffic-manager-configure-geographic-routing-method.md)


