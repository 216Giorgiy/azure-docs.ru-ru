.<properties 
   pageTitle="Вложенные профили диспетчера трафика | Microsoft Azure"
   description="В этой статье описываются функции ";вложенных профилей"; диспетчера трафика Azure."
   services="traffic-manager"
   documentationCenter=""
   authors="sdwheeler"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/25/2016"
   ms.author="sewhee" />

# Вложенные профили диспетчера трафика

Диспетчер трафика включает в себя ряд методов маршрутизации трафика, что позволяет контролировать, каким образом он выбирает, какая конечная точка должна получить трафик от каждого из пользователей. Они описаны в разделе [Методы маршрутизации диспетчера трафика](traffic-manager-routing-methods.md), и благодаря им диспетчер трафика удовлетворяет наиболее распространенным требованиям к маршрутизации трафика.

Каждый профиль диспетчера трафика определяет один метод маршрутизации трафика. Однако бывают случаи, когда более сложным приложениям требуется менее тривиальная маршрутизация трафика, чем может обеспечить один профиль диспетчера трафика.

Для поддержки этих сложных приложений диспетчер трафика позволяет комбинировать, или *вкладывать*, профили. Так одно приложение может пользоваться преимуществами более чем одного метода маршрутизации трафика. Вложенные профили позволяют создавать более гибкие и эффективные схемы маршрутизации трафика для удовлетворения потребностей более крупных и сложных развертываний.

Кроме того, вложенные профили дают возможность переопределить поведение диспетчера трафика по умолчанию в некоторых случаях. Например, можно переопределить маршрутизацию трафика в отдельном регионе или во время отработки отказа при использовании маршрутизации трафика для повышения производительности.

Далее на этой странице на нескольких примерах поясняется, как вложенные профили диспетчера трафика могут использоваться в различных сценариях. В завершение мы рассмотрим несколько часто задаваемых вопросов о вложенных профилях.

## Пример 1. Объединение маршрутизации трафика для повышения производительности и маршрутизации трафика со взвешиванием

Предположим, что приложение развернуто в нескольких регионах Azure — в западной части США, Западной Европе и Азии. Метод маршрутизации трафика для повышения производительности используется диспетчером трафика для распределения трафика по ближайшему к пользователю региону.

![Отдельный профиль диспетчера трафика][1]

Теперь предположим, что вы хотите опробовать обновление для службы на небольшом числе пользователей, прежде чем внедрять его более масштабно. Для этого вы хотите использовать метод маршрутизации трафика со взвешиванием, который может направлять небольшой процент трафика в пробное развертывание. Используя один профиль, нельзя сочетать оба этих метода маршрутизации трафика. Это возможно благодаря вложенным профилям.

Вот как это работает. Предположим, что нужно опробовать новое развертывание в Западной Европе. Вы настраиваете пробное развертывание наряду с существующим развертыванием в рабочей среде и создаете профиль диспетчера трафика, указав только эти две конечные точки и метод маршрутизации трафика со взвешиванием. После этого вы добавляете этот "дочерний" профиль в качестве конечной точки для "родительского" профиля, который по-прежнему использует метод маршрутизации трафика для повышения производительности и содержит остальные глобальные развертывания в качестве конечных точек.

Этот пример представлен на схеме ниже.

![Вложенные профили диспетчера трафика][2]

При такой схеме трафик, направляемый через родительский профиль, будет распределяться по регионам в обычном режиме. В Западной Европе трафик будет распределяться между рабочим и пробным развертываниями в соответствии с назначенными весами.

Обратите внимание, что когда родительский профиль использует метод маршрутизации трафика для повышения производительности, должно быть известно расположение каждой конечной точки. Для вложенных конечных точек, как и для внешних конечных точек, это расположение должно быть указано в конфигурации конечной точки. Выберите ближайший к вашему развертыванию регион Azure. Выбрать можно из регионов Azure, так как это расположения, совместимые с таблицы задержек Интернета. Дополнительные сведения см. в разделе [Метод маршрутизации трафика для повышения производительности](traffic-manager-routing-methods.md#performance-traffic-routing-method).

## Пример 2. Мониторинг конечных точек во вложенных профилях

Диспетчер трафика активно отслеживает работоспособность каждой конечной точки службы. Если выявляется неработоспособная конечная точка, диспетчер трафика будет направлять пользователей на альтернативные конечные точки, сохраняя общую доступность службы. Этот режим мониторинга и отработки отказа конечных точек применяется ко всем методам маршрутизации трафика. Дополнительные сведения см. в разделе [О мониторинге диспетчера трафика](traffic-manager-monitoring.md).

Для вложенных профилей применяется несколько особых правил мониторинга конечных точек. Так как дочерний профиль настроен в родительском профиле как вложенная конечная точка, родительский профиль не проверяет работоспособность дочернего профиля напрямую. Вместо этого для вычисления общей работоспособности дочернего профиля используется работоспособность его конечных точек. Эта информация передается вверх по иерархии вложенного профиля для определения работоспособности вложенной конечной точки в родительском профиле. Так определяется, будет ли родительский профиль направлять трафик в дочерний профиль. Подробные сведения о том, как именно вычисляется работоспособность вложенной конечной точки в родительском профиле на основании работоспособности дочернего профиля, приведены [ниже](#faq).

Вернемся к примеру 1 и предположим, что происходит сбой рабочего развертывания в Западной Европе. По умолчанию дочерний профиль будет направлять весь трафик в пробное развертывание. Если оно тоже выйдет из строя, то родительский профиль определит, что так как все дочерние конечные точки неработоспособны, то дочерний профиль не должен получать трафик. Родительский профиль выполнит отработку отказа, перенаправив весь трафик Западной Европы в другие регионы.

![Отработка отказа вложенного профиля (поведение по умолчанию)][3]

Вас может устроить такая схема или же может беспокоить, что пробное развертывание не должно использоваться для отработки отказа всего трафика Западной Европы. Например, в случае выхода из строя рабочего развертывания в Западной Европе вы бы предпочли, чтобы отработка отказа выполнялась на другие регионы, *вне зависимости* от работоспособности пробного развертывания. Это тоже возможно: при настройке дочернего профиля в качестве конечной точки в родительском профиле можно указать параметр MinChildEndpoints, который определяет минимальное количество конечных точек в дочернем профиле, которые должны быть доступны. При нарушении этого порогового значения (по умолчанию равного 1) родительский профиль сочтет весь дочерний профиль недоступным и направит трафик к другим конечным точкам родительского профиля.

Ниже приведен следующий пример: MinChildEndpoints имеет значение 2, и если произойдет сбой любого из развертываний в Западной Европе, родительский профиль определит, что дочерний профиль не должен получать трафик, и пользователи будут направлены в другие регионы.

![Отработка отказа вложенного профиля при MinChildEndpoints = 2][4]

Обратите внимание, что когда дочерний профиль использует метод маршрутизации трафика по приоритету, весь трафик, направляемый в этот дочерний профиль, получает одна конечная точка. Поэтому в этом случае нет смысла задавать для MinChildEndpoints значение, отличное от 1.

## Пример 3. Расположенные по приоритетам регионы отработки отказа при маршрутизации трафика для повышения производительности

Если при использовании одного профиля с маршрутизацией трафика для повышения производительности происходит сбой конечной точки (например, в Западной Европе), то весь трафик, который направлялся бы к этой конечной точке, вместо этого распределяется по другим конечным точкам во всех регионах. Такое поведение по умолчанию метода маршрутизации трафика для повышения производительности позволяет избежать чрезмерной загрузки ближайшей соседней конечной точки, которая может привести к лавинообразной серии сбоев.

![Маршрутизация трафика для повышения производительности с отработкой отказа по умолчанию][5]

Однако предположим, что вы предпочитаете выполнить отработку отказа трафика из Западной Европы в западную часть США, допуская перенаправление в другие регионы, только если обе эти конечные точки будут недоступны. Это можно сделать, создав дочерний профиль, который использует метод маршрутизации трафика по приоритету, как показано ниже.

![Маршрутизация трафика для повышения производительности с отработкой отказа по предпочтению][6]

Так как конечная точка в Западной Европе имеет более высокий приоритет, чем конечная точка в западной части США, то пока обе они доступны в сети, весь трафик будет отправляться в конечную точку в Западной Европе. В случае сбоя конечной точки в Западной Европе ее трафик направляется в западную часть США. И только в случае сбоя конечной точки в западной части США трафик Западной Европы направлялся бы в Восточную Азию.

Эту схему можно повторить для всех регионов, заменив все три конечные точки в родительском профиле тремя дочерними профилями, каждый из которых обеспечивает последовательность отработки отказа по приоритету.

## Пример 4. Управление маршрутизацией трафика для повышения производительности между несколькими конечными точками в одном регионе

Предположим, что в профиле с несколькими конечными точками в каком-либо определенном регионе (например, западной части США) используется метод маршрутизации трафика для повышения производительности. По умолчанию трафик, направленный в этот регион, распределяется равномерно между всеми доступными конечными точками в этом регионе.

![Распределение трафика в регионе при маршрутизации трафика для повышения производительности (поведение по умолчанию)][7]

Это поведение по умолчанию можно изменить с помощью вложенных профилей диспетчера трафика. Вместо добавления нескольких конечных точек в западную часть США их можно заключить в отдельный дочерний профиль, а его — добавить в родительский как единственную конечную точку в западной части США. После этого параметры в дочернем профиле можно будет использовать для управления распределением трафика в западной части США, включив в пределах этого региона, например, маршрутизацию трафика по приоритету или со взвешиванием.

![Маршрутизация трафика для повышения производительности с пользовательским распределением трафика в регионе][8]

## Пример 5. Параметры мониторинга каждой конечной точки

Предположим, вы используете диспетчер трафика, чтобы незаметно перенести трафик с устаревшего локального веб-сайта на его новую, облачную версию, размещенную в Azure. На устаревшем веб-сайте вы хотите использовать домашнюю страницу (путь "/") для мониторинга работоспособности сайта, а в новой облачной версии вы реализуете пользовательскую страницу мониторинга с дополнительными проверками (путь "/monitor.aspx").

![Мониторинг конечных точек диспетчером трафика (поведение по умолчанию)][9]

Параметры мониторинга в обычном профиле диспетчера трафика применяются ко всем конечным точкам в этом профиле. Это означает, что ранее вам пришлось бы использовать один тот же путь на обоих сайтах. Благодаря вложенным профилям диспетчера трафика теперь можно использовать отдельный дочерний профиль для каждого из сайтов, чтобы определить для них разные параметры мониторинга.

![Мониторинг диспетчером трафика конечных точек с индивидуальными параметрами][10]

## Часто задаваемые вопросы

### Как настроить вложенные профили?

Вложенные профили диспетчера трафика можно настроить с помощью Azure Resource Manager (ARM), интерфейсов REST API управления службами Azure (ASM), командлетов PowerShell и команд кроссплатформенного Azure CLI. Они также поддерживаются на портале Azure, однако не поддерживаются на классическом портале.

### Число уровней вложенности поддерживает диспетчер трафика?
Вложенность профилей может достигать 10 уровней. Использовать "циклы" нельзя.

### Можно ли совмещать конечные точки других типов с вложенными дочерними профилями в одном профиле диспетчера трафика?

Да. Можно без каких-либо ограничений комбинировать в профиле конечные точки разных типов.

### Как модель выставления счетов применяется к вложенным профилям?

Использование вложенных профилей не приводит к повышению цен.

Выставление счетов за использование диспетчера трафика основано на двух составляющих: проверках работоспособности конечных точек и миллионах запросов DNS (полное описание см. нашей [странице цен](https://azure.microsoft.com/pricing/details/traffic-manager/)). Вот как это применяется к вложенным профилям.

- Проверки работоспособности конечных точек: плата за дочерний профиль не взимается, если он настроен как конечная точка в родительском профиле. Счета за конечные точки в дочернем профиле, наблюдающие за базовыми службами, выставляются обычным способом.

- Запросы DNS: каждый запрос учитывается только один раз. В случае запроса к родительскому профилю, который возвращает конечную точку из дочернего профиля, счет выставляется только за родительский профиль.

### Снижают ли вложенные профили производительность?

Нет, использование вложенных профилей не отражается на производительности.

Серверы имен диспетчера трафика просмотрят иерархию профиля изнутри при обработке каждого запроса DNS, поэтому запрос DNS к родительскому профилю может получить ответ DNS с конечной точкой из дочернего профиля.

То есть используется только одна запись CNAME, как и при использовании одного профиля диспетчера трафика. Цепочка записей CNAME, по одной для каждого профиля в иерархии, **не** требуется, поэтому производительность не снижается.

### Как диспетчер трафика вычисляет работоспособность вложенной конечной точки в родительском профиле, исходя из работоспособности дочернего профиля?

Так как дочерний профиль настроен в родительском профиле как вложенная конечная точка, родительский профиль не проверяет работоспособность дочернего профиля напрямую. Вместо этого для вычисления общей работоспособности дочернего профиля используется работоспособность его конечных точек. Эта информация передается вверх по иерархии вложенного профиля для определения работоспособности вложенной конечной точки в родительском профиле. Так определяется, будет ли родительский профиль направлять трафик в дочерний профиль.

В следующей таблице описано поведение проверок работоспособности диспетчера трафика для вложенной конечной точки в родительском профиле, указывающей на дочерний профиль.

|Состояние монитора дочернего профиля|Состояние монитора родительской конечной точки|Примечания|
|---|---|---|
|"Отключено". Дочерний профиль был отключен пользователем.|Остановлено|Состояние родительской конечной точки — «Остановлено», а не «Отключено». Состояние «Отключено» указывает, что вы отключили конечную точку в родительском профиле.|
|"Пониженная функциональность". Как минимум одна конечная точка дочернего профиля находится в состоянии пониженной функциональности.|"В сети": количество конечных точек в дочернем профиле, находящихся в состоянии "В сети", не меньше значения MinChildEndpoints. "Проверка конечной точки": сумма конечных точек в дочернем профиле, находящихся в состояниях "В сети" и "Проверка конечной точки", не меньше значения MinChildEndpoints. В противном случае: "Пониженная функциональность".|Трафик перенаправляется к конечной точке с состоянием "Проверка конечной точки". Если задано слишком большое значение MinChildEndpoints, функциональность конечной точки всегда будет понижена.|
|В сети. Как минимум одна конечная точка дочернего профиля находится в состоянии "В сети" и нет ни одной точки в состоянии "Пониженная функциональность".|См. выше.||
|"Проверка конечных точек". Как минимум одна точка находится в состоянии "Проверка конечной точки". Ни одна не находится в состоянии "В сети" или "Пониженная функциональность".|То же, что и выше.||
|"Неактивно". Все конечные точки дочернего профиля находятся в состоянии "Отключено" или "Остановлено", либо в этом профиле нет конечных точек.|Остановлено||


## Дальнейшие действия

Узнайте больше о том, [как работает диспетчер трафика](traffic-manager-how-traffic-manager-works.md).

Узнайте, как [создать профиль диспетчера трафика](traffic-manager-manage-profiles.md).

<!--Image references-->
[1]: ./media/traffic-manager-nested-profiles/figure-1.png
[2]: ./media/traffic-manager-nested-profiles/figure-2.png
[3]: ./media/traffic-manager-nested-profiles/figure-3.png
[4]: ./media/traffic-manager-nested-profiles/figure-4.png
[5]: ./media/traffic-manager-nested-profiles/figure-5.png
[6]: ./media/traffic-manager-nested-profiles/figure-6.png
[7]: ./media/traffic-manager-nested-profiles/figure-7.png
[8]: ./media/traffic-manager-nested-profiles/figure-8.png
[9]: ./media/traffic-manager-nested-profiles/figure-9.png
[10]: ./media/traffic-manager-nested-profiles/figure-10.png

<!---HONumber=AcomDC_0824_2016-->