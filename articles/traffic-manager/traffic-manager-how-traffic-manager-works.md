---
title: "Как работает диспетчер трафика | Документация Майкрософт"
description: "В этой статье объясняется, как работает диспетчер трафика Azure"
services: traffic-manager
documentationcenter: 
author: kumudd
manager: timlt
editor: 
ms.assetid: a6c9370d-e60d-440f-aa82-b6d3fa5416b0
ms.service: traffic-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/11/2016
ms.author: kumud
translationtype: Human Translation
ms.sourcegitcommit: 8827793d771a2982a3dccb5d5d1674af0cd472ce
ms.openlocfilehash: 6ba1732840d094497a9e2cb7a7ea7825a7f4bc89

---

# <a name="how-traffic-manager-works"></a>Как работает диспетчер трафика

Диспетчер трафика Azure позволяет управлять распределением трафика между конечными точками приложения. Конечная точка — это любая служба, размещенная в среде Azure или за ее пределами, с доступом в Интернет.

Диспетчер трафика предоставляет два основных преимущества.

1. Распределение трафика в соответствии с одним из нескольких [методов маршрутизации трафика](traffic-manager-routing-methods.md)
2. [Постоянный мониторинг работоспособности конечной точки](traffic-manager-monitoring.md) и автоматический переход на другой ресурс при сбое конечных точек.

Когда клиент пытается подключиться к службе, он должен сначала разрешить IP-адрес этой службы по ее DNS-имени. Затем клиент подключается к этому IP-адресу для доступа к службе.

**Самое главное — понимать, как диспетчер трафика работает на уровне DNS.**  Диспетчер трафика с помощью службы DNS направляет клиентов к разным конечным точкам службы, используя правила маршрутизации трафика. Клиент **напрямую** подключается к выбранной конечной точке. Диспетчер трафика не выполняет функции прокси-сервера или шлюза. Диспетчер трафика не может отслеживать трафик, проходящий между клиентом и службой.

## <a name="traffic-manager-example"></a>Пример диспетчера трафика

Корпорация Contoso разработала новый партнерский портал. URL-адрес для этого портала — https://partners.contoso.com/login.aspx. Приложение размещается в трех регионах Azure. Чтобы повысить доступность и общую производительность, компания использует диспетчер трафика, который направляет запросы клиентов в ближайшую доступную конечную точку.

Для достижения этой конфигурации они делают следующее.

* Развертывается три экземпляра службы. Этим развертываниям присваиваются DNS-имена contoso-us.cloudapp.net, contoso-eu.cloudapp.net и contoso-asia.cloudapp.net.
* Затем создается профиль диспетчера трафика с именем contoso.trafficmanager.net. В этом профиле настроена маршрутизации трафика по производительности между тремя конечными точками.
* Наконец, для личного домена (partners.contoso.com) настраивается запись CNAME в DNS, которая указывает на contoso.trafficmanager.net.

![Конфигурация DNS диспетчера трафика][1]

> [!NOTE]
> При использовании личного домена с диспетчером трафика Azure необходимо использовать запись CNAME для связи личного доменного имени с доменным именем диспетчера трафика. Стандарты DNS не позволяют создавать записи CNAME для корневой вершины домена. Поэтому вы не сможете создать запись CNAME для contoso.com (такой адрес иногда называют "голым" доменом). Запись CNAME можно создать только для поддомена contoso.com (например, www.contoso.com). Чтобы решить эту проблему, мы рекомендуем использовать простое перенаправление HTTP с адреса contoso.com на любой другой адрес, например www.contoso.com.

## <a name="how-clients-connect-using-traffic-manager"></a>Как клиенты могут подключаться с помощью диспетчера трафика

Когда пользователь в рамках описанной конфигурации запрашивает страницу https://partners.contoso.com/login.aspx, его клиент выполняет следующие действия, чтобы разрешить имя DNS и установить подключение.

![Установка подключения с помощью диспетчера трафика][2]

1. Клиент отправляет запрос DNS рекурсивной службе DNS для разрешения имени partners.contoso.com. (Рекурсивная (локальная) служба DNS сама не размещает информацию о доменах. Она просто освобождает клиента от необходимости взаимодействия через Интернет с полномочными службами DNS для разрешения DNS-имени.)
2. Чтобы разрешить имя DNS, рекурсивная служба DNS находит серверы доменных имен для домена contoso.com. Затем она обращается к этим серверам доменных имен и запрашивает запись DNS для имени partners.contoso.com. DNS-серверы, связанные с доменом contoso.com, возвращают запись CNAME, которая указывает на contoso.trafficmanager.net.
3. Рекурсивная служба DNS находит серверы доменных имен для домена trafficmanager.net, которые входят в службу диспетчера трафика Azure. Затем служба DNS отправляет этим серверам запрос на запись DNS для имени contoso.trafficmanager.net.
4. Серверы имен диспетчера трафика получают запрос. Они выбирают конечную точку, учитывая следующее:

    - состояние каждой конечной точки (отключенные конечные точки не возвращаются);
    - работоспособность каждой конечной точки, определенная с помощью средства проверки работоспособности диспетчера трафика. Дополнительные сведения см. в статье [Мониторинг и отработка отказов конечной точки диспетчера трафика](traffic-manager-monitoring.md).
    - выбранный метод маршрутизации трафика. Дополнительные сведения см. в статье [Методы маршрутизации трафика диспетчером трафика](traffic-manager-routing-methods.md).

5. Возвращается запись DNS CNAME с именем выбранной конечной точки. В нашем примере это — contoso-us.cloudapp.net.
6. Теперь рекурсивная служба DNS находит серверы доменных имен для домена cloudapp.net. Она обращается к этим серверам доменных имен и запрашивает запись DNS для contoso-us.cloudapp.net. Возвращается запись DNS A, которая содержит IP-адрес конечной точки службы, размещенной в США.
7. Рекурсивная служба DNS объединяет полученные результаты и возвращает клиенту один ответ DNS.
8. Клиент получает информацию DNS и подключается к указанному IP-адресу. Клиент подключается к конечной точке службы приложения напрямую, а не через диспетчер трафика. Так как это конечная точка HTTPS, клиент выполняет необходимое подтверждение SSL/TLS и отправляет запрос HTTP GET на получение страницы /login.aspx.

Рекурсивная служба DNS кэширует все полученные ответы DNS. Сопоставитель DNS на клиентском устройстве также кэширует результат. Это позволяет быстрее отвечать на последующие запросы DNS, используя данные из кэша, а не результаты запросов к другим серверам доменных имен. Длительность хранения записей DNS в кэше определяется свойством time-to-live (срок жизни, TTL). Чем меньше это значение, тем быстрее запись в кэше будет считаться истекшей, следовательно, сервера доменных имен, используемые диспетчером трафика, будут получать больше запросов. Более высокие значения приведут к тому, что при сбое конечной точки потребуется больше времени, чтобы переключить трафик на другие конечные точки. Диспетчер трафика позволяет настроить свойство TTL для ответов DNS диспетчера трафика, чтобы вы могли выбрать значение, которое наилучшим образом отвечает потребностям приложения.

## <a name="faq"></a>Часто задаваемые вопросы

### <a name="what-ip-address-does-traffic-manager-use"></a>Какой IP-адрес использует диспетчер трафика?

В статье "Как работает диспетчер трафика" объясняется, что диспетчер трафика работает на уровне DNS. Он использует ответы DNS, чтобы направлять клиентов в соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика.

Следовательно, диспетчер трафика не предоставляет конечную точку или IP-адрес для подключения клиентов. Если, например, вашей службе требуется статический IP-адрес, он должен быть настроен на уровне службы, а не в диспетчере трафика.

### <a name="does-traffic-manager-support-sticky-sessions"></a>Поддерживает ли диспетчер трафика прикрепленные сеансы?

Как указано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика. Таким образом, диспетчер трафика не может отслеживать HTTP-трафик, проходящий между клиентом и сервером.

Кроме того, исходный IP-адрес, откуда диспетчер трафика получает запрос DNS, принадлежит рекурсивной службе DNS, а не клиенту. Это значит, что диспетчер трафика не может отслеживать отдельные клиенты и не может реализовывать прикрепленные сеансы. Это общее ограничение для всех систем управления трафиком на основе DNS, а не особенность диспетчера трафика.

### <a name="why-am-i-seeing-an-http-error-when-using-traffic-manager"></a>Почему при использовании диспетчера трафика отображается HTTP-ошибка?

Как указано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика. Диспетчер трафика не видит трафик HTTP, проходящий между клиентом и сервером. Это значит, что все отображаемые HTTP-ошибки создаются приложением. Если клиент подключился к приложению, значит все действия по разрешению имен DNS уже успешно выполнены. Сюда входят также действия, выполняемые диспетчером в отношении трафика приложения.

Таким образом, вам следует проанализировать возможные проблемы на уровне приложения.

Чаще всего проблемы возникают из-за HTTP-заголовка Host в запросе, который отправляет браузер пользователя. Убедитесь, что приложение правильно обрабатывает заголовок с используемым вами доменным именем. Если конечная точка размещается в службе приложений Azure, см. статью [Настройка личного доменного имени для веб-приложения в службе приложений Azure, использующей диспетчер трафика](../app-service-web/web-sites-traffic-manager-custom-domain-name.md).

### <a name="what-is-the-performance-impact-of-using-traffic-manager"></a>Как сказывается на производительности использование диспетчера трафика?

Как указано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. Так как клиенты подключаются к конечным точкам службы напрямую, использование диспетчера трафика при установленном соединении никак не влияет на производительность.

Диспетчер трафика интегрируется с приложениями на уровне DNS, поэтому в цепочку разрешения DNS включается дополнительный поиск DNS (см. раздел [Пример диспетчера трафика](#traffic-manager-example)). Диспетчер трафика оказывает минимальное влияние на время разрешения DNS. Диспетчер трафика использует глобальную сеть серверов доменных имен и сетевую службу [произвольной рассылки](https://en.wikipedia.org/wiki/Anycast), обеспечивая передачу запросов DNS на ближайший доступный сервер доменных имен. Кроме того, кэширование DNS-ответов означает, что дополнительные задержки DNS, связанные с использованием диспетчера трафика, происходят только в некоторых сеансах.

В ходе маршрутизации по производительности трафик направляется в ближайшую доступную конечную точку. В итоге этот метод маршрутизации оказывает минимальное влияние на общую производительность. Возможное повышение задержки DNS будет компенсироваться снижением задержки сети при взаимодействии с конечной точкой.

### <a name="what-application-protocols-can-i-use-with-traffic-manager"></a>Какие протоколы приложения пригодны для использования с диспетчером трафика?

Как указано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. После завершения поиска DNS клиенты подключаются к конечной точке приложения напрямую, а не через диспетчер трафика. Следовательно, это подключение может использовать любой протокол приложения. Но проверку работоспособности диспетчер трафика сможет выполнять только для конечных точек HTTP и HTTPS. Можно использовать разные конечные точки при проверке работоспособности и подключении клиентов к приложению.

### <a name="can-i-use-traffic-manager-with-a-naked-domain-name"></a>Можно ли использовать диспетчер трафика с "голым" доменным именем (без префикса www)?

Нет. Стандарты DNS не допускают существование записей CNAME и других записей DNS для одного доменного имени. Для верхнего (корневого) имени в любой зоне DNS всегда определены две записи DNS — SOA и NS (для полномочных серверов доменных имен). Это означает, что на вершине зоны нельзя создать запись CNAME, не нарушив стандарты DNS.

Как описано в разделе [Пример диспетчера трафика](#traffic-manager-example), для работы диспетчера трафика обязательно требуется запись DNS CNAME для сопоставления с личным именем DNS. Например, вы можете сопоставить www.contoso.com с именем DNS профиля диспетчера трафика contoso.trafficmanager.net. Кроме того, профиль диспетчера трафика возвращает еще одну запись DNS CNAME, которая указывает клиенту конечную точку для подключения.

Чтобы решить эту проблему, мы рекомендуем выполнить перенаправление HTTP с "голого" доменного имени на другой URL-адрес, который затем можно использовать с диспетчером трафика. Например, можно перенаправлять пользователей с доменного имени contoso.com на адрес www.contoso.com, для которого указана запись CNAME, ведущая к доменному имени диспетчера трафика.

Полная поддержка таких доменов в диспетчере трафика отслеживается в списке подготавливаемых функций. Если вас интересует эта функция, [проголосуйте за нее на нашем сайте обратной связи](https://feedback.azure.com/forums/217313-networking/suggestions/5485350-support-apex-naked-domains-more-seamlessly).

## <a name="next-steps"></a>Дальнейшие действия

См. дополнительные сведения в статье [Мониторинг и отработка отказов конечной точки диспетчера трафика](traffic-manager-monitoring.md).

См. дополнительные сведения в статье [Методы маршрутизации трафика диспетчером трафика](traffic-manager-routing-methods.md).

<!--Image references-->
[1]: ./media/traffic-manager-how-traffic-manager-works/dns-configuration.png
[2]: ./media/traffic-manager-how-traffic-manager-works/flow.png



<!--HONumber=Nov16_HO5-->


