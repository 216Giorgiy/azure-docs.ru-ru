<properties
   pageTitle="Как работает диспетчер трафика | Microsoft Azure"
   description="Эта статья поможет понять, как работает диспетчер трафика"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn"/>

<tags
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/25/2016"
   ms.author="jonatul"/>

# Как работает диспетчер трафика

Диспетчер трафика Azure позволяет управлять распределением трафика через конечные точки приложения. В качестве конечной точки может использоваться любая конечная точка с выходом в Интернет, размещенная в Azure или за пределами Azure.

Диспетчер трафика предоставляет два основных преимущества.

1. Распределение трафика в соответствии с одним из нескольких [методов маршрутизации трафика](traffic-manager-routing-methods.md).
2. [Постоянный мониторинг работоспособности конечной точки](traffic-manager-monitoring.md) и автоматический переход на другой ресурс при сбое конечных точек.

Когда пользователь пытается подключиться к конечной точке службы, клиент пользователя (ПК, телефон и т. д.) сначала должен разрешить DNS-имя в этой конечной точке в IP-адрес. Затем клиент подключается к этому IP-адресу для доступа к службе.

**Самое главное — понимать, как диспетчер трафика работает на уровне DNS.** Диспетчер трафика использует DNS для направления пользователей в определенные конечные точки службы на основе выбранного метода маршрутизации трафика и текущего состояния конечной точки. Затем клиент подключается к выбранной конечной точке **напрямую**. Диспетчер трафика — это не прокси-сервер, и он не видит трафик, проходящий между клиентом и службой.

## Пример диспетчера трафика

Корпорация Contoso разработала новый партнерский портал. URL-адрес этого портала — https://partners.contoso.com/login.aspx. Приложение размещено в Azure, и для повышения доступности и улучшения общей производительности они хотят развернуть приложение в трех регионах по всему миру и распределять пользователей по их ближайшим конечным точкам с помощью диспетчера трафика.

Для достижения этой конфигурации они делают следующее.

- Разворачивают 3 экземпляра службы. DNS-имена для этих развертываний — "contoso-us.cloudapp.net", "contoso-eu.cloudapp.net" и "contoso-asia.cloudapp.net".
- Затем они создают профиль диспетчера трафика с именем "contoso.trafficmanager.net". В этом профиле настроен метод маршрутизации трафика "Производительность" между тремя конечными точками, указанными выше.
- Наконец, они настраивают свой личный домен ("partners.contoso.com") так, чтобы он указывал на "contoso.trafficmanager.net", с помощью записи CNAME в DNS.

![Конфигурация DNS диспетчера трафика][1]

> [AZURE.NOTE] При использовании личного домена с диспетчером трафика Azure необходимо использовать запись CNAME для связи личного доменного имени с доменным именем диспетчера трафика.

> Из-за ограничений стандартов DNS запись CNAME невозможно создать на "вершине" (или в корне) домена. Поэтому вы не сможете создать запись CNAME для contoso.com (который иногда называется "голым" доменом). Запись CNAME можно создать только для поддомена "contoso.com", например "www.contoso.com".

> Таким образом, диспетчер трафика нельзя использовать напрямую с "голым" доменом. Чтобы обойти эту проблему, рекомендуем использовать простое перенаправление HTTP для перенаправления запросов к "contoso.com" на другой домен, например "www.contoso.com".

## Как клиенты могут подключаться с помощью диспетчера трафика

Когда пользователь запрашивает страницу https://partners.contoso.com/login.aspx (как описано в приведенном выше примере), клиент пользователя выполняет следующие действия, чтобы разрешить имя DNS и установить подключение.

![Установка подключения с помощью диспетчера трафика][2]

1.	Клиент (ПК, телефон и т. д.) отправляет запрос DNS для "partners.contoso.com" настроенной рекурсивной службе DNS. (Рекурсивная служба DNS, которая иногда называется службой "локального DNS", не содержит доменов DNS. Вместо этого она используется клиентом для реализации действий по связи с различными полномочными службами DNS через Интернет для разрешения DNS-имени.)
2.	Рекурсивная служба DNS разрешает DNS-имя "partners.contoso.com". Сначала рекурсивная служба DNS находит серверы имен для домена "contoso.com". Затем она обращается к этим серверам имен для запроса DNS-записи "partners.contoso.com". Возвращается запись CNAME для contoso.trafficmanager.net.
3.	Рекурсивная служба DNS находит серверы имен для домена "trafficmanager.net", которые предоставляются службой диспетчера трафика Azure. Она обращается к этим серверам имен для запроса DNS-записи "contoso.trafficmanager.net".
4.	Серверы имен диспетчера трафика получают запрос. Затем они выбирают конечные точки, которые будут возвращены, на основе следующих параметров: a) состояние включения/отключения каждой конечной точки (отключенные конечные точки не возвращаются); б) работоспособность каждой конечной точки, определенная с помощью средства проверки работоспособности диспетчера трафика. Дополнительные сведения см. в разделе "Мониторинг конечных точек диспетчера трафика"; в) выбранный метод маршрутизации трафика. Дополнительные сведения см. в разделе "Методы маршрутизации трафика в диспетчере трафика".
5.	Выбранная конечная точка возвращается в виде другой DNS-записи CNAME. В данном случае предположим, что возвращена конечная точка contoso-us.cloudapp.net.
6.	Рекурсивная служба DNS находит серверы имен для домена "cloudapp.net". Она обращается к этим серверам имен для запроса DNS-записи "contoso-us.cloudapp.net". Возвращается запись DNS "A", содержащая IP-адрес конечной точки службы, размещенной в США.
7.	Рекурсивная служба DNS возвращает клиенту объединенные результаты для указанной выше последовательности разрешения имен.
8.	Клиент получает результаты DNS от рекурсивной службы DNS и подключается к данному IP-адресу. Обратите внимание, что клиент подключается к конечной точке службы приложения напрямую, а не через диспетчер трафика. Так как это конечная точка HTTPS, она выполняет необходимые подтверждения SSL/TLS и затем отправляет запрос HTTP GET для страницы "/login.aspx".

Обратите внимание, что рекурсивная служба DNS будет кэшировать получаемые ответы DNS. То же будет делать и клиент DNS на устройстве пользователя. Это позволяет быстрее отвечать на последующие запросы DNS, используя данные из кэша вместо опроса других серверов имен. Длительность кэша определяется свойством "time-to-live" (TTL) каждой записи DNS. Меньшие значения приведут к более быстрому истечению срока действия кэша и дополнительным обращениям к серверам имен диспетчера трафика. Большие значения приведут к тому, что на перенаправление трафика от неисправной конечной точки потребуется больше времени. Диспетчер трафика позволяет настроить свойство TTL для ответов DNS диспетчера трафика, чтобы вы могли выбрать значение, которое наилучшим образом отвечает потребностям приложения.

## Дальнейшие действия

Ознакомьтесь с дополнительными сведениями о [мониторинге конечных точек и автоматическом переходе на другой ресурс](traffic-manager-monitoring.md) диспетчера трафика.

Ознакомьтесь с дополнительными сведениями о [методах маршрутизации трафика в диспетчере трафика](traffic-manager-routing-methods.md).

<!--Image references-->
[1]: ./media/traffic-manager-how-traffic-manager-works/dns-configuration.png
[2]: ./media/traffic-manager-how-traffic-manager-works/flow.png

<!---HONumber=AcomDC_0525_2016-->