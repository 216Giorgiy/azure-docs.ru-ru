<properties
   pageTitle="Как работает диспетчер трафика | Microsoft Azure"
   description="Эта статья поможет понять, как работает диспетчер трафика"
   services="traffic-manager"
   documentationCenter=""
   authors="sdwheeler"
   manager="carmonm"
   editor="tysonn"/>

<tags
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="06/07/2016"
   ms.author="sewhee"/>

# Как работает диспетчер трафика

Диспетчер трафика Azure позволяет управлять распределением трафика через конечные точки приложения. В качестве конечной точки может использоваться любая конечная точка с выходом в Интернет, размещенная в Azure или за пределами Azure.

Диспетчер трафика предоставляет два основных преимущества.

1. Распределение трафика в соответствии с одним из нескольких [методов маршрутизации трафика](traffic-manager-routing-methods.md).
2. [Постоянный мониторинг работоспособности конечной точки](traffic-manager-monitoring.md) и автоматический переход на другой ресурс при сбое конечных точек.

Когда пользователь пытается подключиться к конечной точке службы, клиент пользователя (ПК, телефон и т. д.) сначала должен разрешить DNS-имя в этой конечной точке в IP-адрес. Затем клиент подключается к этому IP-адресу для доступа к службе.

**Самое главное — понимать, как диспетчер трафика работает на уровне DNS.** Диспетчер трафика использует DNS для направления пользователей в определенные конечные точки службы на основе выбранного метода маршрутизации трафика и текущего состояния конечной точки. Затем клиент подключается к выбранной конечной точке **напрямую**. Диспетчер трафика — это не прокси-сервер, и он не видит трафик, проходящий между клиентом и службой.

## Пример диспетчера трафика

Корпорация Contoso разработала новый партнерский портал. URL-адрес этого портала — https://partners.contoso.com/login.aspx. Приложение размещено в Azure, и для повышения доступности и улучшения общей производительности они хотят развернуть приложение в трех регионах по всему миру и распределять пользователей по их ближайшим конечным точкам с помощью диспетчера трафика.

Для достижения этой конфигурации они делают следующее.

- Разворачивают 3 экземпляра службы. DNS-имена для этих развертываний — "contoso-us.cloudapp.net", "contoso-eu.cloudapp.net" и "contoso-asia.cloudapp.net".
- Затем они создают профиль диспетчера трафика с именем "contoso.trafficmanager.net". В этом профиле настроен метод маршрутизации трафика "Производительность" между тремя конечными точками, указанными выше.
- Наконец, они настраивают свой личный домен ("partners.contoso.com") так, чтобы он указывал на "contoso.trafficmanager.net", с помощью записи CNAME в DNS.

![Конфигурация DNS диспетчера трафика][1]

> [AZURE.NOTE] При использовании личного домена с диспетчером трафика Azure необходимо использовать запись CNAME для связи личного доменного имени с доменным именем диспетчера трафика.

> Из-за ограничений стандартов DNS запись CNAME невозможно создать на "вершине" (или в корне) домена. Поэтому вы не сможете создать запись CNAME для contoso.com (который иногда называется "голым" доменом). Запись CNAME можно создать только для поддомена "contoso.com", например "www.contoso.com".

> Таким образом, диспетчер трафика нельзя использовать напрямую с "голым" доменом. Чтобы обойти эту проблему, рекомендуем использовать простое перенаправление HTTP для перенаправления запросов к "contoso.com" на другой домен, например "www.contoso.com".

## Как клиенты могут подключаться с помощью диспетчера трафика

Когда пользователь запрашивает страницу https://partners.contoso.com/login.aspx (как описано в приведенном выше примере), клиент пользователя выполняет следующие действия, чтобы разрешить имя DNS и установить подключение.

![Установка подключения с помощью диспетчера трафика][2]

1.	Клиент (ПК, телефон и т. д.) отправляет запрос DNS для "partners.contoso.com" настроенной рекурсивной службе DNS. (Рекурсивная служба DNS, которая иногда называется службой "локального DNS", не содержит доменов DNS. Вместо этого она используется клиентом для реализации действий по связи с различными полномочными службами DNS через Интернет для разрешения DNS-имени.)
2.	Рекурсивная служба DNS разрешает DNS-имя "partners.contoso.com". Сначала рекурсивная служба DNS находит серверы имен для домена "contoso.com". Затем она обращается к этим серверам имен для запроса DNS-записи "partners.contoso.com". Возвращается запись CNAME для contoso.trafficmanager.net.
3.	Рекурсивная служба DNS находит серверы имен для домена trafficmanager.net, которые предоставляются службой диспетчера трафика Azure. Она обращается к этим серверам имен для запроса DNS-записи "contoso.trafficmanager.net".
4.	Серверы имен диспетчера трафика получают запрос. Затем они выбирают конечные точки, которые будут возвращены, на основе следующих параметров: a) состояние включения/отключения каждой конечной точки (отключенные конечные точки не возвращаются); б) работоспособность каждой конечной точки, определенная с помощью средства проверки работоспособности диспетчера трафика. Дополнительные сведения см. в разделе "Мониторинг конечных точек диспетчера трафика"; в) выбранный метод маршрутизации трафика. Дополнительные сведения см. в разделе "Методы маршрутизации трафика в диспетчере трафика".
5.	Выбранная конечная точка возвращается в виде другой DNS-записи CNAME. В данном случае предположим, что возвращена конечная точка contoso-us.cloudapp.net.
6.	Рекурсивная служба DNS находит серверы имен для домена "cloudapp.net". Она обращается к этим серверам имен для запроса DNS-записи "contoso-us.cloudapp.net". Возвращается запись DNS "A", содержащая IP-адрес конечной точки службы, размещенной в США.
7.	Рекурсивная служба DNS возвращает клиенту объединенные результаты для указанной выше последовательности разрешения имен.
8.	Клиент получает результаты DNS от рекурсивной службы DNS и подключается к данному IP-адресу. Обратите внимание, что клиент подключается к конечной точке службы приложения напрямую, а не через диспетчер трафика. Так как это конечная точка HTTPS, она выполняет необходимые подтверждения SSL/TLS и затем отправляет запрос HTTP GET для страницы "/login.aspx".

Обратите внимание, что рекурсивная служба DNS будет кэшировать получаемые ответы DNS. То же будет делать и клиент DNS на устройстве пользователя. Это позволяет быстрее отвечать на последующие запросы DNS, используя данные из кэша вместо опроса других серверов имен. Длительность кэша определяется свойством "time-to-live" (TTL) каждой записи DNS. Меньшие значения приведут к более быстрому истечению срока действия кэша и дополнительным обращениям к серверам имен диспетчера трафика. Большие значения приведут к тому, что на перенаправление трафика от неисправной конечной точки потребуется больше времени. Диспетчер трафика позволяет настроить свойство TTL для ответов DNS диспетчера трафика, чтобы вы могли выбрать значение, которое наилучшим образом отвечает потребностям приложения.

## Часто задаваемые вопросы

### Какой IP-адрес использует диспетчер трафика?

В статье "Как работает диспетчер трафика" объясняется, что диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика.

Следовательно, диспетчер трафика не предоставляет конечную точку или IP-адрес для подключения клиентов. Если, например, требуется статический IP-адрес, он должен быть настроен на уровне службы, а не в диспетчере трафика.

### Поддерживает ли диспетчер трафика прикрепленные сеансы?

Как сказано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика. Следовательно, диспетчер трафика не видит трафик HTTP между клиентом и сервером, включая файлы cookie.

Кроме того, учтите, что исходный IP-адрес DNS-запроса, получаемый диспетчером трафика, — это IP-адрес рекурсивной службы DNS, а не IP-адрес клиента.

Это значит, что диспетчер трафика не может идентифицировать или отслеживать отдельные клиенты и, следовательно, не может реализовывать прикрепленные сеансы. Это общие характеристики для всех систем управления трафиком на основе DNS, которые не ограничивают возможности использования диспетчера трафика.

### Я вижу HTTP-ошибку при использовании диспетчера трафика. В чем проблема?

Как сказано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика.

Следовательно, диспетчер трафика не видит трафик HTTP между клиентом и сервером и не может генерировать ошибки уровня HTTP. Это значит, что все отображаемые HTTP-ошибки создаются приложением. Так как клиент подключается к приложению, это также значит, что разрешение имен DNS, включая роль диспетчера трафика, должно быть завершено.

Таким образом, вам следует проанализировать возможные проблемы на уровне приложения.

Общая проблема заключается в том, что при использовании диспетчера трафика HTTP-заголовок узла, передаваемый браузером в приложение, отображает доменное имя, используемое в браузере. Это может быть доменное имя диспетчера трафика (например, myprofile.trafficmanager.net), если это доменное имя используется при тестировании, или же запись CNAME именного домена, настроенная для выбора доменного имени диспетчера трафика. В любом случае приложение нужно настроить для приема этого заголовка узла.

Если приложение размещается в службе приложений Azure, см. статью [Настройка личного доменного имени для веб-приложения в службе приложений Azure, использующей диспетчер трафика](../app-service-web/web-sites-traffic-manager-custom-domain-name.md).

### Как сказывается на производительности использование диспетчера трафика?

Как сказано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика.

Так как клиенты подключаются к конечным точкам службы напрямую, использование диспетчера трафика при установленном соединении никак не влияет на производительность.

Диспетчер трафика интегрируется с приложениями на уровне DNS, поэтому в цепочку разрешения DNS должен быть включен дополнительный поиск DNS (см. [примере диспетчера трафика](#traffic-manager-example)). Диспетчер трафика оказывает минимальное влияние на время разрешения DNS. Диспетчер трафика использует глобальную сеть серверов доменных имен и сетевую службу произвольной рассылки, обеспечивая маршрутизацию DNS-запросов на ближайший доступный сервер доменных имен. Кроме того, кэширование DNS-ответов означает, что дополнительные задержки DNS, связанные с использованием диспетчера трафика, происходят только в некоторых сеансах.

В результате общее влияние на производительность, обусловленное включением диспетчера трафика в приложение, должно быть минимальным.

Кроме того, при использовании в диспетчере трафика [эффективного метода маршрутизации трафика](traffic-manager-routing-methods.md#performance-traffic-routing-method) увеличение задержки DNS должно значительно превышать смещение благодаря повышению производительности, достигаемому маршрутизацией пользователей на ближайшую доступную конечную точку.

### Какие протоколы приложения пригодны для использования с диспетчером трафика?
Как сказано [выше](#how-clients-connect-using-traffic-manager), диспетчер трафика работает на уровне DNS. После завершения поиска DNS клиенты подключаются к конечной точке приложения напрямую, а не через диспетчер трафика. Следовательно, это подключение может использовать любой протокол приложения.

Тем не менее для проверки работоспособности конечной точки диспетчера трафика требуется конечная точка HTTP или HTTPS. Это может быть отдельная от приложения конечная точка для подключения клиентов. Для этого в параметрах проверки работоспособности профиля диспетчера трафика укажите другой TCP-порт или путь URI.

### Можно ли использовать диспетчер трафика с доменным именем без префикса www?

В настоящее время нет.

Тип DNS-записи CNAME используется для создания сопоставления одного DNS-имени с другим. Как описано в [примере диспетчера трафика](#traffic-manager-example), диспетчеру трафика требуется DNS-запись CNAME для сопоставления запоминающегося DNS-имени (например, www.contoso.com) с DNS-именем профиля диспетчера трафика (например, contoso.trafficmanager.net). Кроме того, профиль диспетчера трафика сам возвращает вторую DNS-запись CNAME, чтобы указать конечную точку, к которой должен подключиться клиент.

Стандарты DNS не допускают сосуществование записей CNAME и других DNS-записей того же типа. Так как вершина (или корень) DNS-зоны всегда содержит две уже существующие DNS-записи (записи SOA и полномочные записи NS), создать записи CNAME на вершине зоны без нарушения стандартов DNS невозможно.

Чтобы обойти эту проблему, рекомендуется, чтобы службы, использующие доменные имена без www, которые должны работать с диспетчером трафика, применяли HTTP-перенаправление прямого трафика (от домена без www на другой URL-адрес) с последующим использованием диспетчера трафика. Например, домен contoso.com может перенаправлять пользователей на домен www.contoso.com, который, в свою очередь, может использовать диспетчер трафика.

Полная поддержка таких доменов в диспетчере трафика отслеживается в списке подготавливаемых функций. Если вы заинтересованы в этой функции, [проголосуйте за нее на нашем сайте обратной связи](https://feedback.azure.com/forums/217313-networking/suggestions/5485350-support-apex-naked-domains-more-seamlessly).

## Дальнейшие действия

См. дополнительные сведения о [мониторинге конечных точек и автоматическом переходе на другой ресурс](traffic-manager-monitoring.md) диспетчера трафика.

См. дополнительные сведения о [методах маршрутизации трафика](traffic-manager-routing-methods.md) в диспетчере трафика.

<!--Image references-->
[1]: ./media/traffic-manager-how-traffic-manager-works/dns-configuration.png
[2]: ./media/traffic-manager-how-traffic-manager-works/flow.png

<!---HONumber=AcomDC_0824_2016-->