---
title: "Общие сведения о параметрах автомасштабирования | Документация Майкрософт"
description: "Подробный разбор настроек автомасштабирования и принципов их работы."
author: anirudhcavale
manager: orenr
editor: 
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: ce2930aa-fc41-4b81-b0cb-e7ea922467e1
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/18/2017
ms.author: ancav
ms.openlocfilehash: 79602cf053d834bf3d6dc6b4d5568637b179d5c7
ms.sourcegitcommit: ded74961ef7d1df2ef8ffbcd13eeea0f4aaa3219
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2018
---
# <a name="understand-autoscale-settings"></a>Общие сведения о параметрах автомасштабирования
С помощью параметров автомасштабирования можно настроить объем ресурсов, необходимый для управления колеблющейся нагрузкой приложения. Вы можете настроить активацию параметров автомасштабирования при достижении метрик нагрузки или производительности или запланировать дату и время активации. В этой статье подробно описывается настройка автомасштабирования. Сначала объясняются схема настройки и ее свойства, затем рассматриваются возможные типы профилей, а в конце описывается, как определяется, какой и когда использовать профиль.

## <a name="autoscale-setting-schema"></a>Схема настройки автомасштабирования
Чтобы показать схему настройки, используются следующие параметры автомасштабирования. Важно, что у этих параметров:
- Один профиль. 
- В этом профиле два правила метрик. Одно правило задает горизонтальное масштабирование, а другое — уменьшение масштаба.
- Правило горизонтального масштабирования применяется, когда среднее значение метрики "Загрузка ЦП" для масштабируемого набора виртуальных машин превышает 85 % на протяжении 10 минут.
- Правило уменьшения масштаба действует, когда этот параметр меньше 60 % на протяжении одной минуты.

> [!NOTE]
> В параметрах может быть несколько профилей (дополнительные сведения см. в разделе о [профилях](#autoscale-profiles)).
> В профиле также можно определить несколько правил горизонтального масштабирования и уменьшения масштаба (как определяется, какое правило применить, см. в разделе об [оценке](#autoscale-evaluation)).

```JSON
{
  "id": "/subscriptions/s1/resourceGroups/rg1/providers/microsoft.insights/autoscalesettings/setting1",
  "name": "setting1",
  "type": "Microsoft.Insights/autoscaleSettings",
  "location": "East US",
  "properties": {
    "enabled": true,
    "targetResourceUri": "/subscriptions/s1/resourceGroups/rg1/providers/Microsoft.Compute/virtualMachineScaleSets/vmss1",
    "profiles": [
      {
        "name": "mainProfile",
        "capacity": {
          "minimum": "1",
          "maximum": "4",
          "default": "1"
        },
        "rules": [
          {
            "metricTrigger": {
              "metricName": "Percentage CPU",
              "metricResourceUri": "/subscriptions/s1/resourceGroups/rg1/providers/Microsoft.Compute/virtualMachineScaleSets/vmss1",
              "timeGrain": "PT1M",
              "statistic": "Average",
              "timeWindow": "PT10M",
              "timeAggregation": "Average",
              "operator": "GreaterThan",
              "threshold": 85
            },
            "scaleAction": {
              "direction": "Increase",
              "type": "ChangeCount",
              "value": "1",
              "cooldown": "PT5M"
            }
          },
    {
            "metricTrigger": {
              "metricName": "Percentage CPU",
              "metricResourceUri": "/subscriptions/s1/resourceGroups/rg1/providers/Microsoft.Compute/virtualMachineScaleSets/vmss1",
              "timeGrain": "PT1M",
              "statistic": "Average",
              "timeWindow": "PT10M",
              "timeAggregation": "Average",
              "operator": "LessThan",
              "threshold": 60
            },
            "scaleAction": {
              "direction": "Decrease",
              "type": "ChangeCount",
              "value": "1",
              "cooldown": "PT5M"
            }
          }
        ]
      }
    ]
  }
}
```

| Раздел | Имя элемента | ОПИСАНИЕ |
| --- | --- | --- |
| Параметр | ИД | Идентификатор ресурса параметров автомасштабирования. Параметры автомасштабирования относятся к ресурсам Azure Resource Manager. |
| Параметр | name | Имя параметра автомасштабирования. |
| Параметр | location | Расположение параметра автомасштабирования. Оно может отличаться от расположения масштабируемого ресурса. |
| properties | targetResourceUri | Идентификатор масштабируемого ресурса. У одного ресурса может быть только один раздел параметров автомасштабирования. |
| properties | профили | Параметры автомасштабирования включают в себя один или несколько профилей. При каждом запуске система автомасштабирования выполняет один профиль. |
| Профиль | name | Имя профиля. Для него можно указать любое имя, позволяющее отличить профиль от других. |
| Профиль | Capacity.maximum | Максимальный разрешенный объем. Обеспечивает, чтобы во время автомасштабирования при выполнении этого профиля объем ресурса не превышал это число. |
| Профиль | Capacity.minimum | Минимальный разрешенный объем. Обеспечивает, чтобы во время автомасштабирования при выполнении этого профиля объем ресурса не снижался ниже этого числа. |
| Профиль | Capacity.default | Если возникнут проблемы чтения метрик ресурсов (в этом случае — ЦП vmss1) и текущий объем будет меньше, чем по умолчанию, механизм автомасштабирования выполнит масштабирование до значения по умолчанию, чтобы обеспечить доступность ресурса. Если текущий объем превышает значение по умолчанию, количество экземпляров не будет уменьшено. |
| Профиль | правила | Механизм автомасштабирования автоматически уменьшает и увеличивает емкость согласно правилам в профиле. В профиле может быть несколько правил. В стандартном сценарии два правила: одно применяется, когда необходимо горизонтальное масштабирование, а другое — когда нужно уменьшить масштаб. |
| правило; | metricTrigger | Определяет условие метрики для правила. |
| metricTrigger | metricName | Имя метрики. |
| metricTrigger |  metricResourceUri | Идентификатор ресурса, выдающего эту метрику. В большинстве случаев он совпадает с именем масштабируемого ресурса. Иногда имя и идентификатор отличаются, например, когда нужно масштабировать набор виртуальных машин по количеству сообщений в очереди хранилища. |
| metricTrigger | timeGrain | Продолжительность выборки метрик. Например, TimeGrain = "PT1M" означает, что метрики будут агрегироваться каждую минуту с помощью метода, указанного в свойстве statistic. |
| metricTrigger | statistic | Метод агрегирования, используемый в течение периода timeGrain. Например, statistic = "Average" и TimeGrain = "PT1M" означают, что метрики будут агрегироваться каждую минуту путем определения среднего значения. Это свойство определяет порядок выборки метрики. |
| metricTrigger | timeWindow | Время для ретроспективного поиска метрик. Например, timeWindow = "PT10M" означает, что при каждом запуске механизм автомасштабирования будет запрашивать метрики за последние 10 минут. Это позволяет нормализовать метрики и избежать реакций на переходные всплески. |
| metricTrigger | timeAggregation | Метод агрегирования метрик выборки. Например, TimeAggregation = "Average" значит, что метрика будет агрегироваться путем определения среднего значения. В примере выше будут выполнены 10 выборок по 1 минуте, а затем будет определено их среднее значение. |
| правило; | scaleAction | Действие, выполняемое при активации параметра metricTrigger правила. |
| scaleAction | direction | "Increase" — для горизонтального масштабирования, "Decrease" — для уменьшения масштаба.|
| scaleAction | value | Емкость, до которой нужно увеличить или уменьшить ресурс. |
| scaleAction | cooldown | Время ожидания следующего масштабирования после аналогичной операции. К примеру, если cooldown = "PT10M", то после масштабирования система автомасштабирования не будет пытаться выполнить эту операцию 10 минут. Свойство cooldown предназначено для стабилизации метрик после добавления или удаления экземпляров. |

## <a name="autoscale-profiles"></a>Профили автомасштабирования

Есть три типа профилей автомасштабирования:

1. **Регулярный профиль.** Он самый распространенный. Если не нужно нестандартно масштабировать ресурс, к примеру с учетом дня недели или в определенный день, достаточно настроить профиль этого типа в параметрах автомасштабирования. Этот профиль можно настроить, используя правила метрик, определяющие, когда горизонтально масштабировать ресурс, а когда уменьшать масштаб. Регулярный профиль должен быть только один.

    Пример профиля, приведенный ранее в этой статье, принадлежит к регулярному типу. Обратите внимание, что в профиле можно задать масштабирование до количества статических экземпляров в ресурсе.

2. **Профиль с фиксированной датой.** Предположим, что вы определили регулярный профиль и 26 декабря 2017 г. (по тихоокеанскому времени) ожидали важное событие, для которого было необходимо другое значение минимального или максимального объема ресурсов при тех же метриках. Тогда следовало добавить в параметры в список профилей профиль с фиксированной датой. Такой профиль настраивают только для выполнения в день события. В других случаях выполняется регулярный профиль.

    ``` JSON
    "profiles": [{
    "name": " regularProfile",
    "capacity": {
    ...
    },
    "rules": [{
    ...
    },
    {
    ...
    }]
    },
    {
    "name": "eventProfile",
    "capacity": {
    ...
    },
    "rules": [{
    ...
    }, {
    ...
    }],
    "fixedDate": {
        "timeZone": "Pacific Standard Time",
               "start": "2017-12-26T00:00:00",
               "end": "2017-12-26T23:59:00"
    }}
    ]
    ```
    
3. **Профиль повторения.** Профиль этого типа позволяет вам настроить выполнение всегда в определенный день недели. В профиле повторения есть только параметр времени запуска, поэтому он выполняется до следующего профиля повторения или профиля с фиксированной датой. Параметры автомасштабирования только с одним профилем повторения выполняют этот профиль, даже если в них определен регулярный профиль. На примерах ниже показано использование этого профиля:

    **Пример 1. Рабочие и выходные дни.** Предположим, что по выходным требуется максимальная емкость, равная 4, а в рабочие дни вам необходимо, чтобы этот параметр был равен 10, так как ожидается больше нагрузки. Тогда нужно, чтобы в настройках было два профиля повторения: один, запускаемый по выходным, а другой — по рабочим дням.
    Параметры будут выглядеть так:

    ``` JSON
    "profiles": [
    {
    "name": "weekdayProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }],
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Monday"
            ],
            "hours": [
                0
            ],
            "minutes": [
                0
            ]
        }
    }}
    },
    {
    "name": "weekendProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }]
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Saturday"
            ],
            "hours": [
                0
            ],
            "minutes": [
                0
            ]
        }
    }
    }]
    ```

    Просмотрев эти параметры, вы заметите, что в каждом профиле повторения есть расписание, которое определяет, когда запускается профиль. Выполнение профиля останавливается, когда наступает время запуска другого профиля.

    Например, в параметрах выше для weekdayProfile настроен запуск в понедельник в 0:00. Профиль будет выполняться до 0:00 субботы, времени, настроенного для запуска weekendProfile.

    **Пример 2. Время работы.** Возьмем другой пример: вам необходимо применять пороговое значение "x" в рабочее время, с 9:00 до 17:00 и с 17:00 до 9:00, а на следующий день требуется использовать пороговое значение "y".
    Параметры будут выглядеть так:
    
    ``` JSON
    "profiles": [
    {
    "name": "businessHoursProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }],
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Monday", “Tuesday”, “Wednesday”, “Thursday”, “Friday”
            ],
            "hours": [
                9
            ],
            "minutes": [
                0
            ]
        }
    }
    },
    {
    "name": "nonBusinessHoursProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }]
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Monday", “Tuesday”, “Wednesday”, “Thursday”, “Friday”
            ],
            "hours": [
                17
            ],
            "minutes": [
                0
            ]
        }
    }
    }]
    ```
    
    В параметрах выше выполнение businessHoursProfile начинается в понедельник в 9:00 и длится до 17:00, так как это время запуска профиля nonBusinessHoursProfile. NonBusinessHoursProfile выполняется до 9:00 вторника, а затем запускается businessHoursProfile. Так будет до 17:00 пятницы. С этого времени профиль nonBusinessHoursProfile будет выполняться вплоть до 9:00 понедельника, так как businessHoursProfile будет не запускаться до 9:00 понедельника.
    
> [!Note]
> Автомасштабирование UX на портале Azure предусматривает время принудительного завершения для профилей повторения, после чего выполняется профиль параметров автомасштабирования по умолчанию между такими профилями.
    
## <a name="autoscale-evaluation"></a>Оценка автомасштабирования
В параметрах автомасштабирования может быть несколько профилей, в каждом из которых может содержаться несколько правил метрик, поэтому важно понимать, как оцениваются параметры. При каждом запуске задание автомасштабирования начинается с выбора приемлемого профиля, а затем происходит оценка минимального и максимального значений и правил метрик в профиле и применяется или не применяется действие масштабирования.

### <a name="which-profile-will-autoscale-pick"></a>Какой профиль выберет механизм автомасштабирования
- Автомасштабирование вначале будет искать любые профили с фиксированной датой, которая наступит сейчас, и если такой есть, выполняет его. Если есть несколько профилей, подлежащих выполнению, задание автомасштабирования выберет первый.
- При отсутствии профиля с фиксированной датой выполняется поиск профилей повторения, и если есть такой профиль, он будет выполнен.
- Если нет профиля с фиксированной датой или повторения, при автомасштабировании будет выполняться регулярный профиль.

### <a name="how-does-autoscale-evaluate-multiple-rules"></a>Как оцениваются несколько правил при автомасштабировании

Когда система автомастабирования определит, какой профиль следует выполнить, начинается оценка всех правил горизонтального масштабирования в нем (с параметром direction = "Increase").
- При активации одного или нескольких правил горизонтального масштабирования механизм автомасштабирования вычисляет новое значение емкости, определенное с помощью параметра scaleAction в каждом из этих правил. Затем происходит максимальное горизонтальное масштабирование емкости, чтобы обеспечить доступность службы.
- Пример. Есть масштабируемый набор виртуальных машин с текущим объемом, равным 10, и два правила горизонтального масштабирования: одно — увеличивающее объем на 10 %, а другое — на 3. После применения первого правила новое значение объема будет равно 11, а после второго — 13. Механизм автомасштабирования выберет действие, которое максимально увеличит объем, что соответствует второму правилу.

Если правила масштабирования не будут активированы, система автомасштабирования оценит все правила уменьшения масштаба (правила с параметром direction = "Decrease"). При автомасштабировании действие уменьшения объема выполняется, только если активированы все правила уменьшения масштаба.
- Механизм автомасштабирования вычисляет новое значение емкости, определенное с помощью параметра scaleAction в каждом из этих правил. Затем он выбирает действие масштабирования, максимально увеличивающее емкость, чтобы обеспечить доступность службы.
- Пример. Есть масштабируемый набор виртуальных машин с текущим объемом, равным 10, и два правила масштабирования: одно — увеличивающее объем на 50 %, а другое — на 3. После применения первого правила новое значение объема будет равно 5, а после второго — 7. Механизм автомасштабирования выберет действие, которое максимально увеличит объем, что соответствует второму правилу.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения об автомасштабировании см. в следующих статьях:

* [Обзор автомасштабирования](monitoring-overview-autoscale.md)
* [Общие метрики автомасштабирования Azure Monitor](insights-autoscale-common-metrics.md)
* [Рекомендации по автомасштабированию в Azure Monitor](insights-autoscale-best-practices.md)
* [Использование действий автомасштабирования для отправки электронной почты и уведомлений об оповещениях веб-перехватчика в Azure Insights](insights-autoscale-to-webhook-email.md)
* [Create or update an autoscale setting in Azure Insights REST API (Создание и изменение параметров автомасштабирования в REST API Azure Insights)](https://msdn.microsoft.com/library/dn931953.aspx)
