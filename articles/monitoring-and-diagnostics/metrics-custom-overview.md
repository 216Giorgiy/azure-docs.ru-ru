---
title: Пользовательские метрики в Azure Monitor
description: Сведения о пользовательских метриках в Azure Monitor и их моделировании.
author: ancav
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 09/24/2018
ms.author: ancav
ms.component: metrics
ms.openlocfilehash: c136772e27dab014c22234f1ef1d2baddd2ffe58
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46978086"
---
# <a name="custom-metrics-in-azure-monitor"></a>Пользовательские метрики в Azure Monitor

По мере развертывания ресурсов и приложений в Azure вы захотите начать собирать данные телеметрии, чтобы получить представление об их производительности и работоспособности. При развертывании ресурсов в Azure по умолчанию становятся доступны некоторые метрики. Это так называемые стандартные метрики, или метрики платформы. Однако по своей природе эти метрики ограничены. Вам может потребоваться собирать некоторые специальные индикаторы производительности или метрики, относящиеся к бизнесу, для более подробной аналитики.
Эти "пользовательские" метрики можно собирать из данных телеметрии приложений, из агента, работающего в ресурсах Azure, или даже из внешней системы мониторинга, а затем отправлять непосредственно в Azure Monitor. После публикации в Azure Monitor вы можете просматривать и запрашивать пользовательские метрики для приложений и ресурсов Azure, а также получать оповещения о них наряду со стандартными метриками Azure.

## <a name="send-custom-metrics"></a>Отправка пользовательских метрик
Пользовательские метрики можно отправлять в Azure Monitor различными способами.
- Инструментирование приложения с помощью пакета SDK Application Insights и отправка пользовательских данных телеметрии в Azure Monitor 
- Установка расширения диагностики Windows из [виртуальной машины Azure](metrics-store-custom-guestos-resource-manager-vm.md), [масштабируемого набора виртуальных машин](metrics-store-custom-guestos-resource-manager-vmss.md), [классической виртуальной машины](metrics-store-custom-guestos-classic-vm.md) или [классической облачной службы](metrics-store-custom-guestos-classic-cloud-service.md) и отправка счетчиков производительности в Azure Monitor 
- Установка [агента InfluxDB Telegraf](metrics-store-custom-linux-telegraf.md) на виртуальной машине Linux Azure и отправка метрики с помощью подключаемого модуля выходных данных Azure Monitor
- Отправка пользовательских метрик [непосредственно в REST API Azure Monitor](metrics-store-custom-rest-api.md) (https://<azureregion>.monitoring.azure.com/<AzureResourceID>/metrics)

При отправке пользовательских метрик в Azure Monitor каждая отправляемая точка данных (или значение) должна включать следующие сведения:

### <a name="authentication"></a>Authentication
При отправке пользовательских метрик в Azure Monitor объект, отправляющий метрику, должен содержать действительный маркер Azure Active Directory в заголовке Bearer запроса. Существует несколько поддерживаемых способов получить действительный маркер носителя:
1. [MSI (управляемое удостоверение службы)](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview). Предоставляет удостоверение самому ресурсу Azure (например, виртуальной машине). MSI предназначено для предоставления ресурсам разрешений на выполнение определенных операций, например отправки своих метрик. Ресурсу (или его MSI) можно предоставить разрешения "Издатель метрик мониторинга" для другого ресурса, позволяя MSI также отправлять метрики другим ресурсам.
2. [Субъект-служба AAD](https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals). В данном случае приложению (службе) AAD можно назначить разрешения на отправку метрик ресурса Azure.
Для проверки подлинности запроса Azure Monitor проверяет маркер приложения с помощью открытых ключей AAD. У имеющейся роли "Издатель метрик мониторинга" уже есть это разрешение, доступное на портале Azure. Субъекту-службе (в зависимости от того, для каких ресурсов будут отправляться пользовательские метрики) можно предоставить роль "Издатель метрик мониторинга" в необходимой области (подписке, группе ресурсов или определенном ресурсе).

> [!NOTE]
> Запрашивая маркер AAD для отправки пользовательских метрик, убедитесь, что он предназначен для аудитории или ресурса https://monitoring.azure.com/ (обязательно добавьте в конце символ "/").

### <a name="subject"></a>Субъект
Это свойство содержит ИД ресурса Azure, для которого предоставляется пользовательская метрика. Эти сведения будут закодированы в URL-адресе совершаемого вызова API. Каждый API может отправлять значения метрик для одного ресурса Azure.

> [!NOTE]
> Отправлять пользовательские метрики по ИД группы ресурсов или подписки невозможно.
>
>

### <a name="region"></a>Регион
В этом свойстве указывается регион Azure, где развертывается ресурс, для которого отправляются метрики. Метрики должны отправляться в конечную точку Azure Monitor того же региона, в котором развертывается ресурс. Например, пользовательские метрики для виртуальной машины, развернутой в регионе "Западная часть США", должны отправляться в конечную точку Azure Monitor региона "Западная часть США". Сведения о регионе также кодируются в URL-адресе вызова API.

> [!NOTE]
> В общедоступной ознакомительной версии пользовательские метрики доступны только в некоторых регионах Azure. Список поддерживаемых регионов представлен в последующем разделе этой статьи.
>
>

### <a name="timestamp"></a>Timestamp
Каждая точка данных, отправляемая в Azure Monitor, должна быть отмечена временной меткой. Эта временная метка содержит дату и время измерения или получения метрики. Azure Monitor принимает данные метрик с временными метками до 20 минут назад и до 5 минут вперед.

### <a name="namespace"></a>Пространство имен
При помощи пространств имен можно классифицировать или группировать похожие метрики. Они позволяют обеспечить изоляцию между группами метрик, которые смогут собирать разные аналитические сведения или индикаторы производительности. Например, у вас может быть пространство имен под названием *ContosoMemoryMetrics*, с помощью которого можно отслеживать метрики использования памяти приложением, и еще одно пространство имен под названием *ContosoAppTransaction*, отслеживающее все метрики пользовательских транзакций в приложении.

### <a name="name"></a>ИМЯ
Имя отправляемой метрики. Как правило, это имя является достаточно описательным, чтобы указать измеряемый показатель. Например, метрика, измеряющая количество байтов памяти, используемое на определенной виртуальной машине, может называться "Используемые байты памяти".

### <a name="dimension-keys"></a>Ключи измерений
Измерение — это пара "ключ-значение", помогающая описывать дополнительные характеристики собираемой метрики. С помощью дополнительных характеристик можно собирать больше данных о метрике, получая больше аналитических сведений. Например, у метрики "Используемые байты памяти" может быть ключ измерения под названием "Процесс", в котором указано, сколько байтов памяти использует каждый процесс на виртуальной машине. Это позволяет фильтровать метрику, чтобы узнать, сколько памяти используют определенные процессы, или получить список 5 процессов, использующих больше всего памяти.
У каждой пользовательской метрики может быть до 10 измерений.

### <a name="dimension-values"></a>Значения измерений
При отправке точки данных метрики каждому ключу измерения этой метрики соответствует значение измерения. Например, если вам нужно сообщить, сколько памяти использует ContosoApp на вашей виртуальной машине:

* имя метрики — *Используемые байты памяти*;
* ключ измерения — *Процесс*;
* значение измерения — *ContosoApp.exe*.

Публикуя значение метрики, можно указывать только по одному значению измерения на ключ. Собирая одни и те же данные об использовании памяти для нескольких процессов на виртуальной машине, вы можете отправить несколько значений метрик для этой временной метки. Каждое значение метрики задает отдельное значение измерения для ключа "Процесс".

### <a name="metric-values"></a>Значения метрик
При сохранении метрик Azure Monitor степень детализации составляет одну минуту. Мы понимаем, что метрику может потребоваться снять несколько раз (например, в случае использования ЦП) или измерить для множества отдельных событий (например, задержки транзакций входа) в течение одной минуты. Чтобы ограничить количество необработанных значений, которые требуется отправлять и оплачивать в Azure Monitor, вы можете заранее выполнить статистическое вычисление в локальной среде и выбрать такие значения:

* "Минимум" — минимальное наблюдаемое значение из всех образцов или измерений за минуту.
* "Максимум" — максимальное наблюдаемое значение из всех образцов или измерений за минуту.
* "Сумма" — сумма всех наблюдаемых значений из всех образцов или измерений за минуту.
* "Количество" — число образцов или измерений за минуту.

Допустим, за определенную минуту в приложении произошло 4 транзакции входа, в результате которых были получены следующие задержки:

|Транзакция 1|Транзакция 2|Транзакция 3|Транзакция 4|
|---|---|---|---|
|7 мс|4 мс|13 мс|16 мс|
|

Результаты публикации метрики в Azure Monitor будут следующими:
* "Минимум": 4;
* "Максимум": 16;
* "Сумма": 40;
* "Количество": 4.

Если приложение не может заранее выполнять статистическое вычисление в локальной среде и вынуждено отправлять каждый образец или событие сразу после сбора, то вы можете передавать необработанные значения показателей.
Например, при каждой транзакции входа в приложении вы будете публиковать метрику в Azure Monitor только с одним измерением. Таким образом, для транзакции входа, выполнение которой заняло 12 мс, будут опубликованы следующие результаты:
* "Минимум": 12;
* "Максимум": 12;
* "Сумма": 12;
* "Количество": 1.

С помощью этого процесса можно отправлять несколько значений для одного сочетания метрики и измерения за определенную минуту. Затем Azure Monitor соберет все необработанные значения, переданные за эту минуту, и выполнит статистическое вычисление.

### <a name="sample-custom-metric-publication"></a>Пример публикации пользовательской метрики
В приведенном ниже примере создается пользовательская метрика под названием "Используемые байты памяти" в пространстве имен "Профиль памяти" для виртуальной машины. У этой метрики есть одно измерение с именем "Процесс". Для определенной временной метки мы передаем значения метрики из двух процессов:

```json
{
    "time": "2018-08-20T11:25:20-7:00",
    "data": {

      "baseData": {

        "metric": "Memory Bytes in Use",
        "namespace": "Memory Profile",
        "dimNames": [
          "Process"        ],
        "series": [
          {
            "dimValues": [
              "ContosoApp.exe"
            ],
            "min": 10,
            "max": 89,
            "sum": 190,
            "count": 4
          },
          {
            "dimValues": [
              "SalesApp.exe"
            ],
            "min": 10,
            "max": 23,
            "sum": 86,
            "count": 4
          }
        ]
      }
    }
  }
```
> [!NOTE]
> Application Insights, расширение системы диагностики Windows Azure и агент InfluxData Telegraf уже настроены на отправку значений метрик в соответствующую региональную конечную точку, передавая все вышеуказанные свойства при каждой отправке.
>
>

## <a name="custom-metric-definitions"></a>Определения пользовательских метрик
Прежде чем отправлять пользовательскую метрику в Azure Monitor, ее не требуется заранее определять. Так как каждая публикуемая точка данных метрики содержит пространство имен, имя и сведения об измерениях, при первой отправке пользовательской метрики в Azure Monitor автоматически создается ее определение. Затем это определение метрики может быть обнаружено любым ресурсом, для которого эта метрика отправлялась посредством определений.

> [!NOTE]
> Azure Monitor пока не поддерживает определение единиц измерения для пользовательских метрик.

## <a name="using-custom-metrics"></a>Использование пользовательских метрик
После отправки пользовательских метрик в Azure Monitor вы можете просматривать их на портале Azure, запрашивать их через интерфейсы REST API Azure Monitor и создавать оповещения о них, чтобы узнавать о соблюдении определенных условий.
### <a name="browse-your-custom-metrics-via-the-azure-portal"></a>Просмотр пользовательских метрик на портале Azure
1.  Перейдите на [портал Azure](https://portal.azure.com).
2.  Выберите колонку "Монитор".
3.  Нажмите "Метрики".
4.  Выберите ресурс, для которого вы отправляли пользовательские метрики.
5.  Выберите пространство имен для пользовательской метрики.
6.  Выберите пользовательскую метрику.

## <a name="supported-regions"></a>Поддерживаемые регионы
В общедоступной ознакомительной версии возможность публиковать пользовательские метрики доступна только в некоторых регионах Azure. Это означает, что публиковать метрики можно только для ресурсов в одном из поддерживаемых регионов. В приведенной ниже таблице перечислены поддерживаемые регионы Azure для пользовательских метрик и соответствующие конечные точки, в которых следует публиковать метрики для ресурсов из этих регионов.

|Регион Azure|Префикс региональной конечной точки|
|---|---|
|Восточная часть США|https://eastus.monitoring.azure.com/|
|Центрально-южная часть США|https://southcentralus.monitoring.azure.com/|
|Западно-центральная часть США|https://westcentralus.monitoring.azure.com/|
|Западный регион США 2|https://westus2.monitoring.azure.com/|
|Юго-Восточная Азия|https://southeastasia.monitoring.azure.com/|
|Северная Европа|https://northeurope.monitoring.azure.com/|
|Западная Европа|https://westeurope.monitoring.azure.com/|

## <a name="quotas-and-limits"></a>Квоты и ограничения
Azure Monitor налагает указанные ниже ограничения на использование пользовательских метрик.

|Категория|Ограничение|
|---|---|
|Активные временные серии, подписки, регион|50 000|
|Ключи измерений на метрику|10|
|Длина строки для имен и пространств имен метрик, а также ключей и имен измерений|256 символов|
Активная временная серия — это уникальное сочетание метрики с ключом и значением измерения, содержащее значения метрик, опубликованные за последние 12 часов.

## <a name="next-steps"></a>Дополнительная информация
Использование пользовательских метрик из различных служб 
 - [Виртуальная машина](metrics-store-custom-guestos-resource-manager-vm.md)
 - [Масштабируемый набор виртуальных машин](metrics-store-custom-guestos-resource-manager-vmss.md)
 - [Виртуальная машина (классическая)](metrics-store-custom-guestos-classic-vm.md)
 - [Виртуальная машина Linux с агентом Telegraf](metrics-store-custom-linux-telegraf.md)
 - [REST API](metrics-store-custom-rest-api.md)
 - [Облачная служба (классическая)](metrics-store-custom-guestos-classic-cloud-service.md)
 