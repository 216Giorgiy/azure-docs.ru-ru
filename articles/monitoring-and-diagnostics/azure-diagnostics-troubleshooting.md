---
title: "Устранение неполадок системы диагностики Azure | Документация Майкрософт"
description: "Устранение неполадок при использовании системы диагностики Azure на виртуальных машинах, в Service Fabric или в облачных службах."
services: monitoring-and-diagnostics
documentationcenter: .net
author: rboucher
manager: carmonm
editor: 
ms.assetid: 66469bce-d457-4d1e-b550-a08d2be4d28c
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 03/28/2017
ms.author: robb
translationtype: Human Translation
ms.sourcegitcommit: 424d8654a047a28ef6e32b73952cf98d28547f4f
ms.openlocfilehash: 81f9a5a8e5ce8389c12a40eb02dd554fc140e009
ms.lasthandoff: 03/22/2017


---
# <a name="azure-diagnostics-troubleshooting"></a>Устранение неполадок с помощью системы диагностики Azure
Информация об устранении неполадок с помощью системы диагностики Azure. Дополнительные сведения о системе диагностики Azure см. в [обзоре системы диагностики Azure](azure-diagnostics.md).

## <a name="azure-diagnostics-is-not-starting"></a>Система диагностики Azure не запускается
Диагностика состоит из двух компонентов: подключаемого модуля гостевого агента и агента мониторинга. Сведения о том, почему диагностика не запускается, можно просмотреть в файлах журнала **DiagnosticsPluginLauncher.log** и **DiagnosticsPlugin.log**.  

В роли облачной службы файлы журнала подключаемого модуля гостевого агента расположены в следующей папке:

```
C:\Logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.7.4.0\
```

На виртуальной машине Azure файлы журнала подключаемого модуля гостевого агента расположены в следующей папке:

```
C:\Packages\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\1.7.4.0\Logs\
```

В последней строке файлов журнала указан код выхода.  

```
DiagnosticsPluginLauncher.exe Information: 0 : [4/16/2016 6:24:15 AM] DiagnosticPlugin exited with code 0
```

Подключаемый модуль возвращает следующие коды выхода:

| Код выхода | Описание |
| --- | --- |
| 0 |Успешно. |
| -1 |Общая ошибка. |
| -2 |Невозможно загрузить RCF-файл.<p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -3 |Не удалось загрузить файл конфигурации системы диагностики.<p><p>Решение. Это вызвано тем, что файл конфигурации не прошел проверку схемы. Следует предоставить файл конфигурации, соответствующий схеме. |
| -4 |Другой экземпляр системы диагностики агента мониторинга уже использует локальный каталог ресурсов.<p><p>Решение. Укажите другое значение для **LocalResourceDirectory**. |
| -6 |Попытка средства запуска подключаемого модуля гостевого агента запустить систему диагностики с помощью неправильно составленной команды.<p><p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -10 |Подключаемый модуль системы диагностики был завершен с необработанным исключением. |
| -11 |Гостевому агенту не удалось создать процесс, ответственный за запуск и мониторинг агента мониторинга.<p><p>Решение. Убедитесь, что доступных системных ресурсов достаточно для запуска новых процессов.<p> |
| -101 |Недопустимые аргументы при вызове подключаемого модуля системы диагностики.<p><p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -102 |Процесс подключаемого модуля не может инициализироваться.<p><p>Решение. Убедитесь, что доступных системных ресурсов достаточно для запуска новых процессов. |
| -103 |Процесс подключаемого модуля не может инициализироваться. А именно: не удается создать объект средства ведения журнала.<p><p>Решение. Убедитесь, что доступных системных ресурсов достаточно для запуска новых процессов. |
| -104 |Не удалось загрузить RCF-файл, предоставленный гостевым агентом.<p><p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -105 |Подключаемому модулю системы диагностики не удается открыть файл конфигурации системы диагностики.<p><p>Эта внутренняя ошибка возникает только тогда, когда подключаемый модуль системы диагностики вызван вручную, неправильно и на виртуальной машине. |
| -106 |Не удалось прочитать файл конфигурации системы диагностики.<p><p>Решение. Это вызвано тем, что файл конфигурации не прошел проверку схемы. Решением будет предоставить файл конфигурации, соответствующий схеме. Для виртуальной машины Azure файл конфигурации, переданный в расширение системы диагностики, можно найти в папке *%SystemDrive%\WindowsAzure\Config* на виртуальной машине. Откройте соответствующий XML-файл и выполните поиск **Microsoft.Azure.Diagnostics**, а затем найдите поле **xmlCfg** или **WadCfg**. Если вы видите поле WadCfg, то это означает, что файл конфигурации имеет формат JSON. Если вы видите поле xmlCfg, то это означает, что файл конфигурации имеет формат XML и кодировку Base64. Его необходимо декодировать, чтобы увидеть XML-файл, который был загружен системой диагностики. Для роли облачной службы файл конфигурации, переданный в расширение системы диагностики, можно найти в расположении C:\Packages\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.7.4.0\config.txt на виртуальной машине. Данные в кодировке base64, поэтому необходимо [раскодировать их](http://www.bing.com/search?q=base64+decoder), чтобы просмотреть данные XML, загруженные системой диагностики.<p> |
| -107 |Недопустимая передача каталога ресурсов в агент мониторинга.<p><p>Эта внутренняя ошибка может возникать, только если агент мониторинга вызван вручную, неправильно и на виртуальной машине.</p> |
| -108 |Не удалось преобразовать файл конфигурации системы диагностики в файл конфигурации агента мониторинга.<p><p>Эта внутренняя ошибка может возникать, только если подключаемый модуль системы диагностики вызван с помощью недопустимого файла конфигурации. |
| -110 |Общая ошибка конфигурации системы диагностики.<p><p>Эта внутренняя ошибка может возникать, только если подключаемый модуль системы диагностики вызван с помощью недопустимого файла конфигурации. |
| -111 |Не удалось запустить агент мониторинга.<p><p>Решение. Убедитесь, что доступен достаточный объем системных ресурсов. |
| -112 |Общая ошибка |

## <a name="diagnostics-data-is-not-logged-to-azure-storage"></a>Журнал данных диагностики не записывается в службу хранилища Azure
Данные диагностики Azure хранятся в службе хранилища Azure.

Наиболее распространенная причина недостающих данных событий — это некорректно определенная информация об учетной записи хранения.

Решение. Исправьте файл конфигурации системы диагностики и переустановите систему диагностики.
Если проблема повторится после переустановки расширения системы диагностики, то может потребоваться более тщательная отладка и просмотр ошибок агента мониторинга. До того, как данные событий передаются в вашу учетную запись хранения, они сохраняются в каталоге LocalResourceDirectory.
Путь к этому каталогу может отличаться.

Для ролей облачной службы:

    C:\Resources\Directory\<CloudServiceDeploymentID>.<RoleName>.DiagnosticStore\WAD<DiagnosticsMajorandMinorVersion>\Tables

Для виртуальных машин:

    C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<DiagnosticsVersion>\WAD<DiagnosticsMajorandMinorVersion>\Tables

Если в папке LocalResourceDirectory нет файлов, агент мониторинга не сможет запуститься. Обычно причина этого — недопустимый файл конфигурации. Это событие должно быть записано в файл CommandExecution.log.

Если агент мониторинга успешно собирает данные событий, то вы увидите TSF-файлы для каждого события, определенного в файле конфигурации. Агент мониторинга регистрирует обнаруженные ошибки в файле MaEventTable.tsf. Для изучения содержимого этого файла можно использовать приложение tabel2csv, чтобы преобразовать TSF-файл в файл значений, разделенных запятыми (CSV-файл):

В роли облачной службы:

    %SystemDrive%\Packages\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\<DiagnosticsVersion>\Monitor\x64\table2csv maeventtable.tsf

*% SystemDrive %* в роли облачной службы — обычно диск D:.

В виртуальной машине:

    C:\Packages\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<DiagnosticsVersion>\Monitor\x64\table2csv maeventtable.tsf

Приведенные выше команды создают файл журнала *maeventtable.csv*, который можно открыть, чтобы изучить сообщения о сбое.    

## <a name="diagnostics-data-tables-not-found"></a>Таблицы данных диагностики не найдены
Таблицы в службе хранилища Azure, содержащие данные диагностики Azure, именуются с помощью следующего кода:

```csharp
        if (String.IsNullOrEmpty(eventDestination)) {
            if (e == "DefaultEvents")
                tableName = "WADDefault" + MD5(provider);
            else
                tableName = "WADEvent" + MD5(provider) + eventId;
        }
        else
            tableName = "WAD" + eventDestination;
```

Пример:

```XML
        <EtwEventSourceProviderConfiguration provider=”prov1”>
          <Event id=”1” />
          <Event id=”2” eventDestination=”dest1” />
          <DefaultEvents />
        </EtwEventSourceProviderConfiguration>
        <EtwEventSourceProviderConfiguration provider=”prov2”>
          <DefaultEvents eventDestination=”dest2” />
        </EtwEventSourceProviderConfiguration>
```

Создается 4 таблицы:

| Событие | Имя таблицы |
| --- | --- |
| provider=”prov1” &lt;Event id=”1” /&gt; |WADEvent+MD5(“prov1”)+”1” |
| provider=”prov1” &lt;Event id=”2” eventDestination=”dest1” /&gt; |WADdest1 |
| provider=”prov1” &lt;DefaultEvents /&gt; |WADDefault+MD5(“prov1”) |
| provider=”prov2” &lt;DefaultEvents eventDestination=”dest2” /&gt; |WADdest2 |

