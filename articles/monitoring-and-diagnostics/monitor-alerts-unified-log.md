---
title: Оповещения журнала в Azure Monitor. Оповещения Azure (предварительная версия) | Документация Майкрософт
description: Узнайте, как активировать сообщения электронной почты и уведомления, вызывать URL-адреса веб-сайтов (использовать веб-перехватчики) или автоматизировать операции при выполнении заданных вами сложных условий запросов в предварительной версии интерфейса оповещений Azure.
author: msvijayn
manager: kmadnani1
editor: ''
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: f7457655-ced6-4102-a9dd-7ddf2265c0e2
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/02/2018
ms.author: vinagara
ms.openlocfilehash: 0cee8bf77e0facc12159b823152b8859ce5cedd8
ms.sourcegitcommit: 168426c3545eae6287febecc8804b1035171c048
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2018
---
# <a name="log-alerts-in-azure-monitor---alerts-preview"></a>Оповещения журнала в Azure Monitor. Оповещения Azure (предварительная версия)
Из этой статьи вы узнаете, как в предварительной версии интерфейса оповещений Azure работают правила генерации оповещений в запросах Analytics. Также здесь описаны различия между типами правил генерации оповещений журнала. См. дополнительные сведения об [использовании оповещений на основе метрик практически в реальном времени и журналов](monitoring-near-real-time-metric-alerts.md).

Сейчас предварительная версия интерфейса оповещений Azure поддерживает оповещения журнала в запросах из [Azure Log Analytics](../log-analytics/log-analytics-tutorial-viewdata.md) и [Application Insights](../application-insights/app-insights-cloudservices.md#view-azure-diagnostic-events).

> [!WARNING]

> Запросы между несколькими рабочими областями или несколькими приложениями в службе оповещений Azure (предварительная версия) сейчас не поддерживаются.

Кроме того, пользователи могут совершенствовать свои запросы на выбранной платформе аналитики в Azure и затем *импортировать их для использования в службе оповещений (предварительная версия), сохранив запрос*. Вот как это сделать:
- Для Application Insights. Перейдите на портал аналитики, проверьте запрос и его результаты. Затем сохраните его с уникальным именем в области *Общие запросы*.
- Для Log Analytics. Перейдите в область "Поиск по журналу", проверьте запрос и его результаты. Затем сохраните его с уникальным именем в любой категории.

Далее, при [создании оповещения журнала в службе оповещений (предварительная версия)"](monitor-alerts-unified-usage.md), сохраненный запрос отобразится в списке как тип сигнала **Log (Saved Query)** (Журнал (сохраненный запрос)), как показано в следующем примере: ![Сохраненный запрос, импортированный в службу оповещений](./media/monitor-alerts-unified/AlertsPreviewResourceSelectionLog-new.png).

> [!NOTE]
> При использовании сигнала **Log (Saved Query)** (Журнал (сохраненный запрос)) выполняется импорт в службу оповещений. Поэтому любые изменения, выполненные впоследствии в службе аналитики, не будут отражены в сохраненных правилах оповещений, и наоборот.

## <a name="log-alert-rules"></a>Правила генерации оповещений журнала

Оповещения, создаваемые в предварительной версии интерфейса оповещений Azure, автоматически выполняют регулярные запросы к журналу.  Если результаты запроса к журналу отвечают определенным условиям, создается запись оповещения. После этого правило может автоматически запустить одно или несколько действий, чтобы заранее уведомить вас об оповещении либо вызвать другой процесс, например отправку данных во внешнее приложение с помощью [веб-перехватчика на основе JSON](monitor-alerts-unified-log-webhook.md), используя [группы действий](monitoring-action-groups.md). В каждом типе правил генерации оповещений используется определенная логика выполнения этого анализа.

Правила генерации оповещений определяются следующими сведениями:

- **Запрос к журналу.**  Это запрос, который будет запускаться каждый раз при срабатывании правила генерации оповещений.  Определить, создается ли оповещение, можно с помощью записей, возвращаемых этим запросом.
- **Временное окно**.  Указывает диапазон времени для запроса.  Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени.  Временное окно может иметь любое значение от 5 до 1440 минут (или 24 часов). Например, если временное окно равно 60 минутам, а запрос выполняется в 13:15, то возвращаются только записи, созданные между 12:15 и 13:15.
- **Частота**.  Указывает, как часто должен выполняться запрос. Это значение может составлять от 5 минут до 24 часов. Оно должно быть меньше или равно временному окну.  Если значение больше, чем временное окно, появляется риск пропуска записей.<br>Например, рассмотрим временное окно в 30 минут и частоту в 60 минут.  Если запрос выполняется в 13:00, он возвращает записи между 12:30 и 13:00.  В следующий раз этот запрос будет выполнен в 14:00, а записи возвратятся между 13:30 и 14:00.  Записи, созданные между 13:00 и 13:30, не будут учитываться.
- **Пороговое значение**.  Чтобы определить, следует ли создавать оповещение, оцениваются результаты поиска по журналам.  Для каждого типа правил генерации оповещений определяется собственное пороговое значение.

Каждое правило генерации оповещений в Log Analytics относится к одному из двух типов.  Каждый из этих типов подробно описан в последующих разделах.

- **[Число результатов](#number-of-results-alert-rules)**. Если число записей, возвращенных в результатах поиска по журналам, превышает указанное количество, создается оповещение.
- **[Измерение метрик](#metric-measurement-alert-rules)**.  Оповещение, созданное для каждого объекта в результатах поиска по журналам со значением, превышающим указанное пороговое значение.

Ниже приведены различия между типами правил генерации оповещений.

- **Правило генерации оповещений "Число результатов" всегда создает одно оповещение, а правило **Измерение метрик** — по одному для каждого объекта, который превышает порог.
- Правило генерации оповещений **Число результатов** создает оповещение при одноразовом превышении порогового значения. Правило генерации оповещений **Измерение метрик** может создавать оповещение при превышении порогового значения определенное количество раз за указанный интервал времени.

## <a name="number-of-results-alert-rules"></a>Правило генерации оповещений "Число результатов"
Правила генерации оповещений **Число результатов** создают одно оповещение, если количество записей, возвращенных в результатах поискового запроса, превышает указанное пороговое значение. Этот тип правила генерации оповещений идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал, ответ веб-приложения и настраиваемые журналы.  Вам может потребоваться создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в определенном временном окне.

**Порог.** Порог для правил генерации оповещений **"Число результатов" больше или меньше определенного значения.  Если число записей, возвращенных в результатах поиска по журналам, соответствует этому критерию, создается оповещение.

Для оповещения об отдельном событии задайте количество результатов больше 0 и проверяйте наличие одного события, созданного с момента последнего выполнения запроса. Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае вам может потребоваться создавать оповещение только в случае возникновения нескольких событий за определенное временное окно.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного временного окна, следует создать оповещение.  В этом случае задайте для порога значение **меньше 1**.

### <a name="example"></a>Пример
Рассмотрим сценарий, где нужно узнать, когда веб-приложение предоставит пользователям ответ с кодом 500 ("Внутренняя ошибка сервера"). Необходимо создать правило генерации оповещений со следующими сведениями:  
**Запрос:** запросы | где resultCode == 500.<br>
**Временное окно:** 30 минут.<br>
**Частота предупреждений:** 5 минут.<br>
**Пороговое значение:** больше 0.<br>

После этого оповещение будет выполнять запрос каждые 5 минут с 30 минутами данных для поиска записей с кодом результата 500. Если будет найдена хотя бы одна такая запись, сработает оповещение и запустится настроенное действие.

## <a name="metric-measurement-alert-rules"></a>Metric measurement alert rules (Измерение метрики для правила генерации оповещений)

Правила генерации оповещений **Измерение метрик** создают оповещение для каждого объекта в запросе со значением, превышающим указанное пороговое значение.  Ниже приведены их четко выраженные отличия от правил генерации оповещений **Число результатов**.

**Агрегатная функция.** Определяет выполняемые вычисления и (необязательно) числовое поле для статистических вычислений.  Например, **count()** возвращает число записей в запросе, а **avg(CounterValue)** — среднее значение поля CounterValue в рамках указанного интервала.

> [!NOTE]

> Агрегатная функция в запросе должна называться AggregatedValue. Она указывает числовое значение. 


**Поле группы.** Для каждого экземпляра этого поля будет создана запись с агрегированным значением; для каждого поля можно создать оповещение.  Например, чтобы создать оповещение для каждого компьютера, используйте группировку **по компьютерам**.   

> [!NOTE]

> Для правил генерации оповещений "Измерение метрик" на основе Application Insights можно указать поле для группирования данных. Для этого в определении правила используйте параметр **Aggregate on** (Агрегирование по).   

**Интервал.** Определяет период, в течение которого выполняется статистическое вычисление данных.  Например, если вы указали значение **5 минут**, создается запись для каждого экземпляра поля группы, вычисленного с интервалом в 5 минут за период, указанный для оповещения.
> [!NOTE]
> В запросе необходимо использовать функцию Bin. Так как использование bin() может быть сопряжено с получением неравных интервалов времени, служба оповещений будет вместо нее использовать функцию bin_at с соответствующим временем в среде выполнения, чтобы гарантировать получение результатов с фиксированной запятой.

**Порог.** Порог для правил генерации оповещений "Измерение метрик" определяется на основе объединенного значения и числа нарушений.  Если любая точка данных в результатах поиска по журналам превышает это значение, она рассматривается как нарушение.  Когда число нарушений в результатах для любого объекта превышает указанное значение, для этого объекта создается оповещение.

#### <a name="example"></a>Пример
Рассмотрим ситуацию, где оповещение должно создаваться, когда использование процессора на компьютере превышает 90 % три раза в течение 30 минут.  Необходимо создать правило генерации оповещений со следующими сведениями:  

**Запрос:** Perf | where ObjectName == "Processor" and CounterName == "% Processor Time" | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5 m), Computer<br>
**Временное окно:** 30 минут.<br>
**Частота предупреждений:** 5 минут.<br>
**Объединенное значение:** больше 90.<br>
**Активировать оповещение на основе:** общее число нарушений, превышающее 5.<br>

Запрос вернет среднее значение для каждого компьютера с интервалом в 5 минут.  Этот запрос выполняется каждые 5 минут для данных, собранных в течение предыдущих 30 минут.  Ниже приведен пример данных для трех компьютеров.

![Результаты выполнения примера запроса](../log-analytics/media/log-analytics-alerts/metrics-measurement-sample-graph.png)

В этом примере отдельные оповещения создаются для компьютеров srv02 и srv03, так как за указанное временное окно они 3 раза превысили пороговое значение в 90 %.  Если значение параметра **Активировать оповещение на основе:** изменить на **Consecutive** (Последовательные нарушения), оповещение будет создано только для компьютера srv03, так как для него 3 раза подряд зафиксировано превышение порога.


## <a name="next-steps"></a>Дополнительная информация
* Общие сведения о [действиях веб-перехватчиков для оповещений журнала](monitor-alerts-unified-log-webhook.md)
* [Общие сведения об интерфейсе оповещений Azure (предварительная версия)](monitoring-overview-unified-alerts.md)
* Дополнительные сведения об [ использовании интерфейса оповещений Azure (предварительная версия)](monitor-alerts-unified-usage.md)
* Дополнительные сведения об [Application Insights](../application-insights/app-insights-analytics.md)
* Дополнительные сведения о [Log Analytics](../log-analytics/log-analytics-overview.md).    
