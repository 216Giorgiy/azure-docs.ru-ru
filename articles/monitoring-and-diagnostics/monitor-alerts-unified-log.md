---
title: Оповещения журнала в Azure Monitor. Интерфейс оповещений | Документация Майкрософт
description: Узнайте, как активировать сообщения электронной почты и уведомления, вызывать URL-адреса веб-сайтов (использовать веб-перехватчики) или автоматизировать операции при выполнении заданных вами условий запросов аналитики в интерфейсе оповещений Azure.
author: msvijayn
manager: kmadnani1
editor: ''
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: f7457655-ced6-4102-a9dd-7ddf2265c0e2
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/01/2018
ms.author: vinagara
ms.openlocfilehash: 8bf534177e8236a7d72d6dfdd4612b5f6f492b17
ms.sourcegitcommit: d28bba5fd49049ec7492e88f2519d7f42184e3a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2018
ms.locfileid: "34057327"
---
# <a name="log-alerts-in-azure-monitor---alerts"></a>Оповещения журнала в Azure Monitor. Интерфейс оповещений 
В это статье рассматриваются оповещения журнала — один из типов оповещений, которые поддерживаются в новом интерфейсе [оповещений Azure](monitoring-overview-unified-alerts.md) и позволяют пользователям применять платформу аналитики Azure в качестве основы для оповещений. См. дополнительные сведения об [использовании оповещений на основе метрик практически в реальном времени и журналов](monitoring-near-real-time-metric-alerts.md).


Оповещение журнала состоит из правил поиска по журналам, созданных для [Azure Log Analytics](../log-analytics/log-analytics-tutorial-viewdata.md) или [Application Insights](../application-insights/app-insights-cloudservices.md#view-azure-diagnostic-events).


## <a name="log-search-alert-rule---definition-and-types"></a>Правило генерации оповещений для поиска по журналам: определения и типы

Правила поиска по журналам создаются в интерфейсе оповещений Azure, чтобы указанные запросы к журналу автоматически выполнялись с регулярными интервалами.  Если результаты запроса к журналу отвечают определенным условиям, создается запись оповещения. Затем правило может автоматически выполнять одно или несколько действий с помощью [групп действий](monitoring-action-groups.md). 

Правила поиска по журналам определяются следующими сведениями:
- **Запрос к журналу.**  Это запрос, который будет запускаться каждый раз при срабатывании правила генерации оповещений.  Определить, создается ли оповещение, можно с помощью записей, возвращаемых этим запросом. Кроме того, запрос *Azure Application Insights* может включать [вызовы между приложениями](https://dev.applicationinsights.io/ai/documentation/2-Using-the-API/CrossResourceQuery) при условии, что у пользователя есть права доступа к внешним приложениям. 

    > [!IMPORTANT]
    > Поддержка [запроса между приложениями для Application Insights](https://dev.applicationinsights.io/ai/documentation/2-Using-the-API/CrossResourceQuery) реализована в предварительной версии — функции и пользовательский интерфейс могут быть изменены. Сейчас в интерфейсе оповещений Azure **не поддерживаются** [запросы между рабочими областями](https://dev.loganalytics.io/oms/documentation/3-Using-the-API/CrossResourceQuery) и [запросы между ресурсами для Log Analytics](../log-analytics/log-analytics-cross-workspace-search.md).

- **Период.**  Указывает диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, ago), используемую в запросе журнала. <br>*Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала возвращаются только записи, созданные между 12:15 и 13:15. Если в запросе журнала будет использована команда времени, например ago (7d), запрос журнала будет выполняться только для данных между 12:15 и 13:15 — как если бы данные существовали только за последние 60 минут. Данные за семь дней, как указано в запросе журнала, не будут выводиться.*
- **Частота**.  Указывает, как часто должен выполняться запрос. Это значение может составлять от 5 минут до 24 часов. Оно не должно превышать указанный период.  Если значение больше, чем указанный период, записи могут быть пропущены.<br>*Например, рассмотрим период в 30 минут и частоту в 60 минут.  Если запрос выполняется в 13:00, он возвращает записи между 12:30 и 13:00.  В следующий раз этот запрос будет выполнен в 14:00, а записи возвратятся между 13:30 и 14:00.  Записи, созданные между 13:00 и 13:30, не будут учитываться.*
- **Пороговое значение**.  Чтобы определить, следует ли создавать оповещение, оцениваются результаты поиска по журналам.  Для каждого типа правил генерации оповещений для поиска по журналам определяется собственное пороговое значение.

Правила поиска по журналам могут быть двух типов (как для [Azure Log Analytics](../log-analytics/log-analytics-tutorial-viewdata.md), так и для [Application Insights](../application-insights/app-insights-cloudservices.md#view-azure-diagnostic-events)). Каждый из этих типов подробно описан в последующих разделах.

- **[Число результатов](#number-of-results-alert-rules)**. Если число записей, возвращенных в результатах поиска по журналам, превышает указанное количество, создается оповещение.
- **[Измерение метрик](#metric-measurement-alert-rules)**.  Оповещение, созданное для каждого объекта в результатах поиска по журналам со значением, превышающим указанное пороговое значение.

Ниже приведены различия между типами правил генерации оповещений.

- Правило генерации оповещений *Число результатов* всегда создает одно оповещение, а правило *Измерение метрик* — по одному для каждого объекта, который превышает порог.
- Правило генерации оповещений *Число результатов* создает оповещение при одноразовом превышении порогового значения. Правило генерации оповещений *Измерение метрик* может создавать оповещение при превышении порогового значения определенное количество раз за указанный интервал времени.

### <a name="number-of-results-alert-rules"></a>Правило генерации оповещений "Число результатов"
Правила генерации оповещений **Число результатов** создают одно оповещение, если количество записей, возвращенных в результатах поискового запроса, превышает указанное пороговое значение. Этот тип правила генерации оповещений идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал, ответ веб-приложения и настраиваемые журналы.  Возможно, вам потребуется создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в течение определенного периода.

**Порог.** Порог для правил генерации оповещений "Число результатов" больше или меньше определенного значения.  Если число записей, возвращенных в результатах поиска по журналам, соответствует этому критерию, создается оповещение.

Для оповещения об отдельном событии задайте количество результатов больше 0 и проверяйте наличие одного события, созданного с момента последнего выполнения запроса. Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае, возможно, вам потребуется создавать оповещение только в случае возникновения нескольких событий за определенный период.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного периода, следует создать оповещение.  В этом случае задайте для порога значение **меньше 1**.

#### <a name="example"></a>Пример
Рассмотрим сценарий, где нужно узнать, когда веб-приложение предоставит пользователям ответ с кодом 500 ("Внутренняя ошибка сервера"). Необходимо создать правило генерации оповещений со следующими сведениями:  
- **Запрос:** запросы | где resultCode == 500.<br>
- **Период:** 30 минут.<br>
- **Частота предупреждений:** 5 минут.<br>
- **Пороговое значение:** больше 0.<br>

После этого оповещение будет выполнять запрос каждые 5 минут с 30 минутами данных для поиска записей с кодом результата 500. Если будет найдена хотя бы одна такая запись, сработает оповещение и запустится настроенное действие.

### <a name="metric-measurement-alert-rules"></a>Metric measurement alert rules (Измерение метрики для правила генерации оповещений)

- Правила генерации оповещений **Измерение метрик** создают оповещение для каждого объекта в запросе со значением, превышающим указанное пороговое значение.  Ниже приведены их четко выраженные отличия от правил генерации оповещений **Число результатов**.
- **Агрегатная функция.** Определяет выполняемые вычисления и (необязательно) числовое поле для статистических вычислений.  Например, **count()** возвращает число записей в запросе, а **avg(CounterValue)** — среднее значение поля CounterValue в рамках указанного интервала. Агрегатная функция в запросе должна называться AggregatedValue. Она указывает числовое значение. 
- **Поле группы.** Для каждого экземпляра этого поля будет создана запись с агрегированным значением; для каждого поля можно создать оповещение.  Например, чтобы создать оповещение для каждого компьютера, используйте группировку **по компьютерам**. 

    > [!NOTE]
    > Для правил генерации оповещений "Измерение метрик" на основе Application Insights можно указать поле для группирования данных. Для этого в определении правила используйте параметр **Aggregate on** (Агрегирование по).   
    
- **Интервал.** Определяет период, в течение которого выполняется статистическое вычисление данных.  Например, если вы указали значение **5 минут**, создается запись для каждого экземпляра поля группы, вычисленного с интервалом в 5 минут за период, указанный для оповещения.

    > [!NOTE]
    > В запросе для указания интервала необходимо использовать функцию Bin. Так как при использовании bin() можно получить неравные интервалы времени, интерфейс оповещений будет автоматически преобразовывать команду bin в команду bin_at с соответствующим временем выполнения, чтобы гарантировать получение результатов с фиксированной запятой.
    
- **Порог.** Порог для правил генерации оповещений "Измерение метрик" определяется на основе объединенного значения и числа нарушений.  Если любая точка данных в результатах поиска по журналам превышает это значение, она рассматривается как нарушение.  Когда число нарушений в результатах для любого объекта превышает указанное значение, для этого объекта создается оповещение.

#### <a name="example"></a>Пример
Рассмотрим ситуацию, где оповещение должно создаваться, когда использование процессора на компьютере превышает 90 % три раза в течение 30 минут.  Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос:** Perf | where ObjectName == "Processor" and CounterName == "% Processor Time" | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5 m), Computer<br>
- **Период:** 30 минут.<br>
- **Частота предупреждений:** 5 минут.<br>
- **Объединенное значение:** больше 90.<br>
- **Активировать оповещение на основе:** общее число нарушений, превышающее 2.<br>

Запрос вернет среднее значение для каждого компьютера с интервалом в 5 минут.  Этот запрос выполняется каждые 5 минут для данных, собранных в течение предыдущих 30 минут.  Ниже приведен пример данных для трех компьютеров.

![Результаты выполнения примера запроса](./media/monitor-alerts-unified/metrics-measurement-sample-graph.png)

В этом примере отдельные оповещения создаются для компьютеров srv02 и srv03, так как за указанный период они 3 раза превысили пороговое значение в 90 %.  Если значение параметра **Активировать оповещение на основе:** изменить на **Consecutive** (Последовательные нарушения), оповещение будет создано только для компьютера srv03, так как для него 3 раза подряд зафиксировано превышение порога.


## <a name="log-search-alert-rule---creation-and-modification"></a>Правило генерации оповещений для поиска по журналам: создание и изменение

Оповещение журнала, а также соответствующее правило генерации оповещений можно просмотреть, создать или изменить в следующих расположениях:
- Портал Azure
- интерфейсы REST API (в том числе через PowerShell);
- Шаблоны Azure Resource Manager

### <a name="azure-portal"></a>Портал Azure
С появлением [нового интерфейса оповещений Azure](monitoring-overview-unified-alerts.md) пользователи могут управлять всеми типами оповещений на портале Azure из единого расположений с помощью аналогичных действий. См. дополнительные сведения об [использование нового интерфейса оповещений Azure](monitor-alerts-unified-usage.md).

Кроме того, пользователи могут совершенствовать свои запросы на выбранной платформе аналитики в Azure и затем *импортировать их для использования в интерфейсе оповещений, сохранив запрос*. Вот как это сделать:
- *Для Application Insights.* Перейдите на портал аналитики, проверьте запрос и его результаты. Затем сохраните его с уникальным именем в области *Общие запросы*.
- *Для Log Analytics.* Перейдите к области "Поиск по журналу", проверьте запрос и его результаты. Затем сохраните его с уникальным именем в любой категории.

В дальнейшем при [создании оповещения журнала в интерфейсе оповещений](monitor-alerts-unified-usage.md) сохраненный запрос отобразится в списке как тип сигнала **Log (Saved Query)** (Журнал (сохраненный запрос)), как показано в следующем примере: ![Сохраненный запрос, импортированный в интерфейс оповещений](./media/monitor-alerts-unified/AlertsPreviewResourceSelectionLog-new.png).

> [!NOTE]
> При использовании сигнала **Log (Saved Query)** (Журнал (сохраненный запрос)) выполняется импорт в службу оповещений. Поэтому любые дальнейшие изменения, внесенные в службе аналитики, не будут отражены в правилах генерации оповещений для поиска по журналам, и наоборот.

### <a name="rest-apis"></a>Интерфейсы API REST
API-интерфейсы, предоставляемые для оповещений журнала, относятся к категории RESTful. К ним можно получить доступ с помощью REST API Azure Resource Manager, то есть через PowerShell, а также с помощью других способов использования API-интерфейсов.

Подробные сведения и примеры использования REST API, см. в следующих документах:
- [REST API оповещений в Log Analytics](../log-analytics/log-analytics-api-alerts.md) — для создания и администрирования правил генерации оповещений для поиска по журналам в Azure Log Analytics.
- [REST API правил запросов Azure Monitor по расписанию](https://docs.microsoft.com/en-us/rest/api/monitorr/scheduledqueryrules/) — для создания и администрирования правил генерации оповещений для поиска по журналам в Azure Application Insights.

### <a name="azure-resource-manager-template"></a>Шаблон Azure Resource Manager
Воспользуйтесь гибкими возможностями [Azure Resource Manager](../azure-resource-manager/resource-group-overview.md) для создания или обновления оповещений журнала.

Подробные сведения, а также примеры использования шаблонов Resource Manager, см. в следующих документах:
- [Управление сохраненными поисковыми запросами и оповещениями](monitor-alerts-unified-log-template.md#managing-log-alert-on-log-analytics) — для оповещений журнала на основе Azure Log Analytics.
- [Правило запланированных запросов](monitor-alerts-unified-log-template.md#managing-log-alert-on-application-insights) — для оповещений журнала на основе Azure Application Insights
 

## <a name="next-steps"></a>Дополнительная информация
* сведения об [оповещениях журналов в Azure](monitor-alerts-unified-log-webhook.md);
* сведения о новом интерфейсе [оповещений Azure](monitoring-overview-unified-alerts.md);
* Дополнительные сведения об [Application Insights](../application-insights/app-insights-analytics.md).
* Дополнительные сведения о [Log Analytics](../log-analytics/log-analytics-overview.md).    
