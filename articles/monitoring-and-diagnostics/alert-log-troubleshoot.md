---
title: Устранение неполадок с оповещениями журналов в Azure Monitor
description: Распространенные проблемы, ошибки и методы их устранения для правил генерации оповещений журналов в Azure.
author: msvijayn
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 10/29/2018
ms.author: vinagara
ms.component: alerts
ms.openlocfilehash: 5572c80879584e7f6df650263ae455a134ee4088
ms.sourcegitcommit: ba4570d778187a975645a45920d1d631139ac36e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2018
ms.locfileid: "51283603"
---
# <a name="troubleshooting-log-alerts-in-azure-monitor"></a>Устранение неполадок с оповещениями журналов в Azure Monitor  

## <a name="overview"></a>Обзор
В этой статье показано, как обрабатывать распространенные проблемы, встречающиеся при настройке оповещений журналов в Azure Monitor. Также здесь приведены ответы на часто задаваемые вопросы о работе и настройке оповещений журналов. Термин **оповещения журнала**, который используется для описания оповещений, где сигналом является пользовательский запрос, основан на [Log Analytics](../log-analytics/log-analytics-tutorial-viewdata.md) или [Application Insights](../application-insights/app-insights-analytics.md). Дополнительные сведения о функциях, терминологии и типах см. в статье [Оповещения журнала в Azure Monitor. Интерфейс оповещений](monitor-alerts-unified-log.md).

> [!NOTE]
> В этой статье не рассматриваются случаи, когда правило генерации оповещений отображается на портале Azure как активированное и отправляет уведомление через связанные группы действий. В таких случаях см. сведения о [группах действий](monitoring-action-groups.md).


## <a name="log-alert-didnt-fire"></a>Оповещение журналов не срабатывает

Ниже приведены распространенные причины того, что [правило генерации оповещений журналов в Azure Monitor](alert-log.md) не отображается в [оповещениях Azure](monitoring-alerts-managing-alert-states.md) как активированное, хотя вы ожидаете его срабатывания. 

### <a name="data-ingestion-time-for-logs"></a>Время приема данных для журналов
Оповещения журналов периодически выполняют предоставленные клиентом запросы через [Log Analytics](../log-analytics/log-analytics-tutorial-viewdata.md) или [Application Insights](../application-insights/app-insights-analytics.md). Обе эти службы основаны на функциях службы Analytics, которая обрабатывает огромные объемы данных журналов и выполняет для них соответствующие функции. Так как служба Log Analytics постоянно обрабатывает много терабайт данных от тысяч клиентов и множества источников, распределенных по всему миру, в ее работе часто происходят задержки. См. дополнительные сведения о [времени приема данных в Log Analytics](../log-analytics/log-analytics-data-ingestion-time.md).

Чтобы устранить задержку в приеме данных, которая может возникать в журналах Log Analytics или Application Insights, оповещения журналов выполняют циклы ожидания и повторных попыток, не находя принятые данные за указанный период оповещений. Оповещения журналов используют заданное время ожидания, которое экспоненциально увеличивается, чтобы гарантировать получение нужных данных в Log Analytics. По этой причине если для журналов, запрашиваемых правилом генерации оповещений, наблюдается задержка приема данных, этот журнал оповещений будет активирован, когда соответствующие данные поступят в Log Analytics после приема и когда завершится очередной период экспоненциально увеличивающейся задержки из-за того, что служба оповещений журналов уже выполнила несколько повторных попыток.

### <a name="incorrect-time-period-configured"></a>Неправильно настроен период времени
Как описано в статье с [терминологией для оповещений журналов](monitor-alerts-unified-log.md#log-search-alert-rule---definition-and-types), настроенный в конфигурации период времени определяет диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в указанный период времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, ago), используемую в запросе журнала. 
*Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала возвращаются только записи, созданные между 12:15 и 13:15. Если в запросе журнала есть команда, связанная со временем, например ago (1d), запрос будет учитывать только период между 12:15 и 13:15, как если бы данные существовали только последние 60 минут. Данные за семь дней, как указано в запросе журнала, не будут выводиться.*

На основе логики запроса проверьте, правильно ли настроен период времени в конфигурации. Для описанного выше примера, где используется команда ago (1d), как отмечено зеленым маркером, период времени должен составлять 24 часа (1440 минут, как указано красным цветом), чтобы результат выполнения такого запроса соответствовал ожиданиям.
    ![Период времени](./media/monitor-alerts-unified/LogAlertTimePeriod.png)

### <a name="suppress-alerts-option-is-set"></a>Настроена отмена вывода оповещений
Как описано в шаге 8 в руководстве по [созданию правила генерации оповещений журналов на портале Azure](alert-log.md#managing-log-alerts-from-the-azure-portal), такие оповещения позволяют настроить автоматическое игнорирование правил генерации оповещений, то есть отключить уведомления и (или) триггеры на некоторый период времени. Применение параметра игнорирования оповещений приводит к тому, что выполнение оповещения журналов не приводит к активации группы действий в течение времени, указанного в параметре **Отключить оповещения**. Пользователь может подумать, что оповещение не срабатывает, хотя оно просто отключено в настройках.
    ![Отключить оповещения](./media/monitor-alerts-unified/LogAlertSuppress.png)

### <a name="metric-measurement-alert-rule-is-incorrect"></a>Неправильно настроено правило генерации оповещений "Измерение метрик"
Тип правил генерации оповещений "Измерение метрик" — это подтип оповещений журналов с некоторыми специальными возможностями и дополнительными ограничениями синтаксиса запроса для оповещений. Правило генерации оповещений журналов "Измерение метрик" требует, чтобы выходные данные запроса предоставляли временные ряды метрик, то есть таблицу с равномерно распределенными периодами времени и значениями AggregatedValue, вычисленными для этих периодов. Кроме того, пользователи могут настроить для таблицы кроме AggregatedValue дополнительные переменные, например Computer, Node и т. п., по которым будут сортироваться данные в этой таблице.

Предположим, что мы настроили такое правило генерации оповещений журнала с типом "Измерение метрик", как показано ниже:
- выполняемый запрос: `search *| summarize AggregatedValue = count() by $table, bin(timestamp, 1h)`;  
- период времени: 6 часов;
- пороговое значение: 50;
- логика оповещений: три последовательных нарушения;
- статистическое выражение (Aggregate Upon): $table.

В этом случае так как в команде выполняется вычисление итогов (summarize... by) и указаны две переменные timestamp и $table, служба оповещений выберет $table в качестве целевой переменной для статистического выражения (Aggregate Upon). В итоге таблица результатов будет отсортирована по полю $table, как показано ниже, и по этим результатам будет выполнена проверка значений AggregatedValue для каждой таблицы (например, availabilityResults) в поисках трех и более последовательных нарушений.

   ![Запрос "Измерение метрик" для нескольких значений](./media/monitor-alerts-unified/LogMMQuery.png)

Так как для статистического выражения (Aggregate Upon) выбрано значение $table, данные сортируются по столбцу $table (обозначено красным цветом) и группируются, после чего по поле Aggregate Upon (т. е. $table) выполняется поиск типов. Например, все значения для availabilityResults будут считаться одним графиком (сущностью), как обозначено оранжевым цветом. Именно по этому графику (сущности) служба уведомлений ищет три последовательных нарушения (как обозначено зеленым цветом), по которым и будут активированы уведомления для значения таблицы availabilityResults. Аналогичным образом, если будут обнаружены три последовательных нарушения для любого другого значения $table, для них создается дополнительное уведомление с автоматической сортировкой значений каждого графика (сущности) по времени, как показано оранжевым цветом.

Теперь предположим, что для этого правила генерации оповещений "Измерение метрик" мы указали запрос `search *| summarize AggregatedValue = count() by bin(timestamp, 1h)`, но сохранили все остальные настройки, в том числе логику оповещений при трех последовательных нарушениях. В этом случае для параметра Aggregate Upon будет выбрано значение по умолчанию timestamp. Так как в запросе для суммирования (summarize…by) выбирается только одно значение, и теперь это будет значение timestamp, выходные данные этого запроса будут выглядеть так, как показано ниже. 

   ![Выполнение запроса "Измерение метрик" для одного значения](./media/monitor-alerts-unified/LogMMtimestamp.png)

Так как у параметра Aggregate Upon значение timestamp, данные сортируются по столбцу timestamp (как показано красным цветом), а затем группируются по полю timestamp. В результате значения `2018-10-17T06:00:00Z` будут рассматриваться как один график (сущность), как показано оранжевым цветом. По этому графику (сущности) служба оповещений не сможет обнаружить три последовательных нарушения, так как для каждого значения отметки времени предоставлена только одна запись, а значит оповещение никогда не будет активировано. В таком случае у пользователя есть несколько вариантов:
- добавить фиктивную переменную или применить существующую переменную (например, $table), чтобы настроить правильную сортировку с помощью поля Aggregate Upon;
- изменить правило генерации оповещений так, чтобы использовать правильную логику оповещений по полю *total breach*.
 
## <a name="log-alert-fired-unnecessarily"></a>Оповещение журналов срабатывает без необходимости
Ниже приведены распространенные причины того, что [правило генерации оповещений журналов в Azure Monitor](alert-log.md) отображается в [оповещениях Azure](monitoring-alerts-managing-alert-states.md) как активированное, хотя вы не ожидаете его срабатывания.

### <a name="alert-triggered-by-partial-data"></a>Предупреждение активируется по частичным данным
Log Analytics и Application Insights основываются на службе аналитики, работа которой характеризуется задержками при приеме и обработке данных. Это означает, что на момент выполнения запроса для оповещения журналов нужные данные могут отсутствовать или быть неполными. См. дополнительные сведения о [времени приема данных в Log Analytics](../log-analytics/log-analytics-data-ingestion-time.md).

В зависимости от настройки правила генерации оповещений могут происходить ложные срабатывания, если на момент выполнения запроса оповещений данные отсутствуют или являются неполными. В таких случаях следует изменить запрос или конфигурацию для оповещения. *Например, если правило генерации оповещений журнала должно активироваться при малом количестве результатов в запросе (скажем, менее 5), оно будет срабатывать и при отсутствии данных (нуль записей) или наличии неполных данных (одна запись). Если бы тот же запрос выполнялся в службе Analytics после ожидания задержки приема, он возвращал бы 10 записей.*

### <a name="alert-query-output-misunderstood"></a>Неправильная интерпретация выходных данных запроса оповещения
Логика генерации оповещений журналов предоставляется пользователем в форме аналитического запроса. Этот аналитический запрос может использовать возможности больших данных и математические функции, чтобы создавать определенные конструкции. Служба оповещений выполняет предоставленный клиентом запрос с указанной периодичностью по данным в указанный период времени. Служба оповещений в зависимости от выбранного типа оповещений вносит в запрос незначительные изменения, которые отображаются в разделе с выполняемыми запросами на экране настройки логики сигнала, как показано ниже: ![Выполняемый запрос](./media/monitor-alerts-unified/LogAlertPreview.png)
 
Служба оповещений будет выполнять именно тот запрос, который отображается в поле **Выполняемый запрос**. Пользователь может запустить этот запрос с указанным интервалом времени, используя [портал Analytics](../log-analytics/log-analytics-log-search-portals.md) или [API Analytics](https://docs.microsoft.com/rest/api/loganalytics/), если нужно проверить результаты запроса до создания оповещения.
 
## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения см. в статье [Оповещения журнала в Azure Monitor. Интерфейс оповещений](monitor-alerts-unified-log.md).
* Дополнительные сведения об [Application Insights](../application-insights/app-insights-analytics.md)
* Дополнительные сведения о [Log Analytics](../log-analytics/log-analytics-queries.md). 