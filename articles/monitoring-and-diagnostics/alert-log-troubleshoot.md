---
title: Устранение неполадок с оповещениями журналов в Azure Monitor
description: Распространенные проблемы, ошибки и методы их устранения для правил генерации оповещений журналов в Azure.
author: msvijayn
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 10/29/2018
ms.author: vinagara
ms.component: alerts
ms.openlocfilehash: e2326f56ad367f744bc7895bc8c4bfd6f32d0310
ms.sourcegitcommit: fa758779501c8a11d98f8cacb15a3cc76e9d38ae
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2018
ms.locfileid: "52264885"
---
# <a name="troubleshooting-log-alerts-in-azure-monitor"></a>Устранение неполадок с оповещениями журналов в Azure Monitor  
## <a name="overview"></a>Обзор
В этой статье показано, как разрешать распространенные проблемы, встречающиеся при настройке оповещений журналов в Azure Monitor. Здесь также приведены ответы на часто задаваемые вопросы о работе и настройке оповещений журналов. 

Термин **оповещения журнала**, который используется для описания оповещений, которые основаны на пользовательском запросе в [Log Analytics](../log-analytics/log-analytics-tutorial-viewdata.md) или [Application Insights](../application-insights/app-insights-analytics.md). Дополнительные сведения о функциях, терминологии и типах см. в статье [Оповещения журнала в Azure Monitor](monitor-alerts-unified-log.md).

> [!NOTE]
> В этой статье не рассматриваются случаи, когда правило генерации оповещений отображается на портале Azure как активированное и отправляет уведомление через связанные группы действий. В таких случаях см. сведения о [группах действий](monitoring-action-groups.md).


## <a name="log-alert-didnt-fire"></a>Оповещение журналов не срабатывает

Ниже приведены некоторые распространенные причины, почему настроенное [правило оповещения журнала в Azure Monitor](alert-log.md) не отображает состояние [как *Инициировано* в предполагаемое время](monitoring-alerts-managing-alert-states.md). 

### <a name="data-ingestion-time-for-logs"></a>Время приема данных для журналов
Оповещения журналов периодически выполняют запросы через [Log Analytics](../log-analytics/log-analytics-tutorial-viewdata.md) или [Application Insights](../application-insights/app-insights-analytics.md). Так как Log Analytics обрабатывает много терабайт данных от тысяч клиентов и множества источников, распределенных по всему миру, в ее работе часто происходят различные задержки. См. дополнительные сведения о [времени приема данных в Log Analytics](../log-analytics/log-analytics-data-ingestion-time.md).

Чтобы избежать задержки приема данных, система ждет и повторяет запрос предупреждения несколько раз, если обнаруживает, что необходимые данные еще не поступают. Система имеет экспоненциально возрастающее время ожидания. Предупреждение о регистрации журнала запускается только после того, как данные доступны, поэтому они могут задерживаться из-за медленного приема данных журнала. 

### <a name="incorrect-time-period-configured"></a>Неправильно настроен период времени
Как описано в статье с [терминологией для оповещений журналов](monitor-alerts-unified-log.md#log-search-alert-rule---definition-and-types), настроенный в конфигурации период времени определяет диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в указанный период времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, ago), используемую в запросе журнала. 
*Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала используются только записи, созданные между 12:15 и 13:15. Если журнал запроса использует команду времени *ago (1d)*, запрос будет по прежнему использовать данные в диапазоне 12:15 и 1:15, так как в интервале задан этот период времени.*

Таким образом проверка этого периода времени в конфигурации соответствует условиям. Для описанного выше примера, где используется команда *ago (1d)*, как отмечено зеленым маркером, период времени должен составлять 24 часа (1440 минут, как указано красным цветом), чтобы результат выполнения такого запроса выполнятся, как ожидается.

![Период времени](./media/monitor-alerts-unified/LogAlertTimePeriod.png)

### <a name="suppress-alerts-option-is-set"></a>Настроена отмена вывода оповещений
Как описано в шаге 8 о создании [правил генерации оповещений для поиска по журналам на портале Azure](alert-log.md#managing-log-alerts-from-the-azure-portal), оповещения журнала содержат параметр **отключения оповещений**, отключающий действия оповещения и уведомления в течении заданного времени. Таким образом, может показаться, что оповещения не срабатывают, хотя на самом деле они были отключены.  

![Отключение оповещений](./media/monitor-alerts-unified/LogAlertSuppress.png)

### <a name="metric-measurement-alert-rule-is-incorrect"></a>Неправильно настроено правило генерации оповещений "Измерение метрик"
**Оповещения журнала измерения метрик** являются подтипом оповещений журнала, которые обладают специальными возможностями и ограниченным синтаксисом запроса оповещений. Правило генерации оповещений журналов "Измерение метрик" требует, чтобы выходные данные запроса предоставляли временные ряды метрик, то есть таблицу с равномерно распределенными периодами времени и агрегированными значениями. Кроме того, пользователи могут настроить дополнительные переменные в таблице наряду с AggregatedValue. Эти переменные могут использоваться для сортировки таблицы. 

Предположим, что мы настроили такое правило генерации оповещений журнала с типом "Измерение метрик", как показано ниже:
- выполняемый запрос: `search *| summarize AggregatedValue = count() by $table, bin(timestamp, 1h)`;  
- период времени: 6 часов;
- пороговое значение: 50;
- логика оповещений: три последовательных нарушения;
- статистическое выражение (Aggregate Upon): $table.

Так как команда содержит *summarize … by* и предоставляет две переменные (timestamp и $table), система выберет $table в качестве целевой переменной для статистического выражения (Aggregate Upon). В итоге таблица результатов будет отсортирована по полю *$table*, как показано ниже, и по этим результатам будет выполнена проверка значений AggregatedValue для каждой таблицы (например, availabilityResults) в поисках 3 и более последовательных нарушений.

![Запрос "Измерение метрик" для нескольких значений](./media/monitor-alerts-unified/LogMMQuery.png)

Так как для статистического выражения (Aggregate Upon) выбрано значение $table, данные сортируются по столбцу $table (обозначено красным цветом) и группируются, после чего по поле Aggregate Upon (т. е. $table) выполняется поиск типов. Например, все значения для availabilityResults будут считаться одним графиком (сущностью), как обозначено оранжевым цветом. Именно по этому графику (сущности) служба уведомлений ищет три последовательных нарушения (как обозначено зеленым цветом), по которым и будут активированы уведомления для значения таблицы availabilityResults. Аналогичным образом, если будут обнаружены три последовательных нарушения для любого другого значения $table, для них создается дополнительное уведомление с автоматической сортировкой значений каждого графика (сущности) по времени, как показано оранжевым цветом.

Теперь предположим, что для этого правила генерации оповещений "Измерение метрик" мы указали запрос `search *| summarize AggregatedValue = count() by bin(timestamp, 1h)`, но сохранили все остальные настройки, в том числе логику оповещений при трех последовательных нарушениях. В этом случае для параметра Aggregate Upon будет выбрано значение по умолчанию timestamp. Так как в запросе для суммирования (summarize…by) выбирается только одно значение, и теперь это будет значение timestamp, выходные данные этого запроса будут выглядеть так, как показано ниже. 

   ![Выполнение запроса "Измерение метрик" для одного значения](./media/monitor-alerts-unified/LogMMtimestamp.png)

Так как у параметра Aggregate Upon значение timestamp, данные сортируются по столбцу timestamp (как показано красным цветом), а затем группируются по полю timestamp. В результате значения `2018-10-17T06:00:00Z` будут рассматриваться как один график (сущность), как показано оранжевым цветом. По этому графику (сущности) служба оповещений не сможет обнаружить три последовательных нарушения, так как для каждого значения отметки времени предоставлена только одна запись, а значит оповещение никогда не будет активировано. В таком случае у пользователя есть несколько вариантов:
- добавить фиктивную переменную или применить существующую переменную (например, $table), чтобы настроить правильную сортировку с помощью поля Aggregate Upon;
- изменить правило генерации оповещений так, чтобы использовать правильную логику оповещений по полю *total breach*.
 
## <a name="log-alert-fired-unnecessarily"></a>Оповещение журналов срабатывает без необходимости
Ниже приведены распространенные причины того, что [правило генерации оповещений журналов в Azure Monitor](alert-log.md) отображается в [оповещениях Azure](monitoring-alerts-managing-alert-states.md) как активированное, хотя вы не ожидаете его срабатывания.

### <a name="alert-triggered-by-partial-data"></a>Предупреждение активируется по частичным данным
Log Analytics и Application Insights основываются на службе аналитики, работа которой характеризуется задержками при приеме и обработке данных. Это означает, что на момент выполнения запроса для оповещения журналов нужные данные могут отсутствовать или быть неполными. См. дополнительные сведения о [времени приема данных в Log Analytics](../log-analytics/log-analytics-data-ingestion-time.md).

В зависимости от настройки правила генерации оповещений могут происходить ложные срабатывания, если на момент выполнения запроса оповещений данные отсутствуют или являются неполными. В таких случаях следует изменить запрос или конфигурацию для оповещения. *Например, если правило генерации оповещений журнала должно активироваться при малом количестве результатов в запросе (скажем, менее 5), оно будет срабатывать и при отсутствии данных (нуль записей) или наличии неполных данных (одна запись). Если бы тот же запрос выполнялся в службе Analytics после ожидания задержки приема, он возвращал бы 10 записей.*

### <a name="alert-query-output-misunderstood"></a>Неправильная интерпретация выходных данных запроса оповещения
Логика генерации оповещений журналов предоставляется пользователем в форме аналитического запроса. Этот аналитический запрос может использовать возможности больших данных и математические функции, чтобы создавать определенные конструкции. Служба оповещений выполняет предоставленный клиентом запрос с указанной периодичностью по данным в указанный период времени. Служба оповещений в зависимости от выбранного типа оповещений вносит в запрос незначительные изменения, которые отображаются в разделе с выполняемыми запросами на экране настройки логики сигнала, как показано ниже: ![Выполняемый запрос](./media/monitor-alerts-unified/LogAlertPreview.png)
 
Служба оповещений будет выполнять именно тот запрос, который отображается в поле **Выполняемый запрос**. Пользователь может запустить этот запрос с указанным интервалом времени, используя [портал Analytics](../log-analytics/log-analytics-log-search-portals.md) или [API Analytics](https://docs.microsoft.com/rest/api/loganalytics/), если нужно проверить результаты запроса до создания оповещения.
 
## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения см. в статье [Оповещения журнала в Azure Monitor. Интерфейс оповещений](monitor-alerts-unified-log.md).
* Дополнительные сведения об [Application Insights](../application-insights/app-insights-analytics.md)
* Дополнительные сведения о [Log Analytics](../log-analytics/log-analytics-overview.md). 

