---
title: "Интеграция Azure DevTest Labs в конвейер непрерывной интеграции и доставки VSTS | Документы Microsoft"
description: "Сведения об интеграции Azure DevTest Labs в VSTS непрерывной интеграции и доставки конвейера"
services: devtest-lab,virtual-machines,visual-studio-online
documentationcenter: na
author: tomarcher
manager: douge
editor: 
ms.assetid: a26df85e-2a00-462b-aac1-dd3539532569
ms.service: devtest-lab
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/07/2017
ms.author: tarcher
ms.openlocfilehash: 3cd6939e890f59e7c5b188edd8620da5c9fcc935
ms.sourcegitcommit: b7adce69c06b6e70493d13bc02bd31e06f291a91
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2017
---
# <a name="integrate-azure-devtest-labs-into-your-vsts-continuous-integration-and-delivery-pipeline"></a>Интеграция Azure DevTest Labs в VSTS непрерывной интеграции и доставки конвейера
Можно использовать **расширение Azure DevTest Labs задания** установлен в Visual Studio Team Services (VSTS) легко интегрировать сборки CI/CD и выпуск конвейер с Azure DevTest Labs. Расширение устанавливает три задачи для создания виртуальной Машины, создать образ с виртуальной Машины и удаления виртуальной Машины. Этот процесс позволяет легко, например, быстро развернуть «золотой образ» для конкретного теста задачи, а затем удалите его после завершения теста.

В этой статье показано, как создание и развертывание виртуальной Машины, создать образ, а затем удалить виртуальную Машину, все как одну полного конвейера. Обычно хотя, следует использовать задачи по отдельности в собственные пользовательские сборки проверить развертывание конвейера.

## <a name="before-you-begin"></a>Перед началом работы
Прежде чем конвейер CI/CD можно интегрировать с Azure DevTest Labs, необходимо сначала установить расширения из Visual Studio Marketplace.
1. Последовательно выберите пункты [задачи Azure DevTest Labs](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks)
1. Выберите "установить"
1. Завершение работы мастера

## <a name="create-a-resource-manager-template"></a>Создание шаблона диспетчера ресурсов
В этом разделе описывается создание шаблона Azure Resource Manager, которая используется для создания виртуальной машины Azure по запросу.

1. Следуйте указаниям в [использование шаблона диспетчера ресурсов](devtest-lab-use-resource-manager-template.md) для создания шаблона диспетчера ресурсов в вашей подписке.
1. Добавить [артефакта WinRM](https://github.com/Azure/azure-devtestlab/tree/master/Artifacts/windows-winrm) в ходе создания виртуальной Машины (перед созданием шаблона диспетчера ресурсов).

   WinRM доступ необходим для использования развертывания задачи, такие как **копирование файлов Azure** и **PowerShell на целевых компьютерах**.

   > [!NOTE]
   > При использовании WinRM общий IP-адрес, необходимо добавить правило NAT для сопоставления портов WinRM внешний порт. Это не требуется, если ВМ создается с использованием общедоступный IP-адрес.
   >
   >

1. Сохраните шаблон в виде файла на компьютере. Назовите файл **CreateVMTemplate.json**.
1. Проверьте шаблон в систему управления версиями.
1. Откройте текстовый редактор и скопируйте в него следующий сценарий.

   ```powershell
   Param( [string] $labVmId)

   $labVmComputeId = (Get-AzureRmResource -Id $labVmId).Properties.ComputeId

   # Get lab VM resource group name
   $labVmRgName = (Get-AzureRmResource -Id $labVmComputeId).ResourceGroupName

   # Get the lab VM Name
   $labVmName = (Get-AzureRmResource -Id $labVmId).Name

   # Get lab VM public IP address
   $labVMIpAddress = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName
                   -Name $labVmName).IpAddress

   # Get lab VM FQDN
   $labVMFqdn = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName
              -Name $labVmName).DnsSettings.Fqdn

   # Set a variable labVmRgName to store the lab VM resource group name
   Write-Host "##vso[task.setvariable variable=labVmRgName;]$labVmRgName"

   # Set a variable labVMIpAddress to store the lab VM Ip address
   Write-Host "##vso[task.setvariable variable=labVMIpAddress;]$labVMIpAddress"

   # Set a variable labVMFqdn to store the lab VM FQDN name
   Write-Host "##vso[task.setvariable variable=labVMFqdn;]$labVMFqdn"
   ```

1. Проверьте сценарий в системе управления версиями. Имя действия, аналогичные **GetLabVMParams.ps1**.

   Этот сценарий, при запуске агента как часть определения выпуска, собирает значения, которые необходимо развернуть приложение в виртуальной Машине, при использовании задач **копирование файлов Azure** или **PowerShell на целевых компьютерах**. Эти задачи обычно используется для развертывания приложений на Виртуальной машине Azure, и требуют значения, такие как имя группы ресурсов виртуальной Машины, IP-адреса и полного доменного имени (FDQN).

## <a name="create-the-release-definition-in-release-management"></a>Создание определения выпуска в Release Management
Выполните следующие шаги для создания определения выпуска.

1. Откройте **выпуски** вкладке **построения и выпуска** концентратора и выберите команду "**+**» значок.
1. В **создать определение выпуска** диалогового окна выберите **пустой** шаблона и выберите **Далее**.
1. На следующей странице выберите **выберите позже** и выберите **создать** для создания определения нового выпуска среды одно значение по умолчанию и не связанных артефактов.
1. В новом определение выпуска, нажмите кнопку с многоточием (...) рядом с именем среды, чтобы открыть контекстное меню и выберите **Настройка переменных**. 
1. В **Настройка - среды** диалоговое окно, введите следующие значения для переменных, используется в задачах определения выпуска:
   - **vmName**: Введите имя, назначенное для виртуальной Машины при создании шаблона диспетчера ресурсов на портале Azure.
   - **имя пользователя**: Введите имя пользователя, назначенное для виртуальной Машины при создании шаблона диспетчера ресурсов на портале Azure.
   - **пароль**: Введите пароль, назначенный для виртуальной Машины при создании шаблона диспетчера ресурсов на портале Azure. Используется значок «замка» скрыть и защитить пароль.

   <a name="create-a-vm"></a>Создание виртуальной машины
   ---

   Для создания виртуальной Машины для использования в качестве «золотой образ» для последующих развертываниях является первым этапом этого развертывания. Создать виртуальную Машину в Azure DevTest лаборатории экземпляра с помощью задачи, разработанных специально для этой цели. В определении выпуска выберите **+ добавить задачи** и добавьте **Создание ВМ Azure DevTest Labs** задачи на вкладке развертывание. Настройте его следующим образом.

   В разделе [Azure DevTest Labs задачи](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks) для создания виртуальной Машины для использования при последующих развертываниях.
   - **Подписка Azure RM**: выберите соединение из списка под заголовком **доступных подключений службы Azure** или создать более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).
   - **Имя лаборатории**: выберите имя экземпляра, созданного ранее.
   - **Имя шаблона**: Введите полный путь и имя файла шаблона, сохраненный в репозиторий исходного кода. Встроенные свойства Release Management можно использовать для упрощения путь, например:
      ```
      $(System.DefaultWorkingDirectory)/Contoso/ARMTemplates/CreateVMTemplate.json
      ```
   - **Параметры шаблона**: Введите параметры для переменных, определенных в шаблоне. Используйте имена переменных, заданных в среде, например:
      ```
      -newVMName '$(vmName)' -userName '$(userName)' -password (ConvertTo-SecureString -String '$(password)' -AsPlainText -Force)
      ```
   - **Выводить переменные — идентификатор виртуальной Машины лаборатории**: требуется идентификатор вновь созданной ВМ для последующих шагов. Имя переменной среды, которая заполняется автоматически с этим Идентификатором по умолчанию задается в **выходных переменных** раздела. Можно изменить переменную, при необходимости, но помните, что нужно использовать правильное имя в последующих задач. Идентификатор виртуальной Машины лаборатории имеет вид:
      ```
      /subscriptions/{subId}/resourceGroups/{rgName}/providers/Microsoft.DevTestLab/labs/{labName}/virtualMachines/{vmName}
      ```
1. Выполните скрипт, созданный ранее, чтобы собирать подробные сведения о виртуальной машины DevTest Labs. В определении выпуска выберите **+ добавить задачи** и добавьте **Azure PowerShell** задач из **развернуть** вкладки. Настройте задачи следующим образом:

   В разделе [развертывание: Azure PowerShell](https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/AzurePowerShell) и выполните скрипт, чтобы собирать подробные сведения о виртуальной машины DevTest Labs.

   - **Тип соединения Azure**: диспетчер ресурсов Azure.
   - **Подписка Azure RM**: выберите соединение из списка под заголовком **доступных подключений службы Azure** или создать более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).
   - **Тип сценария**: файл скрипта.
   - **Скрипт путь**: Введите полный путь и имя сценария, сохраненный в репозиторий исходного кода. Встроенные свойства Release Management можно использовать для упрощения путь, например:
      ```
      $(System.DefaultWorkingDirectory/Contoso/Scripts/GetLabVMParams.ps1
      ```
   - **Аргументы скрипта**: Введите имя переменной среды, который был автоматически заполняется идентификатор виртуальной Машины лаборатории предыдущей задаче, например, в качестве аргумента скрипта: 
      ```
      -labVmId '$(labVMId)'
      ```
   Сценарий собирает необходимые значения и сохраняет их в переменных среды в определение выпуска, таким образом, можно легко ссылаться на них в следующих шагов.

1. Теперь можно развертывать приложения для новой виртуальной Машины DevTest Labs. Задачи, обычно используется для развертывания — **копирование файлов Azure** и **PowerShell на целевых компьютерах**.
   - Сведения о виртуальной Машине, необходимые для параметров из этих задач хранятся в трех переменных конфигурации с именем **labVmRgName**, **labVMIpAddress**, и **labVMFqdn**в определении выпуска.
   - Если необходимо просто поэкспериментировать с создания виртуальной Машины DevTest Labs и настраиваемый образ, без развертывания приложения на его, этот шаг можно пропустить.

   <a name="create-an-image"></a>Создание образа
   ---

   Следующий этап заключается в создании образа виртуальной машины, развернутой в вашем экземпляре Azure DevTest Labs. Затем этот образ можно использовать для создания копий виртуальной машины по требованию, каждый раз, когда требуется выполнить задачу разработки или выполнения некоторых тестов. В определении выпуска выберите **+ добавить задачи** и добавьте **Azure DevTest Labs создать настраиваемый образ** задач из **развернуть** вкладки. Настройте его следующим образом.

   В разделе [Azure DevTest Labs задачи](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks) для создания образа.
   - **Подписка Azure RM**: выберите соединение из списка под заголовком **доступных подключений службы Azure** или создать более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).
   - **Имя лаборатории**: выберите имя экземпляра, созданного ранее.
   - **Имя настраиваемого образа**: Введите имя для настраиваемого образа.
   - **Описание**: при необходимости введите описание, чтобы облегчить выбор нужного образа.
   - **Источник лаборатории виртуальной Машины — идентификатор виртуальной Машины лаборатории источника**: Если вы изменили имя по умолчанию переменная среды, которая была автоматически с Идентификатором виртуальной Машины лаборатории в предыдущей задаче, изменить его здесь. Значение по умолчанию — *$(labVMId)*.
   - **Выводить переменные - идентификатор пользовательского образа**: требуется идентификатор только что созданный образ для управления или удалите его. Имя переменной среды, которая заполняется автоматически с этим Идентификатором по умолчанию задается в **выходных переменных** раздела. При необходимости можно изменить переменную.
   
   <a name="delete-the-vm"></a>Удаление виртуальной машины
   ---
   
   Последний этап в этом примере является удаление виртуальных Машин, развернутых в вашем экземпляре Azure DevTest Labs. Как правило после выполнения задач разработки или выполнения тестов, необходимых на развернутой виртуальной Машины удалить виртуальную Машину. В определении выпуска выберите **+ добавить задачи** и добавьте **удаление виртуальной Машины Azure DevTest Labs** задач из **развернуть** вкладки. Настройте его следующим образом.

   В разделе [Azure DevTest Labs задачи](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks) для удаления виртуальной Машины.
   - **Подписка Azure RM**: выберите соединение из списка под заголовком **доступных подключений службы Azure** или создать более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).
   - **Идентификатор виртуальной Машины лаборатории**: Если вы изменили имя по умолчанию переменная среды, которая была автоматически с Идентификатором виртуальной Машины лаборатории в предыдущей задаче, изменить его здесь. Значение по умолчанию — *$(labVMId)*.
1. Введите имя для определения выпуска и сохраните его.
1. Создать выпуск, выберите последнюю сборку и развернуть его в одной среде, в определении.

На каждом этапе обновления в представлении экземпляра DevTest Labs на портале Azure для просмотра виртуальных Машин и размер создаваемого изображения и попытку удаления виртуальной Машины.

Теперь можно использовать пользовательского образа, чтобы создать виртуальные машины, при необходимости.


[!INCLUDE [devtest-lab-try-it-out](../../includes/devtest-lab-try-it-out.md)]

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения см. в статье [Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager](devtest-lab-create-environment-from-arm.md).
* Просмотр дополнительных шаблонов диспетчера ресурсов краткое руководство для автоматизации DevTest Labs из [открытый DevTest Labs в репозитории GitHub](https://github.com/Azure/azure-quickstart-templates).
* При необходимости просмотреть [Устранение неполадок VSTS](https://docs.microsoft.com/vsts/build-release/actions/troubleshooting) страницы.
