---
title: "Интеграция Azure DevTest Labs в конвейер непрерывной интеграции и доставки VSTS | Документы Microsoft"
description: "Сведения об интеграции Azure DevTest Labs в VSTS непрерывной интеграции и доставки конвейера"
services: devtest-lab,virtual-machines,visual-studio-online
documentationcenter: na
author: craigcaseyMSFT
manager: douge
editor: 
ms.assetid: a26df85e-2a00-462b-aac1-dd3539532569
ms.service: devtest-lab
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/07/2017
ms.author: v-craic
ms.openlocfilehash: db2ee6a25626f0a47bf86c5ee286fddc2441d3f8
ms.sourcegitcommit: d6984ef8cc057423ff81efb4645af9d0b902f843
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/05/2018
---
# <a name="integrate-azure-devtest-labs-into-your-vsts-continuous-integration-and-delivery-pipeline"></a>Интеграция Azure DevTest Labs в VSTS непрерывной интеграции и доставки конвейера
Можно использовать *Azure DevTest Labs задачи* расширение, установленное в Visual Studio Team Services (VSTS) для легко интегрировать конвейер сборки выпуска CI/CD Azure DevTest Labs. Расширение устанавливает три задачи: 
* Создание виртуальной машины
* Создание пользовательского образа из виртуальной машины
* Удаление виртуальной машины 

Процесс позволяет легко, например, быстро развернуть «золотой образ» для задания конкретного теста и удалите его после завершения теста.

В этой статье показано, как создание и развертывание виртуальной Машины, создать образ и затем удалить виртуальную Машину, все как одну полного конвейера. Вы обычно выполняется каждую задачу по отдельности в собственные пользовательские сборки проверить развертывание конвейера.

## <a name="before-you-begin"></a>Перед началом работы
Перед конвейер CI/CD можно интегрировать с Azure DevTest Labs, необходимо установить расширения из Visual Studio Marketplace.
1. Последовательно выберите пункты [задачи Azure DevTest Labs](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).
1. Щелкните **Установить**.
1. Завершите работу мастера.

## <a name="create-a-resource-manager-template"></a>Создание шаблона диспетчера ресурсов
В этом разделе описывается создание шаблона Azure Resource Manager, которая используется для создания виртуальной машины Azure по запросу.

1. Для создания шаблона диспетчера ресурсов в подписке, выполните процедуру, описанную в [использование шаблона диспетчера ресурсов](devtest-lab-use-resource-manager-template.md).
1. Перед созданием шаблона диспетчера ресурсов, добавить [артефакта WinRM](https://github.com/Azure/azure-devtestlab/tree/master/Artifacts/windows-winrm) в ходе создания виртуальной Машины.

   WinRM доступ необходим для использования задачи развертывания, таких как *копирование файлов Azure* и *PowerShell на целевых компьютерах*.

   > [!NOTE]
   > При использовании WinRM общий IP-адрес, необходимо добавить правило NAT для сопоставления портов WinRM внешний порт. Этот шаг не является обязательным при создании виртуальной Машины с общим IP-адресом.
   >
   >

1. Сохраните шаблон в виде файла на компьютере. Назовите файл **CreateVMTemplate.json**.
1. Проверьте шаблон систему управления версиями.
1. Откройте текстовый редактор и вставьте в него следующий сценарий.

   ```powershell
   Param( [string] $labVmId)

   $labVmComputeId = (Get-AzureRmResource -Id $labVmId).Properties.ComputeId

   # Get lab VM resource group name
   $labVmRgName = (Get-AzureRmResource -Id $labVmComputeId).ResourceGroupName

   # Get the lab VM Name
   $labVmName = (Get-AzureRmResource -Id $labVmId).Name

   # Get lab VM public IP address
   $labVMIpAddress = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName
                   -Name $labVmName).IpAddress

   # Get lab VM FQDN
   $labVMFqdn = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName
              -Name $labVmName).DnsSettings.Fqdn

   # Set a variable labVmRgName to store the lab VM resource group name
   Write-Host "##vso[task.setvariable variable=labVmRgName;]$labVmRgName"

   # Set a variable labVMIpAddress to store the lab VM Ip address
   Write-Host "##vso[task.setvariable variable=labVMIpAddress;]$labVMIpAddress"

   # Set a variable labVMFqdn to store the lab VM FQDN name
   Write-Host "##vso[task.setvariable variable=labVMFqdn;]$labVMFqdn"
   ```

1. Проверьте сценарий системе управления версиями. Назовите примерно **GetLabVMParams.ps1**.

   При запуске этого скрипта в агенте как часть определения выпуска, а также при использовании задач *копирование файлов Azure* или *PowerShell на целевых компьютерах*, сценарий собирает значения, которые необходимы для развертывание приложения в виртуальной Машине. Эти задачи обычно применяется для развертывания приложений на Виртуальной машине Azure. Для выполнения задач требуются значения, такие как имя группы ресурсов виртуальной Машины, IP-адреса и полного доменного имени (FDQN).

## <a name="create-a-release-definition-in-release-management"></a>Создание определения выпуска в Release Management
Чтобы создать определение выпуска, выполните следующее:

1. На **выпуски** вкладке **построения и выпуска** концентратора, нажмите кнопку "плюс" (+).
2. В **создать определение выпуска** выберите **пустой** шаблона, а затем выберите **Далее**.
3. Выберите **выберите позже**и выберите **создать** для создания определения нового выпуска среды одно значение по умолчанию и не связанных артефактов.
4. Чтобы открыть контекстное меню, в новом определение выпуска, выберите кнопку с многоточием (...) рядом с именем среды и затем выберите **Настройка переменных**. 
5. В **Настройка - среды** окна переменных, используемых в выпуске определение задачи, введите следующие значения:

   a. Для **vmName**, введите имя, назначенное для виртуальной Машины при создании шаблона диспетчера ресурсов на портале Azure.

   Б. Для **userName**, введите имя пользователя, назначенное для виртуальной Машины при создании шаблона диспетчера ресурсов на портале Azure.

   c. Для **пароль**, введите пароль, который назначен виртуальной Машины при создании шаблона диспетчера ресурсов на портале Azure. Используется значок «замка» скрыть и защитить пароль.

### <a name="create-a-vm"></a>Создание виртуальной машины

Следующий этап развертывания заключается в создании виртуальной Машины для использования в качестве «золотой образ» при последующих развертываниях. Создание виртуальной Машины в пределах экземпляра лаборатории DevTest Azure с помощью задачи, специально разработанный для этой цели. 

1. В определении выпуска выберите **добавьте задачи**.
2. На **развернуть** добавьте *Создание ВМ Azure DevTest Labs* задачи. Настройте задачи следующим образом:

   > [!NOTE]
   > Для создания виртуальной Машины для использования при последующих развертываниях см. [задачи Azure DevTest Labs](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).

   a. Для **подписки Azure RM**, выберите подключение в **доступных подключений службы Azure** или создайте более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).

   Б. Для **имени лаборатории**, выберите имя экземпляра, которое было создано ранее.

   c. Для **имя шаблона**, введите полный путь и имя файла шаблона, сохраненный на репозиторий исходного кода. Встроенные свойства Release Management можно использовать для упрощения путь, например:

   ```
   $(System.DefaultWorkingDirectory)/Contoso/ARMTemplates/CreateVMTemplate.json
   ```

   d. Для **параметров шаблона**, введите параметры для переменных, определенных в шаблоне. Используйте имена переменных, которые определены в среде, например:

   ```
   -newVMName '$(vmName)' -userName '$(userName)' -password (ConvertTo-SecureString -String '$(password)' -AsPlainText -Force)
   ```

   д. Для **выходных переменных — идентификатор виртуальной Машины лаборатории**, требуется идентификатор вновь созданной ВМ для последующих шагов. Значение по умолчанию имя переменной среды, автоматически заполняется этот идентификатор в **выходных переменных** раздела. Можно изменить переменную, при необходимости, но помните, что нужно использовать правильное имя в последующих задач. Идентификатор виртуальной Машины лаборатории записывается в следующем формате:

   ```
   /subscriptions/{subId}/resourceGroups/{rgName}/providers/Microsoft.DevTestLab/labs/{labName}/virtualMachines/{vmName}
   ```

3. Выполните скрипт, созданный ранее, чтобы собирать подробные сведения о виртуальной машины DevTest Labs. 
4. В определении выпуска выберите **добавьте задачи** и затем на **развернуть** добавьте *Azure PowerShell* задачи. Настройте задачи следующим образом:

   > [!NOTE]
   > Чтобы собрать сведения о виртуальной Машине DevTest Labs, в разделе [развертывание: Azure PowerShell](https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/AzurePowerShell) и выполнить скрипт.

   a. Для **типа подключения Azure**выберите **диспетчера ресурсов Azure**.

   Б. Для **подписки Azure RM**, выберите соединение из списка под заголовком **доступных подключений службы Azure**, или создать более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).

   c. Для **тип сценария**выберите **файла сценария**.
 
   d. Для **путь к скрипту**, введите полный путь и имя сценария, который был сохранен для репозитория исходного кода. Встроенные свойства Release Management можно использовать для упрощения путь, например:
      ```
      $(System.DefaultWorkingDirectory/Contoso/Scripts/GetLabVMParams.ps1
      ```
   д. Для **аргументы сценария**, введите имя переменной среды, который был автоматически заполняется идентификатор виртуальной Машины лаборатории предыдущей задаче, например: 
      ```
      -labVmId '$(labVMId)'
      ```
    Сценарий собирает необходимые значения и сохраняет их в переменных среды в определение выпуска, таким образом, можно легко ссылаться на них в последующих шагах.

5. Развертывание приложения для новой виртуальной Машины DevTest Labs. Задачи, обычно используется для развертывания приложения — это *копирование файлов Azure* и *PowerShell на целевых компьютерах*.
   Сведения о виртуальной Машине, необходимые для параметров из этих задач хранятся в трех переменных конфигурации с именем **labVmRgName**, **labVMIpAddress**, и **labVMFqdn**в определении выпуска. Если вы только хотите поэкспериментировать с создания виртуальной Машины DevTest Labs и настраиваемый образ, без развертывания приложения на его, этот шаг можно пропустить.

### <a name="create-an-image"></a>Создание образа

Следующий этап заключается в создании образа виртуальной машины, развернутой в вашем экземпляре Azure DevTest Labs. Затем образ можно использовать для создания копий виртуальной машины по требованию, каждый раз, когда требуется выполнить задачу разработки или выполнения некоторых тестов. 

1. В определении выпуска выберите **добавьте задачи**.
2. На **развернуть** добавьте **DevTest Labs создания пользовательского образа Azure** задачи. Настройте его следующим образом.

   > [!NOTE]
   > Для создания образа, в разделе [задачи Azure DevTest Labs](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).

   a. Для **подписки Azure RM**в **доступных подключений службы Azure** выберите соединение из списка или создать более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).

   Б. Для **имени лаборатории**, выберите имя экземпляра, созданного ранее.

   c. Для **пользовательское имя изображения**, введите имя для настраиваемого образа.

   d. (Необязательно) Для **описание**, введите описание, чтобы облегчить выбор нужного образа.

   д. Для **лаборатории источника виртуальной Машины — идентификатор виртуальной Машины лаборатории источника**, если изменить имя по умолчанию переменная среды, которая была автоматически с Идентификатором виртуальной Машины лаборатории в предыдущей задаче, изменить его здесь. Значение по умолчанию — **$(labVMId)**.

   f. Для **выходных переменных - идентификатор пользовательского образа**, требуется идентификатор только что созданный образ для управления или удалите его. Имя переменной среды, которая заполняется автоматически с этим Идентификатором по умолчанию задается в **выходных переменных** раздела. При необходимости можно изменить переменную.

### <a name="delete-the-vm"></a>Удаление виртуальной машины

Последний этап является удаление виртуальной Машины, развернутой в вашем экземпляре Azure DevTest Labs. После выполнения задач разработки или выполнения тестов, необходимо на развернутой виртуальной Машины, обычно удаление виртуальной Машины. 

1. В определении выпуска выберите **добавьте задачи** и затем на **развернуть** добавьте *удаление виртуальной Машины Azure DevTest Labs* задачи. Настройте его следующим образом.

      > [!NOTE]
      > Чтобы удалить виртуальную Машину, в разделе [Azure DevTest Labs задачи](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).

   a. Для **подписки Azure RM**, выберите подключение в **доступных подключений службы Azure** или создайте более ограниченные разрешения подключения к подписке Azure. Дополнительные сведения см. в разделе [конечной точки службы диспетчера ресурсов Azure](https://docs.microsoft.com/en-us/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).
 
   Б. Для **ИД виртуальной Машины лаборатории**, если изменить имя по умолчанию переменная среды, которая была автоматически с Идентификатором виртуальной Машины лаборатории в предыдущей задаче, изменить его здесь. Значение по умолчанию — **$(labVMId)**.

2. Введите имя для определения выпуска и сохраните его.
3. Создать выпуск, выберите последнюю сборку и развернуть его в одной среде, в определении.

На каждом этапе обновите представление экземпляра DevTest Labs на портале Azure для просмотра виртуальной Машины, создается и образ виртуальной Машины, которое удаляется еще раз.

Теперь можно использовать пользовательского образа для создания виртуальных машин по мере необходимости.


[!INCLUDE [devtest-lab-try-it-out](../../includes/devtest-lab-try-it-out.md)]

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения см. в статье [Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager](devtest-lab-create-environment-from-arm.md).
* Просмотр дополнительных шаблонов диспетчера ресурсов краткое руководство для автоматизации DevTest Labs из [открытый DevTest Labs в репозитории GitHub](https://github.com/Azure/azure-quickstart-templates).
* При необходимости просмотреть [Устранение неполадок VSTS](https://docs.microsoft.com/vsts/build-release/actions/troubleshooting) страницы.
 
