<properties title="Interact with DocumentDB resources" pageTitle="Взаимодействие с ресурсами DocumentDB |Azure" description="В DocumentDB имеются клиентские пакеты SDK для .NET, Python, Node.js и JavaScript, все они являются программами-оболочками базовых интерфейсов REST API." metaKeywords="" services="documentdb" solutions="data-management"  authors="bradsev" manager="jhubbard" editor="cgronlun" videoId="" scriptId="" />

<tags ms.service="documentdb" ms.workload="data-services" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="08/20/2014" ms.author="spelluru" />

#Взаимодействие с ресурсами DocumentDB 
DocumentDB предлагает простую и открытую модель программирования RESTful поверх HTTP. В предварительной версии DocumentDB имеются клиентские пакеты SDL для .NET, Python, Node.js и JavaScript, все они являются обертками над интерфейсами API REST. В будущих версиях также будут выпущены пакеты SDK для C++ и Java. Мы рекомендуем написать собственные пакеты SDK для конкретной среды программирования и поделиться ими с сообществом так же, как мы сделали с нашими пакетами SDK. 

>[AZURE.NOTE] Кроме того, предлагается достаточно эффективный протокол TCP, который также является RESTful в своей коммуникационной модели и доступен через клиентский пакет .NET SDK.  

##Ресурсы
Сущности, которыми управляет DocumentDB, называются **ресурсами**, которые однозначно идентифицируются своими логическими URI. Разработчики могут взаимодействовать с ресурсами, используя стандартные команды HTTP, заголовки запросов/ответов и коды состояний. Как показано на нижеприведенном рисунке, **модель ресурсов** DocumentDB состоит из наборов ресурсов под учетной записью базы данных, каждый из которых адресуется логическим постоянным URI. Набор ресурсов в данном документе называется **каналом**.  

![][1]  

##Иерархическая модель ресурсов под учетной записью базы данных ##

Являясь клиентом DocumentDB, вы начинаете с подготовки **учетной записи базы данных** для DocumentDB с использованием своей подписки Azure. Учетная запись базы данных может состоять из набора **баз данных**, каждая из которых содержит несколько **коллекций**, каждая из которых в свою очередь содержит **хранимые процедуры, триггеры, определяемые пользователем функции, документы** и соответствующие **вложения**. База данных также имеет связанных с ней **пользователей**, каждый из которых обладает набором **разрешений** для доступа к коллекциям, хранимым процедурам, триггерам, определяемым пользователем функциям, документам и вложениям. Если базы данных, пользователи, разрешения и коллекции - это определяемые системой ресурсы с известными схемами, то документы и вложения содержат произвольный, определяемый пользователем контент в формате JSON.  

|Ресурс 	|Описание
|-----------|-----------
|Учетная запись базы данных	|Учетная запись базы данных связана с одной или несколькими единицами емкости, представляющими подготовленное хранилище документов и пропускную способность, а также набор баз данных и хранилище больших двоичных объектов. Вы можете создать одну или несколько учетных записей базы данных с помощью подписки Azure.
|База данных	|База данных представляет собой логический контейнер для хранения документов, разделенных между коллекциями. Она также является контейнером для пользователей.
|Пользователь	|Логическое пространство имен для ограничений или разграничений разрешений. 
|Разрешение	|Маркер авторизации, связанный с пользователем, имеющим право на доступ к определенному ресурсу.
|Коллекция	|Коллекция представляет собой контейнер документов JSON и связанную с ними логику в виде приложения JavaScript.
|Хранимая процедура	|Логика приложения, написанная на JavaScript, которая зарегистрирована в коллекции и выполняется в транзакции в ядре базы данных.
|Триггер	|Логика приложения, написанная на JavaScript для моделирования побочных эффектов, связанных с операциями вставки, замены и удаления.
|UDF	|Логика приложения, написанного на JavaScript, не имеющая побочных эффектов. Пользовательские функции позволяют моделировать операторы пользовательских запросов и тем самым расширить базовый язык запросов DocumentDB.
|Документ	|Пользовательский (произвольный) контент JSON. По умолчанию, нет необходимости определения схемы или обеспечения вторичных индексов для всех документов, добавляемых в коллекцию.
|Вложение	|Вложение - это специальный документ, содержащий ссылки и связанные с ним метаданные для внешних BLOB-объектов или носителей. Разработчик может выбрать, управлять ли BLOB-объектами в DocumentDB или хранить их с помощью внешних поставщиков услуг хранения больших двоичных объектов, таких как OneDrive, Dropbox и т. д. 

###Системные и пользовательские ресурсы
Ресурсы (такие как учетные записи баз данных, базы данных, коллекции, пользователи, разрешения, хранимые процедуры, триггеры и определяемые пользователем функции) имеют статическую схему и называются *системными ресурсами*. В отличие от таких ресурсов, как документы и вложения, не имеющих ограничений по схеме, которые являются примерами *пользовательских ресурсов*. В DocumentDB системные и пользовательские ресурсы представляются и управляются как стандартные, совместимые с JSON-объекты. Все ресурсы, системные и пользовательские, имеют следующие общие свойства.

>[AZURE.NOTE] Обратите внимание, что все сгенерированные системой свойства в ресурсах начинаются с символа подчеркивания (_) в представлении JSON.  


<table width="500"> 
<tbody>
<tr>
<td valign="top" ><p><b>Свойство </b></p></td>
<td valign="top" ><p><b>Устанавливаемое пользователем или генерируемое системой?</b></p></td>
<td valign="top" ><p><b>Назначение</b></p></td>
</tr>

<tr>
<td valign="top" ><p>_rid</p></td>
<td valign="top" ><p>Генерируемое системой</p></td>
<td valign="top" ><p>Генерируемый системой уникальный иерархический идентификатор ресурса</p></td>
</tr>

<tr>
<td valign="top" ><p>_etag</p></td>
<td valign="top" ><p>Генерируемое системой</p></td>
<td valign="top" ><p>etag ресурса, необходимый для управления оптимистичным параллелизмом</p></td>
</tr>

<tr>
<td valign="top" ><p>_ts</p></td>
<td valign="top" ><p>Генерируемое системой</p></td>
<td valign="top" ><p>Метка времени последнего обновления ресурса</p></td>
</tr>

<tr>
<td valign="top" ><p>_self</p></td>
<td valign="top" ><p>Генерируемое системой</p></td>
<td valign="top" ><p>Уникальный адресуемый URI ресурса </p></td>
</tr>

<tr>
<td valign="top" ><p>ид</p></td>
<td valign="top" ><p>Устанавливаемое пользователем</p></td>
<td valign="top" ><p>Устанавливаемое пользователем уникальное имя ресурса </p></td>
</tr>

</tbody>
</table>


###Сетевое представление ресурсов
DocumentDB не требует собственных расширений для стандарта JSON или специальных кодировок. Она работает с документами, совместимыми со стандартом JSON.  
 
###Адресация ресурса
Все ресурсы можно адресовать по URI. Значение свойства ресурса **_self** представляет относительный URI ресурса. Формат URI состоит из сегментов пути /<feed>/{_rid}:  

|Value of the _self	|Description
|-------------------|-----------
|/dbs	|feed of databases under a database account
|/dbs/{_rid-db}	|Database with the unique id property with the value {_rid-db}
|/dbs/{_rid-db}/colls/	|feed of collections under a database 
|/dbs/{_rid-db}/colls/{_rid-coll}	|Collection with the unique id property with the value {_rid-coll}
|/dbs/{_rid-db}/users/	|feed of users under a database 
|/dbs/{_rid-db}/users/{_rid-user}	|User with the unique id property with the value {_rid-user}
|/dbs/{_rid-db}/users/{_rid-user}/permissions	|feed of permissions under a database 
|/dbs/{_rid-db}/users/{_rid-user}/permissions/{_rid-permission}	|Permission with the unique id property with the value {_rid-permission}  
  

Ресурс также имеет уникальное определенное пользователем имя, указанное через свойство идентификатора ресурса. Идентификатор определяется пользователем, имеет вид строки длиной до 256 символов, которая является уникальной в контексте конкретного родительского ресурса. Например, значения идентификатора свойства всех документов в рамках данной коллекции уникальны, но их уникальность не гарантируется среди разных коллекций. Кроме того, значения идентификатора свойства всех разрешений в рамках данного пользователя уникальны, но их уникальность не гарантируется среди разных пользователей. Свойство _rid используется для построения адресуемой ссылки ресурса _self.   

Каждый ресурс имеет также иерархический идентификатор ресурсов, генерируемый системой (также известный как RID), который доступен через свойство _rid. RID кодирует всю иерархию данного ресурса, и это очень удобное внутреннее представление используется для обеспечения ссылочной целостности распределенным образом. RID - это уникальный в пределах учетной записи базы данных идентификатор и используется внутри DocumentDB для эффективной маршрутизации без необходимости выполнения перекрестных выборок разделов. 

Значения свойств _self и  _rid - альтернативное и каноническое представления ресурса.  
 
##Базовая модель взаимодействия
Ресурсы поддерживают следующие HTTP-команды  в их стандартной интерпретации:

>[AZURE.NOTE] В дальнейшем мы добавим функцию поддержки выборочных обновлений с помощью команды PATCH  

1.	POST обозначает создание нового элемента ресурса. 
2.	GET обозначает чтение существующего элемента или потока ресурса 
3.	PUT обозначает замену существующего элемента ресурса 
4.	DELETE означает удаление существующего  элементного ресурса
5.	HEAD означает ответ команды GET без полезной нагрузки (т. е. только заголовки)

В следующих версиях будет добавлена поддержка PATCH-команды.  

Как показано на рисунке ниже, команда POST может быть выполнена только для потокового ресурса, PUT и DELETE - только для элементного ресурса, а GET и HEAD - для любых ресурсов. 

![][2]  

**Модель взаимодействия с использованием стандартных команд HTTP**

Чтобы получить лучшее представление о модели взаимодействия, давайте рассмотрим случай создания нового ресурса (INSERT). Для того чтобы создать новый ресурс Вы должны сформировать запрос HTTP POST с телом запроса, содержащим представление ресурса и URI контейнера, которому принадлежит поток. Единственный обязательный признак для запроса - это идентификатор ресурса.  

В качестве примера, для того чтобы создать новую базу данных, вы формируете запрос POST к ресурсу базы данных (установив свойство идентификатора с уникальным именем) к /DBS, и, аналогично, для того чтобы создать новую коллекцию, вы формируете запрос POST к ресурсу коллекции к /DBS/_rid/colls/ и так далее. Ответ будет содержать полностью завершенный ресурс со сгенерированными системой свойствами, включая ссылку ресурса _self, используя которую вы можете перемещаться к другим ресурсам. В качестве примера простой модели взаимодействия, основанной на HTTP, клиент может оформить HTTP-запрос, чтобы создать новую базу данных в учетной записи:  

	POST http://fabrikam.documents.azure.net/dbs
	{
	      "id":"MyDb"
	}
DocumentDB возвращает положительный ответ и код состояния, обозначающий успешное создание базы данных.  

	[201 Created]
	{
	      "id": "MyDb",
	      "_rid": "UoEi5w==",
	      "_self": "dbs/MyDb/",
	      "_ts": 1407370063,
	      "_etag": "\"00002100-0000-0000-0000-50e71fda0000\"",
	      "_colls": "colls/",
	      "_users": "users/"
	}

Служба DocumentDB возвращает положительный ответ и код состояния, обозначающий успешное создание базы данных.  

В качестве другого примера создания и выполнения ресурса рассмотрим следующую хранимую процедуру, написанную полностью на JavaScript.   

	function sproc(docToCreate, addedPropertyName, addedPropertyValue) {
	    var collectionManager = getContext().getCollection();
	    collectionManager.createDocument(collectionManager.getSelfLink(), docToCreate,   
	    function(err, docCreated) {
	        if(err) throw new Error('Error while creating document: ' + err.message);
	        
	        docCreated.addedPropertyName = addedPropertyValue;
	        getContext().getResponse().setBody(docCreated);
	    });
	}

Хранимая процедура может быть зарегистрирована в коллекции под MyDB путем передачи команды POST с параметрами /dbs/_rid-db/colls/_rid-coll/sprocs. 

	POST /dbs/MyDb/colls/MyColl/sprocs HTTP/1.1
	
	{
	  "id": "sproc1",
	  "body": "function (docToCreate, addedPropertyName, addedPropertyValue) {
	                var collectionManager = getContext().getCollection();
	                collectionManager.createDocument(collectionManager.getSelfLink(), 
	                            docToCreate, function(err, docCreated) {
	                    if(err) throw new Error('Error while creating document: ' + 
	                                                     err.message);
	                    
	                    docCreated.addedPropertyName = addedPropertyValue;
	                    getContext().getResponse().setBody(docCreated);
	                });
	            }"
	}
Служба DocumentDB возвращает положительный ответ и код состояния, обозначающий успешную регистрацию хранимой процедуры.  

	[201 Created]
	{
	      "id": "sproc1",
	      "_rid": "EoEi5w==",
	      "_self": "dbs/MyDb/colls/MyColl/sprocs/sproc1",
	      "_etag": "\"00002100-0000-0000-0000-50f71fda0000\"",
	       ...
	}

Наконец, для выполнения хранимой процедуры в приведенном выше примере необходимо сформировать запрос POST в URI для ресурса хранимой процедуры (/dbs/_rid-db/colls/_rid-coll/sprocs/sproc1). Вот как это можно сделать:  

	POST /dbs/MyDb/colls/MyColl/sprocs/sproc1 HTTP/1.1
	 [ { "id": "TestDocument", "book": "Autumn of the Patriarch"}, "Price", 200 ]
 

Служба DocumentDB ответит следующим образом:  

	HTTP/1.1 200 OK
	 { 
	  "id": "TestDocument",  
	  "_rid": "ZTlcANiwqwIBAAAAAAAAAA==",
	  "_ts": 1407370063,
	  "_self": "dbs/ZTlcAA==/colls/ZTlcANiwqwI=/docs/ZTlcANiwqwIBAAAAAAAAAA==/",
	  "_etag": "00000900-0000-0000-0000-53e2c34f0000",
	  "_attachments": "attachments/",
	  "book": "Autumn of the Patriarch", 
	  "price": 200
	}

Обратите внимание, что команда POST используется как для создания нового ресурса, выполнения хранимой процедуры так и для выполнения SQL-запроса. Чтобы проиллюстрировать выполнение запросов SQL, необходимо учитывать следующее:  

	POST /dbs/MyDb/colls/MyColl/docs HTTP/1.1
	...
	x-ms-documentdb-isquery: True
	Content-Type: application/sql
	
	SELECT * FROM root.children

Ответ службы является результатом выполнения запроса SQL.   

	HTTP/1.1 200 Ok
	x-ms-activity-id: 83f9992c-abae-4eb1-b8f0-9f2420c520d2
	x-ms-item-count: 2
	x-ms-session-token: 81
	x-ms-request-charge: 1.43
	Content-Length: 287
	
	{"_rid":"sehcAIE2Qy4=","Documents":[[{"firstName":"Henriette Thaulow","gender":"female","grade":5,"pets":[{"givenName":"Fluffy"}]}],[{"familyName":"Merriam","givenName":"Jesse","gender":"female","grade":1},{"familyName":"Miller","givenName":"Lisa","gender":"female","grade":8}]],"count":2}


Замена или чтение группы ресурсов осуществляется соответственно командами PUT (с правильным телом запроса) и GET к ссылке _self ресурса. Кроме того, для удаления ресурса используется команда DELETE к ссылке _self ресурса. Стоит отметить, что иерархическая организация ресурсов в ресурсной модели DocumentDB требует поддержки каскадного удаления, при котором удаление владельца ресурса влечет за собой и удаление самого ресурса. Зависимые ресурсы могут быть распределены по другим узлам, отличающимся от узлов владельца и, таким образом, удаление может произойти независимо. Независимо от механизма сбора мусора, при удалении ресурса, квота мгновенно освобождается и доступна для повторного использования. Следует отметить, что в системе сохраняется ссылочная целостность. Например, вы не можете вставить коллекцию в базу данных, которая уже удалена, а также заменить или запросить несуществующий документ.  
 
Запрос GET к потоку (из) ресурсов или запрос к коллекции может привести к потенциальному количеству в миллионы элементов, что делает его непрактичным как для создания со стороны сервера, так и для обработки со стороны клиента в рамках одного обмена одного запроса-ответа. Для решения этой проблемы, DocumentDB позволяет клиентам разбивать на результаты запросов страницы в реальном времени. Клиенты могут использовать заголовок ответа [x-ms-continuationToken] в качестве указателя для перехода на следующую страницу.   

##Управление оптимистическим параллелизмом
Большинство веб-приложений основываются на оптимистическом управлении параллелизмом с метками сущностей, чтобы избежать печально известных проблем "потеря операции обновления" или "потеря операции удаления". Метка сущностей соответствует требованиям HTTP, логическая временная метка связывается с ресурсом. DocumentDB изначально поддерживает оптимистическое управление параллелизмом, гарантируя, что каждый ответ HTTP содержит версию (надежно), связанную с конкретным ресурсом. Конфликты управления параллелизмом правильно обнаруживаются в следующих случаях:  

1.	Если два клиента одновременно отправляют запросы на замену (с помощью команд PUT и DELETE) ресурса последней версией ресурса (указывается в заголовке запроса [if-match]), ядро ​​базы данных DocumentDB передает их под управление транзакционного параллелизма.
2.	Если клиент представляет старую версию ресурса (указывается в разделе [if-match] заголовка запроса), его запрос будет отклонен.  

##Возможности подключения
DocumentDB предлагает модель логической адресации, где каждый ресурс имеет логический статический идентификатор URI по ссылке _self. В распределенной системе хранения информация распределена по регионам, ресурсы различных учетных записей баз данных в DocumentDB разбиваются по многочисленным серверам и каждый раздел реплицируется для обеспечения высокой доступности. Реплики, управляющие ресурсами данного раздела, регистрируют физические адреса. В то время как физические адреса могут меняться в течение времени по причине сбоев, их логические адреса остаются стабильными и постоянным. Соответствие логического и физического адресов хранится в таблице маршрутизации, которая также внутренне доступна в качестве ресурса. DocumentDB предоставляет два режима подключения:  

1.	**Режим шлюза:**Клиенты не узнают о трансляции логических адресов в физические или деталей маршрутизации; они просто работают с логическими URI и переходят по модели ресурса по принципу RESTful. Клиенты формируют запросы с помощью логического URI, в то время как пограничные компьютеры преобразовывают логические URI в физический адрес реплики, управляющей ресурсом и перенаправляющей запрос. Пограничные компьютеры, выполняющие кэширование (и периодически обновляющие) таблицу маршрутизации, способствуют эффективной маршрутизации. 
2.	**Прямой режим подключения:**Клиенты непосредственно управляют таблицей маршрутизации в собственном пространстве обработки и периодически обновляют ее. Клиент может сразу подключиться к репликам и обойти пограничные компьютеры.   



<table width="300">
    <tbody>
        <tr>
            <td width="120" valign="top">
                <p>
                    <strong>Режим подключения</strong>
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    <strong>Протокол</strong>
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    <strong>Подробная информация</strong>
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    <strong>Пакеты SDK для DocumentDB</strong>
                </p>
            </td>
        </tr>
        <tr>
            <td width="120" valign="top">
                <p>
                    Шлюз
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    HTTPS
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    Приложения подключаются непосредственно к пограничным компьютерам, используя логические идентификаторы URI. При этом добавляется дополнительный сетевой узел для перехода.
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    REST APIs
                </p>
                <p>
                    .NET, JavaScript, Node.js, Python
                </p>
            </td>
        </tr>
        <tr>
            <td width="120" valign="top">
                <p>
                    Прямое подключение
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    HTTPS и
                </p>
                <p>
                    TCP
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    Приложения могут получить непосредственный доступ к таблице маршрутизации и выполнить маршрутизацию на стороне клиента для прямого подключения к репликам.
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    .NET
                </p>
            </td>
        </tr>
    </tbody>
</table>

## Ссылки
-	REST [http://en.wikipedia.org/wiki/Representational_state_transfer](http://en.wikipedia.org/wiki/Representational_state_transfer)
-	Спецификация JSON  [http://-www.ietf.org/rfc/rfc4627.txt](http://-www.ietf.org/rfc/rfc4627.txt)
-	HTTP specification [http://www.w3.org/Protocols/rfc2616/rfc2616.html](http://www.w3.org/Protocols/rfc2616/rfc2616.html)
-	Теги ETag [http://en.wikipedia.org/wiki/HTTP_ETag](http://en.wikipedia.org/wiki/HTTP_ETag)
-	[Запросы DocumentDB](/documentation/articles/documentdb-sql-query/)
-	[Справочник по DocumentDB SQL](http://go.microsoft.com/fwlink/p/?LinkID=510612)
-	[Программирование DocumentDB: Хранимые процедуры, триггеры и определяемые пользователем функции](/documentation/articles/documentdb-programming/)
-	[Справочная документация DocumentDB](http://go.microsoft.com/fwlink/p/?LinkID=402384)


[1]: ./media/documentdb-interactions-with-resources/interactions-with-resources1.png
[2]: ./media/documentdb-interactions-with-resources/interactions-with-resources2.png
