<properties 
	pageTitle="Взаимодействия с ресурсами DocumentDB с поддержкой REST | Azure" 
	description="Сведения о выполнении взаимодействий с ресурсами Microsoft Azure DocumentDB с поддержкой REST с использованием глаголов HTTP." 
	services="documentdb" 
	authors="mimig1" 
	manager="jhubbard" 
	editor="monicar" 
	documentationCenter=""/>

<tags 
	ms.service="documentdb" 
	ms.workload="data-services" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="02/03/2015" 
	ms.author="mimig"/>

#REST-взаимодействия с ресурсами DocumentDB 

DocumentDB поддерживает использование методов HTTP для создания, чтения, замены, получения и удаления ресурсов DocumentDB.

Прочитав данную статью, вы сможете ответить на следующие вопросы.

- Как работают стандартные методы HTTP с ресурсами DocumentDB?
- Как создавать новый ресурс с помощью метода POST?
- Как зарегистрировать новую хранимую процедуру с помощью метода POST?
- Как DocumentDB поддерживает управление параллелизмом?
- Какие имеются параметры подключения для протоколов HTTPS и TCP?

##Обзор HTTP-команд
Ресурсы DocumentDB поддерживают следующие команды HTTP с их стандартной интерпретацией.

1.	POST обозначает создание нового элемента ресурса. 
2.	GET обозначает чтение существующего элемента или потока ресурса. 
3.	PUT обозначает замену существующего элемента ресурса. 
4.	DELETE обозначает удаление существующего элемента ресурса.
5.	HEAD означает ответ команды GET без полезной нагрузки (т.е. только заголовки) 

>[AZURE.NOTE] В будущем мы намерены добавить поддержку избирательных обновлений с помощью метода PATCH.  

Как показано на диаграмме ниже, метод POST можно вызывать только для потокового ресурса, методы PUT и DELETE можно вызывать только для ресурса с элементами, методы GET и HEAD можно вызывать для ресурсов обоих видов. 

![][1]  

**Модель взаимодействий с использованием стандартных методов HTTP**

## Создание нового ресурса с помощью метода POST 
Чтобы получить лучшее представление о модели взаимодействия, давайте рассмотрим случай создания нового ресурса (INSERT). Для того чтобы создать требуемый новый ресурс, необходимо выдать запрос HTTP POST с текстом запроса, содержащим представление ресурса относительно URI контейнера, которому принадлежит ресурс. Единственным обязательным признаком для запроса является идентификатор ресурса.  

В качестве примера, для того чтобы создать новую базу данных, вы формируете запрос POST к ресурсу базы данных (установив свойство идентификатора с уникальным именем) к /DBS, и, аналогично, для того чтобы создать новую коллекцию, вы формируете запрос POST к ресурсу коллекции к /DBS/_rid/colls/ и так далее. Ответ содержит полностью законченный ресурс с системными свойствами, включая ссылку _self ресурса, с помощью которой можно перемещаться на другие ресурсы. В качестве примера простой модели взаимодействия на основе HTTP клиент может оформить запрос HTTP, чтобы создать новую базу данных в учетной записи.  

	POST http://fabrikam.documents.azure.net/dbs
	{
	      "id":"MyDb"
	}

Служба DocumentDB ответит об успешном завершении операции и передаст код состояния, указывающий на успешное создание базы данных.  

	[201 Created]
	{
	      "id": "MyDb",
	      "_rid": "UoEi5w==",
	      "_self": "dbs/MyDb/",
	      "_ts": 1407370063,
	      "_etag": "\"00002100-0000-0000-0000-50e71fda0000\"",
	      "_colls": "colls/",
	      "_users": "users/"
	}
  
## Регистрация хранимой процедуры с помощью метода POST
В качестве другого примера создания и выполнения ресурса, рассмотрим следующую хранимую процедуру, написанную полностью на JavaScript.   

	function sproc(docToCreate, addedPropertyName, addedPropertyValue) {
	    var collectionManager = getContext().getCollection();
	    collectionManager.createDocument(collectionManager.getSelfLink(), docToCreate,   
	    function(err, docCreated) {
	        if(err) throw new Error('Error while creating document: ' + err.message);
	        
	        docCreated.addedPropertyName = addedPropertyValue;
	        getContext().getResponse().setBody(docCreated);
	    });
	}

Хранимая процедура может быть зарегистрирована в коллекции под MyDB путем выдачи команды POST с параметрами /dbs/_rid-db/colls/_rid-coll/sprocs. 

	POST /dbs/MyDb/colls/MyColl/sprocs HTTP/1.1
	
	{
	  "id": "sproc1",
	  "body": "function (docToCreate, addedPropertyName, addedPropertyValue) {
	                var collectionManager = getContext().getCollection();
	                collectionManager.createDocument(collectionManager.getSelfLink(), 
	                            docToCreate, function(err, docCreated) {
	                    if(err) throw new Error('Error while creating document: ' + 
	                                                     err.message);
	                    
	                    docCreated.addedPropertyName = addedPropertyValue;
	                    getContext().getResponse().setBody(docCreated);
	                });
	            }"
	}
Служба DocumentDB ответит об успешном завершении операции и передаст код состояния, указывающий на успешную регистрацию хранимой процедуры.  

	[201 Created]
	{
	      "id": "sproc1",
	      "_rid": "EoEi5w==",
	      "_self": "dbs/MyDb/colls/MyColl/sprocs/sproc1",
	      "_etag": "\"00002100-0000-0000-0000-50f71fda0000\"",
	       ...
	}

## Выполнение хранимой процедуры с помощью метода POST
Наконец, чтобы выполнить хранимую процедуру в приведенном выше примере, нужно сформировать POST с URI хранимый процедуры ресурса (/dbs/_rid-db/colls/_rid-coll/sprocs/sproc1). Это продемонстрировано в следующем коде.  

	POST /dbs/MyDb/colls/MyColl/sprocs/sproc1 HTTP/1.1
	 [ { "id": "TestDocument", "book": "Autumn of the Patriarch"}, "Price", 200 ]
 

Служба DocumentDB отвечает следующим образом.  

	HTTP/1.1 200 OK
	 { 
	  "id": "TestDocument",  
	  "_rid": "ZTlcANiwqwIBAAAAAAAAAA==",
	  "_ts": 1407370063,
	  "_self": "dbs/ZTlcAA==/colls/ZTlcANiwqwI=/docs/ZTlcANiwqwIBAAAAAAAAAA==/",
	  "_etag": "00000900-0000-0000-0000-53e2c34f0000",
	  "_attachments": "attachments/",
	  "book": "Autumn of the Patriarch", 
	  "price": 200
	}

Обратите внимание, что команда POST используется для создания нового ресурса, для выполнения хранимой процедуры, а также для выдачи запросов SQL. Чтобы проиллюстрировать выполнение SQL запросов, необходимо учитывать следующее.  

	POST /dbs/MyDb/colls/MyColl/docs HTTP/1.1
	...
	x-ms-documentdb-isquery: True
	Content-Type: application/sql
	
	SELECT * FROM root.children

Ответ службы является результатом выполнения запроса SQL.   

	HTTP/1.1 200 Ok
	x-ms-activity-id: 83f9992c-abae-4eb1-b8f0-9f2420c520d2
	x-ms-item-count: 2
	x-ms-session-token: 81
	x-ms-request-charge: 1.43
	Content-Length: 287
	
	{"_rid":"sehcAIE2Qy4=","Documents":[[{"firstName":"Henriette Thaulow","gender":"female","grade":5,"pets":[{"givenName":"Fluffy"}]}],[{"familyName":"Merriam","givenName":"Jesse","gender":"female","grade":1},{"familyName":"Miller","givenName":"Lisa","gender":"female","grade":8}]],"count":2}


## Использование команд PUT, GET и DELETE
Замена или чтение группы ресурсов осуществляется соответственно командами PUT (с правильным телом запроса) и GET к ссылке _self ресурса. Кроме того, для удаления ресурса используется команда DELETE к ссылке _self ресурса. Стоит отметить, что иерархическая организация ресурсов в ресурсной модели DocumentDB требует поддержки каскадного удаления, при котором удаление владельца ресурса влечет за собой и удаление самого ресурса. Зависимые ресурсы могут быть распределены по другим узлам, отличающимся от узлов владельца и, таким образом, удаление может произойти независимо. Независимо от механизма сбора мусора, при удалении ресурса, квота мгновенно освобождается и доступна для повторного использования. Следует отметить, что в системе сохраняется ссылочная целостность. Например, вы не можете вставить коллекцию в базу данных, которая уже удалена или заменить или запросить документ, которого уже нет.  
 
Выполнение команды GET над потоком ресурсов или запрос коллекции может привести к возможному результату, включающему миллионы элементов, что делает нецелесообразным как для сервера, чтобы материализовать их, так и для клиента, чтобы использовать их как части единого запроса и ответа или обмена. Для решения этой проблемы, DocumentDB позволяет клиентам разбивать на результаты запросов страницы в реальном времени. Клиенты могут использовать заголовок ответа [x-ms-continuationToken] в качестве курсора для перехода к следующей странице.   

## Оптимистичное управление параллелизмом
Большинство веб-приложений основано на управлении оптимистичным параллелизмом на базе меток, чтобы избежать печально известных ошибок "потерянное обновление" и "потерянное удаление". Метка сущностей соответствует требованиям HTTP, логическая временная метка связывается с ресурсом. DocumentDB изначально поддерживает оптимистическое управление параллелизмом, гарантируя, что каждый ответ HTTP содержит версию (надежно), связанную с конкретным ресурсом. Конфликты управления параллелизмом правильно обнаруживаются в следующих случаях:  

1.	Если два клиента одновременно выполняют запросы на изменение данных (через команды PUT или DELETE) к ресурсу с последней версией ресурса (заданной с помощью заголовка запроса [if-match]), ядро базы данных DocumentDB подвергает их управлению оптимистичным параллелизмом.
2.	Если клиент представляет устаревшую версию ресурса (заданной с помощью заголовка запроса [if-match]), этот запрос отклоняется.  

## Варианты подключений
DocumentDB предлагает модель логической адресации, где каждый ресурс имеет логический статический идентификатор URI по ссылке _self. В распределенной системе хранения информация распределена по регионам, ресурсы различных учетных записей баз данных в DocumentDB разбиваются по многочисленным серверам и каждый раздел реплицируется для обеспечения высокой доступности. Реплики, управляющие ресурсами данного раздела, регистрируют физические адреса. В то время как физические адреса могут меняться в течение времени по причине сбоев, их логические адреса остаются стабильными и постоянным. Соответствие логического и физического адресов хранится в таблице маршрутизации, которая также внутренне доступна в качестве ресурса. DocumentDB предоставляет два режима подключения:  

1.	**Режим шлюза.** Клиенты отделены от транзакций между логическими и физическими адресатами или деталей маршрута; они просто работают с логическими URI и перемещаются по принципу REST по модели ресурсов. Клиенты формируют запросы, используя логические URI, а пограничные серверы переводят логические URI в физические адреса реплики, которая управляет ресурсом и пересылает запрос. Маршрутизация становится чрезвычайно эффективной с помощью кэширования пограничными серверами (и периодических обновлений) таблицы маршрутизации. 
2.	**Прямой режим подключения.** Клиенты непосредственно управляют таблицей маршрутизации в пространстве процесса и периодически обновляют ее. Клиент может напрямую подключаться к репликам и обойти пограничные серверы.   


<table width="300">
    <tbody>
        <tr>
            <td width="120" valign="top">
                <p>
                    <strong>Режим подключения</strong>
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    <strong>Протокол</strong>
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    <strong>Сведения</strong>
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    <strong>Пакеты SDK DocumentDB</strong>
                </p>
            </td>
        </tr>
        <tr>
            <td width="120" valign="top">
                <p>
                    Шлюз
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    HTTPS
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    Приложения непосредственно соединяется с пограничными узлами, используя логические идентификаторы URI. При этом добавляется дополнительный сетевой узел для перехода.
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    Интерфейсы API REST
                </p>
                <p>
                    .NET, JavaScript, Node.js, Python
                </p>
            </td>
        </tr>
        <tr>
            <td width="120" valign="top">
                <p>
                    Непосредственное подключение
                </p>
            </td>
            <td width="66" valign="top">
                <p>
                    HTTPS и
                </p>
                <p>
                    TCP
                </p>
            </td>
            <td width="264" valign="top">
                <p>
                    Приложения могут получить непосредственный доступ к таблице маршрутизации и выполнить маршрутизацию на стороне клиента для прямого подключения к репликам.
                </p>
            </td>
            <td width="150" valign="top">
                <p>
                    .NET
                </p>
            </td>
        </tr>
    </tbody>
</table>

##Дальнейшие действия
Изучите [Справочник по API REST Azure DocumentDB](https://msdn.microsoft.com/library/azure/dn781481.aspx), чтобы узнать больше о работе с ресурсами с использованием интерфейса API REST.

##Ссылки
-   [Справочник по API REST Azure использования documentdb по плану](https://msdn.microsoft.com/library/azure/dn781481.aspx) 
-	REST [http://en.wikipedia.org/wiki/Representational_state_transfer](http://en.wikipedia.org/wiki/Representational_state_transfer)
-	Спецификация JSON  [http://www.ietf.org/rfc/rfc4627.txt](http://www.ietf.org/rfc/rfc4627.txt)
-	HTTP specification [http://www.w3.org/Protocols/rfc2616/rfc2616.html](http://www.w3.org/Protocols/rfc2616/rfc2616.html)
-	Теги ETag [http://en.wikipedia.org/wiki/HTTP_ETag](http://en.wikipedia.org/wiki/HTTP_ETag)
-	[Запросы DocumentDB](documentdb-sql-query.md)
-	[Справочник по языку SQL DocumentDB](https://msdn.microsoft.com/library/azure/dn782250.aspx)
-	[Программирование DocumentDB. Хранимые процедуры, триггеры и определяемые пользователем функции](../documentdb-programming/)
-	[Справочная документация по DocumentDB](https://msdn.microsoft.com/library/azure/dn781482.aspx)


[1]: ./media/documentdb-interactions-with-resources/interactions-with-resources2.png

<!--HONumber=49-->