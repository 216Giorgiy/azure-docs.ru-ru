<properties title="Interact with DocumentDB resources" pageTitle="Interact with DocumentDB resources | Azure" description="DocumentDB manages resources--uniquely identified by logical URIs--that developers can interact with using HTTP verbs, request/response headers, and status codes." metaKeywords="" services="documentdb" solutions="data-management"  authors="bradsev" manager="jhubbard" editor="cgronlun" videoId="" scriptId="" />

<tags ms.service="documentdb" ms.workload="data-services" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="08/20/2014" ms.author="bradsev"></tags>

# Взаимодействие с ресурсами DocumentDB

DocumentDB предлагает простую и открытую модель программирования RESTful поверх HTTP. В предварительной версии DocumentDB имеются клиентские пакеты SDL для .NET, Python, Node.js и JavaScript, все они являются обертками над интерфейсами API REST. В будущих версиях также будут выпущены пакеты SDK для C++ и Java. Мы рекомендуем Вам написать свои собственные пакеты SDK для конкретной среды программирования и поделиться ими с сообществом так же, как мы открыли наши пакеты SDK.

> [AZURE.NOTE] Кроме того, также предлагается весьма эффективный протокол TCP, который также является RESTful в своей коммуникационной модели, которая доступна через клиентский .NET SDK.

## Ресурсы

Сущности, которыми управляет DocumentDB, называются **ресурсами**, которые однозначно идентифицируются своими логическими URI. Разработчики могут взаимодействовать с ресурсами, используя стандартные команды HTTP, заголовки запросов/ответов и коды состояний. Как показано на нижеприведенном рисунке, **модель ресурсов** DocumentDB состоит из наборов ресурсов под учетной записью базы данных, каждый из которых адресуется логическим постоянным URI. Набор ресурсов в данном документе называется **каналом**.

![][]

## Иерархическая модель ресурсов под учетной записью базы данных

Являясь клиентом DocumentDB, вы начинаете с подготовки **учетной записи базы данных** для DocumentDB с использованием своей подписки Azure. Учетная запись базы данных может состоять из набора **баз данных**, каждая из которых содержит несколько **коллекций**, каждая из которых в свою очередь содержит **хранимые процедуры, триггеры, определяемые пользователем функции, документы** и соответствующие **вложения**. База данных также имеет связанных с ней **пользователей**, каждый из которых обладает набором **разрешений** для доступа к коллекциям, хранимым процедурам, триггерам, определяемым пользователем функциям, документам и вложениям. В то время как базы данных, пользователи, разрешения и коллекции являются определяемыми системой ресурсами с известными схемами, документы и вложения содержат произвольный, определяемый пользователем контент в формате JSON.

| Ресурс                             | Описание                                                                                                                                                                                                                                                                                                             |
|------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Учетная запись базы данных         | Учетная запись базы данных связана с одним или несколькими единицами объема, представляющих подготовленное хранилище документов и пропускную способность, набор баз данных и хранения BLOB-объектов. Вы можете создать одну или несколько учетных записей базы данных с помощью подписки Azure.                      |
| База данных                        | База данных представляет собой логический контейнер для хранения документов, разделенных между коллекциями. Она также является контейнером для пользователей.                                                                                                                                                        |
| Пользователь                       | Логическое пространство имен для ограничений/разграничений разрешений.                                                                                                                                                                                                                                               |
| Разрешение                         | Метка авторизации, связанная с пользователем, имеющим право на доступ к определенному ресурсу.                                                                                                                                                                                                                       |
| Коллекция                          | Коллекция представляет собой контейнер документов JSON и связанную с ними логику в виде приложения JavaScript.                                                                                                                                                                                                       |
| Хранимая процедура                 | Логика приложения, написанная на JavaScript, которая зарегистрирована в коллекции и выполняется в транзакции в ядре базы данных.                                                                                                                                                                                     |
| Триггер                            | Логика приложения, написанная на JavaScript для моделирования побочных эффектов, связанных с операциями вставки, замены и удаления.                                                                                                                                                                                  |
| Определяемая пользователем функция | Логика приложения, написанного на JavaScript, не имеющая побочных эффектов. Пользовательские функции позволяют моделировать операторы пользовательских запросов и тем самым расширить базовый язык запросов DocumentDB.                                                                                              |
| Документ                           | Пользовательский (произвольный) контент JSON. По умолчанию, нет необходимости определения схемы или обеспечения вторичных индексов для всех документов, добавляемых в коллекцию.                                                                                                                                     |
| Вложение                           | Вложение — это специальный документ, содержащий ссылки и связанные с ним метаданные к внешним BLOB-объектам/носителям. Разработчик может выбрать, управлять ли BLOB-объектами в DocumentDB или хранить их с помощью внешних поставщиков услуг хранения больших двоичных объектов, таких как OneDrive, Dropbox и т.д. |

### Системные и пользовательские ресурсы

Ресурсы (такие как учетные записи баз данных, базы данных, коллекции, пользователи, разрешения, хранимые процедуры, триггеры и определяемые пользователем функции) имеют статическую схему и называются *системными ресурсами*. В отличие от таких ресурсов, как документы и вложения, не имеющих ограничений по схеме, которые являются примерами *пользовательских ресурсов*. В DocumentDB системные и пользовательские ресурсы представляются и управляются как стандартные, совместимые с JSON-объекты. Все ресурсы, системные и пользовательские, имеют следующие общие свойства.

> [AZURE.NOTE] Обратите внимание, что все сгенерированные системой свойства в ресурсах начинаются с символа подчеркивания (\_) в представлении JSON.

<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><p><strong>Свойство</strong></p></td>
<td align="left"><p><strong>Устанавливаемое пользователем или генерируемое системой?</strong></p></td>
<td align="left"><p><strong>Назначение</strong></p></td>
</tr>
<tr class="even">
<td align="left"><p>_rid</p></td>
<td align="left"><p>Генерируемое системой</p></td>
<td align="left"><p>Генерируемый системой уникальный иерархический идентификатор ресурса</p></td>
</tr>
<tr class="odd">
<td align="left"><p>_etag</p></td>
<td align="left"><p>Генерируемое системой</p></td>
<td align="left"><p>etag ресурса, необходимый для управления оптимистичным параллелизмом</p></td>
</tr>
<tr class="even">
<td align="left"><p>_ts</p></td>
<td align="left"><p>Генерируемое системой</p></td>
<td align="left"><p>Метка времени последнего обновления ресурса</p></td>
</tr>
<tr class="odd">
<td align="left"><p>_self</p></td>
<td align="left"><p>Генерируемое системой</p></td>
<td align="left"><p>Уникальный адресуемый URI ресурса</p></td>
</tr>
<tr class="even">
<td align="left"><p>ид</p></td>
<td align="left"><p>Устанавливаемое пользователем</p></td>
<td align="left"><p>Устанавливаемое пользователем уникальное имя ресурса</p></td>
</tr>
</tbody>
</table>

### Сетевое представление ресурсов

DocumentDB не требует никаких собственных расширений помимо стандарта JSON или специальных кодировок; она работает со документами, совместимыми со стандартом JSON.

### Адресация ресурса

Все ресурсы можно адресовать по URI. Значение свойства \*\*\_self\*\* ресурса представляет относительный URI ресурса. Формат URI состоит из сегментов пути /<feed>/{\_rid}:

|Значение \_self |Описание
|-------------------|-----------
|/dbs |поток баз данных под учетной записью базы данных
|/dbs/{\_rid-db} |База данных с уникальным свойством идентификатора и значением {\_rid-db}
|/dbs/{\_rid-db}/colls/ |поток коллекций в базе данных
|/dbs/{\_rid-db}/colls/{\_rid-coll} |Коллекция с уникальным свойством идентификатора и значением {\_rid-coll}
|/dbs/{\_rid-db}/users/ |поток коллекций в базе данных
|/dbs/{\_rid-db}/users/{\_rid-user} |Пользователь с уникальным свойством идентификатора и значением {\_rid-user}
|/dbs/{\_rid-db}/users/{\_rid-user}/permissions |поток пользователей в базе данных
|/dbs/{\_rid-db}/users/{\_rid-user}/permissions/{\_rid-permission} |Разрешение уникальным свойством идентификатора и значением {\_rid-permission}

Ресурс также имеет уникальное определенное пользователем имя, указанное через свойство идентификатора ресурса. Идентификатор определяется пользователем, имеет вид строки длиной до 256 символов, которая является уникальной в контексте конкретного родительского ресурса. Например, значения идентификатора свойства всех документов в рамках данной коллекции уникальны, но их уникальность не гарантируется среди разных коллекций. Также, значения идентификатора свойства всех разрешений в рамках данного пользователя уникальны, но их уникальность не гарантируется среди разных пользователей. Свойство \_rid используется для построения адресуемой ссылки ресурса \_self.

Каждый ресурс имеет также иерархический идентификатор ресурсов, генерируемый системой (также известный как, RID), который доступен через свойство \_rid. RID кодирует всю иерархию данного ресурса, и это очень удобное внутреннее представление используется для обеспечения ссылочной целостности распределенным образом. RID является уникальным в пределах учетной записи базы данных и используется внутри DocumentDB для эффективной маршрутизации без необходимости выполнения перекрестных выборок разделов.

Значения свойств \_self и \_rid являются альтернативным и каноническим представлениями ресурса.

## Базовая модель взаимодействия

Ресурсы поддерживают следующие команды HTTP в их стандартной интерпретации:

> [AZURE.NOTE] В будущем мы намерены добавить поддержку выборочных обновлений с помощью команды PATCH.

1.  POST обозначает создание нового элемента ресурса.
2.  GET обозначает чтение существующего элемента или потока ресурса
3.  PUT обозначает замену существующего элемента ресурса
4.  DELETE обозначает удаление существующего элемента ресурса
5.  HEAD означает ответ команды GET без полезной нагрузки (т.е. только заголовки)

В следующих версиях будет добавлена поддержка команды PATCH.

Как показано на рисунке ниже, команда POST может быть выполнена только для потокового ресурса; PUT, DELETE могут быть выполнены только для элементного ресурса; GET и HEAD могут быть выполнены для любых ресурсов.

![][1]

**Модель взаимодействия с использованием стандартных команд HTTP**

Чтобы получить лучшее представление о модели взаимодействия, давайте рассмотрим случай создания нового ресурса (INSERT). Для того чтобы создать новый ресурс Вы должны сформировать запрос HTTP POST с телом запроса, содержащим представление ресурса и URI контейнера, которому принадлежит поток. Единственным обязательным признаком для запроса является идентификатор ресурса.

В качестве примера, для того чтобы создать новую базу данных, вы формируете запрос POST к ресурсу базы данных (установив свойство идентификатора с уникальным именем) к /DBS, и, аналогично, для того чтобы создать новую коллекцию, вы формируете запрос POST к ресурсу коллекции к /DBS/\_rid/colls/ и так далее. Ответ будет содержать полностью завершенный ресурс с сгенерированными системой свойствами, включая ссылку ресурса \_self, используя которую вы можете перемещаться к другим ресурсам. В качестве примера простой модели взаимодействия, основанной на HTTP, клиент может оформить запрос HTTP, чтобы создать новую базу данных в учетной записи:

    POST http://fabrikam.documents.azure.net/dbs
    {
          "id":"MyDb"
    }

DocumentDB возвращает успешный ответ и код состояния, обозначающий успешное создание базы данных.

    [201 Created]
    {
          "id": "MyDb",
          "_rid": "UoEi5w==",
          "_self": "dbs/MyDb/",
          "_ts": 1407370063,
          "_etag": "\"00002100-0000-0000-0000-50e71fda0000\"",
          "_colls": "colls/",
          "_users": "users/"
    }

Служба DocumentDB возвращает успешный ответ и код состояния, обозначающий успешное создание базы данных.

В качестве другого примера создания и выполнения ресурса, рассмотрим следующую хранимую процедуру, написанную полностью на JavaScript.

    function sproc(docToCreate, addedPropertyName, addedPropertyValue) {
        var collectionManager = getContext().getCollection();
        collectionManager.createDocument(collectionManager.getSelfLink(), docToCreate,   
        function(err, docCreated) {
            if(err) throw new Error('Error while creating document: ' + err.message);
            
            docCreated.addedPropertyName = addedPropertyValue;
            getContext().getResponse().setBody(docCreated);
        });
    }

Хранимая процедура может быть зарегистрирована в коллекции под MyDB путем выдачи команды POST с параметрами /dbs/\_rid-db/colls/\_rid-coll/sprocs.

    POST /dbs/MyDb/colls/MyColl/sprocs HTTP/1.1

    {
      "id": "sproc1",
      "body": "function (docToCreate, addedPropertyName, addedPropertyValue) {
                    var collectionManager = getContext().getCollection();
                    collectionManager.createDocument(collectionManager.getSelfLink(), 
                                docToCreate, function(err, docCreated) {
                        if(err) throw new Error('Error while creating document: ' + 
                                                         err.message);
                        
                        docCreated.addedPropertyName = addedPropertyValue;
                        getContext().getResponse().setBody(docCreated);
                    });
                }"
    }

Служба DocumentDB возвращает успешный ответ и код состояния, обозначающий успешную регистрацию хранимой процедуры.

    [201 Created]
    {
          "id": "sproc1",
          "_rid": "EoEi5w==",
          "_self": "dbs/MyDb/colls/MyColl/sprocs/sproc1",
          "_etag": "\"00002100-0000-0000-0000-50f71fda0000\"",
           ...
    }

Наконец, чтобы выполнить хранимую процедуру в приведенном выше примере, нужно сформировать POST с URI хранимый процедуры ресурса (/dbs/\_rid-db/colls/\_rid-coll/sprocs/sproc1). Это показано ниже:

    POST /dbs/MyDb/colls/MyColl/sprocs/sproc1 HTTP/1.1
     [ { "id": "TestDocument", "book": "Autumn of the Patriarch"}, "Price", 200 ]

Служба DocumentDB ответит следующим образом:

    HTTP/1.1 200 OK
     { 
      "id": "TestDocument",  
      "_rid": "ZTlcANiwqwIBAAAAAAAAAA==",
      "_ts": 1407370063,
      "_self": "dbs/ZTlcAA==/colls/ZTlcANiwqwI=/docs/ZTlcANiwqwIBAAAAAAAAAA==/",
      "_etag": "00000900-0000-0000-0000-53e2c34f0000",
      "_attachments": "attachments/",
      "book": "Autumn of the Patriarch", 
      "price": 200
    }

Обратите внимание, что команда POST используется как для создания нового ресурса, выполнения хранимой процедуры так и для выполнения SQL-запроса. Чтобы проиллюстрировать выполнение запросов SQL, необходимо учитывать следующее:

    POST /dbs/MyDb/colls/MyColl/docs HTTP/1.1
    ...
    x-ms-documentdb-isquery: True
    Content-Type: application/sql

    SELECT * FROM root.children

Ответ службы является результатом выполнения запроса SQL.

    HTTP/1.1 200 Ok
    x-ms-activity-id: 83f9992c-abae-4eb1-b8f0-9f2420c520d2
    x-ms-item-count: 2
    x-ms-session-token: 81
    x-ms-request-charge: 1.43
    Content-Length: 287

    {"_rid":"sehcAIE2Qy4=","Documents":[[{"firstName":"Henriette Thaulow","gender":"female","grade":5,"pets":[{"givenName":"Fluffy"}]}],[{"familyName":"Merriam","givenName":"Jesse","gender":"female","grade":1},{"familyName":"Miller","givenName":"Lisa","gender":"female","grade":8}]],"count":2}

Замена или чтение группы ресурсов осуществляется соответственно командами PUT (с правильным телом запроса) и GET к ссылке \_self ресурса. Кроме того, для удаления ресурса используется команда DELETE к ссылке \_self ресурса. Стоит отметить, что иерархическая организация ресурсов в ресурсной модели DocumentDB требует поддержки каскадного удаления, при котором удаление владельца ресурса влечет за собой и удаление самого ресурса. Зависимые ресурсы могут быть распределены по другим узлам, отличающимся от узлов владельца и, таким образом, удаление может произойти независимо. Независимо от механизма сбора мусора, при удалении ресурса, квота мгновенно освобождается и доступна для повторного использования. Следует отметить, что в системе сохраняется ссылочная целостность. Например, вы не можете вставить коллекцию в базу данных, которая уже удалена или заменить или запросить документ, которого уже нет.

Запрос GET к потоку (из) ресурсов или запрос к коллекции может привести к потенциальному количеству в миллионы элементов, что делает его непрактичным как для создания со стороны сервера, так и для обработки со стороны клиента в рамках одного обмена одного запроса-ответа. Для решения этой проблемы, DocumentDB позволяет клиентам разбивать на результаты запросов страницы в реальном времени. Клиенты могут использовать заголовок ответа [x-ms-continuationToken] в качестве курсора для перехода к следующей странице.

## Управление оптимистичным параллелизмом

Большинство веб-приложений основываются на оптимистическом управлении параллелизмом с метками сущностей, чтобы избежать печально известных проблем "потеря операции обновления" или "потеря операции удаления". Метка сущностей соответствует требованиям HTTP, логическая временная метка связывается с ресурсом. DocumentDB изначально поддерживает оптимистическое управление параллелизмом, гарантируя, что каждый ответ HTTP содержит версию (надежно), связанную с конкретным ресурсом. Конфликты управления параллелизмом правильно обнаруживаются в следующих случаях:

1.  Если два клиента одновременно формируют запросы на изменение (с помощью команд PUT/DELETE) ресурса с текущей версией ресурса (указывается в разделе [if-match] заголовка запроса), ядро ​​базы данных DocumentDB передает их управлению транзакционного параллелизма.
2.  Если клиент представляет старую версию ресурса (указывается в разделе [if-match] заголовка запроса), его запрос будет отклонен.

## Возможности подключения

DocumentDB предлагает модель логической адресации, где каждый ресурс имеет логический статический идентификатор URI по ссылке \_self. В распределенной системе хранения информация распределена по регионам, ресурсы различных учетных записей баз данных в DocumentDB разбиваются по многочисленным серверам и каждый раздел реплицируется для обеспечения высокой доступности. Реплики, управляющие ресурсами данного раздела, регистрируют физические адреса. В то время как физические адреса могут меняться в течение времени по причине сбоев, их логические адреса остаются стабильными и постоянным. Соответствие логического и физического адресов хранится в таблице маршрутизации, которая также внутренне доступна в качестве ресурса. DocumentDB предоставляет два режима подключения:

1.  **Режим шлюза:**Клиенты не узнают о трансляции логических адресов в физические или деталей маршрутизации; они просто работают с логическими URI и переходят по модели ресурса по принципу RESTful. Клиенты формируют запросы, используя логические URI, а пограничные узлы осуществляют перевод логических URI в физический адрес реплики, которая управляет ресурсом, и пересылают запрос. Маршрутизация запросов чрезвычайно эффективно при использовании кэширования таблицы маршрутизации на пограничных узлах (и периодическом ее обновлении).
2.  **Прямой режим подключения:**Клиенты непосредственно управляют таблицей маршрутизации в собственном пространстве обработки и периодически обновляют ее. Клиент может сразу соединиться с репликами и обойти пограничные узлы.

<table>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"><p><strong>Режим подключения</strong></p></td>
<td align="left"><p><strong>Протокол</strong></p></td>
<td align="left"><p><strong>Подробная информация</strong></p></td>
<td align="left"><p><strong>Пакеты SDK для DocumentDB</strong></p></td>
</tr>
<tr class="even">
<td align="left"><p>Шлюз</p></td>
<td align="left"><p>HTTPS</p></td>
<td align="left"><p>Приложения непосредственно соединяется с пограничными узлами, используя логические идентификаторы URI. При этом добавляется дополнительный сетевой узел для перехода.</p></td>
<td align="left"><p>Интерфейсы API REST</p>
<p>.NET, JavaScript, Node.js, Python</p></td>
</tr>
<tr class="odd">
<td align="left"><p>Непосредственное подключение</p></td>
<td align="left"><p>HTTPS и</p>
<p>TCP</p></td>
<td align="left"><p>Приложения могут получить непосредственный доступ к таблице маршрутизации и выполнить маршрутизацию на стороне клиента для прямого подключения к репликам.</p></td>
<td align="left"><p>.NET</p></td>
</tr>
</tbody>
</table>

## Ссылки

-   REST [][]<http://en.wikipedia.org/wiki/Representational_state_transfer></a>
-   Спецификация JSON [][2]<http://-www.ietf.org/rfc/rfc4627.txt></a>
-   Спецификация HTTP [][3]<http://www.w3.org/Protocols/rfc2616/rfc2616.html></a>
-   Идентификаторы ETag [][4]<http://en.wikipedia.org/wiki/HTTP_ETag></a>
-   [Запросы DocumentDB][]
-   [Справочник по DocumentDB SQL][]
-   [Программирование DocumentDB: Хранимые процедуры, триггеры и определяемые пользователем функции][]
-   [Справочная документация DocumentDB][]

  []: ./media/documentdb-interactions-with-resources/interactions-with-resources1.png
  [1]: ./media/documentdb-interactions-with-resources/interactions-with-resources2.png
  []: http://en.wikipedia.org/wiki/Representational_state_transfer
  [2]: http://-www.ietf.org/rfc/rfc4627.txt
  [3]: http://www.w3.org/Protocols/rfc2616/rfc2616.html
  [4]: http://en.wikipedia.org/wiki/HTTP_ETag
  [Запросы DocumentDB]: /documentation/articles/documentdb-sql-query/
  [Справочник по DocumentDB SQL]: http://go.microsoft.com/fwlink/p/?LinkID=510612
  [Программирование DocumentDB: Хранимые процедуры, триггеры и определяемые пользователем функции]: /documentation/articles/documentdb-programming/
  [Справочная документация DocumentDB]: http://go.microsoft.com/fwlink/p/?LinkID=402384
