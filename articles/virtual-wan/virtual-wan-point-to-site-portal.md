---
title: Создание подключения типа "точка — сеть" с помощью Виртуальной глобальной сети Azure | Документация Майкрософт
description: В руководстве показано, как создать VPN-подключение типа "точка — сеть" в Azure с помощью Виртуальной глобальной сети Azure.
services: virtual-wan
author: anzaman
ms.service: virtual-wan
ms.topic: tutorial
ms.date: 02/27/2019
ms.author: alzam
Customer intent: As someone with a networking background, I want to connect remote users to my VNets using Virtual WAN and I don't want to go through a Virtual WAN partner.
ms.openlocfilehash: 9fe0c7f7ae0c19833421b647449f0e4100904f5b
ms.sourcegitcommit: 12d67f9e4956bb30e7ca55209dd15d51a692d4f6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58226238"
---
# <a name="tutorial-create-a-point-to-site-connection-using-azure-virtual-wan-preview"></a>Руководство. Создание подключения "точка — сеть" с помощью Виртуальной глобальной сети Azure (предварительная версия)

В этом руководстве показано, как создать подключение к ресурсам в Azure через VPN-соединение IPsec/IKE (IKEv2) или OpenVPN с помощью Виртуальной глобальной сети. Этот тип подключения требует, чтобы клиент был настроен на клиентском компьютере. Дополнительные сведения о Виртуальной глобальной сети см. в [этой статье](virtual-wan-about.md).

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание глобальной сети.
> * Создание конфигурации подключения "точка — сеть"
> * Создание концентратора.
> * Применение конфигурации подключения "точка — сеть" к концентратору
> * Подключение виртуальной сети к концентратору.
> * Скачивание и применение конфигурации VPN-клиента
> * Просмотр виртуальной глобальной сети
> * Просмотр состояния работоспособности ресурса.
> * Мониторинг подключения.

> [!IMPORTANT]
> Эта общедоступная предварительная версия предоставляется без соглашения об уровне обслуживания и не должна использоваться для производственных рабочих нагрузок. Некоторые функции могут не поддерживаться, иметь ограничения и быть доступными не во всех расположениях Azure. См. [дополнительные условия использования для предварительных версий Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).
>

## <a name="before-you-begin"></a>Перед началом работы

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

[!INCLUDE [Before you begin](../../includes/virtual-wan-tutorial-vwan-before-include.md)]

## <a name="register"></a>Регистрация этой возможности

Нажмите кнопку **Попробовать**, чтобы зарегистрировать эту возможность с помощью Azure Cloud Shell. Если PowerShell лучше запустить локально, убедитесь, что используете последнюю версию и выполните вход с помощью команд **Connect-AzAccount** и **Select-AzSubscription**.

>[!NOTE]
>Если не зарегистрировать эту возможность, вы не сможете ею пользоваться и не увидите ее на портале.
>
>

После нажатия кнопки **Попробовать**, чтобы открыть Azure Cloud Shell, скопируйте и вставьте следующие команды:

```azurepowershell-interactive
Register-AzProviderFeature -ProviderNamespace Microsoft.Network -FeatureName AllowP2SCortexAccess
```
 
```azurepowershell-interactive
Register-AzProviderFeature -ProviderNamespace Microsoft.Network -FeatureName AllowVnetGatewayOpenVpnProtocol
```

```azurepowershell-interactive
Get-AzProviderFeature -ProviderNamespace Microsoft.Network -FeatureName AllowP2SCortexAccess
```

```azurepowershell-interactive
Get-AzProviderFeature -ProviderNamespace Microsoft.Network -FeatureName AllowVnetGatewayOpenVpnProtocol
```

Когда возможность отобразится как зарегистрированная, зарегистрируйте подписку на пространство имен Microsoft.Network.

```azurepowershell-interactive
Register-AzResourceProvider -ProviderNamespace Microsoft.Network
```

## <a name="vnet"></a>1. Создать виртуальную сеть

[!INCLUDE [Create a virtual network](../../includes/virtual-wan-tutorial-vnet-include.md)]

## <a name="openvwan"></a>2. Создание виртуальной глобальной сети

В браузере откройте [портал Azure (предварительная версия)](https://aka.ms/azurevirtualwanpreviewfeatures) и выполните вход с помощью учетной записи Azure.

[!INCLUDE [Create a virtual WAN](../../includes/virtual-wan-tutorial-vwan-include.md)]

## <a name="hub"></a>3. Создание концентратора.

> [!NOTE]
> На этом шаге не выбирайте параметр "Включить шлюз точка — сеть".
>

[!INCLUDE [Create a virtual WAN](../../includes/virtual-wan-tutorial-hub-include.md)]

## <a name="site"></a>4. Создание конфигурации подключения "точка — сеть"

Конфигурации подключения "точка — сеть" определяет параметры для подключения удаленных клиентов.

1. Перейдите к разделу **Все ресурсы**.
2. Щелкните созданную виртуальную глобальную сеть.
3. В разделе **Архитектура виртуальной глобальной сети** щелкните **Конфигурация подключения "точка — сеть"**.
4. Щелкните **+ Добавить конфигурацию подключения "точка — сеть"** в верхней части страницы, чтобы открыть страницу **Создание новой конфигурации подключения "точка — сеть"**.
5. На странице **Создание новой конфигурации подключения "точка — сеть"** заполните следующие поля.

   *  **Имя конфигурации**. Имя, с помощью которого вы будете ссылаться на свою конфигурацию.
   *  **Тип туннеля**. Протокол, используемый для туннеля.
   *  **Пул адресов**. Это пул IP-адресов, из которых будут назначаться клиенты.
   *  **Имя корневого сертификата**. Описательное имя для сертификата.
   *  **Данные корневого сертификата**. Данные сертификата X.509 с кодировкой Base-64.

6. Чтобы создать конфигурацию, щелкните **Создать**.

## <a name="hub"></a>5. Изменение назначения концентратора

1. На странице виртуальной глобальной сети щелкните **Концентраторы**.
2. Выберите концентратор, которому нужно назначить конфигурацию "точка — сеть".
3. Щелкните **...** и выберите **Изменение виртуального концентратора**.
4. Проверьте параметр **Включить шлюз " точка — сеть"** .
5. В раскрывающемся списке выберите **Единицы масштабирования шлюза**.
6. В раскрывающемся списке выберите созданную **конфигурацию "точка — сеть"**.
7. Настройте **пул адресов** для клиентов.
8. Щелкните **Confirm** (Подтвердить). Выполнение операции может занять до 30 минут.

## <a name="vnet"></a>6. Подключение виртуальной сети к концентратору

На этом шаге вы создаете пиринговое подключение между концентратором и виртуальной сетью. Повторите эти шаги для каждой виртуальной сети, которую вы хотите подключить.

1. На странице своей глобальной сети щелкните **Подключения к виртуальной сети**.
2. На странице подключения к виртуальной сети щелкните **+Добавить подключение**.
3. На странице **Добавление подключения** заполните следующие поля.

    * **Имя подключения**. Укажите имя своего подключения.
    * **Концентраторы**. Выберите концентратор, который нужно связать с этим подключением.
    * **Подписка**. Проверьте подписку.
    * **Виртуальная сеть**. Выберите виртуальную сеть, которую вы хотите подключить к этому концентратору. В виртуальной сети не должно быть шлюза виртуальной сети.
4. Нажмите кнопку **ОК**, чтобы добавить подключение.

## <a name="device"></a>7. Загрузка профиля VPN

Используйте профиль VPN для настройки клиентов.

1. На странице виртуальной глобальной сети щелкните **Концентраторы**.
2. Выберите концентратор, для которого нужно скачать профиль.
3. Щелкните **...** и выберите **Скачать профиль**. 
4. После завершения создания файла вы можете скачать его, щелкнув ссылку.
4. Используйте файл профиля для настройки клиентов подключения "точка — сеть".

## <a name="device"></a>8. Настройка подключения "точка — сеть"
Используйте загруженный профиль для настройки клиентов удаленного доступа. Процедуры для каждой операционной системы отличаются, поэтому следуйте приведенным ниже инструкциям.

### <a name="microsoft-windows"></a>Microsoft Windows
#### <a name="openvpn"></a>OpenVPN

1.  С официального веб-сайта загрузите и установите клиент OpenVPN.
2.  Загрузите профиль VPN для шлюза. Это можно сделать со вкладки конфигурации "точка — сеть" на портале Azure или с помощью New-AzVpnClientConfiguration в PowerShell.
3.  Распакуйте профиль. Откройте файл конфигурации vpnconfig.ovpn из папки OpenVPN в Notepad.
4.  Заполните раздел сертификата клиента подключения "точка — сеть" открытым ключом сертификата клиента P2S в формате base64. В сертификате с форматированием PEM вы можете просто открыть файл CER и скопировать ключ в формате base64, находящийся между заголовками сертификата. Сведения о том, как экспортировать сертификат, чтобы получить закодированный открытый ключ, см. ниже.
5.  Заполните раздел секретного ключа закрытым ключом сертификата клиента P2S в base64. Как извлечь закрытый ключ, см. в этом разделе.
6.  Не изменяйте остальные поля. Для подключения к VPN используйте заполненную конфигурацию на входе клиента.
7.  Скопируйте файл vpnconfig.ovpn в папку C:\Program Files\OpenVPN\config.
8.  Щелкните правой кнопкой мыши значок OpenVPN в области уведомлений и щелкните "Подключить".

#### <a name="ikev2"></a>IKEv2

1. Выберите файлы конфигурации VPN-клиента, которые соответствуют архитектуре компьютера Windows. Для 64-разрядной архитектуры процессора выберите пакет установщика VpnClientSetupAmd64. Для 32-разрядной архитектуры процессора выберите пакет установщика VpnClientSetupX86.
2. Дважды щелкните пакет, чтобы установить его. При появлении всплывающего окна SmartScreen щелкните "Подробнее", а затем выберите "Выполнить в любом случае".
3. На клиентском компьютере перейдите в раздел "Параметры сети" и щелкните "VPN". Для VPN-подключения отображается имя виртуальной сети, к которой оно устанавливается.
4. Перед попыткой подключения убедитесь, что вы установили сертификат клиента на клиентском компьютере. Сертификат клиента требуется при использовании собственной аутентификации Azure на основе сертификата. Дополнительные сведения о создании сертификатов см. в разделе "Создание сертификатов". Сведения о том, как установить сертификат клиента, см. в разделе "Установка сертификата клиента".

### <a name="mac-os-x"></a>Mac (OS X)
#### <a name="openvpn"></a>OpenVPN

1.  Скачайте и установите клиент OpenVPN, например TunnelBlik с https://tunnelblick.net/downloads.html. 
2.  Загрузите профиль VPN для шлюза. Это можно сделать с помощью вкладки конфигурации "точка — сеть" на портале Azure или командлета New-AzVpnClientConfiguration в PowerShell.
3.  Распакуйте профиль. Откройте файл конфигурации vpnconfig.ovpn из папки OpenVPN в Notepad.
4.  Заполните раздел сертификата клиента подключения "точка — сеть" открытым ключом сертификата клиента P2S в формате base64. В сертификате с форматированием PEM вы можете просто открыть файл CER и скопировать ключ в формате base64, находящийся между заголовками сертификата. Сведения о том, как экспортировать сертификат, чтобы получить закодированный открытый ключ, см. ниже.
5.  Заполните раздел секретного ключа закрытым ключом сертификата клиента P2S в base64. Как извлечь закрытый ключ, см. в этом разделе.
6.  Не изменяйте остальные поля. Для подключения к VPN используйте заполненную конфигурацию на входе клиента.
7.  Чтобы создать профиль в Tunnelblik, дважды щелкните файл профиля.
8.  Запустите Tunnelblik из папки приложения.
9.  Нажмите значок Tunneblik на панели задач и выберите подключение.

#### <a name="ikev2"></a>IKEv2

Azure не предоставляет файл mobileconfig для собственной аутентификации Azure на основе сертификата. Необходимо вручную настроить VPN-клиент IKEv2 на каждом компьютере Mac, который будет подключаться к Azure. В папке "Generic" содержатся все сведения, необходимые для настройки. Если папки Generic нет в скачанных файлах, вполне вероятно, что IKEv2 не был выбран в качестве типа туннеля. Выбрав IKEv2, создайте ZIP-файл еще раз для получения папки Generic. Эта папка содержит следующие файлы:

- Файл VpnSettings.xml содержит такие важные параметры, как адрес сервера и тип туннеля.
- Файл VpnServerRoot.cer содержит корневой сертификат, который требуется для проверки VPN-шлюза Azure при настройке подключения типа "точка — сеть".

## <a name="viewwan"></a>9. Просмотр виртуальной глобальной сети

1. Перейдите к виртуальной глобальной сети.
2. На странице обзора каждая точка на карте представляет собой концентратор. Наведите курсор на любую точку, чтобы просмотреть сводку о работоспособности концентратора.
3. В разделе концентраторов и подключений можно просмотреть сведения о состоянии концентратора, сайте, регионе, состоянии VPN-подключения, приеме и передаче байтов.

## <a name="viewhealth"></a>10. Просмотр состояния работоспособности ресурса

1. Перейдите к своей глобальной сети.
2. На странице глобальной сети в разделе **Поддержка и устранение неполадок** щелкните **Работоспособность** и просмотрите сведения о своем ресурсе.

## <a name="connectmon"></a>11. Мониторинг подключения.

Создайте подключение для мониторинга связи между виртуальной машиной Azure и удаленным сайтом. Сведения о настройке монитора подключения см. в статье [Руководство. Мониторинг сетевого взаимодействия между двумя виртуальными машинами с помощью портала Azure](~/articles/network-watcher/connection-monitor.md). Исходным адресом является IP-адрес виртуальной машины в Azure, а IP-адресом назначения — IP-адрес сайта.

## <a name="cleanup"></a>12. Очистка ресурсов

Вы можете удалить ненужную группу ресурсов и все содержащиеся в ней ресурсы с помощью командлета [Remove-AzResourceGroup](/powershell/module/az.resources/remove-azresourcegroup). Замените myResourceGroup на имя вашей группы ресурсов и выполните следующую команду PowerShell:

```azurepowershell-interactive
Remove-AzResourceGroup -Name myResourceGroup -Force
```

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Создание глобальной сети.
> * Создание сайта.
> * Создание концентратора.
> * Подключение концентратора к сайту.
> * Подключение виртуальной сети к концентратору.
> * Скачивание и применение конфигурации VPN-устройства.
> * Просмотр виртуальной глобальной сети.
> * Просмотр состояния работоспособности ресурса.
> * Мониторинг подключения.

Дополнительные сведения о Виртуальной глобальной сети см. в [этой статье](virtual-wan-about.md).
