<properties
   pageTitle="Хранимые процедуры в хранилище данных SQL | Microsoft Azure"
   description="Советы по реализации хранимых процедур в хранилище данных SQL Azure для разработки решений."
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="jrowlandjones"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="01/07/2016"
   ms.author="jrj;barbkess;sonyama"/>

# Хранимые процедуры в хранилище данных SQL 

Хранилище данных SQL поддерживает многие функции Transact-SQL, доступные в SQL Server. Что более важно, в нем есть специальные функции разворачивания, с помощью которых можно максимально увеличить производительность решения.

Однако существует и некоторые компоненты и функции для обеспечения масштаба и производительности хранилища данных SQL, поведение которых отличается, а также те, что не поддерживаются.

В этой статье объясняется, как реализовать хранимые процедуры в хранилище данных SQL.

## Введение в хранимые процедуры
Хранимые процедуры — это отличный метод инкапсуляции кода SQL, при котором он хранится близко к данным в хранилище данных. Инкапсуляция кода в хранимые процедуры управляемых элементов помогает разработчикам добиться модульности своих решений и упрощает многократное использование кода. Каждая хранимая процедура может также принимать параметры, что делает их еще более гибкими.

Хранилище данных SQL предоставляет упрощенную и оптимизированную реализацию хранимых процедур. Главное отличие от SQL Server — хранимая процедура не является предварительно скомпилированным кодом. Обычно в хранилищах данных нас не очень интересует время компиляции. Гораздо важнее, чтобы код хранимой процедуры был правильно оптимизирован для обработки больших объемов данных. Цель — сэкономить часы, минуты и секунды, но не миллисекунды. Поэтому удобнее считать хранимые процедуры контейнерами для логики SQL.
 
Когда хранилище данных SQL выполняет хранимую процедуру, инструкции SQL анализируются, транслируются и оптимизируются во время выполнения. Во время этого процесса каждая инструкция преобразуется в распределенные запросы. Код SQL, который фактически выполняется с данными, отличается от отправляемого запроса.

## Вложенные хранимые процедуры
Когда хранимые процедуры вызывают другие хранимые процедуры или выполняют динамический код SQL, то внутреннюю хранимую процедуру или код вызова называют вложенным.

Хранилище данных SQL поддерживает до 8 уровней вложенности. Это немного отличается от SQL Server. Уровень вложенности в SQL Server — 32.

Вызов хранимой процедуры верхнего уровня считается 1 уровнем вложенности.

```
EXEC prc_nesting
``` 
Если хранимая процедура также выполняет другой вызов EXEC, то это приведет к увеличению уровня вложения до 2. ```
CREATE PROCEDURE prc_nesting
AS
EXEC prc_nesting_2  -- This call is nest level 2
GO
EXEC prc_nesting
``` Если вторая процедура затем выполняет какой-либо динамический код SQL, это увеличит уровень вложенности до 3. ```
CREATE PROCEDURE prc_nesting_2
AS
EXEC sp_executesql 'SELECT 'another nest level'  -- This call is nest level 2
GO
EXEC prc_nesting
```

Обратите внимание, что хранилище данных SQL в настоящее время не поддерживает @@NESTLEVEL. Необходимо самостоятельно следить за уровнем вложенности. Маловероятно, что вы дойдете до уровня вложенности 8, но если это случится, понадобится переделать код и преобразовать его в плоскую структуру, чтобы он не превышал это ограничение.

## INSERT..EXECUTE
Хранилище данных SQL не разрешает использовать результирующий набор хранимой процедуры в инструкции INSERT. Однако существует другой подход, которым можно воспользоваться.

Пример того, как это сделать, см. в следующей статье о [временных таблицах].

## Ограничения

Существуют некоторые аспекты хранимых процедур Transact-SQL, которые не реализованы в хранилище данных SQL.

К ним относятся:

- временные хранимые процедуры;
- нумерованные хранимые процедуры;
- расширенные хранимые процедуры;
- хранимые процедуры CLR;
- возможность шифрования;
- возможность репликации;
- параметры с табличным значением;
- параметры только для чтения;
- параметры по умолчанию;
- контекст выполнения;
- инструкция Return.

## Дальнейшие действия
Дополнительные советы по разработке см. в статье [Общие сведения о разработке][].

<!--Image references-->

<!--Article references-->
[временных таблицах]: sql-data-warehouse-develop-temporary-tables.md
[Общие сведения о разработке]: sql-data-warehouse-overview-develop.md

<!--MSDN references-->
[nest level]: https://msdn.microsoft.com/library/ms187371.aspx

<!--Other Web references-->

<!---HONumber=AcomDC_0114_2016-->