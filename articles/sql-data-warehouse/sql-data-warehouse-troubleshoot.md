<properties
   pageTitle="Устранение неполадок хранилища данных SQL Azure | Microsoft Azure"
   description="Диагностика и устранение неполадок хранилища данных SQL Azure."
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="sonyam"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="06/28/2016"
   ms.author="sonyama;barbkess"/>

# Устранение неполадок хранилища данных SQL Azure
В этом разделе описываются некоторые наиболее распространенные проблемы, с которыми пользователи сталкиваются при работе хранилищем данных SQL Azure.


##Ошибки подключения

В случае проблем при подключении ознакомьтесь с приведенными ниже наиболее распространенными проблемами, о которых сообщили клиенты.

### Ошибка CTAIP
Эта ошибка может возникнуть, когда имя для входа создано в базе данных master SQL Server, но не создано в базе данных хранилища данных SQL. Если возникла эта ошибка, ознакомьтесь со статьей [Общие сведения о безопасности][]. В этой статье объясняется, как создать имя для входа в базе данных master, а затем создать пользователя в базе данных хранилища данных SQL.

### Правила файрволла
Базы данных SQL Azure защищены брандмауэрами на уровне сервера и базы данных. Это гарантирует, что доступ к базам данных возможен только с известных IP-адресов. Брандмауэры являются безопасными по умолчанию. Это означает, что перед подключением необходимо прямо разрешить доступ для IP-адреса или диапазона IP-адресов. Чтобы настроить брандмауэр для предоставления доступа, выполните указания в разделе [Настройка доступа брандмауэра сервера к IP-адресу клиента][] на странице, содержащей [инструкции по подготовке][].

### Неподдерживаемые инструменты и протоколы
В хранилище данных SQL для запроса данных рекомендуется использовать [Visual Studio 2013 или Visual Studio 2015][]. Для подключения клиентов рекомендуется использовать [собственный клиент SQL Server 10 или SQL Server 11 (ODBC)][]. Среда SQL Server Management Studio (SSMS) пока не поддерживается, и, несмотря на то, что частично она функционирует, дерево обозревателя объектов не работает с хранилищем данных SQL, а запрос может быть выполнен после нескольких сообщений об ошибке.


## Проблемы с производительностью

Лучше всего начать изучение способов повышения производительности запросов со статьи [Рекомендации по использованию хранилища данных SQL][]. Если вы пытаетесь устранить проблемы конкретного запроса, то можно начать со статьи, [обучающей мониторингу запросов][]. Иногда ускорить выполнение запросов позволяет простое повышение вычислительной мощности, выделяемой для выполнения запросов, за счет [масштабирования хранилища данных SQL][].

## Качество кластеризованного сегмента Columnstore

Качество кластеризованного сегмента Columnstore имеет большое значение для эффективности выполнения запросов в кластеризованных таблицах Columnstore. Качество сегмента можно изменить по числу строк в сжатой группе строк. Следующий запрос определяет таблицы с низкой работоспособностью сегментов индекса Columnstore и создает код T-SQL для повторного формирования индекса Columnstore в этих таблицах. Первый столбец результата выполнения этого запроса содержит код T-SQL для повторного формирования каждого индекса. Второй столбец содержит рекомендации о том, какой минимальный класс ресурсов нужно использовать для оптимизации сжатия.
 
**Шаг 1**. Выполните этот запрос к каждой базе данных хранилища данных SQL, чтобы выявить все неоптимальные индексы columnstore кластера. Если строки не возвращаются, никаких дополнительных действий не требуется.

```sql
SELECT 
     'ALTER INDEX ALL ON ' + s.name + '.' + t.NAME + ' REBUILD;' AS [T-SQL to Rebuild Index]
    ,CASE WHEN n.nbr_nodes < 3 THEN 'xlargerc' WHEN n.nbr_nodes BETWEEN 4 AND 6 THEN 'largerc' ELSE 'mediumrc' END AS [Resource Class Recommendation]
    ,s.name AS [Schema Name]
    ,t.name AS [Table Name]
    ,AVG(CASE WHEN rg.State = 3 THEN rg.Total_rows ELSE NULL END) AS [Ave Rows in Compressed Row Groups]
FROM 
    sys.pdw_nodes_column_store_row_groups rg
    JOIN sys.pdw_nodes_tables pt 
        ON rg.object_id = pt.object_id AND rg.pdw_node_id = pt.pdw_node_id AND pt.distribution_id = rg.distribution_id
    JOIN sys.pdw_table_mappings tm 
        ON pt.name = tm.physical_name
    INNER JOIN sys.tables t 
        ON tm.object_id = t.object_id
INNER JOIN sys.schemas s
    ON t.schema_id = s.schema_id
CROSS JOIN (SELECT COUNT(*) nbr_nodes  FROM sys.dm_pdw_nodes WHERE type = 'compute') n
GROUP BY 
    n.nbr_nodes, s.name, t.name
HAVING 
    AVG(CASE WHEN rg.State = 3 THEN rg.Total_rows ELSE NULL END) < 100000 OR
    AVG(CASE WHEN rg.State = 0 THEN rg.Total_rows ELSE NULL END) < 100000

ORDER BY 
    s.name, t.name
```
 
**Шаг 2**. Повысьте класс ресурсов для пользователя, который имеет разрешение на перестроение индекса для этой таблицы, до рекомендованного класса ресурсов, указанного во втором столбце приведенного выше запроса.

```sql
EXEC sp_addrolemember 'xlargerc', 'LoadUser'
```

> [AZURE.NOTE]  Указанный выше пользователь LoadUser должен быть допустимым пользователем, созданным для выполнения инструкции ALTER INDEX. Класс ресурсов для пользователя db\_owner изменить нельзя. Дополнительные сведения о классах ресурсов и создании нового пользователя см. по приведенным ниже ссылкам.

 
**Шаг 3.** Войдите в систему как пользователь из шага 2 (например, LoadUser), которому теперь соответствует более высокий класс ресурсов, и выполните инструкции ALTER INDEX, сформированные запросом на шаге 1. Убедитесь, что этот пользователь имеет разрешение ALTER в отношении таблиц, идентифицированных запросом в ШАГЕ 1.
 
**Шаг 4.** Снова выполните запрос из шага 1. Если индексы сформированы эффективно, вы не получите никакие строки после выполнения этого запроса. Если строки не возвращаются, значит, больше ничего не нужно. Если баз данных хранилища данных SQL несколько, повторите эту процедуру для каждой из них. Если строки возвращаются, перейдите к шагу 5.
 
**Шаг 5.** Если при повторном выполнении запроса из шага 1 строки возвращаются, возможно, что у вас есть таблицы с чрезмерно широкими строками, которым для оптимального формирования кластеризованных индексов columnstore требуется большой объем памяти. Если это так, повторите описанную процедуру для этих таблиц, используя класс xlargerc. Чтобы изменить класс ресурсов, повторите шаг 2 с использованием метода xlargerc. Повторите шаг 3 для таблиц, у которых остались неоптимальные индексы. Если у вас DW100–DW300 и вы уже использовали xlargerc, вы можете оставить индексы как есть или временно увеличить DWU, чтобы выделить больше памяти для этой операции.
 
**Заключительные действия**. Назначенный выше класс ресурсов является рекомендуемым минимальным классом ресурсов для формирования индексов columnstore наивысшего качества. Рекомендуем назначать его пользователю, который загружает данные. Если же вы хотите отменить изменения, внесенные в шаге 2, это можно сделать с помощью следующей команды.

```sql
EXEC sp_droprolemember 'smallrc', 'LoadUser'
```

Для загрузки данных в таблицу CCI действуют следующие рекомендации по минимальному классу ресурсов: xlargerc для DW100–DW300, largerc для DW400–DW600 и mediumrc для DW1000 и выше. Эти рекомендации подходят для большинства рабочих нагрузок. Главное — выделить для каждой операции создания индекса 400 МБ памяти или больше. Универсального решения не существует. Объем памяти, необходимый для оптимизации индекса, зависит от загружаемых данных, на которые, в свою очередь, влияет размер строки. Таблицам с меньшей шириной строк требуется меньше памяти, таблицам с большей шириной — больше. Если вы хотите поэкспериментировать, возьмите запрос из шага 1 и определите, получаете ли вы оптимальные индексы Columnstore при выделении меньшего объема памяти. На группу строк в среднем должно приходиться больше 100 тысяч строк. Еще лучше, если их будет больше 500 тысяч. Максимальное значение — 1 миллион строк на группу. Дополнительные сведения об управлении классами ресурсов и параллелизмом см. по указанной ниже ссылке.


## Дальнейшие действия

Если не удалось найти решение для приведенной выше проблемы, то можно ознакомиться со следующими ресурсами, которые могут помочь.

- [Блоги]
- [Запросы функций.]
- [Видеоролики]
- [Блоги группы CAT]
- [Создание запроса в службу поддержки]
- [Форум MSDN]
- [Форум Stack Overflow]
- [Twitter]

<!--Image references-->

<!--Article references-->
[Общие сведения о безопасности]: ./sql-data-warehouse-overview-manage-security.md
[Создание запроса в службу поддержки]: ./sql-data-warehouse-get-started-create-support-ticket.md
[масштабирования хранилища данных SQL]: ./sql-data-warehouse-manage-compute-overview.md
[обучающей мониторингу запросов]: ./sql-data-warehouse-manage-monitor.md
[инструкции по подготовке]: ./sql-data-warehouse-get-started-provision.md
[Настройка доступа брандмауэра сервера к IP-адресу клиента]: ./sql-data-warehouse-get-started-provision.md#create-a-new-azure-sql-server-level-firewall
[Visual Studio 2013 или Visual Studio 2015]: ./sql-data-warehouse-get-started-connect.md
[Рекомендации по использованию хранилища данных SQL]: ./sql-data-warehouse-best-practices.md

<!--MSDN references-->
[собственный клиент SQL Server 10 или SQL Server 11 (ODBC)]: https://msdn.microsoft.com/library/ms131415.aspx

<!--Other Web references-->
[Блоги]: https://azure.microsoft.com/blog/tag/azure-sql-data-warehouse/
[Блоги группы CAT]: https://blogs.msdn.microsoft.com/sqlcat/tag/sql-dw/
[Запросы функций.]: https://feedback.azure.com/forums/307516-sql-data-warehouse
[Форум MSDN]: https://social.msdn.microsoft.com/Forums/ru-RU/home?forum=AzureSQLDataWarehouse
[Форум Stack Overflow]: http://stackoverflow.com/questions/tagged/azure-sqldw
[Twitter]: https://twitter.com/hashtag/SQLDW
[Видеоролики]: https://azure.microsoft.com/documentation/videos/index/?services=sql-data-warehouse

<!---HONumber=AcomDC_0629_2016-->