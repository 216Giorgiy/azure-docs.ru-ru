---
title: "Повышение производительности индекса columnstore в SQL Azure | Документация Майкрософт"
description: "Вы можете снизить требования к памяти (или увеличить объем доступной памяти), чтобы достичь максимально возможного числа строк, которые индекс columnstore сжимает в каждой группе строк."
services: sql-data-warehouse
documentationcenter: NA
author: shivaniguptamsft
manager: jhubbard
editor: 
ms.assetid: ef170f39-ae24-4b04-af76-53bb4c4d16d3
ms.service: sql-data-warehouse
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-services
ms.date: 11/18/2016
ms.author: shigu;barbkess
translationtype: Human Translation
ms.sourcegitcommit: b4802009a8512cb4dcb49602545c7a31969e0a25
ms.openlocfilehash: 8d189256ed4c876859203406cda95ce0be36c96c
ms.lasthandoff: 03/29/2017


---

# <a name="memory-optimizations-for-columnstore-compression"></a>Способы оптимизации памяти для сжатия columnstore

Вы можете снизить требования к памяти (или увеличить объем доступной памяти), чтобы достичь максимально возможного числа строк, которые индекс columnstore сжимает в каждой группе строк.  Эти способы можно использовать, чтобы оптимизировать степень сжатия и производительность запросов для индексов columnstore.

## <a name="why-the-rowgroup-size-matters"></a>На что влияет размер группы строк
Так как индекс columnstore обрабатывает таблицу, сканируя сегменты столбцов отдельных групп строк, увеличение максимального числа строк в каждой группе строк повышает производительность запросов. Если группы включают большое число строк, сжатие данных также оптимизируется, так как с диска считывается меньше данных.

Дополнительные сведения о группах строк см. в [руководстве по индексам сolumnstore](https://msdn.microsoft.com/library/gg492088.aspx).

## <a name="target-size-for-rowgroups"></a>Целевой размер для групп строк
Чтобы повысить производительность запросов, нужно максимально увеличить число строк в каждой группе строк в индексе columnstore. Группа строк может включать до 1 048 576 строк. При этом использовать максимальное значение необязательно. Индексы columnstore обеспечивают высокую производительность, если группы строк включают хотя бы 100 000 строк.

## <a name="rowgroups-can-get-trimmed-during-compression"></a>Группы строк при сжатии можно обрезать

Во время массовой загрузки или повторном создании индекса columnstore для сжатия всех строк, назначенных каждой группе строк, иногда не хватает доступной памяти. Из-за нехватки памяти индексы columnstore обрезают размеры групп строк, обеспечивая выполнение сжатия в columnstore.

Если памяти не хватает для сжатия хотя бы 10 000 строк в каждой группе строк, хранилище данных SQL выдает ошибку.

Дополнительные сведения о выполнении массовой загрузки см. в статье [Загрузка данных индексов ColumnStore](https://msdn.microsoft.com/en-us/library/dn935008.aspx#Bulk load into a clustered columnstore index).

## <a name="how-to-estimate-memory-requirements"></a>Как рассчитать требования к памяти

<!--
To view an estimate of the memory requirements to compress a rowgroup of maximum size into a columnstore index, download and run the view [dbo.vCS_mon_mem_grant](). This view shows the size of the memory grant that a rowgroup requires for compression in to the columnstore.
-->

Максимальный объем памяти, требуемый для сжатия одной группы строк, составляет приблизительно

- 72 МБ +
- \#строки \* \#столбцы \* 8 байт +
- \#строки \* \#столбцы коротких строк \* 32 байта +
- \#столбцы длинных строк \* 16 МБ для словаря сжатия

где столбцы коротких строк используют типы строковых данных размером <= 32 байта, а столбцы длинных строк используют типы строковых данных размером > 32 байта.

Используемый метод сжатия длинных строк предназначен для сжатия текста. Этот метод сжатия использует *словари* для хранения текстовых шаблонов. Максимальный размер словаря составляет 16 МБ. Для каждого столбца длинной строки в группе строк используется только один словарь.

Подробные сведения о требованиях к памяти columnstore см. в [видео-руководстве по настройке масштабирования хранилища данных SQL Azure](https://myignite.microsoft.com/videos/14822).

## <a name="ways-to-reduce-memory-requirements"></a>Способы снижения требований к памяти

Используйте следующие методы, чтобы снизить требования к памяти для сжатия групп строк в индексах columnstore.

### <a name="use-fewer-columns"></a>Используйте меньшее число столбцов
По возможности проектируйте таблицы с меньшим числом столбцов. Когда группа строк сжимается в columnstore, индекс columnstore сжимает каждый сегмент столбца отдельно. Следовательно, при сжатии группы строк с увеличением числа столбцов повышаются и требования к памяти.


### <a name="use-fewer-string-columns"></a>Используйте меньшее число строковых столбцов
Столбцы строковых типов данных требуют больше памяти, чем числовые типы и типы даты. Чтобы снизить требования к памяти, можно удалить строковые столбцы из таблиц фактов и поместить их в меньшие таблицы измерений.

Дополнительные требования к памяти при сжатии строк:

- для строковых типов данных до 32 символов может дополнительно потребоваться 32 байта на каждое значение;
- строковые типы данных свыше 32 символов сжимаются с помощью методов словаря,  а для каждого столбца в группе строк может дополнительно потребоваться 16 МБ для создания словаря.

### <a name="avoid-over-partitioning"></a>Избегайте избыточного секционирования

Индексы columnstore создают одну или несколько групп строк в каждой секции. В хранилище данных SQL число секций быстро увеличивается из-за распределения данных, которые при этом секционируются. Если в таблице слишком много разделов, существующих строк может не хватить для заполнения групп строк. Недостаток строк не вызывает нехватку памяти при сжатии, но это приводит к снижению производительности запросов columnstore для групп строк.

Также рекомендуется избегать чрезмерного секционирования из-за перерасхода памяти при загрузке строк в индекс columnstore в секционированной таблице. При загрузке многие секции могут принимать входящие строки, которые хранятся в памяти, пока каждая секция не получит достаточное количество строк для сжатия. Слишком большое число секций приводит к избыточному потреблению памяти.

### <a name="simplify-the-load-query"></a>Упрощайте запросы загрузки

База данных распределяет память, выделенную для запросов, между всеми операторами запроса. Если запрос загрузки включает сложные сортировки и соединения, объем доступной для сжатия памяти снижается.

Разработайте такой запрос нагрузки, который позволит использовать ресурсы только для его загрузки. Если необходимо выполнить преобразование данных, выполните эту операцию отдельно от выполнения запроса загрузки. Например, запустите промежуточную обработку данных в таблице кучи, выполните преобразование и только потом загружайте промежуточную таблицу в индексе. Можно также сначала загрузить данные, затем использовать систему MPP для преобразования данных.

### <a name="adjust-maxdop"></a>Настройка MAXDOP

В рамках каждого распределения группы строк сжимаются в columnstore параллельно, если для распределения доступно более одного ядра ЦП. Параллелизм потребляет дополнительную память, что может привести к ее нехватке и усечению строк.

Чтобы избежать этого, можно использовать указание запроса MAXDOP для принудительного выполнения загрузки в последовательном режиме в рамках каждого распределения.

```
CREATE TABLE MyFactSalesQuota
WITH (DISTRIBUTION = ROUND_ROBIN)
AS SELECT * FROM FactSalesQUota
OPTION (MAXDOP 1);
```

## <a name="ways-to-allocate-more-memory"></a>Способы выделения дополнительной памяти

Объем доступной для выполнения пользовательских запросов памяти определяется размером DWU и классом ресурсов пользователя. Чтобы увеличить объем выделенной для запросов загрузки памяти, можно увеличить число DWU или повысить класс ресурсов.

- Сведения об увеличении числа DWU см.в разделе [Масштабирование производительности](sql-data-warehouse-manage-compute-overview.md#scale-compute).
- Сведения об изменении класса ресурсов для запросов см. в разделе [Пример изменения класса ресурсов пользователя](sql-data-warehouse-develop-concurrency.md#change-a-user-resource-class-example).

Например, располагая DWU 100 и классом ресурсов smallrc, пользователь может использовать 100 МБ памяти для каждого распределения. Дополнительные сведения см. в статье [Управление параллелизмом и рабочей нагрузкой в хранилище данных SQL](sql-data-warehouse-develop-concurrency.md).

Предположим, вы определили, что вам необходимо 700 МБ памяти, чтобы получить оптимальные размеры групп строк. В этих примерах показывается, как можно выполнять запросы загрузки с достаточным объемом памяти.

- При наличии DWU 1000 и mediumrc выделение памяти составит 800 МБ.
- При наличии DWU 600 и largerc выделение памяти составит 800 МБ.


## <a name="next-steps"></a>Дальнейшие действия

Дополнительные способы повышения производительности в хранилище данных SQL см. в статье [Monitor user queries in Azure SQL Data Warehouse](sql-data-warehouse-overview-manage-user-queries.md) (Мониторинг пользовательских запросов в хранилище данных Azure SQL).

<!--Image references-->

<!--Article references-->


<!--MSDN references-->

<!--Other Web references-->

