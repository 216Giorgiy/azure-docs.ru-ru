---
title: 'Резервное копирование и восстановление в хранилище данных SQL Azure: моментальные снимки, геоизбыточные резервные копии | Документация Майкрософт'
description: Сведения о том, как работает резервное копирование и восстановление в хранилище данных SQL Azure. Резервные копии хранилища данных используются для восстановления хранилища данных до точки восстановления в основном регионе. Геоизбыточные резервные копии можно использовать для восстановления в другом географическом регионе.
services: sql-data-warehouse
author: kevinvngo
manager: craigg
ms.service: sql-data-warehouse
ms.topic: conceptual
ms.component: manage
ms.date: 08/24/2018
ms.author: kevin
ms.reviewer: igorstan
ms.openlocfilehash: e9b5005fad1eeb13314e1fb6a5708bb02b96cbf9
ms.sourcegitcommit: 2b2129fa6413230cf35ac18ff386d40d1e8d0677
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/30/2018
ms.locfileid: "43248647"
---
# <a name="backup-and-restore-in-azure-sql-data-warehouse"></a>Резервное копирование и восстановление в хранилище данных SQL Azure
Сведения о том, как работает резервное копирование и восстановление в хранилище данных SQL Azure. Для восстановления или копирования хранилища данных до предыдущей точки восстановления в основном регионе можно использовать моментальные снимки хранилища данных, а для восстановления в другом географическом регионе — геоизбыточные резервные копии хранилища данных. 

## <a name="what-is-a-data-warehouse-snapshot"></a>Что такое моментальный снимок хранилища данных?
*Моментальный снимок хранилища данных* создает точку восстановления, которую можно использовать для восстановления или копирования хранилища до предыдущего состояния.  Так как хранилище данных SQL является распределенной системой, моментальный снимок хранилища данных состоит из множества файлов, которые размещаются в службе хранилища Azure. Моментальные снимки фиксируют добавочные изменения в данных, содержащихся в хранилище данных.

*Восстановление хранилища данных* означает создание хранилища данных из точки восстановления существующего или удаленного хранилища данных. Восстановление хранилища данных является важной частью любой стратегии непрерывности бизнес-процессов и аварийного восстановления, так как позволяет воссоздать данные после случайного повреждения или удаления. Хранилище данных также является эффективном механизмом для создания копий вашего хранилища данных в целях тестирования или разработки.  Хранилище данных SQL использует механизмы быстрого восстановления в том же регионе, процесс восстановления в котором занимает меньше 20 минут для данных любого размера. 

## <a name="automatic-restore-points"></a>Точки автоматического восстановления
Моментальные снимки — это встроенная функция службы, которая создает точки восстановления. Ее не нужно включать специально. Точки автоматического восстановления в настоящее время не могут быть удалены пользователями, если служба использует эти точки для поддержки восстановления в соответствии с соглашением об уровне обслуживания.

Хранилище данных SQL делает моментальные снимки вашего хранилища данных в течение дня, создавая точки восстановления, доступные в течение семи дней. Этот срок нельзя изменить. Хранилище данных SQL поддерживает восьмичасовую целевую точку восстановления (RPO). Вы можете восстановить хранилище данных в основном регионе до любого из моментальных снимков, доступных за последние семь дней.

Чтобы узнать, когда был создан последний моментальный снимок, выполните этот запрос к хранилищу данных SQL, подключенному к сети. 

```sql
select   top 1 *
from     sys.pdw_loader_backup_runs 
order by run_id desc
;
```

## <a name="user-defined-restore-points"></a>Определяемые пользователем точки восстановления
Эта функция позволяет вручную активировать моментальные снимки для создания точек восстановления вашего хранилища данных до и после существенных изменений. Эта возможность гарантирует, что точки восстановления логически согласованы, что обеспечивает дополнительную защиту данных в случае любых прерываний рабочей нагрузки или пользовательских ошибок для быстрого восстановления. Пользовательские точки восстановления доступны в течение семи дней и автоматически удаляются от вашего имени. Пользователь не может самостоятельно изменить срок хранения пользовательских точек восстановления. Только 42 пользовательские точки восстановления поддерживаются в любой момент времени, поэтому они должны быть [удалены](https://go.microsoft.com/fwlink/?linkid=875299) перед созданием новой точки. Вы можете активировать моментальные снимки для создания пользовательских точек восстановления с помощью [PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/new-azurermsqldatabaserestorepoint?view=azurermps-6.2.0#examples) или портала Azure.


> [!NOTE]
> Если вам требуется хранить точки восстановления более 7 дней, проголосуйте за эту возможность [здесь](https://feedback.azure.com/forums/307516-sql-data-warehouse/suggestions/35114410-user-defined-retention-periods-for-restore-points). Вы также можете создать пользовательскую точку восстановления и восстановить ее из вновь созданной точки в новом хранилище данных. После восстановления вы получаете хранилище данных в сети и можете приостановить его на неограниченное время для экономии вычислительных ресурсов. Хранение приостановленной базы данных оплачивается по расценкам службы хранилища Azure уровня "Премиум". Если вам нужна активная копия восстановленного хранилища данных, вы можете возобновить ее, что займет всего несколько минут.
>

### <a name="snapshot-retention-when-a-data-warehouse-is-paused"></a>Срок хранения моментальных снимков, если приостановлена работа хранилища данных
Хранилище данных SQL не создает и не удаляет точки восстановления по истечении периода хранения, пока работа хранилища данных приостановлена. Срок жизни точек восстановления не изменяется, пока работа хранилища данных приостановлена. Срок хранения точек восстановления соответствует количеству дней, в течение которых хранилище данных находится в оперативном режиме, а не количеству календарных дней.

Например, если моментальный снимок был сделан 1 октября в 16:00, а работа хранилища данных приостановлена 3 октября в 16:00, длительность хранения точки восстановления составляет не более двух дней. Когда хранилище данных снова перейдет в оперативный режим, длительность хранения точки восстановления на этот момент будет составлять два дня. Если хранилище данных возобновит работу 5 октября в 16:00, двухдневная точка восстановления будет храниться еще пять дней.

Когда хранилище данных снова перейдет в оперативный режим, хранилище данных SQL возобновит создание новых точек восстановления и удаление точек восстановления со сроком хранения более семи дней.

### <a name="snapshot-retention-when-a-data-warehouse-is-dropped"></a>Срок хранения моментальных снимков при удалении хранилища данных
При удалении хранилища данных с помощью хранилища данных SQL создается конечный моментальный снимок, который хранится в течение семи дней. Вы можете восстановить хранилище данных до последней точки восстановления, созданной при удалении. 

> [!IMPORTANT]
> Когда вы удаляете экземпляр логического сервера SQL Server, все относящиеся к этому экземпляру базы данных также удаляются без возможности восстановления. Удаленный сервер восстановить невозможно.
>

## <a name="geo-backups"></a>Геоархивы
Хранилище данных SQL выполняет геоархивацию один раз в день в [сопряженный центр обработки данных](../best-practices-availability-paired-regions.md). Целевая точка восстановления для геовосстановления составляет 24 часа. Можно восстановить геоархив на сервер в любом другом регионе, в котором поддерживается хранилище данных SQL. Геоархивация гарантирует, что вы сможете восстановить хранилище данных даже при отсутствии доступа к точкам восстановления, размещенным в основном регионе.

Выполнение геоархивации задано по умолчанию. Если хранилище данных относится к поколению 1, при необходимости вы можете [отказаться](/powershell/module/azurerm.sql/set-azurermsqldatabasegeobackuppolicy) этой функции. Вы не можете отказаться от создания геоархивов для поколения 2, так как защита данных является его неотъемлемой гарантией.

> [!NOTE]
> Если требуется более короткий интервал для геоархивации, проголосуйте за эту возможность [здесь](https://feedback.azure.com/forums/307516-sql-data-warehouse). Вы также можете создать пользовательскую точку восстановления и восстановить ее из вновь созданной точки в новом хранилище данных в другом регионе. После восстановления вы получаете хранилище данных в сети и можете приостановить его на неограниченное время для экономии вычислительных ресурсов. Хранение приостановленной базы данных оплачивается по расценкам службы хранилища Azure уровня "Премиум". Затем выполняется пауза. Если вам нужна активная копия хранилища данных, вы можете возобновить ее, что займет всего несколько минут.
>


## <a name="backup-and-restore-costs"></a>Стоимость резервного копирования и восстановления
Можно заметить, что в счете на оплату Azure содержится строка для обычного хранилища и хранилища аварийного восстановления. Плата за использование хранилища представляет собой общую стоимость хранения данных в основном регионе, в котором также хранятся добавочные изменения, зафиксированные моментальными снимками. Дополнительные сведения о создании моментальных снимков см. в [документации](https://docs.microsoft.com/rest/api/storageservices/Understanding-How-Snapshots-Accrue-Charges?redirectedfrom=MSDN#snapshot-billing-scenarios). Плата за использование геоизбыточного хранилища охватывает стоимость хранения геоархивов.  

Общая стоимость основного хранилища данных и изменений моментальных снимков за последние семь дней округляется до ближайшего терабайта. Например, если объем хранилища данных составляет 1,5 ТБ, а под моментальные снимки задействовано 100 ГБ, плата взимается за 2 ТБ данных по тарифам хранилища Azure класса Premium. 

При использовании геоизбыточного хранилища плата за хранилище взимается отдельно. Геоизбыточное хранилище оплачивается по стандартному тарифу для географически избыточного хранилища с доступом на чтение (RA-GRS).

Ознакомиться с ценами на хранилище данных SQL можно на [этой странице](https://azure.microsoft.com/pricing/details/sql-data-warehouse/) и на [странице расценок на исходящий трафик](https://azure.microsoft.com/pricing/details/bandwidth/) при восстановлении между регионами.

## <a name="restoring-from-restore-points"></a>Восстановление из точек восстановления
Каждый моментальный снимок создает точку восстановления, которая представляет время начала создания моментального снимка. Для восстановления хранилища данных следует выбрать точку восстановления и выполнить команду restore.  

Можно сохранить восстановленное и текущее хранилища данных либо удалить один из них. Если необходимо заменить текущее хранилище данных восстанавливаемым, его можно переименовать с помощью инструкции [ALTER DATABASE (хранилище данных SQL Azure)](/sql/t-sql/statements/alter-database-azure-sql-data-warehouse) с параметром MODIFY NAME. 

Чтобы восстановить хранилище данных, см. статьи [Восстановления хранилища данных с помощью портала Azure](sql-data-warehouse-restore-database-portal.md), [Восстановление хранилища данных с помощью PowerShell](sql-data-warehouse-restore-database-powershell.md) или [Восстановление хранилища данных с помощью T-SQL](sql-data-warehouse-restore-database-rest-api.md).

Чтобы восстановить удаленное или приостановленное хранилище данных, вы можете [создать запрос в службу поддержки](sql-data-warehouse-get-started-create-support-ticket.md). 


## <a name="geo-redundant-restore"></a>Геоизбыточное восстановление
[Хранилище данных можно восстановить](https://docs.microsoft.com/azure/sql-data-warehouse/sql-data-warehouse-restore-database-powershell#restore-from-an-azure-geographical-region) в любой регион, поддерживающий хранилище данных SQL выбранного вами уровня производительности. 

> [!NOTE]
> Чтобы выполнить географически избыточное восстановление, необходимо отказаться от этой функции.
>

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения о планировании на случай аварий см. в [обзоре обеспечения непрерывности бизнес-процессов](../sql-database/sql-database-business-continuity.md)
