---
title: "Аудит в хранилище данных SQL Azure | Документация Майкрософт"
description: "Приступая к работе с аудитом в хранилище данных SQL Azure"
services: sql-data-warehouse
documentationcenter: 
author: ronortloff
manager: jhubbard
editor: 
ms.assetid: 0e6af148-b218-4b43-bb5f-907917d20330
ms.service: sql-data-warehouse
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.custom: security
ms.date: 01/16/2018
ms.author: rortloff;barbkess
ms.openlocfilehash: 5400f29d8c7579809ef7b2a084115473df7baa85
ms.sourcegitcommit: 7edfa9fbed0f9e274209cec6456bf4a689a4c1a6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2018
---
# <a name="auditing-in-azure-sql-data-warehouse"></a>Аудит в хранилище данных SQL Azure

Аудит хранилища данных SQL позволяет фиксировать события, происходящие в базе данных, в журнале аудита в вашей учетной записи хранения Azure. Аудит может помочь вам соблюсти стандарты, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности. Аудит хранилища данных SQL объединен с Microsoft Power BI для создания отчетов и анализа.

Средства аудита позволяют и способствуют соблюдению стандартов, но не гарантируют соответствия им. Дополнительную информацию о программах Azure, поддерживающих проверку соблюдения стандартов, см. в <a href="http://azure.microsoft.com/support/trust-center/compliance/" target="_blank">Центре управления безопасностью Azure</a>.

## <a id="subheading-1"></a>Основы аудита
Аудит базы данных хранилища данных SQL позволяет:

* **Сохранить** журнал аудита выбранных событий. Вы можете указать, какие категории действий базы данных должны проходить аудит.
* **Создавать отчеты** по действиям, производимым с базой данных. Вы можете использовать предварительно настроенные отчеты и панель мониторинга для быстрого начала работы с отчетностью по действиям и событиям.
* **Анализировать** отчеты. Вы можете искать подозрительные события, необычную деятельность и тенденции.

Аудит можно настроить для событий следующих категорий:

**Простой SQL** и **параметризованный SQL**, для которого собранные журналы аудита классифицируются следующим образом.  

* **Доступ к данным**
* **Изменения в схеме данных (DDL)**
* **Изменения данных (DML)**
* **Учетные записи, роли и разрешения (DCL)**
* **Хранимая процедура**, **Вход в систему** и **Управления транзакциями**.

Для каждой категории событий **успешные** и **неуспешные** операции аудита настраиваются отдельно.

Дополнительные сведения о действиях и событиях, которые находятся под наблюдением, см. в <a href="http://go.microsoft.com/fwlink/?LinkId=506733" target="_blank">справочнике по формату журнала аудита (DOC-файл для загрузки)</a>.

Журналы аудита хранятся в учетной записи хранения Azure. Срок хранения журнала аудита можно установить.

Политику аудита можно определить для конкретной базы данных или как политику сервера по умолчанию. Политика аудита по умолчанию применяется ко всем базам данных на сервере, для которых не установлена иная переопределяющая политика аудита баз данных.

Прежде чем настраивать проверку аудита, убедитесь, что вы используете [клиент прежних версий](sql-data-warehouse-auditing-downlevel-clients.md).

## <a id="subheading-2"></a>Настройка аудита базы данных
1. Запустите <a href="https://portal.azure.com" target="_blank">портал Azure</a>.
2. Перейдите в колонку **Параметры** хранилища данных SQL, для которого нужно выполнить аудит. Выберите **Аудит SQL и обнаружение угроз**.
   
    ![][1]
3. Затем включите аудит, нажав кнопку **ВКЛ** .
   
    ![][3]
4. На панели конфигурации аудита выберите **Сведения о хранилище**, чтобы открыть панель "Хранилище журналов аудита". Выберите учетную запись хранения Azure для журналов и укажите срок хранения. 
>[!TIP]
>Чтобы воспользоваться всеми возможностями шаблонов предварительно настроенных отчетов, используйте одну и ту же учетную запись хранения для всех баз данных.
   
    ![][4]
5. Нажмите кнопку **ОК** , чтобы сохранить сведения о конфигурации хранилища.
6. В разделе **ВЕДЕНИЕ ЖУРНАЛА ПО СОБЫТИЯМ** щелкните **УСПЕШНО** и **СБОЙ**, чтобы включить в журнал все события, или выберите отдельные категории событий.
7. При настройке аудита для базы данных может потребоваться изменить строку подключения вашего клиента, чтобы убедиться в правильном сборе данных аудита. Ознакомьтесь с разделом [Изменение FDQN сервера в строке подключения](sql-data-warehouse-auditing-downlevel-clients.md) , чтобы узнать больше о подключениях клиентов нижнего уровня.
8. Последовательно выберите **ОК**.

## <a id="subheading-3"></a>Анализ журналов и отчетов аудита
Журналы аудита объединяются в коллекцию таблиц хранилища с префиксом **SQLDBAuditLogs** в учетной записи хранилища Azure, выбранной во время установки. Просматривать файлы журнала можно с помощью таких инструментов, как <a href="http://azurestorageexplorer.codeplex.com/" target="_blank">обозреватель хранилищ Azure</a>.

Для скачивания доступен предварительно настроенный шаблон отчета панели мониторинга в виде <a href="http://go.microsoft.com/fwlink/?LinkId=403540" target="_blank">таблицы Excel</a>, что позволит быстро проанализировать данные журнала. Чтобы использовать шаблон с вашими журналами аудита, вам потребуется Excel 2013 или более поздней версии и Power Query, который можно скачать по этой <a href="http://www.microsoft.com/download/details.aspx?id=39379">ссылке</a>.

В шаблоне приведен пример вымышленных данных, вы можете настроить Power Query для импорта журнала аудита непосредственно в учетную запись хранения Azure.

## <a id="subheading-4"></a>Повторное создание ключа к хранилищу данных
Обычно в рабочей среде приходится периодически обновлять ключи хранилища. При обновлении ключей необходимо сохранить политику. Процесс таков:

1. На панели конфигурации аудита (описанной выше в разделе о настройке аудита) измените значение параметра **Ключ доступа к хранилищу** с *Первичный* на *Вторичный* и нажмите кнопку **Сохранить**.

   ![][4]
2. Перейдите на панель конфигурации хранилища и **повторно создайте** *первичный ключ доступа*.
3. Вернитесь на панель конфигурации аудита, 
4. измените значение параметра **Ключ доступа к хранилищу** с *Вторичный* на *Первичный* и нажмите кнопку **Сохранить**.
4. В интерфейсе хранилища **повторно создайте***вторичный ключ доступа* (для подготовки к следующему циклу обновления ключей).

## <a id="subheading-5"></a>Автоматизация (PowerShell или REST API)
Аудит в хранилище данных SQL Azure также можно настроить с помощью следующих средств автоматизации:

* **Командлеты PowerShell**

   * [Get-AzureRMSqlDatabaseAuditingPolicy](/powershell/module/azurerm.sql/get-azurermsqldatabaseauditingpolicy)
   * [Get-AzureRMSqlServerAuditingPolicy](/powershell/module/azurerm.sql/Get-AzureRMSqlServerAuditingPolicy)
   * [Remove-AzureRMSqlDatabaseAuditing](/powershell/module/azurerm.sql/Remove-AzureRMSqlDatabaseAuditing)
   * [Remove-AzureRMSqlServerAuditing](/powershell/module/azurerm.sql/Remove-AzureRMSqlServerAuditing)
   * [Set-AzureRMSqlDatabaseAuditingPolicy](/powershell/module/azurerm.sql/Set-AzureRMSqlDatabaseAuditingPolicy)
   * [Set-AzureRMSqlServerAuditingPolicy](/powershell/module/azurerm.sql/Set-AzureRMSqlServerAuditingPolicy)
   * [Use-AzureRMSqlServerAuditingPolicy](/powershell/module/azurerm.sql/Use-AzureRMSqlServerAuditingPolicy)


## <a name="downlevel-clients-support-for-auditing-and-dynamic-data-masking"></a>Поддержка клиентов прежних версий для аудита и динамического маскирования данных
Аудит работает с клиентами SQL, которые поддерживают перенаправление TDS.

Любой клиент, который реализует TDS 7.4, также должен поддерживать перенаправление. К исключениям относятся JDBC 4.0, где функция перенаправления поддерживается не полностью, и Tedious для Node.JS, где перенаправление не реализовано.

Для клиентов прежних версий, которые поддерживают TDS 7.3 и более ранних версий, измените полное доменное имя сервера в строке подключения, как показано ниже.

- Полное доменное имя сервера-источника в строке подключения: <*имя сервера*>.database.windows.net.
- Измененное полное доменное имя сервера в строке подключения: <*имя сервера*>.database.**secure**.windows.net.

Частичный список клиентов прежних версий включает:

* .NET 4.0 и ниже
* ODBC 10.0 и ниже
* JDBC (хотя JDBC поддерживает TDS 7.4, но функция перенаправления TDS поддерживается не полностью)
* Tedious (для Node.JS)

**Примечание.** Описанное выше изменение полного доменного имени сервера можно использовать также для применения политики аудита уровня SQL Server без необходимости настройки в каждой базе данных (временное устранение рисков).     




<!--Anchors-->
[Database Auditing basics]: #subheading-1
[Set up auditing for your database]: #subheading-2
[Analyze audit logs and reports]: #subheading-3


<!--Image references-->
[1]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing.png
[2]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-inherit.png
[3]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-enable.png
[4]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-storage-account.png
[5]: ./media/sql-data-warehouse-auditing-overview/sql-data-warehouse-auditing-dashboard.png


