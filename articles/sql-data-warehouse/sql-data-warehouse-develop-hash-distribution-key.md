<properties
   pageTitle="Хэш-распределение и его влияние на скорость выполнения запросов в хранилище данных SQL | Microsoft Azure"
   description="Дополнительные сведения о распределенных хэш-таблицах и их влиянии на скорость обработки запросов в хранилище данных SQL Azure для разработки решений."
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="jrowlandjones"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="01/04/2016"
   ms.author="JRJ@BigBangData.co.uk;barbkess"/>

# Хэш-распределение и его влияние на скорость выполнения запросов в хранилище данных SQL

Правильное хэш-распределение — один из самых важных способов увеличения скорости выполнения запросов.

На производительность влияют три основных фактора:

1. минимизация перемещения данных
2. недопущение скошенности данных
3. сбалансированное выполнение запросов

## Минимизация перемещения данных
Перемещение данных в основном происходит при объединении или группировании таблиц. Один из самых эффективных способов минимизации подобных перемещений — это хэш-распределение таблиц по общему ключу.

Однако для того, чтобы хэш-распределение хэша действительно сводило перемещения данных к минимуму, должны выполняться следующие критерии:

1. обе таблицы должны быть распределенными хэш-таблицами, объединяемыми по общему ключу распределения;
2. типы данных в столбцах обеих таблиц должны совпадать;
3. соединяемые столбцы должны допускать эквивалентное соединение (т. е. значения в столбце левой таблицы должны быть равны значениям в столбце правой таблицы);
4. соединение **не** должно выполняться с помощью предложения `CROSS JOIN`.

> [AZURE.NOTE]Все столбцы, используемые в предложениях `JOIN`, `GROUP BY`, `DISTINCT` и `HAVING`, могут становиться столбцами HASH. Столбцы в предложении `WHERE` на эту роль **не** подходят. См. раздел о сбалансированном выполнении ниже.

Перемещение данных также может быть связано с синтаксисом запроса (в качестве показательных примеров можно привести предложения `COUNT DISTINCT` и `OVER`) при его использовании со столбцами, не включающими ключ хэш-распределения.

> [AZURE.NOTE]Циклические таблицы, как правило, вызывают перемещение данных. Данные в такой таблице распределяются не детерминированно, поэтому перед выполнением большинства запросов требуется перемещение данных.

## Недопущение скошенности данных
Чтобы хэш-распределение было эффективным, нужно, чтобы выбранный столбец обладал следующими свойствами:

1. содержал значимое количество уникальных значений;
2. не страдал **скошенностью данных**.

В распределении участвует каждое уникальное значение. Это значит, что для создания достаточного количества уникальных хэш-значений требуется разумное число неповторяющихся значений в столбце таблицы. В противном случае качество хэша будет низким. Если число распределений превышает число уникальных значений, некоторые распределения останутся пустыми. Это приводит к ухудшению производительности.

Точно так же, если все строки в хэшированном столбце содержат одно и то же значение, данные считаются **скошенными**. В этом крайнем случае создается только одно хэш-значение, а все строки оказываются в одном и том же распределении. В идеале каждое уникальное значение в хэшированном столбце должно иметь одинаковое количество строк.

> [AZURE.NOTE]Циклические таблицы не страдают скошенностью данных. Это связано с тем, что данные распределяются равномерно.

## Сбалансированное выполнение запросов
Сбалансированность выполнения запросов достигается, когда каждому распределению достается одинаковый объем работы. Вычисления с массовым параллелизмом (MPP) — это командная игра, где для победы линию финиша должен пересечь каждый участник. Если каждое распределение выполняет одинаковый объем работы (т. е. обрабатывает одинаковое количество данных), все запросы завершаются примерно в одно и то же время. Это называется сбалансированным выполнением.

Как было показано выше, скошенность данных может препятствовать сбалансированному выполнению запросов. Но то же самое можно сказать и о выборе ключа хэш-распределения. Если выбранный столбец отображается в предложении `WHERE` запроса, то, скорее всего, запрос не будет сбалансирован.

> [AZURE.NOTE]Подбирать столбцы, наиболее подходящие для деления на разделы, обычно помогает предложение `WHERE`.

Хорошим примером столбца, который отображается в предложении `WHERE`, является поле даты. Поля даты — это классические примеры столбцов, которые хорошо делятся на разделы, но зачастую плохо поддаются хэш-распределению. Как правило, в запросах к хранилищу данных фигурирует определенный период времени, например день, неделя или месяц. Хэш-распределение по дате может ограничить масштабируемость и понизить производительность всей системы. Например, если в качестве диапазона дат выбрана неделя (т. е. семь дней), максимальное количество хэшей будет равно семи — по одному для каждого дня недели. Это означает, что данные будут содержать только семь распределений. Остальные распределения не будут содержать никаких данных. Результатом станет несбалансированное выполнение запросов, поскольку только семь распределений обрабатывают данные.

> [AZURE.NOTE]Циклические таблицы обычно отличаются сбалансированным выполнением запросов. Это связано с тем, что данные распределяются равномерно.

## Рекомендации
Для повышения производительности и общей скорости обработки запросов проследите за тем, чтобы ваши хэш-распределенные таблицы максимально соответствовали описанной ниже структуре.

Ключ хэш-распределения:

1. используется в запросах в предложениях `JOIN`, `GROUP BY`, `DISTINCT` или `HAVING`;
2. не используется в предложениях `WHERE`;
3. имеет множество различных значений, не меньше 1000;
4. не имеет непропорционально большого количества строк, которые будут хэшированы в небольшое число распределений;
5. определяется как неравный нулю (NOT NULL). Строки со значением NULL будут собраны в одно распределение.

## Сводка

Хэш-распределение можно вкратце описать следующим образом:

- хэш-функция детерминирована; одно и то же значение всегда назначается в одно и то же распределение;
- один столбец используется как столбец распределения; хэш-функция использует указанный столбец для назначения строк в распределения;
- хэш-функция учитывает тип данных в столбце, а не сами значения.
- В некоторых случаях в результате хэш-распределения могут создаваться скошенные таблицы.
- Распределенные хэш-таблицы обычно требуют меньше перемещений данных, если запросы разрешаются, а значит, увеличивается скорость их обработки для больших таблиц фактов.
- Для повышения скорости обработки запросов соблюдайте рекомендации по выбору столбца хэш-распределения данных.

> [AZURE.NOTE]В хранилище данных SQL большое значение имеет согласованность типов данных. Следите за тем, чтобы в действующей схеме для столбца использовался один и тот же тип данных. Это особенно важно для ключа распределения. Если типы данных ключа распределения не синхронизированы, а таблицы соединяются, происходит ненужное перемещение данных. Если таблицы большие, это дорого вам обойдется, поскольку пропускная способность и скорость обработки запросов сильно упадут.


## Дальнейшие действия
Дополнительные советы по разработке см. в статье [Общие сведения о разработке][].

<!--Image references-->

<!--Article references-->
[Общие сведения о разработке]: sql-data-warehouse-overview-develop.md

<!--MSDN references-->

<!--Other Web references-->

<!---HONumber=AcomDC_0107_2016-->