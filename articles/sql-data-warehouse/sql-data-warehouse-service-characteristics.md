<properties
   pageTitle="Ограничения емкости хранилища данных SQL | Microsoft Azure"
   description="Максимальные значения для подключений, запросов, инструкций Transact-SQL DDL и DML, а также системных представлений, используемых в хранилище данных SQL."
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="barbkess"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="03/23/2016"
   ms.author="barbkess;jrj;sonyama"/>

# Ограничения емкости хранилища данных SQL

Максимальные значения для поддержки ресурсоемких рабочих нагрузок аналитики и обеспечения всех индивидуальных запросов ресурсами, необходимыми для оптимальной производительности.

## Подключения

| Категория | Описание | Максимальная |
| :---------------- | :------------------------------------------- | :----------------- |
| Сеанс | Количество параллельно открытых сеансов | 1024<br/><br/>Поддерживается не более 1024 активных подключений, которые могут одновременно отправлять запросы в хранилище данных. Обратите внимание, что есть ограничения количества запросов, которые действительно могут выполняться одновременно. При превышении этих ограничений запрос помещается во внутреннюю очередь для ожидания обработки.|
| Сеанс | Максимальный объем памяти для подготовленных инструкций | 20 МБ |


## Обработка запросов

| Категория | Описание | Максимальная |
| :---------------- | :------------------------------------------- | :----------------- |
| Запрос | Количество одновременных запросов к пользовательским таблицам | 32<br/><br/>Это верхняя граница параллельного выполнения пользовательских запросов. Дополнительные запросы помещаются во внутреннюю очередь для ожидания обработки. Независимо от количества запросов, выполняемых одновременно, каждый запрос оптимизирован для наиболее эффективного использования возможностей массово-параллельной архитектуры. Примечание. Фактически параллельная обработка может подвергаться дополнительному регулированию в зависимости от количества DWU экземпляра базы данных и выбранного класса ресурсов выполняемых запросов.|
| Запрос | Количество помещенных в очередь запросов к пользовательским таблицам | 1000 |
| Запрос | Количество одновременных запросов к системным представлениям | 100 |
| Запрос | Количество помещенных в очередь запросов к системным представлениям | 1000 |
| Запрос | Максимальное количество параметров | 2098 |
| Пакетная служба | Максимальный размер | 65 536*4096 |


## Язык описания данных DDL

| Категория | Описание | Максимальная |
| :---------------- | :------------------------------------------- | :----------------- |
| Таблица | Количество таблиц в базе данных | 2 миллиарда |
| Таблица | Количество столбцов в таблице | 1024 столбца |
| Таблица | Количество байт в столбце | 8000 байт |
| Таблица | Количество байт в строке (определенный размер) | 8060 байтов<br/><br/>Количество байтов в строке вычисляется так же, как и для SQL Server с включенным сжатием страниц. Как и SQL Server, хранилище данных SQL поддерживает хранение при превышении размера страницы данными строки, что позволяет столбцам переменной длины выходить за пределы строк. В главной записи столбцов переменной длины, выходящих за пределы строк, хранится только 24-байтовый корневой элемент. Дополнительные сведения см. в разделе [Превышающие размер страницы данные строки, превышающие 8 КБ](https://msdn.microsoft.com/library/ms186981.aspx) электронной документации по SQL Server.<br/><br/>Список размеров типов данных хранилища данных SQL см. в разделе [CREATE TABLE (Azure SQL Data Warehouse)](https://msdn.microsoft.com/library/mt203953.aspx). |
| Таблица | Количество байт в строке (размер внутреннего буфера для перемещаемых данных) | 32 768<br/><br/>Примечание. Сейчас это ограничение существует, но достаточно скоро будет удалено.<br/><br/>Хранилище данных SQL использует внутренний буфер для перемещения строк в распределенной системе хранилища данных SQL. Служба, которая перемещает строки, называется службой перемещения данных (DMS). Она хранит строки в формате, отличном от формата, который используется в SQL Server.<br/><br/>Если строка не помещается во внутренний буфер, возникнет ошибка компиляции запроса или ошибка перемещения внутренних данных. Решение этой проблемы см. в разделе [Details about the DMS buffer size](#details-about-the-dms-buffer-size).|
| Таблица | Количество разделов в таблице | 15 000<br/><br/>Для повышения производительности рекомендуем сократить количество секций до минимума, который позволит соблюдать ваши требования к бизнесу. С увеличением количества секций не только растут затраты на операции языка описания данных DDL и языка обработки данных DML, но и снижается производительность.|
| Таблица | Количество символов в разделе (граничное значение)| 4000 |
| Индекс | Количество некластеризованных индексов в таблице | 999<br/><br/>Применимо только к таблицам rowstore.|
| Индекс | Количество кластеризованных индексов в таблице | 1<br><br/>Применимо к таблицам rowstore и columnstore.|
| Индекс | Количество строк в группе rowgroup индекса columnstore | 1024<br/><br/>Каждый индекс columnstore реализован в виде нескольких индексов columnstore. Обратите внимание: когда вы вставляете 1024 строки в индекс columnstore хранилища данных SQL, не все строки попадают в одну группу rowgroup.|
| Индекс | Количество одновременных операций создания кластеризованных индексов columnstore | 32<br/><br/>Применимо, если все кластеризованные индексы columnstore создаются в разных таблицах. В каждой таблице можно создать только один кластеризованный индекс. Дополнительные запросы будут помещены в очередь для ожидания.|
| Индекс | Размер ключа индекса | 900 байтов.<br/><br/>Применимо только к индексам rowstore.<br/><br/>В столбцах varchar могут создаваться индексы с максимальным размером более 900 байтов, если при создании такого индекса размер существующих данных в этих столбцах не превышает 900 байтов. Учтите, что при последующем выполнении в столбцах инструкций INSERT или UPDATE, которые приведут к превышению общего размера данных в 900 байт, соответствующие действия завершатся ошибкой.|
| Индекс | Количество ключевых столбцов в индексе | 16<br/><br/>Применимо только к индексам rowstore. Кластеризованные индексы columnstore включают все столбцы.|
| Статистика | Размер значений объединенных столбцов | 900 байт |
| Статистика | Количество столбцов в объекте статистики | 32 |
| Статистика | Количество объектов статистики для столбцов в таблице | 30 000 |
| Хранимые процедуры | Максимальное количество вложений | 8 |
| Просмотр | Количество столбцов в представлении | 1024 |


## Язык обработки данных DML

| Категория | Описание | Максимальная |
| :---------------- | :------------------------------------------- | :----------------- |
| Результаты SELECT | Количество столбцов в строке | 4096<br/><br/>Каждая строка результата SELECT не может содержать более 4096 столбцов. Нет никакой гарантии, что их количество всегда будет равно 4096. Если планом запроса предусмотрено использование временной таблицы, в такой таблице может быть не более 1024 столбцов.|
| SELECT | Вложенные запросы | 32<br/><br/>Инструкция SELECT не может содержать более 32 вложенных запросов. Нет никакой гарантии, что их количество всегда будет равно 32. Например, с помощью инструкции JOIN можно включить в план запроса вложенный запрос. Количество вложенных запросов также может ограничиваться объемом доступной памяти.|
| SELECT | Количество столбцов в инструкции JOIN | 1024 столбца<br/><br/>Инструкция JOIN не может содержать более 1024 столбцов. Нет никакой гарантии, что их количество всегда будет равно 1024. Если планом для инструкции JOIN предусмотрено использование временной таблицы с количеством столбцов, которое превышает результат JOIN, к такой временной таблице применяется ограничение в 1024 столбца. |
| SELECT | Количество байт в именах столбцов GROUP BY | 8060<br/><br/>Длина имен столбцов в предложении GROUP BY не может превышать 8060 байтов.|
| SELECT | Количество байт в именах столбцов ORDER BY | 8060<br/><br/>Длина имен столбцов в предложении ORDER BY не может превышать 8060 байтов.|
| Количество идентификаторов и констант в инструкции | Количество идентификаторов и констант, на которые имеются ссылки. | 65 535<br/><br/>В хранилище данных SQL есть ограничение на количество идентификаторов и констант, которые могут содержаться в одном выражении запроса; оно равно 65 535. Превышение этого количества приводит к ошибке SQL Server (ошибка 8632). Дополнительные сведения см. в статье [Сообщение об ошибке при выполнении запроса в SQL Server 2005: "Внутренняя ошибка: был достигнут предел служб выражений"](http://support.microsoft.com/kb/913050/).|

## Системные представления

| Системное представление | Максимальное количество строк |
| :--------------------------------- | :------------|
| sys.dm\_pdw\_component\_health\_alerts | 10 000 |
| sys.dm\_pdw\_dms\_cores | 100 |
| sys.dm\_pdw\_dms\_workers | Общее количество рабочих ролей DMS для последней 1000 запросов SQL. |
| sys.dm\_pdw\_errors | 10 000 |
| sys.dm\_pdw\_exec\_requests | 10 000 |
| sys.dm\_pdw\_exec\_sessions | 10 000 |
| sys.dm\_pdw\_request\_steps | Общее количество действий для последней 1000 запросов SQL, хранящихся в sys.dm\_pdw\_exec\_requests. |
| sys.dm\_pdw\_os\_event\_logs | 10 000 |
| sys.dm\_pdw\_sql\_requests | Последняя 1000 запросов SQL, которые хранятся в sys.dm\_pdw\_exec\_requests. |


## Сведения о размере буфера DMS

Хранилище данных SQL использует внутренний буфер для перемещения строк между вычислительными узлами серверной части. Служба, которая перемещает строки, называется службой перемещения данных (DMS). Она хранит строки в формате, отличном от формата, используемого в SQL Server.

Чтобы повысить производительность параллельных запросов, DMS дополняет все данные переменной длины, пока они не достигнут максимального размера, определенного для базы данных SQL. Например, значение hello для `nvarchar(2000) NOT NULL` в буфере DMS на самом деле будет использовать 4002 байта. Это число включает по 2 байта для каждого из 2000 символов и 2 байта для символа завершения NULL.

> [AZURE.NOTE] Если DMS попытается переместить строку, превышающую размер буфера DMS (32 768 байт), возникнет внутренняя ошибка. Если размер строки превышает размер буфера DMS, необходимо изменить определение таблицы так, чтобы строка поместилась в буфер DMS.

### Как определить размер строки в буфере DMS
В этом примере описаны определенные для службы DMS размеры данных переменной длины, а также показано, как рассчитать размер буфера DMS для строки.
 
В буфере DMS размер данных переменной длины складывается из следующих значений:

- заданный размер для символов;
- типы NULL используют 8 байт для индикатора NULL;
- типы ASCII используют 1 символ для символа завершения NULL;
- типы Юникод используют 2 символа для символа завершения NULL.
             
| Тип данных | Размер буфера DMS |
| :---------------------- | :-------------------------- |                
| char(1000) NULL | 1009 байт = 1000 + 8 + 1 |
| char(1000) NOT NULL | 1001 байт = 1000 + 1 |
| nchar(1000 NULL | 2010 байт = 2000 + 8 + 2 |
| varchar(1000) NULL | 1009 байт = 1000 + 8 + 1 |
| varchar(1000) NOT NULL | 1009 байт = 1000 + 1 |
| nvarchar(1000) NULL | 2010 байт = 2000 + 8 + 2 |
| nvarchar(1000) NOT NULL | 2010 байт = 2000 + 2 |
                
В буфере DMS столбцы фиксированной ширины используют размер, применяемый в SQL Server. Если тип допускает значение null, DMS требует дополнительные 8 байт. Размер, используемый в SQL Server, см. в поле max\_length в sys.types.

Например:

| Тип данных фиксированной ширины | Размер буфера DMS |
| :-------------------- | :----------------- |
| int NULL | 12 байт = 4 + 8 |
| int NOT NULL | 4 байта = 4 + 0 | 
                
Если сложить эти значения, определенный для DMS размер буфера для следующей строки составит 31 134 байта; следовательно, такая строка поместится в буфер DMS.

| столбец | Тип данных | Размер столбца |
| :----- | :------------------ | :------------------------ |
| col1 | datetime2 (7) NULL | 20 байт = 8 + 8 |
| col2 | float (4) NULL | 12 байт = 4 + 8 |
| col3 | nchar (6) NULL | 22 байта = 12 + 8 + 2 |
| col4 | char (7000) NULL | 7009 байт = 7000 + 8 + 1 |
| col5 | nvarchar (4000) | 8002 байта = 8000 + 2 |
| col6 | varchar (8000) NULL | 8009 байт = 8000 + 8 + 1 |
| col7 | varbinary (8000) | 8000 байт |
| col8 | binary (60) | 60 байт |
                
              
### Пример превышения размера буфера DMS

В этом примере показана успешная вставка строки в хранилище данных SQL. Но если потом службе DMS нужно будет переместить строку для объединения, которое несовместимо с распределением, возникнет ошибка переполнения DMS. Из этого следует вывод: создавайте строки меньшего размера, чтобы они помещались в буфер DMS.

В следующем примере мы создадим таблицу T1. Если все переменные nvarchar имеют длину 4000 символов в формате Юникод, максимально возможный размер строки составляет более 40 000 байт, что превышает максимальный размер буфера DMS.

Так как реальный размер, определенный для nvarchar, составляет 26 байт, определение строки не превышает 8060 байт, следовательно, такая строка поместится на странице SQL Server. Поэтому инструкция CREATE TABLE будет выполнена успешно, даже если в DMS произойдет сбой при попытке загрузить эту строку в буфер DMS.

```sql
CREATE TABLE T1
  (
    c0 int NOT NULL,
    CustomerKey int NOT NULL,
    c1 nvarchar(4000),
    c2 nvarchar(4000),
    c3 nvarchar(4000),
    c4 nvarchar(4000),
    c5 nvarchar(4000)
  )
WITH ( DISTRIBUTION = HASH (c0) )
;
```
В следующем шаге показано, что для вставки данных в таблицу можно успешно использовать INSERT. Так как эта инструкция загружает данные непосредственно на SQL Server без использования DMS, ошибка переполнения буфера DMS не возникает. Службы интеграции также смогут успешно загрузить эту строку.</para>

```sql
--The INSERT operation succeeds because the row is inserted directly into SQL Server without requiring DMS to buffer the row.
INSERT INTO T1
VALUES (
    25,
    429817,
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.'
  )
```

В рамках подготовки к демонстрации перемещения данных в нашем примере создается вторая таблица с элементом CustomerKey в столбце распределения.

```sql
--This second table is distributed on CustomerKey. 
CREATE TABLE T2
  (
    c0 int NOT NULL,
    CustomerKey int NOT NULL,
    c1 nvarchar(4000),
    c2 nvarchar(4000),
    c3 nvarchar(4000),
    c4 nvarchar(4000),
    c5 nvarchar(4000)
  )
WITH ( DISTRIBUTION = HASH (CustomerKey) )
;

INSERT INTO T2
VALUES (
    32,
    429817,
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.',
    N'Each row must fit into the DMS buffer size of 32,768 bytes.'
  )
```
Так как обе таблицы не распределены по CustomerKey, соединение T1 и T2 по этому элементу несовместимо с распределением. Службе DMS потребуется загрузить по крайней мере одну строку и скопировать ее в другое распределение.

```
SELECT * FROM T1 JOIN T2 ON T1.CustomerKey = T2.CustomerKey;
```

Как и ожидалось, DMS не может выполнить соединение, так как после дополнения всех столбцов nvarchar длина строки превышает размер буфера DMS (32 768 байт). Отображается следующее сообщение об ошибке.

```sql
Msg 110802, Level 16, State 1, Line 126

An internal DMS error occurred that caused this operation to fail. Details: Exception: Microsoft.SqlServer.DataWarehouse.DataMovement.Workers.DmsSqlNativeException, Message: SqlNativeBufferReader.ReadBuffer, error in OdbcReadBuffer: SqlState: , NativeError: 0, 'COdbcReadConnection::ReadBuffer: not enough buffer space for one row | Error calling: pReadConn-&gt;ReadBuffer(pBuffer, bufferOffset, bufferLength, pBytesRead, pRowsRead) | state: FFFF, number: 81, active connections: 8', Connection String: Driver={SQL Server Native Client 11.0};APP=DmsNativeReader:P13521-CMP02\sqldwdms (4556) - ODBC;Trusted_Connection=yes;AutoTranslate=no;Server=P13521-SQLCMP02,1500
```


## Дальнейшие действия
Дополнительные справочные сведения см. в обзоре [Общие справочные сведения о хранилище данных SQL][].

<!--Image references-->

<!--Article references-->
[Общие справочные сведения о хранилище данных SQL]: sql-data-warehouse-overview-reference.md

<!--MSDN references-->

<!---HONumber=AcomDC_0330_2016-->