<properties
   pageTitle="Управление статистикой в хранилище данных SQL | Microsoft Azure"
   description="Советы по управлению статистикой в хранилище данных SQL Azure для разработки решений."
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="jrowlandjones"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="12/11/2015"
   ms.author="JRJ@BigBangData.co.uk;barbkess"/>

# Управление статистикой в хранилище данных SQL
 Хранилище данных SQL использует статистику для оценки стоимости разных способов выполнения распределенных запросов. Если статистика точная, оптимизатор запросов может сформировать планы запросов высокого качества, которые повышают производительность запросов.

Создание и обновление статистики важно для достижения производительности запросов, на которую рассчитано хранилище данных SQL. В этом руководстве приводится обзор статистики, а затем показывается, как:

- создать статистику как часть структуры базы данных;
- обновить статистику в процессе обслуживания базы данных;
- просмотреть статистику с помощью системных представлений и функций.

## Общие сведения о статистике

Одностолбцовая статистика — это объекты, содержащие информацию о диапазоне и частоте значений в одном столбце. Оптимизатор запросов использует эту гистограмму, чтобы оценить количество строк в результатах запроса. Это напрямую влияет на решения о том, как оптимизировать запрос.

Многостолбцовая статистика — это статистика, созданная по списку столбцов. В первом столбце списка находится одностолбцовая статистика, а также некоторые сведения о корреляции между столбцами (т. н. плотность). Многостолбцовая статистика может повысить производительность запросов для некоторых операций, например составных соединений и группировки.

Дополнительную информацию см. в разделе [DBCC SHOW\_STATISTICS][] на сайте MSDN.

## Почему статистика важна?
Без правильной статистики вы не получите производительность, которую предназначено обеспечивать хранилище данных SQL. Хранилище данных SQL не формирует статистику таблиц и столбцов автоматически, поэтому необходимо делать это самостоятельно. Рекомендуется создать статистику при создании таблицы, а потом обновить после ее заполнения.

> [AZURE.NOTE]При использовании SQL Server вы можете создавать и обновлять одностолбцовую статистику, когда требуется. В этом плане хранилище данных SQL отличается. Так как данные распределены, хранилище данных SQL не вычисляет статистику по всем распределенным данным автоматически. Оно только вычисляет сводную статистику при создании и обновлении статистики.

## Когда создавать статистику
Связанный набор актуальной статистики является важной частью хранилища данных SQL. Поэтому важно добавить создание статистики при проектировании таблиц.

Проще всего приступить к работе со статистикой, создав одностолбцовую статистику для каждого столбца. Однако всегда есть компромиссы между производительностью и затратами на создание и обновление статистики. Если вы создали одностолбцовую статистику для всех столбцов и затем обнаружили, что обновление всей статистики занимает слишком много времени, всегда можно удалить некоторые статистические данные или обновлять одни данные чаще других.

Многостолбцовая статистика используется только оптимизатором запросов, когда столбцы используются в составных соединениях или группируются предложениями. Составные фильтры в настоящее время не получают преимуществ от многостолбцовой статистики.

Поэтому в начале разработки для хранилища данных SQL рекомендуется реализовать следующий шаблон: создание одностолбцовой статистики для каждого столбца в каждой таблице; создание многостолбцовой статистики для столбцов, используемых в запросах соединения и предложениях группировки.

Уже понимая, как требуется запрашивать данные, вы можете захотеть уточнить эту модель — особенно в том случае, если используются обширные таблицы. См. раздел [Реализация управления статистикой] (## Реализация управления статистикой), чтобы узнать о более сложном методе.

## Когда обновлять статистику
Важно включить обновление статистики в процедуру управления вашей базой данных. При изменении распределения данных в базе данных статистику необходимо обновить. В противном случае производительность запросов будет недостаточно оптимальной и усилия для дальнейшего устранения неполадок запроса могут оказаться нецелесообразны.

Поэтому один из первых вопросов, задаваемых при устранения неполадок запроса: «Актуальна ли статистика?»

На этот вопрос нельзя ответить, исходя только из возраста. Актуальный объект статистики может быть очень старым. Когда меняется количество строк или существенно изменяется распределение значений для заданного столбца — вот *тогда* необходимо обновить статистику.

Например, для столбцов дат в хранилище данных обычно требуется часто обновлять статистику. При каждой загрузке строк в хранилище данных добавляются новые даты загрузки или даты транзакций. Это изменяет распределение данных и делает статистику устаревшей.

И наоборот, статистика по столбцу пола в таблице клиентов может никогда не обновляться. Если предположить, что распределение между клиентами постоянно, добавление новых строк в вариант таблицы не изменит распределение данных. Тем не менее, если хранилище данных содержит только один пол, а новые требования предписывают несколько полов, вам определенно надо обновить статистику по столбцу пола.

Подробные пояснения см. в разделе [Статистика][] на сайте MSDN.

## Реализация управления статистикой

Часто рекомендуется расширить процесс загрузки данных, чтобы обеспечить обновление статистики в конце загрузки. Загрузка данных происходит, когда таблицы часто меняют свой размер и (или) распределение значений. Поэтому логично реализовать некоторые процессы управления.

Ниже приведены некоторые основные принципы обновления статистики в процессе загрузки:

- Убедитесь, что для каждой загружаемой таблицы обновляется по крайней мере один объект статистики. Тогда при обновлении статистики обновляется информация о размере таблицы (число строк и страниц).
- Сосредоточьтесь на столбцах, участвующие в предложениях JOIN, GROUP BY, ORDER BY и DISTINCT.
- Рекомендуется чаще обновлять столбцы «с возрастающим порядком ключа», например даты транзакций, потому что эти значения не будут включены в гистограмму статистики.
- Рекомендуется реже обновлять столбцы со статическим распределением.
- Помните, что каждый объект статистики обновляется последовательно. Просто реализовать `UPDATE STATISTICS <TABLE_NAME>` может быть не идеальным решением, особенно для обширных таблиц с большим количеством объектов статистики.

> [AZURE.NOTE]Более подробную информацию о [возрастающем порядке ключа] можно найти в техническом документе модели оценки количества элементов SQL Server 2014.

Более подробное описание см. в разделе [Оценка количества элементов][] на сайте MSDN.

## Примеры: создание статистики

Эти примеры показывают, как использовать различные параметры для создания статистики. Параметры, которые можно использовать для каждого столбца, зависят от характеристик данных и того, как столбец будет использован в запросах.

### О. Создание одностолбцовой статистики с параметрами по умолчанию

Чтобы создать одностолбцовую статистику, достаточно просто указать имя объекта статистики и имя столбца.

В этом синтаксисе все параметры используются по умолчанию. По умолчанию хранилище данных SQL создает выборку из 20 процентов таблицы, когда создает статистику.

```
CREATE STATISTICS [statistics_name] ON [schema_name].[table_name]([column_name]);
```

Например:

```
CREATE STATISTICS col1_stats ON dbo.table1 (col1);
```

### B. Создание одностолбцовой статистики путем проверки всех строк

В большинстве случаев достаточно использовать частоту выборки по умолчанию, 20 процентов. Однако вы можете настроить частоту выборки.

Для выборки всей таблицы используйте следующий синтаксис:

```
CREATE STATISTICS [statistics_name] ON [schema_name].[table_name]([column_name]) WITH FULLSCAN;
```

Например:

```
CREATE STATISTICS col1_stats ON dbo.table1 (col1) WITH FULLSCAN;
```

### C. Создание одностолбцовой статистики с указанием размера выборки

В качестве альтернативы можно указать размер выборки в процентах:

```
CREATE STATISTICS col1_stats ON dbo.table1 (col1) WITH SAMPLE = 50 PERCENT;
```

### D. Создание одностолбцовой статистики только для некоторых строк

Еще один вариант: можно создать статистику для части строк в таблице. Это называется отфильтрованной статистикой.

Например, отфильтрованную статистику можно использовать при планировании запроса определенной секции большой секционированной таблицы. Создавая статистику только по значениям секции, можно повысить точность статистики и, таким образом, увеличить производительность запросов.

Этот пример создает статистику по диапазону значений. Легко определить значения для сопоставления с диапазоном значений в секции.

```
CREATE STATISTICS stats_col1 ON table1(col1) WHERE col1 > '2000101' AND col1 < '20001231';
```

> [AZURE.NOTE]Чтобы оптимизатор запросов рассмотрел возможность использования отфильтрованной статистики, когда выбирает план распределенного запроса, запрос должен быть в пределах определения объекта статистики. Если взять приведенный выше пример, предложение WHERE запроса должно указать значения col1 от 2000101 до 20001231.

### E. Создание одностолбцовой статистики со всеми параметрами

Разумеется, параметры можно комбинировать. В приведенный ниже пример создает отфильтрованный объект статистики с настраиваемым размером выборки:

```
CREATE STATISTICS stats_col1 ON table1 (col1) WHERE col1 > '2000101' AND col1 < '20001231' WITH SAMPLE = 50 PERCENT;
```

Полную справочную информацию см. в разделе [CREATE STATISTICS][] на сайте MSDN.

### F. Создание многостолбцовой статистики

Для создания многостолбцовой статистики просто используйте предыдущие примеры, но укажите больше столбцов.

> [AZURE.NOTE]Гистограмма, используемая для оценки количества строк в результатах запроса, доступна только для первого столбца, указанного в определении объекта статистики.

В этом примере гистограмма создана для *product\_category*. Статистика между столбцами вычисляется по *product\_category* и *product\_sub\_c\\ategory*:

```
CREATE STATISTICS stats_2cols ON table1 (product_category, product_sub_category) WHERE product_category > '2000101' AND product_category < '20001231' WITH SAMPLE = 50 PERCENT;
```

Так как между *product\_category* и *product\_sub\_category* существует корреляция, многостолбцовая статистика может быть полезна, когда к этим столбцам обращаются одновременно.

### Ж. Создание статистики для всех столбцов в таблице

Один из способов создать статистику — выполнить команды CREATE STATISTICS после создания таблицы.

```
CREATE TABLE dbo.table1 
(
   col1 int
,  col2 int
,  col3 int
)
WITH
  (
    CLUSTERED COLUMNSTORE INDEX
  )
;

CREATE STATISTICS stats_col1 on dbo.table1 (col1);
CREATE STATISTICS stats_col2 on dbo.table2 (col2);
CREATE STATISTICS stats_col3 on dbo.table3 (col3);
```

### З. Использование хранимой процедуры для создания статистики для всех столбцов в базе данных

В хранилище данных SQL нет системной хранимой процедуры, эквивалентной [sp\_create\_stats][] в SQL Server. Эта хранимая процедура создает объект одностолбцовой статистики для каждого столбца базы данных, для которого статистики еще нет.

Это поможет приступить к проектированию базы данных. Вы можете адаптировать код в соответствии со своими нуждами.

```
CREATE PROCEDURE    [dbo].[prc_sqldw_create_stats]
(   @create_type    tinyint -- 1 default 2 Fullscan 3 Sample
,   @sample_pct     tinyint
)
AS

IF @create_type NOT IN (1,2,3)
BEGIN
    THROW 151000,'Invalid value for @stats_type parameter. Valid range 1 (default), 2 (fullscan) or 3 (sample).',1;
END;

IF @sample_pct IS NULL
BEGIN;
    SET @sample_pct = 20;
END;

IF OBJECT_ID('tempdb..#stats_ddl') IS NOT NULL
BEGIN;
	DROP TABLE #stats_ddl;
END;

CREATE TABLE #stats_ddl
WITH    (   DISTRIBUTION    = HASH([seq_nmbr])
        ,   LOCATION        = USER_DB
        )
AS
WITH T
AS
(
SELECT      t.[name]                        AS [table_name]
,           s.[name]                        AS [table_schema_name]
,           c.[name]                        AS [column_name]
,           c.[column_id]                   AS [column_id]
,           t.[object_id]                   AS [object_id]
,           ROW_NUMBER()
            OVER(ORDER BY (SELECT NULL))    AS [seq_nmbr]
FROM        sys.[tables] t
JOIN        sys.[schemas] s         ON  t.[schema_id]       = s.[schema_id]
JOIN        sys.[columns] c         ON  t.[object_id]       = c.[object_id]
LEFT JOIN   sys.[stats_columns] l   ON  l.[object_id]       = c.[object_id]
                                    AND l.[column_id]       = c.[column_id]
                                    AND l.[stats_column_id] = 1
LEFT JOIN	sys.[external_tables] e	ON	e.[object_id]		= t.[object_id]
WHERE       l.[object_id] IS NULL
AND			e.[object_id] IS NULL -- not an external table
)
SELECT  [table_schema_name]
,       [table_name]
,       [column_name]
,       [column_id]
,       [object_id]
,       [seq_nmbr]
,       CASE @create_type
        WHEN 1
        THEN    CAST('CREATE STATISTICS '+QUOTENAME('stat_'+table_schema_name+ '_' + table_name + '_'+column_name)+' ON '+QUOTENAME(table_schema_name)+'.'+QUOTENAME(table_name)+'('+QUOTENAME(column_name)+')' AS VARCHAR(8000))
        WHEN 2
        THEN    CAST('CREATE STATISTICS '+QUOTENAME('stat_'+table_schema_name+ '_' + table_name + '_'+column_name)+' ON '+QUOTENAME(table_schema_name)+'.'+QUOTENAME(table_name)+'('+QUOTENAME(column_name)+') WITH FULLSCAN' AS VARCHAR(8000))
        WHEN 3
        THEN    CAST('CREATE STATISTICS '+QUOTENAME('stat_'+table_schema_name+ '_' + table_name + '_'+column_name)+' ON '+QUOTENAME(table_schema_name)+'.'+QUOTENAME(table_name)+'('+QUOTENAME(column_name)+') WITH SAMPLE '+@sample_pct+'PERCENT' AS VARCHAR(8000))
        END AS create_stat_ddl
FROM T
;

DECLARE @i INT              = 1
,       @t INT              = (SELECT COUNT(*) FROM #stats_ddl)
,       @s NVARCHAR(4000)   = N''
;

WHILE @i <= @t
BEGIN
    SET @s=(SELECT create_stat_ddl FROM #stats_ddl WHERE seq_nmbr = @i);

    PRINT @s
    EXEC sp_executesql @s
    SET @i+=1;
END

DROP TABLE #stats_ddl;
```

Чтобы создать статистику для всех столбцов в таблице с помощью этой процедуры, просто вызовите ее.

```
prc_sqldw_create_stats;
```

## Примеры: обновление статистики

Чтобы обновить статистику, можно:

1. Обновить один объект статистики. Указать имя объекта статистики, который вы хотите обновить.
2. Обновить все объекты статистики для таблицы. Указать имя таблицы, а не один объект статистики.


### О. Обновление одного указанного объекта статистики ###
Для обновления указанного объекта статистики используйте следующий синтаксис:

```
UPDATE STATISTICS [schema_name].[table_name]([stat_name]);
```

Например:

```
UPDATE STATISTICS [dbo].[table1] ([stats_col1]);
```

Обновляя определенные объекты статистики, можно свести к минимуму затраты времени и ресурсов на управление статистикой. Однако необходимо хорошенько подумать, чтобы выбрать наиболее подходящие объекты статистики для обновления.


### B. Обновление всей статистики для таблицы ###
Ниже показан простой метод обновления всех объектов статистики для таблицы.

```
UPDATE STATISTICS [schema_name].[table_name];
```

Например:

```
UPDATE STATISTICS dbo.table1;
```

Эта инструкция проста в использовании. Просто помните, что она обновляет всю статистику для таблицы, и, следовательно, может выполнять больше работы, чем необходимо. Если производительность не является проблемой — это самый простой и эффективный способ обеспечения актуальности статистики.

> [AZURE.NOTE]При обновлении всей статистики для таблицы хранилище данных SQL осуществляет сканирование, чтобы выполнить выборку из таблицы для каждой статистики. Если таблица большого размера, имеет много столбцов и статистики, может оказаться эффективнее обновлять отдельные данные статистики по необходимости.

Реализацию процедуры `UPDATE STATISTICS` см. в статье о [временных таблицах]. Метод реализации слегка отличается от описанной выше процедуры `CREATE STATISTICS`, но результат одинаков.

Полный синтаксис см. в разделе [Обновление статистики][] на сайте MSDN.

## Метаданные статистики
Существует несколько системных представлений и функций, которые можно использовать для поиска информации о статистике. Например, можно узнать, устарел ли объект статистики, воспользовавшись функцией stats-date, чтобы посмотреть, когда статистика была в последний раз создана или обновлена.

### Представления каталога для статистики
Вот какие системные представления показывают информацию о статистике:

| Представление каталога | Описание |
| :----------- | :---------- |
| [sys.columns][] | Одна строка для каждого столбца. |
| [sys.objects][] | Одна строка для каждого объекта в базе данных. | |
| [sys.schemas][] | Одна строка для каждой схемы в базе данных. | |
| [sys.stats][] | Одна строка для каждого объекта статистики. |
| [sys.stats\_columns][] | Одна строка для каждого столбца в объекте статистики. Ссылается на sys.columns. |
| [sys.tables][] | Одна строка для каждой таблицы (включая внешние таблицы). |
| [sys.table\_types][] | Одна строка для каждого типа данных. |


### Системные функции для статистики
Эти системные функции полезны для работы со статистикой:

| Системная функция | Описание |
| :-------------- | :---------- |
| [STATS\_DATE][] | Дата последнего обновления объекта статистики. |
| [DBCC SHOW\_STATISTICS][] | Предоставляет сводную и подробную информацию о распределении значений согласно объекту статистики. |

### Сочетание столбцов и функций статистики в одном представлении

Это представление содержит столбцы, относящиеся к статистике, и результаты функции [STATS\_DATE()][].

```
CREATE VIEW dbo.vstats_columns
AS
SELECT
        sm.[name]                           AS [schema_name]
,       tb.[name]                           AS [table_name]
,       st.[name]                           AS [stats_name]
,       st.[filter_definition]              AS [stats_filter_defiinition]
,       st.[has_filter]                     AS [stats_is_filtered]
,       STATS_DATE(st.[object_id],st.[stats_id])
                                            AS [stats_last_updated_date]
,       co.[name]                           AS [stats_column_name]
,       ty.[name]                           AS [column_type]
,       co.[max_length]                     AS [column_max_length]
,       co.[precision]                      AS [column_precision]
,       co.[scale]                          AS [column_scale]
,       co.[is_nullable]                    AS [column_is_nullable]
,       co.[collation_name]                 AS [column_collation_name]
,       QUOTENAME(sm.[name])+'.'+QUOTENAME(tb.[name])
                                            AS two_part_name
,       QUOTENAME(DB_NAME())+'.'+QUOTENAME(sm.[name])+'.'+QUOTENAME(tb.[name])
                                            AS three_part_name
FROM    sys.objects                         AS ob
JOIN    sys.stats           AS st ON    ob.[object_id]      = st.[object_id]
JOIN    sys.stats_columns   AS sc ON    st.[stats_id]       = sc.[stats_id]
                            AND         st.[object_id]      = sc.[object_id]
JOIN    sys.columns         AS co ON    sc.[column_id]      = co.[column_id]
                            AND         sc.[object_id]      = co.[object_id]
JOIN    sys.types           AS ty ON    co.[user_type_id]   = ty.[user_type_id]
JOIN    sys.tables          AS tb ON  co.[object_id]        = tb.[object_id]
JOIN    sys.schemas         AS sm ON  tb.[schema_id]        = sm.[schema_id]
WHERE   1=1 
AND     st.[user_created] = 1
;
```

## Примеры DBCC SHOW\_STATISTICS()

DBCC SHOW\_STATISTICS() отображает данные, хранящиеся в объекте статистики. Эти данные состоят из трех частей:

1. Заголовок
2. вектор плотности;
3. Гистограмма

Заголовок метаданных о статистике. Гистограмма отображает распределение значений в первом ключевом столбце объекта статистики. Вектор плотности измеряет корреляцию между столбцами. Хранилище данных SQL вычисляет оценку количества элементов с помощью данных в объекте статистики.

### Отображение заголовка, плотности и гистограммы

Это простой пример показывает все три части объекта статистики.

```
DBCC SHOW_STATISTICS([<schema_name>.<table_name>],<stats_name>)
```

Например:

```
DBCC SHOW_STATISTICS (dbo.table1, stats_col1);
```

### Отображение одной или нескольких частей DBCC SHOW\_STATISTICS()

Если вы заинтересованы только в просмотре определенных частей, используйте предложение `WITH` и укажите, какие части требуется показать:

```
DBCC SHOW_STATISTICS([<schema_name>.<table_name>],<stats_name>) WITH stat_header, histogram, density_vector
```

Например:

```
DBCC SHOW_STATISTICS (dbo.table1, stats_col1) WITH histogram, density_vector
```

## Отличия DBCC SHOW\_STATISTICS()
В хранилище данных SQL используется более строгая реализация DBCC SHOW\_STATISTICS(), чем в SQL Server.

1. Недокументированные возможности не поддерживаются.
- Нельзя использовать Stats\_stream.
- Нельзя соединить результаты для определенных подмножеств данных статистики, например (STAT\_HEADER JOIN DENSITY\_VECTOR).
2. Невозможно задать NO\_INFOMSGS для подавления сообщений.
3. Нельзя использовать квадратные скобки вокруг имен статистики.
4. Нельзя использовать имена столбцов для идентификации объектов статистики.
5. Пользовательская ошибка 2767 не поддерживается.


## Дальнейшие действия
Дополнительные советы по разработке см. в разделе [Общие сведения о разработке для хранилища данных SQL][].

<!--Image references-->

<!--Link references--In actual articles, you only need a single period before the slash.-->
[Общие сведения о разработке для хранилища данных SQL]: ./sql-data-warehouse-overview-develop.md
[временных таблицах]: ./sql-data-warehouse-develop-temporary-tables.md

<!-- External Links -->
[Оценка количества элементов]: https://msdn.microsoft.com/library/dn600374.aspx
[CREATE STATISTICS]: https://msdn.microsoft.com/library/ms188038.aspx
[DBCC SHOW\_STATISTICS]: https://msdn.microsoft.com/library/ms174384.aspx
[Статистика]: https://msdn.microsoft.com/library/ms190397.aspx
[STATS\_DATE]: https://msdn.microsoft.com/library/ms190330.aspx
[sys.columns]: https://msdn.microsoft.com/library/ms176106.aspx
[sys.objects]: https://msdn.microsoft.com/library/ms190324.aspx
[sys.schemas]: https://msdn.microsoft.com/library/ms190324.aspx
[sys.stats]: https://msdn.microsoft.com/library/ms177623.aspx
[sys.stats\_columns]: https://msdn.microsoft.com/library/ms187340.aspx
[sys.tables]: https://msdn.microsoft.com/library/ms187406.aspx
[sys.table\_types]: https://msdn.microsoft.com/library/bb510623.aspx
[Обновление статистики]: https://msdn.microsoft.com/library/ms187348.aspx

<!---HONumber=AcomDC_1217_2015-->