<properties
   pageTitle="Перенос кода SQL в хранилище данных SQL | Microsoft Azure"
   description="Советы по переносу кода SQL в хранилище данных SQL Azure для разработки решений."
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="lodipalm"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="03/23/2016"
   ms.author="jrj;barbkess;sonyama"/>

# Перенос кода SQL в хранилище данных SQL

Чтобы обеспечить совместимость кода с хранилищем данных SQL, скорее всего, необходимо будет вносить изменения в базу кода. Некоторые функции хранилища данных SQL могут значительно повысить производительность, так как они предназначены для работы непосредственно в распределенной форме. Однако для обеспечения производительности и масштабирования некоторые функции недоступны.

## Изменение кода Transact-SQL

В следующем списке перечислены основные функции, которые не поддерживаются в хранилище данных SQL Azure. Предоставленные ссылки позволят вам ознакомиться со способами обхода для этой неподдерживаемой функции:

- [соединение ANSI join при обновлении][]
- [соединение ANSI join при удалении][]
- [инструкция merge][]
- соединение join между базами данных
- [курсоры][]
- [SELECT..INTO][]
- [INSERT..EXEC][]
- предложение output
- встроенные функции, определяемые пользователем
- функции с несколькими инструкциями
- [обобщенные табличные выражения](#Common-table-expressions)
- [рекурсивные обобщенные табличные выражения (CTE)](#Recursive-common-table-expressions-(CTE)
- функции и процедуры среды CLR
- функция $partition
- переменные таблицы
- параметры табличных значений
- распределенные транзакции
- фиксация или откат
- транзакция save
- контекст выполнения EXECUTE AS
- [предложение группирования group by с операторами rollup, cube или grouping][]
- [уровни вложения больше 8][]
- [обновление через представления][]
- [использование инструкции select для назначения переменных][]
- [отсутствует тип данных MAX для динамических строк SQL][]

К счастью, большинство из этих ограничений можно обойти. Пояснения см. в соответствующих разделах по разработке, указанных выше.

### Обобщенные табличные выражения
Текущая реализация обобщенных табличных выражений (CTE) в хранилище данных SQL обладает следующими возможностями и ограничениями.

**Функции обобщенных табличных выражений (CTE)**
+ Выражение CTE можно указать в инструкции SELECT.
+ Выражение CTE можно указать в инструкции CREATE VIEW.
+ Выражение CTE можно указать в инструкции CREATE TABLE AS SELECT (CTAS).
+ Выражение CTE можно указать в инструкции CREATE REMOTE TABLE AS SELECT (CRTAS).
+ Выражение CTE можно указать в инструкции CREATE EXTERNAL TABLE AS SELECT (CETAS).
+ Из выражения CTE можно сослаться на удаленную таблицу.
+ Из выражения CTE можно сослаться на внешнюю таблицу.
+ В CTE можно определить несколько запросов CTE.

**Ограничения СTE**
+ За CTE должна следовать одиночная инструкция SELECT. Инструкции INSERT, UPDATE, DELETE и MERGE не поддерживаются.
+ Обобщенные табличные выражения, которые включают ссылки на самих себя (рекурсивные обобщенные табличные выражения), не поддерживаются (см. раздел ниже).
+ Указание более одного предложения WITH в выражении CTE не допускается. Например, если определение запроса CTE содержит вложенный запрос, этот вложенный запрос не может содержать предложение WITH, определяющее другое выражение CTE.
+ Предложение ORDER BY не может использоваться в определении запроса CTE, если не указано предложение TOP.
+ Если выражение CTE используется в инструкции, которая является частью пакета, то после выражения необходимо указать точку с запятой.
+ При использовании инструкций, подготовленных с помощью sp\_prepare, выражения CTE будут вести себя так же, как другие инструкции SELECT в PDW. Тем не менее, если CTE используются в инструкции CETAS, подготовленной процедурой sp\_prepare, поведение может переопределяться SQL Server и другими инструкциями PDW из-за способа реализации привязки в sp\_prepare. Если инструкция SELECT, ссылающаяся на CTE, использует несуществующий в CTE столбец, процедура sp\_prepare будет выполнена без ошибок. Ошибка возникнет при выполнении sp\_execute.

### Рекурсивные обобщенные табличные выражения (CTE)

Это сложный сценарий миграции. Мы рекомендуем разбивать CTE и обрабатывать их поэтапно. Обычно используется цикл для заполнения временной таблицы по мере выполнения рекурсивных промежуточных запросов. После заполнения временной таблицы можно возвратить данные как единый результирующий набор. Похожий подход использовался для решения `GROUP BY WITH CUBE` в статье [Группировка по параметрам в хранилище данных SQL][].

### Системные функции

Ряд системных функций также не поддерживаются. Ниже приводится список некоторых системных функций, которые могут быть полезны в хранилище данных.

- NEWID()
- NEWSEQUENTIALID()
- @@NESTLEVEL()
- @@IDENTITY()
- @@ROWCOUNT()
- ROWCOUNT\_BIG
- ERROR\_LINE()

Опять же, многие из этих ограничений можно обойти.

Например, приведенный ниже код является альтернативным решением для выборки с помощью инструкции @@ROWCOUNT.

```sql
SELECT  SUM(row_count) AS row_count
FROM    sys.dm_pdw_sql_requests
WHERE   row_count <> -1
AND     request_id IN
                    (   SELECT TOP 1    request_id
                        FROM            sys.dm_pdw_exec_requests
                        WHERE           session_id = SESSION_ID()
                        ORDER BY end_time DESC
                    )
;
```

## Дальнейшие действия
Рекомендации по разработке кода см. в разделе [Общие сведения о разработке][].

<!--Image references-->

<!--Article references-->
[соединение ANSI join при обновлении]: sql-data-warehouse-develop-ctas.md
[соединение ANSI join при удалении]: sql-data-warehouse-develop-ctas.md
[инструкция merge]: sql-data-warehouse-develop-ctas.md
[INSERT..EXEC]: sql-data-warehouse-develop-temporary-tables.md

[курсоры]: sql-data-warehouse-develop-loops.md
[SELECT..INTO]: sql-data-warehouse-develop-ctas.md
[Группировка по параметрам в хранилище данных SQL]: sql-data-warehouse-develop-group-by-options.md
[предложение группирования group by с операторами rollup, cube или grouping]: sql-data-warehouse-develop-group-by-options.md
[уровни вложения больше 8]: sql-data-warehouse-develop-transactions.md
[обновление через представления]: sql-data-warehouse-develop-views.md
[использование инструкции select для назначения переменных]: sql-data-warehouse-develop-variable-assignment.md
[отсутствует тип данных MAX для динамических строк SQL]: sql-data-warehouse-develop-dynamic-sql.md
[Общие сведения о разработке]: sql-data-warehouse-overview-develop.md

<!--MSDN references-->

<!--Other Web references-->

<!---HONumber=AcomDC_0330_2016-->