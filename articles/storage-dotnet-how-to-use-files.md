<properties urlDisplayName="File Service" pageTitle="Использование хранилища файлов Azure | Microsoft Azure" metaKeywords="Get started Azure file  Azure file share  Azure file shares  Azure file   Azure file storage   Azure file .NET   Azure file C#   Azure file PowerShell" description="Learn how to use Microsoft Azure File storage to create file shares and manage file content. Samples are written in PowerShell and C#." metaCanonical="" disqusComments="1" umbracoNaviHide="1" services="storage" documentationCenter=".NET" title="How to use Microsoft Azure File storage in .NET" authors="tamram" manager="adinah" />

<tags ms.service="storage" ms.workload="storage" ms.tgt_pltfrm="na" ms.devlang="dotnet" ms.topic="article" ms.date="11/10/2014" ms.author="tamram" />

# Использование хранилища файлов Azure

В данном руководстве по началу работы мы продемонстрируем основы использования хранилища файлов Microsoft Azure. Во-первых, воспользуемся PowerShell, чтобы создать новый файл Azure для общего доступа, добавить каталог, загрузить локальный файл для общего доступа и выводить список файлов в каталоге. Затем покажем, как смонтировать файлы для общего доступа из виртуальной машины Azure, так же как и любой другой общий ресурс SMB.

Для пользователей, которым может понадобиться общий доступ к файлам из локального приложения, а также из виртуальной машины или облачной службы Azure, покажем, как использовать клиентскую библиотеку .NET хранилища Azure для работы с общим доступом к файлам из настольного приложения.

> [WACOM.NOTE] Для выполнения примеров кода .NET из этого руководства необходимо наличие клиентской библиотеки .NET хранилища Azure версии 4.x или более поздней версии. Клиентская библиотека хранилища доступна через [NuGet](https://www.nuget.org/packages/WindowsAzure.Storage/).


##Оглавление

-   [Что такое хранилище файлов?][]
-   [Принципы хранилища файлов][]
-   [Создание учетной записи хранения Azure][]
-   [Использование PowerShell для создания файлов для общего доступа][]
-	[Подключение ресурса для общего доступа из виртуальной машины Azure][]
-   [Создание локального приложения для доступа к хранилищу файлов][]
-   [Дальнейшие действия][]


##<a name="what-is-file-storage"></a>Что такое хранилище файлов Azure?

Хранилище файлов предлагает совместно используемое хранилище для приложений, использующих стандартный протокол SMB 2.1. Виртуальные машины и облачные службы Azure могут использовать файловые данные компонентов приложений через подключенные ресурсы, а локальные приложения получают доступ к этим данным совместно с помощью API хранилища файлов.

Приложения, работающие на виртуальных машинах Azure или облачных службах, могут подключать ресурсы хранилищ файлов для доступа к данным файлов, так же как это бы делало настольное приложение при подключении обычного ресурса SMB. Любое количество виртуальных машин Azure может одновременно подключаться и получать доступ к ресурсам хранилища файлов.

Так как ресурсы хранилища файлов представляют собой стандартные файловые ресурсы SMB 2.1, приложения, работающие в Аzure, могут получать к ним доступ через файловые API ввода-вывода. Таким образом, разработчики могут использовать имеющиеся у них коды и навыки для миграции существующих приложений. IT-специалисты получают возможность использовать командлеты PowerShell для создания и подключения ресурсов хранилища файлов, а также управления им в качестве части администрирования приложений Azure. В данном руководстве будут приведены примеры и для первого и для второго.

Наиболее частые способы использования хранилища файлов:

- миграция локальных приложений, которые используют совместно используемые файлы, на виртуальные машины или облачные службы Azure без необходимости затратного переписывания кода;
- хранение совместно используемых настроек приложений, например файлов конфигурации;
- хранение диагностических данных, таких как журналы, метрики и аварийные дампы в совместно используемом расположении; 
- хранение средств и утилит, необходимых для разработки и администрирования виртуальных машин или облачных служб Azure.

##<a name="file-storage-concepts"></a>Принципы хранилища файлов

Хранилище файлов состоит из следующих компонентов:

![files-concepts][files-concepts]


-   **Учетная запись хранения.** Весь доступ к хранилищу Azure осуществляется с помощью учетной записи хранения. Подробную информацию о емкости учетной записи хранения см. в статье [Целевые показатели по производительности и масштабируемости для службы хранилища Azure](http://msdn.microsoft.com/ru-ru/library/dn249410.aspx) .

-   **Совместно используемый ресурс.** Совместно используемое хранилище файлов представляет собой общую папку с файлами SMB 2.1 в Azure. Все каталоги и файлы должны быть созданы в родительской общей папке. Учетная запись может содержать любое количество совместно используемых ресурсов, а ресурс может содержать любое количество файлов, насколько это позволяет емкость учетной записи хранения.

-   **Каталог.** Необязательная иерархическая структура каталогов. 

-	**Файл.** Файл в совместно используемом ресурсе. Файлы могут иметь размер до 1 ТБ.

-   **Форматы URL-адреса.** К файлам можно обратиться, используя URL-адреса в следующем формате: https://<учетная_запись_хранения>.file.core.windows.net/<общая_папка>/<каталог/каталоги>/<файл>  
    
    Следующий пример URL-адреса можно использовать для обращения к одному из файлов в схеме выше:  
    http://acmecorp.file.core.windows.net/cloudfiles/diagnostics/log.txt



Дополнительную информацию о способе именования ресурсов, каталогов и файлов см. в разделе [Naming and Referencing Shares, Directories, Files, and Metadata] (Присвоение имен и ссылки на совместно используемые ресурсы, каталоги, файлы и метаданные)(http://msdn.microsoft.com/ru-ru/library/azure/dn167011.aspx).

##<a name="create-account"></a>Создание учетной записи хранения Azure

В настоящее время хранилище файлов Azure находится на стадии предварительной версии. Чтобы запросить доступ к предварительной версии, перейдите на [страницу предварительной версии Microsoft Azure](/ru-ru/services/preview/) и запросите доступ к **файлам Azure**. После одобрения запроса вам придет уведомление о предоставлении доступа к предварительной версии хранилища файлов. Затем можно создать учетную запись хранения для доступа к хранилищу файлов.

> [WACOM.NOTE] Хранилище файлов в настоящее время доступно только для новых учетных записей хранения. После предоставления доступа подписки к хранилищу файлов создайте новую учетную запись хранения для использования в данном руководстве.

[WACOM.INCLUDE [create-storage-account](../includes/create-storage-account.md)]

##<a name="use-cmdlets"></a>Использование PowerShell для создания файлов для общего доступа

###Установите командлеты PowerShell для хранилища Azure

Для подготовки к использованию PowerShell загрузите и установите командлеты Azure PowerShell. См. статью [Установка и настройка Azure PowerShell],(/ru-ru/documentation/articles/install-configure-powershell/) в которой указано соответствующее место установки и приведены указания по ее выполнению.

> [WACOM.NOTE] Командлеты PowerShell для службы файлов доступны только в последней версии модуля Azure PowerShell (версия 0.8.5 и выше). Рекомендуется загрузить и установить или обновить версию модуля Azure PowerShell.

Откройте окно Azure PowerShell, щелкнув **Пуск** и набрав **Microsoft Azure PowerShell**. Окно Azure PowerShell выполнит загрузку модуля Azure PowerShell.

###Создание объекта контекста и ключа для учетной записи хранения

Создайте объект контекста учетной записи хранения. Контекст включает имя учетной записи и ключ Замените "account-name" и "account-key" вашим именем учетной записи и ключом как показано в следующем примере:

    # create a context for account and key
    $ctx=New-AzureStorageContext account-name account-key
    
###Создание нового ресурса совместно используемых файлов

Затем создайте новый общий ресурс, имеющий имя "sampleshare" для данного примера:

    # create a new share
    $s = New-AzureStorageShare sampleshare -Context $ctx

У вас появится новый общий ресурс в хранилище файлов. Далее мы добавим каталог и файл.

###Создание каталога в ресурсе совместно используемых файлов

Затем создайте каталог в ресурсе совместно используемых файлов. В данном примере каталог имеет имя "sampledir":

    # create a directory in the share
    New-AzureStorageDirectory -Share $s -Path sampledir

###Отправка локального файла в каталог

Затем загрузите локальный файл в хранилище файлов. В следующем примере выполняется передача файла из C:\temp\samplefile.txt. Отредактируйте путь к файлу, чтобы он соответствовал пути к существующему файлу на локальном компьютере: 
    
    # upload a local file to the new directory
    Set-AzureStorageFileContent -Share $s -Source C:\temp\samplefile.txt -Path sampledir

###Просмотр списка файлов в каталоге

Чтобы просмотреть, какие файлы имеются в каталоге, можно вывести список файлов. Эта команда также выведет список подкаталогов, однако в данном примере они отсутствуют, и в списке будут перечислены только файлы.  

    # list files in the new directory
    Get-AzureStorageFile -Share $s -Path sampledir

##<a name="mount-share"></a>Монтирование ресурса для общего доступа из виртуальной машины Azure

Для демонстрации монтирования ресурса для совместно используемых файлов Azure создадим виртуальную машину Azure и удаленно подключимся к ней для монтирования ресурса. 

1. Сначала создайте виртуальную машину Azure, выполнив действия, описанные в разделе [Создание виртуальной машины под управлением Windows Server](/ru-ru/documentation/articles/virtual-machines-windows-tutorial/).
2. Затем подключитесь к виртуальной машине, выполнив действия, описанные в разделе [Как войти в систему на виртуальной машине, работающей под управлением Windows Server](/ru-ru/documentation/articles/virtual-machines-log-on-windows-server/).
3. Откройте окно PowerShell на виртуальной машине. 

###Ввод данных учетной записи хранения в виртуальной машине.

Перед монтированием общего ресурса введите данные учетной записи хранения в виртуальной машине. Это позволит Windows автоматически восстанавливать подключение к общему ресурсу файлов при перезагрузке виртуальной машины. Для ввода данных учетной записи выполните команду "cmdkey" в окне PowerShell на виртуальной машине. Замените <storage-account> именем учетной записи хранения, а <account-key> - ключом доступа учетной записи:

	cmdkey /add:<storage-account>.file.core.windows.net /user:<storage-account> /pass:<account-key>

Windows автоматически восстановит подключение к общему ресурсу файлов при перезагрузке виртуальной машины. Вы можете проверить восстановление подключения к общему ресурсу, выполнив команду "net use" в окне PowerShell.

###Монтирование общего ресурса файлов с использованием введенных данных учетной записи

После подключения к виртуальной машине вы можете выполнить команду "net use" для монтирования ресурса с использованием следующего синтаксиса. Замените <storage-account> именем учетной записи хранения, а <share-name> - ключом доступа учетной записи общего ресурса хранения файлов.

	используйте z: \\<storage-account>.file.core.windows.net\<share-name>

> [WACOM.NOTE] Так как вы сохранили данные учетной записи хранения на предыдущем этапе, нет необходимости вводить их повторно с командой "net use". Если вы еще не сохранили данные учетной записи, включите их в виде параметра вызова команды "net use". Замените <storage-account> именем учетной записи хранения, <share-name> - ключом доступа учетной записи общего ресурса хранения файлов, а <account-key> - ключом доступа учетной записи.
	   
	используйте z: \\<storage-account>.file.core.windows.net\<share-name> /u:<storage-account> <account-key>

Теперь можно работать с общим ресурсом хранилища файлов в виртуальной машине, как с обычным диском. Можно выполнять стандартные команды для работы с файлами из интерфейса командной строки, либо просматривать монтированный ресурс и его содержимое с помощью Проводника. Также можно запускать на виртуальной машине код, который получит доступ к ресурсу с использованием стандартных API ввода-вывода Windows, так как они предоставляются [пространствами имен System.IO](http://msdn.microsoft.com/ru-ru/library/gg145019(v=vs.110)(ASPX) в .NET Framework. 

Также можно монтировать общий ресурс файлов из роли, запущенной в облачной службе Azure с помощью удаленного подключения к роли.

##<a name="create-console-app"></a>Создание локального приложения для работы с хранилищем файлов

Вы можете монтировать общий ресурс хранилища файлов в виртуальной машине или облачной службе Azure, как это было показано выше. Однако, этого нельзя сделать из локального приложения. Для доступа к общим данным из локального приложения необходимо пользоваться API хранилища файлов. В данном примере показано, как работать с общим ресурсом фалов через [клиентскую библиотеку.NET хранилища Azure](http://go.microsoft.com/fwlink/?LinkID=390731&clcid=0x409). 

Чтобы показать, как использовать API из локального приложения, создадим простое консольное приложение, работающее на настольном компьютере.

###Создание консольного приложения и получение сборки

Для создания нового консольного приложения в Visual Studio и установки пакета NuGet хранилища Azure:

1. В Visual Studio выберите **Файл** -> **Создать проект** и выберите в списке шаблонов Visual C# **Windows** -> **Консольное приложение**.
2. Укажите имя консольного приложения и нажмите кнопку **ОК**.
3. После создания проекта щелкните правой кнопкой мыши проект в обозревателе решений и выберите **Управление пакетами NuGet**. Выполните в Интернете поиск "WindowsAzure.Storage" и нажмите кнопку **Установить**, чтобы установить пакет службы хранилища Azure и зависимые компоненты.

###Сохранение данных учетной записи хранения в файле app.config.

Затем сохраните данные учетной записи хранения в файле app.config вашего проекта. Отредактируйте файл app.config, чтобы он был похож на следующий пример, заменив "myaccount" именем учетной записи хранения, "mykey" - ключом доступа учетной записи хранения:

    <?xml version="1.0" encoding="utf-8" ?>
	<configuration>
		<startup> 
			<supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.5" />
		</startup>
		<appSettings>
			<add key="StorageConnectionString" value="DefaultEndpointsProtocol=https;AccountName=myaccount;AccountKey=mykey" />
		</appSettings>
	</configuration>

> [WACOM.NOTE] Последняя версия эмулятора службы хранилища Azure не поддерживает хранилище файлов. Строка подключения должна указывать учетную запись хранения Azure облаке, для которой имеется доступ к предварительной версии хранилища файлов.


###Добавление объявлений пространств имен
Откройте в обозревателе решений файл program.cs и добавьте следующие объявления пространств в начало файла:

    using Microsoft.WindowsAzure;
	using Microsoft.WindowsAzure.Storage;
	using Microsoft.WindowsAzure.Storage.File;

###Получение строки подключения программным путем
Вы можете получить сохраненные данные учетной записи из файла app.config с помощью класса "Microsoft.WindowsAzure.CloudConfigurationManager" или класса "System.Configuration.ConfigurationManager". В примере показано, как получить данные учетной записи с использованием класса "CloudConfigurationManager" и инкапсулировать их в класс "CloudStorageAccount". В метод "Main()" в program.cs добавьте следующий код:

    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(
        CloudConfigurationManager.GetSetting("StorageConnectionString"));

###Доступ к общему ресурсу хранилища файлов программным путем

Затем, добавьте код в метод "Main()", после ранее указанного кода, чтобы получить строку для подключения. Этот код получает ссылку на ранее созданный файл и выводит его содержимое в окне консоли.

	//Create a CloudFileClient object for credentialed access to File storage.
    CloudFileClient fileClient = storageAccount.CreateCloudFileClient();

	//Get a reference to the file share we created previously.
    CloudFileShare share = fileClient.GetShareReference("sampleshare");

	//Ensure that the share exists.
    if (share.Exists())
    {
		//Get a reference to the root directory for the share.
        CloudFileDirectory rootDir = share.GetRootDirectoryReference();

		//Get a reference to the sampledir directory we created previously.
        CloudFileDirectory sampleDir = rootDir.GetDirectoryReference("sampledir");

		//Ensure that the directory exists.
        if (sampleDir.Exists())
        {
			//Get a reference to the file we created previously.
            CloudFile file = sampleDir.GetFileReference("samplefile.txt");

			//Ensure that the file exists.
            if (file.Exists())
            {
				//Write the contents of the file to the console window.
                Console.WriteLine(file.DownloadTextAsync().Result);
            }
        }
    }

Запустите консольное приложение и получите вывод.

## <a name="next-steps"></a>Дальнейшие действия

Вы получили общее представление об управлении хранилищем файлов.
Для решения более сложных задач, перейдите по следующим ссылкам.
<ul>
<li>Дополнительную информацию о доступных API-интерфейсах см. в справочной документации по хранилищу файлов:
  <ul>
    <li><a href="http://go.microsoft.com/fwlink/?LinkID=390731&clcid=0x409">Справочник по клиентской библиотеке хранения для .NET</a>
    </li>
    <li><a href="http://msdn.microsoft.com/ru-ru/library/azure/dn167006.aspx">Справочник API REST службы файлов</a></li>
  </ul>
</li>
<li>Просмотрите записи в блоге группы службы хранилища Azure, относящиеся к службе файлов:
  <ul>
    <li><a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2014/05/12/introducing-microsoft-azure-file-service.aspx">Введение в службы файлов Microsoft Azure</a>
    </li>
    <li><a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2014/05/27/persisting-connections-to-microsoft-azure-files.aspx">Сохраняемые подключения к хранилищу файлов Microsoft Azure</a></li>
  </ul>
</li><li>Просмотрите дополнительные руководства, чтобы изучить дополнительные возможности хранения данных в Azure.
  <ul>
    <li>Использовать <a href="/ru-ru/documentation/articles/storage-dotnet-how-to-use-blobs/">Хранилище BLOB-объектов</a> для хранения неструктурированных данных.</li>
    <li>Использовать <a href="/ru-ru/documentation/articles/storage-dotnet-how-to-use-tables/">Хранилище таблиц</a> для хранения структурированных данных.</li>
    <li>Использовать <a href="/ru-ru/documentation/articles/storage-dotnet-how-to-use-queues/">Хранилище очередей</a> для надежного хранения сообщений.</li>
    <li>Использовать <a href="/ru-ru/documentation/articles/sql-database-dotnet-how-to-use/">База данных SQL</a> для хранения реляционных данных.</li>
  </ul>
</li>
</ul>

[Дальнейшие действия]: #next-steps
[Что такое хранилище файлов?]: #what-is-file-storage 
[Принципы хранилища файлов]: #file-storage-concepts
[Создание учетной записи хранения Azure]: #create-account
[Использование PowerShell для создания файлов для общего доступа]: #use-cmdlets
[Подключение ресурса для общего доступа из виртуальной машины Azure]: #mount-share
[Создание локального приложения для доступа к хранилищу файлов]: #create-console-app

[files-concepts]: ./media/storage-dotnet-how-to-use-files/files-concepts.png


<!--HONumber=35.1-->
