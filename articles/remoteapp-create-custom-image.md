<properties title="How to create a custom template image for RemoteApp" pageTitle="How to create a custom template nimage for RemoteApp" description="Learn how to create a custom template image for RemoteApp. You can use this template with either a hybrid or cloud deployment." metaKeywords="" services="" solutions="" documentationCenter="" authors="elizapo" manager="kathyw" />

<tags ms.service="remoteapp" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="09/12/2014" ms.author="elizapo" ms.manager="kathyw"></tags>

# Создание настраиваемого образа шаблона для службы RemoteApp

Azure RemoteApp использует образ шаблона Windows Server 2012 R2 для размещения всех программ, которыми вы планируете делиться с пользователями. Чтобы создать образ шаблона RemoteApp, можно использовать существующий образ или создать новый. К образу, который может быть передан для использования с Azure RemoteApp, предъявляются следующие требования:

-   Размер образа должен быть кратен 1 МБ. В противном случае при попытке отправить образ произойдет сбой.
-   Размер образа не должен превышать 127 ГБ.
-   Он должен быть помещен в VHD-файл (файлы VHDX в настоящее время не поддерживаются).
-   Виртуальный жесткий диск VHD должен быть либо фиксированного размера, либо иметь возможность динамического расширения. Рекомендуется использовать VHD с динамическим расширением, поскольку на его передачу в Azure уходит меньше времени, чем на передачу VHD-файла с фиксированным размером.
-   Диск должен быть инициализирован с использованием стиля разделов основной загрузочной записи (MBR). Стиль разделов (GPT) таблицы разделов GUID не поддерживается.
-   VHD должен содержать одну установку Windows Server 2012 R2. Он может содержать несколько томов, но только один из них может содержать установку Windows.
-   Должны быть установлены роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола».
-   Шифрующая файловая система (EFS) должна быть выключена.
-   Образ должен быть обработан командой SYSPREP с использованием параметров **/oobe /generalize /shutdown** (запуск при первом включении компьютера/ обобщить/ выключить) (НЕ ИСПОЛЬЗУЙТЕ параметр **/mode:vm** (Режим виртуальной машины)).

**Перед началом работы**

Перед созданием службы необходимо выполнить следующие действия.

-   Зарегистрироваться для предварительной версии RemoteApp. Это можно сделать на странице [][0][http://azure.microsoft.com/ru-ru/services/remoteapp/](http://azure.microsoft.com/ru-ru/services/remoteapp/)</a>.
-   создать учетную запись пользователя в Active Directory для использования в качестве учетной записи службы RemoteApp. ограничить разрешения для этой учетной записи, чтобы она могла только присоединять машины к домену.
-   собрать информацию о своей локальной сети: информацию об IP-адресе и сведения о VPN-устройстве.
-   установить модуль [Azure PowerShell][Azure PowerShell].
-   Собрать сведения о пользователях и группах, которым требуется предоставить доступ. Это могут быть сведения об учетных записях Майкрософт или учетных записях в организации Active Directory для пользователей и групп.

## **Создание образа шаблона**

Чтобы создать образ шаблона с самого начала, необходимо выполнить следующие действия:

1.  найдите Windows Server 2012 R2 DVD или ISO-образ;
2.  создать VHD-файл;
3.  установить Windows Server 2012 R2;
4.  установить роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола»;
5.  установить дополнительные функции, необходимые для приложений;
6.  установить и настроить ваши приложения;
7.  Выполните любые дополнительные настройки Windows, необходимые для приложений.
8.  Выключите шифрующую файловую систему (EFS).
9.  Обработайте образ командой SYSPREP.

Ниже приводится подробное описание шагов для создания нового образа:

1.  найдите Windows Server 2012 R2 DVD или ISO-образ;
2.  создайте VHD-файл с помощью управления дисками;

    1.  запустите управление дисками (diskmgmt.msc);
    2.  создайте динамически расширяющийся VHD размером 40 ГБ или более; (Оцените объем дискового пространства, необходимый для Windows, ваших приложений и настроек. Установленный Windows Server с ролью RDSH и компонент «Возможности рабочего стола» требуют приблизительно 10 ГБ дискового пространства.)

        1.  нажмите **Action \> Create VHD** (Действие \> Создать VHD);
        2.  определите местоположение, размер и формат VHD; выберите **Dynamically expanding** (Динамически расширяющийся) и нажмите **OK**.

            Процесс создания диска занимает несколько секунд. После окончания создания VHD вы должны увидеть новый диск без буквы диска в состоянии Not initialized (Не инициализирован) на консоли управления дисками.

        -   Щелкните диск правой кнопкой мыши (а не свободное место) и нажмите **Initialize Disk** (Инициализировать диск). Выберите **MBR** (Основная загрузочная запись) в качестве стиля разделов и нажмите **OK**.
        -   Создайте новую таблицу: нажмите правой кнопкой мыши нераспределенное место, а затем нажмите **New Simple Volume** (Создать простой том). В мастере можно принять параметры по умолчанию, однако не забудьте присвоить букву диска, чтобы избежать возможных проблем при передаче образа шаблона.
        -   Щелкните диск правой кнопкой мыши, а затем нажмите **Detach VHD** (Отсоединить VHD).

3.  Установите Windows Server 2012 R2.

    1.  Создайте новую виртуальную машину. Используйте Мастер новой виртуальной машины в диспетчере Hyper-V или клиент Hyper-V.

        1.  На странице Specify Generation (Укажите поколение) выберите **Generation 1** (Поколение 1).
        2.  На странице «Подключить виртуальный жесткий диск» выберите параметр **Use an existing virtual hard disk** (Использовать существующий виртуальный жесткий диск) и перейдите к VHD, который был создан на предыдущем шаге.
        3.  На странице «Параметры установки» выберите **Install an operating system from a boot CD/DVD\_ROM** (Установить операционную систему с загрузочного CD/DVD\_ROM), а затем выберите местоположение установочного носителя Windows Server 2012 R2.
        4.  Выберите другие параметры в мастере, которые необходимы для установки Windows и ваших приложений. Завершите работу мастера.

    2.  После завершения работы мастера измените параметры виртуальной машины и внесите другие необходимые изменения для установки Windows и ваших программ (например, количество виртуальных машин), а затем нажмите **OK**.
    3.  Подключитесь к виртуальной машине и установите Windows Server 2012 R2.

4.  Установите роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола»:

    1.  Запустите диспетчер сервера.
    2.  Нажмите **Add Roles and features** (Добавить роли и компоненты) на экране Добро пожаловать или из меню **Manage** (Управление).
    3.  Нажмите **Next** (Далее) на странице «Перед началом работы».
    4.  Выберите **Role-based or feature-based installation** (Установка на основе ролей или функций), а затем нажмите **Next**.
    5.  Выберите локальный компьютер из списка и нажмите **Next**.
    6.  Выберите **Remote Desktop Services** (Службы удаленных рабочих столов), а затем нажмите **Next**.
    7.  Разверните список **User Interfaces and Infrastructure** (Пользовательские интерфейсы и инфраструктура) и выберите **Desktop Experience** (Возможности рабочего стола).
    8.  Нажмите **Add Features** (Добавить компоненты), а затем нажмите **Next**.
    9.  На странице служб удаленных рабочих столов нажмите **Next**.
    10. Нажмите **Remote Desktop Session Host** (Узел сеансов удаленных рабочих столов).
    11. Нажмите **Add Features** (Добавить компоненты), а затем нажмите **Next**.
    12. На странице подтверждения выбранных параметров установки выберите **Restart the destination server automatically if required** (Перезапустить целевой сервер автоматически, если требуется), а затем нажмите **Yes** (Да) в предупреждении о перезапуске.
    13. Нажмите **Install** (Установить). Компьютер перезапустится.

5.  Установите такие необходимые для приложений дополнительные компоненты, как .NET Framework 3.5. Чтобы установить компоненты, запустите мастер добавления ролей и компонентов.
6.  Установите и настройте программы и приложения, которые будут публиковаться через RemoteApp.

    **Важно!** Майкрософт рекомендует установить роль RDSH перед установкой приложений, чтобы обнаружить все проблемы с совместимостью приложений до передачи образа в RemoteApp.

7.  Выполните любые дополнительные настройки Windows, необходимые для приложений.
8.  Выключите шифрующую файловую систему (EFS). Выполните следующую команду в окне команд с повышенными привилегиями:

        Fsutil behavior set disableencryption 1

    Вместо этого можно задать или добавить следующее значение DWORD в реестре:

        HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1

9.  Если сборка образа выполняется внутри виртуальной машины Azure, переименуйте файл **\\%windir%\\Panther\\Unattend.xml**, так как он будет блокировать скрипт отправки, который используется позже во время работы. Измените имя этого файла на Unattend.old, чтобы его можно было найти в случае, если потребуется вернуться к предыдущему развертыванию.
10. Обработайте образ командой SYSPREP. В командной строке с повышенными привилегиями выполните следующую команду:

    **C:\\Windows\\System32\\sysprep\\sysprep.exe /generalize /oobe /shutdown**

    **Примечание.** не используйте переключатель **/mode:vm** команды SYSPREP, несмотря на то что это виртуальная машина.

## Дальнейшие действия

Созданный настраиваемый образ шаблона необходимо добавить в развертывание RemoteApp. Чтобы создать развертывание, воспользуйтесь информацией в следующих разделах:

-   [Как создать гибридное развертывание RemoteApp][Как создать гибридное развертывание RemoteApp]
-   [Создание облачного развертывания RemoteApp][Создание облачного развертывания RemoteApp]

  [0]: http://azure.microsoft.com/ru-ru/services/remoteapp/
  [Azure PowerShell]: http://azure.microsoft.com/ru-ru/documentation/articles/install-configure-powershell/
  [Как создать гибридное развертывание RemoteApp]: http://azure.microsoft.com/ru-ru/documentation/articles/remoteapp-create-hybrid-deployment/
  [Создание облачного развертывания RemoteApp]: http://azure.microsoft.com/ru-ru/documentation/articles/remoteapp-create-cloud-deployment/
