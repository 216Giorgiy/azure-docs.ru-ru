<properties title="How to create a custom template image for RemoteApp" pageTitle="Создание настраиваемого образа шаблона для RemoteApp" description="Узнайте, как создать настраиваемый образ шаблона для удаленного приложения RemoteApp Этот шаблон можно использовать для гибридного или облачного развертывания." metaKeywords="" services="" solutions="" documentationCenter="" authors="elizapo" manager="mbaldwin" />

<tags ms.service="remoteapp" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="12/12/2014" ms.author="elizapo" ms.manager="mbaldwin" />

#Создание настраиваемого образа шаблона для RemoteApp
Azure RemoteApp использует образ шаблона Windows Server 2012 R2 для размещения всех программ, которыми вы планируете делиться с пользователями. Чтобы создать образ шаблона RemoteApp, можно использовать существующий образ или создать новый. К образу, который может быть передан для использования с Azure RemoteApp, предъявляются следующие требования:


- Размер образа должен быть кратен 1 МБ. В противном случае при попытке отправить образ произойдет сбой.
- Размер образа не должен превышать 127 ГБ. 
- Он должен быть помещен в VHD-файл (файлы VHDX в настоящее время не поддерживаются).
- Виртуальный жесткий диск не должен быть виртуальной машиной второго поколения.
- Виртуальный жесткий диск VHD должен быть либо фиксированного размера, либо иметь возможность динамического расширения. Рекомендуется использовать VHD с динамическим расширением, поскольку на его передачу в Azure уходит меньше времени, чем на передачу VHD-файла с фиксированным размером.
- Диск должен быть инициализирован с использованием стиля разделов основной загрузочной записи (MBR). Стиль разделов (GPT) таблицы разделов GUID не поддерживается. 
- VHD должен содержать одну установку Windows Server 2012 R2. Он может содержать несколько томов, но только один из них может содержать установку Windows. 
- Должны быть установлены роль узла сеансов удаленных рабочих столов (RDSH) и компонент "Возможности рабочего стола".
- Роль посредника подключений к удаленному рабочему столу *не* должна быть установлена.
- Шифрующая файловая система (EFS) должна быть выключена.
- Образ должен быть обработан командой SYSPREP с использованием параметров **/oobe /generalize /shutdown** (НЕ ИСПОЛЬЗУЙТЕ параметр **/mode:vm**).


**Перед началом работы**

Перед созданием службы необходимо выполнить следующие действия.

- Зарегистрируйтесь в RemoteApp. Это можно сделать на странице [http://azure.microsoft.com/ru-ru/services/remoteapp/](http://azure.microsoft.com/ru-ru/services/remoteapp/).
- создать учетную запись пользователя в Active Directory для использования в качестве учетной записи службы RemoteApp. ограничить разрешения для этой учетной записи, чтобы она могла только присоединять машины к домену. Дополнительные сведения см. в статье [Настройка Azure Active Directory для RemoteApp](http://azure.microsoft.com/ru-ru/documentation/articles/remoteapp-ad/).
- собрать информацию о своей локальной сети: информацию об IP-адресе и сведения о VPN-устройстве.
- Установите модуль [Azure PowerShell](http://azure.microsoft.com/ru-ru/documentation/articles/install-configure-powershell/).
- Соберите сведения о пользователях, которым нужно предоставить доступ. Это могут быть либо данные учетной записи Майкрософт, либо данные рабочей учетной записи Active Directory пользователя.



## **Создание образа шаблона**##

Чтобы создать образ шаблона с самого начала, необходимо выполнить следующие действия:

1.	найдите Windows Server 2012 R2 DVD или ISO-образ;
2.	создать VHD-файл;
4.	установить Windows Server 2012 R2;
5.	установить роль узла сеансов удаленных рабочих столов (RDSH) и компонент "Возможности рабочего стола";
6.	установить дополнительные функции, необходимые для приложений;
7.	установить и настроить ваши приложения;
8.	Выполните любые дополнительные настройки Windows, необходимые для приложений.
9.	Выключите шифрующую файловую систему (EFS).
9.	Обработайте образ командой SYSPREP.

Ниже приводится подробное описание шагов для создания нового образа:

1.	найдите Windows Server 2012 R2 DVD или ISO-образ; 
2.	создайте VHD-файл с помощью управления дисками; 
	1.	запустите управление дисками (diskmgmt.msc); 
	2.	создайте динамически расширяющийся VHD размером 40 ГБ или более; (Оцените объем дискового пространства, необходимый для Windows, ваших приложений и настроек. Установленный Windows Server с ролью RDSH и компонент "Возможности рабочего стола" требуют приблизительно 10 ГБ дискового пространства.)
		1.	Нажмите **Действие > Создать виртуальный жесткий диск**.
		2.	определите местоположение, размер и формат VHD; Выберите **Динамически расширяемый** и нажмите кнопку **ОК**.

			Процесс создания диска занимает несколько секунд. После окончания создания VHD вы должны увидеть новый диск без буквы диска в состоянии Not initialized (Не инициализирован) на консоли управления дисками.

		- Щелкните правой кнопкой мыши жесткий диск (а не свободное место) и выберите пункт **Инициализировать диск**. Выберите **MBR** (Основная загрузочная запись) в качестве стиля разделов и нажмите кнопку **ОК**.
		- Создайте новый том, нажмите правой кнопкой мыши нераспределенное место, а затем нажмите **Создать простой том**. В мастере можно принять параметры по умолчанию, однако не забудьте присвоить букву диска, чтобы избежать возможных проблем при передаче образа шаблона.
		- Щелкните диск правой кнопкой мыши и выберите пункт **Отсоединить виртуальный жесткий диск**.

			



1. Установите Windows Server 2012 R2.
	1. Создайте новую виртуальную машину. Используйте Мастер новой виртуальной машины в диспетчере Hyper-V или клиент Hyper-V. 
		1. На странице "Укажите поколение" выберите **Поколение 1**.
		2. На странице "Подключение виртуального жесткого диска" выберите параметр **Использовать существующий виртуальный жесткий диск** и перейдите к виртуальному жесткому диску, который был создан на предыдущем шаге.
		2. На странице "Параметры установки" выберите **Установить операционную систему с загрузочного CD/DVD_ROM**, а затем выберите местоположение установочного носителя Windows Server 2012 R2.
		3. Выберите другие параметры в мастере, которые необходимы для установки Windows и ваших приложений. Завершите работу мастера.
	2.  После завершения работы мастера измените параметры виртуальной машины и внесите другие необходимые изменения для установки Windows и ваших программ (например, количество виртуальных машин), а затем нажмите **ОК**.
	4.  Подключитесь к виртуальной машине и установите Windows Server 2012 R2.
1. Установите роль узла сеансов удаленных рабочих столов (RDSH) и компонент "Возможности рабочего стола":
	1. Запустите диспетчер сервера.
	2. Нажмите **Добавить роли и компоненты** на экране "Добро пожаловать" или в меню **Управление**.
	3. Нажмите **Далее** на странице "Перед началом работы".
	4. Выберите **Установка на основе ролей или функций** и нажмите **Далее**.
	5. Выберите локальный компьютер из списка и нажмите **Далее**.
	6. Выберите **Службы удаленных рабочих столов** и нажмите **Далее**.
	7. Разверните список **Пользовательские интерфейсы и инфраструктура** и выберите **Возможности рабочего стола**.
	8. Нажмите **Добавить компоненты**, а затем - **Далее**.
	9. На странице "Службы удаленных рабочих столов" нажмите **Далее**.
	10. Нажмите **Узел сеансов удаленных рабочих столов**.
	11. Нажмите **Добавить компоненты**, а затем -  **Далее**.
	12. На странице подтверждения выбранных параметров установки выберите **Перезапустить целевой сервер автоматически, если требуется**, а затем нажмите **Да** в предупреждении о перезапуске.
	13. Нажмите **Установить**. Компьютер перезапустится.
1.	Установите такие необходимые для приложений дополнительные компоненты, как .NET Framework 3.5. Чтобы установить компоненты, запустите мастер добавления ролей и компонентов.
7.	Установите и настройте программы и приложения, которые будут публиковаться через RemoteApp.

 	**Важно!** 


	- Корпорация Майкрософт рекомендует установить роль RDSH перед установкой приложений, чтобы обнаружить все проблемы с совместимостью приложений до передачи образа в RemoteApp.
	- Убедитесь, что приложение отображается в меню "Пуск". Кроме того, убедитесь, что в меню "Пуск" отображается тот значок, который должны видеть пользователи. Если это не так, измените значок. (Добавлять приложения в меню "Пуск" *необязательно*, но это упростит публикацию приложения в RemoteApp. В противном случае при публикации приложения потребуется указать путь установки.)

8.	Выполните любые дополнительные настройки Windows, необходимые для приложений.
9.	Выключите шифрующую файловую систему (EFS). Выполните следующую команду в окне команд с повышенными привилегиями:

		Fsutil behavior set disableencryption 1

	Вместо этого можно задать или добавить следующее значение DWORD в реестре: 

		HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1
9.	Если сборка образа выполняется внутри виртуальной машины Azure, переименуйте файл **\%windir%\Panther\Unattend.xml**, так как он будет блокировать скрипт отправки, который используется позже во время работы. Измените имя этого файла на Unattend.old, чтобы его можно было найти в случае, если потребуется вернуться к предыдущему развертыванию.
10.	Обработайте образ командой SYSPREP. В командной строке с повышенными привилегиями выполните следующую команду: 

	**C:\Windows\System32\sysprep\sysprep.exe /generalize /oobe /shutdown**
	
	**Note:** Do not use the **/mode:vm** switch of the SYSPREP command even though this is a virtual machine. 


## Дальнейшие действия ##
Созданный настраиваемый образ шаблона необходимо добавить в развертывание RemoteApp. Чтобы создать коллекцию, воспользуйтесь информацией в следующих статьях:


- [Создание гибридной коллекции RemoteApp](http://azure.microsoft.com/ru-ru/documentation/articles/remoteapp-create-hybrid-deployment/) 
- [Создание облачной коллекции RemoteApp](http://azure.microsoft.com/ru-ru/documentation/articles/remoteapp-create-cloud-deployment/)


<!--HONumber=35.2-->
