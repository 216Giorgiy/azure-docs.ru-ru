<properties title="How to create a custom template image for RemoteApp" pageTitle="Создание пользовательского образа шаблона для службы RemoteApp" description="Learn how to create a custom template image for RemoteApp. You can use this template with either a hybrid or cloud deployment." metaKeywords="" services="" solutions="" documentationCenter="" authors="elizapo" manager="kathyw" />

<tags ms.service="remoteapp" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="10/22/2014" ms.author="elizapo" ms.manager="kathyw" />

#Создание настраиваемого образа шаблона для службы RemoteApp
Azure RemoteApp использует образ шаблона Windows Server 2012 R2 для размещения всех программ, которые планируется сделать доступными пользователям. Чтобы создать образ шаблона RemoteApp, можно использовать существующий образ или создать новый. К образу, который может быть передан для использования с Azure RemoteApp, предъявляются следующие требования:


- Размер образа должен быть кратен 1 МБ. В противном случае при попытке его отправить произойдет сбой.
- Размер образа не должен превышать 127 ГБ. 
- Он должен быть помещен в VHD-файл (файлы VHDX в настоящее время не поддерживаются).
- Виртуальный жесткий диск VHD не должен быть виртуальной машиной 2 поколения.
- Виртуальный жесткий диск VHD должен иметь либо фиксированный размер, либо возможность динамического расширения. Рекомендуется использовать VHD с динамическим расширением, поскольку на его передачу в Azure уходит меньше времени, чем на передачу VHD-файла с фиксированным размером.
- Диск должен быть инициализирован с использованием стиля разделов главной загрузочной записи (MBR). Стиль разделов (GPT) таблицы разделов GUID не поддерживается. 
- VHD должен содержать одну установку Windows Server 2012 R2. Он может содержать несколько томов, но только один из них может содержать установку Windows. 
- Должны быть установлены роль узла сеансов удаленных рабочих столов (RDSH) и компонент "Возможности рабочего стола".
- Роль посредника подключений к удаленному рабочему столу *НЕ ДОЛЖНА* быть установлена.
- Шифрующая файловая система (EFS) должна быть выключена.
- Образ должен быть обработан командой SYSPREP с параметрами **/oobe /generalize /shutdown** (НЕ УКАЗЫВАЙТЕ параметр **/mode:vm**).


**Перед началом работы**

Перед созданием службы необходимо выполнить следующие действия.

- Зарегистрироваться для предварительной версии RemoteApp. Это можно сделать на странице [http://azure.microsoft.com/ru-ru/services/remoteapp/](http://azure.microsoft.com/ru-ru/services/remoteapp/).
- Создать учетную запись пользователя в Active Directory для использования в качестве учетной записи службы RemoteApp. Ограничить разрешения для этой учетной записи, чтобы она могла только присоединять машины к домену.
- Собрать информацию о своей локальной сети: информацию об IP-адресе и сведения о VPN-устройстве.
- Установить модуль [Azure PowerShell](http://azure.microsoft.com/ru-ru/documentation/articles/install-configure-powershell/).
- Собрать сведения о пользователях и группах, которым требуется предоставить доступ. Это могут быть сведения об учетных записях Майкрософт или учетных записях в организации Active Directory для пользователей и групп.



## **Создание образа шаблона**##

Чтобы создать образ шаблона с самого начала, необходимо выполнить следующие действия:

1.	Найдите Windows Server 2012 R2 на образе DVD или ISO.
2. Создайте VHD-файл.
4. Установите Windows Server 2012 R2.
5. Установите роль узла сеансов удаленных рабочих столов (RDSH) и компонент "Возможности рабочего стола".
6. Установите дополнительные функции, необходимые для приложений.
7. Установите и настройте ваши приложения.
8. Выполните все дополнительные настройки Windows, необходимые для приложений.
9. Выключите шифрующую файловую систему (EFS).
9. Обработайте образ командой SYSPREP.

Ниже приводится подробное описание шагов для создания нового образа:

1.	Найдите Windows Server 2012 R2 на образе DVD или ISO. 
2.	Создайте VHD-файл с помощью управления дисками. 
	1.	Запустите управление дисками (diskmgmt.msc). 
	2.	Создайте динамически расширяющийся VHD размером не менее 40 ГБ. (Оцените объем дискового пространства, необходимый для Windows, ваших приложений и настроек. Установленный Windows Server с ролью RDSH и компонентом "Возможности рабочего стола" требуют приблизительно 10 ГБ дискового пространства.)
		1.	Выберите **Действия > Создать виртуальный жесткий диск**.
		2.	Укажите расположение, размер и формат VHD. Выберите **Динамически расширяемый** и нажмите **ОК**.

			Процесс создания диска займет несколько секунд. После окончания создания VHD появится новый диск без буквы в состоянии "Не инициализирован" на консоли управления дисками.

		- Щелкните диск (не свободное место) правой кнопкой мыши и выберите **Инициализировать диск**. Выберите **MBR** в качестве стиля раздела и нажмите **OK**.
		- Создайте новый том: нажмите правой кнопкой мыши нераспределенное место, а затем нажмите **New Simple Volume** (Создать простой том). В мастере можно принять параметры по умолчанию, однако не забудьте присвоить диску букву, чтобы избежать возможных проблем при передаче образа шаблона.
		- Щелкните диск правой кнопкой мыши, а затем нажмите **Отсоединить VHD**.

			



1. Установите Windows Server 2012 R2.
	1. Создайте новую виртуальную машину. Используйте мастер создания виртуальной машины в диспетчере Hyper-V или клиент Hyper-V.
		1. На странице "Укажите поколение" выберите **Поколение 1**.
		2. На странице "Подключить виртуальный жесткий диск" выберите параметр **Использовать существующий виртуальный жесткий диск** и перейдите к VHD, который был создан на предыдущем шаге.
		2. На странице "Параметры установки" выберите **Установить операционную систему с загрузочного CD/DVD_ROM**, а затем выберите местоположение установочного носителя Windows Server 2012 R2.
		3. Выберите другие параметры в мастере, которые необходимы для установки Windows и приложений. Завершите работу мастера.
	2. После завершения работы мастера измените параметры виртуальной машины и внесите другие необходимые изменения для установки Windows и приложений (например, количество виртуальных машин), а затем нажмите **OK**.
	4. Подключитесь к виртуальной машине и установите Windows Server 2012 R2.
1. Установите роль узла сеансов удаленных рабочих столов (RDSH) и компонент "Возможности рабочего стола".
	1. Запустите диспетчер сервера.
	2. Нажмите **Добавить роли и компоненты** на экране приветствия или в меню **Управление**.
	3. Нажмите **Далее** на странице "Перед началом работы".
	4. Выберите **Установка на основе ролей или компонентов**, а затем нажмите **Next**.
	5. Выберите локальный компьютер из списка и нажмите **Next**.
	6. Выберите **Службы удаленных рабочих столов**, а затем нажмите **Next**.
	7. Разверните список **Пользовательские интерфейсы и инфраструктура** и выберите **Возможности рабочего стола**.
	8. Выберите **Добавить компоненты**, а затем нажмите кнопку **Далее**.
	9. На странице служб удаленных рабочих столов нажмите **Next**.
	10. Щелкните **узел сеансов удаленных рабочих столов**.
	11. Выберите **Добавить компоненты**, а затем нажмите кнопку **Далее**.
	12. На странице подтверждения выбранных параметров установки выберите **Перезапустить целевой сервер автоматически, если требуется**, а затем нажмите **Да** в предупреждении о перезапуске.
13. Нажмите **Установить**. Компьютер перезапустится.
1.	Установите такие необходимые для приложений дополнительные компоненты, как .NET Framework 3.5. Для установки компонентов запустите мастер добавления ролей и компонентов.
7.	Установите и настройте программы и приложения, которые будут публиковаться через RemoteApp.

 	**Важно!** Рекомендует установить роль RDSH перед началом установки приложений, чтобы обнаружить все проблемы с совместимостью приложений до передачи образа в RemoteApp.

8. Выполните любые дополнительные настройки Windows, необходимые для приложений.
9.	Выключите шифрующую файловую систему (EFS). Выполните следующую команду в окне команд с повышенными привилегиями:

		Fsutil behavior set disableencryption 1

	Вместо этого можно задать или добавить следующее значение DWORD в реестре: 

		HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1
9.	Если сборка образа выполняется внутри виртуальной машины Azure, переименуйте файл **\%windir%\Panther\Unattend.xml**, так как он будет блокировать скрипт отправки, который используется позже во время работы. Переименуйте этот файл в Unattend.old, чтобы его можно было найти в том случае, если потребуется вернуться к предыдущему развертыванию.
10.	Обработайте образ командой SYSPREP. В командной строке с повышенными привилегиями выполните следующую команду: 

	**C:\Windows\System32\sysprep\sysprep.exe /generalize /oobe /shutdown**
	
	**Примечание.** не используйте переключатель **/mode:vm** команды SYSPREP, несмотря на то что это виртуальная машина. 


## Дальнейшие действия ##
Созданный пользовательский образ шаблона необходимо добавить в развертывание RemoteApp. Чтобы создать развертывание, воспользуйтесь информацией в следующих разделах:


- [Как создать гибридное развертывание RemoteApp](http://azure.microsoft.com/ru-ru/documentation/articles/remoteapp-create-hybrid-deployment/) 
- [Создание облачного развертывания RemoteApp](http://azure.microsoft.com/ru-ru/documentation/articles/remoteapp-create-cloud-deployment/)

