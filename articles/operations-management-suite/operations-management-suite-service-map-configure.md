---
title: "Настройка схемы услуги в Operations Management Suite (OMS) | Документация Майкрософт"
description: "Схема услуги — это решение Operations Management Suite (OMS), которое автоматически обнаруживает компоненты приложений в системах Windows и Linux и сопоставляет взаимодействие между службами.  В этой статье содержатся подробные сведения о развертывании схемы услуги в вашей среде и приведены разнообразные сценарии ее использования."
services: operations-management-suite
documentationcenter: 
author: daveirwin1
manager: jwhit
editor: tysonn
ms.assetid: d3d66b45-9874-4aad-9c00-124734944b2e
ms.service: operations-management-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/18/2016
ms.author: daseidma;bwren;dairwin
translationtype: Human Translation
ms.sourcegitcommit: bb1ca3189e6c39b46eaa5151bf0c74dbf4a35228
ms.openlocfilehash: 8c9de9aa50cbc26252515d46d0d8d3a603c4e857
ms.lasthandoff: 03/18/2017


---
# <a name="configuring-service-map-solution-in-operations-management-suite-oms"></a>Настройка решения схемы услуги в Operations Management Suite (OMS)
Служба схемы услуги автоматически обнаруживает компоненты приложений в системах Windows и Linux и сопоставляет взаимодействие между службами. Это решение позволяет рассматривать серверы как взаимосвязанные системы, предоставляющие важные службы.  Схема услуги отображает сведения о подключениях между серверами, процессами и портами в любой подключенной по протоколу TCP архитектуре без дополнительной настройки. Пользователям требуется только установить агент.

В этой статье подробно описывается настройка схемы услуги и подключение агентов.  Дополнительные сведения об использовании схемы услуги см. в статье [Использование решения схемы услуги в Operations Management Suite (OMS)](operations-management-suite-service-map.md).


## <a name="connected-sources"></a>Подключенные источники
Схема услуги получает данные от агента зависимостей Майкрософт.  Агент зависимостей является зависимым от агента OMS ввиду подключений к OMS.  Это означает, что сначала на сервере нужно установить и настроить агент OMS, после чего можно будет установить агент зависимостей.  В следующей таблице описаны подключенные источники, которые поддерживаются решением схемы услуги.

| Подключенный источник | Поддерживаются | Описание |
|:--|:--|:--|
| Агенты Windows | Да | Служба схемы услуги анализирует и собирает данные с компьютеров с агентами Windows.  <br><br>Помимо [агента OMS](../log-analytics/log-analytics-windows-agents.md) для агентов Windows необходим агент зависимостей Майкрософт.  Полный список версий операционных систем см. в разделе [Поддерживаемые операционные системы](#supported-operating-systems). |
| Агенты Linux | Да | Служба схемы услуги анализирует и собирает данные с компьютеров с агентами Linux.  <br><br>Помимо [агента OMS](../log-analytics/log-analytics-linux-agents.md) для агентов Linux необходим агент зависимостей Майкрософт.  Полный список версий операционных систем см. в разделе [Поддерживаемые операционные системы](#supported-operating-systems). |
| Группы управления SCOM | Да | Служба схемы услуги анализирует и собирает данные из агентов Windows и Linux в подключенной [группе управления System Center Operations Manager (SCOM)](../log-analytics/log-analytics-om-agents.md). <br><br>Прямое подключение из компьютера агента SCOM к OMS не требуется. Данные пересылаются напрямую из группы управления в репозиторий OMS.|
| Учетная запись хранения Azure. | Нет | Служба схемы услуги собирает данные с компьютеров с агентом, поэтому данные из службы хранилища Azure не собираются. |

Схема услуги поддерживает только 64-разрядные платформы.

В ОС Windows SCOM и OMS используют Microsoft Monitoring Agent (MMA) для сбора и отправки данных мониторинга.  (Этот агент называется агентом SCOM, агентом OMS, MMA или Direct Agent в зависимости от контекста.)  SCOM и OMS предоставляют различные готовые к использованию версии MMA, и в каждой из этих версий предусмотрена возможность отправлять отчеты в SCOM, OMS или в оба решения.  В ОС Linux агент OMS для Linux собирает и отправляет данные мониторинга в OMS.  Схему услуги можно использовать на серверах с агентами Direct Agent OMS или на серверах, подключенных к OMS через группы управления SCOM.  В этой документации мы будем называть все эти агенты — как в Linux, так и в Windows, подключенные к SCOM MG или непосредственно к OMS — "агентами OMS", если имя конкретного развернутого агента не понадобится в контексте.

Агент схемы услуги самостоятельно не передает данные и не требует внесения изменений в брандмауэры или порты.  Данные схемы услуги всегда передаются агентом OMS в OMS, напрямую или через шлюз OMS.

![Агенты схемы услуги](media/oms-service-map/agents.png)

Если вы являетесь пользователем SCOM с группой управления, подключенной к OMS:

- если у ваших агентов SCOM есть доступ к OMS через Интернет, никаких дополнительных настроек не требуется;  
- если у агентов SCOM нет доступа к OMS через Интернет, необходимо настроить шлюз OMS для работы со SCOM.
  
При использовании OMS Direct Agent необходимо настроить агент OMS для подключения к OMS или шлюзу OMS.  Шлюз OMS можно скачать, перейдя по ссылке [https://www.microsoft.com/download/details.aspx?id=52666](https://www.microsoft.com/download/details.aspx?id=52666).


### <a name="avoiding-duplicate-data"></a>Предотвращение дублирования данных

Если вы являетесь пользователем SCOM, не следует настраивать агенты SCOM для непосредственного обмена данными с OMS, иначе данные будут отображаться дважды.  В схеме услуги это приведет к тому, что компьютеры будут дважды показаны в списке компьютеров.

Конфигурацию OMS следует применять только в одном из следующих расположений:

- панель Operations Management Suite консоли SCOM для управляемых компьютеров;
- конфигурация оперативной аналитики Azure в свойствах MMA.

Использование обоих вариантов конфигурации с *одной и той же* рабочей областью в каждой из них приведет к дублированию данных. Использование обеих конфигураций с *разными* рабочими областями может привести к конфликту конфигураций (в одной из них решение схемы услуги включено, а в другой — отключено), что повлечет за собой неполную передачу потоков данных в схему услуги.  

Даже если сама виртуальная машина не указана в конфигурации OMS консоли SCOM и группа экземпляров, например "Группа экземпляров Windows Server", активна, это может привести к тому, что виртуальная машина получит конфигурацию OMS через SCOM.



## <a name="management-packs"></a>Пакеты управления
Если схема услуги активирована в рабочей области OMS, то всем агентам Microsoft Monitoring Agent в этой рабочей области отправляется пакет управления размером 300 КБ.  Если агенты SCOM используются в [подключенной группе управления](../log-analytics/log-analytics-om-agents.md), то пакет управления схемы услуги будет развернут из SCOM.  Если агенты подключены напрямую, пакет управления будет доставлен с помощью OMS.

Пакет управления называется Microsoft.IntelligencePacks.ApplicationDependencyMonitor*.  Он записывается в папку*%Programfiles%\Microsoft Monitoring Agent\Agent\Health Service State\Management Packs\*.  Источник данных, используемый пакетом управления, — *%Program files%\Microsoft Monitoring Agent\Agent\Health Service State\Resources\<AutoGeneratedID>\Microsoft.EnterpriseManagement.Advisor.ApplicationDependencyMonitorDataSource.dll*.



## <a name="configuration"></a>Конфигурация
В дополнение к установке агента на компьютерах Windows и Linux и подключению его к OMS необходимо скачать установщик агента зависимостей из решения схемы услуги, а затем установить его с правами привилегированного пользователя или администратора на каждом управляемом сервере.  После установки агента схемы услуги на сервере, который отправляет отчеты в OMS, карты зависимостей схемы услуги появятся в течение 10 минут.


### <a name="migrating-from-bluestripe-factfinder"></a>Миграция из BlueStripe FactFinder
Схема услуги будет доставлять технологию BlueStripe в OMS поэтапно. FactFinder по-прежнему поддерживается для имеющихся клиентов, но его больше нельзя приобрести отдельно.  Эта предварительная версия агента зависимостей может обмениваться данными только с OMS.  Если вы являетесь текущим пользователем FactFinder, определите набор тестовых серверов для схемы услуги, управление которыми не осуществляется с помощью FactFinder. 

### <a name="download-the-dependency-agent"></a>Скачивание агента зависимостей
Кроме агента MMA и OMS для Linux, которые обеспечивают подключение между компьютером и OMS, на всех компьютерах, которые анализирует служба схемы услуги, необходимо установить агент зависимостей.  В ОС Linux сначала необходимо установить агент OMS для Linux, а затем агент зависимостей. 

![Элемент "Схема услуги"](media/oms-service-map/additional_configuration.png)

Чтобы скачать агент зависимостей, на плитке **Схема услуги** щелкните **Настроить решение**, чтобы открыть колонку **Агент зависимостей**.  В колонке "Агент зависимости" содержатся ссылки на агенты Windows и Linux. Сведения об установке агента в различных системах см. в следующих разделах.

### <a name="install-the-dependency-agent"></a>Установка агента зависимостей

#### <a name="microsoft-windows"></a>Microsoft Windows
Для установки или удаления агента требуются права администратора.

Агент зависимостей устанавливается на компьютерах Windows с помощью файла InstallDependencyAgent-Windows.exe. Если запустить этот исполняемый файл без параметров, запустится мастер с указаниями для установки в интерактивном режиме.  

Выполните приведение шаги, чтобы установить агент зависимостей на каждом компьютере Windows.

1.    Убедитесь, что агент OMS установлен с помощью указаний, приведенных в статье о непосредственном подключении компьютеров к OMS.
2.    Скачайте агент Windows и запустите его с помощью следующей команды. <br>*InstallDependencyAgent-Windows.exe*
3.    Следуйте инструкциям мастера для установки агента.
4.    Если агент зависимостей не запускается, просмотрите подробные сведения об ошибке в записях журналов. В агентах Windows каталогом журнала является *C:\Program Files\Microsoft Dependency Agent\logs*. 

Администратор может удалить агент зависимостей для Windows через панель управления.


#### <a name="linux"></a>Linux
Для установки или настройки агента требуется доступ с правами привилегированного пользователя.

Агент зависимостей устанавливается на компьютерах Linux с помощью файла InstallDependencyAgent-Linux64.bin. Это сценарий оболочки с самоизвлекающимся двоичным файлом. Вы можете запустить этот файл с помощью sh или добавить разрешения на выполнение в сам файл.
 
Выполните приведение шаги, чтобы установить агент зависимостей на каждом компьютере Linux.

1.    Убедитесь, что агент OMS установлен с помощью укаазний, приведенных в статье "[Подключение компьютеров Linux к Log Analytics".  ](https://technet.microsoft.com/library/mt622052.aspx)Его нужно установить перед агентом зависимостей Linux.
2.    Установите агент зависимостей Linux с правами привилегированного пользователя, используя следующую команду.<br>*sh InstallDependencyAgent-Linux64.bin*.
3.    Если агент зависимостей не запускается, просмотрите подробные сведения об ошибке в записях журналов. В агентах Linux каталог журнала находится в расположении */var/opt/microsoft/dependency-agent/log*.

### <a name="uninstalling-the-dependency-agent-on-linux"></a>Удаление агента зависимостей в Linux
Чтобы полностью удалить агент зависимостей в Linux, необходимо удалить сам агент и соединитель, который автоматически устанавливается с агентом.  Удалить и то, и другое одновременно можно с помощью следующей команды.

    rpm -e dependency-agent dependency-agent-connector


### <a name="installing-from-a-command-line"></a>Установка из командной строки
В предыдущих разделах приводятся рекомендации по установке агента монитора зависимости с использованием параметров по умолчанию.  В следующих разделах приведены рекомендации по установке агента из командной строки с использованием настраиваемых параметров.

#### <a name="windows"></a>Windows
Используйте параметры из следующей таблицы для установки из командной строки. Чтобы просмотреть список параметров установки, запустите установщик с помощью параметра /? следующим образом.

    InstallDependencyAgent-Windows.exe /?

| Параметр | Description (Описание) |
|:--|:--|
| /S | Выполняет автоматическую установку без вывода сообщений для пользователя. |

Файлы для агента зависимостей Windows размещаются в папке *C:\Program Files\Microsoft Dependency Agent* по умолчанию.


#### <a name="linux"></a>Linux
Используйте параметры из следующей таблицы для установки. Чтобы просмотреть список параметров установки, запустите программу установки с помощью параметра -help следующим образом.

    InstallDependencyAgent-Linux64.bin -help

| Параметр | Описание |
|:--|:--|
| -s | Выполняет автоматическую установку без вывода сообщений для пользователя. |
| --check | Проверяет разрешения и операционную систему, но не устанавливает агент. |

Файлы для агента зависимостей размещаются в следующих каталогах.

| Файлы | Расположение |
|:--|:--|
| Основные файлы | /opt/microsoft/dependency-agent |
| Файлы журналов | /var/opt/microsoft/dependency-agent/log |
| Файлы конфигурации | /etc/opt/microsoft/dependency-agent/config |
| Исполняемые файлы службы | /opt/microsoft/dependency-agent/bin/microsoft-dependency-agent<br>/opt/microsoft/dependency-agent/bin/microsoft-dependency-agent-manager |
| Двоичные файлы хранилища | /var/opt/microsoft/dependency-agent/storage |



## <a name="troubleshooting"></a>Устранение неполадок
Если при установке или запуске схемы услуги возникли проблемы, в этом разделе вы найдете сведения, которые могут помочь вам приступить к работе.  Если по-прежнему не удается устранить проблему, обратитесь в службу поддержки Майкрософт.

### <a name="dependency-agent-installation-issues"></a>Проблемы установки агента зависимостей
#### <a name="installer-asks-for-a-reboot"></a>Установщик запрашивает перезагрузку
При установке или удалении агент зависимостей *обычно* не требует перезагрузки.  Однако в некоторых редких случаях для продолжения установки Windows Server потребуется перезагрузить.  Это происходит, когда зависимость (как правило, распространяемые компоненты Microsoft VC ++) требует перезагрузки из-за заблокированного файла.

#### <a name="message-unable-to-install-dependency-agent-visual-studio-runtime-libraries-failed-to-install-code--codenumber"></a>Сообщение "Не удалось установить агент зависимостей: сбой установки библиотек среды выполнения Visual Studio (код = [номер_кода])".

Агент Microsoft зависимостей создан на основе библиотек среды выполнения Microsoft Visual Studio. При попытке установить библиотеки обнаружена проблема. Установщики библиотек среды выполнения создают журналы в папке %LOCALAPPDATA%\temp. Файл будет иметь вид dd_vcredist_arch_yyyymmddhhmmss.log, где вместо arch будет указано x86 или amd64, а вместо yyyymmddhhmmss — дата и время создания журнала (в 24-часовом формате). В журнале содержатся подробные сведения о проблеме, из-за которой блокируется установка.

Сначала лучше всего установить [последнюю версию библиотек среды выполнения](https://support.microsoft.com/help/2977003/the-latest-supported-visual-c-downloads).

Ниже приведены некоторые номера кодов и рекомендации по устранению проблем.

| Код | Описание | Способы устранения: |
|:--|:--|:--|
| 0x17 | Установщику библиотек требуется обновление Windows, которое не было установлено. | Проверьте в последнем журнале установщика библиотеки (см. выше).<br><br>Если после ссылки на Windows8.1-KB2999226-x64.msu следует строка "Ошибка 0x80240017: не удалось выполнить пакет MSU", см. статью базы знаний по адресу https://support.microsoft.com/kb/2919355.<br><br>Запустите установщик агента зависимостей Microsoft. |

### <a name="post-installation-issues"></a>Проблемы после установки
#### <a name="server-doesnt-show-in-service-map"></a>Сервер не отображается на схеме услуги
Если агент зависимостей успешно установлен, но в решении "Схема услуги" не отображается сервер, ответьте на следующие вопросы:
1. Успешно ли установлен агент зависимостей?  Для этого проверьте, установлена и запущена ли служба.<br><br>
**Windows**: найдите службу с именем "Агент зависимостей Microsoft".<br>
**Linux**: найдите выполняющийся процесс microsoft-dependency-agent.

2. Вы используете [OMS или Log Analytics ценовой категории "Бесплатный"](https://docs.microsoft.com/azure/log-analytics/log-analytics-add-solutions#offers-and-pricing-tiers)?  План "Бесплатный" предусматривает использование пяти уникальных серверов решения "Схема услуги".  Все последующие серверы не будут отображаться в решении "Схема услуги", даже если предыдущие пять больше не отправляют данные.

3. Отправляет ли сервер данные журналов и данные о производительности в OMS?  Перейдите к поиску по журналам и выполните следующий запрос для своего компьютера: 

        * Computer="<your computer name here>" | measure count() by Type
        
Вы получили множество событий в результатах?  Это последние данные?  В этом случае агент OMS работает правильно и обменивается данными со службой OMS. В противном случае проверьте агент OMS на сервере. Дополнительные сведения см. в статьях об [устранении неполадок агента OMS в Windows](https://support.microsoft.com/help/3126513/how-to-troubleshoot-operations-management-suite-onboarding-issues) и  [устранении неполадок агента OMS в Linux](https://github.com/Microsoft/OMS-Agent-for-Linux/blob/master/docs/Troubleshooting.md).

#### <a name="server-shows-in-service-map-but-has-no-processes"></a>Сервер отображается в решении "Схема услуги", но для него нет процессов
Если сервер отображается в решении "Схема услуги", но для него нет процессов или данных о подключении, это означает, что агент зависимостей установлен и запущен, но не удалось загрузить драйвер ядра.  Чтобы узнать, почему это произошло, проверьте файл wrapper.log (Windows) или service.log (Linux).  Причина будет указана в последних строках файла (например, ядро не поддерживается, что может произойти в Linux при его обновлении).

Windows: C:\Program Files\Агент зависимостей Microsoft\logs\wrapper.log

Linux: /var/opt/microsoft/dependency-agent/log/service.log

## <a name="data-collection"></a>Сбор данных
Каждый агент передает примерно 25 МБ данных в день в зависимости от сложности зависимостей системы.  Агенты отправляют данные зависимостей схемы услуги каждые 15 секунд.  

Агент зависимостей обычно потребляет 0,1 % системной памяти и 0,1 % ресурсов ЦП системы.


## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы
В следующих разделах представлены поддерживаемые операционные системы для агента зависимостей.   32-разрядные версии операционных систем не поддерживаются.

### <a name="windows-server"></a>Windows Server
- Windows Server 2016
- Windows Server 2012 R2
- Windows Server 2012
- Windows Server 2008 R2 с пакетом обновления 1

### <a name="windows-desktop"></a>Классические приложения
- Windows 10
- Windows 8.1
- Windows 8
- Windows 7

### <a name="red-hat-enterprise-linux-centos-linux-and-oracle-linux-with-rhel-kernel"></a>Red Hat Enterprise Linux, CentOS Linux и Oracle Linux (с ядром RHEL)
- Поддерживаются только версии ядра по умолчанию и SMP для Linux.
- Нестандартные версии ядра, такие как PAE и Xen, не поддерживаются ни в одном дистрибутиве Linux. Например, система со строкой версии "2.6.16.21-0.8-xen" не поддерживается.
- Пользовательские ядра, включая повторные компиляции стандартных ядер, не поддерживаются.
- Ядро CentOS Plus не поддерживается.
- Oracle Unbreakable Kernel (UEK) рассматривается в разделе ниже.


#### <a name="red-hat-linux-7"></a>Red Hat Linux 7
| Версия ОС | Версия ядра |
|:--|:--|
| 7.0 | 3.10.0-123 |
| 7.1. | 3.10.0-229 |
| 7,2 | 3.10.0-327 |
| 7.3 | 3.10.0–514 |

#### <a name="red-hat-linux-6"></a>Red Hat Linux 6
| Версия ОС | Версия ядра |
|:--|:--|
| 6,0 | 2.6.32-71 |
| 6.1 | 2.6.32-131 |
| 6.2 | 2.6.32-220 |
| 6.3 | 2.6.32-279 |
| 6.4 | 2.6.32-358 |
| 6,5 | 2.6.32-431 |
| 6.6 | 2.6.32-504 |
| 6.7 | 2.6.32-573 |
| 6,8 | 2.6.32-642 |

#### <a name="red-hat-linux-5"></a>Red Hat Linux 5
| Версия ОС | Версия ядра |
|:--|:--|
| 5.8 | 2.6.18-308 |
| 5.9 | 2.6.18-348 |
| 5.10 | 2.6.18-371 |
| 5.11 | 2.6.18-398<br>2.6.18-400<br>2.6.18-402<br>2.6.18-404<br>2.6.18-406<br>2.6.18-407<br>2.6.18-408<br>2.6.18-409<br>2.6.18-410<br>2.6.18-411<br>2.6.18-412<br>2.6.18-416<br>2.6.18–417<br>2.6.18-419 |

#### <a name="oracle-enterprise-linux-w-unbreakable-kernel-uek"></a>Oracle Enterprise Linux с Unbreakable Kernel (UEK)

#### <a name="oracle-linux-6"></a>Oracle Linux 6
| Версия ОС | Версия ядра
|:--|:--|
| 6.2 | Oracle 2.6.32-300 (UEK R1) |
| 6.3 | Oracle 2.6.39-200 (UEK R2) |
| 6.4 | Oracle 2.6.39-400 (UEK R2) |
| 6,5 | Oracle 2.6.39-400 (UEK R2 i386) |
| 6.6 | Oracle 2.6.39-400 (UEK R2 i386) |

#### <a name="oracle-linux-5"></a>Oracle Linux 5

| Версия ОС | Версия ядра
|:--|:--|
| 5.8 | Oracle 2.6.32-300 (UEK R1) |
| 5.9 | Oracle 2.6.39-300 (UEK R2) |
| 5.10 | Oracle 2.6.39-400 (UEK R2) |
| 5.11 | Oracle 2.6.39-400 (UEK R2) |

#### <a name="suse-linux-enterprise-server"></a>SUSE Linux Enterprise Server

#### <a name="suse-linux-11"></a>SUSE Linux 11
| Версия ОС | Версия ядра
|:--|:--|
| 11 | 2.6.27 |
| 11 SP1 | 2.6.32 |
| 11 SP2 | 3.0.13 |
| 11 SP3 | 3.0.76 |
| 11 SP4 | 3.0.101 |

#### <a name="suse-linux-10"></a>SUSE Linux 10
| Версия ОС | Версия ядра
|:--|:--|
| 10 SP4 | 2.6.16.60 |

## <a name="diagnostic-and-usage-data"></a>Данные диагностики и использования
Корпорация Майкрософт автоматически собирает данные об использовании и производительности с помощью службы схемы услуги. Эти данные используются, чтобы улучшить качество, повысить безопасность и целостность службы схемы услуги. Они включают в себя сведения о конфигурации программного обеспечения, такие как версия операционной системы, а также IP-адрес, DNS-имя и имя рабочей станции, чтобы предоставить возможности для точного и эффективного устранения неполадок. Корпорация Майкрософт не собирает сведения об именах, адресах и другую контактную информацию.

Дополнительные сведения о сборе и использовании данных см. в [заявлении о конфиденциальности служб Online Services корпорации Майкрософт](https://go.microsoft.com/fwlink/?LinkId=512132).



## <a name="next-steps"></a>Дальнейшие действия
- Узнайте, как [использовать схему услуги](operations-management-suite-service-map.md) после ее развертывания и настройки.

