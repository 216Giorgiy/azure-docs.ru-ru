<properties urlDisplayName="" pageTitle="" metaKeywords="" description="" metaCanonical="" services="" documentationCenter="" title="Developing Single Tenant Applications with Azure Active Directory" authors="terrylan" solutions="" manager="terrylan" editor="" />

<tags ms.service="active-directory" ms.workload="identity" ms.tgt_pltfrm="na" ms.devlang="dotnet" ms.topic="article" ms.date="01/01/1900" ms.author="terrylan" />

# Разработка однопользовательских приложений с помощью Azure Active Directory

## <a name="introduction"></a> Введение

В этом учебнике показано, как использовать Azure Active Directory для проверки подлинности пользователей каталога и чтения данных из каталога. Вы научитесь:

-   Подготовка веб-приложения в клиенте заказчика
-   Защита приложения с помощью WS-Federation
-   Доступ к каталогу с помощью Graph API

### Предварительные требования

Для данного пошагового руководства необходимы следующие компоненты среды разработки:

-   Visual Studio 2010 с пакетом обновления 1 (SP1)
-   Microsoft .NET Framework 4.0
-   [ASP.NET MVC 3][ASP.NET MVC 3]
-   [Среда выполнения Windows Identity Foundation 1.0][Среда выполнения Windows Identity Foundation 1.0]
-   [Пакет SDK для Windows Identity Foundation 3.5][Пакет SDK для Windows Identity Foundation 3.5]
-   [Службы данных WCF для OData V3][Службы данных WCF для OData V3]
-   Службы IIS 7.5 с поддержкой SSL
-   Windows PowerShell
-   [Командлеты PowerShell для Office 365][Командлеты PowerShell для Office 365]

### Оглавление

-   [Введение][Введение]
-   [Шаг 1: Создание приложения ASP.NET MVC][Шаг 1: Создание приложения ASP.NET MVC]
-   [Шаг 2: Подготовка приложения в клиенте каталога компании][Шаг 2: Подготовка приложения в клиенте каталога компании]
-   [Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников][Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников]
-   [Шаг 4: Чтение данных каталога с помощью Graph API][Шаг 4: Чтение данных каталога с помощью Graph API]
-   [Сводка][Сводка]

## <a name="createapp"></a>Шаг 1: Создание приложения ASP.NET MVC

На этом этапе рассказывается, как создать простое приложение ASP.NET MVC 3, которое будет представлять защищенный ресурс. Доступ к этому ресурсу будет предоставляться через федеративную проверку подлинности под управлением службы STS компании; этот вопрос будет рассмотрен подробно далее в этом же модуле.

1.  Откройте Visual Studio от имени администратора.
2.  В меню **Файл** выберите **Новый проект**.
3.  В расположенном слева меню шаблонов выберите **Интернет**, затем щелкните **Веб-приложение ASP.NET MVC 3**. Присвойте проекту имя *OrgIdFederationSample*.
4.  В диалоговом окне **Новый проект ASP.NET MVC 3** выберите шаблон **Пусто**, затем нажмите кнопку **ОК**.
5.  После создания нового проекта в Visual Studio щелкните правой кнопкой мыши папку **Контроллеры** в **обозревателе решений**, выберите **Добавить**, затем щелкните **Контроллер**.
6.  В диалоговом окне **Добавление контроллера** присвойте новому контроллеру имя *HomeController.cs*, затем щелкните **Добавить**.
7.  Файл **HomeController.cs** будет создан и открыт. В файле кода щелкните правой кнопкой мыши метод ***Index()*** и выберите **Добавить представление...**.
8.  В диалоговом окне **Добавление представления** нажмите кнопку **ОК**. Создается файл **Index.cshtml** в новой папке с именем **Home**.
9.  Щелкните правой кнопкой мыши по проекту **OrgIdFederationSample** в **обозревателе решений** и выберите **Свойства**.
10. В окне свойств в расположенном слева меню щелкните **Интернет**, затем выберите **Использовать локальный веб-сервер IIS**. Если появится диалоговое окно с предложением создать виртуальный каталог для проекта, нажмите кнопку **Да**.
11. Создайте и запустите приложение. Появится страница Index вашего контроллера Home.

## <a name="provisionapp"></a>Шаг 2: Подготовка приложения в клиенте каталога компании

На этом шаге рассказывается, как администратор заказчика Azure Active Directory выполняет подготовку приложения MVC в клиенте заказчика и настраивает единый вход. После выполнения этого шага сотрудники компании могут проходить проверку подлинности в веб-приложении, используя свои учетные записи Office 365.

Процесс подготовки начинается с создания нового субъекта-службы для приложения. Azure Active Directory использует субъекты-службы для регистрации и проверки подлинности приложений в каталоге.

1.  Загрузите и установите командлеты PowerShell для Office 365, если это еще не сделано.
2.  В меню **Пуск** запустите **модуль Microsoft Online Services для консоли Windows PowerShell**. Эта консоль предоставляет среду командной строки для настройки атрибутов клиента Office 365, например для создания и изменения субъектов-служб.
3.  Чтобы импортировать необходимый модуль **MSOnlineExtended**, введите следующую команду и нажмите клавишу ВВОД:

        Import-Module MSOnlineExtended -Force

4.  Чтобы подключиться к каталогу Office 365, необходимо предоставить учетные данные администратора компании. Введите следующую команду и нажмите клавишу ВВОД, а затем введите свои учетные данные в командной строке:

        Connect-MsolService

5.  Теперь необходимо создать новый субъект-службу для приложения. Введите следующую команду и нажмите клавишу ВВОД:

        New-MsolServicePrincipal -ServicePrincipalNames @("OrgIdFederationSample/localhost") -DisplayName "Federation Sample Website" -Type Symmetric -Usage Verify -StartDate "12/01/2012" -EndDate "12/01/2013" 

    На этом шаге выводится информация следующего вида:

        The following symmetric key was created as one was not supplied qY+Drf20Zz+A4t2w e3PebCopoCugO76My+JMVsqNBFc=
        DisplayName           : Federation Sample Website
        ServicePrincipalNames : {OrgIdFederationSample/localhost}
        ObjectId              : 59cab09a-3f5d-4e86-999c-2e69f682d90d
        AppPrincipalId        : 7829c758-2bef-43df-a685-717089474505
        TrustedForDelegation  : False
        AccountEnabled        : True
        KeyType               : Symmetric
        KeyId                 : f1735cbe-aa46-421b-8a1c-03b8f9bb3565
        StartDate             : 12/01/2012 08:00:00 a.m.
        EndDate               : 12/01/2013 08:00:00 a.m.
        Usage                 : Verify 

    <div class="dev-callout">

    **Примечание.**
    Следует сохранить эти выходные данные, в частности сгенерированный симметричный ключ. Этот ключ отображается только во время создания субъекта-службы, в дальнейшем вы его получить не сможете. Другие значения необходимы, чтобы с помощью Graph API считывать данные из каталога и записывать данные в каталог.

    </div>

6.  На последнем шаге задается URL-адрес ответа для вашего приложения. На URL-адрес ответа отправляются ответы после попыток проверки подлинности. Введите следующие команды и нажмите клавишу ВВОД:

        $replyUrl = New-MsolServicePrincipalAddresses -Address "https://localhost/OrgIdFederationSample" 

        Set-MsolServicePrincipal -AppPrincipalId "7829c758-2bef-43df-a685-717089474505" -Addresses $replyUrl 

Теперь веб-приложение в каталоге подготовлено, и сотрудники компании могут его использовать для единого входа.

## <a name="protectapp"></a>Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников

На этом шаге показано, как добавить поддержку федеративного входа с помощью Windows Identity Foundation (WIF). Вы также научитесь добавлять страницу входа и настраивать отношения доверия между приложением и клиентом каталога.

1.  В Visual Studio щелкните правой кнопкой мыши по проекту **OrgIdFederationSample** и выберите **Добавить ссылку STS...**. Этот пункт контекстного меню был добавлен после установки пакета SDK для WIF.
2.  В диалоговом окне **Программа федерации** в разделе **URI приложения** необходимо указать URI в следующем формате:

        spn:<Your AppPrincipalId>@<Your Directory Domain>

    **spn** указывает, что URI является именем субъекта-службы, **Your AppPrincpalId** — значение GUID **AppPrincipalId**, сгенерированное при создании субъекта-службы, а **Your Directory Domain** — домен \*.onmicrosoft.com для клиента каталога. Для этого примера приложения полное значение URI приложения указывается следующим образом:

        spn:7829c758-2bef-43df-a685-717089474505@awesomecomputers.onmicrosoft.com

    После ввода URI приложения нажмите кнопку **Далее**.

3.  Откроется диалоговое окно с предупреждением о том, что "Приложение не размещено на безопасном https-соединении". Это вызвано тем, что программа федерации не распознает формат **spn:**, а приложение будет все равно использовать защищенное подключение https. Чтобы продолжить, щелкните **Да**.

4.  На следующей странице служебной программы федерации выберите **Использовать существующую STS**, затем в разделе **Расположение документа метаданных STS WS-Federation** введите URL-адрес документа метаданных WS-Federation. Этот URL-адрес указывается в следующем формате:

        https://accounts.accesscontrol.windows.net/<Domain Name or Tenant ID>/FederationMetadata/2007-06/FederationMetadata.xml 

    Для данного приложения расположение метаданных WS-Federation указывается следующим образом:

        https://accounts.accesscontrol.windows.net/fabrikam.onmicrosoft.com/FederationMetadata/2007-06/FederationMetadata.xml 

    После ввода расположения метаданных нажмите кнопку **Далее**.

5.  На следующей странице служебной программы федерации выберите **Отключить проверку цепочки сертификатов** и нажмите кнопку **Далее**.

6.  На следующей странице служебной программы федерации выберите **Без шифрования** и нажмите кнопку **Далее**.

7.  На следующей странице служебной программы федерации отображаются утверждения, предоставляемые службой STS. Просмотрите утверждения, затем нажмите кнопку **Далее**.

8.  Теперь выполните настройку служб IIS для поддержки SSL в вашей среде разработки. Чтобы открыть диспетчер служб IIS, можно ввести команду *inetmgr* в командной строке **Выполнить**.

9.  В диспетчере IIS в расположенном слева меню разверните папку **Сайты**, затем щелкните **Главная страница веб-сайта по умолчанию**. В расположенном справа меню **Действия** щелкните **Привязки...**.

10. В диалоговом окне **Привязки сайта** щелкните **Добавить**. В диалоговом окне **Добавление привязки сайта** выберите в раскрывающемся списке **Тип** вариант ***https***, затем в разделе **SSL-сертификат** выберите **Сертификат разработки IIS Express**. Нажмите кнопку **ОК**.

11. В диспетчере IIS в расположенном слева меню щелкните **Пулы приложений**, затем выберите в списке запись **ASP.NET v4.0** и щелкните **Расширенные настройки** в расположенном справа меню **Действия**.

12. В диалоговом окне **Расширенные настройки** задайте для свойства **Загрузить профиль пользователя** значение **true**. Нажмите кнопку **ОК**.

13. В Visual Studio откройте файл **Web.config** из **обозревателя решений** в корневой папке проекта.

14. В файле **Web.config** найдите раздел **wsFederation** и добавьте атрибут **reply** с тем же значением, что и у переменной **$replyUrl**, заданной при создании субъекта-службы. Например:

        <wsFederation passiveRedirectEnabled="true" issuer="https://accounts.accesscontrol.windows.net/v2/wsfederation" realm="spn: 7829c758-2bef-43df-a685-717089474505" requireHttps="false" reply="https://localhost/OrgIdFederationSample" /> 

15. Добавьте узел **httpRuntime** в разделе **system.web** и задайте для атрибута **requestValidationMode** значение **2.0**. Например:

        <system.web>
            <httpRuntime requestValidationMode="2.0" /> 
            ...

    Сохраните файл **Web.config**.

16. Теперь, когда для веб-приложения включена проверка подлинности, необходимо изменить страницу **Index**, указав утверждения пользователя, прошедшего проверку подлинности. Откройте файл **Index.cshtml**, расположенный во вложенной папке **Home** папки **Представления**.

17. Добавьте в файл **Index.cshtml** следующий фрагмент кода и сохраните его:

        <p>
            @if (User.Identity.IsAuthenticated)
            {
            <ul>
                @foreach (string claim in ((Microsoft.IdentityModel.Claims.IClaimsIdentity)this.User.Identity).Claims.Select(c => c.ClaimType + " : " + c.Value))
                {
                    <li>@claim</li>
                }
            </ul>
            }
        </p> 

18. После сохранения изменений в файле **Index.cshtml** нажмите клавишу **F5** для запуска приложения. Вы будете перенаправлены на страницу поставщика удостоверений Office 365, на которой можете выполнить вход, используя ваши учетные данные клиента каталога. Например, [john.doe@awesomecomputers.onmicrosoft.com][john.doe@awesomecomputers.onmicrosoft.com].

19. После входа с использованием учетных данных вы будете перенаправлены на страницу Index контроллера Home, на которой отображаются утверждения вашей учетной записи. Это демонстрация успешного прохождения проверки подлинности в приложении с использованием возможностей единого входа, предоставляемых службой Azure Active Directory.

## <a name="readdata"></a>Шаг 4: Чтение данных каталога с помощью Graph API

На этом этапе показано использование Graph API для подключения к клиенту Azure Active Directory и чтения данных. Чтобы начать работу с Graph API, загрузите следующее предложение ASP.NET: [Пример приложения с поддержкой записи для Graph API][Пример приложения с поддержкой записи для Graph API]. Это приложение содержит вспомогательные методы, упрощающие процесс проверки подлинности и составления запросов Graph API.

Необходимо добавить разрешения для субъекта-службы приложения, созданного на этапе 2. Для добавления этих разрешений необходимо иметь значение AppPrincipalId.

1.  Загрузите и извлеките пример приложения в необходимую папку.
2.  Перед тем как использовать пример кода, необходимо предоставить дополнительные разрешения для субъекта-службы. Эти разрешения позволят субъекту-службе считывать данные с использованием Graph API. В меню **Пуск** запустите **модуль Microsoft Online Services для консоли Windows PowerShell**.
3.  Вы добавите разрешения на чтение субъекту-службе, добавив этот субъект в роль администратора поддержки службы. Дополнительные сведения о назначении ролей субъекту-службе см. в разделе [Управление доступом к Graph API на основе ролей][Управление доступом к Graph API на основе ролей]. Введите следующую команду и нажмите клавишу ВВОД:

        Add-MsolRoleMember -RoleMemberType "ServicePrincipal" -RoleName "Service Support Administrator" -RoleMemberObjectId $appPrincipal.ObjectId 

4.  Переменная **$appPrincipal.ObjectId** является идентификатором objectId субъекта-службы, который можно получить путем ввода приведенной ниже команды и нажатия клавиши ВВОД:

        Get-MsolServicePrincipal -AppPrincipalId 7829c758-2bef-43df-a685-717089474505 

    <div class="dev-callout">

    **Примечание.**
    Приведенное выше значение \*\*AppPrincipalId было возвращено при создании субъекта-службы на этапе 2.

    </div>

5.  После добавления роли для вашего субъекта-службы запустите Visual Studio и файл **Web.config** корня примера приложения.

6.  Найдите раздел *\<configuration\>* файла **Web.config**, затем перейдите в раздел *\<appSettings\>*. Измените значения ключей *TenantDomainName*, *AppPrincipalId* и *SymmetricKey* на значения для вашего субъекта-службы. Например:

        <appSettings> 
            ...
            <add key="TenantDomainName" value="awesomecomputers.onmicrosoft.com"/> 
            ...
            <add key="AppPrincipalId" value="7829c758-2bef-43df-a685-717089474505"/>     
            ...
            <add key="SymmetricKey" value="qY+Drf20Zz+A4t2w e3PebCopoCugO76My+JMVsqNBFc=" /> 
            ...
        </appSettings>

7.  Сохраните файл **Web.config**, затем нажмите клавишу **F5**, чтобы запустить приложение.

8.  Пример приложения отобразит меню для доступа ко всем пользователям, администраторам компании и другим элементам. Щелчок одной из ссылок приведет к возврату сведений, хранящихся в клиенте через Graph API.

## <a name="summary"></a>Сводка

В этом учебнике показано, как создать и настроить приложение для одного клиента, использующее возможности единого входа Azure Active Directory. Кроме того, вы можете получить доступ к данным каталога клиента с помощью Graph API. Рекомендуется изучить пример приложения, чтобы понять, как воспользоваться преимуществами Graph API в своем приложении.

Дополнительные сведения о Graph API [см. в статьях на MSDN][см. в статьях на MSDN]. Вы сможете также создавать мультитенантные приложения для Azure Active Directory, ознакомившись со следующими учебными материалами: [Разработка многопользовательских облачных приложений с помощью Azure Active Directory][Разработка многопользовательских облачных приложений с помощью Azure Active Directory].

  [ASP.NET MVC 3]: http://www.microsoft.com/ru-ru/download/details.aspx?id=4211
  [Среда выполнения Windows Identity Foundation 1.0]: http://www.microsoft.com/ru-ru/download/details.aspx?id=17331
  [Пакет SDK для Windows Identity Foundation 3.5]: http://www.microsoft.com/ru-ru/download/details.aspx?id=4451
  [Службы данных WCF для OData V3]: http://www.microsoft.com/download/en/details.aspx?id=29306
  [Командлеты PowerShell для Office 365]: http://onlinehelp.microsoft.com/ru-ru/office365-enterprises/ff652560.aspx
  [Введение]: #introduction
  [Шаг 1: Создание приложения ASP.NET MVC]: #createapp
  [Шаг 2: Подготовка приложения в клиенте каталога компании]: #provisionapp
  [Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников]: #protectapp
  [Шаг 4: Чтение данных каталога с помощью Graph API]: #readdata
  [Сводка]: #summary
  [john.doe@awesomecomputers.onmicrosoft.com]: mailto:*john.doe@awesomecomputers.onmicrosoft.com*
  [Пример приложения с поддержкой записи для Graph API]: http://code.msdn.microsoft.com/Write-Sample-App-for-79e55502
  [Управление доступом к Graph API на основе ролей]: http://msdn.microsoft.com/ru-ru/library/hh974466.aspx
  [см. в статьях на MSDN]: http://msdn.microsoft.com/ru-ru/library/hh974476.aspx
  [Разработка многопользовательских облачных приложений с помощью Azure Active Directory]: http://g.microsoftonline.com/0AX00en/121
