<properties title="Using the Docker Virtual Machines Extension for Linux on Azure" pageTitle="Using the Docker VM Extension for Linux on Azure" description="Describes Docker and the Azure Virtual Machines extensions, and shows how to programmatically create Virtual Machines on Azure that are docker hosts from the command line using the azure-cli command interface." metaKeywords="linux, virtual machines, vm, azure, docker, linux containers,  lxc, virtualization" services="virtual-machines" solutions="dev-test" documentationCenter="virtual-machines" authors="rasquill" videoId="" scriptId="" />

<tags ms.service="virtual-machines" ms.devlang="multiple" ms.topic="article" ms.tgt_pltfrm="vm-linux" ms.workload="infrastructure-services" ms.date="08/21/2014" ms.author="ralph.squillace@microsoft.com"></tags>

# Использование расширения виртуальных машин Docker для Linux в Azure

[Docker][Docker] — один из самых популярных подходов к виртуализации, использующий [контейнеры Linux][контейнеры Linux] вместо виртуальных машин как способ изоляции данных и вычислений при использовании общих ресурсов. Можно использовать расширение Docker в [агенте Linux для Azure][агенте Linux для Azure] для создания виртуальной машины, в которой будет размещено любое количество контейнеров с приложениями Azure.

Этот раздел следует за [объявлением в блоге MS Open Tech][объявлением в блоге MS Open Tech] и описывает:

-   [Расширение Docker и контейнеры Linux][Расширение Docker и контейнеры Linux]
-   [Использование расширения виртуальных машин Docker в Azure][Использование расширения виртуальных машин Docker в Azure]
-   [Расширения виртуальных машин для Linux и Windows][Расширения виртуальных машин для Linux и Windows]
-   [Ресурсы для контейнеров и управления ими в Azure][Ресурсы для контейнеров и управления ими в Azure]

## Расширение Docker и контейнеры Linux

[Docker][Docker] — один из самых популярных подходов к виртуализации, использующий [контейнеры Linux][контейнеры Linux] вместо виртуальных машин как способ изоляции данных и вычислений при использовании общих ресурсов и обеспечивающий другие службы, которые позволяют быстро создавать или компоновать приложения и распространять их среди других контейнеров Docker.

Docker и контейнеры Linux не являются [гипервизорами][гипервизорами], такими как Windows Hyper-V и [KVM][KVM] в Linux (существует множество других примеров). Гипервизоры виртуализуют базовую операционную систему для того, чтобы полноценные операционные системы могли выполняться внутри гипервизора так, как будто они являются приложением.

Подход с использованием гипервизора обеспечивает важные преимущества в области безопасности, так как «гостевая» виртуальная машина не имеет какого-либо доступа к «основной» операционной системе; она может использовать только ресурсы гипервизора. Недостатки, однако, включают большие затраты на обработку и увеличение объема хранимой информации, а также относительно долгое время запуска для новых виртуальных машин, потому что, помимо прочего, они полностью копируют гостевые операционные системы.

#### Расширение Docker и контейнеры Linux

Докер и другие подходы с использованием *контейнеров* позволили радикально уменьшить как время запуска, так и затраты на обработку и необходимый объем хранимой информации при помощи возможностей изоляции процессов и файловой системы с использованием особенностей ядра Linux, проставляя полностью изолированным контейнерам доступ только к возможностям ядра. Изнутри контейнера файловая система и возможности ядра доступны в приложениях так, как если бы это было единственное работающее приложение.

Кроме того, Docker предоставляет несколько функций управления контейнерами, позволяющие загружать различные образы контейнеров, подготовленных сообществом, а также собирать и загружать свои ​​собственные образы с максимальной быстротой. Для получения полной информации о расширении Docker и о том, как оно функционирует, см. раздел [Что такое Docker?][Что такое Docker?]

Как и у большинства технологий, у него имеются и существенные плюсы, и некоторые недостатки. Поскольку контейнеры предоставляют общий доступ к ядру главного компьютера, то в случае, если вредоносный код сможет получить права привилегированного пользователя, он также может оказаться в состоянии получить доступ не только к компьютеру, но и к другим контейнерам. Чтобы обеспечить безопасность для системы контейнеров на более высоком уровне, [Docker рекомендует][Docker рекомендует] использовать дополнительную групповую политику или [обеспечение безопасности на основе ролей][обеспечение безопасности на основе ролей], а также, например, [SELinux][SELinux] или [AppArmor][AppArmor] и максимальное уменьшение возможностей ядра, доступных контейнерам. Кроме того, в Интернете есть много других документов, которые описывают подходы к обеспечению безопасности при использовании таких контейнеров, как Docker.

## Использование расширения виртуальных машин Docker в Azure

Чтобы использовать расширения виртуальных машин Docker в Azure, необходимо установить версию [azure-cli][azure-cli] выше, чем 0.8.6 (на момент написания статьи текущей версией является 0.8.7). Вы можете установить azure-cli как на Mac, так и на Linux.

> [WACOM.NOTE] Вы также можете установить azure-cli на Microsoft Windows. Однако, поскольку Docker зависит от ядра Linux, для использования клиента Docker для Windows необходимо установить полный дистрибутив Linux в качестве виртуальной машины внутри Hyper-V или другого гипервизора. После этого вы сможете использовать azure-cli и команды Docker, указанные в данном документе, и вообще все команды Docker. Сам Docker имеет программу установки, [Boot2Docker][Boot2Docker], которую можно также использовать для автоматизации той же самой установки.

Процесс использования Docker в Azure прост.

-   Установите средство командной строки azure-cli и его зависимости на компьютере, с которого вы хотите управлять Azure (в случае Windows это будет дистрибутив Linux, запущенный в виде виртуальной машины)
-   Используйте команды Docker в azure-cli, чтобы создать узел виртуальных машин Docker в Azure.
-   Используйте команды локального Docker для управления своим контейнерами на узле виртуальных машин Docker в Azure.

> [WACOM.NOTE] azure-cli (интерфейс командной строки) в настоящее время является единственным способом создания виртуальной машины под управлением Docker в Azure для размещения контейнеров Docker. Общий документ с процессом установки находится [здесь][здесь]; в разделах ниже описаны некоторые дополнительные предложения по установке на различных операционных системах.

### Установка azure-cli в Linux

В Linux для установки azure-cli требуется [диспетчер пакетов Node (NPM)][диспетчер пакетов Node (NPM)], который требует nodejs, поэтому воспользуйтесь своим предпочтительным диспетчером пакетов для установки nodejs (в зависимости от выбранной платформы). Если npm уже установлен, для получения пакета azure-cli введите:

    npm install -g azure-cli

и пакет azure-cli будет установлен глобальным образом. Чтобы подтвердить установку, введите `azure` в командной строке, и через некоторое время вы должны увидеть вывод azure-cli в виде ASCII-арта, в котором перечислены основные доступные вам команды. Если установка прошла без ошибок, вы можете ввести `azure help vm` и увидеть в списке команд «docker».

> [WACOM.NOTE] При использовании Ubuntu 14.04 LTS, образ которой имеет слегка видоизмененный процесс установки node, могут потребоваться дополнительные действия. В качестве одного из рабочих решений предлагается расположенная [здесь][1] в разделе **Установка с использованием PPA** инструкция, описывающая порядок непосредственной установки самой последней версии nodejs, которая работает для дистрибутива Ubuntu 14.04 LTS.

Кроме того, как и большинство компонентов Linux, можно создать копию исходного кода, скомпилировать его и установить пакет локально. Инструкции для этих действий расположены по адресу [][azure-cli]<https://github.com/Azure/azure-sdk-tools-xplat></a>.

### Установка azure-cli на Mac

На Mac самым простым способом установки azure-cli также является использование npm с той же самой командой: `npm install -g azure-cli`. Однако можно также воспользоваться [пакетом установки для Mac][пакетом установки для Mac]. Так же, как и в Linux и Windows, можно ввести `azure` в командной строке и убедиться в правильности установки azure-cli.

### Подключение azure-cli к учетной записи Azure

Перед тем как вы сможете использовать azure-cli, необходимо привязать учетные данные записи Azure к azure-cli для вашей платформы. В разделе [Подключение к подписке Azure][Подключение к подписке Azure] указано, как загрузить и импортировать файл **.publishsettings** или связать средство командной строки azure-cli с организационным идентификатором. Этапы для обоих методов проверки подлинности и авторизации описаны в вышеупомянутом документе.

> [WACOM.NOTE] Есть некоторые различия в действиях при использовании первого или второго способа проверки подлинности, так что не забудьте прочитать вышеуказанный документ, чтобы понять различие в функциональности.

### Установка Docker и использование расширения виртуальных машин Docker для Azure

На данном этапе у вас имеется компьютер (или виртуальная машина на этом компьютере) с установленным средством azure-cli и подключенный к учетной записи Azure. Следуйте [инструкции по установке Docker][инструкции по установке Docker] для того, чтобы установить Docker локально на вашем компьютере. Для большинства операционных систем и дистрибутивов установка заключается в вводе `apt-get install docker.io`. Убедитесь, что версия Docker не ниже 1.0.

Вы установили средства командной строки azure-cli на компьютер, подключили их к учетной записи Azure и установили Docker. Чтобы создать новую основную виртуальную машину Docker в Azure, потребуется образ виртуальной машины Linux с установленным [агентом виртуальных машин Linux для Azure][агенте Linux для Azure]. На данный момент единственными образами, на которых он уже установлен, являются:

-   образ Ubuntu из коллекции образов или

-   пользовательский образ Linux, созданный вами, с установленным и настроенным агентом виртуальных машин Linux для Azure; дополнительные сведения о создании собственной виртуальной машины с агентом Azure см. в разделе [Агент виртуальных машин Linux для Azure][агенте Linux для Azure].

Найдите в командной строке azure-cli самую последнюю версию образа Ubuntu в коллекции виртуальных машин, набрав команду

`azure vm image list | grep Ubuntu-14_04`

и скопируйте имя одного из последних образов в списке. В командной строке выполните следующую команду:

    azure vm docker create -e 22 -l "West US" <vm-cloudservice name> "b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_10-amd64-server-20140729-alpha2-ru-ru-30GB" <username> <password>

где:

-   *<vm-cloudservice name>* — имя виртуальной машины, которая станет главным компьютером для контейнеров Docker в Azure

-   *<username>* — имя привилегированного пользователя по умолчанию для виртуальной машины

-   *<password>*— пароль для *имени пользователя* учетной записи, который отвечает требованиям к сложности, предъявляемым для Azure

> [WACOM.NOTE] В настоящий момент пароль должен иметь как минимум 8 символов, содержать как минимум один символ в нижнем и в верхнем регистре, цифру и специальный символ, такой как [!@\#$%^&+=][!@\#$%^&+=]. Точка в конце предыдущего выражения НЕ является специальным символом.

Если команда прошла успешно, вы увидите нечто вроде следующего, в зависимости от конкретных аргументов и параметров, используемых вами:

![][0]

> [WACOM.NOTE] Как упоминалось ранее, создание виртуальной машины может занять несколько минут, но после его подготовки будет запущен демон Docker, и вы можете подключиться к компьютеру с контейнерами Docker.

Для проверки виртуальной машины Docker, только что созданной в Azure, введите

`docker --tls -H tcp://<vm-name-you-used>.cloudapp.net:4243 info`

где *<vm-name-you-used>* — имя виртуальной машины, которое было использовано при вызове `azure vm docker create`. Опять же, в зависимости от конкретных аргументов и опций, которые были указаны, вы должны увидеть нечто вроде следующего ответа, в котором указывается, что основная виртуальная машина запущена и работает в Azure и готова к получению ваших команд.

![][2]

## Примечание о проверке подлинности основной виртуальной машины Docker

Кроме создания виртуальной машины Docker, команда `azure vm docker create` также автоматически создает необходимые сертификаты, чтобы клиентский компьютер Docker мог подключиться к основной виртуальной машине Azure с помощью HTTPS. Сертификаты хранятся как на клиенте, так и на узлах, в зависимости от обстоятельств. При последующих запусках существующие сертификаты используются повторно и совместно с новым узлом.

По умолчанию сертификаты помещаются в `~/.docker`, и Docker настраивается для запуска на порту **4243**. Если вы хотите использовать другой порт или каталог, то вы можете использовать один из следующих параметров командной строки `azure vm docker create` для настройки виртуальной машины, на которой размещены контейнеры Docker, на использование другого порта или других сертификатов для подключения клиентов:

    -dp, --docker-port [port]              Port to use for docker [4243]
    -dc, --docker-cert-dir [dir]           Directory containing docker certs [.docker/]

Демон Docker на узле настроен на прослушивание и проверку подлинности клиентских подключений на указанном порту, используя сертификаты, созданные с помощью команды `azure vm docker create`. Клиентские компьютеры должны иметь эти сертификаты, чтобы получить доступ к узлу Docker.

> [WACOM.NOTE] И наоборот, сетевой узел, работающий без этих сертификатов, будет уязвим для всех, кто может подключиться к компьютеру. Перед тем как изменить конфигурацию по умолчанию, убедитесь, что вы понимаете все риски, которым могут быть подвержены компьютеры и приложения.

## Дальнейшие действия

Вы уже можете выполнять команды Docker, описанные в [Руководстве пользователя Docker][Руководстве пользователя Docker], на основной виртуальной машине Docker на Azure.

## Расширения виртуальных машин для Linux и Windows

Расширение виртуальных машин Docker для Azure является всего лишь одним из множества расширений, обеспечивающих специальное поведение, многие из которых еще находятся на стадии разработки. Например некоторые возможности [расширений Агентов виртуальных машин Linux для Azure][агенте Linux для Azure] позволяют изменять и управлять образом, включая функции обеспечения безопасности, ядро и сетевые функции и так далее. Расширение VMAccess для образов Windows позволяет сбрасывать или изменять настройки удаленного рабочего стола, а также сбрасывать пароль администратора.

Полный список приведен в разделе [Расширения виртуальных машин Azure][Расширения виртуальных машин Azure].

<!--Anchors-->

  [Docker]: https://www.docker.com/
  [контейнеры Linux]: http://en.wikipedia.org/wiki/LXC
  [агенте Linux для Azure]: http://azure.microsoft.com/ru-ru/documentation/articles/virtual-machines-linux-agent-user-guide/
  [объявлением в блоге MS Open Tech]: http://msopentech.com/blog/2014/08/15/getting_started_docker_on_microsoft_azure/
  [Расширение Docker и контейнеры Linux]: #Docker-and-Linux-Containers
  [Использование расширения виртуальных машин Docker в Azure]: #How-to-use-the-Docker-VM-Extension-with-Azure
  [Расширения виртуальных машин для Linux и Windows]: #Virtual-Machine-Extensions-For-Linux-and-Windows
  [Ресурсы для контейнеров и управления ими в Azure]: #Container-and-Container-Management-Resources-for-Azure
  [гипервизорами]: http://en.wikipedia.org/wiki/Hypervisor
  [KVM]: http://www.linux-kvm.org/page/Main_Page
  [Что такое Docker?]: https://www.docker.com/whatisdocker/
  [Docker рекомендует]: https://docs.docker.com/articles/security/
  [обеспечение безопасности на основе ролей]: http://en.wikipedia.org/wiki/Role-based_access_control
  [SELinux]: http://selinuxproject.org/page/Main_Page
  [AppArmor]: http://wiki.apparmor.net/index.php/Main_Page
  [azure-cli]: https://github.com/Azure/azure-sdk-tools-xplat
  [Boot2Docker]: https://docs.docker.com/installation/windows/
  [здесь]: http://azure.microsoft.com/ru-ru/documentation/articles/xplat-cli/#install
  [диспетчер пакетов Node (NPM)]: http://en.wikipedia.org/wiki/Npm_%28software%29
  [1]: https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-an-ubuntu-14-04-server
  [пакетом установки для Mac]: http://go.microsoft.com/fwlink/?linkid=252249&clcid=0x409
  [Подключение к подписке Azure]: http://azure.microsoft.com/ru-ru/documentation/articles/xplat-cli/#configure
  [инструкции по установке Docker]: https://docs.docker.com/installation/#installation
  [!@\#$%^&+=]: mailto:!@#$%^&+=
  [0]: ./media/virtual-machines-docker/dockercreateresults.png
  [2]: ./media/virtual-machines-docker/connectingtodockerhost.png
  [Руководстве пользователя Docker]: https://docs.docker.com/userguide/
  [Расширения виртуальных машин Azure]: http://msdn.microsoft.com/ru-ru/library/azure/dn606311.aspx
