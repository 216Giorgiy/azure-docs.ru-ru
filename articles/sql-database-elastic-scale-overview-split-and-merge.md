<properties title="Splitting and Merging with Elastic Scale" pageTitle="Разбиение и объединение с технологией эластичного масштабирования" description="Explains how to manipulate shards and move data via a self-hosted service using Elastic Scale APIs." metaKeywords="sharding scaling, Azure SQL Database sharding, elastic scale, splitting and merging elastic scale" services="sql-database" documentationCenter="" manager="jhubbard" authors="sidneyh@microsoft.com"/>

<tags ms.service="sql-database" ms.workload="sql-database" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="10/02/2014" ms.author="sidneyh" />

# Разбиение и объединение с технологией эластичного масштабирования

Приложения, построенные на базах данных SQL Azure, сталкиваются с трудностями, когда их данные или нужды по их обработке более не умещаются в одной единице масштабирования. Примеры включают приложения, которые набирают огромную популярность, или случаи когда отдельное множество клиентов выходит за пределы ограничений одной базы данных SQL Azure. При эластичном масштабировании **служба разбиения и объединения (Split/Merge)** значительно упрощает эту проблему. 

В данном обсуждении службы разбиения и объединения управляет сужением и расширением решения за счет изменения числа баз данных Azure DB и балансировке распределения**данных сегментов** между ними. (определения терминов см. в [глоссарии по эластичному масштабированию](./sql-database-elastic-scale-glossary.md)). 

При текущем выборе версий баз данных SQL Azure управление производительностью может также осуществляться путем масштабирования вверх и вниз емкости одной базы данных Azure SQL DB. Аспект масштабирования вверх и вниз не решается службой разбиения и объединения, для этого см. описание эластичности сегментов в разделе [эластичность сегментов Elastic Scale](./sql-database-elastic-scale-elasticity.md)). 

## Случаи использования разбиения и объединения 
Приложениям требуется расширение за пределы одной базы данных Azure SQL DB, что проиллюстрировано в следующих сценариях: 

* **Увеличение емкости - разбиение диапазонов**: Возможность увеличения совокупной емкости уровня данных направлена на удовлетворение возрастающей потребности к объему их хранения. В этом сценарии приложение обеспечивает дополнительную емкость путем сегментирования данных и распределением информации по постепенно возрастающему количеству баз данных, пока не будет достигнут нужный объем. Функция разбиения службы разбиения и объединения эластичного масштабирования предназначена для этого сценария. 

* **Уменьшение емкости - объединение диапазонов**: Емкость колеблется из-за сезонных изменений ведения бизнеса. Этот сценарий подчеркивает необходимость выполнять обратное масштабирование до меньших единиц, когда бизнес временно замедляется. Функция объединения в службе разбиения и объединения эластичного масштабирования отвечает данному требованию. 

* **Управление хот-спотами - перемещение шардлетов (части данных в сегментах)**: При использовании одной базы данных несколькими клиентами определенное размещение шардлетов по сегментам может привести к падению производительности в некоторых сегментах. В такой ситуации потребуется перераспределить шардлеты или переместить нагруженные шардлеты в новые или менее загруженные сегменты. 

Далее эти возможности обработки данных службой мы будем называть запросами **разбиения/объединения/перемещения**. 


Рис. 1: Концептуальный обзор операций разбиения и объединения


![Overview][1] 


**Примечание**.  Не все сценарии **увеличения емкости** требуют использования службы разбиения и объединения. Например, если вы время от времени создаете новые сегменты для хранения новых данных с растущим значением ключа сегментирования, то можно использовать клиентские API управления сопоставлениями сегментов для отправки новых данных в новые создаваемые сегменты. Служба разбиения/объединения нужна только при перемещении существующих данных.

## Концепции и основные функции

**Службы, размещаемые на стороне клиента**: Служба разбиения/объединения реализуется в виде службы, размещаемой на стороне клиента. Необходимо развернуть и разместить службу в вашей подписке Microsoft Azure. Пакет, загружаемый через NuGet, содержит шаблон конфигурации, в который нужно внести информацию о вашем развертывании. Подробнее см. в [учебнике по службе разбиения и объединения](./sql-database-elastic-scale-configure-deploy-split-and-merge.md). Поскольку служба выполняется в подписке Azure, вы можете контролировать и настраивать большинство аспектов безопасности этой службы. Шаблон по умолчанию включает параметры настройки SSL, проверку подлинности клиента на основе сертификатов, защиту от DoS-атак и ограничения IP-адресов. Дополнительные сведения об аспектах безопасности можно получить в следующем документе [рекомендации по безопасности эластичного масштабирования](./sql-database-elastic-scale-configure-security.md).

Служба, развернутая в стандартном виде, выполняется с одной рабочей ролью и одной веб-ролью. Каждая использует размер виртуальной машины A1 в облачных службах Azure. Эти параметры нельзя изменить при развертывании пакета, но можно изменить их после успешного развертывания в работающей облачной службе (через портал Azure). Обратите внимание, что рабочая роль по техническим причинам не должна быть настроена для более чем одного экземпляра. 

**Интеграция сопоставлений сегментов**. Служба разбиения и объединения взаимодействует с картой сопоставления сегментов приложения. При использовании службы для разбиения, объединения диапазонов или перемещения данных между сегментами служба автоматически обновляет сопоставления сегментов. Для этого во время обработки запросов служба подключается к базе данных диспетчера сопоставления сегментов приложения и обновляет диапазоны ключей и сопоставления. Это гарантирует, что при выполнении операций разбиения и объединения задействованные сопоставления сегментов всегда будут иметь актуальные данные. Операции разбиения, объединения и перемещения шардлетов осуществляются перемещением пакетов шардлетов из исходного сегмента в целевой сегмент. Во время перемещения шардлета данные обрабатываемого шардлета отмечаются в сопоставлении сегментов как отключенные и недоступны для подключений маршрутизации на основе данных через **OpenConnectionForKey** API. 

**Согласованные подключения к шардлетам**: При начале перемещения нового пакета шардлетов любые предоставленные картой сегментов подключения по маршрутизации на основе данных к сегменту, где хранится шардлет, обрываются и последующие подключения от API карты сегментов к этим шардлетам блокируются на время перемещения данных с целью предотвращения несогласованности. Подключения к другим шардлетам в пределах этого сегмента будут также разорваны, но могут быть немедленно восстановлены. После перемещения пакета шардлеты отмечаются как включенные в целевом сегменте, а исходные данные из исходного сегмента удаляются. Служба выполняет эти действия для каждого пакета, пока не будут перемещены все шардлеты. В результате во время выполнения операции разбиения, объединения или перемещения могут быть разорваны несколько подключений.   

**Управление доступностью шардлетов**: Ограничение разрыва подключений рамками обрабатываемого в данный момент пакета шардлетов, как оговорено выше, ограничивает объем недоступных данных одним пакетом шардлетов. Такой подход более предпочтителен, чем если бы во время осуществления операции разбиения/объединения был недоступен весь сегмент. Размер пакета, который определяется количеством уникальных шардлетов для перемещения за момент времени, - это настраиваемый параметр. Его можно задать для каждой операции разбиения и объединения, в зависимости от требований доступности и производительности приложения. Обратите внимание, что сегмент, заблокированный в сопоставлении сегментов, может превышать заданные размеры пакета. Это происходит потому, что служба выбирает размер диапазона таким образом, чтобы фактическое количество значений ключа сегментирования в данных примерно соответствовало размеру пакета. Это важно помнить, в особенности при наличии разреженных ключей сегментирования. 

**Хранилище метаданных**: Служба разбиения и объединения использует базу данных для хранения состояния и журналов во время обработки запроса. Пользователь создает эту базу данных в своей подписке и указывает строку подключения в файле конфигурации для развертывания службы. Администраторы из организации пользователя также могут подключаться к этой базе данных для просмотра хода выполнения запроса и изучения подробных сведений о потенциальных сбоях.

**Сведения о сегментировании**: Служба разбиения и объединения различает сегментированные таблицы (1), ссылочные таблицы (2) и обычные таблицы (3). Семантика операций разбиения, объединения и перемещения зависит от типа таблицы и определяется следующим образом: 

* **Сегментированные таблицы**: Операции разбиения, объединения и перемещения переносят шардлеты из исходного сегмента в целевой. После успешного завершения всего запроса эти шардлеты удаляются из исходного сегмента. Обратите внимание, что целевые таблицы должны существовать на целевом сегменте до начала обработки операции и не должны содержать данных в целевом диапазоне. 

-    **Ссылочные таблицы**: Для ссылочных таблиц операции разбиения, объединения и перемещения копируют данные из исходного сегмента в целевой. Однако, обратите внимание, что в целевом сегменте не происходит изменений, если в заданной таблице уже присутствуют какие-либо строки. Для осуществления операции копирования ссылочной таблицы целевая таблица должна быть пустой.

-    **Другие таблицы**: В исходном или целевом сегменте операции разбиения и объединения могут присутствовать другие таблицы. Операция разбиения и объединения не затрагивает эти таблицы при любых операциях перемещения или копирования данных. Учтите, что они могут помешать этим операциям в случае наличия ограничений.

Сведения о ссылочных и сегментированных таблицах приведены в**SchemaInfo** API сопоставления сегментов. Следующий пример демонстрирует использование этих API для объекта smm диспетчера сопоставления сегментов: 

    // Create the schema annotations 
    SchemaInfo schemaInfo = new SchemaInfo(); 

    // Reference tables 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "region")); 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "nation")); 

    // Sharded tables 
    schemaInfo.Add(new ShardedTableInfo("dbo", "customer", "C_CUSTKEY")); 
    schemaInfo.Add(new ShardedTableInfo("dbo", "orders", "O_CUSTKEY")); 

    // Publish 
    smm.GetSchemaInfoCollection().Add(Configuration.ShardMapName, schemaInfo); 

Таблицы "область" и "страна" определяются как ссылочные таблицы и будут скопированы с помощью операций разбиения и объединения. "Клиент" и "заказы", в свою очередь, определяются как сегментированные таблицы. C_CUSTKEY и O_CUSTKEY служат в качестве ключа сегментирования. 

**Ссылочная целостность**: Служба разбиения и объединения анализирует зависимости между таблицами и использует связи внешнего ключа и первичного ключа для выполнения операций перемещения ссылочных таблиц и шардлетов. В общем случае в первую очередь копируются ссылочные таблицы в порядке зависимости, затем копируются шардлеты в порядке их зависимостей в каждом пакете. Это нужно для того, чтобы учитывать ограничения внешнего ключа-основного ключа целевого сегмента при поступлении новых данных. 

**Согласованность сопоставления сегментов и завершение операций**: Служба разбиения и объединения возобновляет работу после любого сбоя и стремится завершить любые активные запросы. Тем не менее, могут возникнуть неустранимые ситуации, например, когда целевой сегмент утерян или поврежден без возможности восстановления. В таком случае некоторые шардлеты, предназначенные для перемещения, могут сохраниться в исходном сегменте. Служба обеспечивает обновление сопоставления шардлетов только после успешного копирования необходимых данных в целевой сегмент. Шардлеты удаляются только после копирования всех данных в целевой сегмент и успешного обновления соответствующих сопоставлений. Операция удаления осуществляется в фоновом режиме, после того как диапазон данных уже стал доступен на целевом сегменте. Служба разбиения и объединения всегда гарантирует правильность сопоставлений в карте сегментов.

## Получение двоичных файлов службы

Двоичные файлы службы разбиения и объединения доступны в [NuGet](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge/). См. пошаговое [руководство по службе разбиения и объединения](./sql-database-elastic-scale-configure-deploy-split-and-merge.md) для получения дополнительной информации о загрузке двоичных файлов.

## Пользовательский интерфейс службы разбиения и объединения

Помимо рабочей роли, пакет службы разбиения и объединения также включает веб-роль, которую можно использовать для отправки запросов разбиения и объединения в интерактивном режиме. Существуют следующие основные компоненты пользовательского интерфейса:

-    Тип операции: Тип операции - это переключатель, определяющий тип операции, выполняемой службой для данного запроса. Можно выбрать сценарии разбиения, объединения и перемещения, рассмотренные в разделе "Концепции и основные функции". Кроме того, можно также отменить ранее запрошенную операцию.

-    Карта сегментов: Следующий раздел параметров запроса описывает сопоставление сегментов и базу данных, в которой размещается карта сегментов. В частности, необходимо указать имя сервера базы данных SQL Azure и базы данных, в которой размещается карта сегментов, данные для подключения к базе данных c картой сегментов и, наконец, имя карты. В настоящее время операция принимает только один набор учетных данных. Эти учетные данные должны иметь достаточные разрешения для изменения сопоставления сегментов, а также пользовательских данных в этих сегментах.

-    Диапазон источника (операции разбиения и объединения): Для операции разбиения и объединения запрос должен иметь ключ нижнего и верхнего значений диапазона исходного сегмента. В настоящее время необходимо указывать ключи точно в таком же виде, в каком они встречаются в сопоставлении карты сегментов. Сценарий PowerShell GetMappings.ps1 можно использовать для получения текущего сопоставления для данной карты сегментов.

-    Ключ разбиения и выполнение операции (разбиения): Для операций разбиения необходимо также указать точку, в которой следует разделить исходный диапазон. Это делается путем ввода ключа сегментирования для того места, в котором необходимо выполнить разбиение. Используйте расположенный рядом переключатель, чтобы указать следует ли переместить нижнюю часть диапазона (за исключением ключа разбиения), или верхнюю часть диапазона (включая ключ разбиения).

-    Исходный шардлет (перемещение): Операции перемещения отличаются от операций разбиения или объединения тем, что для них не требуется указание диапазона в источнике данных. Источник данных для перемещения просто определяется значением ключа сегментирования, который планируется переместить.

-    Целевой сегмент (разбиение): После введения информации об исходном сегменте для операции разбиения необходимо указать, куда следует скопировать данные, предоставив серверу базы данных SQL Azure имя базы данных для целевого сегмента.

-    Целевой диапазон (объединение): Операции объединения перемещают шардлеты в существующий сегмент. Существующий сегмент указывается путем ввода пределов диапазона сегмента, с которым необходимо выполнить объединение.

-    Размер пакета: Размер пакета определяет количество шардлет, которые будут отключены во время перемещения данных. Это целое число; когда нежелательны продолжительные периоды простоя сегментов, можно использовать маленькие значения. Большие значения увеличат продолжительность отключения шардлетов, но могут повысить производительность.

-    Идентификатор операции (отмена): Если идет выполнение операции, в которой больше нет потребности, можно отменить эту операцию, указав в этом поле ее идентификатор. Идентификатор операции можно получить из таблицы состояний запросов (см. раздел 8.1) или из выходных данных в веб-браузере, через который был послан запрос.


## Требования и ограничения 

Текущая реализация службы разбиения и объединения соответствует следующим требованиям и ограничениям: 

* В настоящее время сегменты должны существовать и быть зарегистрированы в сопоставлении сегментов до выполнения операций разбиения и объединения над этими сегментами. 

* При исполнении операций служба разбиения и объединения в настоящее время не создает автоматически таблицы или другие объекты базы данных. Это означает, что схемы для всех сегментированных таблиц и ссылочных таблиц целевого сегмента должны существовать до начала любой операции разбиения, объединения и перемещения. В частности, сегментированные таблицы должны быть пустыми в диапазоне, в который операцией будут добавляться новые данные. В противном случае операция завершится ошибкой при начальной проверке согласованности целевого сегмента. Также обратите внимание на то, что ссылочные данные копируются только в случае, если ссылочная таблица пуста. Не гарантируется согласованность с другими параллельными операциями записи в эти ссылочные таблицы. Рекомендуется во время выполнения операции разбиения и объединения не осуществлять других операций записи для внесения изменений в эти ссылочные таблицы.

* В настоящее время служба использует идентификатор строки, который задается уникальным индексом или ключом, включая ключ сегментирования, который повышает надежность больших шардлетов. Это позволяет службе перемещать данные с еще большей степенью детализации, чем просто значение ключа сегментирования. Это позволяет уменьшить максимальный объем пространства журнала и количество требуемых блокировок для проведения операции. Рекомендуется для данной таблицы создать уникальный индекс или первичный ключ, включая ключ сегментирования, если вы хотите использовать эту таблицу вместе с запросами разбиения, объединения и перемещения. Для повышения производительности ключ сегментирования должен находиться в первом столбце ключа или индекса.

* Во время обработки запроса некоторые данные шардлета могут одновременно быть и в исходном и в целевом сегменте. В настоящее время это необходимо для защиты от сбоев при перемещении шардлетов. Как описано выше, интеграция службы разбиения и объединения с сопоставлением сегментов эластичного масштабирования гарантирует, что подключения через API маршрутизации на основе данных, будут использовать метод **OpenConnectionForKey** для игнорирования несогласованных промежуточных состояний сопоставлвения сегментов. Тем не менее, при подключении к исходным или целевым сегментам без использования **OpenConnectionForKey** во время обработки запросов разбиения, объединения и перемещения могут наблюдаться несогласованные промежуточные состояния. Эти подключения могут показывать частичные или повторяющиеся результаты в зависимости от времени выполнения или используемых в подключении сегментов. В настоящий момент это ограничение включает подключения, созданные многосегментными запросами эластичного масштабирования.

* Рабочая роль службы разбиения и объединения в настоящее время не поддерживает экземпляры со множеством ролей. Это исключает из Azure конфигурации высокого уровня доступности, использующие домены сбоя или обновления и зависящие от возможности запускать экземпляры со множеством ролей. Кроме того, метаданные базы данных для разбиения и объединения не должны одновременно использоваться двумя различными экземплярами. Например, экземпляр службы разбиения и объединения, во время работы в промежуточном режиме должен ссылаться на метаданные базы данных, отличные от тех, которые использует экземпляр в рабочем режиме.
 

## Выставление счетов 

Поскольку служба разбиения и объединения работает как облачная служба в рамках подписки Microsoft Azure, ваш экземпляр службы имеет стандартную стоимость для облачных служб. Если вы не часто выполняете операции разбиения, объединения и перемещения, рекомендуем удалить облачную службу разбиения и объединения. Это поможет сократить расходы на действующие или развернутые экземпляры облачной службы. Готовую к работе конфигурацию можно повторно развернуть и запустить всякий раз, когда потребуется выполнить операции разбиения и объединения. 
  
## Мониторинг 
### Таблицы состояния 

Служба разбиения и объединения предоставляет таблицу **RequestStatus** с базой данных хранения метаданных для отслеживания завершенных и выполняемых запросов. В таблице перечислены строки для каждого запроса разбиения и объединения в данном экземпляре службы. В ней представлены следующие сведения для каждого запроса:

* **Timestamp (Метка времени)**: Дата и время начала запроса.

* **OperationId (Идентификатор операции)**: Идентификатор GUID, однозначно определяющий запрос. Этот идентификатор также может использоваться для отмены операции во время ее выполнения.

* **Status (Состояние)**: Текущее состояние запроса. Для выполняемых запросов в ней также приведен текущий этап выполнения запроса.

* **CancelRequest (Отмена запроса)**: Флаг, указывающий, является ли запрос отмененным.

* **Progress (Ход выполнения)**: Процентная оценка хода выполнения операции. Значение 50, указывает, что операция завершена примерно на 50%.

* **Details (Подробности)**: Значение XML, которое предоставляет более подробный отчет о ходе выполнения. Отчет о ходе выполнения периодически обновляется по мере копирования наборов строк из исходного в целевой сегмент. В случаях ошибок или исключений в этом столбце также содержатся более подробные сведения об ошибке.


### Диагностика Azure 

Шаблон службы для разбиения и объединения предварительно настроен на использование хранилища WAD (диагностика Windows Azure), хранения дополнительных подробных журналов и диагностических данных. Управлять конфигурацией WAD, учетной записью хранилища и учетными данными, можно через файл конфигурации службы для разбиения и объединения. Конфигурация WAD для этой службы следует рекомендациям из статьи [Основы облачных служб](http://code.msdn.microsoft.com/windowsazure/Cloud-Service-Fundamentals-4ca72649). В ней даются определения журнала счетчиков производительности, журналов IIS, журналов событий Windows и журналов событий приложения разбиения и объединения. Эти журналы можно легко получить при помощи Visual Studio Server Explorer, смотрите узел Azure в обозревателя :

![Azure Diagnostics][2]   

Таблица WADLogsTable, выделенная на рисунке выше, содержит подробные события из журнала приложения службы разбиения/объединения. Обратите внимание, что конфигурация по умолчанию, которая предоставляется в составе загружаемого пакета, предназначена для рабочего развертывания. Как следствие, интервал извлечения журналов и счетчиков из экземпляров службы достаточно большой (5 минут). Для тестирования и разработки можно сократить этот интервал изменив настройки параметров диагностики веб-роли или рабочей роли. Это можно сделать, щелкнув правой кнопкой мыши на роли в Visual Studio Server Explorer (см. выше) и затем изменить период передачи в диалоговом окне настройки параметров диагностики:

![Configuration][3]


На вкладках диалогового окна выполняется управление различными типами журналов, у каждого из них есть свои параметры периода передачи. 
В случае возникновения проблем при развертывании службы разбиения и объединения сотрудникам Майкрософт может потребоваться доступ к данным в журналах и счетчиках WAD. При помощи таких средств, как [обозреватель хранилищ Azure](http://azurestorageexplorer.codeplex.com/), можно экспортировать журналы WAD в легко распространяемые файлы CSV. 

## Производительность

Производительность операций разбиения, объединения и перемещения зависит от множества факторов. Обычно высокая производительность ожидается на высших, более производительных уровнях базы данных SQL Azure. Более высокая скорость ввода-вывода, мощные ЦП и емкая память для высших уровней служб предоставляют преимущества при осуществлении операций массового копирования и удаления данных, которые используются внутри службы разбиения и объединения. По этой причине может быть полезно повышение уровня службы для заданного набора баз данных на четко определенный ограниченный период времени. Это позволит быстро выполнять запланированные операции службы разбиения и объединения в диапазонах, размещенных на этих базах данных.

Учитывайте, что служба в процессе своей нормальной работы также выполняет запросы проверки. Эти запросы, помимо прочего, проверяют непредвиденное наличие данных в целевом диапазоне и контролируют запуск любой операции операция разбиения, объединения и перемещения из согласованного состояния сегментов. Все эти запросы работают с ключом сегментирования, который задает область действия операции. С запросом также передается размер пакета. Эти запросы лучше всего выполнять при наличии индекса с ключом сегментирования в первом столбце. 

Кроме того, свойство уникальности при наличии ключа сегментирования в первом столбце позволят службе использовать оптимизированный алгоритм ограничения потребления ресурсов для журналов и памяти. Это свойство уникальности необходимо для перемещения больших объемов данных (обычно свыше 1 ГБ). 

## Рекомендации и устранение неполадок 
-    Рекомендуется создать клиента для тестов и проверить наиболее важные операции разбиения, объединения и перемещения на нескольких сегментах с использованием этого тестового клиента. Это поможет обеспечить правильное определение всех метаданных в сопоставлении сегментов и убедиться, что операции не нарушают ограничения и не портят внешние ключи.
-    Стоит поддерживать размер данных тестового клиента так, чтобы он больше максимального размера данных вашего крупнейшего клиента. Это позволит избежать проблем, связанных с размером данных. Это также позволит оценить верхнюю границу времени перемещения всех данных одного клиента. 
-    Службе разбиения и объединения требуется возможность удаления данных из исходного сегмента после успешного копирования данных в целевой сегмент. Тщательно проверьте схему - она должна поддерживать удаление. Например, триггеры удаления могут помешать службе удалить данные в исходном сегменте, что может привести к сбою операций.
-    Убедитесь, что ключ сегментирования является первым столбцом первичного ключа или определения уникального индекса. Это обеспечит наилучшую производительность как для запросов проверки разбиения и объединения, так и для фактических операций перемещения и удаления данных, которые всегда работают с диапазонами ключей сегментирования.
-    Из соображений производительности и стоимости службу разбиения и объединения целесообразно размещать в том же регионе и центре обработки данных, где находятся ваши базы данных. 

[AZURE.INCLUDE [elastic-scale-include](../includes/elastic-scale-include.md)]

## Ссылки 

* [Учебник по службе разбиения и объединения](./sql-database-elastic-scale-configure-deploy-split-and-merge.md)

* [Вопросы безопасности эластичного масштабирования](./sql-database-elastic-scale-configure-security.md)  


<!--Anchors-->
<!--Image references-->
[1]:./media/sql-database-elastic-scale-split-and-merge/split-merge-overview.png
[2]:./media/sql-database-elastic-scale-split-and-merge/diagnostics.png
[3]:./media/sql-database-elastic-scale-split-and-merge/diagnostics-config.png
