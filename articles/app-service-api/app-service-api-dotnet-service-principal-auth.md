<properties
	pageTitle="Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure | Microsoft Azure"
	description="Узнайте, как защитить приложение API в службе приложений Azure для сценариев взаимодействия служб."
	services="app-service\api"
	documentationCenter=".net"
	authors="tdykstra"
	manager="wpickett"
	editor=""/>

<tags
	ms.service="app-service-api"
	ms.workload="na"
	ms.tgt_pltfrm="dotnet"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="01/08/2016" 
	ms.author="tdykstra"/>

# Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure

[AZURE.INCLUDE [app-service-api-get-started-selector](../../includes/app-service-api-get-started-selector.md)]

## Обзор

В этом руководстве показано, как использовать функции проверки подлинности и авторизации службы приложений Azure для защиты приложений API, а также как использовать защищенное приложение API от имени учетной записи службы. В руководстве описан поставщик проверки подлинности Azure Active Directory. И клиент, и интерфейс API являются веб-интерфейсами API ASP.NET, которые выполняются в приложениях API.

## Проверка подлинности и авторизация в службе приложений

Введение в функции аутентификации, которые используются в этом руководстве, см. в предыдущем руководстве этой серии — [Проверка подлинности и авторизация для приложений API в службе приложений Azure](app-service-api-authentication.md).

## Как работать с этим руководством

Это руководство основано на примере приложения, которое вы загрузили и на основе которого создали приложение API в ходе работы с руководством [Приступая к работе с приложениями API и ASP.NET в службе приложений Azure](app-service-api-dotnet-get-started.md).

## Пример проекта CompanyUsers.API

В [примере приложения ContactsList](https://github.com/Azure-Samples/app-service-api-dotnet-contact-list) CompanyUsers.API — это простой проект веб-API, содержащий один метод GET, который возвращает жестко заданный список контактов. Чтобы продемонстрировать сценарий взаимодействия служб, метод GET в ContactsList.API вызывает метод GET в CompanyContacts.API. Затем метод добавляет полученные контакты к тем, которые содержатся в его хранилище данных, и возвращает объединенный список.

Ниже приведено использование метода GET в CompanyUsers.API.

		public async Task<IEnumerable<Contact>> Get()
		{
		    var contacts = new Contact[]{
		                new Contact { Id = 1, EmailAddress = "nancy@contoso.com", Name = "Nancy Davolio"},
		                new Contact { Id = 2, EmailAddress = "alexander@contoso.com", Name = "Alexander Carson"}
		            };
		
		    return contacts;
		}


А здесь приведен код, в котором метод GET в ContactsList.API вызывает CompanyContacts.API и добавляет результаты к тем данным, которые он возвращает. (Для наглядности часть кода опущена.)

		private async Task<IEnumerable<Contact>> GetContacts()
		{
		    var contacts = await _storage.Get(FILENAME);
		
		    var contactsList = contacts.ToList<Contact>();
		    using (var client = CompanyContactsAPIClientWithAuth())
		    {
		        var results = await client.Contacts.GetAsync();
		        foreach (Contact c in results)
		        {
		            contactsList.Add(c);
		        }
		    }
		
		    return contactsList;
		}

Клиентский объект, возвращаемый методом `CompanyContactsAPIClientWithAuth()` в приведенном выше коде, основан на созданном клиентском коде. Он добавляет маркер проверки подлинности в HTTP-запросы.

		private static CompanyContactsAPI CompanyContactsAPIClientWithAuth()
		{
		    var client = new CompanyContactsAPI(new Uri(ConfigurationManager.AppSettings["CompanyContactsAPIUrl"]));
		    client.HttpClient.DefaultRequestHeaders.Authorization =
		        new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
		    return client;
		}

## Создание приложения API в Azure и развертывание в нем проекта CompanyContacts.API

1. В **обозревателе решений** щелкните правой кнопкой мыши проект CompanyContacts.API и нажмите кнопку **Опубликовать**.

3.  На шаге **Профиль** мастера **веб-публикации** щелкните **Служба приложений Microsoft Azure**.

	![](./media/app-service-api-dotnet-service-principal-auth/selectappservice.png)

4. Войдите в учетную запись Azure, если вы этого еще не сделали, или обновите учетные данные, если срок их действия истек.

4. В диалоговом окне **Служба приложений** в поле **Подписка** выберите подписку Azure, которую хотите использовать, и нажмите кнопку **Создать**.

	![](./media/app-service-api-dotnet-service-principal-auth/clicknew.png)

3. В диалоговом окне **Создание службы приложений** на вкладке **Размещение** щелкните **Изменить тип**, а затем — **Приложение API**.

4. В поле **Имя приложения API** введите имя, которое является уникальным в домене *azurewebsites.net*.

6. В раскрывающемся списке **Группа ресурсов** выберите группу ресурсов, которая использовалась при работе с этими руководствами.

4. В раскрывающемся списке **План службы приложений** выберите план, который использовался при работе с этими руководствами.

7. Щелкните **Создать**.

	![](./media/app-service-api-dotnet-service-principal-auth/createappservice.png)

	Visual Studio создает приложение API и профиль публикации со всеми настройками, необходимыми для нового приложения API.

8. На вкладке **Подключение** мастера **веб-публикации** нажмите кнопку **Опубликовать**.

	![](./media/app-service-api-dotnet-service-principal-auth/conntab.png)

	Visual Studio развертывает проект в новом приложении API и выполняет переход по URL-адресу приложения API в браузере. В браузере откроется страница с сообщением «Успешно создано».

9. Закройте браузер.

## Обновление созданного кода клиента в проекте ContactsList.API

В проекте ContactsList.API уже есть созданный код клиента, но его нужно удалить и создать заново из собственного приложения API.

1. В **обозревателе решений** Visual Studio в проекте ContactsList.API удалите папку *CompanyContactsAPI*.

2. Щелкните правой кнопкой мыши проект ContactsList.API и выберите **Добавить > Клиент REST API**.

3. В диалоговом окне **Добавление клиента REST API** щелкните **Скачать из приложения API Microsoft Azure**, а затем нажмите кнопку **Обзор**.

8. В диалоговом окне **Службы приложений** разверните группу ресурсов, которую вы используете в этом руководстве, а затем выберите только что созданное приложение API.

	Если в списке нет приложения API, скорее всего, при его создании вы случайно пропустили действие по замене веб-приложения приложением API. В этом случае можно создать новое приложение API, повторив шаги, выполненные ранее. Выберите для приложения API другое имя или перейдите на портал и удалите веб-приложение.

10. Нажмите кнопку **ОК**.

9. В диалоговом окне **Добавление клиента REST API** нажмите кнопку **ОК**.

	Visual Studio создает папку с именем приложения API и классы клиента.

## Обновление кода в ContactsList.API и развертывание проекта

Код в ContactsList.API, вызывающий CompanyContacts.API, закомментирован при работе с предыдущими руководствами. В этом разделе вы раскомментируете этот код и развернете приложение.

1. В проекте ContactsList.API откройте файл *Controllers/ContactsController.cs*.

2. В верхней части класса `ContactsController` в коде, который использует созданный клиентский класс для добавления маркера проверки подлинности, замените имя класса `CompanyContactsAPI` именем класса, созданного из приложения API.

	Например, если имя приложения API — CompanyContactsAPI3, код будет выглядеть следующим образом:

		 private static CompanyContactsAPI3 CompanyContactsAPIClientWithAuth()
		 {
		     var client = new CompanyContactsAPI3(new Uri(ConfigurationManager.AppSettings["CompanyContactsAPIUrl"]));
		     client.HttpClient.DefaultRequestHeaders.Authorization =
		         new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
		     return client;
		 }
 
4. В методе `Get` раскомментируйте блок кода, который вызывает CompanyContacts.API.

		using (var client = CompanyContactsAPIClientWithAuth())
		{
		    var results = await client.Contacts.GetAsync();
		    foreach (Contact c in results)
		    {
		        contactsList.Add(c);
		    }
		}

2. Щелкните правой кнопкой мыши проект ContactsList.API и нажмите кнопку **Опубликовать**.

	В мастере **веб-публикации** откроется профиль публикации, который вы использовали ранее.

3. В мастере **Публикация веб-сайтов** щелкните **Опубликовать**.

	Visual Studio развернет проект и откроет в окне браузера базовый URL-адрес приложения API. Закройте это окно браузера.

## Настройка проверки подлинности и авторизации в Azure для нового приложения API

1. На [портале Azure](https://portal.azure.com/) перейдите к колонке приложения API, созданного в этом руководстве для проекта CompanyContacts.API, и нажмите кнопку **Параметры**.

2. Найдите раздел **Функции** и щелкните **Проверка подлинности и авторизация**.

3. В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**

4. В раскрывающемся списке **Действие, выполняемое, если запрос не прошел проверку подлинности** выберите **Войти с помощью Azure Active Directory**.

5. В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**.

6. В колонке **Параметры Azure Active Directory** щелкните **Стандартный**.

	Azure автоматически создаст приложение AAD в клиенте AAD. Запишите имя нового приложения AAD, поскольку позже вам необходимо будет выбрать его после перехода на классический портал Azure для получения идентификатора клиента.

7. Нажмите кнопку **ОК**.

10. В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.
 
11. На [классическом портале Azure](https://manage.windowsazure.com/) перейдите в раздел **Azure Active Directory**.

12. На вкладке **Каталог** щелкните свой клиент AAD.

14. Щелкните **Приложения > Приложение, принадлежащее моей компании**, а затем щелкните значок с галочкой.

15. В списке приложений щелкните имя приложения, созданного в Azure после того, как вы активировали проверку подлинности для приложения API.

16. Нажмите **Настроить**.

17. Оставьте эту страницу открытой, чтобы можно было копировать из и вставлять данные в нее и обновлять значения на странице при выполнении дальнейших шагов этого руководства.

## Обновление настроек в приложении API, которое выполняет код проекта ContactsList.API

3. В другом окне браузера перейдите на [классический портал Azure](https://manage.windowsazure.com/), а затем — на вкладку **Настройка** приложения AAD, созданного для приложения API ContactsList.API.

5. В разделе **ключей** в раскрывающемся списке **Выбрать длительность** выберите **1 год**.

6. Щелкните **Сохранить**.

	![](./media/app-service-api-dotnet-service-principal-auth/genkey.png)

7. Скопируйте значение ключа.

	![](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

1. В другом окне браузера перейдите на [портал Azure](https://portal.azure.com/), а затем — к колонке приложения API, в которое развернут проект ContactsList.API. (Это вызывающее, а не вызываемое приложение API — ContactsList.API, а не CompanyContacts.API.)

2. Щелкните элементы **Параметры > Параметры приложения**.

3. В разделе **Параметры приложения** добавьте ключ с именем ida:ClientSecret и вставьте только что созданный ключ в поле значения.

3. Добавьте ключ с именем ida:ClientId и вставьте в поле значения идентификатор клиента с той же страницы AAD **Настройка**.

4. Добавьте ключ с именем ida:Authority и в поле значения введите https://login.windows.net/{ваш\_клиент}, например: https://login.windows.net/contoso.onmicrosoft.com.

3. На классическом портале Azure перейдите на вкладку **Настройка** приложения AAD, созданного для приложения API CompanyContacts.API.

4. Скопируйте код клиента.

3. В колонке **Параметры приложения** портала Azure в разделе **Параметры приложения** добавьте ключ с именем ida:Resource и вставьте в поле значения только что скопированный идентификатор клиента.

4. Добавьте ключ с именем CompanyContactsAPIUrl и в поле значения введите https://{имя\_приложения\_api}.azurewebsites.net, например: https://companycontactsapi.azurewebsites.net.

6. Щелкните Сохранить.

	![](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

## Тестирование в Azure

1. Перейдите по URL-адресу веб-приложения, в котором развернут проект ContactsList.Angular.AAD.

2. Щелкните вкладку **Контакты** и войдите в систему.

	Появится страница контактов с дополнительными контактами, которые получены из приложения API CompanyContacts.API.

	![](./media/app-service-api-dotnet-service-principal-auth/contactspagewithdavolio.png)

Как и в предыдущем руководстве, вы можете указать для проектов Visual Studio URL-адреса локального узла SSL и запустить приложение локально. В таком случае параметры, сохраненные в Azure для выполнения в Azure (идентификатор клиента, секрет клиента и т. д.), можно хранить в файле Web.config. При этом не регистрируйте в системе управления версиями файл Web.config, который содержит конфиденциальные сведения, например секрет клиента. Дополнительную информацию см. в статье [Рекомендации по развертыванию паролей и других конфиденциальных данных в ASP.NET и в службе приложений Azure](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).

## Защита приложения API от доступа браузера

В этом руководстве для настройки проверки подлинности AAD в приложении API используется параметр «Стандартный» на портале Azure (доступ к приложению будет осуществляться с помощью проверки подлинности субъекта-службы). По умолчанию служба приложений настраивает новое приложение AAD так, чтобы пользователь мог использовать URL-адрес приложения API для перехода на страницу входа в браузере. Это означает, что доступ к API может осуществлять не только субъект-служба, но и пользователь. Если требуется, чтобы доступ к API предоставлялся только субъекту- службе, можно запретить доступ через браузер. Для этого измените в приложении AAD **URL-адрес ответа** так, чтобы он отличался от базового URL-адреса приложения API.

### Проверка доступа через браузер

1. В новом окне браузера перейдите по URL-адресу HTTPS приложения API, созданного для проекта CompanyContacts.API.

	В браузере откроется экран входа.
	
2. Войдите с помощью учетных данных, используемых в клиенте AAD.

3. В браузере откроется экран приложения API, информирующий об успешном выполнении операции.

	Если пользовательский интерфейс Swagger активирован, вы сможете перейти по URL-адресу `/swagger` и вызвать API. Можно вызвать API из браузера, добавив к URL-адресу `/api/contacts/get`.

### Отключение доступа через браузер

1. На вкладке **Настройка** классического портала измените для приложения AAD, которое было создано для проекта CompanyContacts.API, значение в поле **URL-адрес ответа** так, чтобы оно являлось действительным URL-адресом, но не URL-адресом приложения API.
 
2. Щелкните **Сохранить**.

### Проверка отсутствия доступа через браузер

1. В новом окне браузера еще раз перейдите по URL-адресу приложения API.

2. Войдите в систему по запросу.

3. Операция входа завершится отображением страницы ошибки.

	Хотя доступ к приложению API по-прежнему можно осуществить с помощью маркера субъекта-службы, пользователи в клиенте AAD не смогут войти в систему и получить доступ к API из браузера.

## Дальнейшие действия

Это последнее руководство в серии учебных материалов для работы с приложениями API. В этом разделе приведены ресурсы для дальнейшей работы с приложениями API.

* Другие способы развертывания приложения службы приложений

	Сведения о других способах развертывания веб-проектов в веб-приложениях с помощью Visual Studio или функции [автоматизации развертывания](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) из [системы управления версиями](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) см. в статье [Документация по развертыванию службы приложений Azure](web-sites-deploy.md).

	Visual Studio может также создавать скрипты Windows PowerShell, которые можно использовать для автоматизации развертывания. Дополнительные сведения см. в разделе [Полная автоматизация (создание реальных облачных приложений в Azure)](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/automate-everything).

* Способы устранения неполадок в приложении службы приложений

	Visual Studio предоставляет функции, упрощающие просмотр журналов Azure по мере их создания в режиме реального времени. Можно также работать в Azure удаленно в режиме отладки. Дополнительную информацию см. в разделе [Устранение неполадок веб-приложений Azure в Visual Studio](web-sites-dotnet-troubleshoot-visual-studio.md).

* Добавление настраиваемого доменного имени и SSL

	Информацию об использовании SSL и собственного домена (например, www.contoso.com вместо contoso.azurewebsites.net) см. в следующих статьях.

	* [Настройка личного доменного имени в службе приложений Azure](web-sites-custom-domain-name.md)
	* [Включение HTTPS для веб-приложения Azure](web-sites-configure-ssl-certificate.md)

<!---HONumber=AcomDC_0114_2016-->