<properties
	pageTitle="Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure | Microsoft Azure"
	description="Узнайте, как защитить приложение API в службе приложений Azure для сценариев взаимодействия служб."
	services="app-service\api"
	documentationCenter=".net"
	authors="tdykstra"
	manager="wpickett"
	editor=""/>

<tags
	ms.service="app-service-api"
	ms.workload="na"
	ms.tgt_pltfrm="dotnet"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="11/28/2015"
	ms.author="tdykstra"/>

# Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure

[AZURE.INCLUDE [app-service-api-get-started-selector](../../includes/app-service-api-get-started-selector.md)]

## Обзор

В этом руководстве показано, как использовать функции проверки подлинности и авторизации службы приложений Azure для защиты приложений API, а также, как использовать защищенное приложение API от имени учетной записи службы. Учетная запись службы называется также *субъект-служба*, а проверку подлинности с использованием такой учетной записи называют также сценарием *взаимодействия между службами*. Следуя инструкциям в этом руководстве, вы установите защиту приложения API в рамках сценария взаимодействия между службами, используя Azure Active Directory для проверки подлинности, при этом API будет использоваться из клиента .NET.

В этом руководстве веб-API ASP.NET используется как для вызывающего клиента, так и для вызываемого API, однако показанные методы также можно применять к другим языкам и платформам, которые поддерживаются службой приложений Azure. Приведенный здесь код клиента — это стандартный код Azure Active Directory, предназначенный для получения и передачи токена носителя для учетной записи службы. Не требуется использование специального кода для Azure, в отличие, например, от обработки токена Zumo мобильных служб.

Это четвертое руководство в серии учебных материалов для работы с приложениями API в службе приложений Azure. Дополнительные сведения об этой серии см. в первом руководстве [Приступая к работе с приложениями API и ASP.NET в службе приложений Azure](app-service-api-dotnet-get-started.md). Дополнительные сведения о проверке подлинности и авторизации в службе приложений Azure см. в предыдущем руководстве этой серии [Проверка подлинности пользователя в приложениях API службы приложений Azure](app-service-api-dotnet-user-principal-auth.md).

## Другие варианты проверки подлинности с взаимодействием между службами

Сведения о том, как обработать сценарий взаимодействия между службами без применения проверки подлинности и авторизации службы приложений, а, например, при помощи сертификатов клиента, см. в разделе [Дальнейшие действия](#next-steps).

## Пример проекта CompanyUsers.API

При работе с этим руководством вы воспользуетесь примерами проектов, которые были скачаны в [первом руководстве из этой серии](app-service-api-dotnet-get-started.md), и ресурсами Azure (приложением API и веб-приложением), созданными при работе с предыдущими руководствами.

CompanyUsers.API — простой проект веб-API, содержащий один метод GET, который возвращает жестко заданный список контактов. Для демонстрации сценария взаимодействия служб метод GET в ContactsList.API вызывает метод GET в CompanyContacts.API и добавляет полученные контакты к тем, которые содержатся в его хранилище данных, а затем возвращает объединенный список.

Ниже приведено использование метода GET в CompanyUsers.API.

		public async Task<IEnumerable<Contact>> Get()
		{
		    var contacts = new Contact[]{
		                new Contact { Id = 1, EmailAddress = "nancy@contoso.com", Name = "Nancy Davolio"},
		                new Contact { Id = 2, EmailAddress = "alexander@contoso.com", Name = "Alexander Carson"}
		            };
		
		    return contacts;
		}


А здесь приведен код, в котором метод GET в ContactsList.API вызывает CompanyContacts.API и добавляет результаты к тем данным, которые он возвращает. (Для наглядности часть кода опущена.)

		private async Task<IEnumerable<Contact>> GetContacts()
		{
		    var contacts = await _storage.Get(FILENAME);
		
		    var contactsList = contacts.ToList<Contact>();
		    using (var client = CompanyContactsAPIClientWithAuth())
		    {
		        var results = await client.Contacts.GetAsync();
		        foreach (Contact c in results)
		        {
		            contactsList.Add(c);
		        }
		    }
		
		    return contactsList;
		}

Клиентский объект для CompanyContacts.API — это модификация созданного кода клиента приложения API, в которой к HTTP-запросу добавлен токен.

		private static CompanyContactsAPI CompanyContactsAPIClientWithAuth()
		{
		    var client = new CompanyContactsAPI(new Uri(ConfigurationManager.AppSettings["CompanyContactsAPIUrl"]));
		    client.HttpClient.DefaultRequestHeaders.Authorization =
		        new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
		    return client;
		}

## Создание приложения API в Azure и развертывание в нем проекта CompanyContacts.API

1. В **обозревателе решений** щелкните правой кнопкой мыши проект CompanyContacts.API и нажмите кнопку **Опубликовать**.

3.  На шаге **Профиль** мастера **веб-публикации** щелкните **Служба приложений Microsoft Azure**.

	![](./media/app-service-api-dotnet-service-principal-auth/selectappservice.png)

4. Войдите в учетную запись Azure, если вы этого еще не сделали, или обновите учетные данные, если срок их действия истек.

4. В диалоговом окне службы приложений в поле **Подписка** выберите подписку Azure, которую нужно использовать, и нажмите кнопку **Создать**.

	![](./media/app-service-api-dotnet-service-principal-auth/clicknew.png)

3. В диалоговом окне **Создание службы приложений** на вкладке **Размещение** щелкните **Изменить тип**, а затем — **Приложение API**.

4. В поле **Имя приложения API** введите имя, которое является уникальным в домене *azurewebsites.net*.

6. В раскрывающемся списке **Группа ресурсов** выберите группу ресурсов, которая использовалась при прохождении этих руководств.

4. В раскрывающемся списке **План службы приложений** выберите план, который использовался при прохождении этих руководств.

7. Щелкните **Создать**.

	![](./media/app-service-api-dotnet-service-principal-auth/createappservice.png)

	Visual Studio создает приложение API и профиль публикации со всеми настройками, необходимыми для нового приложения API.

8. На вкладке **Подключение** мастера **веб-публикации** нажмите кнопку **Опубликовать**.

	![](./media/app-service-api-dotnet-service-principal-auth/conntab.png)

	Visual Studio развертывает проект в новом приложении API и выполняет переход по URL-адресу приложения API в браузере. В браузере откроется страница с сообщением «Успешно создано».

9. Закройте браузер.

## Обновление созданного кода клиента в проекте ContactsList.API

В проекте ContactsList.API уже есть созданный код клиента, но его нужно удалить и создать заново из собственного приложения API.

1. В **обозревателе решений** Visual Studio в проекте ContactsList.API удалите папку *CompanyContactsAPI*.

2. Щелкните правой кнопкой мыши проект ContactsList.API и щелкните **Добавить > Клиент REST API**.

3. В диалоговом окне **Добавление клиента REST API** щелкните **Скачать из приложения API Microsoft Azure**, а затем нажмите кнопку **Обзор**.

8. В диалоговом окне **Службы приложений** разверните группу ресурсов, которую вы используете в этом руководстве, а затем выберите только что созданное приложение API.

10. Нажмите кнопку **ОК**.

9. В диалоговом окне **Добавление клиента REST API** нажмите кнопку **ОК**.

	Visual Studio создает папку с именем приложения API и классы клиента.

## Обновление кода в ContactsList.API и развертывание проекта

Код в ContactsList.API, вызывающий CompanyContacts.API, закомментирован при работе с предыдущими руководствами. В этом разделе вы раскомментируете этот код и развернете приложение.

1. В проекте ContactsList.API откройте *Controllers/ContactsController.cs*.

2. В верхней части класса `ContactsController` в коде, который использует созданный клиентский класс для добавления токена авторизации, замените имя класса `CompanyContactsAPI` на имя класса, созданного из приложения API.

	Например, если имя приложения API — CompanyContactsAPI3, код будет выглядеть следующим образом:

		 private static CompanyContactsAPI3 CompanyContactsAPIClientWithAuth()
		 {
		     var client = new CompanyContactsAPI3(new Uri(ConfigurationManager.AppSettings["CompanyContactsAPIUrl"]));
		     client.HttpClient.DefaultRequestHeaders.Authorization =
		         new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
		     return client;
		 }
 
4. В методе GET раскомментируйте блок кода, который использует клиентский объект, возвращенный `CompanyContactsAPIClientWithAuth`.

		using (var client = CompanyContactsAPIClientWithAuth())
		{
		    var results = await client.Contacts.GetAsync();
		    foreach (Contact c in results)
		    {
		        contactsList.Add(c);
		    }
		}

2. Щелкните правой кнопкой мыши проект ContactsList.API и нажмите кнопку **Опубликовать**.

	В мастере **веб-публикации** откроется профиль публикации, который вы использовали ранее.

3. В мастере **Публикация веб-сайтов** щелкните **Опубликовать**.

## Настройка проверки подлинности и авторизации в Azure для нового приложения API

1. На [портале Azure](https://portal.azure.com/) перейдите к колонке приложения API, созданного в этом руководстве для проекта CompanyContacts.API, и нажмите кнопку **Параметры**.

2. Найдите раздел **Функции** и щелкните **Проверка подлинности и авторизация**.

3. В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**.

4. В раскрывающемся списке **Действие, выполняемое, если запрос не прошел проверку подлинности** выберите **Войти с помощью Azure Active Directory**.

5. В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**.

6. В колонке **Параметры Azure Active Directory** щелкните **Автоматическое**.

	Azure автоматически создаст приложение AAD в клиенте AAD. Запишите имя нового приложения AAD, поскольку позже вам необходимо будет выбрать его после перехода на классический портал Azure для получения идентификатора клиента.

7. Нажмите кнопку **ОК**.

10. В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.
 
11. На [классическом портале Azure](https://manage.windowsazure.com/) перейдите в раздел **Azure Active Directory**.

12. На вкладке **Каталог** щелкните свой клиент AAD.

14. Щелкните **Приложения > Приложение, принадлежащее моей компании**, а затем установите флажок.

15. В списке приложений щелкните имя приложения, созданного в Azure после того, как вы активировали проверку подлинности для приложения API.

16. Нажмите **Настроить**.

15. В нижней части страницы щелкните **Управление манифестом > Загрузить манифест** и сохраните файл в расположении, в котором его можно изменить.

16. В скачанном файле манифеста найдите свойство `oauth2AllowImplicitFlow`. Измените значение этого свойства с `false` на `true`, а затем сохраните файл.

16. Щелкните **Управление манифестом > Отправить манифест** и отправьте файл, который был обновлен на предыдущем шаге.

17. Оставьте эту страницу открытой, чтобы можно было копировать из и вставлять данные в нее и обновлять значения на странице при выполнении дальнейших шагов этого руководства.

## Обновление настроек в приложении API, которое выполняет код проекта ContactsList.API

1. На [портале Azure](https://portal.azure.com/) перейдите к колонке приложения API, в которое развернут проект ContactsList.API. Это вызывающее приложение API, а не только что созданное вызываемое приложение.

2. Щелкните элементы **Параметры > Параметры приложения**.

	Здесь вы добавите некоторые параметры, но сначала их нужно получить с другой страницы классического портала Azure.

3. На [классическом портале Azure](https://manage.windowsazure.com/) перейдите на вкладку **Настройка** приложения AAD, созданного для приложения API ContactsList.API.

5. В разделе **ключей** в раскрывающемся списке **Выбрать длительность** выберите **1 год**.

6. Щелкните **Сохранить**.

	![](./media/app-service-api-dotnet-service-principal-auth/genkey.png)


7. Скопируйте значение ключа.

	![](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

3. В колонке **Параметры приложения** портала Azure в разделе **Параметры приложения** добавьте ключ с именем ida:ClientSecret и вставьте только что созданный ключ в поле значения.

3. На классическом портале Azure перейдите на вкладку **Настройка** приложения AAD, созданного для приложения API CompanyContacts.API.

4. Скопируйте код клиента.

3. В колонке **Параметры приложения** портала Azure в разделе **Параметры приложения** добавьте ключ с именем ida:Resource и вставьте только что скопированный идентификатор клиента в поле значения.

4. Добавьте ключ с именем CompanyContactsAPIUrl, а в поле значения введите https://{your имя приложения api}.azurewebsites.net, например: https://companycontactsapi.azurewebsites.net.

6. Щелкните Сохранить.

	![](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

## Тестирование в Azure

1. Перейдите по URL-адресу веб-приложения, в котором развернут проект ContactsList.Angular.AAD.

2. Щелкните вкладку **Контакты** и войдите в систему.

	Появится страница контактов с дополнительными контактами, которые получены из приложения API CompanyContacts.API.

	![](./media/app-service-api-dotnet-service-principal-auth/contactspagewithdavolio.png)

## Дальнейшие действия

Это последнее руководство в серии учебных материалов для работы с приложениями API. В данном разделе приведены ресурсы для получения дополнительных сведений о работе с приложениями API.

* Другие способы использования приложений API, защищенных с помощью проверки подлинности и авторизации службы приложений Azure.

	В этой статье показано, как защитить приложение API и вызвать его через код, выполняющийся в другом приложении API. Сведения о том, как вызывать защищенное приложение API из приложения логики, см. в статье [Использование настраиваемого интерфейса API, размещенного в службе приложений, с приложениями логики](../app-service-logic/app-service-logic-custom-hosted-api.md).

* Другие способы защиты приложений API для сценариев взаимодействия служб

	В качестве альтернативы проверке подлинности и авторизации службы приложений можно защитить приложение API путем использования клиентских сертификатов или обычной проверки подлинности. Сведения о клиентских сертификатах в Azure см. в статье [Настройка взаимной проверки подлинности TLS для веб-приложения](../app-service-web/app-service-web-configure-tls-mutual-auth.md).

* Другие способы развертывания приложения службы приложений

	Сведения о других способах развертывания веб-проектов в веб-приложениях с помощью Visual Studio или функции [автоматизации развертывания](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) из [системы управления версиями](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) см. в разделе [Развертывание веб-приложения Azure](web-sites-deploy.md).

	Visual Studio может также создавать скрипты Windows PowerShell, которые можно использовать для автоматизации развертывания. Дополнительные сведения см. в разделе [Полная автоматизация (создание реальных облачных приложений в Azure)](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/automate-everything).

* Способы устранения неполадок в приложении службы приложений

	Visual Studio предоставляет функции, упрощающие просмотр журналов Azure по мере их создания в режиме реального времени. Можно также работать в Azure удаленно в режиме отладки. Дополнительную информацию см. в разделе [Устранение неполадок веб-приложений Azure в Visual Studio](web-sites-dotnet-troubleshoot-visual-studio.md).

* Добавление настраиваемого доменного имени и SSL

	Информацию об использовании SSL и собственного домена (например, www.contoso.com вместо contoso.azurewebsites.net) см. в следующих статьях.

	* [Настройка личного доменного имени в службе приложений Azure](web-sites-custom-domain-name.md)
	* [Включение HTTPS для веб-приложения Azure](web-sites-configure-ssl-certificate.md)

<!---HONumber=AcomDC_1203_2015-->