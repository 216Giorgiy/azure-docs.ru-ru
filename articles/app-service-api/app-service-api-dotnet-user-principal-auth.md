<properties
	pageTitle="Проверка подлинности пользователей для приложений API в службе приложений Azure | Microsoft Azure"
	description="Узнайте, как защитить приложение API в службе приложений Azure путем предоставления доступа только тем пользователям, которые прошли проверку подлинности."
	services="app-service\api"
	documentationCenter=".net"
	authors="tdykstra"
	manager="wpickett"
	editor=""/>

<tags
	ms.service="app-service-api"
	ms.workload="na"
	ms.tgt_pltfrm="dotnet"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="01/26/2016"
	ms.author="tdykstra"/>

# Проверка подлинности пользователя для приложений API в службе приложений Azure

[AZURE.INCLUDE [selector](../../includes/app-service-api-auth-selector.md)]

## Обзор

Из этой статьи вы узнаете следующее.

* Как защитить приложение API службы приложений, чтобы к нему могли обращаться только пользователи, прошедшие проверку подлинности.
* Как настроить поставщик проверки подлинности с помощью сведений для Azure Active Directory (Azure AD).
* Как использовать защищенные приложения API с помощью [библиотеки проверки подлинности Active Directory (ADAL) для JavaScript](https://github.com/AzureAD/azure-activedirectory-library-for-js).

Статья содержит два раздела.

* В разделе [Настройка проверки подлинности пользователей в службе приложений Azure](#authconfig) содержатся общие инструкции по настройке проверки подлинности пользователя для любого приложения API. Они одинаково применимы ко всем платформам, которые поддерживаются службой приложений, включая .NET, Node.js и Java.

* [Оставшаяся часть статьи](#tutorialstart) представляет собой руководство, которое поможет настроить в примере приложения .NET, работающего в службе приложений, проверку подлинности пользователей с использованием Azure Active Directory.

## <a id="authconfig"></a> Настройка проверки подлинности пользователей в службе приложений Azure

Этот раздел содержит общие инструкции, которые применимы к любому приложению API. Конкретные инструкции для примера приложения .NET To Do List см. в разделе [Продолжение руководств по началу работы с .NET](#tutorialstart).

1. На [портале Azure](https://portal.azure.com/) перейдите к колонке **Приложение API** для приложения, которое нужно защитить, и щелкните **Параметры**.

2. В колонке **Параметры** найдите раздел **Функции** и щелкните элемент **Аутентификация или авторизация**.

	![](./media/app-service-api-dotnet-user-principal-auth/features.png)

3. В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**

4. Выберите один из вариантов в раскрывающемся списке **Предпринимаемое действие, если проверка подлинности для запроса не выполнена**.

	* Если требуется, чтобы приложения API достигали только прошедшие проверку вызовы, выберите один из вариантов **входа в систему**. Этот параметр позволяет защитить приложение API без написания кода, который выполняется в нем.

	* Если требуется, чтобы все вызовы API достигали приложения, выберите **Разрешить запрос (нет действия)**. С помощью этого параметра можно направлять непроверенные вызывающие стороны к различным поставщикам проверки подлинности. В этом случае необходимо написать код для обработки авторизации.

	Дополнительные сведения см. в статье [Проверка подлинности и авторизация для приложений API в службе приложений Azure](app-service-api-authentication.md#multiple-protection-options).

5. Выберите один или несколько **поставщиков проверки подлинности**.

	На изображении показаны параметры, при выборе которых все вызывающие стороны должны проходить проверку подлинности в Azure AD.
 
	![](./media/app-service-api-dotnet-user-principal-auth/authblade.png)

	Если выбрать поставщик проверки подлинности, на портале отобразится колонка конфигурации для данного поставщика.

	Подробные инструкции, в которых объясняется, как настроить колонки конфигурации для поставщика проверки подлинности, см. в статье [Настройка приложения службы приложений для использования службы входа Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md). (Ссылка указывает на статью об Azure AD, но сама статья содержит вкладки, ведущие на статьи, посвященные другим поставщикам проверки подлинности).

7. Когда закончите настраивать колонку поставщика проверки подлинности, нажмите кнопку **ОК**.

7. В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.

После этого служба приложений начнет проверять подлинность всех вызовов API, прежде чем они достигнут приложения API. Службы проверки подлинности работают одинаково для всех языков, которые поддерживает служба приложений, в том числе .NET, Node.js и Java.

Чтобы выполнять проверенные на подлинность вызовы API, вызывающая сторона должна включать токен носителя OAuth 2.0 поставщика проверки подлинности в заголовок авторизации HTTP-запросов. Этот токен можно получить с помощью пакета SDK поставщика проверки подлинности.

## <a id="tutorialstart"></a> Продолжение руководств по началу работы с .NET

Если вы изучаете серию руководств для приложений API по началу работы с Node.js или Java, перейдите к статье [Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure](app-service-api-dotnet-service-principal-auth.md).

Если вы изучаете серию руководств для приложений API по началу работы с .NET и уже развернули пример приложения в соответствии с [первым](app-service-api-dotnet-get-started.md) и [вторым](app-service-api-cors-consume-javascript.md) руководством, перейдите к разделу [Настройка проверки подлинности](#azureauth).

Если вы хотите пройти это руководство, но не знакомы с первым и вторым, сначала выполните все [предварительные требования](app-service-api-dotnet-get-started.md#prerequisites) для этой серии. Затем выполните следующие действия, чтобы скачать и развернуть пример приложения. Это те же действия, что и в предыдущих двух руководствах, но здесь инструкции приводятся в сокращенном виде.

1. Скачайте пример приложения.

	а. Скачайте пример из репозитория [Azure-Samples/app-service-api-dotnet-todo-list](https://github.com/Azure-Samples/app-service-api-dotnet-to-do-list).

	а. Откройте решение ToDoList в Visual Studio 2015 и выполните сборку решения, чтобы восстановить пакеты NuGet.

2. Разверните проект ToDoListDataAPI в новом приложении API.

	а. Откройте в проекте ToDoListDataAPI файл *App\_Start/SwaggerConfig.cs* и раскомментируйте код **EnableSwaggerUi**.

	b. В **обозревателе решений** щелкните правой кнопкой мыши проект ToDoListDataAPI и выберите пункт **Опубликовать**.

	c. В мастере **веб-публикации** на вкладке **Профиль** щелкните **Служба приложений Microsoft Azure**.

	г) В диалоговом окне **Служба приложений** в поле **Подписка** выберите подписку Azure, которую хотите использовать, и нажмите кнопку **Создать**.

	д. В диалоговом окне **Создание службы приложений** на вкладке **Размещение** щелкните **Изменить тип**, а затем — **Приложение API**.

	Е. Введите **имя приложения API** например ToDoListDataAPI, вместе с номером, который сделает его уникальным в домене *azurewebsites.net*, например, ToDoListDataAPI1230.

	g. В раскрывающемся списке **Группа ресурсов** введите имя, например TodoListGroup, чтобы создать новую группу ресурсов.

	h. В раскрывающемся списке **План службы приложений** щелкните **Создать** и введите необходимые данные в диалоговом окне **Настройка плана службы приложений**.

	i. Щелкните **Создать**.

	j. Щелкните **Опубликовать**.

3. Разверните проект ToDoListAPI в новом приложении API.

	а. В проекте ToDoListAPI откройте файл *Controllers\\ToDoListController.cs* и измените `http://localhost:45914` на `https://{your ToDoListDataAPI app name}.azurewebsites.net`.

	b. Чтобы развернуть проект ToDoListAPI, выполните ту же процедуру, что и для развертывания проекта ToDoListDataAPI. Не забудьте изменить тип на **Приложение API**.

4. Разверните проект ToDoListAngular в новом веб-приложении.

	а. В проекте ToDoListAngular откройте файл *app/scripts/todoListSvc.js*.

	b. Закомментируйте строку, которая задает `apiEndpoint` в качестве URL-адреса localhost, раскомментируйте строку, которая задает `apiEndPoint` в качестве URL-адреса azurewebsites.net, и замените заполнитель фактическим именем приложения API, которое вы создали для проекта ToDoListAPI.

	c. Чтобы развернуть проект ToDoListAPI, выполните ту же процедуру, что и для развертывания проекта ToDoListDataAPI, **но не изменяйте тип с "Веб-приложение" на "Приложение API"**.

5. Настройте CORS для приложения API в Azure.

	а. Перейдете на [портал Azure](https://portal.azure.com/) и найдите приложение API, созданное для проекта ToDoListAPI.

	b. В колонке **Приложение API** выберите элемент **Параметры**.

	c. В разделе **API** щелкните **CORS**.

	г) В текстовом поле введите URL-адрес, с которого следует разрешить вызовы. В этом руководстве используется URL-адрес веб-приложения, созданного для проекта ToDoListAngular. Например, введите https://todolistangular.azurewebsites.net.

	д. Щелкните **Сохранить**.

6. Откройте в браузере URL-адрес HTTPS для веб-приложения и проверьте, можно ли просматривать, добавлять, изменять и удалять элементы списка дел.

## <a id="azureauth"></a> Настройка проверки подлинности в Azure

На данный момент ваше приложение работает в службе приложений Azure, и проверка подлинности пользователей не требуется. В этом разделе мы добавим проверку подлинности, выполнив следующие задачи.

* Настроим в службе приложений требование проверки подлинности в Azure Active Directory (Azure AD) для вызова приложения API среднего уровня.
* Создадим приложение Azure AD.
* Настроим приложение Azure AD для отправки токена носителя после входа во внешнее приложение AngularJS. 

### Настройка проверки подлинности в службе приложений

1. На [портале Azure](https://portal.azure.com/) перейдите к колонке **Приложение API** приложения, созданного для проекта ToDoListAPI.

2. Щелкните **Settings** (Параметры).

2. В колонке **Параметры** найдите раздел **Функции** и щелкните элемент **Аутентификация или авторизация**.

	![](./media/app-service-api-dotnet-user-principal-auth/features.png)

3. В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**

4. В раскрывающемся списке **Действие, выполняемое, если запрос не прошел проверку подлинности** выберите **Войти с помощью Azure Active Directory**.

	Этот параметр гарантирует, что запросы, не прошедшие проверку подлинности, не достигнут приложения API.

5. В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**.

	![](./media/app-service-api-dotnet-user-principal-auth/authblade.png)

6. В колонке **Параметры Azure Active Directory** щелкните **Автоматическое**.

	![](./media/app-service-api-dotnet-user-principal-auth/aadsettings.png)

	Если выбран параметр **Экспресс**, служба приложений может автоматически создать приложение Azure AD в [клиенте](https://msdn.microsoft.com/ru-RU/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant) Azure AD.

	Вам не нужно создавать клиент, так как каждая учетная запись Azure автоматически содержит клиент.

7. В разделе **Режим управления** щелкните **Создать новое приложение AD**.

	Портал заполняет поле ввода **Создание приложения** значением по умолчанию.
	
	![](./media/app-service-api-dotnet-user-principal-auth/aadsettings2.png)

8. Запишите значение, которое находится в поле ввода **Создание приложения**. Это приложение AAD понадобится вам позже на классическом портале Azure.

	Azure автоматически создаст приложение Azure AD в клиенте Azure AD. По умолчанию приложение Azure AD называется так же, как приложение API. Вы можете ввести другое имя.
 
7. Нажмите кнопку **ОК**.

7. В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.

Теперь приложение API смогут вызвать только пользователи в клиенте Azure AD.

### Тестирование приложения API (необязательно)

1. В браузере перейдите по URL-адресу приложения API. Для этого в колонке **Приложение API** на портале Azure щелкните ссылку в разделе **URL-адрес**.  

	Вы будете перенаправлены на экран входа, так как запросы, не прошедшие проверку подлинности, не могут получать доступ к приложению API.

	Если браузер перенаправляет вас на страницу с сообщением "Успешно создано", возможно, он уже вошел в приложение. В таком случае откройте окно InPrivate или анонимное окно и перейдите по URL-адресу приложения API.

2. Войдите с помощью учетных данных, используемых в клиенте Azure AD.

	Когда вы войдете, в браузере откроется страница с сообщением "Успешно создано".

9. Закройте браузер.

### Настройка приложения Azure AD

При настройке проверки подлинности в Azure AD служба приложений автоматически создала приложение Azure AD. По умолчанию новое приложение Azure AD было настроено для предоставления токена носителя URL-адресу приложения API. В этом разделе мы настроим приложение Azure AD таким образом, чтобы токен носителя предоставлялся внешнему приложению AngularJS, а не непосредственно приложению API среднего уровня. Внешнее приложение AngularJS отправит токен приложению API при вызове приложения API.

11. На [классическом портале Azure](https://manage.windowsazure.com/) перейдите в раздел **Azure Active Directory**.

	Нужно использовать именно классический портал, так как в текущей версии портала Azure еще не доступны некоторые параметры Azure Active Directory, которые нам нужны.

12. На вкладке **Каталог** щелкните свой клиент AAD.

	![](./media/app-service-api-dotnet-user-principal-auth/selecttenant.png)

14. Щелкните **Приложения > Приложения, принадлежащие моей компании**, а затем установите флажок.

	Кроме того, может потребоваться обновить страницу, чтобы увидеть новое приложение.

15. В списке приложений щелкните имя приложения, созданного в Azure после того, как вы активировали проверку подлинности для приложения API.

	![](./media/app-service-api-dotnet-user-principal-auth/appstab.png)

16. Нажмите **Настроить**.

	![](./media/app-service-api-dotnet-user-principal-auth/configure.png)

17. Для параметра **URL-адрес входа** укажите URL-адрес веб-приложения AngularJS без косой черты в конце.

	Например: https://todolistangular.azurewebsites.net

	![](./media/app-service-api-dotnet-user-principal-auth/signonurlazure.png)

17. Для параметра **URL-адрес ответа** укажите URL-адрес веб-приложения без косой черты в конце.

	Например: https://todolistsangular.azurewebsites.net

16. Щелкните **Сохранить**.

	![](./media/app-service-api-dotnet-user-principal-auth/replyurlazure.png)

15. В нижней части страницы щелкните **Управление манифестом > Загрузить манифест**.

	![](./media/app-service-api-dotnet-user-principal-auth/downloadmanifest.png)

17. Загрузите файл в папку, где его можно будет отредактировать.

16. В скачанном файле манифеста найдите свойство `oauth2AllowImplicitFlow`. Измените значение этого свойства с `false` на `true`, а затем сохраните файл.

	Это нужно для того, чтобы был возможен доступ из одностраничного приложения JavaScript. При таком значении параметра токен носителя Oauth 2.0 возвращается в виде фрагмента URL-адреса.

16. Щелкните **Управление манифестом > Отправить манифест** и отправьте файл, который был обновлен на предыдущем шаге.

17. Скопируйте значение **Идентификатор клиента** и сохраните его, чтобы использовать позже.

## Настройка проекта ToDoListAngular для использования проверки подлинности

В этом разделе мы изменим внешнее приложение AngularJS таким образом, чтобы токен носителя для вошедшего пользователя из Azure AD можно было получить с помощью библиотеки проверки подлинности Active Directory (ADAL) для JS. Код будет включать токен в HTTP-запросы, отправляемые приложению среднего уровня, как показано на следующей схеме.

![](./media/app-service-api-dotnet-user-principal-auth/appdiagram.png)

Внесите следующие изменения в файлы проекта ToDoListAngular.

1. Откройте файл *index.html*.

2. Раскомментируйте строки, которые ссылаются на библиотеку проверки подлинности Active Directory (ADAL) для скриптов JS.

		<script src="app/scripts/adal.js"></script>
		<script src="app/scripts/adal-angular.js"></script>

1. Откройте файл *app/scripts/app.js*.

2. Закомментируйте блок кода с пометкой "без проверки подлинности" и раскомментируйте блок кода с пометкой "с проверкой подлинности".

	Это изменение ссылается на поставщик проверки подлинности ADAL JS и предоставляет ему значения конфигурации. В следующих шагах мы зададим значения конфигурации для приложения API и приложения Azure AD.

8. В коде, который задает переменную `endpoints`, в качестве URL-адреса API задайте URL-адрес приложения API, созданного для проекта ToDoListAPI, а в качестве идентификатора приложения Azure AD задайте идентификатор клиента, скопированный на классическом портале Azure.

	Код будет выглядеть примерно следующим образом:

		var endpoints = {
		    "https://todolistapi0121.azurewebsites.net/": "1cf55bc9-9ed8-4df31cf55bc9-9ed8-4df3"
		};

9. В вызове к `adalProvider.init` для параметра `tenant` задайте имя клиента, а для параметра `clientId` — значение, которое мы использовали в предыдущем шаге.

	Код будет выглядеть примерно следующим образом:

		adalProvider.init(
		    {
		        instance: 'https://login.microsoftonline.com/', 
		        tenant: 'contoso.onmicrosoft.com',
		        clientId: '1cf55bc9-9ed8-4df31cf55bc9-9ed8-4df3',
		        extraQueryParameter: 'nux=1',
		        endpoints: endpoints
		    },
		    $httpProvider
		    );

	Эти изменения в файле `app.js` указывают, что вызывающий код и вызываемый API находятся в одном приложении Azure AD.

1. Откройте файл *app/scripts/homeCtrl.js*.

2. Закомментируйте блок кода с пометкой "без проверки подлинности" и раскомментируйте блок кода с пометкой "с проверкой подлинности".

1. Откройте файл *app/scripts/indexCtrl.js*.

2. Закомментируйте блок кода с пометкой "без проверки подлинности" и раскомментируйте блок кода с пометкой "с проверкой подлинности".

### Развертывание проекта ToDoListAngular в Azure

8. В **обозревателе решений** щелкните проект ToDoListAngular правой кнопкой мыши и выберите пункт **Опубликовать**.

9. Щелкните **Опубликовать**.

	Visual Studio развернет проект и откроет в браузере базовый URL-адрес веб-приложения.

	Тем не менее перед тестированием приложения вам придется внести некоторые изменения в приложение API среднего уровня.

10. Закройте браузер.

## Настройка проекта ToDoListAPI для использования проверки подлинности

В настоящее время проект ToDoListAPI отправляет "*" в проект ToDoListDataAPI как значение параметра `owner`. В этом разделе мы изменим код для отправки идентификатора вошедшего пользователя.

Внесите следующие изменения в проект ToDoListAPI.

1. Откройте файл *Controllers/ToDoListController.cs* и раскомментируйте строку в каждом методе действия, который задает для параметра `owner` значение утверждения `NameIdentifier` в Azure AD. Например:

		owner = ((ClaimsIdentity)User.Identity).FindFirst(ClaimTypes.NameIdentifier).Value;

### Развертывание проекта ToDoListAPI в Azure

8. В **обозревателе решений** щелкните правой кнопкой мыши проект ToDoListAPI и выберите пункт **Опубликовать**.

9. Щелкните **Опубликовать**.

	Visual Studio развернет проект и откроет в браузере базовый URL-адрес приложения API.

10. Закройте браузер.

### Тестирование приложения

9. Перейдите к URL-адресу веб-приложения **с помощью протокола HTTPS, а не HTTP**.

8. Откройте вкладку **Список дел**.

	Вам будет предложено войти.

9. Войдите с помощью учетных данных, используемых в клиенте AAD.

10. Откроется страница **Список дел**.

	![](./media/app-service-api-dotnet-user-principal-auth/webappindex.png)

	Элементы списка дел не отображаются, так как до этого момента все они принадлежали владельцу "*". Теперь приложение среднего уровня запрашивает элементы для вошедшего пользователя, но они пока не созданы.

11. Добавьте новые элементы списка дел, чтобы убедиться, что приложение работает.

12. В другом окне браузера перейдите к URL-адресу пользовательского интерфейса Swagger для приложения API ToDoListDataAPI и щелкните **ToDoList > Получить**. Введите звездочку как значение параметра `owner`, а затем щелкните **Попробовать**.

	Ответ показывает, что в новых элементах списка дел в свойстве Owner указывается фактический идентификатор пользователя Azure AD.

	![](./media/app-service-api-dotnet-user-principal-auth/todolistapiauth.png)


## Построение проектов с нуля

Эти два проекта веб-API созданы с помощью шаблона проекта **приложения API Azure** и путем замены контроллера значений по умолчанию контроллером ToDoList.

Сведения о создании одностраничного приложения AngularJS с помощью внутреннего приложения веб-API 2 см. в статье [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs) (Практикум: создание одностраничного приложения (SPA) с помощью веб-API ASP.NET и Angular.js). Дополнительные сведения о добавлении кода для проверки подлинности в Azure AD см. в следующих ресурсах.

* [Защита одностраничных приложений AngularJS с помощью Azure AD](../active-directory/active-directory-devquickstarts-angular.md)
* [Introducing ADAL JS v1](http://www.cloudidentity.com/blog/2015/02/19/introducing-adal-js-v1/) (Введение в ADAL JS, версия 1)

## Устранение неполадок

Если вы успешно запустили приложение без проверки подлинности, а после реализации проверки подлинности оно перестало работать, в большинстве случаев проблема заключается в неправильных или несогласованных параметрах конфигурации. Сначала перепроверьте все параметры в службе приложений Azure и Azure Active Directory. Вот несколько рекомендаций.

* В Azure AD на вкладке **Настройка** проверьте значение параметра **URL-адрес ответа**.
* В Azure AD скачайте манифест и убедитесь, что значение `oauth2AllowImplicitFlow` было успешно изменено на `true`. 
* В исходном коде AngularJS еще раз проверьте URL-адрес приложения API среднего уровня и идентификатор клиента Azure AD.
* После настройки кода в проекте убедитесь, что вы повторно развернули именно этот проект, а не какой-нибудь другой.
* Убедитесь, что вы переходите в браузере к URL-адресам HTTPS, а не HTTP.
* Убедитесь, что в приложении API среднего уровня по-прежнему включена поддержка CORS и разрешены вызовы к среднему уровню с внешнего URL-адреса HTTPS. Если вы сомневаетесь, связана ли проблема с CORS, попробуйте ввести "*" как URL-адрес разрешенного источника.
* Убедитесь, что вы получаете максимум информации в сообщениях об ошибках, [отключив режим customErrors](../app-service-web/web-sites-dotnet-troubleshoot-visual-studio.md#remoteview).
* Вкладка "Консоль средств разработчика" в браузере часто содержит дополнительные сведения об ошибках. Также можно проверить HTTP-запросы на вкладке "Сеть".

## Дальнейшие действия

Из этого руководства вы узнали, как использовать проверку подлинности в службе приложений для приложения API и как вызывать приложение API с помощью библиотеки ADAL JS. В следующем руководстве вы узнаете, как [обеспечить безопасный доступ к приложению API в сценариях взаимодействия между службами](app-service-api-dotnet-service-principal-auth.md).

<!---HONumber=AcomDC_0204_2016-->