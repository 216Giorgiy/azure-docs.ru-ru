<properties
	pageTitle="Создание и развертывание приложения API Node.js в службе приложений Azure"
	description="Узнайте, как создать пакет приложения API Node.js и развернуть его в службе приложений Azure."
	services="app-service\api"
	documentationCenter="node"
	authors="bradygaster"
	manager="mohisri"
	editor="tdykstra "/>

<tags
	ms.service="app-service-api"
	ms.workload="web"
	ms.tgt_pltfrm="na"
	ms.devlang="node"
	ms.topic="get-started-article"
	ms.date="02/25/2015"
	ms.author="bradygaster"/>

# Создание и развертывание приложения API Node.js в службе приложений Azure

[AZURE.INCLUDE [app-service-api-get-started-selector](../../includes/app-service-api-get-started-selector.md)]

## Предварительные требования
1. [Node.js](http://nodejs.org), выполняемый на компьютере, на котором ведется разработка (в этом примере предполагается, что установлена версия Node.js 4.2.2).
1. Учетная запись [GitHub](https://github.com/).
1. [Бесплатная пробная учетная запись](https://azure.microsoft.com/pricing/free-trial/) Microsoft Azure.
1. Git, установленный на рабочей станции, где ведется локальная разработка.

## Инструкции по установке
Необходимо выполнить команды ниже с помощью командной строки Node.js. Используя генератор Swaggerize Yo, можно сформировать базовый код Node.js, необходимый для обслуживания HTTP-запросов, определенных в JSON-файле Swagger, на основе скаффолдинга.
 
1. Установите модули NPM **yo** и **generator-swaggerize** глобально.

        npm install -g yo
	    npm install -g generator-swaggerize
		
1. Клонируйте [репозиторий GitHub, содержащий пример кода](https://github.com/Azure-Samples/app-service-api-node-contact-list).

		git clone https://github.com/Azure-Samples/app-service-api-node-contact-list.git
				
1. Выполните команду, чтобы сформировать интерфейс API на основе скаффолдинга, используя файл **api.json**, включенный в исходный код. Файл **api.json** — это файл Swagger, представляющий фактический интерфейс API, который будет сформирован на основе скаффолдинга с помощью команды yo swaggerize на следующем шаге.

        yo swaggerize
        
    **Примечание.** Файл API.json и файл *apiapp.json*, используемый в течение срока действия предварительной версии приложений API, — это разные файлы.

1. Модуль swaggerize сформирует обработчиков на основе скаффолдинга и настроит метаданные Swagger, содержащиеся в файле **api.json**. Во время процесса формирования на основе скаффолдинга необходимо будет указать различные данные, например имя пользователя и адрес электронной почты GitHub. Эти сведения используются для создания файла **package.json** в папке приложения. Из всех запросов, возникающих во время процесса формирования шаблонов на основе скаффолдинга, наиболее важный — запрос на выбор **express**, так как в этом примере кода для создания страницы справки Swagger будет использоваться обработчик представлений express при запуске приложения API в Azure (или локально).

	![Командная строка swaggerize](media/app-service-api-nodejs-api-app/swaggerize-command-line.png)
    
1. Перейдите в папку, в которой содержится код, сформированный на основе скаффолдинга (в данном случае в подпапку *ContactList*). Затем установите модуль NPM **jsonpath**.

        npm install --save jsonpath
        
    Результаты установки отобразятся в командной строке.

    ![Установка jsonpath](media/app-service-api-nodejs-api-app/jsonpath-install.png)

1. Установите модуль NPM **swaggerize-ui**.

        npm install --save swaggerize-ui
        
    Результаты установки отобразятся в командной строке.

    ![Установка пользовательского интерфейса swaggerize](media/app-service-api-nodejs-api-app/swaggerize-ui-install.png)

1. Скопируйте папку **lib** из папки **start** в папку **ContactList**, созданную с помощью компонента формирования на основе скаффолдинга.

1. Замените код в файле **handlers/contacts.js** на код ниже. Этот код использует данные JSON, хранящиеся в файле **lib/contacts.json**, который обрабатывается с помощью **lib/contactRepository.js**. Приведенный ниже новый код contats.js будет отвечать на HTTP-запросы для получения всех контактов с помощью этого кода.

        'use strict';
        
        var repository = require('../lib/contactRepository');
        
        module.exports = {
            get: function contacts_get(req, res) {
                res.json(repository.all())
            }
        };

1. Замените код в файле **handlers/contacts/{ИД}.js** на код ниже, который будет использовать **lib/contactRepository.js** для получения контактов, запрашиваемых с помощью HTTP-запроса, и возвращать их в виде полезных данных JSON.

        'use strict';

        var repository = require('../../lib/contactRepository');
        
        module.exports = {
            get: function contacts_get(req, res) {
                res.json(repository.get(req.params['id']));
            }    
        };

1. Замените код в файле **server.js** на код ниже. Обратите внимание, что изменения, внесенные в файл server.js, выделены с помощью комментариев, чтобы их можно было увидеть.

        'use strict';

        var port = process.env.PORT || 8000; // first change

        var http = require('http');
        var express = require('express');
        var bodyParser = require('body-parser');
        var swaggerize = require('swaggerize-express');
        var swaggerUi = require('swaggerize-ui'); // second change
        var path = require('path');

        var app = express();

        var server = http.createServer(app);

        app.use(bodyParser.json());

        app.use(swaggerize({
            api: path.resolve('./config/api.json'), // third change
            handlers: path.resolve('./handlers'),
            docspath: '/swagger' // fourth change
        }));

        // change four
        app.use('/docs', swaggerUi({
          docs: '/swagger'  
        }));

        server.listen(port, function () { // fifth change
            app.setHost(undefined); // sixth and final change
        });

1. Активируйте сервер с помощью исполняемого файла командной строки Node.js.

        node server.js

    После выполнения этой команды HTTP-сервер Node.js запустится и начнет обслуживать интерфейс API.

1. Если перейти по ссылке ****http://localhost:8000/contacts**, можно увидеть выходные данные списка контактов в формате JSON (или появится запрос на скачивание в зависимости от браузера).

    ![Вызов API всех контактов](media/app-service-api-nodejs-api-app/all-contacts-api-call.png)

1. Если перейти по ссылке ****http://localhost:8000/contacts/2**, можно увидеть контакт, представленный значением идентификатора.

    ![Вызов API определенного контакта](media/app-service-api-nodejs-api-app/specific-contact-api-call.png)

1. Данные JSON Swagger обрабатываются с помощью конечной точки **/swagger**:

    ![JSON-файл Swagger контактов](media/app-service-api-nodejs-api-app/contacts-swagger-json.png)

1. Пользовательский интерфейс Swagger обрабатывается с помощью конечной точки **/docs**. Для тестирования интерфейса API в пользовательском интерфейсе Swagger можно использовать расширенные возможности клиента HTML.

    ![Пользовательский интерфейс Swagger](media/app-service-api-nodejs-api-app/swagger-ui.png)

## Создание приложения API на портале Azure
В этом разделе рассматривается процесс создания пустого приложения API в Azure. Затем описывается процесс подключения приложения к репозиторию Git. Таким образом можно обеспечить непрерывную доставку изменений кода.

Код для развертывания будет помещен не в тот же репозиторий GitHub, из которого вы клонировали исходный код. В примере репозитория GitHub содержалось состояние запуска кода. Так как теперь сформировано состояние завершения кода на основе скаффолдинга, необходимо отправить этот код только в репозиторий Git, связанный с приложением API. Первый шаг — создать приложение API с помощью портала Azure. Затем необходимо:

1. Перейти на [портал Azure](https://portal.azure.com/). 

1. Создать приложение API.

    ![Портал нового приложения API](media/app-service-api-nodejs-api-app/new-api-app-portal.png)

1. Можно добавить новое приложение API в существующую группу ресурсов и/или план службы приложений либо создать группу ресурсов и план службы приложений, как показано на снимке экрана ниже.

    ![Колонка создания приложения API](media/app-service-api-nodejs-api-app/api-app-creation-blade.png)

1. После создания приложения API на портале перейдите к колонке, в которой содержатся параметры для приложения API, как показано ниже.

    ![Параметры навигации портала](media/app-service-api-nodejs-api-app/portal-nav-to-settings.png)

1. Щелкните элемент навигации **Учетные данные развертывания** в меню "Параметры". После открытия колонки добавьте имя пользователя и пароль, которые будут использоваться для публикации кода Node.js в приложение API. Затем нажмите кнопку **Сохранить** в колонке **Установка учетных данных развертывания**.

    ![Учетные данные развертывания](media/app-service-api-nodejs-api-app/deployment-credentials.png)

1. После настройки учетных данных развертывания можно создать репозиторий Git, связанный со службой приложений. Каждый раз при передаче кода в этот репозиторий служба приложений Azure будет получать изменения и развертывать их непосредственно в экземпляр приложения API. Чтобы создать репозиторий Git, который необходимо связать с сайтом, щелкните пункт меню **Непрерывное развертывание** в колонке меню "Параметры", как показано ниже. Затем в колонке **Выбор источника** выберите вариант **Локальный репозиторий Git**. После этого нажмите кнопку "ОК", чтобы создать репозиторий.

    ![Создание репозитория Git](media/app-service-api-nodejs-api-app/create-git-repo.png)

1. После создания репозитория Git вид колонки изменится и в ней будут отображаться активные развертывания. Так как репозиторий новый, в списке не должно быть активных развертываний.

    ![Нет активных развертываний](media/app-service-api-nodejs-api-app/no-active-deployments.png)

1. Последний шаг — скопировать URL-адрес репозитория Git из портала. Чтобы сделать это, перейдите к колонке нового приложения API и просмотрите раздел **Основные компоненты**. В разделе "Основные компоненты" должна отображаться строка **URL-адрес клона Git**. Рядом с ней отображается значок, который позволяет скопировать URL-адрес в буфер обмена. Щелкните этот значок, чтобы скопировать URL-адрес (кнопка появляется при наведении указателя мыши на URL-адрес), или выделите весь URL-адрес и скопируйте его в буфер обмена.

    ![Получите URL-адрес Git из портала](media/app-service-api-nodejs-api-app/get-the-git-url-from-the-portal.png)

    **Примечание**. Для выполнения следующего шага необходим URL-адрес клона Git, поэтому его нужно обязательно сохранить.

Теперь, когда создано приложение API, а репозиторий Git создает его резервную копию, можно перенести код в репозиторий и воспользоваться функциями непрерывного развертывания Azure, чтобы автоматически развернуть изменения.

## Развертывание кода приложения API в Azure
С помощью встроенных функций непрерывной доставки, предоставляемых службой приложений Azure, можно сохранить код в репозиторий Git, связанный со службой приложений. Azure получит исходный код и развернет его в приложение API.

1. Скопируйте папку **src/end/ContactList**, созданную с помощью компонента формирования на основе скаффолдинга swaggerize, на рабочий стол или в другую папку. Это необходимо сделать потому, что вы будете создавать локальный репозиторий Git для кода, который должен находиться за пределами главного репозитория, клонированного из GitHub, в котором содержится код запуска. 

1. Чтобы перейти в новую папку, используйте командную строку Node.js. После этого выполните следующую команду, чтобы создать локальный репозиторий Git.

        git init

    После его создания появится подтверждение об инициализации нового репозитория.

    ![Новый локальный репозиторий Git](media/app-service-api-nodejs-api-app/new-local-git-repo.png)

1. Используйте командную строку Node.js, чтобы выполнить следующую команду, которая добавит удаленный репозиторий Git в локальный репозиторий. Удаленный репозиторий — это только что созданный репозиторий, связанный с приложением API, запущенным в Azure.

        git remote add azure YOUR_GIT_CLONE_URL_HERE

    **Примечание**. Вам понадобиться заменить строку YOUR\_GIT\_CLONE\_URL\_HERE выше на URL-адрес вашего клона Git, скопированный ранее.

1. Затем необходимо выполнить следующие две команды из командной строки Node.js.

        git add .
        git commit -m "initial revision"

    По завершении окно командной строки должно выглядеть наподобие снимка экрана ниже.

    ![Фиксировать выходные данные в Git](media/app-service-api-nodejs-api-app/git-commit-output.png)

1. Выполните следующую команду в командной строке Node.js, чтобы отправить код в Azure, который активирует развертывание в приложение API. При появлении соответствующего запроса введите пароль, созданный ранее для учетных данных развертывания на портале Azure.

        git push azure master

1. Если вернуться к колонке **Непрерывное развертывание** приложения API, можно увидеть, что началось выполнение развертывания.

    ![Процесс развертывания](media/app-service-api-nodejs-api-app/deployment-happening.png)

    В это же время в командной строке Node.js отображается состояние процесса развертывания.

    ![Процесс развертывания Node.js](media/app-service-api-nodejs-api-app/node-js-deployment-happening.png)

1. После завершения развертывания в колонке **Непрерывное развертывание** отобразится сообщение об успешном развертывании изменений кода в приложение API. Скопируйте **URL-адрес** в раздел **Основные компоненты** колонки вашего приложения API.

    ![Развертывание завершено](media/app-service-api-nodejs-api-app/deployment-completed.png)

1. С помощью клиента REST API, например Postman или Fiddler (или веб-браузера), укажите URL-адрес вызова API контактов, который должен быть конечной точкой **/contacts** приложения API.

    **Примечание.** URL-адрес будет выглядеть примерно так: http://myapiapp.azurewebsites.net/contacts.

    При отправке запроса GET в эту конечную точку отобразятся выходные данные JSON приложения API.

    ![Postman отправляет вызовы API](media/app-service-api-nodejs-api-app/postman-hitting-api.png)

## Дальнейшие действия

Вы успешно создали и развернули свое первое приложение API с помощью Node.js. В следующем руководстве из серии "Приступая к работе с приложениями API" показано, как [использовать приложения API в клиентах JavaScript с помощью CORS](app-service-api-cors-consume-javascript.md).

Далее в обработчики в этом примере можно добавить код, который позволит хранить данные в базе данных или на диске экземпляра приложения API. Теперь, когда непрерывное развертывание настроено, изменить и расширить функциональные возможности приложения API также просто, как и изменить и переместить код в репозиторий Git.

<!---HONumber=AcomDC_0420_2016-->