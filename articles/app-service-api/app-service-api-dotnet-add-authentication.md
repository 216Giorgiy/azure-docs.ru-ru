<properties 
	pageTitle="Защита приложения API Azure" 
	description="Обеспечение защиты приложения API Azure с помощью Visual Studio." 
	services="app-service\api" 
	documentationCenter=".net" 
	authors="tdykstra" 
	manager="wpickett" 
	editor="jimbe"/>

<tags 
	ms.service="app-service-api" 
	ms.workload="web" 
	ms.tgt_pltfrm="dotnet" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="03/24/2015" 
	ms.author="tdykstra"/>

# Защита приложения API: добавление проверки подлинности Azure Active Directory или поставщика социальных сетей

## Обзор

В учебнике [Развертывание приложения API](app-service-dotnet-deploy-api-app.md) выполнялось развертывание приложения API с уровнем доступности **Доступно всем пользователям**. В этом учебнике показано, как защитить приложение API, чтобы к нему могли получить доступ только пользователи, прошедшие проверку подлинности.

Вы будете выполнять следующие действия.

- Вызов приложения API для проверки его работоспособности.
- Применение правил проверки подлинности к приложению API.
- Повторный вызов приложения API, чтобы убедиться, что оно отклоняет запросы, не прошедшие проверку подлинности.
- Вход в систему настроенного поставщика.
- Повторный вызов приложения API, чтобы убедиться, что доступ с проверкой подлинности работает.

## Предварительные требования

В этом учебнике используется приложение API, созданное на шаге [Создание приложения API](app-service-dotnet-create-api-app.md) и развернутое на шаге [Развертывание приложения API](app-service-dotnet-deploy-api-app.md).

## Использование браузера для вызова приложения API 

Самый простой способ проверки наличия общего доступа к приложению API — вызов его из браузера.

1. В браузере перейдите на [портал предварительной версии Azure].

3. На домашней странице последовательно щелкните пункты **Обзор > Приложения API**, а затем выберите имя приложения API, которое требуется защитить.

	![Обзор](./media/app-service-api-dotnet-add-authentication/browse.png)

	![Выбор приложения API](./media/app-service-api-dotnet-add-authentication/select.png)

3. В колонке **Приложение API** щелкните **URL-адрес**, чтобы открыть окно браузера, которое вызывает ваше приложение API.

	![Колонка приложения API](./media/app-service-api-dotnet-add-authentication/chooseapiappurl.png)

2. Добавьте `/api/contacts/get/` к URL-адресу в адресной строке браузера.

	Например, если URL-адрес приложения API следующий:

    	https://microsoft-apiappeeb5bdsasd744e188be7fa26f239bd4b.azurewebsites.net/

	Полный URL-адрес будет:

    	https://microsoft-apiappeeb5bdsasd744e188be7fa26f239bd4b.azurewebsites.net/api/contacts/get/

	Разные браузеры обрабатывают вызовы API по-разному. На изображении показан успешно выполненный вызов из браузера Chrome.

	![Ответ GET Chrome](./media/app-service-api-dotnet-add-authentication/chromeget.png)

2. Сохраните использованный URL-адрес; он потребуется далее в учебнике.

## Защита приложения API

Приложение API развертывается в группе ресурсов. Вы можете добавлять веб-приложения и другие приложения API в одну группу ресурсов, и каждое приложение API в этой группе ресурсов может иметь один из трех параметров доступности: <!--todo: diagram showing different accessibility settings-->

- **Общедоступный (анонимный)** — любой пользователь может вызвать приложение API за пределами группы ресурсов, не выполнив вход.
- **Общедоступный (с проверкой подлинности)** — только пользователи, прошедшие проверку подлинности, могут вызвать приложение API за пределами группы ресурсов.
- **Внутренний** — только другие приложения API или веб-приложения, находящиеся в той же группе ресурсов, могут вызывать это приложение API. (Вызовы из веб-приложений считаются внешними, даже если веб-приложения находятся в той же группе ресурсов.)

Когда Visual Studio создает группу ресурсов, также создается *шлюз*. Шлюз — это специальное веб-приложение, которое обрабатывает все запросы, предназначенные для приложений API в группе ресурсов.

Перейдя в колонку группы ресурсов на [портале предварительной версии Azure], вы можете увидеть ваше приложение API и шлюз на схеме.

![Схема группы ресурсов](./media/app-service-api-dotnet-add-authentication/rgdiagram.png)

### Настройка обязательной проверки подлинности в приложении API

Чтобы настроить в приложении API возможность принимать только запросы, прошедшие проверку подлинности, необходимо задать его уровень доступности **Общедоступный (с проверкой подлинности)** и настроить в шлюзе запрос проверки подлинности от поставщика, такого как Azure Active Directory, Google или Facebook.

1. Вернитесь в колонку **Приложение API** для приложения API, которое требуется защитить.

2. В колонке **Приложение API** щелкните пункт **Параметры**, а затем выберите пункт **Параметры приложения**.

	![Щелкните «Параметры»](./media/app-service-api-dotnet-add-authentication/clicksettings.png)

	![Щелкните «Параметры приложения»](./media/app-service-api-dotnet-add-authentication/clickbasicsettings.png)

3. В колонке **Параметры приложения** измените **уровень доступа** на **Общедоступный (с проверкой подлинности)**, а затем нажмите кнопку **Сохранить**.

	![Щелкните «Основные параметры»](./media/app-service-api-dotnet-add-authentication/setpublicauth.png)

	Теперь вы защитили приложение API от несанкционированного доступа. Далее в шлюзе потребуется указать, какого поставщика проверки подлинности следует использовать.

### <a id="gateway"></a>Настройка шлюза для использования поставщика проверки подлинности

4. Прокрутите экран влево к колонке **Приложение API** и щелкните ссылку на шлюз.

	![Выберите шлюз](./media/app-service-api-dotnet-add-authentication/gateway.png)

7. В колонке **Шлюз** щелкните пункт **Параметры**, а затем выберите **Удостоверение**.

	![Щелкните «Параметры»](./media/app-service-api-dotnet-add-authentication/clicksettingsingateway.png)

	![Щелкните «Удостоверение»](./media/app-service-api-dotnet-add-authentication/clickidentity.png)

	Из колонки **Удостоверение** можно переходить к другим колонкам для настройки проверки подлинности с помощью Azure Active Directory и некоторых других поставщиков.

	![Колонка «Удостоверение»](./media/app-service-api-dotnet-add-authentication/identityblade.png)
  
3. Выберите поставщика удостоверений, которого следует использовать, и выполните шаги в соответствующей статье, чтобы настроить приложение API с помощью того же поставщика. Эти статьи были написаны для мобильных приложений, но действия не отличаются от действий для приложений API. В некоторых процедурах требуется использовать [портал Azure].

 - [Учетная запись Майкрософт](../app-service-mobile/app-service-mobile-how-to-configure-microsoft-authentication-preview.md)
 - [Вход в Facebook](../app-service-mobile/app-service-mobile-how-to-configure-facebook-authentication-preview.md)
 - [Вход в Twitter](../app-service-mobile/app-service-mobile-how-to-configure-twitter-authentication-preview.md)
 - [Вход в Google](../app-service-mobile/app-service-mobile-how-to-configure-google-authentication-preview.md)
 - [Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication-preview.md)

Например, на следующих снимках экрана показано, что должно отображаться на страницах [Портала Azure] и в колонках [портала предварительной версии Azure] после настройки проверки подлинности Azure Active Directory.

На портале предварительной версии Azure в колонке **Azure Active Directory** содержится **идентификатор клиента** из приложения, созданного на вкладке «Azure Active Directory» портала Active, а в колонке **Разрешенные клиенты** содержится ваш клиент Azure Active Directory (например, contoso.onmicrosoft.com).

![Колонка Azure Active Directory](./media/app-service-api-dotnet-add-authentication/tdinaadblade.png)

На портале Azure на вкладке **Настройка** для приложения, созданного на вкладке **Azure Active Directory**, содержатся значения **URL-адрес единого входа**, **URI идентификатора приложения** и **URL-адрес ответа** из колонки **Azure Active Directory** на портале предварительной версии Azure.

![](./media/app-service-api-dotnet-add-authentication/oldportal1.png)

![](./media/app-service-api-dotnet-add-authentication/oldportal2.png)

![](./media/app-service-api-dotnet-add-authentication/oldportal3.png)

![](./media/app-service-api-dotnet-add-authentication/oldportal4.png)

(В поле «URL-адрес ответа», показанном на рисунке, один и тот же URL-адрес отображается дважды, один раз с префиксом `http:` и второй раз с префиксом `https:`.)

## Контроль работоспособности проверки подлинности

**Примечание.** Если при выполнении следующих действий возникают проблемы со входом, попробуйте открыть окно в закрытом или анонимном режиме.
 
1. Откройте окно браузера и введите в адресной строке URL-адрес, вызывающий метод `Get` приложения API, как вы делали это ранее.

	На этот раз при попытке доступа к приложению API появится сообщение об ошибке.

	![Сбой ответа GET Chrome](./media/app-service-api-dotnet-add-authentication/chromegetfail.png)

2. В браузере перейдите на URL-адрес входа. URL-адрес соответствует следующему шаблону:

    	http://[gatewayurl]/login/[providername]

	URL-адрес шлюза можно взять из колонки **Шлюз** на [портале предварительной версии Azure]. (Чтобы перейти в колонку **Шлюз**, щелкните шлюз на схеме, которая отображается в колонке **Группа ресурсов**.)

	![URL-адрес шлюза](./media/app-service-api-dotnet-add-authentication/gatewayurl.png)

	Параметр [providername] может иметь значение microsoftaccount, facebook, twitter, google или aad.

	Ниже приведен пример URL-адреса входа для Azure Active Directory.

		https://dropboxrgaeb4ae60b7cb4f3d966dfa43.azurewebsites.net/login/aad/

	Обратите внимание, что в отличие от предыдущего URL-адреса этот URL-адрес не включает имя приложения API: проверку подлинности выполняет шлюз, а не приложение API. Шлюз обрабатывает проверку подлинности для всех приложений API в группе ресурсов.

3. Введите учетные данные, когда в браузере откроется страница для входа.
 
	Если вы настроили вход в Azure Active Directory, используйте одного из пользователей, перечисленных на вкладке **Пользователи**, для приложения, созданного на вкладке Azure Active Directory [портала Azure], например admin@contoso.onmicrosoft.com.

	![Пользователи AAD](./media/app-service-api-dotnet-add-authentication/aadusers.png)

	![Страница входа](./media/app-service-api-dotnet-add-authentication/ffsignin.png)

4. После того как появится сообщение «вход выполнен», снова введите URL-адрес в метод GET приложения API.

	На этот раз вызов будет выполнен, так как вы прошли проверку подлинности. Шлюз распознает, что вы являетесь прошедшим проверку подлинности пользователем, и передаст запрос в приложение API.

	![Вход выполнен](./media/app-service-api-dotnet-add-authentication/logincomplete.png)

	![Ответ GET Chrome](./media/app-service-api-dotnet-add-authentication/chromeget.png)

## Использование Postman для отправки запроса POST

При входе в шлюз он возвращает токен проверки подлинности. Этот токен должен быть включен во все запросы из внешних источников, проходящих через шлюз. При получении доступа к API в браузере обычно браузер сохраняет токен в файл cookie и отправляет его вместе с последующими вызовами в API.

Таким образом, вы можете видеть, что происходит в фоновом режиме. В этом разделе учебника вы будете создавать и отправлять запрос POST с помощью браузера, а также получать токен проверки подлинности из файла cookie и включать его в заголовок HTTP. Этот раздел является необязательным: в предыдущем разделе вы уже проверяли, что приложение API принимает только доступ с проверкой подлинности.

В этих инструкциях показано, как использовать средство Postman в браузере Chrome, но то же самое можно сделать с помощью любого клиентского средства REST и средств разработчика браузера.

1. В окне браузера Chrome выполните действия для проверки подлинности, показанные в предыдущем разделе, а затем откройте средства разработчика (F12).

	![Перейдите на вкладку «Ресурсы»](./media/app-service-api-dotnet-add-authentication/resources.png)

3. На вкладке **Ресурсы** средств разработчика Chrome найдите файлы cookie для шлюза и трижды щелкните поле «Значение» файла cookie **x-zumo-auth**, чтобы выбрать все значения.

	**Примечание.** Убедитесь, что вы получите все значения этого файла cookie. Если щелкнуть дважды, то вы получите только первую часть их.

5. Щелкните правой кнопкой мыши поле **Значение** файла cookie **x-zumo-auth**, а затем выберите команду **Копировать**.

	![Копирование токена проверки подлинности](./media/app-service-api-dotnet-add-authentication/copyzumotoken.png)

4. Установите расширение Postman в браузере Chrome, если вы еще этого не сделали.

6. Откройте расширение Postman.

7. В поле «URL-адрес запроса» введите URL-адрес метода GET приложения API, использованный ранее, но удалите `get/` в конце.
 
		http://[apiappurl]/api/contacts
    
8. Щелкните элемент **Заголовки** и добавьте заголовок *x-zumo-auth*. Вставьте значение токена из буфера обмена в поле **Значение**.

9. Добавьте заголовок *Content-Type* со значением *application/json*.

10. Щелкните элемент **form-data**, а затем добавьте ключ *contact* со следующим значением:

		{   "Id": 0,   "Name": "Li Yan",   "EmailAddress": "yan@contoso.com" }

11. Нажмите кнопку «Отправить».

	Приложение API вернет ответ *201 Created*.

	![Добавление заголовков и текста](./media/app-service-api-dotnet-add-authentication/addcontact.png)

12. Чтобы убедиться, что этот запрос не будет работать без токена проверки подлинности, удалите заголовок проверки подлинности и снова щелкните «Отправить».

	Вы получите ответ *403 Forbidden*.

	![Ответ 403 Forbidden](./media/app-service-api-dotnet-add-authentication/403forbidden.png)

## Дальнейшие действия

Вы узнали, как защитить приложение API Azure с помощью запроса проверки подлинности Azure Active Directory или поставщика социальных сетей. Дополнительные сведения см. в разделе [Что такое приложения API?](app-service-api-apps-why-best-platform.md).

[Портала Azure]: https://manage.windowsazure.com/
[портал Azure]: https://manage.windowsazure.com/
[портал предварительной версии Azure]: https://portal.azure.com/
[портала предварительной версии Azure]: https://portal.azure.com/
[портале предварительной версии Azure]: https://portal.azure.com/


<!--HONumber=54--> 