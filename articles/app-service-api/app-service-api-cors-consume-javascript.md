<properties
	pageTitle="Использование приложения API из JavaScript с помощью CORS | Microsoft Azure"
	description="Узнайте, как использовать приложение API в службе приложений Azure из клиента JavaScript с помощью CORS."
	services="app-service\api"
	documentationCenter=".net"
	authors="tdykstra"
	manager="wpickett"
	editor=""/>

<tags
	ms.service="app-service-api"
	ms.workload="na"
	ms.tgt_pltfrm="dotnet"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="11/27/2015"
	ms.author="tdykstra"/>

# Использование приложения API из JavaScript с помощью CORS

[AZURE.INCLUDE [app-service-api-get-started-selector](../../includes/app-service-api-get-started-selector.md)]

## Обзор

В этом руководстве показано, как использовать приложение API из кода JavaScript на веб-сайте, принадлежащем к другому домену. В примере клиента используется AngularJS.

![](./media/app-service-api-cors-consume-javascript/homepageazure.png)
 
Это второе руководство в серии учебных материалов для работы с приложениями API в службе приложений Azure. Дополнительные сведения об этой серии см. в статье [Приступая к работе с приложениями API и ASP.NET в службе приложений Azure](app-service-api-dotnet-get-started.md).

## Общие сведения о CORS

По соображениям безопасности в браузерах по умолчанию для JavaScript запрещены вызовы других доменов, помимо того, из которого выполняется JavaScript, с помощью API. Например, с веб-страницы contoso.com можно вызвать конечную точку API contoso.com, однако с той же веб-страницы нельзя вызвать конечную точку fabrikam.com. Cross Origin Resource Sharing (CORS) — это протокол IP, который позволяет осуществлять кросс-доменные вызовы API. В службе приложений Azure такие вызовы могут понадобиться, например, если клиент JavaScript выполняется в веб-приложении, а API запущен в приложении API.

В проекте веб-API можно установить пакеты NuGet для CORS, которые позволяют указать в коде домены, вызовы JavaScript из которых будет принимать API. Кроме того, вы можете использовать функцию CORS, встроенную в службе приложений Azure, чтобы указать домены, вызовы из которых будет принимать приложение API. В первой части этого руководства описано, как использовать функцию Azure, которая применима для всех языков, поддерживаемых службой приложений API. Во второй части учебника содержатся сведения о методе с использованием пакета NuGet, который подходит для веб-API ASP.NET. Использовать этот метод необязательно.

## Пример проекта ContactsList.Angular

При работе с этим руководством вы воспользуетесь примерами проектов и ресурсами Azure (приложением API и веб-приложением), которые были скачаны и созданы при работе с первым руководством этой серии.

Проект ContactsList.Angular представляет собой простой клиент AngularJS для проекта веб-API ContactsList.API. В этом проекте код JavaScript AngularJS, вызывающий API, находится в файле *index.html*. Этот код определяет функции и добавляет их в объект `$scope`, как показано в примере ниже, где метод GET API определяется как `$scope.refresh()`.

		angular.module('myApp', []).controller('contactListCtrl', function ($scope, $http) {
		    $scope.baseurl = 'http://localhost:51864';
		
		    $scope.refresh = function () {
		        $scope.status = "Refreshing Contacts...";
		        $http({
		            method: 'GET',
		            url: $scope.baseUrl + '/api/contacts',
		            headers: {
		                'Content-Type': 'application/json'
		            }
		        }).then(function (results) {
		            $scope.contacts = results.data;
		            $scope.status = "Contacts loaded";
		        }, function (err) {
		            $scope.status = "Error loading contacts";
		        });
		    };
		
		    // POST and DELETE not shown
		
		    $scope.refresh();
		});

Код вызывает метод $scope.refresh() при загрузке страницы (в конце фрагмента выше). Он привязан к кнопке **Обновить** в пользовательском интерфейсе.

		<th><button class="btn btn-sm btn-info" ng-click="refresh()">Refresh</button></th>

## Локальный запуск проекта AngularJS

В этом разделе вы узнаете, как проверить, можно ли запустить клиент локально, и вызвать с его помощью API, который также работает локально.

1. Задайте проекты ContactsList.API и ContactsList.Angular в качестве запускаемых проектов и задайте параметры, согласно которым сначала будет запускаться ContactsList.API, а затем —ContactsList.Angular. 

2. Нажмите клавишу F5, чтобы запустить проект.

	В пользовательском интерфейсе AngularJS отображаются локальные контакты. Здесь их можно добавлять и удалять.

	![](./media/app-service-api-cors-consume-javascript/homepagelocal.png)

3. Закройте окна браузера.

## Изменение проекта AngularJS для указания приложения API Azure 

Теперь необходимо запустить интерфейсную часть AngularJS в облаке и вызвать запущенную в нем внутреннюю службу API. Прежде чем развертывать интерфейсную часть в Azure, в проекте AngularJS необходимо изменить конечную точку API, чтобы код вызывал приложение Azure API, созданное ранее.

1. В проекте ContactsList.Angular откройте файл *index.html*.

2. Закомментируйте строку, которая задает `baseUrl` в качестве URL-адреса localhost, раскомментируйте строку, которая задает `baseUrl` в качестве URL-адреса azurewebsites.net, и замените заполнитель на фактическое имя приложения API, которое вы создали ранее. Если вы назвали приложение API ContactsListAPI, теперь код выглядит следующим образом:

		$scope.baseUrl = 'https://ContactsListAPI.azurewebsites.net';
		//$scope.baseUrl = 'http://localhost:51864';

### Развертывание проекта ContactsList.Angular в веб-приложении

Для развертывания проекта AngularJS можно создать отдельное веб-приложение, но в этом руководстве для развертывания используется веб-приложение, созданное ранее. В имени веб-приложения могут содержаться сведения о том, что изначально это приложение использовалось для развертывания проекта MVC ASP.NET, но после этого развертывания в нем будет выполняться код AngularJS.

8. В **обозревателе решений** щелкните правой кнопкой мыши проект ContactsList.Angular и нажмите кнопку **Опубликовать**.

9. Щелкните вкладку **Профиль**.

3.  На шаге **Профиль** мастера **веб-публикации** щелкните **Служба приложений Microsoft Azure**.

4. В диалоговом окне **Служба приложений** выберите необходимую подписку.

5. Задайте для параметра **Представление** значение по умолчанию **Группа ресурсов** и разверните группу ресурсов, созданную при работе с первым руководством этой серии.

7. Выберите веб-приложение, созданное при работе с первым руководством этой серии (не приложение API), и нажмите кнопку **ОК**.

8. Перейдите на вкладку **Параметры**.

9. Разверните раздел **Параметры публикации файлов** и установите флажок **Удалить дополнительные файлы в месте назначения**.

	![](./media/app-service-api-cors-consume-javascript/removeadditionalfiles.png)

	Обычно при развертывании веб-проекта в существующее веб-приложение службы приложений не требуется устанавливать этот флажок, так как изменения — это, как правило, обновления и новые файлы. В этом случае вы развертываете в то же самое веб-приложение другой проект, поэтому, скорее всего, существует много файлов из более раннего развертывания, которые не нужны в новом развертывании.

10. Щелкните **Опубликовать**.

	Visual Studio развертывает проект ContactsList.Angular в веб-приложении и выполняет переход по URL-адресу веб-приложения в браузере. Появится тот же пользовательский интерфейс AngularJS, что и при локальном запуске, но при его работе произойдет сбой, так как интерфейсная часть запущена не в том домене (URL-адрес веб-приложения), где выполняется внутренняя служба (URL-адрес приложения API).

	![](./media/app-service-api-cors-consume-javascript/corserror.png)

## Настройка CORS для целевого приложения API в Azure

8. В другом окне браузера перейдите на [портал Azure](https://portal.azure.com/).

9. Перейдите к колонке приложения API для приложения API, созданного при работе с первым руководством.

10. Щелкните **Параметры**.

11. В разделе **API** щелкните **CORS**.

12. В текстовом поле введите URL-адрес веб-приложения, созданного при работе с первым руководством, для интерфейсной части MVC ASP.NET. Например, если вы назвали веб-приложение ContactsListMVC, введите http://contactslistmvc.azurewebsites.net.

	Обратите внимание, что вместо конкретного URL-адреса можно ввести символ звездочки (*). В таком случае будут приниматься вызовы из всех исходных доменов.

13. Щелкните **Сохранить**.

	![](./media/app-service-api-cors-consume-javascript/corsinportal.png)

14. Вернитесь к окну обозревателя, в котором отображается запущенный в веб-приложении Azure клиент AngularJS и обновите страницу или нажмите кнопку **Обновить**.

	Теперь на странице отображаются контакты, которые хранятся в файловой системе приложения API Azure.

	![](./media/app-service-api-cors-consume-javascript/homepageazure.png)

## Настройка CORS для целевого приложения API в коде веб-API

Если вы не хотите использовать поддержку CORS службы приложений Azure, можно включить CORS в веб-API ASP.NET, используя код. Этот процесс подробно описан в статье [Включение запросов независимо от источника в веб-API 2 ASP.NET](http://www.asp.net/web-api/overview/security/enabling-cross-origin-requests-in-web-api). Для приложений API, созданных с использованием веб-API ASP.NET, процесс идентичен и кратко описан в этом разделе.

Здесь вы узнаете, как отключить поддержку CORS службы приложений Azure и включить поддержку CORS веб-API. Обратите внимание, что для включения поддержки веб-API нужно обязательно отключить поддержку CORS Azure. В противном случае будет использоваться CORS Azure, а CORS веб-API — попросту игнорироваться. Например, если указать один исходный домен в Azure и все исходные домены в коде веб-API, приложение API Azure будет принимать вызовы только из домена, указанного в Azure.

### Отключение поддержки CORS Azure

1. Чтобы отключить поддержку CORS Azure, откройте портал Azure, сотрите указанный URL-адрес в колонке CORS и нажмите кнопку **Сохранить**.
 
3.  Перейдите по URL-адресу веб-приложения, в котором развернуто приложение AngularJS, и обновите страницу или нажмите кнопку **Обновить**.

	Снова появится сообщение «Ошибка загрузки контактов».

	![](./media/app-service-api-cors-consume-javascript/corserror.png)

### Включение поддержки CORS веб-API

Функциональные возможности CORS для веб-API предоставляются пакетом NuGet [Microsoft.AspNet.WebApi.Cors](https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Cors/). Пакет уже установлен в скачанном примере приложения, и все, что нужно сделать для включения CORS, — раскомментировать некоторую часть кода.

1. В проекте ContactsList.API откройте файл *App\_Start/WebApiConfig.cs*. Раскомментируйте строку config.EnableCors кода в метод **Register** класса **WebApiConfig**. 

	После обновления файла код должен выглядеть следующим образом:

		public static class WebApiConfig
	    {
	        public static void Register(HttpConfiguration config)
	        {
	            // Web API configuration and services
	            
		        // Uncomment the following line to control CORS by using Web API code
				config.EnableCors();
	
	            // Web API routes
	            config.MapHttpAttributeRoutes();
	
	            config.Routes.MapHttpRoute(
	                name: "DefaultApi",
	                routeTemplate: "api/{controller}/{id}",
	                defaults: new { id = RouteParameter.Optional }
	            );
	        }
	    }

1. Откройте файл *Controllers/ContactsController.cs* и раскомментируйте следующую строку, которая добавляет атрибут `EnableCors` в класс `ContactsController`.

		namespace ContactList.Controllers
		{
		    [HttpOperationExceptionFilterAttribute]
		    [EnableCors(origins:"*", headers:"*", methods: "*")]
		    public class ContactsController : ApiController
 
	При необходимости вместо всего контроллера атрибут можно применить к отдельным методам действий.

	> **Примечание**. Подстановочные знаки для всех параметров с атрибутом `EnableCors` используются только для демонстрации. Это откроет API для всех источников и всех HTTP-запросов. Этот атрибут следует использовать с осторожностью.

### Развертывание API в Azure и повторное тестирование интерфейсной части

8. В **обозревателе решений** щелкните правой кнопкой мыши проект ContactsList.API и нажмите кнопку **Опубликовать**.

	Мастер **веб-публикации** на шаге **Предварительный просмотр** автоматически откроется для профиля публикации созданного ранее приложения API, так как это последнее целевое расположение развертывания этого проекта.

3.  Щелкните **Опубликовать**.

	![](./media/app-service-api-cors-consume-javascript/pubapi.png)

	После завершения развертывания в браузере откроется страница с URL-адресом приложения API, а затем появится сообщение: «веб-приложение успешно создано».

3.  Перейдите по URL-адресу веб-приложения, в котором развернуто приложение AngularJS, и обновите страницу или нажмите кнопку **Обновить**.

	Страница снова успешно загрузится.

	![](./media/app-service-api-cors-consume-javascript/homepageazure.png)

## Повторное включение поддержки CORS Azure

Для использования встроенных служб проверки подлинности Azure при работе со следующими руководствами вместо CORS веб-API необходимо использовать CORS Azure.
 
1. Чтобы включить поддержку CORS Azure, вернитесь в колонку CORS портала Azure для вашего приложения API и повторно введите URL-адрес веб-приложения.

13. Щелкните **Сохранить**.

	![](./media/app-service-api-cors-consume-javascript/corsinportal.png)

## Дальнейшие действия 

В этом руководстве рассмотрено два способа включения поддержки CORS, что позволяет вызывать API, расположенный в другом домене, с помощью клиентского кода JavaScript. В следующем руководстве вы узнаете, как [ограничить доступ к приложению API, чтобы к нему могли получить доступ только пользователи, прошедшие проверку подлинности](app-service-api-dotnet-user-principal-auth.md).

<!---HONumber=AcomDC_1203_2015-->