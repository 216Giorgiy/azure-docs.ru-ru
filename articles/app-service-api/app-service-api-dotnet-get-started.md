<properties
	pageTitle="Приступая к работе с приложениями API и ASP.NET в службе приложений | Microsoft Azure"
	description="Узнайте, как создать, развернуть и использовать приложение API ASP.NET в службе приложений Azure с помощью Visual Studio 2015."
	services="app-service\api"
	documentationCenter=".net"
	authors="tdykstra"
	manager="wpickett"
	editor=""/>

<tags
	ms.service="app-service-api"
	ms.workload="na"
	ms.tgt_pltfrm="dotnet"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="03/09/2016"
	ms.author="tdykstra"/>

# Приступая к работе с приложениями API и ASP.NET в службе приложений Azure

[AZURE.INCLUDE [selector](../../includes/app-service-api-get-started-selector.md)]

## Обзор

Это первое руководство из серии, посвященной использованию функций службы приложений Azure, которые могут быть полезны при разработке и размещении API-интерфейсов RESTful:

* встроенная поддержка метаданных API;
* [поддержка CORS](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing);
* поддержка аутентификации и авторизации.

Мы развернем пример приложения в двух [приложениях API](app-service-api-apps-why-best-platform.md) и веб-приложении в службе приложений Azure. Пример приложения представляет собой список дел с внешним одностраничным приложением (SPA), веб-приложением API среднего уровня ASP.NET и веб-приложением API ASP.NET уровня данных. Внешнее приложение SPA создано на основе платформы [AngularJS](https://angularjs.org/).

![Схема примера приложения приложений API](./media/app-service-api-dotnet-get-started/noauthdiagram.png)

Ниже приведен снимок экрана внешнего приложения SPA.

![Список дел в примере приложения приложений API](./media/app-service-api-dotnet-get-started/todospa.png)

По завершении этого руководства вы создадите два веб-интерфейса API, которые будут работать в приложениях API службы приложений. После завершения работы с этим руководством вы получите полное приложение, работающее в облаке, со SPA в веб-приложении службы приложений. Изучив последующие руководства, вы научитесь добавлять проверку подлинности и авторизацию.

## Что вы узнаете

В этом учебнике вы узнаете следующее:

* Как работать с приложениями API и веб-приложениями в службе приложений Azure с помощью средств, встроенных в Visual Studio 2015.
* Как автоматизировать обнаружение API с помощью пакета NuGet Swashbuckle для динамического создания JSON-файла определения API Swagger.
* Как использовать автоматически создаваемый код клиента для использования приложений API в клиенте .NET.
* Как настроить конечную точку для метаданных приложения API с помощью портала Azure.

## Предварительные требования

[AZURE.INCLUDE [prerequisites](../../includes/app-service-api-dotnet-get-started-prereqs.md)]

## Загрузка примера приложения 

1. Скачайте репозиторий [Azure-Samples/app-service-api-dotnet-to-do-list](https://github.com/Azure-Samples/app-service-api-dotnet-todo-list).

	Для этого нажмите кнопку **Download ZIP** (Скачать ZIP-файл) или клонируйте репозиторий на локальном компьютере.

2. Откройте решение ToDoList в Visual Studio 2015 или 2013.

	Решение Visual Studio представляет собой пример приложения, работающий с простыми элементами списка дел, которые состоят из описания и владельца. Это решение содержит три проекта.

	![](./media/app-service-api-dotnet-get-started/projectsinse.png)

	* **ToDoListAngular** (внешний интерфейс). Одностраничное приложение AngularJS, которое вызывает средний уровень. 

	* **ToDoListAPI** (средний уровень). Проект веб-API ASP.NET, который вызывает уровень данных для выполнения операций CRUD с элементами списка дел.

	* **ToDoListDataAPI** (уровень данных). Проект веб-API ASP.NET, который выполняет операции CRUD с элементами списка дел.

	Трехуровневая архитектура характерна для многих приложений, однако она не подходит для каждого сценария. Здесь она главным образом используется, чтобы упростить демонстрацию возможностей приложения API. По этой же причине на каждом уровне упрощен код. В отличие от реального приложения, здесь на среднем уровне нет существенной бизнес-логики. Кроме того, уровень данных использует в качестве механизма сохраняемости память сервера, а не базу данных. Это означает, что при каждом перезапуске приложения все изменения будут утеряны.

2. Создайте решение, чтобы восстановить пакеты NuGet.

## Запустите приложение локально (необязательно).

В этом разделе вы узнаете, как проверить, можно ли запустить клиент локально, и как вызвать с его помощью интерфейс API, который также работает локально.

**Примечание.** Эти инструкции предназначены для браузеров Internet Explorer и Edge, так как в них разрешены вызовы JavaScript из любых источников. При этом вызовы могут быть как направлены на URL-адреса `http://localhost`, так и исходить из них. Если вы используете браузер Chrome, запустите его с параметром `--disable-web-security`. Если вы используете Firefox, пропустите этот раздел.

1. Задайте все три проекта в качестве автозагружаемых проектов в такой последовательности: сначала ToDoListDataAPI, затем ToDoListAPI и наконец ToDoListAngular.

	а. В **обозревателе решений** щелкните решение правой кнопкой мыши и выберите пункт **Свойства**.

	b. Выберите **Несколько запускаемых проектов** и расположите проекты в правильном порядке.

	c. Для параметра **Действие** каждого из проектов выберите значение **Запуск**.

2. Нажмите клавишу F5 или щелкните **Отладка > Начать отладку** для запуска проектов в режиме отладки.

	Откроются три окна браузера. В двух окнах будет ошибка HTTP 403 (просмотр каталога запрещен). Для проектов веб-API это ожидаемый результат. В третьем окне будет пользовательский интерфейс AngularJS.

	В некоторых браузерах будут отображаться диалоговые окна, указывающие на то, что проект настроен для использования протокола SSL.

3. В окне браузера с пользовательским интерфейсом AngularJS щелкните вкладку **Список дел**.

	Отобразятся два стандартных элемента списка дел.

	![Список дел в примере приложения приложений API](./media/app-service-api-dotnet-get-started/todospa.png)

4. Потренируйтесь добавлять, изменять и удалять элементы списка дел, чтобы увидеть, как работает приложение.

	Любые внесенные изменения хранятся в памяти и теряются при перезапуске приложения.

3. Закройте окна браузера и остановите процесс отладки Visual Studio.

## Использование метаданных и пользовательского интерфейса Swagger

Поддержка метаданных API [Swagger 2.0](http://swagger.io/) встроена в службу приложений Azure. В каждом приложении API можно указать URL-адрес конечной точки, которая возвращает метаданные для API в формате JSON-файла Swagger. Метаданные, возвращенные из этой конечной точки, можно использовать для создания клиентского кода.

Проект веб-API ASP.NET может динамически создавать метаданные Swagger, используя пакет NuGet [Swashbuckle](https://www.nuget.org/packages/Swashbuckle). В скачанных проектах ToDoListDataAPI и ToDoListAPI этот пакет уже установлен.

В этом разделе мы рассмотрим созданные метаданные Swagger 2.0 и попробуем поработать с созданным на их основе пользовательским интерфейсом.

2. Установите проект ToDoListDataAPI (**не** проект ToDoListAPI) в качестве запускаемого проекта. 
 
4. Нажмите клавишу F5 или щелкните **Отладка > Начать отладку**, чтобы запустить проект в режиме отладки.

	Откроется браузер, в котором отобразится страница с ошибкой HTTP 403.

12. В адресной строке браузера добавьте `swagger/docs/v1` в конец строки и нажмите кнопку «Назад». (URL-адрес — `http://localhost:45914/swagger/docs/v1`.)

	Это URL-адрес по умолчанию, используемый Swashbuckle, чтобы вернуть метаданные JSON Swagger 2.0 для API.

	При использовании Internet Explorer появится запрос на скачивание файла *v1.json*.

	![Скачивание метаданных JSON в Internet Explorer](./media/app-service-api-dotnet-get-started/iev1json.png)

	При использовании Chrome, Firefox или Edge в окне браузера отобразится JSON-файл.

	![Метаданные JSON в Chrome](./media/app-service-api-dotnet-get-started/chromev1json.png)

	В следующем примере показана первая часть метаданных Swagger для API с определением для метода GET. Эти метаданные позволяют использовать пользовательский интерфейс Swagger, которым мы воспользуемся на следующих шагах. Он будет использоваться в следующем разделе этого руководства для автоматического создания кода клиента.

		{
		  "swagger": "2.0",
		  "info": {
		    "version": "v1",
		    "title": "ToDoListDataAPI"
		  },
		  "host": "localhost:45914",
		  "schemes": [ "http" ],
		  "paths": {
		    "/api/ToDoList": {
		      "get": {
		        "tags": [ "ToDoList" ],
		        "operationId": "ToDoList_GetByOwner",
		        "consumes": [ ],
		        "produces": [ "application/json", "text/json", "application/xml", "text/xml" ],
		        "parameters": [
		          {
		            "name": "owner",
		            "in": "query",
		            "required": true,
		            "type": "string"
		          }
		        ],
		        "responses": {
		          "200": {
		            "description": "OK",
		            "schema": {
		              "type": "array",
		              "items": { "$ref": "#/definitions/ToDoItem" }
		            }
		          }
		        },
		        "deprecated": false
		      },

1. Закройте браузер и остановите процесс отладки Visual Studio.

3. В **обозревателе решений** в проекте ToDoListDataAPI откройте файл *App\_Start\\SwaggerConfig.cs*, а затем найдите следующий код и раскомментируйте его.

		/*
		    })
		.EnableSwaggerUi(c =>
		    {
		*/

	Файл *SwaggerConfig.cs* создается при установке пакета Swashbuckle в проекте. С его помощью можно настроить Swashbuckle несколькими способами.

	Раскомментированный код позволяет применять пользовательский интерфейс Swagger, используемый на следующих шагах. При создании проекта веб-API с помощью шаблона проекта приложения API в целях безопасности этот код закомментирован по умолчанию.

5. Запустите проект снова.

3. В адресной строке браузера добавьте `swagger` в конец строки и нажмите кнопку "Назад". (URL-адрес — `http://localhost:45914/swagger`.)

4. Когда откроется страница Swagger, щелкните **ToDoList**, чтобы увидеть доступные методы.

	![Пользовательский интерфейс Swagger — доступные методы](./media/app-service-api-dotnet-get-started/methods.png)

5. Нажмите первую кнопку **Get** в списке.

6. Введите звездочку как значение параметра `owner`, а затем щелкните **Попробуйте в деле**.

	В последующих руководствах при добавлении проверки подлинности средний уровень указывает фактический идентификатор пользователя для уровня данных. Теперь при выполнении приложения с выключенной аутентификацией для всех задач в качестве идентификатора владельца будет использоваться звездочка.

	![Пользовательский интерфейс Swagger — кнопка Try it out](./media/app-service-api-dotnet-get-started/gettryitout1.png)

	Пользовательский интерфейс Swagger вызывает метод Get проекта ToDoList и отображает код ответа и результаты JSON.

	![Пользовательский интерфейс Swagger — результаты нажатия кнопки Try it out](./media/app-service-api-dotnet-get-started/gettryitout.png)

6. Щелкните **POST**, а затем — поле в разделе **Схема модели**.

	При этом предварительно заполняется поле ввода, в котором можно указать значение параметра для метода POST. Если этот способ не сработает в Internet Explorer, используйте другой браузер или вручную введите значение параметра на следующем шаге.

	![Пользовательский интерфейс Swagger — нажатие кнопки Try it out при выборе метода Post](./media/app-service-api-dotnet-get-started/post.png)

7. В поле ввода параметров `todo` измените код JSON, чтобы он выглядел, как показано ниже, или введите собственное описание.

		{
		  "ID": 2,
		  "Description": "buy the dog a toy",
		  "Owner": "*"
		}

10. Щелкните **Попробовать**.

	Проект ToDoList API возвращает код ответа HTTP 204, который указывает на успешное завершение.

11. Нажмите первую кнопку **Get**, а затем в соответствующем разделе страницы нажмите кнопку **Try it out**.

	Теперь ответ метода GET содержит новый элемент списка дел.

12. Необязательно: также попробуйте методы Put, Delete и Get по идентификатору (ID).

14. Закройте браузер и остановите процесс отладки Visual Studio.

Swashbuckle можно использовать с любыми проектами веб-API ASP.NET. Если нужно добавить возможность создания метаданных Swagger в существующий проект, просто установите пакет Swashbuckle.

**Примечание**. В метаданных Swagger есть уникальный идентификатор для каждой операции API. По умолчанию пакет Swashbuckle может создавать дублирующиеся идентификаторы операций Swagger для методов контроллера веб-API. Это происходит, если перегружены HTTP-методы контроллера, например `Get()` и `Get(id)`. Сведения о действиях при перегрузке см. в разделе [Настройка определений API, создаваемых Swashbuckle](app-service-api-dotnet-swashbuckle-customize.md). При создании проекта веб-API в Visual Studio с помощью шаблона приложения API Azure к файлу *SwaggerConfig.cs* автоматически добавляется код, который создает уникальные идентификаторы операций.

## Создание приложения API в Azure и развертывание в нем проекта ToDoListAPI

В этом разделе вы создадите приложение API в Azure с помощью инструментов Azure, интегрированных в мастер **веб-публикации** в Visual Studio. Затем вы развернете проект ToDoListDataAPI в новом приложении API и выполните вызов API, запустив пользовательский интерфейс Swagger в облаке.

1. В **обозревателе решений** щелкните правой кнопкой мыши проект ToDoListDataAPI и выберите пункт **Опубликовать**.

	![Нажмите кнопку "Опубликовать" в Visual Studio](./media/app-service-api-dotnet-get-started/pubinmenu.png)

3.  В мастере **веб-публикации** на вкладке **Профиль** щелкните **Служба приложений Microsoft Azure**.

	![Выберите "Служба приложений Azure" в мастере веб-публикации](./media/app-service-api-dotnet-get-started/selectappservice.png)

4. Войдите в учетную запись Azure, если вы этого еще не сделали, или обновите учетные данные, если срок их действия истек.

4. В диалоговом окне «Служба приложений» в поле **Подписка** выберите подписку Azure, которую хотите использовать, и нажмите кнопку **Создать**.

	![Нажмите кнопку "Создать" в диалоговом окне службы приложений](./media/app-service-api-dotnet-get-started/clicknew.png)

	Откроется диалоговое окно **Создание службы приложений** со вкладкой **Размещение**.

	Так как вы развертываете проект веб-API, в котором установлен пакет Swashbuckle, программа Visual Studio предлагает создать приложение API. Это можно определить по имени поля **Имя приложения API** и типу приложения (в раскрывающемся списке **Изменить тип** выбран тип **Приложение API**).

	![Тип приложения в диалоговом окне службы приложений](./media/app-service-api-dotnet-get-started/apptype.png)

	Функции, которые доступны для нового приложения API, веб-приложения или мобильного приложения, не зависят от типа приложения. Все функции приложения API, представленные в этих учебниках, доступны для всех трех типов приложений. Различие состоит только в значке и тексте, которые отображаются на портале Azure для идентификации типа приложения, и порядке перечисления функций на некоторых страницах портала. В этом руководстве портал Azure вы увидите позже. Это веб-интерфейс для управления ресурсами Azure.

	В примерах, которые приводятся в этих руководствах, внешний интерфейс SPA запущен в веб-приложении, а серверная часть каждого интерфейса веб-API запущена в приложении API. Тем не менее, если бы все три компонента были веб-приложениями или приложениями API, все работало бы так же. Кроме того, одно приложение API или веб-приложение может одновременно размещать внешний интерфейс SPA и серверную часть среднего уровня.

4. Введите **имя приложения API**, которое будет уникальным в домене *azurewebsites.net*. Например, можно ввести имя ToDoListDataAPI и номер, который сделает имя уникальным.

	Visual Studio предлагает уникальное имя, добавляя строку даты и времени к имени проекта. При необходимости можно принять это имя.

	Если ввести имя, которое уже используется, вместо зеленой галочки справа появится красный восклицательный знак. Это значит, что нужно ввести другое имя.

	Azure использует это имя в качестве префикса для URL-адреса приложения. Полный URL-адрес состоит из этого имени и домена *.azurewebsites.net*. Например, если имя — `ToDoListDataAPI`, URL-адрес будет таким: `todolistdataapi.azurewebsites.net`.

6. В раскрывающемся списке **Группа ресурсов** щелкните **Создать** и введите имя ToDoListGroup (или любое другое).

	Группы ресурсов — это совокупность ресурсов Azure, таких как приложения API, базы данных, виртуальные машины и т. д. Мы рекомендуем создать новую группу ресурсов, так как это позволит быстро удалить все ресурсы Azure, созданные для работы с этим руководством.

	В этом поле можно выбрать существующую [группу ресурсов](../azure-portal/resource-group-portal.md) или создать отдельную, введя имя, которое отличается от имени любой существующей группы ресурсов в подписке.

4. Нажмите кнопку **Создать** возле раскрывающегося списка **План службы приложений**.

	На снимке экрана ниже показаны примеры значений в полях **Имя приложения API**, **Подписка** и **Группа ресурсов**. Ваши значения будут другими.

	![Диалоговое окно "Создание службы приложений"](./media/app-service-api-dotnet-get-started/createas.png)

	Далее мы создадим план службы приложений для новой группы ресурсов. План службы приложений определяет вычислительные ресурсы, на которых будет работать ваше приложение API. Например, если выбрать уровень "Бесплатный", ваше приложение будет работает на общих виртуальных машинах, тогда как при выборе некоторых платных уровней приложение будет работать на выделенных виртуальных машинах. Дополнительные сведения о планах службы приложений см. в статье [Обзор планов службы приложений Azure](../app-service/azure-web-sites-web-hosting-plans-in-depth-overview.md).

5. В диалоговом окне **Настроить план служб приложений** в соответствующем поле введите ToDoListPlan или другое имя.

5. В раскрывающемся списке **Расположение** выберите ближайшее расположение.

	Этот параметр определяет, в каком центре обработки данных Azure будет выполняться приложение. При работе с учебником вы можете выбрать любой регион, и это не будет оказывать существенного влияния. Тем не менее для рабочего приложения необходимо, чтобы сервер располагался максимально близко к клиентам, которые осуществляют к нему доступ. Это позволит минимизировать [задержки](http://www.bing.com/search?q=web%20latency%20introduction&qs=n&form=QBRE&pq=web%20latency%20introduction&sc=1-24&sp=-1&sk=&cvid=eefff99dfc864d25a75a83740f1e0090).

5. В раскрывающемся списке **Размер** щелкните **Бесплатный**.

	Эта ценовая категория обеспечит достаточную производительность в рамках заданий этого руководства.

6. В диалоговом окне **Настройка плана службы приложений** нажмите кнопку **ОК**.

	![Нажмите кнопку "ОК" в диалоговом окне "Настройка плана службы приложений"](./media/app-service-api-dotnet-get-started/configasp.png)

7. В диалоговом окне **Создание службы приложений** нажмите кнопку **Создать**.

	![Нажмите кнопку "Создать" в диалоговом окне"Создание службы приложений"](./media/app-service-api-dotnet-get-started/clickcreate.png)

	Visual Studio создает приложение API и профиль публикации со всеми настройками, необходимыми для приложения API. Затем откроется мастер **веб-публикации**, который будет использоваться для развертывания проекта.

	**Примечание.** Создавать приложения API в службе приложений Azure можно и по-другому. Например, в Visual Studio для нового проекта можно создать ресурсы Azure так же, как мы только что создали для существующего проекта. Приложения API можно также создать с помощью [портала Azure](https://portal.azure.com/), [командлетов Azure для Windows PowerShell](../powershell-install-configure.md) или [кроссплатформенного интерфейса командной строки](../xplat-cli.md).

	В мастере **веб-публикации** откроется вкладка **Подключение** (показана ниже).

	На вкладке **Подключение** в полях **Сервер** и **Имя сайта** указываются данные приложения API. В полях **Имя пользователя** и **Пароль** указываются учетные данные развертывания, созданные Azure. После развертывания в браузере откроется страница с **URL-адресом назначения** (**URL-адрес назначения** необходим только для этого).

8. Нажмите кнопку **Далее**.

	![Нажмите кнопку "Далее" на вкладке "Подключение" мастера веб-публикации](./media/app-service-api-dotnet-get-started/connnext.png)

	Следующая вкладка — **Параметры** (показана ниже). Здесь можно изменить конфигурацию сборки, чтобы развернуть отладочную сборку для [удаленной отладки](../app-service-web/web-sites-dotnet-troubleshoot-visual-studio.md#remotedebug). На вкладке также представлено несколько **параметров публикации файлов**:

	* "Удалить дополнительные файлы в месте назначения";
	* "Предварительно компилировать при публикации";
	* "Исключить файлы из папки App\_Data".

	В данном руководстве эти параметры не используются. Подробное описание этих параметров см. в статье [How to: Deploy a Web Project Using One-Click Publish in Visual Studio](https://msdn.microsoft.com/library/dd465337.aspx) (Практическое руководство. Развертывание веб-проекта с помощью публикации одним щелчком в Visual Studio).

14. Нажмите кнопку **Далее**.

	![Нажмите кнопку "Далее" на вкладке "Параметры" мастера веб-публикации](./media/app-service-api-dotnet-get-started/settingsnext.png)

	Следующая вкладка **Просмотр** (показана ниже). На этой вкладке можно узнать, какие файлы будут скопированы из проекта в приложение API. Если вы развертываете проект в приложение API, в которое проект уже был развернут, копируются только измененные файлы. Чтобы просмотреть список файлов, которые будут скопированы, нажмите кнопку **Начать просмотр**.

15. Щелкните **Опубликовать**.

	![Нажмите кнопку "Опубликовать" на вкладке "Предварительный просмотр" мастера веб-публикации](./media/app-service-api-dotnet-get-started/clickpublish.png)

	Visual Studio развернет проект ToDoListDataAPI в новое приложение API. В окне **выходных данных** появится информация об успешном развертывании, а в окне браузера откроется страница с URL-адресом созданного приложения API.

	![Окно вывода с информацией об успешном развертывании](./media/app-service-api-dotnet-get-started/deploymentoutput.png)

	![Страница "Приложение API успешно создано"](./media/app-service-api-dotnet-get-started/appcreated.png)

11. В адресной строке браузера добавьте swagger в URL-адрес и нажмите клавишу ВВОД. (URL-адрес — `http://{apiappname}.azurewebsites.net/swagger`.)

	В браузере отобразится тот же пользовательский интерфейс Swagger, который вы уже видели, но теперь он будет работать в облаке. Попробуйте метод Get, и вы увидите, что вы возвращаетесь к элементам используемого по умолчанию списка дел 2. Внесенные ранее изменения сохранены в памяти локального компьютера.

12. Откройте [портал Azure](https://portal.azure.com/).

	Портал Azure — это веб-интерфейс для управления ресурсами Azure, например приложениями API.
 
14. Щелкните **Обзор > Службы приложений**.

	![Обзор служб приложений](./media/app-service-api-dotnet-get-started/browseas.png)

15. В колонке **Службы приложений** найдите и выберите свое приложение API. (На портале Azure окна, которые открываются справа, называются *колонками*).

	![Колонка "Службы приложений"](./media/app-service-api-dotnet-get-started/choosenewapiappinportal.png)

	Откроются две колонки: в одной будет общая информация о приложении API, а во второй — длинный список параметров, которые можно просматривать и изменять.

16. В колонке **Параметры** найдите раздел **API** и щелкните **Определение API**.

	![Определение API в колонке "Параметры"](./media/app-service-api-dotnet-get-started/apidefinsettings.png)

	В колонке **Определение API** можно указать URL-адрес, возвращающий метаданные Swagger 2.0 в формате JSON. Когда программа Visual Studio создает приложение API, она задает для URL-адреса определения API значение по умолчанию (для созданных пакетом Swashbuckle метаданных, которые вы уже видели ранее). Значением по умолчанию выступает базовый URL-адрес приложения API и строка `/swagger/docs/v1`.

	![URL-адрес определения API](./media/app-service-api-dotnet-get-started/apidefurl.png)

	При выборе приложения API, для которого нужно создать код клиента, Visual Studio извлекает метаданные из этого URL-адреса.

## <a id="codegen"></a> Использование приложения API с помощью созданного клиентского кода

Одним из преимуществ интеграции платформы Swagger в приложения API Azure является автоматическое создание кода. Созданные классы клиента упрощают написание кода, который вызывает приложение API.

В этом разделе мы рассмотрим, как можно использовать приложение API из кода веб-API ASP.NET.

### Создание кода клиента

Код клиента для приложения API можно создать с помощью Visual Studio или из командной строки. В этом руководстве используется решение Visual Studio. Дополнительные сведения о том, как сделать это с помощью командной строки, см. в файле сведений репозитория [Azure/autorest](https://github.com/azure/autorest) на сайте GitHub.com.

В проекте ToDoListAPI уже есть клиентский код, но мы удалим его и создадим повторно, чтобы понять, как это делается.

1. В **обозревателе решений** Visual Studio в проекте ToDoListAPI удалите папку *ToDoListDataAPI*.

	Эта папка появилась в процессе создания кода, который мы будем изучать.

	![Удаление кода, созданного клиентом](./media/app-service-api-dotnet-get-started/deletecodegen.png)

2. Щелкните правой кнопкой мыши проект ToDoListAPI и последовательно выберите **Добавить > Клиент REST API**.

	![Добавление клиента REST API в Visual Studio](./media/app-service-api-dotnet-get-started/codegenmenu.png)

3. В диалоговом окне **Добавление клиента REST API** щелкните **URL-адрес Swagger**, а затем — **Выбрать ресурс Azure**.

	![Выбор ресурса Azure](./media/app-service-api-dotnet-get-started/codegenbrowse.png)

8. В диалоговом окне **Служба приложений** разверните группу ресурсов, которую мы используем в этом руководстве, выберите нужное приложение API и нажмите кнопку **ОК**.

	![Выбор приложения API для создания кода](./media/app-service-api-dotnet-get-started/codegenselect.png)

	Если в этом диалоговом окне приложений в списке слишком много, приложения API можно по разному упорядочить. Здесь также можно ввести строку поиска для фильтрации приложений API по имени.

	Обратите внимание, что при возврате к диалоговому окну **Добавление клиента REST API** в текстовом поле введено значение URL-адреса определения API, которое вы видели на портале ранее.

	![URL-адрес определения API](./media/app-service-api-dotnet-get-started/codegenurlplugged.png)

	Кроме того, чтобы получить метаданные для создания кода, URL-адрес можно ввести напрямую, а не в диалоговом окне обзора. Метаданные можно получить также с помощью параметра **Выбрать существующий файл метаданных Swagger**. Например, если вам нужно создать клиентский код до развертывания в Azure, локально запустите проект веб-API, откройте URL-адрес JSON-файла Swagger, сохраните файл и выберите его здесь.

9. В диалоговом окне **Добавление клиента REST API** нажмите кнопку **ОК**.

	Visual Studio создает папку с именем приложения API и классы клиента.

	![Файлы кода для созданного клиента](./media/app-service-api-dotnet-get-started/codegenfiles.png)

5. В проекте ToDoListAPI откройте файл *Controllers\\ToDoListController.cs*. Вы увидите код, который вызывает API с помощью созданного клиента.

	В приведенном ниже фрагменте кода показано, как создать экземпляр объекта клиента и вызвать метод GET.

		private static ToDoListDataAPI NewDataAPIClient()
		{
		    var client = new ToDoListDataAPI(new Uri(ConfigurationManager.AppSettings["toDoListDataAPIURL"]));
		    return client;
		}
		
		public async Task<IEnumerable<ToDoItem>> Get()
		{
		    using (var client = NewDataAPIClient())
		    {
		        var results = await client.ToDoList.GetByOwnerAsync(owner);
		        return results.Select(m => new ToDoItem
		        {
		            Description = m.Description,
		            ID = (int)m.ID,
		            Owner = m.Owner
		        });
		    }
		}

	Параметр конструктора получает URL-адрес конечной точки из параметра приложения `toDoListDataAPIURL`. В файле Web.config это значение содержит локальный URL-адрес IIS Express проекта API, что дает возможность запускать приложение локально. Если опустить параметр конструктора, в качестве конечной точки по умолчанию будет использоваться URL-адрес, на основе которого создан код.

6. Класс клиента будет создан с другим именем в зависимости от имени приложения API. Измените код в файле *Controllers\\ToDoListController.cs* так, чтобы имя типа совпадало с именем в проекте. Например, если приложение API названо ToDoListDataAPI0121, код будет выглядеть следующим образом:

		private static ToDoListDataAPI0121 NewDataAPIClient()
		{
		    var client = new ToDoListDataAPI0121(new Uri(ConfigurationManager.AppSettings["toDoListDataAPIURL"]));

### Создание приложения API для размещения на среднем уровне

1. В **обозревателе решений** щелкните правой кнопкой мыши проект ToDoListAPI (не ToDoListDataAPI) и выберите пункт **Опубликовать**.

3.  В мастере **веб-публикации** на вкладке **Профиль** щелкните **Служба приложений Microsoft Azure**.

5. В диалоговом окне **Служба приложений** нажмите кнопку **Создать**.

3. В диалоговом окне **Создание службы приложений** на вкладке **Размещение** укажите **имя приложения API**, которое будет уникальным в домене *azurewebsites.net*.

5. В поле **Подписка** выберите подписку Azure, которую нужно использовать.

6. В раскрывающемся списке **Группа ресурсов** выберите созданную ранее группу ресурсов.

4. В раскрывающемся списке **План службы приложений** выберите созданный ранее план. Это значение будет использоваться по умолчанию.

7. Щелкните **Создать**.

	Visual Studio создаст приложение API и профиль публикации для него, а также отобразит в мастере **веб-публикации** шаг **Подключение**.

3.  На шаге **Подключение** мастера **веб-публикации** нажмите кнопку **Опубликовать**.

	Visual Studio развернет проект ToDoListAPI в новом приложении API и откроет в браузере URL-адрес приложения API. Откроется страница "Приложение успешно создано".

### Выбор URL-адреса для приложения API уровня данных в приложении API среднего уровня

Если вызвать приложение API среднего уровня сейчас, оно попытается вызвать уровень данных, используя URL-адрес локального узла, который указан в файле Web.config. В этом разделе мы укажем URL-адрес для приложения API уровня данных в параметре среды в приложении API среднего уровня. Когда код в приложении API среднего уровня получает URL-адрес уровня данных, параметр среды перезаписывает значение в файле Web.config.
 
1. Перейдите на [портал Azure](https://portal.azure.com/) и откройте колонку **Приложение API** для приложения API, которое вы создали для размещения проекта TodoListAPI (приложение среднего уровня).

2. В колонке **Параметры** приложения API щелкните **Параметры приложения**.
 
4. Прокрутите колонку **Параметры приложения** вниз до раздела **Параметры приложения** и добавьте следующие ключ и значение.

	| **Ключ** | toDoListDataAPIURL |
	|---|---|
	| **Значение** | https://{your имя\_приложения\_API\_уровня\_данных}.azurewebsites.net |
	| **Пример** | https://todolistdataapi0121.azurewebsites.net |

4. Щелкните **Сохранить**.

	![Нажмите кнопку "Сохранить" в колонке "Параметры приложения"](./media/app-service-api-dotnet-get-started/asinportal.png)

	Если код выполняется в среде Azure, это значение теперь будет переопределять URL-адрес локального узла, который находится в файле Web.config.

### Проверка: ToDoListAPI вызывает ToDoListDataAPI

11. В окне браузера перейдите по ссылке нового приложения API среднего уровня, которое вы только что создали. Для этого щелкните URL-адрес в главной колонке приложения API на портале.

13. В адресной строке браузера добавьте swagger в URL-адрес и нажмите клавишу ВВОД. (URL-адрес — `http://{apiappname}.azurewebsites.net/swagger`.)

	В браузере появится тот же пользовательский интерфейс Swagger, который мы уже видели в проекте ToDoListDataAPI. В этот раз поле `owner` не является обязательным для операции Get, так как приложение API среднего уровня автоматически отправляет это значение в приложение API уровня данных. (Во время проверки подлинности приложение среднего уровня будет отправлять для параметра `owner` фактические идентификаторы пользователей. Сейчас вместо параметра отображается звездочка).

12. Попробуйте применить метод GET и другие методы, чтобы убедиться, что приложение API среднего уровня успешно вызывает приложение API уровня данных.

	![Метод Get пользовательского интерфейса Swagger](./media/app-service-api-dotnet-get-started/midtierget.png)

Дополнительные сведения о созданном клиенте см. в репозитории [AutoRest в GitHub](https://github.com/azure/autorest). Чтобы получить информацию о проблемах, связанных с созданным клиентом, откройте [проблему в репозитории AutoRest](https://github.com/azure/autorest/issues).

## <a id="creating"></a> Создание проекта приложения API с нуля (необязательное действие)

В этом руководстве мы развертываем в службе приложений скачанные проекты веб-API ASP.NET, а не создаем их с нуля. Чтобы создать проект, который затем будет развернут в приложение API, можно создать типичный проект веб-API и установить в него пакет Swashbuckle или воспользоваться шаблоном нового проекта **Приложение API Azure**. Чтобы воспользоваться этим шаблоном, последовательно выберите **Файл > Создать > Проект > Веб-приложение ASP.NET > Приложение API Azure**.

![Шаблон приложения API в Visual Studio](./media/app-service-api-dotnet-get-started/apiapptemplate.png)

Выбрав шаблон ASP.NET 4.5.2 **Пустой**, установив флажок добавления поддержки веб-API и установив пакет Swashbuckle, вы получите такой же результат, что и при выборе шаблона проекта **Приложение API Azure**. Но в этот шаблон добавлен еще код конфигурации Swashbuckle, который не позволяет создавать повторяющиеся идентификаторы операций Swagger.

## Настройка URL-адреса определения API в шаблонах диспетчера ресурсов Azure (необязательное действие)

В этом руководстве мы видели URL-адрес определения API в программе Visual Studio и на портале Azure. URL-адрес определения API для приложения API можно также настроить с помощью [шаблонов диспетчера Azure Resource Manager](../resource-group-authoring-templates.md), используя такие средства командной строки, как [Azure PowerShell](../powershell-install-configure.md) и [интерфейс командной строки Azure](../xplat-cli-install.md).

Чтобы просмотреть пример шаблона диспетчера Azure Resource Manager, который задает свойство определения API, откройте [файл azuredeploy.json в репозитории примера приложения из данного руководства](https://github.com/azure-samples/app-service-api-dotnet-todo-list/blob/master/azuredeploy.json). Найдите раздел шаблона, который выглядит так:

		"apiDefinition": {
		  "url": "https://todolistdataapi.azurewebsites.net/swagger/docs/v1"
		}

## Устранение неполадок

Если при работе с этим руководством возникли проблемы, убедитесь, что вы используете последнюю версию пакета Azure SDK для .NET. Самый простой способ сделать это — [скачать пакет Azure SDK для Visual Studio 2015](http://go.microsoft.com/fwlink/?linkid=518003). Если у вас установлена текущая версия, установщик веб-платформы сообщит вам, что установка не требуется.

Имена двух проектов похожи (ToDoListAPI, ToDoListDataAPI). Если результаты вашей работы выглядят не так, как описано в инструкциях, убедитесь, что вы открыли правильный проект.

Если вы работаете в корпоративной сети и пытаетесь развернуть службу приложений Azure через брандмауэр, убедитесь, что порты 443 и 8172 открыты для веб-развертывания. Если не удается открыть эти порты, в разделе "Дальнейшие действия" ниже приведены другие варианты развертывания.

Если вы случайно развернули в приложении API неправильный проект, а затем правильный, могут возникать ошибки "Имена маршрутов должны быть уникальными". Чтобы устранить эту проблему, повторно разверните проект в приложении API. В мастере **веб-публикации** на вкладке **Параметры** выберите параметр **Удалить дополнительные файлы в месте назначения**.

Запустив приложение API ASP.NET в службе приложений Azure, можно узнать больше о функциях Visual Studio, которые упрощают устранение неполадок. Сведения о ведении журналов, удаленной отладке и другую информацию см. в статье [Устранение неполадок веб-приложения в службе приложений Azure с помощью Visual Studio](../app-service-web/web-sites-dotnet-troubleshoot-visual-studio.md).

## Дальнейшие действия

В этом руководстве показано, как создавать приложения API, развертывать в них код, создавать для них клиентский код и использовать их в клиентах .NET. Из следующего руководства вы узнаете, как [использовать приложения API в клиентах JavaScript с помощью CORS](app-service-api-cors-consume-javascript.md). В последующих учебниках серии демонстрируется, как реализовать проверку подлинности и авторизацию.

<!---HONumber=AcomDC_0518_2016-->