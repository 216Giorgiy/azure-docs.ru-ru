<properties 
	pageTitle="Развертывание и настройка приложения API соединителя SaaS" 
	description="Узнайте, как настраивается соединитель SaaS, устанавливаемый в подписке Azure из Azure Marketplace." 
	services="app-service\api" 
	documentationCenter=".net" 
	authors="tdykstra" 
	manager="wpickett" 
	editor="jimbe"/>

<tags 
	ms.service="app-service-api" 
	ms.workload="web" 
	ms.tgt_pltfrm="dotnet" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="01/08/2016" 
	ms.author="tdykstra"/>

# Развертывание и настройка приложения API соединителя SaaS в службе приложений Azure

[AZURE.INCLUDE [app-service-api-v2-note](../../includes/app-service-api-v2-note.md)]

## Обзор

В этом учебнике показывается, как установить, настроить и проверить [соединитель «программное обеспечение как услуга» (SaaS)](../app-service-logic-what-are-bizTalk-api-apps.md) в [службе приложений Azure](/documentation/services/app-service/) для его вызова программными средствами, например из мобильного приложения. Соединитель SaaS — это [приложение API](app-service-api-apps-why-best-platform.md), которое упрощает взаимодействие с платформой SaaS, такой как Office 365, Salesforce, Facebook и Dropbox. Если вместо использования встроенного соединителя требуется создать пользовательское приложение API .NET, см. статью [Подключение к платформе SaaS из приложения API ASP.NET](app-service-api-dotnet-connect-to-saas.md).

Например, если требуется кодировать HTTP-запросы на чтение и запись файлов в вашей учетной записи Dropbox, процесс проверки подлинности для работы непосредственно с Dropbox довольно сложен. Соединитель Dropbox берет на себя всю сложность проверки подлинности, так что вы можете заниматься только созданием кода, относящегося к вашим конкретным бизнес-процессам.

> [AZURE.NOTE]Приведенные здесь указания не должны применяться, если вы хотите использовать соединитель SaaS из приложения логики. Сведения об использовании соединителей SaaS в приложениях логики см. в статьях [Создание приложения логики](../app-service-logic/app-service-logic-create-a-logic-app.md) и [Использование пользовательского приложения OAUTH в соединителях](https://social.msdn.microsoft.com/Forums/ru-RU/home?forum=azurelogicapps&announcementId=4af1e4c5-d220-4457-97d8-d08e427ae6c1).
 
В этом учебнике в качестве примера используется соединитель DropBox и подробно описываются следующие действия.

* Установка соединителя Dropbox в [группу ресурсов](../resource-group-overview.md) в подписке Azure. 
* Настройка соединителя Dropbox, чтобы он мог подключаться к службе Dropbox. (Для выполнения этого шага потребуется учетная запись Dropbox.)
* Настройка группы ресурсов, чтобы только прошедшие проверку подлинности пользователи могли обращаться к приложениям API, включенным в эту группу ресурсов.
* Тестирование для проверки функционирования проверки подлинности пользователей и проверки подлинности Dropbox.

Дополнительные сведения о проверке подлинности в службе приложений см. в статье [Проверка подлинности для приложений API и мобильных приложений](../app-service/app-service-authentication-overview.md).

## Установка соединителя Dropbox

1. Перейдите на домашнюю страницу [портала предварительной версии Azure] и щелкните **Marketplace**.

	![Marketplace на портале предварительной версии Azure](./media/app-service-api-connnect-your-app-to-saas-connector/marketplace.png)

2. Найдите Dropbox и щелкните значок **соединителя Dropbox**.

	![Щелкните соединитель Dropbox](./media/app-service-api-connnect-your-app-to-saas-connector/searchdb.png)
 
3. Щелкните **Создать**.

	![Нажмите кнопку "Создать"](./media/app-service-api-connnect-your-app-to-saas-connector/clickcreate.png)
 
5. В колонке **Соединитель Dropbox** в разделе **План службы приложений** щелкните **Создать новый**, а затем в поле **Создать новый план службы приложений** введите DropBoxPlan.

	Дополнительные сведения о планах службы приложений см. в разделе [Подробный обзор планов службы приложений Azure](azure-web-sites-web-hosting-plans-in-depth-overview.md).

4. В разделе **Группа ресурсов** нажмите **Создать**, а затем в поле **Создать новую группу ресурсов** введите DropboxRG.

	Дополнительные сведения о группах ресурсов см. в разделе [Использование групп ресурсов для управления ресурсами Azure](../resource-group-overview.md).

7. Выберите бесплатную **ценовую категорию**. (Если вы не видите ее в списке, нажмите кнопку **Просмотреть все**. Щелкните вариант **F1 бесплатно** и нажмите кнопку **Выбрать**.)

	Вы можете использовать платную ценовую категорию, но для данного учебника это не требуется.
 
11. Выберите **расположение** рядом с вами.

9. <a id="gateway"></a>Оставьте значение по умолчанию DropboxConnector в качестве **имени** соединителя и нажмите кнопку **Создать**.

	![Нажмите «Создать».](./media/app-service-api-connnect-your-app-to-saas-connector/createdropbox.png)

	Служба приложений Azure создает группу ресурсов, а затем создает в этой группе ресурсов приложение API соединителя Dropbox и веб-приложение *шлюза*. Функции шлюза — управление доступом ко всем приложениям API в этой группе ресурсов.

	Чтобы проверить ход выполнения создания ресурсов, щелкните элемент **Уведомления** на домашней странице портала предварительной версии Azure.

3. Когда Azure завершит создание соединителя, последовательно выберите пункты **Обзор > Группы ресурсов > DropboxRG**.
 
	В колонке **Группа ресурсов** для DropboxRG появится соединитель и шлюз в этой группе ресурсов.

	![Схема группы ресурсов](./media/app-service-api-connnect-your-app-to-saas-connector/rgdiagram.png)

## Настройка учетной записи Dropbox и соединителя Dropbox

Чтобы включить доступ API к вашей учетной записи Dropbox, необходимо создать приложение Dropbox на веб-сайте разработчика Dropbox. Затем скопируйте значения идентификатора клиента и секрета клиента из этого приложения Dropbox в ваш соединитель Dropbox и задайте в соединителе прием только запросов, прошедших проверку подлинности.

### <a id="createdbapp"></a>Создание приложения Dropbox

[AZURE.INCLUDE [app-service-api-create-dropbox-app](../../includes/app-service-api-create-dropbox-app.md)]

### <a id="copysettings"></a>Копирование параметров приложения Dropbox в соединитель Dropbox Azure и наоборот 

[AZURE.INCLUDE [app-service-api-exchange-dropbox-settings](../../includes/app-service-api-exchange-dropbox-settings.md)]

### Установка в соединителе Dropbox требования доступа с проверкой подлинности

По умолчанию **уровень доступа** соединителя установлен как **внутренний**, что означает, что он может вызываться только другими приложениями API и веб-приложениями, находящимися в той же группе ресурсов. Однако Dropbox разрешает доступ к учетной записи Dropbox только пользователям, прошедшим проверку подлинности, поэтому нужно изменить уровень доступа, чтобы требовалась проверка подлинности пользователя.

1. Вернитесь в колонку **Параметры** и щелкните раздел **Параметры приложения**.

2. В колонке **Параметры приложения** установите для параметра **Уровень доступа** значение **Общедоступный (с проверкой подлинности)**, а затем нажмите кнопку **Сохранить**.
	
	![Установка значения «Общедоступный (с проверкой подлинности)»](./media/app-service-api-connnect-your-app-to-saas-connector/pubauth.png)

Теперь вы настроили соединитель Dropbox так, что исходящие вызовы имеют доступ к вашей учетной записи Dropbox, а входящие вызовы должны быть от пользователей, прошедших проверку подлинности. В следующем разделе вы укажете, какой поставщик проверки подлинности следует использовать для проверки подлинности пользователей.

## Настройка шлюза

Как объяснялось [ранее](#gateway), шлюз — это специальное веб-приложение, управляющее доступом ко всем приложениям API в группе ресурсов. Чтобы настроить шлюз для проверки подлинности пользователей, выберите поставщик проверки подлинности, например Azure Active Directory, Google или Twitter. После этого пользователи должны будут пройти проверку подлинности в выбранном поставщике, прежде чем смогут успешно вызывать соединитель Dropbox.

- Для выполнения этого шага перейдите в раздел [Настройка шлюза](app-service-api-dotnet-add-authentication.md#configure-the-gateway) в учебнике [Защита приложения API](app-service-api-dotnet-add-authentication.md) и выполните его указания по настройке шлюза в группе ресурсов DropboxRG.

## Тестирование проверки подлинности пользователя и Dropbox

После настройки шлюза в группе ресурсов DropboxRG для использования поставщика проверки подлинности вы можете проверить свой соединитель Dropbox.

В большинстве случаев вы будете использовать соединитель путем вызова из кода и корпорация Майкрософт также предоставит учебники, в которых будет показано, как это делается. Однако иногда бывает необходимо проверить, что соединитель работает, прежде чем подключать другие части приложения. В этом учебнике показывается, как использовать веб-браузер и простое клиентское средство REST для проверки возможности взаимодействия со службой Dropbox через соединитель Dropbox, который вы только что установили и настроили.

Следующие инструкции демонстрируют, как выполнить эти действия с помощью средств разработчика браузера Chrome и клиентского средства Postman (почтальон) REST. Это только лишь пример, и вы можете выполнять те же процедуры, используя другие браузеры и средства. Вы можете использовать другую надстройку Chrome — Advanced REST Client.

### Вход в систему от имени конечного пользователя

Выполните следующие действия в новом окне браузера. В зависимости от применяемого поставщика проверки подлинности может потребоваться использовать окно в закрытом или анонимном режиме.

2. Перейдите на URL-адрес входа для шлюза и настроенного поставщика проверки подлинности. URL-адрес соответствует следующему шаблону: 

    	http://[gatewayurl]/login/[providername]

	URL-адрес шлюза можно взять из колонки **Шлюз** на [портале предварительной версии Azure]. (Чтобы перейти в колонку **Шлюз**, щелкните шлюз на схеме, которая отображается в колонке **Группа ресурсов**.)

	![URL-адрес шлюза](./media/app-service-api-connnect-your-app-to-saas-connector/gatewayurl.png)

	Параметр [providername] имеет значение facebook для Facebook, twitter для Twitter, aad для Azure Active Directory и т. д.

	Ниже приведен пример URL-адреса входа для Azure Active Directory.

		https://dropboxrgaeb4ae60b7cb4f3d966dfa43.azurewebsites.net/login/aad/

3. Когда в браузере откроется страница для входа, введите свои учетные данные.
 
	Если вы настроили вход в Azure Active Directory, войдите как один из пользователей, перечисленных на вкладке **Пользователи** для приложения, созданного на вкладке Azure Active Directory [портала Azure], например admin@contoso.onmicrosoft.com.

	Если вход выполнен успешно, появится страница Login complete (вход выполнен).

	![](./media/app-service-api-connnect-your-app-to-saas-connector/logindone.png)

### Предоставление в Dropbox удостоверения пользователя

Чтобы получить авторизацию Dropbox на использование API Dropbox, необходимо предоставить учетные данные пользователя в Dropbox. Azure запустит этот процесс, но для этого вам необходимо перейти по специальному URL-адресу шлюза в браузере. Чтобы получить этот URL-адрес, выполните запрос HTTP Post к шлюзу.

Запрос HTTP Post к шлюзу должен иметь токен проверки подлинности, предоставленный Azure при входе в систему. Для браузерных запросов этот токен включается автоматически, поскольку он хранится в файле cookie, но для запроса HTTP Post с помощью клиентского средства REST необходимо получить токен из файла cookie и поместить его в заголовке запроса HTTP Post.

1. В окне браузера с сообщением Login complete (вход выполнен) перейдите в средства разработчика браузера и найдите файл cookie `x-zumo-auth`. Не закрывайте это окно, чтобы можно было скопировать это значение из файла cookie на следующем шаге.
 
	Чтобы получить значение файла cookie в Chrome, выполните следующие действия.

	- Нажмите клавишу F12, чтобы открыть средства разработчика.
	- Перейдите на вкладку **Ресурсы**.
	- Найдите файлы cookie для сайта шлюза и трижды щелкните поле **Значение** файла cookie `x-zumo-auth` файла cookie, чтобы выбрать его полностью. (Убедитесь, что вы получили все значение файла cookie. Если щелкнуть дважды, то можно получить только первую часть значения.)  

	![Копирование токена](./media/app-service-api-connnect-your-app-to-saas-connector/copytoken.png)

4. В новой вкладке или окне браузера создайте и отправьте запрос HTTP Post в шлюз для получения соответствующего URL-адреса. Включите токен `x-zumo-auth` как HTTP-заголовок.

	URL-адрес соответствует следующему шаблону:

		[gatewayurl]/api/consent/list?api-version=2015-01-14&redirecturl=[a URL you want the browser to go to after you authenticate]

	Например:

		https://dropboxrgaeb4ae60b7cb4f3d966dfa43.azurewebsites.net/api/consent/list?api-version=2015-01-14&redirecturl=https://portal.azure.com

	Чтобы отправить запрос в средство Postman в Chrome, выполните следующие действия.

	- Введите **URL-адрес запроса**, описанный выше.
	- Задайте метод **Post**.
	- Добавьте заголовок с именем `x-zumo-auth`.
	- В поле **Значение** заголовка вставьте значение, скопированное из файла cookie `x-zumo-auth`.
	- Нажмите кнопку **Отправить**.
	 
	На следующем рисунке показано средство Postman в Chrome:

	![Отправка для получения URL-адреса согласия](./media/app-service-api-connnect-your-app-to-saas-connector/sendforconsent.png)

	Ответ включает URL-адрес для запуска операции входа пользователя с использованием Dropbox. (Если вы выбрали в раскрывающемся списке метод **Post** и получили ошибку, указывающую, что метод Get не поддерживается, убедитесь, что в URL-адресе шлюза используется протокол HTTPS, а не HTTP.)

	![URL-адрес согласия](./media/app-service-api-connnect-your-app-to-saas-connector/getconsenturl.png)

2. Перейдите на URL-адрес, полученный в ответе на запрос HTTP Post.

	Ответ на этот URL-адрес перенаправляет браузер на сайт Dropbox, где пользователь входит и предоставляет приложению разрешение на доступ к своей учетной записи.
	
	После того как пользователь войдет в систему и предоставит разрешение, в браузере откроется указанный URL-адрес перенаправления (например, портал предварительной версии Azure, если вы так в примере указали https://portal.azure.com). Если вызов выполняется из веб-приложения, в веб-приложении отобразится следующая страница. Приложение должно проверить этот URL-адрес, поскольку в случае ошибки при входе или предоставлении разрешения URL-адрес перенаправления может включать переменную строки запроса `error`.

3. Не закрывайте это окно браузера, так как оно будет использоваться в следующем разделе.

### Вызов API соединителя Dropbox 

Теперь Azure управляет тремя вашими токенами проверки подлинности:

- одним от поставщика проверки подлинности, настроенного для шлюза, например от Azure Active Directory;
- одним от Dropbox;
- одним, созданным Azure (токеном zumo).

При выполнении HTTP-запросов для работы с Dropbox вам нужно использовать только один из них —токен zumo. За кулисами Azure связывает этот токен с двумя другими, и при выполнении вызовов в Dropbox соединитель предоставляет остальные два токена от вашего имени.

В следующих шагах вы будете выполнять запрос Get в соединитель Dropbox для просмотра файлов в вашей учетной записи Dropbox. Поскольку вы можете использовать окно браузера для запроса Get и это окно уже имеет токен zumo в файле cookie, все, что нужно сделать, — это перейти на URL-адрес, и вы получите данные Dropbox.

1. В окне браузера с открытым порталом предварительной версии Azure вернитесь в колонку **Приложение API** для соединителя Dropbox. 

2. Скопируйте URL-адрес этого приложения API.
 
4. Щелкните значок **определения API**, чтобы просмотреть методы API, доступные в этом соединителе.

	![Колонка приложения API](./media/app-service-api-connnect-your-app-to-saas-connector/apiappblade.png)

	![Определение API](./media/app-service-api-connnect-your-app-to-saas-connector/apidef.png)

2. В окне браузера, которое использовалось для проверки подлинности в шлюзе, вызовите метод GET, который получает имена файлов из папки. Ниже приведен шаблон URL-адреса.

		[connectorurl]/folder/[foldername]
   
3. Например, если URL-адрес соединителя https://dropboxrg784237ad3e7.azurewebsites.net и вам нужно просмотреть файлы в папке блога, URL-адрес будет следующий:

		https://dropboxrg784237ad3e7.azurewebsites.net/folder/blog

	Разные браузеры по-разному отвечают на вызовы API; если вы используете Chrome, то получите ответ, аналогичный приведенному ниже.

	![Получение ответа на запрос папки](./media/app-service-api-connnect-your-app-to-saas-connector/dbresponse.png)

## Дальнейшие действия

Вы узнали, как устанавливать, настраивать и тестировать соединитель SaaS. Для получения дополнительных сведений см. следующие ресурсы.

* [Использование соединителей](../app-service-logic/app-service-logic-connectors-list.md)
* [Проверка подлинности для приложений API и мобильных приложений](../app-service/app-service-authentication-overview.md)  

[портала предварительной версии Azure]: https://portal.azure.com/
[портале предварительной версии Azure]: https://portal.azure.com/
[портала Azure]: https://manage.windowsazure.com/
 

<!---HONumber=AcomDC_0114_2016-->