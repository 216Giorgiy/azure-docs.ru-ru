<properties 
   pageTitle="Обзор диспетчера трафика"
   description="Эта статья содержит информацию о диспетчере трафика и принципах его работы."
   services="traffic-manager"
   documentationCenter=""
   authors="cherylmc"
   manager="adinah"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="02/27/2015"
   ms.author="cherylmc" />

# Обзор диспетчера трафика

Диспетчер трафика Microsoft Azure дает возможность управлять распределением пользовательского трафика для заданных конечных точек, которые могут включать облачные службы Azure, веб-сайты и другие конечные точки. Диспетчер трафика применяет интеллектуальную подсистему политик в запросах DNS, касающихся доменных имен ваших интернет-ресурсов. Облачные службы и веб-сайты Azure могут выполняться в различных центрах обработки данных по всему миру.

Ниже перечислены возможности диспетчера трафика.

- **Повышение доступности критически важных приложений.** Диспетчер трафика позволяет повысить доступность важных приложений за счет мониторинга конечных точек, работающих в службе Azure, и автоматической отработки отказа при сбоях в работе облачной службы Azure, веб-сайта Azure или другого расположения.
- **Повышение скорости реагирования высокопроизводительных приложений.** Платформа Azure дает возможность запускать облачные службы и веб-сайты в распределенных по всему миру центрах обработки данных. Диспетчер трафика может уменьшить время отклика приложений и доставки содержимого конечным пользователям, направляя пользователей в конечную точку с наименьшим значением задержки в сети от клиента.
- **Обновление и обслуживание без простоя.** Диспетчер трафика поддерживает расширенные сценарии для гибридных облачных и локальных развертываний, в том числе "обработка пиков в облаке", "миграция в облако" и "отработка отказа в облаке". Чтобы выполнить плановое обслуживание, конечную точку в диспетчере трафика следует отключить, а затем подождать, пока она не обслужит существующие соединения. Если трафик в конечную точку больше не поступает, обновите службу в данной точке, протестируйте ее, а затем повторно включите ее в диспетчере трафика. Так вы сможете поддерживать и обновлять свои службы без простоя клиентов.
- **Распределение трафика в крупных и сложных развертываниях.** Благодаря вложенным профилям, в которых профиль диспетчера трафика может воспользоваться другим профилем в качестве конечной точки, вы можете создавать конфигурации, чтобы оптимизировать производительность и распределение в крупных, более сложных развертываниях. Дополнительные сведения см. в статье [Вложенные профили](#nested-profiles).

## Как работает диспетчер трафика

При настройке профиля диспетчера трафика указываемые параметры предоставляют ему информацию, необходимую для определения того, какая конечная точка должна обслужить запрос на основании запроса DNS. Трафик конечных точек не проходит через диспетчер трафика.

На *рисунке 1* показано, как диспетчер трафика направляет пользователей на одну конечную точку из набора. Числа на рисунке 1 соответствуют пронумерованным описаниям ниже.

![Как работает диспетчер трафика](./media/traffic-manager-overview/IC740854.jpg)

**Рисунок 1**

1. **Пользовательский трафик к домену компании**. Клиент запрашивает информацию с помощью имени домена компании. Целью является разрешение DNS-имени в IP-адрес. Домены компании должны быть зарезервированы с использованием нормальных регистраций доменных имен Интернета, которые обслуживаются вне диспетчера трафика. На рисунке 1 приведен пример домена компании - *www.contoso.com*.
2. **Доменное имя компании указывает на доменное имя диспетчера трафика**. Запись ресурса DNS для домена компании указывает на домен диспетчера трафика, который обслуживается в диспетчере трафика Azure. Это достигается благодаря использованию записи ресурса CNAME, которая сопоставляет доменное имя компании с доменным именем диспетчера трафика. В примере доменное имя диспетчера трафика - *contoso.trafficmanager.net*.
3. **Доменное имя и профиль диспетчера трафика**. Домен диспетчера трафика входит в состав профиля диспетчера трафика. DNS-сервер пользователя отправляет новый запрос DNS на доменное имя диспетчера трафика (в нашем примере это *contoso.trafficmanager.net*), и этот запрос принимают серверы DNS-имен диспетчера трафика.
4. **Обработка правил профиля диспетчера трафика**. На основании указанного метода балансировки нагрузки и состояния мониторинга диспетчер трафика определяет, какая конечная точка Azure или другая конечная точка должна обработать запрос.
5. **Доменное имя конечной точки, отправленное пользователю**. Диспетчер трафика возвращает запись CNAME, которая сопоставляет доменные имена диспетчера трафика и конечной точки. DNS-сервер пользователя разрешает доменное имя конечной точки в ее IP-адрес и отправляет его пользователю.
6. **Вызов конечной точки пользователем**. Пользователь вызывает возвращенную конечную точку напрямую, используя ее IP-адрес.

Поскольку домен компании и разрешенный IP-адрес кэшируются на клиентском компьютере, пользователь продолжает взаимодействовать с выбранной конечной точкой, пока не истечет срок действия локальной записи DNS в кэше. Важно отметить, что DNS-клиент кэширует записи узла DNS в течение срока их жизни (TTL). Извлечение записей узлов из кэша DNS-клиента не затрагивает профиль диспетчера трафика, что может привести к задержке подключения, если конечная точка станет недоступна до истечения срока жизни. Если срок жизни записи DNS-узла в кэше истекает и клиентскому компьютеру снова требуется разрешить доменное имя компании, он отправляет новый запрос DNS. Клиентский компьютер может получить IP-адрес другой конечной точки в зависимости от примененного метода балансировки нагрузки и работоспособности конечных точек во время запроса.

## Реализация диспетчера трафика

На *рисунке 2* пошагово показано, что необходимо сделать для реализации диспетчера трафика. Последовательность этих шагов можно немного менять, если вы четко понимаете конфигурацию диспетчера трафика и рекомендации по его использованию. Числа на рисунке 2 соответствуют пронумерованным описаниям ниже.

![Как настроить диспетчер трафика](./media/traffic-manager-overview/IC740855.jpg)

**Рисунок 2**

1. **Разверните в своей рабочей среде облачные службы и веб-сайты Azure, а также другие конечные точки**. При создании профиля диспетчера трафика его необходимо связать с подпиской. Затем в рабочей среде добавьте конечные точки для веб-сайтов уровня Standard и облачных служб, которые входят в ту же подписку. Если конечная точка находится в промежуточной среде, а не в рабочей среде Azure, или не является частью той же подписки, ее можно добавить как внешнюю конечную точку. Дополнительные сведения об облачных службах см. в статье [Облачные службы](http://go.microsoft.com/fwlink/p/?LinkId=314074). Дополнительные сведения о веб-сайтах см. в статье [Веб-сайты](http://go.microsoft.com/fwlink/p/?LinkId=393327).
2. **Выберите имя для своего домена диспетчера трафика**. Придумайте имя для своего домена с уникальным префиксом. Последняя часть домена (trafficmanager.net) является постоянной. Дополнительные сведения см. в разделе [Рекомендации](#best-practices).
3. **Выберите конфигурацию мониторинга, которую вы хотите использовать**. Диспетчер трафика отслеживает конечные точки, чтобы гарантировать их доступность, какой бы метод балансировки нагрузки ни применялся. Когда параметры мониторинга настроены, диспетчер трафика передает трафик конечным точкам, которые, согласно системе мониторинга, находятся вне сети, только если обнаруживает, что все точки находятся вне сети, или если не может определить состояние какой-либо точки в профиле. Дополнительные сведения о мониторинге см. в статье [Мониторинг диспетчера трафика](traffic-manager-monitoring.md).
4. **Выберите метод, который вы хотите использовать для балансировки нагрузки**. Доступны три различных метода балансировки нагрузки. Найдите время, чтобы понять, какой метод вам подходит лучше всего. Если потребуется изменить метод позже, то это можно сделать в любое время. Обратите внимание, что каждый метод настраивается несколько по-разному. Сведения о методах балансировки нагрузки см. в статье [О методах балансировки нагрузки диспетчера трафика](traffic-manager-load-balancing-methods.md).
5. **Создайте профиль и настройте параметры**. Для создания профиля диспетчера трафика и настройки параметров можно использовать интерфейсы API REST, Windows PowerShell или портал управления. Дополнительные сведения см. в разделе [Как настроить параметры диспетчера трафика](#how-to-configure-traffic-manager-settings). В описании следующих шагов подразумевается, что вы используете функцию **Быстрое создание** на портале управления. 
   - **Создайте профиль диспетчера трафика.** Сведения о создании профиля с помощью указанной выше функции на портале управления см. в статье [Управление профилями диспетчера трафика](traffic-manager-manage-profiles.md).
   - **Настройте параметры балансировки нагрузки.** Во время быстрого создания необходимо выбрать метод балансировки нагрузки для профиля. Этот параметр можно изменить в любое время после завершения быстрого создания. Сведения об этапах настройки см. в разделе, соответствующем нужному методу балансировки нагрузки: [Настройка балансировки нагрузки по производительности](traffic-manager-configure-performance-load-balancing.md), [Настройка отказоустойчивой балансировки нагрузки](traffic-manager-configure-failover-load-balancing.md), [Настройка балансировки нагрузки с циклическим перебором](traffic-manager-configure-round-robin-load-balancing.md).
   >[AZURE.NOTE] Метод балансировки нагрузки с циклическим перебором теперь поддерживает взвешенное распределение сетевого трафика. Только теперь для настройки веса следует использовать интерфейс API REST или Windows PowerShell. Дополнительные сведения и пример конфигурации см. в статье [Внешние конечные точки диспетчера трафика Azure и взвешенный циклический перебор с помощью PowerShell](http://azure.microsoft.com/blog/2014/06/26/azure-traffic-manager-external-endpoints-and-weighted-round-robin-via-powershell/) (на английском) в блоге Azure.

   - **Настройте конечные точки.** Конечные точки не настраиваются во время быстрого создания. Создав профиль и указав метод балансировки нагрузки, задайте конечные точки в диспетчере трафика. Инструкции по настройке конечных точек см. в статье [Управление конечными точками в диспетчере трафика](traffic-manager-endpoints.md)

   - **Настройте параметры мониторинга.** Параметры мониторинга не настраиваются во время быстрого создания. Создав профиль и указав метод балансировки нагрузки, укажите, что именно следует отслеживать диспетчеру трафика. Действия по настройке мониторинга см. в статье [Мониторинг диспетчера трафика](traffic-manager-monitoring.md).
6. **Проверьте профиль диспетчера трафика**. Убедитесь, что профиль и домен работают надлежащим образом. Сведения о том, как это сделать, см. в статье [Проверка параметров диспетчера трафика](traffic-manager-testing-settings.md).
7. **Направьте запись ресурса DNS доменного имени вашей компании на профиль, чтобы сделать его активным**. Дополнительные сведения см. в статье [Направление интернет-домена компании на домен диспетчера трафика](traffic-manager-point-internet-domain.md).

В примере на рисунке 1 необходимо изменить запись ресурса DNS на серверах на следующее значение, чтобы направить доменное имя компании на доменное имя диспетчера трафика:
    www.contoso.com IN CNAME contoso.trafficmanager.net

## Настройка параметров диспетчера трафика

Вы можете задать параметры диспетчера трафика на портале управления с помощью интерфейсов API REST или командлетов Windows PowerShell.

Хотя на портале управления отображаются не все элементы API REST, многие настройки можно задать с помощью обоих этих методов. Дополнительные сведения об использовании интерфейсов API REST см. в статье [Операции с диспетчером трафика (справочник по REST API)](http://go.microsoft.com/fwlink/p/?LinkId=313584).

Дополнительные сведения о командлетах Windows PowerShell для диспетчера трафика см. в статье [Командлеты для диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769).

>[AZURE.NOTE] Сейчас не поддерживается настройка внешних конечных точек (тип "Любые"), весов для метода балансировки нагрузки с циклическим перебором и вложенных профилей на портале управления. Используйте REST (см. статью [Создание определения](http://go.microsoft.com/fwlink/p/?LinkId=400772)) или Windows PowerShell (см. статью [Add-AzureTrafficManagerEndpoint](https://msdn.microsoft.com/library/azure/dn690257.aspx)) (на английском).

### Настройка параметров на портале управления

На портале управления с помощью функции быстрого создания можно создать собственный профиль диспетчера трафика. Функция быстрого создания дает возможность создать базовый профиль. Создав профиль, вы можете задать дополнительные настройки либо изменить настройки, заданные ранее. Дополнительные сведения о создании профиля диспетчера трафика с помощью функции быстрого создания см. в статье [Управление профилями диспетчера трафика](traffic-manager-manage-profiles.md).

Вот какие параметры вы можете настроить на портале управления:

- **Префикс DNS.** Уникальный префикс, который создаете вы. Профили отображаются на портале управления по префиксу.
- **Срок жизни DNS.** Значение срока жизни (TTL) DNS определяет, как часто сервер имен локального кэширования клиента будет запрашивать обновленные DNS-записи в системе DNS диспетчера трафика Azure.
- **Подписка.** Выберите подписку, которой будет соответствовать ваш профиль. Обратите внимание, что этот параметр отображается, только если у вас несколько подписок.
- **Метод балансировки нагрузки.** Это способ, который диспетчер трафика будет использовать для балансировки нагрузки.
- **Порядок отработки отказа.** Это порядок конечных точек при использовании метода отказоустойчивой балансировки нагрузки.
- **Мониторинг.** Параметры мониторинга включают в себя протокол (HTTP или HTTPS), порт, относительный путь и имя файла.

### Настройка параметров с помощью интерфейсов API REST

Вы можете создать и настроить профиль диспетчера трафика с помощью интерфейсов API REST. Дополнительные сведения см. в статье [Операции с диспетчером трафика (справочник по REST API)](http://go.microsoft.com/fwlink/?LinkId=313584).

- **Профиль** содержит префикс доменного имени, которое создаете вы. Каждый профиль соответствует одной подписке. Вы можете создать несколько профилей для каждой подписки. Имя профиля отображается на портале управления. Созданное вами имя, которое содержится в профиле, называется доменом диспетчера трафика.
- **Определение** содержит параметры политики и монитора. Определение соответствует профилю. Профилю может соответствовать только одно определение. Само определение не отображается на портале управления, хотя многие его параметры можно видеть и настраивать на этом портале.
- **Параметры DNS** есть в каждом определении. В них указывается срок жизни DNS.
- **Мониторы.** Их параметры содержатся в каждом определении. Здесь можно настроить протокол, порт, относительный путь и имя файла. Параметры мониторов отображаются и могут быть изменены на портале управления. Дополнительные сведения см. в статье [Мониторинг диспетчера трафика](traffic-manager-monitoring.md).
- **Политика.** Ее параметры есть в каждом определении. В политике задаются методы балансировки нагрузки и конечные точки. Политика не отображается на портале управления, хотя некоторые параметры, которые касаются ее, можно видеть и настраивать на этом портале. Дополнительные сведения см. в статье [О методах балансировки нагрузки диспетчера трафика](traffic-manager-load-balancing-methods.md).

## Настройка параметров с помощью Windows PowerShell

Вы можете создать и настроить профиль диспетчера трафика с помощью оболочки Windows PowerShell. Дополнительные сведения см. в статье [Командлеты диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769).

## Рекомендации

- **Сделайте свои префиксы уникальными и легкими для понимания.** DNS-имя вашего профиля диспетчера трафика должно быть уникальным. Вы можете изменять только первую часть DNS-имени. Доменное имя диспетчера трафика используется только для идентификации и направления клиентских запросов. Клиентские компьютеры никогда не отображают эти имена конечным пользователям. Однако это доменное имя определяет профили, поэтому важно, чтобы вы могли быстро отличить его от других доменных имен, указанных на портале управления.
- **Используйте точки для обеспечения уникальности или облегчения чтения доменных имен.** Вы можете использовать точки также для разделения частей префикса доменного имени.  Если вы планируете создать несколько политик в диспетчере трафика, то, чтобы различать службы, используйте согласованную иерархию. Например, в Contoso присутствуют глобальные службы для работы в Интернете, выставления счетов и управления программами. Вот какие три политики будут использованы в этом случае:  *web.contoso.trafficmanager.net*, *bill.contoso.trafficmanager.net* и *util.contoso.trafficmanager.net*. При настройке облачных служб и веб-сайтов, используйте имена, указывающие на расположение. Например, *web-us-contoso.cloudapp.net* и *web-asia-contoso.cloudapp.net*. Ограничения накладываются системой DNS. Предположим, доменное имя - это последовательность меток, разделенных точками (label.label.label.label.etc.). Когда составляли эту документацию, в диспетчере трафика на имена доменов накладывались ограничения, указанные ниже.
   - Каждая метка может содержать не более 63 символов.
   - Количество меток не должно превышать 40. Две метки занимает trafficmanager.net, поэтому для префикса остается 38.
   - Длина доменного имени не может превышать 253 символа. Не забывайте, что элемент trafficmanager.net занимает 19 из этих символов.
- **Срок жизни DNS.** Значение срока жизни DNS определяет, как часто клиентский сервер имен локального кэширования будет запрашивать обновленные DNS-записи в системе DNS диспетчера трафика Azure. Для любого изменения, происходящего в диспетчере трафика (например, изменения профиля или доступности конечной точки), потребуется этот промежуток времени, чтобы оно распространилось по глобальной системе DNS-серверов. Мы рекомендуем оставить для этого параметра значение по умолчанию - 300 секунд (5 минут). При более высоких значениях сопоставители и клиенты DNS дольше хранят в кэше ответы DNS диспетчера трафика, и поэтому общая задержка обработки запросов DNS уменьшается. Однако если требуется быстрая отработка отказа, то лучше задать более низкое значение.
- **Конечные точки должны принадлежать одной подписке.** Все конечные точки должны находиться в той же подписке, в которой создается профиль. Вы можете добавить конечные точки из разных подписок в профиль как внешние, но, если отключить или удалить связанную службу, Azure не удалит их автоматически. В результате внешние конечные точки сохранятся в профиле диспетчера трафика и за них будет взиматься плата, пока вы не удалите их вручную.
- **Только службы рабочей среды.** Доступны только конечные точки в рабочей среде. Вы не можете направлять трафик на конечные точки, работающие в промежуточной среде. Обратите внимание, что если переключить виртуальный IP-адрес, когда профиль направляет трафик, то трафик будет использовать конечную точку, только что введенную в рабочую среду.
- **Задайте имена конечных точек, которые можно легко идентифицировать.** Подумайте, какой префикс DNS лучше всего указать. DNS-имя используется потому, что оно гарантирует уникальность в подписке, тогда как имя облачной службы или веб-сайта этого гарантировать не может. Во избежание путаницы задайте облачной службе или веб-сайту одинаковые или схожие имя и префикс DNS. Если у вас есть 20 облачных служб и веб-сайтов, неправильно выбранные имена могут затруднять поиск конечных точек. Кроме того, конечные точки, названные не так, как нужно, затрудняют обслуживание профилей.
- **Все конечные точки в профиле должны обслуживать одни и те же операции и порты.** Если перепутать конечные точки, велика вероятность того, что клиент вызовет конечную точку, которая не сможет обслужить его запрос.
- **Все облачные службы в профиле должны использовать одни и те же параметры мониторинга.** Для отслеживания всех конечных точек в заданном определении можно выбрать только один путь и файл. Вы можете ввести знак "/" в текстовое поле **Относительный путь и имя файла**, и система мониторинга будет пытаться получить доступ к пути и имени файла по умолчанию.
- **Отключайте конечные точки для внесения временных изменений, а не меняйте конфигурацию.** Во многих случаях может понадобиться перевести конечную точку в режим "вне сети". Вместо удаления из профиля просто отключите конкретную конечную точку в профиле. При этом конечная точка остается частью профиля, но профиль действует так, как будто она в него не включена. Такое решение очень удобно для временного удаления конечной точки, которая находится в режиме обслуживания или повторно развертывается. После повторного запуска конечной точкой ее можно включить. Дополнительные сведения см. в статье [Управление конечными точками в диспетчере трафика](traffic-manager-endpoints.md).
- **Отключайте профиль для внесения временных изменений, а не удаляйте его.** Бывает необходимо перевести весь профиль в режим "вне сети", а не только отдельные конечные точки в нем. Для этого отключите профиль. При отключении профиля все параметры остаются доступными для правки на портале управления. Позже, когда появится необходимость снова его использовать, профиль можно легко и просто перевести в режим "в сети". Дополнительные сведения см. в статье [Управление конечными точками в диспетчере трафика](traffic-manager-endpoints.md).
- **Хранилище.** При использовании диспетчера трафика очень важно правильно спланировать размещение и распределение данных в хранилище. Разрабатывая и развертывая приложения для диспетчера трафика, учтите такие факторы, как сквозная транзакция и перемещение данных.
- **SQL Azure.** Когда вы расширяете конечные точки до нескольких географических регионов, то, как и при проектировании хранилища, проанализируйте состояние приложения и требования к данным для него.

## Вложенные профили

В качестве конечной точки вы можете указать имя другого профиля диспетчера трафика (это называется вложением профилей). Именем профиля диспетчера трафика является соответствующее DNS-имя, например, contoso-europe.trafficmanager.net.

Это дает возможность настраивать диспетчер трафика так, чтобы входящие запросы DNS-имен анализировались в наборе уровней. Благодаря этому запрашивающий клиент направляется в правильный набор конечных точек. На  *Figure 3* приведен пример.

![Пример вложенных профилей диспетчера трафика](./media/traffic-manager-overview/IC751072.png)

**Рисунок 3**

Вы можете вложить до 10 уровней и при этом настроить для каждого профиля отдельный метод балансировки нагрузки.

Например, вы можете создать конфигурацию для такой задачи:

- На верхнем уровне (профиль диспетчера трафика, который сопоставляется с внешним DNS-именем) можно настроить профиль с методом балансировки нагрузки по производительности.
- На среднем уровне набор профилей диспетчера трафика представляет собой разные центры обработки данных и использует метод балансировки нагрузки с циклическим перебором.
- На нижнем уровне запросы пользователя на трафик обслуживает набор конечных точек облачной службы в каждом центре обработки данных.

В результате пользователи направляются в свой региональный центр обработки данных на основании производительности и в облачную службу в этом центре обработки данных на основании равномерного или взвешенного распределения нагрузки. Например, чтобы направить небольшую долю трафика на новое или тестовое развертывание для тестирования или получения отзывов, может использоваться взвешивание.

На *рисунке 4* показана такая конфигурация.

![Пример многоуровневых профилей диспетчера трафика](./media/traffic-manager-overview/IC751073.png)

**Рисунок 4**

На  *Figure 4* профиль диспетчера трафика на верхнем уровне является родительским, а его профили на среднем уровне - дочерними.

Если диспетчер трафика направляет пользователей к дочернему профилю с небольшим числом работоспособных конечных точек, может пострадать производительность и может произойти перегрузка этих конечных точек. Чтобы избежать этого, в родительском профиле диспетчера трафика можно указать пороговое количество работоспособных конечных точек. Это количество определяет, может ли получать трафик та или иная конечная точка в соответствующих дочерних профилях. Например, если нужно, чтобы дочерние профили содержали по крайней мере три работоспособные конечные точки, пороговое значение должно быть равным 3. В примере на рисунке 4 для этого порогового значения настроен профиль диспетчера трафика верхнего уровня.

Чтобы добавить профиль диспетчера трафика как конечную точку и настроить минимальное количество работоспособных конечных точек, нужно использовать REST (см. статью [Создание определения](http://go.microsoft.com/fwlink/p/?LinkId=400772)) или Windows PowerShell (см. статью [Add-AzureTrafficManagerEndpoint](https://msdn.microsoft.com/library/azure/dn690257.aspx)) (на английском). Вы не можете использовать портал управления для этого.

## Рисунки диспетчера трафика

Если рисунки из этой статьи вы хотите использовать как слайды презентации PowerPoint, касающейся диспетчера трафика, или для своих личных целей, см. статью [Схемы диспетчера трафика в документации MSDN](http://gallery.technet.microsoft.com/Traffic-Manager-figures-in-887e7c99).

## См. также

[Облачные службы](http://go.microsoft.com/fwlink/p/?LinkId=314074)

[Веб-сайты](http://go.microsoft.com/fwlink/p/?LinkId=393327)

[Операции с диспетчером трафика (справочник по REST API)](http://go.microsoft.com/fwlink/p/?LinkId=313584)

[Командлеты диспетчера трафика Azure](http://go.microsoft.com/fwlink/p/?LinkId=400769)

<!--HONumber=49-->