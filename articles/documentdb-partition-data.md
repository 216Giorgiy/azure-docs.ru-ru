<properties      
    pageTitle="Секционирование данных в DocumentDB | Azure"
    description="Узнайте, как секционировать данные в DocumentDB и когда использовать секционирование по хэшу, диапазону и подстановке."
	services="documentdb"
    authors="arramac"      
    manager="johnmac"      
    editor="monicar"      
    documentationCenter=""/> 
<tags      
    ms.service="documentdb"      
    ms.workload="data-services"      
    ms.tgt_pltfrm="na"      
    ms.devlang="na"      
    ms.topic="article"      
    ms.date="02/20/2015"      
    ms.author="arramac"/> 

# Секционирование данных в DocumentDB

Система [Microsoft Azure DocumentDB](../../services/documentdb/) разработана таким образом, чтобы обеспечивать высокую и прогнозируемую производительность и легко осуществлять *scale-out* параллельно с ростом вашего приложения. DocumentDB используется для выполнения рабочих служб Microsoft с высокими требованиями к масштабированию, например, хранилища пользовательских данных, на котором основана работа целого набора MSN из веб-приложений и мобильных приложений. 

Вы можете практически бесконечно осуществлять масштабирование хранилище и пропускной способности для своего приложения DocumentDB за счет горизонтального секционирования данных, которое часто называют **сегментированием**.  Учетные записи DocumentDB можно масштабировать с линейным ростом затрат с помощью наращиваемых модулей - **коллекций**. Оптимальное секционирование данных по коллекциям зависит от формата данных и схем доступа. 

После прочтения этой статьи вы сможете ответить на следующие вопросы:   

 - Что такое секционирование по хэшу, диапазону и подстановке?
 - Когда следует использовать методику секционирования и почему?
 - Как создать секционированное приложение на базе Azure DocumentDB?

## Коллекции = разделы

Прежде чем углубиться в методики секционирования данных, важно понять, что такое коллекция и чем она не является. Как вы уже можете знать, коллекция - это контейнер для ваших документов JSON. Коллекции в DocumentDB - это не просто *logical* контейнеры, это также и *physical* контейнеры. Они являются границей транзакции для хранимых процедур и триггеров, а также конечной точкой для запросов и операций CRUD. Каждой коллекции назначен зарезервированный объем пропускной способности, который не предоставляется для общего доступа другим коллекциям в данной учетной записи. Таким образом, вы можете масштабировать свое приложение как по хранилищу, так и по пропускной способности, добавляя больше коллекций, а затем распределяя по ним документы.

Коллекции отличаются от таблиц в реляционных базах данных тем, что не применяют схему. Поэтому вы можете хранить разные типы документов с разными схемами в одной коллекции. При этом вы можете использовать коллекции и аналогично таблицам, храня в них объекты одного типа. Оптимальная модель зависит только от того, как данные совместно отображаются в запросах и транзакциях.

## Секционирование с помощью DocumentDB

Наиболее распространенными методами, используемыми для секционирования данных с помощью Azure DocumentDB, являются  *range partitioning*, *lookup partitioning* и *hash partitioning*. Обычно вы обозначаете имя отдельного свойства JSON в документе в качестве ключа раздела, такого как "timestamp" или "userID". В некоторых случаях может использоваться внутреннее свойство JSON или новое имя свойства для каждого отличного типа документа.

Давайте рассмотрим эти методики подробнее.

## Секционирование по диапазону

При секционировании по диапазону разделы назначаются в зависимости от того, входит ли ключ раздела в определенный диапазон. Это часто используется для секционирования с использованием свойств *time stamp* (например, eventTime между 1 февраля 2015 года и 2 февраля 2015 года). 

> [AZURE.TIP] Вам следует использовать секционирование по диапазону, если запросы ограничены определенными значениями диапазона для ключа раздела.

## Секционирование по подстановке

При секционировании по подстановке разделы назначаются на основании схемы подстановок, которая назначает дискретные значения раздела определенным разделам, ее еще называют схемой разделов или сегментов. Это часто используется для секционирования по области (например, раздел для Скандинавии содержит Норвегию, Данию и Швецию).

> [AZURE.TIP] Секционирование по подстановке обеспечивает максимальный уровень контроля при управлении мультитенантным приложением. Вы можете назначить несколько клиентов одной коллекции, одного клиента одной коллекции и даже одного клиента нескольким коллекциям. 

## Секционирование по хэшу

При секционировании по хэшу разделы назначаются на основе значения хэш-функции, что позволяет равномерно распределить запросы и данные по нескольким разделам. Это часто используется для секционирования данных, выводимых или используемых большим количеством уникальных клиентов и крайне удобно для хранения профилей пользователей, элементов каталога и данных телеметрии Интернета вещей. 

> [AZURE.TIP] Секционирование по хэшу следует использовать, когда присутствует слишком много сущностей для перечисления в рамках секционирования по подстановке (например, пользователей или устройств), а частота запросов у всех этих сущностей довольно однородна.

## Выбор правильной методики секционирования

Так какая методика секционирования подходит именно вам? Это зависит от типа данных и распространенных схем доступа. Выбор правильной методики секционирования во время разработки позволяет избежать технического долга, а также оперативно справляться с ростом объема данных и количества запросов.

- **Секционирование по диапазону** чаще всего используется в контексте дат, так как предоставляет  простой и понятный механизм реализации старения разделов по метке времени. Это также удобно, когда запросы в общем случае ограничиваются временным диапазоном, так как он соответствует границам секционирования. 
- **Секционирование по подстановке** позволяет удобно группировать и упорядочивать не сортированные и не связанные наборы данных, например группировать клиентов по организации или государства по географическому региону. Подстановка также обеспечивает точное управление данными, переносимыми между коллекциями. 
- **Секционирование по хэшу** удобно для обеспечения равномерной балансировки нагрузки для запросов, чтобы повысить эффективность использования хранилища и пропускной способности. Использование алгоритмов *consistent hashing* позволяет минимизировать объем данных, которые требуется перемещать при добавлении или удалении раздела.

Вам не нужно выбирать лишь одну методику секционирования.  *composite* этих методик также может оказаться полезным в определенной ситуации. Например, если вы храните данные телеметрии транспортного средства, данные телеметрии устройства лучше секционировать по диапазону на базе метки времени, чтобы упростить управление разделами, а затем выполнить вложенное секционирование по идентификационному номеру автомобиля VIN, чтобы иметь возможность для горизонтального масштабирования по пропускной способности (сочетание секционирования по диапазону и хэшу).

## Разработка секционированного приложения
Существует три ключевых области, на которые нужно обратить внимание при разработке секционированного приложения на базе DocumentDB.

- Как вы осуществляете маршрутизацию своих операций создания и чтения (включая запросы) в подходящие коллекции.
- Как вы сохраняете и получаете конфигурацию разрешения разделов, то есть схемы разделов.
- Как вы добавляете/удаляете разделы при увеличении объема данных и запросов.

Давайте подробнее рассмотрим каждую из этих областей.

## Маршрутизация операций создания и запросов

Маршрутизация запросов на создание документов довольно проста для всех трех рассмотренных здесь методик. Документ создается в разделе из значения хэша, подстановки или диапазона, соответствующего ключу раздела.

Запросы и операции чтения в общем случае следует группировать по одному ключу раздела, чтобы запросы можно было размножать только в соответствующие разделы. Однако в случае с запросами по всем данным требуется *fan-out* запрос на нескольких разделах, а затем объединить результаты. Помните, что некоторые запросы должны выполнять настраиваемую логическую схему для объединения результатов, например при получении N первых результатов.

## Управление схемой разделов

Вам также потребуется решить, как хранить схему разделов, как клиенты загружают эту схему и получают обновления в случае ее изменения, а также порядок ее совместного использования несколькими клиентами. Если схема разделов меняется довольно редко, можно просто сохранить ее в файле конфигурации вашего приложения. 

В противном случае можно сохранить ее в любом постоянном хранилище. Распространенный конструктивный шаблон в рабочей среде заключается в сериализации схем разделов в виде JSON и сохранение в коллекциях DocumentDB. После этого клиенты могут кэшировать схему, чтобы избежать дополнительных круговых путей, а затем периодически производить опрос на наличие изменений. Если ваши клиенты могут изменить схему сегментов, убедитесь, что они используют согласованную схему именования и оптимистическую блокировку (теги eTag), чтобы реализовать согласованное обновление схемы разделов.

## Добавление и удаление разделов

С помощью DocumentDB вы можете в любое время добавлять и удалять коллекции и использовать их для хранения новых входящих данных или перераспределения данных, доступных в имеющихся коллекциях. Сведения о количестве коллекций см. на странице [Ограничения](documentdb-limits). Вы всегда можете связаться с нами, чтобы расширит эти ограничения.

Добавление и удаление раздела с использованием секционирования по диапазону и подстановке довольно очевидно. Например, чтобы добавить новый географический регион или новый часовой пояс для недавних данных, достаточно добавить новые разделы в схему разделов. Разделение имеющегося раздела на несколько разделов или слияние двух разделов требует немного больше усилий. Вам нужно: 

- отключить сегмент от сети для операций чтения либо
- перенаправить операции чтения в оба раздела с помощью старой конфигурации секционирования, а также новой конфигурации секционирования во время миграции. Обратите внимание на то, что гарантии  по транзакциям и уровню согласованности не действуют до тех пор, пока миграция не будет завершена.

Хэширование значительно сложнее с точки зрения добавления и удаления разделов. Простые методики хэширования вызывают перетасовку и требуют перемещения большего объема данных. Применение **согласованного хэширования** позволяет перемещать только часть данных.

Относительно простой способ добавления новых разделов без перемещения данных заключается в "переброске" данных в свежую коллекцию с последующим размножением запросов по старой и новой коллекциям. Однако такой подход следует использовать лишь в редких случаях (например, перебросить данные во время пиковых рабочих нагрузок и временно хранить эти данные, пока их нельзя будет переместить).

### Дальнейшие действия
В этой статье мы представили некоторые распространенные методики, которые можно применять для сегментирования данных с помощью DocumentDB, и описали ситуации, в которых следует использовать данные методики или их сочетания. Приступайте к работе с одним из [поддерживаемых пакетов SDK](https://msdn.microsoft.com/library/azure/dn781482.aspx), а при наличии вопросов свяжитесь с нами через [форумы службы поддержки MSDN](https://social.msdn.microsoft.com/forums/azure/home?forum=AzureDocumentDB).


<!--HONumber=49-->