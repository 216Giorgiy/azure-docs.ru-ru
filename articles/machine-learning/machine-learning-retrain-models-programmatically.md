<properties
	pageTitle="Программное переобучение моделей машинного обучения | Microsoft Azure"
	description="Узнайте о том, как осуществить программное переобучение модели и обновить веб-службу так, чтобы она использовала переобученную модель при задействовании функций машинного обучения Azure."
	services="machine-learning"
	documentationCenter=""
	authors="raymondlaghaeian"
	manager="paulettm"
	editor="cgronlun"/>

<tags
	ms.service="machine-learning"
	ms.workload="data-services"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/01/2015"
	ms.author="raymondl;garye"/>


#Программное переобучение моделей машинного обучения  

В рамках процесса операционализации моделей машинного обучения в машинном обучении Azure модель необходимо обучить и сохранить, после чего ее следует использовать при создании веб-службы оценки. Созданная веб-служба может впоследствии использоваться на веб-сайтах, панелях мониторинга и в мобильных приложениях.

Часто с получением новых данных требуется переобучить модель, созданную на первом этапе. Ранее это было возможно только с помощью графического интерфейса Azure ML, однако с вводом интерфейса API программного повторного обучения в настоящее время можно переобучить модель и обновить веб-службу, а также использовать по-новому обученную модель путем программного применения интерфейсов API переобучения.

В этом документе описывается вышеуказанный процесс и показывается, как использовать интерфейсы API повторного обучения.

[AZURE.INCLUDE [machine-learning-free-trial](../../includes/machine-learning-free-trial.md)]


##Зачем нужно повторное обучение: определение проблемы  
В рамках процесса обучения ML модель обучается с использованием определенного набора данных. Моделям необходимо повторное обучение в тех сценариях, в которых становятся доступными новые данные, когда потребитель API имеет собственные данные для обучения модели или когда данные необходимо фильтровать, а модель — обучать при помощи специального поднабора данных и т. п.

В этих сценариях программный API обеспечивает для вас или потребителя API удобный способ создания клиента, который может единовременно или регулярно переобучать модель при помощи собственных данных. После этого можно оценить результаты переобучения и обновить API веб-службы, чтобы использовать его с недавно обученной моделью.

##Как выполнить переобучение: полный цикл процесса  
Чтобы начать, необходимы следующие компоненты: обучающий эксперимент и оценивающий эксперимент, опубликованные в виде веб-службы. Чтобы включить переобучение обученной модели, обучающий эксперимент необходимо также опубликовать в виде веб-службы, выход которой будет представлять собой обученную модель. Это позволит использовать API-доступ для переобучения модели. Процесс настройки повторного обучения включает следующие шаги.

![][1]

Схема 1. Обзор процесса повторного обучения

1. *Создание обучающего эксперимента* В этом примере мы будем использовать эксперимент "Образец 5 (обучение, тестирование, оценка для классификации бинарных файлов: набор данных с контентом для взрослых)" из сборника образцов экспериментов Azure ML. Как вы увидите ниже, я упростил этот образец, удалив некоторые модули. Я также назвал эксперимент "Модель ценза".

 	![][2]

	Когда эти элементы находятся на своем месте, можно нажать "Выполнить" в нижней части экрана, чтобы запустить этот эксперимент.  
2. *Создание оценочного эксперимента и опубликование его в виде веб-службы*  

	![][3]

	После того как выполнение эксперимента будет завершено, мы используем функцию "Создать оценочный эксперимент". При этом создается оценочный эксперимент, модель сохраняется в виде обученной модели и добавляются модули ввода и вывода данных веб-службы, как показано ниже. Затем щелкнем "Выполнить".

	После завершения выполнения эксперимента и нажатия кнопки "Опубликовать веб-службу" оценочный эксперимент будет опубликован в виде веб-службы, при этом будет создана конечная точка по умолчанию. Обученная модель в этой веб-службе может обновляться, как показано ниже. Данные для этой конечной точки затем будут отображаться на экране.  
3. *Публикация обучающего эксперимента в виде веб-службы* Чтобы переобучить обученную модель, нам потребуется опубликовать обучающий эксперимент, созданный на шаге 1 выше, в качестве веб-службы. Этой веб-службе для создания новых обученных моделей потребуется выходной модуль, подключенный к модулю [Обучение модели][train-model]. Щелкните значок "Эксперименты" на левой панели, затем выберите эксперимент "Модель ценза", чтобы вернуться в обучающий эксперимент.  

	Затем добавим один модуль ввода и два модуля вывода веб-службы в рабочий процесс. Выходные данные веб-службы для модели обучения позволят создать новую обученную модель. Выходные данные, прикрепленные к модели оценки, возвратят выходные данные процесса "Оценка модели".

	Теперь можно нажать "Выполнить". После завершения эксперимента итоговый рабочий процесс должен выглядеть следующим образом.

	![][4]

	Далее нажмем кнопку "Опубликовать веб-службу", затем "Да". При этом обучающий эксперимент будет опубликован в качестве веб-службы, которая создаст обученную модель и результаты их оценки. Панели мониторинга веб-службы будут отображаться с ключом API и со страницей справки API для пакетного выполнения. Обратите внимание, что метод пакетного выполнения может использоваться для создания обученных моделей.  
4. *Добавление новой конечной точки* Веб-служба оценки, которую мы опубликовали на шаге 2 выше, была создана с конечной точкой по умолчанию. Конечные точки по умолчанию синхронизируются с исходными экспериментами по обучению и оценке, поэтому обученную модель конечной точки по умолчанию нельзя заменить. Чтобы создать обновляемую конечную точку, посетите портал Azure и щелкните "Добавить конечную точку" (более подробно см. [здесь](machine-learning-create-endpoint.md)).

5. *Переобучение модели с помощью новых данных и BES* Чтобы вызывать API переобучения, создадим новое приложение для консоли C# в Visual Studio (Создать->Проект->Рабочий стол Windows->Консольное приложение).

	Затем скопируем образец кода на C# со страницы справки API веб-службы обучения для пакетного выполнения (создан на шаге 3 выше) и вставим его в файл Program.cs, убедившись, что пространство имен остается в неизменном виде.

	Обратите внимание, что образец кода содержит комментарии, указывающие на части кода, которые необходимо обновить. Кроме того, при указании расположения "output1" в полезных данных запроса расширение файла "RelativeLocation" необходимо изменить на .ilearner как показано далее:

	```c#
	Outputs = new Dictionary<string, AzureBlobDataReference>()
	{
		{
			"output1",
			new AzureBlobDataReference()
			{
				ConnectionString = "DefaultEndpointsProtocol=https;AccountName=mystorageacct;AccountKey=Dx9WbMIThAvXRQWap/aLnxT9LV5txxw==",
				RelativeLocation = "mycontainer/output1results.ilearner"
			}
		},
	},
	```
	1. Предоставление сведений хранилища Azure Образец кода для BES выгрузит файл с локального диска (например, C:\\temp\\CensusIpnput.csv) в хранилище Azure, обработает его и снова запишет результаты в хранилище Azure.  

		Для этого потребуется получить имя учетной записи хранения, ключ и сведения о контейнере на портале управления Azure для вашей учетной записи хранения и кода для обновления здесь. Также нужно обеспечить доступность файла вводных данных в местоположении, указанном в коде.

		Мы настроили этот обучающий эксперимент так, что у него есть два интерфейса вывода, поэтому результаты будут содержать сведения о местоположении хранилища для них обоих, как показано ниже. "выход1" — это выход для обученной модели, а "выход2" — выход для модели оценки. Кроме того, обратите внимание, что расширение файла Output для обученной модели (Output1) — .ilearner, а не .csv.

		![][6]

6. *Оценка результатов переобучения* Используя сочетание значений параметров BaseLocation, RelativeLocaiton и SasBlobToken из вышеописанных результатов вывода "выход2", мы увидим результаты работы переобученной модели, вставив полный URL-адрес в адресную строку браузера.

	Эти данные покажут, достаточно ли хорошо работает только что обученная модель, чтобы заменить существующую.

7. *Обновление обученной модели добавленной конечной точки* Чтобы завершить процесс, потребуется обновить обученную модель, указав конечную точку оценки, которую мы создали на шаге 4 выше.

	Вышеописанные выходные данные BES отображают сведения о результате переобучения для интерфейса "выход1", который содержит сведения о местоположении переобученной модели. Теперь нужно взять эту обученную модель и обновить конечную точку оценки (созданную на шаге 4 выше). Пример кода выглядит следующим образом:

	```C#
	private async Task OverwriteModel()
	{
		var resourceLocations = new
		{
			Resources = new[]
			{
				new
				{
					Name = "Census Model [trained model]",
					Location = new AzureBlobDataReference()
					{
						BaseLocation = "https://esintussouthsus.blob.core.windows.net/",
						RelativeLocation = "your endpoint relative location", //from the output, for example: “experimentoutput/8946abfd-79d6-4438-89a9-3e5d109183/8946abfd-79d6-4438-89a9-3e5d109183.ilearner”
						SasBlobToken = "your endpoint SAS blob token" //from the output, for example: “?sv=2013-08-15&sr=c&sig=37lTTfngRwxCcf94%3D&st=2015-01-30T22%3A53%3A06Z&se=2015-01-31T22%3A58%3A06Z&sp=rl”
					}
				}
			}
		};

		using (var client = new HttpClient())
		{
			client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", apiKey);

			using (var request = new HttpRequestMessage(new HttpMethod("PATCH"), endpointUrl))
			{
				request.Content = new StringContent(JsonConvert.SerializeObject(resourceLocations), System.Text.Encoding.UTF8, "application/json");
				HttpResponseMessage response = await client.SendAsync(request);

				if (!response.IsSuccessStatusCode)
				{
					await WriteFailedResponse(response);
				}

				// Do what you want with a successful response here.
			}
		}
	}
	```

	Параметры apiKey и endpointUrl для этого вызова отображаются на панели мониторинга конечной точки.

	При успехе этого вызова новая конечная точка начнет использовать переобученную модель примерно через 15 секунд.

##Сводка  
При помощи интерфейсов API переобучения можно обновить обученную модель прогнозирующей веб-службы, обеспечивая возможность использования таких сценариев, как периодическое переобучение модели с использованием новых данных или распространение моделей клиентам с возможностью переобучения модели на основе собственных данных.

[1]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE01.png
[2]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE02.png
[3]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE03.png
[4]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE04.png
[5]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE05.png
[6]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE06.png


<!-- Module References -->
[train-model]: https://msdn.microsoft.com/library/azure/5cc7053e-aa30-450d-96c0-dae4be720977/

<!---HONumber=Sept15_HO2-->