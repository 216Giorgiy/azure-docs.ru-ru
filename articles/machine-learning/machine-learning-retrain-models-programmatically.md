<properties
	pageTitle="Программное переобучение моделей машинного обучения | Microsoft Azure"
	description="Узнайте, как программно переобучить модель и обновить веб-службу так, чтобы она использовала заново обученную модель в Машинном обучении Azure."
	services="machine-learning"
	documentationCenter=""
	authors="raymondlaghaeian"
	manager="paulettm"
	editor="cgronlun"/>

<tags
	ms.service="machine-learning"
	ms.workload="data-services"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/28/2016"
	ms.author="raymondl;garye;v-donglo"/>


#Программное переобучение моделей машинного обучения  

В рамках процесса операционализации моделей машинного обучения в Машинном обучении Azure модель обучается и сохраняется. После этого она используется для создания прогнозной веб-службы. Созданная веб-служба может впоследствии использоваться на веб-сайтах, панелях мониторинга и в мобильных приложениях.

Модели, создаваемые с помощью машинного обучения, обычно не статические. Если появляются новые данные или у пользователя API есть свои данные, модель нужно переобучить. Кроме того, может потребоваться применить фильтры, получить подмножество данных и переобучить модель.

Переобучение может требоваться достаточно часто. Интерфейс API программного переобучения позволяет программным путем переобучить модель с помощью API переобучения и обновить веб-службу, чтобы она использовала эту модель.

В этом документе описана процедура переобучения и показано, как использовать интерфейсы API переобучения.

## Зачем нужно повторное обучение: определение проблемы  

В рамках процесса машинного обучения модель обучается с использованием определенного набора данных. Модели, создаваемые с помощью машинного обучения, обычно не статические. Если появляются новые данные или у пользователя API есть свои данные, модель нужно переобучить. Иногда может потребоваться применить фильтры, получить подмножество данных и повторно обучить модель.

В этих сценариях программный API обеспечивает для вас или потребителя API удобный способ создания клиента, который может единовременно или регулярно переобучать модель при помощи собственных данных. После этого можно оценить результаты переобучения и обновить API веб-службы, чтобы использовать его с недавно обученной моделью.

##Как выполнить переобучение: полный цикл процесса  

Чтобы начать, необходимы следующие компоненты: обучающий эксперимент и прогнозный эксперимент, опубликованный в виде веб-службы. Чтобы включить переобучение обученной модели, обучающий эксперимент необходимо опубликовать в виде веб-службы, выходные данные которой будут представлять собой обученную модель. Это позволит использовать API-доступ для переобучения модели.

Процесс настройки переобучения для классической веб-службы включает в себя следующие шаги:

![Обзор процесса переобучения][1]

Схема 1. Обзор процесса переобучения для классической веб-службы

Процесс настройки переобучения для новой веб-службы включает в себя следующие шаги:

![Обзор процесса переобучения][7]

Схема 2. Обзор процесса переобучения для новой веб-службы

## Создание обучающего эксперимента
 
В этой статье используется пример "Sample 5: Train, Test, Evaluate for Binary Classification: Adult Dataset" (Образец 5. Обучение, тестирование, анализ для классификации бинарных файлов: набор данных с содержимым для взрослых) из каталога образцов Машинного обучения Microsoft Azure.
	
Чтобы создать эксперимент:

1.	Войдите в Студию машинного обучения Microsoft Azure.
2.	В нижнем правом углу панели мониторинга щелкните **Создать**.
3.	В списке образцов Майкрософт выберите образец 5.
4.	Чтобы переименовать эксперимент, в верхней части холста эксперимента выберите имя эксперимента "Sample 5: Train, Test, Evaluate for Binary Classification: Adult Dataset" (Образец 5. Обучение, тестирование, анализ для классификации бинарных файлов: набор данных с содержимым для взрослых).
5.	Введите "Модель ценза".
6.	В нижней части холста эксперимента нажмите кнопку **Run** (Выполнить).
7.	Щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Retraining Web Service** (Переобучение веб-службы).

 	![Исходный эксперимент][2]

Схема 2. Исходный эксперимент

## Создание оценочного эксперимента и опубликование его в виде веб-службы  

Теперь нужно создать прогнозный эксперимент.

1.	В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Predictive Web Service** (Прогнозная веб-служба). При этом модель сохраняется в качестве обученной и добавляются модули входных и выходных данных веб-службы.
2.	Щелкните **Выполнить**.
3.	После завершения выполнения эксперимента щелкните **Deploy Web Service [Classic]** (Развернуть веб-службу [классическую]) или **Deploy Web Service [New]** (Развернуть веб-службу [новую]).

## Развертывание обучающего эксперимента в качестве обучающей веб-службы

Чтобы переобучить обученную модель, необходимо развернуть обучающий эксперимент, созданный в качестве веб-службы переобучения. Этой веб-службе для создания новых обученных моделей потребуется модуль *Web Service Output* (Выходные данные веб-службы), подключенный к модулю *[Train Model][train-model]* (Обучение модели).

1. Чтобы вернуться в обучающий эксперимент, щелкните значок "Эксперименты" на левой панели, а затем выберите эксперимент "Модель ценза".
2. В поле поиска "Search Experiment Items" (Поиск элементов эксперимента) введите "Web service".
3. Перетащите модуль *входных данных веб-службы* на холст эксперимента и присоедините его вывод к модулю *очистки недостающих данных*.
4. Перетащите два модуля *Web service Output* (Выходные данные веб-службы) на холст эксперимента. Присоедините вывод модуля *Обучение модели* к одному, а вывод модуля *Анализ модели* — к другому. Выходные данные веб-службы для модуля **Train Model** (Обучение модели) позволяют создать обученную модель. Выходные данные, прикрепленные к модулю **Evaluate Model** (Анализ модели), возвращают выходные данные этого модуля.
5. Щелкните **Выполнить**.

Затем следует развернуть обучающий эксперимент в качестве веб-службы, которая создает обученную модель и результаты ее оценки. Для этого необходимо выполнить набор действий, которые зависят от того, как развернут эксперимент: как классическая веб-служба или как новая веб-служба.
  
**Классическая веб-служба**

В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Deploy Web Service [Classic]** (Развернуть веб-службу [классическую]). **Панель мониторинга** веб-службы отображается с ключом API и страницей справки API для пакетного выполнения. Для создания обученных моделей может использоваться только метод пакетного выполнения.

**Новая веб-служба**

В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Deploy Web Service [New]** (Развернуть веб-службу [новую]). Портал веб-служб Машинного обучения Azure откроется на странице "Deploy Web service" (Развертывание веб-службы). Введите имя веб-службы и выберите план платежей, а затем нажмите кнопку **Deploy** (Развернуть). Для создания обученных моделей может использоваться только метод пакетного выполнения.

В любом случае, после завершения эксперимента итоговый рабочий процесс должен выглядеть следующим образом:

![Итоговый рабочий процесс после выполнения][4]

Схема 3. Итоговый рабочий процесс после выполнения

## Переобучение модели с использованием новых данных и BES

Чтобы вызвать интерфейсы API:

1. Создайте приложение для консоли C# в Visual Studio ("Создать->Проект->Рабочий стол Windows->Консольное приложение").
2.	Войдите на портал веб-служб Машинного обучения.
3.	Если вы работаете с классической веб-службой, щелкните **Classic Web Services** (Классические веб-службы).
	1.	Щелкните веб-службу, с которой вы работаете.
	2.	Щелкните конечную точку по умолчанию.
	3.	Щелкните **Consume** (Использование).
	4.	В нижней части страницы **Consume** (Использование) в разделе **Sample Code** (Пример кода) щелкните **Batch** (Пакет).
	5.	Перейдите к шагу 5 этой процедуры.
4.	Если вы работаете с новой веб-службой, щелкните **Web Services** (Веб-службы).
	1.	Щелкните веб-службу, с которой вы работаете.
	2.	Щелкните **Consume** (Использование).
	3.	В нижней части страницы "Consume" (Использование) в разделе **Sample Code** (Пример кода) щелкните **Batch** (Пакет).
5.	Скопируйте пример кода на C# для пакетного выполнения и вставьте его в файл Program.cs, убедившись, что пространство имен остается в неизменном виде.

Добавьте пакет Nuget Microsoft.AspNet.WebApi.Client, как указано в комментариях. Чтобы добавить ссылку на файл Microsoft.WindowsAzure.Storage.dll, может потребоваться сначала установить клиентскую библиотеку для служб хранилища Microsoft Azure. Дополнительные сведения см. на странице [Windows Azure Storage 7.2.1](https://www.nuget.org/packages/WindowsAzure.Storage).

### Обновление объявления apiKey

Найдите объявление **apiKey**.

	const string apiKey = "abc123"; // Replace this with the API key for the web service

В разделе **Basic consumption info** (Основные сведения об использовании) страницы **Consume** (Использование) найдите первичный ключ и скопируйте его в объявление **apiKey**.

### Обновление сведений о службе хранилища Azure

Пример кода BES отправляет файл из локального диска (например, C:\\temp\\CensusIpnput.csv) в службу хранилища Azure, обрабатывает его и записывает результаты обратно в службу хранилища Azure.

Для этого нужно получить имя учетной записи хранения, ключ и сведения о контейнере для вашей учетной записи хранения на классическом портале Azure, а затем обновить соответствующие значения в коде.

1. Войдите на классический портал Azure.
1. В левой области навигации щелкните **Хранилище**.
1. Выберите в списке учетную запись хранения, которая будет использоваться для хранения переобученной модели.
1. В нижней части страницы щелкните **Управление ключами доступа**.
1. Скопируйте и сохраните **Первичный ключ доступа**, а затем закройте диалоговое окно.
1. В верхней части страницы щелкните **Контейнеры**.
1. Выберите существующий контейнер или создайте новый и сохраните его имя.

Найдите объявления *StorageAccountName*, *StorageAccountKey* и *StorageContainerName* и обновите их, используя значения, взятые с портала Azure.

    const string StorageAccountName = "mystorageacct"; // Replace this with your Azure Storage Account name
    const string StorageAccountKey = "a_storage_account_key"; // Replace this with your Azure Storage Key
    const string StorageContainerName = "mycontainer"; // Replace this with your Azure Storage Container name
            
Кроме этого, необходимо обеспечить доступность файла входных данных в расположении, указанном в коде.

### Указание расположения выходных данных

При указании расположения выходных данных для полезных данных запроса измените расширение файла, заданное в *RelativeLocation*, на ilearner. См. указанный ниже пример.

    Outputs = new Dictionary<string, AzureBlobDataReference>() {
        {
            "output1",
            new AzureBlobDataReference()
            {
                ConnectionString = storageConnectionString,
                RelativeLocation = string.Format("{0}/output1results.ilearner", StorageContainerName) /*Replace this with the location you would like to use for your output file, and valid file extension (usually .csv for scoring results, or .ilearner for trained models)*/
            }
        },

>[AZURE.NOTE] Имена расположений для выходных данных могут отличаться от указанных в этом пошаговом руководстве в зависимости от того, в каком порядке добавлены модули выходных данных веб-службы. Так как для этого обучающего эксперимента настроены два вывода, в результатах будет содержаться информация о расположении хранения для обоих выводов.

![Выходные данные переобучения][6]

Схема 4. Выходные данные переобучения

## Анализ результатов переобучения
 
При выполнении приложения выходные данные содержат URL-адрес и маркер SAS, необходимые для доступа к результатам оценки.

Чтобы увидеть результаты работы переобученной модели, необходимо вставить полный URL-адрес в адресную строку браузера, используя сочетание значений параметров *BaseLocation*, *RelativeLocaiton* и *SasBlobToken* из приведенных выше результатов вывода *output2*.

Проанализируйте результаты и определите, достаточно ли хорошо работает только что обученная модель, чтобы заменить имеющуюся.

В полученных выходных данных скопируйте значения параметров *BaseLocation*, *RelativeLocation* и *SasBlobToken*. Они вам потребуются в процессе переобучения.

## Дальнейшие действия

[Переобучение классической веб-службы](machine-learning-retrain-a-classic-web-service.md)

[Переобучение новой веб-службы с помощью командлетов управления Машинного обучения](machine-learning-retrain-new-web-service-using-powershell.md)

<!-- Retrain a New Web service using the Machine Learning Management REST API -->


[1]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE01.png
[2]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE02.png
[3]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE03.png
[4]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE04.png
[5]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE05.png
[6]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE06.png
[7]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE07.png


<!-- Module References -->
[train-model]: https://msdn.microsoft.com/library/azure/5cc7053e-aa30-450d-96c0-dae4be720977/

<!---HONumber=AcomDC_0928_2016-->