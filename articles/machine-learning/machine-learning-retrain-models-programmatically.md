<properties
	pageTitle="Программное переобучение моделей машинного обучения | Microsoft Azure"
	description="Узнайте о том, как осуществить программное переобучение модели и обновить веб-службу так, чтобы она использовала переобученную модель при задействовании функций машинного обучения Azure."
	services="machine-learning"
	documentationCenter=""
	authors="raymondlaghaeian"
	manager="paulettm"
	editor="cgronlun"/>

<tags
	ms.service="machine-learning"
	ms.workload="data-services"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/23/2016"
	ms.author="raymondl;garye;v-donglo"/>


#Программное переобучение моделей машинного обучения  

В рамках процесса операционализации моделей машинного обучения в Машинном обучении Azure модель обучается и сохраняется. После этого она используется для создания прогнозной веб-службы. Созданная веб-служба может впоследствии использоваться на веб-сайтах, панелях мониторинга и в мобильных приложениях.

Модели, создаваемые с помощью машинного обучения, обычно не статические. Если появляются новые данные или у пользователя API есть свои данные, модель нужно переобучить. Кроме того, может потребоваться применить фильтры, получить подмножество данных и переобучить модель.

Переобучение может требоваться достаточно часто. Интерфейс API программного переобучения позволяет программным путем переобучить модель с помощью API переобучения и обновить веб-службу, чтобы она использовала эту модель.

В этом документе описана процедура переобучения и показано, как использовать интерфейсы API переобучения.

## Зачем нужно повторное обучение: определение проблемы  

В рамках процесса обучения ML модель обучается с использованием определенного набора данных. Модели, создаваемые с помощью машинного обучения, обычно не статические. Если появляются новые данные или у пользователя API есть свои данные, модель нужно переобучить. Иногда может потребоваться применить фильтры, получить подмножество данных и повторно обучить модель.

В этих сценариях программный API обеспечивает для вас или потребителя API удобный способ создания клиента, который может единовременно или регулярно переобучать модель при помощи собственных данных. После этого можно оценить результаты переобучения и обновить API веб-службы, чтобы использовать его с недавно обученной моделью.

##Как выполнить переобучение: полный цикл процесса  

Чтобы начать, необходимы следующие компоненты: обучающий эксперимент и эксперимент прогнозирования, опубликованные в виде веб-службы. Чтобы включить переобучение обученной модели, обучающий эксперимент необходимо опубликовать в виде веб-службы, вывод которой будет представлять собой обученную модель. Это позволит использовать API-доступ для переобучения модели.

Процесс настройки повторного обучения включает следующие шаги.

![Обзор процесса переобучения][1]

Схема 1. Обзор процесса повторного обучения

## Создание обучающего эксперимента
 
В этой статье используется пример "Sample 5: Train, Test, Evaluate for Binary Classification: Adult Dataset" (Образец 5. Обучение, тестирование, анализ для классификации бинарных файлов: набор данных с содержимым для взрослых) из каталога образцов Машинного обучения Microsoft Azure.
	
Чтобы создать эксперимент:

1.	Войдите в Студию машинного обучения Microsoft Azure.
2.	В нижнем правом углу панели мониторинга щелкните **Создать**.
3.	В списке образцов Майкрософт выберите образец 5.
4.	Чтобы переименовать эксперимент, в верхней части холста эксперимента выберите имя эксперимента "Sample 5: Train, Test, Evaluate for Binary Classification: Adult Dataset" (Образец 5. Обучение, тестирование, анализ для классификации бинарных файлов: набор данных с содержимым для взрослых).
5.	Введите "Модель ценза".
6.	В нижней части холста эксперимента нажмите кнопку **Run** (Выполнить).
7.	Щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Retraining Web Service** (Переобучение веб-службы).

 	![Исходный эксперимент][2]

Схема 2. Исходный эксперимент

## Создание оценочного эксперимента и опубликование его в виде веб-службы  

Теперь нужно создать прогнозный эксперимент.

1.	В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Predictive Web Service** (Прогнозная веб-служба). При этом модель сохраняется в качестве обученной и добавляются модули входных и выходных данных веб-службы.
2.	Щелкните **Выполнить**.
3.	Когда выполнение эксперимента будет завершено, щелкните **Deploy Web Service [Classic]** (Развернуть веб-службу [классическую]). Прогнозный эксперимент будет развернут в качестве классической веб-службы.

## Развертывание обучающего эксперимента в качестве обучающей веб-службы

Чтобы переобучить обученную модель, необходимо развернуть обучающий эксперимент, созданный в качестве веб-службы переобучения. Этой веб-службе для создания новых обученных моделей потребуется выходной модуль, подключенный к модулю [Обучение модели][train-model].

1. Чтобы вернуться в обучающий эксперимент, щелкните значок "Эксперименты" на левой панели, а затем выберите эксперимент "Модель ценза".
2. В поле поиска Search Experiment Items (Поиск элементов эксперимента) введите "Веб-служба".
3. Перетащите модуль входных данных веб-службы на холст эксперимента и присоедините его вывод к модулю очистки недостающих данных.
4. Перетащите два модуля *Выходные данные веб-службы* на холст эксперимента. Присоедините вывод модуля *Обучение модели* к одному, а вывод модуля *Анализ модели* — к другому. Выходные данные веб-службы для модуля "Обучение модели" позволяют создать обученную модель. Выходные данные, прикрепленные к модулю "Анализ модели", возвращают выходные данные процесса "Анализ модели".
5. Щелкните **Выполнить**.
6. В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Retraining Web Service** (Переобучение веб-службы). При этом обучающий эксперимент развертывается в качестве веб-службы, которая создает обученную модель и результаты ее оценки. **Панель мониторинга** веб-службы отображается с ключом API и страницей справки API для пакетного выполнения. Для создания обученных моделей может использоваться только метод пакетного выполнения.
  
После завершения эксперимента итоговый рабочий процесс должен выглядеть следующим образом:

![Итоговый рабочий процесс после выполнения][4]

Схема 3. Итоговый рабочий процесс после выполнения

## Добавление новой конечной точки
 
Развернутая прогнозная веб-служба является конечной точкой оценки по умолчанию. Конечные точки по умолчанию синхронизируются с исходными экспериментами по обучению и оценке, поэтому обученную модель конечной точки по умолчанию нельзя заменить.

Чтобы создать конечную точку оценки, в прогнозной веб-службе, которую можно обновить с помощью обученной модели, выполните действия ниже.

>[AZURE.NOTE] Важно добавить конечную точку к прогнозной веб-службе, а не к обучающей. Если вы правильно установили обучающую и прогнозную веб-службы, вы увидите две отдельные веб-службы. Имя прогнозной веб-службы должно заканчиваться на [predictive exp.].

1. Перейдите на [классический портал Azure](https://manage.windowsazure.com).
2. В меню слева щелкните **Машинное обучение**.
3. В поле "Имя" выберите рабочую область, а затем щелкните **Веб-службы**.
4. В поле "Имя" щелкните **Модель ценза [predictive exp.]**.
5. В нижней части страницы щелкните **Добавить конечную точку**. Дополнительные сведения о добавлении конечных точек см. в разделе [Создание конечных точек](machine-learning-create-endpoint.md).

Конечные точки оценки также можно добавить с помощью примера кода, приведенного в этом [репозитории GitHub](https://github.com/raymondlaghaeian/AML_EndpointMgmt/blob/master/Program.cs).

## Переобучение модели с использованием новых данных и BES

Чтобы вызвать интерфейсы API:

1. Создайте приложение для консоли C# в Visual Studio ("Создать->Проект->Рабочий стол Windows->Консольное приложение").
2. Скопируйте пример кода на C# со страницы справки API веб-службы обучения для пакетного выполнения и вставьте его в файл Program.cs, убедившись, что пространство имен остается в неизменном виде.
3. Пример кода содержит комментарии, указывающие на части кода, которые необходимо обновить.
4. При указании расположения выходных данных для полезных данных запроса измените расширение файла, заданное в *RelativeLocation*, с csv на ilearner. См. указанный ниже пример.

		Outputs = new Dictionary<string, AzureBlobDataReference>()
		{
			{
				"output1",
				new AzureBlobDataReference()
				{
					ConnectionString = "DefaultEndpointsProtocol=https;AccountName=mystorageacct;AccountKey=Dx9WbMIThAvXRQWap/aLnxT9LV5txxw==",
					RelativeLocation = "mycontainer/output1results.ilearner"
				}
			},
		},

>[AZURE.NOTE] Имена расположений для выходных данных могут отличаться от указанных в этом пошаговом руководстве в зависимости от того, в каком порядке добавлены модули выходных данных веб-службы. Так как для этого обучающего эксперимента настроены два вывода, в результатах будет содержаться информация о расположении хранения для обоих выводов.

### Обновление сведений о службе хранилища Azure

Пример кода BES отправляет файл из локального диска (например, C:\\temp\\CensusIpnput.csv) в службу хранилища Azure, обрабатывает его и записывает результаты обратно в службу хранилища Azure.

Для этого нужно получить имя учетной записи хранения, ключ и сведения о контейнере на классическом портале Azure для вашей учетной записи хранения, а затем обновить соответствующие значения в коде.

Кроме этого, необходимо обеспечить доступность файла входных данных в расположении, указанном в коде.

![Выходные данные переобучения][6]

Схема 4. Выходные данные переобучения

## Анализ результатов переобучения
 
При выполнении приложения выходные данные содержат URL-адрес и маркер SAS, необходимые для доступа к результатам оценки.

Чтобы увидеть результаты работы переобученной модели, необходимо вставить полный URL-адрес в адресную строку браузера, используя сочетание значений параметров *BaseLocation*, *RelativeLocaiton* и *SasBlobToken* из приведенных выше результатов вывода *output2*.

Проанализируйте результаты и определите, достаточно ли хорошо работает только что обученная модель, чтобы заменить имеющуюся.

## Обновление обученной модели добавленной конечной точки

Чтобы завершить процесс переобучения, необходимо обновить обученную модель добавленной конечной точки.

* Во время добавления новой конечной точки с помощью портала Azure щелкните имя новой конечной точки на портале, а затем — ссылку **Обновить ресурс**, чтобы получить URL-адрес, необходимый для обновления модели конечной точки.
* При добавлении конечной точки с помощью примера кода он также включает расположение URL-адреса справки, заданного в свойстве *HelpLocationURL* в выходных данных.

Чтобы извлечь URL-адрес:

1. Скопируйте и вставьте этот URL-адрес в адресную строку браузера.
2. Щелкните ссылку "Обновить ресурс".
3. Скопируйте URL-адрес POST запроса PATCH. Например:

		PATCH URL: https://management.azureml.net/workspaces/00bf70534500b34rebfa1843d6/webservices/af3er32ad393852f9b30ac9a35b/endpoints/newendpoint2

Теперь обученную модель можно использовать для обновления созданной конечной точки оценки.

В следующем примере кода показано, как использовать параметры *BaseLocation*, *RelativeLocation*, *SasBlobToken* и URL-адрес исправления для обновления конечной точки.

	private async Task OverwriteModel()
	{
		var resourceLocations = new
		{
			Resources = new[]
			{
				new
				{
					Name = "Census Model [trained model]",
					Location = new AzureBlobDataReference()
					{
						BaseLocation = "https://esintussouthsus.blob.core.windows.net/",
						RelativeLocation = "your endpoint relative location", //from the output, for example: “experimentoutput/8946abfd-79d6-4438-89a9-3e5d109183/8946abfd-79d6-4438-89a9-3e5d109183.ilearner”
						SasBlobToken = "your endpoint SAS blob token" //from the output, for example: “?sv=2013-08-15&sr=c&sig=37lTTfngRwxCcf94%3D&st=2015-01-30T22%3A53%3A06Z&se=2015-01-31T22%3A58%3A06Z&sp=rl”
					}
				}
			}
		};

		using (var client = new HttpClient())
		{
			client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", apiKey);

			using (var request = new HttpRequestMessage(new HttpMethod("PATCH"), endpointUrl))
			{
				request.Content = new StringContent(JsonConvert.SerializeObject(resourceLocations), System.Text.Encoding.UTF8, "application/json");
				HttpResponseMessage response = await client.SendAsync(request);

				if (!response.IsSuccessStatusCode)
				{
					await WriteFailedResponse(response);
				}

				// Do what you want with a successful response here.
			}
		}
	}

Параметры *apiKey* и *endpointUrl* для этого вызова можно получить на панели мониторинга конечной точки.

Значение параметра *Имя* в *ресурсах* должно соответствовать имени ресурса сохраненной обученной модели в прогнозном эксперименте. Чтобы получить имя ресурса:

1. Перейдите на [классический портал Azure](https://manage.windowsazure.com).
2. В меню слева щелкните **Машинное обучение**.
3. В поле "Имя" выберите рабочую область, а затем щелкните **Веб-службы**.
4. В поле "Имя" щелкните **Модель ценза [predictive exp.]**.
5. Щелкните новую добавленную конечную точку.
6. На панели мониторинга конечной точки щелкните *Обновить ресурс*.
7. На странице документации по API обновления ресурсов для веб-службы можно найти **имя ресурса** в разделе **обновляемых ресурсов**.

Если срок действия маркера SAS истекает до завершения обновления конечной точки, необходимо выполнить операцию GET с использованием идентификатора задания, чтобы получить новый маркер.

Если код выполнен успешно, новая конечная точка начнет использовать переобученную модель примерно через 30 секунд.

##Сводка  
Используя интерфейсы API переобучения, можно обновить обученную модель прогнозной веб-службы, что позволяет выполнять следующие сценарии:

* Периодическое переобучение модели с использованием новых данных.
* Распределение модели клиентам, чтобы они могли переобучить ее с использованием собственных данных.

## Дальнейшие действия
[Устранение неполадок при повторном обучении классической веб-службы машинного обучения Azure](machine-learning-troubleshooting-retraining-models.md)

[1]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE01.png
[2]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE02.png
[3]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE03.png
[4]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE04.png
[5]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE05.png
[6]: ./media/machine-learning-retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE06.png


<!-- Module References -->
[train-model]: https://msdn.microsoft.com/library/azure/5cc7053e-aa30-450d-96c0-dae4be720977/

<!---HONumber=AcomDC_0824_2016-->