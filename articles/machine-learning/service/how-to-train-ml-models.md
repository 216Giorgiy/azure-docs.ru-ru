---
title: Обучение моделей машинного обучения с помощью службы Машинное обучение Azure
description: Узнайте, как выполнять одноузловое и распределенное обучение традиционного машинного обучения и моделей глубокого обучения с помощью Службы машинного обучения Azure
ms.author: minxia
author: mx-iao
services: machine-learning
ms.service: machine-learning
ms.component: core
ms.topic: conceptual
ms.reviewer: sgilley
ms.date: 09/24/2018
ms.openlocfilehash: 50b808b5769f2160d765ecdb431d71856e651b33
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46983588"
---
# <a name="how-to-train-models-with-azure-machine-learning"></a>Как обучать модели машинного обучения с помощью Машинного обучения Azure

Для обучения моделей машинного обучения, в особенности глубоких нейронных сетей, часто требуется много времени и вычислений. После того как вы закончите писать сценарий обучения и работать с небольшим подмножеством данных на вашем локальном компьютере вы, вероятно, захотите увеличить свою рабочую нагрузку.

Чтобы облегчить обучение, пакет SDK Машинного обучения Azure для Python обеспечивает высокоуровневую абстракцию класса Estimator, которая позволяет пользователям легко обучать свои модели в экосистеме Azure. Вы можете создать и использовать объект оценщика для отправки любого учебного кода, который необходимо запустить на удаленном компьютере, будь то одноузловое выполнение или распределенное обучение по кластеру графического процессора. Для заданий PyTorch и TensorFlow Машинное обучение Azure также предоставляет соответствующие пользовательские оценщики PyTorch и TensorFlow, которые упрощают использование этих платформ.

## <a name="train-with-an-estimator"></a>Обучение с оценщиком

После создания [рабочей области](https://docs.microsoft.com/azure/machine-learning/service/concept-azure-machine-learning-architecture#workspace) и настройки вашей [среды разработки](how-to-configure-environment.md) для обучения модели в Машинном обучении Azure необходимо выполнить такие шаги.  
1. [Создать удаленный целевой объект вычисления](how-to-set-up-training-targets.md)
2. [Отправить данные обучения](how-to-access-data.md) (необязательно)
3. Создать сценарий обучения
4. Создать объект оценщика
5. Отправка задания обучения

В этой статье основное внимание уделено шагам 4–5. Примеры для шагов 1–3 см. в этом [руководстве](tutorial-train-models-with-aml.md).

### <a name="single-node-training"></a>Одноузловое обучение

Следующий код проходит через одноузловой тренировочный запуск в удаленной вычислительной среде в Azure для модели scikit-learn. У вас уже должен быть создан объект `compute_target` [целевого вычислительного ресурса](how-to-set-up-training-targets.md#batch) и объект `ds` [хранилища данных](how-to-access-data.md).

```Python
from azureml.train.estimator import Estimator

script_params = {
    '--data-folder': ds.as_mount(),
    '--regularization': 0.8
}

sk_est = Estimator(source_directory='./my-sklearn-proj',
                   script_params=script_params,
                   compute_target=compute_target,
                   entry_script='train.py',
                   conda_packages=['scikit-learn'])
```

Вышеприведенный фрагмент кода определяет следующие параметры конструкции оценщика:
* `source_directory`. Локальный каталог, который содержит весь код, необходимый для задания обучения. Эта папка копируется с локального компьютера на удаленный вычислительный ресурс. 
* `script_params`. Словарь, указывающий аргументы командной строки для сценария обучения `entry_script` в виде пар <аргумент командной строки, значение>.
* `compute_target`. Удаленный вычислительный ресурс (в этом случае — кластер [Batch AI](how-to-set-up-training-targets.md#batch)), на котором будет выполняться сценарий обучения.
* `entry_script`. Путь к файлу (относительно `source_directory`) сценария обучения, который будет выполняться на удаленном вычислительном ресурсе. В этой папке должны быть расположены этот файл и дополнительные файлы, от которых он зависит.
* `conda_packages`. Необходимый для сценария обучения список пакетов Python, которые нужно установить с помощью conda.  
Параметр `pip_packages` конструктора можно использовать для любых необходимых пакетов pip.

Теперь, когда вы создали объект оценщика, можно выполнить задание обучения в удаленной вычислительной среде посредством вызова функции `submit` в объекте `experiment` вашего [эксперимента](concept-azure-machine-learning-architecture.md#experiment). 

```Python
run = experiment.submit(sk_est)
print(run.get_details().status)
```

> [!IMPORTANT]
> **Особые папки**. Две папки — *выходные данные* и *журналы*, обрабатываются Машинным обучением Azure специальным образом. Если вы записываете файлы в папки с именами *выходные данные* и *журналы*, которые относятся к корневому каталогу (`./outputs` и `./logs` соответственно), то эти файлы во время обучения автоматически будут отправляться в журнал выполнения, чтобы после завершения выполнения у вас был к ним доступ. 
>
> Чтобы получить доступ к артефактам, созданным во время обучения (например, к файлам моделей, контрольным точкам, файлам данных или графическим изображениям), запишите их в папку `./outputs`.
>
> Аналогичным образом можно записать любые журналы выполнения обучения в папку `./logs`. Чтобы использовать [интеграцию TensorBoard](https://aka.ms/aml-notebook-tb) Машинного обучения Azure, убедитесь, что вы записываете журналы TensorBoard в эту папку. Во время выполнения вы сможете запустить TensorBoard и выполнить потоковую передачу этих журналов.  Позже вы также сможете восстановить журналы из любого из ваших предыдущих запусков.
>
> Например, чтобы загрузить файл, записанный в папку *выходные данные* локального компьютера, после запуска удаленного обучения выполните такую команду: `run.download_file(name='outputs/my_output_file', output_file_path='my_destination_path')`

### <a name="distributed-training-and-custom-docker-images"></a>Распределенное обучение и настройка образов Docker

Существуют два сценария дополнительного обучения, которые вы можете выполнить с помощью оценщика:
1. использование пользовательского образа Docker;
2. распределенное обучение на кластере с несколькими узлами.

Следующий код показывает, как выполнить распределенное обучение для модели CNTK. Кроме того, вместо использования образов по умолчанию Машинного обучения Azure предполагается, что у вас есть собственный пользовательский образ Docker, который вы хотите использовать для обучения.

У вас уже должен быть создан объект `compute_target` [целевого вычислительного ресурса](how-to-set-up-training-targets.md#batch). Вы можете создать оценщик следующим образом.

```Python
from azureml.train.estimator import Estimator

estimator = Estimator(source_directory='./my-cntk-proj',
                      compute_target=compute_target,
                      entry_script='train.py',
                      node_count=2,
                      process_count_per_node=1,
                      distributed_backend='mpi',     
                      pip_packages=['cntk==2.5.1'],
                      custom_docker_base_image='microsoft/mmlspark:0.12')
```

В приведенном выше коде показаны следующие новые параметры конструктора оценщика:
* `custom_docker_base_image`. Имя используемого образа. Вы можете предоставлять только те образы, которые доступны в публичных хранилищах Docker (в данном случае в центре Docker). Чтобы использовать образ из репозитория Docker, используйте параметр конструктора `environment_definition`.
* `node_count`. Количество узлов, которые будут использоваться для задания обучения. Этот аргумент по умолчанию имеет значение `1`.
* `process_count_per_node`. Количество процессов (или рабочих ролей), запускаемых на каждом узле. В этом случае используется `2` графических процессора, доступных на каждом узле. Этот аргумент по умолчанию имеет значение `1`.
* `distributed_backend`. Серверная часть для запуска распределенного обучения, предлагаемая оценщиком с помощью MPI. Этот аргумент по умолчанию имеет значение `None`. Чтобы выполнять параллельное или распределенное обучение (например, `node_count`> 1 или `process_count_per_node`> 1, или оба варианта), задайте `distributed_backend='mpi'`. Реализация MPI, используемая AML — [Open MPI](https://www.open-mpi.org/).

И наконец, отправьте задание обучения, выполнив такую команду.
```Python
run = experiment.submit(cntk_est)
```

## <a name="examples"></a>Примеры
Руководство по обучению модели sklearn см. в:
* `tutorials/01.train-models.ipynb`

Руководство по распределению CNTK с использованием пользовательских Docker см. в:
* `training/06.distributed-cntk-with-custom-docker/06.distributed-cntk-with-custom-docker.ipynb`

Получение записных книжек.

[!INCLUDE [aml-clone-in-azure-notebook](../../../includes/aml-clone-for-examples.md)]

## <a name="next-steps"></a>Дополнительная информация

* [Отслеживание метрик выполнения](how-to-track-experiments.md)
* [Обучение моделей PyTorch](how-to-train-pytorch.md)
* [Обучение моделей TensorFlow](how-to-train-tensorflow.md)
* [Настройка гиперпараметров](how-to-tune-hyperparameters.md)
* [Развертывание обученной модели](how-to-deploy-and-where.md)
