<properties 
   pageTitle="Настройка DNS между двумя виртуальными сетями Azure | Microsoft Azure" 
   description="Узнайте, как настроить VPN-подключения и разрешение имени домена между двумя виртуальными сетями и как настроить географическую репликацию HBase." 
   services="hdinsight,virtual-network" 
   documentationCenter="" 
   authors="mumian" 
   manager="paulettm" 
   editor="cgronlun"/>

<tags
   ms.service="hdinsight"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="big-data" 
   ms.date="12/02/2015"
   ms.author="jgao"/>

# Настройка DNS между двумя виртуальными сетями Azure

> [AZURE.SELECTOR]
- [Configure VPN connectivity](../hdinsight-hbase-geo-replication-configure-VNETs.md)
- [Configure DNS](hdinsight-hbase-geo-replication-configure-DNS.md)
- [Configure HBase replication](hdinsight-hbase-geo-replication.md) 


Узнайте, как добавить и настроить DNS-серверы в виртуальных сетях Azure для обработки разрешения имен в пределах виртуальных сетей и между ними.

Этот учебник является второй частью [серии][hdinsight-hbase-geo-replication] по созданию географической репликации HBase:

- [Настройка VPN-подключения между двумя виртуальными сетями][hdinsight-hbase-geo-replication-vnet]
- Настройка DNS для виртуальных сетей (данный учебник)
- [Настройка георепликации HBase][hdinsight-hbase-geo-replication]


На следующей схеме показаны две виртуальные сети, созданные вами в разделе [Настройка VPN-подключения между двумя виртуальными сетями][hdinsight-hbase-geo-replication-vnet]\:

![Схема виртуальной сети репликации HBase в HDInsight][img-vnet-diagram]

##Предварительные требования
Перед началом работы с этим учебником необходимо иметь следующее:

- **Подписка Azure.**. См. [Бесплатная пробная версия Azure](https://azure.microsoft.com/documentation/videos/get-azure-free-trial-for-testing-hadoop-in-hdinsight/).

- **Рабочая станция с Azure PowerShell.**. См. [Установка и использование Azure PowerShell](https://azure.microsoft.com/documentation/videos/install-and-use-azure-powershell/).

	Перед выполнением скриптов PowerShell убедитесь, что вы подключены к подписке Azure, с помощью следующего командлета:

		Add-AzureAccount

	При наличии нескольких подписок Azure используется следующий командлет для установки текущей подписки:

		Select-AzureSubscription <AzureSubscriptionName>

- **Две виртуальные сети Azure с VPN-подключением**. Инструкции см. в разделе [Настройка VPN-подключения между двумя виртуальными сетями Azure][hdinsight-hbase-geo-replication-vnet].

>[AZURE.NOTE] Имена служб Azure и имена виртуальных машин должны быть уникальными. В этом учебнике используется имя Contoso-[имя службы или виртуальной машины Azure]-[EU/US]. Например, Contoso-VNet-EU — это виртуальная сеть Azure в центре обработки данных, расположенном в Северной Европе; Contoso-DNS-US — виртуальная машина DNS-сервера в центре обработки данных, расположенном на востоке США. Вам необходимо создать собственные имена.
 
 
##Создание виртуальных машин Azure для использования в качестве DNS-серверов

**Создание виртуальной машины в пределах Contoso-VNet-EU, называемой Contoso-DNS-EU**

1.	Щелкните **СОЗДАТЬ**, **ВЫЧИСЛЕНИЕ**, **ВИРТУАЛЬНАЯ МАШИНА**, **ИЗ КОЛЛЕКЦИИ**.
2.	Выберите **Центр обработки данных Windows Server 2012 R2**.
3.	Введите:
	- **ИМЯ ВИРТУАЛЬНОЙ МАШИНЫ**: Contoso-DNS-EU
	- **НОВОЕ ИМЯ ПОЛЬЗОВАТЕЛЯ**: 
	- **НОВЫЙ ПАРОЛЬ**: 
4.	Введите:
	- **ОБЛАЧНАЯ СЛУЖБА**: создайте новую облачную службу
	- **РЕГИОН/ТЕРРИТОРИАЛЬНАЯ ГРУППА/ВИРТУАЛЬНАЯ СЕТЬ**: (выберите Contoso-VNet-EU)
	- **ПОДСЕТИ ВИРТУАЛЬНОЙ СЕТИ**: Subnet-1
	- **УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ**: Использовать автоматически созданную учетную запись хранения
	
		Имя облачной службы будет таким же, как имя виртуальной машины. В этом случае это ЕС Contoso-DNS. Для последующих виртуальных машин можно выбрать ту же облачную службу. Все виртуальные машины в той же облачной службе совместно используют ту же виртуальную сеть и суффикс домена.

		Учетная запись хранения используется для хранения файла образа виртуальной машины. 
	- **КОНЕЧНЫЕ ТОЧКИ**: (прокрутите вниз и выберите **DNS**) 

После создания виртуальной машины узнайте, внутренний IP-адрес и внешний IP-адрес.

1.	Щелкните имя виртуальной машины — **Contoso-DNS-EU**.
2.	Щелкните **Панель мониторинга**.
3.	Запишите:
	- ОБЩЕДОСТУПНЫЙ ВИРТУАЛЬНЫЙ IP-АДРЕС
	- ВНУТРЕННИЙ IP-АДРЕС


**Создание виртуальной машины в пределах Contoso-VNet-US, называемой Contoso-DNS-US**

- Повторите ту же процедуру для создания виртуальной машины со следующими значениями:
	- ИМЯ ВИРТУАЛЬНОЙ МАШИНЫ: Contoso-DNS-US
	- РЕГИОН/ТЕРРИТОРИАЛЬНАЯ ГРУППА/ВИРТУАЛЬНАЯ СЕТЬ: выберите Contoso-VNET-US
	- ПОДСЕТИ ВИРТУАЛЬНОЙ СЕТИ: Subnet-1
	- УЧЕБНАЯ ЗАПИСЬ ХРАНЕНИЯ: Использовать автоматически созданную учетную запись хранения
	- КОНЕЧНЫЕ ТОЧКИ: (выберите DNS)

##Задайте статические IP-адреса для двух виртуальных машин

DNS-серверам требуются статические IP-адреса. Это действие нельзя выполнить на классическом портале Azure. Вы будете использовать Azure PowerShell.

**Настройка статического IP-адреса для двух виртуальных машин**

1. Откройте интегрированную среду сценариев Windows PowerShell.
2. Выполните следующие командлеты.  

		Add-AzureAccount
		Select-AzureSubscription [YourAzureSubscriptionName]
		
		Get-AzureVM -ServiceName Contoso-DNS-EU -Name Contoso-DNS-EU | Set-AzureStaticVNetIP -IPAddress 10.1.0.4 | Update-AzureVM
		Get-AzureVM -ServiceName Contoso-DNS-US -Name Contoso-DNS-US | Set-AzureStaticVNetIP -IPAddress 10.2.0.4 | Update-AzureVM 

	ServiceName — имя облачной службы. Поскольку DNS-сервер является первой виртуальной машиной облачной службы, имя облачной службы совпадает с именем виртуальной машины.

	Может быть необходимо обновить ServiceName и Name для соответствия имеющимся у вас именам.


##Добавление роли DNS-сервера для двух виртуальных машин

**Добавление роли DNS-сервера для Contoso-DNS-EU**

1.	В левой части классического портала Azure щелкните **Виртуальные машины**. 
2.	Щелкните **Contoso-DNS-EU**.
3.	Щелкните **ПАНЕЛЬ МОНИТОРИНГА** в верхней части страницы.
4.	Щелкните **ПОДКЛЮЧЕНИЕ** снизу и следуйте инструкциям для подключения к виртуальной машине через RDP.
2.	В рамках сеанса RDP нажмите кнопку Windows в левом нижнем углу, чтобы открыть начальный экран.
3.	Щелкните плитку **Диспетчер серверов**.
4.	Щелкните **Добавить роли и компоненты**.
5.	Нажмите кнопку **Далее**.
6.	Выберите **Role-based or feature-based installation** (Установка на основе ролей или функций), а затем нажмите **Next**.
7.	Выберите виртуальную машину DNS (она должна быть уже выделена), а затем нажмите кнопку **Далее**.
8.	Установите флажок **DNS-сервер**.
9.	Нажмите **Добавить компоненты**, а затем **Продолжить**.
10.	Нажмите кнопку **Далее** три раза, а затем нажмите **Установить**. 

**Добавление роли DNS-сервера для Contoso-DNS-US**

- Повторите шаги, чтобы добавить роль DNS для **Contoso-DNS-US**.

##Назначение DNS-серверов виртуальным сетям

**Регистрация двух DNS-серверов**

1.	На классическом портале Azure нажмите **Создать**, **СЕТЕВЫЕ СЛУЖБЫ**, **ВИРТУАЛЬНАЯ СЕТЬ**, **ЗАРЕГИСТРИРОВАТЬ DNS-СЕРВЕР**.
2.	Введите:
	- **ИМЯ**: Contoso-DNS-EU
	- **IP-АДРЕС DNS-СЕРВЕРА**: 10.1.0.4 — IP-адрес должен соответствовать IP-адресу виртуальной машины DNS-сервера.
	 
3.	Повторите процесс для регистрации Contoso-DNS-US со следующими параметрами:
	- **ИМЯ**: Contoso-DNS-US
	- **IP-АДРЕС DNS-СЕРВЕРА**: 10.2.0.4

**Назначение двух DNS-серверов двум виртуальным сетям**

1.	Щелкните **Сети** в левой области на классическом портале.
2.	Щелкните **Contoso-VNet-EU**.
3.	Нажмите **НАСТРОИТЬ**.
4.	Выберите **Contoso-DNS-EU** в разделе **DNS-серверы**.
5.	Нажмите кнопку **СОХРАНИТЬ** внизу страницы, а затем кнопку **Да** для подтверждения.
6.	Повторите процедуру, чтобы назначить DNS-сервер **Contoso-DNS-US** виртуальной сети **Contoso-DNS-US**.

Все виртуальные машины, которые были развернуты в виртуальных сетях, необходимо перезагрузить для обновления конфигурации DNS-серверов.

**Перезагрузка виртуальных машин**

1. В левой части классического портала Azure щелкните **Виртуальные машины**.
2. Щелкните **Contoso-DNS-EU**.
3. Щелкните **Панель мониторинга** в верхней части страницы.
4. Щелкните **ПЕРЕЗАПУСТИТЬ** внизу.
5. Повторите те же действия для перезагрузки **Contoso-DNS-US**.


##Настройка DNS-серверов условной пересылки

DNS-сервер в каждой виртуальной сети может разрешать имена DNS только в пределах этой виртуальной сети. Необходимо настроить сервер условной пересылки, указывающий на одноранговый DNS-сервер, для разрешения имен в одноранговой виртуальной сети.

Чтобы настроить сервер условной пересылки, необходимо знать суффиксы доменов двух DNS-серверов. DNS-суффиксы могут различаться в зависимости от конфигурации облачных служб, которая использовалась при создании виртуальных машин. Для каждого DNS-суффикса, используемого в виртуальной сети, необходимо добавить сервер условной пересылки.

**Поиск суффиксов доменов двух DNS-серверов**

1. Выполните вход RDP в **Contoso-DNS-EU**.
2. Откройте консоль Windows PowerShell или командную строку.
3. Запустите **ipconfig** и запишите **DNS-суффикс, зависящий от подключения**.
4. Не закрывайте сеанс RDP, он будет по-прежнему нужен. 
5. Повторите шаги, чтобы узнать **DNS-суффикс, зависящий от подключения** для **Contoso-HBase-US**.


**Настройка DNS-серверов пересылки**
 
1.	Из сеанса подключения RDP к **Contoso-DNS-EU** нажмите клавишу Windows в левом нижнем углу.
2.	Щелкните **Администрирование**.
3.	Щелкните **DNS**.
4.	В левой области разверните **DSN**, **Contoso-DNS-EU**.
5.	Введите следующие сведения:
	- **DNS-домен**: введите DNS-суффикс Contoso-DNS-US. Например: Contoso-DNS-US.b5.internal.cloudapp.net.
	- **IP-адреса главных серверов**: введите 10.2.0.4 (IP-адрес Contoso-DNS-US).
6.	Нажмите клавишу **ENTER**, а затем нажмите кнопку **ОК**. Теперь можно будет разрешить IP-адрес Contoso-DNS-US из Contoso-DNS-EU.
7.	Повторите шаги, чтобы добавить DNS-сервер условной пересылки в службу DNS на виртуальной машине Contoso-DNS-US со следующими значениями:
	- **DNS-домен**: введите DNS-суффикс Contoso-DNS-EU. 
	- **IP-адреса главных серверов**: введите 10.2.0.4 (IP-адрес Contoso-DNS-EU).

##Проверка разрешения имен между виртуальными сетями

Теперь можно протестировать разрешение имен хостов между виртуальными сетями По умолчанию команда ping блокируется брандмауэром. С помощью nslookup можно разрешать виртуальные машины DNS-серверов виртуальных машин (необходимо использовать полное доменное имя) в одноранговых сетях.


##Дальнейшие действия

В этом учебнике вы узнали, как настроить разрешение имен между виртуальными сетями с использованием VPN-подключений. Две оставшиеся статьи в серии описывают следующие темы:

- [Настройка VPN-подключения между двумя виртуальными сетями Azure][hdinsight-hbase-geo-replication-vnet]
- [Настройка георепликации HBase][hdinsight-hbase-geo-replication]



[hdinsight-hbase-geo-replication]: hdinsight-hbase-geo-replication.md
[hdinsight-hbase-geo-replication-vnet]: hdinsight-hbase-geo-replication-configure-VNets.md
[powershell-install]: ../install-configure-powershell.md

[img-vnet-diagram]: ./media/hdinsight-hbase-geo-replication-configure-DNS/HDInsight.HBase.VPN.diagram.png

<!---HONumber=AcomDC_0128_2016-->