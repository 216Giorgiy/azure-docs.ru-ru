<properties
   pageTitle="Использование ключей SSH с Hadoop на платформе Linux из Linux, Unix или OS X | Microsoft Azure"
   description="Можно получить доступ к HDInsight под управлением Linux с помощью Secure Shell (SSH). В этом документе содержатся сведения об использовании SSH с HDInsight из клиентов OS X, Linux и Unix."
   services="hdinsight"
   documentationCenter=""
   authors="Blackmist"
   manager="paulettm"
   editor="cgronlun"
	tags="azure-portal"/>

<tags
   ms.service="hdinsight"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="big-data"
   ms.date="10/26/2015"
   ms.author="larryfr"/>

#Использование SSH с Hadoop на основе Linux в HDInsight из Linux, Unix или OS X

> [AZURE.SELECTOR]
- [Windows](hdinsight-hadoop-linux-use-ssh-windows.md)
- [Linux, Unix, OS X](hdinsight-hadoop-linux-use-ssh-unix.md)

[Secure Shell (SSH)](https://en.wikipedia.org/wiki/Secure_Shell) позволяет удаленно выполнять операции в кластерах HDInsight на основе Linux с помощью интерфейса командной строки. В этом документе содержатся сведения об использовании SSH с HDInsight из клиентов OS X, Linux и Unix.

> [AZURE.NOTE]При описаний действий в данной статье предполагается, что вы используете клиент OS X, Linux или Unix. Хотя то же самое можно сделать и на клиентах Windows после установки пакета, который предоставляет `ssh` и `ssh-keygen` (например, Git для Windows), на таких клиентах рекомендуется выполнить действия, описанные в статье [Использование SSH с кластерами HDInsight (Hadoop) под управлением Linux в Windows](hdinsight-hadoop-linux-use-ssh-windows.md).

##Предварительные требования

* **ssh-keygen** и **ssh** для клиентов Linux, Unix и OS X. Эти служебные программы обычно входят в состав операционной системы или доступны через систему управления пакетами.

* Современный веб-браузер, который поддерживает HTML5.

ИЛИ

* [Интерфейс командной строки Azure для Mac, Linux и Windows](../xplat-cli-install.md).

##Что такое SSH?

SSH — это служебная программа для входа в систему и удаленного выполнения команд на удаленном сервере. Используя HDInsight под управлением Linux, SSH устанавливает безопасное подключение к головному узлу кластера и предоставляет окно командной строки, используемое для ввода команд. Команды выполняются непосредственно на сервере.

###Имя пользователя SSH

Имя пользователя SSH — это имя, используемое для аутентификации в кластере HDInsight. При указании имени пользователя SSH во время создания кластера этот пользователь будет создан на всех узлах в кластере. После создания кластера это имя пользователя можно применять для подключения к головным узлам кластера HDInsight. Из головных узлов затем можно подключиться к отдельным рабочим узлам.

> [AZURE.NOTE]Имя пользователя SSH должно быть уникальным. Так как имя пользователя SSH создает учетную запись пользователя в кластере HDInsight, оно не должно конфликтовать с существующими пользователями, которые создаются HDInsight. Ниже перечислены имена, которые зарезервированы для служб, работающих в кластере HDInsight, и не могут применяться как имена пользователей SSH.
>
> root, hdiuser, storm, hbase, ubuntu, zookeeper, hdfs, yarn, mapred, hbase, hive, oozie, falcon, sqoop, admin, tez, hcat, hdinsight-zookeeper.

###Пароль SSH или открытый ключ

Пользователь SSH может применять для аутентификации пароль или открытый ключ. Пароль — это строка текста, введенная пользователем, а открытый ключ — это часть пары криптографических ключей, созданных для уникальной идентификации пользователя.

Ключ надежнее, чем пароль, однако для его создания требуются дополнительные действия, при этом необходимо хранить файлы ключа в безопасном месте. Если кто-либо получит доступ к файлам ключа, он получит доступ к вашей учетной записи. Если же вы потеряете файлы ключа, то не сможете войти в свою учетную запись.

Пара ключей состоит из открытого ключа (который отправляется на сервер HDInsight) и закрытого ключа (который хранится на клиентском компьютере). При подключении к серверу HDInsight с помощью SSH клиент SSH использует закрытый ключ, хранящийся на вашем компьютере, для аутентификации на сервере.

##Создание ключа SSH

Если вы планируете использовать ключи SSH на своем кластере, используйте следующую информацию. Если вы планируете использовать пароль, этот раздел можно пропустить.

1. Откройте сеанс терминала и введите следующую команду, чтобы определить наличие существующих ключей SSH:

		ls -al ~/.ssh

	Найдите следующие файлы в листинге каталога. Это общие имена для открытых ключей SSH.

	* id\_dsa.pub
	* id\_ecdsa.pub
	* id\_ed25519.pub
	* id\_rsa.pub

2. Если вы не хотите использовать существующий файл или у вас нет ключей SSH, создайте новый ключ с помощью следующей команды:

		ssh-keygen -t rsa

	Вам будет предложено ввести следующую информацию:

	* расположение файла — по умолчанию используется ~/.ssh/id\_rsa;
	* парольная фраза — появится запрос на повторный ввод.

		> [AZURE.NOTE]Мы настоятельно рекомендуем использовать безопасную парольную фразу для ключа. Однако если вы забудете парольную фразу, восстановить ее будет невозможно.

	После выполнения команды у вас будет два новых файла: закрытый ключ (например, **id\\_rsa**) и открытый ключ (например, **id\\_rsa.pub**).

##Создание кластера HDInsight на основе Linux

При создании кластера HDInsight на основе Linux необходимо предоставить открытый ключ, созданный ранее. Из клиентов OS X, Unix и Linux кластер HDInsight можно создать двумя способами:

* **Портал предварительной версии Azure** — для создания кластера используется веб-портал.

* **с помощью интерфейса командной строки Azure для Mac, Linux и Windows** — для создания кластера используются команды командной строки.

Для каждого из этих способов потребуется пароль или открытый ключ. Полную информацию о создании кластера HDInsight под управлением Linux см. в статье [Подготовка кластеров HDInsight под управлением Linux](hdinsight-hadoop-provision-linux-clusters.md).

###Портал предварительной версии Azure

При использовании [портала предварительной версии Azure][preview-portal] для создания кластера HDInsight под управлением Linux следует ввести значение в поле **ИМЯ ПОЛЬЗОВАТЕЛЯ SSH** и выбрать параметр **ПАРОЛЬ** или **ОТКРЫТЫЙ КЛЮЧ SSH**, для которых необходимо ввести значение.

Если выбран параметр **ОТКРЫТЫЙ КЛЮЧ SSH**, можно вставить открытый ключ (содержащийся в файле с расширением **PUB**) в поле __Открытый ключ SSH__ или щелкнуть __Выберите файл__, чтобы просмотреть и выбрать файл открытого ключа.

![Изображение формы запроса на открытый ключ](./media/hdinsight-hadoop-linux-use-ssh-unix/ssh-key.png)

> [AZURE.NOTE]Файл ключа — это обычный текстовый файл. Содержимое должно выглядеть следующим образом: ```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCelfkjrpYHYiks4TM+r1LVsTYQ4jAXXGeOAF9Vv/KGz90pgMk3VRJk4PEUSELfXKxP3NtsVwLVPN1l09utI/tKHQ6WL3qy89WVVVLiwzL7tfJ2B08Gmcw8mC/YoieT/YG+4I4oAgPEmim+6/F9S0lU2I2CuFBX9JzauX8n1Y9kWzTARST+ERx2hysyA5ObLv97Xe4C2CQvGE01LGAXkw2ffP9vI+emUM+VeYrf0q3w/b1o/COKbFVZ2IpEcJ8G2SLlNsHWXofWhOKQRi64TMxT7LLoohD61q2aWNKdaE4oQdiuo8TGnt4zWLEPjzjIYIEIZGk00HiQD+KCB5pxoVtp user@system
> ```

При этом для указанного пользователя создается имя для входа с использованием заданного пароля или предоставленного открытого ключа.

###Интерфейс командной строки Azure для Mac, Linux и Windows

Вы можете использовать [интерфейс командной строки Azure для Mac, Linux и Windows](../xplat.md) для создания нового кластера с помощью команды `azure hdinsight cluster create`.

Дополнительные сведения об использовании этой команды см. в статье [Подготовка кластеров Hadoop в HDInsight на платформе Linux с использованием настраиваемых параметров](hdinsight-hadoop-provision-linux-clusters.md).

##Подключение к кластеру HDInsight на основе Linux

В сеансе терминала воспользуйтесь командой SSH для подключения к головному узлу кластера, указав имя пользователя и адрес.

* **Адрес SSH** — это имя кластера с добавленным в конце суффиксом **-ssh.azurehdinsight.net**. Например, **mycluster-ssh.azurehdinsight.net**.

* **Имя пользователя** — имя пользователя SSH, указанное при создании кластера.

В следующем примере выполняется подключение к кластеру **mycluster** с именем пользователя **me**:

	ssh me@mycluster-ssh.azurehdinsight.net

Если для учетной записи пользователя использовался пароль, будет предложено ввести пароль.

Если вы использовали ключ SSH, защищенный парольной фразой, появится запрос на ввод парольной фразы. В противном случае SSH попытается автоматически выполнить аутентификацию с помощью одного из локальных закрытых ключей на клиенте.

> [AZURE.NOTE]Если SSH не выполнит аутентификацию автоматически с правильным закрытым ключом, используйте параметр **-i** и укажите путь к закрытому ключу. В следующем примере выполняется загрузка закрытого ключа из файла `~/.ssh/id_rsa`:
>
> `ssh -i ~/.ssh/id_rsa me@mycluster-ssh.azurehdinsight.net`

Если порт не указан, то по умолчанию SSH будет использовать порт 22, который подключается к головному узлу 0 в кластере HDInsight. При использовании порта 23 выполняется подключение к головному узлу 1. Дополнительные сведения о головных узлах см. в статье [Доступность и надежность кластеров Hadoop в HDInsight](hdinsight-high-availability-linux.md).

###Подключение к рабочим узлам

К рабочим узлам нельзя получить прямой доступ за пределами центра обработки данных Azure, но к ним можно получить доступ с головного узла кластера через SSH.

Если для аутентификации учетной записи пользователя используется ключ SSH, на клиенте нужно выполнить следующие действия:

1. Откройте в текстовом редакторе файл `~/.ssh/config`. Если этот файл не существует, вы можете создать его, введя команду `touch ~/.ssh/config` в терминале.

2. Добавьте в файл следующий код. Замените *CLUSTERNAME* именем кластера HDInsight.

        Host CLUSTERNAME-ssh.azurehdinsight.net
          ForwardAgent yes

    Это позволяет настроить перенаправление агента SSH для кластера HDInsight.

3. Чтобы проверить перенаправление агента SSH, выполните следующую команду в терминале:

        echo "$SSH_AUTH_SOCK"

    Эта команда возвращает следующую информацию:

        /tmp/ssh-rfSUL1ldCldQ/agent.1792

    Если информация не возвращается, это означает, что **агент SSH** не работает. Конкретные действия по установке и настройке **агента SSH** см. в документации по операционной системе или в статье [Использование агента SSH с помощью протокола SSH](http://mah.everybody.org/docs/ssh).

4. Убедившись в том, что **агент SSH** запущен, используйте следующую команду, чтобы добавить закрытый ключ SSH для агента:

        ssh-add ~/.ssh/id_rsa

    Если закрытый ключ хранится в другом файле, замените `~/.ssh/id_rsa` на путь к файлу.

Чтобы подключиться к рабочим узлам кластера, выполните следующие действия.

> [AZURE.IMPORTANT]Если для аутентификации учетной записи используется ключ SSH, выполните предыдущие шаги, чтобы убедиться, что перенаправление агента работает.

1. Подключитесь к кластеру HDInsight с помощью протокола SSH, как описано выше.

2. После подключения выполните следующую команду, чтобы получить список узлов в кластере. Замените *ADMINPASSWORD* паролем учетной записи администратора кластера. Замените *CLUSTERNAME* именем кластера.

        curl --user admin:ADMINPASSWORD https://CLUSTERNAME.azurehdinsight.net/api/v1/hosts

    В результате будет возвращена информация в формате JSON для узлов кластера, включая `host_name`, в котором содержится полное доменное имя (FQDN) каждого узла. Ниже приведен пример записи `host_name`, возвращенной командой **curl**:

        "host_name" : "workernode0.workernode-0-e2f35e63355b4f15a31c460b6d4e1230.j1.internal.cloudapp.net"

3. После создания списка рабочих узлов, к которым необходимо подключиться, используйте следующую команду из сеанса SSH на сервере для подключения к рабочему узлу:

        ssh USERNAME@FQDN

    Замените *USERNAME* своим именем пользователя SSH, а *FQDN* — полным доменным именем рабочего узла. Например, `workernode0.workernode-0-e2f35e63355b4f15a31c460b6d4e1230.j1.internal.cloudapp.net`.

    > [AZURE.NOTE]При использовании пароля для аутентификации сеанса SSH появится запрос на повторный ввод пароля. При использовании ключа SSH подключение завершается без запросов.

4. После установки сеанса строка терминала изменится с `username@headnode` на `username@workernode`, чтобы указать, что вы подключены к рабочему узлу. Все команды на этом этапе выполняются на рабочем узле.

4. После выполнения всех действий на рабочем узле закройте сеанс рабочего узла с помощью команды `exit`. Таким образом вы вернетесь к запросу `username@headnode`.

##Добавление дополнительных учетных записей

1. Создайте новый открытый ключ и закрытый ключ для новой учетной записи пользователя, как описано в разделе [Создание ключа SSH](#create-an-ssh-key-optional).

	> [AZURE.NOTE]Закрытый ключ должен быть создан на клиенте, который пользователи будут использовать для подключения к кластеру, или безопасно передан на такой клиент после создания.

1. Из сеанса SSH добавьте в кластер нового пользователя с помощью следующей команды:

		sudo adduser --disabled-password <username>

	Она создаст новую учетную запись пользователя, но отключит проверку пароля.

2. Создайте каталог и файлы для хранения ключа, используя следующие команды:

		sudo mkdir -p /home/<username>/.ssh
		sudo touch /home/<username>/.ssh/authorized_keys
		sudo nano /home/<username>/.ssh/authorized_keys

3. Когда откроется редактор nano, скопируйте и вставьте в него содержимое открытого ключа для новой учетной записи пользователя. Наконец, нажмите клавиши **Ctrl-X**, чтобы сохранить файл и закрыть редактор.

	![изображение редактора Nano с примером ключа](./media/hdinsight-hadoop-linux-use-ssh-unix/nano.png)

4. Используйте следующую команду, чтобы изменить владельца папки в формате SSH и ее содержимого на новую учетную запись пользователя:

		sudo chown -hR <username>:<username> /home/<username>/.ssh

5. Теперь можно будет проходить аутентификацию на сервере с новой учетной записью пользователя и закрытым ключом.

##<a id="tunnel"></a>Туннелирование SSH

Протокол SSH может использоваться для туннелирования локальных запросов, например веб-запросов, к кластеру HDInsight. Запрос будет затем перенаправлен к запрошенному ресурсу, как если бы исходил от головного узла кластера HDInsight.

> [AZURE.IMPORTANT]Туннель SSH обязателен для доступа к веб-интерфейсу некоторых служб Hadoop. Например, доступ к пользовательскому интерфейсу журнала заданий или диспетчера ресурсов можно получить только с помощью туннеля SSH.

Дополнительную информацию о создании и использовании туннеля SSH см. в статье [Использование туннелирования SSH для доступа к веб-интерфейсу Ambari, ResourceManager, JobHistory, NameNode, Oozie и другим веб-интерфейсам](hdinsight-linux-ambari-ssh-tunnel.md).

##Дальнейшие действия

Теперь, когда вы знаете, как пройти аутентификацию с помощью ключа SSH, узнайте, как использовать MapReduce с Hadoop в HDInsight.

* [Использование Hive с HDInsight](hdinsight-use-hive.md)

* [Использование Pig с HDInsight](hdinsight-use-pig.md)

* [Использование заданий MapReduce с HDInsight](hdinsight-use-mapreduce.md)

[preview-portal]: https://portal.azure.com/

<!---HONumber=Nov15_HO1-->