---
title: "Фильтры и динамические манифесты | Документация Майкрософт"
description: "В этом разделе описывается создание фильтров, с помощью которых клиент может передавать определенные секции потока. Для достижения такой выборочной потоковой передачи службы мультимедиа создают динамические манифесты."
services: media-services
documentationcenter: 
author: cenkdin
manager: cfowler
editor: 
ms.assetid: ff102765-8cee-4c08-a6da-b603db9e2054
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 12/07/2017
ms.author: cenkd;juliako
ms.openlocfilehash: 5512be8ce5b9cf28bceb3468ec6032c0778156f4
ms.sourcegitcommit: b07d06ea51a20e32fdc61980667e801cb5db7333
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2017
---
# <a name="filters-and-dynamic-manifests"></a>Фильтры и динамические манифесты
Начиная с выпуска 2.17, Media Services позволяет определять фильтры средств. Эти фильтры представляют собой правила на стороне сервера, позволяющие пользователям выполнять следующие действия: воспроизведение только части видео (вместо целого) или указание подмножества представлений аудио и видео, которые может обрабатывать устройство клиента (вместо всех представлений, связанных с активом). Такая фильтрация активов достигается с помощью **динамических манифестов**, которые создаются по запросу клиента для потоковой передачи видео на основе указанных фильтров.

В этом разделе обсуждаются распространенные сценарии, в которых использование фильтров принесет значительные преимущества вашим клиентам, и содержатся ссылки на статьи, демонстрирующие, как создавать фильтры программно (в настоящее время фильтры можно создавать только с помощью интерфейсов REST API).

## <a name="overview"></a>Обзор
При доставке содержимого клиентам (в виде потоковой трансляции событий в режиме реального времени или видео по запросу) ваша задача — доставлять видео высокого качества для различных устройств в разных сетевых условиях. Для достижения этой цели необходимо сделать следующее:

* закодировать видеопоток с разными скоростями ([с адаптивной скоростью](http://en.wikipedia.org/wiki/Adaptive_bitrate_streaming)) (что позволит справиться с условиями качества и сети) и 
* использовать [динамическую упаковку](media-services-dynamic-packaging-overview.md) служб мультимедиа для динамической перепаковки потока в разные протоколы (это позволит транслировать поток на разных устройствах). Службы мультимедиа поддерживают доставку данных в следующих форматах потоковой передачи с переменной скоростью: HTTP Live Streaming (HLS), Smooth Streaming и MPEG-DASH. 

### <a name="manifest-files"></a>Файлы манифестов
При кодировании актива для потоковой передачи с адаптивной скоростью создается файл **манифеста** (списка воспроизведения) (в основе файла — текст или XML). Файл **манифеста** содержит потоковые метаданные, например тип дорожки (звук, видео или текст), имя дорожки, время начала и окончания, скорость (качество), языки дорожки, окно представления (скользящее окно фиксированной длительности), видеокодек (FourCC). Также он предписывает проигрывателю получить следующий фрагмент, предоставляя информацию о следующих доступных для воспроизведения фрагментах видео и их расположении. Фрагменты (или сегменты) — это фактические составные части видеосодержимого.

Ниже приведен пример файла манифеста: 

    <?xml version="1.0" encoding="UTF-8"?>    
    <SmoothStreamingMedia MajorVersion="2" MinorVersion="0" Duration="330187755" TimeScale="10000000">

    <StreamIndex Chunks="17" Type="video" Url="QualityLevels({bitrate})/Fragments(video={start time})" QualityLevels="8">
    <QualityLevel Index="0" Bitrate="5860941" FourCC="H264" MaxWidth="1920" MaxHeight="1080" CodecPrivateData="0000000167640028AC2CA501E0089F97015202020280000003008000001931300016E360000E4E1FF8C7076850A4580000000168E9093525" />
    <QualityLevel Index="1" Bitrate="4602724" FourCC="H264" MaxWidth="1920" MaxHeight="1080" CodecPrivateData="0000000167640028AC2CA501E0089F97015202020280000003008000001931100011EDC00002CD29FF8C7076850A45800000000168E9093525" />
    <QualityLevel Index="2" Bitrate="3319311" FourCC="H264" MaxWidth="1280" MaxHeight="720" CodecPrivateData="000000016764001FAC2CA5014016EC054808080A00000300020000030064C0800067C28000103667F8C7076850A4580000000168E9093525" />
    <QualityLevel Index="3" Bitrate="2195119" FourCC="H264" MaxWidth="960" MaxHeight="540" CodecPrivateData="000000016764001FAC2CA503C045FBC054808080A000000300200000064C1000044AA0000ABA9FE31C1DA14291600000000168E9093525" />
    <QualityLevel Index="4" Bitrate="1469881" FourCC="H264" MaxWidth="960" MaxHeight="540" CodecPrivateData="000000016764001FAC2CA503C045FBC054808080A000000300200000064C04000B71A0000E4E1FF8C7076850A4580000000168E9093525" />
    <QualityLevel Index="5" Bitrate="978815" FourCC="H264" MaxWidth="640" MaxHeight="360" CodecPrivateData="000000016764001EAC2CA50280BFE5C0548303032000000300200000064C08001E8480004C4B7F8C7076850A45800000000168E9093525" />
    <QualityLevel Index="6" Bitrate="638374" FourCC="H264" MaxWidth="640" MaxHeight="360" CodecPrivateData="000000016764001EAC2CA50280BFE5C0548303032000000300200000064C080013D60000C65DFE31C1DA1429160000000168E9093525" />
    <QualityLevel Index="7" Bitrate="388851" FourCC="H264" MaxWidth="320" MaxHeight="180" CodecPrivateData="000000016764000DAC2CA505067E7C054830303200000300020000030064C040030D40003D093F8C7076850A45800000000168E9093525" />

    <c t="0" d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="20000000" /><c d="9600000"/>
    </StreamIndex>


    <StreamIndex Chunks="17" Type="audio" Url="QualityLevels({bitrate})/Fragments(AAC_und_ch2_128kbps={start time})" QualityLevels="1" Name="AAC_und_ch2_128kbps">
    <QualityLevel AudioTag="255" Index="0" BitsPerSample="16" Bitrate="125658" FourCC="AACL" CodecPrivateData="1210" Channels="2" PacketSize="4" SamplingRate="44100" />

    <c t="0" d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="6965987" /></StreamIndex>


    <StreamIndex Chunks="17" Type="audio" Url="QualityLevels({bitrate})/Fragments(AAC_und_ch2_56kbps={start time})" QualityLevels="1" Name="AAC_und_ch2_56kbps">
    <QualityLevel AudioTag="255" Index="0" BitsPerSample="16" Bitrate="53655" FourCC="AACL" CodecPrivateData="1210" Channels="2" PacketSize="4" SamplingRate="44100" />

    <c t="0" d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201361" /><c d="20201360" /><c d="20201361" /><c d="20201360" /><c d="6965987" /></StreamIndex>

    </SmoothStreamingMedia>

### <a name="dynamic-manifests"></a>Динамические манифесты
Существуют [сценарии](media-services-dynamic-manifest-overview.md#scenarios) , когда клиенту требуется больше гибкости, чем описано в файле манифеста актива по умолчанию. Например: 

* Для определенного устройства: доставка только указанных представлений и/или языков дорожек, поддерживаемых устройством, на котором воспроизводится содержимое ("фильтрация представлений"). 
* Сокращение манифеста для отображения субклипа текущего события ("фильтрация субклипов").
* Обрезка начала видео ("обрезка видео").
* Настройка окна представления (DVR) для предоставления ограниченной длительности окна DVR в проигрывателе ("настройка окна представления").

Для достижения такой гибкости службы мультимедиа предоставляют **динамические манифесты** на основе предварительно определенных [фильтров](media-services-dynamic-manifest-overview.md#filters).  После определения фильтров клиенты могут использовать их для потоковой передачи определенного представления или субклипов видео. Фильтры указываются в URL-адресе потоковой передачи. Фильтры можно применять к протоколам потоковой передачи с переменной скоростью, которые поддерживаются [динамической упаковкой](media-services-dynamic-packaging-overview.md): HLS, MPEG-DASH и Smooth Streaming. Например: 

URL-адрес MPEG DASH с фильтром

    http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=mpd-time-csf,filter=MyLocalFilter)

URL-адрес Smooth Streaming с фильтром

    http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(filter=MyLocalFilter)


Дополнительные сведения о способах доставки содержимого и построения URL-адресов потоковой передачи см. в статье [Доставка содержимого клиентам](media-services-deliver-content-overview.md).

> [!NOTE]
> Обратите внимание, что динамические манифесты не изменяют актив и его манифест по умолчанию. Клиент может запросить поток с фильтрами или без них. 
> 
> 

### <a id="filters"></a>Фильтры
Существуют два типа фильтров активов. 

* Глобальные фильтры (могут применяться к любому активу в учетной записи служб мультимедиа Azure, имеют срок существования учетной записи). 
* Локальные фильтры (могут применяться только к активу, с которым фильтр был связан при создании, имеют срок существования актива). 

Глобальные и локальные типы фильтров обладают в точности одинаковыми свойствами. Основное различие между ними — в сценариях, к которым более подходит тот или иной тип фильтра. Глобальные фильтры обычно подходят для профилей устройств (фильтрация представлений), в то время как локальные могут использоваться для обрезки определенного актива.

## <a id="scenarios"></a>Распространенные сценарии
Как уже было сказано прежде, при доставке содержимого клиентам (в виде потоковой трансляции событий в режиме реального времени или видео по запросу) вашей целью является доставка видео высокого качества для различных устройств в разных сетевых условиях. Кроме этого, возможны и другие требования, задействующие фильтрацию активов и использование **динамических манифестов**. В следующих разделах содержится краткий обзор различных сценариев фильтрации.

* Указание только части представлений аудио и видео, которые могут обрабатываться определенными устройствами (вместо всех представлений, связанных с активом). 
* Воспроизведение только части видео (вместо воспроизведения видео целиком).
* Настройка окна представления DVR.

## <a name="rendition-filtering"></a>Фильтрация представлений
По выбору можно закодировать актив в несколько профилей кодирования (H.264 Baseline, H.264 High, AACL, AACH, Dolby Digital Plus) и с несколькими значениями скорости потока и соответственно качества. Однако не все клиентские устройства будут поддерживать все профили и скорости потока вашего актива. Например, старые устройства Android поддерживают только H.264 Baseline+AACL. Отправка высоких скоростей потока на устройство, которое не способно получить их преимущества, приводит к трате излишней пропускной способности и вычислительных ресурсов устройства. Такое устройство должно декодировать всю заданную информацию только для того, чтобы уменьшать ее масштаб для отображения.

С помощью динамического манифеста можно создать профили устройств, например мобильных устройств, консолей, HD/SD и т. д., и включить в них дорожки и варианты качества, которые следует сделать частью каждого из профилей.

![Пример фильтрации представлений][renditions2]

В следующем примере использовался кодировщик для кодирования промежуточного актива в семь MP4-видеофайлов стандарта ISO (с разрешением от 180p до 1080p). Закодированный ресурс можно динамически упаковать в любой из следующих потоковых протоколов: HLS, Smooth Streaming и MPEG-DASH.  В верхней части схемы показан манифест HLS манифеста для актива без фильтров (он содержит все семь представлений).  В левом нижнем углу показан манифест HLS, к которому был применен фильтр с именем ott. Фильтр ott предписывает удалить все варианты скорости потока ниже 1 Мбит/с, что ведет к исключению двух нижних уровней качества.  В правом нижнем углу показан манифест HLS, к которому был применен фильтр с именем mobile. Фильтр mobile предписывает удалить представления, где разрешение больше 720p, что ведет к исключению двух представлений с разрешением 1080p.

![Фильтрация представлений][renditions1]

## <a name="removing-language-tracks"></a>Удаление языковых дорожек
Активы могут содержать аудиодорожки на нескольких языках, например английском, испанском, французском и т. д. Как правило, пакет SDK проигрывателя управляет выбором аудиодорожки по умолчанию и доступными на выбор пользователя аудиодорожками. Такие пакеты SDK для проигрывателей разрабатывать сложно, они требуют разных реализаций для разных платформ проигрывателей на конкретных устройствах. Кроме того, на некоторых платформах API-интерфейсы проигрывателей ограничены и не включают функции выбора звука, когда пользователи не могут выбрать или изменить установленную по умолчанию звуковую дорожку. С помощью фильтров активов можно управлять поведением проигрывателей, создавая фильтры с включением только нужных языков аудио.

![Фильтрация языковых дорожек][language_filter]

## <a name="trimming-start-of-an-asset"></a>Обрезка начала актива
При большинстве событий потоковой трансляции в реальном времени операторы проводят процедуры тестирования до фактического события. Например, перед началом события они могут включить заставку: "Программа начнется очень скоро". Если программа архивации, тестирования и содержания данных также архивирование и в презентации. Однако эту информацию не следует отображать клиентам. С помощью динамического манифеста можно создать фильтр времени начала и удалить ненужные данные из манифеста.

![Начало обрезки][trim_filter]

## <a name="creating-subclips-views-from-a-live-archive"></a>Создание subclips (представления) из динамического архива
Многие текущие события являются длительными, и их текущий архив может включать в себя несколько событий. После завершения динамической событие источников может потребоваться разбить динамического архива в логической программы для запуска и остановки последовательности. Затем опубликуйте эти виртуальные программы отдельно без post обработки динамического архива и не создавая отдельные активы (который не смогли воспользоваться преимуществами существующих фрагментов кэшированный в CDN). Примерами таких виртуальных программ являются кварталы футбольной или Баскетбольная игры, иннингов в бейсбольные или отдельных событий любой программы спортивных.

С помощью динамического манифеста можно создавать фильтры с указанием времени начала и окончания, а также создавать виртуальные представления поверх текущего архива. 

![Фильтр субклипа][subclip_filter]

Фильтрованный архив:

![Лыжный спорт][skiing]

## <a name="adjusting-presentation-window-dvr"></a>Настройка окна презентации (DVR)
В настоящее время службы мультимедиа Azure поддерживают циклический архив, продолжительность которого можно настроить от 5 минут до 25 часов. Фильтрация манифеста позволяет создать скользящее окно DVR поверх архива, без удаления медиаданных. Существует множество сценариев, где хотите предоставить ограниченный окна DVR для перемещения по краю динамической и в то же время поддержания увеличить архивирования окно источников. Вещателю может понадобиться использовать данные, находящиеся за пределами окна DVR, для выделения клипов, или же предоставлять разные окна DVR для различных устройств. Например большая часть мобильных устройств не обрабатывают большие окна DVR (для настольных клиентов могут иметь окна DVR 2 минуты для мобильных устройств и один час).

![Окно DVR][dvr_filter]

## <a name="adjusting-livebackoff-live-position"></a>Настройка LiveBackoff (динамической позиции)
Фильтрация манифеста позволяет удалить несколько секунд с динамической границы текущей программы. Фильтрация позволяет источников презентация на точки публикации предварительного просмотра и создать объявление точки вставки, до средств просмотра получать поток (резервного выключение до 30 секунд). Затем вещатели могут передавать рекламу на клиентские платформы, располагая временем для получения и обработки информации до появления возможности для рекламы.

Помимо поддержки объявления параметр LiveBackoff можно использовать для настройки положения средств просмотра, чтобы когда клиенты смещения и попадания динамической edge они могут по-прежнему получить фрагментов сервера, а не получение ошибку HTTP 404 или 412 ошибки.

![livebackoff_filter][livebackoff_filter]

## <a name="combining-multiple-rules-in-a-single-filter"></a>Объединение нескольких правил в одном фильтре
В одном фильтре можно объединить несколько правил фильтрации. В качестве примера можно определить «правило диапазона» удалить портативные ПК из динамического архива и также отфильтровать доступные битрейтов. При применении нескольких правил фильтрации, конечный результат представляет собой пересечение всех правил.

![multiple-rules][multiple-rules]

## <a name="create-filters-programmatically"></a>Программное создание фильтров
В следующей статье описываются сущностей служб мультимедиа, связанных с фильтрами. Статья также показано, как программным способом создать фильтры.  

[Создание фильтров с помощью интерфейсов REST API](media-services-rest-dynamic-manifest.md).

## <a name="combining-multiple-filters-filter-composition"></a>Объединение нескольких фильтров (сложение фильтров)
Кроме того, вы можете объединять несколько фильтров в одном URL-адресе. 

В следующем сценарии показано, для чего могут потребоваться подобные фильтры:

1. При необходимости отфильтровать качество видео для мобильных устройств, например, Android или iPAD (для ограничения качества видео). Чтобы удалить ненужные качеств, вы создадите глобального фильтра подходит для профилей устройств. Как упоминалось ранее в этой статье, глобальные фильтры можно использовать для всех ресурсов в ту же учетную запись служб мультимедиа без дальнейших ассоциации. 
2. При необходимости обрезать время начала и окончания ресурс-контейнера. Для этого можно создать локальный фильтр и задать время начала и окончания. 
3. Необходимо объединить обе эти фильтры (без их сочетание, необходимо добавить качества фильтрации в фильтре усечения, что затрудняет использование фильтра).

Для объединения фильтров необходимо указать их имена в URL-адресе манифеста или списка воспроизведения через точку с запятой. Допустим, у вас есть фильтр качества с именем *MyMobileDevice* и фильтр *MyStartTime* для выбора конкретного времени начала. Их можно объединить следующим образом:

    http://teststreaming.streaming.mediaservices.windows.net/3d56a4d-b71d-489b-854f-1d67c0596966/64ff1f89-b430-43f8-87dd-56c87b7bd9e2.ism/Manifest(filter=MyMobileDevice;MyStartTime)

Можно использовать до трех фильтров. 

Дополнительную информацию см. в [этом](https://azure.microsoft.com/blog/azure-media-services-release-dynamic-manifest-composition-remove-hls-audio-only-track-and-hls-i-frame-track-support/) блоге.

## <a name="know-issues-and-limitations"></a>Известные проблемы и ограничения
* Динамический манифест работает в пределах GOP (по ключевым кадрам), поэтому обрезка производится с точностью GOP. 
* Одно и то же имя фильтра можно использовать для локальных и глобальных фильтров. Обратите внимание, что локальный фильтр имеет более высокий приоритет и переопределяет глобальные фильтры.
* При обновлении фильтра может понадобиться до 2 минут на обновление правил конечной точкой потоковой передачи. Если содержимое было обработано с помощью каких-либо фильтров (и кэшировано на прокси-серверах и в кэшах CDN), обновление этих фильтров может привести к сбоям проигрывателя. Рекомендуется очистить кэш после обновления фильтра. Если такой вариант невозможен, рассмотрите возможность использования другого фильтра.

## <a name="media-services-learning-paths"></a>Схемы обучения работе со службами мультимедиа
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]

## <a name="see-also"></a>См. также
[Обзор доставки содержимого клиентам](media-services-deliver-content-overview.md)

[renditions1]: ./media/media-services-dynamic-manifest-overview/media-services-rendition-filter.png
[renditions2]: ./media/media-services-dynamic-manifest-overview/media-services-rendition-filter2.png

[rendered_subclip]: ./media/media-services-dynamic-manifests/media-services-rendered-subclip.png
[timeline_trim_event]: ./media/media-services-dynamic-manifests/media-services-timeline-trim-event.png
[timeline_trim_subclip]: ./media/media-services-dynamic-manifests/media-services-timeline-trim-subclip.png

[multiple-rules]:./media/media-services-dynamic-manifest-overview/media-services-multiple-rules-filters.png

[subclip_filter]: ./media/media-services-dynamic-manifest-overview/media-services-subclips-filter.png
[trim_event]: ./media/media-services-dynamic-manifests/media-services-timeline-trim-event.png
[trim_subclip]: ./media/media-services-dynamic-manifests/media-services-timeline-trim-subclip.png
[trim_filter]: ./media/media-services-dynamic-manifest-overview/media-services-trim-filter.png
[redered_subclip]: ./media/media-services-dynamic-manifests/media-services-rendered-subclip.png
[livebackoff_filter]: ./media/media-services-dynamic-manifest-overview/media-services-livebackoff-filter.png
[language_filter]: ./media/media-services-dynamic-manifest-overview/media-services-language-filter.png
[dvr_filter]: ./media/media-services-dynamic-manifest-overview/media-services-dvr-filter.png
[skiing]: ./media/media-services-dynamic-manifest-overview/media-services-skiing.png
