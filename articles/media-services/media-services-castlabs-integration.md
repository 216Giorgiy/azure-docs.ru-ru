<properties 
	pageTitle="Использование castLabs для доставки лицензий Widevine для служб мультимедиа Azure" 
	description="В этой статье описывается использование служб мультимедиа Azure (AMS) для доставки потока, который зашифрован динамически службой AMS, с помощью лицензий DRM PlayReady и Widevine. Лицензию PlayReady выдает сервер лицензирования служб мультимедиа PlayReady, а лицензию Widevine — сервер лицензирования castLabs." 
	services="media-services" 
	documentationCenter="" 
	authors="Mingfeiy,Juliako" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="10/08/2015"  
	ms.author="juliako"/>


#Использование castLabs для доставки лицензий Widevine для служб мультимедиа Azure

> [AZURE.SELECTOR]
- [Axinom](media-services-axinom-integration.md)
- [castLabs](media-services-castlabs-integration.md)

##Обзор

В этой статье описывается использование служб мультимедиа Azure (AMS) для доставки потока, который зашифрован динамически службой AMS, с помощью лицензий DRM PlayReady и Widevine. Лицензию PlayReady выдает сервер лицензирования служб мультимедиа PlayReady, а лицензию Widevine — сервер лицензирования **castLabs**.

На схеме показана высокоуровневая архитектура служб мультимедиа Azure и интеграция castLabs.

![интеграция](./media/media-services-castlabs-integration/media-services-castlabs-integration.png)

##Настройка типичной системы

- Мультимедийное содержимое хранится в AMS.
- Идентификаторы ключей содержимого хранятся в castLabs и AMS.
- CastLabs и AMS имеют встроенную проверку подлинности маркеров. В следующих разделах рассматриваются маркеры проверки подлинности. 
- Когда клиент запрашивает потоковую передачу видео, содержимое динамически шифруется с помощью **стандартного шифрования** (CENC) и динамически упаковывается сервером AMS для передачи по протоколах Smooth Streaming и DASH. Для протокола потоковой передачи HLS предлагается также шифрование элементарного потока PlayReady M2TS.
- Лицензию PlayReady выдает сервер лицензирования AMS, а лицензию Widevine — сервер лицензирования castLabs. 
- Мультимедиапроигрыватель автоматически выбирает нужную лицензию в соответствии с возможностями платформы клиента. 

##Создания маркеров проверки подлинности для получения лицензии

CastLabs и AMS поддерживают формат маркера JWT (веб-маркера JSON), который используется для авторизации лицензии.

###Маркер JWT в AMS 

В приведенной ниже таблице описан маркер JWT в AMS.

Issuer|Строка издателя из выбранной службы маркеров безопасности
---|---
Аудитория|Строка аудитории из используемой службы маркеров безопасности
Claims|Набор утверждений
NotBefore|Начало действия маркера
Expires|Конец действия маркера
SigningCredentials|Общий ключ для сервера лицензирования PlayReady, castLabs и службы маркеров безопасности. Он может быть симметричным или асимметричным.

###Маркер JWT в castLabs

В приведенной ниже таблице описан маркер JWT в castLabs.

Имя|Описание
---|---
optData|Строка JSON со сведениями о вас. 
crt|Строка JSON со сведениями о файле, лицензии на него и правах на его воспроизведение.
iat|Текущая дата и время в Unix-времени.
jti|Уникальный идентификатор этого маркера (каждый маркер может использоваться в системе castLabs только один раз).

##Настройка образца решения 

[Образец решения](https://github.com/AzureMediaServicesSamples/CastlabsIntegration) состоит из двух проектов.

-	Консольное приложение, которое можно использовать для задания ограничений DRM на уже существующий файл для PlayReady и Widevine.
-	Веб-приложение, которое передает маркеры, которые можно рассматривать как ОЧЕНЬ УПРОЩЕННУЮ версию службы маркеров безопасности.


Чтобы использовать консольное приложение, сделайте следующее.

1.	Измените файл app.config для настройки учетных данных для серверов AMS, castLabs, настройки службы маркеров безопасности и общего ключа.
2.	Отправьте файл в AMS.
3.	Получите UUID отправленного файла и измените строку 32 в файле Program.cs:

		 var objIAsset = _context.Assets.Where(x => x.Id == "nb:cid:UUID:dac53a5d-1500-80bd-b864-f1e4b62594cf").FirstOrDefault();

4.	Используйте AssetId для именования файла в системе castLabs (строка 44 в файле Program.cs).

	Необходимо задать AssetId в **castLabs**; это должна быть уникальная буквенно-цифровая строка.

5.	Запустите программу.


Чтобы использовать веб-приложение (служба маркеров безопасности), сделайте следующее.

1.	Измените файл web.config для настройки идентификатора подразделения castlabs, службы маркеров безопасности и общего ключа.
2.	Разверните приложение на веб-сайтах Azure.
3.	Перейдите на веб-сайт.

##Воспроизведение видео

Чтобы воспроизвести видео со стандартным шифрованием (PlayReady), можно использовать [мультимедиапроигрыватель Azure](http://amsplayer.azurewebsites.net/azuremediaplayer.html). При запуске консольного приложения выводится идентификатор ключа содержимого и URL-адрес манифеста.

1.	Откройте новую вкладку и запустите службу маркеров безопасности: http://[yourStsName].azurewebsites.net/api/token/assetid/[yourCastLabsAssetId]/contentkeyid/[thecontentkeyid].
2.	Перейдите к проигрывателю [Azure Media Player](http://amsplayer.azurewebsites.net/azuremediaplayer.html).
3.	Вставьте URL-адрес для потоковой передачи.
4.	Установите флажок **Дополнительные параметры**.
5.	Выберите PlayReady в раскрывающемся списке **Защита**.
6.	Вставьте маркер, полученный от службы маркеров безопасности в текстовом поле маркера.
7.	Обновите проигрыватель.
8.	Видео должно воспроизводиться.

Чтобы воспроизводить в браузере Chrome защищенное видео на веб-странице с HTML5 с помощью проигрывателя castLabs, запросите доступ к проигрывателю по адресу yanmf@microsoft.com. После получения доступа учтите следующие 2 фактора.

1.	Проигрывателю castLabs требуется доступ к файлу манифеста MPEG-DASH, поэтому добавьте (format=mpd-time-csf) в файл манифеста, чтобы получить файл манифеста MPEG-DASH вместо файла по умолчанию Smooth Streaming.

2.	Сервер лицензирования CastLab не использует префикс "Bearer=" перед маркером. Поэтому удалите его перед отправкой маркера.

 

##Схемы обучения работе со службами мультимедиа

Схемы обучения AMS можно просмотреть здесь:

- [Рабочий процесс для потоковой передачи в реальном времени в службах AMS](http://azure.microsoft.com/documentation/learning-paths/media-services-streaming-live/)
- [Рабочий процесс для потоковой передачи по запросу в службах AMS](http://azure.microsoft.com/documentation/learning-paths/media-services-streaming-on-demand/)

<!---HONumber=Oct15_HO3-->