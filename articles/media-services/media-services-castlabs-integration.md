<properties 
	pageTitle="Использование castLabs для доставки лицензий DRM для служб мультимедиа Azure" 
	description="В этой статье описывается использование служб мультимедиа Azure (AMS) для доставки потока, который зашифрован динамически службой AMS, с помощью лицензий DRM PlayReady и Widevine. Лицензию PlayReady выдает сервер лицензирования служб мультимедиа PlayReady, а лицензию Widevine — сервер лицензирования castLabs." 
	services="media-services" 
	documentationCenter="" 
	authors="Juliako" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/12/2015" 
	ms.author="juliako"/>


#Использование castLabs для доставки лицензий DRM для служб мультимедиа Azure

##Обзор

В этой статье описывается использование служб мультимедиа Azure (AMS) для доставки потока, который зашифрован динамически службой AMS, с помощью лицензий DRM PlayReady и Widevine. Лицензию PlayReady выдает сервер лицензирования служб мультимедиа PlayReady, а лицензию Widevine — сервер лицензирования **castLabs**.

На схеме показана высокоуровневая архитектура служб мультимедиа Azure и интеграция castLabs.

![Страница масштабирования](./media/media-services-castlabs-integration/media-services-castlabs-integration.png)

##Настройка типичной системы

- Мультимедийное содержимое хранится в AMS.
- Идентификаторы ключей содержимого хранятся в castLabs и AMS.
- CastLabs и AMS имеют встроенную проверку подлинности маркеров. В следующих разделах рассматриваются маркеры проверки подлинности. 
- Когда клиент запрашивает потоковую передачу видео, содержимое динамически шифруется с помощью **обычного шифрования** (CENC) и динамически упаковывается сервером AMS с помощью одного из указанных (или всех) протоколов: Smooth streaming, HLS или DASH. 
- Лицензию PlayReady выдает сервер лицензирования AMS, а лицензию Widevine — сервер лицензирования castLabs. 
- Проигрыватель Windows Media автоматически выбирает нужную лицензию в соответствии с возможностями платформы клиента. 

##Создания маркеров проверки подлинности для получения лицензии

CastLabs и AMS поддерживают формат маркера JWT (веб-маркера JSON), который используется для авторизации лицензии.

###Маркер JWT в AMS 

В приведенной ниже таблице описан маркер JWT в AMS.

<table border="1">
<tr><td>Issuer</td><td>Строка издателя из выбранной службы маркеров безопасности</td></tr>
<tr><td>Аудитория</td><td>Строка аудитории из используемой службы маркеров безопасности</td></tr>
<tr><td>Claims</td><td>Набор утверждений</td></tr>
<tr><td>NotBefore</td><td>Начало действия маркера</td></tr>
<tr><td>Expires</td><td>Конец действия маркера</td></tr>
<tr><td>SigningCredentials</td><td>Общий ключ для сервера лицензирования PlayReady, castLabs и службы маркеров безопасности. Он может быть симметричным или асимметричным.</td></tr>
</table>

###Маркер JWT в castLabs

В приведенной ниже таблице описан маркер JWT в castLabs.

<table border="1">
<tr><td>optData</td><td>Строка JSON со сведениями о вас. </td></tr>
<tr><td>crt</td><td>Строка JSON со сведениями о файле, лицензии на него и правах на его воспроизведение.</td></tr>
<tr><td>iat</td><td>Текущая дата и время в Unix-времени.</td></tr>
<tr><td>jti</td><td>Уникальный идентификатор этого маркера (каждый маркер может использоваться в системе castLabs только один раз).</td></tr>
</table>

##Настройка образца решения 

 [Образец решения](https://github.com/AzureMediaServicesSamples/CastlabsIntegration) состоит из двух проектов.

-	Консольное приложение, которое можно использовать для задания ограничений DRM на уже существующий файл для PlayReady и Widevine.
-	Веб-приложение, которое передает маркеры, которые можно рассматривать как ОЧЕНЬ УПРОЩЕННУЮ версию службы маркеров безопасности.


Чтобы использовать консольное приложение, сделайте следующее.

1.	Измените файл app.config для настройки учетных данных для серверов AMS, castLabs, настройки службы маркеров безопасности и общего ключа.
2.	Отправьте файл в AMS.
3.	Получите UUID отправленного файла и измените строку 32 в файле Program.cs:

		 var objIAsset = _context.Assets.Where(x => x.Id == "nb:cid:UUID:dac53a5d-1500-80bd-b864-f1e4b62594cf").FirstOrDefault();

4.	Используйте AssetId для именования файла в системе castLabs (строка 44 в файле Program.cs).

	Необходимо задать AssetId в **castLabs**; это должна быть уникальная буквенно-цифровая строка.

5.	Запустите программу.


Чтобы использовать веб-приложение (служба маркеров безопасности), сделайте следующее.

1.	Измените файл web.config для настройки идентификатора подразделения castlabs, службы маркеров безопасности и общего ключа.
2.	Разверните приложение на веб-сайтах Azure.
3.	Перейдите на веб-сайт.

##Воспроизведение видео

Чтобы воспроизвести видео со стандартным шифрованием (PlayReady и Widevine), можно использовать проигрыватель [Azure Media Player](http://amsplayer.azurewebsites.net/azuremediaplayer.html). При запуске консольного приложения выводится идентификатор ключа содержимого и URL-адрес манифеста.

1.	Откройте новую вкладку и запустите службу маркеров безопасности: http://[yourStsName].azurewebsites.net/api/token/assetid/[yourCastLabsAssetId]/contentkeyid/[thecontentkeyid].
2.	Перейдите к проигрывателю [Azure Media Player](http://amsplayer.azurewebsites.net/azuremediaplayer.html).
3.	Вставьте URL-адрес для потоковой передачи.
4.	Установите флажок **Дополнительные параметры**.
5.	Выберите PlayReady в раскрывающемся списке **Защита**.
6.	Вставьте маркер, полученный от службы маркеров безопасности в текстовом поле маркера.
7.	Обновите проигрыватель.
8.	Видео должно воспроизводиться.

Чтобы воспроизвести видео, защищенное протоколом HTML5, в браузере Chrome с помощью проигрывателя castLabs, обратитесь к castLabs для получения доступа к проигрывателю. После получения доступа учтите следующие 2 фактора.

1.	Проигрывателю castLabs требуется доступ к файлу манифеста MPEG-DASH, поэтому добавьте (format=mpd-time-csf) в файл манифеста, чтобы получить файл манифеста MPEG-DASH вместо файла по умолчанию Smooth Streaming.

2.	Сервер лицензирования CastLab не использует префикс «Bearer=» перед маркером. Поэтому удалите его перед отправкой маркера.

<!---HONumber=58--> 