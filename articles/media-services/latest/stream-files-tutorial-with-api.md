---
title: Передача, кодирование и потоковая передача с использованием Служб мультимедиа Azure | Документация Майкрософт
description: Следуйте инструкциям в этом руководстве, чтобы отправить файл, закодировать видео и выполнять потоковую передачу содержимого с помощью Служб мультимедиа Azure.
services: media-services
documentationcenter: ''
author: Juliako
manager: cfowler
editor: ''
ms.service: media-services
ms.workload: ''
ms.topic: tutorial
ms.custom: mvc
ms.date: 04/09/2018
ms.author: juliako
ms.openlocfilehash: 7e5054d6f59bb3e06e4148bd9cfb3caed9fec970
ms.sourcegitcommit: e14229bb94d61172046335972cfb1a708c8a97a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2018
---
# <a name="tutorial-upload-encode-and-stream-videos-using-apis"></a>Руководство. Отправка, кодирование и потоковая передача видео с помощью API

В этом руководстве показано, как отправлять, кодировать и выполнять потоковую передачу видеофайлов с помощью Служб мультимедиа Azure. Вам может потребоваться выполнить потоковую передачу содержимого в формате Apple HLS, MPEG DASH или CMAF, чтобы его можно было воспроизводить в самых разнообразных браузерах и на устройствах. Прежде чем выполнять потоковую передачу видео, его необходимо закодировать и запаковать соответствующим образом.

Хотя в руководстве показана пошаговая отправка видео, вы также можете кодировать содержимое, которое доступно для вашей учетной записи Служб мультимедиа через URL-адрес HTTPS.

![Воспроизведение видео](./media/stream-files-tutorial-with-api/final-video.png)

В этом учебнике описаны следующие процедуры.    

> [!div class="checklist"]
> * Запуск Azure Cloud Shell
> * Создание учетной записи служб мультимедиа
> * Доступ к API Служб мультимедиа.
> * Настройка примера приложения
> * Тщательный анализ кода.
> * Запуск приложения
> * Тестирование URL-адреса потоковой передачи.
> * Очистка ресурсов

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>предварительным требованиям

Вы можете скачать [Visual Studio Community 2017](https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&rel=15) бесплатно, если у вас нет Visual Studio.

## <a name="download-the-sample"></a>Скачивание примера приложения

Клонируйте репозиторий GitHub, содержащий пример потоковой передачи данных .NET, на компьютер с помощью следующей команды:  

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials.git
 ```

[!INCLUDE [cloud-shell-try-it.md](../../../includes/cloud-shell-try-it.md)]

[!INCLUDE [media-services-cli-create-v3-account-include](../../../includes/media-services-cli-create-v3-account-include.md)]

[!INCLUDE [media-services-v3-cli-access-api-include](../../../includes/media-services-v3-cli-access-api-include.md)]

## <a name="examine-the-code"></a>Анализ кода

В этом разделе рассматриваются функции, определенные в файле [Program.cs](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs) проекта *UploadEncodeAndStreamFiles*.

### <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы начать использование API Служб мультимедиа с .NET, создайте объект **AzureMediaServicesClient**. Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. Сначала необходимо получить маркер, а затем создать объект **ClientCredential** из возвращенного токена. В коде, который был клонирован в начале статьи, объект **ArmClientCredential** используется для получения токена.  

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#CreateMediaServicesClient)]

### <a name="create-an-input-asset-and-upload-a-local-file-into-it"></a>Создание входного ресурса и отправка в него локального файла 

Функция **CreateInputAsset** создает новый входной ресурс и отправляет в него определенный локальный видеофайл. Этот ресурс используется в качестве входных данных для задания кодирования. В Службах мультимедиа версии 3 входные данные для задания могут быть либо ресурсом, либо содержимым, доступным в учетной записи Служб мультимедиа через URL-адрес HTTPS. Дополнительные сведения о кодировании из URL-адреса HTTPS см. в [этой статье](job-input-from-http-how-to.md).  

В Службах мультимедиа версии 3 для отправки файлов используются API службы хранилища. В следующих фрагментах кода .NET показано, как это сделать.

Следующая функция выполняет такие действия:

* создает каталог ресурсов; 
* получает доступный для записи [URL-адрес SAS](https://docs.microsoft.com/azure/storage/common/storage-dotnet-shared-access-signature-part-1) для [контейнера ресурса в хранилище](https://docs.microsoft.com/azure/storage/blobs/storage-quickstart-blobs-dotnet?tabs=windows#upload-blobs-to-the-container);
* отправляет файл в контейнер в хранилище с использованием URL-адреса SAS;

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#CreateInputAsset)]

### <a name="create-an-output-asset-to-store-the-result-of-a-job"></a>Создание выходного ресурса для хранения результатов задания 

Выходной ресурс сохраняет результаты задания кодирования. Проект определяет функцию **DownloadResults**, которая скачивает результаты из выходного ресурса в папку output, чтобы вы могли просмотреть их.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#CreateOutputAsset)]

### <a name="create-a-transform-and-a-job-that-encodes-the-uploaded-file"></a>Создание преобразования и задания, которое кодирует отправленный файл
При кодировании или обработке содержимого в Службах мультимедиа параметры кодировки часто задают в качестве набора инструкций. Затем необходимо отправить **задание**, чтобы применить этот набор к видео. Отправляя новые задания для каждого нового видео, вы применяете этот набор ко всем видео в своей библиотеке. Набор инструкций в Службах мультимедиа называется **Преобразование**. Дополнительные сведения см. в статье о [преобразованиях и заданиях](transform-concept.md). Пример кода, описанный в руководстве, определяет набор инструкций, которые кодируют видео для его потоковой передачи на различные устройства под управлением iOS и Android. 

#### <a name="transform"></a>Преобразование

При создании нового экземпляра **преобразования** необходимо указать, что требуется создать в качестве выходных данных. Обязательный параметр — это объект **TransformOutput**, как показано в приведенном ниже примере кода. Каждый объект **TransformOutput** содержит **предустановку** (Preset). **Предустановка** описывает пошаговые инструкции для операций обработки видео и звука, которые будут использоваться для создания нужного объекта **TransformOutput**. Пример, описанный в этой статье, использует встроенную предустановку, называемую **AdaptiveStreaming**. Предустановка кодирует входное видео в автоматически созданную схему скоростей и разрешений (пары "скорость — разрешение") на основе входного разрешения и скорости и создает файлы ISO MP4 с видео H.264 и аудио AAC, соответствующие каждой паре "скорость — разрешение". Дополнительные сведения об этой предустановке см. в [этой статье](autogen-bitrate-ladder.md).

Вы можете использовать другую встроенную предустановку кодирования или пользовательскую предустановку. 

При создании **преобразования** сначала проверьте, существует ли оно, с помощью метода **Get**, как показано в следующем коде.  В Службах мультимедиа версии 3 методы **Get**, отправленные к сущностям, возвращают значение **NULL**, если сущность не существует (проверка по имени без учета регистра).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#EnsureTransformExists)]

#### <a name="job"></a>Задание

Как было указано выше, объект **преобразования** является набором инструкций, а **задание** — фактическим запросом к Службам мультимедиа для применения этого **преобразования** к данному видео и аудио. **Задание** указывает такую информацию, как расположение входного и выходного видео.

В этом примере входное видео было отправлено с локального компьютера. Дополнительные сведения о кодировании из URL-адреса HTTPS см. в [этой статье](job-input-from-http-how-to.md).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#SubmitJob)]

### <a name="wait-for-the-job-to-complete"></a>Ожидание завершения задания

Пример кода ниже показывает, как опрашивать службу о состоянии задания. Опрос не рекомендуется для приложений рабочей среды из-за потенциальной задержки. Его можно регулировать при чрезмерном использовании в учетной записи. Вместо этого разработчики должны использовать службу "Сетка событий".

Служба "Сетка событий" предназначена для обеспечения высокого уровня доступности, стабильной производительности и динамического масштабирования. С помощью службы "Сетка событий Azure" приложения могут ожидать передачи данных и реагировать на события, поступающие буквально из всех служб Azure и пользовательских источников. Простая реактивная обработка событий на основе HTTP позволяет создавать эффективные решения с использованием интеллектуальной фильтрации и маршрутизации событий.  Дополнительные сведения см. в статье [Route Azure Media Services events to a custom web endpoint using CLI](job-state-events-cli-how-to.md) (Маршрутизация событий Служб мультимедиа в пользовательскую конечную точку с помощью CLI).

**Задание** обычно проходит через такие состояния: **Запланировано**, **В очереди**, **Обработка**, **Завершено** (конечное состояние). Если в задании обнаружена ошибка, вы получите состояние **Ошибка**. Если задание находится в процессе отмены, вы получите состояние **Выполнение отмены** и **Отменено** по завершении.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#WaitForJobToFinish)]

### <a name="get-a-streaminglocator"></a>Получение StreamingLocator

После выполнения кодирования необходимо сделать видео в выходном ресурсе доступным для воспроизведения клиентами. Это можно сделать в два этапа. Сначала создайте **StreamingLocator**, а затем URL-адреса потоковой передачи, которые клиенты могут использовать. 

Процесс создания **StreamingLocator** называется публикацией. По умолчанию **StreamingLocator** допустим сразу после выполнения вызова API и действует, пока не будет удален, если не настроить дополнительное начальное и конечное время. 

При создании **StreamingLocator** необходимо указать желаемое имя **StreamingPolicyName**. В этом примере выполняется потоковая передача незашифрованного содержимого, поэтому можно использовать предварительно определенную политику прозрачной потоковой передачи,  **PredefinedStreamingPolicy.ClearStreamingOnly**.

> [!IMPORTANT]
> При использовании пользовательской StreamingPolicy следует разработать ограниченный набор таких политик для учетной записи Служб мультимедиа и повторно использовать их для StreamingLocators везде, когда требуются те же параметры шифрования и протоколы. У вашей учетной записи Служб мультимедиа есть квота на количество записей StreamingPolicy. Вы не должны создавать новый StreamingPolicy для каждого StreamingLocator.

В следующем коде предполагается, что вы вызываете функцию с уникальным locatorName.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#CreateStreamingLocator)]

Хотя пример в этом разделе рассматривает потоковую передачу, этот же вызов можно использовать, чтобы создать StreamingLocator для передачи видео с помощью поэтапной загрузки.

### <a name="get-streaming-urls"></a>Получение URL-адресов потоковой передачи

После создания StreamingLocator можно получить URL-адреса потоковой передачи, как показано в **GetStreamingURLs**. Чтобы создать URL-адрес, необходимо сцепить имя узла **StreamingEndpoint** и путь **StreamingLocator**. В этом примере используется **конечная точка потоковой передачи** *по умолчанию*. При первом создании учетной записи Служб мультимедиа эта **StreamingEndpoint** *по умолчанию* будет находиться в остановленном состоянии, поэтому вам необходимо вызвать функцию **Start**.

> [!NOTE]
> В этом методе вам необходим locatorName, который использовался при создании **StreamingLocator** для выходного ресурса.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#GetStreamingURLs)]

### <a name="clean-up-resources-in-your-media-services-account"></a>Очистка ресурсов в учетной записи Служб мультимедиа

Как правило, необходимо очистить все, кроме объектов, которые вы планируете использовать повторно. Обычно повторно используются преобразования и будут сохранены StreamingLocators и т. д. Если учетную запись требуется очистить после эксперимента, следует удалить ресурсы, которые не планируется использовать повторно.  Например, следующий код удаляет задания.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/UploadEncodeAndStreamFiles/Program.cs#CleanUp)]

## <a name="run-the-sample-app"></a>Запуск примера приложения

1. Нажмите клавиши CTRL+F5, чтобы выполнить приложение *EncodeAndStreamFiles*.
2. Скопируйте URL-адрес потоковой передачи из консоли.

В этом примере отображаются URL-адреса, которые можно использовать для воспроизведения видео с помощью различных протоколов:

![Выходные данные](./media/stream-files-tutorial-with-api/output.png)

## <a name="test-the-streaming-url"></a>Тестирование URL-адреса потоковой передачи.

Для тестирования потоковой передачи в этой статье используется решение "Проигрыватель мультимедиа Azure". 

> [!NOTE]
> Если проигрыватель размещен на сайте HTTPS, обновите URL-адрес до HTTPS.

1. Откройте браузер и перейдите по адресу [https://aka.ms/azuremediaplayer/](https://aka.ms/azuremediaplayer/).
2. В поле **URL:** (URL-адрес:) вставьте одно из значений URL-адресов потоковой передачи, полученных при работе приложения. 
3. Щелкните **Update Player** (Обновить проигрыватель).

Проигрыватель мультимедиа Azure можно использовать для тестирования, но его нельзя применять в рабочей среде. 

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не нужны какие-либо ресурсы в группе ресурсов, включая Службы мультимедиа и учетные записи хранения, созданные для этого руководства, удалите группу ресурсов, созданную ранее. Для этого можно использовать средство **CloudShell**.

В **CloudShell** выполните следующую команду:

```azurecli-interactive
az group delete --name amsResourceGroup
```

## <a name="multithreading"></a>Многопоточность

Пакеты SDK для Служб мультимедиа Azure версии 3 не являются потокобезопасными. При разработке многопоточного приложения необходимо создать и использовать новый объект AzureMediaServicesClient для каждого потока.

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда вы знаете, как отправлять, кодировать и выполнять потоковую передачу своего видео, перейдите к следующей статье: 

> [!div class="nextstepaction"]
> [Анализ видео](analyze-videos-tutorial-with-api.md)
