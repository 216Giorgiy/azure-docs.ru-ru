---
title: Использование динамического шифрования AES Служб мультимедиа Azure | Документация Майкрософт
description: Доставка содержимого, зашифрованного 128-битными ключами шифрования AES, с помощью служб мультимедиа Microsoft Azure. Они также включают в себя службу доставки ключей, которая доставляет ключи шифрования авторизованным пользователям. В этой статье показано, как динамически шифровать содержимое с помощью алгоритма AES-128 и службы доставки ключей.
services: media-services
documentationcenter: ''
author: Juliako
manager: cfowler
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/26/2018
ms.author: juliako
ms.openlocfilehash: 0da5bbee6d0d6401a35c301a8b35dc0efa77da7d
ms.sourcegitcommit: 5892c4e1fe65282929230abadf617c0be8953fd9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/29/2018
ms.locfileid: "37133502"
---
# <a name="use-aes-128-dynamic-encryption-and-the-key-delivery-service"></a>Использование динамического шифрования AES-128 и службы доставки ключей

Службы мультимедиа можно использовать для доставки содержимого HTTP Live Streaming (HLS), MPEG-DASH и Smooth Streaming, зашифрованного с помощью 128-битных ключей шифрования AES. Они также включают в себя службу доставки ключей, которая доставляет ключи шифрования авторизованным пользователям. Если нужно зашифровать ресурс с помощью служб мультимедиа, свяжите ключ шифрования со StreamingLocator, а также настройте политику ключа содержимого. Когда поток запрашивается проигрывателем, службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью AES. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценивает политики авторизации, заданные для ключа.

Статья основана на образце [EncryptWithAES](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithAES). Образец демонстрирует, как создать преобразование кодирования, которое использует встроенную предустановку для кодирования с адаптивным битрейтом и принимает файл непосредственно из [URL-адреса источника HTTPS](job-input-from-http-how-to.md). Публикация выходного ресурса с помощью шифрования AES (ClearKey). Выходные данные из образца — это URL-адрес для проигрывателя мультимедиа Azure, включая как манифест DASH, так и токен AES, необходимый для воспроизведения содержимого. Образец устанавливает срок действия токена JWT до 1 часа. Можно открыть браузер и вставить полученный URL-адрес, чтобы запустить демонстрационную страницу проигрывателя мультимедиа Azure с URL-адресом и токеном, который уже указан (в следующем формате: ``` https://ampdemo.azureedge.net/?url= {dash Manifest URL} &aes=true&aestoken=Bearer%3D{ JWT Token here}```).

> [!NOTE]
> Каждый ресурс можно зашифровать с помощью нескольких типов шифрования (AES-128, PlayReady, Widevine, FairPlay). Чтобы понять, что лучше объединять, см. раздел [Потоковые протоколы и типы шифрования](content-protection-overview.md#streaming-protocols-and-encryption-types).

## <a name="prerequisites"></a>предварительным требованиям

Ниже перечислены необходимые условия для выполнения действий, описанных в этом учебнике.

* Просмотрите статью [Обзор системы защиты содержимого](content-protection-overview.md).
* Установка Visual Studio Code или Visual Studio.
* Создайте учетную запись Служб мультимедиа Azure, как описано в [этом руководстве](create-account-cli-quickstart.md).
* Получите учетные данные, необходимые для использования API служб мультимедиа, следуя [API доступа](access-api-cli-how-to.md)

## <a name="download-code"></a>Скачать код

Клонируйте репозиторий GitHub, содержащий полный пример .NET, рассмотренный в этом разделе, на компьютер с помощью следующей команды:

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials.git
 ```
 
Образец "Шифровать с AES-128" находится в папке [EncryptWithAES](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithAES).

> [!NOTE]
> Образец создает уникальные ресурсы при каждом запуске приложения. Как правило, будут повторно использовать существующие ресурсы, такие как преобразования и политики (если существующий ресурс имеет требуемые конфигурации). 

## <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы начать использование API Служб мультимедиа с .NET, создайте объект **AzureMediaServicesClient**. Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. В коде, который вы клонировали в начале статьи, функция **GetCredentialsAsync** создает объект ServiceClientCredentials с использованием учетных данных, предоставленных в локальном файле конфигурации. 

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CreateMediaServicesClient)]

## <a name="create-an-output-asset"></a>Создание выходного ресурса  

Выходной [ресурс](https://docs.microsoft.com/rest/api/media/assets) сохраняет результаты задания кодирования. После завершения кодирования выходной ресурс публикуется с использованием алгоритма шифрования AES (ClearKey).  

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CreateOutputAsset)]
 
## <a name="get-or-create-an-encoding-transform"></a>Получение или создание преобразования кодировки

При создании нового экземпляра [преобразования](https://docs.microsoft.com/rest/api/media/transforms) необходимо указать, что требуется создать в качестве выходных данных. Обязательный параметр — это объект **TransformOutput**, как показано в приведенном ниже примере кода. Каждый объект **TransformOutput** содержит **предустановку** (Preset). **Предустановка** описывает пошаговые инструкции для операций обработки видео и звука, которые будут использоваться для создания нужного объекта **TransformOutput**. Пример, описанный в этой статье, использует встроенную предустановку, называемую **AdaptiveStreaming**. Предустановка кодирует входное видео в автоматически созданную схему скоростей и разрешений (пары "скорость — разрешение") на основе входного разрешения и скорости и создает файлы ISO MP4 с видео H.264 и аудио AAC, соответствующие каждой паре "скорость — разрешение". 

Перед созданием нового [преобразования](https://docs.microsoft.com/rest/api/media/transforms) сначала проверьте, существует ли оно, с помощью метода **Get**, как показано в следующем коде.  В Службах мультимедиа версии 3 методы **Get**, отправленные к сущностям, возвращают значение **NULL**, если сущность не существует (проверка по имени без учета регистра).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#EnsureTransformExists)]

## <a name="submit-job"></a>Отправка задания

Как было указано выше, объект [преобразования](https://docs.microsoft.com/rest/api/media/transforms) является набором инструкций, а [задание](https://docs.microsoft.com/rest/api/media/jobs) — фактическим запросом к Службам мультимедиа для применения этого **преобразования** к данному видео и аудио. **Задание** указывает такую информацию, как расположение входного и выходного видео.

В руководстве мы создаем входные данные задания на основе файла, который принимается непосредственно из [URL-адреса источника протоколов HTTP](job-input-from-http-how-to.md).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#SubmitJob)]

## <a name="wait-for-the-job-to-complete"></a>Ожидание завершения задания

Выполнение задания занимает некоторое время. По его завершению вы будете уведомлены. В примере кода ниже показано, как опрашивать службу о состоянии [задания](https://docs.microsoft.com/rest/api/media/jobs). Опрос не рекомендуется для приложений рабочей среды из-за потенциальной задержки. Его можно регулировать при чрезмерном использовании в учетной записи. Вместо этого разработчики должны использовать службу "Сетка событий". Дополнительные сведения см. в статье [Route Azure Media Services events to a custom web endpoint using CLI](job-state-events-cli-how-to.md) (Маршрутизация событий Служб мультимедиа в пользовательскую конечную точку с помощью CLI).

**Задание** обычно проходит через такие состояния: **Запланировано**, **В очереди**, **Обработка**, **Завершено** (конечное состояние). Если в задании обнаружена ошибка, вы получите состояние **Ошибка**. Если задание находится в процессе отмены, вы получите состояние **Выполнение отмены** и **Отменено** по завершении.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#WaitForJobToFinish)]

## <a name="create-a-contentkey-policy"></a>Создание политики ContentKey

Ключ содержимого обеспечивает безопасность доступа к вашим ресурсам. Необходимо создать политику ключа содержимого, которая настраивает доставку ключа содержимого конечным клиентам. Ключ содержимого связан с StreamingLocator. Они также включают в себя службу доставки ключей, которая доставляет ключи шифрования авторизованным пользователям. 

Когда поток запрашивается проигрывателем, службы мультимедиа используют указанный ключ для динамического шифрования содержимого (в этом случае, с помощью AES.) Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценивает политики авторизации, заданные для ключа.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#GetOrCreateContentKeyPolicy)]

## <a name="get-a-token"></a>Получение маркера
        
В этом руководстве указывается, что политика ключа содержимого содержит ограничение по маркеру. При ограничении с помощью маркера к политике должен прилагаться маркер, выданный службой маркеров безопасности (STS). Службы мультимедиа поддерживают токены в форматах [Веб-маркера JSON](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_3) (JWT) и это то, что мы настраиваем в образцах.

ContentKeyIdentifierClaim используется в ContentKeyPolicy, что означает, что маркер, предоставленный службе доставки ключей, должен иметь идентификатор ContentKey. В образце не указывается ключ содержимого при создании StreamingLocator, система создает для нас случайный ключ. Чтобы создать тестовый маркер, нужно получить ContentKeyId для подачи утверждения ContentKeyIdentifierClaim.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#GetToken)]

## <a name="create-a-streaminglocator"></a>Создание указателя потоковой передачи

После выполнения кодирования необходимо сделать видео в выходном ресурсе доступным для воспроизведения клиентами. Это можно сделать в два этапа. Сначала создайте [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators), а затем URL-адреса потоковой передачи, которые клиенты могут использовать. 

Процесс создания **StreamingLocator** называется публикацией. По умолчанию **StreamingLocator** допустим сразу после выполнения вызова API и действует, пока не будет удален, если не настроить дополнительное начальное и конечное время. 

При создании [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators) необходимо указать желаемое имя **StreamingPolicyName**. В этом руководстве используется один из PredefinedStreamingPolicies, который сообщает службам мультимедиа Azure, как публиковать контент для потоковой передачи. В этом примере применяется конвертное шифрование AES (также известное как шифрование ClearKey, поскольку ключ доставляется клиенту воспроизведения через протокол HTTPS, а не через лицензию DRM).

> [!IMPORTANT]
> При использовании пользовательской политики [StreamingPolicy](https://docs.microsoft.com/rest/api/media/streamingpolicies) следует разработать ограниченный набор таких политик для учетной записи Служб мультимедиа и повторно использовать их для StreamingLocators всякий раз, когда требуются те же параметры шифрования и протоколы. У вашей учетной записи Служб мультимедиа есть квота на количество записей StreamingPolicy. Вы не должны создавать новый StreamingPolicy для каждого StreamingLocator.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CreateStreamingLocator)]

## <a name="build-a-dash-streaming-url"></a>Создайте URL-адрес потоковой передачи данных DASH

После создания [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators) вы можете получить URL-адреса потоковой передачи. Чтобы создать URL-адрес, необходимо сцепить имя узла [StreamingEndpoint](https://docs.microsoft.com/rest/api/media/streamingendpoints) и путь **StreamingLocator**. В этом примере используется **конечная точка потоковой передачи** *по умолчанию*. При первом создании учетной записи Служб мультимедиа эта **StreamingEndpoint** *по умолчанию* будет находиться в остановленном состоянии, поэтому вам необходимо вызвать функцию **Start**.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#GetMPEGStreamingUrl)]

## <a name="clean-up-resources-in-your-media-services-account"></a>Очистка ресурсов в учетной записи Служб мультимедиа

Как правило, необходимо очистить все, кроме объектов, которые вы планируете использовать повторно. Обычно повторно используются преобразования и будут сохранены StreamingLocators и т. д. Если учетную запись требуется очистить после эксперимента, следует удалить ресурсы, которые не планируется использовать повторно.  Например, следующий код удаляет задания.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CleanUp)]

## <a name="next-steps"></a>Дополнительная информация

[Обзор](content-protection-overview.md)