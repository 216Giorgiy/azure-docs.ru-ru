---
title: Защита содержимого с помощью служб мультимедиа Azure — Azure | Документация Майкрософт
description: В этой статье представлен обзор защиты содержимого с помощью служб мультимедиа.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/08/2018
ms.author: juliako
ms.custom: seodec18
ms.openlocfilehash: cb7e867ea4304cf8b8741eac183e60d325c752c7
ms.sourcegitcommit: 78ec955e8cdbfa01b0fa9bdd99659b3f64932bba
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2018
ms.locfileid: "53141855"
---
# <a name="content-protection-overview"></a>Обзор системы защиты содержимого

Службы мультимедиа Azure позволяют защитить данные мультимедиа, покидающие ваш компьютер, на этапах их хранения, обработки и доставки, а также доставлять в режиме реального времени и по требованию содержимое, зашифрованное динамически с помощью Advanced Encryption Standard (AES-128) или трех основных систем управления цифровыми правами (DRM): Microsoft PlayReady, Google Widevine и Apple FairPlay. Они также обеспечивают службу доставки ключей AES и лицензий DRM (PlayReady, Widevine и FairPlay) авторизованным клиентам. 

На следующем рисунке показан рабочий процесс защиты содержимого Служб мультимедиа: 

![Защита содержимого](./media/content-protection/content-protection.png)

&#42; *динамическое шифрование поддерживает AES-128 "незащищенный ключ", CBCS и CENC. Для дополнительных сведений см. матрицу поддержки [здесь](#streaming-protocols-and-encryption-types).*

В этой статье объясняются основные понятия и термины, необходимые для понимания процесса защиты содержимого с помощью AMS. В статье также содержится раздел [с вопросами и ответами](#faq) и ссылки на статьи, в которых обсуждается защита содержимого. 

## <a name="main-components-of-the-content-protection-system"></a>Основные компоненты системы защиты содержимого

Чтобы успешно завершить разработку проекта "защиты содержимого" системы или приложения, необходимо полностью представить объем трудозатрат. В следующем списке представлен обзор трех частей, которые необходимо применить. 

1. Код службы мультимедиа Azure
  
  * Лицензионные шаблоны для PlayReady, Widevine и/или FairPlay. Шаблоны позволяют настраивать права и разрешения для каждого используемого DRM
  * Авторизация доставки лицензии, определяющая логику проверки авторизации на основании утверждений в JWT
  * Применяемые ключи содержимого, протоколы потоковой передачи и соответствующие DRM определяют шифрование DRM

  > [!NOTE]
  > Каждый ресурс можно зашифровать с помощью нескольких типов шифрования (AES-128, PlayReady, Widevine, FairPlay). Чтобы понять, что лучше объединять, см. раздел [Протоколы потоковой передачи и типы шифрования](#streaming-protocols-and-encryption-types).
  
  В следующей статье описывается шифрование содержимого с помощью AES и (или) DRM: 
  
  * [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)
  * [Защита с помощью DRM](protect-with-drm.md)

2. Проигрыватель с использованием клиента AES или DRM. Приложение видеопроигрывателя на основе пакета SDK проигрывателя (или собственное, или браузерное) должно отвечать следующим требованиям.
  * Пакет SDK проигрывателя поддерживает необходимые клиенты DRM
  * Пакет SDK проигрывателя поддерживает требуемые протоколы потоковой передачи: Smooth, DASH и/или HLS
  * Пакет SDK проигрывателя должен иметь возможность обрабатывать передачу маркера JWT в запросе на получение лицензии
  
    Проигрыватель можно создать с помощью [API проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.

    Для тестирования зашифрованного содержимого AES или CENC (Widevine и (или) PlayReady) можно использовать [Проигрыватель мультимедиа Azure](https://ampdemo.azureedge.net/azuremediaplayer.html). Обязательно щелкните "Дополнительные параметры" и проверьте параметры шифрования.

    Если необходимо протестировать зашифрованное содержимое FairPlay, используйте [этот тестовый проигрыватель](https://aka.ms/amtest). Проигрыватель поддерживает DRM Widevine, PlayReady и FairPlay, а также шифрование незащищенного ключа AES-128. Необходимо выбрать правильный браузер для тестирования различных систем управления цифровыми правами: Chrome/Opera/Firefox для Widevine, MS Edge и IE 11 для PlayReady, Safari в Mac OS для FairPlay.

3. Служба токенов безопасности (STS), которая выдает JSON Web Token (JWT) в качестве маркера доступа для доступа к серверному ресурсу. Как серверный ресурс можно использовать службу доставки лицензий AMS. Служба токенов безопасности должна определять следующие данные.

  * Издатель и аудитория (или область)
  * Утверждения, которые зависят от бизнес-требований защиты содержимого
  * Симметричные или асимметричные проверки для проверки подписи
  * Поддержка смены ключей (при необходимости)

    Вы можете использовать [это средство STS](https://openidconnectweb.azurewebsites.net/DRMTool/Jwt) для тестирования STS, которое поддерживает все 3 типа ключей проверки: симметричный, асимметричный и AAD со сменой ключей. 

> [!NOTE]
> Настоятельно рекомендуется сосредоточиться и полностью проверить каждый элемент (описанный выше), прежде чем перейти к следующей части. Чтобы протестировать систему "защиты содержимого", используйте средства, указанные в списке выше.  

## <a name="streaming-protocols-and-encryption-types"></a>Протоколы потоковой передачи и типы шифрования

Службы мультимедиа Azure доставляют содержимое, динамически зашифрованное с помощью незащищенного ключа AES или шифрования DRM путем использования PlayReady, Widevine или FairPlay. Сейчас поддерживается шифрование в форматах HTTP Live Streaming (HLS), MPEG DASH и Smooth Streaming. Каждый протокол поддерживает следующие методы шифрования.

|Протокол|Формат контейнера|Схема шифрования|
|---|---|---|---|
|MPEG-DASH|Все|AES|
||CSF(fmp4) |CENC (Widevine + PlayReady) |
||CMAF(fmp4)|CENC (Widevine + PlayReady)|
|HLS|Все|AES|
||MPG2-TS |CBCS (FairPlay) |
||MPG2-TS |CENC (PlayReady) |
||CMAF(fmp4) |CENC (PlayReady) |
|Smooth Streaming|fMP4|AES|
||fMP4 | CENC (PlayReady) |

## <a name="dynamic-encryption"></a>Динамическое шифрование

В службе мультимедиа версии 3 ключ содержимого связан со StreamingLocator (см. [этот пример](protect-with-aes128.md)). Если используется служба доставки ключей служб мультимедиа, необходимо автоматически создать ключ содержимого. Ключ содержимого необходимо создать самостоятельно, если вы используете собственную службу доставки ключей или если необходимо обрабатывать сценарий высокой доступности, где нужно иметь один и тот же ключ содержимого в двух центрах обработки данных.

Когда поток запрашивается проигрывателем, Службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью незащищенного ключа AES или DRM. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей служб мультимедиа или в указанной вами службе доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

## <a name="aes-128-clear-key-vs-drm"></a>Незащищенный ключ AES-128 и DRM

Клиенты часто интересуются, следует ли им использовать шифрование AES или систему DRM. Основное различие между двумя системами заключается в том, что при шифровании AES ключ содержимого передается клиенту в незашифрованном формате ("в чистом виде"). В результате ключ, используемый для шифрования содержимого, можно просмотреть в сетевой трассировке на стороне клиента в виде открытого текста. Шифрование незащищенного ключа AES-128 подходит для использования в случаях, когда зритель является доверенным лицом (например, шифрование корпоративного видео, распространяемого внутри компании, для просмотра сотрудниками).

PlayReady, Widevine и FairPlay обеспечивают более высокий уровень шифрования по сравнению с незащищенным ключом AES-128. Ключ содержимого передается в зашифрованном виде. Кроме того, расшифровка выполняется в защищенной среде на уровне операционной системы, где злоумышленнику труднее атаковать. Мы рекомендуем использовать DRM в случаях, когда зритель не может быть доверенным лицом, и вам нужен самый высокий уровень безопасности.

## <a name="storage-side-encryption"></a>Шифрование на стороне хранилища

Чтобы защитить неактивные ресурсы, их нужно зашифровать на стороне хранилища. В следующей таблице показано, как происходит шифрование на стороне хранилища в службах мультимедиа версии 3.

|Вариант шифрования|ОПИСАНИЕ|Службы мультимедиа версии 3|
|---|---|---|---|
|Шифрование хранилища Служб мультимедиа| Шифрование AES-256. Ключами управляют Службы мультимедиа|Не поддерживается<sup>(1)</sup>|
|[Шифрование службы хранилища для неактивных данных](https://docs.microsoft.com/azure/storage/common/storage-service-encryption)|Шифрование на стороне сервера, предоставляемое службой хранилища Azure. Ключами управляет Azure или клиент|Поддерживаются|
|[Шифрование хранилища на стороне клиента](https://docs.microsoft.com/azure/storage/common/storage-client-side-encryption)|Шифрование на стороне клиента, предоставляемое службой хранилища Azure. Ключами управляет клиент в Key Vault|Не поддерживается|

<sup>1</sup> В Службах мультимедиа версии 3 для обратной совместимости поддерживается шифрование хранилища (шифрование AES-256), только если ресурсы созданы с помощью Служб мультимедиа версии 2. То есть версия 3 работает с существующими зашифрованными ресурсами хранилища, но создание новых ресурсов не поддерживается.

## <a name="licenses-and-keys-delivery-service"></a>Служба доставки лицензий и ключей

Службы мультимедиа предоставляют службу доставки ключей для доставки лицензий DRM (PlayReady, Widevine и FairPlay) и ключей AES авторизованным клиентам. Чтобы настроить политики авторизации и аутентификации для лицензий и ключей, можно использовать REST API или клиентскую библиотеку мультимедиа.

## <a name="control-content-access"></a>Доступ к содержимому элемента управления

Вы можете контролировать пользователей, имеющих доступ к содержимому, настроив политику ключей содержимого. Службы мультимедиа поддерживают несколько способов аутентификации пользователей, которые запрашивают ключи. Потребуется настроить политику ключей содержимого. Прежде чем ключ будет доставлен клиенту (проигрыватель), он должен быть приведен в соответствие с политикой. Политика ключей содержимого может иметь ограничения по **открытию** или по **маркеру**. 

При использовании политики ключей содержимого с ограничением по маркеру ключ содержимого будет отправлен только тому клиенту, который предоставит в запросе ключа или лицензии действующий токен JSON Web Token (JWT) или простой веб-токен (SWT). Этот токен должен быть выдан службой токенов безопасности (STS). Вы можете использовать Azure Active Directory в качестве STS или развернуть пользовательскую службу токенов безопасности. Чтобы создать маркер, подписанный указанным ключом, и получить утверждения, указанные в конфигурации ограничения по маркерам, должна быть настроена служба маркеров безопасности. Служба доставки ключей Служб мультимедиа возвращает клиенту запрошенный ключ (или лицензию), если маркер является допустимым, а его утверждения соответствуют утверждениям, настроенным для ключа (или лицензии).

При настройке политики ограничения по маркеру необходимо задать такие параметры, как основной ключ проверки, издатель и аудитория. Основной ключ проверки содержит ключ, которым был подписан маркер. Издателем является служба токенов безопасности, которая выдает токен. Аудитория, иногда называемая областью, описывает назначение маркера или ресурс, доступ к которому обеспечивает маркер. Служба доставки ключей служб мультимедиа проверяет, соответствуют ли эти значения в маркере значениям в шаблоне.

## <a name="a-idfaqfrequently-asked-questions"></a><a id="faq"/>Часто задаваемые вопросы

### <a name="question"></a>Вопрос

Как реализовать систему со службами DRM (PlayReady, Widevine и FairPlay) с помощью Служб мультимедиа Azure (AMS) версии 3, а также использовать службу доставки лицензий и ключей AMS?

### <a name="answer"></a>Ответ

Для комплексного сценария см. [приведенный ниже пример кода](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs). 

В примере показано, как выполнить следующие задачи.

1. Создание и настройка политик ключей содержимого.

  Пример содержит функции, которые настраивают лицензии [PlayReady](playready-license-template-overview.md), [Widevine](widevine-license-template-overview.md) и [FairPlay](fairplay-license-overview.md).

    ```
    ContentKeyPolicyPlayReadyConfiguration playReadyConfig = ConfigurePlayReadyLicenseTemplate();
    ContentKeyPolicyWidevineConfiguration widevineConfig = ConfigureWidevineLicenseTempate();
    ContentKeyPolicyFairPlayConfiguration fairPlayConfig = ConfigureFairPlayPolicyOptions();
    ```

2. Создание указателя потоковой передачи, который настроен для потоковой передачи зашифрованного ресурса. 

  Например, для StreamingLocator.StreamingPolicyName можно задать значение Predefined_MultiDrmCencStreaming. Эта политика указывает, что для получения созданного и настроенного указателя требуются два ключа содержимого (конверт и CENC). Таким образом применяются шифрования типа конверт, PlayReady и Widevine (ключ доставляется клиенту воспроизведения на основе настроенных лицензий DRM). Если необходимо выполнить шифрование потока с помощью CBCS (FairPlay), используйте Predefined_MultiDrmStreaming.

3. Создание тестового токена.

  Метод **GetTokenAsync** показывает, как создать тестовый токен.
  
4. Создание URL-адреса потоковой передачи.

  Метод **GetDASHStreamingUrlAsync** показывает, как создать URL-адрес потоковой передачи. В этом примере URL-адрес передает содержимое **DASH**.

### <a name="question"></a>Вопрос

Где и как получить токен JWT, чтобы использовать его для запроса лицензии или ключа?

### <a name="answer"></a>Ответ

1. Для рабочей среды необходимо иметь службу токенов безопасности (STS) (веб-службу), которая выдает токен JWT по HTTPS-запросу. Для тестирования можно использовать код, показанный в методе **GetTokenAsync**, который определен в файле [Program.cs](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs).
2. После выполнения проверки подлинности пользователя проигрывателю необходимо будет выполнить запрос к службе безопасности токенов на получение такого токена и присвоить его как значение токена. Можно использовать [API решения "Проигрыватель мультимедиа Azure"](https://amp.azure.net/libs/amp/latest/docs/).

* Пример запуска службы безопасности токенов с симметричным и асимметричным ключом см. на странице [http://aka.ms/jwt](https://aka.ms/jwt). 
* Пример проигрывателя на базе Проигрывателя мультимедиа Azure, в котором используется такой токен JWT, см. на странице [http://aka.ms/amtest](https://aka.ms/amtest) (разверните ссылку player_settings, чтобы увидеть входные данные токена).

### <a name="question"></a>Вопрос

Как вы авторизуете запросы на потоковую передачу видео с помощью шифрования AES?

### <a name="answer"></a>Ответ

Правильный подход заключается в использовании STS (службы токенов безопасности).

В службе токенов безопасности, в зависимости от профиля пользователя, добавьте разные утверждения (например, "Пользователь (цен.категория "Премиум")", "Пользователь (цен.категория "Базовый")", "Пользователь бесплатной пробной версии"). С различными утверждениями в JWT пользователь может видеть разное содержимое. Конечно, для разного содержимого или ресурса параметр ContentKeyPolicyRestriction будет иметь соответствующие утверждения RequiredClaims.

Используйте API Служб мультимедиа Azure для настройки доставки лицензий и ключей и шифрования ресурсов (как показано в [этом примере](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithAES/Program.cs).

## <a name="next-steps"></a>Дополнительная информация

Ознакомьтесь со следующими статьями:

  * [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)
  * [Защита с помощью DRM](protect-with-drm.md)

Дополнительные сведения см. в руководстве по [разработке системы для защиты содержимого с поддержкой технологии Multi-DRM и управления доступом](design-multi-drm-system-with-access-control.md).


