<properties 
	pageTitle="Спецификация приема фрагментированного MP4 в реальном времени в службах мультимедиа Azure" 
	description="Эта спецификация описывает протокол и формат приема потоковой передачи в реальном времени на основе фрагментированного формата MP4 для служб мультимедиа Microsoft Azure. Службы мультимедиа Microsoft Azure поддерживают услугу потоковой передачи в реальном времени, что позволяет клиентам транслировать поток текущих событий и передавать содержимое в реальном времени, используя Microsoft Azure в качестве облачной платформы. На момент написания статьи предварительно кодированный фрагментный MP4 является единственным механизмом приема потоковой передачи в реальном времени в службах мультимедиа Microsoft Azure. В этом документе также обсуждаются практические рекомендации по построению механизмов приема прямой трансляции с высокой избыточностью и надежностью." 
	services="media-services" 
	documentationCenter="" 
	authors="juliako" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/21/2015" 
	ms.author="juliako"/>

#Спецификация приема фрагментированного MP4 в реальном времени в службах мультимедиа Azure

Эта спецификация описывает протокол и формат приема потоковой передачи в реальном времени на основе фрагментированного формата MP4 для служб мультимедиа Microsoft Azure. Службы мультимедиа Microsoft Azure поддерживают услугу потоковой передачи в реальном времени, что позволяет клиентам транслировать поток текущих событий и передавать содержимое в реальном времени, используя Microsoft Azure в качестве облачной платформы. На момент написания статьи предварительно кодированный фрагментный MP4 является единственным механизмом приема потоковой передачи в реальном времени в службах мультимедиа Microsoft Azure. В этом документе также обсуждаются практические рекомендации по построению механизмов приема прямой трансляции с высокой избыточностью и надежностью.

##Замечание о соответствии

Ключевые слова «НЕОБХОДИМО», «НЕДОПУСТИМО», «ТРЕБУЕТСЯ», «НУЖНО», «НЕ ПОЗВОЛЯЕТСЯ», «СЛЕДУЕТ», «НЕ СЛЕДУЕТ», «РЕКОМЕНДУЕТСЯ», «ВОЗМОЖНО» и «НЕОБЯЗАТЕЛЬНО» в данном документе интерпретируются согласно описанию документе RFC 2119.

##Схема службы 

На следующей схеме показана архитектура высокого уровня службы потоковой передачи в реальном времени в службах мультимедиа Microsoft Azure:

1.	Динамический кодировщик помещает текущие потоки в каналы, которые создаются и подготавливаются посредством пакета SDK служб мультимедиа Microsoft Azure.
2.	Каналы, программы и конечная точка потоковой передачи в службах мультимедиа Microsoft Azure обрабатывают все связанные с потоковым вещанием функции, включая прием, форматирование, облачные DVR, безопасность, масштабируемость и избыточность.
3.	При необходимости клиенты могут выбрать развертывание слоя CDN между конечной точкой потоковой передачи и клиентскими конечными точками.
4.	Клиентские конечные точки передают поток из конечной точки потоковой передачи с помощью протоколов адаптивной потоковой передачи HTTP (например, Smooth Streaming, DASH, HDS или HLS).

![рисунок 1][image1]


##Формат битового потока — ISO 14496-12, фрагментированный MP4

Формат подключения для приема динамической потоковой передачи, обсуждаемой в настоящем документе, основан на стандарте [ISO-14496-12]. См. [[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx) для получения подробных сведений о фрагментированном формате MP4 и расширениях как для файлов видео по запросу, так и для приема прямой потоковой передачи.

Ниже приведен список специальных определений форматов, применяемых к приему в реальном времени в службах мультимедиа Microsoft Azure:

1. С каждым запросом (HTTP POST) НЕОБХОДИМО передавать поля «ftyp», LiveServerManifestBox и «moov». Их НЕОБХОДИМО передавать в начале потока и в любое время, когда кодировщику необходимо подключение для возобновления приема потока. Обратитесь к разделу 6 статьи [1] для получения дополнительных сведений.
2. Раздел 3.3.2 в статье [1] определяет необязательное поле с именем StreamManifestBox для приема динамической передачи. Из-за логики маршрутизации в подсистеме балансировки нагрузки Microsoft Azure использование этого поля является устаревшим и НЕ СЛЕДУЕТ допускать, чтобы оно присутствовало во время приема в службе мультимедиа Microsoft Azure. При наличии этого поля службы мультимедиа Azure автоматически его игнорируют.
3. В каждом фрагменте НЕОБХОДИМО наличие поля TrackFragmentExtendedHeaderBox, определенного в разделе 3.2.3.2 статьи [1]
4. Версию 2 поля TrackFragmentExtendedHeaderBox СЛЕДУЕТ использовать при необходимости создания сегментов мультимедиа с идентичными URL-адресами в нескольких центрах обработки данных. Поле индекса фрагмента ТРЕБУЕТСЯ для отработки отказа между центрами обработки данных для индексных форматов потоковой передачи, таких как Apple HTTP Live Streaming (HLS) и индексный MPEG-DASH. Для отработки отказа между центрами обработки данных индекс фрагмента НЕОБХОДИМО синхронизировать между несколькими кодировщиками и увеличивать на 1 для каждого последующего фрагмента медиаданных, даже несмотря на перезапуски или отказы кодировщиков.
5. Раздел 3.3.6 в статье [1] определяет поле, называемое MovieFragmentRandomAccessBox («mfra»), которое МОЖЕТ передаваться в канал в конце прямого приема для обозначения окончания потока (End-of-Stream, EOS). Из-за логики приема в службах мультимедиа Azure использование окончания потока является устаревшим, и поле «mfra» для приема прямой трансляции передавать НЕ СЛЕДУЕТ. В случае отправки этого поля службы мультимедиа Azure автоматически его игнорируют. Рекомендуется использовать [сброс канала](https://msdn.microsoft.com/library/azure/dn783458.aspx#reset_channels) для сброса состояния точки приема, а также рекомендуется использовать [остановку программы](https://msdn.microsoft.com/library/azure/dn783463.aspx#stop_programs) для завершения презентации и потока.
6. Длительность фрагмента MP4 СЛЕДУЕТ поддерживать постоянной, с целью сокращения размера клиентских манифестов и улучшения эвристики загрузки на стороне клиента путем использования повторных тегов. Длительность МОЖЕТ колебаться для компенсации нецелочисленной частоты кадров.
7. Длительность фрагмента MP4 СЛЕДУЕТ поддерживать между приблизительно 2 и 6 секундами.
8. СЛЕДУЕТ обеспечить поступление меток времени и индексов фрагментов MP4 (fragment_absolute_time и fragment_index в TrackFragmentExtendedHeaderBox) в порядке возрастания. Несмотря на то что службы мультимедиа Azure устойчивы к повторяющимся фрагментам, у них весьма ограниченные возможности по изменению порядка фрагментов в соответствии со шкалой времени мультимедийного содержимого.

##Формат протокола — HTTP

При приеме прямой передачи на основе фрагментированного формата MP4 стандарта ISO для служб мультимедиа Microsoft Azure используется стандартный долгосрочный запрос HTTP POST для передачи службе закодированных медиаданных, упакованных в фрагментированный формат MP4. При каждом запросе HTTP POST передается полный битовый поток фрагментированного формата MP4 («Поток»), начиная с начала полей заголовка («ftyp», «Поле манифеста сервера прямой передачи» и «moov») и продолжая последовательностью фрагментов (поля «moof» и «mdat»). Синтаксис URL-адреса запроса HTTP POST см. в разделе 9.2 статьи [1] Пример URL-адреса запроса POST:

	http://customer.channel.mediaservices.windows.net/ingest.isml/streams(720p)

Ниже описаны подробные требования.

1. Кодировщику СЛЕДУЕТ запускать вещание, отправляя запрос HTTP POST с пустым «телом» (нулевой длиной содержимого), используя тот же URL-адрес приема. Это позволяет быстро определять допустимость конечной точки прямого приема и наличие требований к проверке подлинности и других условий. В отношении протокола HTTP сервер не сможет отправить обратно HTTP-ответ до получения всего запроса, включая тело POST. С учетом долговременного характера транслируемого события без этого шага кодировщик не сможет выявить никакой ошибки до тех пор, пока не завершит передачу всех данных.
2. Кодировщику НЕОБХОДИМО обрабатывать все ошибки и проблемы проверки подлинности в результате (1). Если (1) завершится успешно с ответом 200, продолжайте.
3. Кодировщику НЕОБХОДИМО запустить новый запрос HTTP POST с фрагментированным потоком MP4. Полезные данные НЕОБХОДИМО начинать с полей заголовка, за которыми следуют фрагменты. Обратите внимание, что поля «ftyp», «Поле манифеста сервера прямой передачи» и «moov» (в указанном порядке) НЕОБХОДИМО отправлять с каждым запросом, даже если кодировщику необходимо подключиться повторно из-за того, что предыдущий запрос был прерван до окончания потока. 
4. Кодировщику НЕОБХОДИМО использовать для отправки данных фрагментное кодирование передачи, поскольку невозможно предсказать длину всего содержимого транслируемого в реальном времени события.
5. Когда событие завершится, после отправки последнего фрагмента кодировщику НЕОБХОДИМО корректно завершить последовательность сообщений фрагментного кодирования передачи (большинство стеков клиентов HTTP справляются с этим автоматически). Кодировщику НЕОБХОДИМО дождаться возврата службой окончательного кода ответа, а затем разорвать соединение. 
6. Кодировщику НЕДОПУСТИМО использовать существительное Events(), как описано в разделе 9.2 статьи [1], для приема прямой передачи в службах мультимедиа Microsoft Azure.
7. Если запрос HTTP POST завершится или превысит время ожидания до окончания потока с ошибкой TCP, кодировщику НЕОБХОДИМО выдать новый запрос POST с использованием нового соединения и соблюдать указанные выше требования с еще одним дополнительным: кодировщику НЕОБХОДИМО повторно отправить предыдущие два фрагмента MP4 для каждой дорожки в потоке, и возобновить работу без нарушения непрерывности шкалы времени мультимедийного содержимого. Повторная отправка последних двух фрагментов MP4 для каждой дорожки позволяет избежать потери данных. Иными словами, если поток содержит как аудио-, так и видеодорожку, то в случае сбоя текущего запроса POST кодировщику необходимо заново подключиться и отправить повторно два последних фрагмента звуковой дорожки, успешно отправленных ранее, и два последних фрагмента видеодорожки, которые также были ранее успешно отправлены, чтобы обеспечить отсутствие потери данных. Кодировщику НЕОБХОДИМО поддерживать «упреждающий» буфер медиафрагментов, которые он будет отправлять заново при повторном подключении.

##Шкала времени 

[[MS SSTR]](https://msdn.microsoft.com/library/ff469518.aspx) описывает использование «Шкалы времени» для SmoothStreamingMedia (раздел 2.2.2.1), StreamElement (раздел 2.2.2.3), StreamFragmentElement(2.2.2.6) и LiveSMIL (раздел 2.2.7.3.1). Если значение шкалы времени не указано, используется значение по умолчанию 10 000 000 (10 МГц). Несмотря на то, что спецификация формата Smooth Streaming не блокирует использование других значений шкалы времени, в большинстве реализаций кодировщиков значение по умолчанию (10 МГц) используется для формирования данных приема Smooth Streaming. Из-за функции [динамической упаковки мультимедиа Azure](media-services-dynamic-packaging-overview.md) рекомендуется использовать шкалу времени 90 кГц для видеопотоков и 44,1 или 48,1 кГц для аудиопотоков. В случае использования разных значений шкалы времени для разных потоков НЕОБХОДИМО отправлять шкалу времени уровня потока. См. [[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx).

##Определение «Потока»  

«Поток» — это базовая единица операции при приеме прямой передачи для составления текущей презентации, обработки сценариев избыточности и отработки отказа потоковой передачи. «Поток» определяется как один уникальный фрагментированный битовый поток MP4, который может содержать одну или несколько дорожек. Полная текущая презентация может содержать один или несколько потоков в зависимости от конфигурации кодировщика или кодировщиков реального времени. Ниже показаны примеры различных вариантов использования потоков для составления полной текущей презентации.

**Пример**

Клиент хочет создать презентацию потоковой передачи в реальном времени, которая будет включать следующие скорости потоков аудио/видео:

Видео — 3000 кбит/с, 1500 кбит/с, 750 кбит/с

Аудио — 128 кбит/с

###Вариант 1. Все дорожки в одном потоке

В этом случае один кодировщик формирует все аудио- и видеодорожки и объединяет их в один фрагментированный битовый поток MP4, который затем передается через единое подключение HTTP POST. В этом примере имеется только один поток для текущей презентации:

![рисунок 2][image2]

###Вариант 2. Каждая дорожка в отдельном потоке

В этом случае кодировщик или кодировщики помещают только по одной дорожке в каждый фрагментный битовый поток MP4 и передают все потоки по разным отдельным подключениям HTTP. Это можно сделать с помощью одного или нескольких кодировщиков. С точки зрения приема прямой передачи такая текущая презентация состоит из четырех потоков.

![image3][image3]

###Вариант 3. Объединение звуковой дорожки с видеодорожкой наименьшей скорости в один поток

В этом случае клиент выбирает объединить аудиодорожку и видеодорожку с наименьшей скоростью потока в один фрагментный битовый поток MP4 и оставить другие две видеодорожки в отдельных потоках.


![image4][image4]


###Сводка

Показанное выше НЕ является исчерпывающим списком всех возможных вариантов приема в данном примере. Фактически приемом прямой передачи поддерживается любое группирование дорожек в потоки. Заказчики и поставщики кодировщиков могут выбирать собственные реализации в зависимости от инженерной сложности, емкости кодировщика и соображений избыточности и отработки отказов. Однако следует отметить, что в большинстве случаев во всей текущей презентации существует только одна звуковая дорожка, поэтому важно обеспечить устойчивость принимаемого потока, в котором она содержится. Это обстоятельство часто приводит к помещению звуковой дорожки в собственный поток (как в варианте 2) или ее объединению с видеодорожкой наименьшей скорости потока (как в варианте 3). Также для повышения избыточности и отказоустойчивости передача звуковой дорожки в двух разных потоках (вариант 2 с избыточными звуковыми дорожками) или объединение звуковой дорожки по крайней мере с двумя видеодорожками с наименьшей скоростью (вариант 3 со звуком, включенным в не менее чем два видеопотока) настоятельно рекомендуются для приема прямой передачи в службах мультимедиа Microsoft Azure.

##Отработка отказа службы 

С учетом характера прямой потоковой передачи хорошая поддержка отработки отказов критически важна для обеспечения доступности службы. Службы мультимедиа Microsoft Azure предусматривают обработку различных типов сбоев, включая сетевые ошибки, ошибки сервера, проблемы с хранением данных и т. д. При использовании в сочетании с надлежащей логикой отработки отказа со стороны кодировщика реального времени заказчик может обеспечить высоконадежное обслуживание прямой потоковой передачи из облака.

В этом разделе мы обсудим сценарии отработки отказа службы. В данном случае сбой происходит где-либо в пределах службы и проявляется как сетевая ошибка. Ниже приведены некоторые рекомендации по реализации кодировщика для отработки отказа службы.


1. Используйте время ожидания 10 секунд при установлении TCP-подключения. Если попытка установления соединения занимает более 10 секунд, прервите операцию и повторите попытку. 
2. Используйте короткое время ожидания для передачи фрагментов сообщений HTTP-запроса. Если целевая длительность фрагмента MP4 составляет N секунд, используйте время ожидания отправки от N до 2N секунд; например, установите время ожидания от 6 до 12 секунд, если длительность фрагмента MP4 равна 6 секундам. В случае превышения времени ожидания сбросьте соединение, откройте новое и возобновите прием потока в новом соединении. 
3. Поддерживайте скользящий буфер, содержащий два последних фрагмента для каждой дорожки, которые были успешно и полностью отправлены службе. Если запрос HTTP POST для потока прервется или превысит время ожидания до окончания потока, откройте новое подключение и начните другой запрос HTTP POST, повторно отправьте заголовки потока, а также последние два фрагмента для каждой дорожки, и возобновите поток без нарушения шкалы времени мультимедийного содержимого. Это позволит уменьшить вероятность потери данных.
4. Рекомендуется, чтобы кодировщик НЕ ограничивал число повторных попыток установления соединения или возобновления потоковой передачи после ошибки TCP.
5. После возникновения ошибки TCP:
	1. НЕОБХОДИМО закрыть текущее соединение, а также НЕОБХОДИМО создать новое соединение для нового запроса HTTP POST.
	2. URL-адрес нового запроса HTTP POST ДОЛЖЕН совпадать с URL-адресом изначального запроса POST.
	3. Новый запрос HTTP POST ДОЛЖЕН включать заголовки потока (поля «ftyp», «Поле манифеста сервера прямой передачи» и «moov»), идентичные заголовкам потока в изначальном запросе POST.
	4. НЕОБХОДИМО заново передать последние два фрагмента, отправленные для каждой дорожки, и возобновить потоковую передачу без нарушения шкалы времени мультимедийного содержимого. Метки времени фрагментов MP4 должны продолжать увеличиваться, даже несмотря на смену запросов HTTP POST.
6. Кодировщику СЛЕДУЕТ прервать запрос HTTP POST, если данные не передаются со скоростью, соизмеримой с длительностью фрагмента MP4. Запрос HTTP POST, который не передает данные, может препятствовать быстрому отключению служб мультимедиа Azure от кодировщика в случае обновления службы. По этой причине запрос HTTP POST для разреженных (рекламно-сигнальных) дорожек СЛЕДУЕТ сделать кратковременно существующим, прерывая его сразу же после отправки разреженного фрагмента.

##Отработка отказа кодировщика

Отработка отказа кодировщика — это второй тип сценария отработки отказа, который необходимо предусмотреть для обеспечения сквозной прямой потоковой передачи. В этом сценарии состояние ошибки произошло на стороне кодировщика.

![рисунок 5][image5]


Ниже описаны ожидания со стороны конечной точки приема прямой передачи в случае отработки отказа кодировщика.

1. СЛЕДУЕТ создать новый экземпляр кодировщика для продолжения потоковой передачи, как показано на схеме выше (поток для видео скоростью 3000 кбит/с, обозначенный пунктирной линией).
2. Для запросов HTTP POST нового кодировщика НЕОБХОДИМО использовать же URL-адрес, что и для отказавшего экземпляра.
3. В запрос POST нового кодировщика НЕОБХОДИМО включить такие же поля заголовка фрагментированного формата MP4, как и в отказавшем экземпляре.
4. Новый кодировщик НЕОБХОДИМО должным образом синхронизировать со всеми другими запущенными кодировщиками для той же текущей презентации, чтобы формировать синхронизированные образцы аудио/видео с согласованными границами фрагментов.
5. Новый поток НЕОБХОДИМО сделать семантически эквивалентным с предыдущим потоком и взаимозаменяемым на уровне заголовка и фрагментов.
6. Новому кодировщику СЛЕДУЕТ стремиться минимизировать потерю данных. СЛЕДУЕТ обеспечить увеличение значений fragment_absolute_time и fragment_index для фрагментов медиаданных, начиная с момента последней остановки кодировщика. Для значений fragment_absolute_time и fragment_index СЛЕДУЕТ обеспечить непрерывное возрастание, но при необходимости разрешено нарушить эту последовательность. Службы мультимедиа Azure будут игнорировать фрагменты, которые уже ими получены и обработаны, поэтому лучше допустить ошибку на стороне повторной отправки фрагментов, чем вносить нарушения в шкалу времени мультимедийного содержимого. 

##Избыточность кодировщиков 

Для некоторых критически важных транслируемых событий, для которых требуется особо высокая степень доступности и качество передачи, рекомендуется задействовать активно-активные избыточные кодировщики для достижения беспроблемной отработки отказа без потери данных.

![рисунок 6][image6]

Как показано на схеме выше, существуют две группы кодировщиков, которые одновременно передают две копии каждого потока в службу прямой передачи. Такая конфигурация поддерживается благодаря возможности служб мультимедиа Microsoft Azure фильтровать повторяющиеся фрагменты на основе идентификатора потока и метки времени фрагмента. Получающиеся в результате текущий поток и архив будут представлять собой одиночную копию всех потоков, являющуюся лучшей возможной агрегацией из двух источников. Например, в гипотетическом крайнем случае, пока работает хотя бы один кодировщик (не обязательно, чтобы он постоянно был одним и тем же) в любой момент времени для каждого потока, получающийся в результате текущий поток от службы будет непрерывным без потери данных.

Требования к данному сценарию почти аналогичны требованиям в случае отработки отказа кодировщика, за исключением того, что второй набор кодировщиков выполняется одновременно с основными кодировщиками.

##Избыточность служб  

Для глобального распространения с высокой избыточностью иногда требуется межрегиональное резервное копирование на случай аварий в тех или иных регионах. В дополнение к топологии «Избыточность кодировщиков» заказчики могут выбрать развертывание избыточных служб в другом регионе, которые будут подключены с использованием второго набора кодировщиков. Заказчики также могут в сотрудничестве с поставщиком CDN развернуть глобальный диспетчер трафика (GTM) перед двумя развернутыми экземплярами служб для беспрепятственной маршрутизации клиентского трафика. Требования к кодировщикам аналогичны ситуации «Избыточность кодировщиков» с единственным исключением: второй набор кодировщиков необходимо направить на другую конечную точку приема прямой передачи. Такая система показана на схеме ниже:

![рисунок 7][image7]

##Специальные типы форматов приема 

В этом разделе рассматриваются некоторые специальные типы форматов приема прямой передачи, которые предназначены для обработки особых сценариев.

###Разреженная дорожка

При доставке текущей потоковой презентации с расширенными возможностями взаимодействия с пользователем часто бывает необходимо передавать синхронизированные по времени события или сигналы по тому же каналу, что и основные медиаданные. Примером этого является динамическая вставка рекламы в текущий поток. Этот тип сигнализации о событиях отличается от обычной потоковой передачи аудио/видео из-за своего разреженного характера. Иными словами, сигнальные данные зачастую не передаются непрерывно, и интервал может быть трудно предсказать. Понятие разреженной дорожки было специально введено для приема и трансляции сигнальных данных в общем канале.

Ниже описана рекомендуемая реализация приема разреженной дорожки.

1. Создайте отдельный фрагментированный битовый поток MP4, содержащий только одну или несколько разреженных дорожек без аудио- и видеодорожек.
2. В «Поле манифеста сервера прямой передачи», которое определено в разделе 6 статьи [1], укажите имя родительской дорожки с помощью параметра parentTrackName. Обратитесь к разделу 4.2.1.2.1.2 статьи [1] для получения дополнительных сведений.
3. В «Поле манифеста сервера прямой передачи» параметру manifestOutput НЕОБХОДИМО задать значение true.
4. Учитывая разреженный характер сигнального события, рекомендуется следующее.
	1. В начале транслируемого события кодировщик отправляет поля изначального заголовка службе, что позволит службе зарегистрировать разреженную дорожку в манифесте клиента.
	2. Кодировщику СЛЕДУЕТ прервать запрос HTTP POST, если данные не отправляются. Долго выполняющийся запрос HTTP POST, который не передает данных, может препятствовать быстрому отключению служб мультимедиа Azure от кодировщика в случае обновления службы или перезагрузки сервера, поскольку сервер мультимедиа будет временно заблокирован в ходе операции приема на сокете. 
	3. Во время, когда сигнальные данные недоступны, кодировщику СЛЕДУЕТ закрыть запрос HTTP POST. Пока запрос POST активен, кодировщику СЛЕДУЕТ отправлять данные. 
	4. При отправке разреженных фрагментов кодировщик может явно задать заголовок Content-Length, если он доступен.
	5. При отправке разреженного фрагмента с новым соединением кодировщику СЛЕДУЕТ начать отправку с полей заголовка, за которыми будут следовать новые фрагменты. Это позволяет обрабатывать случаи, когда отработка отказа происходит в промежутке и устанавливается новое разреженное подключение к новому серверу, которому ранее не встречалась разреженная дорожка.
	6. Фрагмент разреженной дорожки станет доступен клиенту, когда ему будет доступен соответствующий фрагмент родительской дорожки с равным или большим значением метки времени. Например, если разреженный фрагмент содержит метку времени t=1000, ожидается, что после того как клиент увидит видеофрагмент (при условии, что имя родительской дорожки — video) с меткой времени 1000 или больше, он сможет загрузить разреженный фрагмент t=1000. Обратите внимание на то, что фактический сигнал может эффективно использоваться и в другой позиции на шкале времени презентации с назначенной целью. В приведенном выше примере возможно, что разреженный фрагмент t=1000 содержит полезные данные XML для вставки рекламы в позицию несколькими секундами позже.
	7. Полезные данные фрагмента разреженной дорожки могут быть в различных форматах (например, XML, текстовом, двоичном и т. д.) в зависимости от тех или иных сценариев. 


###Избыточная звуковая дорожка

В типичном сценарии адаптивной потоковой передачи HTTP (например, с помощью Smooth Streaming или DASH) зачастую имеется только одна звуковая дорожка на всю презентацию. В отличие от видеодорожек, которые предусматривают несколько уровней качества на выбор клиента в условиях ошибки, звуковая дорожка может стать единственной точкой отказа, если прием потока, содержащего звуковую дорожку, прервется.

Для решения этой проблемы службы мультимедиа Microsoft Azure поддерживают прием прямой передачи с избыточными звуковыми дорожками. Идея заключается в том, что одну и ту же звуковую дорожку можно передавать несколько раз в разных потоках. Хотя служба зарегистрирует звуковую дорожку только один раз в клиентском манифесте, она может использовать избыточные звуковые дорожки в качестве резервных копий для получения аудиофрагментов в случае проблем с основной звуковой дорожкой. Для приема избыточных звуковых дорожек кодировщику требуется:

1. Создать такую же звуковую дорожку в нескольких битовых потоках фрагментированного формата MP4. НЕОБХОДИМО, чтобы избыточные звуковые дорожки были семантически эквивалентными с точно такими же метками времени фрагментов и взаимозаменяемыми на уровне заголовка и фрагментов.
2. Убедитесь, что запись «audio» в манифесте сервера прямой передачи (раздел 6 в статье [1]) совпадает для всех избыточных звуковых дорожек.

Ниже описана рекомендуемая реализация для избыточных звуковых дорожек.

1. Передавайте каждую уникальную звуковую дорожку в собственном потоке. Также передавайте избыточный поток для каждого из этих потоков звуковой дорожки, где второй поток будет отличаться от первого только идентификатором в URL-адресе запроса HTTP POST: {протокол}://{адрес сервера}/{путь к точке публикации}/Streams({идентификатор}).
2. Используйте отдельные потоки для отправки двух видеодорожек с наименьшей скоростью потока. В каждом из этих потоков СЛЕДУЕТ обеспечить наличие копии каждой уникальной звуковой дорожки. Например, при поддержке нескольких языков в эти потоки СЛЕДУЕТ включить звуковые дорожки для каждого языка.
3. Используйте отдельные экземпляры сервера (кодировщика) для кодирования и отправки избыточных потоков, упомянутых в (1) и (2). 


[image1]: ./media/media-services-fmp4-live-ingest-overview/media-services-image1.png
[image2]: ./media/media-services-fmp4-live-ingest-overview/media-services-image2.png
[image3]: ./media/media-services-fmp4-live-ingest-overview/media-services-image3.png
[image4]: ./media/media-services-fmp4-live-ingest-overview/media-services-image4.png
[image5]: ./media/media-services-fmp4-live-ingest-overview/media-services-image5.png
[image6]: ./media/media-services-fmp4-live-ingest-overview/media-services-image6.png
[image7]: ./media/media-services-fmp4-live-ingest-overview/media-services-image7.png

 

<!---HONumber=July15_HO2-->