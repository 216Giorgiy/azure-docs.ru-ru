<properties 
	pageTitle="Обработка конфликтов с автономными данными в мобильных службах (Windows Phone) | Microsoft Azure" 
	description="Узнайте, как использовать возможности мобильных служб Azure для обработки конфликтов при синхронизации автономных данных в приложении Windows Phone." 
	documentationCenter="windows" 
	authors="wesmc7777" 
	manager="dwrede" 
	editor="" 
	services="mobile-services"/>

<tags 
	ms.service="mobile-services" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile-windows-phone" 
	ms.devlang="dotnet" 
	ms.topic="article" 
	ms.date="06/15/2015" 
	ms.author="wesmc"/>


# Обработка конфликтов синхронизации автономных данных в мобильных службах

[AZURE.INCLUDE [mobile-services-selector-offline-conflicts](../../includes/mobile-services-selector-offline-conflicts.md)]

##Обзор

В этом разделе показывается, как синхронизировать данные и обрабатывать конфликты при использовании возможностей автономной работы мобильных служб Azure. В этом учебнике вам предстоит загрузить приложение, которое поддерживает автономные и оперативные данные, интегрировать мобильную службу с приложением, а затем выполнить вход на портал управления Azure для просмотра и обновления базы данных в ходе выполнения приложения.

Этот учебник основан на инструкциях и примере приложения предыдущего учебника [Приступая к работе с автономными данными]. Перед началом работы с учебником необходимо пройти задания учебника [Приступая к работе с автономными данными].


##Предварительные требования

Для работы с этим учебником необходимы Visual Studio 2012 и [пакет Windows Phone 8 SDK].


##Загрузка примера проекта



Этот учебник основан на [примере кода обработки конфликтов], который представляет собой проект Windows Phone 8 для Visual Studio 2012. Пользовательский интерфейс для этого приложения аналогичен приложению в учебнике [Приступая к работе с автономными данными], за исключением того, что в нем имеется новый столбец данных для каждого элемента TodoItem.

![][0]


1. Загрузите версию Windows Phone [примера кода обработки конфликтов]. 

2. Установите [решение SQLite для Windows Phone 8], если оно не установлено.

3. В Visual Studio 2012 откройте загруженный проект. Добавьте ссылку на **SQLite для Windows Phone** в разделе **Windows Phone** > **Расширения**.

4. В Visual Studio 2012 нажмите клавишу **F5**, чтобы построить и запустить приложение в отладчике.
 
5. В приложении введите какой-либо текст в нескольких новых элементах списка дел и нажмите кнопку **Сохранить**, чтобы сохранить их все. Вы также можете изменить дату выполнения добавляемых элементов списка дел.


Обратите внимание, что приложение еще не подключено к мобильной службе, поэтому кнопки **Push** и **Pull** будут вызывать исключения.


##Добавление столбца в модель данных

В этом разделе вы обновите базу данных, чтобы добавить таблицу TodoItem со столбцом даты выполнения в мобильную службу. Приложение позволяет изменить дату выполнения для элемента во время выполнения, чтобы создавать конфликты синхронизации в следующем разделе данного учебника.

Класс `TodoItem` в этом примере определяется в файле MainPage.xaml.cs. Обратите внимание, что класс содержит следующий атрибут, который используется для операций синхронизации для этой таблицы.

        [DataTable("TodoWithDate")]

Добавьте эту таблицу в базу данных.

###<a name="dotnet-backend"></a>Обновление базы данных для серверных мобильных служб .NET 

Если вы используете серверную часть .NET для мобильной службы, выполните следующие действия для обновления схемы базы данных.

1. Откройте проект серверной мобильной службы .NET в Visual Studio.
2. В обозревателе решений Visual Studio в проекте службы разверните папку **Модели** и откройте файл ToDoItem.cs. Добавьте свойство `DueDate`, как показано ниже.

          public class TodoItem : EntityData
          {
            public string Text { get; set; }
            public bool Complete { get; set; }
            public System.DateTime DueDate { get; set; }
          }


3. В обозревателе решений в Visual Studio разверните папку **App\_Start** и откройте файл WebApiConfig.cs.

    В файле WebApiConfig.cs обратите внимание, что класс инициализатора базы данных по умолчанию является производным от класса `DropCreateDatabaseIfModelChanges`. Это означает, что любое изменение модели приведет в таблице к его удалению и повторному созданию в соответствии с новой моделью. Таким образом данные в таблице будут потеряны, а таблица будет повторно заполнена. Измените метод Seed инициализатора базы данных так, чтобы инициализация `Seed()` функционировала следующим образом для инициализации нового столбца DueDate. Сохраните файл WebApiConfig.cs.

    >[AZURE.NOTE]В случае использования инициализатора базы данных по умолчанию Entity Framework будет удалять и заново создавать базу данных при каждом обнаружении изменения модели данных в определении модели Code First. Чтобы сделать это изменение модели данных и сохранить существующие данные в базе данных, необходимо использовать Code First Migrations. Дополнительные сведения см. в разделе [Как использовать Code First Migrations для обновления модели данных](mobile-services-dotnet-backend-how-to-use-code-first-migrations.md).


        new TodoItem { Id = "1", Text = "First item", Complete = false, DueDate = DateTime.Today },
        new TodoItem { Id = "2", Text = "Second item", Complete = false, DueDate = DateTime.Today },

          

4. В обозревателе решений Visual Studio разверните папку **Контроллеры** и откройте файл ToDoItemController.cs. Переименуйте класс `TodoItemController` на `TodoWithDateController`. Это приведет к изменению конечной точки REST для табличных операций.

        public class TodoWithDateController : TableController<TodoItem>
    

5. В обозревателе решений в Visual Studio щелкните правой кнопкой мыши проект мобильной службы для .NET и выберите пункт**Опубликовать** для публикации изменений.


### <a name="javascript-backend"></a>Обновление базы данных для серверных мобильных служб JavaScript

Для мобильных служб, использующих серверную часть JavaScript, вы добавите новую таблицу с именем **TodoWithDate**. Для добавления таблицы **TodoWithDate** для мобильных служб, использующих серверную часть JavaScript, выполните следующие действия.

  1. Выполните вход на [портал управления Azure]. 

  2. Перейдите на вкладку **Данные** мобильной службы.

  3. Щелкните **Создать** в нижней части страницы, а затем создайте новую таблицу с именем **TodoWithDate**.


##Тестирование приложения с мобильной службой

Теперь пришло время проверить работу приложения с мобильными службами.

1. На портале управления Azure найдите ключ приложения мобильной службы, нажав кнопку **Управление ключами** в панели команд на вкладке **Панель мониторинга**. Скопируйте **ключ приложения**.

2. В обозревателе решений в Visual Studio откройте файл App.xaml.cs в проекте примера клиентского приложения. Добавьте в инициализацию **MobileServiceClient** URL-адрес вашей мобильной службы и ключ приложения:

         public static MobileServiceClient MobileService = new MobileServiceClient(
            "https://your-mobile-service.azure-mobile.net/",
            "Your AppKey"
        );

3. В Visual Studio нажмите клавишу **F5**, чтобы построить и запустить приложение.

4. Как и ранее, введите текст в текстовом поле и нажмите кнопку **Сохранить**, чтобы сохранить новые элементы списка дел. При этом данные сохраняются в локальной таблице синхронизации, но не на сервере.

    ![][0]

5. Для просмотра текущего состояния базы данных войдите на [портал управления Azure], щелкните элемент **Мобильные службы** и выберите вашу мобильную службу.

  * Если используется серверная часть JavaScript для мобильной службы, перейдите на вкладку **Данные**, а затем щелкните таблицу **TodoWithDate**. Нажмите кнопку **Обзор** чтобы убедиться, что таблица по-прежнему пуста, так как мы не передали изменения из приложения на сервер.

        ![][1]

  *  Если используется серверная часть .NET для мобильной службы, перейдите на вкладку **Настройка**, а затем щелкните базу данных SQL. Нажмите кнопку **Управление** в нижней части экрана, чтобы войти на портал управления SQL Azure для просмотра базы данных путем запуска запроса SQL, подобного следующему запросу.
    
            SELECT * FROM todolist.todowithdate

        ![][2]

   	 

7. Вернитесь в приложение и нажмите кнопку **Отправить**.

8. На портале управления щелкните кнопку **Обновись** в таблице **TodoItem**. Теперь вы увидите данные, введенные в приложении.

   	![][3]

9. Оставьте **эмулятор WVGA 512MB** запущенным для следующего раздела, в котором приложение будет запускаться в двух эмуляторах для создания конфликта.

##Обновление данных в серверной части для создания конфликта

В реальной ситуации конфликт синхронизации происходит, когда одно приложение отправляет обновления записи в базе данных, а затем другое приложение пытается отправить изменение в ту же запись, используя устаревшую версию поля в этой записи. Если экземпляр приложения пытается обновить ту же запись без извлечения обновленной записи, возникает конфликт, который будет зафиксирован как исключение `MobileServicePreconditionFailedException` в приложении.

В этом разделе будут одновременно запускаться два экземпляра приложения для создания конфликта.


1. Если **эмулятор WVGA 512MB** еще не запущен, нажмите сочетание клавиш **Ctrl+F5**, чтобы запустить его.

2. В Visual Studio измените устройство вывода на **эмулятор WVGA** и запустите второй экземпляр приложения в новом эмуляторе, нажав клавишу **F5**.
 
    ![][5]
 
   
3. Во втором экземпляре приложения нажмите **Запросить**, чтобы синхронизировать локальное хранилище с базой данных мобильной службы. Оба экземпляра приложения должны иметь одни и те же данные.
 
    ![][6]

4. Во втором экземпляре приложения нажмите кнопку с флажком, чтобы заполнить один из элементов, затем нажмите **Отправить**, чтобы отправить изменение в удаленную базу данных. На следующем снимке экрана раздел **Pick up James** заполнен, что указывает, что James уже был заполнен. Первый экземпляр приложения теперь имеет устаревшую запись.

    ![][9]

5. В первом экземпляре приложения попробуйте изменить дату устаревшей записи, а затем нажмите **Отправить**, чтобы попытаться обновить удаленную базу данных с помощью устаревшей записи. На следующем снимке экрана мы пытаемся заполнить для James дату **5/10/2014**.

    ![][7]

6. Если нажать кнопку **Отправить**, чтобы зафиксировать изменение даты, то появится диалоговое окно, указывающее на обнаруженный конфликт. Вам будет задан вопрос, как следует разрешить этот конфликт. Выберите один из способов разрешения конфликта.

    В приведенном ниже сценарии James уже был заполнен. Поэтому не нужно планировать заполнение для него на дату **5/10/2014**. Можно выбрать параметр **Использовать версию сервера**, чтобы запись в первом экземпляре приложения обновлялась записью с сервера.

    ![][8]

##Проверка кода для обработки конфликтов синхронизации

Чтобы настроить автономный компонент для обнаружения конфликтов, необходимо добавить столбец версии в локальную базу данных и в объект передачи данных. Класс `TodoItem` содержит следующий элемент:

        [Version]
        public string Version { get; set; }

Столбец `__version` также указан в локальной базе данных в методе `OnNavigatedTo()`.

Для обработки конфликтов автономной синхронизации в коде создайте класс, реализующий интерфейс `IMobileServiceSyncHandler`. Передайте объект этого типа в вызов метода `InitializeAsync`:

     await App.MobileService.SyncContext.InitializeAsync(store, new SyncHandler(App.MobileService));

Класс `SyncHandler` в файле **MainPage.xaml.cs** реализует `IMobileServiceSyncHandler`. Метод `ExecuteTableOperationAsync` вызывается при каждой передаче операции принудительной отправки на сервер. Если возникает исключение типа `MobileServicePreconditionFailedException`, это значит, что возник конфликт между локальной и удаленной версиями элемента.

Для разрешения конфликта в пользу локального элемента следует просто повторить операцию. После возникновения конфликта локальная версия элемента будет обновлена в соответствии с версией на сервере, поэтому повторное выполнение операции приведет к замене изменений на сервере на локальные изменения:

    await operation.ExecuteAsync(); 

Чтобы разрешить конфликт в пользу серверного элемента, просто выйдите из метода `ExecuteTableOperationAsync`. Локальная версия объекта будет удалена и заменена значением с сервера.

Чтобы остановить операцию принудительной отправки (но сохранить изменения в очереди), используйте метод `AbortPush()`:

    operation.AbortPush();

При этом текущая операция принудительной отправки будет остановлена, но все ожидающие изменения будут сохранены, в том числе текущая операция, если метод `AbortPush` вызывается из `ExecuteTableOperationAsync`. При следующем вызове `PushAsync()` эти изменения будут отправлены на сервер.

При отмене операции принудительной отправки метод `PushAsync` вызовет исключение `MobileServicePushFailedException`, а свойство исключения `PushResult.Status` будет иметь значение `MobileServicePushStatus.CancelledByOperation`.




<!-- Images -->
[0]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/mobile-services-handling-conflicts-app-run1.png
[1]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/mobile-services-todowithdate-empty.png
[2]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/mobile-services-todowithdate-empty-sql.png
[3]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/mobile-services-todowithdate-push1.png
[5]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/vs-emulator-wvga.png
[6]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/two-emulators-synced.png
[7]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/two-emulators-date-change.png
[8]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/two-emulators-conflict-detected.png
[9]: ./media/mobile-services-windows-phone-handling-conflicts-offline-data/two-emulators-item-completed.png



<!-- URLs -->
[примера кода обработки конфликтов]: http://go.microsoft.com/fwlink/?LinkId=398257
[примере кода обработки конфликтов]: http://go.microsoft.com/fwlink/?LinkId=398257
[Get started with Mobile Services]: ../mobile-services-windows-phone-get-started.md
[Приступая к работе с автономными данными]: mobile-services-windows-phone-get-started-offline-data.md
[портал управления Azure]: https://manage.windowsazure.com/
[пакет Windows Phone 8 SDK]: http://go.microsoft.com/fwlink/p/?linkid=268374
[решение SQLite для Windows Phone 8]: http://go.microsoft.com/fwlink/?LinkId=397953
[Get started with data]: mobile-services-windows-phone-get-started-data.md
 

<!---HONumber=August15_HO8-->