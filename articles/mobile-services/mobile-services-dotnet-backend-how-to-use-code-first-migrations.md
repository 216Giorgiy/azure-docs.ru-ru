<properties 
	pageTitle="Изменение модели данных в серверной мобильной службе для .NET" 
	description="В этом разделе описываются инициализаторы модели данных и изменение модели данных в мобильной службы серверной части .NET." 
	services="mobile-services" 
	documentationCenter="" 
	authors="ggailey777" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="mobile-services" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="NA" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.date="06/04/2015" 
	ms.author="glenga"/>

# Изменение модели данных в серверной мобильной службе для .NET

В этом разделе показано, как использовать Entity Framework Code First Migrations для изменения модели данных существующей базы данных SQL Azure, чтобы избежать потери существующих данных. В этой процедуре предполагается, что вы уже опубликовали проект мобильной службы в Azure, в базе данных уже есть данные и удаленная и локальная модели данных по-прежнему синхронизированы. В этом разделе также описываются первые инициализаторы Code First, внедренные мобильными службами Azure, которые используются при разработке. Эти инициализаторы позволяют легко выполнять изменения схемы без использования Code First Migrations, когда не нужно поддерживать существующие данные.

>[AZURE.NOTE]Имя схемы, которое используется как префикс для имен таблиц в Базе данных SQL, определяется параметром приложения MS\_MobileServiceName в файле web.config. После загрузки начального проекта с портала этому значению уже задано имя мобильной службы. Когда имя схемы соответствует мобильной службе, несколько мобильных служб могут безопасно использовать один и тот же экземпляр базы данных.

## Обновление модели данных

По мере того, как вы добавляете функции к серверной мобильной службе .NET, вы добавляете новые контроллеры для предоставления новых конечных точек в своем API. Вы создаете новый API как особый контроллер или как контроллер таблицы. [TableController<TEntity>] предоставляет тип данных, который наследует от [EntityData]. Чтобы включить сохранение данных в базе данных, этот тип данных также необходимо добавить к модели данных как новый [DbSet<T>] в [DbContext]. Подробнее о Code First на платформе Entity Framework см. в разделе [Создание модели с Code First](https://msdn.microsoft.com/data/ee712907#codefirst).

Visual Studio позволяет легко создать новый контроллер таблицы для предоставления нового типа данных для клиентских приложений. Дополнительную информацию см. в разделе [Использование контроллеров для доступа к данным в мобильных службах](https://msdn.microsoft.com/library/windows/apps/xaml/dn614132.aspx).

## Инициализаторы модели данных

Мобильные службы обеспечивают два базовых класса инициализаторов модели данных в проекте серверной мобильной службы для .NET. Эти инициализаторы удаляют и воссоздают таблицы в базе данных, когда Entity Framework определяет изменение модели данных в [DbContext]. Эти инициализаторы спроектированы для работы и при запуске мобильной службы на локальном компьютере, и при ее размещении в Azure.

>[AZURE.NOTE]При публикации мобильной службы серверной части .NET инициализатор не выполняется, пока не происходит операция доступа к данным. Это означает, что у недавно опубликованной службы используемые для хранения таблицы данных не создаются до тех пор, пока клиент не запросит операцию доступа к данным, например запрос.
>
>Операцию доступа к данным также можно выполнить с помощью встроенных функций справки API, доступ к которым можно получить по ссылке **Попробуйте** на начальной странице. Дополнительные сведения об использовании страниц API для тестирования мобильной службы см. в разделе "Локальное тестирование проекта мобильной службы" статьи [Добавление мобильных служб к существующему приложению](mobile-services-dotnet-backend-windows-universal-dotnet-get-started-data.md#test-the-service-locally).

Оба инициализатора удаляют из базы данных все таблицы, представления, функции и процедуры в схеме, используемой мобильной службой.

+ **ClearDatabaseSchemaIfModelChanges** <br/> Объекты схемы удаляются, только если Code First обнаружит изменения в модели данных. Инициализатор по умолчанию в проекте серверной части .NET, скачанном с [портала управления Azure], наследует от этого базового класса.
 
+ **ClearDatabaseSchemaAlways**. <br/> Объекты схемы удаляются при каждом обращении к модели данных. Используйте этот базовый класс, чтобы сбрасывать базу данных без необходимости изменять модель данных.

В скачанном проекте быстрого запуска инициализатор Code First определен в файле WebApiConfig.cs. Переопределите метод **Seed**, чтобы добавить исходные строки данных в новые таблицы. Примеры заполнения данных см. в разделе [Заполнение данных при миграции]. При запуске на локальном компьютере вы можете использовать другие инициализаторы модели данных Code First. Однако в Azure инициализаторы, которые пытаются удалить базу данных, породят сбой, так как у пользователя нет разрешений удалять базу данных, и это хорошо.

Вы можете продолжить использовать инициализаторы во время локальной разработки проекта мобильной службы. В учебнике по серверной части .NET предполагается, что вы используете инициализаторы. Однако в ситуациях, когда необходимо изменить модель данных и сохранить существующие данные в базе данных, необходимо использовать Code First Migrations.

>[AZURE.IMPORTANT]Во время разработки и тестирования проекта мобильной службы с действующими службами Azure следует всегда использовать экземпляр мобильной службы, предназначенный для тестирования. Никогда не используйте для разработки и тестирования мобильную службу, которая работает в производственной среде или используется клиентскими приложениями.

## <a name="migrations"></a>Включение Code First Migrations

Компонент Code First Migrations использует метод создания моментальных снимков для формирования кода, во время выполнения которого изменения схемы записываются в базу данных. С помощью Code First Migrations вы можете вносить добавочные изменения в модель данных и сохранить при этом существующие данные в базе данных.

>[AZURE.NOTE]Если проект серверной мобильной службы для .NET уже опубликован в Azure и схема таблицы базы данных SQL не соответствует текущей модели данных проекта, то необходимо с помощью инициализатора удалить таблицы вручную или иным образом синхронизировать схему и модель данных, прежде чем пытаться опубликовать его с помощью Code First Migrations.

Следующие действия включают Code First Migrations и применяют изменения модели данных в проекте, локальной базе данных и в Azure.

1. В обозревателе решений в Visual Studio щелкните правой кнопкой мыши проект мобильной службы и выберите **Назначить запускаемым проектом**.
 
2. В меню **Инструменты** разверните **Диспетчер пакетов NuGet**, затем щелкните **Консоль диспетчера пакетов**.

	Откроется консоль диспетчера пакетов, с помощью которой вы будете управлять Code First Migrations.

3. В консоли диспетчера пакетов выполните следующую команду:

		PM> Enable-Migrations

	При этом компонент Code First Migrations будет включен для вашего проекта.

4. В консоли выполните следующую команду:

		PM> Add-Migration Initial

	Будет создана новая миграция с именем *Initial*. Код миграции хранится в папке Migrations проекта.

5. Разверните папку App\_Start, откройте файл проекта WebApiConfig.cs и добавьте следующие инструкции **using**:

		using System.Data.Entity.Migrations;
		using todolistService.Migrations;

	В приведенном выше коде необходимо заменить строку _todolistService_ пространством имен вашего проекта. Для загруженного примера проекта это <em>mobile&95;service&95;name</em>Service.
 
6. В этом же файле кода закомментируйте вызов метода **Database.SetInitializer** и добавьте после него следующий код:

        var migrator = new DbMigrator(new Configuration());
        migrator.Update();

	При этом инициализатор базы данных Code First по умолчанию, который удаляет и повторно создает базу данных, будет отключен и заменен на явный запрос на применение последней миграции. На этом этапе все изменения модели данных приведут к появлению исключения InvalidOperationException при обращении к данным, если для них не была создана миграция. Забегая вперед скажем, что служба должна использовать Code First Migrations для миграции изменений модели данных в базу данных.

7.  Нажмите клавишу F5, чтобы запустить проект мобильной службы на локальном компьютере.
 
	В этот момент база данных синхронизирована с моделью данных. Если вы указали начальные значения данных, их можно проверить, щелкнув **Try it out**, **GET tables/todoitem**, затем **Try this out** и **Send**. Дополнительные сведения см. в разделе [Заполнение данных при миграции].

8.   Теперь внесите изменение в модель данных, например добавьте новое свойство UserId в тип TodoItem, повторите сборку проекта и в диспетчере пакетов выполните следующую команду:

		PM> Add-Migration NewUserId
                                                               
	Будет создана новая миграция с именем *NewUserId*. В папку Migrations добавляется новый файл кода, который реализует данное изменение.

9.  Нажмите клавишу F5 еще раз, чтобы перезапустить проект мобильной службы на локальном компьютере.

	Миграция применяется к базе данных, после чего она снова синхронизируется с моделью данных. Если вы указали начальные значения данных, их можно проверить, щелкнув **Try it out**, **GET tables/todoitem**, затем **Try this out** и **Send**. Дополнительные сведения см. в разделе [Заполнение данных при миграции].

10. Повторно опубликуйте мобильную службу в Azure, а затем запустите клиентское приложение, чтобы получить доступ к данным и убедиться, что данные загружаются без ошибок.

13. (Необязательно). На [портале управления Azure] выберите свою мобильную службу, откройте вкладку **Настройка** и щелкните ссылку **База данных SQL**.

	![][0]

	При этом откроется страница базы данных SQL для базы данных вашей мобильной службы.

14. (Необязательно). Щелкните **Управление**, войдите на свой сервер базы данных SQL, а затем нажмите кнопку **Проектирование** и убедитесь, что изменения схемы внесены в Azure.

    ![][1]


##<a name="seeding"></a>Заполнение данных при миграции

Компонент Migrations может добавить начальные данные в базу данных при выполнении миграции. Класс **Configuration** содержит метод **Seed**, который можно переопределить для вставки или обновления данных. При включении компонента Migrations файл кода Configuration.cs добавляется в папку Migrations. В этих примерах показано, как переопределить метод [Seed], чтобы заполнить данными таблицу **TodoItems**. Метод [Seed] вызывается после перехода на последнюю версию.

###Заполнение новой таблицы

Следующий код заполняет таблицу **TodoItems** новыми строками данных:

        List<TodoItem> todoItems = new List<TodoItem>
        {
            new TodoItem { Id = "1", Text = "First item", Complete = false },
            new TodoItem { Id = "2", Text = "Second item", Complete = false },
        };

        foreach (TodoItem todoItem in todoItems)
        {
            context.Set<TodoItem>().Add(todoItem);
        }
        base.Seed(context);

###Заполнение нового столбца в таблице

Следующий код заполняет только столбец UserId:
 		    
        context.TodoItems.AddOrUpdate(
            t => t.UserId,
                new TodoItem { UserId = 1 },
                new TodoItem { UserId = 1 },
                new TodoItem { UserId = 2 }
            );
        base.Seed(context);

Этот код вызывает вспомогательный метод расширения [AddOrUpdate] для заполнения данными нового столбца UserId. При использовании [AddOrUpdate] повторяющиеся строки не создаются.

<!-- Anchors -->
[Migrations]: #migrations
[Заполнение данных при миграции]: #seeding

<!-- Images -->
[0]: ./media/mobile-services-dotnet-backend-how-to-use-code-first-migrations/navagate-to-sql-database.png
[1]: ./media/mobile-services-dotnet-backend-how-to-use-code-first-migrations/manage-sql-database.png
[2]: ./media/mobile-services-dotnet-backend-how-to-use-code-first-migrations/sql-database-drop-tables.png

<!-- URLs -->
[DropCreateDatabaseIfModelChanges]: http://msdn.microsoft.com/library/gg679604(v=vs.113).aspx
[Seed]: http://msdn.microsoft.com/library/hh829453(v=vs.113).aspx
[портала управления Azure]: https://manage.windowsazure.com/
[портале управления Azure]: https://manage.windowsazure.com/
[DbContext]: http://msdn.microsoft.com/library/system.data.entity.dbcontext(v=vs.113).aspx
[AddOrUpdate]: http://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx
[TableController<TEntity>]: https://msdn.microsoft.com/library/azure/dn643359.aspx
[EntityData]: https://msdn.microsoft.com/library/azure/microsoft.windowsazure.mobile.service.entitydata.aspx
[DbSet<T>]: https://msdn.microsoft.com/library/azure/gg696460.aspx
 

<!---HONumber=August15_HO6-->