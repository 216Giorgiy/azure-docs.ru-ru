<properties 
	pageTitle="Добавление мобильных служб в существующее приложение (HTML 5) | Microsoft Azure" 
	description="Узнайте, как приступить к работе с мобильными службами в существующем приложении HTML." 
	services="mobile-services" 
	documentationCenter="" 
	authors="ggailey777" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="mobile-services" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile-html" 
	ms.devlang="javascript" 
	ms.topic="article" 
	ms.date="05/02/2015" 
	ms.author="glenga"/>

# Добавление мобильных служб к существующему приложению

[AZURE.INCLUDE [mobile-services-selector-get-started-data](../../includes/mobile-services-selector-get-started-data.md)]

##Обзор 

В этом разделе показано, как с помощью мобильных служб Azure эффективно использовать данные в приложении на HTML. В этом учебнике вам предстоит скачать приложение, которое хранит данные в памяти, создать мобильную службу, интегрировать ее с приложением, а затем войти на портал управления Azure для просмотра изменений, внесенных в данные при выполнении приложения.

>[AZURE.NOTE]Этот учебник поможет вам лучше понять, как с помощью мобильных служб можно использовать Azure для хранения и извлечения данных из приложения на HTML. В этом разделе рассматриваются многие действия, которые выполняются в кратком руководстве по использованию мобильных служб. Если это ваш первый опыт работы с мобильными службами, сначала ознакомьтесь с учебником [Приступая к работе с мобильными службами].

> [AZURE.IMPORTANT]Для работы с этим учебником требуется учетная запись Azure. Если ее нет, можно создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в разделе [Бесплатная пробная версия Azure](http://azure.microsoft.com/pricing/free-trial/?WT.mc_id=A756A2826&amp;returnurl=http%3A%2F%2Fazure.microsoft.com%2documentation%2Farticles%2Fmobile-services-html-get-started-data).

###Дополнительные требования

Приложение GetStartedWithData можно разместить на любом веб-сервере. Тем не менее для удобства представлены сценарии, которые позволяют запускать приложение по адресу `http://localhost:8000`.
 
+ Чтобы использовать localhost, в этом учебнике требуется наличие одного из следующих веб-серверов, запущенных на локальном компьютере:

	+  **В Windows**: IIS Express. IIS Express устанавливается [установщиком веб-платформы Майкрософт].   
	+  **В MacOS X**: Python, который уже должен быть установлен.
	+  **В Linux**: Python. Необходимо установить [последнюю версию Python]. 
	
	Можно использовать любой веб-сервер для размещения приложения, однако ниже приведены веб-серверы, которые поддерживаются доступными для загрузки сценариями.

+ Браузер, который поддерживает HTML5.

##<a name="download-app"></a>Скачивание проекта GetStartedWithData

Этот учебник основан на [HTML5-приложении GetStartedWithData]. Пользовательский интерфейс для этого приложения совпадает с интерфейсом приложения, созданного в кратком руководстве по использованию мобильных служб. Отличие заключается в том, что добавленные элементы хранятся локально в памяти.

1. [Загрузите файлы проекта HTML-приложения][GetStartedWithData app].

2. В редакторе HTML откройте скачанный проект и просмотрите файл app.js.

   	Обратите внимание, что элементы хранятся в памяти в объекте **Array** (**staticItems**). Обновите страницу, после чего данные исчезнут. Они не сохраняются.

3. Запустите один из следующих командных файлов во вложенной папке **server**.

	+ **launch-windows** (компьютеры с ОС Windows) 
	+ **launch-mac.command** (компьютеры с ОС Mac OS X)
	+ **launch-linux.sh** (компьютеры с ОС Linux)

	> [AZURE.NOTE]На компьютере под управлением Windows нажмите клавишу `R`, когда в PowerShell появится запрос на запуск сценария. Веб-браузер может предупредить о том, что не следует запускать этот сценарий, так как он был загружен из Интернета. В этом случае необходимо указать, что браузеру следует продолжить загрузку скрипта.
	
	Это приведет к запуску веб-сервера на локальном компьютере, где и будет размещено новое приложение.

4. Откройте URL-адрес <a href="http://localhost:8000/" target="_blank">http://localhost:8000/</a> в веб-браузере, чтобы запустить приложение.

5. В приложении в поле _Введите новую задачу_ введите осмысленный текст, например **Завершение работы с учебником**, и нажмите кнопку **Добавить**.

   	![][0]

   	Обратите внимание, что сохраненный текст добавляется в массив **staticItems**, а страница обновляется для отображения нового элемента.

##<a name="create-service"></a>Создание мобильной службы на портале управления

[AZURE.INCLUDE [mobile-services-create-new-service-data](../../includes/mobile-services-create-new-service-data.md)]

##<a name="add-table"></a>Добавление новой таблицы в мобильную службу

Чтобы иметь возможность сохранять данные приложения в новой мобильной службе, необходимо сначала создать новую таблицу в соответствующем экземпляре базы данных SQL.

1. В портале управления нажмите **Мобильные службы**, затем нажмите только что созданную мобильную службу.

2. Нажмите вкладку **Данные**, а затем нажмите **+Создать**.

   	Откроется диалоговое окно **Создание новой таблицы**.

3. В поле **Имя таблицы** введите _TodoItem_ и нажмите кнопку проверки.

  	Это создает новую таблицу хранения данных **TodoItem** с установленными по умолчанию разрешениями. Это означает, что любой пользователь, имеющий ключ приложения, который входит в состав приложения, имеет доступ и может изменять данные в таблице. Таблица создается в схеме, которая относится к этой мобильной службе. Это необходимо для предотвращения конфликтов данных, когда несколько мобильных служб используют одну и ту же базу данных.

4. Нажмите новую таблицу **TodoItem** и убедитесь, что нет ни одной строки данных.

	>[AZURE.NOTE]Новые таблицы создаются со столбцами "Id", "\_\_createdAt", "\_\_updatedAt" и "\_\_version". Если динамическая схема включена, мобильные службы автоматически создают новые столбцы на основе JSON-объекта в запросе вставки или обновления. Дополнительные сведения см. в разделе [Динамическая схема](http://msdn.microsoft.com/library/windowsazure/jj193175.aspx).

6. На вкладке **Настройка** убедитесь, что элемент `localhost` уже указан в списке **Разрешить запросы от имен узлов** в разделе **Общий доступ к ресурсам независимо от источника (CORS)**. Если этот элемент не указан, введите `localhost` в поле **Имя узла** и нажмите кнопку **Сохранить**.


	> [AZURE.IMPORTANT]Если развернуть приложение быстрого запуска на веб-сервере, отличном от localhost, необходимо добавить имя узла веб-сервера в список **Разрешить запросы имен узлов**. Дополнительную информацию см. в разделе [Общий доступ к ресурсам независимо от источника](http://msdn.microsoft.com/library/windowsazure/dn155871.aspx"%20target="_blank).

Теперь вы готовы использовать новую мобильную службу как хранилище данных для приложения.

##<a name="update-app"></a>Обновление приложения для доступа к данным с помощью мобильной службы

После настройки мобильной службы вы можете обновить приложение, чтобы хранить элементы в мобильных службах, а не в локальной коллекции.

3. На портале управления щелкните **Мобильные службы** и выберите только что созданную мобильную службу.

4. Щелкните вкладку **Панель мониторинга** и запишите **URL-адрес** сайта, а затем щелкните **Управление ключами** и запишите значение параметра **Ключ приложения**.

  	Эти значения потребуются при обращении к мобильной службе из кода приложения.

1. В редакторе веб-страниц откройте файл проекта index.html и добавьте следующую строку в ссылки сценария для страницы:

        <script src="http://ajax.aspnetcdn.com/ajax/mobileservices/MobileServices.Web-1.2.5.min.js"></script>

5. В редакторе откройте файл app.js, раскомментируйте следующий код, который определяет переменную **MobileServiceClient**, и укажите URL-адрес и ключ приложения мобильной службы в конструкторе **MobileServiceClient** в указанном порядке:

	    var MobileServiceClient = WindowsAzure.MobileServiceClient,
			client = new MobileServiceClient('AppUrl', 'AppKey'),   		    

  	Код создает экземпляр MobileServiceClient, используемый для доступа к мобильной службе.

6. Закомментируйте следующие строки кода:

		var itemCount = 0;
		var staticItems = [];

	Данные будут храниться в мобильной службе, а не в массиве в памяти.

6. Раскомментируйте следующую строку кода:

        todoItemTable = client.getTable('todoitem');

   	Этот код создает прокси-объект (**todoItemTable**) для базы данных SQL **TodoItem**.

7. Замените обработчик событий **$('#add-item').submit** следующим кодом:

		$('#add-item').submit(function(evt) {
			var textbox = $('#new-item-text'),
				itemText = textbox.val();
			if (itemText !== '') {
				todoItemTable.insert({ text: itemText, complete: false })
					.then(refreshTodoItems);
			}
			textbox.val('').focus();
			evt.preventDefault();
		});


  	Этот код вставляет новый элемент в таблицу.

8. Замените метод **refreshTodoItems** следующим кодом:

		function refreshTodoItems() {

			var query = todoItemTable;

			query.read().then(function(todoItems) {
				listItems = $.map(todoItems, function(item) {
					return $('<li>')
						.attr('data-todoitem-id', item.id)
						.append($('<button class="item-delete">Delete</button>'))
						.append($('<input type="checkbox" class="item-complete">').prop('checked', item.complete))
						.append($('<div>').append($('<input class="item-text">').val(item.text)));
				});
					   
				$('#todo-items').empty().append(listItems).toggle(listItems.length > 0);
				$('#summary').html('<strong>' + todoItems.length + '</strong> item(s)');
			});
		}
	   

   Этот код отправляет запрос мобильной службе, который возвращает все элементы. Выполняется итерация по результатам, а данные отображаются на странице.

9. Замените обработчики событий **$(document.body).on('change', '.item-text')** и **$(document.body).on('change', '.item-complete')** следующим кодом:
        
		$(document.body).on('change', '.item-text', function() {
			var newText = $(this).val();
			todoItemTable.update({ id: getTodoItemId(this), text: newText });
		});

		$(document.body).on('change', '.item-complete', function() {
			var isComplete = $(this).prop('checked');
			todoItemTable.update({ id: getTodoItemId(this), complete: isComplete })
				.then(refreshTodoItems);
		});
 
   	Этот код отправляет обновление элемента мобильной службе при изменении текста или установке флажка.

10. Замените обработчик событий **$(document.body).on('click', '.item-delete')** следующим кодом:

		$(document.body).on('click', '.item-delete', function () {
			todoItemTable.del({ id: getTodoItemId(this) }).then(refreshTodoItems);
		});

	Этот код отправляет мобильной службе запрос на удаление службы при нажатии кнопки **Delete**.

Теперь, когда приложение обновлено для хранения данных на сервере с использованием мобильных служб, настало время протестировать приложение на работу с мобильными службами.

##<a name="test-app"></a>Тестирование работы приложения с новой мобильной службой

4. Повторно откройте URL-адрес <a href="http://localhost:8000/" target="_blank">http://localhost:8000/</a> в браузере, чтобы запустить приложение.

    > [AZURE.NOTE]Если требуется перезапустить веб-сервера, повторите действия, описанные в первом разделе.

2. Как и ранее, введите текст в поле **Введите новую задачу** и нажмите кнопку **Добавить**.

   	В результате в мобильную службу будет отправлен новый элемент в качестве вставки.

3. На [Портале управления] щелкните **Мобильные службы**, затем щелкните свою мобильную службу.

4. Откройте вкладку **Данные**, а затем щелкните **Обзор**.
  
   	Обратите внимание, что таблица **TodoItem** теперь содержит данные со значениями идентификаторов, которые созданы мобильными службами, и в таблицу были автоматически добавлены столбцы, соответствующие классу TodoItem в приложении.

5. В приложении отметьте один из элементов списка, а затем вернитесь на вкладку "Обзор" на портале и нажмите кнопку **Обновить**

  	Обратите внимание, что значение выполнения изменилось с **false** на **true**.

6. Найдите в файле проекта app.js метод **RefreshTodoItems** и замените строку кода, которая определяет `query`, такой строкой:

   		var query = todoItemTable.where({ complete: false });

7. Снова загрузите страницу и проверьте другой элемент в списке.

   	Обратите внимание, что отмеченный элемент теперь исчез из списка. Каждое обновление ведет к обмену данными с мобильной службой, которая теперь будет возвращать отфильтрованные данные.

Это заключительный шаг учебника **Приступая к работе с данными**.

## <a name="next-steps"> </a>Дальнейшие действия

В этом учебнике показаны основы включения в HTML-приложении возможностей работы с данными в мобильных службах. Вы также узнаете, как проверять подлинность пользователей приложения, изучив один из следующих учебников и [статью о добавлении проверки подлинности в приложение]. Если вы работаете с проектом приложения Cordova или PhoneGap, дополнительные сведения о push-уведомлениях можно найти в [статье о push-уведомлениях в службе Microsoft Azure](https://msdn.microsoft.com/magazine/dn879353.aspx).

<!-- Anchors. -->
[Download the HTML app project]: #download-app
[Create the mobile service]: #create-service
[Add a data table for storage]: #add-table
[Update the app to use Mobile Services]: #update-app
[Test the app against Mobile Services]: #test-app
[Next Steps]: #next-steps

<!-- Images. -->
[0]: ./media/mobile-services-html-get-started-data/mobile-quickstart-startup-html.png

<!-- URLs. -->
[Приступая к работе с мобильными службами]: mobile-services-html-get-started.md
[статью о добавлении проверки подлинности в приложение]: mobile-services-html-get-started-users.md

[Azure Management Portal]: https://manage.windowsazure.com/
[Портале управления]: https://manage.windowsazure.com/
[GetStartedWithData app]: http://go.microsoft.com/fwlink/?LinkID=286345
[HTML5-приложении GetStartedWithData]: http://go.microsoft.com/fwlink/?LinkID=286345

[Mobile Services HTML/JavaScript How-to Conceptual Reference]: mobile-services-html-how-to-use-client-library.md

[Cross-origin resource sharing]: http://msdn.microsoft.com/library/azure/dn155871.aspx

 

<!---HONumber=August15_HO7-->