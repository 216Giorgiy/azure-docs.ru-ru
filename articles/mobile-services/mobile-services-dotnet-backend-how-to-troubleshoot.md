<properties
	pageTitle="Устранение неполадок серверной части .NET мобильных служб | Microsoft Azure"
	description="Узнайте, как определить и устранить проблемы в работе мобильных служб, использующих серверную часть .NET"
	services="mobile-services"
	documentationCenter=""
	authors="wesmc7777"
	manager="dwrede"
	editor="mollybos"/>

<tags
	ms.service="mobile-services"
	ms.workload="mobile"
	ms.tgt_pltfrm="multiple"
	ms.devlang="multiple"
	ms.topic="article"
	ms.date="02/07/2016" 
	ms.author="wesmc;ricksal"/>

# Устранение неполадок серверной части .NET мобильных служб

[AZURE.INCLUDE [mobile-service-note-mobile-apps](../../includes/mobile-services-note-mobile-apps.md)]

&nbsp;


Разработка с использованием мобильных служб обычно выполняется легко и беспроблемно, но иногда что-нибудь может пойти не так. В этом учебнике рассматриваются некоторые методы, позволяющие устранять распространенные проблемы, которые могут возникать в серверной части .NET мобильных служб.

1. [Отладка HTTP](#HttpDebugging)
2. [Отладка в среде выполнения](#RuntimeDebugging)
3. [Анализ журналов диагностики](#Logs)
4. [Отладка разрешения облачной сборки](#AssemblyResolution)
5. [Устранение неполадок миграций Entity Framework](#EFMigrations)

<a name="HttpDebugging"></a>
## Отладка HTTP

При разработке приложений с использованием мобильных служб обычно используется преимущество пакета SDK клиента мобильных служб для соответствующей платформы (Магазин Windows, iOS, Android и т. п.). Однако иногда полезно перейти вниз на уровень HTTP и понаблюдать за необработанными вызовами, как они выполняются в сети. В частности, такой подход используется при отладке проблем с подключением и сериализацией. В серверной части .NET мобильных служб можно объединять этот подход с локальной и удаленной отладкой Visual Studio (подробности в следующем разделе), чтобы получить полное представление о том, какой путь проделывает HTTP-вызов, прежде чем вызвать код вашей службы.

Для отправки и проверки HTTP-трафика можно использовать любой отладчик HTTP. В этих целях разработчики часто используют популярный инструмент [Fiddler](http://www.telerik.com/fiddler). Чтобы облегчить работу разработчиков, мобильные службы предоставляют веб-отладчик HTTP (также называемый "тестовым клиентом") вместе с мобильной службой, что снижает потребность во внешних инструментах. Когда мобильная служба размещается локально, она будет доступна по URI, подобному [http://localhost:59233](http://localhost:59233), а при размещении в облаке URI будет иметь вид [http://todo-list.azure-mobile.net](http://todo-list.azure-mobile.net). Следующие шаги работают одинаково независимо от того, где размещена служба.

1. Начните с серверного проекта мобильных служб, открыв его в **Visual Studio 2013 с обновлением 2** или последующих версий. Если у вас нет подходящего проекта, его можно создать, последовательно выбрав в меню пункты **Файл**, **Создать**, **Проект**, затем выбрав узел **Облако** и указав шаблон **Мобильные службы Microsoft Azure**.
2. Нажмите клавишу **F5**, чтобы построить и запустить проект. На начальной странице нажмите ссылку **try it out** (испытать).

    >[AZURE.NOTE]
    Если служба размещена локально, выбор этой ссылки направит вас на следующую страницу. Однако при размещении в облаке будет предложено указать учетные данные. Это гарантирует, что пользователи, не прошедшие проверку подлинности, не получат доступ к сведениям об API и к полезным данным. Чтобы увидеть эту страницу, необходимо выполнить вход с **пустым именем пользователя** и **ключом приложения** в качестве пароля. Ключ приложения можно найти на классическом портале Azure: перейдите на вкладку **Панель мониторинга** для соответствующей мобильной службы и выберите пункт **Управление ключами**.
    >
    > ![Запрос проверки подлинности для доступа к странице справки][HelpPageAuth]

3. На открывшейся странице (которая также называется "страница справки") отображается список всех API HTTP, которые делает доступными ваша мобильная служба. Выберите один из API (если вы начали с использования шаблона проекта мобильных служб в Visual Studio, то должны видеть **GET tables/TodoItem** (Получить таблицы/TodoItem).)

    ![Страница справки][HelpPage]

4. Полученная страница показывает всю документацию и примеры JSON запроса и ответа, которые ожидает API. Нажмите кнопку **try this out** (испытать это).

    ![Тестовая страница для API][HelpPageApi]

5. Это тестовый клиент, позволяющий отправлять HTTP-запрос, чтобы испытать API. Нажмите **отправить**.

    ![Тестовый клиент][TestClient]

6. Появится HTTP-ответ, вернувшийся от мобильной службы непосредственно в окно браузера.

    ![Тестовый клиент с HTTP-ответом][TestClientResponse]

Теперь вы готовы для исследования других API HTTP, предоставляемых мобильной службой для удобства использования веб-браузера.

<a name="RuntimeDebugging"></a>
## Отладка во время выполнения

Одной из важнейших особенностей серверной части .NET является не только возможность локальной отладки кода службы, но также отладки кода, работающего в текущий момент в облачной среде. Выполните следующие действия.

1. Откройте проект мобильной службы, который требуется отладить, в **Visual Studio 2013 с обновлением 2** или последующих версий.
2. Настройте загрузку символов. Перейдите в меню **Отладка** и выберите пункт **Параметры и настройки**. Убедитесь, что флажок **Включить только мой код** снят, а флажок **Включить поддержку исходного сервера** установлен.

    ![Настройка загрузки символов][SymbolLoading]

3. Выберите узел **Символы** слева и добавьте ссылку на сервер [SymbolSource], используя универсальный код ресурса (URI) [http://srv.symbolsource.org/pdb/Public](http://srv.symbolsource.org/pdb/Public). Символы для серверной части .NET мобильных служб становятся доступными здесь с каждым новым выпуском.

    ![Настройка сервера символов][SymbolServer]

4. Установите точку останова в части кода, которую планируется отлаживать. Например, установите точку останова в методе **GetAllTodoItems()** контроллера **TodoItemController**, который предусмотрен в шаблоне проекта мобильных служб в Visual Studio.
5. Выполните локальную отладку службы, нажав клавишу **F5**. Первая загрузка может выполняться медленно, поскольку Visual Studio загружает символы для серверной части .NET мобильных служб.
6. Как описывалось в предыдущем разделе, посвященном отладке HTTP, с помощью тестового клиента отправьте HTTP-запрос в метод, в котором была установлена точка останова. Например, можно отправить запрос в метод **GetAllTodoItems()**, нажав **GET tables/TodoItem** (Получить таблицы/TodoItem) на странице справки, нажав ссылку **try this out** (испытать), а затем нажав кнопку **отправить**.
7. Visual Studio должен остановиться в заданной точке останова, и в окне **Стек вызовов** Visual Studio должна быть доступна полная трассировка стека с исходным кодом.

    ![Попадание в точку останова][Breakpoint]

8. Теперь можно опубликовать службу в Azure, и можно будет использовать отладку в точности так, как это делалось выше. Опубликуйте проект, щелкнув его правой кнопкой мыши в **обозревателе решений** и выбрав пункт **Опубликовать**.
9. На вкладке **Параметры** мастера публикации выберите конфигурацию для **отладки**. Это обеспечит публикацию соответствующих символов отладки наряду с кодом.

    ![Публикация отладки][PublishDebug]

10. После успешной публикации службы откройте **обозреватель сервера** и разверните узлы **Azure** и **Мобильные службы**. При необходимости выполните вход.
11. Щелкните правой кнопкой мыши только что опубликованную мобильную службу и выберите пункт **Подключить отладчик**.

    ![Подключение отладчика][AttachDebugger]

12. Отправьте HTTP-запрос для вызова метода, в котором установлена точка останова, как это делалось в шаге 6. На этот раз используйте страницу справки и протестируйте клиент в отношении мобильной службы, размещенной в Azure.
13. Visual Studio остановится в точке останова.

Теперь вы можете использовать все возможности отладчика Visual Studio при локальной разработке и для действующей мобильной службы в Azure.

<a name="Logs"></a>
## Анализ журналов диагностики

При обработке запросов от клиентов мобильная служба создает много полезных сведений для диагностики, а также записывает все возникшие исключения. Помимо этого можно реализовать код контроллера с дополнительными журналами, используя преимущества свойства [**Log**](http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.apiservices.log.aspx), доступного в свойстве [**Services**](http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.tables.tablecontroller.services.aspx) каждого [**TableController**](http://msdn.microsoft.com/library/microsoft.windowsazure.mobile.service.tables.tablecontroller.aspx).

При локальной отладке журналы будут отображаться в окне **вывода** Visual Studio.

![Журналы в окне вывода Visual Studio][LogsOutputWindow]

После публикации службы в Azure доступ к журналам для экземпляра службы, работающего в облаке, можно получить, щелкнув эту мобильную службу правой кнопкой мыши в **обозревателе серверов** Visual Studio и выбрав пункт **Просмотр журналов**.

![Журналы в обозревателе серверов Visual Studio][LogsServerExplorer]

Эти же журналы доступны на классическом портале Azure на вкладке **Журналы** для соответствующей мобильной службы.

![Журналы на классическом портале Azure][LogsPortal]

<a name="AssemblyResolution"></a>
## Отладка разрешения облачной сборки

При публикации мобильной службы в Azure она загружается средой внешнего размещения мобильных служб, что гарантирует беспрепятственные обновления и исправления в конвейере HTTP, размещающем код контроллера. Сюда входят все сборки, на которые имеются ссылки в [пакетах NuGet серверной части .NET](http://www.nuget.org/packages?q=%22mobile+services+.net+backend%22): группа постоянно обновляет службу, чтобы она использовала последние версии этих сборок.

Иногда можно спровоцировать конфликты версий, ссылаясь на *другие основные номера версий* необходимых сборок (другие *дополнительные номера* версий разрешены). Часто это происходит, когда NuGet предлагает выполнить обновление до последней версии одного из пакетов, используемых серверной частью .NET мобильных служб.

>[AZURE.NOTE] На данный момент мобильные службы совместимы только с ASP.NET 5.1; ASP.NET 5.2 в настоящее время не поддерживается. Обновление пакетов ASP.NET NuGet до 5.2.* может привести к ошибке после развертывания.

Если выполнить обновление такого пакета, то при публикации обновленной службы в Azure появится страница с предупреждением, указывающим на конфликт.

![Страница справки, указывающая на конфликт загрузки сборки][HelpConflict]

Это сопровождается записью в журналы службы сообщения об исключении, подобного следующему:

    Found conflicts between different versions of the same dependent assembly 'Microsoft.ServiceBus': 2.2.0.0, 2.3.0.0. Please change your project to use version '2.2.0.0' which is the one currently supported by the hosting environment.

Эту проблему можно легко исправить — просто вернитесь к поддерживаемой версии необходимой сборки и заново опубликуйте службу.

<a name="EFMigrations"></a>
## Устранение неполадок миграций Entity Framework

При использовании серверной части .NET мобильных служб с базой данных SQL в качестве технологии доступа к данным, позволяющей запрашивать базу данных и сохранять в ней объекты, применяется Entity Framework (EF). Одним важным аспектом, который обрабатывается EF от имени разработчика, является то, как изменяются столбцы базы данных (также называемые *схемой*) при изменении классов модели, заданных в коде. Этот процесс называется [Code First Migrations](http://msdn.microsoft.com/data/jj591621).

Миграции могут быть сложными, и для их успешного выполнения может требоваться сохранение состояния базы данных в синхронизации с моделью EF. Сведения об обработке миграций с помощью мобильной службы и о возможных ошибках см. в статье [Внесение изменений в модель данных в мобильной службе серверной части .NET](mobile-services-dotnet-backend-how-to-use-code-first-migrations.md).

<!-- IMAGES -->

[HelpPageAuth]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/6.png
[HelpPage]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/7.png
[HelpPageApi]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/8.png
[TestClient]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/9.png
[TestClientResponse]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/10.png
[SymbolLoading]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/1.png
[SymbolServer]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/2.png
[Breakpoint]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/3.png
[PublishDebug]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/4.png
[AttachDebugger]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/5.png
[LogsOutputWindow]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/11.png
[LogsServerExplorer]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/12.png
[LogsPortal]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/13.png
[HelpConflict]: ./media/mobile-services-dotnet-backend-how-to-troubleshoot/14.png


<!-- Links -->
[SymbolSource]: http://symbolsource.org

<!---HONumber=AcomDC_0211_2016-->