<properties
	pageTitle="Использование автономных данных в мобильных службах (Xamarin для Android) | Microsoft Azure"
	description="Узнайте, как использовать мобильные службы Azure для кэширования и синхронизации автономных данных в приложении на Xamarin для Android"
	documentationCenter="xamarin"
	authors="lindydonna"
	editor="wesmc"
	manager="dwrede"
	services="mobile-services"/>

<tags
	ms.service="mobile-services"
	ms.workload="mobile"
	ms.tgt_pltfrm="mobile-xamarin-android"
	ms.devlang="dotnet"
	ms.topic="article"
	ms.date="09/25/2015"
	ms.author="donnam"/>

# Использование автономной синхронизации данных в мобильных службах

[AZURE.INCLUDE [mobile-services-selector-offline](../../includes/mobile-services-selector-offline.md)]

В этом разделе рассматривается возможности автономной синхронизации мобильных служб Azure в приложении быстрого запуска для списка дел. Автономная синхронизация позволяет легко создавать приложения, которые можно использовать даже в случае отсутствия у пользователя доступа к сети.

Автономная синхронизация может применяться в следующих случаях:

* Повышение скорости реагирования приложений путем локального кэширования данных сервера в устройстве
* Защита приложений от потери сетевой связности
* Предоставление конечным пользователям возможности создания и изменения данных даже в том случае, когда отсутствует сетевой доступ, поддерживая сценарии с минимальной связностью или при отсутствии связности
* Синхронизация данных между несколькими устройствами и обнаружение конфликтов, когда два устройства изменяют одну и ту же запись

>[AZURE.NOTE]Для работы с этим учебником требуется учетная запись Azure. Если у вас нет учетной записи, можно зарегистрироваться для получения бесплатной пробной версии Azure и получить до 10 бесплатных мобильных служб, которые можно использовать и после окончания пробного периода. Дополнительные сведения см. в разделе <a href="http://www.windowsazure.com/pricing/free-trial/?WT.mc_id=AE564AB28" target="_blank">Бесплатная пробная версия Azure</a>.
>
> Если это ваш первый опыт работы с мобильными службами, сначала ознакомьтесь с учебником [Приступая к работе с мобильными службами].

В этом учебнике рассматриваются следующие основные действия:

1. [Обзор кода синхронизации мобильных служб]
2. [Обновление режима синхронизации приложения]
3. [Обновление приложения для повторного подключения мобильной службы]

Для работы с данным учебником требуется следующее:

* Visual Studio с [расширением Xamarin] **или** [Xamarin Studio]
* Выполнение заданий учебника [Приступая к работе с мобильными службами]

## <a name="review-offline"></a>Обзор кода синхронизации мобильных служб

Мобильные службы Azure с автономной синхронизацией позволяет конечным пользователям взаимодействовать с локальной базой данных в случае, когда сеть недоступна. Для использования этих возможностей в приложении необходимо инициализировать `MobileServiceClient.SyncContext` в локальном хранилище. Затем ссылаетесь на таблицу с помощью интерфейса `IMobileServiceSyncTable`. В этом разделе рассматривается связанный код автономной синхронизации в `ToDoActivity.cs`.

1. Откройте в Visual Studio или Xamarin Studio проект, созданный в ходе работы с учебником [Приступая к работе с мобильными службами]. Откройте файл `ToDoActivity.cs`.

2. Обратите внимание, что этот член `toDoTable` имеет тип `IMobileServiceSyncTable`. Автономная синхронизация использует этот интерфейс таблицы синхронизации вместо `IMobileServiceTable`. При использовании таблицы синхронизации все операции направляются в локальное хранилище и синхронизируются с удаленной службой только по явным операциям принудительной отправки и принудительного получения.

    Для получения ссылки на таблицу синхронизации используется метод `GetSyncTable()`. Чтобы удалить функцию автономной синхронизации, можно использовать `GetTable()`.

3. Прежде чем можно будет выполнить операции с таблицами, необходимо инициализировать локальное хранилище. Это делается с помощью метода `InitLocalStoreAsync`.

        private async Task InitLocalStoreAsync()
        {
            // new code to initialize the SQLite store
            string path = Path.Combine(System.Environment.GetFolderPath(System.Environment.SpecialFolder.Personal), localDbFilename);

            if (!File.Exists(path))
            {
                File.Create(path).Dispose();
            }

            var store = new MobileServiceSQLiteStore(path);
            store.DefineTable<ToDoItem>();

            // Uses the default conflict handler, which fails on conflict
            await client.SyncContext.InitializeAsync(store);
        }

    При этом создается локальное хранилище с использованием класса `MobileServiceSQLiteStore`, предоставляемого в пакете SDK для мобильных служб. Можно также предоставить другую реализацию локального хранилища, внедрив `IMobileServiceLocalStore`.

    Метод `DefineTable` создает в локальном хранилище таблицу, соответствующую полям в указанном типе, в данном случае это `ToDoItem`. Тип необязательно должен включать в себя все столбцы, которые находятся в удаленной базе данных, так как можно хранить и подмножество столбцов.

    Эта перегрузка `InitializeAsync` использует обработчик конфликтов по умолчанию, который завершается с ошибкой всякий раз, когда возникает конфликт. Сведения о том, как предоставить пользовательский обработчик конфликтов, см. в учебнике [Обработка конфликтов с автономной поддержкой мобильных служб].

4. Метод `SyncAsync` запускает операцию фактической синхронизации:

        private async Task SyncAsync()
        {
            await client.SyncContext.PushAsync();
            await toDoTable.PullAsync("allTodoItems", toDoTable.CreateQuery()); // query ID is used for incremental sync
        }

    Во-первых, это вызов `IMobileServiceSyncContext.PushAsync()`. Этот метод является членом `IMobileServicesSyncContext` вместо таблицы синхронизации, поскольку он будет передавать изменения во все таблицы. Только те записи, которые были каким-либо образом локально изменены (с помощью операций CUD), будут отправлены на сервер.

    Затем метод вызывает `IMobileServiceSyncTable.PullAsync()` для извлечения данных из таблицы на сервере в приложение. Обратите внимание, что если в контексте синхронизации имеются ожидающие изменения, то операция принудительного получения всегда предварительно выполняет операцию принудительной отправки. Это позволяет обеспечить согласованность всех таблиц в локальном хранилище, а также связей между ними. В этом случае мы вызвали операцию принудительной отправки явным образом.

    В этом примере мы получаем все записи из удаленной таблицы `TodoItem`, однако их можно также отфильтровать путем передачи запроса. Первым параметром для `PullAsync()` является идентификатор запроса, используемый для добавочной синхронизации, в рамках которой используется метка времени `UpdatedAt`, чтобы получить только записи, измененные с момента последней синхронизации. Идентификатор запроса должен быть описательной строкой, уникальной для каждого логического запроса в приложении. Чтобы явно отказаться от добавочной синхронизации, передайте `null` в качестве идентификатора запроса. В этом случае команда получает все записи по каждой операции принудительного извлечения, которая потенциально неэффективна.

    >[AZURE.NOTE]Чтобы удалить записи из локального хранилища устройства, если они удалены из базы данных мобильной службы, вам следует включить [обратимое удаление]. В противном случае приложение должно периодически вызывать `IMobileServiceSyncTable.PurgeAsync()` для очистки локального хранилища.

    Обратите внимание, что `MobileServicePushFailedException` может возникать как при операциях принудительной передачи, так и при операциях принудительного извлечения. В следующем учебнике [Обработка конфликтов с автономной поддержкой мобильных служб] показано, как обрабатывать такие исключения, связанные с синхронизацией.

5. В классе `ToDoActivity` метод `SyncAsync()` вызывается после операций, которые изменяют данные, а именно `AddItem()` и `CheckItem()`. Он также вызывается из `OnRefreshItemsSelected()`, поэтому пользователи получают последние данные при каждом нажатии кнопки **Обновить**. Приложение также выполняет синхронизацию при запуске, так как `ToDoActivity.OnCreate()` вызывает `OnRefreshItemsSelected()`.

    `SyncAsync()` вызывается при каждом изменении данных, поэтому это приложение предполагает, что пользователь находится в сети каждый раз, когда вносит изменения в данные. В следующем разделе мы обновим приложение, чтобы пользователи могли изменять данные, даже работая в автономном режиме.

## <a name="update-sync"></a>Обновление режима синхронизации приложения

В этом разделе вы измените приложение, чтобы оно не синхронизировалось при запуске или операциях вставки и изменения и синхронизировалось только при нажатии кнопки обновления. Затем вы разорвете связь приложения с мобильной службой для имитации автономного сценария. При добавлении элементов данных они будут находиться в локальном хранилище, но не будут синхронизированы с мобильной службой немедленно.

1. Измените методы `AddItem()` и `CheckItem()` в классе `ToDoActivity`, чтобы закомментировать вызовы `SyncAsync()`.

2. В `ToDoActivity` закомментируйте определения членов `applicationURL` и `applicationKey`. Добавьте следующие строки, которые ссылаются на недопустимый URL-адрес мобильной службы:

        const string applicationURL = @"https://your-mobile-service.azure-mobile.xxx/";
        const string applicationKey = @"AppKey";

3. В `ToDoActivity.OnCreate()` удалите вызов `OnRefreshItemsSelected()` и замените его следующим:

        // Load the items from the Mobile Service
        // OnRefreshItemsSelected (); // don't sync on app launch
        await RefreshItemsFromTableAsync(); // load UI only

4. Выполните сборку и запустите приложение. Добавьте несколько новых элементов списка дел. Эти новые элементы списка дел существует только в локальном хранилище, пока не будут принудительно переданы в мобильную службу. Клиентское приложение ведет себя так, как если бы оно было подключено к мобильной службе, поддерживающей все операции создания, чтения, обновления и удаления (CRUD).

5. Закройте приложение и перезапустите его, чтобы убедиться, что новые элементы сохранены в локальном хранилище.

## <a name="update-online-app"></a>Обновление приложения для повторного подключения мобильной службы

В этом разделе приложение будет повторно подключено к мобильной службе. Эта процедура имитирует переход приложения из автономного состояния в оперативное состояние с мобильной службой. При нажатии кнопки **Обновить** данные будут синхронизированы с вашей мобильной службой.

1. Откройте `ToDoActivity.cs`. Удалите недопустимый URL-адрес мобильной службы и верните правильный URL-адрес и ключ приложения.

2. Повторно выполните сборку и запустите приложение. Обратите внимание, что данные выглядят так же, как в автономном сценарии, хотя приложение теперь подключено к мобильной службе. Это вызвано тем, что данное приложение всегда использует объект `IMobileServiceSyncTable`, который указывает на локальное хранилище.

3. Войдите на портал управления Microsoft Azure и посмотрите на базу данных мобильной службы. Если служба использует серверную часть JavaScript, вы можете просмотреть данные на вкладке **Данные** мобильной службы.

    Если вы используете серверную часть .NET для мобильной службы, в Visual Studio выполните команду **Обозреватель сервера** -> **Azure** -> **Базы данных SQL**. Щелкните правой кнопкой мыши базу данных и выберите пункт **Открыть в обозревателе объектов SQL Server**.

    Обратите внимание, что данные *не* синхронизированы между базой данных и локальным хранилищем.

4. В приложении нажмите кнопку обновления. Это вызывает `OnRefreshItemsSelected()`, который в свою очередь вызывает `SyncAsync()`. Это приведет к выполнению операций принудительного получения и принудительной отправки — сначала локальные элементы хранения отправляются в мобильную службу, а затем из мобильной службы извлекаются новые данные.

5. Проверьте базу данных для своей мобильной службы, чтобы убедиться, что изменения были синхронизированы.

##Сводка

[AZURE.INCLUDE [mobile-services-offline-summary-csharp](../../includes/mobile-services-offline-summary-csharp.md)]

## Дальнейшие действия

* [Обработка конфликтов с автономной поддержкой мобильных служб]

* [Использование клиентского компонента Xamarin для мобильных служб Azure]

<!-- Anchors. -->
[Обзор кода синхронизации мобильных служб]: #review-offline
[Обновление режима синхронизации приложения]: #update-sync
[Обновление приложения для повторного подключения мобильной службы]: #update-online-app

<!-- Images -->


<!-- URLs. -->
[Обработка конфликтов с автономной поддержкой мобильных служб]: mobile-services-windows-store-dotnet-handling-conflicts-offline-data.md
[Приступая к работе с мобильными службами]: mobile-services-android-get-started.md
[Использование клиентского компонента Xamarin для мобильных служб Azure]: partner-xamarin-mobile-services-how-to-use-client-library.md
[обратимое удаление]: mobile-services-using-soft-delete.md

[Mobile Services SDK Nuget]: http://www.nuget.org/packages/WindowsAzure.MobileServices/1.3.0
[SQLite store nuget]: http://www.nuget.org/packages/WindowsAzure.MobileServices.SQLiteStore/1.0.0
[Xamarin Studio]: http://xamarin.com/download
[расширением Xamarin]: http://xamarin.com/visual-studio
[NuGet Addin for Xamarin]: https://github.com/mrward/monodevelop-nuget-addin
 

<!---HONumber=Oct15_HO2-->