<properties pageTitle="Get Started with the Azure WebJobs SDK" metaKeywords="Azure tutorial, Azure WebJobs tutorial, Azure multi-tier tutorial, MVC tutorial, Azure blobs tutorial, Azure queues tutorial, Azure storage tutorial" description="Learn how to create a multi-tier app using ASP.NET MVC and Azure. The frontend runs in a website, and the backend runs as a WebJob. The app uses Entity Framework, SQL Database, and Azure storage queues and blobs." metaCanonical="" services="web-sites,storage" documentationCenter=".NET" title="Get Started with the Azure WebJobs SDK" authors="tdykstra" solutions="" manager="wpickett" editor="mollybos" />

# Начало работы с пакетом SDK веб-заданий Azure

В этом учебнике представлен пакет SDK веб-заданий и показано, как создать многоуровневое приложение ASP.NET MVC, которое использует пакет SDK веб-заданий на [веб-сайте Azure][веб-сайте Azure]. Приложение использует [базу данных Azure SQL][базу данных Azure SQL], [службу BLOB-объектов Azure][службу BLOB-объектов Azure] и [службу очередей Azure][службу очередей Azure].

Пример приложения представляет собой рекламную доску объявлений. Пользователи создают рекламу, вводя текст и загружая изображения. Они могут видеть список рекламы по эскизам изображений, и они могут видеть изображения в полном размере, когда выбирают рекламу для просмотра деталей. Ниже приведен снимок экрана:

![Список рекламы][Список рекламы]

Можно [загрузить проект Visual Studio][загрузить проект Visual Studio] из галереи кода MSDN.

## Оглавление

Учебник включает в себя следующие разделы:

-   [Предварительные требования][Предварительные требования]
-   [Содержание обучения][Содержание обучения]
-   [Пакет SDK веб-заданий][Пакет SDK веб-заданий]
-   [Архитектура приложения][Архитектура приложения]
-   [Настройка среды разработки][Настройка среды разработки]
-   [Создание, запуск и развертывание приложения][Создание, запуск и развертывание приложения]
-   [Создание приложения с самого начала][Создание приложения с самого начала]
-   [Просмотр кода приложения][Просмотр кода приложения]
-   [Устранение неполадок][Устранение неполадок]
-   [Дальнейшие действия][Дальнейшие действия]

## <span id="prerequisites"></span></a>Предварительные требования

В учебнике предполагается, что вы знаете, как работать с проектами [ASP.NET MVC][ASP.NET MVC] или [веб-форм][веб-форм] в Visual Studio. Пример приложения использует MVC, но многое в руководство также применимо к веб-формам.

Инструкции руководства применимы со следующими продуктами:

-   Visual Studio 2013
-   Visual Studio 2013 Express для Web

Если у вас нет одного из них, Visual Studio 2013 Express для Web установится автоматически, когда будет установлен Azure SDK.

[WACOM.INCLUDE [free-trial-note](../includes/free-trial-note.md)]

## <span id="learn"></span></a>Содержание обучения

В учебнике показано, как выполнять следующие задачи.

-   Подготовка компьютера к разработке для Azure путем установки пакета Azure SDK.
-   Создание проекта приложения консоли, который автоматически развертывается как веб-задание Azure при развертывании связанного веб-проекта.
-   Локальное тестирование внутреннего сервера SDK веб-заданий на компьютере разработки.
-   Публикация приложения с помощью внутреннего сервера веб-заданий на веб-сайте Azure.
-   Отправка файлов и сохранение их в службе больших двоичных объектов Azure.
-   Использование пакета SDK веб-заданий Azure для работы с очередями и большими двоичными объектами хранилища Azure.

## <span id="webjobssdk"></span></a>Общие сведения о пакете SDK веб-заданий

[Веб-задания][Веб-задания] — это функция веб-сайтов Azure, которая позволяет запускать программу или скрипт в том же контексте, что и веб-сайт. Вам не нужно использовать пакет SDK веб-заданий, чтобы запустить программу как веб-задание. Цель пакета SDK веб-заданий — упростить задачу написания кода, который работает с очередями, большими двоичными объектами и таблицами хранилища Azure и очередями служебной шины.

Пакет SDK веб-заданий содержит следующие компоненты.

-   **Пакеты NuGet**. Пакеты NuGet, которые вы добавляете в проект Visual Studio, предоставляют платформу, которую код использует для работы со службой хранилища Azure или очередями служебной шины.
-   **Панель мониторинга**. Часть пакета SDK веб-заданий включена в веб-сайты Azure и предоставляет обширные возможности мониторинга и диагностики для программ, которые вы пишете с помощью пакетов NuGet. Чтобы использовать эти функции мониторинга и диагностики, не нужно писать код.

Можно запустить программу, которая использует пакеты NuGet SDK веб-заданий где угодно; ее не нужно запускать как веб-задание Azure. Однако панель мониторинга доступна только как расширение сайта для веб-сайта Azure. Например, вы можете запустить программу, которая использует пакет SDK веб-заданий локально, на компьютере разработки или в рабочей роли облачной службы Azure. После этого вы не сможете получить сведения о мониторинге, настроив панель мониторинга SDK веб-заданий веб-сайта Azure для использования той же учетной записи хранения, которую использует ваша программа SDK веб-заданий.

Во время написания этого учебника пакет SDK веб-заданий доступен в виде бета-выпуска. Он не поддерживается для использования в рабочей среде.

### Стандартные сценарии

Ниже представлены стандартные сценарии, которые можно проще обработать с помощью пакета SDK веб-заданий Azure:

-   Обработка изображений или другая нагружающая ЦП задача. Стандартной функцией веб-сайтов является возможность отправлять изображения или видео. Часто требуется изменить контент после его отправки, но вы не хотите, чтобы пользователь при этом ждал.
-   Обработка очередей. Обычно для взаимодействия внешнего сервера с внутренним используются очереди. Когда веб-сайту требуется выполнить задание, он отправляет сообщение в очередь. Служба внутреннего сервера извлекает сообщения из очереди и выполняет задание. Например, можно использовать очереди с обработкой изображений: после отправки нескольких файлов пользователем поместите имена файлов в сообщение очереди, чтобы внутренний сервер мог выбрать их для обработки. Также можно использовать очереди для ускорения отклика сайта. Например, вместо записи непосредственно в базу данных SQL выполните запись в очередь, сообщите пользователю о готовности и позвольте службе внутреннего сервера обработать задание реляционной базы данных с высокой задержкой.
-   Объединение RSS-каналов. Если ваш сайт обрабатывает список RSS-каналов, можно получить все статьи из веб-каналов в фоновом процессе.
-   Обработка файлов, например, объединение или очистка файлов журнала. Файлы журнала могут быть созданы несколькими сайтами или в течение отдельных интервалов времени, которые следует совместить для запуска в них заданий анализа. Также можно запланировать еженедельную задачу для очистки старых файлов журнала.
-   Другие долгосрочные задачи, которые вы хотите запустить в фоновом потоке, например, отправка электронной почты.

Чтобы предотвратить переход веб-сайта в спящий режим после периода неактивности, который прервет долгосрочную фоновую задачу, можно использовать функцию [AlwaysOn][AlwaysOn] веб-сайтов Azure.

### Примеры кода

Код для обработки стандартных задач, которые работают с хранилищем Azure, прост. В приложении консоли запишите методы для фоновых задач, которые следует выполнить, и добавьте в них атрибуты из пакета SDK веб-заданий. Метод `Main` создает объект `JobHost`, который координирует вызовы записываемых методов. Платформа SDK веб-заданий знает, когда следует вызывать используемые методы на основе атрибутов пакета SDK веб-заданий. Например:

        static void Main()
        {
            JobHost host = new JobHost();
            host.RunAndBlock();
        }

        public static void ProcessQueueMessage([QueueTrigger("webjobsqueue")] string inputText, 
            [Blob("containername/blobname")]TextWriter writer)
        {
            writer.WriteLine(inputText);
        }

Объект `JobHost` является контейнером для набора фоновых функций. Объект `JobHost` отслеживает функции, просматривает события, которые активируют их и выполняет функции при возникновении событий активации. Метод `JobHost` вызывается, чтобы указать, следует ли запускать обработку контейнера в текущем потоке или в фоновом потоке. В этом примере метод `RunAndBlock` запускает постоянную обработку в текущем потоке.

Поскольку метод `ProcessQueueMessage` в этом примере имеет атрибут `QueueTrigger`, триггер для этой функции — получение нового сообщения очереди. Объект `JobHost` ищет новые сообщения очереди в указанной очереди ("webjobsqueue" в этом примере) и при нахождении вызывает `ProcessQueueMessage`. Атрибут `QueueTrigger` также уведомляет платформу о привязке параметра `inputText` к значению сообщения очереди:

<pre class="prettyprint">
public static void ProcessQueueMessage([QueueTrigger(&quot;webjobsqueue&quot;)]] string inputText, 
    [Blob(&quot;containername/blobname&quot;)]TextWriter writer)
</pre>

Платформа также привязывает объект `TextWriter` к большому двоичному объекту с именем "blobname" в контейнере с именем "containername":

<pre class="prettyprint">
public static void ProcessQueueMessage([QueueTrigger(&quot;webjobsqueue&quot;)]] string inputText, 
    [Blob(&quot;containername/blobname&quot;)]TextWriter writer)
</pre>

Затем функция использует эти параметры для записи значения сообщения очереди в большой двоичный объект:

        writer.WriteLine(inputText);

Как можно видеть, функции триггера и модуля привязки пакета SDK веб-заданий значительно упрощают код, который нужно записывать для работы с объектами хранилища Azure. Код низкого уровня, необходимый для обработки очередей и больших двоичных объектов, создается платформой пакета SDK веб-заданий — платформа создает очереди, которые еще не существуют, открывает очередь, читает сообщения очереди, удаляет сообщения очереди по завершении обработки, создает контейнеры больших двоичных объектов, которые еще не существуют, выполняет запись в большие двоичные объекты и т. д.

Пакет SDK веб-заданий предоставляет множество способов работы с хранилищем Azure. Например, если параметр с добавленным атрибутом `QueueTrigger` является массивом байтов или пользовательским типом, выполняется его автоматическая десериализация из JSON. Атрибут `BlobTrigger` можно также использовать для активации обработки при создании нового большого двоичного объекта в учетной записи службы хранилища Azure. (Обратите внимание, что в то время как `QueueTrigger` ищет новые сообщения очереди в течение нескольких секунд, для `BlobTrigger` может потребоваться до 20 минут, чтобы обнаружить новый большой двоичный объект. `BlobTrigger` сканирует большие двоичные объекты при каждом запуске `JobHost`, а затем периодически проверяет журналы хранилища Azure для поиска новых больших двоичных объектов.)

## <span id="contosoads"></span></a>Архитектура приложения

Пример приложения использует [рабочий шаблон на основе очередей][службу очередей Azure] для разгрузки процессора от задач создания эскизов для обработки внутреннего сервера

Приложение хранит рекламу в базе данных SQL, используя Entity Framework Code First для создания таблиц и доступа к данным. Для каждой части рекламы база данных хранит два URL-адреса: один для полноразмерного изображения, другой для эскиза.

![Таблица рекламы][Таблица рекламы]

Когда пользователь отправляет изображение, веб-сайт на внешнем сервере сохраняет его в [большой двоичный объект Azure][службу BLOB-объектов Azure], а информацию о рекламе — в базе данных с URL-адресом, который указывает на большой двоичный объект. В это же время оно записывает сообщение в очередь Azure. Обработка внутреннего сервера, запущенная как веб-задание Azure, использует пакет SDK веб-заданий, чтобы опросить очередь на предмет новых сообщений. Когда появляется новое сообщение, веб-задание создает эскиз для изображения и обновляет поле базы данных с URL-адресом эскиза для этой рекламы. Вот диаграмма, которая показывает, как взаимодействуют части приложения:

![Архитектура Contoso Ads][Архитектура Contoso Ads]

### Альтернативная архитектура

Веб-задания запускаются в контексте веб-сайта и не масштабируются отдельно. Например, если у вас есть один экземпляр веб-сайта Standard, вы можете запустить только 1 экземпляр внутренней обработки, и он будет использовать некоторые ресурсы сервера (ЦП, память и т. д.), которые в противном случае были бы доступны для обработки веб-содержимого.

Если трафик зависит от времени дня или дня недели и если необходимую обработку внутреннего сервера можно запустить позже, запланируйте запуск веб-заданий на период, когда трафик мало используется. Если загрузка для этого решения все еще слишком высока, можно рассмотреть другие среды для программы внутреннего сервера, например, следующие.

-   Запуск программы как веб-задания на отдельном веб-сайте, предназначенном для этого. После этого можно масштабировать веб-сайт внутреннего сервера отдельно от веб-сайта внешнего сервера.
-   Запустите программу в рабочей роли облачной службы Azure. При выборе этого параметра можно запустить внешний сервер в веб-роли облачной службы или на веб-сайте.

В этом учебнике показано, как запустить внешний сервер на веб-сайте и внутренний сервер как веб-задание на одном веб-сайте. Сведения о том, как выбрать оптимальную среду для вашего сценария см. в разделе [Сравнение веб-сайтов, облачных служб и виртуальных машин Azure][Сравнение веб-сайтов, облачных служб и виртуальных машин Azure].

[WACOM.INCLUDE [установка-sdk-2013-только](../includes/install-sdk-2013-only.md)]

## <span id="storage"></span></a>Создайте учетную запись хранения Azure

Учетная запись хранилища Azure обеспечивает ресурсы для хранения данных очередей и больших двоичных объектов в облаке. Она также используется пакетом SDK веб-заданий для хранения данных журналов для панели мониторинга.

В реальном приложении обычно создают отдельные учетные записи для данных приложения и данных журналов, а также отдельные учетные записи для тестовых данных и рабочих данных. В этом учебнике будет использоваться одна запись.

1.  На [портале управления Azure][портале управления Azure] щелкните кнопку **Создать** — **Службы данных** — **Хранилище** — **Быстрое создание**.

2.  В поле ввода **URL-адреса** введите префикс URL-адреса.

    Этот префикс в сочетании с текстом, который отображается под полем, будет уникальным URL-адресом для вашей учетной записи хранения. Если указанный префикс уже используется, выберите другой префикс.

    На рисунке в конце раздела показано создание учетной записи хранилища с URL-адресом `contosoads.core.windows.net`.

3.  В раскрывающемся списке **Регион** укажите ближайший к вам регион.

    Этот параметр указывает, в каком центре обработки данных Azure будет размещаться учетная запись хранения. При работе с учебником это не окажет существенного влияния, но для рабочего сайта веб-сервер и учетная запись хранения должны находиться в одном регионе, чтобы минимизировать задержку и стоимость исходящих данных. Веб-сайт (который будет создан позже) должен находиться как можно ближе к браузерам, получившим доступ к сайту, чтобы максимально уменьшить задержку.

4.  В раскрывающемся списке **Репликация** установите значение **Локально избыточное**.

    При включении георепликации для учетной записи хранения хранящиеся данные реплицируются в дополнительный центр обработки данных для обеспечения возможности отработки отказа в это расположение в случае крупной аварии в основном расположении. Георепликация может потребовать дополнительных затрат. Для учетных записей тестирования и разработки оплачивать георепликацию обычно не требуется. Дополнительные сведения см. в разделе [Управление учетными записями хранения][Управление учетными записями хранения].

5.  Щелкните **Создать учетную запись хранения**.

    ![Новая учетная запись хранения][Новая учетная запись хранения]

## <span id="download"></span></a>Скачивание приложения

1.  Загрузите и распакуйте [готовое решение][загрузить проект Visual Studio].

2.  Запустите Visual Studio.

3.  В меню **Файл** нажмите кнопку **Открыть** \> **Проект/решение**, перейдите к скачанному решению и откройте файл решения.

4.  Чтобы построить решение, нажмите CTRL+SHIFT+B.

    По умолчанию Visual Studio автоматически запускает содержимое пакета NuGet, которое не включено в файл *.zip* Если пакеты не восстановлены, установите их вручную, перейдя к диалогу **Управление пакетами для NuGet решения** и нажав кнопку **Восстановить** вверху справа.

5.  В **обозревателе решений** убедитесь, что в качестве запускаемого проекта выбран **ContosoAdsWeb**.

## <span id="configurestorage"></span></a>Настройка приложения для использования учетной записи хранения

1.  Откройте файл приложения *Web.config* в проекте ContosoAdsWeb.

    Файл содержит строку подключения SQL и строку подключения хранилища Azure для работы с большими двоичными объектами и очередями.

    Строка подключения SQL указывает на базу данных [SQL Server Express LocalDB][SQL Server Express LocalDB].

    Строка подключения хранилища содержит заполнители, вместо которых нужно вставить имя учетной записи хранения и ключ доступа в следующих шагах.

    ``` prettyprint
    <connectionStrings>
      <add name="ContosoAdsContext" connectionString="Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;" providerName="System.Data.SqlClient" />
      <add name="AzureWebJobsStorage" connectionString="DefaultEndpointsProtocol=https;AccountName=[accountname];AccountKey=[accesskey]"/>
    </connectionStrings>
    ```

    Строка подключения хранилища называется AzureWebJobsStorage, поскольку пакет SDK веб-заданий использует это имя по умолчанию. Здесь используется то же имя, поэтому вам нужно задать только одно значение строки подключения в среде Azure.

2.  На [портале управления Azure][1] выберите свою учетную запись хранения и щелкните кнопку **Управление ключами доступа** в нижней части страницы.

    ![Кнопка "Управление ключами доступа"][Кнопка "Управление ключами доступа"]

    ![Диалоговое окно "Управление ключами доступа"][Диалоговое окно "Управление ключами доступа"]

3.  Замените *[accountname]* в строке подключения на значение в поле **Имя учетной записи хранения**.

4.  Замените *[accesskey]* в строке подключения на значение в поле **Первичный ключ доступа**.

5.  Откройте файл *App.config* в проекте ContosoAdsWebJob.

    Этот файл содержит две строки подключения хранилища: одну для данных приложения, а другую для ведения журнала. В этом учебнике будет использоваться одна учетная запись. Строки подключения содержат те же заполнители, которые были указаны ранее.

  	<pre class="prettyprint">&lt;configuration&gt;
    &lt;connectionStrings&gt;
        &lt;add name="AzureWebJobsDashboard" connectionString="DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>"/&gt;
        &lt;add name="AzureWebJobsStorage" connectionString="DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>"/&gt;
        &lt;add name="ContosoAdsContext" connectionString="Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;"/&gt;
    &lt;/connectionStrings&gt;
        &lt;startup&gt; 
            &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.5" /&gt;
    &lt;/startup&gt;
&lt;/configuration&gt;</pre>

    По умолчанию пакет SDK веб-заданий ищет строки подключения с именем AzureWebJobsStorage и AzureWebJobsDashboard. В качестве альтернативы можно сохранить строку подключения любым способом и передать ее явно в объект `JobHost`.

6.  Замените все вхождения *[accountname]* и *[accesskey]* значениями для учетной записи хранения, как было сделано для веб-проекта. (Вы также можете скопировать заполненную строку подключения из файла *Web.config* в обе строки подключения файла *App.config*.)

7.  Сохраните изменения.

## <span id="run"></span></a> Локальный запуск приложения

1.  Чтобы запустить внешний сервер приложения, нажмите клавиши CTRL+F5.

    Откроется домашняя страница браузера по умолчанию. (Запускается веб-проект, поскольку он стал запускаемым проектом.)

    ![Домашняя страница Contoso Ads][Домашняя страница Contoso Ads]

2.  Чтобы запустить внутренний сервер веб-задания приложения, щелкните правой кнопкой мыши проект ContosoAdsWebJob в **обозревателе решений** и нажмите **Отладка** \> **Запустить новый экземпляр**.

    Откроется окно приложения консоли, где отобразится сообщение "Запущено задание размещения", указывающее, что оно выполняется.

    ![Окно приложения консоли, отображающее, что внутренний сервер запущен][Окно приложения консоли, отображающее, что внутренний сервер запущен]

3.  В браузере щелкните кнопку **Создать рекламу**.

4.  Введите тестовые данные, выберите изображение и нажмите кнопку **Create**.

    ![Страница создания][Страница создания]

    Приложение переходит к странице индексации, но не показывает эскиз для новой рекламы, поскольку индексирование еще не проводилось.

    В то же время после короткого ожидания в окне приложения консоли отобразится сообщение журнала, что сообщение очереди было получено и обработано.

    ![Окно приложения консоли, отображающее, что сообщение очереди обработано][Окно приложения консоли, отображающее, что сообщение очереди обработано]

5.  После того, как вы увидите сообщения журнала в окне приложения консоли, обновите страницу индексов, чтобы увидеть эскиз.

    ![Страница индексации][Список рекламы]

6.  Щелкните **Details**, чтобы увидеть рекламу в полный размер.

    ![Страница сведений][Страница сведений]

Вы запустили приложение на локальном компьютере, и оно использует базу данных SQL Server, расположенную на компьютере, но она работает с очередями и большими двоичными объектами в облаке. В следующем разделе вы запустите приложение в облаке с помощью облачной базы данных, а также облачных больших двоичных объектов и очередей.

## <span id="runincloud"></span></a>Запуск приложения в облаке

Чтобы запустить приложение в облаке, выполните следующие действия:

-   Развертывание на веб-сайте Azure. Visual Studio автоматически создаст новый веб-сайт Azure и экземпляр базы данных SQL.
-   Настройка веб-сайта для использования базы данных SQL Azure и учетной записи хранения.

После создания рекламы во время работы в облаке вы просмотрите панель мониторинга SDK веб-заданий, чтобы увидеть предлагаемые обширные функции мониторинга.

### Развертывание на веб-сайте Azure

1.  Закройте браузер и окно приложения консоли.

2.  В **обозревателе решений** щелкните правой кнопкой мыши проект ContosoAdsWeb и нажмите **Опубликовать**.

3.  В шаге **Профиль** мастера **веб-публикации** щелкните **Веб-сайты Microsoft Azure**.

    ![Целевой объект публикации выбора веб-сайта Azure][Целевой объект публикации выбора веб-сайта Azure]

4.  В поле **Выбор существующего веб-сайта** щелкните кнопку **Войти**.

    ![Щелкните "Войти"][Щелкните "Войти"]

5.  После того, как вы выполните вход, нажмите кнопку "Создать".

    ![Нажмите кнопку "Создать"][Нажмите кнопку "Создать"]

6.  В диалоговом окне **Создание сайта в Microsoft Azure** введите уникальное имя в поле **Имя сайта**.

    Полный URL-адрес будет состоять из того, что вы ввели, плюс .azurewebsites.net (как указано рядом с текстовым полем **Имя сайта**). Например, если имя сайта — ContosoAds, URL-адрес будет ContosoAds.azurewebsites.net.

7.  В раскрывающемся списке **Регион** выберите тот же регион, который выбрали для учетной записи хранения.

    Этот параметр указывает, в каком центре обработки данных Azure будет запущен веб-сайт. Хранение веб-сайта и учетной записи хранения в одном центре обработки данных минимизирует задержку и стоимость исходящих данных.

8.  В раскрывающемся списке **Сервер базы данных** нажмите кнопку **Создать сервер**.

    Если в подписке уже есть сервер, можно выбрать его в раскрывающемся списке.

9.  Введите **Имя пользователя базы данных** и **Пароль базы данных** администратора.

    Если выбрано действие **Создать сервер базы данных SQL**, не используйте здесь существующие имя и пароль, введите новые, которые в дальнейшем будут использоваться при обращении к базе данных. Если выбран созданный ранее сервер, появится запрос на ввод пароля для ранее созданной административной учетной записи.

10. Щелкните **Создать**.

    ![Диалоговое окно "Создание сайта в Microsoft Azure"][Диалоговое окно "Создание сайта в Microsoft Azure"]

    Visual Studio создает решение, веб-проект, веб-сайт Azure и экземпляр базы данных SQL Azure.

11. В шаге **Подключение** мастера **веб-публикации** нажмите кнопку **Далее**.

    ![Шаге "Подключение"][Шаге "Подключение"]

12. В шаге **Параметры** снимите флажок **Использовать эту строку подключения в среде выполнения** и нажмите кнопку **Далее**.

    ![Этап настроек][Этап настроек]

    Не нужно использовать диалоговое окно "Публикация", чтобы задать строку подключения SQL, поскольку это значение будет указано в среде Azure позже.

    Вы можете проигнорировать предупреждения на этой странице.

    -   Обычно учетная запись хранения, используемая при запуске Azure, отличается от той, которая используется при локальном запуске, но в этом учебнике для обеих сред используется одна учетная запись. Поэтому не требуется изменять строку подключения AzureWebJobsStorage. Даже если бы в облаке использовалась другая учетная запись хранения, строку подключения изменять не нужно, поскольку при запуске в Azure приложение будет использовать параметр среды Azure. Это будет показано позже в данном учебнике.

    -   В этом учебнике не будут вноситься изменения в модель данных, использованную для базы данных ContosoAdsContext, поэтому для развертывания не нужно использовать Entity Framework Code First Migrations. Code First автоматически создаст новую базу данных при первой попытке приложения получить доступ к данным SQL.

    Для этого учебника подойдут значения по умолчанию в разделе **Параметры публикации файлов**.

13. В шаге **Предварительный просмотр** нажмите кнопку **Начать предварительный просмотр**.

    ![Нажмите кнопку "Начать предварительный просмотр"][Нажмите кнопку "Начать предварительный просмотр"]

    Вы можете проигнорировать предупреждение об отсутствии баз данных для публикации. Entity Framework Code First создаст базу данных; ее не нужно публиковать.

    В окне "Предварительный просмотр" отобразится, что двоичные файлы и файлы конфигурации из проекта веб-задания будут скопированы в папку *app\_data\\jobs\\continuous* веб-сайта.

    ![Окно "Предварительный просмотр файлов веб-заданий"][Окно "Предварительный просмотр файлов веб-заданий"]

14. Щелкните **Опубликовать**.

    Visual Studio развертывает приложение и открывает URL-адрес домашней страницы в браузере.

    Вы не сможете использовать сайт, пока не зададите строки подключения в среде Azure в следующем разделе. Появится страница ошибки или домашняя страница в зависимости от выбранных ранее параметров создания сайта и базы данных.

### Настройка веб-сайта для использования базы данных SQL Azure и учетной записи хранения.

В целях безопасности рекомендуется [не указывать конфиденциальную информацию, такую как строки подключения, в файлах, которые хранятся в репозиториях исходного кода][не указывать конфиденциальную информацию, такую как строки подключения, в файлах, которые хранятся в репозиториях исходного кода]. Azure предоставляет следующую возможность: вы можете задать строку подключения и другие значения параметров в среде Azure, и API конфигурации ASP.NET автоматически выберут эти значения при запуске приложения в Azure. В этом разделе предстоит задать значения строк подключения в Azure.

1.  В браузере перейдите на портал управления Azure и выберите веб-сайт, на котором развернуто приложение Contoso Ads.

2.  Откройте вкладку **Настройка** и прокрутите вниз к разделу **Строки подключения**.

3.  Измените имя строки подключения DefaultConnection на ContosoAdsContext.

    Azure автоматически создала эту строку подключения, когда вы создали сайт со связанной базой данных, поэтому она автоматически содержит правильное значение строки подключения. Нужно только изменить имя на искомый код.

4.  Добавьте две новые строки подключения с именами AzureWebJobsStorage и AzureWebJobsDashboard. Задайте тип "Пользовательская" и укажите для строки подключения то же значение, которое использовалось ранее для файлов *Web.config* и *App.config*. (Убедитесь, что включили всю строку подключения без кавычек, а не только ключ доступа.)

    Эти строки подключения используются пакетом SDK веб-заданий: одна для данных приложения, а другая для ведения журнала. Как было показано ранее, строка подключения для данных приложения также используется кодом внешнего сервера.

5.  Щелкните **Сохранить**.

    ![Строки подключения на портале управления][Строки подключения на портале управления]

6.  Откройте вкладку **Панель мониторинга** и щелкните кнопку **Перезапустить**.

    Веб-задание запустится автоматически при публикации, но остановится при внесении изменений в конфигурацию. Чтобы перезапустить его, можно перезапустить сайт или веб-задание. Обычно рекомендуется перезапускать сайт после изменения конфигурации.

7.  Обновите окно браузера, которое содержит URL-адрес сайта в адресной строке.

    Появится домашняя страница.

8.  Создайте рекламу, как вы делали это при локальном запуске приложения.

    Сначала появится страница индексов без эскизов.

9.  Через несколько секунд обновите страницу, чтобы появился эскиз.

    Если эскиз не появляется, возможно, веб-задание не запустилось автоматически. В этом случае перейдите на вкладку "Веб-задания" в

### Просмотр панели мониторинга SDK веб-заданий

1.  На портале управления Azure выберите свой веб-сайт.

2.  Перейдите на вкладку **Веб-задания**.

3.  щелкните URL-адрес веб-задания в столбце "Журналы".

    ![Вкладка "Веб-задания"][Вкладка "Веб-задания"]
    На панели мониторинга "Пакет SDK веб-заданий" откроется новая вкладка браузера. На панели мониторинга отобразится, что веб-задание запущено, и появится список функций в коде, активированных пакетом SDK веб-заданий.

4.  Щелкните одну из функций, чтобы увидеть сведения о ее выполнении

    ![Панель мониторинга пакета SDK веб-заданий][Панель мониторинга пакета SDK веб-заданий]

    ![Панель мониторинга пакета SDK веб-заданий][2]

    Кнопка **Повторить функцию** на этой странице позволяет платформе SDK веб-заданий повторно вызывать функцию и дает возможность изменить данные, изначально переданные в функцию.

> [WACOM.NOTE] По завершении тестирования удалите веб-сайт и экземпляр базы данных SQL. Веб-сайт бесплатен, но за экземпляр базы данных SQL и учетную запись хранения взимается плата (минимальная из-за мелкого размера). Также если оставить сайт работающим, любой кто найдет этот URL-адрес, сможет создать и просмотреть рекламу. На портале управления Azure перейдите на вкладку **Панель мониторинга** для веб-сайта и нажмите кнопку **Удалить** внизу страницы. Затем можно установить флажок, чтобы удалить экземпляр базы данных SQL. Если необходимо временно предотвратить доступ посторонних к сайту, вместо этого щелкните **Остановить**. В этом случае плата за базы данных SQL и учетную запись хранения продолжит взиматься. Можно повторить эту же процедуру для удаления базы данных SQL и учетной записи хранилища, если они больше не нужны.

## <span id="create"></span></a>Создание приложения с нуля

В этом разделе предстоит выполнить следующие задачи:

-   Создание решения Visual Studio с веб-проектом.
-   Добавление проекта библиотеки класса для уровня доступа данных, который совместно используется внешним и внутренним сервером.
-   Добавление проекта приложения консоли для внутреннего сервера с включенным развертыванием веб-заданий.
-   Добавление пакетов NuGet.
-   Указание ссылок на проекты.
-   Копирование кода приложения и файлов конфигурации из скачанного приложения, с которым вы работали в предыдущем разделе учебника.
-   Просмотр фрагментов кода, которые работают с большими двоичными объектами и очередями Azure и пакетом SDK веб-заданий.

### Создание решения Visual Studio с веб-проектом и проектом библиотеки класса

1.  В Visual Studio нажмите кнопку **Создать** \> **Проект** в меню **Файл**.

2.  В диалоговом окне **Новый проект** щелкните **Visual C#** \> **Веб-приложение** \> **Веб-приложение ASP.NET**.

3.  Назовите проект "ContosoAdsWeb", назовите решение "ContosoAdsWebJobsSDK" (измените имя решения, если планируете поместить его в ту же папку, что и скачанное решение), а затем нажмите кнопку **ОК**.

    ![Новый проект][Новый проект]

4.  В диалоговом окне **Новый проект ASP.NET** выберите шаблон MVC и снимите флажок **Размещение в облаке** в **Microsoft Azure**.

    Параметр **Размещение в облаке** позволяет Visual Studio автоматически создать веб-сайт Azure и базу данных SQL. Поскольку вы уже создали их ранее, это не нужно делать при создании проекта. Если нужно создать новые, установите флажок. После этого можно настроить новый веб-сайт и базу данных SQL так же, как вы делали ранее при развертывании приложения.

5.  Щелкните **Изменить проверку подлинности**.

    ![Измените проверку подлинности][Измените проверку подлинности]

6.  В диалоговом окне **Изменение проверки подлинности** щелкните **Без проверки подлинности** и нажмите кнопку **ОК**.

    ![Без аутентификации][Без аутентификации]

7.  В диалоговом окне **Новый проект ASP.NET** нажмите кнопку **ОК**.

    Visual Studio создаст решение и веб-проект.

8.  в **обозревателе решений** щелкните правой кнопкой мыши решение (а не проект) и выберите **Добавить** \> **Новый проект**.

9.  В диалоговом окне **Добавление нового проекта** выберите шаблон **Visual C#** \> **Классические приложения Windows** \> **Библиотека классов**.

10. Присвойте проекту имя *ContosoAdsCommon* и нажмите кнопку **ОК**.

    Этот проект будет содержать контекст и модель данных Entity Framework, которые будут использовать внешний и внутренний сервер. Как вариант, можно определить связанные с EF классы в веб-проекте и сослаться на этот проект из проекта веб-задания. Но тогда проект веб-задания будет содержать ссылку на веб-сборки, которые ему не нужны.

### Добавление проекта приложения консоли, в котором включено развертывание веб-заданий

1.  Щелкните правой кнопкой мыши проект (а не решение или проект библиотеки классов) и нажмите кнопку **Добавить** \> **Новый проект веб-задания Azure**.

    ![Пункт меню "Новый проект веб-задания Azure"][Пункт меню "Новый проект веб-задания Azure"]

2.  В диалоговом окне **Добавление веб-задания Azure** введите ContosoAdsWebJob в поля **Имя проекта** и **Имя веб-задания**. Оставьте в поле **Режим запуска веб-задания** значение **Запускать постоянно**.

3.  Нажмите кнопку **ОК**.

    Visual Studio создает приложение консоли, которое настроено для развертывания в качестве веб-задания при каждом развертывании веб-проекта. Для этого после создания проекта выполняются следующие задачи.

    -   Добавляется файл *webjob-publish-settings.json* в папку "Свойства" проекта веб-задания.
    -   Добавляется файл *webjobs-list.json* в папку "Свойства" веб-проекта.
    -   Устанавливается пакет NuGet Microsoft.Web.WebJobs.Publish в проект веб-задания.

    Дополнительные сведения об этих изменениях см. в разделе [Развертывание веб-заданий с помощью Visual Studio][Развертывание веб-заданий с помощью Visual Studio].

### Добавление пакетов NuGet

Сначала установите пакет SDK веб-заданий в проект веб-задания.

1.  Откройте диалоговое окно **Управление пакетами NuGet** для решения.

2.  В левой области щелкните **В сети**.

3.  Измените значение **Только постоянные** на **Включить предварительные выпуски**.

4.  Найдите пакет NuGet *Microsoft.Azure.WebJobs* и установите его в пакете ContosoAdsWebJob.

    ![Поиск пакета SDK веб-заданий][Поиск пакета SDK веб-заданий]

    ![Установка пакета SDK веб-заданий только в проекте веб-задания][Установка пакета SDK веб-заданий только в проекте веб-задания]

    Также будут установлены зависимые пакеты, включая другой пакет SDK веб-заданий, *Microsoft.Jobs.Core*. (Другой пакет SDK веб-заданий используется отдельно, только когда вы создаете свои функции пользователя в отдельном DLL-файле. В этом учебнике весь код записывается в приложении консоли.) Для работы с очередями и большими двоичными объектами в веб-проекте и проекте веб-задания потребуется клиентская библиотека хранилища Azure (SCL).

Пакет NuGet клиентской библиотеки хранилища Azure (SCL) устанавливается в проект веб-задания автоматически, как зависимость пакета SDK веб-заданий. Он также нужен для работы с большими двоичными объектами и очередями в веб-проекте.

1.  В левой области выберите **Установленные пакеты**.

2.  Найдите пакет *Хранилище Azure* и щелкните кнопку **Управление**.

3.  В поле **Выберите проекты** установите флажок **ContosoAdsWeb** и нажмите кнопку **ОК**.

Все три проекта используют Entity Framework для работы с данными в базе данных SQL.

1.  В левой области щелкните **В сети**.

2.  Измените значение **Включить предварительный выпуск** на **Только стабильные**.

3.  Найдите пакет NuGet *EntityFramework* и установите его во все проекты.

### Установите ссылки проекта

Как веб-проекты, так и проекты веб-заданий будут работать с базой данных SQL, поэтому для обоих нужна ссылка на проект ContosoAdsCommon.

1.  Задайте в проекте ContosoAdsWeb ссылку на проект ContosoAdsCommon. (Щелкните правой кнопкой мыши проект ContosoAdsWeb и нажмите кнопку **Добавить** \> **Ссылка**. В диалоговом окне **Диспетчер ссылок** выберите **Решение** \> **Проекты** \> **ContosoAdsCommon** и нажмите кнопку **ОК**.)

2.  Задайте в проекте ContosoAdsWebJob ссылку на проект ContosoAdsCommon.

Для проекта веб-задания нужны ссылки для работы с изображениями и для доступа к строкам подключения.

1.  Задайте в проекте ContosoAdsWebJob ссылку на `System.Drawing` и `System.Configuration`.

### Добавление кода и файлов конфигурации

В этом учебнике не представлены следующие пошаговые инструкции: [Создание контроллеров и представлений MVC с помощью формирования шаблонов][ASP.NET MVC], [Запись кода Entity Framework, который работает с базами данных SQL Server][Запись кода Entity Framework, который работает с базами данных SQL Server] или [Основы асинхронного программирования в ASP.NET 4.5][Основы асинхронного программирования в ASP.NET 4.5]. Поэтому все, что нужно сделать, — скопировать код и файлы конфигурации из скачанного решения в новое. После этого в следующих разделах будет показаны и объяснены основные части кода.

Чтобы добавить файлы в проект или папку, щелкните правой кнопкой мыши проект или папку и нажмите **Добавить** \> **Существующий элемент**. Выберите необходимые файлы и щелкните **Добавить**. При запросе о том, заменять ли существующие файлы, щелкните **Да**.

1.  В проекте ContosoAdsCommon удалите файл *Class1.cs* и добавьте на его место следующие файлы из скачанного проекта.

    -   *Ad.cs*
    -   *ContosoAdscontext.cs*
    -   *BlobInformation.cs*

2.  В проекте ContosoAdsCommon добавьте следующие файлы из загруженного проекта.

    -   *Web.config*
    -   *Global.asax.cs*
    -   В папку *Controllers*: *AdController.cs.*
    -   В папку *Views\\Shared*: файл *\_Layout.cshtml*.
    -   В папку *Views\\Home*: *Index.cshtml*.
    -   В папку *Views\\Ad* (вначале создайте эту папку): пять файлов *.cshtml*.

3.  В проекте ContosoAdsWebJob добавьте следующие файлы из скачанного проекта.

    -   *App.config* (измените фильтр типов файлов на **Все файлы**)
    -   *Program.cs*

Теперь вы можете создать, запустить и развернуть приложение, как показано ранее в этом учебнике. Однако перед этим остановите веб-задание, которое все еще выполняется на первом веб-сайте, на котором выполнено развертывание. В противном случае такое веб-задание обработает сообщения очереди, созданные локально или запущенные приложением на новом веб-сайте, поскольку все они используют одну учетную запись хранения.

## <span id="code"></span></a>Просмотр кода приложения

В следующих разделах объясняется код, связанный с работой с пакетом SDK веб-заданий и большими двоичными объектами и очередями Azure. Код, связанный в пакетом SDK веб-заданий, см. в разделе [Раздел Program.cs][Раздел Program.cs].

### ContosoAdsCommon - Ad.cs

Файл Ad.cs определяет перечисляемый тип для класса Ad и класс сущностей POCO для информации в рекламе.

        public enum Category
        {
            Cars,
            [Display(Name="Real Estate")]
            RealEstate,
            [Display(Name = "Free Stuff")]
            FreeStuff
        }

        public class Ad
        {
            public int AdId { get; set; }

            [StringLength(100)]
            public string Title { get; set; }

            public int Price { get; set; }

            [StringLength(1000)]
            [DataType(DataType.MultilineText)]
            public string Description { get; set; }

            [StringLength(1000)]
            [DisplayName("Full-size Image")]
            public string ImageURL { get; set; }

            [StringLength(1000)]
            [DisplayName("Thumbnail")]
            public string ThumbnailURL { get; set; }

            [DataType(DataType.Date)]
            [DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}", ApplyFormatInEditMode = true)]
            public DateTime PostedDate { get; set; }

            public Category? Category { get; set; }
            [StringLength(12)]
            public string Phone { get; set; }
        }

### ContosoAdsCommon - ContosoAdsContext.cs

Класс ContosoAdsContext указывает, что класс Ad используется коллекцией DbSet, которую Entity Framework хранит в базе данных SQL.

        public class ContosoAdsContext : DbContext
        {
            public ContosoAdsContext() : base("name=ContosoAdsContext")
            {
            }
            public ContosoAdsContext(string connString)
                : base(connString)
            {
            }
            public System.Data.Entity.DbSet<Ad> Ads { get; set; }
        }

Класс имеет два конструктора. Первый из них используется веб-проектом и указывает имя строки подключения, которая сохранена в файле Web.config или в среде выполнения Azure. Второй конструктор дает возможность передачи действующей строки подключения. Это необходимо проекту веб-задания, поскольку он не имеет файла Web.config. Ранее было показано, где хранится строка подключения, а потом будет показано, как код извлекает строку подключения, когда он создает экземпляр класса DbContext.

### ContosoAdsCommon — BlobInformation.cs

Класс `BlobInformation` используется для хранения информации о сообщении о большом двоичном объекте изображения в очереди.

        public class BlobInformation
        {
            public Uri BlobUri { get; set; }
            
            public string BlobName
            {
                get
                {
                    return BlobUri.Segments[BlobUri.Segments.Length - 1];
                }
            }
            public string BlobNameWithoutExtension
            {
                get
                {
                    return Path.GetFileNameWithoutExtension(BlobName);
                }
            }
            public int AdId { get; set; }
        }

### ContosoAdsWeb - Global.asax.cs

Код, который вызывается из метода `Application_Start`, создает контейнер большого двоичного объекта *images* и очередь *images*, если они еще не существуют. Это гарантирует, что при каждом использовании новой учетной записи хранения необходимый контейнер больших двоичных объектов и очередь будут создаваться автоматически.

Код получает доступ к учетной записи хранения, используя строку подключения из файла *Web.config* или среду выполнения Azure.

        var storageAccount = CloudStorageAccount.Parse
            (ConfigurationManager.ConnectionStrings["AzureWebJobsStorage"].ToString());

Затем он получает ссылку на контейнер больших двоичных объектов *images*, создает контейнер, если он еще не существует, и устанавливает разрешения доступа к новому контейнеру. По умолчанию новые контейнеры разрешают доступ к большим двоичным объектам только клиентам с учетными данными записи хранилища. Веб-сайту требуются общедоступные большие двоичные объекты, чтобы он мог выводить изображения с использованием URL-адресов, которые указывают на объекты изображений.

        var blobClient = storageAccount.CreateCloudBlobClient();
        var imagesBlobContainer = blobClient.GetContainerReference("images");
        if (imagesBlobContainer.CreateIfNotExists())
        {
            imagesBlobContainer.SetPermissions(
                new BlobContainerPermissions
                {
                    PublicAccess = BlobContainerPublicAccessType.Blob
                });
        }

Аналогичный код получает ссылку на очередь *blobnamerequest* и создает новую очередь В этом случае изменений разрешений не требуется. В разделе [ResolveBlobName][ResolveBlobName] далее в этом учебнике объясняется, почему очередь, в которую выполняет запись веб-приложение, используется только для получения имен больших двоичных объектов, а не для создания эскизов.

        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
        var imagesQueue = queueClient.GetQueueReference("blobnamerequest");
        imagesQueue.CreateIfNotExists();

### ContosoAdsWeb - \_Layout.cshtml

Файл *\_Layout.cshtml* устанавливает имя приложения в заголовке и нижнем колонтитуле и создает запись меню "Ads".

### ContosoAdsWeb - Views\\Home\\Index.cshtml

Файл *Views\\Home\\Index.cshtml* выводит ссылки категорий на домашней странице. Ссылки передают целое значение перечисляемого типа `Category` в переменную querystring на странице индекса Ads.

        <li>@Html.ActionLink("Cars", "Index", "Ad", new { category = (int)Category.Cars }, null)</li>
        <li>@Html.ActionLink("Real estate", "Index", "Ad", new { category = (int)Category.RealEstate }, null)</li>
        <li>@Html.ActionLink("Free stuff", "Index", "Ad", new { category = (int)Category.FreeStuff }, null)</li>
        <li>@Html.ActionLink("All", "Index", "Ad", null, null)</li>

### ContosoAdsWeb - AdController.cs

В файле *AdController.cs* конструктор вызывает метод `InitializeStorage` для создания объектов клиентской библиотеки хранилища Azure, который предоставляет API для работы с большими двоичными объектами и очередями.

Затем код получает ссылку на контейнер больших двоичных объектов *images*, как показано ранее в *Global.asax.cs*. При этом он устанавливает [политику повторения][политику повторения] по умолчанию, подходящую для веб-приложения. Политика повторения с экспоненциальной задержкой по умолчанию может застопорить веб-приложение более чем на минуту при повторяющихся повторах во время кратковременного сбоя. Политика повторения здесь указывает ожидание в 3 секунды после каждой попытки, всего до 3 повторений.

        var blobClient = storageAccount.CreateCloudBlobClient();
        blobClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
        imagesBlobContainer = blobClient.GetContainerReference("images");

Аналогичный код получает ссылку на очередь *images*.

        CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
        queueClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
        imagesQueue = queueClient.GetQueueReference("blobnamerequest");

Большая часть кода контроллера обычна для работы с моделью данных Entity Framework с использованием класса DbContext. Исключением является метод `Create` HttpPost, который отправляет файл и сохраняет его в хранилище больших двоичных объектов. Связыватель модели предоставляет объект [HttpPostedFileBase][HttpPostedFileBase] для метода.

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> Create(
            [Bind(Include = "Title,Price,Description,Category,Phone")] Ad ad,
            HttpPostedFileBase imageFile)

При выбора файла для отправки код отправляет его, сохраняет его в большом двоичном объекте и обновляет запись базы данных URL-адресом, который указывает на большой двоичный объект.

        if (imageFile != null && imageFile.ContentLength != 0)
        {
            blob = await UploadAndSaveBlobAsync(imageFile);
            ad.ImageURL = blob.Uri.ToString();
        }

Код отправки содержится в методе `UploadAndSaveBlobAsync`. Он создает имя GUID для большого двоичного объекта, отправляет и сохраняет файл, а также возвращает ссылку на сохраненный большой двоичный объект.

        private async Task<CloudBlockBlob> UploadAndSaveBlobAsync(HttpPostedFileBase imageFile)
        {
            string blobName = Guid.NewGuid().ToString() + Path.GetExtension(imageFile.FileName);
            CloudBlockBlob imageBlob = imagesBlobContainer.GetBlockBlobReference(blobName);
            using (var fileStream = imageFile.InputStream)
            {
                await imageBlob.UploadFromStreamAsync(fileStream);
            }
            return imageBlob;
        }

После того, как метод `Create` HttpPost отправляет большой двоичный объект и обновляет базу данных, он создает сообщение в очереди для информирования фонового процесса о том, что изображение готово для конвертации в эскиз.

        BlobInformation blobInfo = new BlobInformation() { AdId = ad.AdId, BlobUri = new Uri(ad.ImageURL) };
        var queueMessage = new CloudQueueMessage(JsonConvert.SerializeObject(blobInfo));
        await thumbnailRequestQueue.AddMessageAsync(queueMessage);

Код для метода `Edit` HttpPost аналогичен за одним исключением — если пользователь выбирает новый файл изображения, все большие двоичные объекты, которые уже существуют для этой рекламы, должны быть удалены.

        if (imageFile != null && imageFile.ContentLength != 0)
        {
            await DeleteAdBlobsAsync(ad);
            imageBlob = await UploadAndSaveBlobAsync(imageFile);
            ad.ImageURL = imageBlob.Uri.ToString();
        }

Вот код, который удаляет большие двоичные объекты при удалении элемента рекламы:

        private async Task DeleteAdBlobsAsync(Ad ad)
        {
            if (!string.IsNullOrWhiteSpace(ad.ImageURL))
            {
                Uri blobUri = new Uri(ad.ImageURL);
                await DeleteAdBlobAsync(blobUri);
            }
            if (!string.IsNullOrWhiteSpace(ad.ThumbnailURL))
            {
                Uri blobUri = new Uri(ad.ThumbnailURL);
                await DeleteAdBlobAsync(blobUri);
            }
        }
        private static async Task DeleteAdBlobAsync(Uri blobUri)
        {
            string blobName = blobUri.Segments[blobUri.Segments.Length - 1];
            CloudBlockBlob blobToDelete = imagesBlobContainer.GetBlockBlobReference(blobName);
            await blobToDelete.DeleteAsync();
        }

### ContosoAdsWeb - Views\\Ad\\Index.cshtml и Details.cshtml

Файл *Index.cshtml* выводит эскиз с другими данными рекламы:

        <img  src="@Html.Raw(item.ThumbnailURL)" />

Файл *Details.cshtml* выводит изображение в полном размере:

        <img src="@Html.Raw(Model.ImageURL)" />

### ContosoAdsWeb - Views\\Ad\\Create.cshtml и Edit.cshtml

Файлы *Create.cshtml* и *Edit.cshtml* указывают кодирование формы, которое дает возможность контроллеру получить объект `HttpPostedFileBase`.

        @using (Html.BeginForm("Create", "Ad", FormMethod.Post, new { enctype = "multipart/form-data" }))

Элемент `<input>` сообщает браузеру, что нужно открыть диалоговое окно выбора файла.

        <input type="file" name="imageFile" accept="image/*" class="form-control fileupload" />

### <span id="programcs"></span></a>ContosoAdsWebJob — Program.cs — методы Main и Initialize

При запуске веб-задания метод `Main` вызывает `Initialize` для создания экземпляра контекста базы данных Entity Framework. Затем он вызывает метод `JobHost.RunAndBlock` пакета SDK веб-заданий, чтобы начать однопотоковое выполнение активированных функций в текущем потоке.

        static void Main(string[] args)
        {
            Initialize();
        
            JobHost host = new JobHost();
            host.RunAndBlock();
        }
        
        private static void Initialize()
        {
            db = new ContosoAdsContext();
        }

### <span id="generatethumbnail"></span></a>ContosoAdsWebJob — Program.cs — метод GenerateThumbnail

Пакет SDK веб-заданий вызывает этот метод при получении сообщения очереди. Метод создает эскиз и помещает URL-адрес эскиза в базу данных.

        public static void GenerateThumbnail(
        [QueueTrigger("thumbnailrequest")] BlobInformation blobInfo,
        [Blob("images/{BlobName}")] Stream input,
        [Blob("images/{BlobNameWithoutExtension}_thumbnail.jpg")] CloudBlockBlob outputBlob)
        {
            using (Stream output = outputBlob.OpenWrite())
            {
                ConvertImageToThumbnailJPG(input, output);
                outputBlob.Properties.ContentType = "image/jpeg";
            }
        
            var id = blobInfo.AdId;
            Ad ad = db.Ads.Find(id);
            if (ad == null)
            {
                throw new Exception(String.Format("AdId {0} not found, can't create thumbnail", id.ToString()));
            }
            ad.ThumbnailURL = outputBlob.Uri.ToString();
            db.SaveChanges();
        }

-   Атрибут `QueueTrigger` направляет пакет SDK веб-заданий для вызова этого метода при получении нового сообщения в очереди запросов эскизов.

        [QueueTrigger("thumbnailrequest")] BlobInformation blobInfo,

    Для объекта `BlobInformation` в сообщении очереди автоматически выполняется десериализация в параметр `blobInfo`. По завершении метода сообщение очереди удаляется. Если происходит сбой метода до его завершения, сообщение очереди не удаляется. После истечения 10-минутного срока действия аренды сообщение передается для повторной обработки. Если сообщение вызывает исключение, эта последовательность не будет повторяться бесконечно. После 5 неудачных попыток обработать сообщение, оно будет перемещено в очередь с именем {queuename}-poison. Можно настроить максимальное количество попыток.

-   Два атрибута `Blob` предоставляют объекты, которые привязаны к большим двоичным объектом: один к существующему большому двоичному объекту изображения, а другой к новому большому двоичному объекту эскиза, который создает метод.

        [Blob("images/{BlobName}")] Stream input,
        [Blob("images/{BlobNameWithoutExtension}_thumbnail.jpg")] CloudBlockBlob outputBlob)

    Имена больших двоичных объектов задаются в соответствии со свойствами объекта `BlobInformation`, полученного в сообщении очереди (`BlobName` и `BlobNameWithoutExtension`). Чтобы получить все функции клиентской библиотеки хранилища, можно использовать класс `CloudBlockBlob` для работы с большими двоичными объектами. Если вы хотите повторно использовать код, написанный для работы с объектами `Stream`, можно использовать класс `Stream`.

> [WACOM.NOTE]
>
> -   Если ваш веб-сайт работает на нескольких виртуальных машинах, эта программа запустится на каждой машине, и каждая машина будет ожидать триггеров и попытки запустить функции. В некоторых сценариях это может привести к тому, что некоторые функции обработают часть данных дважды, поэтому функции должны быть идемпотентными (написанными так, что постоянный их вызов с одинаковыми входными данными не создаст дублирующие результаты).
> -   Сведения о нормальном завершении работы см. в разделе [Объявление о бета-версии пакета SDK 0.3.0 веб-заданий][Объявление о бета-версии пакета SDK 0.3.0 веб-заданий].
> -   Для простоты код в методе `ConvertImageToThumbnailJPG` (не показан) использует классы в пространстве имен `System.Drawing`. Однако классы в этом пространстве имен были спроектированы для использования с формами Windows. Они не поддерживаются в службе Windows или ASP.NET.

### Сравнение веб-заданий и рабочей роли облачной службы

Если сравнить объем кода в методе `GenerateThumbnails` в этом примере приложения с кодом рабочей роли в [версии облачной службы приложения][версии облачной службы приложения], можно увидеть, сколько пакет SDK веб-заданий выполняет автоматически. Преимуществ больше, чем кажется, поскольку код примера приложения облачной службы не выполняет всего (например, обработку сообщений о сбоях), что требуется в рабочем приложении, в отличие от пакета SDK веб-заданий.

Версия облачной службы этого примера приложения содержит метод `ProcessQueueMessage`, который выполняет следующие задачи.

-   Получение идентификатора записи базы данных из сообщения очереди.
-   Чтение базы данных для получения URL-адреса большого двоичного объекта.
-   Преобразование изображения в эскиз и сохранение эскиза в новом большом двоичном объекте.
-   Обновление записи базы данных путем добавления URL-адреса больших двоичных объектов эскиза.

В версии облачной службы приложения идентификатор записи — это единственная информация в сообщении очереди, а фоновый процесс получает URL-адрес изображения базы данных. В версии SDK веб-заданий приложения сообщение очереди включает URL-адрес изображения так, что его невозможно предоставить атрибутам `Blob`. Если сообщение очереди не содержало URL-адрес больших двоичных объектов, потребуется записать код в метод для получения URL-адреса больших двоичных объектов, а затем записать код для привязки объектов к входным и выходным большим двоичным объектам, вместо того, чтобы позволить пакету SDK веб-заданий сделать это за вас.

### Использование пакета SDK веб-заданий в рабочей роли

Как вы видели, программа, которая использует пакет SDK веб-заданий, не должна запускаться в Azure в веб-задании. Ее можно запустить локально и в рабочей роли. Однако доступ к панели мониторинга SDK веб-заданий можно получить только на веб-сайте Azure. Чтобы использовать панель мониторинга, необходимо подключить веб-сайт к используемой учетной записи хранения, задав строку подключения AzureWebJobsDashboard на вкладке "Настройка" портала управления. Затем можно перейти на панель мониторинга по URL-адресу [https://{websitename}.scm.azurewebsites.net/azurejobs/\#/functions][https://{websitename}.scm.azurewebsites.net/azurejobs/\#/functions]. Дополнительные сведения см. в разделе [Получение панели мониторинга для локальной разработки с помощью пакета SDK веб-заданий][Получение панели мониторинга для локальной разработки с помощью пакета SDK веб-заданий], но обратите внимание, что она отображает имя старой строки подключения.

## Дальнейшие действия

В этом учебнике было показано простое многоуровневое приложение, которое использует пакет SDK веб-заданий для обработки внутреннего сервера. Приложение намеренно сделано простым, поскольку это учебник по началу работы. Например, оно не реализует [вставку зависимостей][вставку зависимостей] или [репозиторий и блок рабочих шаблонов][репозиторий и блок рабочих шаблонов], не [использует интерфейс для журналов][использует интерфейс для журналов], не использует [EF Code First Migrations][EF Code First Migrations] для управления изменениями модели данных или [EF Connection Resiliency][EF Connection Resiliency] для управления кратковременными ошибками сети и т. д.

Дополнительные примеры, в которых показано, как использовать пакет SDK веб-заданий в других сценариях см. в папке [AzureWebJobs][AzureWebJobs] в проекте CodePlex ASP.NET.

При запуске веб-задания на веб-сайте можно устранить неполадки, запустив удаленный режим отладки, как для веб-сайтов. Дополнительные сведения см. в статье [Устранение неполадок веб-сайтов Azure в Visual Studio][Устранение неполадок веб-сайтов Azure в Visual Studio]. Необходимо вручную вложить процесс веб-задания. Сведения о вложении процесса см. в инструкциях Visual Studio 2012 в учебнике.

Дополнительные сведения см. в разделе [Рекомендуемые ресурсы по веб-заданиям Azure][Рекомендуемые ресурсы по веб-заданиям Azure].

  [веб-сайте Azure]: /ru-ru/documentation/articles/fundamentals-application-models/#WebSites
  [базу данных Azure SQL]: http://msdn.microsoft.com/library/azure/ee336279
  [службу BLOB-объектов Azure]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage
  [службу очередей Azure]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern
  [Список рекламы]: ./media/websites-dotnet-webjobs-sdk-get-started/list.png
  [загрузить проект Visual Studio]: http://code.msdn.microsoft.com/Simple-Azure-Website-with-b4391eeb
  [Предварительные требования]: #prerequisites
  [Содержание обучения]: #learn
  [Пакет SDK веб-заданий]: #webjobssdk
  [Архитектура приложения]: #contosoads
  [Настройка среды разработки]: #setupdevenv
  [Создание, запуск и развертывание приложения]: #storage
  [Создание приложения с самого начала]: #create
  [Просмотр кода приложения]: #code
  [Устранение неполадок]: #troubleshoot
  [Дальнейшие действия]: #next-steps
  [ASP.NET MVC]: http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started
  [веб-форм]: http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview
  [Веб-задания]: /ru-ru/documentation/articles/web-sites-create-web-jobs/
  [AlwaysOn]: http://weblogs.asp.net/scottgu/archive/2014/01/16/windows-azure-staging-publishing-support-for-web-sites-monitoring-improvements-hyper-v-recovery-manager-ga-and-pci-compliance.aspx
  [Таблица рекламы]: ./media/websites-dotnet-webjobs-sdk-get-started/adtable.png
  [Архитектура Contoso Ads]: ./media/websites-dotnet-webjobs-sdk-get-started/apparchitecture.png
  [Сравнение веб-сайтов, облачных служб и виртуальных машин Azure]: /ru-ru/documentation/articles/choose-web-site-cloud-service-vm/
  [портале управления Azure]: http://manage.windowsazure.com
  [Управление учетными записями хранения]: /ru-ru/documentation/articles/storage-manage-storage-account/
  [Новая учетная запись хранения]: ./media/websites-dotnet-webjobs-sdk-get-started/newstorage.png
  [SQL Server Express LocalDB]: http://msdn.microsoft.com/ru-ru/library/hh510202.aspx
  [1]: http://manage.windowsazure.com/
  [Кнопка "Управление ключами доступа"]: ./media/websites-dotnet-webjobs-sdk-get-started/mak.png
  [Диалоговое окно "Управление ключами доступа"]: ./media/websites-dotnet-webjobs-sdk-get-started/cpak.png
  [Домашняя страница Contoso Ads]: ./media/websites-dotnet-webjobs-sdk-get-started/home.png
  [Окно приложения консоли, отображающее, что внутренний сервер запущен]: ./media/websites-dotnet-webjobs-sdk-get-started/backendrunning.png
  [Страница создания]: ./media/websites-dotnet-webjobs-sdk-get-started/create.png
  [Окно приложения консоли, отображающее, что сообщение очереди обработано]: ./media/websites-dotnet-webjobs-sdk-get-started/backendlogs.png
  [Страница сведений]: ./media/websites-dotnet-webjobs-sdk-get-started/details.png
  [Целевой объект публикации выбора веб-сайта Azure]: ./media/websites-dotnet-webjobs-sdk-get-started/pubweb.png
  [Щелкните "Войти"]: ./media/websites-dotnet-webjobs-sdk-get-started/signin.png
  [Нажмите кнопку "Создать"]: ./media/websites-dotnet-webjobs-sdk-get-started/clicknew.png
  [Диалоговое окно "Создание сайта в Microsoft Azure"]: ./media/websites-dotnet-webjobs-sdk-get-started/newdb.png
  [Шаге "Подключение"]: ./media/websites-dotnet-webjobs-sdk-get-started/connstep.png
  [Этап настроек]: ./media/websites-dotnet-webjobs-sdk-get-started/settingsstep.png
  [Нажмите кнопку "Начать предварительный просмотр"]: ./media/websites-dotnet-webjobs-sdk-get-started/previewstep.png
  [Окно "Предварительный просмотр файлов веб-заданий"]: ./media/websites-dotnet-webjobs-sdk-get-started/previewwjfiles.png
  [не указывать конфиденциальную информацию, такую как строки подключения, в файлах, которые хранятся в репозиториях исходного кода]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets
  [Строки подключения на портале управления]: ./media/websites-dotnet-webjobs-sdk-get-started/azconnstr.png
  [Вкладка "Веб-задания"]: ./media/websites-dotnet-webjobs-sdk-get-started/wjtab.png
  [Панель мониторинга пакета SDK веб-заданий]: ./media/websites-dotnet-webjobs-sdk-get-started/wjdashboardhome.png
  [2]: ./media/websites-dotnet-webjobs-sdk-get-started/wjfunctiondetails.png
  [Новый проект]: ./media/websites-dotnet-webjobs-sdk-get-started/newproject.png
  [Измените проверку подлинности]: ./media/websites-dotnet-webjobs-sdk-get-started/chgauth.png
  [Без аутентификации]: ./media/websites-dotnet-webjobs-sdk-get-started/noauth.png
  [Пункт меню "Новый проект веб-задания Azure"]: ./media/websites-dotnet-webjobs-sdk-get-started/newawjp.png
  [Развертывание веб-заданий с помощью Visual Studio]: /ru-ru/documentation/articles/websites-dotnet-deploy-webjobs/
  [Поиск пакета SDK веб-заданий]: ./media/websites-dotnet-webjobs-sdk-get-started/updstg.png
  [Установка пакета SDK веб-заданий только в проекте веб-задания]: ./media/websites-dotnet-webjobs-sdk-get-started/updstg2.png
  [Запись кода Entity Framework, который работает с базами данных SQL Server]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc
  [Основы асинхронного программирования в ASP.NET 4.5]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async
  [Раздел Program.cs]: #programcs
  [ResolveBlobName]: #resolveblobname
  [политику повторения]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling
  [HttpPostedFileBase]: http://msdn.microsoft.com/ru-ru/library/system.web.httppostedfilebase.aspx
  [Объявление о бета-версии пакета SDK 0.3.0 веб-заданий]: http://azure.microsoft.com/blog/2014/06/18/announcing-the-0-3-0-beta-preview-of-microsoft-azure-webjobs-sdk/http://azure.microsoft.com/blog/2014/06/18/announcing-the-0-3-0-beta-preview-of-microsoft-azure-webjobs-sdk/
  [версии облачной службы приложения]: /ru-ru/documentation/articles/cloud-services-dotnet-get-started/
  [Получение панели мониторинга для локальной разработки с помощью пакета SDK веб-заданий]: http://blogs.msdn.com/b/jmstall/archive/2014/01/27/getting-a-dashboard-for-local-development-with-the-webjobs-sdk.aspx
  [вставку зависимостей]: http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection
  [репозиторий и блок рабочих шаблонов]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo
  [использует интерфейс для журналов]: http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log
  [EF Code First Migrations]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
  [EF Connection Resiliency]: http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application
  [AzureWebJobs]: http://aspnet.codeplex.com/SourceControl/latest#Samples/AzureWebJobs/ReadMe.txt
  [Устранение неполадок веб-сайтов Azure в Visual Studio]: /ru-ru/documentation/articles/web-sites-dotnet-troubleshoot-visual-studio/
  [Рекомендуемые ресурсы по веб-заданиям Azure]: http://go.microsoft.com/fwlink/?LinkId=390226
