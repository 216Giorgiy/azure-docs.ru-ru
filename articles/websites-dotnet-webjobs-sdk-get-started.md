<properties pageTitle="Начало работы с Azure WebJobs SDK" metaKeywords="учебник Azure, учебник Azure WebJobs, многоуровневый учебник Azure, учебник MVC, учебник по большим двоичным объектам Azure, учебник по очередям Azure, учебник по хранилищу Azure" description="Узнайте, как можно создать многоуровневое приложение с помощью ASP.NET MVC и Azure. Интерфейсная часть выполняется на веб-сайте, а внутренняя служба — как элемент WebJob. Приложение использует Entity Framework, базу данных SQL, очереди службы хранилища Azure и большие двоичные объекты." metaCanonical="" services="web-sites,storage" documentationCenter=".NET" title="Get Started with the Azure WebJobs SDK" authors="tdykstra" solutions="" manager="wpickett" editor="mollybos" />

<tags ms.service="web-sites" ms.workload="web" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="10/12/2014" ms.author="tdykstra" />

# Начало работы с пакетом SDK веб-заданий Azure

В этом учебнике показано, как создать многоуровневое MVC-приложение ASP.NET, которое с помощью пакета WebJobs SDK работает с [очередями Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern) и [BLOB-объектами Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage) на [веб-сайте Azure](/ru-ru/documentation/services/websites/). Приложение также использует [Azure SQL Database](http://msdn.microsoft.com/library/azure/ee336279). 

Приложение в примере представляет собой рекламную доску объявлений. Пользователи создают рекламу, вводя текст и загружая изображения. Они могут видеть список рекламы по эскизам изображений, и они могут видеть изображения в полном размере, когда выбирают рекламу для просмотра деталей. Ниже приведен снимок экрана.

![Ad list](./media/websites-dotnet-webjobs-sdk-get-started/list.png)

[Проект Visual Studio][можно загрузить] из коллекции примеров кода MSDN. 

[загрузить]: http://code.msdn.microsoft.com/Simple-Azure-Website-with-b4391eeb

## Оглавление

- [Предварительные требования](#prerequisites)
- [Содержание обучения](#learn)
- [Архитектура приложения](#contosoads)
- [Настройка среды разработки](#setupdevenv)
- [Создание, запуск и развертывание приложения](#storage)
- [Создание приложения с самого начала](#create)
- [Просмотр кода приложения](#code)
- [Дальнейшие действия](#next-steps)

## <a id="prerequisites"></a>Предварительные требования

В учебнике предполагается, что вы знаете, как работать с проектами [ASP.NET MVC](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started) или [веб-формами](http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview) в Visual Studio. Пример приложения использует MVC, но многое в руководство также применимо к веб-формам. 

Инструкции в учебнике применимы к следующим продуктам:

* Visual Studio 2013
* Visual Studio 2013 Express для Web

Если у вас нет одного из них, Visual Studio 2013 Express for Web установится автоматически, когда будет установлен Azure SDK.

[WACOM.INCLUDE [free-trial-note](../includes/free-trial-note.md)]

## <a id="learn"></a>Вы узнаете:

В учебнике показано, как выполнять следующие задачи.

* Подготовка компьютера к разработке для Azure путем установки пакета Azure SDK.
* Создание проекта приложения консоли, который автоматически развертывается как веб-задание Azure при развертывании связанного веб-проекта.
* Локальное тестирование внутреннего сервера SDK веб-заданий на компьютере разработки.
* Публикация приложения с помощью внутреннего сервера веб-заданий на веб-сайте Azure.
* Отправка файлов и сохранение их в службе больших двоичных объектов Azure.
* Использование пакета SDK веб-заданий Azure для работы с очередями и большими двоичными объектами хранилища Azure.

## <a id="contosoads"></a>Архитектура приложения

В примере приложения используется [рабочий шаблон на основе очередей](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern) для разгрузки процессора от задач по созданию эскизов за счет их выполнения в серверном процессе. 

Приложение хранит рекламу в базе данных SQL, используя Entity Framework Code First для создания таблиц и доступа к данным. Для каждого рекламного объявления база данных хранит два URL-адреса: один для полноразмерного изображения, другой для эскиза.

![Ad table](./media/websites-dotnet-webjobs-sdk-get-started/adtable.png)

Когда пользователь отправляет изображение, веб-сайт сохраняет его в [большой двоичный объект Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage), а информацию о рекламе - в базе данных с URL-адресом, который указывает на большой двоичный объект. В это же время оно записывает сообщение в очередь Azure. Обработка внутреннего сервера, запущенная как веб-задание Azure, использует пакет SDK веб-заданий, чтобы опросить очередь на предмет новых сообщений. Когда появляется новое сообщение, веб-задание создает эскиз для изображения и обновляет поле базы данных с URL-адресом эскиза для этой рекламы. Вот диаграмма, которая показывает, как взаимодействуют части приложения.

![Contoso Ads architecture](./media/websites-dotnet-webjobs-sdk-get-started/apparchitecture.png)

### Альтернативная архитектура

Веб-задания запускаются в контексте веб-сайта и не масштабируются отдельно. Например, если у вас есть один экземпляр веб-сайта Standard, вы можете запустить только 1 экземпляр фонового процесса, и он будет использовать некоторые ресурсы сервера (ЦП, память и т. д.), которые в противном случае были бы доступны для обработки веб-содержимого. 

Если трафик зависит от времени дня или дня недели и если необходимую внутреннюю обработку можно запустить позже, запланируйте запуск веб-заданий на период с низким трафиком. Если загрузка для этого решения все еще слишком высока, можно рассмотреть другие среды для программы внутреннего сервера, например следующие:

* Запустите программу в качестве веб-задания на отдельном специализированном веб-сайте. После этого можно масштабировать внутренний веб-сайт отдельно от внешнего веб-сайта.
* Запустите программу в рабочей роли облачной службы Azure. При выборе этого варианта внешний сервер можно запустить в веб-роли облачной службы или на веб-сайте.

В этом учебнике показано, как запустить внешний сервер на веб-сайте и внутренний сервер как веб-задание на одном и том же веб-сайте. Сведения о том, как выбрать оптимальную среду для вашего сценария, см. в разделе [Сравнение веб-сайтов, облачных служб и виртуальных машин Azure](/ru-ru/documentation/articles/choose-web-site-cloud-service-vm/).

[WACOM.INCLUDE [install-sdk-2013-only](../includes/install-sdk-2013-only.md)]

Инструкции учебника были написаны с помощью следующей предварительной версии [Visual Studio 2013 с обновлением 4](http://go.microsoft.com/fwlink/?LinkID=510328). При работе в Visual Studio 2013 с обновлением 3 различие будет только в разделе "Создание с нуля" о создании проекта веб-задания: с обновлением 4 пакеты WebJobs SDK автоматически включаются в проект; без обновления 4 вам нужно устанавливать пакеты вручную.

## <a id="storage"></a>Создание учетной записи хранения Azure

Учетная запись хранения Azure обеспечивает ресурсы для хранения в облаке данных очередей и больших двоичных объектов. Она также используется пакетом WebJobs SDK для хранения данных журналов для панели мониторинга.

В реальном приложении обычно создают отдельные учетные записи для данных приложения и данных журналов, а также отдельные учетные записи для тестовых и рабочих данных. В этом учебнике будет использоваться только одна учетная запись.

1. Откройте окно **Обозреватель серверов** в Visual Studio.

2. Щелкните правой кнопкой мыши узел **Azure**, а затем щелкните **Подключиться к Microsoft Azure**.

![Connect to Azure](./media/websites-dotnet-webjobs-sdk-get-started/connaz.png)

3. Выполните вход с использованием учетных данных Azure.

5. Щелкните правой кнопкой мыши **Хранилище** в узле Azure и выберите пункт **Создать учетную запись хранения**.

![Create Storage Account](./media/websites-dotnet-webjobs-sdk-get-started/createstor.png)

3. В диалоговом окне **Создание учетной записи хранения** введите имя для учетной записи хранения. 

	Имя должно быть уникальным (другие учетные записи хранения Azure не могут иметь то же имя). Если введенное имя уже используется, вы сможете изменить его.

	URL-адрес для доступа к вашей учетной записи хранения будет выглядеть следующим образом: *{имя} *.core.windows.net. 

5. В раскрывающемся списке **Регион или территориальная группа** укажите ближайший к вам регион.

	Этот параметр указывает, в каком центре обработки данных Azure будет размещаться учетная запись хранения. При работе с учебником это не окажет существенного влияния, но для рабочего сайта веб-сервер и учетная запись хранения должны находиться в одном регионе, чтобы минимизировать задержку и стоимость исходящих данных. Веб-сайт (который будет создан позже) должен находиться как можно ближе к браузерам, которые обращаются к сайту, чтобы максимально уменьшить задержку.

6. В раскрывающемся списке **Репликация** выберите значение **Локально избыточное**. 

	Если для учетной записи хранения включена георепликация, хранящиеся данные реплицируются в дополнительный центр обработки данных для отработки отказа в это расположение в случае крупной аварии в основном расположении. Георепликация может потребовать дополнительных затрат. Для учетных записей тестирования и разработки оплачивать георепликацию обычно не требуется. Дополнительные сведения см. в разделе [Управление учетными записями хранения](/ru-ru/documentation/articles/storage-manage-storage-account/).

5. Щелкните **Создать**. 

	![New storage account](./media/websites-dotnet-webjobs-sdk-get-started/newstorage.png)	

## <a id="download"></a>Загрузите приложение
 
1. Загрузите и распакуйте [готовое решение][].

2. Запустите Visual Studio.

3. В меню **Файл** выберите **Открыть** > **Проект/решение**, перейдите к папке, куда вы загрузили решение, а затем откройте файл *.sln.

3. Чтобы построить решение, нажмите CTRL+SHIFT+B.

	По умолчанию Visual Studio автоматически восстановит содержимое пакета NuGet, которое не было включено в *.zip*-файл. Если пакеты не восстановлены, установите их вручную, перейдя к диалогу **Управление пакетами для NuGet решения** и нажав кнопку **Восстановить** вверху справа. 

3. В **обозревателе решений** убедитесь, что в качестве запускаемого проекта выбран **ContosoAdsWeb**.

## <a id="configurestorage"></a>Настройка приложения для использования учетной записи хранения

2. Откройте файл Web.config приложения в проекте ContosoAdsWeb.
 
	Файл содержит строку подключения SQL и строку подключения хранилища Azure для работы с большими двоичными объектами и очередями. 

	Строка подключения SQL указывает на базу данных [SQL Server Express LocalDB](http://msdn.microsoft.com/ru-ru/library/hh510202.aspx).
 
	Строка подключения к хранилищу является примером с заполнителями для имени учетной записи хранения и ключа доступа. Замените это строкой подключения, которая содержит имя и ключ для вашей учетной записи хранения.  

	<pre class="prettyprint">&lt;connectionStrings&gt;
	  &lt;add name="ContosoAdsContext" connectionString="Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;" providerName="System.Data.SqlClient" /&gt;
	  &lt;add name="AzureWebJobsStorage" connectionString="DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>"/&gt;
	&lt;/connectionStrings&gt;</pre>

	Строка подключения хранилища называется AzureWebJobsStorage, поскольку пакет WebJobs SDK по умолчанию использует это имя. Здесь используется то же имя, поэтому вам нужно задать только одно значение строки подключения в среде Azure.
 
2. В **обозревателе серверов** щелкните правой кнопкой мыши учетную запись хранения в узле **Хранилище** и щелкните **Свойства**.

	![Click Storage Account Properties](./media/websites-dotnet-webjobs-sdk-get-started/storppty.png)	

4. В окне **Свойства** щелкните **Ключи учетной записи хранения** и нажмите кнопку с многоточием.

	![New storage account](./media/websites-dotnet-webjobs-sdk-get-started/newstorage.png)	

7. Скопируйте **строку подключения**.

	![Storage Account Keys dialog](./media/websites-dotnet-webjobs-sdk-get-started/cpak.png)	

8. Замените строку подключения к хранилищу в файле *Web.config* на скопированную строку подключения. Перед вставкой убедитесь, что выбраны все элементы внутри кавычек без самих кавычек.

4. Откройте файл *App.config* в проекте ContosoAdsWebJob.

	Этот файл содержит две строки подключения хранилища: одну для данных приложения, а другую для ведения журнала. В этом учебнике будет использоваться одна учетная запись. Строки подключения содержат заполнители для ключей учетной записи хранения.
  	<pre class="prettyprint">&lt;configuration&gt;
    &lt;connectionStrings&gt;
        &lt;add name="AzureWebJobsDashboard" connectionString="DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>"/&gt;
        &lt;add name="AzureWebJobsStorage" connectionString="DefaultEndpointsProtocol=https;AccountName=<mark>[accountname]</mark>;AccountKey=<mark>[accesskey]</mark>"/&gt;
        &lt;add name="ContosoAdsContext" connectionString="Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;"/&gt;
    &lt;/connectionStrings&gt;
        &lt;startup&gt; 
            &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.5" /&gt;
    &lt;/startup&gt;
&lt;/configuration&gt;</pre>

	По умолчанию пакет WebJobs SDK ищет строки подключения с именами AzureWebJobsStorage и AzureWebJobsDashboard. В качестве альтернативы можно [сохранить строку подключения любым способом и явно передать ее в объект JobHost](../websites-dotnet-webjobs-sdk-storage-queues-how-to/#config).

1. Замените обе строки подключения к хранилищу скопированной ранее строкой подключения.

5. Сохраните изменения.

## <a id="run"></a>Локальный запуск приложения

1. Чтобы запустить внешний веб-сервер приложения, нажмите клавиши CTRL+F5. 

	Откроется веб-браузер. (Запускается веб-проект, поскольку он сделан запускаемым проектом.)

	![Contoso Ads home page](./media/websites-dotnet-webjobs-sdk-get-started/home.png)

2. Чтобы запустить внутренний сервер веб-задания приложения, щелкните правой кнопкой мыши проект ContosoAdsWebJob в **обозревателе решений** и нажмите **Отладка** > **Запустить новый экземпляр**.

	Окно консоли приложения открывает и отображает сообщение для ведения журнала, указывающее начало выполнения объекта JobHost из WebJobs SDK.

	![Console application window showing that the backend is running](./media/websites-dotnet-webjobs-sdk-get-started/backendrunning.png)

2. В браузере нажмите кнопку **Создать рекламу**.

2. Введите тестовые данные, выберите изображение и нажмите кнопку **Создать**.

	![Create page](./media/websites-dotnet-webjobs-sdk-get-started/create.png)

	Приложение переходит к странице индексации, но не показывает эскиз для новой рекламы, поскольку индексирование еще не проводилось.

	В то же время после короткого ожидания в окне приложения консоли отобразится сообщение журнала, что сообщение очереди было получено и обработано.   

	![Console application window showing that a queue message has been processed](./media/websites-dotnet-webjobs-sdk-get-started/backendlogs.png)

3. После того, как вы увидите сообщения журнала в окне приложения консоли, обновите страницу индексов, чтобы увидеть эскиз.

	![Index page](./media/websites-dotnet-webjobs-sdk-get-started/list.png)

4. Щелкните **Сведения**, чтобы увидеть рекламу в полный размер.

	![Details page](./media/websites-dotnet-webjobs-sdk-get-started/details.png)

Вы запустили приложение на локальном компьютере, и оно использует базу данных SQL Server, расположенную на компьютере, но она работает с очередями и большими двоичными объектами в облаке. В следующем разделе вы запустите приложение в облаке с помощью облачной базы данных, а также облачных больших двоичных объектов и очередей.  

## <a id="runincloud"></a>Запуск приложения в облаке

Чтобы запустить приложение в облаке, выполните следующие действия:

* Развертывание на веб-сайте Azure. Visual Studio автоматически создаст новый веб-сайт Azure и экземпляр базы данных SQL.
* Настройка веб-сайта для использования базы данных SQL Azure и учетной записи хранения.

После создания рекламы во время работы в облаке вы просмотрите панель мониторинга SDK веб-заданий, чтобы увидеть предлагаемые обширные функции мониторинга.

### Развертывание на веб-сайте Azure

1. Закройте браузер и окно приложения консоли.

3. В **обозревателе решений** щелкните правой кнопкой мыши проект ContosoAdsWeb и нажмите **Опубликовать**.

3. На вкладке **Профиль** мастера **Публикация веб-сайта** щелкните **Веб-сайты Microsoft Azure**.

	![Select Azure Website publish target](./media/websites-dotnet-webjobs-sdk-get-started/pubweb.png)	

2. В поле **Выбор существующего веб-сайта** нажмите кнопку **Войти**.
 
	![Click Sign In](./media/websites-dotnet-webjobs-sdk-get-started/signin.png)	

5. После того, как вы выполните вход, нажмите кнопку "Создать".

	![Click New](./media/websites-dotnet-webjobs-sdk-get-started/clicknew.png)

9. В диалоговом окне **Создание сайта в Microsoft Azure** введите уникальное имя в поле **Имя сайта**.

	Полный URL-адрес будет состоять из того, что вы ввели, плюс .azurewebsites.net (как указано рядом с текстовым полем **Имя сайта**). Например, если имя сайта - ContosoAds, URL-адресом будет ContosoAds.azurewebsites.net.

9. В раскрывающемся списке **Регион** выберите тот же регион, который выбрали для учетной записи хранения.

	Этот параметр указывает, в каком центре обработки данных Azure будет запущен веб-сайт. Хранение веб-сайта и учетной записи хранения в одном центре обработки данных минимизирует задержку и стоимость исходящих данных.

9. В раскрывающемся списке **Сервер базы данных** нажмите кнопку **Создать сервер**.

	Если в подписке уже есть сервер, можно выбрать его в раскрывающемся списке.

1. Введите **Имя пользователя базы данных** и **Пароль базы данных** администратора. 

	Если выбрано действие **Создать сервер базы данных SQL**, не используйте здесь существующие имя и пароль, введите новые, которые в дальнейшем будут использоваться при обращении к базе данных. Если выбран созданный ранее сервер, появится запрос на ввод пароля для ранее созданной административной учетной записи.

1. Щелкните **Создать**.

	![Create site on Microsoft Azure dialog](./media/websites-dotnet-webjobs-sdk-get-started/newdb.png)	

	Visual Studio создает решение, веб-проект, веб-сайт Azure и экземпляр базы данных SQL Azure.

2. На этапе **Соединение** мастера **Публикация веб-сайта** нажмите кнопку **Далее**.

	![Connection step](./media/websites-dotnet-webjobs-sdk-get-started/connstep.png)	

3. На этапе **Параметры** снимите флажок **Использовать эту строку подключения в среде выполнения** и нажмите кнопку **Далее**.

	![Settings step](./media/websites-dotnet-webjobs-sdk-get-started/settingsstep.png)	
	
	Не нужно использовать диалоговое окно "Публикация", чтобы задать строку подключения SQL, поскольку это значение будет указано в среде Azure позже.

	Вы можете проигнорировать предупреждения на этой странице. 

	* Обычно учетная запись хранения, используемая при запуске Azure, отличается от той, которая используется при локальном запуске, но в этом учебнике для обеих сред используется одна учетная запись. Поэтому не требуется изменять строку подключения AzureWebJobsStorage. Даже если бы в облаке использовалась другая учетная запись хранения, строку подключения изменять не нужно, поскольку при запуске в Azure приложение будет использовать параметр среды Azure. Это будет показано позже в данном учебнике.

	* В этом учебнике не будут вноситься изменения в модель данных, использованную для базы данных ContosoAdsContext, поэтому для развертывания не нужно использовать Entity Framework Code First Migrations. Code First автоматически создаст новую базу данных при первой попытке приложения получить доступ к данным SQL.

	Для этого учебника подойдут значения по умолчанию в разделе **Параметры публикации файлов**. 

4. На этапе **Предварительный просмотр** нажмите кнопку **Начало предварительного просмотра**.

	![Click Start Preview](./media/websites-dotnet-webjobs-sdk-get-started/previewstep.png)	

	Вы можете проигнорировать предупреждение об отсутствии баз данных для публикации. Entity Framework Code First создаст базу данных, и ее не нужно публиковать.

	В окне предварительного просмотра отобразится, что двоичные файлы и файлы конфигурации из проекта веб-задания будут скопированы в папку *app_data\jobs\continuous* веб-сайта.

	![WebJobs files in preview window](./media/websites-dotnet-webjobs-sdk-get-started/previewwjfiles.png)	

5. Щелкните **Опубликовать**.

	Visual Studio развертывает приложение и открывает URL-адрес домашней страницы в браузере. 

	Вы не сможете использовать сайт, пока не зададите строки подключения в среде Azure в следующем разделе. Появится страница ошибки или домашняя страница в зависимости от выбранных ранее параметров создания сайта и базы данных. 

### Настройка веб-сайта для использования базы данных SQL Azure и учетной записи хранения.

В целях безопасности рекомендуется [не указывать конфиденциальную информацию, такую как строки подключения, в файлах, которые хранятся в репозиториях исходного кода](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets). Azure предоставляет следующую возможность: вы можете задать строку подключения и другие значения параметров в среде Azure, и API конфигурации ASP.NET автоматически выберут эти значения при запуске приложения в Azure. В этом разделе предстоит задать значения строк подключения в Azure.

7. В **обозревателе серверов** щелкните правой кнопкой мыши веб-сайт в узле **Веб-сайты** и щелкните **Просмотр параметров**.

	Окно **Веб-сайт Azure** открывается во вкладке **Настройка**.

9. Измените имя строки подключения DefaultConnection на ContosoAdsContext.

	Azure автоматически создала эту строку подключения, когда вы создали сайт со связанной базой данных, поэтому она автоматически содержит правильное значение строки подключения. Нужно только изменить имя на искомый код.

9. Добавьте две новые строки подключения с именами AzureWebJobsStorage и AzureWebJobsDashboard. Задайте "Пользовательский" тип и укажите для строки подключения то же значение, которое использовалось ранее для файлов *Web.config* и *App.config*. (Убедитесь, что включили всю строку подключения без кавычек, а не только ключ доступа.)

	Эти строки подключения используются пакетом WebJobs SDK: одна для данных приложения, а другая для ведения журнала. Как было показано ранее, строка подключения для данных приложения также используется кодом внешнего сервера.
	
9. Щелкните **Сохранить**.

	![Connection strings in management portal](./media/websites-dotnet-webjobs-sdk-get-started/azconnstr.png)

10. В **обозревателе серверов** щелкните правой кнопкой мыши веб-сайт, затем щелкните **Остановить веб-сайт**. 

12. После остановки веб-сайта щелкните снова правой кнопкой мыши веб-сайт, затем щелкните **Запуск веб-сайта**.

	Веб-задание запустится автоматически при публикации, но остановится при внесении изменений в конфигурацию. Перезапустить его можно перезапуском сайта или веб-задания на портале управления Azure. Обычно рекомендуется перезапускать сайт после изменения конфигурации. 

9. Обновите окно браузера, которое содержит URL-адрес сайта в адресной строке.

	Появится домашняя страница.

10. Создайте рекламу, как вы делали это при локальном запуске приложения.

	Сначала появится страница индексов без эскизов.

11.	Через несколько секунд обновите страницу, чтобы появился эскиз.

	Если эскиз не появляется, возможно, веб-задание не запустилось автоматически. В этом случае перейдите на вкладку WebJobs в 
 

### Просмотр панели мониторинга SDK веб-заданий

1. На [портале управления Azure](http://manage.windowsazure.com/) выберите свой веб-сайт.

2. Выберите вкладку **WebJobs**.

3. щелкните URL-адрес веб-задания в столбце "Журналы".

	![WebJobs tab](./media/websites-dotnet-webjobs-sdk-get-started/wjtab.png)

	На панели мониторинга WebJobs SDK откроется новая вкладка браузера. На панели мониторинга отобразится, что веб-задание запущено, и появится список функций в коде, активированных пакетом WebJobs SDK.

4. Щелкните одну из функций, чтобы увидеть сведения о ее выполнении 
 
	![WebJobs SDK dashboard](./media/websites-dotnet-webjobs-sdk-get-started/wjdashboardhome.png)	

	![WebJobs SDK dashboard](./media/websites-dotnet-webjobs-sdk-get-started/wjfunctiondetails.png)	

	Кнопка **Повторить функцию** на этой странице позволяет платформе WebJobs SDK повторно вызывать функцию и дает возможность изменить данные, изначально переданные в функцию.

>[WACOM.NOTE] По завершении тестирования удалите веб-сайт и экземпляр базы данных SQL. Веб-сайт бесплатен, но за экземпляр базы данных SQL и учетную запись хранения взимается плата (минимальная из-за мелкого размера). Также если оставить сайт работающим, любой кто найдет этот URL-адрес, сможет создать и просмотреть рекламу. На портале управления Azure перейдите на вкладку **Панель мониторинга** для веб-сайта и нажмите кнопку **Удалить** внизу страницы. Затем можно установить флажок, чтобы удалить экземпляр базы данных SQL. Если необходимо временно предотвратить доступ посторонних к сайту, вместо этого щелкните **Остановить**. В этом случае плата за базы данных SQL и учетную запись хранения продолжит взиматься. Можно повторить эту же процедуру для удаления базы данных SQL и учетной записи хранения, если они больше не нужны.

### Включите функцию AlwaysOn для длительных рабочих процессов

Для этого примера приложения работа веб-сайта всегда предшествует созданию очереди сообщений, поэтому не возникает проблемы, если веб-сайт переходит в спящий режим и прекращает работу веб-задания из-за длительного периода бездействия. При поступлении запроса сайт выходит из спящего режима и веб-задание перезапускается.

Используйте функцию [AlwaysOn](http://weblogs.asp.net/scottgu/archive/2014/01/16/windows-azure-staging-publishing-support-for-web-sites-monitoring-improvements-hyper-v-recovery-manager-ga-and-pci-compliance.aspx) на веб-сайтах Azure для продолжения выполнения веб-заданий при условии длительной неактивности веб-сайта.

## <a id="create"></a>Создание приложения с самого начала 

В этом разделе предстоит выполнить следующие задачи:

* Создание решения Visual Studio с веб-проектом.
* Добавление проекта библиотеки класса для уровня доступа данных, который совместно используется внешним и внутренним сервером.
* Добавление проекта приложения консоли для внутреннего сервера с включенным развертыванием веб-заданий.
* Добавление пакетов NuGet.
* Указание ссылок на проекты.
* Копирование кода приложения и файлов конфигурации из скачанного приложения, с которым вы работали в предыдущем разделе учебника.
* Просмотр фрагментов кода, которые работают с большими двоичными объектами и очередями Azure и пакетом SDK веб-заданий.
 
### Создание решения Visual Studio с веб-проектом и проектом библиотеки класса

1. В Visual Studio нажмите кнопку **Создать** > **Проект** в меню **Файл**.

2. В диалоговом окне **Новый проект** щелкните **Visual C#** > **Веб** > **Веб-приложение ASP.NET**.

3. Назовите проект ContosoAdsWeb, назовите решение ContosoAdsWebJobsSDK (измените имя решения, если планируете поместить его в ту же папку, что и скачанное решение), а затем нажмите кнопку **ОК**.

	![New Project](./media/websites-dotnet-webjobs-sdk-get-started/newproject.png)	

5. В диалоговом окне **Новый проект ASP.NET** выберите шаблон MVC и снимите флажок **Размещение в облаке** в **Microsoft Azure**.

	Параметр **Размещение в облаке** позволяет Visual Studio автоматически создать веб-сайт Azure и базу данных SQL. Поскольку вы уже создали их ранее, это не нужно делать при создании проекта. Если нужно создать новые, установите флажок. После этого можно настроить новый веб-сайт и базу данных SQL так же, как вы делали ранее при развертывании приложения.

5. Щелкните **Изменить проверку подлинности**.

	![Change Authentication](./media/websites-dotnet-webjobs-sdk-get-started/chgauth.png)	

7. В диалоговом окне **Изменение проверки подлинности** выберите **Без аутентификации** и нажмите кнопку **ОК**.

	![No Authentication](./media/websites-dotnet-webjobs-sdk-get-started/noauth.png)	

8. В диалоговом окне **Новый проект ASP.NET** нажмите кнопку **ОК**. 

	Visual Studio создаст решение и веб-проект.

9. В **обозревателе решений** щелкните правой кнопкой мыши решение (а не проект) и выберите **Добавить** > **Новый проект**.

11. В диалоговом окне **Добавление нового проекта** выберите шаблон **Visual C#** > **Рабочий стол Windows** > **Библиотека классов**.  

10. Присвойте проекту имя *ContosoAdsCommon* и нажмите кнопку **ОК**.

	Этот проект будет содержать контекст и модель данных Entity Framework, которые будут использовать внешний и внутренний сервер. Как вариант, можно определить связанные с EF классы в веб-проекте и сослаться на этот проект из проекта веб-задания. Но тогда проект веб-задания будет содержать ссылку на веб-сборки, которые ему не нужны.

### Добавление проекта приложения консоли, в котором включено развертывание веб-заданий

11. Щелкните правой кнопкой мыши проект (а не решение или проект библиотеки классов) и нажмите кнопку **Добавить** > **Новый проект веб-задания Azure**.

	![New Azure WebJob Project menu selection](./media/websites-dotnet-webjobs-sdk-get-started/newawjp.png)	

1. В диалоговом окне **Добавление веб-задания Azure** введите ContosoAdsWebJob в поля **Имя проекта** и **Имя веб-задания**. Оставьте в поле **Режим запуска веб-задания** значение **Запускать постоянно**.

2.  Нажмите кнопку **ОК**.
  
	Visual Studio создает приложение консоли, которое настроено для развертывания в качестве веб-задания при каждом развертывании веб-проекта. Для этого после создания проекта выполняются следующие задачи:

	* Добавляется файл *webjob-publish-settings.json* в папку Properties проекта веб-задания.
	* Добавляется файл *webjobs-list.json* в папку Properties веб-проекта.
	* Устанавливается пакет NuGet Microsoft.Web.WebJobs.Publish в проект веб-задания.
	 
	Дополнительные сведения об этих изменениях см. в разделе [Развертывание веб-заданий с помощью Visual Studio](/ru-ru/documentation/articles/websites-dotnet-deploy-webjobs/).

### Добавление пакетов NuGet

Шаблон нового проекта для проекта веб-задания автоматически устанавливает пакет WebJobs SDK NuGet [Microsoft.Azure.WebJobs](http://www.nuget.org/packages/Microsoft.Azure.WebJobs) и зависимости. 

Одна из зависимостей пакета SDK веб-заданий, которая автоматически устанавливается в проекте веб-задания, - клиентская библиотека хранения (SCL) Azure. Тем не менее ее необходимо добавить в веб-проект для работы с BLOB-объектами и очередями.

11. Откройте диалоговое окно **Управление пакетами NuGet** для решения.

12. В левой области выберите **Установленные пакеты**.
   
13. Найдите пакет *Azure Storage* и нажмите кнопку **Управление**.

13. В поле **Выбрать проекты** установите флажок **ContosoAdsWeb** и нажмите кнопку **ОК**. 

Все три проекта используют Entity Framework для работы с данными в базе данных SQL.

12. В левой области щелкните **В сети**.
   
16. Найдите пакет NuGet *EntityFramework* и установите его во все три проекта.


### Установите ссылки проекта

Как веб-проекты, так и проекты веб-заданий будут работать с базой данных SQL, поэтому для обоих нужна ссылка на проект ContosoAdsCommon.

10. Задайте в проекте ContosoAdsWeb ссылку на проект ContosoAdsCommon. (Щелкните правой кнопкой мыши проект ContosoAdsWeb и нажмите кнопку **Добавить** > **Ссылка**. В диалоговом окне **Диспетчер ссылок** выберите **Решение** > **Проекты** > **ContosoAdsCommon** и нажмите кнопку **ОК**.)

11. Задайте в проекте ContosoAdsWebJob ссылку на проект ContosoAdsCommon.

Для проекта веб-задания нужны ссылки для работы с изображениями и для доступа к строкам подключения.

11. В проекте ContosoAdsWebJob установите ссылку на System.Drawing и System.Configuration.

### Добавление кода и файлов конфигурации

В этом учебнике не указано следующее: [Создание контроллеров и представлений MVC с помощью формирования шаблонов](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started), [Запись кода Entity Framework, который работает с базами данных SQL Server](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc) или [Основы асинхронного программирования в ASP.NET 4.5](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async). Поэтому все, что нужно сделать, - скопировать код и файлы конфигурации из скачанного решения в новое. После этого в следующих разделах будут показаны и объяснены основные части кода.

Чтобы добавить файлы в проект или папку, щелкните правой кнопкой мыши проект или папку и щелкните **Добавить** > **Существующий элемент**. Выберите необходимые файлы и щелкните **Добавить**. При запросе о том, заменять ли существующие файлы, щелкните **Да**.

3. В проекте ContosoAdsCommon удалите файл *Class1.cs* и добавьте на его место следующие файлы из скачанного проекта.

	- *Ad.cs*
	- *ContosoAdscontext.cs*
	- *BlobInformation.cs*<br/><br/>

3. В проекте ContosoAdsCommon добавьте следующие файлы из загруженного проекта.

	- *Web.config*
	- *Global.asax.cs*  
	- В папке *Controllers*: *AdController.cs* 
	- В папке *Views\Shared*: файл <em>_Layout.cshtml</em>. 
	- В папке *Views\Home*: *Index.cshtml*. 
	- В папке *Views\Ad* (сначала создайте папку): пять файлов *.cshtml*.<br/><br/>

3. В проекте ContosoAdsWebJob добавьте следующие файлы из скачанного проекта.

	- *App.config* (измените фильтр типов файлов на **Все файлы**)
	- *Program.cs*
	- *Functions.cs*

Теперь вы можете создать, запустить и развернуть приложение, как показано ранее в этом учебнике. Однако перед этим остановите веб-задание, которое все еще выполняется на первом веб-сайте, на котором выполнено развертывание. В противном случае такое веб-задание обработает сообщения очереди, созданные локально или запущенные приложением на новом веб-сайте, поскольку все они используют одну учетную запись хранения.

## <a id="code"></a>Просмотр кода приложения

В следующих разделах объясняется код, связанный с работой с пакетом SDK веб-заданий и большими двоичными объектами и очередями хранилища Azure. Код, связанный с пакетом SDK веб-заданий, см. в разделе [Program.cs](#programcs).

### ContosoAdsCommon - Ad.cs

Файл Ad.cs определяет перечисляемый тип для класса Ad и класс сущностей POCO для информации в рекламе.

		Категория открытого перечисления
		{
		    Автомобили,
		    [Display(Name="Недвижимость")]
		    Недвижимость,
		    [Display(Name = "Бесплатные материалы")]
		    Бесплатные материалы
		}

		public class Ad
		{
		    public int AdId { get; set; }

		    [StringLength(100)]
		    public string Title { get; set; }

		    public int Price { get; set; }

		    [StringLength(1000)]
		    [DataType(DataType.MultilineText)]
		    public string Description { get; set; }

		    [StringLength(1000)]
		    [DisplayName("Full-size Image")]
		    public string ImageURL { get; set; }

		    [StringLength(1000)]
		    [DisplayName("Thumbnail")]
		    public string ThumbnailURL { get; set; }

		    [DataType(DataType.Date)]
		    [DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}", ApplyFormatInEditMode = true)]
		    public DateTime PostedDate { get; set; }

		    public Category? Category { get; set; }
		    [StringLength(12)]
		    public string Phone { get; set; }
		}

### ContosoAdsCommon - ContosoAdsContext.cs

Класс ContosoAdsContext указывает, что класс Ad используется коллекцией DbSet, которую Entity Framework хранит в базе данных SQL.

		public class ContosoAdsContext : DbContext
		{
		    public ContosoAdsContext() : base("name=ContosoAdsContext")
		    {
		    }
		    public ContosoAdsContext(string connString)
		        : base(connString)
		    {
		    }
		    public System.Data.Entity.DbSet<Ad> Ads { get; set; }
		}
 
Класс имеет два конструктора. Первый из них используется веб-проектом и указывает имя строки подключения, которая сохранена в файле Web.config или в среде выполнения Azure. Второй конструктор дает возможность передачи действующей строки подключения. Это необходимо проекту веб-задания, поскольку он не имеет файла Web.config. Ранее было показано, где хранится строка подключения, а потом будет показано, как код извлекает строку подключения, когда он создает экземпляр класса DbContext.

### ContosoAdsCommon - BlobInformation.cs

Класс BlobInformation используется для хранения информации о сообщении о большом двоичном объекте изображения в очереди.

		public class BlobInformation
		{
		    public Uri BlobUri { get; set; }
		    
		    public string BlobName
		    {
		        get
		        {
		            return BlobUri.Segments[BlobUri.Segments.Length - 1];
		        }
		    }
		    public string BlobNameWithoutExtension
		    {
		        get
		        {
		            return Path.GetFileNameWithoutExtension(BlobName);
		        }
		    }
		    public int AdId { get; set; }
		}


### ContosoAdsWeb - Global.asax.cs

Код, который вызывается из метода "Application_Start", создает контейнер большого двоичного объекта *images* и очередь *images*, если они еще не существуют. Это гарантирует, что при каждом использовании новой учетной записи хранения необходимый контейнер больших двоичных объектов и очередь будут создаваться автоматически.

Код получает доступ к учетной записи хранения, используя строку подключения хранилища из файла *Web.config* или среду выполнения Azure.

		var storageAccount = CloudStorageAccount.Parse
		    (ConfigurationManager.ConnectionStrings["AzureWebJobsStorage"].ToString());

Затем он получает ссылку на контейнер больших двоичных объектов *images*,создает контейнер, если он еще не существует, и устанавливает разрешения доступа к новому контейнеру. По умолчанию новые контейнеры разрешают доступ к большим двоичным объектам только клиентам с учетными данными записи хранилища. Веб-сайту требуются общедоступные большие двоичные объекты, чтобы он мог выводить изображения с использованием URL-адресов, которые указывают на объекты изображений.

		var blobClient = storageAccount.CreateCloudBlobClient();
		var imagesBlobContainer = blobClient.GetContainerReference("images");
		if (imagesBlobContainer.CreateIfNotExists())
		{
		    imagesBlobContainer.SetPermissions(
		        new BlobContainerPermissions
		        {
		            PublicAccess = BlobContainerPublicAccessType.Blob
		        });
		}

Аналогичный код получает ссылку на очередь *blobnamerequest* и создает новую очередь. В этом случае изменений разрешений не требуется. В разделе [ResolveBlobName](#resolveblobname) далее в этом учебнике объясняется, почему очередь, в которую выполняет запись веб-приложение, используется только для получения имен больших двоичных объектов, а не для создания эскизов.

		CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
		var imagesQueue = queueClient.GetQueueReference("blobnamerequest");
		imagesQueue.CreateIfNotExists();

### ContosoAdsWeb - _Layout.cshtml

Файл *_Layout.cshtml* устанавливает имя приложения в заголовке и нижнем колонтитуле и создает запись меню "Ads".

### ContosoAdsWeb - Views\Home\Index.cshtml

Файл *Views\Home\Index.cshtml* выводит ссылки категорий на домашней странице. Ссылки передают целое значение перечисляемого типа Category в переменную querystring на странице индекса Ads.
	
		<li>@Html.ActionLink("Cars", "Index", "Ad", new { category = (int)Category.Cars }, null)</li>
		<li>@Html.ActionLink("Real estate", "Index", "Ad", new { category = (int)Category.RealEstate }, null)</li>
		<li>@Html.ActionLink("Free stuff", "Index", "Ad", new { category = (int)Category.FreeStuff }, null)</li>
		<li>@Html.ActionLink("All", "Index", "Ad", null, null)</li>

### ContosoAdsWeb - AdController.cs

В файле *AdController.cs* file конструктор вызывает метод InitializeStorage для создания объектов клиентской библиотеки хранилища Azure, который предоставляет API для работы с большими двоичными объектами и очередями. 

Затем код получает ссылку на контейнер больших двоичных объектов *images*, как показано ранее в *Global.asax.cs*. При этом он устанавливает [политику повторения](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling) по умолчанию, подходящую для веб-приложения. Политика повторения с экспоненциальной задержкой по умолчанию может застопорить веб-приложение более чем на минуту при повторяющихся повторах во время кратковременного сбоя. Политика повторения здесь указывает ожидание в 3 секунды после каждой попытки, всего до 3 повторений.

		var blobClient = storageAccount.CreateCloudBlobClient();
		blobClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
		imagesBlobContainer = blobClient.GetContainerReference("images");

Аналогичный код получает ссылку на очередь *images*.

		CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
		queueClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
		imagesQueue = queueClient.GetQueueReference("blobnamerequest");

Большая часть кода контроллера обычна для работы с моделью данных Entity Framework с использованием класса DbContext. Исключением является метод Create HttpPost, который отправляет файл и сохраняет его в хранилище больших двоичных объектов. Связыватель модели предоставляет объект [HttpPostedFileBase](http://msdn.microsoft.com/ru-ru/library/system.web.httppostedfilebase.aspx) для метода.

		[HttpPost]
		[ValidateAntiForgeryToken]
		public async Task<ActionResult> Create(
		    [Bind(Include = "Title,Price,Description,Category,Phone")] Ad ad,
		    HttpPostedFileBase imageFile)

При выбора файла для отправки код отправляет его, сохраняет его в большом двоичном объекте и обновляет запись базы данных URL-адресом, который указывает на большой двоичный объект.

		if (imageFile != null && imageFile.ContentLength != 0)
		{
		    blob = await UploadAndSaveBlobAsync(imageFile);
		    ad.ImageURL = blob.Uri.ToString();
		}

Код отправки содержится в методе UploadAndSaveBlobAsync. Он создает имя GUID для большого двоичного объекта, отправляет и сохраняет файл, а также возвращает ссылку на сохраненный большой двоичный объект.

		private async Task<CloudBlockBlob> UploadAndSaveBlobAsync(HttpPostedFileBase imageFile)
		{
		    string blobName = Guid.NewGuid().ToString() + Path.GetExtension(imageFile.FileName);
		    CloudBlockBlob imageBlob = imagesBlobContainer.GetBlockBlobReference(blobName);
		    using (var fileStream = imageFile.InputStream)
		    {
		        await imageBlob.UploadFromStreamAsync(fileStream);
		    }
		    return imageBlob;
		}

После того как метод Create HttpPost отправляет большой двоичный объект и обновляет базу данных, он создает сообщение в очереди для информирования фонового процесса о том, что изображение готово для конвертации в эскиз.

		BlobInformation blobInfo = new BlobInformation() { AdId = ad.AdId, BlobUri = new Uri(ad.ImageURL) };
		var queueMessage = new CloudQueueMessage(JsonConvert.SerializeObject(blobInfo));
		await thumbnailRequestQueue.AddMessageAsync(queueMessage);

Код для метода Edit HttpPost аналогичен за одним исключением - если пользователь выбирает новый файл изображения, все большие двоичные объекты, которые уже существуют для этой рекламы, должны быть удалены.
 
		if (imageFile != null && imageFile.ContentLength != 0)
		{
		    await DeleteAdBlobsAsync(ad);
		    imageBlob = await UploadAndSaveBlobAsync(imageFile);
		    ad.ImageURL = imageBlob.Uri.ToString();
		}

Вот код, который удаляет большие двоичные объекты при удалении элемента рекламы:

		private async Task DeleteAdBlobsAsync(Ad ad)
		{
		    if (!string.IsNullOrWhiteSpace(ad.ImageURL))
		    {
		        Uri blobUri = new Uri(ad.ImageURL);
		        await DeleteAdBlobAsync(blobUri);
		    }
		    if (!string.IsNullOrWhiteSpace(ad.ThumbnailURL))
		    {
		        Uri blobUri = new Uri(ad.ThumbnailURL);
		        await DeleteAdBlobAsync(blobUri);
		    }
		}
		private static async Task DeleteAdBlobAsync(Uri blobUri)
		{
		    string blobName = blobUri.Segments[blobUri.Segments.Length - 1];
		    CloudBlockBlob blobToDelete = imagesBlobContainer.GetBlockBlobReference(blobName);
		    await blobToDelete.DeleteAsync();
		}
 
### ContosoAdsWeb - Views\Ad\Index.cshtml и Details.cshtml

Файл *Index.cshtml* выводит эскиз с другими данными рекламы:

		<img  src="@Html.Raw(item.ThumbnailURL)" />

Файл *Details.cshtml* выводит изображение в полном размере:

		<img src="@Html.Raw(Model.ImageURL)" />

### ContosoAdsWeb - Views\Ad\Create.cshtml и Edit.cshtml

Файлы *Create.cshtml* и *Edit.cshtml* указывают кодировку, которая позволяет контроллеру получить объект HttpPostedFileBase.

		@using (Html.BeginForm("Create", "Ad", FormMethod.Post, new { enctype = "multipart/form-data" }))

Элемент <input> сообщает браузеру, что нужно открыть диалоговое окно выбора файла.

		<input type="file" name="imageFile" accept="image/*" class="form-control fileupload" />

### <a id="programcs"></a>ContosoAdsWebJob - Program.cs

При запуске веб-задания метод Main вызывает Initialize для создания экземпляра контекста базы данных Entity Framework. Затем он вызывает метод JobHost.RunAndBlock пакета SDK веб-заданий, чтобы начать однопотоковое выполнение активированных функций в текущем потоке.

		static void Main(string[] args)
		{
		    Initialize();
		
		    JobHost host = new JobHost();
		    host.RunAndBlock();
		}
		
		private static void Initialize()
		{
		    db = new ContosoAdsContext();
		}

### <a id="generatethumbnail"></a>ContosoAdsWebJob - Functions.cs - GenerateThumbnail method

Пакет WebJobs SDK вызывает этот метод при получении сообщения очереди. Метод создает эскиз и помещает URL-адрес эскиза в базу данных.

		public static void GenerateThumbnail(
		[QueueTrigger("thumbnailrequest")] BlobInformation blobInfo,
		[Blob("images/{BlobName}", FileAccess.Read)] Stream input,
		[Blob("images/{BlobNameWithoutExtension}_thumbnail.jpg"), FileAccess.Write] CloudBlockBlob outputBlob)
		{
		    using (Stream output = outputBlob.OpenWrite())
		    {
		        ConvertImageToThumbnailJPG(input, output);
		        outputBlob.Properties.ContentType = "image/jpeg";
		    }
		
		    var id = blobInfo.AdId;
		    Ad ad = Program.db.Ads.Find(id);
		    if (ad == null)
		    {
		        throw new Exception(String.Format("AdId {0} not found, can't create thumbnail", id.ToString()));
		    }
		    ad.ThumbnailURL = outputBlob.Uri.ToString();
		    Program.db.SaveChanges();
		}

* Атрибут QueueTrigger указывает пакету WebJobs SDK вызвать этот метод при получении нового сообщения в очереди запросов эскизов.

		[QueueTrigger("thumbnailrequest")] BlobInformation blobInfo,

	Объект BlobInformation в сообщении очереди автоматически десериализируется в параметр blobInfo. По завершении метода сообщение очереди удаляется. Если происходит сбой метода до его завершения, сообщение очереди не удаляется. После истечения 10-минутного срока действия аренды сообщение передается для повторной обработки. Если сообщение вызывает исключение, эта последовательность не будет повторяться бесконечно. После 5 неудачных попыток обработать сообщение, оно будет перемещено в очередь с именем {queuename}-poison. Можно настроить максимальное количество попыток. 

* Два атрибута Blob предоставляют объекты, которые привязаны к большим двоичным объектам: один к существующему большому двоичному объекту изображения, а другой к новому большому двоичному объекту эскиза, который создает метод. 

		[Blob("images/{BlobName}", FileAccess.Read)] Stream input,
		[Blob("images/{BlobNameWithoutExtension}_thumbnail.jpg")] CloudBlockBlob outputBlob)

	Имена больших двоичных объектов берутся из свойств объекта BlobInformation, полученных в сообщении очереди (BlobName и BlobNameWithoutExtension). Чтобы получить все функции клиентской библиотеки хранилища, можно использовать класс CloudBlockBlob для работы с большими двоичными объектами. Если вы хотите повторно использовать код, написанный для работы с объектами Stream, можно использовать класс Stream. 

>[WACOM.NOTE] 
>* Если ваш веб-сайт работает на нескольких виртуальных машинах, эта программа запустится на каждой машине и каждая машина будет ожидать триггеров и попытки запустить функции. В некоторых сценариях это может привести к тому, что некоторые функции обработают часть данных дважды, поэтому функции должны быть идемпотентными (написанными так, что постоянный их вызов с одинаковыми входными данными не создаст дублирующиеся результаты).
>* Сведения о нормальном завершении работы см. в разделе [Нормальное завершение работы](../websites-dotnet-webjobs-sdk-storage-queues-how-to/#graceful).   
>* Для простоты код в методе ConvertImageToThumbnailJPG (не показан) использует классы в пространстве имен System.Drawing. Однако классы в этом пространстве имен были спроектированы для использования с формами Windows. Они не поддерживаются в службе Windows или ASP.NET.

### Сравнение WebJobs SDK и рабочей роли облачной службы без WebJobs SDK

Если сравнить объем кода в методе GenerateThumbnails в этом примере приложения с кодом рабочей роли в [версии облачной службы приложения](/ru-ru/documentation/articles/cloud-services-dotnet-get-started/), можно увидеть, сколько пакет WebJobs SDK выполняет автоматически. Преимуществ больше, чем кажется, поскольку код примера приложения облачной службы не выполняет всего (например, обработку сообщений о сбоях), что требуется в рабочем приложении, в отличие от пакета WebJobs SDK.

В версии облачной службы приложения идентификатор записи - это единственная информация в сообщении очереди, а фоновый процесс получает URL-адрес изображения базы данных. В версии WebJobs SDK приложения сообщение очереди включает URL-адрес изображения так, что его невозможно предоставить атрибутам Blob. Если сообщение очереди не содержало URL-адрес больших двоичных объектов, вы можете [использовать атрибут больших двоичных объектов в теле метода, а не в подписи метода](../websites-dotnet-webjobs-sdk-storage-queues-how-to/#blobbody).

### Использование пакета SDK веб-заданий вне сферы применения веб-заданий

Программа, которая использует пакет WebJobs SDK, не должна запускаться в Azure в веб-задании. Ее можно запустить локально, а также в другой среде, например в рабочей роли облачной службы или службы Windows. Однако доступ к панели мониторинга SDK веб-заданий можно получить только на веб-сайте Azure. Чтобы использовать панель мониторинга, необходимо подключить веб-сайт к используемой учетной записи хранения, задав строку подключения AzureWebJobsDashboard на вкладке **Настройка** портала управления. Затем можно перейти на панель мониторинга по URL-адресу https://{websitename}.scm.azurewebsites.net/azurejobs/#/functions. Дополнительные сведения см. в разделе [Получение панели мониторинга для локальной разработки с помощью пакета SDK веб-заданий](http://blogs.msdn.com/b/jmstall/archive/2014/01/27/getting-a-dashboard-for-local-development-with-the-webjobs-sdk.aspx), но обратите внимание, что она отображает имя старой строки подключения. 

## Дальнейшие действия

В этом учебнике было показано простое многоуровневое приложение, которое использует пакет WebJobs SDK для внутренней обработки. Приложение намеренно сделано простым, поскольку это учебник для начинающих. Например, оно не реализует [вставку зависимостей](http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection) или [репозиторий и блок рабочих шаблонов](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo), не [использует интерфейс для журналов](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log), не использует [EF Code First Migrations](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application) для управления изменениями модели данных или [EF Connection Resiliency](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application) для управления кратковременными ошибками сети и т. д.

Дополнительные сведения см. в разделе [Рекомендуемые ресурсы для веб-заданий Azure](http://go.microsoft.com/fwlink/?LinkId=390226).
