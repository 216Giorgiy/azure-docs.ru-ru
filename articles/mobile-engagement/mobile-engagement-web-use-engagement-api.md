<properties
	pageTitle="Интерфейсы API веб-пакета SDK для Azure Mobile Engagement | Microsoft Azure"
	description="Последние обновления и процедуры для веб-пакета SDK для Azure Mobile Engagement."
	services="mobile-engagement"
	documentationCenter="mobile"
	authors="piyushjo"
	manager="erikre"
	editor="" />

<tags
	ms.service="mobile-engagement"
	ms.workload="mobile"
	ms.tgt_pltfrm="web"
	ms.devlang="js"
	ms.topic="article"
	ms.date="06/07/2016"
	ms.author="piyushjo" />

# Как использовать API Engagement в веб-приложении

Этот документ представляет собой приложение к документу [Как интегрировать Engagement в веб-приложение](mobile-engagement-web-integrate-engagement.md). В нем рассказывается о том, как с помощью Engagement API предоставлять статистику по приложению.

API Engagement предоставляется объектом `engagement.agent`. `engagement` — псевдоним по умолчанию пакета SDK для Engagement, который можно переопределить в конфигурации пакета SDK.

## Основные понятия Engagement

В следующих подразделах дано более подробное объяснение [основных понятий Mobile Engagement](mobile-engagement-concepts.md) для веб-платформы.

### `Session` и `Activity`

Если пользователь неактивен между двумя *действиями* больше чем несколько секунд, то последовательность его *действий* разбивается на два отдельных *сеанса*. Эти несколько секунд называются *время ожидания сеанса*.

Если веб-приложение не объявит завершение действия пользователя (путем вызова функции `engagement.agent.endActivity`), то сервер Engagement автоматически завершит сеанс пользователя через три минуты после закрытия страницы приложения. Такое поведение называется *временем ожидания сеанса* сервера.

### `Crash`

Отчет о неперехваченных исключениях JavaScript не создается автоматически. Тем не менее можно сообщать о сбоях вручную с помощью функции `sendCrash` (см. ниже).

## Уведомление о действиях

### Запуск нового действия пользователем

	engagement.agent.startActivity("MyUserActivity");

При каждом изменении пользовательского действия необходимо вызывать `startActivity()`. При первом вызове этой функции начинается новый сеанс пользователя.

### Завершение текущего действия пользователем

	engagement.agent.endActivity();

Необходимо вызвать `endActivity()` как минимум один раз, когда пользователь заканчивает свое последнее действие. В результате пакет SDK для Engagement получает информацию о том, что пользователь неактивен и его сеанс необходимо закрыть после истечения времени ожидания (если вызов `startActivity()` сделан до этого момента, то сеанс просто возобновляется).

Часто бывает сложно или невозможно перехватить завершение действий пользователя внутри веб-сред (нет надежного вызова при закрытии окна навигатора). Поэтому сервер Engagement автоматически завершает срок действия сеанса пользователя через три минуты после закрытия страницы приложения.

## Уведомление о событиях

### События сеанса

События сеанса обычно используются для уведомления о действиях, выполняемых пользователем во время сеанса.

**Пример без дополнительных данных:**

	loginButton.onclick = function() {
	  engagement.agent.sendSessionEvent('login');
	  // [...]
	}

**Пример с дополнительными данными:**

	loginButton.onclick = function() {
	  engagement.agent.sendSessionEvent('login', {user: 'alice'});
	  // [...]
	}

### Изолированные события

В отличие от событий сеанса изолированные события могут происходить вне контекста сеанса.

Для этого используйте ``engagement.agent.sendEvent`` вместо ``engagement.agent.sendSessionEvent``.

## Уведомление об ошибках

### Ошибки сеанса

Ошибки сеанса обычно используются для уведомления об ошибках, влияющих на пользователя во время сеанса.

**Пример без дополнительных данных:**

	var validateForm = function() {
	  // [...]
	  if (password.length < 6) {
	    engagement.agent.sendSessionError('password_too_short');
	  }
	  // [...]
	}

**Пример с дополнительными данными:**

	var validateForm = function() {
	  // [...]
	  if (password.length < 6) {
	    engagement.agent.sendSessionError('password_too_short', {length: 4});
	  }
	  // [...]
	}

### Изолированные ошибки

В отличие от ошибок сеанса изолированные ошибки могут возникать вне контекста сеанса.

Для этого используйте `engagement.agent.sendError` вместо `engagement.agent.sendSessionError`.

## Уведомление о заданиях

### Пример

Предположим, что необходим мониторинг запроса AJAX.
			
	// [...]
	xhr.onreadystatechange = function() {
	  if (xhr.readyState == 4) {
	  // [...]
	    engagement.agent.endJob('publish');
	  }
	}
	engagement.agent.startJob('publish');
	xhr.send();
	// [...]

### Уведомление об ошибках при выполнении задания

Ошибки могут быть связаны с выполняемым заданием, а не с текущим сеансом пользователя.

**Пример**

Предположим, что нужно сообщить об ошибке в случае сбоя запроса AJAX.

	// [...]
	xhr.onreadystatechange = function() {
	  if (xhr.readyState == 4) {
	    // [...]
	    if (xhr.status == 0 || xhr.status >= 400) {
	      engagement.agent.sendJobError('publish_xhr', 'publish', {status: xhr.status, statusText: xhr.statusText});
	    }
	    engagement.agent.endJob('publish');
	  }
	}
	engagement.agent.startJob('publish');
	xhr.send();
	// [...]

### Отчеты о событиях во время выполнения задания

События могут быть связаны с выполняемым заданием, а не с текущим сеансом пользователя, благодаря функции `engagement.agent.sendJobEvent`.

Эта функция работает в точности как `engagement.agent.sendJobError`.

### Сбои отчетов

Функция `sendCrash` используется для уведомления о сбоях вручную.

Аргумент `crashid` — это строка, используемая для идентификации типа сбоя. Аргументом `crash` обычно является трассировка стека сбоя в виде строки.

	engagement.agent.sendCrash(crashid, crash);

## Дополнительные параметры

Произвольные данные можно прикрепить к событию, ошибке, действию или заданию.

Данные могут быть любым объектом JSON (не массивом или простыми типами).

**Пример**

	var extras = {"video_id": 123, "ref_click": "http://foobar.com/blog"};
	engagement.agent.sendEvent("video_clicked", extras);

### Ограничения

#### ключей

Каждый ключ в объекте должен соответствовать следующему регулярному выражению:

	^[a-zA-Z][a-zA-Z_0-9]*

Это означает, что ключ должен содержать не менее одной буквы, за которой следуют буквы, цифры или символы подчеркивания (\_).

#### Значения

Допустимые типы значений: строка, число и логическое значение.

#### Размер

Дополнительные данные ограничены **1024** знаками на один вызов (после кодирования в JSON пакетом SDK).

## Уведомление о данных приложения

С помощью функции `sendAppInfo()` вы можете вручную сообщать о данных отслеживания (или любых других данных о приложении).

Обратите внимание, что такие данные можно отправлять поэтапно, так как для заданного устройства будет сохраняться только последнее значение заданного ключа.

Как и дополнительные данные события, любой объект JSON можно использовать для получения абстрактных сведений о приложении. Отметим, что массивы или вложенные объекты будут считаться плоскими строками (с использованием сериализации JSON).

### Пример

Ниже приведен пример кода для отправки пола и даты рождения пользователя.

	var appInfos = {"birthdate":"1983-12-07","gender":"female"};
	engagement.agent.sendAppInfo(appInfos);

### Ограничения

#### ключей

Каждый ключ в объекте должен соответствовать следующему регулярному выражению:

	^[a-zA-Z][a-zA-Z_0-9]*

Это означает, что ключ должен содержать не менее одной буквы, за которой следуют буквы, цифры или символы подчеркивания (\_).

#### Размер

Сведения о приложении ограничены **1024** знаками на один вызов (после кодирования в JSON пакетом SDK).

В предыдущем примере длина JSON-файла, отправленного на сервер, составляет 44 знака:

	{"birthdate":"1983-12-07","gender":"female"}
 

<!---HONumber=AcomDC_0615_2016-->