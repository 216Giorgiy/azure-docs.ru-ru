<properties linkid="manage-windows-common-task-upload-vhd" urlDisplayName="Загрузка VHD" pageTitle="Создайте и загрузите VHD Windows Server в Windows Azure" metaKeywords="Azure VHD, загрузка VHD" description="Узнать, как создать и загрузить виртуальный жесткий диск (VHD) в Windows Azure с операционной системой Windows Server." metaCanonical="" services="virtual-machines" documentationCenter="" title="Создание и загрузка виртуального жесткого диска, содержащего операционную систему Windows Server" authors=""  solutions="" writer="kathydav" manager="jeffreyg" editor="tysonn"  />





#Создание и загрузка виртуального жесткого диска с операционной системой Windows Server #

Виртуальная машина в Windows Azure работает под управлением операционной системы, выбранной при создании виртуальной машины. Windows Azure хранит операционную систему виртуальной машины на виртуальном жестком диске в формате VHD (файл VHD). Виртуальный жесткий диск операционной системы, который был подготовлен к дублированию, называется образом. В этой статье показано, как создать собственный образ путем загрузки файла VHD с установленной и обобщенной операционной системой. Дополнительные сведения о дисках и образах в Windows Azure см. в разделе [Управление дисками и образами](http://msdn.microsoft.com/ru-ru/library/windowsazure/jj672979.aspx).

**Примечание**. При создании виртуальной машины можно настроить параметры операционной системы для оптимизации выполняемого приложения. Заданная конфигурация хранится на диске для данной виртуальной машины. Инструкции см. в разделе [Создание настраиваемой виртуальной машины](/ru-ru/manage/windows/how-to-guides/custom-create-a-vm/).

##Предварительные требования##
В данной статье предполагается, что у вас есть следующие элементы:

**Сертификат управления**. Вы создали сертификат управления для подписки, для которой требуется загрузить VHD, а также экспортировали сертификат в файл CER. Дополнительные сведения о создании сертификатов см. в разделе [Создание сертификата управления в Windows Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/gg551722.aspx). 

**Поддерживаемая операционная система хранится в файле VHD**. Вы установили поддерживаемую операционную систему Windows Server на виртуальный жесткий диск. Существует несколько средств для создания файлов VHD. Для создания файла VHD и установки операционной системы можно использовать решения для виртуализации, например Hyper-V. Инструкции см. в разделе [Установка роли Hyper-V и настройка виртуальной машины](http://technet.microsoft.com/ru-ru/library/hh846766.aspx).

**Важно**! Более новый формат VHDX не поддерживается в Windows Azure. Можно преобразовать диск в формат VHD с помощью диспетчера Hyper-V или командлет convert-vhd.     
 
- **Носитель с операционной системой Windows Server.** Для выполнения этой задачи требуется файл ISO, содержащий операционную систему Windows Server. Поддерживаются следующие версии Windows Server:
<P>
  <TABLE BORDER="1" WIDTH="600">
  <TR BGCOLOR="#E9E7E7">
    <TH>ОС</TH>
    <TH>SKU</TH>
    <TH>Пакет обновления</TH>
    <TH>Архитектура</TH>
  </TR>
  <TR>
    <TD>Windows Server 2012</TD>
    <TD>Все выпуски</TD>
    <TD>Недоступно</TD>
    <TD>x64</TD>
  </TR>
  <TR>
    <TD>Windows Server 2008 R2</TD>
    <TD>Все выпуски</TD>
    <TD>SP1</TD>
    <TD>x64</TD>
  </TR>
  </TABLE>
</P>

- Командлет [Add-AzureVHD](http://msdn.microsoft.com/ru-ru/library/windowsazure/dn205185.aspx), который является частью модуля PowerShell Windows Azure. Сведения о загрузке модуля см. в разделе [Загрузки Windows Azure](/ru-ru/develop/downloads/).


Эта задача включает следующие шаги:

- [Шаг 1. Подготовка образа для загрузки] []
- [Шаг 2. Создание учетной записи хранения в Windows Azure] []
- [Шаг 3. Подготовка подключения к Windows Azure] []
- [Шаг 4. Загрузка файла VHD] []

## <a id="prepimage"> </a>Шаг 1. Подготовка образа для загрузки ##

Перед загрузкой образа в Windows Azure его необходимо обобщить с помощью команды Sysprep. Дополнительные сведения об использовании Sysprep см. в разделе [Как использовать Sysprep: введение](http://technet.microsoft.com/ru-ru/library/bb457073.aspx).

В только что созданной виртуальной машине выполните следующие действия:

1. Войдите в операционную систему.

2. Откройте окно командной строки с правами администратора. Измените каталог на **%windir%\system32\sysprep** и выполните команду `sysprep.exe`.

	![Откройте окно командной строки](./media/virtual-machines-create-upload-vhd-windows-server/sysprepcommand.png)

3.	Откроется диалоговое окно **Программа подготовки системы**.

	![Запустите Sysprep](./media/virtual-machines-create-upload-vhd-windows-server/sysprepgeneral.png)

4. В разделе **Действие по очистке системы** выберите **Запуск при первом включении компьютера (OOBE)** и убедитесь, что установлен флажок **Обобщить**.

5. В разделе **Параметры завершения работы** выберите **Завершение работы**.

6. Нажмите кнопку **ОК**.


## <a id="createstorage"> </a>Шаг 2. Создание учетной записи хранения в Windows Azure ##

Учетная запись хранения представляет собой высший уровень пространства имен для доступа к службам хранения; эта запись связана с вашей подпиской Windows Azure. Для загрузки в Windows Azure файла VHD, который можно использовать для создания виртуальной машины, потребуется учетная запись хранения в Windows Azure. Для создания учетной записи хранения можно использовать портал управления Windows Azure.

1. Выполните вход на портал управления Windows Azure.

2. На панели команд нажмите **Создать**.

3. Нажмите **Учетная запись хранения**, а затем **Быстрое создание**.

	![Быстрое создание учетной записи хранения](./media/virtual-machines-create-upload-vhd-windows-server/Storage-quick-create.png)

4. Заполните поля, как показано ниже:

	![Введите сведения об учетной записи хранения](./media/virtual-machines-create-upload-vhd-windows-server/Storage-create-account.png)

- В **URL-адрес** введите имя дочернего домена, используемое в URL для учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это имя становится именем узла в URL, который используется для адресации ресурсов BLOB-объекта, очереди и таблицы для подписки.
	
- Выберите расположение или территориальную группу для учетной записи хранения. Указав территориальную группу, можно выполнить совместное размещение облачных служб в одном центре обработки данных с хранилищем.
 
- Укажите, следует ли использовать георепликацию для учетной записи хранения. По умолчанию георепликация включена. Этот параметр позволяет бесплатно выполнять репликацию данных в дополнительное местоположение; таким образом в случае аварийного отказа, который не может быть устранен в основном местоположении, хранилище переключится на дополнительное местоположение. Дополнительное местоположение назначается автоматически и не может быть изменено. Если в соответствии с законодательными требованиями или организационной политикой требуется более жесткий контроль местоположения облачного хранилища, то георепликацию можно отключить. Однако следует помнить, что если вы опять включите георепликацию, с вас будет взята однократная плата за репликацию существующих данных в дополнительное местоположение. Службы хранения без георепликации предлагаются со скидкой.

5. Щелкните **Создать учетную запись хранения**.

	Учетная запись появится в списке **учетных записей хранения**.

	![Учетная запись хранилища успешно создана](./media/virtual-machines-create-upload-vhd-windows-server/Storagenewaccount.png)


## <a id="PrepAzure"> </a>Шаг 3. Подготовка подключения к Windows Azure ##

Перед загрузкой файла VHD необходимо установить безопасное соединение между компьютером и вашей подпиской в Windows Azure. 

1. Откройте окно PowerShell для Windows Azure.

2. Тип: 

	`Get-AzurePublishSettingsFile`

	Эта команда открывает окно браузера и автоматически загружает файл .publishsettings, содержащий информацию и сертификат для подписки Windows Azure. 

3. Сохраните файл .publishsettings. 

4. Тип:

	`Import-AzurePublishSettingsFile <PathToFile>`

	Где "<PathToFile>" — это полный путь к файлу .publishsettings. 

	Дополнительные сведения см. в разделе [Начало работы с командлетами Windows Azure](http://msdn.microsoft.com/ru-ru/library/windowsazure/jj554332.aspx) 


## <a id="upload"> </a>Шаг 4. Загрузка файла VHD ##

При загрузке файла VHD его можно поместить в любом месте внутри хранилища blob. В приведенных ниже примерах команд **BlobStorageURL** — это URL-адрес для учетной записи хранения, созданный при выполнении шага 2, **YourImagesFolder** — это контейнер внутри хранилища BLOB-данных, где будут храниться образы. **VHDName** — это метка, которая отображается в портале управления для идентификации виртуального жесткого диска. **PathToVHDFile** — это полный путь и имя файла VHD. 

1. В окне Windows Azure PowerShell, использованном при выполнении предыдущего шага, наберите:

	`Add-AzureVhd -Destination <BlobStorageURL>/<YourImagesFolder>/<VHDName> -LocalFilePath <PathToVHDFile>`

	Дополнительные сведения см. в разделе [Add-AzureVhd](http://msdn.microsoft.com/ru-ru/library/windowsazure/dn205185.aspx).

##Добавьте образ в список пользовательских образов ##
После загрузки файла VHD его можно добавить в качестве образа в список пользовательских образов, связанных с подпиской.

1. На портале управления в разделе **Все элементы** нажмите **Виртуальные машины**.

2. В разделе Виртуальные машины нажмите **Образы**, а затем нажмите **Создать**.

3. В разделе **Создать образ на основе VHD** укажите имя и URL-адрес загруженного файла VHD.

4. Отметьте пункт **Я выполнил Sysprep на виртуальной машине, связанной с этим VHD**, чтобы подтвердить обобщение операционной системы при выполнении шага 2, а затем нажмите **ОК**. 


## Следующие шаги ##
После добавления образа в список его можно использовать для создания виртуальных машин. Инструкции см. в разделе [Создание виртуальной машины под управлением Windows Server](../virtual-machines-windows-tutorial/).

[Шаг 1. Подготовка образа для загрузки]: #prepimage
[Шаг 2. Создание учетной записи хранения в Windows Azure]: #createstorage
[Шаг 3. Подготовка подключения к Windows Azure]: #prepAzure
[Шаг 4. Загрузка файла VHD]: #upload





