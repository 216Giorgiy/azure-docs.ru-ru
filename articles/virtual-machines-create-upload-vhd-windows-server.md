<properties urlDisplayName="Upload a VHD" pageTitle="Создание и передача виртуального жесткого диска Windows Server в Azure" metaKeywords="Azure VHD, uploading VHD" description="Узнайте, как создать и передать виртуальный жесткий диск с операционной системой Windows Server в Azure." metaCanonical="" services="virtual-machines" documentationCenter="" title="Создание и передача виртуального жесткого диска Windows Server в Azure" authors="kathydav" solutions="" manager="timlt" editor="tysonn" />

<tags ms.service="virtual-machines" ms.workload="infrastructure-services" ms.tgt_pltfrm="vm-windows" ms.devlang="na" ms.topic="article" ms.date="09/23/2014" ms.author="kathydav" />

# Создание и передача виртуального жесткого диска Windows Server в Azure

В этой статье показано, как передать виртуальный жесткий диск с операционной системой, чтобы использовать его в качестве образа для создания виртуальных машин. Дополнительную информацию о дисках и образах в Microsoft Azure см. в разделе [Диски и образы в Azure][Диски и образы в Azure].

**Примечание**. При создании виртуальной машины можно настроить параметры операционной системы, чтобы оптимизировать выполняемое приложение. Заданная конфигурация хранится на диске для данной виртуальной машины. Инструкции см. в разделе [Создание настраиваемой виртуальной машины][Создание настраиваемой виртуальной машины].

## Предварительные требования

В данной статье предполагается, что у вас есть следующие элементы:

**Подписка Azure** — если ее нет, можно создать бесплатную пробную учетную запись всего за несколько минут. Подробную информацию см. в разделе [Создание учетной записи Azure][Создание учетной записи Azure].

**Microsoft Azure PowerShell** — у вас установлен модуль Microsoft Azure PowerShell. Информацию о скачивании модуля см. в разделе [Загрузки Microsoft Azure][Загрузки Microsoft Azure]. Учебник по установке и настройке PowerShell с подпиской Azure можно найти [здесь][здесь].

-   Командлет [Add-AzureVHD][Add-AzureVHD], который является частью модуля Microsoft Azure PowerShell. Воспользуйтесь этим командлетом для передачи виртуального жесткого диска (VHD).

**Поддерживаемая операционная система хранится в файле VHD**. Вы установили поддерживаемую операционную систему Windows Server на виртуальный жесткий диск. Существует несколько средств для создания VHD-файлов. Для создания файла VHD и установки операционной системы можно использовать решения для виртуализации, например Hyper-V. Инструкции см. в разделе [Установка роли Hyper-V и настройка виртуальной машины][Установка роли Hyper-V и настройка виртуальной машины].

**Важно!** Формат VHDX не поддерживается в Microsoft Azure. Можно преобразовать диск в формат VHD с помощью диспетчера Hyper-V или командлета [Convert-VHD][Convert-VHD]. Учебник по этому действию можно найти [здесь][1].

**Носитель с операционной системой Windows Server.** Для выполнения этой задачи требуется ISO-файл, содержащий операционную систему Windows Server. Поддерживаются следующие версии Windows Server:

<table border="1" width="600">

<tr bgcolor="#E9E7E7">

<th>
ОС

</th>

<th>
SKU

</th>

<th>
Пакет обновления

</th>

<th>
Архитектура

</th>

</tr>

<tr>

<td>
Windows Server 2012 R2

</td>

<td>
Все выпуски

</td>

<td>
Недоступно

</td>

<td>
x64

</td>

</tr>

<tr>

<td>
Windows Server 2012

</td>

<td>
Все выпуски

</td>

<td>
Недоступно

</td>

<td>
x64

</td>

</tr>

<tr>

<td>
Windows Server 2008 R2

</td>

<td>
Все выпуски

</td>

<td>
SP1

</td>

<td>
x64

</td>

</tr>

</table>

</p>
</p>
Эта задача включает следующие шаги:

-   [Шаг 1: подготовка образа для передачи][Шаг 1: подготовка образа для передачи]
-   [Шаг 2: создание учетной записи хранения в Azure][Шаг 2: создание учетной записи хранения в Azure]
-   [Шаг 3: подготовка подключения к Azure][Шаг 3: подготовка подключения к Azure]
-   [Шаг 4: передача VHD-файла][Шаг 4: передача VHD-файла]

## <span id="prepimage"></span> </a>Шаг 1: подготовка образа для передачи

Перед передачей образа в Azure его необходимо обобщить с помощью команды Sysprep. Дополнительную информацию об использовании Sysprep см. в разделе [Как использовать Sysprep: введение][Как использовать Sysprep: введение].

В только что созданной виртуальной машине выполните следующие действия:

1.  Войдите в операционную систему.

2.  Откройте окно командной строки с правами администратора. Измените каталог на **%windir%\\system32\\sysprep** и запустите файл `sysprep.exe`.

    ![Откройте окно командной строки][Откройте окно командной строки]

3.  Откроется диалоговое окно **Программа подготовки системы**.

    ![Запустите Sysprep][Запустите Sysprep]

4.  В разделе **Программа подготовки системы** выберите **Запуск при первом включении компьютера (OOBE)** и убедитесь, что установлен флажок «Обобщить».

5.  В разделе **Параметры завершения работы** выберите **Завершение работы**.

6.  Нажмите кнопку **ОК**.

## <span id="createstorage"></span> </a>Шаг 2: создание учетной записи хранения в Azure

Учетная запись хранения представляет собой высший уровень пространства имен для доступа к службам хранения; эта запись связана с вашей подпиской Azure. Для загрузки в Azure файла VHD, который можно использовать для создания виртуальной машины, потребуется учетная запись хранения в Azure. Для создания учетной записи хранения можно использовать портал управления Azure.

1.  Войдите на портал управления Azure.

2.  На панели команд нажмите **Создать**.

3.  Нажмите **Учетная запись хранения**, а затем **Быстрое создание**.

    ![Быстрое создание учетной записи хранения][Быстрое создание учетной записи хранения]

4.  Заполните поля, как показано ниже:

-   В поле **URL-адрес** введите имя поддомена, используемого в URL-адресе для учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это имя становится именем узла в URL, который используется для адресации ресурсов BLOB-объекта, очереди и таблицы для подписки.

-   Выберите **расположение или территориальную группу** для учетной записи хранения. Указав территориальную группу, можно выполнить совместное размещение облачных служб в одном центре обработки данных с хранилищем.

-   Укажите, следует ли использовать **георепликацию** для учетной записи хранения. По умолчанию георепликация включена. Этот параметр позволяет бесплатно выполнять репликацию данных в дополнительное местоположение; таким образом в случае аварийного отказа, который не может быть устранен в основном местоположении, хранилище переключится на дополнительное местоположение. Дополнительное местоположение назначается автоматически и не может быть изменено. Если в соответствии с законодательными требованиями или организационной политикой требуется более жесткий контроль местоположения облачного хранилища, то георепликацию можно отключить. Однако следует помнить, что если вы опять включите георепликацию, с вас будет взята однократная плата за репликацию существующих данных в дополнительное местоположение. Службы хранения без георепликации предлагаются со скидкой. Дополнительную информацию об управлении георепликацией учетных записей хранения см. здесь: [Управление учетными записями хранения][Управление учетными записями хранения].

    ![Введите сведения об учетной записи хранения][Введите сведения об учетной записи хранения]

1.  Щелкните **Создать учетную запись хранения**.

    Учетная запись появится в списке **учетных записей хранения**.

    ![Учетная запись хранилища успешно создана][Учетная запись хранилища успешно создана]

2.  Теперь создайте контейнер для переданных виртуальных жестких дисков. Щелкните **Имя учетной записи хранения**, а затем выберите **Контейнеры**.

    ![Информация об учетной записи хранения][Информация об учетной записи хранения]

3.  Щелкните **Создание контейнера**.

    ![Информация об учетной записи хранения][2]

4.  Введите **Имя** своего контейнера и выберите **Политика доступа**.

    ![Имя контейнера][Имя контейнера]

    > [WACOM.NOTE] По умолчанию контейнер является закрытым и доступ к нему имеет только владелец учетной записи. Чтобы разрешить общий доступ на чтение для больших двоичных объектов в контейнере, но не к свойствам и метаданным контейнера, используйте параметр «Общедоступный BLOB-объект». Чтобы разрешить полный общий доступ на чтение для контейнера и больших двоичных объектов, используйте параметр «Общедоступный контейнер».

## <span id="PrepAzure"></span> </a>Шаг 3: подготовка подключения к Microsoft Azure

Перед передачей VHD-файла необходимо установить безопасное соединение между компьютером и вашей подпиской в Microsoft Azure. Это можно сделать, используя метод Microsoft Azure Active Directory или метод сертификатов.

### Использование Microsoft Azure AD

1.  Откройте консоль Microsoft Azure PowerShell, как описано в разделе [Практическое руководство. Установка Microsoft Azure PowerShell][Практическое руководство. Установка Microsoft Azure PowerShell].

2.  Введите следующую команду:
    `Add-AzureAccount`

    После выполнения команды откроется окно входа, и вы сможете войти, используя свою рабочую или школьную учетную запись.

    ![Окно PowerShell][Окно PowerShell]

3.  Microsoft Azure выполняет аутентификацию и сохраняет учетные данные, а затем закрывает окно.

### Использование сертификата

1.  Откройте окно Microsoft Azure PowerShell.

2.  Введите:
    `Get-AzurePublishSettingsFile`.

3.  В открывшемся окне браузера появится запрос на скачивание PUBLISHSETTINGS-файла. Он содержит информацию и сертификат для подписки Microsoft Azure.

    ![Страница скачивания браузера][Страница скачивания браузера]

4.  Сохраните файл .publishsettings.

5.  Введите:
    `Import-AzurePublishSettingsFile <PathToFile>`

    Где "`<PathToFile>`" — это полный путь к файлу .publishsettings.

    Дополнительную информацию см. в разделе [Начало работы с командлетами Microsoft Azure][Начало работы с командлетами Microsoft Azure]

    Дополнительную информацию об установке и настройке PowerShell см. в разделе [Установка и настройка Microsoft Azure PowerShell][здесь]

## <span id="upload"></span> </a>Шаг 4: передача VHD-файла

При загрузке файла .vhd его можно поместить в любом месте внутри хранилища blob. В приведенных ниже примерах команд **BlobStorageURL** — это URL-адрес для учетной записи хранения, созданный при выполнении шага 2, **YourImagesFolder** — это контейнер внутри хранилища BLOB-данных, где будут храниться образы. **VHDName** — это метка, которая отображается в портале управления для идентификации виртуального жесткого диска. **PathToVHDFile** — это полный путь и имя файла .vhd.

1.  В окне Microsoft Azure PowerShell, использованном при выполнении предыдущего шага, наберите:

    `Add-AzureVhd -Destination "<BlobStorageURL>/<YourImagesFolder>/<VHDName>.vhd" -LocalFilePath <PathToVHDFile>`

    ![PowerShell Add-AzureVHD][PowerShell Add-AzureVHD]

    Дополнительную информацию о командлете Add-AzureVhd см. в разделе [Add-AzureVhd][Add-AzureVhd].

## Добавьте образ в список пользовательских образов

После загрузки файла VHD его можно добавить в качестве образа в список пользовательских образов, связанных с подпиской.

1.  На портале управления в разделе **Все элементы** нажмите **Виртуальные машины**.

2.  В разделе виртуальных машин щелкните **Образы**.

3.  Затем щелкните **Создать образ**.

    ![PowerShell Add-AzureVHD][3]

4.  В разделе **Создать образ на основе VHD** выполните следующее:

    -   Укажите **имя**.
    -   Введите **описание**.
    -   Чтобы указать **URL-адрес VHD**, нажмите кнопку папки, чтобы открыть следующее диалоговое окно.

    ![Выбор виртуального жесткого диска][Выбор виртуального жесткого диска]

    -   Выберите учетную запись хранения, в которой находится ваш виртуальный жесткий диск, и нажмите **Открыть**. Это позволит вернуться в окно раздела **Создать образ на основе VHD**.
    -   После возврата в раздел **Создать образ на основе VHD** выберите семейство ОС.
    -   Отметьте пункт **Я выполнил Sysprep на виртуальной машине, связанной с этим VHD**, чтобы подтвердить обобщение операционной системы при выполнении шага 1, а затем нажмите **ОК**.

    ![Добавление образа][Добавление образа]

5.  **ДОПОЛНИТЕЛЬНО.** Командлет Add-AzureVMImage Azure PowerShell также можно использовать для добавления VHD-файла в качестве образа.

    В окне Microsoft Azure PowerShell введите:

    `Add-AzureVMImage -ImageName <Your Image's Name> -MediaLocation <location of the VHD> -OS <Type of the OS on the VHD>`

    ![PowerShell Add-AzureVMImage][PowerShell Add-AzureVMImage]

6.  После выполнения предыдущих действий новый образ отобразится в списке при выборе вкладки **Образы**.

    ![пользовательский образ][пользовательский образ]

    Теперь при создании виртуальной машины вы сможете воспользоваться этим новым образом. Чтобы показать новый образ, выберите **Мои образы**. Инструкции см. в разделе [Создание виртуальной машины под управлением Windows Server][Создание настраиваемой виртуальной машины].

    ![создание виртуальной машины на основе пользовательского образа][создание виртуальной машины на основе пользовательского образа]

## Дальнейшие действия

После создания виртуальной машины попробуйте создать виртуальную машину SQL Server. Указания см. в разделе [Подготовка виртуальной машины SQL Server в Microsoft Azure][Подготовка виртуальной машины SQL Server в Microsoft Azure].

  [Диски и образы в Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/jj672979.aspx
  [Создание настраиваемой виртуальной машины]: http://www.windowsazure.com/ru-ru/documentation/articles/virtual-machines-windows-tutorial/
  [Создание учетной записи Azure]: http://www.windowsazure.com/ru-ru/develop/php/tutorials/create-a-windows-azure-account/
  [Загрузки Microsoft Azure]: http://www.windowsazure.com/ru-ru/downloads/
  [здесь]: http://www.windowsazure.com/ru-ru/documentation/articles/install-configure-powershell/
  [Add-AzureVHD]: http://msdn.microsoft.com/ru-ru/library/windowsazure/dn205185.aspx
  [Установка роли Hyper-V и настройка виртуальной машины]: http://technet.microsoft.com/ru-ru/library/hh846766.aspx
  [Convert-VHD]: http://technet.microsoft.com/ru-ru/library/hh848454.aspx
  [1]: http://blogs.msdn.com/b/virtual_pc_guy/archive/2012/10/03/using-powershell-to-convert-a-vhd-to-a-vhdx.aspx
  [Шаг 1: подготовка образа для передачи]: #prepimage
  [Шаг 2: создание учетной записи хранения в Azure]: #createstorage
  [Шаг 3: подготовка подключения к Azure]: #prepAzure
  [Шаг 4: передача VHD-файла]: #upload
  [Как использовать Sysprep: введение]: http://technet.microsoft.com/ru-ru/library/bb457073.aspx
  [Откройте окно командной строки]: ./media/virtual-machines-create-upload-vhd-windows-server/sysprep_commandprompt.png
  [Запустите Sysprep]: ./media/virtual-machines-create-upload-vhd-windows-server/sysprepgeneral.png
  [Быстрое создание учетной записи хранения]: ./media/virtual-machines-create-upload-vhd-windows-server/Storage-quick-create.png
  [Управление учетными записями хранения]: http://www.windowsazure.com/ru-ru/documentation/articles/storage-manage-storage-account/
  [Введите сведения об учетной записи хранения]: ./media/virtual-machines-create-upload-vhd-windows-server/Storage-create-account.png
  [Учетная запись хранилища успешно создана]: ./media/virtual-machines-create-upload-vhd-windows-server/Storagenewaccount.png
  [Информация об учетной записи хранения]: ./media/virtual-machines-create-upload-vhd-windows-server/storageaccount_detail.png
  [2]: ./media/virtual-machines-create-upload-vhd-windows-server/storageaccount_container.png
  [Имя контейнера]: ./media/virtual-machines-create-upload-vhd-windows-server/storageaccount_containervalues.png
  [Практическое руководство. Установка Microsoft Azure PowerShell]: #Install
  [Окно PowerShell]: ./media/virtual-machines-create-upload-vhd-windows-server/add_azureaccount.png
  [Страница скачивания браузера]: ./media/virtual-machines-create-upload-vhd-windows-server/Browser_download_GetPublishSettingsFile.png
  [Начало работы с командлетами Microsoft Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/jj554332.aspx
  [PowerShell Add-AzureVHD]: ./media/virtual-machines-create-upload-vhd-windows-server/powershell_upload_vhd.png
  [Add-AzureVhd]: http://msdn.microsoft.com/ru-ru/library/dn495173.aspx
  [3]: ./media/virtual-machines-create-upload-vhd-windows-server/Create_Image.png
  [Выбор виртуального жесткого диска]: ./media/virtual-machines-create-upload-vhd-windows-server/Select_VHD.png
  [Добавление образа]: ./media/virtual-machines-create-upload-vhd-windows-server/Create_Image_From_VHD.png
  [PowerShell Add-AzureVMImage]: ./media/virtual-machines-create-upload-vhd-windows-server/add_azureimage_powershell.png
  [пользовательский образ]: ./media/virtual-machines-create-upload-vhd-windows-server/vm_custom_image.png
  [создание виртуальной машины на основе пользовательского образа]: ./media/virtual-machines-create-upload-vhd-windows-server/create_vm_custom_image.png
  [Подготовка виртуальной машины SQL Server в Microsoft Azure]: http://www.windowsazure.com/ru-ru/documentation/articles/virtual-machines-provision-sql-server/
