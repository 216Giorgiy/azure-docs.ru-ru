---
title: Повторное создание заголовков HTTP в Шлюзе приложений Azure | Документация Майкрософт
description: В этой статье представлен обзор возможностей повторного создания заголовков HTTP в Шлюзе приложений Azure
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 04/11/2019
ms.author: absha
ms.openlocfilehash: 20c484779e7ffe74ae01e33472b4cf8761d81b66
ms.sourcegitcommit: c3d1aa5a1d922c172654b50a6a5c8b2a6c71aa91
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59682686"
---
# <a name="rewrite-http-headers-with-application-gateway"></a>Перепишите заголовки HTTP с помощью шлюза приложений

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Заголовки HTTP позволяют клиенту и серверу передавать дополнительную информацию вместе с запросом или ответом. Переписать эти заголовки HTTP помогает выполнить несколько важных сценариев, таких как добавление поля заголовка, связанные с безопасностью, как HSTS / X-XSS-Protection Удаление заголовка ответа поля, который может раскрыть конфиденциальную информацию, удаляя сведения о порте из Заголовки X-Forwarded-For и т. д. Шлюз приложений поддерживает возможность добавить, удалить или обновить заголовки запроса и ответа HTTP, во время запроса и пакетов ответа перемещать между пулами клиентской и серверной части. Он предоставляет возможность добавить условия, чтобы убедиться, что указанные заголовки перезаписываются только в том случае, если соблюдены определенные условия. Эта возможность также поддерживает несколько [переменных сервера](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers#server-variables) оповещающие хранения дополнительной информации о запросах и ответах, тем самым позволяя внести правила мощные подстановки.
> [!NOTE]
>
> Поддержка повторного создания заголовка HTTP доступна только для [нового номера SKU [Standard_V2\]](https://docs.microsoft.com/azure/application-gateway/application-gateway-autoscaling-zone-redundant)

![Переопределения заголовков](media/rewrite-http-headers/rewrite-headers.png)

## <a name="headers-supported-for-rewrite"></a>Заголовки, поддерживаемые для переопределения

Благодаря возможности вы можете переписать все заголовки в запросе и ответе заголовков узла, подключения и обновление с запретом на использование. Шлюз приложений также можно создать пользовательские заголовки и добавить их в запрос и ответы, направляется через него. 

## <a name="rewrite-conditions"></a>Перепишите условия

С помощью переопределения, которые условий можно оценить содержимое HTTP (S) запросов и ответов и выполнять заголовком перепишите только в том случае, если один или несколько условий. Следующие три типа переменных используются шлюзом приложений для оценки содержимого на запросы HTTP (S) и ответы:

- Заголовки HTTP в запросе
- Заголовки HTTP в ответе
- Переменные сервера шлюза приложения

Условие можно использовать для оценки, является ли указанная переменная существует, ли указанная переменная точно совпадает с конкретным значением или ли указанная переменная точно соответствует шаблону. [Perl совместимый регулярных выражений () требуется библиотека PCRE](https://www.pcre.org/) используется для реализации в условиях сопоставления шаблона регулярного выражения. Дополнительные сведения о синтаксисе регулярных выражений, см. в разделе [регулярных выражений Perl справочная страница](https://perldoc.perl.org/perlre.html).

## <a name="rewrite-actions"></a>Перепишите действия

Перепишите действия используются для указания заголовков запроса и ответа, которые вы собираетесь переписать и новое значение, необходимо переписать, чтобы исходные заголовки. Можно создать новый заголовок, изменить значение существующего заголовка или удалить существующий заголовок. Заголовок нового или существующего заголовка может быть значение в следующие типы значений:

- текст 
- Заголовок запроса: Чтобы указать в заголовке запроса, необходимо использовать синтаксис {http_req_*Имя_заголовка*}
- Заголовок ответа: Чтобы указать заголовок ответа, необходимо использовать синтаксис {http_resp_*Имя_заголовка*}
- Переменная сервера: Чтобы указать переменную сервера, необходимо использовать синтаксис {var_*serverVariable*}
- Сочетание текста, заголовок запроса, заголовок ответа и переменную сервера.

## <a name="server-variables"></a>Переменные сервера

Шлюз приложений использует серверные переменные для хранения полезные сведения о сервере, соединение с клиентом и текущий запрос на подключение, например IP-адрес клиента или типом веб-браузера. Эти переменные изменяются динамически, такие как публикации при загрузке новой страницы или формы. Эти переменные сервера можно использовать для оценки условия перезаписи и переписывать заголовки. 

Шлюз приложений поддерживает следующие переменные сервера:

| Поддерживаемые переменные сервера | ОПИСАНИЕ                                                  |
| -------------------------- | :----------------------------------------------------------- |
| add_x_forwarded_for_proxy  | Содержит «X-Forwarded-For» клиент поле заголовка запроса с `client_ip` (описано в следующей таблице) переменной, добавленным к нему в формате (IP1, IP2 IP3,...). Если поле «X-Forwarded-For» отсутствует в заголовке запроса клиента `add_x_forwarded_for_proxy` переменной равно `$client_ip` переменной. Эта переменная является особенно полезно в сценариях, где клиентам требуется переписать заголовок X-Forwarded-For, задайте шлюзом приложений, таким образом, что заголовок содержит только IP-адрес без сведения о порте. |
| ciphers_supported          | возвращает список шифров, поддерживаемых клиентом          |
| ciphers_used               | возвращает строку шифров, которая используется для установленного безопасного соединения |
| client_ip                  | IP-адрес клиента, по которому шлюз приложений получили запрос. Если обратный прокси-сервер перед шлюза приложений и клиенту, затем *client_ip* возвращает IP-адрес обратного прокси-сервера. |
| client_port                | порт клиента                                                  |
| client_tcp_rtt             | предоставляет сведения о подключении протокола TCP клиента; доступен на системах, которые поддерживают параметр сокета TCP_INFO |
| client_user                | при использовании проверки подлинности HTTP, используется имя пользователя |
| host                       | в следующем порядке значимости: имя узла из строки запроса или имя узла из поля заголовка запроса "Host" или имя сервера, который соответствует запросу |
| cookie_*имя*              | *имя* куки-файл                                            |
| http_method                | метод, используемый для выполнения запроса URL-адреса. Например, GET, POST и т. д. |
| http_status                | состояние сеанса, например: 200, 400, 403 и т. д.                       |
| http_version               | запрос протокола, обычно "HTTP/1.0", "HTTP/1.1"или "HTTP/2.0" |
| query_string               | список пар переменная – значение, которые следуют за "?" в запрошенном URL-адресе. |
| received_bytes             | длина запроса (включая строку, заголовок и текст запроса) |
| request_query              | аргументы в строке запроса                                |
| request_scheme             | Схема запроса, "HTTP" или "HTTPS"                            |
| request_uri                | полный исходный URI запроса (с аргументами)                   |
| sent_bytes                 | количество отправленных байт клиенту                             |
| server_port                | порт сервера, который принял запрос                 |
| ssl_connection_protocol    | возвращает протокол установленного безопасного соединения        |
| ssl_enabled                | "включено", если подключение работает в режиме SSL, или в противном случае строка будет пустой |

## <a name="rewrite-configuration"></a>Перепишите конфигурации

Чтобы настроить перезапись заголовка HTTP, необходимо будет:

1. Создать новые объекты, необходимые для переработки заголовков HTTP:

   - **Перепишите действие**: используется для указания запроса и полей заголовка запроса, которые вы собираетесь переписать и новое значение, необходимо переписать, чтобы исходные заголовки. Вы можете связать один или дополнительные условия перезаписи с помощью действия переопределения.

   - **Перепишите условие**: Он является необязательной конфигурацией. Если добавляется условие перезаписи, выполняется оценка содержимого HTTP (S) запросов и ответов. Решение для выполнения определенного действия переопределения, связанный с условием перезаписи будет основываться ли HTTP (S) запроса или ответа соответствует условию перезаписи. 

     Если более одного условия связаны с действие, а затем действие выполняется только в том случае, если все условия выполняются, т. е., будет выполняться логическую операцию и.

   - **Правила переопределения**: правила переопределения содержит несколько действие переопределения — переписать сочетания условий.

   - **Правила последовательности**: помогает определить порядок, в котором разные правила переопределения сработать. Это полезно при наличии нескольких правила подстановки в наборе перезаписи. Сначала выполняется с меньшим значением последовательности правило правила перезаписи. Если указать той же последовательности правила, чтобы два правила подстановки порядок выполнения будет недетерминированным.

   - **Перепишите набора**: содержит несколько переопределения правила, которые будут связаны с правило маршрутизации запроса.

2. Вам потребуется присоединить множество перезаписи (*rewriteRuleSet*) с помощью правила маршрутизации. Это обусловлено конфигурации перезаписи присоединяется к исходному прослушивателю посредством правила маршрутизации. При использовании базового правила маршрутизации конфигурация перезаписи связывается с прослушивателем источника и выполняется перезапись глобального заголовка. При использовании правила маршрутизации на основе пути конфигурация перезаписи заголовка определяется в сопоставлении URL-пути. Поэтому она применяется только к области конкретного пути на сайте.

Можно создать несколько наборов переопределения заголовка http, и каждый набор переопределения может применяться к несколько прослушивателей. Тем не менее можно применить только один переписать набора для конкретного прослушивателя.

## <a name="common-scenarios"></a>Распространенные сценарии

Ниже приведены некоторые из наиболее распространенных сценариев, которые требуют переопределения заголовка.

### <a name="remove-port-information-from-the-x-forwarded-for-header"></a>Удалить сведения о порте из заголовка X-Forwarded-For

Шлюз приложений вставляет заголовок X-Forwarded-For во все запросы, прежде чем он перенаправляет запросы в серверную часть. Формат этого заголовка — это разделенный запятыми список IP: Port. Однако возможны сценарии, где внутренних серверов требуется заголовок, чтобы содержать только IP-адресов. Для выполнения таких сценариев, перезапись заголовка можно использовать для удаления сведений порт из заголовка X-Forwarded-For. Один из способов сделать это является задание для переменной сервера add_x_forwarded_for_proxy заголовка. 

![Удаление порта](media/rewrite-http-headers/remove-port.png)

### <a name="modify-the-redirection-url"></a>Изменить URL-адрес перенаправления

Внутреннее приложение посылает ответ перенаправления, можно будет перенаправлять клиента на другой URL-адрес, отличной от указанной для серверной части приложения. Одна из таких ситуаций, когда службы приложений размещается за шлюз приложений и клиенту нужно выполнить перенаправление относительный путь к каталогу (перенаправление из contoso.azurewebsites.net/path1 в contoso.azurewebsites.net/path2). 

Так как служба приложений — это мультитенантная служба, используется заголовок узла в запросе для направления в правильную конечную точку. Службы приложений по по умолчанию присвоено имя домена *. azurewebsites.net (например, contoso.azurewebsites.net), который отличается от шлюза приложений доменное имя (например, contoso.com). Так как исходный запрос от клиента имеет имя шлюза приложений домена contoso.com, установленного как имя узла, шлюза приложений изменяет имя узла для contoso.azurewebsites.net, чтобы службы приложений может направлять на правильную конечную точку. Когда службы приложений отправляет ответ перенаправления, он использует же именем узла в заголовке location ответа, в запросе, получаемых от шлюза приложений. Таким образом клиент будет делать запрос прямо на contoso.azurewebsites.net/path2, а не через шлюз приложений (contoso.com/path2). Обход шлюза приложений является нежелательным. 

Эту проблему можно устранить, задав имя узла в заголовке location, чтобы доменное имя шлюза приложений. Чтобы сделать это, можно создать правило переопределения с условием, которое возвращает, если под заголовком location в ответе содержит azurewebsites.net, введя `(https?):\/\/.*azurewebsites\.net(.*)$` как шаблон и выполняет действие, которое перезаписывает заголовок расположения для шлюза приложений Имя узла, введя `{http_resp_Location_1}://contoso.com{http_resp_Location_2}` как значение заголовка.

![Изменить заголовок location](media/rewrite-http-headers/app-service-redirection.png)

### <a name="implement-security-http-headers-to-prevent-vulnerabilities"></a>Реализовать заголовки безопасности HTTP для предотвращения появления уязвимостей

Некоторые уязвимости можно устранить путем реализации необходимых заголовков в ответе приложения. Ниже приведены некоторые из этих заголовков безопасности X-XSS-Protection, Strict-Transport-Security, содержимое политики безопасности, и т.д. Шлюз приложений можно использовать для установки этих заголовков всех ответов.

![Заголовок безопасности](media/rewrite-http-headers/security-header.png)

### <a name="delete-unwanted-headers"></a>Удаление нежелательных заголовки

Можно удалить эти заголовки из HTTP-ответа, раскрыть конфиденциальную информацию, например имя внутреннего сервера, операционной системы, сведения о библиотеке и т. д. Чтобы удалить эти поля можно использовать шлюз приложений.

![Удалить заголовок](media/rewrite-http-headers/remove-headers.png)

### <a name="check-presence-of-a-header"></a>Проверьте наличие заголовка

Вы можете оценить заголовка запроса или ответа HTTP на наличие переменной заголовок или сервера. Это полезно в том случае, если планируется выполнять перезапись заголовка только в том случае, если определенные заголовок присутствует.

![Проверка на присутствие заголовка](media/rewrite-http-headers/check-presence.png)

## <a name="limitations"></a>Ограничения

- Переопределения заголовков подключения, обновления и узел еще не поддерживается.

- Имена заголовков могут содержать любые буквенно-цифровые и специальные символы, как определено в [RFC 7230](https://tools.ietf.org/html/rfc7230#page-27). Однако "подчеркивание" (\_), специальный символ в имени заголовка, сейчас не поддерживается. 

## <a name="need-help"></a>Требуется помощь?

Если вам нужна помощь с этой возможностью, свяжитесь с нами по адресу [AGHeaderRewriteHelp@microsoft.com](mailto:AGHeaderRewriteHelp@microsoft.com).

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать, как переписать заголовки HTTP, см. в разделе:

-  [Перепишите заголовки HTTP, с помощью портала Azure](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers-portal)
-  [Перепишите заголовки HTTP, с помощью Azure PowerShell](add-http-header-rewrite-rule-powershell.md)
