---
title: Повторное создание заголовков HTTP в Шлюзе приложений Azure | Документация Майкрософт
description: В этой статье представлен обзор возможностей повторного создания заголовков HTTP в Шлюзе приложений Azure
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 12/20/2018
ms.author: absha
ms.openlocfilehash: e89fe10768331f5b4099ce9a9e2204dd72aa0bff
ms.sourcegitcommit: ad3e63af10cd2b24bf4ebb9cc630b998290af467
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2019
ms.locfileid: "58793470"
---
# <a name="rewrite-http-headers-with-application-gateway-public-preview"></a>Повторное создание заголовков HTTP с помощью Шлюза приложений (общедоступная предварительная версия)

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Заголовки HTTP позволяют клиенту и серверу передавать дополнительную информацию вместе с запросом или ответом. Повторное создание этих заголовков HTTP помогает вам выполнить несколько важных сценариев, например, добавление полей заголовков, связанных с безопасностью (HSTS/X-XSS-Protection), или удаление полей заголовков ответов, которые могут раскрыть конфиденциальную информацию (например, имя внутреннего сервера).

Шлюз приложений теперь поддерживает возможность повторного создания заголовков входящих HTTP-запросов, а также исходящих HTTP-ответов. Вы сможете добавлять, удалять или обновлять заголовки запросов и ответов HTTP, пока пакеты запросов и ответов перемещаются между клиентским и внутренним пулами. Вы можете повторно создать как стандартные, так и нестандартные поля заголовка.

> [!NOTE]
> 
> Поддержка повторного создания заголовка HTTP доступна только для [нового номера SKU [Standard_V2\]](https://docs.microsoft.com/azure/application-gateway/application-gateway-autoscaling-zone-redundant)

Поддержка повторного создания заголовка Шлюза приложений предлагает следующее:

- **Повторное создание глобального заголовка**. Вы можете повторно создавать специальные заголовки для всех запросов и ответов, относящихся к сайту.
- **Перезапись заголовка на основе пути**: этот тип переопределения позволяет переопределения заголовка для запросов и ответов, которые относятся к только на указанную область сайта, например в корзину для покупок область обозначается /cart/\*.

Благодаря этому изменению вам необходимо:

1. Создать новые объекты, необходимые для переработки заголовков HTTP: 
   - **RequestHeaderConfiguration**: этот объект используется для указания полей заголовка запроса, которые необходимо повторно создать, и нового значения, в котором нужно повторно создать исходные заголовки.
   - **ResponseHeaderConfiguration**: этот объект используется для указания полей заголовка ответа, которые необходимо повторно создать, и нового значения, в котором нужно повторно создать исходные заголовки.
   - **ActionSet**: этот объект содержит конфигурации запросов и ответов заголовков, указанных выше. 
   - **RewriteRule**: этот объект содержит все указанные выше *actionSets*. 
   - **RewriteRuleSet**: этот объект содержит все *rewriteRules* и должен быть подключен к базовому правилу или правилу маршрутизации запроса на основе путей.
2. Затем вам потребуется присоединить набор правил повторного создания к правилу маршрутизации. После создания эта конфигурация повторного создания присоединяется к исходному слушателю с помощью правила маршрутизации. При использовании базового правила маршрутизации конфигурация перезаписи связывается с прослушивателем источника и выполняется перезапись глобального заголовка. При использовании правила маршрутизации на основе пути конфигурация перезаписи заголовка определяется в сопоставлении URL-пути. Поэтому она применяется только к области конкретного пути на сайте.

Можно создать несколько наборов правил повторного создания заголовка HTTP, который может применяться к нескольким слушателям. Однако вы можете применить только один набор правил повторного создания HTTP для конкретного слушателя.

Вы можете изменить значение в заголовках для:

- текстового значения; 

  *Пример.* 

  ```azurepowershell-interactive
  $responseHeaderConfiguration = New-AzApplicationGatewayRewriteRuleHeaderConfiguration -HeaderName "Strict-Transport-Security" -  HeaderValue "max-age=31536000")
  ```

- значение из другого заголовка; 

  *Пример 1*. 

  ```azurepowershell-interactive
  $requestHeaderConfiguration= New-AzApplicationGatewayRewriteRuleHeaderConfiguration -HeaderName "X-New-RequestHeader" -HeaderValue {http_req_oldHeader}
  ```

  > [!Note] 
  > Чтобы указать запрос заголовка, необходимо использовать синтаксис: {http_req_headerName}

  *Пример 2*.

  ```azurepowershell-interactive
  $responseHeaderConfiguration= New-AzApplicationGatewayRewriteRuleHeaderConfiguration -HeaderName "X-New-ResponseHeader" -HeaderValue {http_resp_oldHeader}
  ```

  > [!Note] 
  > Чтобы указать ответ заголовка, необходимо использовать синтаксис: {http_resp_headerName}

- значение из поддерживаемых переменных сервера;

  *Пример.* 

  ```azurepowershell-interactive
  $requestHeaderConfiguration = New-AzApplicationGatewayRewriteRuleHeaderConfiguration -HeaderName "Ciphers-Used" -HeaderValue "{var_ciphers_used}"
  ```

  > [!Note] 
  > Чтобы указать переменную сервера, необходимо использовать синтаксис: {var_serverVariable}

- сочетание вышеуказанных способов.

## <a name="server-variables"></a>Переменные сервера

В переменных сервера хранится полезная информация, касающаяся веб-сервера. Эти переменные предоставляют сведения о сервере, подключении к клиенту и текущем запросе на подключение, например IP-адрес клиента или тип браузера. Они могут динамически изменяться, например при загрузке новой страницы или при публикации формы.  С помощью этих переменных пользователи могут задавать заголовки запросов, а также заголовки ответов. 

Эта возможность поддерживает повторное создание заголовков для следующих серверных переменных.

| Поддерживаемые переменные сервера | ОПИСАНИЕ                                                  |
| -------------------------- | :----------------------------------------------------------- |
| ciphers_supported          | возвращает список шифров, поддерживаемых клиентом          |
| ciphers_used               | возвращает строку шифров, которая используется для установленного безопасного соединения |
| client_ip                  | IP-адрес клиента, по которому шлюз приложений получили запрос. Если обратный прокси-сервер перед шлюза приложений и клиенту, затем *client_ip* возвращает IP-адрес обратного прокси-сервера. Эта переменная является особенно полезно в сценариях, где клиентам требуется перепишите заголовок X-Forwarded-For, задайте шлюзом приложений, таким образом, чтобы заголовок содержит только IP-адрес без сведения о порте. |
| client_port                | порт клиента                                                  |
| client_tcp_rtt             | предоставляет сведения о подключении протокола TCP клиента; доступен на системах, которые поддерживают параметр сокета TCP_INFO |
| client_user                | при использовании проверки подлинности HTTP, используется имя пользователя |
| host                       | в следующем порядке значимости: имя узла из строки запроса или имя узла из поля заголовка запроса "Host" или имя сервера, который соответствует запросу |
| cookie_*имя*              | *имя* куки-файл |
| http_method                | метод, используемый для выполнения запроса URL-адреса. Например, GET, POST и т. д. |
| http_status                | состояние сеанса, например: 200, 400, 403 и т. д.                       |
| http_version               | запрос протокола, обычно "HTTP/1.0", "HTTP/1.1"или "HTTP/2.0" |
| query_string               | список пар переменная – значение, которые следуют за "?" в запрошенном URL-адресе. |
| received_bytes             | длина запроса (включая строку, заголовок и текст запроса) |
| request_query              | аргументы в строке запроса                                |
| request_scheme             | Схема запроса, "HTTP" или "HTTPS"                            |
| request_uri                | полный исходный URI запроса (с аргументами)                   |
| sent_bytes                 | количество отправленных байт клиенту                             |
| server_port                | порт сервера, который принял запрос                 |
| ssl_connection_protocol    | возвращает протокол установленного безопасного соединения        |
| ssl_enabled                | "включено", если подключение работает в режиме SSL, или в противном случае строка будет пустой |

## <a name="limitations"></a>Ограничения

- Возможность повторного создания HTTP-заголовков в настоящее время доступна только через Azure PowerShell, Azure API и Azure SDK. Скоро будет доступна поддержка с помощью портала и Azure CLI.

- Поддержка повторного создания заголовка HTTP поддерживается только новым номером SKU [Standard_V2](https://docs.microsoft.com/azure/application-gateway/application-gateway-autoscaling-zone-redundant). Эта возможность не будет поддерживаться предыдущим номером SKU.

- Переопределения заголовков подключения, обновления и узел еще не поддерживается.

- Скоро будет доступна возможность повторно создавать заголовки HTTP условно.

- Имена заголовков могут содержать любые буквенно-цифровые и специальные символы, как определено в [RFC 7230](https://tools.ietf.org/html/rfc7230#page-27). Однако "подчеркивание" (\_), специальный символ в имени заголовка, сейчас не поддерживается. 

## <a name="need-help"></a>Требуется помощь?

Если вам нужна помощь с этой возможностью, свяжитесь с нами по адресу [AGHeaderRewriteHelp@microsoft.com](mailto:AGHeaderRewriteHelp@microsoft.com).

## <a name="next-steps"></a>Дальнейшие действия

После изучения возможностей повторного создания заголовков HTTP, перейдите к [Tutorial: Create an application gateway and rewrite HTTP headers](tutorial-http-header-rewrite-powershell.md) (Руководство. Создание шлюза приложения и повторное создание заголовков HTTP) или к [Rewrite HTTP headers in an existing Application gateway](add-http-header-rewrite-rule-powershell.md) (Повторное создание заголовков HTTP в существующем шлюзе приложения)
