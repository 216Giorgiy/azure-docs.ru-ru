---
title: Как Azure работы приложения шлюза
description: В этой статье приведены сведения о том, как работает шлюз приложения
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 02/20/2019
ms.author: absha
ms.openlocfilehash: bbaf651233d4cebad3f45e5cf3823bcaf6ce38b6
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59783281"
---
# <a name="how-application-gateway-works"></a>Как работает шлюз приложений

В этой статье объясняется, как шлюз приложений принимает входящие запросы и направляет их в серверную часть.

![как приложения шлюз работает](./media/how-application-gateway-works/how-application-gateway-works.png)

## <a name="how-a-request-is-accepted"></a>Как запрос принят

Прежде чем клиент отправляет запрос на шлюз приложений, он разрешает доменное имя шлюза приложений, с помощью сервера доменных имен (DNS). Запись DNS управляет Azure, так как шлюзов приложений находятся в домене, сайте azure.com. Azure DNS возвращает IP-адрес клиента, которая представляет *внешний IP-адрес* шлюза приложений. Шлюз приложений принимает входящий трафик на одном или нескольких *прослушиватели*. Прослушиватель — это логическая сущность, которое проверяет наличие запросов на подключение. Он настраивается с помощью плана IP-адрес, протокол и номер порта для подключения от клиентов в шлюзе приложений. Если включен брандмауэр веб-приложения (WAF), шлюз приложений проверяет заголовки запроса и текст (при его наличии) от *правил WAF* для определения, является ли запрос допустимым запросом - в этом случае он будет перенаправлен к Серверная часть — или угрозы безопасности, в котором будет заблокирован в случае запроса.  

Шлюз приложений может использоваться как подсистемы балансировки нагрузки внутреннего приложения или подсистемы балансировки нагрузки приложения для Интернета. Шлюз приложений для Интернета имеет общедоступный IP-адресов. DNS-имя шлюза приложений для Интернета разрешимые его общедоступный IP-адрес. Таким образом шлюзов приложений для Интернета можно направлять запросы от клиентов через Интернет. Шлюзы внутреннего приложения получают только частный IP-адрес. DNS-имя шлюза приложений с внутренней разрешимые ее частный IP-адрес. Таким образом внутренних подсистем балансировки нагрузки только может направлять запросы от клиентов с доступом к виртуальной сети для шлюза приложений. Шлюзы приложений для Интернета и внутренние направляет запросы к серверной части серверы с помощью частных IP-адресов. Таким образом внутренних серверов не требуется общедоступный IP-адреса для получения запросов из внутреннего или шлюза приложений для Интернета.

## <a name="how-a-request-is-routed"></a>Как направляется запрос

Если обнаружено, что запрос не являться (или не включен WAF), *правило маршрутизации запроса* связанные с *прослушивателя* будет оценен для определения *внутренний пул* для который будет направляться является запрос. Правила обрабатываются в том порядке, в котором они указаны на портале. На основе *правило маршрутизации запроса* конфигурации шлюза приложений решает, следует ли перенаправлять все запросы на прослушивателе определенном серверном пуле или перенаправлять их в разные внутренние пулы, зависимости на URL-адрес или к *перенаправлять запросы* на другой порт или внешний сайт

Один раз *серверной части* *пула* выбран, шлюз приложений отправляет запрос к одному из внутренних серверов настроены в пуле, который находится в работоспособном состоянии (y.y.y.y). Работоспособность сервера определяется *пробы работоспособности*. Если внутренний пул содержит более одного сервера, шлюз приложений использует алгоритм циклического перебора, чтобы перенаправлять запросы между серверами работоспособное, тем самым балансировки запросов на серверах.

После определения сервера базы данных, шлюз приложений открывает новый сеанс TCP с внутреннего сервера, на основе конфигурации в *параметры HTTP*. *Параметры HTTP* — это компонент, который определяет протокол, порт и другие связанные с маршрутизацией будет параметр, который необходим для установки нового сеанса с внутреннего сервера. Порт и протокол, используемый в параметрах HTTP определяют, зашифрован ли трафик между сервером шлюза и серверной части приложения, тем самым выполнения сквозного режима связи SSL, так и незашифрованные. При отправке исходного запроса внутреннему серверу, шлюз приложений использует пользовательской настройки, внесенные в параметры HTTP, относящиеся к переопределение имени узла, путь, протокол; обеспечение сходства сеансов на основе файлов cookie, фильтрация, подключений комплектации имя узла из серверной части и т. д.

Внутренний шлюз приложений имеет только частный IP-адрес. DNS-имя внутренней шлюза приложений можно внутренне разрешить ее частный IP-адрес. Таким образом внутренних подсистем балансировки нагрузки только может направлять запросы от клиентов с доступом к виртуальной сети для шлюза приложений.

Если серверный пул содержит внутренним образом разрешить полное доменное имя или частный IP-адрес, шлюз приложений направляет запрос к внутреннему серверу, с помощью его экземпляр частных IP-адресов. Если серверный пул содержит внешнюю конечную точку и возможностью внешнего разрешения полного доменного ИМЕНИ, шлюз приложений направляет запрос к внутреннему серверу, с помощью общедоступного IP-адрес внешнего интерфейса. Разрешение DNS основан на частную зону DNS или пользовательский DNS-сервер, если настроена или необходимое по умолчанию, предоставляемый Azure DNS. Если вы еще не подготовили общедоступный IP-адрес внешнего интерфейса, один назначается для исходящих внешних подключений.

### <a name="modifications-to-the-request"></a>Изменения в запрос

Шлюз приложений вставляет 4 Дополнительные заголовки для всех запросов, прежде чем он перенаправляет запросы в серверную часть. Эти заголовки X-forwarded-for, X-forwarded-proto, X-forwarded-port и X-исходный host. Формат для заголовка x-forwarded-for является разделенный запятыми список IP: Port. Допустимые значения для x-forwarded-proto — HTTP или HTTPS. Заголовок X-Forwarded-Port указывает порт, в котором запрос достигает шлюза приложений. Заголовок X-исходный host содержит исходный заголовок узла, с которого поступил запрос. Этот заголовок полезен в таких сценариях, как интеграция веб-сайта Azure, при которой заголовок узла входящих запросов изменяется, прежде чем трафик направляется к серверной части. При необходимости Если включенном сходстве сеансов, затем файл cookie сходства управляемых шлюза будет вставлена. 

Кроме того, можно настроить шлюз приложений для изменения заголовков с использованием [заголовки HTTP, перепишите](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers) или изменить путь URI, используя переопределение пути установки. Но если настроена для этого, все входящие запросы передаются как есть в серверную часть.


## <a name="next-steps"></a>Дальнейшие действия

Ознакомившись со сведениями о принципах работы шлюза приложений, см. в разделе [компоненты шлюза приложения](application-gateway-components.md) для понимания ее компонентов, более подробно.
