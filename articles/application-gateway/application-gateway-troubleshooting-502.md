<properties
   pageTitle="Устранение ошибок ";Недопустимый шлюз"; шлюза приложений (502) | Microsoft Azure"
   description="Из этой статьи вы узнаете, как устранять ошибки 502 шлюза приложений."
   services="application-gateway"
   documentationCenter="na"
   authors="amitsriva"
   manager="rossort"
   editor=""
   tags="azure-resource-manager"
/>
<tags  
   ms.service="application-gateway"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/15/2016"
   ms.author="amitsriva" />

#Устранение ошибок "Недопустимый шлюз" в шлюзе приложений

##Обзор
После настройки шлюза приложений Azure может появиться сообщение об ошибке "Ошибка сервера 502: веб-сервер, выполняющий роль шлюза или прокси-сервера, получил недопустимый ответ". Это может произойти по следующим причинам:

- серверный пул шлюза приложений Azure не настроен или пуст;
- в наборе масштабирования ВМ нет работоспособных экземпляров или ВМ;
- серверные ВМ или экземпляры набора масштабирования ВМ не отвечают на стандартную пробу работоспособности;
- недопустимая или неправильная конфигурация пользовательских проб работоспособности;
- истекло время запроса или при его обработке возникли проблемы с подключением.


##Пустой серверный пул адресов
###Причина:
Если для шлюза приложений не настроены в серверном пуле адресов виртуальные машины или набор масштабирования виртуальных машин, он не может отправлять запросы клиентов и выдает ошибку шлюза.

###Решение
Убедитесь, что серверный пул адресов не пуст. Это можно сделать с помощью PowerShell, интерфейса командной строки или на портале.

	
	Get-AzureRmApplicationGateway -Name "SampleGateway" -ResourceGroupName "ExampleResourceGroup"

Выходные данные командлета, приведенного выше, должны содержать непустой серверный пул адресов. В примере ниже возвращаются два пула, в которых для серверных виртуальных машин указано полное доменное имя или IP-адрес. Состояние подготовки серверного пула адресов должно быть "Выполнено".
	
		BackendAddressPoolsText: 
				[{
					"BackendAddresses": [{
						"ipAddress": "10.0.0.10",
						"ipAddress": "10.0.0.11"
					}],
					"BackendIpConfigurations": [],
					"ProvisioningState": "Succeeded",
					"Name": "Pool01",
					"Etag": "W/"00000000-0000-0000-0000-000000000000"",
					"Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool01"
				}, {
					"BackendAddresses": [{
						"Fqdn": "xyx.cloudapp.net",
						"Fqdn": "abc.cloudapp.net"
					}],
					"BackendIpConfigurations": [],
					"ProvisioningState": "Succeeded",
					"Name": "Pool02",
					"Etag": "W/"00000000-0000-0000-0000-000000000000"",
					"Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool02"
				}]
	
	
## Неработоспособные экземпляры в серверном пуле адресов

###Причина:
Если неработоспособными являются все экземпляры серверного пула адресов, шлюзу приложений некуда отправлять запросы пользователей. То же самое происходит, когда серверные экземпляры работоспособны, но в них не развернуто требуемое приложение.

###Решение
Сделайте экземпляры работоспособными и правильно настройте приложение. Проверьте, могут ли серверные экземпляры отвечать на запрос проверки связи от другой виртуальной машины в виртуальной сети. Если настроена общая конечная точка, убедитесь, что запрос браузера к веб-приложению подлежит обслуживанию.


##Проблемы со стандартной пробой работоспособности
###Причина:
Ошибки 502 часто указывают на то, что стандартная проба работоспособности не может связаться с серверными виртуальными машинами. Подготовленный экземпляр шлюза приложений автоматически настраивает стандартную пробу работоспособности для каждого серверного пула адресов. Для этого он использует свойства параметра BackendHttpSetting. Пользователю ничего не нужно вводить для настройки этой пробы. В частности, при настройке правила балансировки нагрузки создается связь между параметром BackendHttpSetting и серверным пулом адресов. Стандартная проба настраивается для каждой такой связи. Шлюз приложений периодически проверяет работоспособность каждого экземпляра в серверном пуле адресов. Для этого он подключается к нужным экземплярам, пользуясь портом, заданным в параметре BackendHttpSetting. Ниже приведены значения, связанные со стандартной пробой работоспособности.


|Свойства проверки | Значение | Описание|
|---|---|---|
| URL-адрес проверки| http://127.0.0.1/ | URL-адрес |
| Интервал | 30 | Интервал проверки в секундах |
| Время ожидания | 30 | Время ожидания проверки в секундах |
| Пороговое значение сбоя | 3 | Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

###Решение
- Убедитесь, что стандартный сайт настроен и ожидает передачи данных по адресу 127.0.0.1.
- Если в параметре BackendHttpSetting задан порт, отличный от 80, на стандартном сайте нужно настроить ожидание передачи данных через этот порт.
- Вызов к http://127.0.0.1:port должен вернуть HTTP-код результата 200 (в течении 30-секундного периода ожидания).
- Откройте настроенный порт и удалите правила брандмауэра и группы безопасности сети Azure. Иначе они будут блокировать входящий и исходящий трафик через настроенный порт.
- Если классические виртуальные машины Azure или облачная служба используются с полным доменным именем или общедоступным IP-адресом, откройте соответствующую [конечную точку](../virtual-machines/virtual-machines-windows-classic-setup-endpoints.md).
- Если виртуальная машина настроена с помощью Azure Resource Manager и находится за пределами виртуальной сети, в которой развернут шлюз приложений, настройте в [группе безопасности сети](../virtual-network/virtual-networks-nsg.md) доступ через нужный порт.


##Проблемы с пользовательскими пробами работоспособности
###Причина:
Пользовательские пробы работоспособности более гибкие по сравнению со стандартными. При использовании пользовательских проб можно настроить интервал проб, их URL-адрес и путь к ним, а также количество неудачных откликов, после которых экземпляр пула внутренних серверов должен считаться неработоспособным. Добавляются приведенные ниже дополнительные свойства.


|Свойства проверки| Описание|
|---|---|
| Имя | Имя проверки. Это имя используется для указания проверки в параметрах HTTP внутреннего сервера |
| Протокол | Протокол, используемый для проверки. Единственным допустимым протоколом является HTTP. |
| Узел | Имя узла для проверки. Применяется только тогда, когда в шлюзе приложений настроено многосайтовое подключение. (То есть указывается не имя узла виртуальной машины.) |
| Путь | Относительный путь проверки. Путь должен начинаться с "/". Проба отправляется по адресу <protocol>://<host>:<port><path>. |
| Интервал | Интервал проверки в секундах. Интервал времени между двумя последовательными проверками.|
| Время ожидания | Время ожидания проверки в секундах. Проверка считается неудачной, если ответ о работоспособности не получен в течение этого времени ожидания. |
| Пороговое значение сбоя | Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |


###Решение
Настройте пользовательскую пробу производительности правильно, согласно сведениям, приведенным в таблице выше. Помимо действий по устранению неполадок, описанных выше, требуется соблюдение следующих условий:

- задан только протокол HTTP; протокол HTTPS сейчас не поддерживается;
- проба указана правильно, согласно [руководству](application-gateway-create-probe-ps.md);
- если шлюз приложений настроен для одного сайта, нужно указать стандартное имя узла 127.0.0.1, если только другое имя не задано в пользовательской пробе;
- вызов к http://\<host>:<port><path> должен возвращать HTTP-код результата 200;
- значения "Интервал", "Время ожидания" и "Порог работоспособности" должны находиться в допустимом диапазоне.


##Время ожидания запроса
###Причина:
Когда получен запрос пользователя, шлюз приложений применяет настроенные правила к запросу и направляет его экземпляру серверного пула. Затем в течение указанного интервала он ожидает отклик от серверного экземпляра. По умолчанию этот интервал составляет **30 секунд**. Если шлюз приложений не получает отклик от серверного приложения в течение этого времени, в связи с пользовательским запросом отобразится ошибка 502.

###Решение
Шлюз приложений позволяет пользователям настроить этот параметр с помощью параметра BackendHttpSetting, который затем можно применить к разным пулам. Для разных серверных пулов параметр BackendHttpSetting и, следовательно, время ожидания запроса могут быть настроены по-разному.

	New-AzureRmApplicationGatewayBackendHttpSettings -Name 'Setting01' -Port 80 -Protocol Http -CookieBasedAffinity Enabled -RequestTimeout 60

##Дальнейшие действия

Если описанные выше шаги не решат проблему, отправьте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).

<!---HONumber=AcomDC_0720_2016-->