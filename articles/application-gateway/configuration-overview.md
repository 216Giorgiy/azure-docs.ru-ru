---
title: Общие сведения о настройке шлюза приложений Azure
description: В этой статье сведения о настройке различных компонентов в шлюзе приложений Azure
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 03/20/2019
ms.author: absha
ms.openlocfilehash: 18013050546cc5e204d9cc07a2f499388596164c
ms.sourcegitcommit: 5e4ca656baf3c7d370ab3c0fbad0278aa2c9f1e6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/21/2019
ms.locfileid: "58319454"
---
# <a name="application-gateway-configuration-overview"></a>Общие сведения о конфигурации шлюза приложений

Шлюз приложений состоит из нескольких компонентов, которые могут быть настроены по-разному для выполнения различных сценариев. В этой статье рассматривается как каждый компонент будет настраиваться.

![компоненты для шлюза приложений](./media/configuration-overview/configuration-overview1.png)

Пример рисунке выше показана конфигурация приложения с 3 прослушивателями. Первые два предоставляются многосайтовые прослушиватели для `http://acme.com/*` и `http://fabrikam.com/*`, соответственно. Оба прослушивают порт 80. Третий прослушивателя — это базовый прослушиватель с завершением запросов SSL сквозного. 

## <a name="prerequisites"></a>Технические условия

### <a name="azure-virtual-network-and-dedicated-subnet"></a>Виртуальная сеть Azure и выделенную подсеть

Шлюз приложений — это специальное развертывание в виртуальной сети. В виртуальной сети в выделенной подсети является обязательным для шлюза приложений. В этой подсети может иметь несколько экземпляров определенного шлюза развертывания приложения. Можно также развернуть другие шлюзы приложений в подсети, но вы не можете развернуть любой другой ресурс в подсети шлюза приложений.  

> [!NOTE]   
> Смешанное использование Standard_v2 и шлюза приложений (ценовая категория "Стандартный") в той же подсети не поддерживается.

#### <a name="size-of-the-subnet"></a>Размер подсети

Шлюз приложений использует один частный IP-адрес на каждый экземпляр, а также еще один, если настроен частный интерфейсный IP-адрес. Кроме того, Azure резервирует 5 IP-адреса — первые четыре и последний IP-адрес - в каждой подсети для внутреннего использования. Например если шлюз приложений имеет значение 15 экземпляров и без частный внешний IP-адреса, по крайней мере 20 IP-адресов будет требуется в подсеть — пять IP-адресов для внутреннего использования и 15 IP-адреса для 15 экземпляров шлюза приложений. Таким образом, в данном случае типа/27 требуется подсеть, размер или более поздней версии. У вас есть экземпляры 27 и IP-адрес для частный внешний IP-конфигурацию, то 33 IP-адресов, которые будут необходимы - 27 IP-адресов для 27 экземпляров шлюза приложений, один IP-адрес для частный интерфейсный IP-адрес и пять IP-адреса серверов для внутреннего использования. Таким образом, в данном случае /26 требуется подсеть, размер или более поздней версии.

Рекомендуется использовать по крайней мере/28 размер подсети. Это дает 11 пригодных для использования адреса. Если в соответствии с загруженностью приложения требует более чем 10 экземпляров, следует учитывать типа/27 или/26 размер подсети.

#### <a name="network-security-groups-supported-on-the-application-gateway-subnet"></a>Группы безопасности сети, поддерживаемые в подсети шлюза приложений

Группы безопасности сети (Nsg) поддерживаются в подсети шлюза приложений со следующими ограничениями: 

- Для номера SKU Шлюза приложений версии 1 нужно задать исключения для входящего трафика на портах 65503–65534, а для номера SKU версии 2 — на портах 65200–65535. Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Они защищены (заблокированы) посредством сертификатов Azure. Без соответствующих сертификатов внешние сущности, включая клиентов этих шлюзов, не смогут вносить изменения в конечные точки.

- Исходящее подключение к Интернету не может быть заблокировано. Правила для исходящих подключений по умолчанию в группу безопасности сети уже разрешить подключение к Интернету. Мы рекомендуем не удалять правила для исходящего трафика по умолчанию и что нельзя создавать другие правила для исходящих подключений, которые запрещают исходящие подключения к Интернету.

- Трафик из тега AzureLoadBalancer должен быть разрешен.

##### <a name="whitelist-application-gateway-access-to-a-few-source-ips"></a>Шлюз приложений в список разрешений доступа к нескольким исходным IP-адресов

Этот сценарий можно выполнить с помощью групп безопасности сети в подсети шлюза приложений. Следующие ограничения должны быть установлены для подсети в указанном порядке приоритета:

1. Разрешить входящий трафик из исходного IP-адреса или диапазона IP-адресов.
2. Разрешить входящие запросы от всех источников на порты 65503–65534 для [просмотра работоспособности серверной части ](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics). Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Они защищены (заблокированы) посредством сертификатов Azure. Без подходящих сертификатов внешние сущности, включая клиентов этих шлюзов, не смогут никоим образом изменить конечные точки.
3. Разрешить пробы Azure Load Balancer (тег AzureLoadBalancer) и входящего виртуального сетевого трафика (тег VirtualNetwork) в [группах безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview).
4. Запретить весь другой входящий трафик с помощью правила, запрещающего любой трафик.
5. Разрешить исходящий трафик в Интернет для всех назначений.

#### <a name="user-defined-routes-supported-on-the-application-gateway-subnet"></a>Определяемые пользователем маршруты, поддерживаемые в подсети шлюза приложений

В случае SKU v1 определяемые пользователем маршруты (Udr) поддерживаются в подсети шлюза приложений, до тех пор, пока они не влияют на end-to-end запрос-ответ. Например, можно настроить UDR в подсети шлюза приложений, чтобы указать устройство брандмауэра для проверки пакетов, но необходимо убедиться, что после проверки пакет достигнет места назначения. Невыполнение этого требования может привести к неправильному выполнению пробы работоспособности или некорректной маршрутизации трафика. Это касается полученных маршрутов или маршрутов 0.0.0.0/0 по умолчанию, которые распространяются в виртуальной сети с помощью ExpressRoute или VPN-шлюзов.

В случае v2 SKU, определяемые пользователем маршруты для подсети шлюза приложений не поддерживаются. Дополнительные сведения см. в статье [Автоматическое масштабирование и Шлюз приложений, избыточный между зонами (общедоступная предварительная версия)](https://docs.microsoft.com/azure/application-gateway/application-gateway-autoscaling-zone-redundant#known-issues-and-limitations).

> [!NOTE]
> С помощью определяемых пользователем маршрутов в подсети шлюза приложений приведет к состояние работоспособности в [представление работоспособности серверной части](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics#back-end-health) отображаются как **Неизвестный** и приводит произошел поколения журналов шлюза приложений и метрики. Рекомендуется не использовать определяемые пользователем маршруты в подсети шлюза приложений. Чтобы иметь возможность просматривать работоспособность серверной части, журналы и метрики.

## <a name="frontend-ip"></a>Интерфейсный IP-адрес

Можно настроить шлюз приложений, либо иметь общедоступный IP-адрес или частный IP-адрес или оба. Общедоступный IP-адрес является обязательным, если вы размещаете серверную платформу, которая требуется доступ к клиентам через Интернет с помощью Интернет-виртуальный IP-адрес. Общедоступный IP-адрес не является обязательным для внутренней конечной точки, который не подключен к Интернету, а также называется внутренним балансировщиком нагрузки конечную точку. Настройка шлюза с ILB подходит для внутренних бизнес-приложений, недоступных в Интернете. Кроме того, этот вариант конфигурации можно использовать для служб и уровней многоуровневого приложения, размещенного в периметре безопасности без доступа к Интернету, но требующего циклического перебора нагрузки, закрепления сеансов или завершения SSL-запросов.

Поддерживается только один общедоступный или частный IP-адрес. Выберите интерфейсный IP-адрес при создании шлюза приложений. 

- В случае общедоступный IP-адрес вы можете создать новый общедоступный IP-адрес или использовать существующий общедоступный IP-адрес в том же расположении, что и шлюз приложений. Если вы создаете новый общедоступный IP-адрес, IP адрес выбранного типа (статический или динамический) нельзя изменить позже. Дополнительные сведения см. в разделе [статические и динамические общедоступный IP-адрес](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#static-vs-dynamic-public-ip) 

- В случае частный IP-адрес вы можете указать частный IP-адрес из подсети, в котором создается шлюз приложений. Если не указано явным образом, произвольный IP-адрес автоматически выберет из подсети. Дополнительные сведения см. в разделе [Создание шлюза приложений с конечной точкой внутреннего балансировщика нагрузки.](https://docs.microsoft.com/azure/application-gateway/application-gateway-ilb-arm)

Интерфейсный IP-адрес связан с *прослушивателя* которого проверяет входящие запросы через интерфейсный IP-адрес.

## <a name="listeners"></a>Прослушиватели

Прослушиватель — это логическая сущность, которая проверяет наличие входящих запросов на подключение, используя порт, протокол, узла и IP-адрес. Таким образом, при настройке прослушивателя, вам потребуется ввести эти значения порта, протокола, узла и IP-адресов которого совпадают с соответствующими значениями во входящем запросе на шлюзе. При создании шлюза приложений с помощью портала Azure, вы также создайте прослушиватель по умолчанию, выбрав протокол и порт для прослушивателя. Кроме того, можно выбрать, следует ли включить поддержку HTTP2 на прослушивателе. После создания шлюза приложений можно изменить параметр этого прослушивателя по умолчанию (*appGatewayHttpListener*/*appGatewayHttpsListener*) и/или создать новые прослушиватели.

### <a name="listener-type"></a>Тип прослушивателя

Можно выбрать между [основные или многосайтового прослушивателя](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#types-of-listeners) при создании нового прослушивателя. 

- При размещении одного сайта за шлюзом приложений, выберите базовый прослушиватель. Узнайте, [как создать шлюз приложений с помощью базовый прослушиватель](https://docs.microsoft.com/azure/application-gateway/quick-create-portal).

- Если вы настраиваете более одного веб-приложение или несколько поддоменов одного родительского домена в одном экземпляре шлюза приложений, выберите многосайтового прослушивателя. Для многосайтового прослушивателя Кроме того необходимо будет ввести имя узла. Это обусловлено тем, шлюз приложений использует заголовки узлов HTTP 1.1 для размещения нескольких веб-сайта на том же общедоступный IP-адрес и порт.

#### <a name="order-of-processing-listeners"></a>Порядок обработки прослушиватели

Для номеров SKU v1 прослушиватели обрабатываются в порядке, в котором они отображаются. Поэтому если основной прослушиватель соответствует поступившему запросу, он обработает этот запрос первым. Таким образом многосайтовые прослушиватели следует настроить до основного прослушивателя, чтобы убедиться, что трафик направляется в правильный внутренний сервер.

Для номеров SKU v2 многосайтовые прослушиватели обрабатываются перед базовые прослушиватели.

### <a name="frontend-ip"></a>Интерфейсный IP-адрес

Выберите интерфейсный IP-адрес, который требуется связать с этим прослушивателем. Прослушиватель будет вести прослушивание на входящий запрос на этот IP-адрес.

### <a name="frontend-port"></a>Интерфейсный порт

Выберите интерфейсный порт. Можно выбрать из имеющихся портов или создайте новую. Можно выбрать любое значение от [допустимый диапазон портов](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#ports). Это позволяет не только использовать хорошо известные порты, например 80 и 443, но любой разрешена пользовательский порт подходящий для использования. Можно использовать один порт для общих прослушивателей с выходом или частного прослушивателей с выходом.

### <a name="protocol"></a>Протокол

Необходимо выбрать протокол HTTP и HTTPS. 

- Если выбрано HTTP, трафик между клиентом и приложением шлюз будет передаваться в незашифрованном.

- Выберите протокол HTTPS, если вы заинтересованы в [Secure Sockets Layer (SSL) Завершение](https://docs.microsoft.com/azure/application-gateway/overview#secure-sockets-layer-ssl-terminationl) или [сквозное шифрование SSL](https://docs.microsoft.com/azure/application-gateway/ssl-overview). Если выбран HTTPS, шифруется трафик между клиентом и приложением шлюз, и завершается SSL-соединение на шлюзе приложений.  Если требуется сквозное шифрование SSL, кроме того необходимо будет выбрать протокол HTTPS при настройке *настройках внутреннего HTTP*. Это позволит гарантировать, что трафик шифруется повторно при его передаче из шлюза приложения для серверной части.

  Чтобы настроить завершение Secure Sockets Layer (SSL) и сквозное шифрование SSL, сертификат необходим для добавления прослушивателя таким образом, чтобы шлюз приложений для получения симметричного ключа согласно спецификации протокола SSL. Затем симметричный ключ используется для шифрования и расшифровки трафика, передаваемого в шлюз. Сертификат шлюза должен быть представлен в формате PFX (файл обмена личной информацией). Этот формат файла позволяет экспортировать закрытый ключ, необходимый шлюзу приложений для шифрования и расшифровки трафика. 

#### <a name="supported-certificates"></a>Поддерживаемые сертификаты

См. в разделе [сертификаты, поддерживаемые для завершения SSL-запросов](https://docs.microsoft.com/azure/application-gateway/ssl-overview#certificates-supported-for-ssl-termination).

### <a name="additional-protocol-support"></a>Поддержка дополнительных протоколов

#### <a name="http2-support"></a>Поддержка HTTP2

Поддержка протокола HTTP/2 доступна только для клиентов, подключающихся к прослушивателям шлюза приложений. Подключение к внутренним пулам серверов осуществляется по протоколу HTTP/1.1. Поддержка HTTP/2 отключена по умолчанию. В следующем фрагменте кода Azure PowerShell показано, как его включить.

```azurepowershell
$gw = Get-AzureRmApplicationGateway -Name test -ResourceGroupName hm

$gw.EnableHttp2 = $true

Set-AzureRmApplicationGateway -ApplicationGateway $gw
```

#### <a name="websocket-support"></a>Поддержка WebSocket

Поддержка WebSocket включен по умолчанию. Настраиваемый пользователем параметр для выборочного включения или отключения поддержки WebSocket отсутствует. Вы можете использовать WebSocket с прослушивателями HTTP и HTTPS. 

### <a name="custom-error-page"></a>Пользовательскую страницу ошибки

Настраиваемые страницы ошибок, которые могут быть определены на глобальном уровне, а также на уровне прослушивателя, однако Создание глобального уровня настраиваемые страницы ошибок с помощью портала Azure в настоящее время не поддерживается. На уровне прослушивателя можно настроить на пользовательскую страницу ошибки для WAF ошибка 403 "или" 502 страница «обслуживание». Необходимо также указать URL-адрес общедоступного BLOB-объектов для кода состояния возникшей ошибки. Дополнительные сведения см. в разделе [создать пользовательскую страницу ошибки](https://docs.microsoft.com/azure/application-gateway/custom-error).

![Коды ошибок службы "Шлюз приложений"](https://docs.microsoft.com/azure/application-gateway/media/custom-error/ag-error-codes.png)

Чтобы настроить на глобальный пользовательскую страницу ошибки, используйте [Azure PowerShell для конфигурации](https://docs.microsoft.com/azure/application-gateway/custom-error#azure-powershell-configuration) 

### <a name="ssl-policy"></a>Политика SSL

Можно централизовать управление SSL-сертификатами и сократить расходы на шифрование и расшифровку с внутреннего сервера фермы. Такая централизованная обработка SSL также дает возможность задать центральную политику SSL в соответствии с требованиями безопасности организации.  Можно выбрать по умолчанию, стандартные и пользовательской политики SSL. 

Можно настроить политику SSL для контроля версий протокола SSL. Вы можете настроить шлюз приложений, чтобы запретить TLS1.0, TLS1.1 и TLS1.2. Протоколы SSL версий 2.0 и 3.0 уже отключены по умолчанию, и их настройки нельзя изменить. Дополнительные сведения см. в разделе [Общие сведения о политике SSL шлюза приложений](https://docs.microsoft.com/azure/application-gateway/application-gateway-ssl-policy-overview).

После создания прослушивателя, связать его с правило маршрутизации запроса, который определяет, как запрос, полученный на прослушиватель будет направляться на серверной части.

## <a name="request-routing-rule"></a>Правило маршрутизации запроса

При создании шлюза приложений, с помощью портала Azure, создайте правило по умолчанию (*rule1*), который связывает прослушиватель по умолчанию (*appGatewayHttpListener*) с внутренним пулом (поумолчанию*appGatewayBackendPool*) и параметры HTTP серверной части по умолчанию (*appGatewayBackendHttpSettings*). После создания шлюза приложений можно изменить параметр этого правила по умолчанию или создать новые правила.

### <a name="rule-type"></a>Тип правила

Можно выбрать между [базовый "или" на основе путей правило](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#request-routing-rule) при создании нового правила. 

- Если вы хотите пересылать все запросы на связанный прослушиватель (например: blog.contoso.com/*) на один серверный пул, выберите базовый прослушиватель. 
- Выберите основаны на путях прослушивателя, если вы хотите перенаправить запросы с помощью определенного пути URL-адреса в определенные внутренние пулы. Шаблон пути применяется только к пути URL-адрес, а не на своих параметрах запроса.


#### <a name="order-of-processing-rules"></a>Порядок обработки правил

Для номеров SKU v1 сопоставления шаблона входящего запроса обрабатываются в порядке, в котором перечислены пути в сопоставления путей URL-адрес правила на основе путей. По этой причине, если запрос соответствует шаблону в два или более контуров в сопоставления путей URL-адрес, затем путь, который приведен сначала будут сопоставляться, и запрос будет перенаправлен к серверной части, сопоставленный этому пути.

Для номеров SKU v2 точное совпадение содержит более высокий приоритет над порядком, в котором перечислены пути в сопоставления URL-пути. Для этой причине, если запрос соответствует шаблону в два или несколько путей, то запрос будет перенаправлен к серверной части, связанный с этого пути, который соответствует в точности запрос. Если путь во входящем запросе полностью соответствует любой путь в сопоставления URL-пути, то сопоставление шаблона входящего запроса обрабатывается в порядке, в котором перечислены пути в сопоставления путей URL-адрес правила на основе путей.

### <a name="associated-listener"></a>Связанный прослушиватель

Необходимо связать прослушиватель в правило, чтобы *правило маршрутизации запроса* связанные с *прослушивателя* будет оценен для определения *внутренний пул* к которому запрашивается маршрутизации.

### <a name="associated-backend-pool"></a>Связанные внутреннего пула

Свяжите серверный пул, содержащий целевые объекты серверной части, которые будет выполнять запросы, получаемые прослушивателем. В случае базовое правило только один серверный пул допустимо, поскольку все запросы на связанный прослушиватель будут перенаправляться на этот внутренний пул. В случае правила на основе пути добавьте несколько пулов серверной части, соответствующий каждой пути URL-адрес. Запросы, которые соответствуют пути URL-адрес, введенный здесь, будут перенаправлены к внутреннему пулу. Кроме того добавьте серверный пул по умолчанию, так как на него будут перенаправляться запросы, которые не соответствуют любой путь URL-адрес, введенный в этом правиле.

### <a name="associated-backend-http-setting"></a>Параметр HTTP связанной серверной части

Добавьте параметры HTTP серверной части для каждого правила. Запросы будут направляться к целевым объектам базы данных, используя номер порта, протокола и другие параметры, указанные в параметре, шлюз приложений. В случае базовое правило только один параметр серверной части HTTP допустимо, поскольку все запросы на связанный прослушиватель будут перенаправляться на соответствующие целевые объекты серверной части, с помощью этого параметра HTTP. В случае правила на основе пути добавьте несколько параметры HTTP серверной части, соответствующие каждый путь URL-адрес. Запросы, которые соответствуют пути URL-адрес, введенный здесь, будут перенаправляться на соответствующие целевые серверной части с использованием параметров HTTP, соответствующий каждой пути URL-адрес. Кроме того добавьте HTTP по умолчанию, так как запросы, которые не соответствуют любой путь URL-адрес, введенный в этом правиле будут перенаправляться на серверный пул по умолчанию, с помощью HTTP по умолчанию.

### <a name="redirection-setting"></a>Параметр перенаправления

Если перенаправление настроена для базовое правило, все запросы на связанный прослушиватель будете перенаправлены в целевой объект перенаправления, тем самым позволяя глобальное перенаправление. Если перенаправление настраивается для правила на основе путей, запросы только на указанную область сайта, например корзины области, обозначенное с помощью/cart / *, будут перенаправляться в целевой объект перенаправления, тем самым позволяя перенаправление на основе пути. 

Сведения о возможностях перенаправления см. в разделе [Обзор перенаправления](https://docs.microsoft.com/azure/application-gateway/redirect-overview).

- #### <a name="redirection-type"></a>Тип перенаправления

  Выберите тип перенаправления, требуемое от: Other(303) Permanent(301), Temporary(307), Found(302) или см. в разделе.

- #### <a name="redirection-target"></a>Целевой объект перенаправления

  Можно выбрать другой прослушиватель или внешний узел как целевой объект перенаправления. 

  - ##### <a name="listener"></a>Прослушиватель

    Нажимая кнопку прослушивателя как целевой объект перенаправления помогает перенаправление с одного прослушивателя на другой прослушиватель на шлюзе. Этот параметр является обязательным, если вы хотите включить HTTP для перенаправления с HTTPS, т. е. перенаправление трафика, поступающего от прослушивателя источника, проверка входящих HTTP-запросы в целевой прослушиватель, проверка входящих HTTPS-запросов. Вы также можете строку запроса и путь в исходном запросе должны быть включены в запрос, пересылаться в целевой объект перенаправления.![компоненты для шлюза приложений](./media/configuration-overview/configure-redirection.png)

    Дополнительные сведения о HTTP для перенаправления HTTPS, см. в разделе [перенаправление HTTP для HTTP, с помощью портала](https://docs.microsoft.com/azure/application-gateway/redirect-http-to-https-portal), [перенаправление HTTP для HTTP, с помощью PowerShell](https://docs.microsoft.com/azure/application-gateway/redirect-http-to-https-powershell), [перенаправление HTTP для HTTP, с помощью интерфейса командной строки](https://docs.microsoft.com/azure/application-gateway/redirect-http-to-https-cli)

  - ##### <a name="external-site"></a>Внешний сайт

    Выберите внешний сайт, если вы хотите перенаправить трафик в прослушиватель, связанный с правилом таким образом, перенаправление на внешний сайт. Можно выбрать строку запроса в исходном запросе должны быть включены в запрос, пересылаться в целевой объект перенаправления. Невозможно передать путь в исходном запросе внешний сайт.

    Дополнительные сведения о перенаправлении внешний сайт, см. в разделе [перенаправление трафика на внешний сайт, с помощью PowerShell](https://docs.microsoft.com/azure/application-gateway/redirect-external-site-powershell) и [https://docs.microsoft.com/azure/application-gateway/redirect-external-site-cli](https://docs.microsoft.com/azure/application-gateway/redirect-external-site-cli)

#### <a name="rewrite-http-header-setting"></a>Перепишите параметр заголовка HTTP

Благодаря этой возможности вы можете добавить, удалить или обновить заголовки запроса и ответа HTTP, во время запроса и пакетов ответа перемещать между пулами клиентской и серверной части.    Вы можете настроить эту возможность только через PowerShell. Поддержка портала и интерфейса командной строки еще не доступны. Дополнительные сведения см. в разделе [заголовки HTTP, перепишите](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers) Обзор и [переопределения заголовка HTTP, настроить](https://docs.microsoft.com/azure/application-gateway/add-http-header-rewrite-rule-powershell#specify-your-http-header-rewrite-rule-configuration).

## <a name="http-settings"></a>Настройки HTTP

Шлюз приложений направляет трафик на внутренние серверы, с помощью конфигурации, заданной в этот компонент. После создания Настройка HTTP, необходимо связать его с одним или более запрос правила маршрутизации.

### <a name="cookie-based-affinity"></a>Сходство на основе файлов cookie

Это полезно, если вы хотите сохранить сеанс пользователя на одном сервере. Используя управляемые шлюзом файлы cookie, шлюз приложений может направлять последующий трафик из сеанса пользователя на тот же сервер для обработки. Эта функция важна, когда состояние сеанса сохраняется локально на сервере для сеанса пользователя. Если приложение не поддерживает сходство на основе файлов cookie, затем не можно использовать эту возможность. Использование сходства сеансов на основе файлов cookie, следует убедиться, что клиенты должны поддерживать файлы cookie. 

### <a name="connection-draining"></a>фильтрация подключений;

Фильтрация подключений поможет обеспечить корректное удаление элементов серверного пула на протяжении запланированных обновлений службы. Этот параметр может применяться ко всем элементам пула серверной части при создании правила. После включения шлюз приложений гарантирует, что все новые запросы не будут получать при этом существующие запросы для выполнения в течение ограниченного времени настроенной всех отмену регистрации экземпляров внутреннего пула. Это относится и к экземплярами серверного пула, которые явно удалены из него с помощью вызова API, и к экземплярам серверного пула, которые после проверки работоспособности рассматриваются как неработоспособные.

### <a name="protocol"></a>Протокол

Шлюз приложений поддерживает протоколы HTTP и HTTPS для направления запросов на внутренних серверах. Если выбран протокол HTTP, то затем трафик пропускается, внутренние серверы в незашифрованном виде. В таких случаях, где незашифрованная связь внутренних серверов не является допустимым вариантом следует выбрать протокол HTTPS. Этот параметр вместе с Выбор протокола HTTPS в прослушивателе позволяет включить [сквозного режима связи SSL](https://docs.microsoft.com/azure/application-gateway/ssl-overview). Что позволяет безопасно передавать конфиденциальные данные в серверную часть зашифрованы. Для каждого внутреннего сервера во внутреннем пуле, для которого включен сквозной режим связи SSL, должен быть настроен сертификат, обеспечивающий безопасный обмен данными.

### <a name="port"></a>Порт

Это номер порта внутренних серверов для трафика, поступающего от шлюза приложений. Вы можете настроить порты, от 1 до 65535.

### <a name="request-timeout"></a>Время ожидания запроса

Число секунд ожидания шлюза приложений для получения ответа из внутреннего пула, прежде чем вернуть ошибку «Тайм-аут подключения».

### <a name="override-backend-path"></a>Переопределить путь внутреннего сервера

Этот параметр позволяет настроить необязательные пользовательские переадресации путь для использования при запрос передается на внутренний сервер. Эта команда скопирует любую часть входящего путь, соответствующий пользовательский путь, указанный в **переопределить путь внутреннего сервера** поле перенаправленных путь. См. таблицу ниже, чтобы понять, как работает функция.

- Параметр HTTP при присоединении к правилу маршрутизации базовым запросом:

  | Исходный запрос  | Переопределить путь внутреннего сервера | Запрос, перенаправленные в серверную часть |
  | ----------------- | --------------------- | ---------------------------- |
  | /Home/            | /override/            | / override/home /              |
  | / home/secondhome / | /override/            | / Переопределение/home/secondhome /   |

- Параметр HTTP при присоединении к правилу маршрутизации на основе путей запроса:

  | Исходный запрос           | Правило для пути       | Переопределить путь внутреннего сервера | Запрос, перенаправленные в серверную часть |
  | -------------------------- | --------------- | --------------------- | ---------------------------- |
  | /pathrule/home /            | /pathrule*      | /override/            | / override/home /              |
  | / pathrule/home/secondhome / | /pathrule*      | /override/            | / Переопределение/home/secondhome /   |
  | /Home/                     | /pathrule*      | /override/            | / override/home /              |
  | / home/secondhome /          | /pathrule*      | /override/            | / Переопределение/home/secondhome /   |
  | /pathrule/home /            | / pathrule/home * | /override/            | /override/                   |
  | / pathrule/home/secondhome / | / pathrule/home * | /override/            | / override/secondhome /        |

### <a name="use-for-app-service"></a>Использовать для службы приложений

Это ярлык пользовательского интерфейса, который выбирает двух необходимых параметров для серверной части приложения службы — позволяет выбрать имя узла из адресов серверной части и создает новый пользовательский зонд. Причина, почему выполняется первый вариант описан в разделе **выбрать имя узла из адресов серверной части** параметр. Создается новую проверку, где заголовок пробы также берется из адреса серверной части элемента.

### <a name="use-custom-probe"></a>Использовать пользовательский зонд

Этот параметр используется для сопоставления [пользовательской пробы](https://docs.microsoft.com/azure/application-gateway/application-gateway-probe-overview#custom-health-probe) с этой настройкой HTTP. Можно связать только один пользовательский зонд с параметром HTTP. Если не связать явно пользовательской пробы, затем [Проба по умолчанию](https://docs.microsoft.com/azure/application-gateway/application-gateway-probe-overview#default-health-probe-settings) будет использоваться для мониторинга работоспособности серверной части. Рекомендуется создать пользовательскую проверку для более детального контроля над мониторингом работоспособности вашей внутренних серверов.

> [!NOTE]   
> Пользовательская проверка начнется наблюдение за работоспособностью серверного пула, соответствующий параметр HTTP явным образом связано с прослушивателем.

### <a name="pick-host-name-from-backend-address"></a>Имя узла, выбранное в наборе серверных адресов

Эта возможность динамически задает *узла* заголовка в запросе на имя узла пула серверной части, с помощью IP-адрес или полное доменное имя (FQDN). Это может оказаться полезным в сценариях, где имя домена из внутреннего пула отличается от DNS-имя шлюза приложений и серверной части зависит от конкретного заголовка узла или расширения SNI при разрешении в правильную конечную точку, такие как в случае мультитенантных служб, как внутренний сервер. Так как служба приложений — это мультитенантная служба, с помощью общего пространства с одного IP-адреса, служба приложений может осуществляться только с помощью имен узлов, настроенный в параметрах личного домена. По умолчанию является имя личного домена *example.azurewebsites.net*. Таким образом Если вы хотите получить доступ к вашей службе приложений, с помощью шлюза приложений с узла, явно не зарегистрирован в службе приложений или с полным доменным ИМЕНЕМ шлюза приложений, необходимо переопределить имя узла в исходном запросе к имени сервера в службе приложений, Включение **выбрать имя узла из адресов серверной части** параметр.

Если вы владеете личного домена и сопоставили существующего пользовательского DNS-имени в службе приложений, включите этот параметр не нужно.

> [!NOTE]   
> Этот параметр не требуется для среды службы приложений (ASE), так как ASE — это специальное развертывание. 

### <a name="host-name-override"></a>Переопределение имени узла

Эта функция заменяет *узла* заголовка во входящем запросе в шлюзе приложений с именем узла, указанные здесь. Например если www\.contoso.com указывается как **имя узла** задание исходного запроса https://appgw.eastus.cloudapp.net/path1 будет изменен на https://www.contoso.com/path1 когда запрос перенаправляется внутреннему серверу. 

## <a name="backend-pool"></a>Серверный пул

Серверный пул, можно указать четыре типа членов внутреннего: конкретной виртуальной машины, масштабируемого набора виртуальных машин, IP адрес или полное доменное имя или службу приложений. Каждый пул серверной части могут указывать на несколько элементов того же типа. Указывает элементы различных типов в один и тот же пул серверной части не поддерживается. 

После создания серверного пула, необходимо связать его с одного или нескольких правил маршрутизации запроса. Необходимо также настроить проверки работоспособности для каждого пула серверной части шлюза приложений. При выполнении запроса, условие правила маршрутизации шлюза приложений перенаправляет трафик на работоспособные серверы (что определяется пробы работоспособности), в соответствующий внутренний пул.

## <a name="health-probes"></a>Пробы работоспособности.

Несмотря на то, что шлюз приложений отслеживает работоспособность всех ресурсов в его серверной части по умолчанию, настоятельно рекомендуется создание пользовательской проверки для каждого параметра HTTP серверной части, таким образом, чтобы добиться более детального контроля над мониторингом работоспособности. Чтобы узнать, как настроить пользовательскую проверку работоспособности, см. в разделе [настраиваемые параметры пробы работоспособности](https://docs.microsoft.com/azure/application-gateway/application-gateway-probe-overview#custom-health-probe-settings).

> [!NOTE]   
> Если вы создадите пользовательскую проверку работоспособности, необходимо связать его с параметром HTTP серверной части. Пользовательская проверка начнется наблюдение за работоспособностью серверного пула, соответствующий параметр HTTP явным образом связано с прослушивателем.

## <a name="next-steps"></a>Дальнейшие действия

После изучения компоненты шлюза приложений, вы можете:

- [Создание шлюза приложений на портале Azure](quick-create-portal.md)
- [Создание шлюза приложений с помощью PowerShell](quick-create-powershell.md)
- [Создание шлюза приложений с помощью Azure CLI](quick-create-cli.md)
