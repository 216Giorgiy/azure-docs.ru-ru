<properties
   pageTitle="Балансировка нагрузки контейнеров в кластере службы контейнеров Azure | Microsoft Azure"
   description="Сведения о балансировке нагрузки нескольких контейнеров в кластере службы контейнеров Azure."
   services="container-service"
   documentationCenter=""
   authors="rgardler"
   manager="timlt"
   editor=""
   tags="acs, azure-container-service"
   keywords="Контейнеры, микрослужбы, DC/OS, Azure"/>

<tags
   ms.service="container-service"
   ms.devlang="na"
   ms.topic="get-started-article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="07/11/2016"
   ms.author="rogardle"/>

# Балансировка нагрузки контейнеров в кластере службы контейнеров Azure

В этой статье рассматривается создание внутренней подсистемы балансировки нагрузки в управляемой службе контейнеров Azure DC/OS с помощью средства marathon-lb. Это позволит вам масштабировать приложения по горизонтали. Вы также сможете воспользоваться преимуществами кластеров общедоступных и частных агентов, поместив подсистемы балансировки нагрузки в общедоступный кластер, а контейнеры приложений в частный кластер.

## Предварительные требования

[Разверните экземпляр службы контейнеров Azure](container-service-deployment.md) с типом оркестратора DC/OS и [убедитесь, что клиент может подключиться к кластеру](container-service-connect.md). Кроме того, выполните следующие действия.

## Балансировка нагрузки.

В создаваемом нами кластере службы контейнеров будет два уровня балансировки нагрузки.

  1. Azure Load Balancer предоставляет общедоступные точки входа (к ним будут обращаться пользователи). Они предоставляются автоматически службой контейнеров Azure. По умолчанию для них настроены порты 80, 443 и 8080.
  2. Балансировщик нагрузки Marathon (marathon-lb) направляет входящие запросы в экземпляры контейнера для обслуживания. Marathon-lb приспосабливается к изменениям по мере того, как мы масштабируем контейнеры в веб-службе. Этот балансировщик нагрузки не предоставляется по умолчанию в службе контейнеров, но его очень просто установить.

## Балансировщик нагрузки Marathon

Балансировщик нагрузки Marathon динамически перенастраивается на основе развернутых контейнеров. Он также устойчив к сбоям в работе контейнера или агента. В такой ситуации Apache Mesos просто перезапустит контейнер в другом расположении, а marathon-lb будет перенастроен.

Установить балансировщик нагрузки Marathon можно с помощью веб-интерфейса DC/OS или командной строки.

### Установка балансировщика нагрузки Marathon с помощью веб-интерфейса DC/OS

  1. Щелкните Universe (Вселенная).
  2. Выполните поиск по запросу "Marathon-LB".
  3. Щелкните Install (Установить).

![Установка marathon-lb через веб-интерфейс DC/OS](./media/dcos/marathon-lb-install.png)

### Установка балансировщика нагрузки Marathon с помощью интерфейса командной строки DC/OS

Когда вы установите интерфейс командной строки DC/OS и обеспечите возможность подключения к кластеру, выполните следующую команду на клиентском компьютере:

```bash
dcos package install marathon-lb
```

Эта команда автоматически устанавливает подсистему балансировки нагрузки в кластер общедоступных агентов.

## Развертывание веб-приложения с балансировкой нагрузки

Установив пакет балансировщика нагрузки Marathon, можно развернуть контейнер приложения, который нужно сбалансировать. В этом примере описывается развертывание простого веб-сервера с помощью следующей конфигурации:

```json
{
  "id": "web",
  "container": {
    "type": "DOCKER",
    "docker": {
      "image": "yeasy/simple-web",
      "network": "BRIDGE",
      "portMappings": [
        { "hostPort": 0, "containerPort": 80, "servicePort": 10000 }
      ],
      "forcePullImage":true
    }
  },
  "instances": 3,
  "cpus": 0.1,
  "mem": 65,
  "healthChecks": [{
      "protocol": "HTTP",
      "path": "/",
      "portIndex": 0,
      "timeoutSeconds": 10,
      "gracePeriodSeconds": 10,
      "intervalSeconds": 2,
      "maxConsecutiveFailures": 10
  }],
  "labels":{
    "HAPROXY_GROUP":"external",
    "HAPROXY_0_VHOST":"YOUR FQDN",
    "HAPROXY_0_MODE":"http"
  }
}

```

  * Параметру `HAProxy_0_VHOST` нужно задать значение полного доменного имени подсистемы балансировки нагрузки для агентов в следующем формате: `<acsName>agents.<region>.cloudapp.azure.com`. Например, если кластер службы контейнеров создан с именем `myacs` в регионе `West US`, полное доменное имя будет таким: `myacsagents.westus.cloudapp.azure.com`. Это значение также можно получить, выполнив в группе ресурсов, созданной для службы контейнеров на [портале Azure](https://portal.azure.com), поиск подсистемы балансировки нагрузки, в имени которой содержится agent.
  * Параметру servicePort следует назначить порт с номером >= 10 000. Таким образом мы определим службу, запущенную в этом контейнере. Балансировщик нагрузки Marathon сможет определять службы, для которых он должен балансировать нагрузку.
  * Задайте для метки `HAPROXY_GROUP` значение external.
  * Задайте для параметра `hostPort` значение 0. Так балансировщик нагрузки Marathon будет произвольно выделять доступный порт.
  * Задайте для параметра `instances` количество экземпляров, которое требуется создать. Вы всегда сможете изменить масштаб позже.

Следует заметить, что подсистема балансировки нагрузки Marathon по умолчанию будет развернута в частном кластере. Это означает, что приведенное выше развертывание будет доступным только через подсистему балансировки нагрузки, что обычно соответствует нужному поведению.

### Развертывание с помощью веб-интерфейса DC/OS

  1. Посетите страницу Marathon по адресу http://localhost/marathon (после настройки [туннеля SSH](container-service-connect.md)) и щелкните `Create Appliction`.
  2. В диалоговом окне `New Application` в правом верхнем углу щелкните `JSON Mode`.
  3. Вставьте в редактор фрагмент JSON (см. выше).
  4. Щелкните `Create Appliction`.

### Развертывание с помощью интерфейса командной строки DC/OS

Чтобы развернуть это приложение с помощью интерфейса командной строки DC/OS, просто скопируйте фрагмент JSON (см. выше) в файл с именем `hello-web.json` и выполните следующую команду:

```bash
dcos marathon app add hello-web.json
```

## Подсистема балансировщика нагрузки Azure

По умолчанию Azure Load Balancer использует порты 80, 8080 и 443. При использовании одного из этих трех портов (как это было сделано в примере выше) дополнительные действия не требуются. Будет использоваться полное доменное имя агента балансировщика нагрузки, а при каждом обновлении — один из трех веб-серверов, выбранный с помощью циклического перебора. Но если используется другой порт, вам нужно добавить для него в балансировщик нагрузки правило циклического перебора и зонд для порта. Это можно сделать в [интерфейсе командной строки Azure](../xplat-cli-azure-resource-manager.md) с помощью команд `azure lb rule create` и `azure lb probe create`. Это также можно сделать на портале Azure.


## Дополнительные сценарии

Возможно, вам потребуется использовать другие домены для предоставления других служб. Например:

mydomain1.com -> Azure LB:80 -> marathon-lb:10001 -> mycontainer1:33292 mydomain2.com -> Azure LB:80 -> marathon-lb:10002 -> mycontainer2:22321

Дополнительные сведения об этом см. в документации по [виртуальным узлам](https://mesosphere.com/blog/2015/12/04/dcos-marathon-lb/), которые позволяют связать домены с конкретными путями marathon-lb.

Кроме того, можно предоставить другие порты, повторно сопоставив их с соответствующей службой на базе балансировщика нагрузки Marathon. Например:

Azure lb:80 -> marathon-lb:10001 -> mycontainer:233423 Azure lb:8080 -> marathon-lb:1002 -> mycontainer2:33432


## Дальнейшие действия

Дополнительные сведения о [marathon-lb](https://dcos.io/docs/1.7/usage/service-discovery/marathon-lb/) см. в документации по DC/OS.

<!---HONumber=AcomDC_0921_2016-->