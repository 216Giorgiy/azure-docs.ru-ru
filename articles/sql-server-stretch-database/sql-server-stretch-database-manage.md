<properties
	pageTitle="Управление растяжением баз данных и устранение неполадок | Microsoft Azure"
	description="Узнайте, как управлять растяжением баз данных и устранять неполадки."
	services="sql-server-stretch-database"
	documentationCenter=""
	authors="douglaslMS"
	manager=""
	editor=""/>

<tags
	ms.service="sql-server-stretch-database"
	ms.workload="data-management"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="06/27/2016"
	ms.author="douglasl"/>

# Управление растяжением баз данных и устранение неполадок

Для управления растяжением баз данных и устранения неполадок используйте средства и методы, описанные в этом разделе.

## Управление локальными данными

### <a name="LocalInfo"></a>Получение информации о локальных базах данных и таблицах, для которых включена база данных Stretch
Откройте представления каталога **sys.databases** и **sys.tables** для просмотра сведений о базах данных и таблицах SQL Server, для которых включена функция Stretch. Дополнительные сведения см. в статьях [sys.databases (Transact-SQL)](https://msdn.microsoft.com/library/ms178534.aspx) и [sys.tables (Transact-SQL)](https://msdn.microsoft.com/library/ms187406.aspx).

Чтобы узнать, сколько места использует в SQL Server таблица, для которой включена функция Stretch, выполните следующую инструкцию.

 ```tsql
USE <Stretch-enabled database name>;
GO
EXEC sp_spaceused '<Stretch-enabled table name>', 'true', 'LOCAL_ONLY';
GO
 ```
## Управление миграцией данных

### Проверка функции фильтра, примененной к таблице
Откройте представление каталога **sys.remote\_data\_archive\_tables** и проверьте значение столбца **filter\_predicate**, чтобы определить функцию, которую использует база данных Stretch для выбора строк для переноса. Если значение равно null, то всю таблицу можно перенести. Дополнительные сведения см. в разделах [sys.remote\_data\_archive\_tables (Transact-SQL)](https://msdn.microsoft.com/library/dn935003.aspx) и [Выбор строк для переноса с помощью функции фильтра (база данных Stretch)](sql-server-stretch-database-predicate-function.md).

### <a name="Migration"></a>Проверка состояния переноса данных
Выберите **Задачи > Перенос > Мониторинг** для базы данных в SQL Server Management Studio, чтобы отслеживать перенос данных в мониторе базы данных Stretch. Дополнительные сведения см. в разделе [Мониторинг и устранение неполадок переноса данных (база данных Stretch)](sql-server-stretch-database-monitor.md).

Или откройте динамическое административное представление **sys.dm\_db\_rda\_migration\_status**, чтобы узнать, сколько пакетов и строк данных было перенесено.

### <a name="Firewall"></a>Устранение неполадок переноса данных
Предложения по устранению неполадок см. в разделе [Мониторинг и устранение неполадок переноса данных (база данных Stretch)](sql-server-stretch-database-monitor.md).

## Управление удаленными данными

### <a name="RemoteInfo"></a>Получение информации об удаленных базах данных и таблицах, используемых базой данных Stretch
Откройте представления каталога **sys.remote\_data\_archive\_databases** и **sys.remote\_data\_archive\_tables**, чтобы просмотреть сведения об удаленных базах данных и таблицах, в которых хранятся перенесенные данные. Дополнительные сведения см. в статьях [sys.remote\_data\_archive\_databases (Transact-SQL)](https://msdn.microsoft.com/library/dn934995.aspx) и [sys.remote\_data\_archive\_tables (Transact-SQL)](https://msdn.microsoft.com/library/dn935003.aspx).

Чтобы узнать, сколько пространства в Azure использует таблица с поддержкой переноса, выполните следующую инструкцию.

 ```tsql
USE <Stretch-enabled database name>;
GO
EXEC sp_spaceused '<Stretch-enabled table name>', 'true', 'REMOTE_ONLY';
GO
 ```

### Удаление перенесенных данных  
Если вы хотите удалить данные, уже перенесенные в Azure, выполните действия, описанные в разделе [sys.sp\_rda\_reconcile\_batch](https://msdn.microsoft.com/library/mt707768.aspx).

## Управление схемой таблицы

### Не изменяйте схему удаленной таблицы.
Не изменяйте схему удаленной таблицы Azure, связанной с таблицей SQL Server, для которой настроено растяжение базы данных. В частности, не изменяйте имя и тип данных столбца. Функция растяжения базы данных делает различные предположения в отношении схемы удаленной таблицы по отношению к схеме таблицы SQL Server. При изменении схемы удаленной таблицы растяжение базы данных для измененной таблицы перестает работать.

### Согласование столбцов таблицы  
Если вы случайно удалили столбцы из удаленной таблицы, выполните командлет **sp\_rda\_reconcile\_columns**, чтобы добавить в удаленную таблицу столбцы, которые существуют в таблице SQL Server с поддержкой переноса, но не в удаленной таблице. Дополнительные сведения см. в разделе [sys.sp\_rda\_reconcile\_columns](https://msdn.microsoft.com/library/mt707765.aspx).

  > [Важно!] При восстановлении столбцов, случайно удаленных вами из удаленной таблицы, командлет **sp\_rda\_reconcile\_columns** не восстанавливает данные, которые содержались ранее в удаленных столбцах.

Командлет **sp\_rda\_reconcile\_columns** не удаляет из удаленной таблицы столбцы, которые существуют в ней, но которых нет в таблице SQL Server с поддержкой переноса. Если в удаленной таблице Azure есть столбцы, которых больше нет в таблице SQL Server с поддержкой Stretch, эти лишние столбцы не препятствуют нормальной работе базы данных Stretch. При необходимости вы можете вручную удалить лишние столбцы.

## Управление производительностью и расходами  

### Решение проблем с производительностью запросов
Запросы, которые включают таблицу, для которой включено растяжение баз данных, должны выполняться медленнее, чем раньше — до включения растяжения баз данных. Если производительность запросов значительно снизилась, просмотрите следующие возможные проблемы.

-   Находится ли сервер Azure находится в другом географическом регионе по сравнению с сервером SQL Server? Настройте сервер Azure, так чтобы он находился в одном географическом регионе с SQL Server для снижения задержки в сети.

-   Возможно ухудшение характеристик работы сети. Обратитесь к администратору сети для получения сведений о последних неполадках или простоях.

### Повысьте уровень производительности ресурсоемких операций в Azure, таких как индексирование.
При сборке, повторной сборке или реорганизации индекса для большой таблицы, настроенной для базы данных Stretch, если предполагается большое количество запросов к перенесенным данным в Azure в этот период, необходимо увеличить уровень производительности соответствующей удаленной базы данных Azure на период этой операции. Дополнительные сведения об уровнях производительности и ценовых категориях см. в статье [Цены на SQL Server Stretch Database](https://azure.microsoft.com/pricing/details/sql-server-stretch-database/).

### Вы не можете приостановить службу базы данных SQL Server Stretch в Azure  
 Убедитесь, что выбраны соответствующие уровень производительности и ценовая категория. Если вы временно повышаете уровень производительности для ресурсоемкой операции, по завершении такой операции восстановите производительность до прежнего уровня. Дополнительные сведения об уровнях производительности и ценовых категориях см. на странице [цен на SQL Server Stretch Database](https://azure.microsoft.com/pricing/details/sql-server-stretch-database/).

## Изменение области запросов  
 Запросы к таблицам с поддержкой Stretch по умолчанию возвращают как локальные, так и удаленные данные. Вы можете изменить область запросов для всех запросов, отправляемых всеми пользователями, или только для одного запроса, отправляемого администратором.

### Изменение области запросов для всех запросов, отправляемых всеми пользователями  
 Чтобы изменить область всех запросов, отправляемых всеми пользователями, выполните хранимую процедуру **sys.sp\_rda\_set\_query\_mode**. Вы можете сузить область запроса только до локальных данных, отключить все запросы или восстановить настройку по умолчанию. Дополнительные сведения см. в разделе [sys.sp\_rda\_set\_query\_mode](https://msdn.microsoft.com/library/mt703715.aspx).

### <a name="queryHints"></a>Изменение администратором области запросов для одного запроса  
 Чтобы участник роли db\_owner мог изменить область одного запроса, добавьте указание запроса **WITH (REMOTE\_DATA\_ARCHIVE\_OVERRIDE = *значение*)** в инструкцию SELECT. Указание запроса REMOTE\_DATA\_ARCHIVE\_OVERRIDE может иметь следующие значения.
 -   **LOCAL\_ONLY**. Запрос только локальных данных.

 -   **REMOTE\_ONLY**. Запрос только удаленных данных.

 -   **STAGE\_ONLY**. Запрос только данных в таблице, где база данных Stretch размещает строки, пригодные для миграции, и сохраняет перенесенные строки в течение указанного периода после миграции. Это указание запроса является единственным способом отправить запрос к промежуточной таблице.

Например, следующий запрос возвращает только локальные результаты.

 ```tsql  
 USE <Stretch-enabled database name>;
 GO
 SELECT * FROM <Stretch_enabled table name> WITH (REMOTE_DATA_ARCHIVE_OVERRIDE = LOCAL_ONLY) WHERE ... ;
 GO
```  

## <a name="adminHints"></a>Осуществление административных операций обновления и удаления  
 По умолчанию вы не можете выполнять операции UPDATE и DELETE со строками, пригодными для миграции, или с уже перенесенными строками в таблице с поддержкой Stretch. Когда вам необходимо устранить проблему, участник роли db\_owner может выполнить операцию UPDATE или DELETE, добавив указание запроса **WITH (REMOTE\_DATA\_ARCHIVE\_OVERRIDE = *значение*)** в инструкцию. Указание запроса REMOTE\_DATA\_ARCHIVE\_OVERRIDE может иметь следующие значения.
 -   **LOCAL\_ONLY**. Обновление или удаление только локальных данных.

 -   **REMOTE\_ONLY**. Обновление или удаление только удаленных данных.

 -   **STAGE\_ONLY**. Обновление или удаление только данных в таблице, где база данных Stretch размещает строки, пригодные для миграции, и сохраняет перенесенные строки в течение указанного периода после миграции.

## См. также

[Мониторинг базы данных Stretch](sql-server-stretch-database-monitor.md)

[Резервное копирование баз данных с поддержкой Stretch](sql-server-stretch-database-backup.md)

[Восстановление баз данных с поддержкой Stretch](sql-server-stretch-database-restore.md)

<!---HONumber=AcomDC_0629_2016-->