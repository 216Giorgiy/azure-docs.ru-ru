<properties 
   pageTitle="Устранение неполадок в развертывании устройства StorSimple"
   description="Инструкции по диагностике и устранению ошибок при первом развертывании StorSimple."
   services="storsimple"
   documentationCenter="NA"
   authors="SharS"
   manager="adinah"
   editor="tysonn" /> <tags 
   ms.service="storsimple"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="TBD"
   ms.date="04/06/2015"
   ms.author="v-sharos" />

# Устранение неполадок в развертывании устройства StorSimple

## Обзор

Эта статья содержит полезные рекомендации по устранению неполадок в развертывании системы Microsoft Azure StorSimple. Здесь описаны типичные проблемы, возможные причины и рекомендуемые действия для устранения проблем, которые могут возникнуть в процессе настройки StorSimple. Эти сведения актуальны как для локального физического устройства StorSimple, так и для виртуального устройства StorSimple.

> [AZURE.NOTE]Проблемы с конфигурацией устройства могут возникнуть при первом развертывании устройства или позже, в процессе его эксплуатации. В данной статье рассматривается устранение неполадок при развертывании устройства впервые. Инструкции по устранению неполадок в процессе эксплуатации устройства см. в статье [Устранение неполадок в работающем устройстве StorSimple](storsimple-troubleshoot-operational-device.md).

В этой статье также описываются средства для устранения неполадок в развертываниях StorSimple, представлен пример пошагового устранения неполадок.

## Проблемы при первом развертывании

При возникновении проблем во время развертывания устройства в первый раз, обратите внимание на следующее.

- Если вы устраняете неполадки на физическом устройстве, убедитесь, что оборудование установлено и настроено в соответствии с инструкциями в статье [Установка оборудования для вашего устройства](https://msdn.microsoft.com/library/azure/dn772375.aspx).
- Проверьте, соблюдены ли предварительные требования, связанные с развертыванием. Убедитесь в наличии всей информации, перечисленной в [контрольном списке развертывания] (storsimple-deployment-walkthrough.md#pre-installation).
- Изучите заметки о выпуске StorSimple — документ может содержать описание проблемы. Заметки о выпуске содержат обходные пути для известных проблем установки. 

Во время развертывания устройства наиболее распространенные проблемы возникают у пользователей при запуске мастера установки и регистрации устройства с помощью Windows PowerShell для StorSimple. (Windows PowerShell для StorSimple используется для регистрации и настройки устройства StorSimple. Дополнительные сведения о регистрации устройства см. в статье [Регистрация устройства](https://msdn.microsoft.com/library/azure/dn757742.aspx)).

Следующие разделы помогут устранить проблемы, возникающие при настройке устройства StorSimple в первый раз.

## Работа с мастером установки в первый раз

Ниже приводится пошаговое описание работы с мастером установки. Подробные сведения об установке и настройке см. в документе [Пошаговое руководство по развертыванию StorSimple](storsimple-deployment-walkthrough.md).

1. Выполните командлет [Invoke-HcsSetupWizard](https://technet.microsoft.com/library/dn688135.aspx), чтобы запустить мастер установки, который поможет выполнить остальные шаги. 
2. Настройте сеть: мастер установки позволяет настроить параметры сети для сетевого интерфейса DATA 0 на устройстве StorSimple. К числу этих параметров относятся следующие:
  - Виртуальный IP-адрес (VIP), маска подсети и шлюз: командлет [Set-HcsNetInterface](https://technet.microsoft.com/library/dn688161.aspx) выполняется в фоновом режиме. Он настаивает IP-адрес, маску подсети и шлюз для сетевого интерфейса DATA 0 на устройстве StorSimple.
  - Основной DNS-сервер: командлет [Set-HcsDnsClientServerAddress](https://technet.microsoft.com/library/dn688172.aspx) выполняется в фоновом режиме. Он настраивает параметры DNS для решения StorSimple.
  - NTP-сервер: командлет [Set-HcsNtpClientServerAddress](https://technet.microsoft.com/library/dn688138.aspx) выполняется в фоновом режиме. Он настраивает параметры NTP-сервера для решения StorSimple.
  - Дополнительный веб-прокси-сервер: командлет [Set-HcsWebProxy](https://technet.microsoft.com/library/dn688154.aspx) выполняется в фоновом режиме. Он задает и включает конфигурацию веб-прокси для решения StorSimple.
3. Настройка паролей: затем необходимо настроить пароли администратора устройства и диспетчера моментальных снимков StorSimple.
  - Пароль администратора устройства используется для входа в систему на устройстве. Пароль устройства по умолчанию: *Password1*.
  - Пароль диспетчера моментальных снимков StorSimple нужен при настройке устройства для использования этого диспетчера. Сначала нужно задать пароль в мастере установки, а затем его можно будет настраивать и изменять в службе диспетчера StorSimple. Этот пароль используется для проверки подлинности устройства в диспетчере моментальных снимков StorSimple.
 
    > [AZURE.IMPORTANT]Пароли собираются перед регистрацией, но применяются только после успешной регистрации устройства. В случае ошибки применения пароля система будет требовать снова указать пароль до тех пор, пока необходимые пароли (соответствующие требованиям по сложности) не будут собраны.

4. Регистрация устройства: последний шаг — регистрация устройства в службе диспетчера StorSimple, работающей в среде Microsoft Azure. В процессе регистрации необходимо [получить ключ регистрации службы](https://msdn.microsoft.com/library/azure/cd4dee49-6ae8-4ff0-b79b-74b2027cb694#sec03) на портале управления Azure и указать его в мастере установки. После успешной регистрации устройства вам предоставляется ключ шифрования данных службы. Обязательно сохраните этот ключ шифрования в защищенном месте, так как он потребуется для регистрации в службе всех последующих устройств.

## Распространенные ошибки при развертывании устройства

В следующих таблицах перечислены распространенные ошибки, которые могут возникнуть в следующих случаях:

- Настройка обязательных сетевых параметров.
- Настойка необязательных параметров веб-прокси.
- Настройка паролей администратора устройства и диспетчера моментальных снимков StorSimple. 
- Регистрация устройства. 

### Ошибки, возникающие при настройке обязательных сетевых параметров

| №| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
| ---| ------------- | --------------- | ------------------ |
| 1 | Invoke-HcsSetupWizard: эта команда может быть выполнена только на активном контроллере. | Настройка выполнялась на пассивном контроллере.| Выполните эту команду на активном контроллере. Дополнительные сведения см. в статье [Определение активного контроллера на устройстве](https://msdn.microsoft.com/library/azure/dn790262.aspx).|
| 2 | Invoke-HcsSetupWizard: устройство не готово. | Проблемы с сетевым подключением в интерфейсе DATA 0.| Проверьте физическое подключение к сети в интерфейсе DATA 0.|
| 3 | Invoke-HcsSetupWizard: конфликт IP-адресов с другой системой в сети (исключение из HRESULT: 0x80070263). | IP-адрес, предоставленный для DATA 0, уже используется другой системой. | Укажите новый IP-адрес, который еще не используется.|
| 4. | Invoke-HcsSetupWizard: сбой ресурса кластера (исключение из HRESULT:0x800713AE). | Дублирование виртуальных IP-адресов. Указанный IP-адрес уже используется.| Укажите новый IP-адрес, который еще не используется.|
| 5 | Invoke-HcsSetupWizard: недопустимый IPv4-адрес. | IP-адрес указан в неверном формате.| Проверьте формат и укажите IP-адрес еще раз. Дополнительные сведения см. на странице [Адресация IPv4][1]. |
| 6 | Invoke-HcsSetupWizard: недопустимый IPv6-адрес. | IP-адрес указан в неверном формате.| Проверьте формат и укажите IP-адрес еще раз. Дополнительные сведения см. на странице [Адресация IPv6][2].|
| 7 | Invoke-HcsSetupWizard: в сопоставителе конечных точек отсутствуют доступные конечные точки (исключение из HRESULT: 0x800706D9). | Функциональные возможности кластера не работают. | [Обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx), чтобы узнать, что делать дальше.

### Ошибки, возникающие при настройке необязательных параметров веб-прокси-сервера

| №| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
| ---| ------------- | --------------- | ------------------ |
| 1 | Invoke-HcsSetupWizard: недопустимый параметр (исключение из HRESULT: 0x80070057) | Один из параметров, указанных для настройки прокси-сервера, является недопустимым.| URI предоставлен в неверном формате. Используйте следующий формат: http://*<IP address or FQDN of the web proxy server>*:*<TCP port number>* |
| 2 | Invoke-HcsSetupWizard: RPC-сервер недоступен (исключение из HRESULT: 0x800706ba) | Ниже перечислены возможные причины этого.<ol><li>Кластер не функционирует.</li><li>Пассивный контроллер не может взаимодействовать с активным контроллером, а команда выполняется из пассивного контроллера.</li></ol> | В зависимости от причины:<ol><li>[обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx), чтобы убедиться, что кластер работает.</li><li>Выполните команду из активного контроллера. Если требуется выполнить команду из пассивного контроллера, необходимо убедиться, что он может взаимодействовать с активным контроллером. Если соединение разорвано, необходимо [обратиться в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx).</li></ol> |
| 3 | Invoke-HcsSetupWizard: сбой вызова RPC (исключение из HRESULT: 0x800706be) | Кластер не работает. | [Обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx), чтобы убедиться, что кластер работает.|
| 4. | Invoke-HcsSetupWizard: ресурс кластера не найден (исключение из HRESULT: 0x8007138f) | Ресурс кластера не найден. Это может произойти при неправильной установке. | Может потребоваться восстановить на устройстве заводские настройки. [Обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx), чтобы создать ресурс кластера.|
| 5 | Invoke-HcsSetupWizard: ресурс кластера не подключен к сети (исключение из HRESULT: 0x8007138c)| Ресурсы кластера отключены от сети. | [Обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx), чтобы узнать, что делать дальше.|

### Ошибки при настройке паролей администратора устройства и диспетчера моментальных снимков StorSimple

Пароль администратора устройства по умолчанию: *Password1*. Пароль становится недействительным после первого входа в систему; следовательно, нужно изменить его в мастере установки. При регистрации устройства в первый раз необходимо указать новый пароль администратора устройства.

При использовании программного обеспечения диспетчера моментальных снимков StorSimple на узле Windows Server для управления устройством необходимо также указать пароль для диспетчера при первой регистрации.

Убедитесь, что пароли соответствуют следующим требованиям:

- Требуемая длина пароля администратора устройства: от 8 до 15 символов.
- Требуемая длина пароля диспетчера моментальных снимков StorSimple: 14 или 15 символов.
- Пароль должен содержать 3 из следующих 4 типов символов: символы нижнего и верхнего регистров, цифры и специальные символы. 
- Текущий пароль не должен совпадать с 24 предыдущими.

Помните, что срок действия пароля истекает каждый год, а поменять пароль можно только после успешной регистрации устройства. Если по какой-либо причине выполнить регистрацию не удается, пароль невозможно будет изменить. Дополнительные сведения о паролях администратора устройства и диспетчера моментальных снимков StorSimple см. в статье [Пароли](https://msdn.microsoft.com/library/azure/00fb2b46-e29e-4c4d-90a8-1dbb7db3672e#sec_02).

При настройке паролей администратора устройства или диспетчера моментальных снимков StorSimple могут возникнуть следующие ошибки.

| №| Сообщение об ошибке | Рекомендуемое действие |
| ---| ------------- | ------------------ | 
| 1 | Пароль превышает максимальную длину. |Используйте пароль, который отвечает следующим требованиям:<ul><li>пароль администратора устройства должен содержать от 8 до 15 символов;</li><li>пароль диспетчера моментальных снимков StorSimple должен содержать 14 или 15 символов.</li></ul> | 
| 2 | Длина пароля не соответствует требованиям. | Используйте пароль, который отвечает следующим требованиям:<ul><li>пароль администратора устройства должен содержать от 8 до 15 символов;</li><li>пароль диспетчера моментальных снимков StorSimple должен содержать 14 или 15 символов.</lu></ul> |
| 3 | Пароль должен содержать символы нижнего регистра. | Пароль должен содержать 3 из следующих 4 типов символов: символы нижнего и верхнего регистров, цифры и специальные символы. Убедитесь, что пароль отвечает этим требованиям. |
| 4. | Пароль должен содержать цифры. | Пароль должен содержать 3 из следующих 4 типов символов: символы нижнего и верхнего регистров, цифры и специальные символы. Убедитесь, что пароль отвечает этим требованиям. |
| 5 | Пароль должен содержать специальные символы. | Пароль должен содержать 3 из следующих 4 типов символов: символы нижнего и верхнего регистров, цифры и специальные символы. Убедитесь, что пароль отвечает этим требованиям. |
| 6 | Пароль должен содержать 3 из следующих 4 типов символов: символы нижнего и верхнего регистров, цифры и специальные символы. | Пароль не содержит необходимые типы символов. Убедитесь, что пароль отвечает этим требованиям. |
| 7 | Параметр не соответствует подтверждению. | Убедитесь, что пароль отвечает всем требованиям и введен правильно. |
| 8 | Пароль не может соответствовать значению по умолчанию. | Пароль по умолчанию: *Password1*. Необходимо изменить этот пароль после входа в систему в первый раз. |
| 9 | Введенный пароль не соответствует паролю устройства. Повторите ввод пароля. | Проверьте пароль и введите его еще раз. |

Пароли собираются перед регистрацией устройства, но применяются только после успешной регистрации. Рабочий процесс восстановления пароля требует регистрации устройства.

> [AZURE.IMPORTANT]В общем случае при неудачной попытке применить пароль программное обеспечение предпринимает попытки собрать пароль до тех пор, пока это не будет сделано. В редких случаях применить пароль не удается. В этом случае можно зарегистрировать устройство и продолжить работу, однако пароли не будут изменены. Вы не получите никакого уведомления о том, какой пароль не был изменен: пароль администратора устройства или пароль диспетчера моментальных снимков StorSimple. В такой ситуации рекомендуется сменить оба пароля.

Пароли можно сбросить на портале управления службы диспетчера StorSimple. Дополнительные сведения см. в разделе:

- [Настройка пароля администратора устройства](https://msdn.microsoft.com/library/azure/02f1412f-e196-4a88-8eda-2113247ea47c#sec09)
- [Настройка пароля диспетчера моментальных снимков StorSimple](https://msdn.microsoft.com/library/azure/02f1412f-e196-4a88-8eda-2113247ea47c#sec08)

### Ошибки, возникающие при регистрации устройства

Для регистрации устройства используется служба диспетчера StorSimple в среде Microsoft Azure. Во время регистрации устройства могут возникать следующие проблемы.

| №| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
| ---| ------------- | --------------- | ------------------ |
| 1 | Ошибка 350027: не удалось зарегистрировать устройство в диспетчере StorSimple. | | Подождите несколько минут и повторите попытку. Если проблема будет повторяться, [обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx).|
| 2 | Ошибка 350013: ошибка во время регистрации устройства. Это может быть вызвано использованием неправильного ключа регистрации службы. | | Зарегистрируйте устройство еще раз, указав правильный ключ регистрации службы. Дополнительные сведения см. в статье [Получение ключа регистрации службы](https://msdn.microsoft.com/library/azure/cd4dee49-6ae8-4ff0-b79b-74b2027cb694#sec03). |
| 3 | Ошибка 350063: проверка подлинности в службе диспетчера StorSimple пройдена, однако произошел сбой регистрации. Повторите операцию через некоторое время. | Эта ошибка указывает, что проверка подлинности в ACS пройдена, однако произошел сбой вызова регистрации, адресованного службе. Это может быть результатом случайного сбоя в сети. | Если проблема будет повторяться, [обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx). |
| 4. | Ошибка 350049: не удалось связаться со службой во время регистрации. | При вызове службы получено веб-исключение. В некоторых случаях это можно исправить, повторив попытку выполнения операции позже. | Проверьте IP-адрес и DNS-имя и повторите попытку. Если проблема будет повторяться, [обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx). | 
| 5 | Ошибка 350031: устройство уже зарегистрировано. | | Никаких действий не требуется. |
| 6 | Ошибка 350016: не удалось выполнить регистрацию устройства. | |Убедитесь, что указан правильный ключ регистрации. |
| 7 | Invoke-HcsSetupWizard: произошла ошибка регистрации устройства; это может быть вызвано неправильным IP-адресом или DNS-именем. Проверьте параметры сети и повторите попытку. Если проблема будет повторяться, [обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx) (ошибка 350050). | Убедитесь, что устройство может проверить связь с внешней сетью. Если подключение к внешней сети отсутствует, может произойти сбой регистрации с этой ошибкой. Эту ошибку могут вызвать следующие факторы или их сочетание:<ul><li>неверный IP-адрес,</li><li>неверная подсеть,</li><li>неверный шлюз,</li><li>неверные настройки DNS.</li></ul> | См. пошаговое описание в разделе [Пошаговый пример устранения неполадок](#step-by-step-storsimple-troubleshooting-example). |
| 8 | Invoke-HcsSetupWizard: сбой текущей операции из-за внутренней ошибки в службе, [0x1FBE2]. Повторите операцию через некоторое время. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. | Это общая ошибка, возникающая при наличии любых невидимых пользователю ошибок в службе или агенте. Наиболее распространенной причиной является сбой проверки подлинности в ACS. Возможные причины сбоя: проблемы с конфигурацией NTP-сервера и неверная установка времени на устройстве. | Скорректируйте время (при наличии проблем) и повторите попытку регистрации. Если проблема будет повторяться, [обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx) для получения дальнейших инструкций. |
| 9 | Предупреждение: не удалось активировать устройство. Пароли администратора устройства и диспетчера моментальных снимков StorSimple не поменялись. | При сбое регистрации пароли администратора устройства и диспетчера моментальных снимков StorSimple не меняются. |

## Средства для устранения неполадок в развертываниях StorSimple

StorSimple включает в себя несколько средств, которые можно использовать для устранения неполадок в решении StorSimple. В частности, описаны такие возможности:

- Пакеты поддержки и журналы устройств. 
- Командлеты, специально разработанные для устранения неполадок. 

## Пакеты поддержки и журналы устройств, доступные для устранения неполадок

Пакет поддержки содержит все журналы, которые могут помочь сотрудникам службы поддержки Майкрософт в устранении неполадок на устройстве. Для создания зашифрованного пакета поддержки, который затем можно предоставить специалистам службы поддержки, можно воспользоваться Windows PowerShell для StorSimple.

### Просмотр журналов или содержимого пакета поддержки

1. Воспользуйтесь Windows PowerShell для StorSimple, чтобы создать пакет поддержки в соответствии с инструкциями в статье [Создание пакета поддержки](https://msdn.microsoft.com/library/azure/dn772348.aspx).

2. Загрузите [скрипт расшифровки](https://gallery.technet.microsoft.com/scriptcenter/Script-to-decrypt-a-a8d1ed65) в локальную систему на клиентском компьютере.

3. Используйте [пошаговое описание процедуры](https://msdn.microsoft.com/library/azure/dn762117.aspx), чтобы открыть и расшифровать пакет поддержки.

4. Расшифрованные журналы пакета поддержки записываются в формате etw/etvx. Для просмотра этих файлов в компоненте «Просмотр событий» Windows можно выполнить следующие действия:
  1. Выполните команду **eventvwr** в клиенте Windows. Это позволит запустить компонент «Просмотр событий».
  2. В области **Действия** щелкните **Открыть сохраненный журнал** и укажите файлы журнала в формате etvx/etw (пакет поддержки). Теперь можно просмотреть файл. После открытия файла можно щелкнуть правой кнопкой мыши и сохранить файл как обычный текст.
   
    > [AZURE.IMPORTANT]Можно также использовать командлет **Get-WinEvent**, чтобы открыть этот файл в Windows PowerShell. Дополнительные сведения см. в статье [Get-WinEvent](https://technet.microsoft.com/library/hh849682.aspx) справочной документации по командлетам Windows PowerShell.

5. При открытии журналов в компоненте «Просмотр событий» ищите указанные ниже журналы. Они содержат описание ошибок в конфигурации устройства.

  - hcs_pfconfig/Operational Log.
  - hcs_pfconfig/Config.

6. В файлах журналов ищите строки, имеющие отношение к командлетам, которые вызываются мастером установки. Список этих командлетов см. в разделе [Работа с мастером установки в первый раз](#first-time-setup-wizard-process). 

7. Если не удается определить причину проблемы, можно [обратиться в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx) для получения дальнейших инструкций. Обращаясь в службу поддержки Майкрософт за  помощью, выполните действия из статьи [Запуск сеанса поддержки](https://msdn.microsoft.com/library/azure/dn757804.aspx).

## Командлеты, доступные для устранения неполадок

Воспользуйтесь следующими командлетами Windows PowerShell для обнаружения ошибок подключения.

- Get-NetAdapter: используйте этот командлет для оценки состояния сетевых интерфейсов. 

- Test-Connection: используйте этот командлет для проверки сетевого подключения внутри сети и за ее пределами.

- Test-HcsmConnection: используйте этот командлет для проверки подключения успешно зарегистрированного устройства.

## Устранение неполадок с использованием командлета Get-NetAdapter

При настройке сетевых интерфейсов для развертывания устройства в первый раз данные о состоянии оборудования недоступны в пользовательском интерфейсе службы диспетчера StorSimple, поскольку устройство еще не зарегистрировано в службе. Кроме того, информация на странице «Состояние оборудования» может не всегда точно отражать состояние устройства, особенно при наличии проблем, влияющих на синхронизацию службы. В этих случаях можно использовать командлет Get-NetAdapter, чтобы определить состояние и статус сетевых интерфейсов в своей системе.

### Просмотр полного списка сетевых адаптеров на устройстве

1. Запустите Windows PowerShell для StorSimple, а затем введите **Get-NetAdapter**. 

2. Используйте выходные данные командлета Get-NetAdapter и следующие инструкции, чтобы узнать статус своего сетевого интерфейса.
  - Если интерфейс работоспособен и включен, параметр состояния **ifIndex** имеет значение **Up** (Работает).
  - Если интерфейс работоспособен, но не подключен физически (с использованием сетевого кабеля), параметр состояния **ifIndex** имеет значение **Disabled** (Отключен).
  - Если интерфейс работоспособен, но не включен, параметр состояния **ifIndex** имеет значение **NotPresent** (Нет).
  - Если интерфейс не существует, он не отображается в этом списке. Этот интерфейс будет отображаться в пользовательском интерфейсе службы диспетчера StorSimple в состоянии сбоя.

Дополнительные сведения об использовании этого командлета см. в статье [GetNetAdapter](https://technet.microsoft.com/library/jj130867.aspx) справочника по командлетам Windows PowerShell.

В следующих разделах показаны примеры выходных данных командлета Get-NetAdapter.

 В этих примерах контроллер 0 — пассивный, он имеет следующую конфигурацию:

- Сетевые интерфейсы DATA 0, DATA 1, DATA 2 и DATA 3 существуют на устройстве.
- Карт сетевых интерфейсов DATA 4 и DATA 5 нет; следовательно, они не указаны в выходных данных.
- Интерфейс DATA 0 включен.

Контроллер 1 — активный, он имеет следующую конфигурацию:

- Сетевые интерфейсы DATA 0, DATA 1, DATA 2, DATA 3, DATA 4 и DATA 5 существуют на устройстве.
- Интерфейс DATA 0 включен.

**Образец выходных данных, контроллер 0**

Далее приведены выходные данные контроллера 0 (пассивного контроллера). Интерфейсы DATA 1, DATA 2 и DATA 3 не подключены. Интерфейсы DATA 4 и DATA 5 не включены в список, потому что они отсутствуют на устройстве.

     Controller0>Get-NetAdapter
     Name                 InterfaceDescription                        ifIndex  Status
     ------               --------------------                        -------  ----------
     DATA3                Mellanox ConnectX-3 Ethernet Adapter #2     17       NotPresent
     DATA2                Mellanox ConnectX-3 Ethernet Adapter        14       NotPresent
     Ethernet 2           HCS VNIC                                    13       Up
     DATA1                Intel(R) 82574L Gigabit Network Co...#2     16       NotPresent
     DATA0                Intel(R) 82574L Gigabit Network Conn...     15       Up


**Образец выходных данных, контроллер 1**

Далее приведены выходные данные контроллера 1 (активного контроллера). Только сетевой интерфейс DATA 0 на этом устройстве настроен и работает.

     Controller1>Get-NetAdapter
     Name                 InterfaceDescription                        ifIndex  Status
     ------               --------------------                        -------  ----------
     DATA3                Mellanox ConnectX-3 Ethernet Adapter        18       NotPresent
     DATA2                Mellanox ConnectX-3 Ethernet Adapter #2     19       NotPresent
     DATA1                Intel(R) 82574L Gigabit Network Co...#2     16       NotPresent
     DATA0                Intel(R) 82574L Gigabit Network Conn...     15       Up
     Ethernet 2           HCS VNIC                                    13       Up
     DATA5                Intel(R) Gigabit ET Dual Port Server...     14       NotPresent
     DATA4                Intel(R) Gigabit ET Dual Port Serv...#2     17       NotPresent

 
## Устранение неполадок с использованием командлета Test-Connection

Можно воспользоваться командлетом Test-Connection, чтобы определить, может ли устройство StorSimple подключаться к внешней сети. Если все сетевые параметры, включая DNS, правильно настроены в мастере установки, можно воспользоваться командлетом Test-Connection, чтобы проверить связь с известным адресом за пределами сети, например outlook.com.

Примеры выходных данных командлета Test-Connection см. ниже.

> [AZURE.NOTE]В первом примере для устройства заданы неверные параметры DNS. В втором примере параметры DNS заданы верно.
 
**Пример вывода: неверные параметры DNS**

В следующем примере отсутствуют выходные данные для IPV4- и IPV6-адресов, что означает, что служба DNS не разрешена. Следовательно, подключение к внешней сети отсутствует, необходимо указать правильные параметры DNS.

     Source        Destination     IPV4Address      IPV6Address
     ------        -----------     -----------      -----------
     HCSNODE0      outlook.com
     HCSNODE0      outlook.com
     HCSNODE0      outlook.com
     HCSNODE0      outlook.com

**Пример вывода: верные параметры DNS**

В следующем примере DNS возвращает IPV4-адрес, что указывает на правильность настройки DNS. Это подтверждает наличие подключения к внешней сети.

     Source        Destination     IPV4Address      IPV6Address
     ------        -----------     -----------      -----------
     HCSNODE0      outlook.com     132.245.92.194
     HCSNODE0      outlook.com     132.245.92.194
     HCSNODE0      outlook.com     132.245.92.194
     HCSNODE0      outlook.com     132.245.92.194

## Устранение неполадок с использованием командлета Test-HcsmConnection

Используйте командлет Test-HcsmConnection для работы с устройством, которое уже подключено к службе диспетчера StorSimple и зарегистрировано в ней. Этот командлет помогает проверить подключение между зарегистрированным устройством и соответствующей службой диспетчера StorSimple. Эту команду можно выполнить в Windows PowerShell для StorSimple.

### Выполнение командлета Test-HcsmConnection

1. Убедитесь, что устройство зарегистрировано.

2. Проверьте состояние устройства. Если устройство деактивировано, находится в режиме обслуживания или отключено от сети, могут возникнуть следующие ошибки:

   - ErrorCode.CiSDeviceDecommissioned: устройство деактивировано.
   - ErrorCode.DeviceNotReady: устройство находится в режиме обслуживания.
   - ErrorCode.DeviceNotReady: устройство не подключено к сети.

3. Убедитесь, что запущена служба диспетчера StorSimple (воспользуйтесь командлетом [Get-ClusterResource](https://technet.microsoft.com/library/ee461004.aspx)). Если служба не запущена, возможны следующие ошибки:

   - ErrorCode.CiSApplianceAgentNotOnline.
   - ErrorCode.CisPowershellScriptHcsError: при выполнении командлета Get-ClusterResource возникло исключение.

4. Проверьте токен службы контроля доступа (ACS). Если возникает веб-исключение, причиной может быть проблема со шлюзом, непрохождение проверки подлинности на прокси-сервере, неверные параметры DNS или сбой проверки подлинности. Возможны следующие ошибки:

   - ErrorCode.CiSApplianceGateway: исключение HttpStatusCode.BadGateway, указывающее, что службе разрешения имен не удалось разрешить имя узла. 
   - ErrorCode.CiSApplianceProxy: исключение HttpStatusCode.ProxyAuthenticationRequired (код состояния HTTP 407): клиенту не удалось пройти проверку подлинности на прокси-сервере. 
   - ErrorCode.CiSApplianceDNSError: исключение WebExceptionStatus.NameResolutionFailure, указывающее, что службе разрешения имен не удалось разрешить имя узла.
   - ErrorCode.CiSApplianceACSError: служба вернула ошибку проверки подлинности, однако подключение имеется.
   
   Если веб-исключение не создается, проверьте следующее:

   - ErrorCode.CiSApplianceFailure: означает сбой в программно-аппаратном комплексе.

5. Проверьте подключение к облачной службе. Если служба создает веб-исключение, возможны  следующие ошибки:

  - ErrorCode.CiSApplianceGateway: исключение HttpStatusCode.BadGateway, указывающее, что промежуточный прокси-сервер получил недопустимый запрос от другого прокси-сервера или сервера-источника.
  - ErrorCode.CiSApplianceProxy: исключение HttpStatusCode.ProxyAuthenticationRequired (код состояния HTTP 407): клиенту не удалось пройти проверку подлинности на прокси-сервере. 
  - ErrorCode.CiSApplianceDNSError: исключение WebExceptionStatus.NameResolutionFailure, указывающее, что службе разрешения имен не удалось разрешить имя узла.
  - ErrorCode.CiSApplianceACSError: служба вернула ошибку проверки подлинности, однако подключение имеется.
  
  Если не создается веб-исключение, проверьте следующее: ошибка ErrorCode.CiSApplianceSaasServiceError указывает на проблему со службой диспетчера StorSimple.
 
6. Проверьте подключение к служебной шине Azure. ErrorCode.CiSApplianceServiceBusError: устройству не удается подключиться к служебной шине.
 
В файлах журналов CiSCommandletLog0Curr.errlog и CiSAgentsvc0Curr.errlog содержится больше информации, например сведения об исключениях.

Дополнительные сведения об использовании этого командлета см. в статье [Test-HcsmConnection](https://technet.microsoft.com/library/dn715782.aspx) в справочной документации по Windows PowerShell.

> [AZURE.IMPORTANT]Этот командлет можно выполнять и для активного, и для пассивного контроллера.
 
Примеры выходных данных командлета Test-HcsmConnection см. ниже.

**Пример вывода: устройство успешно зарегистрировано**

Первый пример — данные с устройства, которое было успешно зарегистрировано в службе диспетчера StorSimple и не имеет проблем с подключением.

     Controller1>Test-HcsmConnection -verbose
     Checking device state  ... Success.
     Device registered successfully
     Checking device authentication.  ... This operation will take few minutes to complete....
     Checking device authentication.  ... Success.
     Checking connectivity from device to StorSimple Manager service.  ... This operation will take few minutes to complete....
     Checking connectivity from device to StorSimple Manager service.  ... Success.
     Checking connectivity from StorSimple Manager service to StorSimple device. .... Success.
     Controller1>

**Пример вывода: автономное устройство**

Данный пример — это данные с устройства с состоянием **Вне сети** на портале управления.

     Checking device state: Success 
     Device is registered successfully 
     Checking connectivity from device to SaaS.. Failure

Устройству не удалось подключиться с помощью текущей конфигурации веб-прокси. Причиной может являться проблема в конфигурации веб-прокси или проблема с подключением к сети. В этом случае следует убедиться в правильности параметров веб-прокси и в том, что веб-прокси-серверы подключены к сети и доступны.

## Пример с пошаговыми инструкциями по устранению неполадок в устройстве StorSimple

В следующем примере показано пошаговое устранение неполадок в развертывании StorSimple. В этом сценарии регистрация устройства завершается сбоем с сообщением об ошибке, которое указывает, что параметры сети или DNS-имя неверны.

Возвращаемое сообщение об ошибке:

     Invoke-HcsSetupWizard: An error has occurred while registering the device. This could be due to incorrect IP address or DNS name. Please check your network settings and try again. If the problems persist, contact Microsoft Support.
     +CategoryInfo: Not specified
     +FullyQualifiedErrorID: CiSClientCommunicationErros, Microsoft.HCS.Management.PowerShell.Cmdlets.InvokeHcsSetupWizardCommand

Ошибка может быть вызвана следующими причинами:

- Неверная установка оборудования.
- Неисправные сетевые интерфейсы.
- Неправильный IP-адрес, маска подсети, шлюз, основной DNS-сервер или веб-прокси.
- Неверный ключ регистрации.
- Неверные настройки брандмауэра.

### Поиск и устранение проблем с регистрацией устройства

1. Проверьте конфигурацию устройств: на активном контроллере выполните командлет **Invoke-HcsSetupWizard**.

     >[AZURE.NOTE]Мастер установки необходимо выполнять на активном контроллере. Чтобы убедиться, что вы подключены к активному контроллеру, посмотрите на баннер на последовательной консоли. Баннер показывает, к какому контроллеру вы подключены (0 или 1) и является ли контроллер активным или пассивным. Дополнительные сведения см. в статье [Определение активного контроллера на устройстве](https://msdn.microsoft.com/library/azure/dn790262.aspx).
 
2. Убедитесь, что устройство правильно подключено: проверьте подключение сетевых кабелей на задней панели устройства. Схема подключения кабелей различается в зависимости от модели устройства. Дополнительные сведения см. в статье [Подключение кабелей к устройству 8100](https://msdn.microsoft.com/library/azure/dn757738.aspx) или [Подключение кабелей к устройству 8600](https://msdn.microsoft.com/library/azure/dn757762.aspx).

     >[AZURE.NOTE]При использовании сетевых портов 10 GbE, необходимо будет использовать поставляемые в комплекте адаптеры QSFP-SFP и кабели SFP. Дополнительные сведения см. в статье [Список кабелей, коммутаторов и приемопередатчиков, рекомендуемых OEM-поставщиком для портов Mellanox](http://www.mellanox.com/page/cables?mtag=cable_overview).
 
3. Убедитесь в работоспособности сетевого интерфейса:

   - Воспользуйтесь командлетом Get-NetAdapter, чтобы определить работоспособность сетевых интерфейсов для DATA 0. 
   - Если связь не работает, состояние **ifindex** укажет на то, что интерфейс не работает. Затем необходимо будет проверить сетевое подключение порта к устройству и коммутатору. Также необходимо будет исключить поврежденные кабели. 
   - Если вы подозреваете, что произошел сбой порта DATA 0 на активном контроллере, это можно проверить, подключившись к порту DATA 0 на контроллере 1. Чтобы проверить это, отключите сетевой кабель на задней панели устройства от контроллера 0, подключите его к контроллеру 1 и снова выполните командлет Get-NetAdapter. Если происходит сбой порта DATA 0 на контроллере, [обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx) для получения дальнейших инструкций. Возможно, потребуется заменить контроллер в системе.
 
4. Проверьте подключение к коммутатору:
   - Убедитесь что сетевые интерфейсы DATA 0 на контроллере 0 и контроллере 1 основного корпуса находятся в одной подсети. 
   - Проверьте концентратор или маршрутизатор. Как правило, необходимо подключить оба контроллера к одному и тому же концентратору или маршрутизатору. 
   - Убедитесь, что коммутаторы, используемые для подключения, настроены на размещение портов DATA 0 для обоих контроллеров в одной виртуальной ЛС.
   
5. Исключите ошибки пользователей:

  - Снова запустите мастер установки (выполните командлет **Invoke-HcsSetupWizard**) и снова введите значения, чтобы убедиться в отсутствии ошибок. 
  - Проверьте используемый ключ регистрации. Один и тот же ключ регистрации можно использовать для подключения к службе диспетчера StorSimple нескольких устройств. Воспользуйтесь процедурой, описанной в статье [Получение ключа регистрации службы](https://msdn.microsoft.com/library/azure/cd4dee49-6ae8-4ff0-b79b-74b2027cb694#sec03), чтобы убедиться, что используется правильный ключ регистрации.

    > [AZURE.IMPORTANT]Если выполняется несколько служб, необходимо убедиться, что для регистрации устройства используется ключ регистрации от правильной службы. Если устройство зарегистрировано в неверной службе диспетчера StorSimple, необходимо [обратиться в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx) для получения дальнейших инструкций. Возможно, потребуется восстановить на устройстве заводские настройки (что может привести к потере данных), чтобы подключить его к правильной службе.

6. Используйте командлет Test-Connection, чтобы убедиться в наличии подключения к внешней сети. Дополнительные сведения см. в разделе [Устранение неполадок с использованием командлета Test-Connection](#troubleshoot-with-the-test-connection-cmdlet).

7. Проверьте на помехи со стороны брандмауэра. Если вы убедились в правильности настроек виртуального IP-адреса (VIP), подсети, шлюза и DNS, а проблемы подключения не устранены, возможно, ваш брандмауэр блокирует связь между устройством и внешней сетью. Необходимо убедиться, что порты 80 и 443 на устройстве StorSimple доступны для исходящего трафика. Дополнительные сведения см. в статье [Сетевые требования устройства StorSimple](https://msdn.microsoft.com/library/azure/dn772371.aspx).

8. Просмотрите журналы. Перейдите в раздел [Пакеты поддержки и журналы устройств, доступные для устранения неполадок](#support-packages-and-device logs-for-troubleshooting).

9. Если разрешить проблему, выполнив предыдущие действия, не удалось, [обратитесь в службу поддержки Майкрософт](https://msdn.microsoft.com/library/azure/dn757750.aspx) за помощью.

## Дальнейшие действия
[Устранение неполадок в работающем устройстве](../storsimple-troubleshoot-an-operational-device.md)

<!--Link references-->

[1]: https://technet.microsoft.com/library/dd379547(v=ws.10).aspx
[2]: https://technet.microsoft.com/library/dd392266(v=ws.10).aspx
<!--HONumber=52-->
 