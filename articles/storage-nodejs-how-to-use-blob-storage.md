<properties linkid="dev-nodejs-how-to-blob-storage" urlDisplayName="Служба BLOB-объектов" pageTitle="Использование хранилища BLOB-объектов (Node.js) | Microsoft Azure" metaKeywords="Начало работы с BLOB-объектом Azure, неструктурированные данные Azure, неструктурированное хранилище Azure, BLOB-объект Azure, хранилище BLOB-объектов Azure, BLOB-объект Azure Node.js" description="Узнайте, как использовать службу BLOB-объектов Azure для передачи, загрузки, перечисления и удаления содержания BLOB-объектов. Примеры кода, написанные на Node.js." metaCanonical="" services="storage" documentationCenter="Node.js" title="Использование службы BLOB-объектов из Node.js" authors="" solutions="" manager="" editor="" />





# Использование службы BLOB-объектов из Node.js

В этом руководстве показано, как реализовать типичные сценарии с использованием службы BLOB-объектов Azure. Примеры написаны с помощью
API-интерфейса Node.js. Здесь описаны такие сценарии, как **отправка**, **перечисление**,
**загрузка** и **удаление** BLOB-объектов. Дополнительные сведения о BLOB-объектах
см. в разделе [Дальнейшие действия][].

## Оглавление

* [Что такое служба BLOB-объектов?][]    
* [Основные понятия][]    
* [Создание учетной записи хранения Azure][]   
* [Создание приложения Node.js][]   
* [Настройка приложения для доступа к хранилищу][]   
* [Настройка строки подключения к хранилищу Azure][]   
* [Практическое руководство. Создание контейнера][]   
* [Практическое руководство. Отправка BLOB-объекта в контейнер][]   
* [Практическое руководство. Перечисление BLOB-объектов в контейнере][]   
* [Практическое руководство. Загрузка BLOB-объектов][]   
* [Практическое руководство. Удаление BLOB-объекта][]   
* [Дальнейшие действия][]

## <a name="what-is"> </a>Что такое служба BLOB-объектов?

Служба BLOB-объектов Azure предназначена для хранения большого количества неструктурированных данных, к которым можно получить доступ практически из любой точки мира по протоколу HTTP или HTTPS. Один BLOB-объект может быть размером сотни гигабайт, а
одна учетная запись хранения может содержать до 100 ТБ BLOB-объектов. Наиболее частые способы
использования BLOB-объектов:

-   Обслуживание изображений или документов непосредственно в браузере
-   Хранение файлов для распределенного доступа
-   Потоковая передача видео и аудио
-   Безопасное выполнение резервного копирования и аварийного восстановления
-   Хранение данных для анализа локальной службой или службой, размещенной в Azure

BLOB-объекты можно использовать для предоставления данных в открытом доступе всему миру
или в частном порядке для хранения внутренних приложений.

## <a name="concepts"> </a>Основные понятия

Служба Blob-объектов содержит следующие компоненты:

![Blob1](./media/storage-nodejs-how-to-use-blob-storage/blob1.jpg)

-   **Формат URL-адреса**. К BLOB-объектам можно обратиться, используя следующий формат
    URL-адреса:
   
    	http://storageaccount.blob.core.windows.net/container/blob  
      
    Следующий URL-адрес позволяет обратиться к одному из BLOB-объектов на схеме: 
 
	    http://sally.blob.core.windows.net/movies/MOV1.AVI

-   **Учетная запись хранилища.** Весь доступ к хранилищу 
    Azure осуществляется с помощью учетной записи хранения. Это самое высокоуровневое пространство имен для доступа
    к BLOB-объектам. Учетная запись может содержать неограниченное число
    контейнеров при условии, что их общий размер не достигает 100 ТБ.

-   **Контейнер**. Контейнер обеспечивает группирование набора BLOB-объектов.
    Все BLOB-объекты должны содержаться в контейнере. Учетная запись может содержать неограниченное число контейнеров. Контейнер может хранить неограниченное количество BLOB-объектов.

-   **BLOB-объект**. Файл любого типа и размера. Существует два типа BLOB-объектов — блоки и страницы. Большинство файлов являются
    BLOB-блоками. Единичный BLOB-блок может иметь размер до 200 ГБ. В этом учебнике
    используются BLOB-блоки. BLOB-страницы, другой тип BLOB-объекта, могут иметь размер до 1 ТБ.
    Они более эффективны, когда диапазоны байтов в файле
    часто изменяются.

## <a name="create-account"> </a>Создание учетной записи хранения Azure

Для выполнения операций хранилища необходимо использовать учетную запись хранения Azure. Выполнив
следующие шаги, вы создадите учетную запись хранения. (Можно также
создать учетную запись хранения [с помощью интерфейса API REST][].)

1.  Выполните вход на [портал управления Azure].

2.  В нижней части области навигации щелкните **+СОЗДАТЬ**.

	![+new](./media/storage-nodejs-how-to-use-blob-storage/plus-new.png)

3.  Щелкните **Учетная запись хранения**, а затем **Быстрое создание**.

	![Диалоговое окно "Быстрое создание"](./media/storage-nodejs-how-to-use-blob-storage/quick-storage.png)

4.  В поле URL-адреса введите имя дочернего домена для использования URI для
    учетной записи хранения. Записи могут содержать от 3 до 24 строчных букв и цифр. Это значение становится именем узла в URI, который используется для адресации ресурсов BLOB-объекта, очереди и таблицы для подписки.

5.  Выберите регион или территориальную группу, где требуется расположить
    хранилище. При использовании хранилища в приложении Azure
    выберите область, в которой будет разворачиваться
    приложение.

6.  Щелкните **Создать учетную запись хранения**.

## <a name="create-app"> </a>Создание приложения Node.js

Создайте пустое приложение Node.js. Инструкции по созданию приложения Node.js см. в статьях [Создание и развертывание приложения Node.js на веб-сайте Azure], [Облачная служба Node.js] (с помощью Windows PowerShell) или [Веб-сайт с WebMatrix].

## <a name="configure-access"> </a>Настройка приложения для доступа к хранилищу

Для использования хранилища Azure необходимо загрузить и использовать пакет Node.js Azure,
который содержит набор библиотек, взаимодействующих
со службами REST хранилища.

### Использование диспетчера пакета Node (NPM) для получения пакета

1.  Используя интерфейс командной строки, такой как **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix), перейдите в папку, в которой создан пример приложения.

2.  Введите в командной строке **npm install azure**, что должно привести к следующему результату:

        azure@0.7.5 node_modules\azure
		├── dateformat@1.0.2-1.2.3
		├── xmlbuilder@0.4.2
		├── node-uuid@1.2.0
		├── mime@1.2.9
		├── underscore@1.4.4
		├── validator@1.1.1
		├── tunnel@0.0.2
		├── wns@0.5.3
		├── xml2js@0.2.7 (sax@0.5.2)
		└── request@2.21.0 (json-stringify-safe@4.0.0, forever-agent@0.5.0, aws-sign@0.3.0, tunnel-agent@0.3.0, oauth-sign@0.3.0, qs@0.6.5, cookie-jar@0.3.0, node-uuid@1.4.0, http-signature@0.9.11, form-data@0.0.8, hawk@0.13.1)

3.  Можно вручную выполнить команду **ls**, чтобы убедиться в создании папки **node\_modules**. В этой папке находится пакет
    **azure**, содержащий библиотеки, необходимые для
    доступа к хранилищу.

### Импорт пакета

С помощью программы Блокнот или другого текстового редактора добавьте следующее в начало
файла **Server.js** приложения, где планируется использовать хранилище:

    var azure = require('azure');

## <a name="setup-connection-string"> </a>Настройка подключения к хранилищу Azure

Модуль Azure считывает переменные среды AZURE\_STORAGE\_ACCOUNT и AZURE\_STORAGE\_ACCESS\_KEY с целью получения сведений, необходимых для подключения к учетной записи хранения Azure. Если эти переменные среды не заданы, при вызове **createBlobService** необходимо указать данные учетной записи.

Пример настройки переменных среды в файле конфигурации для облачной службы Azure см. в статье [Облачная служба Node.js с хранилищем].

Пример настройки переменных среды на портале управления для веб-сайта Azure см. в статье [Веб-приложение Node.js с хранилищем]

## <a name="create-container"> </a>Практическое руководство. Создание контейнера

Объект **BlobService** позволяет работать с контейнерами и BLOB-объектами. Следующий код создает объект **BlobService**. Добавьте в начало **server.js**
следующий код:

    var blobService = azure.createBlobService();

Все BLOB-объекты содержатся в контейнере. Вызов
**createContainerIfNotExists** для объекта **BlobService** возвращает
указанный контейнер, если он уже существует, или создает новый контейнер с указанным именем,
если он еще не был создан. По умолчанию новый
контейнер является закрытым, и вам необходимо использовать ключ доступа, чтобы загрузить BLOB-объекты из этого контейнера.

	blobService.createContainerIfNotExists(containerName, function(error){
    	if(!error){
        	// Container exists and is private
    	}
	});


Если вы хотите сделать файлы в контейнере общедоступными, чтобы для обращения к ним не требовался ключ доступа, можно задать для контейнера уровень доступа **blob** или **container**. При установке уровня доступа **blob** можно осуществлять анонимный доступ для чтения к содержимому и метаданным BLOB-объектов внутри этого контейнера, но не к метаданным контейнера, например, для перечисления всех BLOB-объектов в контейнере. При установке уровня доступа **container** можно осуществлять анонимный доступ для чтения к содержимому и метаданным BLOB-объектов, а также к метаданным контейнера. В следующем примере показана установка уровня доступа **blob**: 

    blobService.createContainerIfNotExists(containerName
		, {publicAccessLevel : 'blob'}
		, function(error){
			if(!error){
				// Container exists and is public
			}
		});

Кроме того, можно изменить уровень доступа к контейнеру, используя метод **setContainerAcl** для указания уровня доступа. В следующем примере уровень доступа изменяется на "container":

    blobService.setContainerAcl(containerName
		, 'container'
		, function(error){
			if(!error){
				// Container access level set to 'container'
			}
		});

###Фильтры

Используя **QueueService**, к выполняемым операциям можно применить дополнительные операции фильтрации. К операциям фильтрации могут относиться ведение журнала, автоматически повтор и т. д. Фильтры являются объектами, реализующими метод со следующей сигнатурой:

		function handle (requestOptions, next)

Выполнив предварительную обработку параметров запроса, метод должен вызвать "next", передавая обратный вызов со следующей сигнатурой:

		function (returnObject, finalCallback, next)

В этой функции обратного вызова и после обработки returnObject (ответ на запрос к серверу) функция обратного вызова должна либо вызвать "next", если он существует, чтобы продолжить обработку других фильтров, либо в противном случае просто вызвать "finalCallback" для завершения обращения к службе.

В Azure SDK для Node.js включены два фильтра, реализующие логику повторных попыток: **ExponentialRetryPolicyFilter** и **LinearRetryPolicyFilter** Следующий код создает объект **BlobService**, использующий **ExponentialRetryPolicyFilter**:

	var retryOperations = new azure.ExponentialRetryPolicyFilter();
	var blobService = azure.createBlobService().withFilter(retryOperations);

## <a name="upload-blob"> </a>Практическое руководство. Отправка BLOB-объекта в контейнер

Для отправки данных в BLOB-объект используйте методы **createBlockBlobFromFile**, **createBlockBlobFromStream** или **createBlockBlobFromText**. **createBlockBlobFromFile** передает содержимое файла, а **createBlockBlobFromStream** передает содержимое потока. **createBlockBlobFromText** передает указанное текстовое значение.

В следующем примере содержимое файла **test1.txt** передается в BLOB-объект "test1".

	blobService.createBlockBlobFromFile(containerName
		, 'test1'
		, 'test1.txt'
		, function(error){
			if(!error){
				// File has been uploaded
			}
		});

## <a name="list-blob"> </a>Практическое руководство. Перечисление BLOB-объектов в контейнере

Чтобы получить список BLOB-объектов в контейнере, используйте метод **listBlobs** в цикле
**for** для отображения имени каждого BLOB-объекта в контейнере. Следующий
код выводит на консоль имя (**name**) каждого BLOB-объекта в
контейнере.

    blobService.listBlobs(containerName, function(error, blobs){
		if(!error){
			for(var index in blobs){
				console.log(blobs[index].name);
			}
		}
	});

## <a name="download-blobs"> </a>Практическое руководство. Загрузка BLOB-объектов

Чтобы загрузить данные из BLOB-объекта, используйте **getBlobToFile**, **getBlobToStream** или **getBlobToText** В следующем примере показано, как использовать метод **getBlobToStream**, чтобы загрузить содержимое BLOB-объекта **test1** и сохранить его в файл **output.txt** с помощью потока.

    var fs=require('fs');
	blobService.getBlobToStream(containerName
		, 'test1'
		, fs.createWriteStream('output.txt')
		, function(error){
			if(!error){
				// Wrote blob to stream
			}
		});

## <a name="delete-blobs"> </a>Практическое руководство. Удаление BLOB-объекта

Наконец, чтобы удалить BLOB-объект, вызовите **deleteBlob**. В следующем примере удаляется BLOB-объект с именем "blob1".

    blobService.deleteBlob(containerName
		, 'blob1'
		, function(error){
			if(!error){
				// Blob has been deleted
			}
		});

## <a name="next-steps"> </a>Дальнейшие действия

Вы изучили основные сведения о хранилище BLOB-объектов. Дополнительные сведения о более сложных задачах по использованию хранилища можно найти по следующим ссылкам.

-   См. справочник MSDN: [Хранение данных и доступ к ним в Azure][].
-   Посетите блог [команды разработчиков хранилища Azure][].
-   Посетите репозиторий [Azure SDK для Node] на веб-сайте GitHub.

  [Azure SDK для Node]: https://github.com/WindowsAzure/azure-sdk-for-node
  [Дальнейшие действия]: #next-steps
  [Что такое служба BLOB-объектов?]: #what-is
  [Основные понятия]: #concepts
  [Создание учетной записи хранения Azure]: #create-account
  [Создание приложения Node.js]: #create-app
  [Настройка приложения для доступа к хранилищу]: #configure-access
  [Настройка строки подключения к хранилищу Azure]: #setup-connection-string
  [Практическое руководство. Создание контейнера]: #create-container
  [Практическое руководство. Отправка BLOB-объекта в контейнер]: #upload-blob
  [Практическое руководство. Перечисление BLOB-объектов в контейнере]: #list-blob
  [Практическое руководство. Загрузка BLOB-объектов]: #download-blobs
  [Практическое руководство. Удаление BLOB-объекта]: #delete-blobs
[Создание и развертывание приложения Node.js на веб-сайте Azure]: /ru-ru/develop/nodejs/tutorials/create-a-website-(mac)/
  [Облачная служба Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-app-with-storage/
  [Веб-приложение Node.js с хранилищем]: /ru-ru/develop/nodejs/tutorials/web-site-with-storage/
 [Веб-сайт с WebMatrix]: /ru-ru/develop/nodejs/tutorials/web-site-with-webmatrix/
  [Использование REST API]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh264518.aspx
  [Портал управления Azure]: http://manage.windowsazure.com
  [Облачная служба Node.js]: {localLink:2221} "веб-приложение Node.js"
  [Хранение данных и доступ к ним в Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/gg433040.aspx
  [команды разработчиков хранилища Azure]: http://blogs.msdn.com/b/windowsazurestorage/

