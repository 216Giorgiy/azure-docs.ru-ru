<properties
   pageTitle="Повышение эффективности узлов в пакетной службе благодаря параллельному выполнению задач на узлах | Microsoft Azure"
   description="Вы можете увеличить эффективность и снизить стоимость, используя меньшее количество вычислительных узлов. Это возможно благодаря параллельному выполнению задач на каждом узле в пуле пакетной службы Azure."
   services="batch"
   documentationCenter=".net"
   authors="mmacy"
   manager="timlt"
   editor=""/>

   <tags
   	ms.service="batch"
   	ms.devlang="multiple"
   	ms.topic="article"
   	ms.tgt_pltfrm="vm-windows"
   	ms.workload="big-compute"
   	ms.date="09/30/2015"
   	ms.author="v-marsma"/>

# Повышение эффективности вычислительных ресурсов в пакетной службе Azure благодаря параллельному выполнению задач на узлах

Параллельное выполнение масштабных задач является основной функцией пакетной службы Azure. Эти возможности подразумевают не только использование множества вычислительных узлов для клиентских задач, но и выполнение на этих узлах параллельных задач. Пакетная служба позволяет как увеличивать масштаб выполнения параллельных задач, так и развертывать их.

Используя выполнение параллельных задач на вычислительных узлах пула, вы обеспечите максимальную эффективность ресурсов с меньшим количеством узлов в пуле. Во многих случаях выгоднее использовать все ресурсы узла для выполнения одной задачи. Но для некоторых ситуаций совместное использование ресурсов несколькими задачами дает следующие преимущества.

 - Если задачи могут совместно использовать один набор данных, **уменьшается объем передачи данных**. В таком случае общие данные копируются на меньшее число узлов, а параллельное выполнение задач на каждом узле позволит существенно снизить затраты при передаче данных. Это будет особенно заметно в том случае, если данные передаются между узлами, расположенными в разных географических регионах.

 - Если задачам нужен большой объем памяти в течение коротких промежутков времени и на разных этапах выполнения, **повышается эффективность использования памяти**. Меньшее количество более крупных экземпляров узлов с большим объемом памяти будет более эффективно обрабатывать такие задачи с пиковыми периодами. Параллельное выполнение задач на каждом узле позволит задачам в разное время эффективно использовать огромные ресурсы памяти.

 - Если требуется взаимодействие между узлами в пуле, **уменьшается ограничение по количеству узлов**. Сейчас существует ограничение в 50 узлов для пулов, в которых настроен обмен данными между узлами. Если каждый узел в таком пуле будет выполнять задачи параллельно, можно будет выполнять больше задач одновременно.

 - **Выполняется репликация локального вычислительного кластера** (например, как при первичном переходе в вычислительную среду Azure). Увеличение максимального числа задач на узле позволит более точно скопировать существующую физическую конфигурацию, если она ранее позволяла выполнять несколько задач на каждом вычислительном узле.

## Пример сценария

Чтобы продемонстрировать преимущества параллельного выполнения задач, рассмотрим такой пример. Допустим, ваше приложение имеет такие требования к ЦП и памяти, что для его работы достаточно узла размера Standard\_D1, но чтобы выполнить задание в установленный срок, потребуется 1000 таких узлов. Вместо узлов размера Standard\_D1 вы можете применить 16-ядерные узлы Standard\_D14, включив на них параллельное выполнение задач. В этом случае потребуется *в 16 раз меньше узлов*, то есть 63 узла вместо 1000. Это значительно ускорит выполнение работы и повысит эффективность, если для каждого узла требуются файлы приложения или справочные данные большого объема.

## Включение параллельного выполнения задач

Настройка параллельного выполнения задач для вычислительных узлов в пакетной службе выполняется на уровне пула. Если вы используете API .NET пакетной службы, задайте при создании пула свойство [CloudPool.MaxTasksPerComputeNode][maxtasks_net]. В REST API пакетной службы включите элемент [maxTasksPerNode][maxtasks_rest] в текст запроса при создании пула.

Пакетная служба Azure позволяет задать для каждого узла максимальное количество задач, в четыре раза превышающее количество ядер узла. Например, если для пула настроены узлы размера «Большой» (четыре ядра), для параметра `maxTasksPerNode` можно задать значение 16. Информация о количестве ядер для каждого размера узла доступна в статье [Размеры виртуальных машин](../virtual-machines/virtual-machines-size-specs.md). Дополнительные сведения об ограничениях службы см. в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-subscription-service-limits.md).

> [AZURE.TIP]Обязательно учитывайте значение параметра `maxTasksPerNode` при создании [формулы автомасштабирования][enable_autoscaling] для пула. Например, если в формуле учитывается параметр `$RunningTasks`, изменение количества задач существенно повлияет на результат ее применения. Дополнительные сведения см. в статье [Автоматическое масштабирование вычислительных узлов в пуле пакетной службы Azure](batch-automatic-scaling.md).

## Распределение задач

Если вычислительные узлы в пуле могут выполнять задачи параллельно, важно указать правила распределения задач между узлами пула.

Свойство [CloudPool.TaskSchedulingPolicy][task_schedule] позволяет выбрать один из двух вариантов распределения. Пул может равномерно распределять задачи между узлами («распространение») или передавать максимально возможное количество задач на один узел, прежде чем переходить к следующему («упаковка»).

Чтобы понять важность этой функции, давайте рассмотрим пул из предыдущего примера. Он состоит из узлов размера Standard\_D14, для которых параметр [CloudPool.MaxTasksPerComputeNode][maxtasks_net] имеет значение 16. Если в свойстве [CloudPool.TaskSchedulingPolicy][task_schedule] для параметра [ComputeNodeFillType][fill_type] будет указано значение *Pack* («упаковка»), на каждом узле все 16 ядер будут задействованы по максимуму. При этом [автомасштабируемый пул](./batch-automatic-scaling.md) будет исключать неиспользуемые узлы (для которых не назначены задачи), что снизит использование ресурсов и расходы на них.

## Пример использования компонента .NET пакетной службы

Этот фрагмент кода для интерфейса API [.NET пакетной службы][api_net] содержит запрос на создание пула с четырьмя большими узлами и не более чем четырьмя задачами на каждый узел. кроме того, этот запрос определяет политику распределения задач, согласно которой каждый узел будет полностью заполняться задачами до перехода к следующему узлу. Дополнительные сведения о добавлении пулов с использованием API .NET пакетной службы см. в описании метода [BatchClient.PoolOperations.CreatePool][poolcreate_net].

        CloudPool pool = batchClient.PoolOperations.CreatePool(poolId: "mypool",
        													osFamily: "2",
        													virtualMachineSize: "large",
        													targetDedicated: 4);
        pool.MaxTasksPerComputeNode = 4;
        pool.TaskSchedulingPolicy = new TaskSchedulingPolicy(ComputeNodeFillType.Pack);
        pool.Commit();

## Пример интерфейса REST API пакетной службы

Этот фрагмент кода для [REST API пакетной службы][api_rest] содержит запрос на создание пула с двумя большими узлами и максимальным количеством задач на каждый узел, равным четырем. Дополнительные сведения о добавлении пулов с помощью REST API см. в статье [Добавление пула][maxtasks_rest].

        {
          "id": "mypool",
          "vmSize": "Large",
          "osFamily": "2",
          "targetOSVersion": "*",
          "targetDedicated": 2,
          "enableInterNodeCommunication": false,
          "maxTasksPerNode": 4
        }

> [AZURE.NOTE]Элемент `maxTasksPerNode` и свойство [MaxTasksPerComputeNode][maxtasks_net] можно задать только во время создания пула. Их невозможно изменить после создания пула.

## Изучение примера проекта

Откройте на сайте GitHub проект [ParallelNodeTasks][parallel_tasks_sample]. Он содержит рабочий пример кода, в котором используется свойство [CloudPool.MaxTasksPerComputeNode][maxtasks_net]. Это консольное приложение на C# использует библиотеку [.NET пакетной службы][api_net] для создания пула с одним или несколькими вычислительными узлами, а затем выполняет на них задачи для моделирования переменной нагрузки. Количество задач можно настроить самостоятельно. Выходные данные приложения показывают, какие узлы выполняли каждую задачу, а также содержат сводку параметров задания и длительности его выполнения. Ниже приводится часть сводки выходных данных примера приложения по двум различным запускам.

```
Nodes: 1
Node size: large
Max tasks per node: 1
Tasks: 32
Duration: 00:30:01.4638023
```

Первый запуск выполнялся с одним узлом в пуле и одной задачей на узел. Результаты выполнения демонстрируют, что на все задание было затрачено более 30 минут.

```
Nodes: 1
Node size: large
Max tasks per node: 4
Tasks: 32
Duration: 00:08:48.2423500
```

При втором запуске примера удалось значительно сократить время выполнения — почти в четыре раза. Это было достигнуто благодаря параллельному выполнению четырех задач на узле.

> [AZURE.NOTE]В приведенных выше сводках длительность выполнения задания не включает время создания пула. Каждое из заданий в примерах выше отправлялось в уже созданные пулы, вычислительные узлы которых на момент отправки находились в состоянии *простоя*.

## Тепловая карта обозревателя пакетной службы

В списке [примеров приложений][github_samples] пакетной службы Azure есть [обозреватель пакетной службы][batch_explorer]. Он содержит функцию *тепловой карты*, которая иллюстрирует использование ядер на всех узлах в пуле. Используйте эту тепловую карту при выполнении приложения [ParallelTasks][parallel_tasks_sample], чтобы наглядно оценить загрузку ядер узла.

![Тепловая карта обозревателя пакетной службы][1]

*Тепловая карта обозревателя пакетной службы демонстрирует четыре четырехъядерных узла, при этом на каждом из ядер выполняется задача*

[api_net]: http://msdn.microsoft.com/library/azure/mt348682.aspx
[api_rest]: http://msdn.microsoft.com/library/azure/dn820158.aspx
[batch_explorer]: http://blogs.technet.com/b/windowshpc/archive/2015/01/20/azure-batch-explorer-sample-walkthrough.aspx
[cloudpool]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.aspx
[enable_autoscaling]: https://msdn.microsoft.com/library/azure/dn820173.aspx
[fill_type]: https://msdn.microsoft.com/ru-RU/library/microsoft.azure.batch.common.computenodefilltype.aspx
[github_samples]: https://github.com/Azure/azure-batch-samples
[maxtasks_net]: http://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.maxtaskspercomputenode.aspx
[maxtasks_rest]: https://msdn.microsoft.com/library/azure/dn820174.aspx
[parallel_tasks_sample]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/ParallelTasks
[poolcreate_net]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.pooloperations.createpool.aspx
[task_schedule]: https://msdn.microsoft.com/library/microsoft.azure.batch.cloudpool.taskschedulingpolicy.aspx

[1]: ./media/batch-parallel-node-tasks\heat_map.png

<!---HONumber=Oct15_HO3-->