---
title: "Комплексное выполнение пакетных заданий Azure без написания кода (предварительная версия) | Документация Майкрософт"
description: "Узнайте, как создать файлы шаблонов для Azure CLI для создания пулов, заданий и задач пакетной службы."
services: batch
author: mscurrell
manager: timlt
ms.assetid: 
ms.service: batch
ms.devlang: na
ms.topic: article
ms.workload: big-compute
ms.date: 07/07/2017
ms.author: markscu
ms.translationtype: HT
ms.sourcegitcommit: 2ad539c85e01bc132a8171490a27fd807c8823a4
ms.openlocfilehash: 9f8a1d7ab39a2d1e5a095f3b4d9bafef07d4086b
ms.contentlocale: ru-ru
ms.lasthandoff: 07/12/2017

---

# <a name="use-azure-batch-cli-templates-and-file-transfer-preview"></a>Использование шаблонов интерфейса командной строки для пакетной службы Azure и передачи файлов (предварительная версия)

С помощью Azure CLI можно комплексно выполнять пакетные задания Azure без написания кода.

Файлы шаблонов можно создавать и использовать с Azure CLI, что позволяет создавать пулы, задания и задачи пакетной службы. Входные файлы задания можно с легкостью передать в учетную запись хранения, связанную с учетной записью пакетной службы, и выходные файлы задания — скачать.

## <a name="overview"></a>Обзор

Это расширение Azure CLI дает возможность пользователям, которые не являются разработчиками, комплексно использовать пакетную службу. Можно создавать пулы, задания и связанные с ними задачи, передавать входные данные и скачивать получаемые выходные данные — и все это без написания кода. При этом интерфейс командной строки используются напрямую или интегрируется в сценарии.

Шаблоны пакетной службы создаются на основе [существующей поддержки пакетной службы в Azure CLI](https://docs.microsoft.com/azure/batch/batch-cli-get-started#json-files-for-resource-creation), что позволяет JSON-файлам указывать значения свойств для создания пулов, заданий, задач и других элементов. Благодаря шаблонам пакетной службы к имеющимся функциям JSON-файлов добавляются следующие возможности:

-   Возможность определять параметры. При использовании шаблона указываются только значения параметров для создания элемента, а остальные значения свойств элемента содержатся в теле шаблона. Пользователь, понимающий принцип работы пакетной службы и приложений, запускаемых пакетной службой, может создавать шаблоны, указывая значения свойств пулов, заданий и задач. Если пользователь мало знаком с пакетной службой и (или) приложениями, то ему необходимо указать только значения определенных параметров.

-   Фабрики задач позволяют с легкостью создать несколько задач для одного задания, что избавляет от необходимости создавать множество определений задач и значительно упрощает отправку задания.

Для заданий необходимо предоставить файлы входных данных, а также часто создаются файлы выходных данных. Учетная запись хранения по умолчанию связана с каждой учетной записью пакетной службы, поэтому файлы можно с легкостью передавать в эту учетную запись хранения и обратно, используя интерфейс командной строки. При этом не требуется писать код, указывать учетные данные хранилища или подписанные URL-адреса (SAS).

Например, [ffmpeg](http://ffmpeg.org/) — это популярное приложение, которое обрабатывает аудио- и видеофайлы. Можно использовать интерфейс командной строки для пакетной службы Azure, чтобы вызвать приложение ffmpeg, которое перекодирует исходные видеофайлы в файлы с другим разрешением.

-   Создается шаблон пула. Пользователь, создающий шаблон, должен знать, как вызвать приложение ffmpeg и какие его требования. Необходимо указать соответствующую операционную систему, размер виртуальной машины, как было установлено приложение (например, из пакета приложения или с помощью диспетчера пакетов) и другие значения свойств пула. Создаются параметры, таким образом при использовании шаблона необходимо указать только идентификатор пула и число виртуальных машин.

-   Создается шаблон задания. Пользователь, создающий шаблон, должен знать, как вызвать приложение ffmpeg для перекодирования исходного видео в файл с другим разрешением и указать командную строку задачи. Он также должен знать, что есть папка, в которой содержатся исходные видеофайлы, и каждому входному файлу соответствует одна задача.

-   Пользователь с набором видеофайлов, которые необходимо перекодировать, сначала с помощью шаблона пула создает пул, указывая только идентификатор пула и число необходимых виртуальных машин. После этого можно передать исходные файлы для перекодирования. Затем с помощью шаблона задания можно отправить задание, указав только идентификатор пула и расположение переданных исходных файлов. Будет создано пакетное задание. Для каждого входного файла создается одна задача. Наконец, можно скачать перекодированные выходные файлы.

## <a name="installation"></a>Установка

Для использования функций шаблонов и передачи файлов требуется установить расширение.

Инструкции по установке Azure CLI см. на [этой странице](https://docs.microsoft.com/cli/azure/install-azure-cli).

После установки Azure CLI можно установить расширение пакетной службы, следуя [инструкциям, приведенным в репозитории Azure GitHub](https://github.com/Azure/azure-batch-cli-extensions).


## <a name="templates"></a>Шаблоны

Интерфейс командной строки для пакетной службы Azure позволяет создавать элементы, такие как пулы, задания и задачи, указав JSON-файл, в котором содержатся имена и значения свойств. Например:

```azurecli
az batch pool create –-json-file AppPool.json
```

Шаблоны пакетной службы Azure по своей функциональности и синтаксису очень похожи на шаблоны Azure Resource Manager. Они являются JSON-файлами, содержащими имена и значения свойств элементов, но в них добавлены следующие основные понятия:

-   **Параметры**

    -   Позволяют указывать значения свойств в теле шаблона. При использовании шаблона необходимо предоставить только значения параметров. Например, полное определение пула можно поместить в тело и определить только один параметр для идентификатора пула. Таким образом, для создания пула необходимо указать только строку идентификатора пула.
    -   Тело шаблона может создать пользователь, который знаком с пакетной службой и приложениями, запускаемыми пакетной службой. При использовании шаблона необходимо указать только значения параметров, определенных создателем шаблона. Поэтому пользователь, мало знакомый с пакетной службой и (или) приложениями, также может использовать шаблоны.

-   **Переменные**

    -   Позволяют указывать значения простых или сложных параметров в одном месте, а затем использовать их в одном или нескольких местах в теле шаблона. С помощью переменных можно упростить шаблон и уменьшить его размер, а также сделать его более удобным в использовании благодаря возможности в одном месте изменять свойства, значения которых могут меняться.

-   **Конструкции более высокого уровня**

    -   В шаблоне доступны некоторые конструкции более высокого уровня, которые еще не доступны в интерфейсах API пакетной службы. Например, с помощью определения общей задачи в шаблоне задания можно определить фабрику задач, чтобы создать несколько задач для одного задания. Благодаря этим конструкциям не требуется писать код, чтобы динамически создать несколько JSON-файлов, например по одному файлу для каждой задачи, или создавать файлы сценариев для установки приложений через диспетчер пакетов.
    -   На определенном этапе (где это применимо) данные конструкции можно добавить в пакетную службу, сделав их доступными через интерфейсы API пакетной службы, пользовательские интерфейсы и т. д.

### <a name="pool-templates"></a>Шаблоны пула

Помимо стандартных возможностей шаблонов (параметры и переменные) шаблон пула поддерживает следующие конструкции более высокого уровня:

-   **Ссылки на пакет**

    -   Позволяют при необходимости копировать программное обеспечение в узлы пула с помощью диспетчеров пакетов. Указываются диспетчер пакетов и идентификатор пакета. Возможность объявить про один или несколько пакетов избавляет от необходимости создавать сценарий, который получает пакеты, устанавливать этот сценарий и запускать его на каждом узле пула.

Ниже приведен пример шаблона, который создает пул виртуальных машин Linux с установленным приложением ffmpeg. Ему требуется только строка идентификатора пула и число виртуальных машин, которое необходимо предоставить для использования.

```json
{
    "parameters": {
        "nodeCount": {
            "type": "int",
            "metadata": {
                "description": "The number of pool nodes"
            }
        },
        "poolId": {
            "type": "string",
            "metadata": {
                "description": "The pool id "
            }
        }
    },
    "pool": {
        "type": "Microsoft.Batch/batchAccounts/pools",
        "apiVersion": "2016-12-01",
        "properties": {
            "id": "[parameters('poolId')]",
            "virtualMachineConfiguration": {
                "imageReference": {
                    "publisher": "Canonical",
                    "offer": "UbuntuServer",
                    "sku": "16.04.0-LTS",
                    "version": "latest"
                },
                "nodeAgentSKUId": "batch.node.ubuntu 16.04"
            },
            "vmSize": "STANDARD_D3_V2",
            "targetDedicatedNodes": "[parameters('nodeCount')]",
            "enableAutoScale": false,
            "maxTasksPerNode": 1,
            "packageReferences": [
                {
                    "type": "aptPackage",
                    "id": "ffmpeg"
                }
            ]
        }
    }
}
```

Если имя файла шаблона — _pool-ffmpeg.json_, то шаблон будет вызываться следующим образом:

```azurecli
az batch pool create --template pool-ffmpeg.json
```

### <a name="job-templates"></a>Шаблоны задания

Помимо стандартных возможностей шаблонов (параметры и переменные) шаблон задания поддерживает следующие конструкции более высокого уровня:

-   **Фабрика задач**

    -   Позволяет создать несколько задач для одного задания, используя одно определение задачи. Поддерживается три типа фабрики задач: параметрический анализ, "по одной задаче на файл" и коллекция задач.

Ниже приведен пример шаблона, который создает задание, использующее приложение ffmpeg для перекодирования видеофайлов MP4 в один из двух форматов с более низким разрешением. На каждый исходный видеофайл создается по одной задаче.

```json
{
    "parameters": {
        "poolId": {
            "type": "string",
            "metadata": {
                "description": "The name of Azure Batch pool which runs the job"
            }
        },
        "jobId": {
            "type": "string",
            "metadata": {
                "description": "The name of Azure Batch job"
            }
        },
        "resolution": {
            "type": "string",
            "defaultValue": "428x240",
            "allowedValues": [
                "428x240",
                "854x480"
            ],
            "metadata": {
                "description": "Target video resolution"
            }
        }
    },
    "job": {
        "type": "Microsoft.Batch/batchAccounts/jobs",
        "apiVersion": "2016-12-01",
        "properties": {
            "id": "[parameters('jobId')]",
            "constraints": {
                "maxWallClockTime": "PT5H",
                "maxTaskRetryCount": 1
            },
            "poolInfo": {
                "poolId": "[parameters('poolId')]"
            },
            "taskFactory": {
                "type": "taskPerFile",
                "source": { 
                    "fileGroup": "ffmpeg-input"
                },
                "repeatTask": {
                    "commandLine": "ffmpeg -i {fileName} -y -s [parameters('resolution')] -strict -2 {fileNameWithoutExtension}_[parameters('resolution')].mp4",
                    "resourceFiles": [
                        {
                            "blobSource": "{url}",
                            "filePath": "{fileName}"
                        }
                    ],
                    "outputFiles": [
                        {
                            "filePattern": "{fileNameWithoutExtension}_[parameters('resolution')].mp4",
                            "destination": {
                                "autoStorage": {
                                    "path": "{fileNameWithoutExtension}_[parameters('resolution')].mp4",
                                    "fileGroup": "ffmpeg-output"
                                }
                            },
                            "uploadOptions": {
                                "uploadCondition": "TaskSuccess"
                            }
                        }
                    ]
                }
            },
            "onAllTasksComplete": "terminatejob"
        }
    }
}
```

Если имя файла шаблона — _job-ffmpeg.json_, то шаблон будет вызываться следующим образом:

```azurecli
az batch job create --template job-ffmpeg.json
```

## <a name="file-groups-and-file-transfer"></a>Группы файлов и передача файлов

Помимо создания пулов, заданий и задач для большинства заданий потребуется указание входных файлов и создание выходных файлов. Входные файлы может потребоваться передать с клиента, а затем скопировать на узел или узлы пула. Выходные файлы, создаваемые задачами на узле пула, должны сохраняться, а затем загружаться в клиент.

Расширение интерфейса командной строки для пакетной службы Azure значительно упрощает передачу файлов и использует учетную запись хранения, которая по умолчанию создается для каждой учетной записи пакетной службы.

Было введено понятие группы файлов, которое соответствует контейнеру, создаваемому в учетной записи хранения Azure. Группа файлов может иметь вложенные папки.

Предоставляются команды интерфейса командной строки, которые позволяют передать файлы из клиента в указанную группу файлов, а также загрузить файлы из указанной группы файлов в клиент.

```azurecli
az batch file upload --local-path c:\source_videos\*.mp4 
    --file-group ffmpeg-input

az batch file download --file-group ffmpeg-output --local-path
    c:\output_lowres_videos
```

Шаблоны пула и задания позволяют указать файлы, хранящиеся в группах файлов, для копирования на узлы пула или с узлов пула обратно в группу файлов. Например, в приведенном выше шаблоне задания группа файлов ffmpeg-input указывается для фабрики задач как расположение исходных видеофайлов, которые копируются на узел для перекодирования. Группа файлов ffmpeg-output используется в качестве расположения, в которое копируются перекодированные выходные файлы из узла при выполнении каждой задачи.

## <a name="summary"></a>Сводка

В настоящее время поддержка шаблонов и передачи файлов добавлена только в Azure CLI. В будущем планируется расширить аудиторию пакетной службы до пользователей, которым не нужно разрабатывать код, используя интерфейсы API пакетной службы, например исследователей, ИТ-пользователи и т. д. Пользователи, знакомые с Azure, пакетной службой и приложениями, которые запускает пакетная служба, могут создавать шаблоны для создания пулов и заданий, не прибегая к написанию кода. Параметры шаблона позволяют использовать шаблоны пользователям с базовыми знаниями в пакетной службе и приложениях.

В будущем могут быть добавлены дополнительные возможности в зависимости от отзывов, которые мы получим. Например, поддержка шаблонов и передачи файлов может стать доступной через интерфейсы API пакетной службы, PowerShell и пользовательский интерфейс портала.
-   Для определения шаблонов может быть предоставлен пользовательский интерфейс, что избавит от необходимости создавать, изменять, хранить и совместно использовать JSON-файлы.

-   Шаблонам можно назначить идентификатор, который сохраняется в пакетной службе и связывается с учетной записью пакетной службы. Поддержка пользовательского интерфейса, интерфейса командной строки и API позволит создавать, обновлять и удалять шаблоны. В качестве альтернативы указанию всех значений свойств, необходимых для создания пулов или заданий, шаблоны и значения параметров можно указать в процессе их создания. Пользовательский интерфейс создания пулов и заданий динамически создает элементы интерфейса, запрашивающие значения параметров.

Попробуйте Azure CLI в действии и отправьте нам свои отзывы и предложения. Для этого можно использовать комментарии к данной статье или [форум MSDN, посвященный пакетной службе Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=azurebatch).

## <a name="next-steps"></a>Дальнейшие действия

Подробная документация по установке и использованию, примеры и исходный код доступны в [репозитории Azure GitHub](https://github.com/Azure/azure-batch-cli-extensions).
