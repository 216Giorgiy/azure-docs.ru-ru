---
title: Комплексное выполнение пакетных заданий Azure без написания кода (предварительная версия) | Документация Майкрософт
description: Узнайте, как создать файлы шаблонов для Azure CLI для создания пулов, заданий и задач пакетной службы.
services: batch
author: mscurrell
manager: jeconnoc
ms.assetid: ''
ms.service: batch
ms.devlang: na
ms.topic: article
ms.workload: big-compute
ms.date: 12/18/2017
ms.author: markscu
ms.openlocfilehash: 565ceb179d8cf749842bb58ab25a8b3d946efa12
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34608653"
---
# <a name="use-azure-batch-cli-templates-and-file-transfer-preview"></a>Использование шаблонов интерфейса командной строки для пакетной службы Azure и передачи файлов (предварительная версия)

Интерфейс командной строки Azure позволяет выполнять пакетные задания Azure без написания кода.

Создавайте и используйте файлы шаблонов при помощи Azure CLI, чтобы разрабатывать пулы, задания и задачи пакетной службы. Легко передавайте входные файлы задания в учетную запись хранения, связанную с учетной записью пакетной службы, и загружайте выходные файлы задания.

## <a name="overview"></a>Обзор

Это расширение Azure CLI дает возможность пользователям, которые не являются разработчиками, комплексно использовать пакетную службу. Используя только команды CLI, можно создать пул, отправить входные данные, создать задания и связанные задачи и загрузить результаты выходных данных. Дополнительный код не требуется. Напрямую запустите команды CLI или интегрируйте их в сценарии.

Шаблоны пакетной службы создаются на основе [существующей поддержки пакетной службы в Azure CLI](batch-cli-get-started.md#json-files-for-resource-creation), что позволяет JSON-файлам указывать значения свойств для создания пулов, заданий, задач и других элементов. Благодаря шаблонам пакетной службы к имеющимся функциям JSON-файлов добавляются следующие возможности:

-   Возможность определять параметры. При использовании шаблона указываются только значения параметров для создания элемента, а остальные значения свойств элемента содержатся в теле шаблона. Пользователь, понимающий принцип работы пакетной службы и приложений, запускаемых пакетной службой, может создавать шаблоны, указывая значения свойств пулов, заданий и задач. Если пользователь мало знаком с пакетной службой и (или) приложениями, то ему необходимо указать только значения определенных параметров.

-   Фабрики задач создают одну или несколько задач, связанных с заданием, избавляя вас от необходимости создавать для них множество определений. Это значительно упрощает отправку заданий.


В заданиях обычно используются файлы входных данных и файлы выходных данных. По умолчанию учетная запись хранения связана с каждой учтенной записью пакетной службы. Для передачи файлов в учетную запись хранения и из нее с помощью интерфейса командной строки не требуется использовать код и учетные данные хранения.

Например, [ffmpeg](http://ffmpeg.org/) — это популярное приложение, которое обрабатывает аудио- и видеофайлы. Ниже приведены инструкции по вызову приложение ffmpeg с помощью интерфейс командной строки для пакетной службы Azure, которое перекодирует исходные видеофайлы в файлы с другим разрешением.

-   Создайте шаблон пула. Пользователь, создающий шаблон, должен знать, как вызвать приложение ffmpeg и какие его требования. Необходимо указать соответствующую операционную систему, размер виртуальной машины, как было установлено приложение (например, из пакета приложения или с помощью диспетчера пакетов) и другие значения свойств пула. Создаются параметры, поэтому при использовании шаблона необходимо указать только идентификатор пула и число виртуальных машин.

-   Создайте шаблон задания. Пользователь, создающий шаблон, должен знать, как вызвать приложение ffmpeg для перекодирования исходного видео в файл с другим разрешением и указать командную строку задачи. Он также должен знать, что существует папка, в которой содержатся исходные видеофайлы, и что для каждого входного файла требуется одна задача.

-   Сначала пользователь создает пул для набора видеофайлов, которые необходимо перекодировать. Он использует шаблон пула, указывая только идентификатор пула и требуемое число виртуальных машин. После этого можно передать исходные файлы для перекодирования. Затем с помощью шаблона можно отправить задание, указав только идентификатор пула и расположение переданных исходных файлов. Создается пакетное задание. Для каждого входного файла создается одна задача. Наконец, можно загрузить перекодированные выходные файлы.

## <a name="installation"></a>Установка

Установите расширение интерфейса командной строки для пакетной службы Azure, чтобы использовать возможности передачи файлов и шаблонов.

Инструкции по установке Azure CLI см. в [этой статье](/cli/azure/install-azure-cli).

После установки Azure CLI установите последнюю версию расширения пакетной службы с помощью следующей команды CLI:

```azurecli
az extension add --name azure-batch-cli-extensions
```

Дополнительные сведения о расширении пакетной службы см. в статье [Microsoft Azure Batch CLI Extensions for Windows, Mac and Linux](https://github.com/Azure/azure-batch-cli-extensions#microsoft-azure-batch-cli-extensions-for-windows-mac-and-linux) (Расширения командной строки для пакетной службы Microsoft Azure для Windows, Mac и Linux).

## <a name="templates"></a>Шаблоны

Интерфейс командной строки для пакетной службы Azure позволяет создавать элементы, такие как пулы, задания и задачи, указав JSON-файл, в котором содержатся имена и значения свойств. Например: 

```azurecli
az batch pool create –-json-file AppPool.json
```

Шаблоны пакетной службы Azure по функциональности и синтаксису похожи на шаблоны Azure Resource Manager. Они являются JSON-файлами, содержащими имена и значения свойств элементов, но в них добавлены следующие основные понятия:

-   **Параметры**

    -   Позволяют указывать значения свойств в теле шаблона. При использовании шаблона необходимо предоставить только значения параметров. Например, полное определение пула можно поместить в текст и определить только один параметр для идентификатора пула. Таким образом, для создания пула необходимо указать только строку идентификатора.
        
    -   Тело шаблона может создать пользователь, который знаком с пакетной службой и приложениями, запускаемыми пакетной службой. При использовании шаблона необходимо указать только значения параметров, определенных создателем шаблона. Поэтому пользователь, мало знакомый с пакетной службой и (или) приложениями, также может использовать шаблоны.

-   **Переменные**

    -   Позволяют указывать значения простых или сложных параметров в одном месте, а затем использовать их в одном или нескольких местах в теле шаблона. С помощью переменных можно упростить шаблон и уменьшить его размер, а также сделать его более удобным в использовании благодаря возможности изменять свойства в одном месте.

-   **Конструкции более высокого уровня**

    -   В шаблоне доступны некоторые конструкции более высокого уровня, которые еще не доступны в интерфейсах API пакетной службы. Например, в шаблоне задания на основе стандартного определения задач можно определить фабрику задач, которая создаст несколько задач для одного задания. Благодаря этим конструкциям не требуется писать код, чтобы динамически создать несколько JSON-файлов, по одному файлу для каждой задачи, или создавать файлы сценариев для установки приложений через диспетчер пакетов.

    -   На определенном этапе данные конструкции можно добавить в пакетную службу, сделав их доступными через интерфейсы API пакетной службы, пользовательские интерфейсы и т. д.

### <a name="pool-templates"></a>Шаблоны пула

Шаблоны пулов поддерживают стандартные возможности шаблонов (параметры и переменные), а также следующие конструкции более высокого уровня:

-   **Ссылки на пакет**

    -   Позволяют при необходимости копировать программное обеспечение в узлы пула с помощью диспетчеров пакетов. Указываются диспетчер пакетов и идентификатор пакета. Объявляя об одном или нескольких пакетах, вы избавляетесь от необходимости создания сценария, который получает пакеты, установки этого сценария и его запуска на каждом узле пула.

Ниже приведен пример шаблона, при помощи которого создается пул виртуальных машин Linux с установленным приложением ffmpeg. Чтобы его использовать, необходимо только указать строку идентификатора пула и число используемых виртуальных машин:

```json
{
    "parameters": {
        "nodeCount": {
            "type": "int",
            "metadata": {
                "description": "The number of pool nodes"
            }
        },
        "poolId": {
            "type": "string",
            "metadata": {
                "description": "The pool ID "
            }
        }
    },
    "pool": {
        "type": "Microsoft.Batch/batchAccounts/pools",
        "apiVersion": "2016-12-01",
        "properties": {
            "id": "[parameters('poolId')]",
            "virtualMachineConfiguration": {
                "imageReference": {
                    "publisher": "Canonical",
                    "offer": "UbuntuServer",
                    "sku": "16.04-LTS",
                    "version": "latest"
                },
                "nodeAgentSKUId": "batch.node.ubuntu 16.04"
            },
            "vmSize": "STANDARD_D3_V2",
            "targetDedicatedNodes": "[parameters('nodeCount')]",
            "enableAutoScale": false,
            "maxTasksPerNode": 1,
            "packageReferences": [
                {
                    "type": "aptPackage",
                    "id": "ffmpeg"
                }
            ]
        }
    }
}
```

Если имя файла шаблона — _pool-ffmpeg.json_, то вызовите шаблон следующим образом:

```azurecli
az batch pool create --template pool-ffmpeg.json
```

### <a name="job-templates"></a>Шаблоны задания

Шаблоны задания поддерживают стандартные возможности шаблонов (параметры и переменные), а также следующие конструкции более высокого уровня:

-   **Фабрика задач**

    -   Создает несколько задач для одного задания, используя одно определение задачи. Поддерживается три типа фабрики задач: параметрический анализ, "по одной задаче на файл" и коллекция задач.

Ниже приведен пример шаблона, который создает задание для перекодирования видеофайлов MP4 с помощью ffmpeg в один из двух форматов с более низким разрешением. Он создает одну задачу для каждого исходного видеофайла.

```json
{
    "parameters": {
        "poolId": {
            "type": "string",
            "metadata": {
                "description": "The name of Azure Batch pool which runs the job"
            }
        },
        "jobId": {
            "type": "string",
            "metadata": {
                "description": "The name of Azure Batch job"
            }
        },
        "resolution": {
            "type": "string",
            "defaultValue": "428x240",
            "allowedValues": [
                "428x240",
                "854x480"
            ],
            "metadata": {
                "description": "Target video resolution"
            }
        }
    },
    "job": {
        "type": "Microsoft.Batch/batchAccounts/jobs",
        "apiVersion": "2016-12-01",
        "properties": {
            "id": "[parameters('jobId')]",
            "constraints": {
                "maxWallClockTime": "PT5H",
                "maxTaskRetryCount": 1
            },
            "poolInfo": {
                "poolId": "[parameters('poolId')]"
            },
            "taskFactory": {
                "type": "taskPerFile",
                "source": { 
                    "fileGroup": "ffmpeg-input"
                },
                "repeatTask": {
                    "commandLine": "ffmpeg -i {fileName} -y -s [parameters('resolution')] -strict -2 {fileNameWithoutExtension}_[parameters('resolution')].mp4",
                    "resourceFiles": [
                        {
                            "blobSource": "{url}",
                            "filePath": "{fileName}"
                        }
                    ],
                    "outputFiles": [
                        {
                            "filePattern": "{fileNameWithoutExtension}_[parameters('resolution')].mp4",
                            "destination": {
                                "autoStorage": {
                                    "path": "{fileNameWithoutExtension}_[parameters('resolution')].mp4",
                                    "fileGroup": "ffmpeg-output"
                                }
                            },
                            "uploadOptions": {
                                "uploadCondition": "TaskSuccess"
                            }
                        }
                    ]
                }
            },
            "onAllTasksComplete": "terminatejob"
        }
    }
}
```

Если имя файла шаблона — _job-ffmpeg.json_, то вызовите шаблон следующим образом:

```azurecli
az batch job create --template job-ffmpeg.json
```

## <a name="file-groups-and-file-transfer"></a>Группы файлов и передача файлов

Большинство заданий и задач принимают входные файлы и создают выходные файлы. Обычно входные и выходные файлы передаются от клиента на узел или с узла клиенту. Расширение интерфейса командной строки для пакетной службы Azure значительно упрощает передачу файлов и использует учетную запись хранения, которая по умолчанию создается для каждой учетной записи пакетной службы.

Группа файлов соответствует контейнеру, создаваемому в учетной записи хранения Azure. Группа файлов может иметь вложенные папки.

Расширение CLI для пакетной службы предоставляет команды, чтобы передать файлы от клиента в указанную группу файлов или скачать в клиент файлы из указанной группы файлов.

```azurecli
az batch file upload --local-path c:\source_videos\*.mp4 
    --file-group ffmpeg-input

az batch file download --file-group ffmpeg-output --local-path
    c:\output_lowres_videos
```

Шаблоны пула и задания позволяют указать файлы, хранящиеся в группах файлов, для копирования на узлы пула или с узлов пула обратно в группу файлов. Например, в приведенном выше шаблоне задания группа файлов ffmpeg-input указывается для фабрики задач как расположение исходных видеофайлов, которые копируются на узел для перекодирования. Группа файлов ffmpeg-output находится в расположении, в которое копируются перекодированные выходные файлы из узла при выполнении каждой задачи.

## <a name="summary"></a>Сводка

Сейчас поддержка шаблонов и передачи файлов реализована только в Azure CLI. В будущем планируется расширить аудиторию пакетной службы до пользователей, которым не нужно разрабатывать код, используя интерфейсы API пакетной службы, например исследователей, ИТ-пользователи и т. д. Пользователи, знакомые с Azure, пакетной службой и приложениями, которые запускает пакетная служба, могут создавать шаблоны для создания пулов и заданий, не прибегая к написанию кода. Параметры шаблона позволяют использовать шаблоны даже пользователям с небольшим опытом работы с пакетной службой и приложениями.

Попробуйте использовать расширение пакетной службы для Azure CLI и оставьте отзыв или предложения в комментариях к этой статье или на [форуме по пакетной службе Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=azurebatch).

## <a name="next-steps"></a>Дополнительная информация

- Прочитайте запись блога о пакетной службе: [Running Azure Batch jobs using the Azure CLI – no code required](https://azure.microsoft.com/blog/running-azure-batch-jobs-using-the-azure-cli-no-code-required/) (Выполнение пакетных заданий Azure с помощью Azure CLI без написания кода).
- Подробная документация по установке и использованию, примеры и исходный код доступны в [репозитории Azure GitHub](https://github.com/Azure/azure-batch-cli-extensions).
