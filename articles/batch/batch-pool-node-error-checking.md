---
title: Проверка на наличие ошибок в пуле пакетной службы и узле
description: Проверяемые ошибки и способы их избежания при создании пулов и узлов.
services: batch
author: mscurrell
ms.author: markscu
ms.date: 9/25/2018
ms.topic: conceptual
ms.openlocfilehash: bc09089fa9984e9042166938da19499afca21509
ms.sourcegitcommit: 7c4fd6fe267f79e760dc9aa8b432caa03d34615d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2018
ms.locfileid: "47435846"
---
# <a name="checking-for-pool-and-node-errors"></a>Проверка на наличие ошибок в пуле и узле

При создании пулов пакетной службы и управлении ими есть операции, которые выполняются немедленно, и асинхронные операции, которые не выполняются сразу, а запускаются в фоновом режиме и могут занять несколько минут.

Процесс обнаружения ошибок для операций, которые выполняются немедленно, довольно прост, так как все ошибки будут сразу возвращаться через API, интерфейс командной строки или пользовательский интерфейс.

В этой статье рассматриваются фоновые операции, которые можно выполнить для пулов и узлов пула. Здесь приведены способы обнаружения сбоев, а также методы их избежания.

## <a name="pool-errors"></a>Ошибки пула

### <a name="resize-timeout-or-failure"></a>Время ожидания изменения размера или сбой

При создании пула или изменении размера имеющегося пула указывается целевое количество узлов.  Операция завершается немедленно, но фактическое распределение новых и удаление имеющихся узлов выполняется в фоновом режиме. Для этого может понадобиться несколько минут.  Время ожидания изменения размера указывается в программном интерфейсе [создания](https://docs.microsoft.com/rest/api/batchservice/pool/add) или [изменения размера](https://docs.microsoft.com/rest/api/batchservice/pool/resize). Если целевое количество узлов нельзя получить в течение времени ожидания изменения размера, то операция будет остановлена и пул перейдет в стабильное состояние с ошибками изменения размера.

Истечение времени ожидания изменения размера сообщается с помощью свойства [ResizeError](https://docs.microsoft.com/rest/api/batchservice/pool/get#resizeerror) для последнего вычисления и содержит одну или несколько возникших ошибок.

К распространенным причинам истечения времени ожидания изменения размера относятся:
- Слишком короткое время ожидания изменения размера.
  - Время ожидания по умолчанию составляет 15 минут. Обычно этого времени достаточно для выделения или удаления узлов пула.
  - При выделении большого количества узлов (более 1000 узлов из образа Marketplace или более 300 узлов из пользовательского образа) во время создания пула или изменения его размера рекомендуется устанавливать время ожидания 30 минут.
- Недостаточная квота ядер.
  - Учетная запись пакетной службы включает в себя квоту на количество ядер, которые можно выделить во всех пулах.  После достижения данной квоты пакетная служба не будет выделять узлы.  Квоты ядер [можно увеличить](https://docs.microsoft.com/azure/batch/batch-quota-limit), чтобы выделить больше узлов.
- Недостаточно IP-адресов подсети, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - В подсети виртуальной сети должно быть достаточно свободных IP-адресов для всех запрашиваемых узлов пула. В противном случае будет невозможно создавать узлы.
- Недостаточно ресурсов, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - Ресурсы, такие как балансировщики нагрузки, общедоступные IP-адреса и группы безопасности сети, создаются в подписке, используемой для создания учетной записи пакетной службы.  Необходима достаточная квота подписки для этих ресурсов.
- Для больших пулов используется пользовательский образ виртуальной машины.
  - Для выделения больших пулов, использующих пользовательские образы, может потребоваться больше времени, из-за чего время ожидания может истечь.  Ограничения и рекомендации для настройки приведены в [этой статье](https://docs.microsoft.com/azure/batch/batch-custom-images). 

### <a name="auto-scale-failures"></a>Сбои автомасштабирования

Вместо того чтобы явно задавать целевое количество узлов для пула при создании или изменении размера пула, можно автоматически масштабировать количество узлов в пуле.  [Для пула можно создать формулу автомасштабирования](https://docs.microsoft.com/azure/batch/batch-automatic-scaling), которая будет оцениваться в соответствии с регулярным настраиваемым интервалом для установки целевого количества узлов для пула.  Вы можете обнаружить следующие типы проблем:

- Оценка автомасштабирования может завершиться ошибкой.
- Итоговая операция изменения размера может завершиться ошибкой и истечением времени ожидания.
- Может возникнуть проблема с формулой автоматического масштабирования, что приведет к неправильным целевым значениям узла, а также к изменению размера или истечению времени ожидания.

Сведения о последней оценке автомасштабирования можно получить с помощью свойства [autoScaleRun](https://docs.microsoft.com/rest/api/batchservice/pool/get#autoscalerun), которое сообщает время, значения и результат вычисления, а также ошибки при выполнении вычисления.

Сведения обо всех оценках автоматически фиксируются в [событии завершения изменения размера пула](https://docs.microsoft.com/azure/batch/batch-pool-resize-complete-event).

### <a name="delete"></a>Delete

При условии, что в пуле есть узлы, операция удаления пула приводит к удалению узлов, а затем самого объекта пула.  Удаление узлов пула может занять несколько минут.

В процессе удаления в качестве [состояния пула](https://docs.microsoft.com/rest/api/batchservice/pool/get#poolstate) будет указано значение deleting (Удаление).  Вызывающее приложение может обнаружить слишком долгое время удаления пула на основе свойств state и stateTransitionTime.

## <a name="pool-compute-node-errors"></a>Ошибки вычислительных узлов в пуле

Узлы можно успешно выделять в пуле, но множество проблем могут привести к неработоспособности узлов и невозможности их использования.  После выделения узлов в пуле за них взимается плата. Поэтому важно выявлять проблемы, чтобы не платить за узлы, которые невозможно использовать.

### <a name="start-task-failure"></a>Сбой задачи запуска

Для пула можно указать дополнительную [задачу запуска](https://docs.microsoft.com/rest/api/batchservice/pool/add#starttask).  Как и в любой задаче, вы можете указать командную строку и файлы ресурсов, которые необходимо загрузить из хранилища.  Задача запуска задается для пула, но выполняется на каждом узле отдельно (после запуска каждого узла).  Следующее свойство [задачи запуска](https://docs.microsoft.com/rest/api/batchservice/pool/add#starttask) (waitForSuccess) указывает, следует ли пакетной службе ожидать успешного выполнения задачи запуска перед планированием задачи для узла.

Если задача запуска завершается сбоем и установлена конфигурация запуска, ожидающая успешного завершения, узел будет непригодным для использования и за него по-прежнему будет взиматься плата.

Сбои выполнения задачи запуска можно обнаружить с помощью свойств [result](https://docs.microsoft.com/rest/api/batchservice/computenode/get#taskexecutionresult) и [failureInfo](https://docs.microsoft.com/rest/api/batchservice/computenode/get#taskfailureinformation) свойства узла верхнего уровня [startTaskInfo](https://docs.microsoft.com/rest/api/batchservice/computenode/get#starttaskinformation).

Неудачное выполнение задачи запуска также приводит к установлению в качестве [состояния](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodestate) узла значения starttaskfailed, но только если для параметра waitForSuccess задано значение true.

Как и в любой задаче, может быть множество причин сбоя задачи запуска.  Для устранения неполадок следует проверить файлы журнала stdout, stderr и другие файлы журнала для конкретных задач.

### <a name="application-package-download-failure"></a>Не удалось скачать пакет приложения

Один или несколько пакетов приложений можно дополнительно указать для пула, скачав указанные файлы пакета на каждый узел и распаковав их после запуска узла перед планированием задач.  Обычно для копирования файлов в другое расположение или для запуска установки используется командная строка задачи запуска в сочетании с пакетами приложений.

Сбой при скачивании и распаковке пакета приложения будет сообщаться с помощью свойства узла [errors](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror).  В качестве состояния узла будет установлено значение unusable (Непригоден).

### <a name="node-in-unusable-state"></a>Узел с состоянием unusable (Непригоден)

[Состояние узла](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodestate) может иметь значение unusable (Непригоден) по многим причинам.  Если узел непригоден, задачи нельзя планировать для узла, но за этот узел по-прежнему будет взиматься плата.

Пакетная служба будет пытаться восстановить непригодные для использования узлы, но такие узлы не всегда можно восстановить. Это зависит от причины возникновения такого состояния.

Если причину можно определить, она будет сообщена с помощью свойства узла [errors](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror).

Другие примеры возможных причин возникновения состояния узлов unusable (Непригоден):

- Недопустимый пользовательский образ, например неправильно подготовленный.
- Сбой инфраструктуры или низкоуровневое обновление, ведущее к перемещению базовой виртуальной машины. Пакетная служба восстановит узел.

### <a name="node-agent-log-files"></a>Файлы журнала агента узла

Если необходимо обратиться в службу поддержки по поводу проблемы с узлом пула, можно получить файлы журнала из процесса агента пакетной службы, выполняемого на каждом пуле.  Файлы журнала для узла можно скачать с помощью портала Azure, Batch Explorer или [программного интерфейса](https://docs.microsoft.com/rest/api/batchservice/computenode/uploadbatchservicelogs).  Может быть очень полезно передать и сохранить файлы журналов, так как узел или пул можно удалить, чтобы сэкономить на стоимости выполняющихся узлов.

## <a name="next-steps"></a>Дополнительная информация

Убедитесь, что в приложении реализована комплексная проверка ошибок, особенно для асинхронных операций, чтобы была возможность быстрого обнаружения и диагностирования проблем.
