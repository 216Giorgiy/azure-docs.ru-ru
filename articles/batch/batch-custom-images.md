---
title: "Подготовка пулов пакетной службы Azure на основе пользовательских образов | Документация Майкрософт"
description: "Пул пакетной службы можно создать на основе пользовательского образа для подготовки вычислительных узлов, которые содержат программное обеспечение и данные, необходимые для приложения. Пользовательские образы представляют собой эффективный способ настройки вычислительных узлов для выполнения рабочих нагрузок пакетной службы."
services: batch
author: tamram
manager: timlt
ms.service: batch
ms.topic: article
ms.date: 08/07/2017
ms.author: tamram
ms.openlocfilehash: 0816c464b6b52747148cc42a55445048901e7595
ms.sourcegitcommit: 51ea178c8205726e8772f8c6f53637b0d43259c6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="use-a-custom-image-to-create-a-pool-of-virtual-machines"></a>Использование пользовательского образа для создания пула виртуальных машин

При создании пула виртуальных машин в пакетной службе Azure необходимо указать образ виртуальной машины, предоставляющий операционную систему для каждого вычислительного узла в пуле. Пул виртуальных машин можно создать с помощью образа Microsoft Azure Marketplace или подготовленного пользовательского образа VHD. Предоставив пользовательский образ, вы можете контролировать настройку операционной системы во время подготовки каждого вычислительного узла. Пользовательский образ может также содержать данные о приложении и справочные данные, которые становятся доступными на вычислительном узле сразу после его подготовки.

Пользовательский образ позволяет сэкономить время за счет подготовки вычислительных узлов пула к выполнению рабочей нагрузки пакетной службы. Вы всегда можете использовать образ Azure Marketplace и установить программное обеспечение на каждом вычислительном узле после его подготовки. Однако этот подход менее эффективен, чем использование пользовательского образа. 

Причины для использования пользовательского образа, настроенного для сценария, обусловлены необходимостью:

- **Настройки операционной системы (ОС)**. В пользовательском образе можно реализовать любую специальную конфигурацию операционной системы. 
- **Установки больших приложений.** Установка приложений на пользовательский образ более эффективна, чем их установка на каждом вычислительном узле после его подготовки.
- **Копирования значительного объема данных.** Если данные скопированы на пользовательский образ, его нужно копировать только один раз вместо копирования на каждый вычислительный узел, что экономит время и уменьшает потребление пропускной способности.
- **Перезагрузки виртуальной машины во время процесса установки.** Перезагрузка виртуальной машины может занять много времени, особенно при наличии нескольких вычислительных узлов.

## <a name="prerequisites"></a>Предварительные требования

- **Учетная запись пакетной службы, созданная в режиме распределения пула "Пользовательская подписка".** В этом режиме пулы пакетной службы выделяются для подписки, в которой находится учетная запись. Дополнительные сведения см. в разделе об [учетной записи](batch-api-basics.md#account) в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).

- **Учетная запись хранения Azure.** Чтобы создать пул виртуальных машин с помощью пользовательского образа, необходима стандартная учетная запись хранения Azure общего назначения в той же подписке и регионе. При создании пользовательского образа виртуальной машины Azure копируйте образ в учетную запись хранения, где размещен диск ОС виртуальной машины, и вам не понадобится создавать отдельную учетную запись хранения. 
    
## <a name="prepare-a-custom-image"></a>Подготовка пользовательского образа

Для подготовки пользовательского образа к использованию с пакетной службой необходимо подготовить имеющуюся установку Windows или Linux. При подготовке операционной системы удаляются сведения о компьютере. В результате вы получаете образ, который можно установить на других компьютерах или виртуальных машинах.  

> [!IMPORTANT]
> Сейчас пакетная служба не поддерживает использование управляемых образов Azure для подготовки пула. Пользовательский образ, используемый для подготовки пула, должен храниться в службе хранилища Azure. 
>
> При подготовке пользовательского образа учитывайте следующие моменты:
> - Убедитесь, что в базовом образе операционной системы, который используется для подготовки пулов пакетной службы, нет предварительно установленных расширений Azure, например расширения "Настраиваемый скрипт". Если образ содержит предварительно установленное расширение, могут возникнуть проблемы при развертывании виртуальной машины в Azure.
> - Убедитесь, что для базового образа операционной системы, предоставленного вами, по умолчанию используется временный диск, так как на текущем этапе для агента узла пакетной службы требуется этот временный диск.
>
>

В качестве пользовательского образа можно использовать любой имеющийся образ Windows или Linux. Например, при необходимости использовать локальный образ отправьте образ в учетную запись хранения Azure, которая находится в той же подписке и регионе, что и учетная запись пакетной службы, используя [AzCopy](../storage/storage-use-azcopy.md) или другое средство передачи.

Также пользовательский образ можно подготовить из новой или имеющейся виртуальной машины Azure. При создании новой виртуальной машины можно использовать образ Azure Marketplace в качестве базового для пользовательского образа, а затем настроить его. Чтобы настроить базовый образ, создайте виртуальную машину Azure и добавьте в нее приложения или данные. Затем подготовьте виртуальную машину, которая будет использоваться в качестве пользовательского образа, и сохраните ее в службе хранилища Azure. 

Чтобы подготовить пользовательский образ виртуальной машины Azure, выполните такие шаги:

1. Создайте **неуправляемую** виртуальную машину Azure из образа Microsoft Azure Marketplace. Microsoft Azure Marketplace содержит образы для [Windows](../virtual-machines/windows/quick-create-portal.md) и [Linux](../virtual-machines/linux/quick-create-portal.md).
    
    На шаге 3 процесса создания виртуальной машины убедитесь, что для параметра **Служба хранилища: использование управляемых дисков** установлено значение **Нет**. Также запишите имя учетной записи хранения для диска ОС виртуальной машины, так как именно в ней Azure сохранит пользовательский образ:

    ![Создание неуправляемой виртуальной машины и запись имени учетной записи хранения](media/batch-custom-images/vm-create-storage.png)
 
2. Завершите процесс создания виртуальной машины и дождитесь ее выделения в Azure. Вот образ, который отображает виртуальную машину на портале Azure в рабочем состоянии:

    ![Создание виртуальной машины из образа Marketplace](media/batch-custom-images/vm-status-running.png)

3. После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные и подготовьте виртуальную машину к использованию. Выполните действия, описанные в разделе о [подготовке виртуальной машины к использованию](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sa-copy-generalized.md#generalize-the-vm). 
   
4. Выполните шаги, чтобы [войти в Azure PowerShell](../virtual-machines/windows/sa-copy-generalized.md#log-in-to-azure-powershell). Чтобы установить Azure PowerShell, ознакомьтесь со статьей [Общие сведения об Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview?view=azurermps-4.2.0). 

5. Затем выполните шаги, чтобы [освободить виртуальную машину и установить состояние "универсальный"](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sa-copy-generalized#deallocate-the-vm-and-set-the-state-to-generalized). 

    На портале Azure обратите внимание, что виртуальная машина находится в состоянии "Освобождена":

    ![Убедитесь, что виртуальная машина находится в состоянии "Освобождена"](media/batch-custom-images/vm-status-deallocated.png)

6.  Создайте образ виртуальной машины и сохраните его в службе хранилища Azure с помощью командлета PowerShell [Save-AzureRmVMImage](https://docs.microsoft.com/powershell/module/azurerm.compute/save-azurermvmimage). Следуйте инструкциям, описанным в разделе [Создание образа](../virtual-machines/windows/sa-copy-generalized.md#create-the-image).
    
    Образ виртуальной машины сохраняется в учетной записи хранения Azure, которая была создана при создании виртуальной машины, как показано на шаге 1 этой процедуры. Командлет Save-AzureRmVMImage сохраняет образ в контейнер **системы** в учетной записи хранения. Параметр `-DestinationContainername` указывает виртуальный каталог в контейнере **системы**. Параметр `-VHDNamePrefix` указывает префикс имени большого двоичного объекта. Этот префикс присоединяется к имени большого двоичного объекта через дефис. 

    Предположим, вы вызываете командлет Save-AzureRmVMImage с такими параметрами:  

        Save-AzureRmVMImage -ResourceGroupName sample-resource-group -Name vm-custom-image -DestinationContainerName batchimages -VHDNamePrefix custom -Path C:\Temp\Images\vm-custom-image.json

    Полученный образ сохраняется в расположении, а имя большого двоичного объекта отображается здесь:

    ![Расположение сохраненного VHD в контейнере системы](media/batch-custom-images/vhd-in-vm-storage-account.png)

    > [!NOTE]
    > Неуправляемая виртуальная машина Azure создает несколько учетных записей хранения для различных целей. Если вы не записали имя контейнера хранилища при создании виртуальной машины, найдите связанную учетную запись хранения, которая содержит контейнер **системы**. Найдите в контейнере **системы** пользовательский образ, использующий значения, указанные для команды **Save-AzureRmVMImage**.

## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a>Создание пула на основе пользовательского образа на портале

Если вы сохранили пользовательский образ и знаете его расположение, можно создать пул пакетной службы из этого образа. Выполните следующие действия для создания пула с помощью портала Azure:

1. Войдите в свою учетную запись пакетной службы на портале Azure. Это учетная запись должна принадлежать к тем же подписке и региону, что и учетная записи хранения, которая содержит пользовательский образ. 
2. В окне **Параметры** слева выберите пункт меню **Пулы**.
3. В окне **Пулы** выберите команду **Добавить**.
4. В окне **Добавить пул** из раскрывающегося списка **Тип образа** выберите **Пользовательский образ (Linux или Windows)**. На портале отобразится средство выбора **пользовательского образа**. Перейдите к учетной записи хранения, где расположен созданный вами пользовательский образ, и выберите желаемый VHD из контейнера. 
5. Выберите правильного **издателя, предложение, SKU** для пользовательского VHD.
6. Укажите оставшиеся необходимые параметры, в том числе **Размер узла**, **Target dedicated nodes** (Целевые выделенные узлы) и **Узлы с низким приоритетом**, а также любые необходимые дополнительные параметры.

    Например, для пользовательского образа Microsoft Windows Server Datacenter 2016 окно **Добавить пул** отображается, как показано ниже:

    ![Добавление пула из пользовательского образа Windows](media/batch-custom-images/add-pool-custom-image.png)
  
Чтобы проверить, основан ли имеющийся пул на пользовательском образе, найдите свойство **Операционная система** в разделе сводки по ресурсу окна **Пул**. Если пул был создан с помощью пользовательского образа, ему будет присвоено значение **Пользовательский образ виртуальной машины**.

Все пользовательские VHD, связанные с пулом, отображаются в окне **Свойства** пула.
 
## <a name="next-steps"></a>Дальнейшие действия

- Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
- Сведения о создании учетной записи пакетной службы см. в статье [Создание учетной записи пакетной службы на портале Azure](batch-account-create-portal.md).