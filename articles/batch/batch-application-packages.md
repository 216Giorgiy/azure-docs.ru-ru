<properties
	pageTitle="Быстрая установка приложения и управление им с помощью пакетной службы Azure | Microsoft Azure"
	description="Пакеты приложений пакетной службы Azure позволяют легко управлять несколькими приложениями и их версиями для установки на вычислительные узлы пакетной службы."
	services="batch"
	documentationCenter=".net"
	authors="mmacy"
	manager="timlt"
	editor="" />

<tags
	ms.service="batch"
	ms.devlang="multiple"
	ms.topic="article"
	ms.tgt_pltfrm="vm-windows"
	ms.workload="big-compute"
	ms.date="03/14/2016"
	ms.author="marsma" />

# Развертывание приложения с помощью пакетов приложений пакетной службы Azure

Использование пакетов приложений пакетной службы Azure обеспечивает простое управление и развертывание приложений на вычислительных узлах в пуле. С помощью пакетов приложений вы сможете передать несколько версий приложений, выполняемых вашими задачами (в том числе двоичные файлы и вспомогательные файлы), а также управлять ими, а затем автоматически развернуть одно или несколько таких приложений на вычислительных узлах в пуле.

Из этой статьи вы узнаете, как передавать пакеты приложений с помощью портала Azure, а также управлять ими, а затем устанавливать их на вычислительных узлах пула с помощью библиотеки [пакетной службы для .NET][api_net].

> [AZURE.NOTE] Компонент "Пакеты приложений", описываемый в этой статье, заменяет компонент "Приложения пакетной службы", доступный в предыдущих версиях службы.

## Требования к пакетам приложений

Компонент "Пакеты приложений", рассматриваемый в этой статье, совместим *только* с пулами пакетной службы, созданными после 10 марта 2016 г. Пакеты приложений не удастся развернуть на вычислительных узлах в пулах, созданных до этой даты.

Этот компонент появился в [REST API пакетной службы][api_rest] версии 2015-12-01.2.2 и соответствующей библиотеке [пакетной службы для .NET][api_net] версии 3.1.0. Мы рекомендуем всегда использовать при работе с пакетной службой последнюю версию API.

## О приложениях и пакетах приложений

В пакетной службе Azure **приложение** ссылается на набор двоичных файлов с возможностью управления версиями, которые могут автоматически загружаться на вычислительные узлы в пуле. **Пакет приложения** ссылается на *определенный набор* таких двоичных файлов, представляя конкретную *версию* приложения.

![Обзорная схема: приложения и пакеты приложений][1]

### Приложения

Приложение в пакетной службе содержит один или несколько пакетов приложений. Оно задает параметры конфигурации для приложения, например версию пакета приложения по умолчанию для установки на вычислительных узлах, а также определяет необходимость обновления или удаления пакетов.

### Пакеты приложений

Пакет приложения — это ZIP-файл, содержащий двоичные файлы приложения и вспомогательные файлы, которые необходимы задачам для выполнения приложений. Каждый пакет приложения представляет определенную версию приложения. При создании пула в пакетной службе можно указать одно или несколько таких приложений и (необязательно) версию. Эти пакеты приложений будут автоматически загружены и извлечены на каждый узел при его включении в пул.

> [AZURE.IMPORTANT] Существуют ограничения на количество приложений и пакетов приложений в учетной записи пакетной службы, а также на максимальный размер пакета. Дополнительные сведения см. в статье [Квоты и ограничения пакетной службы Azure](batch-quota-limit.md).

### Преимущества пакетов приложений

Пакеты приложений позволяют упростить код в решении пакетной службы, а также сократить расходы на управление приложениями, выполняемыми вашими задачами.

Если вы используете пакет приложений, начальная задача пула не должна указывать длинный список отдельных файлов ресурсов для установки на узлах. Также вам не нужно вручную управлять несколькими версиями этих файлов в службе хранилища Azure или на узлах. Кроме того, вам не нужно создавать [URL-адреса SAS](../storage/storage-dotnet-shared-access-signature-part-1.md), чтобы предоставить доступ к файлам в своей учетной записи хранения Azure.

Пакетная служба обрабатывает сведения о работе со службой хранилища Azure в фоновом режиме, обеспечивая хранение и развертывание пакетов приложений на вычислительных узлах. При этом упрощается код и сокращаются издержки, связанные с управлением.

## Передача приложений и управление ими

С помощью портала Azure вы можете добавлять, обновлять и удалять пакеты приложений, а также настраивать для каждого приложения версии по умолчанию. Сейчас эти операции можно выполнять только на портале Azure.

В следующих разделах мы сначала рассмотрим связывание учетной записи хранения с учетной записью пакетной службы, а затем расскажем о возможностях управления пакетом, доступных на портале Azure. После этого вы узнаете, как развертывать эти пакеты на вычислительных узлах с помощью библиотеки [пакетной службы для .NET][api_net].

### Связывание учетной записи хранения

Чтобы использовать пакеты приложений, вам сначала нужно связать учетную запись хранения Azure со своей учетной записью пакетной службы. Если вы еще не настроили учетную запись хранения для своей учетной записи пакетной службы, на портале Azure отобразится предупреждение, когда вы в первый раз щелкнете плитку *Приложения* в колонке учетной записи пакетной службы.

![Предупреждение об отсутствии настроенной учетной записи хранения на портале Azure][9]

Пакетная служба использует связанную учетную запись хранения для хранения и извлечения пакетов приложений. Когда вы свяжете две учетные записи, пакетная служба сможет автоматически развертывать на вычислительных узлах пакеты, хранимые в связанной учетной записи хранения. Щелкните **Параметры учетной записи хранения** в колонке *Предупреждение*, а затем **Учетная запись хранения** в колонке *Учетная запись хранения*, чтобы связать учетную запись хранения с учетной записью пакетной службы.

![Выбор колонки учетной записи хранения на портале Azure][10]

Рекомендуем создать учетную запись хранилища *специально* для учетной записи пакетной службы и выбрать ее здесь. Дополнительные сведения о создании учетной записи хранения см. в разделе "Создание учетной записи хранения" статьи [Об учетных записях хранения Azure](../storage/storage-create-storage-account.md). Созданную учетную запись хранения затем можно связать с учетной записью пакетной службы с помощью колонки *Учетная запись хранения*.

> [AZURE.WARNING] Поскольку пакетная служба хранит пакеты приложений с использованием службы хранилища Azure, с вас будет [взиматься обычная плата][storage_pricing] за использование блочных BLOB-объектов. Вам обязательно следует учитывать размер и количество пакетов приложений, периодически удаляя устаревшие пакеты для минимизации расходов.

### Просмотр текущих приложений

Чтобы просмотреть приложения в учетной записи пакетной службы, щелкните элемент **Приложения** в колонке учетной записи пакетной службы.

![Плитка "Приложения"][2]

Откроется колонка *Приложения*:

![Список приложений][3]

В колонке *Приложения* отображается идентификатор каждого приложения в вашей учетной записи, а также следующие свойства:

* **Пакеты** — количество версий, связанных с этим приложением.
* **Версия по умолчанию** — если не указать версию при настройке приложения для пула, будет установлена эта версия. Это необязательный параметр.
* **Разрешить обновления** — если это свойство имеет значение *Нет*, возможность обновления и удаления пакетов будет удалена для этого приложения. Вы сможете добавлять только новые версии пакета приложения. По умолчанию используется значение *Да*.

### Просмотр сведений о приложении

Щелкнув по приложению в колонке *Приложения*, вы увидите колонку со сведениями для этого приложения.

![Сведения о приложении][4]

В колонке сведений о приложении можно настроить следующие параметры для приложения.

* **Разрешить обновления** — возможность обновления и удаления пакетов приложений (см. раздел "Обновление или удаление пакета приложения" ниже).
* **Версия по умолчанию** — выбор пакета приложения по умолчанию для развертывания на вычислительных узлах.
* **Отображаемое имя** — "понятное" имя, которое решение пакетной службы может использовать при отображении сведений о приложении, например в пользовательском интерфейсе службы, предоставляемой клиентам через пакетную службу.

### Добавление нового приложения

Чтобы создать приложение, добавьте пакет приложения, используя новый уникальный идентификатор. Первый пакет приложения, добавленный с помощью идентификатора нового приложения, в свою очередь создаст приложение.

Щелкните **Добавить** в колонке *Приложения*, чтобы открыть колонку *Новое приложение*.

![Колонка "Новое приложение" на портале Azure][5]

Колонка *Новое приложение* включает следующие поля для настройки параметров нового приложения и пакета приложения.

**Метаданные**

Вы можете вручную указать метаданные приложения (введя значения непосредственно в текстовые поля **Идентификатор приложения** и **Версия**) или отправить JSON-файл, содержащий эти метаданные. Чтобы вручную указать идентификатор и версию приложения, просто оставьте значение **Ввести метаданные** (значение по умолчанию) в раскрывающемся списке **Метаданные**. Затем вручную введите значения в текстовые поля **Идентификатор приложения** и **Версия**.

Чтобы указать JSON-файл с метаданными, содержащий идентификатор и версию пакета, выберите в раскрывающемся списке **Метаданные** пункт **Отправить файл метаданных**:

![Пункт "Передать файл метаданных" в раскрывающемся списке][6]

Затем щелкните значок папки рядом с появившимся текстовым полем **Файл метаданных** и укажите локальный файл, содержащий данные JSON. В нашем примере мы выбрали для отправки файл `litware_1.1001.2b.json`. Это значит, что текстовые поля **Идентификатор приложения** и **Версия** автоматически заполняются данными из файла:

![Параметры для варианта "Передать файл метаданных"][13]

Чтобы указать метаданные пакета приложения в файле, используйте следующий формат JSON:

```
{
    "id": "litware",
    "version": "1.1001.2b"
}
```

> [AZURE.NOTE] Если вы отправили файл метаданных JSON с идентификатором и версией приложения, вам *не* нужно дополнительно изменять значения в текстовых полях "Идентификатор приложения" и "Версия" — они автоматически заполняются данными из файла JSON.

**Идентификатор приложения**

Указывает идентификатор нового приложения, на который распространяются стандартные правила проверки идентификатора пакетной службы Azure.

* Может содержать любое сочетание букв и цифр, включая дефисы и символы подчеркивания.
* Не может содержать более 64 символов.
* Должен быть уникальным в рамках учетной записи пакетной службы.
* С сохранением регистра, но без его учета.

**Версия**

Указывает версию пакета приложения, который вы передаете. На строки версии распространяются следующие правила проверки.

* Могут содержать любое сочетание букв и цифр, включая дефисы, символы подчеркивания и точки.
* Не могут содержать более 64 символов.
* Должны быть уникальными в рамках приложения.
* С сохранением регистра, но без его учета.

**Пакет приложения**

Указывает ZIP-файл, содержащий двоичные файлы приложения и вспомогательные файлы, необходимые для выполнения приложения. Щелкните текстовое поле **Выбор файла** или значок папки, чтобы выбрать ZIP-файл, содержащий файлы приложения.

Выбрав файл, нажмите кнопку **ОК**, чтобы отправить файл в службу хранилища Azure. Когда передача файла завершится, вы получите уведомление, а сама колонка будет закрыта. Обратите внимание: скорость выполнения этой операции зависит от размера передаваемого файла и возможностей сетевого подключения.

> [AZURE.WARNING] Не закрывайте колонку *Новое приложение* до завершения операции. Иначе вы прервете процесс передачи.

### Добавление нового пакета приложения

Чтобы добавить новую версию пакета приложения для существующего приложения, выберите это приложение в колонке *Приложения*, щелкните **Пакеты** и нажмите кнопку **Добавить**, чтобы открыть колонку *Добавление пакета*.

![Колонка "Добавление пакета приложения" на портале Azure][8]

Как видите, эти поля совпадают с полями в колонке *Новое приложение*, за исключением неактивного текстового поля "Идентификатор приложения". Как описано выше, укажите **версию** нового пакета, выберите ZIP-файл **пакета приложения**, а затем нажмите кнопку **ОК**, чтобы отправить пакет.

### Обновление или удаление пакета приложения

Чтобы обновить или удалить существующий пакет приложения, откройте колонку со сведениями о приложении, щелкните пункт **Пакеты**, чтобы открыть колонку *Пакеты*, затем щелкните **многоточие** в строке пакета приложения, который вы хотите изменить, и выберите нужное действие.

![Обновление или удаление пакета на портале Azure][7]

**Блокировка изменений**

Если нажать кнопку **Обновить**, отобразится колонка *Обновление пакета*. Эта колонка аналогична колонке *Новый пакет приложения*, но в ней активно только поле для выбора ZIP-файла пакета для отправки.

![Колонка "Обновление пакета" на портале Azure][11]

**Удалить**

При нажатии кнопки **Удалить** вам будет предложено подтвердить удаление пакета. Затем пакетная служба удалит пакет из службы хранилища Azure. Удалив версию приложения по умолчанию, вы удалите настройку версии по умолчанию для этого приложения.

![Удаление приложения][12]

## Установка приложений на вычислительных узлах

Мы рассмотрели передачу пакетов приложений и управление ими с помощью портала Azure. Теперь можно перейти к их фактическому развертыванию на вычислительных узлах, а также их выполнению с помощью задач пакетной службы.

Чтобы установить пакет приложения на вычислительные узлы в пуле, укажите *ссылки* на один или несколько пакетов приложений для пула. В пакетной службе для .NET это можно сделать, добавив одно или несколько свойств [CloudPool][net_cloudpool].[ApplicationPackageReferences][net_cloudpool_pkgref] во время создания пула или добавив эти свойства в существующий пул.

Класс [ApplicationPackageReference][net_pkgref] определяет идентификатор приложения и версию для установки на вычислительные узлы пула.

```csharp
// Create the unbound CloudPool
CloudPool myCloudPool =
    batchClient.PoolOperations.CreatePool(poolId: "myPool",
                                          osFamily: "4",
                                          virtualMachineSize: "small",
                                          targetDedicated: "1");

// Specify the application and version to install on the compute nodes
myCloudPool.ApplicationPackageReferences = new List<ApplicationPackageReference>
{
    new ApplicationPackageReference {
        ApplicationId = "litware",
        Version = "1.1001.2b" }
};

// Commit the pool so that it's created in the Batch service. As the nodes join
// the pool, the specified application package will be installed on each.
await myCloudPool.CommitAsync();
```

## Выполнение установленных приложений

По мере того как каждый вычислительный узел подключается к пулу (или перезагружается, а также при повторном создании образа узла), указанные пакеты загружаются и извлекаются в указанный `AZ_BATCH_ROOT_DIR` на узле. Пакетная служба также создает переменную среды, которую командные строки задачи будут использовать при вызове двоичных файлов приложения. Для этой переменной применяется следующая схема именования:

`AZ_BATCH_APP_PACKAGE_appid#version`

Например, если вы выбираете установку приложения *blender* версии 2.7, то для того, чтобы задачи смогли получить доступ к двоичным файлам приложения, необходимо задать следующую переменную среды:

`AZ_BATCH_APP_PACKAGE_BLENDER#2.7`

Если для приложения используется версия по умолчанию, на переменную среды можно ссылаться без суффикса со строкой версии. Например, если на портале Azure для приложения *blender* указана версия 2.7 по умолчанию, задачи могут обращаться к следующей переменной среды:

`AZ_BATCH_APP_PACKAGE_BLENDER`

В следующем фрагменте кода показано, как можно настроить задачу, если для приложения *blender* указана версия по умолчанию.

```csharp
string taskId = "blendertask01";
string commandLine = @"cmd /c %AZ_BATCH_APP_PACKAGE_BLENDER%\blender.exe -my -command -args";
CloudTask blenderTask = new CloudTask(taskId, commandLine);
```

> [AZURE.TIP] Дополнительные сведения о параметрах среды вычислительных узлов см. в разделе "Параметры среды для задач" статьи [Обзор функций пакетной службы Azure](batch-api-basics.md).

## Обновление пакетов приложений пула

Если для существующего пула уже выполнена настройка пакета приложения, вы можете указать новый пакет для пула. Новый указанный пакет будет установлен на все новые узлы, присоединенные к пулу. Пакет также будет установлен на все существующие узлы, которые были перезагружены или для которых был повторно создан образ. Новый пакет приложения не будет автоматически установлен на вычислительные узлы, которые во время обновления ссылки на пакет уже существовали в пуле.

В нашем примере для существующего пула настроена версия 2.7 приложения *blender* (в качестве одного из свойств [CloudPool][net_cloudpool].[ApplicationPackageReferences][net_cloudpool_pkgref]). Чтобы обновить узлы в пуле, используя версию 2.76b, укажите новое свойство [ApplicationPackageReference][net_pkgref] с новой версией, а затем подтвердите изменения.

```csharp
string newVersion = "2.76b";
CloudPool boundPool = await batchClient.PoolOperations.GetPoolAsync("myPool");
boundPool.ApplicationPackageReferences = new List<ApplicationPackageReference>
{
    new ApplicationPackageReference {
        ApplicationId = "blender",
        Version = newVersion }
};
await boundPool.CommitAsync();
```

После настройки новой версии на всех *новых* узлах, присоединенных к пулу, будет развернута версия 2.76b. Чтобы установить версию 2.76b на все узлы, *уже* существующие в пуле, перезагрузите их (или создайте для них новый образ). Обратите внимание: после перезагрузки на узлах будут оставаться файлы предыдущих развертываний пакета.

## Список приложений в учетной записи пакетной службы

Вы можете вывести список приложений и их пакетов, входящих в учетную запись пакетной службы, с помощью метода [ApplicationOperations][net_appops].[ListApplicationSummaries][net_appops_listappsummaries].

```csharp
// List the applications and their application packages in the Batch account.
List<ApplicationSummary> applications = await batchClient.ApplicationOperations.ListApplicationSummaries().ToListAsync();
foreach (ApplicationSummary app in applications)
{
    Console.WriteLine("ID: {0} | Display Name: {1}", app.Id, app.DisplayName);

    foreach (string version in app.Versions)
    {
        Console.WriteLine("  {0}", version);
    }
}
```

## Заключение

С помощью пакетов приложений вы можете легко предоставлять пользователям возможность выбирать приложения для своих заданий и указывать точную версию для использования при обработке заданий в пакетной службе. Вы также можете предоставить пользователям возможность передавать и отслеживать свои приложения в вашей службе.

## Дальнейшие действия

* [API REST пакетной службы][api_rest] также обеспечивает поддержку при работе с пакетами приложений. В качестве примера см. элемент [applicationPackageReferences][rest_add_pool_with_packages] в руководстве по [добавлению пула в учетную запись][rest_add_pool] для выбора установочных пакетов с помощью API REST. Дополнительную информацию о получении сведений с помощью REST API пакетной службы см. в разделе [Приложения][rest_applications].

* Узнайте больше о программном [управлении квотами и учетными записями пакетной службы Azure с помощью библиотеки .NET для управления пакетной службой](batch-management-dotnet.md). С помощью [библиотеки .NET для управления пакетной службой][api_net_mgmt] можно включить функции создания и удаления для службы или приложения пакетной службы.

[api_net]: http://msdn.microsoft.com/library/azure/mt348682.aspx
[api_net_mgmt]: https://msdn.microsoft.com/library/azure/mt463120.aspx
[api_rest]: http://msdn.microsoft.com/library/azure/dn820158.aspx
[github_samples]: https://github.com/Azure/azure-batch-samples
[storage_pricing]: https://azure.microsoft.com/pricing/details/storage/
[net_appops]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.applicationoperations.aspx
[net_appops_listappsummaries]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.applicationoperations.listapplicationsummaries.aspx
[net_cloudpool]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.aspx
[net_cloudpool_pkgref]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.applicationpackagereferences.aspx
[net_pkgref]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.applicationpackagereference.aspx
[rest_applications]: https://msdn.microsoft.com/library/azure/mt643945.aspx
[rest_add_pool]: https://msdn.microsoft.com/library/azure/dn820174.aspx
[rest_add_pool_with_packages]: https://msdn.microsoft.com/library/azure/dn820174.aspx#bk_apkgreference

[1]: ./media/batch-application-packages/app_pkg_01.png "Общая схема: пакеты приложений"
[2]: ./media/batch-application-packages/app_pkg_02.png "Плитка "Приложения" на портале Azure"
[3]: ./media/batch-application-packages/app_pkg_03.png "Колонка "Приложения" на портале Azure"
[4]: ./media/batch-application-packages/app_pkg_04.png "Параметры в колонке "Сведения о приложении" на портале Azure"
[5]: ./media/batch-application-packages/app_pkg_05.png "Колонка "Новое приложение" на портале Azure"
[6]: ./media/batch-application-packages/app_pkg_06.png "Пункт "Передать файл метаданных" в раскрывающемся списке"
[7]: ./media/batch-application-packages/app_pkg_07.png "Варианты "Обновить" и "Удалить" для пакетов на портале Azure"
[8]: ./media/batch-application-packages/app_pkg_08.png "Колонка "Новый пакет приложения" на портале Azure"
[9]: ./media/batch-application-packages/app_pkg_09.png "Предупреждение об отсутствии связанной учетной записи хранения"
[10]: ./media/batch-application-packages/app_pkg_10.png "Выбор колонки учетной записи хранения на портале Azure"
[11]: ./media/batch-application-packages/app_pkg_11.png "Колонка "Обновление пакета" на портале Azure"
[12]: ./media/batch-application-packages/app_pkg_12.png "Диалоговое окно для подтверждения удаления пакета на портале Azure"
[13]: ./media/batch-application-packages/app_pkg_13.png "Параметры для варианта "Передать файл метаданных""

<!---HONumber=AcomDC_0323_2016-->