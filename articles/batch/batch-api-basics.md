<properties 
	pageTitle="Основные сведения об API Пакетной службы Azure" 
	description="Основные понятия для ознакомления разработчиков с API Пакетной службы Azure и Пакетной службой" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="07/14/2015" 
	ms.author="yidingz"/>

<!--The next line, with one pound sign at the beginning, is the page title-->
# Основные сведения об API Пакетной службы Azure

Пакетная служба Azure предоставляет платформу планирования заданий для масштабируемых и распределенных вычислений. Пакетная служба обслуживает набор виртуальных машин, расположенных в разных кластерах и центрах обработки данных Microsoft Azure. Пакетная служба выполняет распределенные вычисления, запуская одну или несколько программ в указанной коллекции узлов. Это происходит по запросу или в запланированное время. Пакетная служба управляет этими узлами, запуская вычислительные задачи в соответствии с требованиям к ресурсам, спецификациями и заданными ограничениями.

Пакетная служба позволяет избавиться от необходимости писать код для организации очереди, планирования, выделения вычислительных ресурсов и управления ими. Это дает возможность сосредоточиться на конкретном приложении и не беспокоиться о сложности планирования заданий и управления ресурсами базовой платформы. Это также позволяет Пакетной службе оптимизировать расположение заданий и их доступ к данным, которые необходимо обработать.

Ниже приведены некоторые сценарии, которые можно реализовать с помощью Пакетной службы:

- Параллельная обработка больших объемов вычислений.

- Ежедневная очистка файлов.

- Пакетная обработка.

## <a name="resource"></a> Ресурсы пакетной службы

При использовании Пакетной службы можно воспользоваться следующими ресурсами:

- [Учетная запись](#account).

- [Вычислительный узел](#computenode)

- [Пул](#pool).

- [Задание](#job).

- [Задача](#task).

	- [Задача запуска](#starttask).
	
	- [Задание ManagerTask](#jobmanagertask).

- [JobSchedule](#jobschedule)

### <a name="account"></a>Учетная запись

Учетная запись Пакетной службы — это уникально идентифицируемая сущность в Пакетной службе. Вся обработка данных осуществляется через учетную запись Пакетной службы. Для выполнения операций с помощью Пакетной службы нужно знать имя учетной записи и ее ключ. Процедуру создания учетной записи пакетной службы см. в разделе "Учетная запись пакетной службы" в [обзоре пакетной службы Azure][].


### <a name="computenode"></a>Вычислительный узел

Вычислительный узел (узел) — это узел Azure, выделенный приложению под определенную рабочую нагрузку. Размер узла определяет количество ядер ЦП, объем памяти и размер локальной файловой системы, которые выделяются узлу. Размер узла может малым, большим и очень большим. Дополнительную информацию см. в статье [Размеры виртуальных машин и облачных служб для Azure](http://msdn.microsoft.com/library/dn197896.aspx).

Типы программ, которые могут выполняться на узле, включают в себя исполняемые файлы (EXE-файлы), командные файлы (CMD-файлы), пакетные файлы (BAT-файлы) и файлы сценариев. Узел также имеет следующие атрибуты.

- Связанные с задачами папки файловой системы, которые являются общими. На каждом узле пула создается структура папок и переменные среды. Создается следующая структура папок с "общей" папкой для приложений и данных, общих для задач, а также папка для каждой задачи.

<pre><code> ─ %AZ_BATCH_NODE_ROOT_DIR%
   ├─shared
   ├─startup
   └─&lt;JOB_ID>
     ├─&lt;TASK_ID_1>
     │ └─wd
     └─&lt;TASK_ID_2>
       └─wd
</code></pre>


- Файлы stdout.txt и stderr.txt, которые записываются в папку задачи.

- Переменные среды для обработки.

- Параметры брандмауэра, настроенные для управления доступом.

>Доступ к узлу
>
>Если к узлу требуется доступ, например для отладки, можно получить RDP-файл, который затем может использоваться для доступа к узлу через удаленный рабочий стол.


### <a name="pool"></a>Пул

Пул — это коллекция узлов, на которых выполняется приложение. Пул может быть создан как вами, так и автоматически Пакетной службой при указании выполняемых работ. Вы можете создать и настроить пул таким образом, чтобы он удовлетворял требованиям вашего приложения. Пул может использоваться только той учетной записью Пакетной службы, с помощью которой он был создан. Учетная запись Пакетной службы может содержать более одного пула.

Пулы пакетной службы Azure основаны на базовой вычислительной платформе Azure. Они выполняют операции крупномасштабного выделения, установки приложений и данных, перемещения данных, наблюдения за работоспособностью, а также обеспечивают гибкое масштабирование узлов.

Каждому узлу, который добавляется в пул, присваивается уникальное имя и связанный IP-адрес. Когда узел удаляется из пула, он теряет изменения, внесенные в операционную систему, все локальные файлы, а также имя и IP-адрес. Когда узел покидает пул, он перестает существовать.

В пуле можно настроить обмен данными между входящими в него узлами. Если для пула был запрошен внутренний обмен данными, пакетная служба сделает доступными порты с номерами больше 1100 для всех узлов пула. Каждый узел пула настраивается таким образом, чтобы ограничить доступные входящие подключения только данным диапазоном портов и данной коллекцией узлов пула. Если приложению не требуется обмен данными между узлами, пакетная служба может выделить для пула большое количество узлов из разных кластеров и центров обработки данных. Это позволяет расширить возможности параллельной обработки.

При создании пула можно указать следующие атрибуты:

- **Размер узлов** в пуле.
	- Соответствующий размер узла выбирается на основе характеристик и требований приложения или приложений, которые будут использоваться на данном узле. Обычно размер узла выбирается, исходя из предположения, что на узле в один момент времени будет выполняться одна задача. Например, для определения наиболее подходящего и экономичного размера узла учитываются такие факторы, как многопоточность приложения и требуемый объем памяти. Можно также ориентироваться на режим параллельного выполнения нескольких назначенных задач и нескольких экземпляров приложения. В таком случае обычно выбирается более крупный узел — см. раздел с описанием максимального количества задач для каждого узла (ниже). 
	- Все узлы в пуле должны быть одинакового размера. Если должны выполняться различные приложения с разными требованиями к системе и (или) с разной нагрузкой, то необходимо создать отдельные пулы.
	- Для пула можно настраивать узлы облачной службы любого размера, кроме A0.

- Семейство и версия операционной системы, запущенной на узлах.
	- Так же как и с рабочими ролями, семейство и версии ОС можно настраивать.
	- Семейство ОС также определяет, какие версии .NET устанавливаются вместе с операционной системой.
	- Так же как и с рабочими ролями, для версии ОС рекомендуется использовать знак звездочка (*). Это обеспечит автоматическое обновление узлов, а также позволит не предпринимать какие-либо действия для адаптации под новые версии. При выборе версии ОС необходимо, в первую очередь, убедиться, что обеспечивается совместимость приложений. Для этого перед обновлением версии следует протестировать обратную совместимость. После выполнения проверки версию ОС для пула можно обновить и установить новый образ ОС — любая выполняемая задача будет прервана и повторно поставлена в очередь.

- Целевое количество узлов, которые должны быть доступны для пула.

- Политика масштабирования для пула. Кроме количества узлов также можно указать формулу автоматического масштабирования для каждого пула. Пакетная служба выполнит формулу, выбирая количество узлов на основе статистических данных о пуле и рабочих элементах.

- Планирование конфигурации
	- Конфигурация по умолчанию предусматривает выполнение одной задачи на узле пула в любое время. Но существуют сценарии, когда полезно иметь возможность одновременного выполнения нескольких задач на одном узле. Примером может служить повышение уровня нагрузки на узел, если приложение должно ожидать выполнение операции ввода-вывода. Наличие нескольких работающих приложений приведет к увеличению нагрузки на ЦП. Другой пример — уменьшение количества узлов в пуле. Это может привести к уменьшению количества копий данных, необходимых для крупных эталонных наборов данных. Если A1 будет правильным размером для приложения, то можно выбрать A4. Тогда конфигурация сможет выполнять одновременно до 8 задач, каждая из которых будет использовать одно ядро.
	- Конфигурация с максимальным количеством задач для каждого узла определяет максимальное количество задач, которые могут выполняться параллельно.
	- Также можно выбрать политику заполнения, которая определяет порядок заполнения узлов пакетной службой. Узлы могут заполняться в первую очередь или же задачи будут распределены по всем узлам.
 
- Статус взаимодействия между узлами в пуле.
 	- В большинстве сценариев задачи выполняются независимо друг от друга и не должны взаимодействовать с другими задачами. Но существуют некоторые приложения, где задачи будут взаимодействовать между собой (например, приложения, которые применяют MPI).
	- Существует конфигурация, контролирующая возможность узлов взаимодействовать друг с другом. Она используется для настройки базовой сетевой инфраструктуры и влияет на размещение узлов.

- Задача запуска для узлов в пуле.

При создании пула можно указать учетную запись хранения, с которой необходимо связать пул. Пакетная служба выделяет узлы из центров обработки данных с наилучшим сетевым соединением и пропускной способностью для указанной учетной записи хранения. Это обеспечивает рабочим нагрузкам более эффективный доступ к данным.

### <a name="job"></a>Задание

Задание представляет собой набор задач. Задание определяет порядок выполнения вычислений на вычислительных узлах в пуле.

- Задание указывает пул, в котором будет выполняться работа. Созданный заранее пул может использоваться различными заданиями. Но также можно создать пул для каждого задания, связанного с расписанием заданий, или для всех заданий, связанных с расписанием заданий.
- Можно указать необязательный приоритет. Задание можно отправить с более высоким приоритетом, чем у других заданий, которые еще выполняются. В таком случае задачи заданий с более высоким приоритетом ставятся в очередь перед задачами заданий с более низким приоритетом. Задачи с более низким приоритетом, которые уже выполняются, прерываться не будут.
- Ограничения.
	- Для заданий можно указывать максимальное время выполнения. Если задания выполняется дольше, чем указанное максимальное время выполнения, то такое задание и все связанные с ним задачи будут завершены.
	- Пакетная служба Azure может обнаруживать задачи, которые завершаются с ошибкой и повторно запускать задачи. В качестве ограничения можно указать максимальное число повторов задачи по умолчанию. Также можно указать, будет ли задача повторяться всегда или никогда. Повторное выполнение задачи означает, что данная задача повторно помещается в очередь и будет снова запущена.
- Задачи, выполняемые в рамках задания, могут быть добавлены клиентом в задание. Также можно указать задачу диспетчера заданий. Задача диспетчера заданий использует API пакетной службы. Кроме того, она содержит код для создания необходимых задач для задания с помощью задачи, выполняемой на одном из узлов пула. Задача диспетчера заданий обрабатывается особым образом пакетной службой — она помещается в очередь сразу при создании задания и перезапускается по любой причине, если происходит сбой. Диспетчер заданий требуется для задания, создаваемого расписанием заданий, так как это единственный способ определения задач перед созданием экземпляра задания.


### <a name="task"></a>Задача

Задача представляет собой единицу вычисления, которая связана с заданием и выполняется на узле. Задачи назначаются узлу для выполнения или ставятся в очередь, пока не освободится какой-либо узел. Задача использует следующие ресурсы:

- Программа, указанная в рабочем элементе.

- Файлы ресурсов, которые содержат данные для обработки. Эти файлы автоматически копируются на узел из хранилища больших двоичных объектов. Дополнительную информацию см. в разделе «Файлы и каталоги».

- Необходимые программе параметры среды. Дополнительную информацию см. в разделе «Параметры среды для задач».

- Ограничения, в рамках которых должны выполняться вычисления. Например — максимальное время, в рамках которого задаче разрешено выполняться; максимальное количество попыток выполнить задачу в случае сбоя; максимальное время хранения файлов в рабочем каталоге.

Помимо задач, которые можно определить для выполнения вычислений на узле, можно использовать следующие специальные задачи, предоставленные пакетной службой:

- [Задача запуска](#starttask)

- [Задача диспетчера заданий](#jobmanagertask)

#### <a name="starttask"></a>Задача запуска

Можно настроить операционную систему узлов в пуле, связав задачу запуска с пулом. Задача запуска может выполнять такие действия, как установка программного обеспечения или запуск фоновых процессов. Задача запуска выполняется при каждом запуске узла. Она выполняется все время, пока узел остается в пуле.

Как и с любой задачей пакетной службы, в службе хранилища Azure можно указать список файлов в дополнение к командной строке, которая выполняется пакетной службой. Пакетная служба Azure сначала будет копировать файлы из службы хранилища Azure, а затем запускать командную строку. Список файлов для задачи запуска пула обычно содержит файлы приложений или пакет. В нем также могут содержаться справочные данные, которые будут использоваться всеми задачами, выполняемыми на узлах пула. Командная строка может выполнять любой скрипт PowerShell или команду robocopy, например, чтобы скопировать файлы приложения в "общую" папку. Она также может запускать MSI-файл.

Как правило, пакетной службе лучше дождаться завершения задачи запуска, а затем считать узел готовым к назначению задач, но это можно настроить.

При сбое задачи запуска для узла пула состояние узла обновляется, чтобы отобразить сбой. При этом узел будет недоступным для назначения задач. Задача запуска может завершиться с ошибкой, если имеется проблема при копировании файлов, указанных для задачи запуска, или процесс задачи запуска возвращает ненулевое значение.

Объявление всей информации, необходимой для настройки узлов и установки приложений, указывает на то, что увеличить количество узлов в пуле так же просто, как указать новое необходимое количество. Пакетная служба содержит всю информацию, необходимую для настройки узлов и их подготовке к приему задач.

Задача запуска определяется путем добавления раздела JSON в текст запроса для операции добавления пула (Add Pool). В следующем примере показано базовое определение задачи запуска:

	{
		“commandLine”:”mypoolsetup.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”mypoolsetup.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“maxTaskRetryCount”:0
	}

Интерфейс C# выглядит следующим образом:

	CloudPool pool = pm.CreatePool(poolId, targetDedicated: 3, virtualMachineSize: "small", osFamily: "3");
	pool.StartTask = new StartTask();
	pool.StartTask.CommandLine = "mypoolsetup.exe";
	pool.StartTask.ResourceFiles = new List<IResourceFile>();
	pool.StartTask.ResourceFiles.Add(new ResourceFile("http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d", "mypoolsetup.exe"));
	pool.Commit();


#### <a name="jobmanagertask"></a>Задача диспетчера заданий

Задача диспетчера заданий запускается перед выполнением всех других задач. Задача диспетчера заданий предоставляет следующие преимущества:

- Автоматически создается Пакетной службой при создании задания.

- Запускается перед выполнением других задач в задании.

- Связанный с ней узел удаляется из пула последним при уменьшении размера пула.

- При перезапуске данной задаче присваивается наивысший приоритет. Если узел в состоянии простоя недоступен, пакетная служба может прервать выполнение одной из запущенных задач в пуле. Это позволит освободить место для запуска вышеупомянутой задачи.

- Такое завершение задачи может привести к завершению всех задач данного задания.

Задача диспетчера заданий в задании не имеет приоритета над задачами других заданий. Приоритеты применяются только на уровне заданий. Задача диспетчера заданий определяется путем добавления раздела XML в текст запроса для операции добавления рабочего элемента. В следующем примере показано базовое определение задачи диспетчера заданий:

	{
		“name”:”jmTask”,
		“commandLine”:”myapp1.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp1.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“taskConstraints”:
		{
			“maxWallClockTime”:”PT1H”,
			“maxTaskRetryCount”:0,
			“retentionTime”:”PT1H”
		},
		“killJobOnCompletion”:true,
		“runElevated”:false,
		“runExclusive”:true
	}


### <a name="jobschedule"></a>Расписание заданий

Расписание заданий — это способ создания нескольких заданий с запланированным временем запуска. При создании расписания заданий для каждого события расписания создается по одному заданию.

## <a name="workflow"></a>Рабочий процесс пакетной службы

Чтобы воспользоваться Пакетной службой и ее ресурсами для планирования вычислений, необходимо иметь учетную запись Пакетной службы. При создании сценария распределенных вычислений с помощью Пакетной службы используется следующий базовый рабочий процесс:

1\. Передайте файлы, которые вы хотите использовать в сценарии распределенных вычислений, в учетную запись хранения Azure. Чтобы Пакетная служба имела к ним доступ, они должны находиться в учетной записи хранения. Пакетная служба загружает их на узел при выполнении задачи.

2\. Передайте зависимые двоичные файлы в учетную запись хранения. Двоичные файлы включают в себя программу, которая выполняется задачей, и зависимые сборки. Эти файлы также должны быть доступны из хранилища и загружены на узел.

3\. Создайте пул узлов. При создании пула можно указать размер виртуальной машины задач. При выполнении задачи ей назначается узел из этого пула.

4\. Создайте рабочий элемент. Задание создается автоматически при создании рабочего элемента. Рабочий элемент позволяет управлять заданием, которое содержит задачи.

5\. Добавьте задачи в рабочий элемент. Каждая задача использует переданную вами программу для обработки информации из переданного вами файла.

6\. Отслеживайте выходные данные.

## <a name="files"></a>Файлы и каталоги

У каждой задачи есть рабочий каталог, в котором она может создавать дополнительные файлы и каталоги для хранения программы, выполняемой задачей, обрабатываемых задачей данных, а также выходных данных. Эти каталоги и файлы будут доступными для использования другим задачам во время выполнения задания. Все задачи, файлы и каталоги на узле принадлежат одной учетной записи пользователя.

Пакетная служба предоставляет часть файловой системы на узле в качестве корневого каталога. Корневой каталог узла доступен задаче через переменную среды AZ\_BATCH\_NODE\_ROOT\_DIR. Дополнительную информацию об использовании переменных среды см. в разделе «Параметры среды для задач».

Корневой каталог содержит следующие подкаталоги:

- **Tasks** — в этом расположении хранятся все файлы выполняемых на узле задач. Для каждой задачи пакетная служба создает рабочий каталог с уникальным путем %AZ\_BATCH\_TASK\_ROOT\_DIR%. Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Время существования каталога определяется указанным для задачи ограничением RetentionTime.

- **Shared** — это общий каталог для всех задач учетной записи. %AZ\_BATCH\_NODE\_SHARED\_DIR% — это путь к общему каталогу на узле. Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в данном каталоге.

- **Start** — это расположение используется задачей запуска в качестве рабочего каталога. В этом каталоге также хранятся все файлы, скачанные Пакетной службой для выполнения задачи запуска. %AZ\_BATCH\_NODE\_START\_DIR% — это путь к каталогу запуска на узле. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Также данный каталог может использоваться задачами запуска для настройки операционной системы.

При удалении узла из пула удаляются все файлы, хранящиеся на этом узле.

## <a name="lifetime"></a>Время существования пулов и узлов

В проектном решении ключевыми являются обстоятельства, при которых создаются пулы, а также интервал времени, на протяжении которого узлы остаются доступными.

Одной из крайностей является создание пула для каждого задания при его отправке, а также удаление узлов при завершении выполнения задач. Это приводит к максимальному использованию ресурсов, так как узлы выделяются только при крайней необходимости и завершают работу, как только переходят в состояние простоя. Это означает, что задание должно ожидать выделения узлов. При этом важно отметить, что запланированное распределение задач узлам происходит, как только каждый отдельный узел становится доступным и выделенным, а задача запуска — выполнена. Иными словами, пакетная служба НЕ дожидается, пока все узлы в пуле станут доступными, поскольку это привело бы к неэффективному использованию ресурсов.

Если приоритетом является немедленное выполнение заданий, вопрос создания пула и доступности узлов должен быть решен до отправки задания. Задачи могут запускаться немедленно, но в зависимости от нагрузки узлы могут пребывать в состоянии простоя, ожидая поступления задач задания.

Рассмотрим один общий сценарий с переменным объемом текущей нагрузки. Ключевым здесь является наличие пула, в который отправляется несколько заданий. При этом количество узлов увеличивается или уменьшается в зависимости от нагрузки. Это регуляция происходит либо в ответ на нагрузку, либо заранее, если нагрузку можно прогнозировать.

## <a name="scaling"></a>Масштабирование приложений

Приложение может легко автоматически масштабироваться, подстраиваясь под потребности в вычислениях. Количество узлов в пуле можно регулировать динамически в соответствии с текущей рабочей нагрузкой и статистикой использования ресурсов. Также вы можете оптимизировать общую стоимость выполнения приложения, настроив для него автоматическое масштабирование. Параметры масштабирования можно указать при создании пула, при этом конфигурацию можно будет обновить в любое время.

Для уменьшения количества узлов следует учитывать задачи, которые могут выполняться на узлах. Указывается политика отмены выделения, определяющая поведение запущенных задач: будут ли такие задачи немедленно остановлены для удаления узла или они смогут завершить работу до удаления узлов. Если для целевого количества узлов указать нулевое значение в конце задания, но разрешить текущим задачам завершаться нормально, будет обеспечена максимальная эффективность использования ресурсов.

Автоматическое масштабирование приложения указывается с помощью набора формул масштабирования. Формулы можно использовать для определения количества узлов в пуле для следующего интервала масштабирования. Например, вам нужно запланировать для пула большое количество задач. Вы можете назначить для пула формулу масштабирования, которая будет определять размер пула на основе текущего числа ожидающих задач и скорости их выполнения. Пакетная служба периодически вычисляет формулу и изменяет размер пула в зависимости от рабочей нагрузки.

Формула может основываться на следующих метриках:

- **Метрики времени** — основываются на статистических данных, которые собираются каждые 5 минут за указанное число часов.

- **Метрики ресурсов** — основываются на показателях загрузки ЦП, использования пропускной способности и памяти, а также на количестве узлов.

- **Метрики задач** — основываются на состоянии задач (активные, ожидающие и завершенные).

Дополнительную информацию об автоматическом масштабировании приложения см. в разделе «Настройка автоматического масштабирования виртуальных машин задач».

>Удаление узлов
>
>Хоть это требуется не очень часто, но вы можете выбрать отдельные узлы, которые будут удалены из пула. Например, если какой-то узел предположительно является не очень надежным, его можно удалить.

## <a name="cert"></a>Сертификаты для приложений

При шифровании секретных данных обычно требуется использовать сертификаты. Сертификаты можно устанавливать на узлах. Зашифрованные данные передаются задачам через параметры командной строки или внедряются в один из ресурсов, а установленные сертификаты могут использоваться для их расшифровки. Примером секретных данных может быть ключ для учетной записи хранения.

Чтобы добавить сертификат в учетную запись Пакетной службы, необходимо выполнить операцию добавления сертификата. Затем можно будет связать сертификат с новым или существующим пулом. После того как сертификат будет связан с пулом, пакетная служба установит этот сертификат на каждом узле пула. Пакетная служба устанавливает соответствующие сертификаты при запуске узла до начала выполнения каких-либо задач, включая задачи запуска и задачи диспетчера заданий.

## <a name="scheduling"></a>Планирование приоритетов

При создании рабочего элемента ему можно назначить приоритет. Все задания, которые создаются в рамках рабочего элемента, будут иметь одинаковый приоритет. Пакетная служба использует значения приоритетов задания, чтобы определять порядок выполнения заданий в рамках учетной записи при планировании. Значения приоритетов находятся в диапазоне от -1000 до 1000, при этом значение -1000 является наименьшим приоритетом, а 1000 — наивысшим. Приоритет задания можно обновить с помощью операции обновления задания.

В рамках одной учетной записи задания с высоким приоритетом имеют приоритет при планировании относительно заданий с низким приоритетом. Задания с более высоким приоритетом, относящиеся к одной учетной записи, не имеют приоритета при планировании относительно других заданий с более низким приоритетом, относящихся к другой учетной записи.

Задания из разных пулов планируются независимо. Нет гарантии того, что в разных пулах выполнение задания с более высоким приоритетом будет запланировано в первую очередь, если в связанном с ним пуле недостаточно узлов в состоянии простоя. В одном пуле задания с одинаковым приоритетом имеют одинаковую вероятность добавления в расписание.

## <a name="environment"></a>Параметры среды для задач

Вы можете указать параметры среды, которые будут использоваться в контексте задачи. Параметры среды для задачи запуска и задач, выполняемых в рамках задания, определяются путем добавления раздела XML в текст запроса операций добавления или обновления задачи.

В следующем примере показано, как определяются параметры среды:

Для каждой задачи, запланированной в задании, Пакетная служба определяет набор переменных среды. В следующей таблице перечислены переменные среды, которые устанавливаются Пакетной службой для всех задач.

| Имя переменной среды | Описание |
|------------------------------------|--------------------------------------------------------------------------|
| AZ\_BATCH\_ACCOUNT\_NAME | Имя учетной записи, которой принадлежит задача. |
| AZ\_BATCH\_JOB\_ID | Имя задания, которому принадлежит задача. |
| AZ\_BATCH\_TASK\_ID | Имя текущей задачи. |
| AZ\_BATCH\_POOL\_ID | Имя пула, в котором выполняется задача. |
| AZ\_BATCH\_NODE\_ID | Имя узла, на котором выполняется задача. |
| AZ\_BATCH\_NODE\_ROOT\_DIR | Полный путь к корневому каталогу на узле. |
| AZ\_BATCH\_NODE\_SHARED\_DIR | Полный путь к общему каталогу на узле. |
| AZ\_BATCH\_NODE\_STARTUP\_DIR | Полный путь к каталогу задачи запуска узла пула на узле. |
| AZ\_BATCH\_NODE\_TASK\_DIR | Полный путь к каталогу задачи на узле. |
| AZ\_BATCH\_NODE\_TASK\_WORKING\_DIR | Полный путь к рабочему каталогу задачи на узле. |
| AZ\_BATCH\_NODE\_JOB\_PREP\_DIR | Полный путь к каталогу задачи подготовки задания на узле. |
| AZ\_BATCH\_NODE\_JOB\_PREP\_WORKING\_DIR | Полный путь к рабочему каталогу задачи подготовки задания на узле. |

**Примечание**.

Эти переменные определяются системой и их нельзя переопределить.

Значения параметров среды можно получить с помощью операции получения задачи.

## <a name="errorhandling"></a>Обработка ошибок

###Обработка сбоев задач
Сбои задач делятся на следующие категории:

- Ошибки планирования:
	- Для задачи указаны файлы. При копировании одного или нескольких файлов может произойти сбой. Это может произойти, если файлы были перемещены, учетная запись хранения больше недоступна и т. д.
	- В этом случае для задачи устанавливается "ошибка планирования".
- Ошибки приложений:
	- Процесс задачи, указанный в командной строке, также может завершиться сбоем. Считается, что процесс завершился сбоем, если возвращается ненулевой код выхода.
	- Применительно к ошибкам приложений можно настроить пакетную службу так, чтобы она автоматически повторяла задачу максимальное указанное число раз. 
- Сбой из-за ограничения:
	- Для максимальной длительности выполнения задания или задачи можно указать ограничение. Это можно использовать для завершения задачи, которая зависла.
	- В случае превышения максимального времени выполнения задача отмечается как завершенная, но код выход будет отмечен как `0xC000013A`, а поле schedulingError будет отмечено как `{ category:“ServerError”, code=“TaskEnded”}`.

###Отладка ошибок приложений

Приложение может создавать диагностические данные, которые можно использовать для устранения проблем. Приложения часто записывают информацию в файлы stdout и stderr или выводят данные в пользовательские файлы. В этих случаях файлы можно получить с помощью API, указав задачу или узел.

Также можно войти на узлы пула. API возвращает RDP-файл для узла, который затем можно использовать для входа на узел.

###Обработка сбоев задач и проблем

Задачи могут завершаться сбоем или прерываться по нескольким причинам. Само приложение задачи может завершаться сбоем; узел, на котором выполняется задача, может перезагружаться; узел может быть удален из-за изменения размера пула в соответствии с политикой отмены выделения, которая предусматривает немедленное удаление узла без ожидания нормального выполнения задачи. Во всех случаях пакетная служба может автоматически повторно поставить задачу в очередь, а сама задача будет выполнена на другом узле.

Задача может также зависнуть или выполняться слишком долго из-за кратковременного сбоя. Для задачи можно установить максимальное время выполнения, при превышении которого пакетная служба прервет приложение задачи. В настоящее время для этого случая автоматическая повторная постановка в очередь невозможна, но такой случай может обнаружить клиент, который сможет отправить новую задачу.

###Работа с плохими узлами

Каждому узлу в пуле присваивается уникальное имя, а узел, на котором выполняется задача, включается в метаданные задачи. Некоторые узлы по какой-либо причине могут вызывать сбои задач. Клиент может определить подозрительные узлы, чтобы удалить их из пула. Если на удаленном узле выполнялась задача, она будет автоматически повторно поставлена в очередь и выполнена на другом узле.


<!--Image references-->
[1]: ./media/batch-api-basics/batch-api-basics-01.png

[обзоре пакетной службы Azure]: batch-technical-overview.md

<!---HONumber=Oct15_HO3-->