<properties 
	pageTitle="Основные сведения об API Пакетной службы Azure" 
	description="Основные понятия для ознакомления разработчиков с API Пакетной службы Azure и Пакетной службой" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="03/19/2015" 
	ms.author="yidingz"/>

<!--The next line, with one pound sign at the beginning, is the page title-->
# Основные сведения об API Пакетной службы Azure

Пакетная служба Azure предоставляет платформу планирования заданий для масштабируемых и распределенных вычислений. Пакетная служба обслуживает набор виртуальных машин, расположенных в разных кластерах и центрах обработки данных Microsoft Azure. Пакетная служба выполняет распределенные вычисления путем запуска одной или нескольких программ на указанном наборе виртуальных машин по требованию или запланированных на определенное время. Пакетная служба управляет виртуальными машинами для выполнения вычислительных задач в соответствии с потребностями в ресурсах, спецификациями и указанными ограничениями.

Пакетная служба позволяет избавиться от необходимости писать код для организации очереди, планирования, выделения вычислительных ресурсов и управления ими. Это дает возможность сосредоточиться на конкретном приложении и не беспокоиться о сложности планирования заданий и управления ресурсами базовой платформы. Это также позволяет Пакетной службе оптимизировать расположение заданий и их доступ к данным, которые необходимо обработать.

Ниже приведены некоторые сценарии, которые можно реализовать с помощью Пакетной службы:

- Параллельная обработка больших объемов вычислений.

- Ежедневная очистка файлов.

- Пакетная обработка.

## <a name="resource"></a> Ресурсы пакетной службы

При использовании Пакетной службы можно воспользоваться следующими ресурсами:

- [Учетная запись](#account).

- [Виртуальная машина задач](#taskvm).

- [Пул](#pool).

- [Рабочий элемент](#workitem).

- [Задание](#job).

- [Задача](#task).

	- [Задача запуска](#starttask).
	
	- [Задание ManagerTask](#jobmanagertask).

### <a name="account"></a>Учетная запись

Учетная запись Пакетной службы — это уникально идентифицируемая сущность в Пакетной службе. Вся обработка данных осуществляется через учетную запись Пакетной службы. Для выполнения операций с помощью Пакетной службы нужно знать имя учетной записи и ее ключ. Процедуру создания учетной записи пакетной службы см. в разделе "Учетная запись пакетной службы" в [обзоре пакетной службы Azure][].


### <a name="taskvm"></a>Виртуальная машина задач

Виртуальная машина задач (ВМЗ) — это виртуальная машина Microsoft Azure, выделенная вашему приложению для определенной рабочей нагрузки. Размер ВМЗ определяет количество ядер ЦП, объем памяти и размер локальной файловой системы, которые выделяются для ВМЗ. Значение размера ВМЗ может быть Small (маленькая), Large (большая) и ExtraLarge (очень большая). Дополнительную информацию см. в разделе [Размеры виртуальных машин и облачных служб Microsoft Azure](http://msdn.microsoft.com/library/dn197896.aspx).

Типы программ, которые могут выполняться на ВМЗ, включают в себя исполняемые файлы (EXE-файлы), командные файлы (CMD-файлы), пакетные файлы (BAT-файлы) и файлы сценариев. ВМЗ также имеет следующие атрибуты:

- Связанные с задачами папки файловой системы, которые являются общими. На каждый виртуальной машине в пуле создаются структура папок и переменные среды. Создается следующая структура папок с "общей" папкой для приложений и данных, общих для задач, а также папка для каждой задачи.

![][1]

- Файлы stdout.txt и stderr.txt, которые записываются в папку задачи.

- Переменные среды для обработки.

- Параметры брандмауэра, настроенные для управления доступом.

>Доступ к ВМ
>
>Если к виртуальной машине требуется доступ, например, для отладки, можно получить RDP-файл, который затем может использоваться для доступа к виртуальной машине через удаленный рабочий стол.


### <a name="pool"></a>Пул

Пул — это коллекция ВМЗ, на которых выполняется приложение. Пул может быть создан как вами, так и автоматически Пакетной службой при указании выполняемых работ. Вы можете создать и настроить пул таким образом, чтобы он удовлетворял требованиям вашего приложения. Пул может использоваться только той учетной записью Пакетной службы, с помощью которой он был создан. Учетная запись Пакетной службы может содержать более одного пула.

Пулы пакетной службы Azure базируются на основной вычислительной платформе Azure; пулы пакетной службы выполняют операции крупномасштабного выделения, установки приложений и данных, перемещения данных, наблюдения за работоспособностью и предоставляют гибкое масштабирование для виртуальных машин.

Каждой добавляемой к пулу ВМЗ присваивается уникальное имя и IP-адрес. При удалении ВМЗ из пула она теряет все изменения, внесенные в операционную систему, все локальных файлы, свое имя и IP-адрес. Когда ВМЗ покидает пул, она перестает существовать.

Пул можно настроить, чтобы обеспечивать обмен данными между ВМЗ внутри него. Если для пула был затребован внутренний обмен данными, Пакетная служба для всех ВМЗ пула сделает доступными порты с номерами больше 1100. Каждая ВМЗ пула настраивается таким образом, чтобы ограничить входящие подключения только данным диапазоном портов и принимать подключения только от других ВМЗ пула. Если приложению не требуется обмен данными с другими ВМЗ, Пакетная служба потенциально может выделить для пула большое количество ВМЗ из различных кластеров и центров обработки данных, чтобы еще больше распараллелить обработку.

При создании пула можно указать следующие атрибуты:

- **Размер виртуальных машин** в пуле.
	- Необходимо выбрать соответствующий размер виртуальной машины, в зависимости от характеристик и требований приложения или приложений, которые будут использоваться на данной виртуальной машине. Обычно размер виртуальной машины будет выбираться исходя из предположения, что на виртуальной машине в конкретный момент времени будет выполняться одна задача. Для определения наиболее подходящего и экономичного размера виртуальной машины также, например, учитываются такие факторы как является ли приложение многопоточным или нет, а также требуемый объем памяти. Можно ориентироваться на режим параллельного выполнения нескольких назначенных задач и нескольких экземпляров приложения. В этом случае обычно выбирается более крупная виртуальная машина — см. ниже в разделе, где обсуждается максимальное число задач для каждой виртуальной машины. 
	- Все ВМ в пуле должны иметь одинаковый размер. Если должны выполняться различные приложения с разными требованиями к системе и (или) с разной нагрузкой, то необходимо создать отдельные пулы.
	- Для пула, за исключением A0, можно настраивать виртуальные машины облачной службы любого размера.

- Семейство и версии операционных систем, которые выполняются на виртуальных машинах.
	- Так же как и с рабочими ролями, семейство и версии ОС можно настраивать.
	- Семейство ОС также определяет, какие версии .NET устанавливаются вместе с операционной системой.
	- Так же как и с рабочими ролями, для версии операционной системы рекомендуется использовать "*", чтобы виртуальные машины обновлялись автоматически, и не было бы нужно что-либо делать для адаптации под новые версии. При выборе версии ОС необходимо, в первую очередь, убедиться, что обеспечивается совместимость приложений. Для этого перед обновлением версии следует протестировать обратную совместимость. После выполнения проверки версию ОС для пула можно обновить и установить новый образ ОС — любая выполняемая задача будет прервана и повторно поставлена в очередь.

- Целевое число виртуальных машин, которые должны быть доступны для пула.

- Политика масштабирования для пула. Кроме числа виртуальных машин, также можно указать формулу автоматического масштабирования для каждого пула. Пакетная служба будет выполнять формулу, чтобы выбирать число виртуальных машин на основе статистики о пуле и рабочих элементах.

- Планирование конфигурации
	- Конфигурация по умолчанию предусматривает выполнение одной задачи в любое время в пуле виртуальных машин. Но существуют сценарии, когда полезно иметь возможность одновременного выполнения нескольких задач на одной виртуальной машине. Примером может служить повышение уровня нагрузки на виртуальную машину, если приложение должно ожидать операций ввода-вывода; наличие нескольких работающих приложений приведет к увеличению нагрузки на ЦП. Другой пример — уменьшение числа виртуальных машин в пуле. Это может привести к уменьшению количества копий данных, необходимых для крупных наборов эталонных данных. Если A1 будет правильным размером для приложения, то можно выбрать A4. Тогда конфигурация сможет выполнять одновременно до 8 задач, каждая из которых будет использовать одно ядро.
	- Конфигурация "максимальное число задач для каждой виртуальной машины" определяет максимальное число задач, которые могут выполняться параллельно.
	- Также можно выбрать "политику заполнения", которая определяет, заполняет ли пакетная служба виртуальные машины в первую очередь, или же задачи распределяются по всем ВМ.
 
- Состояние связи виртуальных машин в пуле.
 	- В большинстве сценариев задачи выполняются независимо друг от друга и не должны взаимодействовать с другими задачами. Но существуют некоторые приложения, где задачи будут взаимодействовать между собой (например, приложения, которые применяют MPI).
	- Существует конфигурация, контролирующая возможность виртуальных машин взаимодействовать друг с другом, которая используется для настройки базовой сетевой инфраструктуры и влияет на размещение виртуальных машин.

- Задача запуска для ВМЗ в пуле.

При создании пула можно указать учетную запись хранения, с которой необходимо связать пул. Пакетная служба выделяет ВМЗ в центрах обработки данных с наилучшим сетевым соединением и пропускной способностью сети для указанной учетной записи хранения. Это обеспечивает рабочим нагрузкам более эффективный доступ к данным.

### <a name="workitem"></a>Рабочий элемент

Рабочий элемент указывает, как следует выполнять вычисления на ВМЗ в пуле.

- С рабочим элементом может быть связано одно или несколько заданий. Для рабочего элемента можно указать необязательное расписание. В этом случае для каждого экземпляра расписания создается одно задание. Если для работы по запросу расписание не указано, задание создается немедленно.
- Рабочий элемент указывает пул, в котором будет выполняться работа. Пул может быть уже создан и использоваться различными рабочими элементами. Но пул также может быть создан для каждого задания, связанного с рабочим элементом, или для всех заданий, связанных с рабочим элементом.
- Можно указать необязательный приоритет. При отправке рабочего элемента с приоритетом, превышающим приоритет других текущих рабочих элементов, такой высокоприоритетный элемент вставляется в очередь перед низкоприоритетными задачами. Задачи с более низким приоритетом, которые уже выполняются, прерываться не будут.
- Можно указать ограничения, которые будут применяться к связанному заданию или заданиям.
	- Для заданий можно указывать максимальное время выполнения. Если задания выполняется дольше, чем указанное максимальное время выполнения, то такое задание и все связанные с ним задачи будут завершены.
	- Пакетная служба Azure может обнаруживать задачи, которые завершаются с ошибкой и повторно запускать задачи. В качестве ограничения можно указать максимальное число повторов задачи по умолчанию. Также можно указать, будет ли задача повторяться всегда или никогда. Повторное выполнение задачи означает, что данная задача повторно помещается в очередь и будет снова запущена.
- Задачи, которые должны выполняться для задания рабочего элемента, могут быть указаны клиентом таким же образом, как был создан рабочий элемент, но, с другой стороны, можно указать задачу диспетчера заданий. Задача диспетчера заданий использует API пакетной службы и содержит код для создания необходимых задач для задания; при этом задачи выполняются на одной из виртуальных машин пула. Задача диспетчера заданий обрабатывается особым образом пакетной службой — она помещается в очередь сразу при создании задания и перезапускается по любой причине, если происходит сбой. Диспетчер заданий требуется для рабочих элементов со связанным расписанием, так как это единственный способ определения задач перед созданием экземпляра задания.

### <a name="job"></a>Задание

Задание является запущенным экземпляром рабочего элемента и представляет собой набор задач. Пакетная служба создает экземпляр задания на основе конфигурации рабочего элемента. Задание использует ВМЗ из пула, который связан с рабочим элементом.

### <a name="task"></a>Задача

Задача — это единица вычисления, которая связана с заданием и выполняется на ВМЗ. Задачи назначаются виртуальной машине для выполнения или помещаются в очередь, пока виртуальная машина не освободится. Задача использует следующие ресурсы:

- Программа, указанная в рабочем элементе.

- Файлы ресурсов, которые содержат данные для обработки. Эти файлы автоматически копируются на ВМЗ из хранилища больших двоичных объектов. Дополнительную информацию см. в разделе «Файлы и каталоги».

- Необходимые программе параметры среды. Дополнительную информацию см. в разделе «Параметры среды для задач».

- Ограничения, в рамках которых должны выполняться вычисления. Например — максимальное время, в рамках которого задаче разрешено выполняться; максимальное количество попыток выполнить задачу в случае сбоя; максимальное время хранения файлов в рабочем каталоге.

В дополнение к задачам, которые выполняют вычисления на ВМЗ, можно использовать следующие специальные задачи, предоставляемые Пакетной службой:

- [Задача запуска](#starttask)

- [Задача диспетчера заданий](#jobmanagertask)

#### <a name="starttask"></a>Задача запуска

Операционную систему виртуальных машин в пуле можно настроить путем связывания задачи запуска с пулом. Задача запуска может выполнять такие действия, как установка программного обеспечения или запуск фоновых процессов. Задача запуска выполняется каждый раз при запуске ВМ при условии, что эта ВМ остается в пуле.

Как и с любой задачей пакетной службы, в службе хранилища Azure можно указать список файлов в дополнение к командной строке, которая выполняется пакетной службой. Пакетная служба Azure сначала будет копировать файлы из службы хранилища Azure, а затем запускать командную строку. Для задачи запуска пула список файлов обычно содержит файлы приложения или пакет, но также может включать эталонные данные, которые будут использоваться всеми задачами, выполняемыми на виртуальных машинах пула. Командная строка может выполнять любой скрипт PowerShell или команду robocopy, например, чтобы скопировать файлы приложения в "общую" папку. Она также может запускать MSI-файл.

Обычно желательно, чтобы пакетная служба ждала завершения задачи запуска, а затем воспринимала ВМ готовой к назначению задач, но такое поведение можно изменять.

Если задача запуска завершается сбоем для виртуальной машины в пуле, состояние данной ВМ обновляется и отражает сбой, и назначение задач данной виртуальной машине будет невозможно. Задача запуска может завершиться с ошибкой, если имеется проблема при копировании файлов, указанных для задачи запуска, или процесс задачи запуска возвращает ненулевое значение.

Тот факт, что все данные, необходимые для настройки виртуальных машин и установки приложений, объявляются, означает, что увеличение числа виртуальных машин в пуле является очень простой процедурой, нужно просто указать требуемое число. Пакетная служба содержит все данные, необходимые для настройки виртуальных машин и их подготовки к приемке задач.

Задача запуска определяется путем добавления раздела JSON в текст запроса для операции добавления пула (Add Pool). В следующем примере показано базовое определение задачи запуска:

	{
		“commandLine”:”mypoolsetup.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”mypoolsetup.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“maxTaskRetryCount”:0
	}

Интерфейс C# выглядит следующим образом:

	ICloudPool pool = pm.CreatePool(poolName, targetDedicated: 3, vmSize: "small", osFamily: "3");
	pool.StartTask = new StartTask();
	pool.StartTask.CommandLine = "mypoolsetup.exe";
	pool.StartTask.ResourceFiles = new List<IResourceFile>();
	pool.StartTask.ResourceFiles.Add(new ResourceFile("http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d", "mypoolsetup.exe"));
	pool.Commit();


#### <a name="jobmanagertask"></a>Задача диспетчера заданий

Задача диспетчера заданий запускается перед выполнением всех других задач. Задача диспетчера заданий предоставляет следующие преимущества:

- Автоматически создается Пакетной службой при создании задания.

- Запускается перед выполнением других задач в задании.

- Связанная с ней ВМЗ будет удалена из пула в последнюю очередь при уменьшении размера пула.

- При перезапуске данной задаче присваивается наивысший приоритет. Если неактивная ВМЗ недоступна, Пакетная служба может завершить одну из задач, которые выполняются в пуле, чтобы освободить ресурсы для запуска задачи диспетчера заданий.

- Такое завершение задачи может привести к завершению всех задач данного задания.

Задача диспетчера заданий в задании не имеет приоритета над задачами других заданий. Приоритеты применяются только на уровне заданий. Задача диспетчера заданий определяется путем добавления раздела XML в текст запроса для операции добавления рабочего элемента. В следующем примере показано базовое определение задачи диспетчера заданий:

	{
		“name”:”jmTask”,
		“commandLine”:”myapp1.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp1.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“taskConstraints”:
		{
			“maxWallClockTime”:”PT1H”,
			“maxTaskRetryCount”:0,
			“retentionTime”:”PT1H”
		},
		“killJobOnCompletion”:true,
		“runElevated”:false,
		“runExclusive”:true
	}




## <a name="workflow"></a>Рабочий процесс пакетной службы

Чтобы воспользоваться Пакетной службой и ее ресурсами для планирования вычислений, необходимо иметь учетную запись Пакетной службы. При создании сценария распределенных вычислений с помощью Пакетной службы используется следующий базовый рабочий процесс:

1. Передайте файлы, которые вы хотите использовать в сценарии распределенных вычислений, в учетную запись хранения Azure. Чтобы Пакетная служба имела к ним доступ, они должны находиться в учетной записи хранения. Пакетная служба передаст их в ВМЗ при выполнении задачи.

2. Передайте зависимые двоичные файлы в учетную запись хранения. Двоичные файлы включают в себя программу, которая выполняется задачей, и зависимые сборки. Эти файлы также должны быть доступны из службы хранения и загружены в ВМЗ.

3. Создайте пул ВМЗ. При создании пула можно указать размер виртуальной машины задач. Когда задача запускается, ей назначается ВМЗ из этого пула.

4. Создайте рабочий элемент. Задание создается автоматически при создании рабочего элемента. Рабочий элемент позволяет управлять заданием, которое содержит задачи.

5. Добавьте задачи в рабочий элемент. Каждая задача использует переданную вами программу для обработки информации из переданного вами файла.

6. Отслеживайте выходные данные.

## <a name="files"></a>Файлы и каталоги

У каждой задачи есть рабочий каталог, в котором она может создавать дополнительные файлы и каталоги для хранения программы, выполняемой задачей, обрабатываемых задачей данных, а также выходных данных. Эти каталоги и файлы будут доступными для использования другим задачам во время выполнения задания. Все задачи, файлы и каталоги в ВМЗ принадлежат одной учетной записи.

Пакетная служба предоставляет часть файловой системы ВМЗ в качестве корневого каталога. Корневой каталог ВМЗ доступен для задачи через переменную среды WATASK_TVM_ROOT_DIR. Дополнительную информацию об использовании переменных среды см. в разделе «Параметры среды для задач».

Корневой каталог содержит следующие подкаталоги:

- **Tasks** — в этом расположении хранятся все файлы выполняемых на ВМЗ задач. Для каждой задачи пакетная служба создает рабочий каталог, который умеет уникальный путь вида "%WATASK_TVM_ROOT_DIR%/tasks/workitemName/jobName/taskName/". Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Время существования каталога определяется указанным для задачи ограничением RetentionTime.

- **Shared** — это общий каталог для всех задач учетной записи. На ВМЗ этот каталог имеет путь вида "%WATASK_TVM_ROOT_DIR%/shared". Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в данном каталоге.

- **Start** — это расположение используется задачей запуска в качестве рабочего каталога. В этом каталоге также хранятся все файлы, скачанные Пакетной службой для выполнения задачи запуска. На ВМЗ каталог запуска расположен по пути вида "%WATASK_TVM_ROOT_DIR%/start". Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Также данный каталог может использоваться задачами запуска для настройки операционной системы.

При удалении ВМЗ из пула также удаляются все хранимые на ней файлы.

## <a name="lifetime"></a>Время существования пула и виртуальной машины

Одно из основных решений при проектировании — когда создаются пулы, и как долго будут доступны виртуальные машины.

С одной стороны, пул может создаваться для каждого задания, когда задание отправляется, а виртуальная машина удаляется по окончании выполнения задач. Это обеспечит максимальную степень использования, так как виртуальные машины выделяются только при крайней необходимости и завершают работу, как только они становятся свободны. Это означает, что задание должно ожидать выделения виртуальной машины, хотя важно отметить, что задачи будут планироваться для виртуальных машин, как только они окажутся по отдельности доступны и выделены, а задача запуска будет завершена. То есть пакетная служба НЕ будет ждать, пока все виртуальные машины в пуле окажутся доступны, так как это ухудшит коэффициент использования.

Если приоритетным является немедленный запуск заданий, то пул должен быть создан, а виртуальные машины стать доступны до отправки задания. Задачи могут запускаться немедленно, но в зависимости от нагрузки, виртуальные машины могут оставаться свободными и ожидать поступления задач задания.

Одним из общих сценариев для ситуации, когда существует переменный объем текущей нагрузки, заключается в наличии пула, в который отправляются несколько заданий, с последующим увеличением или уменьшением числа виртуальных машин, в зависимости от нагрузки. Это можно сделать по факту или заранее, если нагрузку можно прогнозировать.

## <a name="scaling"></a>Масштабирование приложений

Приложение может легко автоматически масштабироваться, подстраиваясь под потребности в вычислениях. Вы можете динамически настраивать количество ВМЗ в пуле в соответствии с текущей рабочей нагрузкой и статистикой использования ресурсов. Также вы можете оптимизировать общую стоимость выполнения приложения, настроив для него автоматическое масштабирование. Параметры масштабирования можно указать при создании пула, при этом конфигурацию можно будет обновить в любое время.

Для уменьшения числа виртуальных машин можно предусмотреть задачи, выполняемые на виртуальных машинах. Указывается политика отмены выделения, которая определяет, будут ли немедленно останавливаться выполняемые задачи для удаления виртуальной машины, или задачи смогут завершаться до удаления ВМ. Если для целевого числа виртуальных машин установить нулевое значение в конце задания, но разрешить выполняемым задачам нормально завершаться, будет обеспечена максимальная эффективность использования.

Автоматическое масштабирование приложения указывается с помощью набора формул масштабирования. C помощью формул определяется количество ВМЗ в пуле для следующего интервала масштабирования. Например, вам нужно запланировать для пула большое количество задач. Вы можете назначить для пула формулу масштабирования, которая будет определять размер пула на основе текущего числа ожидающих задач и скорости их выполнения. Пакетная служба периодически вычисляет формулу и изменяет размер пула в зависимости от рабочей нагрузки.

Формула может основываться на следующих метриках:

- **Метрики времени** — основываются на статистических данных, которые собираются каждые 5 минут за указанное число часов.

- **Метрики ресурсов** — основываются на загрузке ЦП, уровне использования пропускной способности, использования памяти и числе ВМЗ.

- **Метрики задач** — основываются на состоянии задач (активные, ожидающие и завершенные).

Дополнительную информацию об автоматическом масштабировании приложения см. в разделе «Настройка автоматического масштабирования виртуальных машин задач».

>Удаление виртуальных машин
>
>На практике это требуется не очень часто. Но существует возможность указать отдельные виртуальные машины для их удаления из пула. Например, если имеется виртуальная машина, которая, предположительно, является не очень надежной, то ее можно удалить.

## <a name="cert"></a>Сертификаты для приложений

При шифровании секретных данных обычно требуется использовать сертификаты. Сертификаты могут быть установлены на ВМЗ. Зашифрованные данные передаются задачам через параметры командной строки или внедряются в один из ресурсов, а установленные сертификаты могут использоваться для их расшифровки. Примером секретных данных может быть ключ для учетной записи хранения.

Чтобы добавить сертификат в учетную запись Пакетной службы, необходимо выполнить операцию добавления сертификата. Затем можно будет связать сертификат с новым или существующим пулом. После того, как сертификат будет связан с пулом, Пакетная служба установит сертификат на каждую ВМЗ в пуле. Пакетная служба установит соответствующие сертификаты при запуске ВМЗ до начала выполнения каких-либо задач, включая задачи запуска и задачи диспетчера заданий.

## <a name="scheduling"></a>Планирование приоритетов

При создании рабочего элемента ему можно назначить приоритет. Все задания, которые создаются в рамках рабочего элемента, будут иметь одинаковый приоритет. Пакетная служба использует значения приоритетов задания, чтобы определять порядок выполнения заданий в рамках учетной записи при планировании. Значения приоритетов находятся в диапазоне от -1000 до 1000, при этом значение -1000 является наименьшим приоритетом, а 1000 — наивысшим. Приоритет задания можно обновить с помощью операции обновления задания.

В рамках одной учетной записи задания с высоким приоритетом имеют приоритет при планировании относительно заданий с низким приоритетом. Задания с более высоким приоритетом, относящиеся к одной учетной записи, не имеют приоритета при планировании относительно других заданий с более низким приоритетом, относящихся к другой учетной записи.

Задания из разных пулов планируются независимо. В разных пулах не гарантируется, что задание с более высоким приоритетом будет запланировано в первую очередь, если связанный с ним пул не имеет достаточно неактивных ВМЗ. В одном пуле задания с одинаковым приоритетом имеют одинаковую вероятность добавления в расписание.

## <a name="environment"></a>Параметры среды для задач

Вы можете указать параметры среды, которые будут использоваться в контексте задачи. Параметры среды для задачи запуска и задач, выполняемых в рамках задания, определяются путем добавления раздела XML в текст запроса операций добавления или обновления задачи.

В следующем примере показано, как определяются параметры среды:

Для каждой задачи, запланированной в задании, Пакетная служба определяет набор переменных среды. В следующей таблице перечислены переменные среды, которые устанавливаются Пакетной службой для всех задач.

<table>
  <tr>
   <th>Имя переменной среды
   </th>
   <th>
   Описание
   </th>
  </tr>
 <tr>
  <td>
  WATASK_ ACCOUNT_NAME
  </td>
  <td>
  Имя учетной записи, которой принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_WORKITEM_NAME
  </td>
  <td >Имя рабочего элемента, которому принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_JOB_NAME
  </td>
  <td >Имя задания, которому принадлежит задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TASK_NAME
  </td>
  <td >Имя текущей задачи.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_POOL_NAME
  </td>
  <td >Имя пула, в котором выполняется задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_NAME
  </td>
  <td >Имя ВМЗ, на которой выполняется задача.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_ROOT_DIR
  </td>
  <td >Полный путь к корневому каталогу на ВМЗ.
  </td>
 </tr>
 <tr>
  <td>
  WATASK_PORTRANGE_LOW WATASK_PORTRANGE_HIGH
</td>
<td>
  Диапазон портов (включая граничные порты), которые задача может использовать для обмена данными внутри пула (если обмен данными внутри пула включен).
</td>
</table>

**Примечание**

Эти переменные определяются системой и их нельзя переопределить.

Значения параметров среды можно получить с помощью операции получения задачи.

## <a name="errorhandling"></a>Обработка ошибок

###Обработка сбоев задач
Сбои задач делятся на следующие категории:

- Ошибки планирования:
	- Для задачи указаны файлы. При копировании одного или нескольких файлов может произойти сбой. Это может произойти, если файлы были перемещены, учетная запись хранения больше недоступна и т. д.
	- В этом случае для задачи устанавливается "ошибка планирования".
- Ошибки приложений:
	- Процесс задачи, указанный в командной строке, также может завершиться сбоем. Считается, что процесс завершился сбоем, если возвращается ненулевой код выхода.
	- Применительно к ошибкам приложений можно настроить пакетную службу так, чтобы она автоматически повторяла задачу максимальное указанное число раз. 
- Сбой из-за ограничения:
	- Для максимальной длительности выполнения задания или задачи можно указать ограничение. Это можно использовать для завершения задачи, которая зависла.
	- В случае превышения максимального времени выполнения задача отмечается как завершенная, но код выход будет отмечен как `0xC000013A`, а поле schedulingError будет отмечено как `{ category:“ServerError”, code=“TaskEnded”}`.

###Отладка ошибок приложений

Приложение может создавать диагностические данные, которые можно использовать для устранения проблем. Приложения часто записывают информацию в файлы stdout и stderr или выводят данные в пользовательские файлы. В таких случаях эти файлы можно получить с помощью интерфейса API путем указания задачи или виртуальной машины.

Также можно войти на виртуальные машины пула. Интерфейс API возвращает RDP-файл для виртуальной машины, который затем можно использовать для входа на ВМ.

###Обработка сбоев задач и проблем

Задачи могут завершаться сбоем или прерываться по нескольким причинам. Само приложение задачи может завершаться сбоем, на виртуальной машине, на которой выполняется задача, может выполняться перезагрузка или виртуальная машина может быть удалена из-за изменения размера пула с помощью политики отмены выделения, которая предусматривает немедленное удаление виртуальной машины без ожидания завершения выполнения задачи. Во всех случаях задача может быть автоматически повторно поставлена в очередь пакетной службой и выполнена на другой виртуальной машине.

Задача может также зависнуть или выполняться слишком долго из-за кратковременного сбоя. Для задачи можно установить максимальное время выполнения, при превышении которого пакетная служба прервет приложение задачи. В настоящее время для этого случая автоматическая повторная постановка в очередь невозможна, но такой случай может обнаружить клиент, который сможет отправить новую задачу.

###Обработка "плохих" виртуальных машин

Каждой виртуальной машине в пуле присваивается уникальное имя, а ВМ, на которой выполняется задача, включается в метаданные задачи. В случае, когда имеется виртуальная машина, которая по некоторым причинам вызывает сбой задач, такую ВМ сможет обнаружить клиент, после чего удалить предположительно неисправную машину из пула. Если задача выполнялась на виртуальной машине, которая была удалена, она будет автоматически повторно поставлена в очередь и выполнена на другой виртуальной машине.


<!--Image references-->
[1]: ./media/batch-api-basics/batch-api-basics-01.png

[обзоре пакетной службы Azure]: batch-technical-overview.md

<!---HONumber=62-->