<properties
	pageTitle="Обзор функций пакетной службы Azure | Microsoft Azure"
	description="Ознакомьтесь с функциями пакетной службы и ее API-интерфейсов с точки зрения разработки."
	services="batch"
	documentationCenter=".net"
	authors="yidingzhou"
	manager="timlt"
	editor=""/>

<tags
	ms.service="batch"
	ms.devlang="multiple"
	ms.topic="get-started-article"
	ms.tgt_pltfrm="na"
	ms.workload="big-compute"
	ms.date="02/25/2016"
	ms.author="yidingz;marsma"/>

# Обзор функций пакетной службы Azure

Эта статья содержит обзорную информацию о базовых возможностях API пакетной службы Azure. Многие из сущностей и компонентов, описанных ниже, используются при разработке распределенных вычислительных решений с использованием интерфейсов [REST API][batch_rest_api] или [.NET API][batch_net_api] пакетной службы.

> [AZURE.TIP] Подробную техническую информацию о пакетной службе см. в статье [Основные сведения о пакетной службе Azure](batch-technical-overview.md).

## <a name="workflow"></a>Рабочий процесс пакетной службы

Далее приводится обобщенная схема рабочего процесса, типичного для большинства сценариев распределенных вычислений в рамках пакетной службы.

1. Передайте *файлы данных*, которые вы хотите использовать в сценарии распределенных вычислений, в [учетную запись службы хранилища Azure][azure_storage]. Чтобы пакетная служба имела доступ к этим файлам, они должны находиться в учетной записи хранения. Запускаемые задачи будут загружать эти файлы в [вычислительные узлы](#computenode).

2. Передайте зависимые *двоичные файлы* в учетную запись хранения. Двоичные файлы содержат программу, которую запускают задачи, и все зависимые сборки. Эти файлы также должны быть доступны из вашей учетной записи хранения, чтобы задачи могли загружать их в вычислительные узлы.

3. Создайте [пул](#pool) вычислительных узлов. При создании пула следует указать [размер вычислительных узлов][cloud_service_sizes]. Каждой запускаемой задаче будет присвоен узел из этого пула.

4. Создайте [задание](#job). Задание позволяет управлять задачами коллекции.

5. Добавьте [задачи](#task) в задание. Каждая задача использует переданную вами программу для обработки информации из файлов данных, переданных в учетную запись хранения.

6. Отследите выполнение задания и получите результаты.

> [AZURE.NOTE] Для использования пакетной службы вам потребуется [учетная запись пакетной службы](batch-account-create-portal.md). Также почти любое решение предполагает наличие учетной записи [службы хранилища Azure][azure_storage] для хранения и извлечения файлов.

В следующих разделах вы узнаете о каждом из ресурсов, перечисленных выше в схеме рабочего процесса, а также о многих других возможностях пакетной службы, которые вы сможете использовать в сценариях распределенных вычислений.

## <a name="resource"></a> Ресурсы пакетной службы

В процессе использования пакетной службы Azure вы будете использовать следующие ресурсы.

- [Учетная запись.](#account)
- [Вычислительный узел.](#computenode)
- [Пул.](#pool)
- [Задание.](#job)
- [Задача.](#task)
	- [Задача запуска.](#starttask)
	- [Задание ManagerTask.](#jobmanagertask)
	- [Задачи подготовки и завершения заданий.](#jobpreprelease)
	- [Задачи с несколькими экземплярами](#multiinstance)
- [JobSchedule](#jobschedule)

### <a name="account"></a>Учетная запись

Учетная запись Пакетной службы — это уникально идентифицируемая сущность в Пакетной службе. Вся обработка данных привязана к учетной записи пакетной службы. Для выполнения операций пакетной службы нужно имя и ключ учетной записи. Чтобы создать учетную запись пакетной службы, см. статью [Создание учетной записи пакетной службы на портале Azure и управление ею](batch-account-create-portal.md).

### <a name="computenode"></a>Вычислительный узел

Вычислительный узел — это виртуальная машина Azure, которой назначена определенная рабочая нагрузка вашего приложения. Размер узла определяет количество ядер ЦП, объем памяти и размер локальной файловой системы, которые выделяются узлу. Можно использовать любые [размеры узлов облачной службы][cloud_service_sizes], кроме A0.

На узлах могут выполняться различные файлы и сценарии, в том числе исполняемые файлы (EXE), файлы команд (CMD), пакетные файлы (BAT) и сценарии PowerShell. Кроме того, узел имеет следующие атрибуты.

- На каждом вычислительном узле создается стандартная **структура папок** и соответствующие **переменные среды** с описанием путей к папкам. Дополнительную информацию см. в разделе [Файлы и каталоги](#files) ниже.
- **Переменные среды**, на которые могут ссылаться задачи.
- Параметры **брандмауэра**, настроенные для управления доступом.
- Если требуется **удаленный доступ** к вычислительному узлу (например, для его отладки), вы можете получить RDP-файл и использовать его для доступа к узлу через *удаленный рабочий стол*.

### <a name="pool"></a>Пул

Пул — это коллекция узлов, на которых выполняется приложение. Пул может быть создан как вами (вручную), так и пакетной службой (автоматически) при указании выполняемых работ. Вы можете создавать и изменять пулы в соответствии с потребностями своего приложения. Пул может использоваться только той учетной записью пакетной службы, в которой он был создан. Учетная запись Пакетной службы может содержать более одного пула.

Пулы пакетной службы Azure основаны на базовой вычислительной платформе Azure. Они удобны для крупномасштабных операций выделения ресурсов, установки приложений, распространения данных и мониторинга работоспособности. Также пулы обеспечивают масштабирование, то есть гибкое изменение количества вычислительных узлов в пуле.

Каждому узлу, который добавляется в пул, присваивается уникальное имя и IP-адрес. При удалении узла из пула будут потеряны любые изменения, внесенные в операционную систему или файлы. Имя и IP-адрес удаленного узла освобождаются для использования в других целях. Когда узел покидает пул, он перестает существовать.

Вы можете разрешить обмен данными между узлами, входящими в один пул. Если для пула был запрошен внутренний обмен данными, пакетная служба сделает доступными порты с номерами больше 1100 на всех узлах пула. Каждый узел пула настраивается таким образом, чтобы входящие подключения принимались только на порты в этом диапазоне и только с других узлов того же пула. Если приложению не требуется обмен данными между узлами, пакетная служба может выделить для пула большое количество узлов из разных кластеров и центров обработки данных. Это позволяет увеличить производительность параллельной обработки.

При создании пула можно указать следующие атрибуты:

- **Размер узлов** в пуле.
	- Следует тщательно выбирать правильный размер узлов с учетом характеристик и требований приложений, которые будут выполняться на узлах пула. Обычно при выборе размера узла предполагается, что единовременно на узле будет выполняться одна задача. Также для выбора правильного размера узла и снижения затрат следует учитывать такие аспекты, как многопоточность приложений и требуемый объем памяти. Вы можете разрешить параллельное назначение нескольких задач и выполнение нескольких экземпляров приложения на одном узле. В таком случае следует выбрать более крупный размер узлов. Подробнее этот вопрос описан ниже в разделе «Политика планирования задач».
	- Все узлы в пуле должны быть одинакового размера. Если вы планируете выполнять различные приложения с разными требованиями к системе и (или) с разной нагрузкой, вам следует создать отдельные пулы.
	- Для пула можно использовать любые [размеры узлов облачной службы][cloud_service_sizes], кроме A0.

- **Семейство** и **версия операционной системы**, запускаемой на узлах.
	- Вы можете выбрать для узлов *семейство ОС* и *версию ОС* так же, как и для рабочих ролей в облачных службах (информация о рабочих ролях представлена в разделе [Информация об облачных службах][about_cloud_services] статьи *Варианты размещения вычислительных сред, предоставляемые Azure*).
	- Семейство ОС также определяет, какие версии .NET устанавливаются вместе с операционной системой.
	- Как и для рабочих ролей, мы рекомендуем указывать значение `*` в качестве версии ОС. Тогда узлы будут обновляться автоматически, и вам не нужно будет выполнять дополнительные действия при выходе новых версий. Выбор конкретной версии ОС обычно нужен только для гарантии совместимости приложений. Это позволит протестировать обратную совместимость перед установкой обновлений. После успешной проверки вам нужно будет обновить версию ОС для пула и установить новый образ ОС. Все выполняемые задачи будут при этом прерваны и повторно поставлены в очередь.

- **Целевое количество узлов**, которые должны быть доступны для пула.

- **Политика масштабирования** для пула.
	- Кроме количества узлов, для пула можно задать [формулу автоматического масштабирования](batch-automatic-scaling.md). По этой формуле пакетная служба будет вычислять и изменять количество узлов в пуле в зависимости от выбранных вами параметров пула, заданий и задач.

- Политика **планирования задач**.
	- Параметр конфигурации [Максимальное число заданий на узел](batch-parallel-node-tasks.md) определяет максимальное число задач, которые могут параллельно выполняться на каждом узле пула.
	- По умолчанию устанавливается выполнение только одной задачи на узле пула в любое время. Но в некоторых ситуациях выполнение нескольких задач на одном узле будет более правильным выбором. Например, так вы можете более эффективно использовать узлы, если приложение часто ожидает операции ввода-вывода. Одновременное выполнение нескольких приложений повышает загрузку ЦП. Другой пример — уменьшение количества узлов в пуле. Таким образом вы сможете уменьшить объем передачи данных между узлами при использовании больших наборов ссылочных данных. Если для вашего приложения достаточно узла размера A1, вы можете выбрать размер узла A4 и разрешить параллельное выполнение 8 задач на каждом узле, то есть по одной задаче на каждом ядре.
	- Также вы можете выбрать тип распределения. Пакетная служба может равномерно распределять задачи между всеми узлами или назначать каждому узлу максимально возможное число задач, прежде чем переходить к загрузке следующего узла пула.

- **Статус взаимодействия** между узлами в пуле.
	- В пуле можно разрешить обмен информацией между узлами. Этот параметр определяет, какая базовая инфраструктура сети будет использоваться. Также он влияет на расположение узлов в кластерах.
	- В большинстве случаев задачи работают независимо друг от друга и взаимодействие между ними не требуется. Но в некоторых приложениях задачи должны взаимодействовать.

- **Задача запуска** для узлов в пуле.
	- Вы можете указать *задачу запуска*, которая будет выполняться при каждом добавлении вычислительного узла в пул, а также при перезапуске узла. Эта возможность чаще всего применяется для установки приложения, которое будет использоваться выполняемыми на узле задачами.

### <a name="job"></a>Задание

Задание представляет собой набор задач и определяет порядок выполнения вычислений на вычислительных узлах в пуле.

- Задание указывает **пул**, в котором будет выполняться работа. Это может быть созданный ранее пул, который используют различные задания. Также служба может создавать новый пул для каждого задания, включенного в расписание, или единый пул для всех заданий в одном расписании.
- Вы можете указать **приоритет задания**, но это необязательный параметр. Если вы создаете задание с более высоким приоритетом, чем у других выполняющихся заданий, задачи из более приоритетного задания добавляются в очередь перед задачами из заданий с низким приоритетом. Задачи с более низким приоритетом, которые уже выполняются, прерываться не будут.
- Вы можете задать некоторые **ограничения** для заданий.
	- Например, **максимальное время выполнения**. Если задания выполняется дольше, чем указанное максимальное время выполнения, то такое задание и все связанные с ним задачи будут завершены.
	- Пакетная служба Azure может обнаруживать задачи, которые завершаются с ошибкой и повторно запускать задачи. В качестве ограничения можно указать **максимальное число повторных попыток задачи**, в том числе указать, следует ли пытаться повторно выполнить задачу всегда или никогда. Повторное выполнение задачи означает, что данная задача повторно помещается в очередь и будет снова запущена.
- Задачи к заданию может добавлять клиентское приложение или [задачи диспетчера заданий](#jobmanagertask). Задача диспетчера заданий использует API пакетной службы. Она содержит всю информацию для создания необходимых задач в рамках задания. Эту задачу выполняет один из вычислительных узлов пула. Задача диспетчера заданий обрабатывается пакетной службой особым образом: она помещается в очередь сразу при создании задания и перезапускается, если происходит сбой. Задача диспетчера заданий необходима для заданий, создаваемых расписанием заданий, так как это единственный способ определить задачи перед созданием экземпляра задания. Дополнительную информацию о задачах диспетчера заданий см. ниже.


### <a name="task"></a>Задача

Задача представляет собой единицу вычисления, которая связана с заданием и выполняется на узле. Задачи назначаются узлу для выполнения или ставятся в очередь, пока не освободится какой-либо узел. Задача использует следующие ресурсы:

- Приложение, указанное в **командной строке** задачи.

- **Файлы ресурсов**, которые содержат данные для обработки. Эти файлы автоматически копируются на узел из хранилища больших двоичных объектов в учетной записи службы хранилища Azure. Дополнительную информацию см. в разделе [Файлы и каталоги](#files) ниже.

- **Переменные среды**, необходимые для приложения. Дополнительную информацию см. в разделе [Параметры среды для задач](#environment) ниже.

- **Ограничения**, в рамках которых должны выполняться вычисления. Например, может быть задано максимальное время на выполнение задачи, максимальное количество повторных попыток выполнить задачу в случае сбоя и максимальное время хранения файлов в рабочем каталоге.

Помимо задач, которые можно определить для вычислений на узле, пакетная служба выполняет следующие специальные задачи.

- [Задача запуска](#starttask)
- [Задача диспетчера заданий](#jobmanagertask)
- [Задачи подготовки и завершения заданий.](#jobmanagertask)
- [Задачи с несколькими экземплярами](#multiinstance)

#### <a name="starttask"></a>Задача запуска

Связав **задачу запуска** с пулом, можно настроить среду выполнения на его узлах. Эта задача может выполнять установку программного обеспечения или запуск фоновых процессов. Задача запуска выполняется при каждом запуске узла, пока узел остается в пуле, в том числе при первом добавлении узла к пулу. Задача запуска особенно полезна тем, что она содержит все сведения для настройки вычислительных узлов и установки приложений, которые нужны для выполнения задач в рамках задания. Таким образом, для увеличения числа узлов в пуле достаточно указать новое количество узлов. Пакетная служба уже имеет всю информацию для настройки новых узлов и подготовки их к выполнению задач.

Для этой задачи, как для любой задачи пакетной службы, кроме исполняемой **командной строки** можно указать список **файлов ресурсов**, которые хранятся в [службе хранилища Azure][azure_storage]. Пакетная служба Azure сначала скопирует эти файлы из службы хранилища Azure, а затем запустит командную строку. Список файлов для задачи запуска пула обычно содержит файлы или пакет приложения. В нем также могут содержаться справочные данные, которые будут использоваться всеми задачами, выполняемыми на вычислительных узлах. Командная строка задачи запуска может выполнять сценарий PowerShell или операцию `robocopy`, например, чтобы скопировать файлы приложения в «общую» папку и запустить MSI или `setup.exe`.

Обычно желательно, чтобы пакетная служба дождалась завершения задачи запуска, прежде чем считать узел готовым к назначению задач, но это поведение можно изменить.

Если задача запуска на узле пула завершится сбоем, этот сбой отобразится в параметре состояния узла. При этом узел будет недоступным для назначения задач. Задача запуска может завершиться сбоем, если не удастся скопировать файлы ресурсов из хранилища или если процесс, запущенный командной строкой задачи запуска, вернет ненулевой код завершения.

#### <a name="jobmanagertask"></a>Задача диспетчера заданий

**Задача диспетчера заданий** обычно используется для управления заданием или его отслеживания. Например, она создает и отправляет задачи для задания, определяет необходимые дополнительные задачи и определяет завершение задания. Но задача диспетчера заданий не ограничивается такими действиями. Это полнофункциональная задача, которая может выполнять любые действия в рамках задания. Например, задача диспетчера заданий может загрузить файл, указанный в качестве параметра, проанализировать содержимое этого файла и в зависимости от содержимого отправить на выполнение дополнительные задачи.

Задача диспетчера заданий запускается перед выполнением других задач и предоставляет следующие возможности.

- Пакетная служба автоматически создает эту задачу при создании задания.

- Эта задача выполняется раньше любых других задач в задании.

- Узел, на котором выполняется задача, удаляется из пула последним при уменьшении размера пула.

- Такое завершение задачи может привести к завершению всех задач данного задания.

- При перезапуске задачи диспетчера заданий она получает наивысший приоритет. При этом, если нет свободных узлов, пакетная служба может освободить ресурсы для этой задачи, прервав выполнение одной из других задач, запущенных в пуле.

- Задача диспетчера заданий не имеет приоритета над задачами других заданий. Приоритеты между заданиями определяются только на уровне заданий.

#### <a name="jobpreprelease"></a>Задачи подготовки и завершения заданий

Для настройки среды выполнения задания пакетная служба предоставляет задачу подготовки задания, а для очистки или обслуживания по окончании задания — задачу завершения задания.

- **Задача подготовки задания**. Эта задача выполняется на всех вычислительных узлах, на которых запланировано выполнение задач, до выполнения какой-либо другой задачи задания. Например, вы можете применить задачу подготовки задания для копирования данных, которые используются всеми задачами, но только в рамках одного задания.
- **Задача завершения задания**. Когда задание завершается, эта задача выполняется на каждом узле в пуле, на котором была выполнена хотя бы одна задача. Задачу завершения задания можно использовать для удаления данных, скопированных задачей подготовки задания, или для сжатия и передачи диагностических данных журналов.

Задачи подготовки и завершения задания позволяют указать командную строку, которая будет выполняться при вызове задачи, а также предлагают такие возможности, как загрузка файлов, выполнение с повышенными правами, пользовательские переменные среды, максимальная длительность выполнения, число повторных попыток и время хранения файла.

Дополнительные сведения о задачах подготовки и завершения заданий см. в статье [Выполнение задач подготовки и завершения заданий на вычислительных узлах пакетной службы Azure](batch-job-prep-release.md).

#### <a name="multiinstance"></a>Задачи с несколькими экземплярами

[Задача с несколькими экземплярами](batch-mpi.md) —это задача, которая может выполняться на нескольких вычислительных узлах одновременно. С помощью задач с несколькими экземплярами можно включать высокопроизводительные вычислительные сценарии, такие как интерфейс передачи сообщений (MPI), которым необходимо несколько совместно выделенных вычислительных узлов для обработки одной рабочей нагрузки.

Подробные сведения о выполнении заданий MPI в пакетной службе с использованием библиотеки .NET для пакетной службы см. в статье [Использование задач с несколькими экземплярами для запуска приложений с интерфейсом передачи сообщений (MPI) в пакетной службе Azure](batch-mpi.md).

### <a name="jobschedule"></a>Запланированные задания

Расписания заданий позволяют создавать в пакетной службе повторяющиеся задания. Расписание заданий определяет время запуска заданий и параметры для запуска этих заданий. В расписании заданий можно указать период его действия, то есть с какого момента и в течение какого времени служба будет применять это расписание, а также частоту выполнения периодических заданий в этот период.

## <a name="files"></a>Файлы и каталоги

У каждой задачи есть рабочий каталог, в котором она может создавать дополнительные файлы и каталоги для хранения выполняемой программы, обрабатываемых данных и результатов обработки. Эти файлы и каталоги будут доступны для других задач, пока выполняется это задание. Все задачи, файлы и каталоги на узле принадлежат одной учетной записи пользователя.

Пакетная служба предоставляет часть файловой системы на узле в качестве корневого каталога. Задача может обратиться к корневому каталогу по пути, который хранится в переменной среды `%AZ_BATCH_NODE_ROOT_DIR%`. Дополнительную информацию об использовании переменных среды см. в разделе [Параметры среды для задач](#environment).

![Структура каталогов вычислительного узла][1]

Корневой каталог имеет следующую структуру каталогов.

- **Shared** — эта папка является общей для всех задач на этом узле, выполняемых любым заданием. К общей папке на узле можно обратиться по пути из переменной `%AZ_BATCH_NODE_SHARED_DIR%`. Все задачи, выполняемые на узле, имеют права чтения и записи в этой папке. Любая задача может создавать, читать, обновлять и удалять файлы в этом каталоге.

- **Startup** — этот каталог используется задачей запуска в качестве рабочего каталога. В этом каталоге также хранятся все файлы, скачанные Пакетной службой для выполнения задачи запуска. К каталогу запуска на узле можно обратиться по пути из переменной среды `%AZ_BATCH_NODE_START_DIR%`. Задача запуска может создавать, читать, обновлять и удалять файлы в этом каталоге. Также данный каталог может использоваться задачами запуска для настройки операционной системы.

- **Tasks** — такой каталог создается отдельно для каждой задачи, которая выполняется на узле. Он доступен по пути из переменной среды `%AZ_BATCH_TASK_DIR%`. В каждом каталоге задачи пакетная служба создает рабочий каталог (`wd`), который имеет уникальный путь, указанный в переменной среды `%AZ_BATCH_TASK_WORKING_DIR%`. Этот каталог предоставляет задаче доступ на чтение и запись. Задача может создавать, читать, обновлять и удалять файлы в этом каталоге. Время существования каталога определяется указанным для задачи ограничением *RetentionTime*.
  - `stdout.txt` и `stderr.txt` — эти файлы сохраняются в папку задачи во время ее выполнения.

При удалении узла из пула все файлы, хранящиеся на этом узле, удаляются.

## <a name="lifetime"></a>Время существования пула и вычислительного узла

При проектировании решения на базе пакетной службы Azure следует принять решение о том, когда и как будут создаваться пулы и как долго будут доступны вычислительные узлы в этих пулах.

Одной из крайностей является создание отдельного пула для каждого задания при его отправке с удалением узлов сразу по завершении задач. Такой вариант позволит максимально эффективно использовать ресурсы, так как узлы выделяются в строго необходимом количестве и завершают работу, как только переходят в состояние простоя. Но при этом задание должно ожидать выделения узлов. Важно отметить, что распределение задач по узлам происходит по мере доступности и выделения каждого отдельного узла, сразу после выполнения на нем задачи запуска. Иными словами, пакетная служба *не* дожидается перед назначением задач, пока все узлы в пуле станут доступными, что обеспечивает максимально эффективное использование ресурсов.

Другим крайним вариантом является заблаговременное создание пула и подготовка его узлов до запуска заданий. Этот вариант применим для тех ситуаций, когда немедленный запуск задания имеет наивысший приоритет. В нашем случае задачи, создаваемые заданием, будут запускаться немедленно, но при этом узлы могут некоторое время простаивать в ожидании назначения задач.

Возможен и смешанный подход, когда создается пул для нескольких заданий, количество узлов в котором изменяется в зависимости от текущей нагрузки (см. раздел *Масштабирование приложений* ниже). Обычно такой вариант используется для обработки постоянной нагрузки, интенсивность которой изменяется. Масштабирование можно выполнять по мере изменения интенсивности нагрузки или с упреждением, если нагрузка является прогнозируемой.

## <a name="scaling"></a>Масштабирование приложений

С помощью [автоматического масштабирования](batch-automatic-scaling.md) вы можете использовать пакетную службу для динамической настройки нескольких вычислительных узлов в пуле в соответствии с текущей рабочей нагрузкой и использованием ресурсов сценария вычислений. Это позволит снизить общую стоимость работы приложения за счет использования только необходимых ресурсов и освобождения остальных. Вы можете указать параметры автоматического масштабирования для пула при его создании или включить масштабирование позже, а также можете обновить параметры масштабирования для пула с включенным автоматическим масштабированием.

Автоматическое масштабирование выполняется путем указания **формулы автоматического масштабирования** для пула. Пакетная служба использует эту формулу для определения целевого количества узлов в пуле для следующего интервала масштабирования (интервал, который вы можете указать).

Рассмотрим для примера задание, которое требует планирования большого количества задач. Вы можете назначить для пула формулу масштабирования, которая изменяет количество узлов пула в зависимости от текущего числа задач в очереди и скорости выполнения этих задач. Пакетная служба периодически вычисляет формулу и изменяет размер пула в зависимости от рабочей нагрузки и параметров формулы.

Формула масштабирования может использовать следующие метрики.

- **Метрики времени** — основываются на статистических данных, которые собираются каждые 5 минут за указанное число часов.

- **Метрики ресурсов** — зависят от показателей загрузки ЦП, использования пропускной способности и памяти, а также количества узлов.

- **Метрики задач** — основываются на состоянии задач (активные, ожидающие и завершенные).

Если при автоматическом масштабировании уменьшается количество вычислительных узлов в пуле, необходимо учитывать количество выполняемых задач. Чтобы решить эту проблему, в формулу можно включить параметр, регулирующий политику отмены выделения узла: от него зависит, будут ли выполняемые задачи немедленно остановлены или могут быть завершены до удаления узла из пула.

> [AZURE.TIP] Для максимально эффективного использования ресурсов укажите значение "ноль" для целевого количества узлов на момент завершения задания, но позвольте текущим задачам завершиться нормально.

Подробные сведения об автоматическом масштабировании приложения см. в статье [Автоматическое масштабирование вычислительных узлов в пуле пакетной службы Azure](batch-automatic-scaling.md).

## <a name="cert"></a>Безопасность с использованием сертификатов

Обычно сертификаты используются для шифрования и расшифровки конфиденциальных сведений, используемых задачами, например ключей [учетной записи службы хранилища Azure][azure_storage]. Для использования этой возможности на узлах можно установить сертификаты. Зашифрованные данные передаются задачам через параметры командной строки или через ресурсы задачи, а установленные сертификаты позволяют расшифровать их.

Для добавления сертификата к учетной записи пакетной службы используйте операцию [Добавить сертификат][rest_add_cert] в REST API пакетной службы или метод [CertificateOperations.CreateCertificate][net_create_cert] в .NET API пакетной службы. Затем можно будет связать сертификат с новым или существующим пулом. Если к пулу привязан сертификат, пакетная служба устанавливает этот сертификат на каждом узле пула. Пакетная служба устанавливает нужные сертификаты при запуске узла, до начала выполнения каких-либо задач, в том числе задач запуска и задач диспетчера заданий.

## <a name="scheduling"></a>Приоритеты планирования

При создании задания в пакетной службе ему можно назначить приоритет. Пакетная служба использует значения приоритетов заданий, чтобы определять порядок выполнения разных заданий в одной учетной записи. Приоритет может иметь значение в диапазоне от -1000 до 1000, где -1000 означает наименьший приоритет, а 1000 — наивысший. Вы можете изменить приоритет задания с помощью операции [Изменить свойства задания][rest_update_job] (REST API пакетной службы) или изменив свойство [CloudJob.Priority][net_cloudjob_priority] (в .NET API пакетной службы).

В рамках одной учетной записи задания с высоким приоритетом имеют приоритет при планировании относительно заданий с низким приоритетом. Задания с более высоким приоритетом, относящиеся к одной учетной записи, не имеют приоритета при планировании относительно других заданий с более низким приоритетом, относящихся к другой учетной записи.

Задания распределяются по пулам независимо друг от друга. Если используется несколько пулов, задание с более высоким приоритетом не обязательно будет выполняться первым. Задание задерживается, если в связанном с ним пуле недостаточно свободных узлов. Если задания выполняются в одном пуле и имеют одинаковый приоритет, они имеют равные шансы на распределение.

## <a name="environment"></a>Параметры среды для задач

Каждая задача, выполняемая в рамках пакетного задания, имеет доступ к переменным среды, которые устанавливаются самой пакетной службой (системные переменные, см. таблицу ниже) или пользователем. Приложения и скрипты, запускаемые на вычислительных узлах с помощью задач, получают доступ к переменным среды во время выполнения на узле.

Установить значения пользовательских переменных среды можно при использовании операции [Добавить задачу к заданию][rest_add_task] (REST API пакетной службы) или при добавлении задач в задание. В последнем случае следует изменить значение параметра [CloudTask.EnvironmentSettings][net_cloudtask_env] (.NET API пакетной службы).

Чтобы получить значения системных и пользовательских переменных среды для задачи, используйте операцию [Получить сведения о задаче][rest_get_task_info] (REST API пакетной службы) или свойство [CloudTask.EnvironmentSettings][net_cloudtask_env] (.NET API пакетной службы). Как уже упоминалось, процессы, которые выполняются на вычислительном узле, также могут обращаться ко всем переменным среды, например, с помощью привычного синтаксиса `%VARIABLE_NAME%`.

Для каждой задачи, запланированной в рамках задания, пакетная служба определяет следующий набор системных переменных среды.

| Имя переменной среды | Описание |
|---------------------------------|--------------------------------------------------------------------------|
| `AZ_BATCH_ACCOUNT_NAME` | Имя учетной записи, которой принадлежит задача. |
| `AZ_BATCH_JOB_ID` | Идентификатор задания, к которому относится задача. |
| `AZ_BATCH_JOB_PREP_DIR` | Полный путь к каталогу задачи подготовки задания на узле. |
| `AZ_BATCH_JOB_PREP_WORKING_DIR` | Полный путь к рабочему каталогу задачи подготовки задания на узле. |
| `AZ_BATCH_NODE_ID` | Идентификатор узла, на котором выполняется задача. |
| `AZ_BATCH_NODE_ROOT_DIR` | Полный путь к корневому каталогу на узле. |
| `AZ_BATCH_NODE_SHARED_DIR` | Полный путь к общему каталогу на узле. |
| `AZ_BATCH_NODE_STARTUP_DIR` | Полный путь к каталогу задачи запуска на вычислительном узле. |
| `AZ_BATCH_POOL_ID` | Идентификатор пула, в котором выполняется задача. |
| `AZ_BATCH_TASK_DIR` | Полный путь к каталогу задачи на узле. |
| `AZ_BATCH_TASK_ID` | Идентификатор текущей задачи. |
| `AZ_BATCH_TASK_WORKING_DIR` | Полный путь к рабочему каталогу задачи на узле. |

>[AZURE.NOTE] Указанные выше системные переменные нельзя перезаписать, так как все они доступны только для чтения.

## <a name="errorhandling"></a>Обработка ошибок

Возможно, вы захотите обрабатывать ошибки задач и приложений в своем решении пакетной службы.

### Обработка сбоев задач
Сбои задач делятся на следующие категории.

- **Ошибки планирования**
	- Если по какой-либо причине происходит сбой передачи файлов, указанных для задачи, для нее устанавливается состояние «ошибка планирования».
	- Ошибки планирования могут возникать, если файлы были перемещены, если прекращено действие учетной записи хранения, или копирование файлов на узел не удалось из-за другой проблемы.
- **Ошибки приложений**
	- Процесс, указанный в командной строке задачи, также может завершиться ошибкой. Если процесс, выполняемый задачей, возвращает ненулевой код выхода, считается, что такой процесс завершился ошибкой.
	- Вы можете настроить пакетную службу так, чтобы в случае ошибки приложения она автоматически повторяла задачу, а также указать максимальное количество таких попыток.
- **Ошибки ограничения**
	- Вы можете установить ограничение на максимальное время выполнения задания или задачи с помощью параметра *maxWallClockTime*. Это полезно для завершения задач, переставших отвечать на запросы.
	- В случае превышения максимального времени выполнения задача отмечается как *завершенная*, но с кодом выхода `0xC000013A`. При этом поле *schedulingError* будет иметь значение `{ category:"ServerError", code="TaskEnded"}`.

### Отладка ошибок приложений

Во время выполнения приложение может создавать диагностические данные, которые помогут устранить неполадки. Как упоминалось выше в разделе [Файлы и каталоги](#files), пакетная служба направляет выходные данные stdout и stderr в файлы `stdout.txt` и `stderr.txt`, расположенные в каталоге задачи на вычислительном узле. Вы можете получить эти и другие файлы для устранения неполадок, используя методы [ComputeNode.GetNodeFile][net_getfile_node] и [CloudTask.GetNodeFile][net_getfile_task] .NET API пакетной службы.

Дополнительные возможности для отладки можно получить, выполнив вход на вычислительный узел через *удаленный рабочий стол*. Для этого вам следует [получить с узла файл протокола удаленного рабочего стола][rest_rdp] (REST API пакетной службы) или использовать метод [ComputeNode.GetRDPFile][net_rdp] (.NET API пакетной службы).

>[AZURE.NOTE] Чтобы подключиться к узлу по протоколу удаленного рабочего стола, на узле нужно создать пользователя. [Добавьте учетную запись пользователя на узел][rest_create_user] в REST API пакетной службы или используйте метод [ComputeNode.CreateComputeNodeUser][net_create_user] в .NET пакетной службы.

### Работа со сбоями и прерываниями задач

Задачи могут иногда завершаться ошибками или прерываться. Например, может завершиться ошибкой приложение задачи, или узел, на котором выполняется задача, может быть перезапущен. Также узел может быть удален из пула при изменении размера, если установленная политика отмены выделения предусматривает немедленное удаление узла без ожидания завершения задачи. Во всех случаях пакетная служба может автоматически поставить задачу в очередь на повторное выполнение на другом узле.

Задача может также зависнуть или выполняться слишком долго из-за кратковременного сбоя. Для задачи можно установить максимальное время выполнения, при превышении которого пакетная служба прервет выполнение приложения задачи.

### Устранение неполадок на "плохих" вычислительных узлах

В ситуациях, когда при выполнении некоторых задач происходит сбой, пакетное клиентское приложение или служба может проверить метаданные неудачных задач для определения узла, который плохо работает. Каждому узлу в пуле присваивается уникальный идентификатор, а сведения об узле, на котором выполняется задача, включены в метаданные задачи. После определения узла вы можете выполнить следующие действия.

- **Перезагрузите узел** ([REST][rest_reboot] | [.NET][net_reboot]).

	В некоторых случаях перезапуск узла может устранить некоторые скрытые проблемы, например задержки и сбои при выполнении процессов. Обратите внимание, что если пул использует начальную задачу или задание использует задачу подготовки задания, они будут выполнены при перезапуске узла.

- **Повторно создайте образ узла** ([REST][rest_reimage] | [.NET][net_reimage]).

	Это обеспечит переустановку операционной системы на узле. Как и в случае перезагрузки узла, задачи запуска и задачи подготовки заданий будут повторно выполнены после повторного создания образа узла.

- **Удалите узел из пула** ([REST][rest_remove] | [.NET][net_remove]).

	Иногда бывает необходимо полностью удалить узел из пула.

- **Отключите планирование задач на узле** ([REST][rest_offline] | [.NET][net_offline]).

	Это эффективно переключит узел в "автономный режим", чтобы ему не назначались дальнейшие задачи, но позволяет узлу продолжать выполнение текущих задач, оставаясь в пуле. Благодаря этому вы сможете продолжить поиск причины сбоев без потери данных невыполненной задачи и без сбоев при выполнении дополнительных задач на узле. Например, можно отключить планирование задач на узле, а затем выполнить удаленный вход на узел для анализа журналов событий или устранения других неполадок. По завершении анализа проблемы вы сможете снова подключить узел к сети, включив планирование задач ([REST][rest_online], [.NET][net_online]) или выполнив одно из перечисленных выше действий.

> [AZURE.IMPORTANT] С помощью каждого из перечисленных выше действий (перезагрузки, повторного создания образа, удаления, отключения планирования задач) вы можете указать вариант обработки текущих задач на узле при выполнении действия. Например, при отключении планирования задач на узле с помощью клиентской библиотеки .NET для пакетной службы вы можете указать значение перечисления [DisableComputeNodeSchedulingOption][net_offline_option], чтобы определить, нужно ли **прекратить** выполнение текущих задач, **повторно поставить их в очередь** для планирования выполнения на других узлах или разрешить завершение текущих задач, прежде чем будет выполнено действие (**TaskCompletion**).

## Дальнейшие действия

- Создайте свое первое приложение пакетной службы в соответствии с шагами, описанными в статье [Начало работы с библиотекой Пакетной службы Azure для .NET](batch-dotnet-get-started.md)
- Загрузите и соберите пример проекта [обозревателя пакетной службы][batch_explorer_project], который вы сможете использовать при разработке собственных решений пакетной службы. С помощью обозревателя пакетной службы вы можете выполнять множество операций, в частности:
  - отслеживать и изменять работу пулов, заданий и задач в своей учетной записи пакетной службы;
  - загружать с узлов файлы `stdout.txt`, `stderr.txt` или любые другие;
  - создавать на узлах пользователей и загружать RDP-файлы для удаленного входа.

[1]: ./media/batch-api-basics/node-folder-structure.png

[about_cloud_services]: https://azure.microsoft.com/documentation/articles/fundamentals-application-models/#tell-me-about-cloud-services
[azure_storage]: https://azure.microsoft.com/services/storage/
[batch_explorer_project]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/BatchExplorer
[cloud_service_sizes]: https://azure.microsoft.com/documentation/articles/cloud-services-sizes-specs/
[msmpi]: https://msdn.microsoft.com/library/bb524831.aspx

[batch_net_api]: https://msdn.microsoft.com/library/azure/mt348682.aspx
[net_cloudjob_jobmanagertask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.jobmanagertask.aspx
[net_cloudjob_priority]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.priority.aspx
[net_cloudpool_starttask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.starttask.aspx
[net_cloudtask_env]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudtask.environmentsettings.aspx
[net_create_cert]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.certificateoperations.createcertificate.aspx
[net_create_user]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.createcomputenodeuser.aspx
[net_getfile_node]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.getnodefile.aspx
[net_getfile_task]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudtask.getnodefile.aspx
[net_multiinstancesettings]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.multiinstancesettings.aspx
[net_rdp]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.getrdpfile.aspx
[net_reboot]: https://msdn.microsoft.com/library/azure/mt631495.aspx
[net_reimage]: https://msdn.microsoft.com/library/azure/mt631496.aspx
[net_remove]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.pooloperations.removefrompoolasync.aspx
[net_offline]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.disableschedulingasync.aspx
[net_online]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.enableschedulingasync.aspx
[net_offline_option]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.common.disablecomputenodeschedulingoption.aspx

[batch_rest_api]: https://msdn.microsoft.com/library/azure/Dn820158.aspx
[rest_add_job]: https://msdn.microsoft.com/library/azure/mt282178.aspx
[rest_add_pool]: https://msdn.microsoft.com/library/azure/dn820174.aspx
[rest_add_cert]: https://msdn.microsoft.com/library/azure/dn820169.aspx
[rest_add_task]: https://msdn.microsoft.com/library/azure/dn820105.aspx
[rest_create_user]: https://msdn.microsoft.com/library/azure/dn820137.aspx
[rest_get_task_info]: https://msdn.microsoft.com/library/azure/dn820133.aspx
[rest_multiinstance]: https://msdn.microsoft.com/ru-RU/library/azure/mt637905.aspx
[rest_multiinstancesettings]: https://msdn.microsoft.com/library/azure/dn820105.aspx#multiInstanceSettings
[rest_update_job]: https://msdn.microsoft.com/library/azure/dn820162.aspx
[rest_rdp]: https://msdn.microsoft.com/library/azure/dn820120.aspx
[rest_reboot]: https://msdn.microsoft.com/library/azure/dn820171.aspx
[rest_reimage]: https://msdn.microsoft.com/library/azure/dn820157.aspx
[rest_remove]: https://msdn.microsoft.com/library/azure/dn820194.aspx
[rest_offline]: https://msdn.microsoft.com/library/azure/mt637904.aspx
[rest_online]: https://msdn.microsoft.com/library/azure/mt637907.aspx

<!---HONumber=AcomDC_0302_2016-->