<properties
	pageTitle="Учебник «Приступая к работе с библиотекой приложений пакетной службы Azure для .NET»"
	description="Основные сведения о приложениях пакетной службы Azure и методах простой и быстрой разработки."
	services="batch"
	documentationCenter=".net"
	authors="yidingzhou"
	manager="timlt"
	editor=""/>

<tags
	ms.service="batch"
	ms.devlang="dotnet"
	ms.topic="hero-article"
	ms.tgt_pltfrm="na"
	ms.workload="big-compute"
	ms.date="07/21/2015"
	ms.author="yidingz"/>




# Приступая к работе с библиотекой приложений пакетной службы Azure для .NET
В этом учебнике будет рассказано, как выполнять параллельные вычисления рабочих нагрузок в Пакетной службе Azure с помощью приложений Пакетной службы.

Приложения Пакетной службы — одна из функций Пакетной службы Azure, которая дает возможность управлять рабочими нагрузками Пакетной службы и выполнять их на уровне приложения. С помощью пакета SDK для приложений Пакетной службы можно создать приложения Пакетной службы, а также развернуть их в собственной учетной записи или же сделать их доступными для других пользователей Пакетной службы. Пакетная служба также дает возможность управлять данными, осуществлять мониторинг заданий, предоставляет встроенные инструменты диагностики и ведения журнала, а также обеспечивает поддержку внутренних зависимостей задач. Кроме того, она включает в себя портал управления, с помощью которого вы можете управлять заданиями, просматривать журналы и загружать выходные данные без необходимости разработки собственного клиентского приложения.

В сценарии приложений Пакетной службы необходимо написать код с использованием пакета SDK для облачных приложений Пакетной службы, чтобы разделять задания на параллельные задачи, описать зависимости между задачами и указать способ выполнения каждой задачи. Этот код развертывается в учетной записи Пакетной службы. После этого клиенты смогут выполнять задания, указывая тип задания и входные файлы в интерфейсе REST API.

>[AZURE.NOTE]Для работы с этим учебником требуется учетная запись Azure. Вы можете создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в разделе [Бесплатная пробная версия Azure](http://azure.microsoft.com/pricing/free-trial/). NuGet можно использовать для получения сборок <a href="http://www.nuget.org/packages/Microsoft.Azure.Batch.Apps.Cloud/">облачных приложений пакетной службы</a> и <a href="http://www.nuget.org/packages/Microsoft.Azure.Batch.Apps/">клиента приложений пакетной службы</a>. После создания проекта в Visual Studio щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **Управление пакетами NuGet**. Вы также можете скачать расширение Visual Studio для приложений пакетной службы, которое включает шаблон проекта для приложений с поддержкой облака и возможность развернуть приложение <a href="https://visualstudiogallery.msdn.microsoft.com/8b294850-a0a5-43b0-acde-57a07f17826a">здесь</a> или через поиск **приложений пакетной службы** в Visual Studio с помощью пункта меню "Расширения и обновления". Вы также можете найти <a href="https://go.microsoft.com/fwLink/?LinkID=512183&clcid=0x409">полные примеры на портале MSDN.</a>
>

###Основные положения приложений Пакетной службы Azure
Пакетная служба предназначена для работы с существующими приложениями, которые разработаны для крупномасштабных вычислений. Она использует существующий код приложения и запускает его в динамической виртуализированной среде общего назначения. Вот что нужно сделать, чтобы приложение стало совместимым со приложениями Пакетной службы.

1.	Подготовьте ZIP-файл с исполняемыми файлами существующего приложения (это те же исполняемые файлы, которые могут выполняться на традиционной ферме серверов или кластерах) и всеми необходимыми файлами. Затем отправьте этот ZIP-файл в вашу учетную запись Пакетной службы с помощью портала управления или REST API.
2.	Создайте ZIP-файл "облачных сборок", которые распределяют рабочую нагрузку для приложения, и отправьте его с помощью портала управления или REST API. Облачная сборка состоит из двух компонентов, которые собираются с помощью пакета SDK для облачных приложений:
	1.	Разделитель заданий разбивает задание на задачи, которые могут быть обработаны независимо друг от друга. Например, в сценарии анимации разделитель заданий будет принимать в качестве задания фильм и разбивать его на отдельные кадры.
	2.	Обработчик задач вызывает исполняемый файл приложения для заданной задачи. Например, в сценарии анимации обработчик задач будет вызывать программу визуализации для отрисовки отдельного, указанного задачей кадра.
3.	Предоставьте способ отправки заданий приложению в Azure. Это может быть подключаемый модуль пользовательского интерфейса приложения, веб-портал или же автоматическая служба, входящая в ваш конвейер выполнения. См. <a href="https://go.microsoft.com/fwLink/?LinkID=512183&clcid=0x409">примеры</a> на портале MSDN.



###Основные понятия приложений Пакетной службы
Модель программирования и использования приложений Пакетной службы основывается на следующих ключевых понятиях:

####Задания
**Задание** — это элемент работы, отправленный пользователем. При отправке задания пользователь указывает его тип, параметры задания и необходимые данные. Для действующей реализации пользователь может не указать данную информацию либо указать ее явно с помощью клиента. После завершения задание возвращает результаты. Каждое задание содержит основные выходные данные и необязательные данные предварительного просмотра. При необходимости задания могут возвращать дополнительные выходные данные.

####Задачи
**Задача** — это элемент работы, выполняемый в рамках задания. Когда пользователь отправляет задание, оно разбивается на более мелкие задачи. Пакетная служба обрабатывает отдельные задачи, а затем собирает результаты и предоставляет их в виде общих выходных данных задания. Характер задачи зависит от типа задания. Основываясь на знаниях о блоках работы, которые приложение должно обрабатывать, разделитель заданий определяет, каким образом задание будет разбито на задачи. Можно скачать выходные данные отдельных задач, и в некоторых случаях это может быть полезным. Например, пользователю может потребоваться скачать отдельные задачи из задания анимации.

####Задачи слияния
**Задача слияния** — это особый тип задачи, которая объединяет результаты выполнения отдельных задач в окончательные результаты задания. Для задания визуализации фильма задача слияния может собирать отрисованные кадры в фильм или ZIP-файл готовых кадров. Каждое задание содержит задачу слияния, даже если в слиянии нет необходимости.

####Файлы
**Файл** — это элемент данных, который используется в качестве входных данных для задания. Задание может содержать как один или несколько входных файлов, так и не иметь их вовсе. Один и тот же файл можно использовать в нескольких заданиях: например, для задания отрисовки фильма эти файлы могут быть текстурами, моделями и т. д. Для задания анализа данных файлы могут содержать набор наблюдений или измерений.

###Реализация облачного приложения
Ваше приложение должно содержать статическое поле или свойство, содержащее всю информацию о приложении. Оно определяет имя приложения и тип задания (или типы заданий, которые обрабатываются приложением). Для этого можно использовать шаблон из пакета SDK, который можно загрузить с помощью коллекции Visual Studio.

Ниже приведен пример объявления облачного приложения для параллельной рабочей нагрузки:

	public static class ApplicationDefinition
	{
	    public static readonly CloudApplication App = new ParallelCloudApplication
	    {
	        ApplicationName = "ApplicationName",
	        JobType = "ApplicationJobType",
	        JobSplitterType = typeof(MyJobSplitter),
	        TaskProcessorType = typeof(MyTaskProcessor),
	    };
	}

####Реализация разделителя заданий и обработчика задач
Для параллельной обработки рабочих нагрузок необходимо реализовать разделитель заданий и обработчик задач.

####Реализация JobSplitter.SplitIntoTasks
Реализация SplitIntoTasks должна возвращать последовательность задач. Каждая задача представляет собой отдельную часть работы, которая помещается в очередь для обработки на вычислительном узле. Каждая задача должна быть автономной и содержать всю необходимую информацию, которая может потребоваться обработчику задач.

Задачи, указанные разделителем заданий, представлены в виде объектов TaskSpecifier. TaskSpecifier содержит ряд свойств, которые вы можете установить перед возвратом задачи.


-	Свойство TaskIndex не указывается, однако остается доступным для обработчика задач. Его можно использовать для передачи индекса в обработчик задач. Если передавать индекс не требуется, определять это свойство не нужно.
-	Параметры – это пустая коллекция по умолчанию. В нее можно добавить новые элементы или заменить ее новой коллекцией. Записи из коллекции параметров задания можно копировать с помощью метода WithJobParameters или WithAllJobParameters.  


RequiredFiles — это пустая коллекция по умолчанию. В нее можно добавить новые элементы или заменить ее новой коллекцией. Записи из коллекции файлов задания вы можете копировать с помощью метода RequiringJobFiles или RequiringAllJobFiles.

Вы можете указать задачу, которая зависит от какой-либо другой задачи. Для этого определите свойство TaskSpecifier.DependsOn, передав идентификатор задачи, от которой она зависит.

	new TaskSpecifier {
	    DependsOn = TaskDependency.OnId(5)
	}

Задача не начнет выполняться до тех пор, пока не станут доступны выходные данные задачи, от которой она зависит.

Также вы можете указать, что обработка всей группы задач не должна начинаться до полного завершения задач другой группы. Для этого можно определить свойство TaskSpecifier.Stage. Задачи с определенным значением свойства Stage не будут переданы на обработку, пока не завершены все задачи с меньшими значениями свойства Stage. Например, задачи, у которых свойству Stage присвоено значение 3, не начнут обрабатываться, пока не будут завершены все задачи, у которых свойство Stage имеет значение 0, 1 или 2. Значения свойства Stage должны начинаться с 0, последовательность этапов не должна иметь разрывов, а SplitIntoTasks должен возвращать задачи в порядке номеров этапов. Например, будет считаться ошибкой возвращение задачи со значением свойства Stage 0 после задачи со Stage 1.

Каждое задание с параллельной обработкой завершается специальной задачей слияния. Задача слияния объединяет результаты задач параллельной обработки в итоговый результат. Приложения Пакетной службы автоматически создадут задачу слияния.

В редких случаях может потребоваться явно управлять задачей слияния. Например, чтобы настроить ее параметры. Чтобы указать задачу слияния, нужно вернуть набор свойств TaskSpecifier, в котором свойство IsMerge имеет значение true. Таким образом автоматически созданная задача слияния будет переопределена. Если вы явно создаете задачу слияния:

-	Можно создать только одну явную задачу слияния.
-	Она должна быть последней задачей в последовательности.
-	Она должна содержать свойство IsMerge со значением true, а все другие задачи должны содержать свойство IsMerge со значением false.  


Однако помните, что в общем случае не требуется создавать задачу слияния явно.

В следующем примере кода показана простая реализация метода SplitIntoTasks.

	protected override IEnumerable<TaskSpecifier> SplitIntoTasks(
	    IJob job,
	    JobSplitSettings settings)
	{
	    int start = Int32.Parse(job.Parameters["startIndex"]);
	    int end = Int32.Parse(job.Parameters["endIndex"]);
	    int count = (end - start) + 1;

	    // Processing tasks
	    for (int i = 0; i < count; ++i)
	    {
	        yield return new TaskSpecifier
	        {
	            TaskIndex = start + i,
	        }.RequiringAllJobFiles();
	    }
	}
####Реализация ParallelTaskProcessor.RunExternalTaskProcess

RunExternalTaskProcess вызывается для всех задач без слияния, которые были возвращены разделителем заданий. Данный метод вызовет ваше приложение с соответствующими аргументами и вернет коллекцию выходных данных, которые должны быть сохранены для последующего использования.

Следующий фрагмент показывает, как вызвать программу под названием application.exe. Обратите внимание, что вы можете использовать вспомогательный метод ExecutablePath для создания абсолютного пути к файлам.

Класс ExternalProcess из пакета SDK для облачных приложений предоставляет полезные вспомогательные методы для исполняемых объектов вашего приложения. ExternalProcess может позаботиться об отмене действий, преобразовании кодов выхода в исключения, захвате стандартных потоков вывода и ошибок, а также обеспечить настройку переменных среды. Для непосредственного запуска программ вы можете дополнительно использовать класс .NET Process.

Метод RunExternalTaskProcess возвращает TaskProcessResult, который включает в себя список выходных файлов. К ним относятся как минимум все файлы, необходимые для слияния. Также можно возвращать файлы журнала, файлы предварительного просмотра и промежуточные файлы (например, для диагностики, если задача завершена с ошибкой). Обратите внимание, что метод возвращает пути к файлам, а не их содержание.

Каждый файл должен быть идентифицирован по типу вывода, который в нем содержится: вывод (то есть часть возможного вывода задания), предварительный просмотр, журнал или промежуточный. Эти значения берутся из перечисления TaskOutputFileKind. Следующий фрагмент возвращает выходные данные одной задачи без данных предварительного просмотра или данных журнала. Метод TaskProcessResult.FromExternalProcessResult упрощает распространенный сценарий записи кода завершения, выходных данных обработчика и выходных файлов программы командной строки:

В следующем примере кода демонстрируется простая реализация ParallelTaskProcessor.RunExternalTaskProcess.

	protected override TaskProcessResult RunExternalTaskProcess(
	    ITask task,
	    TaskExecutionSettings settings)
	{
	    var inputFile = LocalPath(task.RequiredFiles[0].Name);
	    var outputFile = LocalPath(task.TaskId.ToString() + ".jpg");

	    var exePath = ExecutablePath(@"application\application.exe");
	    var arguments = String.Format("-in:{0} -out:{1}", inputFile, outputFile);

	    var result = new ExternalProcess {
	        CommandPath = exePath,
	        Arguments = arguments,
	        WorkingDirectory = LocalStoragePath,
	        CancellationToken = settings.CancellationToken
	    }.Run();

	    return TaskProcessResult.FromExternalProcessResult(result, outputFile);
	}
####Реализация ParallelTaskProcessor.RunExternalMergeProcess

Этот метод вызывается задачей слияния. Он вызывает приложение для объединения выходных данных предыдущих задач, которые соответствуют вашему приложению, и возвращает итоговый результат.

Реализация RunExternalMergeProcess очень похожа на реализацию RunExternalTaskProcess за небольшим исключением:

-	RunExternalMergeProcess использует выходные данные предыдущих задач, а не входные файлы пользователя. Следовательно, вам нужно определять имена обрабатываемых вами файлов на основании идентификатора задачи, а не коллекции Task.RequiredFiles.
-	RunExternalMergeProcess возвращает файл JobOutput и, при необходимости, файл JobPreview.


В следующем коде демонстрируется простая реализация ParallelTaskProcessor.RunExternalMergeProcess.

	protected override JobResult RunExternalMergeProcess(
	    ITask mergeTask,
	    TaskExecutionSettings settings)
	{
	    var outputFile =  "output.zip";

	    var exePath =  ExecutablePath(@"application\application.exe");
	    var arguments = String.Format("a -application {0} *.jpg", outputFile);

	    new ExternalProcess {
	        CommandPath = exePath,
	        Arguments = arguments,
	        WorkingDirectory = LocalStoragePath
	    }.Run();

	    return new JobResult {
	        OutputFile = outputFile
	    };
	}

###Отправка заданий в приложения Пакетной службы
Задание описывает рабочую нагрузку и должно включать в себя всю необходимую информацию о ней, за исключением содержимого файлов. Например, задание содержит параметры конфигурации, которые передаются от клиента к задаче через разделитель заданий. В MSDN приводятся примеры отправки заданий и работы с несколькими клиентами, включая веб-порталы и клиенты командной строки.

<!---HONumber=July15_HO4-->