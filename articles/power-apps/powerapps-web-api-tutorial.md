<properties
	pageTitle="Учебник. Создание пользовательского API с помощью веб-приложения ASP.Net в PowerApps и логических потоках | Microsoft Azure"
	description="Учебник по созданию пользовательского API с помощью веб-приложения ASP.Net в PowerApps и логических потоках"
	services=""
    suite="powerapps"
	documentationCenter="" 
	authors="sunaysv"
	manager="erikre"
	editor=""/>

<tags
   ms.service="powerapps"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na" 
   ms.date="07/12/2016"
   ms.author="mandia"/>

# Учебник. Создание пользовательского веб-API с защитой AAD для PowerApps и логических потоков

В этом учебнике показано, как создать веб-API ASP.Net, разместить его в веб-приложениях Azure, включить проверку подлинности AAD (простую), а затем зарегистрировать веб-API в PowerApps и логических потоках.

>[AZURE.IMPORTANT] Эта статья перемещена на веб-сайт powerapps.microsoft.com, на котором она по-прежнему называется [Учебник. Создание пользовательского веб-API с защитой AAD для PowerApps и логических потоков](https://powerapps.microsoft.com/tutorials/customapi-web-api-tutorial/). См. последнюю версию на сайте PowerApps. Эта статья Azure архивируется.

## Что необходимо для начала работы

* Подписка Azure
* Учетная запись PowerApps
* Visual Studio 2013 или более поздней версии

## Шаг 1. Создание веб-API и его развертывание в Azure
1. Откройте Visual Studio и создайте новое веб-приложение C# ASP.NET. ![](./media/powerapps-web-api-tutorial/newwebapp.png "Новое веб-приложение")

2. На следующем экране укажите шаблон веб-API и выберите **Без проверки подлинности**. ![](./media/powerapps-web-api-tutorial/noauth.png "Без проверки подлинности")

	>[AZURE.IMPORTANT] Обязательно укажите "Без проверки подлинности" в параметрах проверки подлинности.

3. При создании проекта необходимо создать веб-API для ваших ресурсов. В этом учебнике мы не будем углубляться в основы создания веб-API.

4. Затем создайте файл Swagger для веб-API. Это легко сделать, открыв __консоль диспетчера пакетов__ и установив __Swashbuckle__. ![](./media/powerapps-web-api-tutorial/swashbuckle-console.png "Консоль Swashbuckle")

5. После установки перейдите к таким документам Swagger и конечным точкам пользовательского интерфейса: **<Корневой\_URL-адрес>/swagger/docs/v1**

 	**<Корневой\_URL-адрес>/swagger**

6. Когда веб-API будет готово, опубликуйте его в Azure. Для публикации в Visual Studio выберите **Сборка**, а затем — **Опубликовать**.

7. Извлеките код JSON из файла Swagger, перейдя в каталог ***https://\<URL-адрес\_веб-приложения\_Azure>/swagger/docs/v1***.

	> [AZURE.IMPORTANT] Документ swagger с повторяющимися идентификаторами операций является недействительным. При использовании примера шаблона C# идентификатор операции "Values\_Get" повторяется дважды. Измените один из двух идентификаторов на "Value\_Get".


Файл Swagger, используемый в этом руководстве, можно скачать [отсюда][6]. Не забудьте заменить или удалить комментарии перед его использованием. Комментарии начинаются со знаков `//`.

## Шаг 2. Настройка проверки подлинности AAD

В этом учебнике предполагается, что вы знаете, как создать приложение AAD в Azure. Дополнительные сведения о том, как создать приложение AAD, приведены в статье [Учебник. Создание пользовательского API ARM с защитой AAD для PowerApps и логических потоков](powerapps-azure-resource-manager-tutorial.md). В этом учебнике нам потребуются два приложения AAD.

1. Первое приложение AAD используется для защиты веб-API. Назовите его **webAPI**.
2. Второе приложение AAD используется для защиты регистрации пользовательского API и получения делегированного доступа к веб-API, защищенному первым приложением. Назовите второе приложение **webAPI-customAPI**.
3. Для **webAPI** используйте следующую конфигурацию:

  1. URL-адрес входа: ***https://login.windows.net***.
  2. Универсальный код ресурса (URI) для идентификации приложения: ***https://\<Корневой\_URL-адрес>*** (обычно это URL-адрес вашего сайта, развернутого в Azure).
  3. URL-адрес ответа: ***https://\<Корневой\_URL-адрес>/.auth/login/aad/callback***.
  
	>[AZURE.IMPORTANT] Идентификатор клиента для этого приложения потребуется позже, поэтому запишите его.

4. Для **webAPI-customAPI** используйте следующую конфигурацию:
  
  1. URL-адрес входа: **https://login.windows.net**.
  2. Универсальный код ресурса (URI) для идентификации приложения: ***любой уникальный URL-адрес***.
  3. URL-адрес ответа: ***https://msmanaged-na.consent.azure-apim.net/redirect***.
  4. Добавьте разрешения, чтобы делегировать доступ к веб-API.
  5. Идентификатор клиента для этого приложения также потребуется позже, поэтому запишите его.
  6. Создайте ключ и сохраните его в безопасном месте. Этот ключ понадобится позднее.

>[AZURE.IMPORTANT] Оба приложения должны находиться в одном и том же каталоге.

## Шаг 3. Настройка простой проверки подлинности для веб-приложения

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к веб-приложению, развернутому на **этапе 1** (в этой статье).
2. В разделе **Параметры** выберите **Аутентификация или авторизация**.
3. Включите **Проверка подлинности службы приложений** и выберите **Azure Active Directory**. В следующей колонке выберите **Express**.
4. Щелкните **Выбрать существующее приложение AD** и выберите первое приложение AAD, созданное на этапе 2. В данном случае это **webAPI**.

На этом настройка проверки подлинности AAD для вашего веб-приложения закончена.

## Шаг 4. Настройка пользовательского API 

1. Теперь нужно немного изменить файл Swagger, указав объект `securityDefintions` и проверку подлинности AAD, используемую в веб-приложении. Добавьте следующие строки кода:

	```javascript
  "host": "<your-root-url>",
  "schemes": [
    "https"						//Change scheme to https 
  ],
  "securityDefinitions": {
    "AAD": {
      "type": "oauth2",
      "flow": "implicit",
      "authorizationUrl": "https://login.windows.net/common/oauth2/authorize",
      "scopes": []
    }
  },
	```

2. Перейдите на [веб-портал][1] PowerApps и добавьте пользовательский API. Необходимые шаги описаны в статье [Что такое пользовательские интерфейсы API](powerapps-register-custom-api.md).

3. После отправки Swagger мастер автоматически определит, что для вашего веб-API используется проверка подлинности AAD.

4. Настройте проверку подлинности AAD для пользовательского API:

  1. Идентификатор клиента: ***идентификатор клиента для webAPI-CustomAPI*** из пункта 4.5 **этапа 2** (в этой статье).
  2. Секрет: ***ключ для webAPI-CustomAPI*** из пункта 4.6 **этапа 2** (в этой статье).
  3. URL-адрес входа: ***https://login.windows.net***.
  4. ResourceUri: ***идентификатор клиента для веб-API*** из пункта 3.4 **этапа 2** (в этой статье).

5. Выберите **Создать** и попробуйте создать подключение в пользовательском интерфейсе API. Если все настроено правильно, то вход должен завершиться успешно.

Более подробное описание действий по созданию PowerApps и логических потоков см. в следующих разделах:

- [Подключение к Office 365, Twitter и Microsoft Translator][5]
- [Отображение данных из Office 365][4]
- [Создание приложения из данных][3]
- [Приступая к работе с логическими потоками][2]

Свои вопросы или комментарии отправляйте по электронной почте [customapishelp@microsoft.com](mailto:customapishelp@microsoft.com).

<!--Reference links in article-->
[1]: https://web.powerapps.com
[2]: https://powerapps.microsoft.com/tutorials/get-started-logic-flow/
[3]: https://powerapps.microsoft.com/tutorials/get-started-create-from-data/
[4]: https://powerapps.microsoft.com/tutorials/show-office-data/
[5]: https://powerapps.microsoft.com/tutorials/powerapps-api-functions/
[6]: http://pwrappssamples.blob.core.windows.net/samples/webAPI.json

<!---HONumber=AcomDC_0713_2016-->