<properties title="Federations Migration" pageTitle="Миграция федераций" description="Outlines the steps to migrate an existing app built with Federations feature to Elastic Scale model." metaKeywords="sharding scaling, federations, Azure SQL DB sharding, Elastic Scale" services="sql-database" documentationCenter=""  manager="jhubbard" authors="sidneyh@microsoft.com"/>

<tags ms.service="sql-database" ms.workload="sql-database" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="sidneyh" />

#Миграция федераций 

Функция федераций баз данных Azure SQL отменяется вместе с веб/бизнес-выпусками в сентябре 2015 г. С этого момента приложения, в которых используются функции федераций, перестанут выполняться. Для выполнения успешной миграции настоятельно рекомендуется как можно быстрее начать действия по переходу, чтобы отвести соответствующее время под планирование и выполнение. В этом документе приводятся контекст, примеры и общие сведения об утилите для миграции федераций, которые наглядно демонстрируют успешный перенос действующего приложения с использованием федераций на [API-интерфейсы Azure SQL DB Elastic Scale предварительной версии](http://go.microsoft.com/?linkid=9862592). Цель документа - продемонстрировать предложенные поэтапные действия по переносу приложения с использованием федераций без перемещения данных.

Есть три основных этапа по переносу существующего приложения с использованием федераций в приложение, которое использует API-интерфейсы Elastic Scale.

1. [Создание диспетчера сопоставлений сегментов из корня федерации] 
2. [Изменение существующего приложения]
3. [Отключение существующих членов федерации]
    

### Инструмент для примера выполнения миграции
Чтобы упростить этот процесс, была создана [Утилита для миграции федераций](http://go.microsoft.com/?linkid=9862613). Утилита выполняет этапы 1 и 3. 

## <a name="create-shard-map-manager"></a>Создание диспетчера сопоставлений сегментов из корня федерации
Первым этапом миграции приложения с использованием федераций является клонирование метаданных корня федерации в конструкции диспетчера сопоставлений сегментов. 

![Clone the federation root to the shard map manager][1]
 
Начните с существующего приложения, использующего федерации в тестовой среде.
 
Используйте **Утилиту для миграции федераций**, чтобы клонировать метаданные корня федераций в конструкции Elastic Scale в [Диспетчере сопоставлений сегментов](http://go.microsoft.com/?linkid=9862595). Как и корень федерации, база данных диспетчера сопоставлений сегментов является автономной базой данных, содержащий сопоставления сегментов (т. е. федерации), ссылки на сегменты (т. е. члены федерации) и сопоставления диапазонов. 

Клонирование корня федерации в диспетчер сопоставлений сегментов - это копирование и трансляция метаданных. Никакие метаданные в корне федерации не изменяются. Обратите внимание, что клонирование корня федерации с помощью утилиты для миграции является одномоментной операцией, поэтому изменения как в корне федерации, так и в сопоставлениях сегментов не будут отражены в другом соответствующем хранилище данных. При внесении изменений в корень федерации во время тестирования новых API-интерфейсов утилиту для миграции можно использовать для обновления сопоставлений сегментов и представления текущего состояния. 

![Migrate the existing app to use the Elastic Scale APIs][2]

## Изменение существующего приложения 

Настроив диспетчер сопоставлений сегментов и зарегистрировав в нем диапазоны и члены федерации (что выполняется с помощью утилиты для миграции), можно изменить существующее приложение с использованием федераций для применения API-интерфейсов Elastic Scale. Как показано на рисунке выше, подключения приложений через API-интерфейсы Elastic Scale будут маршрутизироваться через диспетчер сопоставлений сегментов к соответствующим членам федерации (теперь ставшим сегментами). Сопоставление членов федерации к диспетчеру сопоставлений сегментов позволяет выполнять две версии приложения: в одной используются федерации, а в другой используется эластичное масштабирование, причем для проверки функциональности их можно запустить одновременно.   

Во время миграции приложения в существующее приложение необходимо будет внести два основных изменения.


#### Изменение 1: Создать экземпляр объекта диспетчера сопоставления сегментов (Shard Map Manager): 

В отличие от федераций, API-интерфейсы эластичного масштабирования взаимодействуют с диспетчером сопоставления сегментов при помощи класса **ShardMapManager**. Создание экземпляра объекта **ShardMapManager** и сопоставления сегментов можно выполнить следующим образом:
     
    //Instantiate ShardMapManger Object 
    ShardMapManager shardMapManager = ShardMapManagerFactory.GetSqlShardMapManager(
                            connectionStringSMM, ShardMapManagerLoadPolicy.Lazy); 
    RangeShardMap<T> rangeShardMap = shardMapManager.GetRangeShardMap<T>(shardMapName) 
    
#### Изменение 2: маршрутизировать соединения в соответствующий сегмент 

При использовании федераций подключение к конкретному члену федерации устанавливается с помощью команды USE FEDERATION следующим образом:  

    USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=OFF`

При использовании API-интерфейсов Elastic Scale подключение к конкретному сегменту устанавливается с помощью [маршрутизации на основе данных](./sql-database-elastic-scale-data-dependent-routing.md), при этом используется метод **OpenConnectionForKey** класса **RangeShardMap**. 

    //Connect and issue queries on the shard with key=100 
    using (SqlConnection conn = rangeShardMap.OpenConnectionForKey(100, csb))  
    { 
         using (SqlCommand cmd = new SqlCommand()) 
         { 
            cmd.Connection = conn; 
            cmd.CommandText = "SELECT * FROM customer";
     
            using (SqlDataReader dr = cmd.ExecuteReader()) 
            { 
                  //Perform action on dr 
            } 
        } 
    }

Действия, описанные в этом разделе, являются необходимыми, но они не могут являться решением для всех возможных ситуаций миграции, с которыми могут столкнуться разработчики. Для получения более подробной информации см. раздел [Общее описание технологии эластичного масштабирования (Elastic Scale)](./sql-database-elastic-scale-introduction.md) и [Справочник по API-интерфейсам](http://go.microsoft.com/?linkid=9862604).

## Отключение существующих членов федерации 

![Switch out the federation members for the shards][3]

После того, как программа была изменена с включением в нее API-интерфейсов эластичного масштабирования, последним этапом миграции приложения с использованием федераций является **SWITCH OUT (ОТКЛЮЧЕНИЕ)** членов федерации (для получения дополнительной информации см. справочную документацию MSDN по команде [ALTER FEDERATION (ИЗМЕНИТЬ ФЕДЕРАЦИЮ) (база данных Azure SQL](http://msdn.microsoft.com/ru-ru/library/azure/hh597475.aspx)). Конечным результатом работы команды **SWITCH OUT** в отношении конкретного члена федерации является удаление всех ограничений федерации и метаданных, после чего член федерации становится обычной базой данных SQL Azure, ничем не отличающейся от любой другой базы данных SQL Azure. 

Обратите внимание, что отправка команды **SWITCH OUT** в отношении члена федерации - это односторонняя операция, которую нельзя отменить. После ее выполнения получившуюся базу данных нельзя добавить обратно в федерацию, команды USE FEDERATION (ИСПОЛЬЗОВАТЬ ФЕДЕРАЦИЮ) в отношении этой базы данных больше работать не будут. 

Чтобы выполнить переключение, к команде ALTER FEDERATION был добавлен дополнительный аргумент, чтобы ОТКЛЮЧИТЬ(SWITCH OUT) члена федерации.  Хотя команду можно применить к отдельным членам федерации, утилита для миграции предоставляет возможность программно перебирать всех членов федерации, выполняя операцию переключения для каждого из них. 

После выполнения переключения для всех существующих членов федерации, миграция приложения можно считать завершенной.  
Утилита для миграции федераций предоставляет следующие возможности: 

1.    Клонирование корня федерации в диспетчер сопоставлений сегментов.  Можно выбрать установку существующего диспетчера сопоставления сегментов на новую базу данных Azure SQL (рекомендуется) или на существующую базу данных корня федерации.
2.    Выполните команду SWITCH OUT для всех членов федерации.


##Сравнение возможностей  
Хотя эластичное масштабирование предоставляет множество дополнительных возможностей (например, [многосегментные запросы](./sql-database-elastic-scale-multishard-querying.md), [разделение и объединение сегментов](./sql-database-elastic-scale-overview-split-and-merge.md), [эластичность сегментов](./sql-database-elastic-scale-elasticity.md), [кэширование на стороне клиента ](./sql-database-elastic-scale-shard-map-management.md) и многое другое), существует несколько примечательных особенностей федераций, которые не поддерживаются при эластичном масштабировании.
  

- Использование **FILTERING=ON (ФИЛЬТРАЦИЯ=ВКЛ)**. Эластичное масштабирование в настоящее время не поддерживает фильтрацию на уровне строк. Одним из вариантов решения является встраивание логики фильтрации в запрос, передаваемый в отношении сегмента следующим образом: 

        --Example of USE FEDERATION with FILTERING=ON
        USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=ON 
        SELECT * FROM customer

Дает тот же результат, что и:

        --Example of USE FEDERATION with filtering in the WHERE clause 
        USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=OFF 
        SELECT * FROM customer WHERE CustomerId = 100 

- Функция эластиного масштабирования **Split** не является полностью выполняемой в режиме подключения к сети. Во время операции разбиения на время выполнения перемещения каждый отдельный шардлет (часть данных в сегменте) переводится в автономный режим.
- Функция разбиения требует подготовки базы данных и управления схемой вручную.

## Дополнительные замечания

* Поддержка работы как веб-версии, так и бизнес-версии, а также поддержка Федераций будет прекращена осенью 2015 г.  В рамках миграции приложения использующего федерации настоятельно рекомендуется выполнить тестирование производительности на Базовой, Стандартной и Премиум версиях. 

* Выполнение оператора SWITCH OUT в отношении члена федерации дает возможность получаемой базе данных пользоваться преимуществами всех функций базы данных Azure SQL (т. е. новыми версиями, резервным копированием, PITR, аудитом и т. д.) 

[AZURE.INCLUDE [elastic-scale-include](../includes/elastic-scale-include.md)]

<!--Anchors-->
[Создание диспетчера сопоставлений сегментов из корня федерации]:#create-shard-map-manager
[Изменение существующего приложения]:#Modify-the-Existing-Application
[Отключение существующих членов федерации]:#Switch-Out-Existing-Federation-members


<!--Image references-->
[1]: ./media/sql-database-elastic-scale-federation-migration/migrate-1.png
[2]: ./media/sql-database-elastic-scale-federation-migration/migrate-2.png
[3]: ./media/sql-database-elastic-scale-federation-migration/migrate-3.png
