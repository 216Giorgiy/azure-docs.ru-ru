<properties 
	pageTitle="Миграция федераций" 
	description="В этой статье описана процедура миграции существующего приложения, созданного с использованием функции федераций, в модель эластичного масштабирования." 
	services="sql-database" 
	documentationCenter="" 
	manager="stuartozer" 
	authors="Joseidz" 
	editor=""/>

<tags 
	ms.service="sql-database" 
	ms.workload="sql-database" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="02/16/2015" 
	ms.author="Joseidz@microsoft.com"/>

#Миграция федераций 

В сентябре 2015 года функция федераций баз данных SQL Azure и выпуски Web Edition и Business Edition станут недоступны. После этого приложения, использующие функцию федераций, станут неработоспособными. Чтобы миграция прошла удачно, начните ее как можно раньше Это позволит спланировать и выполнить ее должным образом. В этом документе приводятся контекст, примеры и общая информация о программе миграции федераций, которые наглядно демонстрируют успешный перенос действующего приложения с использованием федераций в [API-интерфейсы предварительной версии эластичного масштабирования базы данных SQL Azure](http://go.microsoft.com/?linkid=9862592). В этом документе описана рекомендуемая процедура миграции приложения с функцией федераций без перемещения данных.

Миграция такого приложения на платформу API для эластичного масштабирования состоит из трех основных этапов.

1. [Создание диспетчера сопоставления сегментов из корня федерации.]
2. [Изменение существующего приложения.]
3. [Отключение существующих элементов федерации.]
    

### Образец инструмента для миграции
Чтобы упростить этот процесс, была создана [программа миграции федераций](http://go.microsoft.com/?linkid=9862613). Она позволяет выполнить шаги 1 и 3. 

## <a name="create-shard-map-manager"></a>Создание диспетчера сопоставления сегментов из корня федерации
Первый шаг миграции приложения с функцией федераций предусматривает клонирование метаданных корня федерации в конструкции диспетчера сопоставления сегментов. 

![Clone the federation root to the shard map manager][1]
 
Запустите существующее приложение с функцией федераций в тестовой среде.
 
Используйте **программу миграции федераций**, чтобы клонировать метаданные корня федераций в конструкциях [диспетчера сопоставления сегментов эластичного масштабирования](http://go.microsoft.com/?linkid=9862595). Как и корень федерации, база данных диспетчера сопоставления сегментов является автономной базой данных, содержащий сопоставления сегментов (т. е. федерации), ссылки на сегменты (т. е. элементы федерации) и сопоставления диапазонов. 

Клонирование корня Федерации в диспетчер сопоставления сегментов - это сочетание копирования и преобразования метаданных. В корне федерации метаданные не меняются. Обратите внимание, что клонирование корня федерации с помощью служебной программы миграции федераций - это операция, выполняемая на определенный момент времени, и любые изменения в корне федерации или сопоставлениях сегментов не будут отражены в другом соответствующем хранилище данных. В случае внесения изменений в корень федерации во время тестирования новых API состояние сопоставления сегментов можно обновить с помощью программы миграции федераций. 

![Migrate the existing app to use the Elastic Scale APIs][2]

## Изменить существующее приложение 

При наличии диспетчера сопоставления сегментов элементов федераций и зарегистрированных с помощью этого диспетчера диапазонов (регистрация осуществляется с помощью служебной программы миграции) параметры существующего приложения с функцией федераций можно изменить таким образом, чтобы в нем использовались API для эластичного масштабирования. Как показано на рисунке выше, маршруты подключений к приложению через API для эластичного масштабирования будут проходить через диспетчер сопоставления сегментов к соответствующим элементам федерации (а теперь также к сегментам). Сопоставление элементов федерации с диспетчером сопоставления сегментов позволяет параллельно использовать две версии приложения. Одна из них использует федерации, а другая - эластичное масштабирование. Обе они выполняются параллельно для проверки функциональности.   

Во время миграции в существующее приложение необходимо внести два основных изменения.


#### Измените 1: Создание экземпляра объекта диспетчера сопоставления сегментов 

В отличие от федераций, API для эластичного масштабирования взаимодействуют с диспетчером сопоставления сегментов через класс **ShardMapManager**. Экземпляр объекта **ShardMapManager** и сопоставления сегментов можно создать вот так:
     
    //Instantiate ShardMapManger Object 
    ShardMapManager shardMapManager = ShardMapManagerFactory.GetSqlShardMapManager(
                            connectionStringSMM, ShardMapManagerLoadPolicy.Lazy); 
    RangeShardMap<T> rangeShardMap = shardMapManager.GetRangeShardMap<T>(shardMapName) 
    
#### Измените 2: Маршрутизация подключений к соответствующим сегментам 

При использовании федераций подключение устанавливается к конкретному элементу федерации с помощью команды USE FEDERATION следующим образом:  

    USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=OFF`

При использовании API для эластичного масштабирования подключение устанавливается к конкретному сегменту с помощью [зависящей от данных маршрутизации](sql-database-elastic-scale-data-dependent-routing.md) с применением метода **OpenConnectionForKey** для класса **RangeShardMap**. 

    //Connect and issue queries on the shard with key=100 
    using (SqlConnection conn = rangeShardMap.OpenConnectionForKey(100, csb))  
    { 
         using (SqlCommand cmd = new SqlCommand()) 
         { 
            cmd.Connection = conn; 
            cmd.CommandText = "SELECT * FROM customer";
     
            using (SqlDataReader dr = cmd.ExecuteReader()) 
            { 
                  //Perform action on dr 
            } 
        } 
    }

Все шаги, описанные в этом разделе, обязательны, но они могут подходить не для всех сценариев миграции. Дополнительную информацию см. в [обзоре принципов использования технологии эластичного масштабирования](sql-database-elastic-scale-introduction.md) и [справочнике по API](http://go.microsoft.com/?linkid=9862604).

## Отключение существующих элементов федерации 

![Switch out the federation members for the shards][3]

После изменения приложения и включения в него API для эластичного масштабирования для завершения миграции приложения с функцией федераций остается выполнить команду **SWITCH OUT** для элементов федераций (дополнительную информацию см. в справочнике MSDN для [ALTER FEDERATION (Azure SQL Database](http://msdn.microsoft.com/library/dn269988(v=sql.120).aspx)). В конечном итоге после выполнения команды **SWITCH OUT** для конкретного элемента федерации будут удалены все ограничения для федераций, а его метаданные, по которым элемент федерации обрабатывается как обычная база данных SQL Azure, ничем не будут отличаться от метаданных любой другой базы данных SQL Azure.  

Обратите внимание, что выполнение команды **SWITCH OUT** для элемента федерации - необратимая операция и ее нельзя отменить. После выполнения этой команды для базы данных невозможно восстановить поддержку федераций и выполнить команду USE FEDERATION. 

Чтобы выполнить переключение, в команду ALTER FEDERATION был добавлен дополнительный аргумент, который позволяет выполнить команду SWITCH OUT для элемента федерации.  Эту команду можно выполнять только для отдельных элементов федерации, но в служебной программе миграции федераций предусмотрены функциональные возможности для программной итерации по всем элементам федерации и выполнения операции переключения. 

После переключения всех существующих элементов федерации миграция приложения будет завершена.  
Служебная программа миграции федераций предоставляет ряд возможностей. 

1.    Клонирование корня федерации в диспетчер сопоставления сегментов.  Существующий диспетчер сопоставления сегментов можно разместить в новой базе данных SQL Azure(рекомендуется) или в существующей базе данных корня федерации.
2.    Выполнение команды SWITCH OUT для всех элементов федерации.


##Сравнение возможностей  
Несмотря на то, что технология эластичного масштабирования предоставляет множество дополнительных возможностей (например, [многосегментное формирование запросов](sql-database-elastic-scale-multishard-querying.md), [разделение и слияние сегментов](sql-database-elastic-scale-overview-split-and-merge.md), [эластичность сегментов](sql-database-elastic-scale-elasticity.md), [кэширование на стороне клиента](sql-database-elastic-scale-shard-map-management.md)и многие другие), она не поддерживает некоторые важные возможности федераций.
  

- Использование **FILTERING=ON**. Сейчас эластичное масштабирование не поддерживает фильтрацию на уровне строк. Отчасти эту проблему можно решить, построив логику фильтрации в запросе, который отправляется для сегмента. Вот как это можно сделать: 

        --Example of USE FEDERATION with FILTERING=ON
        USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=ON 
        SELECT * FROM customer

Такой же результат можно получить так:

        --Example of USE FEDERATION with filtering in the WHERE clause 
        USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=OFF 
        SELECT * FROM customer WHERE CustomerId = 100 

- Отсутствие полноценной поддержки подключения к сети при **разделении сегментов** при эластичном масштабировании. При выполнении этой операции каждый отдельный шардлет во время перемещения переходит в состояние "Не готов".
- Чтобы использовать функцию разделения сегментов при эластичном масштабировании, подготовку базы данных и управление схемой необходимо выполнять вручную.

## Дополнительные вопросы

* Осенью 2015 года прекратится поддержка федераций, а также выпусков Business Edition и Web Edition.  Настоятельно рекомендуем во время миграции приложений с функцией федераций протестировать их производительность в выпусках Basic, Standard и Premium. 

* После выполнения инструкции SWITCH OUT для элемента федерации результирующая база данных будут поддерживать все возможностей базы данных SQL Azure (т. е. новые издания, резервное копирование, восстановление на определенный момент времени, аудит и т. п.) 

[AZURE.INCLUDE [elastic-scale-include](../includes/elastic-scale-include.md)]

<!--Anchors-->
[Создание диспетчера сопоставления сегментов из корня федерации.]:#create-shard-map-manager
[Изменение существующего приложения.]:#Modify-the-Existing-Application
[Отключение существующих элементов федерации.]:#Switch-Out-Existing-Federation-members


<!--Image references-->
[1]: ./media/sql-database-elastic-scale-federation-migration/migrate-1.png
[2]: ./media/sql-database-elastic-scale-federation-migration/migrate-2.png
[3]: ./media/sql-database-elastic-scale-federation-migration/migrate-3.png

<!--HONumber=47-->
