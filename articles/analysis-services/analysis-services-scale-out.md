---
title: Горизонтальное масштабирование служб Azure Analysis Services | Документация Майкрософт
description: Репликация серверов Azure Analysis Services с помощью горизонтального масштабирования.
author: minewiskan
manager: kfile
ms.service: azure-analysis-services
ms.topic: conceptual
ms.date: 01/09/2019
ms.author: owend
ms.reviewer: minewiskan
ms.openlocfilehash: 775de554f39df8359c3852a2d7fa876fd12199d2
ms.sourcegitcommit: 63b996e9dc7cade181e83e13046a5006b275638d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/10/2019
ms.locfileid: "54190851"
---
# <a name="azure-analysis-services-scale-out"></a>Горизонтальное масштабирование служб Azure Analysis Services

С помощью горизонтального масштабирования клиентские запросы можно распределить между несколькими *репликами запросов* в пуле запросов, уменьшив время отклика при рабочих нагрузках с большим числом запросов. Операции обработки могут выполняться отдельно от пула запросов, чтобы эти операции не оказывали отрицательного влияния на клиентские запросы. Горизонтальное масштабирование можно настроить на портале Azure или с помощью REST API служб Analysis Services.

## <a name="how-it-works"></a>Принцип работы

В обычном развертывании сервера один сервер выступает в роли сервера обработки и сервера запросов. Если количество клиентских запросов к моделям на сервере превышает число единиц обработки запросов (QPU) в плане сервера или обработка модели производится во время выполнения рабочей нагрузки с большим числом запросов, это может привести к снижению производительности. 

Благодаря функции горизонтального масштабирования вы можете создать пул запросов, который содержит до семи дополнительных ресурсов реплик запросов (всего восемь, включая сервер). Можно масштабировать число реплик запросов, чтобы удовлетворять требования к QPU в критические моменты времени, и в любое время можно отделить сервер обработки от пула запросов. Все реплики запроса создаются в том же регионе, что и сервер.

Независимо от числа реплик запросов, имеющихся в пуле запросов, обработка рабочих нагрузок не распределяется между репликами запросов. Один сервер выступает в качестве сервера обработки. Реплики запросов обслуживают только запросы к моделям, синхронизируемым между всеми репликами запросов в пуле запросов. 

При увеличении масштаба новые реплики запросов добавляются в пул запросов постепенно. Добавление новых ресурсов реплики запросов в пул может занять до пяти минут. После запуска всех новых реплик запросов новые клиентские подключения будут распределены по всех ресурсах пула запросов. Имеющиеся клиентские подключения останутся в пуле, к которому они в настоящее время подключены.  При свертывании любые имеющиеся клиентские подключения к ресурсу пула запросов, которые удаляются из пула, завершаются. Они снова подключаются к оставшемуся ресурсу пула запросов при завершении операции свертывания. На это может потребоваться до пяти минут.

При обработке моделей после завершения операций необходимо выполнить синхронизацию сервера обработки и реплик запросов. При автоматизации операций обработки важно настроить синхронизацию после их успешного завершения. Синхронизацию можно выполнить вручную на портале или с помощью PowerShell либо REST API. 

### <a name="separate-processing-from-query-pool"></a>Отделение обработки от пула запросов

Чтобы достичь максимальной производительности во время выполнения операций обработки и запросов, отделите сервер обработки от пула запросов. При отделении имеющиеся и новые клиентские подключения назначаются репликам запросов только в пуле запросов. Если для операций обработки требуется лишь короткий промежуток времени, вы можете отделить сервер обработки от пула запросов только на время, затрачиваемое на выполнение операций обработки и синхронизации, а затем снова включить его в пул запросов. 

> [!NOTE]
> Горизонтальное масштабирование доступно для серверов в ценовой категории "Стандартный". Каждая реплика запросов оплачивается по той же ставке, что и сервер.

> [!NOTE]
> Горизонтальное масштабирование не увеличивает объем доступной памяти сервера. Чтобы увеличить объем памяти, необходимо изменить план.

## <a name="region-limits"></a>Региональные пределы

Число реплик запросов, которые вы можете настроить, ограничено регионом, в котором находится ваш сервер. Дополнительные сведения см. в разделе [Доступность по регионам](analysis-services-overview.md#availability-by-region).

## <a name="monitor-qpu-usage"></a>Мониторинг использования QPU

 Чтобы определить, требуется ли горизонтальное масштабирование для вашего сервера, можно отслеживать его работу с помощью метрик на портале Azure. Регулярно используется максимальное число QPU, это означает, что количество запросов к моделям превышает квоту QPU для плана. Значение метрики длины очереди заданий для пула запросов также увеличивается, когда количество запросов в очереди пула потока запросов превышает доступную квоту QPU. Чтобы узнать больше, ознакомьтесь с [отслеживанием метрик сервера](analysis-services-monitor.md).

## <a name="configure-scale-out"></a>Настройка горизонтального масштабирования

### <a name="in-azure-portal"></a>На портале Azure

1. На портале щелкните **Масштабируемый**. Используйте ползунок, чтобы выбрать количество серверов-реплик запросов. Число выбранных реплик помимо существующего сервера.

2. В разделе **Отделить сервер обработки от пула запросов** выберите "Да", чтобы отделить сервер обработки от серверов запросов. Подключения клиентов с помощью строки подключения по умолчанию (без: rw) будут перенаправляться к репликам в пуле запросов. 

   ![Ползунок горизонтального масштабирования](media/analysis-services-scale-out/aas-scale-out-slider.png)

3. Нажмите кнопку **Сохранить**, чтобы подготовить новые серверы-реплики запросов. 

Табличные модели на сервере-источнике синхронизируются с серверами-репликами. После завершения синхронизации пул запросов начинает распределять входящие запросы между серверами-репликами. 

## <a name="synchronization"></a>Синхронизация 

При подготовке новых реплик запросов службы Azure Analysis Services автоматически реплицируют модели во всех репликах. Можно также выполнить синхронизацию вручную с помощью портала или REST API. При обработке моделей следует выполнять синхронизацию, чтобы обновления синхронизировались между репликами запросов.

### <a name="in-azure-portal"></a>На портале Azure

Выберите **Обзор** > модель > **Синхронизировать модель**.

![Ползунок горизонтального масштабирования](media/analysis-services-scale-out/aas-scale-out-sync.png)

### <a name="rest-api"></a>REST API

Используйте операцию **sync**.

#### <a name="synchronize-a-model"></a>Синхронизация модели:   

`POST https://<region>.asazure.windows.net/servers/<servername>:rw/models/<modelname>/sync`

#### <a name="get-sync-status"></a>Получение состояния синхронизации  

`GET https://<region>.asazure.windows.net/servers/<servername>/models/<modelname>/sync`

### <a name="powershell"></a>PowerShell

Перед использованием PowerShell [установите модуль AzureRM или обновите его до последней версии](https://github.com/Azure/azure-powershell/releases). 

Чтобы задать число реплик запросов, используйте [Set-AzureRmAnalysisServicesServer](https://docs.microsoft.com/powershell/module/azurerm.analysisservices/set-azurermanalysisservicesserver). Укажите необязательный параметр `-ReadonlyReplicaCount`.

Чтобы запустить синхронизацию, используйте командлет [Sync-AzureAnalysisServicesInstance](https://docs.microsoft.com/powershell/module/azurerm.analysisservices/sync-azureanalysisservicesinstance).

## <a name="connections"></a>Подключения

На странице "Обзор" вашего сервера указаны два имени сервера. Если вы еще не настроили горизонтальное масштабирование для сервера, оба его имени работают одинаково. После настройки горизонтального масштабирования для сервера нужно указать соответствующее имя сервера в зависимости от типа подключения. 

Для таких клиентских подключений пользователей, как Power BI Desktop, Excel и настраиваемые приложения, используйте **имя сервера**. 

Для SSMS, SSDT, строк подключения в PowerShell, приложений службы "Функции Azure" и AMO используйте **имя сервера управления**. Имя сервера управления содержит специальный квалификатор `:rw` (чтение и запись). Все операции обработки выполняются на сервере управления.

![имена серверов;](media/analysis-services-scale-out/aas-scale-out-name.png)

## <a name="troubleshoot"></a>Устранение неполадок

**Проблема.** У пользователей возникает ошибка **Не удается найти экземпляр сервера "\<имя сервера>" в режиме соединения ReadOnly.**

**Решение.** При выборе варианта **Отделить сервер обработки от пула запросов** подключения клиентов с помощью строки подключения по умолчанию (без: rw) будут перенаправляться в реплики пула запросов. Если реплики в пуле запросов еще не подключены, так как синхронизация еще не завершена, возможен сбой перенаправления клиентских подключений. Чтобы предотвратить неудачные попытки подключения, не отделяйте сервер обработки от пула запросов до завершения горизонтального масштабирования и синхронизации. Вы можете использовать метрики памяти и QPU для проверки состояния синхронизации.

## <a name="related-information"></a>Связанные сведения

[Мониторинг метрик сервера](analysis-services-monitor.md)   
[Управление службами Azure Analysis Services](analysis-services-manage.md) 

