---
title: "Устранение проблем с производительностью базы данных SQL Azure с помощью Intelligent Insights | Документация Майкрософт"
description: "Intelligent Insights помогает устранять проблемы с производительностью базы данных SQL Azure."
services: sql-database
documentationcenter: 
author: danimir
manager: drasumic
editor: carlrab
ms.assetid: 
ms.service: sql-database
ms.custom: monitor & tune
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: NA
ms.date: 09/25/2017
ms.author: v-daljep
ms.translationtype: HT
ms.sourcegitcommit: c3a2462b4ce4e1410a670624bcbcec26fd51b811
ms.openlocfilehash: edd8c526a681c9cd5226ede6110f21c3362aaef6
ms.contentlocale: ru-ru
ms.lasthandoff: 09/25/2017

---
# <a name="troubleshoot-azure-sql-database-performance-issues-with-intelligent-insights"></a>Устранение проблем с производительностью базы данных SQL Azure с помощью Intelligent Insights

Эта страница содержит сведения о проблемах производительности базы данных SQL Azure, которые можно обнаружить с помощью журнала диагностики производительности базы данных [Intelligent Insights](sql-database-intelligent-insights.md). Этот журнал диагностики можно отправить в [Azure Log Analytics](../log-analytics/log-analytics-azure-sql.md), [концентратор событий Azure](../monitoring-and-diagnostics/monitoring-stream-diagnostic-logs-to-event-hubs.md), [службу хранилища Azure](sql-database-metrics-diag-logging.md#stream-into-azure-storage) или стороннее решение для разработки настраиваемых функций оповещения и создания отчетов в соответствии с процедурами DevOps.

> [!NOTE]
> Краткие инструкции по устранению неполадок производительности базы данных SQL Azure приведены на блок-схеме [рекомендуемой процедуры устранения неполадок](sql-database-intelligent-insights-troubleshoot-performance.md#recommended-troubleshooting-flow) в этом документе.
>

## <a name="detectable-database-performance-patterns"></a>Выявляемые шаблоны снижения производительности базы данных

Intelligent Insights автоматически выявляет проблемы с производительностью базы данных SQL Azure, исходя из времени ожидания выполнения запросов, ошибок и значений времени ожидания, и заносит обнаруженные шаблоны снижения производительности в журнал диагностики. Ниже в таблице кратко описаны выявляемые шаблоны снижения производительности.

| Выявляемые шаблоны снижения производительности | Выводимые сведения |
| :------------------- | ------------------- |
| [Достижение лимитов ресурсов](sql-database-intelligent-insights-troubleshoot-performance.md#reaching-resource-limits) | Достигнут лимит доступных ресурсов (DTU), рабочих потоков базы данных или сеансов входа в базу данных для отслеживаемой подписки, что вызывает проблемы с производительностью базы данных SQL Azure. |
| [Увеличение рабочей нагрузки](sql-database-intelligent-insights-troubleshoot-performance.md#workload-increase) | Обнаружено увеличение рабочей нагрузки или непрерывные накопление рабочей нагрузки для базы данных, что вызывает проблемы с производительностью базы данных SQL Azure. |
| [Нехватка памяти](sql-database-intelligent-insights-troubleshoot-performance.md#memory-pressure) | Рабочие роли, запрашивающие временно предоставляемый буфер памяти, ожидают выделение памяти статистически значимое количество времени, или накоплено повышенное количество рабочих ролей, запрашивающих временно предоставляемый буфер памяти, что негативно влияет на производительность базы данных SQL Azure. |
| [Блокировка](sql-database-intelligent-insights-troubleshoot-performance.md#locking) | Обнаружена чрезмерная блокировка базы данных, что негативно влияет на производительность базы данных SQL Azure. |
| [Повышенное значение MAXDOP](sql-database-intelligent-insights-troubleshoot-performance.md#increased-maxdop) | Значение параметра максимальной степени параллелизма (MAXDOP) было изменено, и это влияет на эффективность выполнения запросов.  |
| [Состязание за кратковременную блокировку страниц](sql-database-intelligent-insights-troubleshoot-performance.md#pagelatch-contention) | Обнаружено состязание за кратковременную блокировку страниц, что негативно влияет на производительность базы данных SQL Azure. Несколько потоков одновременно пытаются обратиться к одним и тем же страницам в буфере данных в памяти, что приводит к увеличению времени ожидания и негативно влияет на производительность базы данных Azure SQL. |
| [Отсутствующий индекс](sql-database-intelligent-insights-troubleshoot-performance.md#missing-index) | Обнаружен отсутствующий индекс, что негативно влияет на производительность базы данных SQL Azure. |
| [Новый запрос](sql-database-intelligent-insights-troubleshoot-performance.md#new-query) | Обнаружен новый запрос, который влияет на общую производительность базы данных SQL Azure.  |
| [Необычная статистика ожидания](sql-database-intelligent-insights-troubleshoot-performance.md#unusual-wait-statistic) | Обнаружены необычные значения времени ожидания базы данных, влияющие на производительность базы данных SQL Azure. |
| [Состязание за tempdb](sql-database-intelligent-insights-troubleshoot-performance.md#tempdb-contention) | Несколько потоков пытается получить доступ к одним и тем же ресурсам TempDB, создавая узкое место и негативно влияя на производительность базы данных SQL Azure. |
| [Нехватка DTU эластичного пула](sql-database-intelligent-insights-troubleshoot-performance.md#elastic-pool-dtu-shortage) | Нехватка доступных Edtu эластичном пуле негативно влияет на производительность базы данных SQL Azure. |
| [Снижение эффективности плана](sql-database-intelligent-insights-troubleshoot-performance.md#plan-regression) | Обнаружен новый план или изменение рабочей нагрузки существующего плана, что негативно влияет на производительность базы данных SQL Azure. |
| [Изменение значения конфигурации уровня базы данных](sql-database-intelligent-insights-troubleshoot-performance.md#database-scoped-configuration-value-change) | Изменение конфигурации базы данных влияет на производительность базы данных SQL Azure. |
| [Медленная работа клиента](sql-database-intelligent-insights-troubleshoot-performance.md#slow-client) | Обнаружен медленный клиент приложения, не способный достаточно быстро потреблять выходные данные из базы данных SQL Azure, что негативно влияет на производительность базы данных SQL Azure. |
| [Переход на более низкую ценовую категорию](sql-database-intelligent-insights-troubleshoot-performance.md#pricing-tier-downgrade) | Действие понижения ценовой категории уменьшило объем доступных ресурсов, что негативно влияет на производительность базы данных SQL Azure. |

> [!TIP]
> Чтобы непрерывно оптимизировать производительность базы данных SQL Azure, можно включить [автоматическую настройку базы данных SQL Azure](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-automatic-tuning). Это уникальная функция встроенного аналитического механизма SQL Azure, который постоянно отслеживает базу данных SQL Azure и автоматически настраивает индексы и применяет исправления к плану выполнения запросов.
>

В следующем разделе более подробно описаны перечисленные выше выявляемые шаблоны снижения производительности.

## <a name="reaching-resource-limits"></a>Достижение лимитов ресурсов

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности объединяет проблемы производительности, связанные с достижением лимитов доступных ресурсов, рабочих ролей и сеансов. После обнаружения этой проблемы с производительностью в поле описания журнала диагностики указывается, связана ли она с лимитами ресурсов, рабочих ролей или сеансов.

Под ресурсами в базе данных SQL Azure обычно понимаются [ресурсы DTU](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-what-is-a-dtu), состоящие из сочетания ресурсов ЦП и ввода-вывода (ввод-вывод данных и журнала транзакций). Шаблон достижения лимитов ресурсов обнаруживается, когда причиной выявленного снижения производительности обработки запросов является достижение лимитов измеряемого ресурса.

Лимит ресурсов сеанса означает число доступных параллельных операций входа в базу данных SQL Azure. Этот шаблон снижения производительности распознается в случае, когда приложения, подключающиеся к базам данных SQL Azure, достигают числа доступных параллельных операций входа в базу данных. В случае, если приложения пытаются использовать больше сеансов, чем позволяет база данных, производительность обработки запросов снижается.

Достижение лимита рабочих ролей — это частный случай достижения лимитов ресурсов, так как доступные рабочие роли не учитываются при использовании DTU. Достижение лимитов рабочих ролей для базы данных может привести к увеличению времени ожидания ресурсов и, следовательно, понизить производительность обработки запросов.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики генерирует хэши запросов, которые повлияли на производительность и процент потребления ресурсов. Эти сведения можно использовать в качестве отправной точки для оптимизации рабочей нагрузки базы данных. В частности, можно рассмотреть возможность оптимизации запросов, приводящих к снижению производительности, путем добавления индексов, или рассмотреть возможность оптимизации приложений за счет более равномерного распределения рабочей нагрузки. Если не удалось уменьшить рабочую нагрузку или применить оптимизацию, возможно, следует рассмотреть возможность повышения ценовой категории подписки базы данных SQL Azure, чтобы увеличить объем доступных ресурсов.

При достижении лимитов доступных сеансов можно оптимизировать приложения, уменьшив количество имен для входа в базу данных. Если не удалось уменьшить количество имен для входа приложений для базы данных, можно попробовать повысить ценовую категорию базы данных или, возможно, разделить базу данных на несколько баз данных, чтобы обеспечить более сбалансированное распределение рабочей нагрузки.

Дополнительные предложения по устранению проблем с лимитами сеансов см. в разделе [How to deal with the limits of Azure SQL Database maximum logins](https://blogs.technet.microsoft.com/latam/2015/06/01/how-to-deal-with-the-limits-of-azure-sql-database-maximum-logins/) (Устранение проблем с ограничениями максимального числа операций входа в базу данных SQL Azure). Чтобы узнать лимиты доступных ресурсов для своего уровня подписки, ознакомьтесь с разделом [Ограничения ресурсов базы данных SQL Azure](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-resource-limits).

## <a name="workload-increase"></a>Увеличение рабочей нагрузки

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности позволяет выявить проблемы из-за увеличения рабочей нагрузки или, если ситуация серьезнее, из-за накопления рабочей нагрузки.

Для обнаружения используется сочетание нескольких метрик. Основные измеряемые метрики позволяют обнаружить увеличение рабочей нагрузки по сравнению с предыдущими базовыми показателями рабочей нагрузки. Также для обнаружения используется измерение значительного увеличения числа рабочих потоков, которое достаточно для того, чтобы негативно повлиять на производительность запросов.

В более серьезной ситуации рабочая нагрузка постоянно накапливается из-за того, что база данных SQL Azure не справляется с ее обработкой. В результате размер рабочей нагрузки постоянно растет, то есть возникает ее накопление. В этой ситуации время, которое рабочая нагрузка ожидает выполнения, увеличивается, и это одна из наиболее серьезных проблем с производительностью базы данных. Данная проблема выявляется за счет мониторинга увеличения числа прерванных рабочих потоков. 

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит число запросов, время выполнения которых увеличилось, и хэш запросов, составляющих наибольшую часть рабочей нагрузки. Эти сведения можно использовать в качестве отправной точки для оптимизации рабочей нагрузки, в частности, определенного запроса, который больше остальных повлиял на увеличение рабочей нагрузки.

Можно также рассмотреть возможность более равномерного распределения рабочих нагрузок в базе данных. Кроме того, можно рассмотреть возможность оптимизации запроса, негативно влияющего на производительность, и добавление индексов. Еще один возможный подход к решению проблемы — распределение рабочей нагрузки между несколькими базами данных. Если это невозможно, то вы можете рассмотреть возможность повышения ценовой категории подписки базы данных SQL Azure, чтобы увеличить объем доступных ресурсов.

## <a name="memory-pressure"></a>Нехватка памяти

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение текущей производительности базы данных из-за нехватки памяти или, если ситуация более серьезная, из-за накопления запросов на выделение памяти по сравнению с базовыми показателями производительности за последние 7 дней.

Нехватка памяти означает состояние производительности, в котором большое количество рабочих потоков запрашивает временно предоставляемый буфер памяти в базе данных SQL Azure. Это приводит к использованию большого объема памяти. В данной ситуации база данных SQL Azure не может эффективно выделить память для всех запрашивающих ее рабочих процессов. С одной стороны, одна из наиболее распространенных причин этой проблемы связана с объемом памяти для базы данных SQL Azure, а с другой стороны — с увеличением рабочей нагрузки, приводящим к увеличению числа рабочих потоков и нехватке памяти.

В более серьезной ситуации нехватки памяти запросы на выделение памяти накапливаются. Это признак того, что число рабочих потоков, запрашивающих временно предоставляемый буфер памяти, превышает число запросов, освобождающих память. Данное число рабочих потоков, запрашивающих временно предоставляемый буфер памяти, может также постоянно увеличиваться (то есть накапливаться) из-за того, что ядру не удается эффективно выделять память для удовлетворения этих потребностей. Накопление запросов на выделение памяти представляет собой одну из наиболее серьезных проблем с производительностью базы данных.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения о хранении объектов в памяти, включая клерк (то есть рабочий поток), который помечен как основная причина использования большого объема памяти, и соответствующие метки времени. Эта информация может использоваться в качестве основы для устранения неполадок. 

Можно рассмотреть возможность оптимизации или удаления запросов, связанных с клерками с наибольшим использованием памяти. Можно также устранить запросы к данным, которые не планируется использовать. Рекомендуется всегда использовать в запросах предложение WHERE. Кроме того, рекомендуется создавать некластеризованные индексы для поиска данных, а не выполнять сканирование данных.

Можно также рассмотреть возможность уменьшения рабочей нагрузки за счет ее оптимизации или распределения по нескольким базам данных. Еще один возможный подход к решению проблемы — распределение рабочей нагрузки между несколькими базами данных. Если это невозможно, то вы можете рассмотреть возможность повышения ценовой категории подписки базы данных SQL Azure, чтобы увеличить объем доступных ресурсов памяти для базы данных.

Дополнительные рекомендации по устранению неполадок см. в разделе [Memory Grants Meditation: The mysterious SQL Server memory consumer with Many Names](https://blogs.msdn.microsoft.com/sqlmeditation/2013/01/01/memory-meditation-the-mysterious-sql-server-memory-consumer-with-many-names/) (Устранение проблем с памятью: загадочный потребитель памяти SQL Server со множеством имен).

## <a name="locking"></a>Блокировка

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение производительности текущей базы данных, при котором была выявлена чрезмерная блокировка базы данных по сравнению базовыми показателями производительности за последние 7 дней. 

В современных реляционных СУБД блокировка необходима для реализации многопоточных систем, в которых максимальная производительность достигается благодаря выполнению нескольких одновременных рабочих процессов и параллельных транзакций базы данных, где это возможно. Проще говоря, блокировка в этом контексте означает встроенный механизм доступа, при котором только одна транзакция может иметь монопольный доступ к необходимым строкам, страницам, таблицам и файлам, не состязаясь за ресурсы с другой транзакцией. После того, как транзакция, заблокировавшая ресурсы, завершает их использование, их блокировка снимается, и они становятся доступны другим транзакциям. Дополнительные сведения о блокировке см. в разделе [Блокировка в компоненте Database Engine](https://msdn.microsoft.com/library/ms190615.aspx).

В случае, если транзакции, выполняемые ядром SQL, в течение длительного времени ожидают доступа к заблокированным ресурсам, снижается производительность выполнения рабочей нагрузки. 

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения о блокировке, которые могут использоваться в качестве основы для устранения неполадок. Может потребоваться проанализировать блокирующие запросы из отчетов, то есть запросы, блокирующие ресурсы и снижающие производительность, и удалить их. В некоторых случаях возможна успешная оптимизация блокирующих запросов.
Наиболее простой и безопасный способ устранения проблемы — ограничение объема транзакций и сокращение объема блокируемых ресурсов для наиболее ресурсоемких запросов. Попробуйте разделить большой пакет операций на небольшие операции. Рекомендуется сократить объем блокируемых запросом ресурсов, максимально повысив его эффективность. Рассмотрите возможность сокращения крупных операций сканирования, так как они повышают вероятность возникновения взаимоблокировок и отрицательно влияют на общую производительность базы данных. Для выявленных запросов, которые вызывают блокировку, можно создать новые индексы или добавить столбцы в существующий индекс, чтобы избежать сканирования таблиц. Дополнительные рекомендации приведены в разделе [Как решить проблемы с блокировками, вызванные экскалацией блокировок в SQL Server](https://support.microsoft.com/en-us/help/323630/how-to-resolve-blocking-problems-that-are-caused-by-lock-escalation-in).

## <a name="increased-maxdop"></a>Повышенное значение MAXDOP

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает ситуацию, в которой выбранный план выполнения запроса распараллелен больше, чем следует. Оптимизатор запросов базы данных SQL Azure повышает производительность рабочей нагрузки, принимая решения о параллельном выполнении запросов, чтобы максимально ускорить обработку, где это возможно. Тем не менее, в некоторых случаях параллельная обработка запросов рабочими ролями требует больше времени на ожидание друг друга для синхронизации и объединения результатов по сравнению с выполнением того же запроса с меньшим распараллеливанием рабочих ролей, а в некоторых случаях — при его выполнении отдельным рабочим потоком.

Экспертная система анализирует текущую производительность базы данных по сравнению с базовым периодом и определяет, если выполненный ранее запрос выполняется медленнее, чем раньше, из-за большего распараллеливания плана выполнения запросов, чем это необходимо.

Параметр конфигурации сервера MAXDOP для базы данных SQL Azure позволяет указать, сколько ядер ЦП может использоваться для выполнения запроса в параллельном режиме. 

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит хэши запросов, время выполнения которых увеличилось из-за чрезмерного распараллеливания. Журнал также содержит значения времени ожидания CXP. Это время, которое отдельный поток организатора или координатора (поток 0) ожидает завершения выполнения всех остальных потоков перед объединением результатов и переходом к следующей операции. Кроме того, журнал диагностики содержит общее время ожидания выполнения для запросов с низкой производительностью. Эта информация используется в качестве основы для устранения неполадок.

Возможно, следует начать с оптимизации или упрощения сложных запросов. Рекомендуется разбить длительные пакетных задания на более мелкие. Кроме того, убедитесь, что созданы индексы для обработки запросов. Можно также вручную задать значение MAXDOP (максимальная степень параллелизма) для конкретного запроса, производительность которого оказалась низкой. Для этого используется T-SQL. Дополнительные сведения см. в разделе [Настройка параметра конфигурации сервера max degree of parallelism](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option).

Если для параметра конфигурации сервера MAXDOP в качестве значения по умолчанию задать ноль (0), то база данных SQL Azure сможет использовать все доступные логические ядра ЦП для параллельного выполнения потоков, выполняющих отдельный запрос. Если для параметра конфигурации сервера MAXDOP задать единицу (1), то для выполнения отдельного запроса сможет использоваться только одно ядро. То есть фактически распараллеливание будет отключено. В зависимости от ситуации, доступных ядер базы данных и сведений в журнале диагностики, можно задать для параметра MAXDOP соответствующее число ядер для параллельного выполнения запросов, чтобы устранить возникшую проблему.

## <a name="pagelatch-contention"></a>Состязание за кратковременную блокировку страниц

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение текущей производительности рабочей нагрузки базы данных из-за состязания с кратковременной блокировкой страниц по сравнению с базовыми показателями рабочей нагрузки за последние 7 дней.

Кратковременные блокировки — это механизмы упрощенной синхронизации, используемые базой данных SQL Azure, чтобы обеспечить многопоточность и гарантировать согласованность структур в памяти, включая индексы, страницы данных и другие внутренние структуры.

Существует много типов кратковременных блокировок в базе данных SQL Azure. В целях упрощения кратковременные блокировки буфера используются для защиты страниц в памяти в буферном пуле, а кратковременные блокировки ввода-вывода используются для защиты страниц, которые еще не загружены в буферный пул. При каждой операции записи или чтения данных страницы в буферном пуле рабочий поток должен сначала наложить кратковременную блокировку на буфер для этой страницы. Каждый раз, когда рабочий поток пытается получить доступ к странице, которая еще не доступна в буферном пуле в памяти, выполняется запрос на ввод-вывод для загрузки необходимых сведений из хранилища, что указывает на более серьезное снижение производительности.

Состязание за кратковременную блокировку страниц происходит, когда несколько потоков одновременно пытаются наложить кратковременную блокировку на одну и ту же структуру в памяти, что приводит к увеличению времени ожидания выполнения запроса. В случае состязания за кратковременную блокировку страниц для ввода-вывода, когда требуется обратиться к данным в хранилище, время ожидания может быть еще больше, что может значительно повлиять на производительность рабочей нагрузки. Состязание за кратковременную блокировку страниц — наиболее распространенная ситуация, в которой потоки ожидают друг друга и состязаются за ресурсы в многопроцессорных системах.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения о состязаниях за кратковременную блокировку страниц, которые можно использовать в качестве основы для устранения проблемы.

Так как кратковременные блокировки страниц являются внутренним механизмом управления базы данных SQL Azure, ситуации, когда их следует использовать, определяются автоматически. Решения в разработке приложений, включая структуру схемы, могут влиять на поведение кратковременных блокировок страниц ввиду детерминированного поведения кратковременных блокировок.
Один из методов обработки состязаний за кратковременную блокировку — замена последовательного ключа индекса непоследовательным ключом, что позволяет равномерно распределить вставку данных в пределах индекса. Обычно для этого в индексе используется начальный столбец, который пропорционально распределяет рабочую нагрузку. Кроме того, можно рассмотреть возможность секционирования таблиц. Создание схемы хэш-секционирования с вычисляемым столбцом для секционированной таблицы — распространенный способ устранения чрезмерного состязания за кратковременную блокировку. В случае состязания за блокировку страниц для вода-вывода рекомендуется добавить индексы. Это позволит устранить данную проблему с производительностью. Дополнительные сведения см. в документе [Diagnosing and Resolving Latch Contention on SQL Server](http://download.microsoft.com/download/B/9/E/B9EDF2CD-1DBF-4954-B81E-82522880A2DC/SQLServerLatchContention.pdf) (Диагностика и устранение состязания за кратковременную блокировку в SQL Server), который можно скачать в формате PDF.

## <a name="missing-index"></a>Отсутствующий индекс

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение текущей производительности рабочей нагрузки базы данных по сравнению с базовыми показателями за последние 7 дней из-за отсутствующего индекса.

Индекс используется для повышения производительность запросов. Он обеспечивает быстрый доступ к данным таблиц, уменьшая число страниц в наборе данных, которые должны быть просмотрены или просканированы.

Запросы, которые привели к снижению производительности, определяются с помощью этого шаблона, и для повышения их производительности можно создать индексы.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит хэши выявленных запросов, которые негативно влияют на производительность рабочей нагрузки. Рассмотрите возможность создания индексов для этих запросов. Их можно также оптимизировать или удалить, если эти запросы не нужны. Для повышения производительности рекомендуется избегать выполнения запросов к данным, которые не используются.

> [!TIP]
> Вы знали, что встроенный аналитический механизм Azure может автоматически управлять наиболее производительными индексами для баз данных?
>
> Чтобы непрерывно оптимизировать производительность базы данных SQL Azure, рекомендуется включить [автоматическую настройку базы данных SQL Azure](sql-database-automatic-tuning.md). Это уникальная функция встроенного аналитического механизма SQL Azure, который постоянно отслеживает базу данных SQL Azure и автоматически настраивает и создает индексы для ваших баз данных.
>

## <a name="new-query"></a>Создать запрос

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает, что был обнаружен новый запрос с низкой производительностью, который снижает производительность рабочей нагрузки по сравнению с базовыми показателями производительности за последние 7 дней.

Иногда создание высокопроизводительного запроса может быть сложной задачей. Дополнительные сведения о создании запросов см. в разделе [Writing SQL Queries: Let's Start with the Basics](https://msdn.microsoft.com/library/bb264565.aspx) (Создание SQL-запросов. Начнем с основ). Чтобы оптимизировать производительность существующего запроса, прочитайте раздел [Настройка запроса](https://msdn.microsoft.com/library/ms176005.aspx).

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит до двух (2) новых запросов, потребляющих больше всего ресурсов ЦП, включая их описание и хэши. Так как обнаруженный запрос снижает производительность рабочей нагрузки, его можно оптимизировать. Рекомендуется не извлекать данные, которые не используются. Кроме того, разумно использовать запросы с предложением WHERE. Также рекомендуется упростить сложные запросы и разделить их на запросы меньшего размера. Разделение больших пакетных запросов на пакетные запросы меньшего размера также является хорошей методикой, которую вам следует рассмотреть. Как правило, устранить данную проблему с производительностью помогает создание индексов для новых запросов.

Вы можете также рассмотреть возможность использования [анализа производительности запросов базы данных SQL Azure](sql-database-query-performance.md).

## <a name="unusual-wait-statistic"></a>Необычная статистика ожидания

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает на снижение производительности рабочей нагрузки, которое определяется на основе низкой производительности запросов по сравнению с базовыми показателями рабочей нагрузки за последние 7 дней.

В этом случае системе не удалось отнести запросы с низкой производительностью к другим стандартным категориям снижения производительности, но она обнаружила статистику ожидания, связанную со снижением эффективности, и поэтому отнесла их к категории &#8220;*необычной статистики ожидания*&#8221;. Это категория запросов, в которой снижение производительности связано с необычной статистикой ожидания. 

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения о необычных значениях времени ожидания, хэши соответствующих запросов и их время ожидания.

В этом случае, так как системе не удалось определить первопричину низкой производительности запросов, хорошей отправной точкой для ручного устранения неполадок может послужить диагностическая информация о таких запросах. Может потребоваться оптимизировать производительность этих запросов. Обычно рекомендуется не получать данные, которые не используются, а также упростить и разбить сложные запросы на запросы меньшего размера. Дополнительные сведения об оптимизации производительности запросов см. в разделе [Настройка запроса](https://msdn.microsoft.com/library/ms176005.aspx).

## <a name="tempdb-contention"></a>Состязание за tempdb

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает, что на производительность базы данных негативно влияет узкое место, возникшее из-за потоков, пытающихся получить доступ к ресурсам tempdb (это состояние не связано с вводом-выводом). Типичный сценарий для этой проблемы производительности подразумевает сотни параллельных запросов, которые создают, используют, а затем удаляют небольшие таблицы tempdb, то есть таблицы базы данных TempDB. Система обнаружила, что число одновременно выполняющихся запросов, использующих одинаковые таблицы tempdb, статистически значительно увеличилось и теперь негативно влияет на производительность базы данных по сравнению с базовыми показателями производительности за последние 7 дней.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения о состязании за ресурсы tempdb, которые можно использовать в качестве отправной точки при устранении проблем с производительностью. Чтобы устранить подобные конфликты и увеличить пропускную способность общей рабочей нагрузки, можно принять несколько мер. Можно прекратить использование временных таблиц. Рассмотрите возможность использования таблиц, оптимизированных для памяти. Ознакомьтесь с разделом [Введение в таблицы, оптимизированные для памяти](https://docs.microsoft.com/en-us/sql/relational-databases/in-memory-oltp/introduction-to-memory-optimized-tables). 

## <a name="elastic-pool-dtu-shortage"></a>Нехватка DTU эластичного пула

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает, что текущая производительность рабочей нагрузки базы данных понизилась по сравнению с базовыми показателями за последние 7 дней из-за нехватки DTU в эластичном пуле вашей подписки. 

Под ресурсами в базе данных SQL Azure обычно понимаются [ресурсы DTU](sql-database-what-is-a-dtu.md), состоящие из сочетания ресурсов ЦП и ввода-вывода (ввод-вывод данных и журнала транзакций). [Ресурсы эластичного пула Azure](sql-database-elastic-pool.md) используются в качестве пула доступных ресурсов eDTU, совместно используемого несколькими базами данных в целях масштабирования. Если доступных ресурсов eDTU в эластичном пуле недостаточно, чтобы обеспечить все базы данных в пуле, система выявляет проблему с производительностью из-за нехватки DTU эластичного пула.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения об эластичном пуле, перечень баз данных, которые используют больше всего ресурсов DTU, и процент ресурсов DTU пула, используемых наиболее ресурсоемкой базой данных.

Так как данная проблема производительности связана с несколькими базами данных, использующими один пул eDTU в эластичном пуле, действия по устранению этой проблемы необходимо направить на базы данных, которые используют больше всего ресурсов DTU. Можно уменьшить нагрузку на самые ресурсоемкие базы данных, включая оптимизацию самых ресурсоемких запросов к этим базам данных. Можно также устранить запросы к данным, которые не используются. Другой подход заключается в оптимизации приложений, использующих базы данных, которые потребляют больше всего ресурсов DTU, и перераспределении рабочей нагрузки между несколькими базами данных.

Если невозможно сократить и оптимизировать текущую рабочую нагрузку наиболее ресурсоемких баз данных, рассмотрите возможность увеличения ценовой категории эластичного пула. Ее повышение позволит увеличить число DTU в эластичном пуле.

## <a name="plan-regression"></a>Снижение эффективности плана

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает, что база данных SQL Azure начинает использовать неоптимальный план выполнения запросов. Как правило, неоптимальный план повышает объем выполняемых запросов и приводит к увеличению времени ожидания текущих и других запросов.

База данных SQL Azure определяет план выполнения запросов с наименьшими затратами на выполнение запроса. Но иногда из-за изменения типа запросов и рабочих нагрузок существующие планы утрачивают эффективность. Также проблема может заключаться в недостаточной качественной оценке базы данных SQL Azure. Исправить планы выполнения запросов можно вручную.

Этот выявляемый шаблон снижения производительности учитывает три разных случая снижения эффективности плана: ухудшение показателей нового плана, ухудшение показателей старого плана и изменение рабочей нагрузки существующего плана. Тип снижения эффективности плана указывается в свойстве &#8220;*details*&#8221; в журнале диагностики.

Снижение эффективности нового плана означает, что база данных SQL Azure начала выполнение нового плана выполнения запросов, эффективность которого ниже, чем эффективность старого плана. Снижение эффективности старого плана означает, что база данных SQL Azure переключилась с нового, более эффективного плана, на старый план, эффективность которого ниже. Снижение эффективности существующих планов из-за изменения рабочей нагрузки означает ситуацию, в которой новый и старый план непрерывно использовались по очереди, причем предпочтение отдавалось плану с более низкой эффективностью.

Дополнительные сведения о снижении эффективности планов см. в разделе [What is plan regression in SQL Server?](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2017/06/09/what-is-plan-regression-in-sql-server/) (Что такое снижение эффективности плана в SQL Server?) 

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит хэши запросов, идентификатор высокоэффективного плана, идентификатор низкоэффективного плана и идентификаторы запросов, которые могут использоваться в качестве основы для устранения этих проблем с производительностью.

Можно проанализировать, какой план лучше подходит для конкретных запросов. Это можно определить с помощью указанных хэшей запросов. Когда вы определите, какой план лучше подходит для запросов, можно будет применить его вручную. Дополнительные сведения см. в разделе [How SQL Server 2017 prevents plan regressions](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2017/04/25/you-shall-not-regress-how-sql-server-2017-prevents-plan-regressions/) (Как SQL Server 2017 предотвращает снижение эффективности).

> [!TIP]
> Вы знали, что встроенный аналитический механизм Azure может автоматически управлять наиболее производительными планами выполнения запросов для баз данных?
>
> Чтобы непрерывно оптимизировать производительность базы данных SQL Azure, рекомендуется включить [автоматическую настройку базы данных SQL Azure](sql-database-automatic-tuning.md). Это уникальная функция встроенного аналитического механизма SQL Azure, который постоянно отслеживает базу данных SQL Azure и автоматически настраивает и создает наиболее производительные планы выполнения запросов для ваших баз данных.
>

## <a name="database-scoped-configuration-value-change"></a>Изменение значения конфигурации уровня базы данных

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает, что в конфигурацию уровня базы данных было внесено изменение, которое является причиной снижения производительности по сравнению с показателями рабочей нагрузки базы данных за последние 7 дней. Эта означает, что последнее изменение, внесенное в конфигурацию уровня базы данных, негативно влияет на производительность базы данных.

Изменение конфигурации уровня базы данных можно задать отдельно для каждой базы данных. Данная конфигурация используется на индивидуальной основе для оптимизации производительности отдельных баз данных. Для каждой отдельной базы данных можно настроить следующие параметры: MAXDOP, LEGACY_CARDINALITY_ESTIMATION, PARAMETER_SNIFFING, QUERY_OPTIMIZER_HOTFIXES и CLEAR PROCEDURE_CACHE.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит последние изменения конфигурации уровня базы данных, которые привели к снижению производительности по сравнению с показателями рабочей нагрузки за последние 7 дней. Возможно, потребуется отменить изменения конфигурации и восстановить предыдущие значения или поочередно настроить все ее значения, пока не будет достигнут нужный уровень производительности. Можно также скопировать значения конфигурации уровня базы данных из аналогичной базы данных с удовлетворительной производительностью. Если вам не удалось устранить проблемы с производительностью, то может потребоваться восстановить значения по умолчанию для базы данных SQL Azure и попытаться оптимизировать ее, начав с этих базовых показателей.

Дополнительные сведения об оптимизации конфигурации уровня базы данных и синтаксисе T-SQL для изменения конфигурации приведены в статье [ALTER DATABASE SCOPED CONFIGURATION (Transact-SQL)](https://msdn.microsoft.com/en-us/library/mt629158.aspx).

## <a name="slow-client"></a>Медленная работа клиента

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает, что клиент, использующий базу данных SQL Azure, не может достаточно быстро потреблять выходные данные, передаваемые из базы данных. Так как база данных SQL Azure не сохраняет результаты выполненных запросов в буфере, это приводит к замедлению работы и ожиданию потребления клиентом передаваемых выходных данных запросов перед продолжением операций. Эта проблема также может быть связана с медленной сетью, которая не может достаточно быстро передавать выходные данные из базы данных SQL Azure в потребляющий их клиент.

Это состояние выявляется только при обнаружении снижения производительности по сравнению с показателями рабочей нагрузки базы данных за последние 7 дней. Это гарантирует обнаружение этой проблемы производительности только в том случае, если снижение производительности статистически значимое по сравнению с предыдущими показателями производительности.

### <a name="troubleshooting"></a>Устранение неполадок

Этот выявляемый шаблон снижения производительности указывает на проблему на стороне клиента, требующую устранить неполадки в работе приложения или сети на стороне клиента. Журнал диагностики содержит хэши запросов и наибольшие значения времени ожидания клиентом данных за последние 2 часа. Эти сведения можно использовать в качестве основы для устранения неполадок.

Возможно, следует оптимизировать производительность приложения для использования этих запросов. Можно также рассмотреть возможные проблемы из-за задержки сети. Так как снижение производительности определяется на основании изменения базовых показателей производительности за последние 7 дней, может потребоваться изучить изменения приложения или состояния сети, произошедшие за последнее время, которые могли привести к снижению производительности. 

## <a name="pricing-tier-downgrade"></a>Переход на более низкую ценовую категорию

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает на то, что была изменена ценовая категория базы данных SQL Azure. Из-за сокращения ресурсов (DTU) базы данных система обнаружила снижение текущей производительности базы данных по сравнению с базовыми показателями за последние 7 дней.

Кроме того, возможна ситуация, в которой ценовая категория подписки базы данных SQL Azure была понижена, а затем повышена в течение короткого периода времени. Это означает, что обнаружено временное снижение производительности, информация о котором выводится в разделе сведений журнала диагностики в виде описания понижения и повышения ценовой категории.

### <a name="troubleshooting"></a>Устранение неполадок

Если вы понизили ценовую категорию и, следовательно, уменьшили число DTU для базы данных SQL Azure, и вас удовлетворяет полученная производительность, то никакие действия выполнять не требуется. Если после снижения ценовой категории вас не устраивает производительность базы данных SQL Azure, может потребоваться либо уменьшить рабочую нагрузку базы данных, либо повысить ценовую категорию.

## <a name="recommended-troubleshooting-flow"></a>Рекомендуемая последовательность устранения неполадок

В блок-схеме ниже показан рекомендуемый подход к устранению проблем с производительностью с помощью Intelligent Insights.

Функции Intelligent Insights доступны на портале Azure. Чтобы воспользоваться ими, следует перейти к SQL Azure Analytics. Попытайтесь найти входящее оповещение о производительности и щелкните его. На странице "Обнаружения" выясните, что происходит. Изучите предоставленный анализ первопричин проблемы, текст запросов, тенденции длительности запросов и развитие инцидента. Попытайтесь устранить проблему с производительность с помощью соответствующей рекомендации Intelligent Insights. 

[![Блок-схема устранения неполадок](./media/sql-database-intelligent-insights/intelligent-insights-troubleshooting-flowchart.png)](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/intelligent-insight/Troubleshoot%20Azure%20SQL%20Database%20performance%20issues%20using%20Intelligent%20Insight.pdf)

> [!TIP]
> Щелкните блок-схему, чтобы скачать ее в формате PDF.

Обычно Intelligent Insights требуется 1 час для выполнения анализа первопричин проблемы с производительностью. Если проблему не удается найти на странице Intelligent Insights (в большинстве случаев таким проблемам меньше 1 часа) и она является критической, используйте хранилище запросов (QDS), чтобы вручную определить первопричину данной проблемы с производительностью. Дополнительные сведения см. в разделе [Мониторинг производительности с использованием хранилища запросов](https://docs.microsoft.com/en-us/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store).

## <a name="next-steps"></a>Дальнейшие действия
- Изучите основные понятия [Intelligent Insights](sql-database-intelligent-insights.md).
- Используйте [журнал диагностики производительности Intelligent Insights для базы данных SQL Azure](sql-database-intelligent-insights-use-diagnostics-log.md).
- Настройте [мониторинг базы данных SQL Azure с помощью службы "Аналитика SQL Azure"](https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-azure-sql).
- Изучите [сбор и использование данных журнала из ресурсов Azure](../monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs.md).

