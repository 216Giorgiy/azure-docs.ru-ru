---
title: Обзор функции запросов к эластичной базе данных SQL Azure | Microsoft Docs
description: >
  Обзор функции эластичных запросов services: sql-database
documentationcenter: ''
manager: jhubbard
author: torsteng

ms.service: sql-database
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/27/2016
ms.author: torsteng

---
# Обзор функции запросов к эластичной базе данных SQL Azure (предварительная версия)
С помощью функции запросов к эластичной базе данных (доступна в режиме предварительной версии) можно выполнять запросы Transact-SQL для обращения сразу к нескольким базам данных в базе данных SQL Azure (SQLDB). Эта возможность позволяет создавать межбазовые запросы для доступа к удаленным таблицам. Также вы можете подключать средства Майкрософт и сторонних производителей (Excel, PowerBI, Tableau и т. д.) для выполнения запросов на разных уровнях данных со множеством баз данных. С помощью этой функции можно разворачивать запросы до уровней большого объема данных в базе данных SQL и визуализировать результаты в отчетах по бизнес-аналитике (BI).

## Документация
* [Приступая к работе с межбазовыми запросами](sql-database-elastic-query-getting-started-vertical.md)
* [Отчет по масштабируемым облачным базам данных](sql-database-elastic-query-getting-started.md)
* [Запрос к нескольким сегментированным облачным базам данных (горизонтальное секционирование)](sql-database-elastic-query-horizontal-partitioning.md)
* [Запрос к нескольким облачным базам данных с разными схемами (вертикальное секционирование)](sql-database-elastic-query-vertical-partitioning.md)
* [sp\_execute \_remote](https://msdn.microsoft.com/library/mt703714)

## Почему рекомендуется использовать эластичные запросы?
**база данных SQL Azure;**

Выполняйте запросы к нескольким базам данных SQL Azure только в T-SQL. Это позволяет отправлять в удаленные базы данных запросы только для чтения. Благодаря этому текущие пользователи локального сервера SQL Server могут переместить приложения в базу данных SQL, используя имена, состоящие из трех или четырех частей, либо связанный сервер.

**Доступно на стандартном уровне**. В настоящее время эластичные запросы поддерживаются на уровнях производительности "Стандартный" и "Премиум". Сведения об ограничениях производительности для нижних уровней производительности см. в разделе "Ограничения предварительной версии" ниже.

**Отправка в удаленные базы данных**

Эластичные запросы к удаленным базам данных теперь могут отправлять параметры SQL для выполнения.

**Выполнение хранимой процедуры**

Выполнить вызовы удаленных хранимых процедур или удаленных функций можно с помощью процедуры [sp\_execute \_remote](https://msdn.microsoft.com/library/mt703714).

**Гибкость**

Функция эластичных запросов теперь позволяет внешним таблицам ссылаться на удаленные таблицы с разными именами схем или таблиц.

## Сценарии эластичных запросов к базам данных
Основная задача лежит в области упрощения сценариев запросов, когда строки, предоставленные несколькими базами данных, объединяются в один общий набор результатов. Запрос может быть создан либо напрямую пользователем или приложением, либо косвенно — с помощью средств, которые подключены к базе данных. Это особенно полезно при создании отчетов с помощью коммерческих средств бизнес-аналитики, интеграции данных или любого приложения, которое нельзя изменить. Функция эластичных запросов позволяет выполнять межбазовые запросы с использованием уже знакомой процедуры подключения к SQL Server в таких средствах, как Excel, PowerBI, Tableau или Cognos. Кроме того, эластичный запрос не только обеспечивает доступ ко всей коллекции баз данных через запросы, выданные SQL Server Management Studio или Visual Studio, но и упрощает обработку межбазовых запросов из Entity Framework или других сред ORM. На рисунке 1 показан сценарий, в котором существующее облачное приложение (использующее [клиентскую библиотеку эластичной базы данных](sql-database-elastic-database-client-library.md)) основывается на уровне масштабируемых данных, а функция эластичных запросов используется для создания межбазовых отчетов.

**Рисунок 1.** Запрос к эластичной базе данных, используемый на уровне масштабируемых данных.

![Запрос к эластичной базе данных, используемый на уровне масштабируемых данных][1]

Пользовательские сценарии эластичных запросов могут характеризоваться следующими топологиями:

* **Вертикальное секционирование — межбазовые запросы** (топология 1): вертикальное разделение данных между несколькими базами данных в рамках одного уровня. Как правило, разные наборы таблиц расположены в разных базах данных. Это означает, что схемы разных баз данных различаются. Например, все таблицы, связанные с данными инвентаризации, хранятся в одной базе данных, а таблицы, связанные с учетом, — в другой. Использование подобной топологии предполагает использование первой базы данных для выполнения запросов или создания отчетов по таблицам в нескольких базах данных.
* **Горизонтальное секционирование — сегментирование** (топология 2): горизонтальное разделение данных для распределения строк в рамках масштабируемого уровня данных. При таком подходе схемы всех включенных баз данных являются идентичными. Такой подход также называется сегментированием. Сегментирование может выполняться с помощью (1) библиотеки средств эластичной базы данных или (2) как самостоятельное сегментирование. Эластичные запросы используются для создания запросов или построения отчетов на основе нескольких сегментов.

> [!NOTE]
> Запрос к эластичной базе данных лучше всего подходит для нерегулярных отчетов, где большую часть обработки можно выполнить на уровне данных. Для сценариев, предусматривающих высокие рабочие нагрузки отчетности или хранение данных с более сложными запросами, вы можете использовать [хранилище данных SQL Azure](https://azure.microsoft.com/services/sql-data-warehouse/).
> 
> 

## Топология запросов к эластичной базе данных
### Топология 1: вертикальное секционирование — межбазовые запросы
Сведения о том, как начать писать код, см. в статье [Приступая к работе с межбазовыми запросами (вертикальное секционирование)](sql-database-elastic-query-getting-started-vertical.md).

Эластичные запросы можно использовать для предоставления доступа к данным, расположенным в базе данных SQLDB, другим базам данных SQLDB. Это позволяет запросам из одной базы данных ссылаться на таблицы в любой другой удаленной базе данных SQLDB. Первым этапом является определение внешнего источника данных для каждой удаленной базы данных. Внешний источник данных определяется в локальной базе данных, из которой необходимо получить доступ к таблицам, расположенным в удаленной базе данных. Вносить изменения в удаленную базу данных не нужно. В стандартных сценариях вертикального секционирования, когда с разными базами данных используются разные схемы, эластичные запросы позволяют решать такие стандартные задачи, как доступ к ссылочным данным и создание межбазовых запросов.

**Ссылочные данные**: топология 1 используется для управления ссылочными данными. На приведенном ниже рисунке две таблицы (T1 и T2) со ссылочными данными хранятся в выделенной базе данных. Как показано на рисунке, используя эластичный запрос, вы можете получить удаленный доступ к таблицам T1 и T2 из других баз данных. Топологию 1 рекомендуется использовать, если ссылочные таблицы имеют небольшой размер или если в удаленных запросах к таким таблицам используются предикаты селекции.

**Рисунок 2.** Вертикальное секционирование — использование эластичных запросов для обращения к ссылочным данным

![Вертикальное секционирование — использование эластичных запросов для запросов к ссылочным данным][3]

**Межбазовые запросы**: эластичные запросы позволяют реализовывать сценарии, требующие выполнения межбазовых запросов SQLDB. На рисунке 3 показаны четыре разных базы данных: «Управление отношениями с клиентами», «Инвентарные данные», «Управление персоналом» и «Продукты». Запросам, выполняемым в одной из этих баз данных, требуется доступ к одной или всем базам данным. Используя эластичные запросы, вы можете настроить свою базу, выполнив несколько простых инструкций DDL в каждой из этих четырех баз данных. После однократной настройки доступ к удаленной таблице будет предоставятся в виде ссылки на локальную таблицу в запросах T-SQL или используемых средствах бизнес-аналитики. Этот подход рекомендуется применять, когда удаленные запросы не возвращают большие объемы.

**Рисунок 3.** Вертикальное секционирование — использование эластичных запросов для межбазовых запросов

![Вертикальное секционирование — использование эластичных запросов для межбазовых запросов][4]

### Топология 2: горизонтальное секционирование (сегментирование)
Чтобы использовать эластичные запросы для выполнения задач отчетности на уровне горизонтально секционированных (сегментированных) данных, базы данных на этом уровне должны быть представлены с помощью [карты сегментов эластичной базы данных](sql-database-elastic-scale-shard-map-management.md). Как правило, в этом сценарии используется только одна карта сегментов, а роль точки входа для запросов отчетности выполняет выделенная база данных с поддержкой эластичных запросов. Доступ к карте сегментов требуется только для этой выделенной базы данных. На рисунке 4 показана топология, конфигурация которой включает базу данных эластичных запросов и карту сегментов. На этом уровне данных базы данных могут быть представлены базами данных SQL Azure других версий или выпусков. Дополнительные сведения о клиентской библиотеке эластичной базы данных и о создании карт сегментов см. в статье [Управление картой сегментов](sql-database-elastic-scale-shard-map-management.md).

**Рисунок 4.** Горизонтальное секционирование — использование эластичных запросов для создания отчетности по уровням сегментированных данных

![Горизонтальное секционирование — использование эластичных запросов для создания отчетности по уровням сегментированных данных][5]

> [!NOTE]
> Выделенная эластичная база данных должна представлять собой базу данных SQL версии 12. К самим сегментам ограничения не применяются.
> 
> 

Начальные сведения для написания кода см. в статье [Приступая к работе с запросами к эластичной базе данных при горизонтальном секционировании (сегментировании)](sql-database-elastic-query-getting-started.md).

## Реализация запросов к эластичной базе данных
В следующих разделах описаны шаги по реализации эластичных запросов в сценариях вертикального и горизонтального секционирования. Также приведены ссылки на более подробную документацию по разным сценариям секционирования.

### Вертикальное секционирование — межбазовые запросы
Далее описана настройка запросов к эластичной базе данных при вертикальном секционировании с необходимостью доступа к таблице, расположенной в удаленной базе данных SQLDB с той же схемой:

* [CREATE MASTER KEY](https://msdn.microsoft.com/library/ms174382.aspx) mymasterkey
* [CREATE DATABASE SCOPED CREDENTIAL](https://msdn.microsoft.com/library/mt270260.aspx) mycredential
* [CREATE/DROP EXTERNAL DATA SOURCE](https://msdn.microsoft.com/library/dn935022.aspx) mydatasource of type **RDBMS**
* [CREATE/DROP EXTERNAL TABLE](https://msdn.microsoft.com/library/dn935021.aspx) mytable

Выполнив эти инструкции DDL, вы получите доступ к удаленной таблице mytable как к локальной таблице. База данных SQL Azure автоматически открывает подключение к удаленной базе данных, обрабатывает запрос к удаленной базе данных и возвращает результаты. Дополнительные сведения о действиях, требуемых при вертикальном секционировании, см. в статье [Эластичные запросы при вертикальном секционировании](sql-database-elastic-query-vertical-partitioning.md).

### Горизонтальное секционирование (сегментирование)
Далее описана поэтапная настройка эластичных запросов к базе данных при горизонтальном секционировании, требующем доступ к набору таблиц, расположенных (как правило) в нескольких удаленных базах данных SQLDB:

* [CREATE MASTER KEY](https://msdn.microsoft.com/library/ms174382.aspx) mymasterkey
* [CREATE DATABASE SCOPED CREDENTIAL](https://msdn.microsoft.com/library/mt270260.aspx) mycredential
* Создание [карты сегментов](sql-database-elastic-scale-shard-map-management.md) для представления уровня данных с помощью клиентской библиотеки эластичной базы данных.
* [CREATE/DROP EXTERNAL DATA SOURCE](https://msdn.microsoft.com/library/dn935022.aspx) mydatasource of type **SHARD\_MAP\_MANAGER**
* [CREATE/DROP EXTERNAL TABLE](https://msdn.microsoft.com/library/dn935021.aspx) mytable

Выполнив эти шаги, вы получите доступ к горизонтально секционированной таблице mytable как к локальной таблице. База данных SQL Azure автоматически открывает несколько параллельных подключений к удаленным базам данных, хранящим таблицы, обрабатывает запросы к удаленным базам данных и возвращает результаты. Дополнительные сведения о действиях, требуемых при горизонтальном секционирования, см. в статье [Эластичные запросы при горизонтальном секционировании](sql-database-elastic-query-horizontal-partitioning.md).

## Запросы T-SQL
Определив внешние источники данных и внешние таблицы, вы можете использовать уже обычные строки подключения к SQL Server для соединения с базами данных, в которых определены внешние таблицы. Затем через это подключение можно выполнить инструкции T-SQL применимо к внешним таблицам. При этом будут действовать описанные ниже ограничения. Дополнительные сведения и примеры запросов T-SQL см. в статьях по [горизонтальному секционированию](sql-database-elastic-query-horizontal-partitioning.md) и [вертикальному секционированию](sql-database-elastic-query-vertical-partitioning.md).

## Подключение для инструментов
Используйте обычные строки подключения к SQL Server, чтобы подключить приложения, а также средства бизнес-аналитики и интеграции данных к базам данных, содержащих внешние таблицы. Убедитесь, что в качестве источника данных для вашего инструмента поддерживается SQL Server. После подключения обратитесь к базе данных эластичных запросов и внешним таблицам в этой базе данных, как при подключении к любой другой базе данных SQL Server с помощью какого-либо средства.

> [!IMPORTANT]
> Проверка подлинности с помощью Azure Active Directory и эластичных запросов сейчас не поддерживается.
> 
> 

## Стоимость
Функция эластичных запросов включена в стоимость баз данных SQL Azure. Обратите внимание: несмотря на поддержку топологий, в которых удаленные базы данных и конечная точка эластичного запроса находятся в разных центрах обработки данных, стоимость вывода данных из удаленных баз данных рассчитывается по обычным [тарифам Azure](https://azure.microsoft.com/pricing/details/data-transfers/).

## Ограничения предварительной версии
* На уровне производительности «Стандартный» выполнение первого эластичного запроса может занять несколько минут. Это время требуется для загрузки функций, связанных с эластичными запросами. На более высоких уровнях производительности скорость загрузки будет выше.
* Сценарии для внешних источников данных или внешних таблиц из SSMS или SSDT в настоящее время не поддерживаются.
* Функции импорта и экспорта баз данных SQL в настоящее время не поддерживают внешние источники данных и внешние таблицы. Если вам нужно использовать функции импорта и экспорта, удалите эти объекты перед экспортом и создайте их заново после импорта.
* Функция запросов к эластичной базе данных в настоящее время поддерживает доступ к внешним таблицам только для чтения. Тем не менее вы можете использовать полный набор функций T-SQL при работе с базой данных, в которой определена внешняя таблица. Например, это может быть полезно для сохранения временных результатов (например, с помощью инструкции SELECT <список\_столбцов> INTO <локальная\_таблица>) или для определения хранимых процедур в базе данных эластичных запросов со ссылками на внешние таблицы.
* В определениях внешних таблиц типы LOB не поддерживаются, за исключением nvarchar(max). Обойти это ограничение можно, создав представление в удаленной базе данных с преобразованием типа LOB в тип nvarchar(max). Затем нужно определить внешнюю таблицу применимо к этому представлению (а не базовой таблице) и выполнить обратное преобразование в исходный тип LOB для запросов.
* Статистика по столбцам для внешних таблиц в настоящее время не поддерживается. Статистика по таблицам поддерживается, но она создается вручную.

## Отзыв
Просим вас поделиться своим мнением об эластичных запросах в разделе Disqus, на форумах MSDN или на сайте Stackoverflow. Мы будем признательны за любые отзывы о нашем сервисе, в том числе за сообщения о недостатках, недоработках и недостающих функциях.

## Дополнительные сведения
Дополнительные сведения о межбазовых запросах и сценариях вертикального секционирования см. в следующих документах:

* [Обзор межбазовых запросов при вертикальном секционировании](sql-database-elastic-query-vertical-partitioning.md)
* Обратитесь к нашему пошаговому руководству и уже через несколько минут вы сможете запустить полнофункциональный рабочий пример: [Приступая к работе с межбазовыми эластичными запросами (вертикальное секционирование)](sql-database-elastic-query-getting-started-vertical.md).

Дополнительные сведения о сценариях горизонтального секционирования и сегментирования см. здесь:

* [Обзор горизонтального секционирования и сегментирования](sql-database-elastic-query-horizontal-partitioning.md)
* Обратитесь к нашему пошаговому руководству, и уже через несколько минут вы сможете запустить полнофункциональный рабочий пример: [Начало работы с запросами к эластичной базой данных при горизонтальном секционировании (сегментировании)](sql-database-elastic-query-getting-started.md).

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-query-overview/overview.png
[2]: ./media/sql-database-elastic-query-overview/topology1.png
[3]: ./media/sql-database-elastic-query-overview/vertpartrrefdata.png
[4]: ./media/sql-database-elastic-query-overview/verticalpartitioning.png
[5]: ./media/sql-database-elastic-query-overview/horizontalpartitioning.png

<!--anchors-->

<!---HONumber=AcomDC_0713_2016-->