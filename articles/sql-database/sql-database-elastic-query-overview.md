<properties
    pageTitle="Обзор функции запросов к эластичным базам данных SQL Azure "
    description="Обзор функции эластичных запросов "
    services="sql-database"
    documentationCenter=""  
    manager="jeffreyg"
    authors="sidneyh"/>

<tags
    ms.service="sql-database"
    ms.workload="sql-database"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="07/09/2015"
    ms.author="sidneyh" />

# Обзор функции запросов к эластичным базам данных SQL (предварительная версия)

С помощью предварительной версии **функции запросов к эластичным базам данных** можно выполнять запросы Transact-SQL, которые позволят обработать сразу несколько баз данных в базе данных SQL Azure. Вы сможете подключать средства Microsoft и сторонние инструменты (Excel, PowerBI, Tableau и т. д.) к уровням данных с несколькими базами данных, особенно если последние используют общую схему, которая также называется горизонтальным секционированием или сегментированием. С помощью этой функции можно разворачивать запросы до уровней большого объема данных в базе данных SQL и визуализировать результаты в отчетах по бизнес-аналитике (BI).

Чтобы начать создание программы для запроса к эластичной базе данных, см. статью [Начало работы с запросами к эластичным базам данных](sql-database-elastic-query-getting-started.md).

## Сценарии эластичных запросов к базам данных

Цель запроса к эластичной базе данных — облегчить сценарии отчетности, в которых несколько баз данных предоставляют строки для единственного общего результата. Запрос может быть создан напрямую пользователем или программой либо косвенно — с помощью средств, которые подключены к базе данных запросов. Эта функция особенно полезна при создании отчетов с помощью коммерческих средств бизнес-аналитики или интеграции данных или любого программного обеспечения, не допускающего внесение изменений. С помощью запроса к эластичной базе данных можно легко выполнять запросы между несколькими базами данных с использованием уже знакомой процедуры подключения к SQL Server в таких инструментах, как, например, Excel, PowerBI, Tableau или Cognos.

Запрос к эластичной базе данных также позволяет легко получить доступ ко всей коллекции баз данных через запросы, выданные SQL Server Management Studio или Visual Studio, и упрощает обработку запросов между базами данных из Entity Framework или других сред ORM. На рис. 1 показан сценарий, в котором существующая облачная программа (использующая библиотеку средств эластичных баз данных) создается на уровне масштабируемых данных, а запрос к эластичной базе данных используется для создания отчетов между базами данных.

**Рисунок 1**

![Запрос к эластичной базе данных, используемый на уровне масштабируемых данных][1]

Уровень данных разворачивается на несколько баз данных, использующих общую схему. Этот подход также называется горизонтальным секционированием или сегментированием. Для выполнения секционирования и управления им можно использовать (1) [клиентскую библиотеку эластичных баз данных](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Client/) или (2) модель распределения данных по нескольким базам данных для конкретной программы. Отчеты с такой топологией часто охватывают несколько баз данных. Теперь с помощью запроса к эластичной базе данных можно подключиться к определенной базе данных SQL, при этом результаты запроса от удаленных баз данных будут отображаться таким образом, как если бы они были сгенерированы одной виртуальной базой данных.

> [AZURE.NOTE]Запрос к эластичной базе данных лучше всего подходит для нерегулярных отчетов, где большую часть обработки можно выполнить на уровне данных. Для высоких нагрузок отчетов или хранения данных с более сложными запросами вы можете использовать [хранилище данных SQL Azure](http://azure.microsoft.com/services/sql-data-warehouse/).


## Топология запросов к эластичным базам данных

В случае использования запроса к эластичной базе данных для выполнения отчетов на уровне горизонтально секционированных данных базы данных на этом уровне должны быть представлены с помощью карты сегментов для гибкого масштабирования. Как правило, в этом сценарии используется только одна карта сегментов, а также выделенная база данных с возможностью запросов к эластичной базе данных, которая служит точкой входа для запросов отчетности. Как следует из описания ниже, настройка объектов запросов к эластичным базам данных требуется только для этой выделенной базы данных. На рис. 2 показаны топология и ее настройка с использованием базы данных запросов к эластичным базам данных и карты сегментов.

> [AZURE.NOTE]Выделенная база данных запросов к эластичным базам данных должна представлять собой базу данных SQL версии 12 и изначально поддерживает только уровень Premium. К самим сегментам ограничения не применяются.

**На рис. 2**

![Использование запроса к эластичной базе данных для отчетов по сегментированным уровням][2]

(**Шардлет** представляет собой все данные, связанные с одним значением ключа сегментирования в сегменте. **Ключ сегментирования** — это значение столбца, который задает принцип распределения данных по сегментам. Например, в качестве ключа сегментирования для данных, распределенных по регионам, можно использовать идентификаторы регионов. Дополнительные сведения см. в [глоссарии гибкого масштабирования](sql-database-elastic-scale-glossary.md).)


Со временем функция запросов к эластичным базам данных начнет поддерживать дополнительные топологии. По мере появления новых функций данная статья будет обновляться.

## Активация эластичных запросов с помощью настройки карты сегментов

Создание решения для запросов к эластичным базам данных предполагает наличие [**карты сегментов**](sql-database-elastic-scale-shard-map-management.md) средств эластичной базы данных для представления удаленных баз данных в запросе. Если вы уже работаете с клиентской библиотекой эластичных баз данных, можно использовать существующую карту сегментов. В противном случае необходимо создать карту сегментов с помощью средств эластичной базы данных.

В следующем примере кода C# показано создание карты сегментов с одной удаленной базой данных, которая добавляется в качестве сегмента.

    ShardMapManagerFactory.CreateSqlShardMapManager(
      "yourconnectionstring",
      ShardMapManagerCreateMode.ReplaceExisting, RetryBehavior.DefaultRetryBehavior);
    smm = ShardMapManagerFactory.GetSqlShardMapManager(
      "yourconnectionstring",
      ShardMapManagerLoadPolicy.Lazy,
      RetryBehavior.DefaultRetryBehavior);
    map = smm.CreateRangeShardMap<int>("yourshardmapname");
    shard = map.CreateShard(new ShardLocation("yoursqldbserver", "yoursqldbdatabasename"));

Дополнительные сведения о картах сегментов см. в статье [Управление картой сегментов](sql-database-elastic-scale-shard-map-management.md).

Для использования функции запросов к эластичным базам данных сначала необходимо создать карту сегментов и зарегистрировать удаленные базы данных в качестве сегментов. Выполнить данную операцию достаточно всего один раз. Изменять карту сегментов требуется только при добавлении или удалении удаленных баз данных — эти операции выполняются уже для существующей карты сегментов.


## Создание объектов базы данных запросов к эластичным базам данных

Чтобы описывать удаленные таблицы, доступ к которым можно получить из конечной точки запроса к эластичной базе данных, была добавлена возможность определения внешних таблиц, которые будут отображаться в программе и сторонних инструментах так же, как и локальные таблицы. Запросы могут неявно передаваться от этих объектов базы данных с помощью инструментов или явным образом из SQL Server Management Studio, средств работы с данными Visual Studio или программы. Запрос к эластичной базе данных выполняется так же, как и любая другая инструкция Transact-SQL; единственным существенным отличием является распределение задач обработки по потенциально большому количеству удаленных баз данных, лежащих в основе внешних объектов.

Функция запроса к эластичной базе данных использует следующие четыре инструкции DDL. Как правило, эти инструкции используются лишь один раз или изредка в случае изменения схемы программы.

*    [CREATE MASTER KEY](https://msdn.microsoft.com/library/ms174382.aspx)
*    [CREATE CREDENTIAL](https://msdn.microsoft.com/library/ms189522.aspx)
*    [CREATE/DROP EXTERNAL DATA SOURCE](https://msdn.microsoft.com/library/dn935022.aspx)
*    [CREATE/DROP EXTERNAL TABLE](https://msdn.microsoft.com/library/dn935021.aspx)

### Главный ключ и учетные данные для конкретной базы данных

К учетным данным относятся идентификатор пользователя и пароль, используемые в запросе к эластичной базе данных для подключения к карте сегментов гибкого масштабирования и удаленным базам данных в базе данных SQL Azure. Необходимый главный ключ и учетные данные можно создать с помощью следующего синтаксиса:

    CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'password';  
    CREATE DATABASE SCOPED CREDENTIAL <credential_name>
    WITH IDENTITY = '<shard_map_username>',
    SECRET = '<shard_map_password>'
     [;]
Убедитесь, что значение &lt;shard\_map\_username> не содержит суффикс "@servername".

Сведения об учетных данных можно просмотреть в представлении каталогов sys.database\_scoped.credentials.

Для удаления главного ключа и учетных данных можно использовать следующий синтаксис:

    DROP CREDENTIAL <credential_name> ON DATABASE;
    DROP MASTER KEY;  

### Внешние источники данных

На следующем шаге необходимо зарегистрировать карту сегментов в качестве внешнего источника данных. Синтаксис для создания и удаления внешних источников данных определяется следующим образом.

      CREATE EXTERNAL DATA SOURCE <data_source_name> WITH
                     (TYPE = SHARD_MAP_MANAGER,
                     LOCATION = '<fully_qualified_server_name>',
                     DATABASE_NAME = '<shardmap_database_name>',
                     CREDENTIAL = <credential_name>,
                     SHARD_MAP_NAME = '<shardmapname>'
    ) [;]

Для удаления внешнего источника данных можно использовать следующую инструкцию:

    DROP EXTERNAL DATA SOURCE <data_source_name>[;]

Пользователь должен иметь разрешение ALTER ANY EXTERNAL DATA SOURCE. Это разрешение включено в разрешение ALTER DATABASE.

**Пример**

В следующем примере демонстрируется использование инструкции CREATE для внешних источников данных.

    CREATE EXTERNAL DATA SOURCE MyExtSrc
    WITH
    (
    TYPE=SHARD_MAP_MANAGER,
    LOCATION='myserver.database.windows.net',
    DATABASE_NAME='ShardMapDatabase',
    CREDENTIAL= SMMUser,
    SHARD_MAP_NAME='ShardMap'
    );

Список актуальных внешних источников данных можно получить в следующем представлении каталога:

    select * from sys.external_data_sources;

Обратите внимание на то, что для чтения карты сегментов и доступа к данным в удаленных базах данных во время обработки запроса используются одни и те же учетные данные.


### Внешние таблицы

Запрос к эластичной базе данных позволяет расширить существующий синтаксис внешних таблиц до таблиц, разнесенных по (нескольким) удаленным базам данных в базе данных SQL Azure. В соответствии с вышеописанной концепцией источников внешних данных, для создания и удаления внешних таблиц задается следующий синтаксис:

    CREATE EXTERNAL TABLE [ database_name . [ dbo ] . | dbo. ] table_name
        ( { <column_definition> } [ ,...n ])
        { WITH ( <sharded_external_table_options> ) }
    )[;]

    <sharded_external_table_options> ::=
          DATA_SOURCE = <External_Data_Source>,
          DISTRIBUTION = SHARDED(<sharding_column_name>) | REPLICATED | ROUND_ROBIN

Обработка таблицы как сегментированной или реплицированной зависит от политики сегментирования. В случае сегментированной таблицы данные разных сегментов не перекрываются. В свою очередь, реплицированные таблицы содержат одни и те же данные для каждого сегмента. Эта информация помогает обработчику запросов правильно и более эффективно обрабатывать запросы. Циклическое распределение указывает на использование определенного метода распределения данных из этой таблицы для конкретной программы.

    DROP EXTERNAL TABLE [ database_name . [ dbo ] . | dbo. ] table_name[;]

Разрешения для инструкции **CREATE/DROP EXTERNAL TABLE**: требуются разрешения ALTER ANY EXTERNAL DATA SOURCE, также необходимые для ссылки на базовый источник данных.

**Пример.** Далее показано создание внешней таблицы.

    CREATE EXTERNAL TABLE [dbo].[order_line](
        [ol_o_id] [int] NOT NULL,
        [ol_d_id] [tinyint] NOT NULL,
        [ol_w_id] [int] NOT NULL,
        [ol_number] [tinyint] NOT NULL,
        [ol_i_id] [int] NOT NULL,
        [ol_delivery_d] [datetime] NOT NULL,
        [ol_amount] [smallmoney] NOT NULL,
        [ol_supply_w_id] [int] NOT NULL,
        [ol_quantity] [smallint] NOT NULL,
        [ol_dist_info] [char](24) NOT NULL
    )
    WITH
    (
        DATA_SOURCE = MyExtSrc,
        DISTRIBUTION=SHARDED(ol_w_id)
    );

В следующем примере показано получение списка внешних таблиц из текущей базы данных:

    select * from sys.external_tables;


## Отчетность и выполнение запросов

### Запросы
После определения источника внешних данных и внешних таблиц можно использовать уже известные строки подключения к базе данных SQL для соединения с базой данных, для которой была подключена функция запросов к эластичным базам данных. Теперь вы можете использовать полные запросы только для чтения для внешних таблиц с некоторыми ограничениями, описанными ниже в разделе [Ограничения](#preview-limitations).

**Пример.** С помощью следующего запроса устанавливается трехстороннее соединение между хранилищами, заказами и строками заказов, при этом используется несколько статистических выражений и выборочный фильтр. Предположим, что хранилища, заказы и строки заказов секционированы по столбцу с идентификатором хранилища, — в этом случае запрос к эластичной базе данных может выровнять соединения на удаленных базах данных и масштабировать выполнение ресурсоемкой части запроса.

    select
        w_id as warehouse,
        o_c_id as customer,
        count(*) as cnt_orderline,
        max(ol_quantity) as max_quantity,
        avg(ol_amount) as avg_amount,
        min(ol_delivery_d) as min_deliv_date
    from warehouse
    join orders
    on w_id = o_w_id
    join order_line
    on o_id = ol_o_id and o_w_id = ol_w_id
    where w_id > 100 and w_id < 200
    group by w_id, o_c_id

### Хранимая процедура SP\_ EXECUTE\_FANOUT

SP\_EXECUTE\_FANOUT — это хранимая процедура, предоставляющая доступ к базам данных, представленным в карте сегментов. Хранимая процедура имеет следующие параметры:

-    **Имя сервера** (nvarchar): полное имя логического сервера, на котором размещена карта сегментов.
-    **Имя базы данных карты сегментов** (nvarchar): имя базы данных карты сегментов.
-    **Имя пользователя** (nvarchar): имя пользователя для входа в базу данных карты сегментов и удаленные базы данных.
-    **Пароль** (nvarchar): пароль пользователя.
-    **Имя сегмента карты** (nvarchar): имя карты сегментов, используемое в запросе.
-    **Запрос**: запрос, выполняемый для каждого сегмента.

В рамках процедуры данные карты сегментов, предоставляемые в параметрах вызова, используются для выполнения данной инструкции в отношении всех сегментов, зарегистрированных в карте сегментов. Любые результаты объединяются с помощью семантики UNION ALL, аналогичной семантике запросов с несколькими сегментами. Результаты также содержат дополнительный "виртуальный" столбец с именем удаленной базы данных.

Обратите внимание на то, что для подключения к базе данных карты сегментов и к сегментам используются одни и те же исходные данные.

**Пример.**

    sp_execute_fanout 'myserver.database.windows.net', N'ShardMapDb', N'myuser', N'MyPwd', N'ShardMap', N'select count(w_id) as foo from warehouse'

## Подключение для инструментов
Для подключения к инструментам бизнес-аналитики и интеграции данных можно использовать уже знакомые вам строки подключения к базе данных SQL с базой данных запросов к эластичным базам данных. Убедитесь, что в качестве источника данных для вашего инструмента поддерживается SQL Server. Затем используйте внешние объекты базы данных запросов к эластичным базам данных так же, как и для любой другой базы данных SQL Server, к которой требуется подключиться с помощью вашего инструмента.

## Рекомендации
*    Убедитесь, что в правилах брандмауэра базы данных диспетчера карты сегментов и баз данных, заданных в карте сегментов, разрешен доступ из Microsoft Azure. Это необходимо для подключения к ним базы данных запросов к эластичным базам данных. Дополнительные сведения см. в статье [Брандмауэр базы данных SQL Azure](https://msdn.microsoft.com/library/azure/ee621782.aspx).
*    Запрос к эластичной базе данных не предполагает проверку или распределение данных в соответствии с внешней таблицей. Если фактическое распространение данных отличается от определения таблицы, то результаты запросов могут быть непредсказуемыми.
*    Запрос к эластичной базе данных оптимален для тех запросов, в которых основная часть вычислений может быть выполнена в сегментах. Обычно наиболее эффективны запросы с предикатами выборочных фильтров, дающие возможность вычисления в сегментах или соединениях путем секционирования ключей с выравниванием по секциям для всех сегментов. Для других шаблонов запросов может потребоваться загрузка больших объемов данных из сегментов в головном узле, что может стать причиной снижения производительности.

## Стоимость

Функция запросов к эластичным базам данных включена в стоимость баз данных SQL Azure. Обратите внимание на поддержку топологий, в которых удаленные базы данных и конечная точка запроса к эластичной базе данных находятся в разных центрах обработки данных, при этом стоимость выхода данных из удаленных баз данных рассчитывается по тарифам Azure для стандартной пропускной способности.

## Ограничения предварительной версии

В отношении предварительной версии необходимо учесть несколько нюансов.

*    Функция запросов к эластичным базам данных изначально доступна только на уровне производительности базы данных SQL версии 12 Premium, тогда как уровень удаленных баз данных, доступ к которым осуществляется через запрос к эластичным базам данных, может быть любым.
* Внешние таблицы, ссылки на которые содержатся во внешнем источнике данных, поддерживают только операции чтения из удаленных баз данных. Тем не менее вы можете указать полный набор функций Transact-SQL в базе данных запросов к эластичным базам данных, где непосредственно находится определение внешней таблицы. Например, это может быть целесообразно для хранения временных результатов с помощью столбца SELECT таблицы list INTO local или для определения хранимых процедур со ссылками на внешние таблицы в базе данных запросов к эластичным базам данных.
*    В настоящее время параметры запросов не могут быть отправлены в удаленные базы данных. Параметризованные запросы должны будут переносить на головной узел все данные, что в зависимости от размера этих данных может привести к снижению производительности. Временным решением этой проблемы является исключение параметров из запросов или использование опции RECOMPILE для автоматической замены параметров на их текущие значения.
* Статистика по внешним таблицам на уровне столбцов пока что не поддерживается.
* Функция запросов к эластичным базам данных в настоящее время не позволяет исключать сегменты, когда предикаты для ключа сегментирования безопасно исключают определенные удаленные базы данных из процесса обработки. В результате запросы всегда связаны со всеми удаленными базами данных, представленными внешними источниками данных запроса.
* Любые запросы, включающие соединения между таблицами в разных базах данных, могут возвращать в базу данных запросов к эластичным базам данных большое количество строк для обработки, что повышает затраты на поддержание производительности. Оптимальным решением является разработка запросов с возможностью локальной обработки в каждой удаленной базе данных или использование предложений WHERE для ограничения строк из каждой базы данных перед выполнением соединения.
*    Синтаксис, используемый в определении метаданных запроса к эластичным базам данных, в предварительной версии будет изменен.
*    В настоящее время функции скриптов Transact-SQL в SSMS или SSDT недоступны для объектов запросов к эластичным базам данных.

## Отзыв
Приглашаем вас поделиться мнением о работе с нами на Disqus или Stackoverflow. Мы будем признательны за любые отзывы о нашем сервисе, в том числе за сообщения о недостатках, недоработках и недостающих функциях.

## Дальнейшие действия
Чтобы начать изучение функции запросов к эластичным базам данных, обратитесь к нашему пошаговому руководству. Уже через несколько минут вы сможете запустить полнофункциональный рабочий пример: [Начало работы с запросами к эластичным базам данных](sql-database-elastic-query-getting-started.md).


[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-query-overview/overview.png
[2]: ./media/sql-database-elastic-query-overview/topology1.png

<!--anchors-->

<!---HONumber=August15_HO8-->