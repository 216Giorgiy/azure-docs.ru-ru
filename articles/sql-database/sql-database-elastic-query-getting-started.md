<properties
	pageTitle="Приступая к работе с запросом к эластичной базе данных"
	description="как использовать запрос к эластичной базе данных"
	services="sql-database"
	documentationCenter=""  
	manager="jeffreyg"
	authors="sidneyh"/>

<tags
	ms.service="sql-database"
	ms.workload="sql-database"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="06/23/2015"
	ms.author="sidneyh" />

# Приступая к работе с запросом к эластичной базе данных

Запрос (предварительная версия) к гибкой базе данных для базы данных Azure SQL позволяет выполнять запросы T-SQL, охватывающие несколько баз данных, с помощью одной точки подключения. Дополнительные сведения о функции запросов к гибкой базе данных см. на [странице с обзором функций](sql-database-elastic-query-overview.md).

В этом разделе более подробным образом рассматривается пример из раздела [Приступая к работе с инструментами эластичной базы данных](sql-database-elastic-scale-get-started.md). Будут представлены способы настройки и использования базы данных Azure SQL для выполнения запросов, охватывающих несколько связанных баз данных.
## Предварительные требования

Загрузите и запустите пример [Приступая к работе с инструментами эластичной базы данных](sql-database-elastic-scale-get-started.md).

## Создание диспетчера сопоставления сегментов с помощью примера приложения

Здесь мы создадим диспетчер сопоставления сегментов вместе с несколькими сегментами, а затем выполним вставку данных в сегменты. Если вы уже знакомы с настройкой сегментов с помощью сегментированных данных, описанные ниже действия можно пропустить и перейти к следующему разделу.

1. Постройте и запустите пример приложения **Приступая к работе с инструментами эластичной базы данных**. Следуйте инструкциям до шага 7 в разделе [Загрузка и запуск примера приложения](sql-database-elastic-scale-get-started.md#Getting-started-with-elastic-database-tools). В конце шага 7 появится следующее окно командной строки:

	![окно командной строки.][1]

2.  В окне команд введите "1" и нажмите клавишу **ВВОД**. Это позволит создать диспетчер сопоставления сегментов и добавить два сегмента на сервер. Затем введите "3" и нажмите клавишу **ВВОД**. Повторите данное действие четыре раза. Это позволит вставить строки демонстрационных данных в свои сегменты.
3.  На [портале предварительной версии Azure](https://portal.azure.com) должны появиться три новые базы данных на сервере v12:

	![Подтверждение Visual Studio][2]

	На этом этапе межбазовые запросы поддерживаются с помощью клиентских библиотек эластичной базы данных. Например, используйте параметр 4 в окне команд. Результатами многосегментного запроса всегда являются объединением типа **UNION ALL** результатов из всех сегментов.

	В следующем разделе мы создадим пример конечной точки базы данных, которая поддерживает расширенные запросы данных по сегментам.

## Создание запросов к эластичной базе данных

1. Откройте [портал предварительной версии Azure](https://portal.azure.com) и войдите в систему.
2. Создайте новую базу данных Azure SQL на том же сервере, где находятся ваши сегменты. Назначьте базе данных имя ElasticDBQuery. Для ценовой категории необходимо выбрать одно из предложений premium. В настоящее время запрос к эластичной базе данных может выполняться только на уровне premium.

	![Портал Azure и ценовая категория][3]

	Примечание: можно использовать существующую базу данных premium. Но в данном случае база данных не должна быть одним из сегментов, в которых вы хотите выполнять свои запросы. Эта база данных будет использоваться для создания объектов метаданных для запроса к эластичной базе данных.


## Создание объектов базы данных

### Главный ключ и учетные данные для конкретной базы данных

Они используются для подключения к диспетчеру сопоставления сегментов и сегментам:

1. Откройте SQL Server Management Studio или SQL Server Data Tools в Visual Studio.
2. Подключитесь к базе данных ElasticDBQuery и выполните следующие команды T-SQL:

		CREATE MASTER KEY ENCRYPTION BY PASSWORD = '<password>';

		CREATE CREDENTIAL ElasticDBQueryCred ON DATABASE
		WITH IDENTITY = '<username>',
		SECRET = '<password>';

	"имя пользователя" и "пароль" должны быть идентичны имени и паролю, используемым на шаге 6 [Загрузка и запуск примера приложения](sql-database-elastic-scale-get-started.md#Getting-started-with-elastic-database-tools) в разделе [Приступая к работе с инструментами эластичной базы данных](sql-database-elastic-scale-get-started.md).


### Внешние источники данных

Для создания внешнего источника данных выполните следующую команду в базе данных ElasticDBQuery.

	CREATE EXTERNAL DATA SOURCE MyElasticDBQueryDataSrc WITH
      (TYPE = SHARD_MAP_MANAGER,
      LOCATION = '<server_name>.database.windows.net',
      DATABASE_NAME = 'ElasticScaleStarterKit_ShardMapManagerDb',
	  CREDENTIAL = ElasticDBQueryCred,
 	  SHARD_MAP_NAME = 'CustomerIDShardMap'
    ) ;

 CustomerIDShardMap — это имя карты сегментов, если вы создали карту сегментов и диспетчер сопоставления сегментов с помощью примера инструментов эластичной базы данных. Тем не менее, если вы использовали свои пользовательские настройки для этого примера, то это должно быть имя карты сегментов, которое было выбрано в приложении.

### Внешние таблицы

Создайте внешнюю таблицу, которая соответствует таблице Customers на сегментах, путем выполнения следующей команды в базе данных ElasticDBQuer:

	CREATE EXTERNAL TABLE [dbo].[Customers]
	( [CustomerId] [int] NOT NULL,
	  [Name] [nvarchar](256) NOT NULL,
	  [RegionId] [int] NOT NULL)
	WITH
	( DATA_SOURCE = MyElasticDBQueryDataSrc,
      DISTRIBUTION = SHARDED([CustomerId])
	) ;

## Выполнение запроса T-SQL к примеру эластичной базы данных

После определения источника внешних данных и внешних таблиц теперь можно использовать полный T-SQL для внешних таблиц.

Выполните следующий запрос в базе данных ElasticDBQuery:

	select count(CustomerId) from [dbo].[Customers]

Следует отметить, что запрос объединяет результаты из всех сегментов и дает следующий результат:

![Сведения о выходных данных][4]

## Импорт в Excel результатов запроса к эластичной базе данных

 Результаты запроса можно импортировать в файл Excel.

1. Запустите Excel 2013.
2. 	Перейдите на ленту **Данные**.
3. 	Щелкните **Из других источников**, а затем **Из SQL Server**.

	![Импорт в Excel из других источников][5]
4. 	В **мастере подключения к данным** введите имя сервера и учетные данные для входа. Нажмите кнопку **Далее**.
5. 	В диалоговом окне **Выберите базу данных, которая содержит требуемые данные** выберите базы данных **ElasticDBQuery**.
6. 	Выберите таблицу **Клиенты** в представлении списка и нажмите кнопку **Далее**. Нажмите кнопку **Готово**.
7. 	В форме **Импорт данных** в разделе **Выберите способ просмотра этих данных в книге** выберите **Таблица** и нажмите кнопку **ОК**.

Все строки из таблицы **Клиенты**, хранящиеся в различных сегментах, попадают на лист Excel.

## Дальнейшие действия
Теперь можно использовать мощные функции Excel по обработке данных. Для подключения к эластичной базе данных своих инструментов бизнес-аналитики и интеграции данных можно использовать строку подключения с именем сервера, именем базы данных и учетными данными. Убедитесь, что в качестве источника данных для вашего инструмента поддерживается SQL Server. На запрос к эластичной базе данных и внешние таблицы можно ссылаться таким же образом, как и на любую другую базу данных SQL Server и таблицы SQL Server, которые вы хотите подключить с помощью своего инструмента.

### Стоимость
За использование функции запросов к эластичной базе данных дополнительная плата отсутствует. Однако в настоящее время эта функция доступна только в базах данных premium как конечная точка, а сегменты могут находиться на любом уровне служб.

Сведения о ценах см. в разделе [Информация о ценах на базу данных SQL](http://azure.microsoft.com/pricing/details/sql-database/).


[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-query-getting-started/cmd-prompt.png
[2]: ./media/sql-database-elastic-query-getting-started/portal.png
[3]: ./media/sql-database-elastic-query-getting-started/tiers.png
[4]: ./media/sql-database-elastic-query-getting-started/details.png
[5]: ./media/sql-database-elastic-query-getting-started/exel-sources.png
<!--anchors-->

<!---HONumber=July15_HO2-->