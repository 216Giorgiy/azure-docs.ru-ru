<properties
   pageTitle="Управление хранилищем запросов в базе данных SQL Azure"
   description="Узнайте, как управлять хранилищем запросов в базе данных SQL Azure"
   keywords=""
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jhubbard"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="performance"
   ms.workload="data-management"
   ms.date="05/25/2016"
   ms.author="carlrab"/>

# Управление хранилищем запросов в базе данных SQL Azure 

Хранилище запросов в Azure является полностью управляемой службой базы данных, которая непрерывно собирает и предоставляет подробные статистические сведения обо всех запросах. Хранилище запросов можно рассматривать как аналог бортового самописца, который значительно упрощает устранение проблем, отражающихся на производительности запросов, для клиентов в облаке и в локальной среде. В этой статье объясняются некоторые аспекты управления хранилищем запросов в Azure. С помощью предварительно собранных данных о запросах пользователи могут быстро диагностировать и устранять проблемы с производительностью, что позволяет уделять больше времени основным рабочим задачам.

Хранилище запросов [глобально доступно](https://azure.microsoft.com/updates/general-availability-azure-sql-database-query-store/) в базе данных SQL Azure с ноября 2015 г. Хранилище запросов является основой для анализа производительности и настройки компонентов, таких как [помощник по настройке базы данных SQL и панель мониторинга производительности](https://azure.microsoft.com/updates/sqldatabaseadvisorga/). На момент публикации этой статьи хранилище запросов работает в более чем 200 000 пользовательских баз данных в Azure, безостановочно собирая информацию о запросах за несколько месяцев.

> [AZURE.IMPORTANT] Корпорация Майкрософт работает над тем, чтобы хранилище запросов стало доступно для всех баз данных Azure SQL (как существующих, так и новых). Этот процесс пока включает только одноэлементные базы данных, но в ближайшем будущем он будет расширен и на базы данных в пуле эластичных БД. Если вы используете пулы эластичных БД, включайте хранилище запросов только для небольшого подмножества баз данных. Если включить хранилище запросов для всех баз данных в пуле эластичных БД, это может привести к чрезмерному использованию ресурсов и неработоспособности системы.

## Хранилище запросов как управляемый компонент в базе данных SQL Azure

Работа хранилища запросов в базе данных SQL Azure основана на двух фундаментальных принципах:

- не оказывать заметного влияния на рабочую нагрузку клиента;
- непрерывно отслеживать запросы, если это не влияет на рабочую нагрузку.

Влияние на рабочую нагрузку клиента оценивается по двум факторам.

- ***Доступность***. Требования соглашения об уровне обслуживания для базы данных SQL не снижаются при работе хранилища запросов.
- ***Производительность***. Дополнительные издержки, связанные с работой хранилища запросов, в среднем обычно не превышают 1–2 %.

Хранилище запросов в Azure работает с ограниченными ресурсами (ЦП, память, дисковые операции ввода-вывода, место на диске и т. д.). Оно учитывает различные системные ограничения, чтобы как можно меньше влиять на обычную рабочую нагрузку. В целом хранилище запросов учитывает два типа ограничений ресурсов.

- ***Статические ограничения:*** ограничения, налагаемые емкостью ресурсов для каждого уровня служб ("Базовый", "Стандартный", "Премиум", пул эластичных БД).
- ***Динамические ограничения:*** ограничения, связанные с текущим уровнем потребления ресурсов рабочей нагрузкой (т. е. доступные ресурсы).

Чтобы обеспечить непрерывность и надежность работы, база данных SQL Azure использует инфраструктуру постоянного мониторинга на базе хранилища запросов, которое собирает основные операционные данные по каждой базе данных. Это позволяет непрерывно отслеживать несколько технических ключевых показателей эффективности для обеспечения надежности:

- количество исключений и автоматических исправлений;
- количество баз данных в состоянии "только для чтения" и продолжительность таких состояний;
- базы данных, для которых чаще всего и дольше всего выполняется автоматическая очистка;
- базы данных с максимальным временем загрузки данных в память (во время инициализации);
- базы данных с максимальным временем записи данных на диск.

База данных SQL Azure использует собранные данные в следующих целях.

- ***Решение или устранение проблем, вызванных работой хранилища запросов.*** База данных SQL Azure может обнаруживать и устранять проблемы, оказывающие значительное влияние на рабочую нагрузку клиента, с небольшой задержкой (менее одного часа). Чаще всего такие проблемы устраняются путем временного ***отключения*** хранилища запросов.
- ***Изучение закономерностей использования на основе большого количества баз данных с целью повышения качества и стабильности компонентов.*** Хранилище запросов регулярно совершенствуется при каждом обновлении базы данных SQL Azure. 

Время от времени обновление хранилища запросов включает изменение значений по умолчанию для внутренних и, реже, внешних (предназначенных для клиентов) настроек системы. Взаимодействие клиента с хранилищем запросов в базе данных SQL Azure может отличаться от работы в локальной среде, так как платформа хранилища запросов выполняет ряд действий автоматически.

- Хранилище запросов может быть ***отключено*** для устранения проблем и снова ***включено*** после их устранения.
- Конфигурация хранилища запросов может изменяться для повышения надежности работы. Возможны разные варианты:
    - изменения для отдельных баз данных, нацеленные на устранение нестабильности или ненадежности;
    - глобальные развертывания оптимальной конфигурации, полезные одновременно для всех баз данных, использующих хранилище запросов.

***Отключение*** хранилища запросов выполняется автоматически и только для отдельных баз данных. Оно может происходить, если поведение платформы отрицательно влияет на базы данных пользователя (в таком случае механизм обнаружения выдает соответствующее предупреждение). Для этой конкретной базы данных хранилище запросов остается ***отключенным*** до тех пор, пока не появится новая улучшенная реализация хранилища запросов. При переходе хранилища запросов в ***отключенное*** состояние клиент получает извещение по электронной почте. В извещении содержится рекомендация не включать хранилище запросов, пока не будет развернута новая версия. После нового развертывания инфраструктура базы данных SQL Azure автоматически активирует хранилище запросов для всех баз данных, для которых оно было ***отключено***.

Иногда база данных SQL Azure может принудительно применять для всех пользовательских баз данных новые значения конфигурации по умолчанию, оптимизированные для надежной работы и непрерывного сбора данных.

## Оптимальная конфигурация хранилища запросов

В этом разделе описываются оптимальные настройки по умолчанию, которые призваны обеспечить надежную работу хранилища запросов и зависимых компонентов, таких как [помощник по настройке базы данных SQL и панель мониторинга производительности](https://azure.microsoft.com/updates/sqldatabaseadvisorga/). По умолчанию конфигурация оптимизирована для постоянного сбора данных, т. е. для минимальной продолжительности состояний "отключено" и "только для чтения".

| Конфигурация | Описание | значение по умолчанию | Комментарий |
| ------------- | ----------- | ------- | ------- |
| MAX\_STORAGE\_SIZE\_MB | Предельный размер пространства данных, которое хранилище запросов использует в базе данных клиента. | 100 | Принудительно для новых баз данных |
| INTERVAL\_LENGTH\_MINUTES | Определяет время, в течение которого объединяются и сохраняются собранные статистические данные среды выполнения по планам запросов. Для каждого активного плана запроса в течение периода, заданного в этом параметре, будет сохраняться только одна строка. | 60 | Принудительно для новых баз данных |
| STALE\_QUERY\_THRESHOLD\_DAYS | Политика очистки на основе времени, которая контролирует срок хранения статистики для среды выполнения и неактивных запросов. | 30 | Принудительно для новых баз данных и баз данных с предыдущим значением по умолчанию (367) |
| SIZE\_BASED\_CLEANUP\_MODE | Указывает, нужно ли выполнять автоматическую очистку данных при приближении к предельному значению, установленному для размера данных хранилища запросов. | AUTO (АВТОМАТИЧЕСКИ) | Принудительно для всех баз данных |
| QUERY\_CAPTURE\_MODE | Указывает, следует ли отслеживать все запросы или только определенное подмножество. | AUTO (АВТОМАТИЧЕСКИ) | Принудительно для всех баз данных |
| FLUSH\_INTERVAL\_SECONDS | Указывает максимальный период, в течение которого статистика среды выполнения будет храниться в памяти перед записью на диск. | 900 | Принудительно для новых баз данных |
||||||

Указанные выше значения по умолчанию будут автоматически применяться на последнем этапе активации хранилища запросов для всех баз данных Azure SQL. После этого база данных SQL Azure не будет изменять значения настроек, заданные пользователями, за исключением случаев негативного влияния на основную рабочую нагрузку или на надежность работы хранилища запросов.

Если вы хотите сохранить свои пользовательские настройки, используйте [параметры ALTER DATABASE для хранилища запросов](https://msdn.microsoft.com/library/bb522682.aspx), чтобы восстановить предыдущее состояние конфигурации. Изучите [рекомендации по использованию хранилища запросов](https://msdn.microsoft.com/library/mt604821.aspx), чтобы научиться правильно выбирать оптимальные параметры конфигурации.

## Дальнейшие действия

[Анализ производительности базы данных SQL](sql-database-performance.md)

## Подробнее

Дополнительные сведения вы найдете в следующих статьях.

- [Query Store: A flight data recorder for your database](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database) (Хранилище запросов: "бортовой самописец" для вашей базы данных) 

- [Query Store Usage Scenarios](https://msdn.microsoft.com/library/mt614796.aspx) (Сценарии использования хранилища запросов)

- [Мониторинг производительности с использованием хранилища запросов](https://msdn.microsoft.com/library/dn817826.aspx)

<!---HONumber=AcomDC_0525_2016-->