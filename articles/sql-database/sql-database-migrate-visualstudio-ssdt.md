<properties 
   pageTitle="Миграция с помощью Visual Studio и SSDT" 
   description="База данных SQL Microsoft Azure, перенос базы данных, импорт базы данных, экспорт базы данных, мастер миграции" 
   services="sql-database" 
   documentationCenter="" 
   authors="pehteh" 
   manager="jeffreyg" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-management" 
   ms.date="04/14/2015"
   ms.author="pehteh"/>

#Обновление базы данных на месте с последующим развертыванием в Базе данных SQL Azure

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/01VSSSDTDiagram.png)

Используйте этот вариант, если для переноса базы данных в Базу данных SQL Azure V12 в схему необходимо внести изменения, которые не поддерживаются мастером миграции SQL Azure (SAMW). Это происходит в случае, когда база данных использует компоненты SQL Server, которые не поддерживаются в Базе данных SQL Azure (или поддержка которых пока не реализована). В этом случае Visual Studio сначала используется для создания проекта базы данных из базы данных-источника. Затем в качестве целевой платформы проекта задается База данных SQL Azure V12 и выполняется создание проекта для выявления всех проблем совместимости. Многие из проблем совместимости (но не все) можно устранить с помощью SAMW, поэтому этот мастер используется для обработки всех сценариев в проектах во время первого прохода. Использовать SAMW необязательно, однако мы рекомендуем это сделать. Создавая проект после обработки файлов сценариев с помощью SAMW, вы сможете определить оставшиеся проблемы, которые затем можно устранить вручную с помощью средств редактирования T-SQL в Visual Studio. После успешного создания проекта схема публикуется обратно в копии (рекомендуется) базы данных-источника для обновления ее схемы и данных на месте. Затем обновленная база данных развертывается в Azure (либо напрямую, либо путем экспорта и импорта файла BACPAC с помощью методик, описанных в первом варианте.
 
Поскольку перед развертыванием базы данных в Azure этот вариант включает обновление схемы базы данных на месте, настоятельно рекомендуется выполнить обновление с использованием копии базы данных. Для просмотра полного набора изменений, которые будут применены к базе данных перед публикацией проекта, можно воспользоваться средством сравнения схем Visual Studio.

Использовать мастер миграции SQL Azure (SAMW) необязательно, однако мы рекомендуем это сделать. SAMW позволяет обнаружить проблемы совместимости в теле функций, хранимых процедур и триггеров, которые невозможно обнаружить до развертывания. Если требуется развернуть только схему, то обновленную схему можно опубликовать в Базе данных SQL Azure непосредственно из Visual Studio.

## Этапы миграции

1.	Откройте **обозреватель объектов SQL Server** в Visual Studio. Выберите **Добавить SQL Server** для подключения к экземпляру SQL Server, содержащему базу данных для переноса. Найдите базу данных в обозревателе, щелкните ее правой кнопкой мыши и выберите команду **Создать новый проект**. 

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/02MigrateSSDT.png)

2.	В настройках параметров импорта установите флажок **Импортировать только объекты области приложения**. Снимите флажки для импорта упоминаемых имена входа, разрешений и параметров базы данных.

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/03MigrateSSDT.png)

3.	Нажмите кнопку **Начать**, чтобы приступить к импорту базы данных и создать проект, который будет содержать файл сценария T-SQL для каждого объекта в базе данных. Файлы сценариев вложены в папки проекта.

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/04MigrateSSDT.png)

4.	В обозревателе решений Visual Studio щелкните правой кнопкой мыши проект базы данных и выберите "Свойства". После этого откроется страница **Параметры проекта**, на которой необходимо настроить целевую платформу для Базы данных SQL Microsoft Azure V12.

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/05MigrateSSDT.png)

5.	Необязательно: щелкните правой кнопкой мыши проект и выберите **Создать**, чтобы создать проект (это не является строго обязательным на этом этапе, однако это обеспечит базовый уровень для количества проблем совместимости в проекте и более эффективное выполнение следующих шагов).

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/06MigrateSSDT.png)

6.	Необязательно: щелкните правой кнопкой мыши проект и выберите **Моментальный снимок проекта**. С помощью моментальных снимков, полученных в начале и, возможно, на более поздних этапах преобразования, можно сравнить схемы на каждом этапе с помощью инструмента сравнения схем.

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/07MigrateSSDT.png). При создании моментального снимка проекта создается файл DACPAC с отметкой времени, в котором содержится полная схема проекта. Этому файлу можно присвоить имя, указывающее на этап процесса, на котором был создан данный моментальный снимок. ![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/08MigrateSSDT.png)

7.	Обработайте импортированные файлы сценариев с помощью мастера миграции SQL Azure (SAMW). Установите переключатель "Папка TSQL" и выберите корневую папку проекта. ![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/09MigrateSSDT.png)

8.	Мастер обработает каждый файл сценария в этой папке и во всех вложенных в нее папках. На следующей странице будет представлена сводка результатов. ![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/10MigrateSSDT.png)
9.	Чтобы просмотреть сводный список файлов, которые были изменены, нажмите кнопку "Далее". 

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/11MigrateSSDT.png)

>Обратите внимание, что в расположениях, указанных в верхней части страницы, создаются временные копий как исходных файлов до обработки, так и затронутых файлов после обработки.

10.	Нажмите кнопку "Перезаписать", а затем — кнопку "ОК" в диалоговом окне подтверждения. После этого исходные файлы будут перезаписаны измененными файлами. Обратите внимание, что будут перезаписаны только те файлы, которые действительно были изменены.
11.	Необязательный параметр. Выберите пункт "Сравнение схем", чтобы сравнить проект с исходной базой данных или с моментальным снимком, созданным ранее, и понять, какие изменения были внесены с помощью мастера. На этом этапе также может потребоваться сделать еще один моментальный снимок проекта. 

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/12MigrateSSDT.png)

12.	Снова создайте проект (см. соответствующий шаг выше), чтобы определить, какие ошибки остались.

13.	Изучите ошибки и устраните каждую проблему. Оцените влияние каждого изменения на приложения, использующие эту базу данных.

14.	Устранив все ошибки, щелкните правой кнопкой мыши проект и выберите команду **Опубликовать**, чтобы создать и опубликовать базу данных в копии базы данных-источника (настоятельно рекомендуется использовать именно копию, по крайней мере первоначально). Цель этого этапа — обновить схему базы данных-источника и внести все последующие изменения в данные, находящиеся в ней.
- В зависимости от версии SQL Server источника перед публикацией может потребоваться сбросить целевую платформу проекта, чтобы обеспечить возможность развертывания. Если вы переносите старую базу данных SQL Server, вам не следует добавлять в проект какие-либо функции, которые не поддерживается исходным сервером SQL Server, за исключением случаев, когда база данных сначала была перенесена в более новую версию SQL Server. 
- Необходимо настроить этап публикации, чтобы включить соответствующие параметры публикации. Например, если вы удалили неподдерживаемые объекты в проекте или добавили комментарии к ним, то их необходимо удалить из базы данных. Поэтому необходимо разрешить публикацию, чтобы в целевой базе данных можно было удалить соответствующие данные. 
- Если предполагается повторная публикация 

15.	Разверните скопированную базу данных в Базу данных SQL Azure с помощью методик, описанных в первом варианте.

## Проверка миграции

После завершения миграции рекомендуется сравнить схемы в перенесенной базе данных со схемой базы данных-источника, чтобы ознакомиться с изменениями, которые были внесены и убедиться в том, что они сделаны надлежащим образом и не вызовут проблем при миграции приложений в новую базу данных. Для этого можно воспользоваться средством сравнения схем, которое входит в набор средств для работы с SQL Server в Visual Studio. Можно сравнить базу данных в Базе данных SQL Azure с исходной базой данных SQL Server или с моментальным снимком, созданным во время первого импорта базы данных в проект.

1.	Подключитесь к серверу в базе данных SQL Azure, на котором находится перенесенная база данных, и найдите ее. 

2.	Щелкните правой кнопкой мыши базу данных и выберите пункт **Сравнение схем.**. После этого откроется новое окно со сравнением схем, в котором слева в качестве исходной базы данных будет указана база данных Azure. В раскрывающемся списке "Выбор целевого объекта" справа выберите целевую базу данных или файл моментального снимка для сравнения.

3.	Выбрав исходную и целевую базы данных, нажмите кнопку "Сравнить", чтобы запустить процедуру сравнения. Загрузка схемы из сложной базы данных в Базе данных SQL Azure может занять значительное время. Если вы приобрели продукт более высокой ценовой категории, то загрузка схемы и выполнение других задач с метаданными в базе данных Azure SQL займет меньше времени.

4.	По завершении сравнения изучите различия между базами данных. Как правило, применять изменения к любой из схем следует только избавившись от любых сомнений.

Ниже представлен пример сравнения схем базы данных Adventure Works 2014 в Базе данных SQL Azure V12 (слева), которая была преобразована и перенесена с помощью мастера миграции SQL Azure, с базой данных-источником на сервере SQL Server (справа).

![замещающий текст](./media/sql-database-migrate-visualstudio-ssdt/13MigrateSSDT.png)

<!---HONumber=58--> 