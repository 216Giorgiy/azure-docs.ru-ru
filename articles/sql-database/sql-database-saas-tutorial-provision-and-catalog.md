---
title: "Подготовка новых клиентов в мультитенантном приложении, использующем базу данных SQL Azure | Документация Майкрософт"
description: "Узнайте, как подготовить и каталогизировать новые клиенты в приложении SaaS Wingtip."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/31/2017
ms.author: sstein
ms.translationtype: Human Translation
ms.sourcegitcommit: fc27849f3309f8a780925e3ceec12f318971872c
ms.openlocfilehash: f6beb62246aaf59bfd81467f07d347913a20677b
ms.contentlocale: ru-ru
ms.lasthandoff: 06/14/2017


---
# <a name="provision-new-tenants-and-register-them-in-the-catalog"></a>Подготовка новых клиентов и их регистрация в каталоге

В этом руководстве рассматривается развертывание новых клиентов в приложении SaaS Wingtip. Вы создадите клиенты, подготовив базы данных клиента, и зарегистрируете клиенты в каталоге. *Каталог* является базой данных, обеспечивающей сопоставление между клиентами приложения SaaS и их данными.

Используйте эти сценарии, чтобы изучить модели подготовки и каталогизации, а также узнать о реализации регистрации новых клиентов в каталоге. Каталог играет важную роль в направлении запросов приложения к правильным базам данных.

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]

> * Подготовка нового клиента.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.


Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS Wingtip. Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных SQL Azure](sql-database-saas-tutorial.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="introduction-to-the-saas-catalog-pattern"></a>Общие сведения о шаблоне каталога SaaS

В мультитенантном приложении SaaS на основе базы данных важно знать, где хранятся сведения для каждого клиента. В шаблоне каталога SaaS база данных каталога используется для размещения сопоставления между клиентами и хранения их данных. Приложение SaaS Wingtip использует архитектуру базы данных с одним клиентом, но базовый шаблон (хранение сопоставления клиента с базой данных в каталоге) применяется при использовании базы данных с несколькими или с одним клиентом.

Каждому клиенту назначается ключ, который позволяет отличать свои данные в каталоге. В приложении SaaS Wingtip ключ формируется из хэша имени клиента. Этот шаблон позволяет использовать часть имени URL-адреса клиента приложения для создания ключа и устанавливать подключение для определенного клиента. Вы можете использовать другие схемы идентификации. Это не повлияет на общий шаблон.

Каталог в этом приложении реализуется с помощью технологии управления сегментами в [клиентской библиотеке эластичной базы данных (EDCL)](sql-database-elastic-database-client-library.md). EDCL отвечает за создание *каталога* на основе базы данных, где хранится *карта сегментов*, и управление им. Каталог содержит сопоставление ключей (клиентов) и их сегментов (баз данных).

> [!IMPORTANT]
> Данные сопоставления доступны в базе данных каталога. *Не изменяйте их*. Изменяйте данные сопоставления только с помощью интерфейсов API EDCL. Прямые манипуляции с данными сопоставления могут привести к повреждению каталога. Такие операции не поддерживаются.



## <a name="get-the-wingtip-application-scripts"></a>Получение сценариев приложения Wingtip

Скрипты и исходный код приложения SaaS Wingtip доступны в репозитории GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS). Указания по скачиванию скриптов SaaS Wingtip см. [здесь](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).

## <a name="provision-one-new-tenant"></a>Подготовка одного нового клиента

Если вы уже создали клиент, работая с [первым руководством по приложению SaaS Wingtip](#provision-a-batch-of-tenants), переходите к разделу [Подготовка пакета клиентов](sql-database-saas-tutorial.md).

Запустите скрипт *Demo-ProvisionAndCatalog* для быстрого создания клиента и его регистрации в каталоге:

1. Откройте файл **Demo-ProvisionAndCatalog.ps1** в интегрированной среде сценариев PowerShell и задайте следующие значения:
   * **$TenantName** — имя нового мероприятия (например, *Bushwillow Blues*).
   * **$VenueType** — один из предопределенных типов мероприятия: blues, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.
   * **$DemoScenario** — 1. Оставьте значение _1_ для **подготовки одного клиента**.

1. Нажмите клавишу **F5** для запуска скрипта.

По завершении выполнения скрипта подготавливается новый клиент и в браузере откроется приложение *Events*:

![Новый клиент](./media/sql-database-saas-tutorial-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a>Подготовка пакета клиентов

В этом упражнении подготавливается пакет дополнительных клиентов. Рекомендуется подготовить пакет клиентов перед выполнением других руководств по SaaS Wingtip, чтобы вы могли работать не только с несколькими базами данных.

1. Откройте файл ...\\Learning Modules\\Utilities\\*Demo-ProvisionAndCatalog.ps1* в *интегрированной среде сценариев PowerShell* и задайте следующие значения:
   * **$DemoScenario** = **3**. Установите значение **3** для **подготовки пакета клиентов**.
1. Нажмите клавишу **F5** для запуска скрипта.

Скрипт подготовит пакет дополнительных клиентов. Он использует [шаблон Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md), который управляет пакетом, а затем подготавливает каждую базу данных в связанном шаблоне. При использовании шаблонов таким способом Azure Resource Manager выступает в качестве посредника в процессе подготовки скрипта. Шаблоны подготавливают базы данных в параллельном режиме, когда это возможно, и выполняют повторные попытки в случае необходимости, чтобы оптимизировать общий процесс. Сценарий является идемпотентным, поэтому, если при его выполнении произойдет сбой или по какой-либо причине он остановится, запустите его еще раз.

### <a name="verify-the-batch-of-tenants-successfully-deployed"></a>Проверка успешного развертывания пакета клиентов

* Откройте сервер *tenants1* на [портале Azure](https://portal.azure.com) и щелкните **Базы данных SQL**:

   ![список баз данных](media/sql-database-saas-tutorial-provision-and-catalog/database-list.png)


## <a name="provision-and-catalog-details"></a>Сведения о подготовке и каталогизации

Чтобы получить более полное представление о том, как приложение Wingtip реализует подготовку новых клиентов, еще раз запустите скрипт *Demo-ProvisionAndCatalog* и подготовьте еще один клиент. На этот раз добавьте точку останова и перейдите к выполнению рабочего процесса:

1. Откройте файл …\\Learning Modules\Utilities\_Demo-ProvisionAndCatalog.ps1 и задайте следующие параметры.
   * **$TenantName** — имена клиентов должны быть уникальными, поэтому задайте имя, отличное от имен имеющихся клиентов (например, *Hackberry Hitters*).
   * **$VenueType** — используйте один из предопределенных типов мероприятия (например, *judo*).
   * **$DemoScenario** — 1. Установите значение **1** для **подготовки одного клиента**.

1. Добавьте точку останова, поместив курсор в любом месте строки *New-Tenant `* и нажмите клавишу **F9**.

   ![точка останова](media/sql-database-saas-tutorial-provision-and-catalog/breakpoint.png)

1. Нажмите клавишу **F5** для запуска сценария. По достижении точки останова нажмите клавишу **F11**, чтобы перейти к нужному компоненту. Отслеживайте выполнение скрипта и используйте клавиши **F10** и **F11**, чтобы обойти вызываемую функцию или перейти в нее. [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)

### <a name="examine-the-provision-and-catalog-implementation-in-detail-by-stepping-through-the-script"></a>Получение дополнительных сведений о подготовке и каталогизации в процессе выполнения скрипта

Ниже представлены этапы подготовки и каталогизации новых клиентов в скрипте:

1. **Импорт модуля SubscriptionManagement.psm1**, который содержит функции для входа в Azure и выбора рабочей подписки Azure.
1. **Импорт модуля CatalogAndDatabaseManagement.psm1**, предоставляющего каталог и абстракцию на уровне клиента с помощью функций[управления сегментами](sql-database-elastic-scale-shard-map-management.md). Это важный модуль, который инкапсулирует большую часть шаблона каталога. Его следует изучить.
1. **Получение сведений о конфигурации.** Перейдите к *Get-Configuration* (нажав клавишу **F11**) и посмотрите, как указывается конфигурация приложения. Здесь определяются имена ресурсов и другие значения для конкретного приложения, но не изменяйте эти значения, пока вы не изучите скрипты.
1. **Получение объекта каталога.** Перейдите к *Get-Catalog*, чтобы посмотреть, как каталог инициализируется с использованием функций управления сегментами, которые импортируются из **AzureShardManagement.psm1**. Каталог состоит из следующих объектов:
   * $catalogServerFullyQualifiedName создается с использованием стандартного корня, а также имени пользователя: _catalog-\<пользователь\>.database.windows.net_.
   * $catalogDatabaseName извлекается из файла конфигурации: *tenantcatalog*.
   * Объект $shardMapManager инициализируется из базы данных каталога.
   * Объект $shardMap инициализируется из карты сегментов *tenantcatalog* в базе данных каталога.
   Объект каталога формируется, возвращается и используется в скрипте более высокого уровня.
1. **Вычисление нового ключа клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
1. **Проверка наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ доступен.
1. **Подготовка базы данных клиента с помощью New-TenantDatabase.** Используйте клавишу **F11**, чтобы перейти к функции и увидеть, как база данных подготавливается с помощью шаблона Resource Manager.

Имя базы данных создается на основе имени клиента, чтобы было ясно, какие сегменты принадлежит определенному клиенту. (Вы можете использовать другие стратегии именования базы данных.)

Шаблон Resource Manager используется для создания базы данных клиента путем копирования *окончательной* базы данных (basetenantdb) на сервер каталога.  Альтернативный подход заключается в том, чтобы создать пустую базу данных, а затем инициализировать ее путем импорта BACPAC-файла.

Шаблон Resource Manager находится в папке ...\\Learning Modules\\Common\\: *tenantdatabasecopytemplate.json*.

После создания базы данных клиента она инициализируется с помощью имени мероприятия (клиента) и его типа. Также здесь можно выполнить другие действия по инициализации.

База данных клиента регистрируется в каталоге с использованием функции *Add-TenantDatabaseToCatalog* и ключа клиента. Используйте клавишу **F11**, чтобы просмотреть подробные сведения:

* База данных каталога добавляется на карту сегментов (список известных баз данных).
* Создается сопоставление, которое связывает значение ключа (клиент) с сегментом (базой данных).
* Добавляются дополнительные метаданные о клиенте.

После завершения подготовки возобновляется выполнение исходного сценария *Demo-ProvisionAndCatalog*, а в браузере открывается страница **События** нового клиента.

   ![events](media/sql-database-saas-tutorial-provision-and-catalog/new-tenant2.png)


## <a name="other-provisioning-patterns"></a>Другие шаблоны подготовки

Далее представлены другие шаблоны подготовки, которые не рассматриваются в этом руководстве.

**Предварительная подготовка баз данных.** В шаблоне предварительной подготовки учитывается тот факт, что базы данных в эластичном пуле не создают дополнительных затрат. Счета выставляются за эластичный пул, а не за базы данных, и простаивающие базы данных не потребляют ресурсы. Предварительная подготовка баз данных в пуле и выделение их при необходимости может значительно сократить время адаптации клиента. Количество заранее подготовленных баз данных можно настраивать при необходимости, чтобы обеспечивать готовность буфера к предполагаемой скорости подготовки.

**Автоматическая подготовка.** В шаблоне автоматической подготовки используется выделенная служба для автоматической подготовки серверов, пулов и баз данных по мере необходимости, включая предварительную подготовку баз данных в эластичных пулах. При списании и удалении баз данных "пропуски" в эластичных пулах могут заполняться службой подготовки в случае необходимости. Такие службы могут быть простыми или сложными. Они могут, например, управлять подготовкой в нескольких географических регионах и автоматически настраивать георепликацию, если эта стратегия используется для аварийного восстановления. С помощью шаблона автоматической подготовки клиентское приложение или скрипт может отправить запрос на подготовку в очередь для обработки службой подготовки, а затем будет запрашивать службу, чтобы получить данные о завершении. Если используется предварительная подготовка, запросы будут обрабатываться быстро, если служба, управляющая подготовкой базы данных для замены, работает в фоновом режиме.



## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]

> * Подготовка нового клиента.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.

Ознакомьтесь с [руководством по мониторингу производительности](sql-database-saas-tutorial-performance-monitoring.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по SaaS WTP базы данных SQL](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)
* [Клиентская библиотека эластичной базы данных](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library)
* [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)

