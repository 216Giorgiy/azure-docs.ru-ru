<properties 
	pageTitle="Устранение проблем сопоставления сегментов с помощью диспетчера восстановления | Microsoft Azure" 
	description="Устранение проблем сопоставления сегментов с помощью класса RecoveryManager" 
	services="sql-database" 
	documentationCenter=""  
	manager="jhubbard"
	authors="ddove"/>

<tags 
	ms.service="sql-database" 
	ms.workload="sql-database" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/05/2016" 
	ms.author="ddove"/>

# Устранение проблем сопоставления сегментов с помощью класса RecoveryManager

Класс [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) предоставляет приложениям ADO.Net возможность легко обнаружить и исправить все несоответствия между глобальным сопоставлением сегментов (GSM) и локальным сопоставлением сегментов (LSM) в сегментированной среде базы данных.

GSM и LSM отслеживают сопоставление каждой базы данных в сегментированной среде. Иногда между GSM и LSM происходит разрыв. Для его обнаружения и устранения используйте класс RecoveryManager.

Класс RecoveryManager является частью [клиентской библиотеки эластичной базы данных](sql-database-elastic-database-client-library.md).


![Карта сегментов][1]


Определения терминов см. в статье [Глоссарий инструментов эластичных баз данных](sql-database-elastic-scale-glossary.md). Чтобы узнать, как с помощью объекта **ShardMapManager** управлять данными в сегментированном решении, см. статью [Управление размещением сегментов](sql-database-elastic-scale-shard-map-management.md).


## Зачем использовать диспетчер восстановления

В среде сегментированной базы данных на каждую базу данных приходится по одному клиенту и на каждый сервер — по несколько баз данных. В среде также может быть несколько серверов. Каждая база данных сопоставляется с чем-то в карте сегментов, чтобы вызовы можно было направить к правильному серверу и базе данных. Базы данных отслеживаются по **ключу сегментирования**, а каждому серверу назначается **диапазон значений ключа**. Например, ключ сегментирования может представлять имена клиентов от «В» до «Е». Сопоставление всех сегментов (т. е. баз данных) и их диапазонов сопоставления содержится в **глобальной карте сегментирования**. Каждая база данных также содержит карту содержащихся в сегментах диапазонов. Она называется **локальной картой сегментирования**. Когда приложение подключается к сегменту, сопоставление кэшируется с приложением для быстрого извлечения данных. LSM используется для проверки кэшированных данных.

GSM и LSM могут рассинхронизироваться по следующим причинам:

1. Удаление сегмента, диапазон которого считается неиспользуемым, или переименование сегмента. Удаление сегмента приводит к **потере сопоставления сегментов**. Переименование базы данных точно так же может привести к потере сопоставления сегментов. В зависимости от цели изменения может потребоваться удалить сегмент или просто изменить его расположение. Для восстановления удаленной базы данных обратитесь к статье [Восстановление базы данных на более ранний момент времени, восстановление удаленной базы данных или восстановление после сбоя центра обработки данных](sql-database-troubleshoot-backup-and-restore.md).
2. Происходит событие географической отработки отказа. Чтобы продолжить, необходимо обновить имя сервера и имя базы данных диспетчера сопоставления сегментов в приложении и затем обновить сведения о сопоставлении сегментов для всех сегментов в сопоставлении. В случае географической отработки отказа такую логику восстановления следует автоматизировать в рабочем процессе отработки отказа. Автоматизация действий по восстановлению гарантирует удобную управляемость для баз данных с поддержкой определения географического расположения и позволяет избежать выполнение действий пользователем вручную.
3. Сегмент или база данных ShardMapManager восстанавливается до более ранней версии.

Дополнительные сведения об инструментах эластичной базы данных, входящей в базу данных SQL Azure, и о георепликации и восстановлении см. в следующих разделах:

* [Обзор. Непрерывность облачных бизнес-процессов и аварийное восстановление баз данных с базой данных SQL](sql-database-business-continuity.md) 
* [Разработка с учетом требований непрерывности бизнес-процессов](sql-database-business-continuity-design.md)
* [Приступая к работе с инструментами эластичной базы данных](sql-database-elastic-scale-get-started.md)  
* [Управление ShardMap](sql-database-elastic-scale-shard-map-management.md)

## Извлечение RecoveryManager из ShardMapManager 

Сначала нужно создать экземпляр RecoveryManager. [Метод GetRecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) возвращает диспетчер восстановления для текущего экземпляра [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx). Чтобы устранить несоответствия в сопоставлении сегментов, необходимо сначала получить RecoveryManager для конкретного сопоставления сегментов.

	ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 

В этом примере RecoveryManager инициализируется из ShardMapManager. ShardMapManager, содержащий ShardMap, также уже инициализирован.

Так как этот код приложения сам использует сопоставление сегментов, учетные данные, применяемые фабричным методом (в примере выше это smmConnectionString), должны иметь разрешения для чтения и записи в базе данных GSM, ссылка на которую содержится в строке подключения. Обычно эти учетные данные отличаются от учетных данных, используемых при открытии подключений для зависящей от данных маршрутизации. Дополнительные сведения см. в разделе [Использование учетных данных в клиенте эластичных баз данных](sql-database-elastic-scale-manage-credentials.md).

## Удаление сегмента из ShardMap после удаления сегмента

[Метод DetachShard](https://msdn.microsoft.com/library/azure/dn842083.aspx) отсоединяет данный сегмент от сопоставления сегментов и удаляет сопоставления, связанные с ним.

* В параметре расположения указано расположение, а точнее, имя сервера и имя базы данных отключаемых сегментов. 
* В параметре shardMapName указано имя сопоставления сегментов. Он необходим, только если один и тот же диспетчер сопоставления сегментов управляет несколькими сопоставлениями сегментов. необязательный параметр. 

**Важно**. Используйте этот метод, только если вы уверены, что диапазон для обновленного сопоставления пуст. Методы выше не позволяют проверить данные для перемещаемого диапазона, так что лучше включить проверки в код.

Этот пример удаляет сегменты из сопоставления сегментов.

	rm.DetachShard(s.Location, customerMap); 

Сопоставление расположения сегмента в глобальной карте сегментов до удаления сегмента. Поскольку сегмент удален, предполагается, что это было намеренное действие, и диапазон ключа сегментирования больше не используется. Если это не так, можно выполнить восстановление до точки во времени, чтобы восстановить более ранний сегмент. (В этом случае просмотрите раздел ниже, чтобы обнаружить несоответствия сегментов.) Для восстановления базы данных обратитесь к статье [Восстановление базы данных на более ранний момент времени, восстановление удаленной базы данных или восстановление после сбоя центра обработки данных](sql-database-troubleshoot-backup-and-restore.md).

Поскольку предполагается, что удаление базы данных было намеренным действием, завершающим административным действием является удаление записи сегмента в диспетчере сопоставления сегментов. Это не дает приложению случайно записать данные в не тот диапазон.

## Определение различий сопоставления 

[Метод DetectMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) выбирает и возвращает одно из сопоставлений сегментов (локальное или глобальное) как источник истины и согласовывает сопоставления на обоих сопоставлениях сегментов (GSM и LSM).

	rm.DetectMappingDifferences(location, shardMapName);

* *Расположение* указывает имя сервера и имя базы данных. 
* В параметре *shardMapName* указано имя сопоставления сегментов. Он необходим, только если один и тот же диспетчер сопоставления сегментов управляет несколькими сопоставлениями сегментов. необязательный параметр. 

## Устранение различий сопоставления

[Метод ResolveMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) выбирает одно из сопоставлений сегментов (локальное или глобальное) как источник истины и согласовывает сопоставления на обоих сопоставлениях сегментов (GSM и LSM).

	ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   
* Параметр *RecoveryToken* перечисляет отличия в сопоставлениях GSM и LSM для конкретного сегмента. 

* [Перечисление MappingDifferenceResolution](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) используется для указания метода для устранения разницы между сопоставлениями сегментов.
* **MappingDifferenceResolution.KeepShardMapping** рекомендуется в случае, если LSM содержит точное сопоставление и поэтому должно использоваться сопоставление в сегменте. Обычно это происходит при отработке отказа: сегмент теперь находится на новом сервере. Поскольку сегмент сначала должен быть удален из GSM (с помощью метода RecoveryManager.DetachShard), сопоставление больше не существует в GSM. Таким образом, для повторного установления сопоставления сегментов должно использоваться сопоставление LSM.

## Присоединение сегмента к ShardMap после восстановления сегмента 

[Метод AttachShard](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) присоединяет сегмент к сопоставлению сегментов. Затем он обнаруживает несогласованности сопоставления сегментов и обновляет сопоставления для соответствия сегмента в точке восстановления сегментов. Предполагается, что база данных также переименовывается для отображения исходного имени базы данных (до момента восстановления сегмента), поскольку восстановление до точки во времени восстанавливает значения по умолчанию в новой базе данных, к которой была добавлена отметка времени.

	rm.AttachShard(location, shardMapName) 

* В параметре *расположение* указано имя сервера и имя базы данных присоединяемого сегмента. 

* В параметре *shardMapName* указано имя сопоставления сегментов. Он необходим, только если один и тот же диспетчер сопоставления сегментов управляет несколькими сопоставлениями сегментов. необязательный параметр.

В этом примере добавляется сегмент к сопоставлению сегментов, которое было восстановлено из более ранней точки во времени. Так как сегмент (а именно сопоставление для сегмента в LSM) был восстановлен, он является потенциально несовместимым с записью сегментов в GSM. Вне этого примера кода сегмент был восстановлен и переименован в исходное имя базы данных. Так как он был восстановлен, предполагается, что сопоставление в LSM является доверенным сопоставлением.

	rm.AttachShard(s.Location, customerMap); 
	var gs = rm.DetectMappingDifferences(s.Location); 
	  foreach (RecoveryToken g in gs) 
	   { 
	   rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
	   } 

## Обновление расположений сегментов после географической отработки отказа (восстановления) сегментов

В случае географической отработки отказа база данных-получатель становится доступной для записи и становится новой базой данных-источником. Имя сервера и, возможно, базы данных (в зависимости от конфигурации) может отличаться от исходных основных значений. Поэтому необходимо исправить сопоставляемые записи для сегмента в GSM и LSM. Аналогичным образом, если база данных восстанавливается до другого имени или расположения или до более ранней точки во времени, это может вызвать несогласованности в сопоставлениях сегментов. Диспетчер сопоставления сегментов обрабатывает распределение открытых подключений к нужной базе данных. Распределение основывается на данных в сопоставлении сегментов и значении ключа сегментирования, который является целевым объектом запроса приложения. После географической отработки отказа необходимо обновить эти сведения, добавив точное имя сервера, имя базы данных и сопоставление сегментов восстановленной базы данных.

## Рекомендации

Географической отработкой отказа и восстановлением обычно управляет облачный администратор приложения, который намеренно использует одну из возможностей непрерывности бизнес-процессов базы данных SQL Azure. Для планирования непрерывности бизнес-процессов требуются процессы, процедуры и меры, обеспечивающие непрерывность выполнения бизнес-операций. Методы, доступные как часть класса RecoveryManager, должны использоваться в этом рабочем процессе, чтобы гарантировать актуальность сопоставлений GSM и LSM в соответствии с действиями, предпринятыми для восстановления. Чтобы GSM и LSM отражали точную информацию после отработки отказа, выполните 5 приведенных ниже основных действий. Код приложения для выполнения этих действий можно интегрировать в существующие средства и рабочий процесс.

1. Получите диспетчер восстановления из диспетчера сопоставления сегментов. 
2. Отсоедините старый сегмент от сопоставления сегментов.
3. Присоедините новый сегмент к сопоставлению сегментов, включая новое расположение сегмента.
4. Выявите несоответствия в сопоставлении между GSM и LSM. 
5. Устраните различия между GSM и LSM, ориентируясь на LSM. 

В этом примере выполняются следующие действия.
1. Удаление сегментов из сопоставления сегментов, которое отражает расположения сегментов до отработки отказа.
2. Присоединение сегментов к сопоставлению сегментов, которое отражает новые местоположения сегментов (параметр Configuration.SecondaryServer — это новое имя сервера, но то же имя базы данных).
3. Получение маркеров восстановления путем обнаружения различий сопоставления между GSM и LSM для каждого сегмента. 
4. Разрешение несоответствий путем ориентации на сопоставление каждого сегмента в LSM. 

	var shards = smm.GetShards(); foreach (shard s in shards) { if (s.Location.Server == Configuration.PrimaryServer) { ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database);
		
		  rm.DetachShard(s.Location); 
		
		  rm.AttachShard(slNew); 
		
		  var gs = rm.DetectMappingDifferences(slNew); 
	
		  foreach (RecoveryToken g in gs) 
			{ 
			   rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
			} 
		} 
	}



[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]


<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png
 

<!---HONumber=AcomDC_0511_2016-->