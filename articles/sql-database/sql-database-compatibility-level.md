<properties 
	pageTitle="Уровни совместимости баз данных SQL | Microsoft Azure" 
	description="В этой статье объясняется, как задать уровень совместимости базы данных SQL Azure и какие функции будут затронуты."
	services="sql-database" 
	documentationCenter="" 
	authors="MightyPen" 
	manager="jeffreyg" 
	editor=""/>


<tags 
	ms.service="sql-database" 
	ms.workload="data-management" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/21/2015" 
	ms.author="genemi"/>


# Уровни совместимости баз данных SQL


В этом разделе описываются варианты выбора компонентов, которые можно сделать с помощью инструкции Transact-SQL **ALTER DATABASE** для базы данных SQL Azure. Уровни совместимости предназначены для того, чтобы снизить любые риски при обновлении.


Большинство функций, которые активируются или деактивируются уровнем совместимости, являются частью оптимизатора запросов. Корпорация Microsoft делает активацию функции нового оптимизатора возможной на уровне совместимости при выполнении следующих условий:


- обновленное содержимое изменяет семантику предыдущей функции;
- оптимизация запросов может с высокой долей вероятности негативно повлиять на производительность некоторых нестандартных, но допустимых SQL-запросов.


Если после обновления сервера или базы данных SQL Azure ваш запрос выполняется медленнее, вы можете понизить уровень совместимости. Более низкий уровень совместимости может деактивировать узкий набор улучшений оптимизатора, среди которых могут оказаться и те, которые негативно влияют на ваш запрос.


## Как работают уровни совместимости


В Microsoft SQL Server уровни совместимости используются на протяжении многих лет. Теперь начиная с версии 12 уровни совместимости используются и в базе данных SQL Azure. Уровень совместимости, который задается для каждой базы данных SQL, влияет на активацию некоторых новых функций. Возможные варианты уровней совместимости включают:


- 110: наименьший возможный уровень, при котором, как следствие, большинство новых функций исключены.
- 120: примерно соответствует базам данных SQL версии 11 (следовательно, `SELECT @@version;` возвращает **11.**0.0.0).
 - Версию 11 также называют базами данных SQL "SAWA версии 2".
 - 120 — максимальное значение для Microsoft SQL Server 2014.
- 130: примерно соответствует базам данных SQL версии 12 (следовательно, `SELECT @@version;` возвращает **12.**0.0.0).
 - 130 — максимальное значение для Microsoft SQL Server 2016.


Например, значение 120 означает, что вашей базе данных доступно подмножество функций, которое активируется на уровне 120, *а также* функции, которые становятся активными на всех более низких уровнях, например 110. При уровне совместимости 120 базе данных недоступны функции уровня 130.


## Чтение и установка уровня совместимости


### Чтение уровня совместимости


```
SELECT d.name, d.compatibility_level
	FROM sys.databases AS d
	WHERE d.name = db_name();
```


### Установка уровня совместимости


```
ALTER DATABASE YourDatabaseName SET COMPATIBILITY_LEVEL = 130;
```


Дополнительные сведения см. в следующих статьях:


- [Уровень совместимости ALTER TABLE (Transact-SQL)](http://msdn.microsoft.com/library/bb510680.aspx)
- [sys.databases (Transact-SQL)](http://msdn.microsoft.com/library/ms178534.aspx)


## Таблицы в памяти и индексы columnstore


Большинство возможностей уровней совместимости, которые становятся активными на уровнях 120 и 130, относятся к таблицам и индексам *в памяти*. Поэтому важные компоненты включают:


- Оптимизированные для памяти таблицы
- Индексы columnstore


При использовании компонентов в памяти уровень совместимости 130 обеспечивает следующие преимущества:


- Оптимизатор запроса получает возможность обработки запросов в *пакетном* режиме.
 - Пакетный режим быстрее *построчного* при большом количестве строк.
- Добавляется оператор **SORT**.
- Добавляются агрегаты для окон.


Дополнительные сведения о таблицах в памяти, а также об индексах columnstore см. в следующих статьях:


- [Оптимизированные для памяти таблицы](http://msdn.microsoft.com/library/dn133165.aspx)
- [CREATE CLUSTERED COLUMNSTORE INDEX (Transact-SQL)](http://msdn.microsoft.com/library/dn511016.aspx)
- [Сведения об индексах columnstore](http://msdn.microsoft.com/library/gg492088.aspx)


## Общие компоненты, для которых необходим минимальный уровень 130


Оценщик количества элементов (CE) создает и сохраняет статистические данные о приблизительном количестве строк в таблице. Информация о количестве элементов используется многими компонентами оптимизатора запросов


Алгоритмы, используемые оценщиком количества элементов, были улучшены. Улучшения вызывают изменения, а изменения могут вызвать ухудшение работы для некоторых специализированных запросов.


| 130 — минимально<br/>необходимый<br/>уровень | Область запроса,<br/>Общие | Подробные сведения об улучшении<br/>плана запроса<br/> |
| :-- | :-- | :-- |
| 130 | Оценщик количества элементов | Улучшения в оценщике количества элементов (CE) по сравнению с более ранней версией оценщика на уровне 120.<br/><br/>В плане запроса вы можете увидеть: **CardinalityEstimationModelVersion="130"**<br/><br/>**Флаг трассировки** [**9481**](http://www.sqlservergeeks.com/sql-server-2014-trace-flags-9481/) можно включить для использования оценщика количества элементов уровня 120, когда база данных находится на уровне 130.<br/><br/>**Флаг трассировки** [**4199**](http://support.microsoft.com/kb/974006) можно отключить, когда база данных находится на уровне совместимости 130, для того чтобы отказаться от исправлений, внесенных в оптимизатор запросов. Флаг применяется только к исправлениям, которые будут реализованы после того, как уровень 130 полностью выйдет из предварительной версии будет выпущен в общедоступной версии. Дополнительные сведения см. в статьях:<br/><br/>● [DBCC TRACEON](http://msdn.microsoft.com/library/ms187329.aspx) |
| 130 | Планы параллельных запросов для таблиц в памяти | Запросы могут быть многосеточными и запускаться параллельно, если они применяются к таблице в памяти, то есть к таблице, созданной с предложением **MEMORY\_OPTIMIZED = YES**. Параллелизм может ускорить выполнение запросов.<br/><br/>Это улучшение поддерживается для обычного Transact-SQL и пользовательских хранимых процедур. Однако оно не поддерживается для собственных хранимых процедур, которые компилируются в библиотеку DLL. |


## Для функций индекса columnstore необходим минимальный уровень совместимости 130


На уровне совместимости 130 улучшение оптимизатора запросов может привести к появлению нового плана запросов. Для измененных планов, которые включают индекс columnstore, изменение обычно включает одно из следующих:


- Снижение производительности в ситуациях, когда необходимо скопировать данные для дальнейшей вложенной подобработки.
- Изменение *построчной* обработки на ***пакетную*** для таких операций, как сортировка.


В большинстве случаев изменение плана улучшает производительность запроса благодаря следующему:


- параллельные вставки в индексе columnstore.
 - На уровне 130 параллельное сканирование некластеризованных индексов не поддерживается.
- Более активное использование базы данных **tempdb**.


| 130 — минимально<br/>необходимый<br/>уровень | Область запроса,<br/>Индекс columnstore | Подробные сведения об улучшении<br/>плана запроса<br/> |
| :-- | :-- | :-- |
| 130 | Функции запросов | Производительность повышается за счет переключения в пакетный режим в следующих случаях:<br/><br/>• при использовании сортировки;<br/><br/>• при агрегировании с *несколькими* различными функциями<br/>(по одной функции из каждой пары различных пунктов следующего списка):<br/>&nbsp;&nbsp;&nbsp;▫ **COUNT** *или* **COUNT\_BIG**<br/>&nbsp;&nbsp;&nbsp;▫ **AVG** *или* **SUM**<br/>&nbsp;&nbsp;&nbsp;▫ **CHECKSUM\_AGG**<br/>&nbsp;&nbsp;&nbsp;▫ **STDEV** *или* **STDEVP**<br/><br/>•; при использовании функций агрегирования для окон<br/>(описаны [здесь на сайте MSDN](http://msdn.microsoft.com/library/ms189461.aspx) и [здесь Кати Келленбергер](http://www.bidn.com/blogs/KathiKellenberger/sql-server/4397/what-is-a-window-aggregate-function)):<br/>&nbsp;&nbsp;&nbsp;▫ **COUNT**, **COUNT\_BIG**, **SUM**, **AVG**, **MIN**, **MAX**, **CLR**<br/><br/>•; при использовании [пользовательских](http://msdn.microsoft.com/library/ms131057.aspx) функций агрегирования для окон:<br/>&nbsp;&nbsp;&nbsp;▫ [**CHECKSUM\_AGG**](http://msdn.microsoft.com/library/ms188920.aspx), [**STDEV**](http://msdn.microsoft.com/library/ms190474.aspx), [**STDEVP**](http://msdn.microsoft.com/library/ms176080.aspx), [**VAR**](http://msdn.microsoft.com/library/ms186290.aspx), [**VARP**](http://msdn.microsoft.com/library/ms188735.aspx), [**GROUPING**](http://msdn.microsoft.com/library/ms178544.aspx)<br/><br/>• При использовании аналитических функций агрегирования для окон:<br/>&nbsp;&nbsp;&nbsp;▫ [**LAG**](http://msdn.microsoft.com/library/hh231256.aspx), [**LEAD**](http://msdn.microsoft.com/library/hh213125.aspx), [**FIRST\_VALUE**](http://msdn.microsoft.com/library/hh213018.aspx), [**LAST\_VALUE**](http://msdn.microsoft.com/library/hh231517.aspx), [**PERCENTILE\_CONT**](http://msdn.microsoft.com/library/hh231473.aspx), [**PERCENTILE\_DISC**](http://msdn.microsoft.com/library/hh231327.aspx), [**CUME\_DIST**](http://msdn.microsoft.com/library/hh231078.aspx), [**PERCENT\_RANK**](http://msdn.microsoft.com/library/hh213573.aspx) |
| 130 | План однопоточных последовательных запросов | Запрос, выполняемый в одном потоке, можно запускать в пакетном режиме. Это может ускорить выполнение запроса.<br/><br/>План запроса может быть рассчитан на однопоточные запросы или запросы, выполняемые с **MAXDOP 1**. |
| 130 | Параллельная вставка | В вашем плане запроса некоторые операции вставки могут выполняться в параллельном режиме.< br/<br/> Это демонстрируется в [примере](#ExampleQueryParallelCciByCompatLevel) далее в этом разделе. |
| 130 | Антиполусоединение | Теперь этот оператор может выполняться в пакетном режиме. |


## Общие компоненты, для которых необходим минимальный уровень 120


| 120 — минимально<br/>необходимый<br/>уровень | Область запроса,<br/>Общие | Подробные сведения об улучшении<br/>плана запроса<br/> |
| :-- | :-- | :-- |
| 120 | [Изменение таблиц, оптимизированных для памяти](http://msdn.microsoft.com/library/dn269114.aspx) | Позволяет выполнять операции **ALTER TABLE** Transact-SQL с таблицами, оптимизированными для памяти (у которых **MEMORY\_OPTIMIZED = YES**).<br/><br/>Приложения базы данных могут продолжать работу, но операции доступа к таблице блокируются до завершения **ALTER TABLE**. |
| 120 | [Создание и управление хранилищем для оптимизированных для памяти объектов](http://msdn.microsoft.com/library/dn133174.aspx) | Система OLTP в памяти интегрирована в SQL Server. Это позволяет иметь как традиционные, так и оптимизированные для памяти (**MEMORY\_OPTIMIZED**) таблицы в одной базе данных. |
| 120 | [Поддержка Transact-SQL для OLTP в памяти](http://msdn.microsoft.com/library/dn133180.aspx) | Некоторые команды Transact-SQL были улучшены для поддержки обработки транзакций в памяти в реальном времени (OLTP).<br/><br/>Один из примеров — новое ключевое слово **NATIVE\_COMPILATION** команды [CREATE PROCEDURE](http://msdn.microsoft.com/library/ms187926.aspx). |
| 120 | Оценщик количества элементов | В оценщик количества элементов внесены улучшения по сравнению с более ранней версией оценщика на уровне 110.<br/><br/>В плане запроса вы можете увидеть: **CardinalityEstimationModelVersion="120"**<br/><br/>Подробные сведения о том, как **флаг трассировки 4199** взаимодействует со значением уровня совместимости, см. в [KB 974006](http://support.microsoft.com/kb/974006).|


## Для функций индекса columnstore необходим минимальный уровень совместимости 120


В этом разделе описаны [возможности индексирования columnstore](http://msdn.microsoft.com/library/dn934994.aspx), которые активируются на уровне совместимости 120 или выше.


| 120 — минимальный<br/>уровень<br/>совместимости | Имя функции индекса columnstore<br/> | Описание функции индекса columnstore<br/> |
| :-- | :-- | :-- |
| 120 | Уровень изоляции моментального снимка (SI) и<br/><br/>уровень изоляции фиксации моментального снимка при чтении (RCSI). | Если план запроса включает индекс columnstore, SI и RCSI предотвращают включение данных от частично завершенных транзакций в результаты запроса без необходимости избыточного использования блокировок. |
| 120 | Дефрагментация индекса | Удаленные строки удаляются без явного перестроения индекса.<br/><br/>**ALTER INDEX ... REORGANIZE ** удаляет удаленные строки из индекса columnstore, при этом таблица и индекс остаются доступными. |
| 120 | Доступность [вторичной реплики для чтения](http://msdn.microsoft.com/library/ff878253.aspx) AlwaysOn | Производительность операционной аналитики можно улучшить путем передачи аналитических запросов вторичной реплике AlwaysOn. |
| 120 | Предварительное промежуточное агрегирование <br/>при выполнении сканирования таблицы агрегатными функциями | Повышает производительность за счет предварительного выполнения промежуточных вычислений в плане запроса, чтобы уменьшить количество данных для копирования на последующих стадиях.<br/><br/>Применяется к **MIN**, **MAX**, **SUM**, **COUNT**, **AVG**.<br/><br/>Применяется только в том случае, если тип данных имеет размер 8 байт или меньше, но не для строк. |
| 120 | Оптимизация строковых предложений **WHERE** | Оптимизация предиката за счет частичного переноса его анализа на более низкий уровень может ускорить выполнение запросов, в которых сравниваются строковые данные типа &#x5b;var&#x5d;char или n&#x5b;var&#x5d;char. Эта оптимизация:<br/><br/>• Применяется для общих операторов сравнения, включая **LIKE**, которые используют фильтры по битовым картам.<br/><br/>• Работает только для одного строкового предиката.<br/><br/>• Работает со всеми типами сортировки, которые поддерживает продукт.<br/><br/>Для получения дополнительных сведений о фильтрах по битовым картам обратитесь к следующей статье в блоге: [Сведения о выполнении запросов с использованием фильтров по битовым картам](http://blogs.msdn.com/b/sqlqueryprocessing/archive/2006/10/27/query-execution-bitmaps.aspx). |



<a id="ExampleQueryParallelCciByCompatLevel" name="ExampleQueryParallelCciByCompatLevel"></a>


&nbsp;


## Пример изменения плана запроса в зависимости от уровня совместимости


В этом разделе описано изменение плана запроса для одной инструкции **INSERT...SELECT** Transact-SQL между уровнями совместимости 120 и 130.


#### Схема исходной таблицы


Следующая таблица содержит не менее 300 000 строк. Улучшенный план запроса может не использовать параллелизм, если данных слишком мало, чтобы параллельная обработка проявила свои преимущества.


```
CREATE TABLE [dbo].[ccitestoriginal](
	[FinanceKey] [int] NOT NULL,
	[DateKey] [int] NOT NULL,
	[OrganizationKey] [int] NOT NULL,
	[DepartmentGroupKey] [int] NOT NULL,
	[ScenarioKey] [int] NOT NULL,
	[AccountKey] [int] NOT NULL,
	[Amount] [float] NOT NULL,
	[Date] [datetime] NULL
) ON [PRIMARY];
GO

CREATE CLUSTERED COLUMNSTORE INDEX [cci_ccitestoriginal]
	ON [dbo].[ccitestoriginal]
	WITH (DROP_EXISTING = OFF) ON [PRIMARY];
GO
```


#### Сценарий для создания плана запроса


Выполните следующие действия для сценария Transact-SQL, приведенного ниже:


1. В **Ssms.exe** подключитесь к своей базе данных.
2. Вставьте сценарий Transact-SQL в окно запроса **Ssms.exe**.
3. Измените сценарий, указав значение **120** в инструкции **ALTER DATABASE**.
4. Запустите только ту часть сценария, которая находится *перед* инструкцией **INSERT INTO**.
5. Выберите пункт меню: **Запрос** > **Включить действительный план выполнения (Ctrl+M)**.
6. Запустите только инструкцию **INSERT INTO**.<br/><br/>
7. Снимите выделение с пункта меню: **Запрос** > **Включить действительный план выполнения (Ctrl+M)**.
8. Наконец, запустите только ту часть сценария, которая расположена *после* инструкции **INSERT INTO**.
9. Обратите внимание на план запроса для уровня **120** на вкладке **План выполнения**, которая находится рядом с вкладкой **Результаты**.<br/>-- -- -- -- -- --
10. Измените сценарий, указав значение **130** в инструкции **ALTER DATABASE**.
11. Повторно выполните сценарий, как описано на предыдущих шагах.
12. Обратите внимание, что теперь план запроса для уровня **130** отличается от предыдущего и включает параллелизм.


&nbsp;


```
go
SET NOCOUNT ON;
go

ALTER DATABASE YourDatabaseName SET COMPATIBILITY_LEVEL =
	120
	--130
;
go

DROP TABLE ccitest_into_work;
go

SELECT *
	INTO ccitest_into_work  -- Create an empty copy of the table.
	FROM ccitestoriginal
	WHERE 1=2;
go

CREATE CLUSTERED COLUMNSTORE INDEX ccitest_into_work_cci
	ON ccitest_into_work;
go

SET NOCOUNT OFF;
go
	
	-- Run this INSERT statement alone!
	--
	-- First run all the preceding Transact-SQL statements.
	-- Then run this one INSERT statement alone.
	-- Then run all remaining Transact-SQL statements.

INSERT INTO ccitest_into_work WITH (TABLOCK)
	SELECT TOP 300000 *
		FROM ccitestoriginal;
go

SET NOCOUNT ON;
go

DROP TABLE ccitest_into_work;
go
```


#### Отображение этих двух планов



<br/>** 120:** Вот план запроса для уровня совместимости **120**.


![План для уровня 120][1-Plan-at-level-120]


<br/>** 130:** Вот план запроса для уровня совместимости **130**.


План запроса для уровня **130** включает *параллелизм*, который отсутствует в плане для уровня **120**.


Этот план довольно подробно отображается в **Ssms.exe**. Для удобства снимок экрана разбит на две части. Вторая часть является продолжением первой.


![План для уровня 130][2-Plan-at-level-130]


## Уровень совместимости базы данных по умолчанию


При обновлении сервера базы данных SQL Azure, например с версии 11 до версии 12 уровень совместимости в каждой базе данных остается неизменным. После обновления можно увеличить уровень совместимости в каждой базе данных с помощью инструкции **ALTER DATABASE**.


Для всех вновь создаваемых баз данных SQL уровень совместимости будет максимально допустимым.



<!-- Image references. -->

[1-Plan-at-level-120]: ./media/sql-database-compatibility-level/sql-db-compat-level-query-plan-b-120.png

[2-Plan-at-level-130]: ./media/sql-database-compatibility-level/sql-db-compat-level-query-plan-b12-130.png

<!---HONumber=Sept15_HO4-->