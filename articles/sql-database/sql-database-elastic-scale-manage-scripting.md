<properties 
	pageTitle="Создание скриптов для эластичного масштабирования" 
	description="Создание сценариев задач эластичного масштабирования с помощью Runbook службы автоматизации Azure PowerShell." 
	services="sql-database" 
	documentationCenter="" 
	manager="stuartozer" 
	authors="Joseidz" 
	editor=""/>

<tags 
	ms.service="sql-database" 
	ms.workload="sql-database" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="02/03/2015" 
	ms.author="Joseidz@microsoft.com"/>

# Управление эластичным масштабированием с помощью скриптов


## Служба автоматизации Azure 

Служба [автоматизации Azure](http://azure.microsoft.com/documentation/services/automation/) переводит мощные и необходимые службы выполнения рабочего процесса PowerShell на платформу Azure. Теперь вы можете автоматизировать задачи обслуживания, которые трудно реализовать обычными средствами портала Azure. Просто создайте рабочий процесс PowerShell (называемый **runbook** в службе автоматизации Azure), загрузите его в облако и запланируйте выполнение runbook. В этом документе подробно описывается настройка службы автоматизации Azure для нескольких примеров, демонстрирующих эластичность сегментов. Для получения дополнительной информации см. [предварительное сообщение](http://blogs.technet.com/b/in_the_cloud/archive/2014/04/15/announcing-the-microsoft-azure-automation-preview.aspx). Или оформите [подписку](https://account.windowsazure.com/PreviewFeatures?fid=automation) на Azure.

В этом примере служба автоматизации Azure используется как платформа для создания расписания для рабочей нагрузки и ее выполнения. Можно рассматривать службу автоматизации Azure как вашего [агента SQL в облаке](http://azure.microsoft.com/blog/2014/06/26/azure-automation-your-sql-agent-in-the-cloud/).

Помимо этого документа существуют и другие ресурсы:

* [Начало работы со службой автоматизацией Azure](../automation-create-runbook-from-samples.md)
* [Пошаговое руководство: начало работы с предварительной версией новой службы автоматизации Microsoft Azure ](http://blogs.technet.com/b/keithmayer/archive/2014/04/04/step-by-step-getting-started-with-windows-azure-automation.aspx) 
* [Служба автоматизации Microsoft Azure](http://blogs.technet.com/b/cbernier/archive/2014/04/08/microsoft-azure-automation.aspx) 
* Задайте вопросы о службе автоматизации Azure на [форуме автоматизации](http://social.msdn.microsoft.com/Forums/windowsazure/home?forum=azureautomation&filter=alltypes&sort=lastpostdesc).  


## Предварительные требования

[Регистрация](http://azure.microsoft.com/services/preview/) и самостоятельное [знакомство](../automation-create-runbook-from-samples.md) с предварительной версией службы автоматизации Microsoft Azure.


## Файлы PowerShell для эластичности сегментов

Следующий набор файлов PowerShell содержит основные команды для выполнения сценариев горизонтального и вертикального масштабирования с помощью службы автоматизации Azure.

Эти примеры показывают, как использовать образцы модулей PowerShell для выполнения основных задач по эластичности сегментов. В сочетании со службой автоматизации Microsoft Azure и ее соответствующими модулями Runbook вы можете создать автоматизированные и запланированные к выполнению задания, провизионирующие новый сегмент и/или меняющие уровень производительности отдельных сегментов в соответствии с набором правил.

**SetupShardedEnvironment.ps1**: этот PowerShell runbook выполняет одноразовую настройку сегментированной среды и создает менеджер карты сегментов и диапазонную карту сегментов.

**ProvisionByDate.ps1**: Подготовка новой базы данных для будущей дневной рабочей нагрузки. База данных создается и получает имя по дате (ГГГГММДД) и регистрируется диспетчером карты сегментов в качестве диапазона [ГГГГММДД, ГГГГММДД + 1 D).

**ProvisionBySize.ps1**: подготовка новой базы данных при недостатке емкости текущей базы данных.

**ReduceServiceTier.ps1**: просматривает сегменты в предоставленной карте сегментов и определяет, является ли каждый отдельный сегмент кандидатом для снижения уровня производительности. Два условия определяют, является ли сегмент кандидатом: 1) текущий уровень обслуживания сегмента и (2) возраст базы данных.

**ShardManagement.psm1**: предоставляет набор методов для взаимодействия с диспетчером карты сегментов.

**SqlDatabaseHelpers.psm1**: предоставляет набор методов для взаимодействия с базами данных Azure SQL.

**ShardElasticity.psm1**: предоставляет набор методов для выполнения горизонтального масштабирования и операций вертикального масштабирования.

**ShardElasticityModule.psd1**: предоставляет набор методов для взаимодействия с гибким масштабированием и базами данных SQL Azure.

## Расходы

Внимание: выполнение примеров скриптов PowerShell приведет к созданию баз данных, что повлечет за собой денежные затраты для владельца подписки. Основные базы данных SQL Azure будут [оплачиваться по ставке](http://azure.microsoft.com/pricing/details/sql-database/), равной ставке для других баз данных SQL Azure. Начиная с 1 ноября взимается следующая оплата:

* Модуль runbook SetupShardedEnvironment создает диспетчер сопоставления сегментов в базе данных Basic (0,0069 долларов США в час), а также провизионирует первый сегмент базы данных Basic (0,0069 долларов США в час). 

* Модули runbook ProvisionBySize и ProvisionByDate провизионируют базу данных Standard S0 (0,0208 долларов США в час). Снизить эти затраты можно, запустив модули совместно с модулем runbook ReduceServiceTier – тогда спустя сутки уровень обслуживания новых провизионированных баз данных будет уменьшен с Standard S0 ($0,0208 в час) до Basic ($0,0069 в час).

Наконец, в области предоставленных примеров использование [службы автоматизации Azure](http://azure.microsoft.com/pricing/details/automation/) в настоящее время не повлечет за собой никаких расходов для владельца подписки. См. раздел [страница цен службы автоматизации Azure ](http://azure.microsoft.com/pricing/details/automation/) для получения дополнительных сведений.

## Загрузка модулей Runbook 

1. Загрузите **ShardElasticity.zip** файл и извлеките содержимое.
2. [Добавьте ссылки на двоичные файлы гибкого масштабирования с помощью NuGet](sql-database-elastic-scale-add-references-visual-studio.md)
3. Найдите клиентские двоичные файлы гибкого масштабирования (** Microsoft.Azure.SqlDatabase.ElasticScale.Client.dll**).
4. Поместите DLL в папку ShardElasticityModule и сожмите эту папку в ZIP-архив. 
3. В вашей учетной записи службы автоматизации Azure, загрузите файл ShardElasticityModule.zip как **Asset(актив)**. 
4. В службе автоматизации Azure создайте **учетные данные ресурса**, называемые *ElasticScaleCredential* и содержащие имя пользователя и пароль для вашего сервера базы данных SQL Azure. 
5. Создайте **Переменную актива**, называемую *SqlServerName* с полным именем сервера базы данных SQL Azure. 
5. Загрузите **SetupShardedEnvironment.ps1**, **ProvisionBySize.ps1**, **ProvisionByDate.ps1**, и **ProvisionByDate.ps1** как модули runbook. 
6. Попробуйте **SetupShardedEnvironment.ps1** runbook,как разовую операцию проверки, чтобы настроить сегментированную среду. 
7. Опубликуйте один или несколько из оставшихся модулей runbook и свяжите эти модули с расписанием. 
8. Просмотрите выходные данные runbook во вкладке **ЗАДАНИЯ**. 

Если краткие инструкции не помогли вам в работе над примером, ознакомьтесь с подробными инструкциями, приведенными ниже.

## Использование модулей Runbook

1. Создайте и упакуйте модуль PowerShell. 
2. Создайте учетную запись службы автоматизации Microsoft Azure. 
3. Передайте модуль PowerShell в службу автоматизации Azure в качестве ресурса. 
4. Создайте учетные данные службы автоматизации Azure и переменные ресурсы. 
5. Передайте модули Runbook PowerShell в службу автоматизации Azure. 
6. Настройте сегментированную среду. 
7. Протестируйте модули Runbook службы автоматизации. 
8. Опубликуйте модули Runbook. 
9. Запланируйте выполнение модулей Runbook. 


## Создайте и упакуйте модуль PowerShell. 

Первый шаг – создание модуля PowerShell, ссылающегося на сборки эластичного масштабирования, и упаковка этого модуля для передачи в службу автоматизации Azure в качестве ресурса.

1. Загрузите файл ShardElasticity.zip.
2. Извлеките все содержание файла.

    ![Извлечь все][1]
3. Получите клиентский DLL-файл эластичного масштабирования (т. е. файл Microsoft.Azure.SqlDatabase.ElasticScale.Client.dll) и скопируйте следующие файлы в свою локальную папку ShardElasticityModule, которую вы скачали на шаге 1. Это можно сделать двумя способами: 1) загрузите DLL используя NuGet-пакет гибкого масштабирования [Ссылка] или 2) из своего проекта гибкого масштабирования Starter Kit [Ссылка] (должен быть построен), перейдите к \\bin\\Debug\\ для получения библиотеки DLL.

    ![Получить Dll][2]

4. Сожмите папку ShardElasticityModule в ZIP-архив.

    Примечание. Служба автоматизации Azure использует несколько соглашений об именах: для модуля с именем ShardElasticityModule.psm1 имя zip файла должно быть точно таким же (ShardElasticityModule.zip). В zip-файле содержится папка ShardElasticityModule (имя соответствует имени модуля), в которой в свою очередь содержится psm1-файл. Если эта структура не соблюдены, автоматизации Azure не будет распаковать модуль.

5.    Когда вы убедитесь, что содержание и структура папки, сжатой в ZIP-архив, соответствуют требованиям, переходите к следующему шагу. Он должен выглядеть примерно следующим образом:

    ![dll][3]


## Регистрация для предварительной версии службы автоматизации Azure

1. Выберите [Компоненты предварительной версии Azure](http://azure.microsoft.com/services/preview/).
    
2. Щелкните **попробовать**.

    ![Щелкните чтобы попробовать][8]

2. Выберите [ портал Microsoft Azure](https://manage.windowsazure.com/microsoft.onmicrosoft.com).
3. Щелкните на **автоматизации**.

    ![Автоматизация][4]
4. В нижней части экрана щелкните **Создать**. 
5. В командной строке, показанной ниже, введите действующее имя учетной записи и установите флажок в правом нижнем углу окна.

    ![Запрос][5] 
5. Перейдите к следующему шагу. Успешное выполнение будет схоже с приведенной ниже иллюстрацией.

    ![Успешное завершение][6]

## Передайте модуль PowerShell в службу автоматизации Azure в качестве ресурса. 

Передайте указанный выше модуль PowerShell в свою учетную записи службы автоматизации Azure. Например, в модуле содержатся набор функций для эластичности сегментов и библиотеки DLL для эластичного масштабирования, на которые можно ссылаться из модулей Runbook.

1. Щелкните **АКТИВЫ** на ленте в верхней части экрана.
2. Щелкните **ИМПОРТ МОДУЛЯ** в нижней части страницы. 
3. Щелкните **Обзор файла...**, и найдите **ShardElasticityModule.zip** файл, упомянутый выше. 
4. Выбрав правильный файл, установите флажок в правом нижнем углу поля, чтобы импортировать его. Служба автоматизации Azure импортирует модуль. 
5. Перейдите к следующему шагу. У вас должен получиться результат, показанный на этом рисунке. Если модуль не был успешно импортирован, убедитесь, что в ZIP-файл соответствует описанным выше.

    ![Активы][10]
      
## Создайте учетные данные службы автоматизации Azure и переменные ресурсы. 

Вместо жесткого задания учетных данных и часто используемых переменных в модуле Runbook служба автоматизации Azure позволяет создавать соответственно учетные данные и переменные ресурсы так, что на них можно будет ссылаться из разных модулей. Например, менять пароль потом нужно будет только в одном месте.

1. Выберите только что созданную вами новую учетную запись службы автоматизации Azure.
2. В разделе учетной записи **ShardElasticityExamples** нажмите кнопку **АКТИВЫ** на ленте.
3. Щелкните **ДОБАВИТЬ ПАРАМЕТР** в нижней части экрана.  
4. Щелкните **ДОБАВИТЬ УЧЕТНЫЕ ДАННЫЕ**. 

    ![Добавить учетные данные][9]
4. Выберите **учетные данные Windows PowerShell** как **ТИП УЧЕТНЫХ ДАННЫХ** и **ElasticScaleCredential** в качестве имени. Описание является необязательным.  
5. Щелкните стрелку в правом нижнем углу окна. 

    Примечание. Для использования модулей runbook без изменений называйте переменные точно так же, как указано в инструкции. В модулях Runbook есть ссылки на имена переменных. 
5. Вставьте имя пользователя и пароль (два раза) для сервера баз данных SQL Azure, на котором вы хотите запустить примеры эластичности сегментов. 
 
6. Для создания переменной активов щелкните **ДОБАВИТЬ ПАРАМЕТР**, а затем выберите **ДОБАВИТЬ ПЕРЕМЕННУЮ**.

    ![Добавить переменную][7]
7. Для данного примера необходимо создать переменную для полного имени сервера баз данных SQL Azure, на котором будут располагаться диспетчер сопоставления сегментов и сегментированные базы данных. Выберите **Строка** как **ТИП ПЕРЕМЕННОЙ** и введите **SqlServerName**. Щелкните стрелку, чтобы продолжить. 
8. Введите полное доменное имя сервера БД SQL Azure в качестве ЗНАЧЕНИЯ и щелкните флажок. 
9. Вы создали учетные данные и переменный ресурс, которые будут использоваться в модулях runbook для эластичности сегментов. Перейдите к следующему шагу. У вас должен получиться следующий результат: 
    

## Передайте модули Runbook PowerShell в службу автоматизации Azure. 

Передайте четыре предоставленных учебных модуля Runbook для PowerShell.

1. Чтобы отправить новый модуль Runbook службе автоматизации Azure, щелкните **RUNBOOKS** на ленте. 
2. В нижней части экрана щелкните **ИМПОРТ**. 
3. Перейдите к папке, содержащий файл, выберите **SetupShardedEnvironment.ps1** и установите флажок. 
4. Повторите шаги 2 и 3 для трех оставшихся PowerShell модулей Runbook (** ProvisionByDate.ps1**, **ProvisionBySize.ps1**, и **ReduceServiceTier.ps1**). 
5. Перейдите к следующему шагу. 

## Настройте сегментированную среду. 

Следующим шагом является выполнение **SetupShardedEnvironment** runbook, который подготавливает сегментированную среду с диспетчером карты сегментов баз данных, диапазонной картой сегментов и сегментом для текущего дня.

1. Выберите **SetupShardedEnvironment** runbook, щелкнув его имя. 
2. Щелкните **АВТОР** на ленте. 
3. На этом экране вы увидите код модуля runbook (и при необходимости сможете изменить его). Чтобы настроить сегментированную среду, нажмите кнопку **ТЕСТ**, расположенную в нижней части экрана. Подтвердите сохранение и тестирование модуля runbook. 
4. На панели вывода вы можете просмотреть состояние задания. После завершения на указанном вами сервере базы данных SQL Azure будет заполняться диспетчер карты сегментов баз данных, а также база данных сегмента. **SetupShardedEnvironment** runbook предназначен только для подготовки сегментированных сред и не предназначен для запуска по повторяющемуся расписанию. Перейдите к следующему шагу.  

## Протестируйте модули Runbook службы автоматизации. 

Проверьте успешное выполнение всех модулей Runbook перед публикацией и планированием запуска модулей.

1. Щелкните **RUNBOOK** на ленте в верхней части страницы. 
2. Щелкните **ProvisionByDate** runbook.
3. Щелкните **АВТОР** на ленте в верхней части страницы. 
4. Щелкните **СОХРАНИТЬ **, затем **ТЕСТ**. 5. Повторите для **ReduceServiceTier**. 

    Обратите внимание, что **ProvisionBySize** и **ProvisionByDate** готовят новые сегменты (с помощью других алгоритмов), и в данный момент нет необходимости выполнять **ProvisionByDate** .

## Опубликуйте модуль Runbook. 
Следующий шаг – публикация модуля runbook, дающая возможность запланировать его выполнение на периодической основе.

1. Щелкните **ПУБЛИКОВАТЬ** в нижней части страницы. 
2. Щелкните **Опубликованные**. 
3. Перейдите к следующему шагу.
 
## Запланируйте выполнение модуля Runbook. 

Последний шаг – создание расписания и связывание его с опубликованным выше модулем Runbook.

1. Щелкните **РАСПИСАНИЯ** в верхней части страницы. 
2. Щелкните **ССЫЛКА НА НОВОЕ РАСПИСАНИЕ**.
3. Назовите расписание соответствующим образом и нажмите кнопку со стрелкой вправо.
4. Настройте расписание.
5. По завершении щелкните флажок в нижней части окна.
6. Когда задание будет запущено согласно предварительно установленному расписанию, щелкните **ЗАДАНИЯ **на ленте в верхней части страницы и затем выберите запланированное задание. 
## Заключение 

Теперь вы успешно создали и упаковали модуль PowerShell, передали модуль PowerShell для службы автоматизации Azure в качестве ресурса, а также создали, протестировали и опубликовали модуль Runbook и запланировали его выполнение. Для мониторинга исправности и состояния модуля Runbook используйте вкладки панели мониторинга и заданий.

Приведенные примеры демонстрируют лишь малую долю возможностей, которые дает сочетание эластичного масштабирования, баз данных SQL Azure и службы автоматизации Azure. Экспериментируйте с этими примерами и развивайте их дальше – так вы сможете добиться в своем приложении баз данных SQL Azure вертикального или горизонтального масштабирования либо обоих видов масштабирования сразу.

[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-manage-scripting/zip.png
[2]: ./media/sql-database-elastic-scale-manage-scripting/dll.png
[3]: ./media/sql-database-elastic-scale-manage-scripting/lookslikethis.png
[4]: ./media/sql-database-elastic-scale-manage-scripting/automation.png
[5]: ./media/sql-database-elastic-scale-manage-scripting/prompt.png
[6]: ./media/sql-database-elastic-scale-manage-scripting/success.png
[7]: ./media/sql-database-elastic-scale-manage-scripting/add-variable.png
[8]: ./media/sql-database-elastic-scale-manage-scripting/sign-up.png
[9]: ./media/sql-database-elastic-scale-manage-scripting/add-credential.png
[10]: ./media/sql-database-elastic-scale-manage-scripting/assets.png
 

<!---HONumber=July15_HO2-->