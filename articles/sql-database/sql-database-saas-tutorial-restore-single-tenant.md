---
title: "Восстановление базы данных отдельного клиента (пример приложения SaaS, использующего базу данных SQL Azure) | Документация Майкрософт"
description: "Сведения о восстановлении баз данных SQL отдельных клиентов после случайного удаления данных."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: tutorial
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 05/10/2017
ms.author: billgib;sstein
ms.translationtype: Human Translation
ms.sourcegitcommit: 71fea4a41b2e3a60f2f610609a14372e678b7ec4
ms.openlocfilehash: aa5759645713c5e5bc4c4f1d2b10f032efc7eae2
ms.contentlocale: ru-ru
ms.lasthandoff: 05/10/2017


---
# <a name="restore-a-single-tenant-database"></a>Восстановление базы данных отдельного клиента

Приложение SaaS Wingtip Tickets создано на основе модели, предусматривающей использование одной базы данных для каждого клиента. Одно из преимуществ этой модели заключается в простоте восстановления данных отдельного изолированного клиента, не влияя на другие клиенты.

В этом руководстве рассматривается два шаблона восстановления данных:

> [!div class="checklist"]

> * восстановление базы данных в параллельную базу данных (параллельное восстановление);
> * восстановление базы данных "на месте".


|||
|:--|:--|
| **Восстановление клиента до предыдущей точки во времени в параллельную базу данных** | Клиент может использовать этот шаблон для просмотра, аудита, обеспечения соответствия требованиям и т. д. Исходная база данных остается доступной и не изменяется. |
| **Восстановление клиента "на месте"** | Обычно этот шаблон используется для восстановления клиента до предыдущей точки во времени после случайного удаления данных. Исходная база данных переводится в автономный режим и заменяется восстановленной базой данных. |
|||

Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение WTP. Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Deploy and explore a multi-tenant SaaS application that uses Azure SQL Database](sql-database-saas-tutorial.md) (Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных Azure SQL).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="introduction-to-the-saas-tenant-restore-pattern"></a>Общие сведения о шаблоне восстановления клиента SaaS

Данные отдельного клиента можно восстановить с использованием двух простых шаблонов. Так как базы данных клиента изолированы, восстановление одного клиента не влияет на данные других клиентов.

В первом шаблоне данные восстанавливаются в новую базу данных. Затем клиент получает доступ к этой базе данных и ее рабочим данным. Этот шаблон позволяет администратору клиента просматривать восстановленные данные и использовать их, чтобы выборочно перезаписать текущие данные. Выбор вариантов восстановления данных зависит от конструктора приложений SaaS. В некоторых сценариях все, что может вам потребоваться, — это возможность просматривать данные в том состоянии, в котором они были в определенный момент времени. Если база данных использует [георепликацию](sql-database-geo-replication-overview.md), мы советуем копировать необходимые данные из восстановленной копии в исходную базу данных. После замены исходной базы данных восстановленной необходимо перенастроить и повторно синхронизировать георепликацию.

Во втором шаблоне, в котором предполагается потеря или повреждение данных, рабочая база данных клиента восстанавливается до предыдущей точки во времени. В шаблоне восстановления "на месте" клиент переводится в автономный режим до восстановления базы данных, а затем его работа возобновляется. В этом случае исходная база данных удаляется, но ее по-прежнему можно восстановить, чтобы вернуться до более ранней точки во времени. Этот шаблон позволяет изменить имя базы данных, а не удалять ее. Но изменение имени не позволит улучшить безопасность данных.

## <a name="get-the-wingtip-application-scripts"></a>Получение сценариев приложения Wingtip

Сценарий Wingtip Tickets и исходный код приложения доступны в репозитории GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS). Файлы сценариев находятся в папке [Learning Modules](https://github.com/Microsoft/WingtipSaaS/tree/master/Learning%20Modules). Скачайте папку **Learning Modules** на локальный компьютер, сохраняя ее структуру.

## <a name="simulate-a-tenant-accidentally-deleting-data"></a>Моделирование случайного удаления данных клиента

Чтобы продемонстрировать эти сценарии восстановления, нам нужно *случайно* удалить некоторые данные в одной из баз данных клиента. Хотя вы можете удалять любые записи, но мы советуем выполнить приведенную ниже процедуру, которая устраняет возможность блокировки демонстрационного сценария из-за нарушений целостности данных. Кроме того, выполнив ее, вы также добавите некоторые данные о приобретении билетов, которые можно использовать позже при работе с *руководствами по аналитике WTP*.

Выполните сценарий генератора билетов и создайте дополнительные данные. Генератор билетов намеренно не покупал билеты для каждого последнего события клиентов.

1. Откройте сценарий ...\\Learning Modules\\Utilities\\*Demo-TicketGenerator.ps1* в *интегрированной среде сценариев PowerShell*.
1. Нажмите клавишу **F5**, чтобы запустить сценарий и создать данные о продажах билетов и клиентах.


### <a name="open-the-events-app-to-review-the-current-events"></a>Просмотр текущих событий в приложении "События"

1. Откройте *концентратор событий* (http://events.wtp.&lt;пользователь&gt;.trafficmanager.net) и щелкните **Contoso Concert Hall**:

   ![Концентратор событий](media/sql-database-saas-tutorial-restore-single-tenant/events-hub.png)

1. Прокрутите список событий и запишите последнее:

   ![Последнее событие](media/sql-database-saas-tutorial-restore-single-tenant/last-event.png)


### <a name="run-the-demo-scenario-to-accidentally-delete-the-last-event"></a>Выполнение демонстрационного сценария случайного удаления последнего события

1. Откройте сценарий ...\\Learning Modules\\Business Continuity and Disaster Recovery\\RestoreTenant\\*Demo-RestoreTenant.ps1* в *интегрированной среде сценариев PowerShell* и задайте следующее значение:
   * **$DemoScenario** = **1**. Задав значение **1**, вы удалите события, в рамках которых не выполнялись продажи.
1. Нажмите клавишу **F5**, чтобы запустить сценарий и удалить последнее событие. Должно появиться примерно такое подтверждение:

   ```Console
   Deleting unsold events from Contoso Concert Hall ...
   Deleted event 'Seriously Strauss' from Contoso Concert Hall venue.
   ```

1. После этого откроется страница событий Contoso. Прокрутите вниз и убедитесь, что событие исчезло. Если событие по-прежнему в списке, щелкните обновить.

   ![Последнее событие](media/sql-database-saas-tutorial-restore-single-tenant/last-event-deleted.png)


## <a name="restore-a-tenant-database-in-parallel-with-the-production-database"></a>Восстановление базы данных клиента и рабочей базы данных

Эти действия позволяют восстановить базу данных Contoso Concert Hall до точки во времени перед удалением события. На предыдущих шагах вы удалили событие. Теперь нужно восстановить его, чтобы просмотреть удаленные данные. Рабочую базу данных с удаленной записью восстанавливать не нужно, но вам нужно восстановить старую базу данных, чтобы получить доступ к ее данным по другим деловым соображениям.

 Сценарий *Restore-TenantInParallel.ps1* создает параллельную базу данных клиента и параллельную запись каталога. Обоим этим элементам присваивается имя *ContosoConcertHall\_old*. Этот шаблон лучше всего подходит для восстановления после незначительной потери данных или сценариев восстановления данных с обеспечением соответствия требованиям и аудита. Мы также советуем использовать его в базах данных с [георепликацией](sql-database-geo-replication-overview.md).

1. Выполните действия в разделе [Моделирование случайного удаления данных клиента](#simulate-a-tenant-accidentally-deleting-data).
1. Откройте сценарий ...\\Learning Modules\\Business Continuity and Disaster Recovery\\RestoreTenant\\_Demo-RestoreTenant.ps1_ в *интегрированной среде сценариев PowerShell*.
1. Задайте **$DemoScenario** = **2**. Задав для этого параметра значение **2**, вы сможете *восстановить клиент в параллельном режиме*.
1. Нажмите клавишу **F5** для запуска скрипта.

Этот сценарий восстанавливает базу данных клиента (в параллельную базу данных) до точки во времени, предшествующей удалению события в предыдущем разделе. Он создает вторую базу данных, удаляет все имеющиеся метаданные каталога в этой базе данных и добавляет базу данных в каталог с записью *ContosoConcertHall\_old*.

Демонстрационный сценарий открывает страницу событий в браузере. Обратите внимание на следующий фрагмент URL-адреса: ```http://events.wtp.&lt;user&gt;.trafficmanager.net/contosoconcerthall_old```. Элемент *_old* в имени означает, что данные получены из восстановленной базы данных.

Просмотрите список событий в браузере и убедитесь, что событие, удаленное в предыдущем разделе, восстановилось.

Обратите внимание, что, предоставив доступ к восстановленному клиенту как к дополнительному с собственным приложением "События" для просмотра событий, связанных с билетами, вы не сможете получить доступ к восстановленным данным. Но этот способ наглядно иллюстрирует шаблон восстановления.

На самом деле вы, вероятно, только сохраните эту восстановленную базу данных на определенный период. После завершения запись восстановленного клиента можно удалить, вызвав сценарий *Remove-RestoredTenant.ps1*.

1. Чтобы выбрать сценарий *удаления восстановленного клиента*, задайте для параметра **$DemoScenario** значение **4**.
1. **Выполните этот сценарий**, **нажав клавишу** **F5**.
1. После этого запись *ContosoConcertHall\_old* удаляется из каталога. Закройте страницу событий этого клиента в браузере.


## <a name="restore-a-tenant-in-place-replacing-the-existing-tenant-database"></a>Восстановление клиента "на месте" с заменой имеющейся базы данных

Эти действия позволяют восстановить клиент Contoso Concert Hall до точки во времени перед удалением события. Сценарий *Restore-TenantInPlace* восстанавливает текущую базу данных клиента до новой базы данных, указывая на предшествующую точку во времени, и удаляет исходную базу данных. Этот шаблон лучше всего подходит для восстановления после серьезного повреждения со значительной потерей данных, которые нужно восстановить на клиенте.

1. Откройте файл **Demo-RestoreTenant.ps1** в интегрированной среде сценариев PowerShell.
1. Чтобы выбрать сценарий *восстановления клиента "на месте"*, задайте для параметра **$DemoScenario** значение **5**.
1. Выполните этот сценарий, нажав клавишу **F5**.

Этот сценарий восстанавливает базу данных клиента за 5 минут до удаления события. Сначала клиент Contoso Concert Hall переводится в автономный режим, поэтому его данные не обновляются. Затем в процессе восстановления из точки восстановления создается параллельная база данных с меткой времени в качестве имени. Таким образом, имена восстановленной и имеющейся базы данных клиента не будут конфликтовать. Затем старая база данных клиента удаляется, а восстановленной базе данных присваивается имя исходной. После этого работа клиента Contoso Concert Hall возобновляется и приложение получает доступ к восстановленной базе данных.

Вы успешно восстановили базу данных до точки во времени, предшествующей удалению события. После этого откроется страница событий. Проверьте, восстановилось ли последнее событие.


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]

> * восстановить базу данных в параллельную базу данных (параллельное восстановление);
> * восстановить базу данных "на месте".

[Manage schema for multiple tenants in the WTP SaaS application](sql-database-saas-tutorial-schema-management.md) (Управление схемой нескольких клиентов в SaaS-приложении WTP)

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по работе с SaaS-приложением WTP, использующим базу данных SQL Azure](sql-database-wtp-overview.md#sql-database-wtp-saas-tutorials)
* [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](sql-database-business-continuity.md)
* [Подробнее о резервном копировании базы данных SQL](sql-database-automated-backups.md)
