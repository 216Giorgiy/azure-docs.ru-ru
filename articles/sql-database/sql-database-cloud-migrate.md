<properties
   pageTitle="Перенос базы данных SQL Server в базу данных SQL Azure"
   description="База данных SQL Microsoft Azure, развертывание базы данных, миграция базы данных, импорт базы данных, экспорт базы данных, мастер миграции"
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jeffreyg"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-management"
   ms.date="10/12/2015"
   ms.author="carlrab"/>

# Перенос базы данных SQL Server в базу данных SQL Azure

База данных SQL Azure версии 12 обеспечивает практически полную совместимость на уровне ядра с SQL Server 2014 и SQL Server 2016. Для совместимых баз данных перенос в базу данных SQL Azure сводится к простой операции перемещения схемы и данных, не требующей изменения схемы или доработки приложений. Если изменения базы данных все же необходимы, их объем весьма ограничен по сравнению с базой данных SQL Azure версии 11.

Функции уровня сервера SQL Server не поддерживаются Базой данных SQL Azure версии 12 преднамеренно. Базы данных и приложения, опирающиеся на эти функции, потребуют небольшой доработки перед их миграцией.

>[AZURE.NOTE]Информацию о переносе других типов баз данных, в том числе Microsoft Access, Sybase, MySQL Oracle и DB2, в базу данных SQL Azure см. в статье [Помощник по миграции SQL Server](http://blogs.msdn.com/b/ssma/).

Рабочий процесс переноса базы данных SQL Server в базу данных SQL Azure состоит из следующих этапов.

 1. [Определение совместимости базы данных](#determine-if-your-database-is-compatible).
 2. [Устранение проблем совместимости, если база данных несовместима](#fix-database-compatibility-issues).
 3. [Перенос совместимой базы данных](#options-to-migrate-a-compatible-database-to-azure-sql-database).

## Определение совместимости базы данных
Существует два основных метода определения совместимости исходной базы данных. Экспорт приложения уровня данных — этот метод использует мастер в среде Management Studio и отображает сообщения об ошибках на консоли. SQLPackage.exe ([sqlpackage.exe](https://msdn.microsoft.com/library/hh550080.aspx)) — это служебная программа командной строки, поставляемая с Visual Studio и SQL Server. При использовании этого метода будет создан отчет.

> [AZURE.NOTE]Существует третий метод, который также использует файлы трассировки для проверки совместимости. Это [мастер миграции SQL Azure](http://sqlazuremw.codeplex.com/), бесплатное средство на сайте Codeplex. Однако это средство в настоящее время может обнаруживать проблемы совместимости, которые присутствовали в базе данных SQL Azure версии 11 и которые не являются проблемами в базе данных SQL Azure версии 12.

При обнаружении проблем совместимости базы данных их необходимо устранить до переноса базы данных в базу данных SQL Azure. Руководство по устранению проблем совместимости базы данных см. в разделе [Устранение проблем совместимости базы данных](#fix-database-compatibility-issues).

> [AZURE.IMPORTANT]Эти способы не обнаруживают все проблемы совместимости между различными уровнями баз данных SQL Server (т. е. уровень 90, 100 и 110). Если перенос выполняется с более старой базы данных (уровень 80, 90, 100 и 110), то сначала необходимо выполнить обновление (по крайней мере в среде разработки). Как только будет выполнено обновление до SQL Server 2014 (или более поздней версии), тогда можно начинать перенос в базу данных SQL Azure.

## Определение совместимости базы данных с помощью служебной программы sqlpackage.exe

1. Откройте окно командной строки и измените каталог, содержащий самую последнюю версию sqlpackage.exe. Эта служебная программа поставляется вместе с Visual Studio и SQL Server.
2. Выполните следующую команду, заменив значение следующих аргументов: < server_name >, < database_name >, < target_file >, < schema_name.table_name > и < output_file >. Аргумент /p:TableName используется потому, что нужно проверить только совместимость базы данных для экспорта в базу данных SQL Azure версии 12, а не экспортировать данные из всех таблиц. К сожалению, аргумент экспорта для sqlpackage.exe не поддерживает извлечение без таблицы, поэтому нужно указать одну небольшую таблицу. Аргумент < output_file > будет содержать отчет об ошибках.

	'sqlpackage.exe /Action:Export /ssn:< server_name > /sdn:< database_name > /tf:< target_file > /p:TableData=< schema_name.table_name > > < output_file > 2>&1'

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSQLPackage01.png)

3. Откройте выходной файл и просмотрите проблемы совместимости (если они есть). Руководство по устранению проблем совместимости базы данных см. в разделе [Устранение проблем совместимости базы данных](#fix-database-compatibility-issues).

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSQLPackage02.png)

## Определение совместимости базы данных с помощью экспорта приложения уровня данных

1. Убедитесь, что вы используете среду SQL Server Management Studio версии 13.0.600.65 или более поздней. Новые версии среды Management Studio обновляются ежемесячно для поддержания синхронизации с обновлениями портала Azure.

 	 >[AZURE.IMPORTANT]Загрузите [последнюю](https://msdn.microsoft.com/library/mt238290.aspx) версию среды SQL Server Management Studio. Мы рекомендуем всегда использовать самую последнюю версию среды Management Studio.

2. Откройте среду Management Studio и подключитесь к исходной базе данных в обозревателе объектов.
3. В обозревателе объектов щелкните правой кнопкой мыши исходную базу данных, наведите указатель мыши на пункт **Задачи** и выберите команду **Экспорт приложения уровня данных...**

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSSMS01.png)

4. В окне мастера экспорта на вкладке **Настройки** настройте сохранение BACPAC-файла на локальный диск или в большой двоичный объект Azure. BACPAC-файл будет сохранен, только если нет проблем совместимости базы данных. При наличии проблем совместимости они будут отображаться на консоли.

	![Параметры экспорта](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSSMS02.png)

5. Перейдите на вкладку **Дополнительно** и снимите флажок **Выделить все**, чтобы пропустить экспорт данных. На этом этапе нашей целью является только проверка совместимости.

	![Параметры экспорта](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSSMS03.png)

6. Нажмите кнопку **Далее**, а затем кнопку **Готово**. При наличии проблем совместимости базы данных они отобразятся, после того как мастер проверит схему.

	![Параметры экспорта](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSSMS04.png)

7. Если проблемы отсутствуют, значит база данных совместима и все готово к переносу. Если проблемы есть, их необходимо устранить. Чтобы просмотреть проблемы, нажмите ссылку **Ошибка** для соответствующей **Проверки схемы**. Сведения об устранении этих проблем см. в разделе [Устранение проблем совместимости базы данных](#fix-database-compatibility-issues).

	![Параметры экспорта](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSSMS05.png)

## Возможности переноса совместимой базы данных в базу данных SQL Azure

- Перенос малых и средних [совместимых](#determine-if-your-database-is-compatible) баз данных SQL Server 2005 или более поздних версий выполняется просто и заключается в запуске [мастера по развертыванию базы данных в базе данных Microsoft Azure](#use-the-deploy-database-to-microsoft-azure-database-wizard) в среде SQL Server Management Studio. При наличии проблем с подключением (отсутствие подключения, низкая пропускная способность или проблемы из-за превышения времени ожидания) можно [использовать BACPAC-файл для переноса](#use-a-bacpac-to-migrate-a-database-to-azure-sql-database) базы данных SQL Server в базу данных SQL Azure.
- Для средних и больших баз данных или при наличии проблем с подключением [используйте BACPAC-файл для переноса](#use-a-bacpac-to-migrate-a-database-to-azure-sql-database) базы данных SQL Server в базу данных SQL Azure. Благодаря этому методу вы можете воспользоваться SQL Server Management Studio для экспорта данных и схемы в [BACPAC](https://msdn.microsoft.com/library/ee210546.aspx#Anchor_4)-файл (хранящийся локально или в большом двоичном объекте Azure), а затем импортировать BACPAC-файл в экземпляр Azure SQL. При хранении BACPAC-файла в большом двоичном объекте Azure вы также можете импортировать этот файл на [портале Azure](sql-database-import.md) или [с помощью PowerShell](sql-database-import-powershell.md).
- В больших базах данных можно достичь повышения производительности за счет отдельного переноса схемы и данных. Благодаря этому методу вы извлекаете схему с помощью SQL Server Management Studio или создаете проект базы данных в Visual Studio, а затем разворачиваете эту схему в базу данных SQL Azure. После импорта схемы в базу данных SQL Azure можно использовать служебную программу [BCP](https://msdn.microsoft.com/library/ms162802.aspx) для извлечения данных в неструктурированные файлы, а затем импортировать эти файлы в базу данных SQL Azure.

 ![Схема миграции среды SSMS](./media/sql-database-migrate-ssms/01SSMSDiagram.png)

## Использование мастера развертывания базы данных в базу данных Microsoft Azure

Мастер развертывания базы данных в базе данных Microsoft Azure в среде SQL Server Management Studio переносит [совместимую](#determine-if-your-database-is-compatible) базу данных SQL Server 2005 (или более поздней версии) непосредственно в экземпляр логического сервера SQL Azure.

> [AZURE.NOTE]При выполнении указанных ниже действий предполагается, что вы уже подготовили логический экземпляр SQL Azure и у вас есть сведения о подключении.

1. Убедитесь, что вы используете среду SQL Server Management Studio версии 13.0.600.65 или более поздней. Новые версии среды Management Studio обновляются ежемесячно для поддержания синхронизации с обновлениями портала Azure.

	 >[AZURE.IMPORTANT]Загрузите [последнюю](https://msdn.microsoft.com/library/mt238290.aspx) версию среды SQL Server Management Studio. Мы рекомендуем всегда использовать самую последнюю версию среды Management Studio.

2. Откройте среду Management Studio и подключитесь к исходной базе данных в обозревателе объектов.
3. В обозревателе объектов щелкните правой кнопкой мыши исходную базу данных, наведите указатель мыши на пункт **Задачи** и выберите команду **Развернуть базу данных в базу данных SQL Microsoft Azure…**

	![Развертывание в Azure из меню "Задачи"](./media/sql-database-cloud-migrate/MigrateUsingDeploymentWizard01.png)

4.	В мастере развертывания настройте подключение к серверу базы данных SQL Azure.
5.	Укажите **Имя новой базы данных** для базы данных в базе данных SQL Azure, установите параметры **Выпуск базы данных SQL Microsoft Azure** (уровень службы), **Максимальный размер базы данных**, **Цель обслуживания** (уровень производительности) и **Имя временного файла** для BACPAC-файла, создаваемого мастером в процессе переноса. Дополнительные сведения об уровнях обслуживания и уровнях производительности см. в статье [Уровни служб в базе данных SQL Azure](sql-database-service-tiers.md).

	![Параметры экспорта](./media/sql-database-cloud-migrate/MigrateUsingDeploymentWizard02.png)

6.	Завершите выполнение мастера, чтобы перенести базу данных. В зависимости от размера и сложности базы данных процесс развертывания может занять от нескольких минут до нескольких часов.
7.	В обозревателе объектов подключитесь к перенесенной базе данных на сервере базы данных SQL Azure.
8.	На портале Azure просмотрите базу данных и ее свойства.

## Использование BACPAC-файла для переноса базы данных SQL Server в базу данных SQL Azure

При переносе средних и больших баз данных или при наличии проблем с подключением процесс переноса можно разделить на два отдельных этапа. Схему и ее данные можно экспортировать в [BACPAC](https://msdn.microsoft.com/library/ee210546.aspx#Anchor_4)-файл с помощью одного или двух методов.

- [Экспорт в BACPAC-файл с помощью среды SQL Server Management Studio](#export-a-compatible-sql-server-database-to-a-bacpac-file-using-sql-server-management-studio)
- [Экспорт в BACPAC-файл с помощью SqlPackage](#export-a-compatible-sql-server-database-to-a-bacpac-file-using-sqlpackage)

Этот BACPAC-файл можно сохранить локально или в большом двоичном объекте Azure. Затем можно импортировать этот BACPAC-файл в базу данных SQL Azure, используя один из методов.

- [Импорт из BACPAC-файла в базу данных SQL Azure с помощью среды SQL Server Management Studio](#import-from-a-bacpac-file-into-azure-sql-database-using-sql-server-management-studio)
- [Импорт из BACPAC-файла в базу данных SQL Azure с помощью SqlPackage](#import-from-a-bacpac-file-into-azure-sql-database-using-sqlpackage)
- [Импорт из BACPAC-файла в базу данных SQL Azure с помощью портала Azure](sql-database-import.md)
- [Импорт из BACPAC-файла в базу данных SQL Azure с помощью PowerShell](sql-database-import-powershell.md)

## Экспорт совместимой базы данных SQL Server в BACPAC-файл с помощью SQL Server Management Studio

Выполните следующие действия для экспорта переносимой [совместимой](#determine-if-your-database-is-compatible) базы данных SQL Server в BACPAC-файл с помощью среды Management Studio.

1. Убедитесь, что вы используете среду SQL Server Management Studio версии 13.0.600.65 или более поздней. Новые версии среды Management Studio обновляются ежемесячно для поддержания синхронизации с обновлениями портала Azure.

	 >[AZURE.IMPORTANT]Загрузите [последнюю](https://msdn.microsoft.com/library/mt238290.aspx) версию среды SQL Server Management Studio. Мы рекомендуем всегда использовать самую последнюю версию среды Management Studio.

2. Откройте среду Management Studio и подключитесь к исходной базе данных в обозревателе объектов.

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/MigrateUsingBACPAC01.png)

3. В обозревателе объектов щелкните правой кнопкой мыши исходную базу данных, наведите указатель мыши на пункт **Задачи** и выберите команду **Экспорт приложения уровня данных...**

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSSMS01.png)

4. В окне мастера экспорта настройте сохранение BACPAC-файла на локальный диск или в большой двоичный объект Azure. Экспортированный файл BACPAC всегда содержит полную схему базы данных и по умолчанию данные из всех таблиц. Воспользуйтесь вкладкой "Дополнительно", если необходимо исключить данные из некоторых или всех таблиц. Например, можно экспортировать только данные для ссылочных таблиц, а не для всех таблиц.

	![Параметры экспорта](./media/sql-database-cloud-migrate/MigrateUsingBACPAC02.png)

## Экспорт совместимой базы данных SQL Server в BACPAC-файл с помощью SqlPackage

Выполните следующие действия для экспорта переносимой [совместимой](#determine-if-your-database-is-compatible) базы данных в BACPAC-файл с помощью служебной программы командной строки [SqlPackage.exe](https://msdn.microsoft.com/library/hh550080.aspx).

> [AZURE.NOTE]При выполнении описанных ниже действий предполагается, что вы уже подготовили сервер базы данных SQL Azure, имеете сведения о подключении и проверили совместимость исходной базы данных.

1. Откройте окно командной строки и измените каталог, содержащий служебную программу командной строки sqlpackage.exe. Эта служебная программа поставляется в комплекте с Visual Studio и SQL Server.
2. Выполните следующую команду, заменив значение следующих аргументов: < server_name >, < database_name > и < target_file >.

	'sqlpackage.exe /Action:Export /ssn:< server_name > /sdn:< database_name > /tf:< target_file >

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSQLPackage01b.png)

## Импорт из BACPAC-файла в базу данных SQL Azure с помощью среды SQL Server Management Studio

Выполните описанные ниже действия для импорта из BACPAC-файла в базу данных SQL Azure.

> [AZURE.NOTE]При выполнении указанных ниже действий предполагается, что вы уже подготовили логический экземпляр SQL Azure и у вас есть сведения о подключении.

1. Убедитесь, что вы используете среду SQL Server Management Studio версии 13.0.600.65 или более поздней. Новые версии среды Management Studio обновляются ежемесячно для поддержания синхронизации с обновлениями портала Azure.

	 >[AZURE.IMPORTANT]Загрузите [последнюю](https://msdn.microsoft.com/library/mt238290.aspx) версию среды SQL Server Management Studio. Мы рекомендуем всегда использовать самую последнюю версию среды Management Studio.

2. Откройте среду Management Studio и подключитесь к исходной базе данных в обозревателе объектов.

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/MigrateUsingBACPAC01.png)

    После создания BACPAC-файла подключитесь к серверу базы данных SQL Azure, щелкните правой кнопкой мыши папку **базы данных** и выберите команду **Импорт приложения уровня данных...**

    ![Импорт пункта меню приложения уровня данных](./media/sql-database-cloud-migrate/MigrateUsingBACPAC03.png)

3.	В мастере импорта выберите файл BACPAC-файл, который вы экспортировали, для создания новой базы данных в Базе данных SQL Azure.

    ![Импорт параметров](./media/sql-database-cloud-migrate/MigrateUsingBACPAC04.png)

4.	Укажите **Имя новой базы данных** для базы данных в базе данных SQL Azure, установите параметры **Выпуск базы данных SQL Microsoft Azure** (уровень службы), **Максимальный размер базы данных** и **Цель обслуживания** (уровень производительности).

    ![Параметры базы данных](./media/sql-database-cloud-migrate/MigrateUsingBACPAC05.png)

5.	Нажмите кнопку **Далее**, а затем кнопку **Готово** для импорта BACPAC-файла в новую базу данных на сервере базы данных SQL Azure.

6. В обозревателе объектов подключитесь к перенесенной базе данных на сервере базы данных SQL Azure.

7.	На портале Azure просмотрите базу данных и ее свойства.

## Импорт из BACPAC-файла в базу данных SQL Azure с помощью SqlPackage

Выполните следующие действия для импорта совместимой базы данных SQL Server (или базы данных SQL Azure) из BACPAC-файл с помощью служебной программы командной строки [SqlPackage.exe](https://msdn.microsoft.com/library/hh550080.aspx).

> [AZURE.NOTE]При выполнении указанных ниже действий предполагается, что вы уже подготовили сервер базы данных SQL Azure и имеете сведения о подключении.

1. Откройте окно командной строки и измените каталог, содержащий служебную программу командной строки sqlpackage.exe. Эта служебная программа поставляется в комплекте с Visual Studio и SQL Server.
2. Выполните следующую команду, заменив значение следующих аргументов: < server_name >, < database_name >, < user_name >, < password > и < source_file >.

	'sqlpackage.exe /Action:Import /tsn:< server_name > /tdn:< database_name > /tu:< user_name > /tp:< password > /sf:< target_file >

	![Экспорт приложения уровня данных из меню "Задачи"](./media/sql-database-cloud-migrate/TestForCompatibilityUsingSQLPackage01c.png)


## Устранение проблем совместимости базы данных

Есть несколько способов устранения проблем совместимости исходной базы данных SQL Server, которые были [обнаружены ранее](#determine-if-your-database-is-compatible).

- Используйте [мастер миграции SQL Azure](http://sqlazuremw.codeplex.com/). Это средство Codeplex можно использовать для создание сценария T-SQL из несовместимой исходной базы данных, который затем преобразуется мастером, чтобы сделать его совместимым с базой данных SQL, а затем подключить к базе данных SQL Azure для выполнения сценария. Это средство также будет анализировать файлы трассировки, чтобы определить проблемы совместимости. Сценарии могут создаваться только со схемой или могут содержать данные в формате BCP. Дополнительная документация, в том числе пошаговые инструкции, доступна на сайте Codeplex в разделе [Мастер миграции SQL Azure](http://sqlazuremw.codeplex.com/).  

 ![Схема переноса SAMW](./media/sql-database-cloud-migrate/02SAMWDiagram.png)

 >[AZURE.NOTE]Обратите внимание, что не все несовместимые схемы, которые могут быть обнаружены с помощью мастера, подлежат обработке с помощью его встроенных средств преобразования. Если имеются несовместимые сценарии, которые не удается обработать, то о них будет сообщено как об ошибках. Такие сценарии будут внедрены в созданный сценарий с соответствующими комментариями. Если обнаружено много ошибок, используйте Visual Studio или SQL Server Management Studio для исправления каждой ошибки, которую невозможно исправить с помощью мастера миграции SQL Server.

- Используйте Visual Studio. Visual Studio можно использовать для импорта схемы базы данных в проект базы данных Visual Studio для анализа. Для анализа укажите целевую платформу для проекта как Базу данных SQL версии 12, а затем соберите проект. Если построение выполнено успешно, база данных совместима. Если построение завершается неудачей, можно устранить ошибки в SQL Server Data Tools для Visual Studio (SSDT). После успешного построения проекта, вы можете опубликовать его в качестве копии базы данных-источника, а затем использовать функцию сравнения данных в SSDT, чтобы скопировать данные из базы данных-источника в базу данных, совместимую с SQL Azure версии 12. Затем развертывание обновленной базы данных в базе данных SQL Azure выполняется по плану, [описанному ранее](#options-to-migrate-a-compatible-database-to-azure-sql-database).

 ![Схема переноса VSSSDT](./media/sql-database-cloud-migrate/03VSSSDTDiagram.png)

 >[AZURE.NOTE]Если требуется перенести только схему, можно опубликовать ее в Базе данных SQL Azure непосредственно из Visual Studio. Этот метод используется, если схема баз данных требует больше изменений, чем может обработать мастер миграции.

- SQL Server Management Studio. Исправить ошибки можно в среде Management Studio с помощью команд Transact-SQL, таких как **ALTER DATABASE**.

<!---HONumber=Oct15_HO3-->