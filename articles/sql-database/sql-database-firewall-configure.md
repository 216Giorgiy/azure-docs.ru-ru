<properties
   pageTitle="Настройка брандмауэра базы данных SQL Azure | Microsoft Azure"
   description="Узнайте, как настроить брандмауэр базы данных SQL с помощью правил брандмауэра уровня сервера и базы данных для управления доступом."
   keywords="брандмауэр базы данных"
   services="sql-database"
   documentationCenter=""
   authors="BYHAM"
   manager="jeffreyg"
   editor="cgronlun"
   tags=""/>

<tags
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="data-management"
   ms.date="08/04/2015"
   ms.author="rickbyh"/>

# Как настроить брандмауэр базы данных SQL Azure

База данных SQL Microsoft Azure предоставляет службу реляционных баз данных для Azure и других интернет-приложений. Для защиты данных брандмауэр базы данных SQL запрещает любой доступ к серверу базы данных SQL, пока не будут указаны компьютеры, которые имеют разрешение. Брандмауэр базы данных предоставляет доступ на основании исходного IP-адреса каждого запроса.

Для настройки брандмауэра базы данных можно создать правила брандмауэра, которые указывают диапазон допустимых IP-адресов. Можно создавать правила брандмауэра на уровне сервера и базы данных.

- **Правила брандмауэра уровня сервера:** эти правила разрешают клиентам доступ ко всему серверу базы данных SQL Azure, то есть ко всем базам данных в одном логическом сервере. Эти правила хранятся в базе данных **master**.
- **Правила брандмауэра уровня базы данных:** эти правила разрешают клиентам доступ к отдельным базам данных в пределах сервера базы данных SQL Azure. Эти правила создаются для каждой базы данных и хранятся в отдельных базах данных (включая **master**). Эти правила могут быть полезны для ограничения доступа к определенным (защищенным) базам данных в одном логическом сервере.

**Рекомендация.** Корпорация Майкрософт рекомендует использовать правила брандмауэра уровня базы данных всегда, когда это возможно, чтобы сделать базу данных более портативной. Используйте правила брандмауэра уровня сервера, если у вас много баз данных, имеющих одинаковые требования доступа, и вы не хотите тратить время на настройку каждой базы данных по отдельности.

**О федерациях.** Текущая реализация федераций станет устаревшей вместе с уровнями служб Web и Business. Внедрение настраиваемых решений сегментирования позволяет повысить масштабируемость, гибкость и производительность. Дополнительные сведения о настраиваемом сегментировании можно найти в статье [Масштабирование баз данных SQL Azure](https://msdn.microsoft.com/library/dn495641.aspx).

> [AZURE.NOTE]При создании федерации баз данных в базе данных SQL Azure, где корневая база данных содержит правила брандмауэра уровня базы данных, правила не копируются в базы данных члена федерации. Если вам требуются правила брандмауэра уровня базы данных для членов федерации, необходимо заново создать правила для членов федерации. Однако если вы разбиваете член федерации, содержащий правило брандмауэра уровня базы данных, на новых членов федерации с помощью инструкции ALTER FEDERATION… SPLIT, новые конечные члены будет следовать тем же правилам брандмауэра уровня базы данных, что и исходный член федерации. Подробнее о федерациях см. в разделе [Федерации в базе данных SQL Azure](https://msdn.microsoft.com/library/hh597452.aspx).

## Обзор брандмауэра базы данных SQL

Первоначально весь доступ к серверу базы данных SQL Azure блокируется брандмауэром. Чтобы начать использование сервера базы данных SQL Azure, необходимо перейти на портал управления и указать одно или несколько правил брандмауэра уровня сервера, которые обеспечивают доступ к серверу базы данных SQL Azure. Используйте правила брандмауэра, чтобы указать, какие диапазоны IP-адресов из Интернета могут делать попытки подключения к серверу базы данных SQL Azure, а также разрешено ли это приложениям Azure.

Тем не менее, если требуется выборочно предоставить доступ только к одной из баз данных на сервере базы данных SQL Azure, необходимо создать правило уровня базы данных для соответствующей базы данных с более широким диапазоном IP-адресов, чем указанный в правиле брандмауэра уровня сервера, и убедиться, что IP-адрес клиента попадает в диапазон, указанный в правиле уровня базы данных.

Попытки подключения из Интернета и Azure должны сначала пройти через брандмауэр, прежде чем достигнуть сервера базы данных SQL Azure или базы данных, как показано на следующей схеме.

   ![Схема конфигурации брандмауэра базы данных SQL.][1]

## Подключение через Интернет

Когда компьютер пытается подключиться к серверу базы данных из Интернета, брандмауэр проверяет исходный IP-адрес запроса относительно полного набора правил брандмауэра уровня сервера и (при необходимости) уровня базы данных:

- Если IP-адрес запроса находится в одном из диапазонов, указанных в правилах брандмауэра уровня сервера, подключение предоставляется к серверу базы данных SQL Azure.

- Если IP-адрес запроса не находится в одном из диапазонов, указанных в правиле брандмауэра уровня сервера, проверяются правила брандмауэра уровня базы данных. Если IP-адрес запроса находится в одном из диапазонов, указанных в правилах брандмауэра уровня базы данных, подключение предоставляется только к базе данных, в которой есть соответствующее правило уровня базы данных.

- Если IP-адрес запроса находится за пределами диапазонов, указанных в любом из правил брандмауэра уровня сервера или уровня базы данных, запрос на подключение отклоняется.

> [AZURE.NOTE]Для доступа к базе данных SQL Azure с локального компьютера убедитесь, что брандмауэр сети и локального компьютера разрешает исходящие подключения по TCP-порту 1433.


## Подключение из Azure

Когда приложение из Azure пытается подключиться к серверу базы данных, брандмауэр проверяет, разрешены ли подключения Azure. Параметр брандмауэра с начальным и конечным адресом, равным 0.0.0.0, указывает, что эти подключения разрешены. Если попытка подключения не разрешена, запрос не достигает сервера базы данных SQL Azure.

Подключения из Azure можно включить на [портале управления](http://go.microsoft.com/fwlink/p/?LinkID=161793) двумя способами:

- Установите флажок **Разрешить службам Microsoft Azure доступ к серверу** при создании нового сервера.

- На сервере на вкладке **Настройка** в разделе **Разрешенные службы** щелкните **Да** для **служб Microsoft Azure**.

## Создание первого правила брандмауэра уровня сервера

Первый параметр брандмауэра на уровне сервера можно создать с помощью [портала управления](http://go.microsoft.com/fwlink/p/?LinkID=161793) или программным путем с помощью REST API или Azure PowerShell. Последующие правила брандмауэра уровня сервера можно создавать и контролировать с помощью этих методов, а также посредством Transact-SQL. Дополнительные сведения о правилах брандмауэра уровня сервера см. в разделе [Практическое руководство. Настройка параметров брандмауэра для Базы данных SQL](sql-database-configure-firewall-settings.md).

## Правила брандмауэра уровня базы данных

После настройки первого брандмауэра уровня сервера можно ограничить доступ к определенным базам данных. Если в правиле брандмауэра уровня базы данных указать диапазон IP-адресов, выходящий за пределы диапазона, указанного в правиле брандмауэра уровня сервера, доступ к базе данных смогут получить только те клиенты, которые имеют IP-адреса в диапазоне уровня базы данных. Для базы данных можно задать не более 128 правил брандмауэра уровня базы данных. С помощью Transact-SQL можно создать и контролировать правила брандмауэра уровня базы данных для главной и пользовательской баз данных. Дополнительные сведения см. в статье [Практическое руководство. Настройка параметров брандмауэра для Базы данных SQL](sql-database-configure-firewall-settings.md).

## Программное управление правилами брандмауэра базы данных

Помимо портала управления Azure правилами брандмауэра можно управлять программно с помощью Transact-SQL, API REST и Azure PowerShell. В приведенных ниже таблицах описан набор команд, доступных для каждого метода.


### Transact-SQL

| Представление каталога или хранимая процедура | Уровень | Описание |
|--------------------------------------------------------------------------------------------|-----------|------------------------------------------------------|
| [sys.firewall\_rules](https://msdn.microsoft.com/library/dn269980.aspx) | сервер; | Отображает текущие правила брандмауэра уровня сервера |
| [sp\_set\_firewall\_rule](https://msdn.microsoft.com/library/dn270017.aspx) | сервер; | Создает или обновляет правила брандмауэра уровня сервера |
| [sp\_delete\_firewall\_rule](https://msdn.microsoft.com/library/dn270024.aspx) | сервер; | Удаляет правила брандмауэра уровня сервера |
| [sys.database\_firewall\_rules](https://msdn.microsoft.com/library/dn269982.aspx) | База данных | Отображает текущие правила брандмауэра уровня базы данных |
| [sp\_set\_database\_firewall\_rule](https://msdn.microsoft.com/library/dn270010.aspx) | База данных | Создает или обновляет правила брандмауэра уровня базы данных |
| [sp\_delete\_database\_firewall\_rule](https://msdn.microsoft.com/library/dn270030.aspx) | Базы данных | Удаляет правила брандмауэра на уровне базы данных |

### Интерфейс REST API

| API | Уровень | Описание |
|----------------------|--------|------------------------------------------------------------------|
| [Вывод списка правил брандмауэра](https://msdn.microsoft.com/library/azure/dn505715.aspx) | сервер; | Отображает текущие правила брандмауэра уровня сервера |
| [Создание правила брандмауэра](https://msdn.microsoft.com/library/azure/dn505712.aspx) | сервер; | Создает или обновляет правила брандмауэра уровня сервера |
| [Задание правила брандмауэра](https://msdn.microsoft.com/library/azure/dn505707.aspx) | сервер; | Обновляет свойства существующего правила брандмауэра уровня сервера |
| [Удаление правила брандмауэра](https://msdn.microsoft.com/library/azure/dn505706.aspx) | сервер; | Удаляет правила брандмауэра уровня сервера |


### Azure PowerShell

| Командлет | Уровень | Описание |
|-----------------------------------------------------------------------------------------------------|--------|------------------------------------------------------------------|
| [Get-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546731.aspx) | сервер; | Возвращает текущие правила брандмауэра уровня сервера |
| [New-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546724.aspx) | сервер; | Создает новое правило брандмауэра уровня сервера |
| [Set-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546739.aspx) | сервер; | Обновляет свойства существующего правила брандмауэра уровня сервера |
| [Remove-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546727.aspx) | сервер; | Удаляет правила брандмауэра уровня сервера |

> [AZURE.NOTE]Задержка вступления в силу новых настроек брандмауэра может составить до пяти минут.

## Устранение неполадок брандмауэра базы данных

Если доступ к службе базы данных SQL Microsoft Azure не работает должным образом, необходимо учитывать следующее.

- **Конфигурация локального брандмауэра:** прежде чем компьютер сможет получить доступ к Базе данных SQL Azure, может потребоваться создать исключение брандмауэра на компьютере для TCP-порта 1433. Вам может потребоваться открыть дополнительные порты при создании подключений в пределах облака Azure. Подробнее об этом см. в разделе **Версия 12 Базы данных SQL: внешняя и внутренняя программа** статьи [Порты, кроме 1433, для ADO.NET 4.5 и Базы данных SQL версии 12](sql-database-develop-direct-route-ports-adonet-v12.md).

- **Преобразование сетевых адресов (NAT):** из-за применения NAT IP-адрес, используемый компьютером для подключения к Базе данных SQL Azure, может отличаться от IP-адреса, показанного в параметрах конфигурации IP-адреса компьютера. Для просмотра IP-адреса, используемого компьютером для подключения к Azure, войдите на портал управления и перейдите на вкладку **Настройка** сервера, где размещена база данных. В разделе **Разрешенные IP-адреса** отображается **текущий IP-адрес клиента**. Щелкните **Добавить** в разделе **Разрешенные IP-адреса**, чтобы разрешить компьютеру доступ к серверу.

- **Изменения в списке разрешенных адресов еще не вступили в силу:** может присутствовать задержка до пяти минут до вступления в силу изменений конфигурации брандмауэра Базы данных SQL Azure.

- **Имя для входа не имеет прав, или использован неправильный пароль:** если имя для входа не имеет разрешений на сервере Базы данных SQL Azure или введен неправильный пароль, подключение к серверу Базы данных SQL Azure будет отклонено. Создание параметра брандмауэра только предоставляет клиентам возможность подключения к серверу. Каждый клиент должен предоставить необходимые учетные данные безопасности. Дополнительные сведения о подготовке имен входа см. в разделе "Управление базами данных, именами входа и пользователями в базе данных SQL Azure".

- **Динамический IP-адрес:** если используется подключение к Интернету с динамическим предоставлением IP-адресов и возникли проблемы с прохождением через брандмауэр, попробуйте одно из описанных ниже решений.

 - Попросите поставщика услуг Интернета (ISP) назначить диапазон IP-адресов тем клиентским компьютерам, с которых будет осуществляться доступ к серверу базы данных SQL Azure, а затем добавьте диапазон IP-адресов в качестве правила брандмауэра.

 - Получите статические IP-адреса для клиентских компьютеров, а затем добавьте IP-адреса как правила брандмауэра.

## См. также

[Практическое руководство. Настройка параметров брандмауэра базы данных SQL Azure](sql-database-configure-firewall-settings.md)

<!--Image references-->
[1]: ./media/sql-database-firewall-configure/sqldb-firewall-1.png

<!---HONumber=Nov15_HO4-->