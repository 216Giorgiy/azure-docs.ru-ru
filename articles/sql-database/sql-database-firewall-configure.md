<properties
   pageTitle="Общие сведения о настройке брандмауэра SQL Server | Microsoft Azure"
   description="Узнайте, как настроить брандмауэр базы данных SQL с помощью правил брандмауэра уровня сервера и базы данных для управления доступом."
   keywords="брандмауэр базы данных"
   services="sql-database"
   documentationCenter=""
   authors="BYHAM"
   manager="jhubbard"
   editor="cgronlun"
   tags=""/>

<tags
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="data-management"
   ms.date="06/10/2016"
   ms.author="rickbyh"/>

# Как настроить брандмауэр сервера Azure SQL Server (обзор)


> [AZURE.SELECTOR]
- [Обзор](sql-database-firewall-configure.md)
- [Портал Azure](sql-database-configure-firewall-settings.md)
- [TSQL](sql-database-configure-firewall-settings-tsql.md)
- [PowerShell](sql-database-configure-firewall-settings-powershell.md)
- [ИНТЕРФЕЙС REST API](sql-database-configure-firewall-settings-rest.md)


База данных SQL Microsoft Azure предоставляет службу реляционных баз данных для Azure и других интернет-приложений. Чтобы защитить ваши данные, брандмауэр запрещает любой доступ к серверу базы данных, пока вы не укажете компьютеры, у которых есть разрешение на доступ. Брандмауэр предоставляет доступ к базам данным на основе исходного IP-адреса каждого запроса.

Для настройки брандмауэра можно создать правила брандмауэра, которые указывают диапазон допустимых IP-адресов. Можно создавать правила брандмауэра на уровне сервера и базы данных.

- **Правила брандмауэра серверного уровня:** эти правила разрешают клиентам доступ ко всему серверу Azure SQL Server, то есть ко всем базам данных на одном логическом сервере. Эти правила хранятся в базе данных **master**. Правила брандмауэра серверного уровня можно настроить на портале или с помощью инструкций Transact-SQL.
- **Правила брандмауэра уровня базы данных:** эти правила разрешают клиентам доступ к отдельным базам данных в пределах сервера базы данных SQL Azure. Эти правила создаются для каждой базы данных и хранятся в отдельных базах данных (включая **master**). Эти правила могут быть полезны для ограничения доступа к определенным (защищенным) базам данных в одном логическом сервере. Правила брандмауэра на уровне базы данных можно настроить только с помощью инструкций Transact-SQL.

**Рекомендация.** Корпорация Майкрософт рекомендует по возможности всегда использовать правила брандмауэра на уровне базы данных, чтобы повысить уровень безопасности и портативность базы данных. Используйте правила брандмауэра серверного уровня для администраторов, если у вас много баз данных с одинаковыми требованиями к доступу и вы не хотите тратить время на настройку каждой базы данных по отдельности.


## Общие сведения о брандмауэре

Первоначально весь доступ к серверу Azure SQL Server с использованием Transact-SQ блокируется брандмауэром. Чтобы использовать Azure SQL Server, вам сначала нужно указать на портале Azure одно или несколько правил брандмауэра серверного уровня, которые обеспечивают доступ к этому серверу. Используйте правила брандмауэра, чтобы определить диапазоны IP-адресов из Интернета, которые могут пытаться подключиться к серверу Azure SQL Server; кроме того, нужно указать, разрешено ли это приложениям Azure.

Однако если вы хотите выборочно предоставить доступ только к одной из баз данных на сервере Azure SQL Server, вам нужно создать правило на уровне базы данных для соответствующей базы данных с более широким диапазоном IP-адресов, чем указано в правиле брандмауэра серверного уровня. Также следует убедиться, что IP-адрес клиента попадает в диапазон, указанный в правиле на уровне базы данных.

Запросы на подключение из Интернета и среды Azure должны сначала обрабатываться брандмауэром и только потом достигать сервера Azure SQL Server или базы данных SQL, как показано на следующей схеме.

   ![Схема, описывающая конфигурацию брандмауэра.][1]

## Подключение через Интернет

Когда компьютер пытается подключиться к серверу базы данных из Интернета, брандмауэр проверяет исходный IP-адрес запроса относительно полного набора правил брандмауэра уровня сервера и (при необходимости) уровня базы данных:

- Если IP-адрес запроса находится в одном из диапазонов, указанных в правилах брандмауэра уровня сервера, подключение предоставляется к серверу базы данных SQL Azure.

- Если IP-адрес запроса не находится в одном из диапазонов, указанных в правиле брандмауэра уровня сервера, проверяются правила брандмауэра уровня базы данных. Если IP-адрес запроса находится в одном из диапазонов, указанных в правилах брандмауэра уровня базы данных, подключение предоставляется только к базе данных, в которой есть соответствующее правило уровня базы данных.

- Если IP-адрес запроса находится за пределами диапазонов, указанных в любом из правил брандмауэра уровня сервера или уровня базы данных, запрос на подключение отклоняется.

> [AZURE.NOTE] Для доступа к базе данных SQL Azure с локального компьютера убедитесь, что брандмауэр сети и локального компьютера разрешает исходящие подключения по TCP-порту 1433.


## Подключение из Azure

Когда приложение из Azure пытается подключиться к серверу базы данных, брандмауэр проверяет, разрешены ли подключения Azure. Параметр брандмауэра с начальным и конечным адресом, равным 0.0.0.0, указывает, что эти подключения разрешены. Если попытка подключения не разрешена, запрос не достигает сервера базы данных SQL Azure.

Подключения из Azure можно включить двумя способами.

- При создании сервера на [портале Microsoft Azure](https://portal.azure.com/) установите флажок **Разрешить службам Azure доступ к серверу**.

- На [классическом портале](http://go.microsoft.com/fwlink/p/?LinkID=161793) на вкладке **Настройка** сервера в разделе **Разрешенные службы** выберите **Да** для пункта **Службы Microsoft Azure**.

## Создание первого правила брандмауэра уровня сервера

Первый параметр брандмауэра серверного уровня можно создать на [портале Azure](https://portal.azure.com/) или программным путем с помощью REST API либо Azure PowerShell. Последующие правила брандмауэра уровня сервера можно создавать и контролировать с помощью этих методов, а также посредством Transact-SQL. Дополнительные сведения о правилах брандмауэра серверного уровня см. в статье [Практическое руководство. Настройка брандмауэра базы данных SQL Azure с помощью портала Azure](sql-database-configure-firewall-settings.md).

## Правила брандмауэра уровня базы данных

После настройки первого брандмауэра уровня сервера можно ограничить доступ к определенным базам данных. Если в правиле брандмауэра уровня базы данных указать диапазон IP-адресов, выходящий за пределы диапазона, указанного в правиле брандмауэра уровня сервера, доступ к базе данных смогут получить только те клиенты, которые имеют IP-адреса в диапазоне уровня базы данных. Для базы данных можно задать не более 128 правил брандмауэра уровня базы данных. С помощью Transact-SQL можно создать и контролировать правила брандмауэра уровня базы данных для главной и пользовательской баз данных. Дополнительные сведения о настройке правил брандмауэра на уровне базы данных см. в разделе [sp\_set\_database\_firewall\_rule (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270010.aspx).

## Программное управление правилами брандмауэра

Помимо портала Azure правилами брандмауэра можно управлять программно с помощью Transact-SQL, REST API и Azure PowerShell. В приведенных ниже таблицах описан набор команд, доступных для каждого метода.


### Transact-SQL

| Представление каталога или хранимая процедура | Уровень | Описание |
|--------------------------------------------------------------------------------------------|-----------|------------------------------------------------------|
| [sys.firewall\_rules](https://msdn.microsoft.com/library/dn269980.aspx) | сервер; | Отображает текущие правила брандмауэра уровня сервера |
| [sp\_set\_firewall\_rule](https://msdn.microsoft.com/library/dn270017.aspx) | сервер; | Создает или обновляет правила брандмауэра уровня сервера |
| [sp\_delete\_firewall\_rule](https://msdn.microsoft.com/library/dn270024.aspx) | сервер; | Удаляет правила брандмауэра уровня сервера |
| [sys.database\_firewall\_rules](https://msdn.microsoft.com/library/dn269982.aspx) | База данных | Отображает текущие правила брандмауэра уровня базы данных |
| [sp\_set\_database\_firewall\_rule](https://msdn.microsoft.com/library/dn270010.aspx) | База данных | Создает или обновляет правила брандмауэра уровня базы данных |
| [sp\_delete\_database\_firewall\_rule](https://msdn.microsoft.com/library/dn270030.aspx) | Базы данных | Удаляет правила брандмауэра на уровне базы данных |

### Интерфейс REST API

| API | Уровень | Описание |
|----------------------|--------|------------------------------------------------------------------|
| [Вывод списка правил брандмауэра](https://msdn.microsoft.com/library/azure/dn505715.aspx) | сервер; | Отображает текущие правила брандмауэра уровня сервера |
| [Создание правила брандмауэра](https://msdn.microsoft.com/library/azure/dn505712.aspx) | сервер; | Создает или обновляет правила брандмауэра уровня сервера |
| [Задание правила брандмауэра](https://msdn.microsoft.com/library/azure/dn505707.aspx) | сервер; | Обновляет свойства существующего правила брандмауэра уровня сервера |
| [Удаление правила брандмауэра](https://msdn.microsoft.com/library/azure/dn505706.aspx) | сервер; | Удаляет правила брандмауэра уровня сервера |


### Azure PowerShell

| Командлет | Уровень | Описание |
|-----------------------------------------------------------------------------------------------------|--------|------------------------------------------------------------------|
| [Get-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546731.aspx) | сервер; | Возвращает текущие правила брандмауэра уровня сервера |
| [New-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546724.aspx) | сервер; | Создает новое правило брандмауэра уровня сервера |
| [Set-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546739.aspx) | сервер; | Обновляет свойства существующего правила брандмауэра уровня сервера |
| [Remove-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546727.aspx) | сервер; | Удаляет правила брандмауэра уровня сервера |

> [AZURE.NOTE] Задержка вступления в силу новых настроек брандмауэра может составить до пяти минут.

## Устранение неполадок брандмауэра базы данных

Если доступ к службе базы данных SQL Microsoft Azure не работает должным образом, необходимо учитывать следующее.

- **Конфигурация локального брандмауэра:** прежде чем компьютер сможет получить доступ к Базе данных SQL Azure, может потребоваться создать исключение брандмауэра на компьютере для TCP-порта 1433. Вам может потребоваться открыть дополнительные порты при создании подключений в пределах облака Azure. Подробнее об этом см. в разделе **Версия 12 Базы данных SQL: внешняя и внутренняя программа** статьи [Порты, кроме 1433, для ADO.NET 4.5 и Базы данных SQL версии 12](sql-database-develop-direct-route-ports-adonet-v12.md).

- **Преобразование сетевых адресов (NAT):** из-за применения NAT IP-адрес, используемый компьютером для подключения к Базе данных SQL Azure, может отличаться от IP-адреса, показанного в параметрах конфигурации IP-адреса компьютера. Чтобы просмотреть IP-адрес, используемый компьютером для подключения к Azure, войдите на портал и откройте вкладку **Настройка** для сервера, где размещена база данных. В разделе **Разрешенные IP-адреса** отображается **текущий IP-адрес клиента**. Щелкните **Добавить** в разделе **Разрешенные IP-адреса**, чтобы разрешить компьютеру доступ к серверу.

- **Изменения в списке разрешенных адресов еще не вступили в силу:** может присутствовать задержка до пяти минут до вступления в силу изменений конфигурации брандмауэра Базы данных SQL Azure.

- **Имя для входа не имеет прав, или использован неправильный пароль:** если имя для входа не имеет разрешений на сервере Базы данных SQL Azure или введен неправильный пароль, подключение к серверу Базы данных SQL Azure будет отклонено. Создание параметра брандмауэра только предоставляет клиентам возможность подключения к серверу. Каждый клиент должен предоставить необходимые учетные данные безопасности. Дополнительные сведения о подготовке имен входа см. в разделе "Управление базами данных, именами входа и пользователями в базе данных SQL Azure".

- **Динамический IP-адрес:** при наличии подключения к Интернету с динамическим предоставлением IP-адресов и возникновении проблем с прохождением через брандмауэр попробуйте одно из описанных ниже решений.

 - Попросите поставщика услуг Интернета (ISP) назначить диапазон IP-адресов тем клиентским компьютерам, с которых будет осуществляться доступ к серверу базы данных SQL Azure, а затем добавьте диапазон IP-адресов в качестве правила брандмауэра.

 - Получите статические IP-адреса для клиентских компьютеров, а затем добавьте IP-адреса как правила брандмауэра.

## См. также

[Практическое руководство. Настройка брандмауэра базы данных SQL Azure с помощью портала Azure](sql-database-configure-firewall-settings.md)

[Центр обеспечения безопасности для ядра СУБД SQL Server и базы данных Azure SQL](https://msdn.microsoft.com/library/bb510589)

<!--Image references-->
[1]: ./media/sql-database-firewall-configure/sqldb-firewall-1.png

<!---HONumber=AcomDC_0615_2016-->