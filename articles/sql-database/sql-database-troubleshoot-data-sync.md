---
title: Устранение неполадок с синхронизацией данных SQL Azure | Документация Майкрософт
description: Узнайте, как устранять распространенные неполадки с синхронизацией данных SQL Azure.
services: sql-database
ms.date: 07/16/2018
ms.topic: conceptual
ms.service: sql-database
author: allenwux
ms.author: xiwu
manager: craigg
ms.custom: data-sync
ms.openlocfilehash: 2be6d0321db41772116078d5308824fe8e1b64fd
ms.sourcegitcommit: 7827d434ae8e904af9b573fb7c4f4799137f9d9b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/18/2018
ms.locfileid: "39113905"
---
# <a name="troubleshoot-issues-with-sql-data-sync"></a>Устранение неполадок с синхронизацией данных SQL

В этой статье описывается, как устранять известные неполадки с синхронизацией данных SQL Azure. Если существует решение проблемы, оно представлено ниже.

Общие сведения о синхронизации данных SQL см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL Azure](sql-database-sync-data.md).

## <a name="sync-issues"></a>Проблемы синхронизации

- [Ошибка синхронизации в ​​пользовательском интерфейсе портала данных SQL для локальных баз данных, связанных с агентом клиента](#sync-fails)

- [Моя группа синхронизации зависла в процессе обработки](#sync-stuck)

- [Неверные данные в таблицах](#sync-baddata)

- [Несогласованные данные первичного ключа после успешной синхронизации](#sync-pkdata)

- [Значительное снижение производительности](#sync-perf)

- [Получено сообщение: "Не удалось вставить значение NULL в столбец <column>. В столбце запрещены значения NULL". Что это означает, и как это можно исправить?](#sync-nulls)

- [Как синхронизация данных обрабатывает циклические ссылки? То есть, одни и те же данные синхронизируются в нескольких группах синхронизации и в результате постоянно изменяются?](#sync-circ)

### <a name="sync-fails"></a>Ошибка синхронизации в ​​пользовательском интерфейсе портала данных SQL для локальных баз данных, связанных с агентом клиента

Ошибка синхронизации в ​​пользовательском интерфейсе портала данных синхронизации данных SQL для локальных баз данных, связанных с агентом клиента. На локальном компьютере, на котором запущен агент, в журнале событий содержатся ошибки System.IO.IOException. Они указывают, что на диске недостаточно места.

- **Причина**. Недостаточно места на диске.

- **Способы устранения**. Освободите дополнительное место на диске, на котором находится каталог %TEMP%.

### <a name="sync-stuck"></a> Моя группа синхронизации зависла в процессе обработки

Группа синхронизации в службе синхронизации данных SQL находилась в состоянии обработки в течение длительного времени. Она не реагирует на команду **stop**, новые записи в журнале отсутствуют.

К фиксации группы синхронизации в состоянии обработки может привести любое из следующих условий:

- **Причина**. Агент клиента находится вне сети

- **Способы устранения**. Убедитесь, что агент клиента в сети, а затем повторите попытку.

- **Причина**. Агент клиента удален или отсутствует.

- **Способы устранения**. Агент клиента удален или отсутствует:

    1. Удалите XML-файл агента из установочной папки синхронизации данных SQL, если файл существует.
    2. Установите агент на локальном компьютере (это может быть тот же или другой компьютер). Затем отправьте ключ, созданный на портале для агента, который находится вне сети.

- **Причина**. Служба синхронизации данных SQL остановлена.

- **Способы устранения**. Перезапустите службу синхронизации данных SQL.

    1. В меню **Пуск** выполните поиск текста **Службы**.
    2. В результатах поиска щелкните **Службы**.
    3. Найдите службу **синхронизации данных SQL**.
    4. Если служба находится в состоянии **Остановлена**, щелкните правой кнопкой мыши имя службы и выберите **Запуск**.

> [!NOTE]
> Если приведенные выше сведения не вывели группу синхронизации из состояния обработки, служба поддержки Майкрософт может сбросить состояние группы синхронизации. Чтобы сбросить состояние группы синхронизации, создайте соответствующую запись на [форуме по Базе данных SQL Azure](https://social.msdn.microsoft.com/Forums/azure/home?forum=ssdsgetstarted). Укажите в ней идентификатор подписки и идентификатор группы синхронизации, которую нужно сбросить. Специалист службы поддержки Майкрософт ответит на вашу запись и сообщит вам, когда состояние будет сброшено.

### <a name="sync-baddata"></a>Неверные данные в таблицах

Если в синхронизации участвуют таблицы с одинаковыми именам, но из разных схем базы данных, то после синхронизации в них отображаются ошибочные данные.

- **Причина**. В процессе подготовки синхронизации данных SQL Sync используются одни и те же таблицы отслеживания для таблиц с одинаковыми именами, но в разных схемах. По этой причине изменения из обеих таблиц отражаются в одной таблице отслеживания. Это приводит к неправильному изменению данных во время синхронизации.

- **Способы устранения**. Убедитесь, что имена таблиц, участвующих в синхронизации, отличаются, даже если они относятся к разным схемам в базе данных.

### <a name="sync-pkdata"></a>Несогласованные данные первичного ключа после успешной синхронизации

После синхронизации, которая считается успешной, в журнале нет неудачных или пропущенных строк, но вы видите, что данные первичного ключа не согласованы между базами данных в группе синхронизации.

- **Причина**. Это сделано намеренно. Изменения в любом столбце первичного ключа приводят к несогласованным данным в строках, в которых был изменен первичный ключ.

- **Способы устранения**. Чтобы предотвратить эту проблему, убедитесь, что данные в столбце первичного ключа не изменены. Чтобы устранить эту проблему после ее возникновения, удалите строку, которая содержит несогласованные данные, из всех конечных точек в группе синхронизации. Затем снова вставьте эту строку.

### <a name="sync-perf"></a>Значительное снижение производительности

Производительность может снизиться до такой степени, что вы даже не сможете открыть пользовательский интерфейс синхронизации данных.

- **Причина**. Наиболее вероятной причиной является петля синхронизации. Петля синхронизации возникает, когда группа синхронизации А активирует синхронизацию с группой по синхронизации Б, которая затем запускает синхронизацию с группой синхронизации А. Фактическая ситуации может быть более сложной, так как петля может включать более двух групп синхронизации. Проблема заключается в зацикливании синхронизации из-за перекрытия групп синхронизации.

- **Способы устранения**. Наилучшим решением является предотвращение. Убедитесь, что в группах синхронизации нет циклических ссылок. Любая строка, синхронизируемая с одной группой синхронизации, не может синхронизироваться c другой группой синхронизации.

### <a name="sync-nulls"></a> Получено сообщение: "Не удалось вставить значение NULL в столбец <column>. В столбце запрещены значения NULL". Что это означает, и как это можно исправить? 
Это сообщение об ошибке указывает на одну из двух следующих проблем:
-  У таблицы нет первичного ключа. Чтобы устранить эту проблему, добавьте первичный ключ во все таблицы, которые синхронизируются.
-  В инструкции CREATE INDEX присутствует предложение WHERE. Служба синхронизации данных не может обработать такое условие. Чтобы устранить эту проблему, удалите предложение WHERE или вручную внесите изменения во все базы данных. 
 
### <a name="sync-circ"></a> Как синхронизация данных обрабатывает циклические ссылки? То есть, когда одни и те же данные синхронизируются в нескольких группах синхронизации и в результате постоянно изменяются?
Синхронизация данных не обрабатывает циклические ссылки. Не используйте их. 

## <a name="client-agent-issues"></a>Проблемы в работе агента клиента

- [Установка, удаление или восстановление агента клиента завершается ошибкой](#agent-install)

- [Агент клиента не работает после отмены удаления](#agent-uninstall)

- [В списке агента отсутствует моя база данных](#agent-list)

- [Агент клиента не запускается (ошибка 1069)](#agent-start)

- [Невозможно отправить ключ агента](#agent-key)

- [Агент клиента невозможно удалить с портала, если связанная с ним локальная база данных недоступна](#agent-delete)

- [Приложение локального агента синхронизации не может подключиться к локальной службе синхронизации](#agent-connect)

### <a name="agent-install"></a> Установка, удаление или восстановление агента клиента завершается ошибкой

- **Причина**. Этот сбой может произойти во множестве случаев. Чтобы определить конкретную причину этого сбоя, просмотрите журналы.

- **Способы устранения**. Чтобы найти конкретную причину сбоя, следует создать и просмотреть журналы установщика Windows. Включить ведение журнала можно с помощью командной строки. Например, если скачанный файл AgentServiceSetup.msi — LocalAgentHost.msi, создайте и изучите файлы журналов, используя следующие команды.

    -   Для установки: `msiexec.exe /i SQLDataSyncAgent-Preview-ENU.msi /l\*v LocalAgentSetup.InstallLog`
    -   Для удаления: `msiexec.exe /x SQLDataSyncAgent-se-ENU.msi /l\*v LocalAgentSetup.InstallLog`

    Вы также можете включить ведение журнала для всех установок, выполняемых установщиком Windows. Дополнительные сведения см. в статье базы знаний Майкрософт [Как включить ведение журнала работы установщика Windows](https://support.microsoft.com/help/223300/how-to-enable-windows-installer-logging). В ней также описано расположение этих журналов.

### <a name="agent-uninstall"></a> Агент клиента не работает после отмены удаления

Агент клиента не работает, даже если вы отменили его удаление.

- **Причина**. Эта проблема возникает из-за того, что агент клиента синхронизации данных SQL не хранит учетные данные.

- **Способы устранения**. Попробуйте применить следующие два способа:

    -   Используйте services.msc для повторного ввода учетных данных агента клиента.
    -   Удалите этот агент клиента и установите его заново. Скачайте и установите последний агент клиента из [центра загрузки](http://go.microsoft.com/fwlink/?linkid=221479).

### <a name="agent-list"></a> В списке агента отсутствует моя база данных

При попытке добавить существующую базу данных SQL Server в группу синхронизации база данных не отображается в списке агентов.

Этот сбой может произойти в следующих случаях:

- **Причина**. Агент клиента и группа синхронизации находятся в разных центрах обработки данных.

- **Способы устранения**. Агент клиента и группа синхронизации должны находиться в одном центре обработки данных. Чтобы обеспечить это, имеются две возможности:

    -   Создайте новый агент в центре обработки данных, в котором находится группа синхронизации. Затем зарегистрируйте базу данных в этом агенте.
    -   Удалите текущую группу синхронизации. Затем повторно создайте группу синхронизации в центре обработки данных, в котором находится агент.

- **Причина**. Список баз данных агента клиента устарел.

- **Способы устранения**. Остановите и перезапустите службу агента клиента.

    Локальный агент скачивает список связанных баз данных только при первой отправке ключа агента. Он не скачивает список связанных баз данных при последующих отправках ключа агента. Базы данных, зарегистрированные во время перемещения агента, не отображаются в исходном экземпляре агента.

### <a name="agent-start"></a> Агент клиента не запускается (ошибка 1069)

Вы обнаружили, что агент не работает на компьютере, на котором размещен сервер SQL Server. При попытке запустить агент вручную отображается диалоговое окно с сообщением об ошибке: "Ошибка 1069. Служба не запущена из-за ошибки входа в систему".

![Диалоговое окно ошибки с синхронизацией данных 1069](media/sql-database-troubleshoot-data-sync/sync-error-1069.png)

- **Причина**. Вероятной причиной этой ошибки является то, что пароль на локальном сервере изменился с момента создания агента и его пароля.

- **Способы устранения**. Обновите пароль агента до текущего пароля сервера.

  1. Найдите службу агента клиента синхронизации данных SQL.  
    a. Щелкните **Запуск**.  
    b. В поле поиска введите **services.msc**.  
    c. В результатах поиска щелкните **Службы**.  
    d. В окне **Службы** прокрутите список до записи **Агент синхронизации данных SQL**.  
  2. Щелкните правой кнопкой мыши **Агент синхронизации данных SQL**, а затем выберите **Остановить**.
  3. Щелкните правой кнопкой мыши **Агент синхронизации данных SQL**, а затем выберите **Свойства**.
  4. В окне **Свойства агента синхронизации данных SQL** щелкните вкладку **Вход**.
  5. Введите пароль в поле **Пароль**.
  6. Повторно введите пароль в поле **Подтверждение пароля**.
  7. Нажмите кнопку **Apply** (Применить), а затем нажмите кнопку **ОК**.
  8. В окне **Службы** щелкните правой кнопкой мыши службу **Агент синхронизации данных SQL**, а затем щелкните **Запуск**.
  9. Закройте окно **Службы**.

### <a name="agent-key"></a>Невозможно отправить ключ агента

После создания или повторного создания ключа агента вы пытаетесь передать этот ключ через приложение SqlAzureDataSyncAgent. Но выполнить отправку не удается.

![Диалоговое окно ошибки синхронизации: не удается отправить ключ агента](media/sql-database-troubleshoot-data-sync/sync-error-cant-submit-agent-key.png)

- **Предварительные требования**. Прежде чем продолжить, обратите внимание на следующие условия:

  - Служба синхронизации данных SQL Windows запущена.

  - Учетная запись службы синхронизации данных SQL Windows имеет доступ к сети.

  - Исходящий порт 1433 открыт в локальном правиле брандмауэра.

  - Локальный IP-адрес добавляется к серверу или в правило брандмауэра базы данных для синхронизации базы данных метаданных.

- **Причина**. Ключ агента уникально идентифицирует каждый локальный агент. Ключ должен соответствовать двум условиям:

  -   Ключи агента клиента на сервере синхронизации данных SQL и локальном компьютере должны быть идентичными.
  -   Ключ агента клиента можно использовать только один раз.

- **Способы устранения**. Если агент не работает, это связано с тем, что одно или оба условия не выполняются. Чтобы агент снова заработал:

  1. Создайте ключ.
  2. Примените новый ключ к агенту.

  Примените новый ключ к агенту.

  1. Используйте проводник для перехода в каталог установки агента. Каталог установки по умолчанию — C:\\Program Files (x86)\\Microsoft SQL Data Sync.
  2. Дважды щелкните подкаталог bin.
  3. Откройте приложение SqlAzureDataSyncAgent.
  4. Щелкните **Submit Agent Key** (Отправить ключ агента).
  5. Вставьте ключ из буфера обмена в соответствующем поле.
  6. Нажмите кнопку **ОК**.
  7. Закройте программу.

### <a name="agent-delete"></a> Агент клиента невозможно удалить с портала, если связанная с ним локальная база данных недоступна

Если локальная конечная точка (то есть база данных), которая зарегистрирована в агенте клиента синхронизации данных SQL, становится недоступной, агент клиента нельзя удалить.

- **Причина**. Локальный агент не может быть удален, так как недоступная база данных все еще зарегистрирована в агенте. При попытке удалить агент процесс удаления пытается подключиться к базе данных, что приводит к ошибке.

- **Способы устранения**. Используйте принудительное удаление, чтобы удалить недоступную базу данных.

> [!NOTE]
> Если таблицы метаданных синхронизации остаются после принудительного удаления, используйте `deprovisioningutil.exe`, чтобы очистить их.

### <a name="agent-connect"></a>Приложение локального агента синхронизации не может подключиться к локальной службе синхронизации

- **Способы устранения**. Попробуйте сделать следующее.

  1. Выйдите из приложения.  
  2. Откройте панель "Службы компонентов".  
    a. В поле поиска на панели задач введите **services.msc**.  
    b. В результатах поиска дважды щелкните **Службы**.  
  3. Остановите работу службы **синхронизации данных SQL**.
  4. Перезапустите службу **синхронизации данных SQL**.  
  5. Повторно откройте приложение.

## <a name="setup-and-maintenance-issues"></a>Проблемы установки и обслуживания

- [ Появляется уведомление "нет свободного места на диске" ](#setup-space)

- [Невозможно удалить группу синхронизации](#setup-delete)

- [Невозможно отменить регистрацию локальной базы данных SQL Server](#setup-unreg)

- [У меня нет необходимых привилегий для запуска системных служб](#setup-perms)

- [База данных находится в состоянии "Устарела"](#setup-date)

- [Группа синхронизации находится в состоянии "Устарела"](#setup-date2)

- [Группу синхронизации не удается устранить в течение трех минут после удаления или остановки агента](#setup-delete2)

- [Что происходит, когда восстанавливаются потерянная или поврежденная база данных?](#setup-restore)

### <a name="setup-space"></a> Появляется уведомление "нет свободного места на диске"

- **Причина**. Сообщение "disk out of space" (нет свободного места на диске) может отображаться, если нужно удалить лишние файлы. Это могут быть лишние файлы, обнаруженные антивирусным программным обеспечением, или файлы, которые были открыты при попытке выполнить операции удаления.

- **Способы устранения**. Вручную удалите файлы синхронизации, которые находятся в папке %temp% (`del \*sync\* /s`). Затем удалите подкаталоги в папке %temp%.

> [!IMPORTANT]
> Не удаляйте файлы во время синхронизации.

### <a name="setup-delete"></a>Невозможно удалить группу синхронизации

Вам не удается удалить группу синхронизации. Любая из следующих ситуаций может помешать удалению группы синхронизации:

- **Причина**. Агент клиента находится в автономном режиме.

- **Способы устранения**. Убедитесь, что агент клиента в сети, а затем повторите попытку.

- **Причина**. Агент клиента удален или отсутствует.

- **Способы устранения**. Агент клиента удален или отсутствует:  
    a. Удалите XML-файл агента из установочной папки синхронизации данных SQL, если файл существует.  
    b. Установите агент на локальном компьютере (это может быть тот же или другой компьютер). Затем отправьте ключ, созданный на портале для агента, который находится вне сети.

- **Причина**. База данных находится в автономном режиме.

- **Способы устранения**. Убедитесь, что базы данных SQL и базы данных SQL Server подключены к сети.

- **Причина**. Группа синхронизации подготавливается или синхронизируется.

- **Способы устранения**. Дождитесь завершения процесса подготовки или синхронизации и повторите попытку удалить группу синхронизации.

### <a name="setup-unreg"></a>Невозможно отменить регистрацию локальной базы данных SQL Server

- **Причина**. Скорее всего, вы пытаетесь отменить регистрацию базы данных, которая уже удалена.

- **Способы устранения**. Чтобы отменить регистрацию локальной базы данных SQL Server, выберите эту базу данных и щелкните **Принудительно удалить**.

  Если эта операция не удалила базу данных из группы синхронизации, выполните следующие действия.

  1. Остановите, а затем перезапустите службу узла агента клиента.  
    a. Щелкните меню **Пуск**.  
    b. В поле поиска введите **services.msc**.  
    c. В разделе **Программы** области результатов поиска дважды щелкните **Службы**.  
    d. Щелкните правой кнопкой мыши службу **синхронизации данных SQL**.  
    д. Если служба запущена, остановите ее.  
    f. Щелкните правой кнопкой мыши службу и выберите **Запуск**.  
    ж. Проверьте, зарегистрирована ли еще база данных. Если она больше не зарегистрирована, процедура завершена. В противном случае перейдите к следующему шагу.
  2. Откройте приложение агента клиента (SqlAzureDataSyncAgent).
  3. Выберите **Изменить учетные данные**, а затем введите учетные данные для базы данных.
  4. Выполните отмену регистрации.

### <a name="setup-perms"></a>У меня нет необходимых привилегий для запуска системных служб

- **Причина**. Эта ошибка возникает в двух ситуациях:
  -   Имя пользователя или пароль неверны.
  -   Указанная учетная запись пользователя не имеет достаточных привилегий для входа в систему в качестве службы.

- **Способы устранения**. Предоставьте учетной записи пользователя учетные данные для входа в качестве службы.

  1. Выберите **Пуск** > **Панель управления** > **Администрирование** > **Локальная политика безопасности**  >  **Локальная политика** > **User Rights Management** (Управление правами пользователей).
  2. Выберите **Вход в качестве службы**.
  3. В диалоговом окне **Свойства** добавьте учетную запись пользователя.
  4. Нажмите кнопку **Apply** (Применить), а затем нажмите кнопку **ОК**.
  5. Закройте все окна.

### <a name="setup-date"></a> База данных находится в состоянии "Устарела"

- **Причина**. Служба синхронизации данных SQL удаляет базы данных, которые были отключены более 45 дней (с момента отключения базы данных от сети). Если база данных находится вне сети более 45 дней, а затем возвращается в сеть, ее состояние имеет значение **Out-of-Date** (Устарела).

- **Способы устранения**. Чтобы избежать состояния **Out-of-Date** (Устарела), нужно сделать так, чтобы ни одна из ваших баз данных не находилась вне сети более 45 дней.

  Если база данных находится в состоянии **Out-of-Date** (Устарела), сделайте следующее.

  1. Удалите базу данных в состоянии **Out-of-Date** (Устарела) из группы синхронизации.
  2. Добавьте базу данных обратно в группу синхронизации.

  > [!WARNING]
  > Все изменения, внесенные в эту базу данных в автономном режиме, будут потеряны.

### <a name="setup-date2"></a> Группа синхронизации находится в состоянии "Устарела"

- **Причина**. Если одно или несколько изменений не применяются в течение всего периода хранения (45 дней), группа синхронизации может стать устаревшей.

- **Способы устранения**. Чтобы избежать состояния **Out-of-Date** (Устарела) группы синхронизации, регулярно проверяйте результаты заданий синхронизации в средстве просмотра журнала. Изучайте и устраняйте проблемы изменений, которые не применяются.

  Если группа синхронизации находится в состоянии **Out-of-Date** (Устарела), необходимо удалить ее и создать заново.

### <a name="setup-delete2"></a>Группу синхронизации не удается устранить в течение трех минут после удаления или остановки агента

Вы не можете удалить группу синхронизации в течение трех минут после удаления или остановки связанного агента синхронизации данных SQL.

- **Способы устранения**.

  1. Удалите группу синхронизации, в то время как связанные агенты синхронизации подключены к сети (рекомендуется).
  2. Если агент находится вне сети, но установлен, подключите его к сети на локальном компьютере. Дождитесь, пока состояние агента не изменится на **В сети** на портале синхронизации данных SQL. Удалите группу синхронизации.
  3. Если агент находится вне сети, потому что он был удален, выполните следующие действия.  
    a.  Удалите XML-файл агента из установочной папки синхронизации данных SQL, если файл существует.  
    b.  Установите агент на локальном компьютере (это может быть тот же или другой компьютер). Затем отправьте ключ, созданный на портале для агента, который находится вне сети.  
    c. Попробуйте удалить группу синхронизации.

### <a name="setup-restore"></a>Что происходит, когда восстанавливаются потерянная или поврежденная база данных?

Если вы восстанавливаете потерянную или поврежденную базу данных из резервной копии, могут быть несогласованности в данных групп синхронизации к которой принадлежит база данных.

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения о синхронизации данных SQL см. в следующих материалах:

-   [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL](sql-database-sync-data.md)  
-   [Начало работы с синхронизацией данных SQL Azure (предварительная версия)](sql-database-get-started-sql-data-sync.md)  
-   [Best practices for SQL Data Sync (Preview)](sql-database-best-practices-data-sync.md) (Рекомендации по синхронизации данных SQL (предварительная версия))  
-   [Мониторинг синхронизации данных SQL Azure с помощью Log Analytics](sql-database-sync-monitor-oms.md)  
-   Полные примеры PowerShell, которые демонстрируют, как настроить синхронизацию данных SQL:  
    -   [Использование PowerShell для синхронизации данных между несколькими базами данных SQL Azure](scripts/sql-database-sync-data-between-sql-databases.md)  
    -   [Использование PowerShell для синхронизации данных между базой данных SQL Azure и локальной базой данных SQL Server](scripts/sql-database-sync-data-between-azure-onprem.md)  
-   [Документация по REST API синхронизации данных SQL](https://github.com/Microsoft/sql-server-samples/raw/master/samples/features/sql-data-sync/Data_Sync_Preview_REST_API.pdf?raw=true)

Дополнительные сведения о Базе данных SQL см. в разделах:

-   [Обзор Базы данных SQL](sql-database-technical-overview.md)
-   [Управление жизненным циклом базы данных](https://msdn.microsoft.com/library/jj907294.aspx)
