---
title: Ведение журналов метрик и диагностики Базы данных SQL Azure | Документация Майкрософт
description: Сведения о настройке Базы данных SQL Azure для хранения данных статистики об использовании ресурсов, подключении и выполнении запросов.
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: danimir
ms.author: v-daljep
ms.reviewer: carlrab
manager: craigg
ms.date: 09/20/2018
ms.openlocfilehash: 8f66c95202e0ccdef86f9630f7a98c20023a8955
ms.sourcegitcommit: 5de9de61a6ba33236caabb7d61bee69d57799142
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/25/2018
ms.locfileid: "50087752"
---
# <a name="azure-sql-database-metrics-and-diagnostics-logging"></a>Ведение журналов метрик и диагностики Базы данных SQL Azure 

База данных SQL Azure, эластичные пулы, Управляемый экземпляр и базы данных Управляемого экземпляра могут выдавать журналы метрик и диагностики для упрощения мониторинга производительности. Вы можете настроить базу данных для потоковой передачи сведений об использовании ресурсов, о рабочих ролях и сеансах, а также настроить подключение к одному из этих ресурсов Azure:

* **Аналитика SQL Azure**. Используется как интегрированное интеллектуальное решение для мониторинга производительности базы данных Azure с возможностями предоставления отчетов, предупреждений и устранения проблем.
* **Центры событий Azure**. Используются для интеграции телеметрии Базы данных SQL с настраиваемым решением для мониторинга или горячими конвейерами.
* **Служба хранилища Azure**. Используется для архивации больших объемов данных телеметрии по оптимальной стоимости.

    ![Архитектура](./media/sql-database-metrics-diag-logging/architecture.png)

Чтобы узнать, какие метрики и категории журналов поддерживаются различными службами Azure, рекомендуется ознакомиться со следующими статьями:

* [Обзор метрик в Microsoft Azure](../monitoring-and-diagnostics/monitoring-overview-metrics.md)
* [Сбор и использование данных журнала из ресурсов Azure](../monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs.md) 

## <a name="enable-logging-of-diagnostics-telemetry"></a>Включение ведения журнала диагностических данных телеметрии

В первой части этого документа рассказывается, как включить диагностическую телеметрию баз данных, а во второй — как включить диагностическую телеметрию эластичных пулов или Управляемых экземпляров. Последние разделы документа посвящены настройке службы Аналитика SQL Azure в качестве средства мониторинга для просмотра потоковых диагностических данных телеметрии баз данных.

> [!NOTE]
> Если используются эластичные пулы или Управляемые экземпляры, кроме включения диагностической телеметрии баз данных, также рекомендуется включить диагностическую телеметрию для этих ресурсов. Это обусловлено тем, что у эластичных пулов и Управляемых экземпляров в роли контейнеров баз данных есть свои собственные данные диагностической телеметрии, отличающиеся от данных диагностической телеметрии отдельной базы данных. 
>

Можно включить ведение таких журналов метрик и диагностической телеметрии и управлять ими, используя один из следующих методов:

- Портал Azure
- PowerShell
- Azure CLI
- REST API Azure Monitor 
- Шаблон Azure Resource Manager

При включении ведения журналов метрик и диагностики нужно указать ресурс Azure, где будут собраны выбранные данные. Доступны следующие варианты:

- Azure SQL Analytics
- Центры событий Azure
- Хранилище Azure

Вы можете подготовить новый ресурс Azure или выбрать имеющийся. После выбора ресурса нужно указать, какие данные нужно собирать, используя параметр диагностики.

## <a name="enable-logging-for-azure-sql-database-or-databases-in-managed-instance"></a>Включение ведения журнала для Базы данных SQL Azure или баз данных в Управляемом экземпляре

Ведение журналов метрик и диагностики в Базе данных SQL и базах данных Управляемого экземпляра отключено по умолчанию.

Для баз данных SQL и баз данных Управляемого экземпляра можно собрать следующие диагностические данные телеметрии:

| Мониторинг телеметрии для баз данных | Поддержка Базы данных SQL Azure | Поддержка базы данных в Управляемом экземпляре |
| :------------------- | ------------------- | ------------------- |
| [Все метрики](sql-database-metrics-diag-logging.md#all-metrics) содержат сведения о проценте использования DTU и ЦП, ограничении DTU и ЦП, проценте чтения физических данных, проценте записей в журнал, проценте успешных, неудачных или заблокированных подключений брандмауэра, проценте сеансов, проценте рабочих ролей, хранилище, проценте хранилища и проценте хранилища XTP. | Yes | Нет  |
| [QueryStoreRuntimeStatistics](sql-database-metrics-diag-logging.md#query-store-runtime-statistics) содержит сведения о статистике выполнения запросов, такие как данные об использовании ЦП и длительности запросов. | Yes | Yes |
| [QueryStoreWaitStatistics](sql-database-metrics-diag-logging.md#query-store-wait-statistics) содержит сведения о статистике времени ожидания запросов, с помощью которых можно узнать, что ожидали запросы, например ЦП, журнал и блокировку. | Yes | Yes |
| [Errors](sql-database-metrics-diag-logging.md#errors-dataset) содержит сведения об ошибках SQL, которые произошли в этой базе данных. | Yes | Нет  |
| [DatabaseWaitStatistics](sql-database-metrics-diag-logging.md#database-wait-statistics-dataset) содержит статистику по значениям времени ожидания различных типов для базы данных. | Yes | Нет  |
| [Timeouts](sql-database-metrics-diag-logging.md#time-outs-dataset) содержит сведения о времени ожидания в базе данных. | Yes | Нет  |
| [Blocks](sql-database-metrics-diag-logging.md#blockings-dataset) содержит сведения о блокирующих событиях, произошедших в базе данных. | Yes | Нет  |
| [SQLInsights](sql-database-metrics-diag-logging.md#intelligent-insights-dataset) содержит сведения о производительности Intelligent Insights. Дополнительные сведения об Intelligent Insights см. в [этой статье](sql-database-intelligent-insights.md). | Yes | Yes |

### <a name="azure-portal"></a>Портал Azure

Потоковая передача диагностических данных телеметрии для базы данных SQL Azure и баз данных Управляемого экземпляра в назначения службы хранилища Azure, концентраторы событий или Log Analytics настраивается с помощью меню "Параметры диагностики" для каждой базы данных на портале Azure.

### <a name="configure-streaming-of-diagnostics-telemetry-for-azure-sql-database"></a>Настройка потоковой передачи диагностических данных телеметрии для базы данных SQL Azure

   ![Значок Базы данных SQL](./media/sql-database-metrics-diag-logging/icon-sql-database-text.png)

Чтобы включить потоковую передачу диагностических данных телеметрии для **базы данных SQL Azure**, сделайте следующее:

1. Перейдите к ресурсу базы данных SQL Azure.
2. Выберите **Параметры диагностики**.
3. Выберите **Включить диагностику**, если предыдущие параметры отсутствуют, или **Настройка параметра**, чтобы изменить предыдущий параметр.
- Можно создать до трех (3) параллельных подключений к диагностическим данным телеметрии потока. Чтобы настроить несколько параллельных потоковых передач диагностических данных в несколько ресурсов, выберите **+ Добавить параметр диагностики** для создания дополнительного параметра.

   ![Включение диагностики Базы данных SQL](./media/sql-database-metrics-diag-logging/diagnostics-settings-database-sql-enable.png)

4. Введите имя параметра — для собственных нужд.
5. Выберите ресурсы для потоковой передачи данных диагностики из базы данных: **Архивировать в учетной записи хранения**, **Передать в концентратор событий** или **Отправить в Log Analytics**
6. Для стандартных возможностей мониторинга установите флажки для телеметрии журнала диагностики базы данных: **SQLInsights**, **AutomaticTuning**, **QueryStoreRuntimeStatistics**, **QueryStoreWaitStatistics**, **Errors**, **DatabaseWaitStatistics**, **Timeouts**, **Blocks**, **Deadlocks**. Эти данные телеметрии основаны на событиях и обеспечивают стандартные возможности мониторинга.
7. Для расширенных возможностей мониторинга установите флажок для **AllMetrics**. Это 1-минутная телеметрия для диагностических данных базы данных, как описано выше. 
8. В меню «Параметры» щелкните пункт **Сохранить**

   ![Настройка диагностики Базы данных SQL](./media/sql-database-metrics-diag-logging/diagnostics-settings-database-sql-selection.png)

> [!NOTE]
> Журнал аудита невозможно включить из параметров диагностики базы данных. Сведения о том, как включить потоковую передачу данных журнала аудита см. в руководстве по [настройке аудита базы данных](sql-database-auditing.md#subheading-2), а также статье о [журналах аудита SQL в Azure Log Analytics и Центрах событий Azure](https://blogs.msdn.microsoft.com/sqlsecurity/2018/09/13/sql-audit-logs-in-azure-log-analytics-and-azure-event-hubs/).
>

> [!TIP]
> Повторите описанные выше действия для каждой базы данных SQL Azure, которую вы хотите отслеживать. 
>

### <a name="configure-streaming-of-diagnostics-telemetry-for-databases-in-managed-instance"></a>Настройка потоковой передачи диагностических данных телеметрии для баз данных Управляемого экземпляра

   ![Значок базы данных в Управляемом экземпляре](./media/sql-database-metrics-diag-logging/icon-mi-database-text.png)

Чтобы включить потоковую передачу диагностических данных телеметрии для **баз данных Управляемого экземпляра**, сделайте следующее:

1. Перейдите к базе данных в Управляемом экземпляре.
2. Выберите **Параметры диагностики**.
3. Выберите **Включить диагностику**, если предыдущие параметры отсутствуют, или **Настройка параметра**, чтобы изменить предыдущий параметр.
- Можно создать до трех (3) параллельных подключений к диагностическим данным телеметрии потока. Чтобы настроить несколько параллельных потоковых передач диагностических данных в несколько ресурсов, выберите **+ Добавить параметр диагностики** для создания дополнительного параметра.

   ![Включение диагностики базы данных Управляемого экземпляра](./media/sql-database-metrics-diag-logging/diagnostics-settings-database-mi-enable.png)

4. Введите имя параметра — для собственных нужд.
5. Выберите ресурсы для потоковой передачи данных диагностики из базы данных: **Архивировать в учетной записи хранения**, **Передать в концентратор событий** или **Отправить в Log Analytics**
6. Установите флажки для телеметрии диагностики базы данных: **SQLInsights**, **QueryStoreRuntimeStatistics**, **QueryStoreWaitStatistics** и **Errors**
7. В меню «Параметры» щелкните пункт **Сохранить**

   ![Настройка диагностики базы данных Управляемого экземпляра](./media/sql-database-metrics-diag-logging/diagnostics-settings-database-mi-selection.png)

> [!TIP]
> Повторите описанные выше действия для каждой базы данных Управляемого экземпляра, которую вы хотите отслеживать.
>

## <a name="enable-logging-for-elastic-pools-or-managed-instance"></a>Включение ведения журналов для эластичных пулов или Управляемого экземпляра

У эластичных пулов и Управляемых экземпляров в роли контейнеров баз данных есть своя собственная диагностическая телеметрия, отличающаяся от диагностической телеметрии баз данных. Эта диагностическая телеметрия по умолчанию отключена. 

### <a name="configure-streaming-of-diagnostics-telemetry-for-elastic-pools"></a>Настройка потоковой передачи диагностических данных телеметрии для эластичных пулов

   ![Значок эластичного пула](./media/sql-database-metrics-diag-logging/icon-elastic-pool-text.png)

Для ресурса эластичных пулов можно собрать следующие диагностические данные телеметрии:

| Ресурс | Мониторинг телеметрии |
| :------------------- | ------------------- |
| **Эластичный пул** | [Все метрики](sql-database-metrics-diag-logging.md#all-metrics) содержат сведения о проценте использования eDTU и ЦП, ограничении eDTU и ЦП, проценте чтения физических данных, проценте записей в журнал, проценте сеансов, проценте рабочих ролей, хранилище, проценте хранилища, ограничении хранилища и проценте хранилища XTP. |

Чтобы включить потоковую передачу диагностических данных телеметрии для **ресурса эластичного пула**, сделайте следующее:

1. Перейдите к ресурсу эластичного пула на портале Azure.
2. Выберите **Параметры диагностики**.
3. Выберите **Включить диагностику**, если предыдущие параметры отсутствуют, или **Настройка параметра**, чтобы изменить предыдущий параметр.

   ![Включение диагностики для эластичных пулов](./media/sql-database-metrics-diag-logging/diagnostics-settings-container-elasticpool-enable.png)

4. Введите имя параметра — для собственных нужд.
5. Выберите ресурсы для потоковой передачи данных диагностики из эластичного пула: **Архивировать в учетной записи хранения**, **Передать в концентратор событий** или **Отправить в Log Analytics**
6. В случае если выбран Log Analytics, выберите **Настройка** и создайте рабочую область, выбрав **+ Создать рабочую область**, либо выберите существующую рабочую область.
7. Установите флажок для диагностических данных телеметрии эластичного пула **AllMetrics**.
8. Нажмите кнопку **Сохранить**

   ![Настройка диагностики для эластичных пулов](./media/sql-database-metrics-diag-logging/diagnostics-settings-container-elasticpool-selection.png)

> [!TIP]
> Повторите описанные выше действия для каждого эластичного пула, который вы хотите отслеживать.
>

### <a name="configure-streaming-of-diagnostics-telemetry-for-managed-instance"></a>Настройка потоковой передачи диагностических данных телеметрии для Управляемого экземпляра

   ![Значок Управляемого экземпляра](./media/sql-database-metrics-diag-logging/icon-managed-instance-text.png)

Для ресурса Управляемого экземпляра можно собрать следующие диагностические данные телеметрии:

| Ресурс | Мониторинг телеметрии |
| :------------------- | ------------------- |
| **Управляемый экземпляр** | [ResourceUsageStats](sql-database-metrics-diag-logging.md#resource-usage-stats) содержит количество виртуальных ядер, средний процент использования ЦП, а также сведения о запросах ввода-вывода, прочитанных и записанных байтах, зарезервированном и используемом дисковом пространстве. |

Чтобы включить потоковую передачу диагностических данных телеметрии для **ресурса Управляемого экземпляра**, сделайте следующее:

1. Перейдите к ресурсу Управляемого экземпляра на портале Azure.
2. Выберите **Параметры диагностики**.
3. Выберите **Включить диагностику**, если предыдущие параметры отсутствуют, или **Настройка параметра**, чтобы изменить предыдущий параметр.

   ![Включение диагностики Управляемого экземпляра](./media/sql-database-metrics-diag-logging/diagnostics-settings-database-mi-enable.png)

4. Введите имя параметра — для собственных нужд.
5. Выберите ресурсы для потоковой передачи данных диагностики из эластичного пула: **Архивировать в учетной записи хранения**, **Передать в концентратор событий** или **Отправить в Log Analytics**
6. Если выбран Log Analytics, создайте или используйте существующую рабочую область.
7. Установите флажок для диагностических данных телеметрии экземпляра **ResourceUsageStats**.
8. Нажмите кнопку **Сохранить**

   ![Настройка диагностики Управляемого экземпляра](./media/sql-database-metrics-diag-logging/diagnostics-settings-database-mi-selection.png)

> [!TIP]
> Повторите описанные выше действия для каждого Управляемого экземпляра, который вы хотите отслеживать.
>

### <a name="powershell"></a>PowerShell

Чтобы включить ведение журналов метрик и диагностики с помощью PowerShell, используйте следующие команды:

- Выполните приведенную ниже команду, чтобы включить отправку журналов диагностики в учетную запись хранения:

   ```powershell
   Set-AzureRmDiagnosticSetting -ResourceId [your resource id] -StorageAccountId [your storage account id] -Enabled $true
   ```

   StorageAccountId — это идентификатор ресурса учетной записи хранения, в которую будут отправляться журналы.

- Чтобы включить потоковую передачу журналов диагностики в концентратор событий, используйте следующую команду:

   ```powershell
   Set-AzureRmDiagnosticSetting -ResourceId [your resource id] -ServiceBusRuleId [your service bus rule id] -Enabled $true
   ```

   Идентификатор правила служебной шины Azure — это строка в формате:

   ```powershell
   {service bus resource ID}/authorizationrules/{key name}
   ``` 

- Чтобы включить отправку журналов диагностики в рабочую область Log Analytics, используйте следующую команду:

   ```powershell
   Set-AzureRmDiagnosticSetting -ResourceId [your resource id] -WorkspaceId [resource id of the log analytics workspace] -Enabled $true
   ```

- Идентификатор ресурса рабочей области Log Analytics можно получить с помощью следующей команды:

   ```powershell
   (Get-AzureRmOperationalInsightsWorkspace).ResourceId
   ```

Можно объединять эти параметры, чтобы получить несколько вариантов вывода.

### <a name="to-configure-multiple-azure-resources"></a>Настройка нескольких ресурсов Azure

Чтобы обеспечить поддержку нескольких подписок, используйте сценарий PowerShell. Дополнительные сведения см. в статье [Enable Azure resource metrics logging using PowerShell](https://blogs.technet.microsoft.com/msoms/2017/01/17/enable-azure-resource-metrics-logging-using-powershell/) (Включение ведения журнала метрик ресурсов Azure с помощью PowerShell).

Укажите идентификатор ресурса рабочей области &lt;$WSID&gt; в качестве параметра при выполнении скрипта (Enable-AzureRMDiagnostics.ps1) для отправки данных диагностики из нескольких ресурсов в рабочую область. Чтобы получить идентификатор рабочей области &lt;$WSID&gt;, в которую необходимо отправить данные диагностики, в следующем сценарии замените &lt;subID&gt; идентификатором подписки, &lt;RG_NAME&gt; — именем группы ресурсов, а &lt;WS_NAME&gt; — именем рабочей области.

- Для настройки нескольких ресурсов Azure используйте следующие команды:

    ```powershell
    PS C:\> $WSID = "/subscriptions/<subID>/resourcegroups/<RG_NAME>/providers/microsoft.operationalinsights/workspaces/<WS_NAME>"
    PS C:\> .\Enable-AzureRMDiagnostics.ps1 -WSID $WSID
    ```

### <a name="azure-cli"></a>Azure CLI

Чтобы включить ведение журналов метрик и диагностики с помощью Azure CLI, используйте следующие команды:

- Выполните приведенную ниже команду, чтобы включить отправку журналов диагностики в учетную запись хранения:

   ```azurecli-interactive
   azure insights diagnostic set --resourceId <resourceId> --storageId <storageAccountId> --enabled true
   ```

   StorageAccountId — это идентификатор ресурса учетной записи хранения, в которую будут отправляться журналы.

- Чтобы включить потоковую передачу журналов диагностики в концентратор событий, используйте следующую команду:

   ```azurecli-interactive
   azure insights diagnostic set --resourceId <resourceId> --serviceBusRuleId <serviceBusRuleId> --enabled true
   ```

   Идентификатор правила служебной шины — это строка в формате:

   ```azurecli-interactive
   {service bus resource ID}/authorizationrules/{key name}
   ```

- Чтобы включить отправку журналов диагностики в рабочую область Log Analytics, используйте следующую команду:

   ```azurecli-interactive
   azure insights diagnostic set --resourceId <resourceId> --workspaceId <resource id of the log analytics workspace> --enabled true
   ```

Можно объединять эти параметры, чтобы получить несколько вариантов вывода.

### <a name="rest-api"></a>REST API

Сведения об изменении параметров диагностики с помощью REST API Azure Monitor см. в [этом документе](https://docs.microsoft.com/rest/api/monitor/diagnosticsettings). 

### <a name="resource-manager-template"></a>Шаблон Resource Manager

Сведения о включении параметров диагностики при создании ресурса из шаблона Resource Manager см. [здесь](../monitoring-and-diagnostics/monitoring-enable-diagnostic-logs-using-template.md). 

## <a name="stream-into-azure-sql-analytics"></a>Потоковая передача данных в службу Аналитика SQL Azure 

Служба "Аналитика SQL Azure" — это облачное решение для наблюдения за производительностью баз данных SQL Azure, эластичных пулов и управляемых экземпляров в нужном масштабе и в нескольких подписках на одной панели. Эта служба собирает и отображает важные метрики производительности Базы данных SQL Azure благодаря встроенным средствам аналитики, которые помогают устранять соответствующие неполадки.

![Обзор службы "Аналитика SQL Azure"](../log-analytics/media/log-analytics-azure-sql/azure-sql-sol-overview.png)

Журналы метрик и диагностики Базы данных SQL можно передать в службу Аналитика SQL Azure с помощью встроенной функции **отправки в Log Analytics** в колонке диагностических параметров на портале. Log Analytics также можно включить с помощью параметра диагностики через командлеты PowerShell, Azure CLI или Azure Monitor REST API.

### <a name="installation-overview"></a>Обзор установки

Мониторинг транспортной карты Базы данных SQL Azure выполнять просто благодаря службе "Аналитика SQL Azure". Необходимо выполнить три шага:

1. Создайте решение "Аналитика SQL Azure" из Azure Marketplace.
2. Создайте рабочую область мониторинга в решении.
3. Настройте базы данных для потоковой передачи диагностических данных телеметрии в созданную рабочую область.

Если используется эластичный пул или Управляемые экземпляры, в дополнение к настройке диагностической телеметрии баз данных, настройте потоковую передачу диагностических данных телеметрии из этих ресурсов.

### <a name="create-azure-sql-analytics-resource"></a>Создание ресурса Аналитика SQL Azure

1. Выполните поиск по запросу "Аналитика SQL Azure" в Azure Marketplace и выберите найденное решение.

   ![Поиск службы Аналитика SQL Azure на портале](./media/sql-database-metrics-diag-logging/sql-analytics-in-marketplace.png)
   
2. Выберите **Создать** на экране обзора решения.

3. В форме "Аналитика SQL Azure" введите необходимые дополнительные сведения: имя рабочей области, подписку, группу ресурсов, расположение и ценовую категорию.
 
   ![Настройка службы "Аналитика SQL Azure" на портале](./media/sql-database-metrics-diag-logging/sql-analytics-configuration-blade.png)

4. Нажмите **ОК**, чтобы подтвердить, и **Создать**, чтобы завершить операцию.

### <a name="configure-databases-to-record-metrics-and-diagnostics-logs"></a>Настройка баз данных для записи журналов метрик и диагностики

Расположение, в которое базы данных будут записывать метрики, проще всего настроить на портале Azure, как описано выше. На портале перейдите к ресурсу Базы данных SQL и выберите **Параметры диагностики**.

При использовании эластичных пулов или Управляемых экземпляров также необходимо настроить параметры диагностики для этих ресурсов и потоковую передачу их диагностических данных телеметрии в созданную рабочую область.

### <a name="use-the-sql-analytics-solution"></a>Использование решения "Аналитика SQL"

Решение "Аналитика SQL" — это иерархическая панель мониторинга, которая позволяет перемещаться по иерархии ресурсов Базы данных SQL. Дополнительные сведения об использовании решения "Аналитика SQL" см. в статье [Мониторинг Базы данных SQL Azure с помощью служб анализа SQL Azure (предварительная версия) в Log Analytics](../log-analytics/log-analytics-azure-sql.md).

## <a name="stream-into-event-hubs"></a>Потоковая передача в Центры событий

Журналы метрик и диагностики Базы данных SQL можно передать в Центры событий с помощью встроенной возможности **Stream to an event hub** (Передать в концентратор событий) на портале. Можно также включить идентификатор правила служебной шины с помощью параметра диагностики через командлеты PowerShell, Azure CLI или Azure Monitor REST API. 

### <a name="what-to-do-with-metrics-and-diagnostics-logs-in-event-hubs"></a>Что делать с журналами метрик и диагностики в Центрах событий
Выполнив потоковую передачу выбранных данных в Центры событий, вы становитесь на один шаг ближе к включению дополнительных сценариев мониторинга. Центры событий выступают в качестве "двери" для конвейера событий. После сбора данных в концентраторе событий их можно преобразовывать и сохранять с помощью любого поставщика аналитики в реальном времени, а также с помощью адаптеров пакетной обработки или хранения. Центры событий отделяют производство потока событий от потребления этих событий. Таким образом потребители событий могут получать доступ к событиям по собственному расписанию. Дополнительные сведения о Центрах событий см. в следующих статьях:

- [Что такое Центры событий?](../event-hubs/event-hubs-what-is-event-hubs.md)
- [Начало работы с Центрами событий](../event-hubs/event-hubs-csharp-ephcs-getstarted.md)

Мы приведем лишь несколько примеров использования потоковой передачи:

* **Проверка работоспособности службы путем потоковой передачи данных критического пути в Power BI**. С помощью Центров событий, Stream Analytics и Power BI можно в близком к реальному времени получать аналитическую информацию о службах Azure на основе метрик и диагностических данных. Обзор настройки концентраторов событий, обработки данных в Stream Analytics и вывода информации через Power BI см. в статье [Stream Analytics и Power BI. Панель мониторинга для анализа потоковой передачи данных](../stream-analytics/stream-analytics-power-bi-dashboard.md).

* **Потоковая передача журналов в сторонние потоки ведения журналов и сбора телеметрии.** С помощью потоковой передачи Центров событий вы можете передать журналы метрик и диагностики в другие сторонние решения мониторинга и Log Analytics. 

* **Создание пользовательской платформы для телеметрии и ведения журнала**. Если у вас уже есть пользовательская платформа для телеметрии и ведения журнала или вы только планируете ее создать, высокая масштабируемость публикации и подписки Центров событий позволит вам гибко настраивать прием журналов диагностики. Ознакомьтесь с [руководством Дэна Росановы (Dan Rosanova) по использованию Центров событий для глобальной платформы телеметрии](https://azure.microsoft.com/documentation/videos/build-2015-designing-and-sizing-a-global-scale-telemetry-platform-on-azure-event-Hubs/).

## <a name="stream-into-storage"></a>Потоковая передача в хранилище

Журналы метрик и диагностики Базы данных SQL могут храниться в службе хранилище с помощью встроенной возможности **Archive to a storage account** (Архивировать в учетной записи хранения) на портале. Хранилище также можно включить с помощью параметра диагностики через командлеты PowerShell, Azure CLI или Azure Monitor REST API.

### <a name="schema-of-metrics-and-diagnostics-logs-in-the-storage-account"></a>Схема журналов метрик и диагностики в учетной записи хранения

После настройки сбора журналов метрик и диагностики в выбранной учетной записи хранения создается контейнер хранилища, как только первые строки данных станут доступными. Вот как выглядит структура большого двоичного объекта:

```powershell
insights-{metrics|logs}-{category name}/resourceId=/SUBSCRIPTIONS/{subscription ID}/ RESOURCEGROUPS/{resource group name}/PROVIDERS/Microsoft.SQL/servers/{resource_server}/ databases/{database_name}/y={four-digit numeric year}/m={two-digit numeric month}/d={two-digit numeric day}/h={two-digit 24-hour clock hour}/m=00/PT1H.json
```
    
Или даже еще проще:

```powershell
insights-{metrics|logs}-{category name}/resourceId=/{resource Id}/y={four-digit numeric year}/m={two-digit numeric month}/d={two-digit numeric day}/h={two-digit 24-hour clock hour}/m=00/PT1H.json
```

Например, большой двоичный объект для всех метрик может иметь такое имя:

```powershell
insights-metrics-minute/resourceId=/SUBSCRIPTIONS/s1id1234-5679-0123-4567-890123456789/RESOURCEGROUPS/TESTRESOURCEGROUP/PROVIDERS/MICROSOFT.SQL/ servers/Server1/databases/database1/y=2016/m=08/d=22/h=18/m=00/PT1H.json
```

Если требуется записывать данные из эластичного пула, имя большого двоичного объекта немного отличается:

```powershell
insights-{metrics|logs}-{category name}/resourceId=/SUBSCRIPTIONS/{subscription ID}/ RESOURCEGROUPS/{resource group name}/PROVIDERS/Microsoft.SQL/servers/{resource_server}/ elasticPools/{elastic_pool_name}/y={four-digit numeric year}/m={two-digit numeric month}/d={two-digit numeric day}/h={two-digit 24-hour clock hour}/m=00/PT1H.json
```

### <a name="download-metrics-and-logs-from-storage"></a>Скачивание метрик и журналов из хранилища

Ознакомьтесь с разделом [Скачивание больших двоичных объектов](../storage/blobs/storage-quickstart-blobs-dotnet.md#download-the-sample-application).

## <a name="data-retention-policy-and-pricing"></a>Политика хранения данных и цены

Если выбрать Центры событий или учетную запись хранения, можно указать политику хранения. Эта политика удаляет данные, которые хранятся дольше выбранного периода времени. При указании Log Analytics политика хранения определяется на основании выбранной ценовой категории. Учитывается использование телеметрии диагностики сверх бесплатных единиц приема данных, выделяемых каждый месяц. Бесплатные единицы приема данных позволяют осуществлять бесплатный мониторинг нескольких баз данных каждый месяц. Обратите внимание, что более активные базы данных с более интенсивными рабочими нагрузками будут принимать больше данных, чем простаивающие базы данных. Дополнительные сведения см. на странице [цен на Log Analytics](https://azure.microsoft.com/pricing/details/monitor/). 

Если вы используете Аналитику SQL Azure, то легко можете отслеживать использование приема данных в решении, выбрав рабочую область OMS в меню навигации Аналитики SQL Azure, а затем выбрав "Usage and Estimated Costs" (Использование и оценка затрат).

## <a name="metrics-and-logs-available"></a>Доступные метрики и журналы

Собранные данные телеметрии можно использовать для **пользовательского анализа** и **разработки приложений** с помощью [языка SQL Analytics](https://docs.microsoft.com/azure/log-analytics/query-language/get-started-queries). Ниже показана структура собранных данных, метрик и журналов.

## <a name="all-metrics"></a>Все метрики

### <a name="all-metrics-for-elastic-pools"></a>Все метрики для эластичных пулов

|**Ресурс**|**Метрики**|
|---|---|
|Эластичный пул|Сведения о проценте использования DTU, используемых единицах DTU, ограничении DTU, проценте использования ЦП, проценте чтения физических данных, проценте записей в журнал, проценте сеансов, проценте рабочих ролей, хранилище, проценте хранилища, ограничении хранилища, проценте хранилища XTP. |

### <a name="all-metrics-for-azure-sql-database"></a>Все метрики для Базы данных SQL Azure

|**Ресурс**|**Метрики**|
|---|---|
|Базы данных SQL Azure|Сведения о проценте использования DTU, используемых единицах DTU, ограничении DTU, проценте использования ЦП, проценте чтения физических данных, проценте записей в журнал, проценте успешных, неудачных или заблокированных подключений брандмауэра, проценте сеансов, проценте рабочих ролей, хранилище, проценте хранилища, проценте хранилища XTP и взаимоблокировках. |

## <a name="logs"></a>Журналы

### <a name="logs-for-managed-instance"></a>Журналы для Управляемого экземпляра

### <a name="resource-usage-stats"></a>Статистика использования ресурсов

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: ResourceUsageStats|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: MANAGEDINSTANCES|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя Управляемого экземпляра.|
|ResourceId|Универсальный код ресурса (URI).|
|SKU_s|Номер SKU продукта Управляемого экземпляра|
|virtual_core_count_s|Доступное количество виртуальных ядер|
|avg_cpu_percent_s|Average CPU percentage (Средний процент использования ЦП)|
|reserved_storage_mb_s|Зарезервированная емкость хранилища в Управляемом экземпляре|
|storage_space_used_mb_s|Использованный объем хранилища в Управляемом экземпляре|
|io_requests_s|Количество операций ввода-вывода|
|io_bytes_read_s|Количество считанных байтов операций ввода-вывода|
|io_bytes_written_s|Количество записанных байтов операций ввода-вывода|

### <a name="logs-for-azure-sql-database-and-managed-instance-database"></a>Журналы для Базы данных SQL Azure и базы данных Управляемого экземпляра

### <a name="query-store-runtime-statistics"></a>Статистика среды выполнения хранилища запросов

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: QueryStoreRuntimeStatistics.|
|OperationName|Имя операции. Всегда: QueryStoreRuntimeStatisticsEvent.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных.|
|ResourceId|Универсальный код ресурса (URI).|
|query_hash_s|Хэш запроса.|
|query_plan_hash_s|Хэш плана запроса.|
|statement_sql_handle_s|Дескриптор SQL инструкции.|
|interval_start_time_d|Начальное значение datetimeoffset интервала в тактах с 01.01.1900.|
|interval_end_time_d|Конечное значение datetimeoffset интервала в тактах с 01.01.1900.|
|logical_io_writes_d|Общее число логических операций записи ввода-вывода.|
|max_logical_io_writes_d|Максимальное число логических операций записи ввода-вывода при выполнении каждого запроса.|
|physical_io_reads_d|Общее число физических операций чтения ввода-вывода.|
|max_physical_io_reads_d|Максимальное число логических операций чтения ввода-вывода при выполнении каждого запроса.|
|logical_io_reads_d|Общее число логических операций чтения ввода-вывода.|
|max_logical_io_reads_d|Максимальное число логических операций чтения ввода-вывода при выполнении каждого запроса.|
|execution_type_d|Тип выполнения.|
|count_executions_d|Число выполнений запроса.|
|cpu_time_d|Общее процессорное время, затраченное на выполнение запроса, в микросекундах.|
|max_cpu_time_d|Максимальное потребление процессорного времени на выполнение одного запроса в микросекундах.|
|dop_d|Сумма степеней параллелизма.|
|max_dop_d|Максимальная степень параллелизма, используемая для выполнения одного запроса.|
|rowcount_d|Общее число возвращаемых строк.|
|max_rowcount_d|Максимальное число строк, возвращаемых при выполнении одного запроса.|
|query_max_used_memory_d|Общий объем используемой памяти в килобайтах.|
|max_query_max_used_memory_d|Максимальный объем памяти, используемой при выполнении одного запроса, в килобайтах.|
|duration_d|Общее время выполнения запроса в миллисекундах.|
|max_duration_d|Максимальное время выполнения одного запроса.|
|num_physical_io_reads_d|Общее число физических операций чтения.|
|max_num_physical_io_reads_d|Максимальное число физических операций чтения при выполнении каждого запроса.|
|log_bytes_used_d|Общий объем записанного журнала в байтах.|
|max_log_bytes_used_d|Максимальное число байтов журнала, используемых при выполнения каждого запроса.|
|query_id_d|Идентификатор запроса в хранилище запросов.|
|plan_id_d|Идентификатор плана в хранилище запросов.|

[Дополнительные сведения о статистических данных среды выполнения хранилища запросов.](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-query-store-runtime-stats-transact-sql)

### <a name="query-store-wait-statistics"></a>Статистика времени ожидания хранилища запросов

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: QueryStoreWaitStatistics.|
|OperationName|Имя операции. Всегда: QueryStoreWaitStatisticsEvent.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных.|
|ResourceId|Универсальный код ресурса (URI).|
|wait_category_s|Категория времени ожидания.|
|is_parameterizable_s|Указывает, подлежит ли запрос параметризации.|
|statement_type_s|Тип инструкции.|
|statement_key_hash_s|Хэш ключа инструкции.|
|exec_type_d|Тип выполнения.|
|total_query_wait_time_ms_d|Общее время ожидания запроса в определенной категории времени ожидания.|
|max_query_wait_time_ms_d|Максимальное время ожидания запроса при отдельном выполнении в определенной категории времени ожидания.|
|query_param_type_d|0|
|query_hash_s|Хэш запроса в хранилище запросов.|
|query_plan_hash_s|Хэш плана запроса в хранилище запросов.|
|statement_sql_handle_s|Дескриптор инструкции в хранилище запросов.|
|interval_start_time_d|Начальное значение datetimeoffset интервала в тактах с 01.01.1900.|
|interval_end_time_d|Конечное значение datetimeoffset интервала в тактах с 01.01.1900.|
|count_executions_d|Количество выполнений запроса.|
|query_id_d|Идентификатор запроса в хранилище запросов.|
|plan_id_d|Идентификатор плана в хранилище запросов.|

Дополнительные сведения о [статистических данных времени ожидания хранилища запросов](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-query-store-wait-stats-transact-sql).

### <a name="errors-dataset"></a>Набор данных ошибок

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: Errors.|
|OperationName|Имя операции. Всегда: ErrorEvent.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных.|
|ResourceId|Универсальный код ресурса (URI).|
|Сообщение|Сообщение об ошибке в виде обычного текста.|
|user_defined_b|Указывает, установлен ли бит ошибки пользователем.|
|error_number_d|Код ошибки.|
|Уровень серьезности|Серьезность ошибки.|
|state_d|Состояние ошибки.|
|query_hash_s|Хэш запроса, завершенного сбоем, если он доступен.|
|query_plan_hash_s|Хэш плана запроса для запроса, завершенного сбоем, если он доступен.|

Дополнительные сведения о [сообщениях об ошибках SQL Server](https://msdn.microsoft.com/library/cc645603.aspx).

### <a name="database-wait-statistics-dataset"></a>Набор данных статистики времени ожидания базы данных

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: DatabaseWaitStatistics.|
|OperationName|Имя операции. Всегда: DatabaseWaitStatisticsEvent.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных.|
|ResourceId|Универсальный код ресурса (URI).|
|wait_type_s|Имя типа времени ожидания.|
|start_utc_date_t [UTC]|Время начала измеренного периода.|
|end_utc_date_t [UTC]|Время окончания измеренного периода.|
|delta_max_wait_time_ms_d|Максимальное время ожидания при выполнении одного запроса.|
|delta_signal_wait_time_ms_d|Общее время ожидания сигнала.|
|delta_wait_time_ms_d|Общее время ожидания в течение периода.|
|delta_waiting_tasks_count_d|Число ожидающих задач.|

Дополнительные сведения о [статистике времени ожидания базы данных](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql).

### <a name="time-outs-dataset"></a>Набор данных времени ожидания

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: Timeouts.|
|OperationName|Имя операции. Всегда: TimeoutEvent.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных.|
|ResourceId|Универсальный код ресурса (URI).|
|error_state_d|Код состояния ошибки.|
|query_hash_s|Хэш запроса, если он доступен.|
|query_plan_hash_s|Хэш плана запроса, если он доступен.|

### <a name="blockings-dataset"></a>Набор данных блокировки

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: Blocks.|
|OperationName|Имя операции. Всегда: BlockEvent.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных.|
|ResourceId|Универсальный код ресурса (URI).|
|lock_mode_s|Режим блокировки, используемый для запроса.|
|resource_owner_type_s|Владелец блокировки.|
|blocked_process_filtered_s|Отчет о заблокированных процессах в формате XML.|
|duration_d|Длительность блокировки в микросекундах.|

### <a name="deadlocks-dataset"></a>Набор данных взаимоблокировки

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC] |Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: Deadlocks.|
|OperationName|Имя операции. Всегда: DeadlockEvent.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных. |
|ResourceId|Универсальный код ресурса (URI).|
|deadlock_xml_s|Отчет о взаимоблокировке в формате XML.|

### <a name="automatic-tuning-dataset"></a>Набор данных автоматической настройки

|Свойство|ОПИСАНИЕ|
|---|---|
|TenantId|Идентификатор клиента.|
|SourceSystem|Всегда: Azure.|
|TimeGenerated [UTC]|Метка времени, когда был записан журнал.|
|type|Всегда: AzureDiagnostics.|
|ResourceProvider|Имя поставщика ресурсов. Всегда: MICROSOFT.SQL.|
|Категория|Имя категории. Всегда: AutomaticTuning.|
|Ресурс|Имя ресурса.|
|ResourceType|Имя типа ресурса. Всегда: SERVERS/DATABASES.|
|SubscriptionId|GUID подписки, к которой относится база данных.|
|ResourceGroup|Имя группы ресурсов, к которой принадлежит база данных.|
|LogicalServerName_s|Имя сервера, к которому принадлежит база данных.|
|LogicalDatabaseName_s|Имя базы данных.|
|ElasticPoolName_s|Имя эластичного пула, к которому принадлежит база данных (если она входит в пул).|
|DatabaseName_s|Имя базы данных.|
|ResourceId|Универсальный код ресурса (URI).|
|RecommendationHash_s|Уникальный хэш рекомендаций по автоматической настройке.|
|OptionName_s|Операция автоматической настройки.|
|Schema_s|Схема базы данных.|
|Table_s|Затронутая таблица.|
|IndexName_s|Имя индекса.|
|IndexColumns_s|Имя столбца.|
|IncludedColumns_s|Включенные столбцы.|
|EstimatedImpact_s|Предполагаемое влияние JSON-файла рекомендаций по автоматической настройке.|
|Event_s|Тип события автоматической настройки.|
|Timestamp_t|Метка времени последнего обновления.|

### <a name="intelligent-insights-dataset"></a>Набор данных Intelligent Insights
Дополнительные сведения о [формате журнала Intelligent Insights](sql-database-intelligent-insights-use-diagnostics-log.md).

## <a name="next-steps"></a>Дальнейшие действия

Чтобы научиться включать ведение журнала и узнать, какие метрики и категории журналов поддерживаются различными службами Azure, ознакомьтесь со следующими статьями:

 * [Обзор метрик в Microsoft Azure](../monitoring-and-diagnostics/monitoring-overview-metrics.md)
 * [Сбор и использование данных журнала из ресурсов Azure](../monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs.md)

Дополнительные сведения о Центрах событий см. в статье:

* [Что такое Центры событий Azure?](../event-hubs/event-hubs-what-is-event-hubs.md)
* [Начало работы с Центрами событий](../event-hubs/event-hubs-csharp-ephcs-getstarted.md)

Дополнительные сведения о хранилище см. в разделе [Скачивание больших двоичных объектов](../storage/blobs/storage-quickstart-blobs-dotnet.md#download-the-sample-application).
