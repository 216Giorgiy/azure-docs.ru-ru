---
title: "Выполнение специальных запросов аналитики к нескольким базам данных SQL Azure | Документация Майкрософт"
description: "Сведения о выполнении запросов ad-hoc-аналитики к нескольким базам данных SQL в мультитенантном приложении SaaS Wingtip."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/24/2017
ms.author: billgib; sstein
ms.translationtype: Human Translation
ms.sourcegitcommit: 5edc47e03ca9319ba2e3285600703d759963e1f3
ms.openlocfilehash: bf003a3677ed27bc833de59ef61f7637a6899d37
ms.contentlocale: ru-ru
ms.lasthandoff: 05/31/2017


---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a>Выполнение запросов ad-hoc-аналитики по всем клиентам SaaS Wingtip

С помощью этого руководства вы сможете создать базу данных ad-hoc-аналитики и выполнить несколько запросов по всем клиентам. С помощью этих запросов можно извлекать сводки, скрытые в текущих операционных данных приложения Wingtip SaaS.

Чтобы выполнить запросы ad-hoc-аналитики (по всем клиентам), приложение SaaS Wingtip использует [эластичный запрос](sql-database-elastic-query-overview.md) и базу данных аналитики.


Из этого руководства вы узнаете следующее:

> [!div class="checklist"]

> * сведения о глобальных представлениях в каждой из баз данных, разрешающих запросы по всем клиентам;
> * как развертывать базу данных ad-hoc-аналитики;
> * как выполнять распределенные запросы по всем клиентским базам данных.



Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS Wingtip. Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных SQL Azure](sql-database-saas-tutorial.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).


## <a name="ad-hoc-analytics-pattern"></a>Модель ad-hoc-аналитики

Одной из основных возможностей приложений SaaS является использование огромного числа клиентских данных, хранящихся в облаке. Используйте эти данные для более детального ознакомления с работой и использованием приложений, клиентов, их пользователей, а также с преимуществами клиентов и их режимом работы. Эти сведения будут полезны при разработке функций, помогут повысить удобство использования, а также обеспечить вложение дополнительных средств в приложения и службы.

Доступ к этим данным получить очень просто, если они содержатся в отдельной мультитенантной базе данных, но не так просто, если они распределены по тысячам масштабируемых баз данных. Одним из подходов является использование эластичного запроса, который позволяет выполнять ad-hoc-запросы в распределенном наборе баз данных с общей схемой. Эластичный запрос использует отдельную *головную* базу данных, в которой внешние таблицы определены как зеркальные таблицы или представления в распределенных (клиентских) базах данных. Запросы, отправленные к этой головной базе данных, компилируются для создания распределенного плана запроса с частями запроса, которые при необходимости можно принудительно установить в клиентских базах данных. Эластичный запрос использует карту сегментов в базе данных каталога для предоставления расположения клиентских баз данных. При настройке и выполнении запроса используется стандартный язык [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), поддерживающий ad-hoc-запросы из инструментов Power BI и Excel.

## <a name="get-the-wingtip-application-scripts"></a>Получение сценариев приложения Wingtip

Скрипты и исходный код приложения SaaS Wingtip доступны в репозитории GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS). Указания по скачиванию скриптов SaaS Wingtip см. [здесь](sql-database-wtp-overview.md#download-the-wingtip-saas-scripts).


## <a name="explore-the-global-views"></a>Обзор глобальных представлений

Приложение SaaS Wingtip создано по модели, предусматривающей использование одного клиента для базы данных, поэтому схема базы данных клиента определяется с учетом одного клиента. Сведения для конкретного клиента находятся в одной таблице, *Venue*, в которой всегда есть одна строка. Кроме того, эта таблица создается как куча без первичного ключа.  Не нужно связывать таблицу *Venue* с другими таблицами в схеме, так как при нормальном использовании вы точно знаете, какому клиенту принадлежат данные.  Тем не менее при запросе всех баз данных важно сопоставить данные из таблиц в базе данных с конкретным клиентом. Чтобы упростить такую задачу, в базу данных клиента добавляется набор представлений, который обеспечивает глобальное представление каждого клиента. Эти глобальные представления проецируют идентификатор клиента в каждую таблицу, к которой будет осуществляться глобальный запрос. Так вы с легкостью определите данные каждого клиента. Для удобства эти представления были предварительно созданы во всех базах данных клиентов (а также в эталонной базе данных, поэтому эти глобальные представления доступны после подготовки новых клиентов).

1. Откройте среду SSMS и подключитесь к серверу [tenants1-&lt;пользователь&gt;](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).
1. Разверните узел **Базы данных**, щелкните **contosoconcerthall** правой кнопкой мыши и выберите **Создать запрос**.
1. Выполните следующие запросы, чтобы увидеть разницу между таблицами одного клиента и глобальными представлениями:

   ```T-SQL
   -- This is the base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice the plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- The base Events table which has no VenueId column.
   SELECT * FROM Events

   -- This view projects the VenueId retrieved from the Venues table.
   SELECT * FROM VenueEvents
   ```

В примере базы данных был вычислен идентификатор (целое число) из хэша имени места проведения (Venue), но уникальное значение можно ввести любым другим способом. Этот процесс похож на создание ключа клиента в каталоге, когда нет требования, чтобы ключ каталога и идентификатор клиента в базе данных *adhocanalytics* совпадали.

Чтобы проверить *представление* и узнать, как оно создается, сделайте следующее.

1. В **обозревателе объектов** разверните узел **contosoconcethall** > **Представления**:

   ![узел "Представления"](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

1. Щелкните **dbo.Venues** правой кнопкой мыши.
1. Выберите **Создать скрипт для представления** > **Используя CREATE** > **В новом окне редактора запросов**.

Так можно просмотреть создание каждого *представления*.

## <a name="deploy-the-database-used-for-ad-hoc-analytics-queries"></a>Развертывание базы данных, используемой для запросов ad-hoc-аналитики

В этом упражнении развертывается база данных *adhocanalytics*. Она содержит схему, используемую для выполнения запросов по всем базам данных клиента. База данных развертывается на имеющемся сервере каталога, содержащем все базы данных для управления.

1. Откройте файл …\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Deploy-AdhocAnalyticsDB.ps1*
1. Прокрутите вниз до раздела назначения `$commandText` скрипту SQL. Изучите скрипт и обратите внимание на следующее:

   1. Эластичный запрос использует учетные данные уровня базы данных для доступа к каждой базе данных клиента. Эти учетные данные должны быть доступны во всех базах данных. Обычно им предоставляются минимальные права, необходимые для включения этих ad-hoc-запросов.
   1. Внешний источник данных, для которого определено использование карты сегментов клиента в базе данных каталога.  При использовании этого внешнего источника данных запросы будут распределяться по всем базам данных, зарегистрированным в каталоге, при отправке.
   1. Внешние таблицы, которые ссылаются на глобальные представления, описанные в предыдущем разделе.
   1. Локальная таблица *VenueTypes*, которая создается и заполняется.  Так как эта ссылочная таблица данных обычно используется во всех базах данных клиента, здесь ее можно представить в качестве локальной. При этом объем данных, перемещаемых между базами данных клиента и базой данных *adhocanalytics*, для некоторых запросов может сократиться.


1. Теперь откройте в *интегрированной среде сценариев PowerShell* файл …\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1*, а затем задайте следующие значения:
   * **$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.

1. Нажмите клавишу **F5**, чтобы выполнить скрипт и создать базу данных *adhocanalytics*.

   Вы можете проигнорировать предупреждение *Сервер RPC недоступен*.

Теперь у вас есть база данных *adhocanalytics*, которую можно использовать для выполнения распределенных запросов, а также сбора сведений по всем клиентам.

![База данных adhocanalytics](media/sql-database-saas-tutorial-adhoc-analytics/adhocanalytics.png)

## <a name="run-ad-hoc-analytics-queries"></a>Выполнение запросов ad-hoc-аналитики

Теперь, когда база данных *adhocanalytics* настроена, выполните несколько запросов ad-hoc:

1. Откройте в SSMS \\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql*.
1. Подключитесь к базе данных **adhocanalytics**.
1. Выберите отдельный запрос, который вы хотите выполнить, а затем нажмите клавишу **F5**:

    ![query](media/sql-database-saas-tutorial-adhoc-analytics/query.png)




## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]

> * Развертывание базы данных ad-hoc-аналитики
> * как выполнить распределенные запросы по всем клиентским базам данных.

Ознакомьтесь со статьей [Выполнение распределенных запросов в нескольких базах данных SQL Azure](sql-database-saas-tutorial-tenant-analytics.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по SaaS WTP базы данных SQL](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)
* [Обзор эластичных запросов к базе данных SQL Azure (предварительная версия)](sql-database-elastic-query-overview.md)

