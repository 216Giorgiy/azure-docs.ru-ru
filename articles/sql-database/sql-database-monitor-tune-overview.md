---
title: Мониторинг и настройка производительности базы данных SQL Azure | Документация Майкрософт
description: Советы по настройке базы данных SQL Azure — оценка и улучшение производительности.
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: danimir
ms.author: v-daljep
ms.reviewer: carlrab
manager: craigg
ms.date: 10/16/2018
ms.openlocfilehash: 5ef15b7a757b87c14bf0bd764bdd6ca6e6da64e0
ms.sourcegitcommit: 3a7c1688d1f64ff7f1e68ec4bb799ba8a29a04a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/17/2018
ms.locfileid: "49379055"
---
# <a name="monitoring-and-performance-tuning"></a>Мониторинг и настройка производительности

База данных SQL Azure — это автоматически управляемая гибкая служба данных, позволяющая легко отслеживать использование, добавлять и удалять ресурсы (ЦП, памяти, ввода-вывода), находить рекомендации, которые могут повысить производительность базы данных, а также позволить базе данных адаптироваться к рабочей нагрузке и автоматически оптимизировать производительность.

## <a name="the-state-of-an-active-query"></a>Состояние активного запроса

Чтобы повысить производительность базы данных SQL Azure, необходимо понимать, что каждый активный запрос из приложения находится в состоянии выполнения или ожидания. При устранении проблем с производительностью в базе данных SQL Azure примите во внимание следующую диаграмму:

![Состояния рабочей нагрузки](./media/sql-database-monitor-tune-overview/workload-states.png)

Для рабочей нагрузки проблема с производительностью может быть вызвана состязанием ЦП (условие, **связанное с выполнением**) или тем, что отдельные запросы находятся в состоянии ожидания (условие, **связанное с ожиданием**).

- **Чрезмерная загрузка ЦП в Базе данных SQL Azure**

  Чрезмерная загрузка ЦП может приводить к проблемам с производительностью при следующих условиях:

  - слишком много выполняемых запросов;
  - слишком много компилируемых запросов;
  - один или несколько выполняемых запросов использует неоптимальный план запроса.

  Если это так, ваша задача состоит в том, чтобы выявить и настроить связанные запросы либо обновить размер вычислений или уровень служб, чтобы увеличить производительность Базы данных SQL Azure для снижения требований к ЦП. Дополнительные сведения о масштабировании ресурсов для отдельной базы данных см. в статье [Масштабирование ресурсов отдельной базы данных в Базе данных SQL Azure](sql-database-single-database-scale.md). Дополнительную информацию о масштабировании ресурсов для эластичных пулов см. в статье [Масштабирование ресурсов эластичного пула в базе данных SQL Azure](sql-database-elastic-pool-scale.md).

- **Отдельный запрос в состоянии ожидания**

  В отдельных запросах могут возникнуть проблемы с производительностью из-за того, что они находятся в состоянии ожидания. В данном случае вам нужно сократить период ожидания или сделать так, чтобы его и вовсе не было.

### <a name="determine-if-you-have-a-running-related-performance-issue"></a>Определение наличия проблемы с производительностью, связанной с выполнением

Проблемы с производительностью, связанные с выполнением, можно определить с помощью нескольких методов. Ниже перечислены наиболее распространенные из них.

- Используйте [портал Azure](#monitor-databases-using-the-azure-portal), чтобы отследить процент загрузки ЦП.
- Используйте следующие [динамические административные представления](sql-database-monitoring-with-dmvs.md):

  - [sys.dm_db_resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП, операциях ввода-вывода и потреблении памяти для базы данных в службе "База данных SQL Azure". Новая строка создается каждые 15 секунд, даже если в базе данных не выполняется никаких действий. Исторические данные хранятся в течение одного часа.
  - [sys.resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП и хранилища для Базы данных SQL Azure. Данные собираются и объединяются за пятиминутные интервалы.

> [!TIP]
> Как правило, проблемы с производительностью возникают, если загрузка ЦП постоянно превышает 80 %.

### <a name="determine-if-you-have-a-waiting-related-performance-issue"></a>Определение наличия проблемы с производительностью, связанной с ожиданием

Сначала убедитесь, что проблема с производительностью не связана с высокой загрузкой ЦП. Если это не так, необходимо определить максимальное время ожидания, связанное с рабочей нагрузкой приложения.  Ниже перечислены распространенные методы для отображения категорий типов максимального времени ожидания.

- [Хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) предоставляет статистику времени ожидания на запрос за определенный промежуток времени. В хранилище запросов типы времени ожидания объединены в категории ожидания. Сопоставление категорий времени ожидания с типами доступно в [sys.query_store_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-query-store-wait-stats-transact-sql?view=sql-server-2017#wait-categories-mapping-table).
- [sys.dm_db_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-wait-stats-azure-sql-database) возвращает сведения обо всех периодах ожидания потоков, выполнявшихся в ходе операции. Это агрегированное представление может использоваться для диагностики проблем с производительностью Базы данных SQL Azure, а также проблем с определенными запросами и пакетами.
- [sys.dm_os_waiting_tasks](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-os-waiting-tasks-transact-sql) возвращает сведения об очереди ожидания задач, которым необходимы некоторые ресурсы.

Как показано на предыдущей диаграмме, следующие типы ожидания являются самыми распространенными:

- блокировки;
- ВВОД-ВЫВОД
- состязание, связанное с tempdb;
- ожидание временно предоставляемого буфера памяти.

В зависимости от того, с чем связано ожидание, для каждой категории предоставляется отдельный путь устранения неполадок.

## <a name="overview-of-monitoring-database-performance-in-azure-sql-database"></a>Общие сведения о производительности базы данных в Базе данных SQL Azure

Мониторинг производительности базы данных SQL в Azure начинается с мониторинга использования ресурсов в соответствии с выбранным уровнем производительности базы данных. С помощью мониторинга можно определить, является ли емкость базы данных избыточной или же проблема возникает из-за того, что ресурсы используются на пределе возможностей. Затем при необходимости можно изменить объем вычислительных ресурсов и уровень служб своей базы данных в [модели приобретения на основе DTU](sql-database-service-tiers-dtu.md) или [модели приобретения на основе виртуальных ядер](sql-database-service-tiers-vcore.md). Вы можете выполнять мониторинг базы данных с помощью графических средств на [портале Azure](https://portal.azure.com) или с помощью [динамических административных представлений (DMV)](sql-database-monitoring-with-dmvs.md) SQL.

База данных SQL Azure позволяет выявить возможности для повышения и оптимизации производительности запросов без изменения ресурсов. Для этого достаточно изучить [рекомендации по настройке производительности](sql-database-advisor.md). Отсутствующие индексы и плохо оптимизированные запросы — распространенные причины низкой производительности баз данных. Можно применить эти рекомендации по настройке, чтобы повысить производительность рабочей нагрузки.
Можно также позволить Базе данных Azure SQL [автоматически оптимизировать производительность запросов](sql-database-automatic-tuning.md). В этом случае она будет применять все созданные рекомендации и проверять, действительно ли они повышают производительность базы данных. Доступны следующие возможности мониторинга и устранения неполадок производительности базы данных.

- На [портале Azure](https://portal.azure.com) щелкните **Базы данных SQL**, выберите базу данных и найдите ресурсы, приближающиеся к максимальной отметке, на диаграмме мониторинга. По умолчанию отображается процент использования DTU. Щелкните **Изменить** , чтобы изменить диапазон времени и отображаемые значения.
- На странице [Анализ производительности запросов](sql-database-query-performance.md) можно определить, какие запросы потребляют большую часть ресурсов.
- Используйте [Помощник по базам данных SQL](sql-database-advisor-portal.md), чтобы просматривать рекомендации по созданию и удалению индексов, параметризации запросов и устранению ошибок схемы.
- Используйте [Azure SQL Intelligent Insights](sql-database-intelligent-insights.md) для автоматического мониторинга производительности базы данных. После обнаружения проблемы с производительностью создается журнал диагностики, в который записываются сведения о проблеме и результат анализа ее первопричин (RCA). При возможности также приводятся рекомендации по повышению производительности.
- [Включите автоматическую настройку](sql-database-automatic-tuning-enable.md) и позвольте Базе данных SQL Azure автоматически исправлять выявленные проблемы производительности.
- Можно также использовать [динамические административные представления](sql-database-monitoring-with-dmvs.md), [расширенные события (`XEvents`)(sql-database/sql-database-xevent-db-diff-from-svr.md) и [хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store), чтобы получать параметры производительности в режиме реального времени. В [этом руководстве по производительности](sql-database-performance-guidance.md) описаны методы, которые можно использовать, чтобы повысить производительность Базы данных SQL Azure, если вы обнаружили какие-либо проблемы с помощью этих отчетов или представлений.

## <a name="monitor-databases-using-the-azure-portal"></a>Мониторинг баз данных с помощью портала Azure

На [портале Azure](https://portal.azure.com/) можно отслеживать использование отдельной базы данных. Для этого необходимо выбрать базу данных и щелкнуть диаграмму **Мониторинг**. Появится окно **Метрика**, которое можно изменить, нажав кнопку **Изменить диаграмму**. Добавьте следующие метрики:

- Процент использования ЦП
- Процент использования DTU
- Процент операций ввода/вывода данных
- Размер базы данных в процентах

После добавления этих метрик можно продолжить наблюдение за ними на диаграмме **Мониторинг** с более подробными сведениями в окне **Метрика**. Все четыре метрики показывают средний процент использования в соответствии с количеством единиц **DTU** для вашей базы данных. Узнайте больше об уровнях служб, ознакомившись с [моделью приобретения на основе DTU](sql-database-service-tiers-dtu.md) и [моделью приобретения на основе виртуальных ядер](sql-database-service-tiers-vcore.md).  

![Мониторинг производительности базы данных для разных уровней служб.](./media/sql-database-single-database-monitoring/sqldb_service_tier_monitoring.png)

Также можно настроить оповещения для метрик производительности. В окне **Метрика** нажмите кнопку **Добавить оповещение**. Следуйте инструкциям мастера для настройки оповещения. Можно настроить предупреждение, информирующее либо о превышении показателями определенного порога, либо о падении показателей ниже определенного порога.

Например, если предполагается, что рабочая нагрузка базы данных будет расти, можно настроить отправку оповещения по электронной почте каждый раз, когда любой из показателей производительности для вашей базы данных достигнет 80%. Это оповещение можно использовать как предварительное предупреждение о том, что необходимо перейти на следующий максимальный объем вычислительных ресурсов.

Метрики производительности также помогут определить, можете ли вы перейти на более низкий объем вычислительных ресурсов. Предположим, вы используете базу данных размера S2 уровня Стандартный, и все метрики производительности показывают, что база данных никогда не используется более чем на 10%. Вполне вероятно, что эта база данных будет хорошо работать с размером S1 уровня Стандартный. Однако перед переходом на более низкий уровень производительности следует учитывать скачки и колебания объема вычислительных ресурсов.

## <a name="improving-database-performance-with-more-resources"></a>Повышение производительности базы данных с помощью дополнительных ресурсов

Наконец, если для базы данных нет применимых рекомендаций по повышению производительности, можно изменить объем ресурсов, доступных в Базе данных SQL Azure. Можно назначить больше ресурсов, изменив [уровень служб на основе DTU](sql-database-service-tiers-dtu.md) отдельной базы данных или увеличив количество eDTU эластичного пула в любое время. Кроме того, если вы используете [модель приобретения на основе виртуальных ядер](sql-database-service-tiers-vcore.md), вы можете изменить уровень служб или увеличить объем ресурсов, выделенных для базы данных.

1. Для повышения производительности отдельных баз данных можно изменять [уровни служб](sql-database-service-tiers-dtu.md) или объем [вычислительных ресурсов](sql-database-service-tiers-vcore.md) по запросу.
2. Если баз данных несколько, можно включить автомасштабирование ресурсов, используя [пулы эластичных баз данных](sql-database-elastic-pool-guidance.md).

## <a name="tune-and-refactor-application-or-database-code"></a>Настройка и рефакторинг кода приложения или базы данных

Можно изменить код приложения для более оптимального использования базы данных, изменить индексы, принудительно применить планы или с помощью указаний вручную адаптировать базу данных для рабочей нагрузки. Рекомендации и советы по ручной настройке и изменению кода приведены в [этом разделе руководства по производительности](sql-database-performance-guidance.md).

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о том, как включить автоматическую настройку в Базе данных SQL Azure и позволить ей полностью управлять рабочей нагрузкой, см. в [этой статье](sql-database-automatic-tuning-enable.md).
- Дополнительные сведения о ручной настройке для повышения производительности запросов см. в статье [Использование помощника по базам данных SQL на портале Azure](sql-database-advisor-portal.md).
- Изменить ресурсы, доступные в базе данных, можно, изменив [уровни служб Базы данных SQL Azure](sql-database-performance-guidance.md).
