---
title: Архитектура подключения к Управляемому экземпляру Базы данных SQL Azure | Документация Майкрософт
description: В этой статье представлены общие сведения об обмене данными с Управляемым экземпляром Базы данных SQL Azure и объясняется архитектура подключения, а также как функционируют различные компоненты при передаче трафика к Управляемому экземпляру.
services: sql-database
ms.service: sql-database
ms.subservice: managed-instance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: bonova, carlrab
manager: craigg
ms.date: 12/10/2018
ms.openlocfilehash: b709bbacce23a89b8c60b77a524018b50ca1ca5e
ms.sourcegitcommit: 898b2936e3d6d3a8366cfcccc0fccfdb0fc781b4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2019
ms.locfileid: "55245673"
---
# <a name="azure-sql-database-managed-instance-connectivity-architecture"></a>Архитектура подключения к Управляемому экземпляру Базы данных SQL Azure

В этой статье представлены общие сведения об обмене данными с Управляемым экземпляром Базы данных SQL Azure и объясняется архитектура подключения, а также как функционируют различные компоненты при передаче трафика к Управляемому экземпляру.  

Управляемый экземпляр Базы данных SQL Azure помещается в виртуальной сети Azure и подсети, выделенной для Управляемых экземпляров. Это развертывание поддерживает следующие сценарии: 
- Защищенный частный IP-адрес.
- Подключение к Управляемому экземпляру непосредственно из локальной сети.
- Подключение Управляемого экземпляра к связанному серверу или другому локальному хранилищу данных.
- Подключение Управляемого экземпляра к ресурсам Azure.

## <a name="communication-overview"></a>Общие сведения об обмене данными

На следующей схеме показаны сущности, которые подключаются к Управляемому экземпляру, а также ресурсы, к которым Управляемому экземпляру необходимо обратиться для правильной работы.

![Архитектура подключения сущностей](./media/managed-instance-connectivity-architecture/connectivityarch001.png)

Обмен данными, представленный в нижней части схемы, показывает, как приложения клиента и средства подключаются к Управляемому экземпляру в качестве источника данных.  

Так как Управляемый экземпляр является предложением "платформа как услуга" (PaaS), то корпорация Майкрософт управляет этой службой с помощью автоматических агентов (управления, развертывания и обслуживания) с учетом потоков данных телеметрии. Ответственность за управление Управляемым экземпляром лежит исключительно на корпорации Майкрософт, поэтому клиенты не могут получить доступ к машинам виртуального кластера Управляемого экземпляра по протоколу RDP.

Некоторым операциям SQL Server, инициированным пользователями или приложениями, может требоваться Управляемый экземпляр для взаимодействия с платформой. Как вариант, можно создать базу данных Управляемого экземпляра — ресурс, который предоставляется с помощью портала, PowerShell и Azure CLI.

Правильная работа Управляемого экземпляра зависит от других служб Azure (например, службы хранилища Azure для резервных копий, служебной шины Azure для данных телеметрии, Microsoft Azure AD для проверки подлинности, Azure Key Vault для прозрачного шифрования данных и т. д.), и он инициирует подключения к ним соответствующим образом.

Весь упомянутый выше обмен данными шифруется и подписывается с помощью сертификатов. Чтобы убедиться в том, что взаимодействующие стороны являются доверенными, Управляемый экземпляр постоянно проверяет эти сертификаты, обращаясь в центр сертификации. Чтобы защитить данные, Управляемый экземпляр закрывает подключения, если он не смог проверить сертификаты или они отозваны.

## <a name="high-level-connectivity-architecture"></a>Высокоуровневая архитектура подключения

На высоком уровне Управляемый экземпляр — это набор компонентов служб, размещенных на выделенном ряде изолированных виртуальных машин, которые работают внутри подсети виртуальной сети клиента и образуют виртуальный кластер.

Несколько Управляемых экземпляров могут разместиться в одном виртуальном кластере. При необходимости кластер автоматически расширяется или инициируется заключение контракта, если клиент изменяет число подготовленных экземпляров в подсети.

Приложения клиентов могут подключаться к Управляемому экземпляру, запрашивать и обновлять базы данных только в том случае, если они выполняются внутри виртуальной сети, пиринговой виртуальной сети, подключенной сети VPN или ExpressRoute, используя конечную точку с частным IP-адресом.  

![Схема архитектуры подключения](./media/managed-instance-connectivity-architecture/connectivityarch002.png)

Службы управления и развертывания Майкрософт выполняются за пределами виртуальной сети, поэтому подключение между Управляемым экземпляром и службами Майкрософт проходит через конечные точки с общедоступными IP-адресами. Из-за преобразования сетевых адресов (NAT) при создании исходящего подключения Управляемым экземпляром принимающая сторона видит его так, будто оно поступает из этого общедоступного IP-адреса.

Трафик управления проходит через виртуальную сеть клиента. Это означает, что элементы инфраструктуры виртуальной сети влияют на трафик управления и могут потенциально нанести ему вред, что приведет к неисправности или недоступности экземпляра.

> [!IMPORTANT]
> Для улучшения взаимодействия с клиентом и обеспечения доступности служб корпорация Майкрософт применяет политику намерений сети для элементов инфраструктуры виртуальной сети Azure, которые могут повлиять на работу Управляемого экземпляра. Это механизм платформы для прозрачного обмена сетевыми требованиями с пользователем. Основной целью механизма является предотвращение ошибок в конфигурации сети и обеспечение надлежащей работы Управляемого экземпляра. После удаления Управляемого экземпляра политика намерений сети также удаляется.

## <a name="virtual-cluster-connectivity-architecture"></a>Архитектура подключения виртуального кластера

Давайте более подробно вникнем в архитектуру подключения к Управляемому экземпляру Базы данных SQL Azure. На схеме ниже показан концептуальной макет виртуального кластера.

![Схема архитектуры подключения виртуального кластера](./media/managed-instance-connectivity-architecture/connectivityarch003.png)

Клиенты подключаются к Управляемому экземпляру с помощью имени узла в формате `<mi_name>.<dns_zone>.database.windows.net`. Это имя узла преобразовывается в частный IP-адрес, несмотря на то что оно зарегистрировано в общедоступной зоне DNS и является публично разрешимо. `zone-id` создается автоматически при создании кластера. Если в новом кластере размещается вторичный управляемый экземпляр, он совместно использует идентификатор зоны с основным кластером. Дополнительные сведения см. в [Use auto-failover groups to enable transparent and coordinated failover of multiple databases](sql-database-auto-failover-group.md##enabling-geo-replication-between-managed-instances-and-their-vnets) (Обеспечение прозрачной согласованной отработки отказа нескольких баз данных с помощью групп автоматической отработки отказа).

Этот частный IP-адрес принадлежит внутреннему балансировщику нагрузки (ILB) Управляемого экземпляра, который направляет трафик к шлюзу (GW) Управляемого экземпляра. Так как несколько Управляемых экземпляров могут выполняться внутри одного кластера, шлюз использует имя узла Управляемого экземпляра для перенаправления трафика в соответствующую службу ядра SQL.

Службы управления и развертывания подключаются к Управляемому экземпляру с помощью [конечной точки управления](#management-endpoint), которая сопоставляется с внешней подсистемой балансировки нагрузки. Трафик направляется на узлы, только если он получен на предопределенном наборе портов, которые используются исключительно компонентами управления Управляемого экземпляра. Чтобы разрешить трафик только с определенных диапазонов IP-адресов Майкрософт, настраивается встроенный брандмауэр на узлах. Весь обмен данными между компонентами управления и плоскостью управления с обеих сторон аутентифицируется с использованием сертификата.

## <a name="management-endpoint"></a>Конечная точка управления

Виртуальный кластер Управляемого экземпляра Базы данных SQL содержит конечную точку управления, которую корпорация Майкрософт использует для управления Управляемым экземпляром. Защита конечной точки управления обеспечивается с помощью встроенного брандмауэра на уровне сети и взаимной проверкой сертификатов на уровне приложения. Вы можете [найти IP-адрес конечной точки управления](sql-database-managed-instance-find-management-endpoint-ip-address.md).

Если подключения инициируются из Управляемого экземпляра (резервная копия, журнал аудита), в этом случае трафик поступает с общедоступного IP-адреса конечной точки управления. Вы можете ограничить доступ к общедоступным службам из Управляемого экземпляра, настроив правила брандмауэра, чтобы разрешить только IP-адрес Управляемого экземпляра. Найдите дополнительные сведения о методе [проверки встроенного брандмауэра Управляемого экземпляра](sql-database-managed-instance-management-endpoint-verify-built-in-firewall.md).

> [!NOTE]
> Это не относится к настройке правил брандмауэра для служб Azure, которые находятся в той же области, что и Управляемый экземпляр, так как на платформе Azure предусмотрена оптимизация трафика, проходящего между совместно размещенными службами.

## <a name="network-requirements"></a>Требования к сети

Управляемый экземпляр можно развернуть в выделенной подсети (подсеть Управляемого экземпляра) в виртуальной сети, которая соответствует следующим требованиям:
- **Выделенная подсеть**. С подсетью Управляемого экземпляра не должны быть связаны другие облачные службы, и она не должна быть подсетью шлюза. Вы не сможете создать Управляемый экземпляр в подсети, если в ней содержатся другие ресурсы, кроме Управляемого экземпляра, а также не сможете позже добавить в такую подсеть другие ресурсы.
- **Совместимая группа безопасности сети (NSG)**. Группы безопасности сети, связанные с подсетью Управляемого экземпляра, должны содержать также правила, приведенные в таблицах ниже ("Обязательные правила безопасности для входящего трафика" и "Обязательные правила безопасности для исходящего трафика"). Вы можете использовать группу безопасности сети для полного контроля доступа к конечной точке данных Управляемого экземпляра путем фильтрации трафика через порт 1433. 
- **Таблица совместимых определяемых пользователем маршрутов (UDR)**. В подсети Управляемого экземпляра должна быть пользовательская таблица маршрутов с **интернет-маршрутом следующего прыжка 0.0.0.0/0** , установленным в качестве обязательного определяемого пользователем маршрута. Кроме того, можно добавить определяемый пользователем маршрут, который передает трафик с локальных частных IP-адресов в качестве назначения через шлюз виртуальной сети или виртуальное сетевое устройство (NVA). 
- **Наличие необязательной пользовательской DNS**. Если в виртуальной сети определен пользовательский DNS-сервер, то в список должен быть добавлен IP-адрес рекурсивных сопоставителей Azure (например, 168.63.129.16). Дополнительные сведения см. в статье [Configuring a Custom DNS for Azure SQL Database Managed Instance](sql-database-managed-instance-custom-dns.md) (Настройка пользовательской DNS для Управляемого экземпляра Базы данных SQL Azure). Пользовательский DNS-сервер должен иметь возможность разрешать имена узлов в следующих доменах и их дочерних доменах: *microsoft.com*, *windows.net*, *windows.com*, *msocsp.com*, *digicert.com*, *live.com*, *microsoftonline.com* и *microsoftonline-p.com*. 
- **Отсутствие конечной точки службы**. С подсетью Управляемого экземпляра не должна быть связана конечная точка службы. При создании виртуальной сети отключите параметр "Конечные точки службы".
- **Достаточно IP-адресов**. В подсети Управляемого экземпляра должно быть как минимум 16 IP-адресов (рекомендуемый минимум — 32 IP-адреса). Дополнительные сведения см. в разделе [Determine VNet subnet size for Azure SQL Database Managed Instance](sql-database-managed-instance-determine-size-vnet-subnet.md) (Определение размера подсети виртуальной сети для Управляемого экземпляра Базы данных SQL Azure). Вы можете развернуть Управляемые экземпляры в [имеющейся сети](sql-database-managed-instance-configure-vnet-subnet.md) после его настройки в соответствии с [требованиями к сети Управляемого экземпляра](#network-requirements) или создать [сеть и подсеть](sql-database-managed-instance-create-vnet-subnet.md).

> [!IMPORTANT]
> Если целевая подсеть не соответствует перечисленным выше требованиям, в ней невозможно развернуть Управляемый экземпляр. *Политика намерений сети*, которая применяется в подсети, позволяет предотвратить несоответствующие изменения в конфигурации сети во время создания Управляемого экземпляра. *Эта политика* удаляется после удаления последнего экземпляра из подсети.

### <a name="mandatory-inbound-security-rules"></a>Обязательные правила безопасности для входящего трафика 

| ИМЯ       |Порт                        |Протокол|Источник           |Место назначения|Действие|
|------------|----------------------------|--------|-----------------|-----------|------|
|управление  |9000, 9003, 1438, 1440, 1452|TCP     |Любой              |Любой        |РАЗРЕШИТЬ |
|mi_subnet   |Любой                         |Любой     |MI SUBNET        |Любой        |РАЗРЕШИТЬ |
|health_probe|Любой                         |Любой     |AzureLoadBalancer|Любой        |РАЗРЕШИТЬ |

### <a name="mandatory-outbound-security-rules"></a>Обязательные правила безопасности для исходящего трафика 

| ИМЯ       |Порт          |Протокол|Источник           |Место назначения|Действие|
|------------|--------------|--------|-----------------|-----------|------|
|управление  |80, 443, 12000|TCP     |Любой              |Интернет   |РАЗРЕШИТЬ |
|mi_subnet   |Любой           |Любой     |Любой              |MI SUBNET  |РАЗРЕШИТЬ |

  > [!Note]
  > MI SUBNET означает диапазон IP-адресов для подсети в формате 10.x.x.x/y. Эти сведения можно найти на портале Azure (используя свойства подсети).
  
  > [!Note]
  > Несмотря на то, что обязательные правила безопасности входящего трафика разрешают трафик из _любого_ источника на портах 9000 9003, 1438, 1440, 1452, эти порты защищены с помощью встроенного брандмауэра. В этой [статье](sql-database-managed-instance-find-management-endpoint-ip-address.md) показано, как обнаружить IP-адрес конечной точки управления и проверить правила брандмауэра. 
  
  > [!Note]
  > Если используется репликация транзакций в управляемом экземпляре и любая база данных в управляемом экземпляре используется как издатель или распространитель, порт 445 (исходящий TCP-порт) также должен быть открыт в правилах безопасности подсети для доступа к файловому ресурсу Azure.
  
## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения см. в статье  [Общие сведения об Управляемом экземпляре Базы данных SQL Azure (предварительная версия)](sql-database-managed-instance.md).
- Узнайте, как [настроить новую виртуальную сеть](sql-database-managed-instance-create-vnet-subnet.md) или [имеющуюся виртуальную сеть](sql-database-managed-instance-configure-vnet-subnet.md), в которой можно развернуть Управляемые экземпляры.
- [Вычислите размер подсети](sql-database-managed-instance-determine-size-vnet-subnet.md), где будут развернуты Управляемые экземпляры. 
- Перейдите к краткому руководству по созданию Управляемого экземпляра:
  - на [портале Azure](sql-database-managed-instance-get-started.md);
  - с помощью [PowerShell](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2018/06/27/quick-start-script-create-azure-sql-managed-instance-using-powershell/).
  - с помощью [шаблона Azure Resource Manager](https://azure.microsoft.com/resources/templates/101-sqlmi-new-vnet/);
  - с помощью [шаблона Azure Resource Manager (jumpbox со включенным SSMS)](https://portal.azure.com/).
