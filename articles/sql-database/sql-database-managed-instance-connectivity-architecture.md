---
title: Архитектура подключения к Управляемому экземпляру Базы данных SQL Azure | Документация Майкрософт
description: В этой статье представлены общие сведения об обмене данными с Управляемым экземпляром Базы данных SQL Azure и объясняется архитектура подключения, а также как функционируют различные компоненты при передаче трафика к Управляемому экземпляру.
keywords: ''
services: sql-database
author: srdan-bozovic-msft
manager: craigg
ms.service: sql-database
ms.subservice: managed instance
ms.custom: ''
ms.date: 08/16/2018
ms.author: srbozovi
ms.reviewer: bonova, carlrab
ms.topic: conceptual
ms.openlocfilehash: 54917c6548c7f0bfacad6408732c5619e6346683
ms.sourcegitcommit: d2f2356d8fe7845860b6cf6b6545f2a5036a3dd6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2018
ms.locfileid: "40177560"
---
# <a name="azure-sql-database-managed-instance-connectivity-architecture"></a>Архитектура подключения к Управляемому экземпляру Базы данных SQL Azure 

В этой статье представлены общие сведения об обмене данными с Управляемым экземпляром Базы данных SQL Azure и объясняется архитектура подключения, а также как функционируют различные компоненты при передаче трафика к Управляемому экземпляру.  

## <a name="communication-overview"></a>Общие сведения об обмене данными 

На следующей схеме показаны сущности, которые подключаются к Управляемому экземпляру, а также ресурсы, к которым Управляемому экземпляру необходимо обратиться для правильной работы. 

![Архитектура подключения сущностей](./media/managed-instance-connectivity-architecture/connectivityarch001.png)

Обмен данными, представленный в нижней части схемы, показывает, как приложения клиента и средства подключаются к Управляемому экземпляру в качестве источника данных.  

Так как Управляемый экземпляр является предложением "платформа как услуга" (PaaS), то корпорация Майкрософт управляет этой службой с помощью автоматических агентов (управления, развертывания и обслуживания) с учетом потоков данных телеметрии. Ответственность за управление Управляемым экземпляром лежит исключительно на корпорации Майкрософт, поэтому клиенты не могут получить доступ к машинам виртуального кластера Управляемого экземпляра по протоколу RDP. 

Некоторым операциям SQL Server, инициированным пользователями или приложениями, может требоваться Управляемый экземпляр для взаимодействия с платформой. Как вариант, можно создать базу данных Управляемого экземпляра — ресурс, который предоставляется с помощью портала, PowerShell и Azure CLI. 

Правильная работа Управляемого экземпляра зависит от других служб Azure (например, службы хранилища Azure для резервных копий, служебной шины Azure для данных телеметрии, Microsoft Azure AD для проверки подлинности, Azure Key Vault для прозрачного шифрования данных и т. д.), и он инициирует подключения к ним соответствующим образом. 

Весь упомянутый выше обмен данными шифруется и подписывается с помощью сертификатов. Чтобы убедиться в том, что взаимодействующие стороны являются доверенными, Управляемый экземпляр постоянно проверяет эти сертификаты, обращаясь в центр сертификации. Чтобы защитить данные, Управляемый экземпляр закрывает подключения, если он не смог проверить сертификаты или они отозваны. 

## <a name="high-level-connectivity-architecture"></a>Высокоуровневая архитектура подключения 

На высоком уровне Управляемый экземпляр — это набор компонентов служб, размещенных на выделенном ряде изолированных виртуальных машин, которые работают внутри подсети виртуальной сети клиента и образуют виртуальный кластер. 

Несколько Управляемых экземпляров могут разместиться в одном виртуальном кластере. При необходимости кластер автоматически расширяется или инициируется заключение контракта, если клиент изменяет число подготовленных экземпляров в подсети. 

Приложения клиентов могут подключаться к Управляемому экземпляру, запрашивать и обновлять базы данных только в том случае, если они выполняются внутри виртуальной сети, пиринговой виртуальной сети, подключенной сети VPN или ExpressRoute, используя конечную точку с частным IP-адресом.  

![Схема архитектуры подключения](./media/managed-instance-connectivity-architecture/connectivityarch002.png)

Службы управления и развертывания Майкрософт выполняются за пределами виртуальной сети, поэтому подключение между Управляемым экземпляром и службами Майкрософт проходит через конечные точки с общедоступными IP-адресами. Из-за преобразования сетевых адресов (NAT) при создании исходящего подключения Управляемым экземпляром принимающая сторона видит его так, будто оно поступает из этого общедоступного IP-адреса. 

Трафик управления проходит через виртуальную сеть клиента. Это означает, что элементы инфраструктуры виртуальной сети влияют на трафик управления и могут потенциально нанести ему вред, что приведет к неисправности или недоступности экземпляра. 

> [!IMPORTANT]
> Для улучшения взаимодействия с клиентом и обеспечения доступности служб корпорация Майкрософт применяет политику намерений сети для элементов инфраструктуры виртуальной сети Azure, которые могут повлиять на работу Управляемого экземпляра. Это механизм платформы для прозрачного обмена сетевыми требованиями с пользователем. Основной целью механизма является предотвращение ошибок в конфигурации сети и обеспечение надлежащей работы Управляемого экземпляра. После удаления Управляемого экземпляра политика намерений сети также удаляется. 

## <a name="virtual-cluster-connectivity-architecture"></a>Архитектура подключения виртуального кластера 

Давайте более подробно вникнем в архитектуру подключения к Управляемому экземпляру Базы данных SQL Azure. На схеме ниже показан концептуальной макет виртуального кластера. 

![Схема архитектуры подключения виртуального кластера](./media/managed-instance-connectivity-architecture/connectivityarch003.png)

Клиенты подключаются к Управляемому экземпляру с помощью имени узла в формате "<имя_Управляемого_экземпляра>.<clusterid>.database.windows.net". Это имя узла преобразовывается в частный IP-адрес, несмотря на то что оно зарегистрировано в общедоступной зоне DNS и является публично разрешимо. 

Этот частный IP-адрес принадлежит внутреннему балансировщику нагрузки (ILB) Управляемого экземпляра, который направляет трафик к шлюзу (GW) Управляемого экземпляра. Так как несколько Управляемых экземпляров могут выполняться внутри одного кластера, шлюз использует имя узла Управляемого экземпляра для перенаправления трафика в соответствующую службу ядра SQL. 

Службы управления и развертывания подключаются к Управляемому экземпляру с помощью общедоступной конечной точки, которая сопоставляется с внешней подсистемой балансировки нагрузки. Трафик направляется на узлы, только если он получен на предопределенном наборе портов, которые используются исключительно компонентами управления Управляемого экземпляра. Весь обмен данными между компонентами управления и плоскостью управления с обеих сторон аутентифицируется с использованием сертификата. 

## <a name="next-steps"></a>Дополнительная информация 

- Дополнительные сведения см. в статье  [Общие сведения об Управляемом экземпляре Базы данных SQL Azure (предварительная версия)](sql-database-managed-instance.md). 
- Дополнительные сведения о настройке виртуальной сети для Управляемого экземпляра Базы данных SQL Azure см. в  [этой статье](sql-database-managed-instance-vnet-configuration.md). 
- Перейдите к краткому руководству по созданию Управляемого экземпляра: 
  - на [портале Azure](sql-database-managed-instance-create-tutorial-portal.md); 
  - с помощью [PowerShell](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2018/06/27/quick-start-script-create-azure-sql-managed-instance-using-powershell/); 
  - с помощью [шаблона Azure Resource Manager](https://azure.microsoft.com/resources/templates/101-sqlmi-new-vnet/); 
  - с помощью [шаблона Azure Resource Manager (jumpbox со включенным SSMS)](https://portal.azure.com/). 

