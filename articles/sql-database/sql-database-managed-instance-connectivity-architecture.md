---
title: Архитектура подключений к для управляемого экземпляра базы данных SQL Azure | Документация Майкрософт
description: Сведения о связи Azure базы данных SQL управляемого экземпляра и архитектура подключений к также как компоненты направлять трафик на управляемом экземпляре.
services: sql-database
ms.service: sql-database
ms.subservice: managed-instance
ms.custom: fasttrack-edit
ms.devlang: ''
ms.topic: conceptual
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: bonova, carlrab
manager: craigg
ms.date: 02/26/2019
ms.openlocfilehash: f08b22f24dfde41646f56dc1ecd9777f267620ee
ms.sourcegitcommit: 22ad896b84d2eef878f95963f6dc0910ee098913
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2019
ms.locfileid: "58651318"
---
# <a name="connectivity-architecture-for-a-managed-instance-in-azure-sql-database"></a>Архитектура подключений к для управляемого экземпляра базы данных SQL Azure 

В этой статье объясняется обмен данными в управляемый экземпляр базы данных SQL Azure. Также описывается архитектура подключений к и как компоненты направлять трафик на управляемом экземпляре.  

Управляемый экземпляр базы данных SQL размещается внутри виртуальной сети Azure и подсеть, предназначенный для управляемых экземпляров. Это развертывание обеспечивает:

- Безопасной частный IP-адрес.
- Возможность подключения к локальной сети на управляемом экземпляре.
- Возможность подключения к связанному серверу или другому управляемого экземпляра в локальном хранилище данных.
- Возможность подключения управляемого экземпляра к ресурсам Azure.

## <a name="communication-overview"></a>Общие сведения об обмене данными

На следующей схеме показана сущностей, которые подключаются к управляемому экземпляру. Он также представлены ресурсы, которые должны взаимодействовать с управляемым экземпляром. Процесс связи в нижней части диаграммы представляет клиентских приложений и средств, которые подключаются к управляемый экземпляр в качестве источников данных.  

![Сущности в архитектура подключений к](./media/managed-instance-connectivity-architecture/connectivityarch001.png)

Управляемый экземпляр — это платформа как услуга (PaaS). Корпорация Майкрософт использует автоматизированные агентов (управления, развертывания и обслуживания) для управления этой службы на основании потоки данных телеметрии. Так, как корпорация Майкрософт отвечает за управление, клиенты не может получить доступ к машин управляемый экземпляр виртуального кластера через протокол удаленного рабочего стола (RDP).

Некоторые операции, запущенные конечным пользователям или приложениям может потребоваться SQL Server управляемые экземпляры для взаимодействия с платформой. Один из вариантов — Создание управляемого экземпляра базы данных. Этот ресурс предоставляется с помощью портала Azure, PowerShell, Azure CLI и REST API.

Управляемые экземпляры зависят от Azure такие службы хранилища Azure для резервных копий, служебной шины Azure для данных телеметрии, Azure Active Directory для проверки подлинности и Azure Key Vault для прозрачного шифрования данных (TDE). Управляемые экземпляры подключаться к этим службам.

Весь обмен данными использование сертификатов для шифрования и подписывания. Для проверки надежности взаимодействующих сторон, управляемые экземпляры постоянно проверка этих сертификатов, обратившись в службу сертификации. Если не удается проверить сертификаты отзываются, управляемый экземпляр закроет его для защиты данных.

## <a name="high-level-connectivity-architecture"></a>Высокоуровневая архитектура подключения

На высоком уровне управляемый экземпляр — это набор компонентов службы. Эти компоненты размещаются на выделенном наборе изолированных виртуальных машин, которые выполняются в подсети виртуальной сети клиента. Эти компьютеры образуют виртуальный кластер.

Виртуальный кластер можно разместить несколько управляемых экземпляров. При необходимости, кластер автоматически расширение или сужение при смене число подготовленных экземпляров в подсети.

Клиентских приложений, для подключения к управляемых экземпляров и выполнить запрос и обновление баз данных только в том случае, если они выполняются внутри виртуальной сети, пиринговой виртуальной сети или сети, соединенных VPN или Azure ExpressRoute. Этой сети необходимо использовать конечную точку и частный IP-адрес.  

![Схема архитектуры подключения](./media/managed-instance-connectivity-architecture/connectivityarch002.png)

Управление и развертывание служб Microsoft работать за пределами виртуальной сети. Управляемый экземпляр и службам Майкрософт, подключиться через конечные точки, общедоступные IP-адреса. Когда управляемый экземпляр создает исходящее подключение на принимающей стороне делает сетевых адресов (NAT), внешний вид подключения, как и откуда этот общедоступный IP-адрес.

Трафик управления проходит через клиента виртуальной сети. Это означает, что элементы инфраструктуры виртуальной сети может причинить ущерб трафик управления нужно сделать экземпляром ошибкой и становятся недоступными.

> [!IMPORTANT]
> Для улучшения качества обслуживания клиентов и доступность служб, корпорация Майкрософт применяет намерений политику сети на элементы инфраструктуры виртуальной сети Azure. Политики могут повлиять на работу управляемого экземпляра. Этот механизм платформы прозрачно взаимодействует сетевые требования к пользователям. Основная цель этой политики — для предотвращения ошибок в конфигурации сети и обеспечить работу обычного управляемого экземпляра. При удалении управляемого экземпляра, также удаляется намерений политики сети.

## <a name="virtual-cluster-connectivity-architecture"></a>Архитектура подключения виртуального кластера

Давайте более подробно узнать в архитектуру связи для управляемых экземпляров. На схеме ниже показан концептуальной макет виртуального кластера.

![Архитектура подключения виртуальный кластер](./media/managed-instance-connectivity-architecture/connectivityarch003.png)

Клиенты подключаются к управляемому экземпляру, используя имя узла, которое имеет форму `<mi_name>.<dns_zone>.database.windows.net`. Это имя узла разрешается частный IP-адрес, несмотря на то, что он зарегистрирован в зоне общедоступного домена имен (DNS) и разрешимые. `zone-id` Создается автоматически при создании кластера. Если только что созданного кластера размещаются вторичной управляемого экземпляра, он использует его идентификатор зоны с основным кластером. Дополнительные сведения см. в разделе [используйте группы автоматической отработки отказа для включения прозрачного и согласованной отработки отказа нескольких баз данных](sql-database-auto-failover-group.md##enabling-geo-replication-between-managed-instances-and-their-vnets).

Этот частный IP-адрес принадлежит управляемый экземпляр внутренней подсистемы балансировки нагрузки. Подсистема балансировки нагрузки направляет трафик к шлюзу управляемого экземпляра. Так как внутри одного кластера можно запустить несколько экземпляров, шлюз использует имя узла управляемого экземпляра для перенаправления трафика с соответствующей службой ядра SQL.

Управление и развертывание служб подключиться к управляемому экземпляру с помощью [конечная точка управления](#management-endpoint) что сопоставляется с внешним подсистемы балансировки нагрузки. Трафик направляется к узлам, только в том случае, если оно приходит на стандартный набор портов, использующих только компоненты управления, управляемый экземпляр. Настройка встроенного брандмауэра на узлах, разрешающее трафик только из диапазонов IP-адресов Microsoft. Сертификаты выполняют взаимную аутентификацию весь обмен данными между компонентами управления и плоскости управления.

## <a name="management-endpoint"></a>Конечная точка управления

Корпорация Майкрософт управляет управляемый экземпляр с помощью конечной точки управления. Эта конечная точка находится внутри экземпляра виртуальный кластер. Конечная точка управления защищен встроенного брандмауэра на уровне сети. На уровне приложения он защищен взаимной сертификат проверки. Чтобы найти IP-адрес конечной точки, см. в разделе [определить IP-адрес конечной точки управления](sql-database-managed-instance-find-management-endpoint-ip-address.md).

После подключения запустите в управляемом экземпляре (как и в резервные копии и журналы аудита), трафик, по-видимому, начните с общедоступный IP-адрес конечной точки управления. Можно ограничить доступ к общедоступным службам из управляемого экземпляра, настроив правила брандмауэра, чтобы разрешить только IP-адрес управляемого экземпляра. Дополнительные сведения см. в разделе [проверить встроенный брандмауэр управляемый экземпляр](sql-database-managed-instance-management-endpoint-verify-built-in-firewall.md).

> [!NOTE]
> В отличие от брандмауэра для подключений, которые начинаются в управляемом экземпляре служб Azure, которые находятся внутри области управляемый экземпляр установлен брандмауэр, оптимизированный для трафика, проходящего между этими службами.

## <a name="network-requirements"></a>Требования к сети

Развертывание управляемого экземпляра в выделенной подсети в виртуальной сети. Подсеть должна иметь следующие характеристики:

- **Выделенная подсеть:** Подсети управляемого экземпляра не может содержать другие облачные службы, связанной с ним, и не может быть подсеть шлюза. Подсети не может содержать любой ресурс, но управляемый экземпляр и более поздней версии, нельзя добавлять ресурсы в подсети.
- **Группа безопасности сети (NSG).** Необходимо определить группу безопасности сети, связанной с виртуальной сетью [правила безопасности для входящего трафика](#mandatory-inbound-security-rules) и [правила безопасности для исходящего трафика](#mandatory-outbound-security-rules) перед другие правила. Группа безопасности сети можно использовать для управления доступом к конечной точке данных управляемого экземпляра путем фильтрации трафика через порт 1433.
- **Определяемой пользователем (UDR) таблицы маршрутов:** Определяемый пользователем Маршрут таблицу, связанную с виртуальной сетью необходимо включить определенные [записи](#user-defined-routes).
- **Нет конечных точек службы:** Конечная точка службы не должна быть связана с подсетью управляемого экземпляра. Убедитесь, что службы конечных точек может быть отключена при создании виртуальной сети.
- **IP-адресов:** Для подсети управляемого экземпляра необходимо по крайней мере 16 IP-адресов. Рекомендуемое минимальное число — 32 IP-адресов. Дополнительные сведения см. в разделе [определения размера подсети для управляемых экземпляров](sql-database-managed-instance-determine-size-vnet-subnet.md). Вы можете развернуть управляемых экземпляров в [существующей сети](sql-database-managed-instance-configure-vnet-subnet.md) после его настройки [сетевые требования для управляемых экземпляров](#network-requirements). В противном случае создайте [создать сеть и подсеть](sql-database-managed-instance-create-vnet-subnet.md).

> [!IMPORTANT]
> Нельзя развернуть новый управляемый экземпляр, если в подсети назначения не имеет следующие характеристики. При создании управляемого экземпляра, намерений сетевой политики, применяемые в подсети для предотвращения несоответствующих изменений в сетевой настройки. После удаления последнего экземпляра из подсети намерений политики сети также удаляется.

### <a name="mandatory-inbound-security-rules"></a>Обязательные правила безопасности для входящего трафика

| ИМЯ       |Порт                        |Протокол|Источник           |Место назначения|Действие|
|------------|----------------------------|--------|-----------------|-----------|------|
|управление  |9000, 9003, 1438, 1440, 1452|TCP     |Любой              |Любой        |РАЗРЕШИТЬ |
|mi_subnet   |Любой                         |Любой     |MI SUBNET        |Любой        |РАЗРЕШИТЬ |
|health_probe|Любой                         |Любой     |AzureLoadBalancer|Любой        |РАЗРЕШИТЬ |

### <a name="mandatory-outbound-security-rules"></a>Обязательные правила безопасности для исходящего трафика

| ИМЯ       |Порт          |Протокол|Источник           |Место назначения|Действие|
|------------|--------------|--------|-----------------|-----------|------|
|управление  |80, 443, 12000|TCP     |Любой              |AzureCloud;  |РАЗРЕШИТЬ |
|mi_subnet   |Любой           |Любой     |Любой              |MI ПОДСЕТИ *  |РАЗРЕШИТЬ |

> [!IMPORTANT]
> Убедитесь, имеется только одно входящее правило для порта 9000 9003, 1438, 1440, 1452 и одно правило исходящего трафика для порта 80, 443, 12000. Управляемый экземпляр подготовку с помощью развертывания ARM завершится ошибкой, если правила входящего трафика и выходных настраиваются отдельно для каждого порта. Если эти порты находятся в отдельных правил, развертывание завершится ошибкой с кодом ошибки `VnetSubnetConflictWithIntendedPolicy`

\* MI ПОДСЕТИ ссылается на диапазон IP-адресов для подсети в 10.x.x.x/y формы. Эти сведения можно найти на портале Azure, в свойства подсети.

> [!IMPORTANT]
> Несмотря на то, что правила безопасности для входящего трафика требуется разрешить трафик от _любой_ источников на порты 9000, 9003, 1438, 1440 и 1452, эти порты защищены встроенного брандмауэра. Дополнительные сведения см. в разделе [определить адрес конечной точки управления](sql-database-managed-instance-find-management-endpoint-ip-address.md).

> [!NOTE]
> При использовании репликации транзакций в управляемом экземпляре, и при использовании любой экземпляр базы данных в качестве издателя или распространителя, откройте порт 445 (исходящий TCP-ПОРТ) в правилах безопасности этой подсети. Этот порт будет разрешать доступ к общей папке Azure.

### <a name="user-defined-routes"></a>Определяемые пользователем маршруты

|ИМЯ|Префикс адреса|Next Hop|
|----|--------------|-------|
|subnet_to_vnetlocal|[mi_subnet]|Виртуальная сеть|
|mi-0-5-Next-Hop-Internet|0.0.0.0/5|Интернет|
|mi-11-8-следующего прыжка — Интернет|11.0.0.0/8|Интернет|
|mi — 12-6-следующего прыжка — Интернет|12.0.0.0/6|Интернет|
|mi — 128-3-следующего прыжка — Интернет|128.0.0.0/3|Интернет|
|mi — 16-4-следующего прыжка — Интернет|16.0.0.0/4|Интернет|
|mi — 160-5-следующего прыжка — Интернет|160.0.0.0/5|Интернет|
|mi — 168-6-следующего прыжка — Интернет|168.0.0.0/6|Интернет|
|mi — 172-12-следующего прыжка — Интернет|172.0.0.0/12|Интернет|
|mi-172-128-9-nexthop-Internet|172.128.0.0/9|Интернет|
|mi-172-32-11-nexthop-Internet|172.32.0.0/11|Интернет|
|mi-172-64-10-nexthop-Internet|172.64.0.0/10|Интернет|
|mi — 173-8-следующего прыжка — Интернет|173.0.0.0/8|Интернет|
|mi — 174-7-следующего прыжка — Интернет|174.0.0.0/7|Интернет|
|mi — 176-4-следующего прыжка — Интернет|176.0.0.0/4|Интернет|
|mi-192-128-11-nexthop-Internet|192.128.0.0/11|Интернет|
|mi-192-160-13-nexthop-Internet|192.160.0.0/13|Интернет|
|mi-192-169-16-nexthop-Internet|192.169.0.0/16|Интернет|
|mi-192-170-15-nexthop-Internet|192.170.0.0/15|Интернет|
|mi-192-172-14-nexthop-Internet|192.172.0.0/14|Интернет|
|mi-192-176-12-nexthop-Internet|192.176.0.0/12|Интернет|
|mi-192-192-10-nexthop-Internet|192.192.0.0/10|Интернет|
|mi — 192-9-следующего прыжка — Интернет|192.0.0.0/9|Интернет|
|mi — 193 — 8-следующего прыжка — Интернет|193.0.0.0/8|Интернет|
|mi — 194-7-следующего прыжка — Интернет|194.0.0.0/7|Интернет|
|mi — 196-6-следующего прыжка — Интернет|196.0.0.0/6|Интернет|
|mi — 200-5-следующего прыжка — Интернет|200.0.0.0/5|Интернет|
|mi — 208-4-следующего прыжка — Интернет|208.0.0.0/4|Интернет|
|mi — 224-3-следующего прыжка — Интернет|224.0.0.0/3|Интернет|
|mi — 32-3-следующего прыжка — Интернет|32.0.0.0/3|Интернет|
|mi — 64-2-следующего прыжка — Интернет|64.0.0.0/2|Интернет|
|mi — 8-7-следующего прыжка — Интернет|8.0.0.0/7|Интернет|
||||

Кроме того можно добавить записи в таблицу маршрутов для маршрутизации трафика с локальных частных IP-адресов в качестве назначения через шлюз виртуальной сети или виртуальное сетевое устройство (NVA).

Если виртуальная сеть содержит пользовательский DNS-сервер, добавьте запись для IP-адрес Azure рекурсивного сопоставителя (например, 168.63.129.16). Дополнительные сведения см. в разделе [настроить пользовательский DNS-сервер](sql-database-managed-instance-custom-dns.md). Пользовательский DNS-сервер должен иметь возможность разрешения имен узлов в эти домены и поддомены, их: *microsoft.com*, *windows.net*, *windows.com*,  *msocsp.com*, *digicert.com*, *live.com*, *microsoftonline.com*, и *microsoftonline-p.com*.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения см. в разделе [повышенной безопасности данных базы данных SQL](sql-database-managed-instance.md).
- Узнайте, как [настроить новую виртуальную сеть Azure](sql-database-managed-instance-create-vnet-subnet.md) или [существующей виртуальной сети](sql-database-managed-instance-configure-vnet-subnet.md) которого можно развернуть управляемых экземпляров.
- [Вычислите размер подсети](sql-database-managed-instance-determine-size-vnet-subnet.md) место для развертывания управляемых экземплярах.
- Узнайте, как создать управляемый экземпляр:
  - На [портале Azure](sql-database-managed-instance-get-started.md).
  - С помощью [PowerShell](scripts/sql-database-create-configure-managed-instance-powershell.md).
  - С помощью [шаблона Azure Resource Manager](https://azure.microsoft.com/resources/templates/101-sqlmi-new-vnet/).
  - С помощью [шаблон Azure Resource Manager (с помощью JumpBox, с помощью SSMS включены)](https://portal.azure.com/).
