<properties 
	pageTitle="Вопросы цены и производительности для пула эластичных баз данных | Пулы эластичных баз данных базы данных SQL Azure" 
	description="Эластичный пул баз данных — это набор доступных ресурсов, совместно используемых группой эластичных баз данных. В этом документе представлены рекомендации, которые помогут оценить целесообразность использования пула эластичных баз данных для группы баз данных." 
	services="sql-database" 
	documentationCenter="" 
	authors="stevestein" 
	manager="jeffreyg" 
	editor=""/>

<tags 
	ms.service="sql-database"
	ms.devlang="NA"
	ms.date="06/24/2015" 
	ms.author="sstein" 
	ms.workload="data-management" 
	ms.topic="article" 
	ms.tgt_pltfrm="NA"/>


# Вопросы цены и производительности для пула эластичных баз данных


Этот документ содержит рекомендации, позволяющие оценить, является ли использование пула эластичных баз данных экономически эффективным, на основе закономерностей использования и ценовых различий между пулом эластичных баз данных и отдельными базами данных. Чтобы определить текущий размер пула, необходимый для существующего набора баз данных SQL, также предоставляются дополнительные рекомендации.

- Общие сведения о пулах эластичных баз данных см. в разделе [Пулы эластичных баз данных для баз данных SQL](sql-database-elastic-pool.md).
- Дополнительные сведения о пулах эластичных баз данных см. в разделе [Справочник по пулу эластичных баз данных для баз данных SQL](sql-database-elastic-pool-reference.md).


> [AZURE.NOTE]Сейчас эластичные пулы предоставляются в виде предварительной версии, которая доступна только с серверами Базы данных SQL версии 12.

## Пулы эластичных баз данных

Независимые поставщики программных продуктов SaaS разрабатывают приложения, созданные на основе крупных уровней данных, состоящих из нескольких баз данных. Каждая из этих баз данных имеет стандартный шаблон приложения, что позволяет задавать различных клиентов с уникальными и непрогнозируемыми закономерностями использования. Для независимого поставщика программных продуктов трудно спрогнозировать требования для каждой отдельной базы данных. При этих обстоятельствах независимый поставщик программных продуктов может закладывать избыточные ресурсы, значительно увеличив расходы, чтобы обеспечить подходящую пропускную способность и время отклика для всех баз данных. Иначе независимый поставщик программных продуктов может сэкономить и подвергнуть риску производительность своих клиентов.

Пулы эластичных баз данных в базе данных SQL Azure позволяют независимым поставщикам программных продуктов SaaS оптимизировать соотношение цены и производительности для группы баз данных с назначенным бюджетом и обеспечить эластичность производительности для каждой базы данных. Пулы эластичных БД позволяют независимым поставщикам программных продуктов покупать единицы пропускной способности баз данных (DTU) для пула эластичных БД, которые совместно используются несколькими базами данных, чтобы обеспечить работу отдельных баз данных в непрогнозируемые периоды использования. Требование к DTU для пула эластичных БД определяется совокупным использованием его баз данных. Количество единиц DTU, доступных для пула эластичных БД, ограничено бюджетом независимого поставщика программных продуктов. Благодаря пулам эластичных БД независимому поставщику программных продуктов проще обосновать влияние бюджета на производительность их пула и наоборот. Независимый поставщик программных продуктов просто добавляет базы данных в пул эластичных БД, задает необходимые гарантии DTU или ограничения для баз данных, затем задает единицы DTU для пула на основе своего бюджета. Благодаря использованию пулов эластичных БД независимые поставщики программных продуктов переводят качество своих услуг с уровня небольшой новой компании на уровень состоявшегося бизнеса с возможностями роста.
  


## Когда необходимо рассматривать вариант с пулом эластичных баз данных

Пулы эластичных БД хорошо подходят для большого числа баз данных с конкретными закономерностями использования. Для заданной базы данных эта закономерность характеризуется низким средним использованием с относительно редкими пиками использования.

Чем больше баз данных можно добавить в пул, тем больше экономия, но в зависимости от закономерности использования приложения можно увидеть экономию уже для 4 баз данных S3.

Следующие разделы помогут вам понять, как оценить преимущества использования пула эластичных БД для конкретного набора баз данных.

### Оценка закономерностей использования баз данных

На следующем рисунке показан пример базы данных, которая большую часть времени находится в режиме ожидания, но также у нее периодически возникают пики активности. Такая закономерность использования хорошо подходит для пула эластичных БД:
 
   ![одна база данных][1]

Для одночасового периода времени, показанного на рисунке выше, пики базы данных DB1 достигают 90 DTU, но общее среднее использование составляет менее 5 DTU. Для обработки такой рабочей нагрузки в отдельной базе данных требуется уровень производительности S3. Однако большая часть ресурсов остается неиспользованной в периоды низкой активности.

Пул эластичных БД позволяет совместно использовать эти незадействованные единицы DTU между несколькими базами данных, сокращая тем самым общее число необходимых единиц DTU и уменьшая расходы.

На основе предыдущего примера предположим, что существуют дополнительные базы данных с закономерностями использования, схожими с закономерностью использования базы данных DB1. На следующих двух рисунках использование 4 и 20 баз данных представлено на одном графике, чтобы показать, что их использование не накладывается во времени:

   ![четыре базы данных][2]

   ![двадцать баз данных][3]

Совокупное использование DTU для всех 20 баз данных показано черной линией на рисунке выше. На рисунке видно, что совокупное использование DTU никогда не превышает 100 DTU, и показано, что 20 баз данных могут совместно использовать 100 DTU в этом периоде времени. Это приводит к 20-кратному сокращению единиц DTU и 6-кратному снижению цены по сравнению с размещением каждой базы данных на уровнях производительности S3 для отдельных баз данных.


Этот пример является идеальным по следующим причинам.

- Существует большая разница между пиковым использованием и средним использованием для каждой базы данных.  
- Пиковое использование для каждой базы данных возникает в разное время. 
- Единицы DTU совместно используются большим числом баз данных.


Цена пула эластичных БД зависит от единиц DTU пула и количества баз данных в нем. Хотя цена единицы DTU для пула по расценкам общедоступных версий в 3 раза выше цены единицы DTU для отдельной базы данных, единицы DTU пула можно совместно использовать между множеством баз данных, поэтому во многих случаях требуется меньшее общее количество единиц DTU. Эти различия в цене и совместное использование единиц DTU является основой возможности экономии, которую может предоставить пул.

<br>

Следующие практические правила, относящиеся к количеству баз данных и использованию баз данных, помогут обеспечить уменьшение цены пула эластичных БД по сравнению с использованием уровней производительности для отдельных баз данных. Рекомендации основаны на ценах общедоступных версий. Обратите внимание, что цены общедоступных версий снижены на 50 % для предварительной версии, поэтому эти практические правила следует рассматривать как относительно умеренные.


### Минимальное число баз данных

Благодаря цене общедоступных версий пул эластичных БД становится более экономичным выбором с точки зрения производительности, если 1 единица DTU может совместно использоваться более чем 3 базами данных. Это означает, что сумма всех единиц DTU уровней производительности для отдельных баз данных больше чем в 3 раза превосходит единицы DTU пула. Доступные размеры см. в разделе [Ограничения по DTU и памяти для пулов эластичных БД и эластичных баз данных](sql-database-elastic-pool-reference.md#dtu-and-storage-limits-for-elastic-pools-and-elastic-databases).


***Пример.***<br> Не менее 4 баз данных S3 или 36 баз данных S0 необходимо для пула эластичных БД со 100 единицами DTU, чтобы этот вариант был более экономичным, чем использование уровней производительности для отдельных баз данных. (Обратите внимание, что благодаря ценам предварительной версии значение точки безубыточности, основанное на числе баз данных, снижается до 2 баз данных S3 или 17 баз данных S0.)



### Максимальное число баз данных с одновременными пиками

Из-за совместного использования единиц DTU не все базы данных в пуле могут одновременно использовать предельные значения единиц DTU, которые доступны при использовании уровней производительности для отдельных баз данных. Чем меньше баз данных с одновременными пиками, тем меньше значение для единиц DTU можно задавать, и тем более экономичным становится пул. Как правило, в пуле должно быть не более 1/3 от всего числа баз данных с одновременным пиком до предельных значений единиц DTU

***Пример.***<br> Чтобы сократить затраты для 4 баз данных S3 в пуле с 200 DTU, не более 2 баз данных в пуле должны испытывать одновременные пиковые нагрузки использования. В противном случае, если пиковую нагрузку одновременно испытывают более 2 из этих 4 баз данных S3, для пула необходимо выбрать размер более 200 DTU. И если размер пула увеличится до значения единиц DTU более 200, больше баз данных S3 потребуется добавить, чтобы цена была ниже, чем у уровней производительности для отдельных баз данных.


Обратите внимание, что в данном примере не учитывается использование других баз данных в пуле. Если все базы данных используются в любой заданной временной точке, тогда одновременно испытывать пиковую нагрузку могут менее 1/3 от числа баз данных.


### Использование единиц DTU на одну базу данных

Большая разница между пиковым и средним использованием базы данных указывает на продолжительные периоды низкого уровня использования и короткие периоды высокого уровня использования. Эта закономерность использования идеально подходит для совместного использования ресурсов несколькими базами данных. Следует рассматривать помещение базы данных в пул, если ее загрузка пикового использования в 3 раза больше загрузки среднего использования.

    
***Пример.***<br> База данных S3 с пиковым использованием 100 DTU и средним использованием 30 DTU или менее хорошо подходит для совместного использования единиц DTU в пуле эластичных БД. Кроме того, база данных S1 с пиковым использованием 20 DTU и средним использованием 7 DTU или меньше хорошо подходит для пула эластичных БД.
    

## Алгоритм сравнения разницы цен между пулом эластичных БД и отдельными базами данных 

Следующий алгоритм может помочь оценить, какой вариант является более экономичным, пул эластичных БД или отдельные базы данных.

1. Оцените количество единиц DTU, необходимых для пула, следующим образом:
    
    Макс.(*Общее число баз данных* * *среднее использование единиц DTU на базу данных*, *число баз данных с одновременными пиками* * *пиковое использование единиц DTU на базу данных*)

2. Выберите наименьшее доступное значение единиц DTU для пула, которое превосходит оценку из действия 1. Для доступных вариантов DTU изучите действительные значение для единиц DTU, перечисленных здесь: [ограничения по единицам DTU и памяти для пулов эластичных БД и эластичных БД](sql-database-elastic-pool-reference.md#dtu-and-storage-limits-for-elastic-pools-and-elastic-databases).

    


3. Рассчитайте цену за пул следующим образом:

    цена за пул = (*число единиц DTU пула* * *цена единицы DTU пула*) + (*общее число баз данных DB* * *цена за единицу базы данных пула*)

    Информацию о ценах см. в разделе [Цены на базы данных SQL](http://azure.microsoft.com/pricing/details/sql-database/).


4. Сравните цену пула из действия 3 с ценой использования подходящих уровней производительности отдельных баз данных.



## Определение наилучшего размера DTU пула для существующих баз данных SQL 

Наилучший размер для пула эластичных БД зависит от совокупного числа единиц DTU и ресурсов хранения, необходимых для всех баз данных в пуле. Для этого необходимо определить наибольшую из следующих двух величин:

* Максимальное число единиц DTU, используемых всеми базами данных в пуле.
* Максимальное число байтов памяти, используемых всеми базами данных в пуле. 

Обратите внимание, что для уровня служб Standard 1 ГБ памяти доступен для каждой единицы DTU, настроенной для пула. Например, если пул настроен на 200 DTU, ограничение его памяти составляет 200 ГБ.

### Используйте советник по уровням служб (STA) и динамические административные представления (DMVs) для получения рекомендаций о размере   

В STA и DMV предоставлены различные средства и возможности для определения размера пула эластичных БД. Независимо от использованного средства оценку размера следует использовать только для первоначального анализа и создания пулов эластичных БД. После создания пула эластичных БД использование его ресурсов следует точно отслеживать и регулировать настройки пула соответствующим образом.

**STA**<br>STA — это встроенное средство портала Azure, которое автоматически оценивает использование ресурсов баз данных в существующем сервере баз данных SQL за прошедший период времени и рекомендует подходящую конфигурацию пула эластичных БД.

**Средство определения размера DMV**<br>Средство определения размера DMV предоставляется в виде сценария PowerShell и позволяет настраивать оценки размера пула эластичных БД для существующих баз данных на сервере.

### Выбор между средствами STA и DMV 

Выберите средство, которое подходит для анализа вашего конкретного приложения. В следующей таблице приведены различия между этими 2 средствами для определения размера:

| Функция | STA | DMV |
| :--- | :--- | :--- |
| Степень детализации образцов данных, используемых в анализе. | 15 секунд | 15 секунд |
| Учет различий в цене между пулом и уровнями производительности для отдельных баз данных. | Да | Нет |
| Возможность настройки списка баз данных, проанализированных на сервере. | Нет | Да |
| Возможность настройки периода времени, используемого в анализе. | Нет | Да |


### Оценка размера пула эластичных БД с помощью STA  

STA оценивает историю использования баз данных и рекомендует пул эластичных БД, когда это более экономично по сравнению с использованием уровней производительности отдельных баз данных. Если рекомендуется использовать пул эластичных БД, средство предоставляет список рекомендованных баз данных, а также рекомендованное число единиц DTU пула, минимальные и максимальные настройки единиц DTU для каждой эластичной базы данных. Чтобы база данных рассматривалась для включения в пул эластичных БД, она должна существовать не менее 14 дней. Если общедоступная предварительная версия пула эластичных баз данных ограничена только уровнем Standard, базы данных Premium не рассматриваются для включения в пул эластичных БД.

Средство STA доступно на портале Azure при добавлении пула эластичных БД на существующий сервер. Если рекомендации для пула эластичных БД доступны для этого сервера, они отображаются в колонке создания "Пул эластичных баз данных". Клиенты всегда могут изменять рекомендованные конфигурации для создания своих групп пулов эластичных БД.

### Оценка размера эластичных БД с помощью динамических административных представлений (DMV) 

Средство DMV [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) измеряет использование ресурсов отдельной базы данных. Это средство DMV предоставляет данные о загрузке ЦП, операциях ввода-вывода, ведении журнала и журнал использования базы данных в виде процента от ограничения уровня производительности базы данных. Эти данные можно использовать для расчета использования единиц DTU базы данных в любом заданном 15-секундном интервале.

Совокупное использование единиц DTU для пула эластичных БД в 15-секундном интервале можно оценить, сложив использование единиц DTU для всех рассматриваемых баз данных за этот период времени. В зависимости от конкретных целей для производительности может понадобиться отбросить небольшой процент образцовых данных. Например, значение 99-го процентиля совокупных единиц DTU за все временные интервалы можно применить для исключения выбросов и обеспечения того, что единицы DTU пула эластичных БД соответствуют 99 % от образцовых временных интервалов.

## Сценарий PowerShell для оценки совокупного использования единиц DTU ваших баз данных

Здесь представлен образец сценария PowerShell для оценки совокупных значений DTU для баз данных пользователя на сервере баз данных SQL.

Сценарий собирает данные, только когда запущен. Для получения типичной производственной нагрузки следует, чтобы сценарий работал не менее дня, хотя для получения более точной оценки требуется работа в течение недели или даже больше. Запустите сценарий на время, которое позволит отразить типичную рабочую нагрузку ваших баз данных.

> [AZURE.IMPORTANT]Окно PowerShell должно быть открыто во время работы сценария. Не закрывайте окно PowerShell, пока сценарий не проработает достаточное количество времени и собранных данных не будет хватать для отражения типичной рабочей нагрузки с периодами нормального и пикового использования.

### Предварительные требования сценария 

Перед запуском сценария установите следующие элементы:

- Последнее [средство командной строки Powershell](http://go.microsoft.com/?linkid=9811175&clcid=0x409).
- [Пакет дополнительных компонентов SQL Server 2014](https://www.microsoft.com/download/details.aspx?id=42295).


### Сведения о сценарии


Можно запустить сценарий с локального компьютера или виртуальной машины в облаке. Если запустить сценарий на локальном компьютере, с вас могут взять плату за передачу данных, поскольку сценарию необходимо загружать данные из целевых баз данных. Ниже показана оценка объема данных на основе числа целевых баз данных и продолжительности работы сценария. Цены на передачу данных Azure см. в разделе [Сведения о ценах за передачу данных](http://azure.microsoft.com/pricing/details/data-transfers/).
       
 -     1 база данных в час = 38 КБ
 -     1 база данных в день = 900 КБ
 -     1 база данных в неделю = 6 МБ
 -     100 баз данных в день = 90 МБ
 -     500 баз данных в неделю = 3 ГБ

Сценарий исключает определенные базы данных, которые не подходят для текущего предложения по общедоступной предварительной версии для уровня Standard пулов эластичных БД. Если необходимо исключить дополнительные базы данных с целевого сервера, можно изменить сценарий для соответствия вашим критериям. По умолчанию сценарий не собирает информацию для следующих баз данных:

* Всех баз данных Premium на серверах V12.
* Баз данных P2 и P3 на серверах V11.
* Эластичных баз данных (баз данных, которые уже находятся в пуле эластичных БД).
* Главной базы данных сервера.

Сценарию требуется выходная база данных, чтобы хранить промежуточные данные для анализа. Можно использовать новую или существующую базу данных. Хотя это не является техническим требованием, необходимым для работы средства, выходная база данных должна располагаться на другом сервере во избежание влияния на результат анализа. Предложите уровень производительности выходной базы данных, соответствующий S0 или выше. При сборе данных в течение продолжительного промежутка времени для большого числа баз данных можно рассмотреть вариант увеличения уровня производительности выходной базы данных.

Для сценария необходимо предоставить учетные данные для подключения к целевому серверу (кандидату на включение в пул эластичных баз данных) с указанием полного имени сервера, например abcdef.database.windows.net. В настоящее время сценарий не поддерживает одновременный анализ нескольких серверов.



После отправки значений для первоначальной настройки параметров предлагается выполнить вход в учетную запись Azure. Это делается для выполнения входа на целевом сервере, а не на сервере выходной базы данных.
	
Если во время работы сценария отображаются следующие предупреждения, их можно игнорировать:

- ВНИМАНИЕ! Командлет Switch-AzureMode является устаревшим.
- ВНИМАНИЕ! Не удалось получить информацию о службе SQL Server. Сбой попытки подключиться к WMI в Microsoft.Azure.Commands.Sql.dll со следующей ошибкой: сервер RPC недоступен.

Когда сценарий завершает работу, он выдает оценочное число единиц DTU, необходимых для пула эластичных БД, чтобы содержать все рассматриваемые базы данных на целевом сервере. Оценку числа единиц DTU можно использовать для создания и конфигурации пула эластичных БД для этих баз данных. После создания пула и перемещения баз данных в пул следует внимательно следить за пулом в течение нескольких дней и при необходимости вносить изменения в конфигурацию DTU пула.


Чтобы выбрать весь сценарий для копирования, щелкните любой текст в сценарии 3 раза (тройной щелчок).

    
    param (
    [Parameter(Mandatory=$true)][string]$AzureSubscriptionName, # Azure Subscription name - can be found on the Azure portal: https://portal.azure.com/
    [Parameter(Mandatory=$true)][string]$ResourceGroupName, # Resource Group name - can be found on the Azure portal: https://portal.azure.com/
    [Parameter(Mandatory=$true)][string]$servername, # full server name like "abcdefg.database.windows.net"
    [Parameter(Mandatory=$true)][string]$username, # user name
    [Parameter(Mandatory=$true)][string]$serverPassword, # password
    [Parameter(Mandatory=$true)][string]$outputServerName, # metrics collection database for analysis. full server name like "zyxwvu.database.windows.net"
    [Parameter(Mandatory=$true)][string]$outputdatabaseName,
    [Parameter(Mandatory=$true)][string]$outputDBUsername,
    [Parameter(Mandatory=$true)][string]$outputDBpassword,
    [Parameter(Mandatory=$true)][int]$duration_minutes # How long to run. Recommend to run for the period of time when your typical workload is running. At least 10 mins.
    )
    
    Add-AzureAccount 
    Select-AzureSubscription $AzureSubscriptionName
    Switch-AzureMode AzureResourceManager
    
    $server = Get-AzureSqlServer -ServerName $servername.Split('.')[0] -ResourceGroupName $ResourceGroupName
    
    # Check version/upgrade status of the server
    $upgradestatus = Get-AzureSqlServerUpgrade -ServerName $servername.Split('.')[0] -ResourceGroupName $ResourceGroupName
    $version = ""
    if ([string]::IsNullOrWhiteSpace($server.ServerVersion)) 
    {
    $version = $upgradestatus.Status
    }
    else
    {
    $version = $server.ServerVersion
    }
    
    # For Elastic database pool candidates, we exclude master, Premium SKU (P1 in previous version still qualifies), and any databases that are already in a pool. You may add more to the excluded list below as needed
    if ($version -in ("12.0", "Completed")) # This is on Azure Database V12. 
    {
    $ListOfDBs = Get-AzureSqlDatabase -ServerName $servername.Split('.')[0] -ResourceGroupName $ResourceGroupName | Where-Object {$_.DatabaseName -notin ("master") -and $_.CurrentServiceLevelObjectiveName -notin ("ElasticPool") -and $_.CurrentServiceLevelObjectiveName -notlike ("P*") -and $_.CurrentServiceObjectiveName -notin ("ElasticPool") -and $_.CurrentServiceObjectiveName -notlike ("P*")}
    }
    else # This is previous versions of Azure Database
    {
    $ListOfDBs = Get-AzureSqlDatabase -ServerName $servername.Split('.')[0] -ResourceGroupName $ResourceGroupName | Where-Object {$_.DatabaseName -notin ("master") -and $_.CurrentServiceLevelObjectiveName -notin ("ElasticPool", "P2", "P3") -and $_.CurrentServiceObjectiveName -notin ("ElasticPool", "P2", "P3")}
    }
    
    # Due to pricing model difference, we don't recommend to put less than 3 databases in a pool. 
    if ($ListOfDBs.Count -lt 3)
    {
    Write-Host "There are less than 3 qualified standalone databases in this server. Not a good candidate for Elastic Database Pool!" -ForegroundColor Red
    }
    
    $outputConnectionString = "Data Source=$outputServerName;Integrated Security=false;Initial Catalog=$outputdatabaseName;User Id=$outputDBUsername;Password=$outputDBpassword"
    $destinationTableName = "resource_stats_output"
    
    # Create a table in output database for metrics collection
    $sql = "
    IF  NOT EXISTS (SELECT * FROM sys.objects 
    WHERE object_id = OBJECT_ID(N'$($destinationTableName)') AND type in (N'U'))
    
    BEGIN
    Create Table $($destinationTableName) (database_name varchar(128), end_time datetime, avg_cpu float, avg_io float, avg_log float, db_size float);
    Create Clustered Index ci_endtime ON $($destinationTableName) (end_time);
    END
    TRUNCATE TABLE $($destinationTableName);
    "
    Invoke-Sqlcmd -ServerInstance $outputServerName -Database $outputdatabaseName -Username $outputDBUsername -Password $outputDBpassword -Query $sql -ConnectionTimeout 120 -QueryTimeout 120 
    
    # waittime (minutes) is interval between data collection queries in the loop below.
    $Waittime = 10
    $end_Time = [DateTime]::UtcNow
    $start_time = $end_time.AddMinutes(-$Waittime)
    $finish_time = $end_Time.AddMinutes($duration_minutes)
    
    While ($end_time -lt $finish_time)
    {
     foreach ($db in $ListOfDBs)
     {
    if ($version -in ("12.0", "Completed")) # for V12 databases 
    {
    $sql = "Declare @dbname varchar(128) = '$($db.DatabaseName)';"
    $sql += "Declare @SLO varchar(20) = '$($db.CurrentServiceLevelObjectiveName)';"
    $sql+= "
    Declare @DTU_cap int, @db_size float;
    Select @DTU_cap = CASE @SLO 
    WHEN 'Basic' THEN 5
    WHEN 'S0' THEN 10
    WHEN 'S1' THEN 20
    WHEN 'S2' THEN 50
    WHEN 'S3' THEN 100
    ELSE 50 -- assume Web/Business DBs
    END
    SELECT @db_size = SUM(reserved_page_count) * 8.0/1024/1024 FROM sys.dm_db_partition_stats
    SELECT @dbname as database_name, dateadd(second, round(datediff(second, '2015-01-01', end_time) / 15.0, 0) * 15,'2015-01-01')
    as end_time, avg_cpu_percent * (@DTU_cap/100.0) AS avg_cpu, avg_data_io_percent * (@DTU_cap/100.0) AS avg_io, avg_log_write_percent * (@DTU_cap/100.0) AS avg_log, @db_size as db_size FROM sys.dm_db_resource_stats
    WHERE end_time > '$($start_time)' and end_time <= '$($end_time)';
    " 
    }
    else
    {
    $sql = "Declare @dbname varchar(128) = '$($db.DatabaseName)';"
    $sql += "Declare @SLO varchar(20) = '$($db.CurrentServiceLevelObjectiveName)';"
    $sql+= "
    Declare @DTU_cap int, @db_size float;
    Select @DTU_cap = CASE @SLO 
    WHEN 'Basic' THEN 5
    WHEN 'S0' THEN 10
    WHEN 'S1' THEN 20
    WHEN 'S2' THEN 50
    WHEN 'P1' THEN 100 -- for old version of SQL database, P1 has same performance capacity as S3.
    ELSE 50 -- assume Web/Business DBs
    END
    SELECT @db_size = SUM(reserved_page_count) * 8.0/1024/1024 from sys.dm_db_partition_stats
    SELECT @dbname as database_name, dateadd(second, round(datediff(second, '2015-01-01', end_time) / 15.0, 0) * 15,'2015-01-01')
    as end_time, avg_cpu_percent * (@DTU_cap/100.0) AS avg_cpu, avg_data_io_percent * (@DTU_cap/100.0) AS avg_io, avg_log_write_percent * (@DTU_cap/100.0) AS avg_log, @db_size as db_size FROM sys.dm_db_resource_stats
    WHERE end_time > '$($start_time)' and end_time <= '$($end_time)';
    " 
    }
    #write-host $sql
    
    $result = Invoke-Sqlcmd -ServerInstance $servername -Database $db.DatabaseName -Username $username -Password $serverPassword -Query $sql -ConnectionTimeout 120 -QueryTimeout 3600 
    #bulk copy the metrics to output database
    $bulkCopy = new-object ("Data.SqlClient.SqlBulkCopy") $outputConnectionString 
    $bulkCopy.BulkCopyTimeout = 600
    $bulkCopy.DestinationTableName = "$destinationTableName";
    $bulkCopy.WriteToServer($result);
    
     }
    
     $start_time = $start_time.AddMinutes($Waittime)
     $end_time = $end_time.AddMinutes($Waittime)
     Write-Host $start_time
     Write-Host $end_time
     do {
    Start-Sleep 1
    }
    until (([DateTime]::UtcNow) -ge $end_time)
    }
    
    
    # Analysis query that does aggregation of the resource metrics to calculate pool size.
    $sql = 'Declare @DTU_Perf_99 as float, @DTU_Storage as float;
    WITH group_stats AS
    (
    SELECT end_time, SUM(db_size) AS avg_group_Storage, SUM(avg_cpu) AS avg_group_cpu, SUM(avg_io) AS avg_group_io,SUM(avg_log) AS avg_group_log
    FROM resource_stats_output
    GROUP BY end_time
    )
    -- calculate aggregate storage and DTUs for all DBs in the group
    , group_DTU AS
    (
    SELECT end_time, avg_group_Storage, 
    (SELECT Max(v)
       FROM (VALUES (avg_group_cpu), (avg_group_log), (avg_group_io)) AS value(v)) AS avg_group_DTU
    FROM group_stats
    )
    -- Get top 1 percent of the storage and DTU utilization samples.
    , top1_percent AS (
    SELECT TOP 1 PERCENT avg_group_Storage, avg_group_dtu FROM group_dtu ORDER BY [avg_group_DTU] DESC
    )
    
    -- Max and 99th percentile DTU for the given list of databases if converted into an elastic pool. Storage is increased by factor of 1.25 to accommodate for future growth. Currently storage limit of the pool is determined by the amount of DTUs based on 1GB/DTU.
    --SELECT MAX(avg_group_Storage)*1.25/1024.0 AS Group_Storage_DTU, MAX(avg_group_dtu) AS Group_Performance_DTU, MIN(avg_group_dtu) AS Group_Performance_DTU_99th_percentile FROM top1_percent;
    SELECT @DTU_Storage = MAX(avg_group_Storage)*1.25/1024.0, @DTU_Perf_99 = MIN(avg_group_dtu) FROM top1_percent;
    IF @DTU_Storage > @DTU_Perf_99 
    SELECT @DTU_Storage AS "Pool Size DTU dominated by storage"
    ELSE 
    SELECT @DTU_Perf_99 AS "Pool Size DTU dominated by resource consumption";'
    
    #write-host $sql
    Invoke-Sqlcmd -ServerInstance $outputServerName -Database $outputdatabaseName -Username $outputDBUsername -Password $outputDBpassword -Query $sql -QueryTimeout 3600
    
    

## Сводка

Не все отдельные базы данных являются оптимальными кандидатами на включение в пулы эластичных баз данных. Базы данных с закономерностями использования, которые характеризуются низким средним уровнем использования и относительно редкими пиками использования, прекрасно подходят для включения в пул эластичных БД. Закономерности использования приложений являются динамическими, поэтому используйте информацию и инструменты, описанные в данной статье, чтобы выполнить первоначальную оценку и понять, является ли пул эластичных баз данных хорошим вариантом для некоторых или всех ваших баз данных. В этой статье представлены лишь начальные данные, которые помогут вам принять решение, подходит вам или нет пул эластичных баз данных. Помните, что следует постоянно отслеживать использование ресурсов за прошедшие периоды времени (с помощью STA или DMVs) и выполнять переоценку уровней производительности всех ваших баз данных. Не забывайте, что можно легко перемещать базы данных в пул эластичных БД и из него, и, если у вас очень много баз данных, можно иметь несколько пулов различного размера, между которыми можно разделить свои базы данных.



<!--Image references-->
[1]: ./media/sql-database-elastic-pool-guidance/one-database.png
[2]: ./media/sql-database-elastic-pool-guidance/four-databases.png
[3]: ./media/sql-database-elastic-pool-guidance/twenty-databases.png

<!---HONumber=July15_HO2-->