---
title: "Приступая к работе с аудитом базы данных SQL | Документация Майкрософт"
description: "Приступая к работе с аудитом базы данных SQL"
services: sql-database
documentationcenter: 
author: ronitr
manager: jhubbard
editor: giladm
ms.assetid: 89c2a155-c2fb-4b67-bc19-9b4e03c6d3bc
ms.service: sql-database
ms.custom: secure and protect
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/05/2016
ms.author: ronitr; giladm
translationtype: Human Translation
ms.sourcegitcommit: 1793c49627fd45a28d6b707466b472082f904e1f
ms.openlocfilehash: 0188ef05673e539d4e02998fdeae4badddb1ca52


---
# <a name="get-started-with-sql-database--auditing"></a>Приступая к работе с аудитом базы данных SQL
Аудит базы данных SQL Azure позволяет отслеживать события базы данных и записывать их в журнал аудита в учетной записи хранения Azure.

Аудит может помочь вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности.

Средства аудита способствуют соблюдению стандартов соответствия, но не гарантируют их выполнение. Дополнительную информацию о программах Azure, поддерживающих проверку соблюдения стандартов, см. в [Центре управления безопасностью Azure](https://azure.microsoft.com/support/trust-center/compliance/).

* [Обзор аудита баз данных SQL Azure]
* [Настройка аудита базы данных]
* [Анализ журналов и отчетов аудита]

## <a name="a-idsubheading-1aazure-sql-database-auditing-overview"></a><a id="subheading-1"></a>Обзор аудита баз данных SQL Azure
Аудит базы данных SQL позволяет:

* **Сохранить** журнал аудита выбранных событий. Вы можете указать, какие категории действий базы данных должны проходить аудит.
* **Создавать отчеты** по действиям, производимым с базой данных. Вы можете использовать предварительно настроенные отчеты и панель мониторинга для быстрого начала работы с отчетностью по действиям и событиям.
* **Анализировать** отчеты. Вы можете искать подозрительные события, необычную деятельность и тенденции.

Существует два **метода аудита**:

* **Аудит BLOB-объектов**: журналы записываются в хранилище BLOB-объектов Azure. Это более новый метод аудита, который обеспечивает **более высокую производительность**, поддерживает **более высокую детализацию аудита на уровне объекта** и **является более экономически эффективным**.
* **Аудит таблиц**: журналы записываются в хранилище таблиц Azure.

> [!IMPORTANT]
> Из-за нового аудита BLOB-объектов база данных иначе наследует политику аудита сервера. Дополнительные сведения см. в разделе [Различия между BLOB-объектами и таблицами при наследовании политики аудита сервера](#subheading-8).

Аудит можно настроить для различных типов категорий событий (см. раздел [Настройка аудита базы данных](#subheading-2)).

<!--For each Event Category, auditing of **Success** and **Failure** operations are configured separately.-->

Политику аудита можно определить для конкретной базы данных или как политику сервера по умолчанию. Политика аудита сервера по умолчанию применяется ко всем существующим и вновь создаваемым базам данных на сервере.

## <a name="a-idsubheading-2aset-up-auditing-for-your-database"></a><a id="subheading-2"></a>Настройка аудита базы данных
В следующих разделах описывается настройка аудита на портале Azure.

### <a name="a-idsubheading-2-1blob-auditinga"></a><a id="subheading-2-1">Аудит больших двоичных объектов</a>
1. Откройте [портал Azure](https://portal.azure.com) по адресу https://portal.azure.com.
2. Перейдите в колонку параметров базы данных SQL или SQL Server, где нужно выполнить аудит. В колонке "Параметры" выберите **Аудит и обнаружение угроз**.

    <a id="auditing-screenshot"></a>
    ![Область навигации][1]
3. В колонке для настройки аудита базы данных можно установить флажок **Наследовать настройки от сервера**. Это означает, что аудит базы данных будет выполняться в соответствии с настройками сервера. Установив этот флажок, вы увидите ссылку **Просмотр настроек аудита сервера**, позволяющую просмотреть или изменить настройки аудита сервера.

    ![Область навигации][2]
4. Если вы хотите включить аудит BLOB-объектов на уровне базы данных (в дополнение или вместо аудита на уровне сервера), **снимите** флажок **Наследовать настройки аудита от сервера**, **включите** аудит и выберите тип аудита **Аудит BLOB-объектов**.

   > Если включен аудит BLOB-объектов сервера, настроенный аудит для базы данных будет существовать параллельно с ним.  

    ![Область навигации][3]
5. Выберите **Сведения о хранилище** , чтобы открыть колонку хранилища журналов аудита. Выберите учетную запись хранения Azure, в которой будут сохраняться журналы, и срок хранения, по истечении которого старые журналы будут удалены. Затем нажмите кнопку **ОК** внизу. **Совет.** Для того чтобы в полной мере воспользоваться возможностями шаблонов отчетов об аудите, используйте одну и ту же учетную запись хранения для всех баз данных.

    <a id="storage-screenshot"></a>
    ![Область навигации][4]
6. Если вы хотите настроить события аудита, это можно сделать с помощью PowerShell или REST API. Дополнительные сведения см. в разделе [Автоматизация (PowerShell или REST API)](#subheading-7).
7. Щелкните **Сохранить**.

### <a name="a-idsubheading-2-2table-auditinga"></a><a id="subheading-2-2">Аудит таблиц</a>

> Перед настройкой **аудита таблиц** проверьте, пользуетесь ли вы ["клиентом нижнего уровня"](sql-database-auditing-and-dynamic-data-masking-downlevel-clients.md). Кроме того, если установлены строгие параметры брандмауэра, учтите, что при включении аудита таблиц [IP-адрес конечной точки базы данных изменится](sql-database-auditing-and-dynamic-data-masking-downlevel-clients.md).


1. Откройте [портал Azure](https://portal.azure.com) по адресу https://portal.azure.com.
2. Перейдите в колонку параметров базы данных SQL или SQL Server, где нужно выполнить аудит. В колонке "Параметры" выберите **Аудит и обнаружение угроз** (*[см. снимок экрана в разделе "Аудит BLOB-объектов"](#auditing-screenshot)*).
3. В колонке для настройки аудита базы данных можно установить флажок **Наследовать настройки от сервера**. Это означает, что аудит базы данных будет выполняться в соответствии с настройками сервера. Установив этот флажок, вы увидите ссылку **Просмотр настроек аудита сервера**, позволяющую просмотреть или изменить настройки аудита сервера.

    ![Область навигации][2]
4. Если вы не хотите наследовать настройки аудита от сервера, **снимите** флажок **Наследовать настройки аудита от сервера**, **включите** аудит и выберите тип аудита **Аудит таблиц**.

    ![Область навигации][3-tbl]
5. Выберите **Сведения о хранилище** , чтобы открыть колонку хранилища журналов аудита. Выберите учетную запись хранения Azure, в которой будут сохраняться журналы, и срок хранения, по истечении которого старые журналы будут удалены. **Совет.** Для того чтобы в полной мере воспользоваться возможностями шаблонов отчетов об аудите, используйте одну и ту же учетную запись хранения для всех баз данных (*[см. снимок экрана в разделе "Аудит BLOB-объектов"](#storage-screenshot)*).
6. Щелкните **События аудита** , чтобы указать, какие события требуют аудита. В колонке **Журнал событий** щелкните **Успех** и **Отказ**, чтобы включить в журнал все события, или выберите отдельные категории событий.

   > Настройку событий аудита также можно выполнить с помощью PowerShell или REST API. Дополнительные сведения см. в разделе [Автоматизация (PowerShell или REST API)](#subheading-7).

    ![Область навигации][5]
7. После настройки параметров аудита можно включить новую функцию **Обнаружение угроз** (предварительная версия) и указать адреса электронной почты для получения предупреждений системы безопасности. Функция "Обнаружение угроз" позволяет настроить упреждающие оповещения об аномальной активности в базах данных, которая может указывать на потенциальные угрозы безопасности. Дополнительные сведения см. в статье [Приступая к работе с системой обнаружения угроз](sql-database-threat-detection-get-started.md).
8. Щелкните **Сохранить**.


## <a name="a-idsubheading-8ablobtable-differences-in-server-auditing-policy-inheritance"></a><a id="subheading-8"></a>Различия между BLOB-объектами и таблицами при наследовании политики аудита сервера

###<a name="ablob-auditinga"></a><a>Аудит больших двоичных объектов</a>

1. Если **для сервера включен аудит BLOB-объектов**, он **всегда применяется к базе данных** (т. е. выполняется аудит базы данных). Это поведение не зависит от следующих параметров:
    - настройки аудита для базы данных;
    - положение флажка "Наследовать настройки от сервера" в колонке базы данных.

2. Если аудит BLOB-объектов включен для сервера, то его включение для базы данных **не** приводит к переопределению или изменению настроек аудита BLOB-объектов, установленных для сервера. Оба аудита будут выполняться независимо друг от друга. Таким образом, аудит базы данных будет выполняться дважды: один раз в соответствии с политикой сервера и еще раз в соответствии с политикой базы данных.

    > [!NOTE]
    > Не устанавливайте политику аудита BLOB-объектов одновременно для сервера и базы данных, за исключением следующих случаев.
    > * Если для определенной базы данных нужно использовать другую *учетную запись хранения* или другой *срок хранения*.
    > * Если для определенной базы данных вам нужен аудит типов или категорий событий, отличных от параметров аудита для остальных баз данных на этом сервере (например, если аудит вставки данных будет выполняться только для одной конкретной базы данных).
    > <br><br>
    > Во всех остальных случаях **мы рекомендуем включать аудит BLOB-объектов только на уровне сервера**, а на уровне баз данных отключить все параметры аудита для всех баз данных.

###<a name="atable-auditinga"></a><a>Аудит таблиц</a>

Если **аудит таблиц включен на уровне сервера**, он применяется только к тем базам данных, для которых в колонке базы данных установлен флажок "Наследовать настройки от сервера" (он установлен по умолчанию для всех существующих и создаваемых баз данных).

- Если этот флажок *установлен*, любые настройки аудита, установленные для базы данных, **переопределяют** параметры, установленные для этой базы данных на уровне сервера.

- Если флажок *снят*, а аудит на уровне базы данных отключен, для этой базы данных аудит выполняться не будет.

## <a name="a-idsubheading-3aanalyze-audit-logs-and-reports"></a><a id="subheading-3"></a>Анализ журналов и отчетов аудита
Журналы аудита объединяются в учетной записи хранения Azure, выбранной на этапе настройки.

Журналы аудита можно просматривать с помощью таких инструментов, как [обозреватель хранилищ Azure](http://storageexplorer.com/).

Ниже описаны особенности анализа журналов аудита для **BLOB-объектов** и **таблиц**.

### <a name="a-idsubheading-3-1blob-auditinga"></a><a id="subheading-3-1">Аудит больших двоичных объектов</a>
Журналы аудита BLOB-объектов сохраняются в виде коллекции файлов BLOB-объектов в контейнере с именем **sqldbauditlogs**.

Дополнительные сведения об иерархии папок для хранения журналов аудита BLOB-объектов, соглашении об именовании BLOB-объектов и формате журнала см. в [Справочнике по формату журнала аудита (скачать DOC-файл)](https://go.microsoft.com/fwlink/?linkid=829599).

Просмотреть журналы аудита BLOB-объектов можно несколькими способами:

1. На [портале Azure](https://portal.azure.com) откройте соответствующую базу данных. В верхней части колонки **Аудит и обнаружение угроз** щелкните **Просмотр журналов аудита**.

    ![Область навигации][10]

    Откроется колонка **Записи аудита**, в которой вы сможете просматривать журналы.

    - Для просмотра записей за определенную дату щелкните **Фильтр** в верхней части колонки записей аудита.
    - Можно переключаться между записями аудита, которые создаются политиками аудита для сервера и для базы данных.

    ![Область навигации][11]
2. Скачайте файлы журналов из контейнера BLOB-объектов хранилища Azure из портала или с помощью [Обозревателя хранилища Azure](http://storageexplorer.com/).

    После загрузки файла дважды щелкните по нему, чтобы открыть, просмотреть и проанализировать файл в среде SSMS.

    Дополнительные методы

   * В обозревателе хранилища Azure можно **скачать нескольких файлов одновременно**. Для этого щелкните правой кнопкой мыши по необходимой вложенной папке (например, по вложенной папке, включающей все файлы журнала для определенной даты) и выберите "Сохранить как", чтобы сохранить файлы журнала в локальной папке.

       Загрузив несколько файлов (или файлы за весь день, как описано выше), их можно объединить локально следующим образом:

       **Откройте SSMS и выберите "Файл" -> "Открыть" -> "Объединить расширенные события". Затем укажите все файлы для слияния**
   * Программным способом:

     * **Библиотека C#** для считывания расширенных событий ([дополнительные сведения](https://blogs.msdn.microsoft.com/extended_events/2011/07/20/introducing-the-extended-events-reader/))
     * Запросы к файлам расширенных событий с помощью **PowerShell** ([дополнительные сведения](https://sqlscope.wordpress.com/2014/11/15/reading-extended-event-files-using-client-side-tools-only/))

3. Вы создали **образец приложения**, которое выполняется в Azure и использует общедоступные API OMS для отправки в OMS журналов аудита SQL, где их можно затем обрабатывать через панель мониторинга OMS ([дополнительные данные см. здесь](https://github.com/Microsoft/Azure-SQL-DB-auditing-OMS-integration)).

### <a name="a-idsubheading-3-2table-auditinga"></a><a id="subheading-3-2">Аудит таблиц</a>
Журналы аудита таблиц сохраняются в виде коллекции таблиц службы хранилища Azure с префиксом **SQLDBAuditLogs**.

Дополнительные сведения о формате журнала аудита таблиц см. в [Справочнике по формату журнала аудита таблиц (скачать DOC-файл)](http://go.microsoft.com/fwlink/?LinkId=506733).

Просмотреть журналы аудита таблиц можно несколькими способами:

1. На [портале Azure](https://portal.azure.com) откройте соответствующую базу данных. В верхней части колонки **Аудит и обнаружение угроз** щелкните **Просмотр журналов аудита**.

    ![Область навигации][10]

    Откроется колонка **Записи аудита**, в которой вы сможете просматривать журналы.

    * Для просмотра записей за определенную дату щелкните **Фильтр** в верхней части колонки записей аудита.
    * Можно скачать и просмотреть журналы аудита в формате Excel, щелкнув **Открыть в Excel** в верхней части колонки записей аудита.

    ![Область навигации][12]

2. Кроме того, можно воспользоваться предварительно настроенным шаблоном, который доступен в виде [таблицы Excel](http://go.microsoft.com/fwlink/?LinkId=403540). Он быстро проанализировать данные журнала. Для того, чтобы использовать шаблон с вашими журналами аудита, вам потребуется Excel 2013 и выше и Power Query, который можно загрузите по [этой ссылке](http://www.microsoft.com/download/details.aspx?id=39379).

    Помимо этого, можно импортировать журналы аудита в шаблон Excel непосредственно из учетной записи хранения Azure с помощью Power Query. После этого вы сможете просматривать записи аудита и создавать панели управления и отчеты на основе данных журнала.

    ![Область навигации][9]

## <a name="a-idsubheading-5apractices-for-usage-in-production"></a><a id="subheading-5"></a>Рекомендации по использованию в рабочей среде
<!--The description in this section refers to screen captures above.-->

### <a name="a-idsubheading-6auditing-geo-replicated-databasesa"></a><a id="subheading-6">Аудит географически реплицированных баз данных</a>
При использовании географически реплицированных баз данных можно настроить аудит для базы данных-источника, базы данных-получателя или для обеих баз данных в зависимости от типа аудита.

**Аудит таблиц**: вы можете настроить отдельную политику на уровне базы данных или на уровне сервера для каждой из двух баз данных (источника и получателя). Дополнительные сведения см. в разделе [Настройка аудита базы данных](#subheading-2-2).

**Аудит BLOB-объектов**: выполните следующие действия.

1. **База данных-источник**: включите **аудит BLOB-объектов** на сервере или базе данных, как описано в разделе [Настройка аудита базы данных](#subheading-2-1).
2. **База данных-получатель**: аудит BLOB-объектов можно включить и выключить только в параметрах аудита базы данных-источника.

   * Включите **аудит BLOB-объектов** для **базы данных-источника**, как описано в разделе [Настройка аудита базы данных](#subheading-2-1). Аудит BLOB-объектов нужно включать для самой *базы данных-источника*, а не для сервера.
   * После включения аудита BLOB-объектов в базе данных-источнике он станет доступным в базе данных-получателе.

    > [!IMPORTANT]
    > По умолчанию **настройки хранилища** для базы данных-получателя будут совпадать с настройками для базы данных-источника, что приведет к появлению **трафика между регионами**. Чтобы избежать этого, включите аудит BLOB-объектов на **сервере-получателе** и настройте **локальное хранилище** в параметрах хранилища сервера-получателя. Такая настройка переопределит место хранения для базы данных-получателя, и в результате каждая база данных будет хранить журналы аудита в своем локальном хранилище.  

<br>

### <a name="a-idsubheading-6storage-key-regenerationa"></a><a id="subheading-6">Повторное создание ключа хранилища</a>
Обычно в рабочей среде приходится периодически обновлять ключи хранилища. При обновлении ключей необходимо повторно сохранить политику аудита. Процесс таков:

1. В колонке "Сведения об аудите" измените значение параметра **Ключ доступа к хранилищу** с *Источник* на *Получатель* и нажмите кнопку **OK**. Затем щелкните **СОХРАНИТЬ** в верхней части колонки настройки аудита.

    ![Область навигации][6]
2. Перейдите в колонку конфигурации хранилища и **повторно создайте***первичный ключ доступа*.

    ![Область навигации][8]
3. Вернитесь в колонку настройки аудита, измените значение параметра **Ключ доступа к хранилищу** с *Получатель* на *Источник* и нажмите кнопку **ОК** внизу. Затем щелкните **СОХРАНИТЬ** в верхней части колонки настройки аудита.
4. Вернитесь в колонку настройки хранилища и **повторно создайте***ключ доступа получателя* (для подготовки к следующему циклу обновления ключей).

## <a name="a-idsubheading-7aautomation-powershell--rest-api"></a><a id="subheading-7"></a>Автоматизация (PowerShell или REST API)
Аудит в базе данных SQL Azure также можно настроить с помощью следующих средств автоматизации:

1. **Командлеты PowerShell**

   * [Get-AzureRMSqlDatabaseAuditingPolicy][101]
   * [Get-AzureRMSqlServerAuditingPolicy][102]
   * [Remove-AzureRMSqlDatabaseAuditing][103]
   * [Remove-AzureRMSqlServerAuditing][104]
   * [Set-AzureRMSqlDatabaseAuditingPolicy][105]
   * [Set-AzureRMSqlServerAuditingPolicy][106]
   * [Use-AzureRMSqlServerAuditingPolicy][107]
2. **REST API — аудит BLOB-объектов**

   * [Создание или обновление политики аудита BLOB-объектов базы данных](https://msdn.microsoft.com/en-us/library/azure/mt695939.aspx)
   * [Создание или обновление политики аудита BLOB-объектов сервера](https://msdn.microsoft.com/en-us/library/azure/mt771861.aspx)
   * [Получение политики аудита BLOB-объектов базы данных](https://msdn.microsoft.com/en-us/library/azure/mt695938.aspx)
   * [Получение политики аудита BLOB-объектов сервера](https://msdn.microsoft.com/en-us/library/azure/mt771860.aspx)
   * [Получение результата операции аудита для BLOB-объектов сервера](https://msdn.microsoft.com/en-us/library/azure/mt771862.aspx)
3. **REST API — аудит таблиц**

   * [Создание или обновление политики аудита базы данных](https://msdn.microsoft.com/en-us/library/azure/mt604471.aspx)
   * [Создание или обновление политики аудита сервера](https://msdn.microsoft.com/en-us/library/azure/mt604383.aspx)
   * [Получение политики аудита базы данных](https://msdn.microsoft.com/en-us/library/azure/mt604381.aspx)
   * [Получение политики аудита сервера](https://msdn.microsoft.com/en-us/library/azure/mt604382.aspx)

<!--Anchors-->
[Обзор аудита баз данных SQL Azure]: #subheading-1
[Настройка аудита базы данных]: #subheading-2
[Анализ журналов и отчетов аудита]: #subheading-3
[Practices for usage in production]: #subheading-5
[Storage Key Regeneration]: #subheading-6
[Automation (PowerShell / REST API)]: #subheading-7
[Blob/Table differences in Server auditing policy inheritance]: (#subheading-8)  

<!--Image references-->
[1]: ./media/sql-database-auditing-get-started/1_auditing_get_started_settings.png
[2]: ./media/sql-database-auditing-get-started/2_auditing_get_started_server_inherit.png
[3]: ./media/sql-database-auditing-get-started/3_auditing_get_started_turn_on.png
[3-tbl]: ./media/sql-database-auditing-get-started/3_auditing_get_started_turn_on_table.png
[4]: ./media/sql-database-auditing-get-started/4_auditing_get_started_storage_details.png
[5]: ./media/sql-database-auditing-get-started/5_auditing_get_started_audited_events.png
[6]: ./media/sql-database-auditing-get-started/6_auditing_get_started_storage_key_regeneration.png
[7]: ./media/sql-database-auditing-get-started/7_auditing_get_started_activity_log.png
[8]: ./media/sql-database-auditing-get-started/8_auditing_get_started_regenerate_key.png
[9]: ./media/sql-database-auditing-get-started/9_auditing_get_started_report_template.png
[10]: ./media/sql-database-auditing-get-started/10_auditing_get_started_blob_view_audit_logs.png
[11]: ./media/sql-database-auditing-get-started/11_auditing_get_started_blob_audit_records.png
[12]: ./media/sql-database-auditing-get-started/12_auditing_get_started_table_audit_records.png

[101]: https://msdn.microsoft.com/en-us/library/azure/mt603731(v=azure.200).aspx
[102]: https://msdn.microsoft.com/en-us/library/azure/mt619329(v=azure.200).aspx
[103]: https://msdn.microsoft.com/en-us/library/azure/mt603796(v=azure.200).aspx
[104]: https://msdn.microsoft.com/en-us/library/azure/mt603574(v=azure.200).aspx
[105]: https://msdn.microsoft.com/en-us/library/azure/mt603531(v=azure.200).aspx
[106]: https://msdn.microsoft.com/en-us/library/azure/mt603794(v=azure.200).aspx
[107]: https://msdn.microsoft.com/en-us/library/azure/mt619353(v=azure.200).aspx



<!--HONumber=Feb17_HO1-->


