<properties 
   pageTitle="Аварийное восстановление базы данных SQL" 
   description="Информация о восстановлении базы данных после сбоя регионального центра обработки данных с помощью георепликации и геовосстановления базы данных SQL Azure." 
   services="sql-database" 
   documentationCenter="" 
   authors="elfisher" 
   manager="jeffreyg" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-management" 
   ms.date="07/14/2015"
   ms.author="elfish"/>

# Восстановление базы данных SQL Azure после сбоя

Базу данных SQL Azure после сбоя можно восстановить несколькими способами:

- активная георепликация [(блог)](http://azure.microsoft.com/blog/2014/07/12/spotlight-on-sql-database-active-geo-replication/);
- стандартная георепликация [(блог)](http://azure.microsoft.com/blog/2014/09/03/azure-sql-database-standard-geo-replication/);
- геовосстановление [(блог)](http://azure.microsoft.com/blog/2014/09/13/azure-sql-database-geo-restore/).

Информацию о подготовке к аварии и времени восстановления базы данных см. на нашей странице [проекта обеспечения непрерывности бизнес-процессов](sql-database-business-continuity-design.md).

##Время начала восстановления 

Операция восстановления влияет на приложение. Для выполнения этой операции необходимо изменить строку подключения SQL, и она может привести к безвозвратной потере данных. Поэтому следует выполнять ее, только если сбой будет длиться дольше, чем целевое время восстановления (RTO) приложения. При развертывании приложения в рабочей среде следует выполнять регулярное отслеживание работоспособности приложений и использовать следующие точки данных для подтверждения гарантированного восстановления.

1. Постоянная ошибка подключения из уровня приложения к базе данных.
2. На портале Azure отображается предупреждение об инциденте в регионе с широким диапазоном влияния.

## Отработка отказа с помощью базы данных-получателя, восстановленной с помощью георепликации
> [AZURE.NOTE]Настройте [Стандартную георепликацию](https://msdn.microsoft.com/library/azure/dn758204.aspx) или [Активную георепликацию](https://msdn.microsoft.com/library/azure/dn741339.aspx), чтобы получить базу данных-получателя для отработки отказа. Георепликация доступна только для баз данных Standard и Premium.

В случае сбоя базы данных-источника вы можете отработать отказ с помощью базы данных-получателя для восстановления доступности. Чтобы сделать это, необходимо принудительно завершить связь непрерывной копии. Полное описание завершения связи непрерывной копии см. [здесь](https://msdn.microsoft.com/library/azure/dn741323.aspx).



###Портал Azure
1. Войдите на [портал Azure](https://portal.Azure.com).
2. В левой части экрана выберите **ОБЗОР**, а затем — **Базы данных SQL**.
3. Перейдите к нужной базе данных и выберите ее. 
4. В нижней части колонки базы данных выберите **Карта георепликации**.
4. В разделе **Базы данных-получатели** щелкните правой кнопкой мыши строку с именем базы данных, которую требуется восстановить, и выберите **Остановить**.

После завершения связи непрерывной копии вы можете настроить восстановленную базу данных. Для этого следуйте инструкциям руководства [Завершение восстановленной базы данных](sql-database-recovered-finalize.md).
###PowerShell
Используйте PowerShell для программного восстановления базы данных.

Чтобы прекратить связь из базы данных-получателя, используйте командлет [Stop-AzureSqlDatabaseCopy](https://msdn.microsoft.com/library/dn720223).
		
		$myDbCopy = Get-AzureSqlDatabaseCopy -ServerName "SecondaryServerName" -DatabaseName "SecondaryDatabaseName"
		$myDbCopy | Stop-AzureSqlDatabaseCopy -ServerName "SecondaryServerName" -ForcedTermination
		 
После завершения связи непрерывной копии вы можете настроить восстановленную базу данных для использования. Для этого следуйте инструкциям руководства [Завершение восстановленной базы данных](sql-database-recovered-finalize.md).
###REST API 
Используйте REST для программного восстановления базы данных.

1. Создайте непрерывное копирование базы данных с помощью операции [Создать копирование базы данных](https://msdn.microsoft.com/library/azure/dn509570.aspx).
2. Остановите непрерывное копирование базы данных с помощью операции [Остановить копирование базы данных](https://msdn.microsoft.com/library/azure/dn509573.aspx). Используйте имя сервера-получателя и имя базы данных-получателя в запросе URI "Остановить копирование базы данных".

 После завершения связи непрерывной копии вы можете настроить восстановленную базу данных. Для этого следуйте инструкциям руководства [Завершение восстановленной базы данных](sql-database-recovered-finalize.md).
## Восстановление с использованием геовосстановления

В случае сбоя базы данных вы можете восстановить базу данных из последней избыточной резервной копии геообъекта с помощью геовосстановления.

> [AZURE.NOTE]При восстановлении базы данных создается новая база данных. Важно убедиться, что на сервере, куда выполняется восстановление, имеется достаточный объем DTU для новой базы данных. Можно [обратиться в службу поддержки](http://azure.microsoft.com/blog/azure-limits-quotas-increase-requests/) с просьбой увеличить квоту.

###Портал Azure
1. Войдите на портал [Azure](https://portal.Azure.com).
2. В левой части экрана последовательно выберите **СОЗДАТЬ**, **Данные и хранилище**, **База данных SQL**.
2. Выберите **РЕЗЕРВНАЯ КОПИЯ** в качестве источника, затем выберите избыточную резервную копию геообъекта, из которой вы хотите восстановить базу данных.
3. Укажите остальные свойства базы данных и нажмите кнопку **Создать**.
4. Начнется процесс восстановления базы данных, который можно отслеживать с помощью **УВЕДОМЛЕНИЙ** в левой части экрана.

После восстановления базы данных вы можете настроить ее для использования. Для этого следуйте инструкциям руководства [Завершение восстановленной базы данных](sql-database-recovered-finalize.md).
###PowerShell 
Используйте PowerShell для программного восстановления базы данных.

Чтобы запустить запрос на геовосстановление, используйте командлет [AzureSqlDatabaseRecovery](https://msdn.microsoft.com/library/azure/dn720224.aspx). Пошаговую инструкцию см. в [видеоинструкции](http://azure.microsoft.com/documentation/videos/restore-a-sql-database-using-geo-restore-with-microsoft-azure-powershell/).

		$Database = Get-AzureSqlRecoverableDatabase -ServerName "ServerName" –DatabaseName “DatabaseToBeRecovered"
		$RecoveryRequest = Start-AzureSqlDatabaseRecovery -SourceDatabase $Database –TargetDatabaseName “NewDatabaseName” –TargetServerName “TargetServerName”
		Get-AzureSqlDatabaseOperation –ServerName "TargetServerName" –OperationGuid $RecoveryRequest.RequestID

После восстановления базы данных вы можете настроить ее для использования. Для этого следуйте инструкциям руководства [Завершение восстановленной базы данных](sql-database-recovered-finalize.md).
###REST API 

Используйте REST для программного восстановления базы данных.

1.	Получите список баз данных, доступных для восстановления, используя операцию [List Recoverable Databases](http://msdn.microsoft.com/library/azure/dn800984.aspx)
	
2.	Получите базу данных, которую необходимо восстановить, используя операцию [Get Recoverable Database](http://msdn.microsoft.com/library/azure/dn800985.aspx).
	
3.	Создайте запрос на восстановление, используя операцию [Create Database Recovery Request](http://msdn.microsoft.com/library/azure/dn800986.aspx).
	
4.	Отслеживайте состояние восстановления, используя операцию [Database Operation Status](http://msdn.microsoft.com/library/azure/dn720371.aspx).

После восстановления базы данных вы можете настроить ее для использования. Для этого следуйте инструкциям руководства [Завершение восстановленной базы данных](sql-database-recovered-finalize.md).
 

<!---HONumber=Oct15_HO3-->