<properties 
   pageTitle="Аварийное восстановление Базы данных SQL" 
   description="Информация о восстановлении базы данных после сбоя регионального центра обработки данных с помощью активной георепликации, стандартной георепликации и геовосстановления Базы данных SQL Azure." 
   services="sql-database" 
   documentationCenter="" 
   authors="elfisher" 
   manager="jeffreyg" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-management" 
   ms.date="11/09/2015"
   ms.author="elfish"/>

# Восстановление базы данных SQL Azure после сбоя

Базы данных SQL Azure предоставляют следующие возможности для восстановления после сбоя:

- активная георепликация [(блог)](http://azure.microsoft.com/blog/2014/07/12/spotlight-on-sql-database-active-geo-replication/);
- стандартная георепликация [(блог)](http://azure.microsoft.com/blog/2014/09/03/azure-sql-database-standard-geo-replication/);
- геовосстановление [(блог)](http://azure.microsoft.com/blog/2014/09/13/azure-sql-database-geo-restore/).
- Новые возможности георепликации [(блог)](https://azure.microsoft.com/blog/azure-sql-database-geo-replication-october-2015-update/)

Информацию о подготовке к аварии и времени восстановления базы данных см. на нашей странице [проекта обеспечения непрерывности бизнес-процессов](sql-database-business-continuity-design.md).

##Время начала восстановления 

Операция восстановления влияет на приложение. Для выполнения этой операции необходимо изменить строку подключения SQL, и она может привести к безвозвратной потере данных. Поэтому следует выполнять ее, только если сбой будет длиться дольше, чем целевое время восстановления (RTO) приложения. При развертывании приложения в рабочей среде следует выполнять регулярное отслеживание работоспособности приложений и использовать следующие точки данных для подтверждения гарантированного восстановления.

1. Постоянная ошибка подключения из уровня приложения к базе данных.
2. На классическом портале Azure отображается предупреждение об инциденте в регионе с широким диапазоном влияния.

> [AZURE.NOTE]После восстановления базы данных вы можете настроить ее для использования, следуя инструкциям руководства по [настройке базы данных после восстановления](#postrecovery).

## Отработка отказа с помощью геореплицируемой базы данных-получателя
> [AZURE.NOTE]Чтобы использовать отработку отказа, необходимо настроить базу данных-получатель. Георепликация доступна только для баз данных Standard и Premium. Узнайте, как [настроить георепликацию](sql-database-business-continuity-design.md).

###Классический портал Azure
Классический портал Azure позволяет прекратить связь непрерывной копии с базой данных-получателем, восстановленной с помощью географической репликации.

1. Перейдите на [классический портал Azure](https://portal.Azure.com).
2. В левой части экрана выберите **ОБЗОР**, а затем — **Базы данных SQL**.
3. Перейдите к нужной базе данных и выберите ее. 
4. В нижней части колонки базы данных выберите **Карта георепликации**.
4. В разделе **Базы данных-получатели** щелкните правой кнопкой мыши строку с именем базы данных, которую требуется восстановить, и выберите **Отработка отказа**.

###PowerShell
С помощью PowerShell инициируйте отработку отказа на геореплицируемую базу данных-получатель с помощью командлета [Set-AzureRMSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt619393.aspx).
		
		$database = Get-AzureRMSqlDatabase –DatabaseName "mydb” –ResourceGroupName "rg2” –ServerName "srv2”
		$database | Set-AzureRMSqlDatabaseSecondary –Failover -AllowDataLoss

###Интерфейс REST API 
Используйте REST, чтобы программно инициировать отработку отказа на базу данных-получатель.

1. Получите связь репликации для конкретной базы данных-получателя с помощью операции [Get Replication Link](https://msdn.microsoft.com/library/mt600778.aspx).
2. Выполните отработку отказа на базу данных-получатель с помощью операции [Set Secondary Database As Primary](https://msdn.microsoft.com/library/mt582027.aspx) с допустимой потерей данных. 

## Восстановление с использованием геовосстановления

В случае сбоя базы данных вы можете восстановить базу данных из последней избыточной резервной копии геообъекта с помощью геовосстановления.

> [AZURE.NOTE]При восстановлении базы данных создается новая база данных. Важно убедиться, что на сервере, куда выполняется восстановление, имеется достаточный объем DTU для новой базы данных. Можно [обратиться в службу поддержки](http://azure.microsoft.com/blog/azure-limits-quotas-increase-requests/) с просьбой увеличить квоту.

###Классический портал Azure
Чтобы восстановить базу данных SQL с помощью геовосстановления на классическом портале Azure, выполните указанные ниже действия.

1. Перейдите на [классический портал Azure](https://portal.Azure.com).
2. В левой части экрана последовательно выберите **СОЗДАТЬ**, **Данные и хранилище**, **База данных SQL**.
2. Выберите **РЕЗЕРВНАЯ КОПИЯ** в качестве источника, затем выберите избыточную резервную копию геообъекта, из которой вы хотите восстановить базу данных.
3. Укажите остальные свойства базы данных и нажмите кнопку **Создать**.
4. Начнется процесс восстановления базы данных, который можно отслеживать с помощью **УВЕДОМЛЕНИЙ** в левой части экрана.

###PowerShell 
Чтобы восстановить базу данных SQL с помощью функции геовосстановления в PowerShell, отправьте запрос геовосстановления с помощью командлета [start-AzureSqlDatabaseRecovery](https://msdn.microsoft.com/library/azure/dn720224.aspx).

		$Database = Get-AzureSqlRecoverableDatabase -ServerName "ServerName" –DatabaseName “DatabaseToBeRecovered"
		$RecoveryRequest = Start-AzureSqlDatabaseRecovery -SourceDatabase $Database –TargetDatabaseName “NewDatabaseName” –TargetServerName “TargetServerName”
		Get-AzureSqlDatabaseOperation –ServerName "TargetServerName" –OperationGuid $RecoveryRequest.RequestID

###Интерфейс REST API 

Используйте REST для программного восстановления базы данных.

1.	Получите список баз данных, доступных для восстановления, используя операцию [List Recoverable Databases](http://msdn.microsoft.com/library/azure/dn800984.aspx)
	
2.	Получите базу данных, которую необходимо восстановить, используя операцию [Get Recoverable Database](http://msdn.microsoft.com/library/azure/dn800985.aspx).
	
3.	Создайте запрос на восстановление, используя операцию [Create Database Recovery Request](http://msdn.microsoft.com/library/azure/dn800986.aspx).
	
4.	Отслеживайте состояние восстановления, используя операцию [Database Operation Status](http://msdn.microsoft.com/library/azure/dn720371.aspx).
 
## Настройка базы данных после восстановления<a name="postrecovery"></a>

Это контрольный список задач, который можно использовать для подготовки восстановленной базы данных к использованию в рабочей среде.

### Обновление строк подключения

Убедитесь, что строки подключения вашего приложения указывают на только что восстановленную базу данных. При возникновении любой из следующих ситуаций обновите строки подключения:

  + имя восстановленной базы данных отличается от имени базы данных-источника;
  + восстановленная база данных находится на сервере, отличном от исходного сервера.

Подробнее об изменении строк подключения см. в разделе [Подключение к базе данных SQL: основные рекомендации](sql-database-connect-central-recommendations.md).
 
### Изменение правил брандмауэра
Проверьте правила брандмауэра на уровне сервера и на уровне базы данных и убедитесь в том, что в них разрешены подключения от клиентских компьютеров или Azure к серверу и только что восстановленной базе данных. Дополнительные сведения см. в статье [Практическое руководство. Настройка параметров брандмауэра для Базы данных SQL](sql-database-configure-firewall-settings.md).

### Проверка имен для входа на сервер и пользователей базы данных

Проверьте существование всех имен для входа, используемых вашим приложением, на сервере, на котором находится восстановленная база данных. Повторно создайте отсутствующие имена для входа и предоставьте им соответствующие разрешения на работу с восстановленной базой данных. Дополнительные сведения см. в статье [Управление базами данных, именами для входа и пользователями в Базе данных SQL Azure](sql-database-manage-logins.md).

Проверьте, связан ли каждый пользователей базы данных в восстановленной базе данных с именем для входа на сервер. Используйте инструкцию ALTER USER для сопоставления пользователя с именем для входа на сервер. Дополнительные сведения см. в статье [ALTER USER](http://go.microsoft.com/fwlink/?LinkId=397486).


### Настройка оповещений телеметрии

Проверьте сопоставление параметров существующих правил генерации оповещений с восстановленной базой данных. При возникновении любой из следующих ситуаций обновите параметры:

  + имя восстановленной базы данных отличается от имени базы данных-источника;
  + восстановленная база данных находится на сервере, отличном от исходного сервера.

Подробнее о правилах генерации оповещений базы данных см. в разделах [Получение уведомлений об оповещениях](insights-receive-alert-notifications.md) и [Получение информации о работоспособности службы](insights-service-health.md).


### Включение аудита

Если для доступа к базе данных требуется аудит, то после восстановления базы данных необходимо включить аудит. Индикатором того, что необходим аудит, служит использование в клиентских приложениях строк безопасного подключения вида *. database.secure.windows.net. Дополнительные сведения см. в статье [Приступая к работе с аудитом базы данных SQL](sql-database-auditing-get-started.md).

<!---HONumber=AcomDC_1203_2015-->