---
title: "Активная георепликация для базы данных SQL Azure"
description: "Активная георепликация позволяет настроить четыре реплики базы данных в любом из центров обработки данных Azure."
services: sql-database
documentationcenter: na
author: anosov1960
manager: jhubbard
editor: monicar
ms.assetid: 2a29f657-82fb-4283-9a83-e14a144bfd93
ms.service: sql-database
ms.custom: business continuity
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: NA
ms.date: 09/26/2016
ms.author: sashan
translationtype: Human Translation
ms.sourcegitcommit: 2c13daf84727a500a2ea6a3dc1d4968c9824e223
ms.openlocfilehash: 4ed2bfcad36059000b5a8e4bfa5f06bceb56843b
ms.lasthandoff: 02/16/2017


---
# <a name="overview-sql-database-active-geo-replication"></a>Обзор: активная георепликация для базы данных SQL
Активная георепликация позволяет настроить до четырех доступных для чтения баз данных-получателей в одном или в разных расположениях (регионах) центров обработки данных. Базы данных-получатели доступны для выполнения запросов и отработки отказа при сбое центра обработки данных или невозможности подключения к базе данных-источнику. Активная георепликация должна поддерживаться между базами данных в рамках одной подписки.

> [!NOTE]
> Активная георепликация (с доступными для чтения базами данных-получателями) теперь доступна для всех баз данных и всех уровней обслуживания. В апреле 2017 года недоступные для чтения базы данных-получатели будут удалены, и существующие недоступные для чтения базы данных будут автоматически преобразованы в доступные для чтения базы данных-получатели.
>  

 Активную георепликацию можно настроить с помощью [портала Azure](sql-database-geo-replication-portal.md), [PowerShell](sql-database-geo-replication-powershell.md), [Transact-SQL](sql-database-geo-replication-transact-sql.md) или [REST API (создания или обновления базы данных)](https://msdn.microsoft.com/library/azure/mt163685.aspx).

Если по какой-либо причине произойдет сбой вашей базы данных-источника (или вам просто потребуется перевести ее в автономный режим), вы можете выполнить *отработку отказа* на любую из доступных баз данных-получателей. При активации отработки отказа в одной из баз данных-получателей все прочие получатели автоматически связываются с новой базой данных-источником.

Отработку отказа на базу данных-получатель можно выполнить с помощью [портала Azure](sql-database-geo-replication-failover-portal.md), [PowerShell](sql-database-geo-replication-failover-powershell.md), [Transact-SQL](sql-database-geo-replication-failover-transact-sql.md), [REST API (плановой отработки отказа)](https://msdn.microsoft.com/ibrary/azure/mt575007.aspx) или [REST API (внеплановой отработки отказа)](https://msdn.microsoft.com/library/azure/mt582027.aspx).

После отработки отказа убедитесь, что для новой базы данных-источника настроены требования аутентификации ваших сервера и базы данных. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

Функция активной георепликации реализует механизм обеспечения избыточности базы данных в одном регионе Microsoft Azure или в разных регионах (геоизбыточность). Активная георепликация асинхронно реплицирует зафиксированные транзакции из базы данных максимум на максимум четыре ее копии на разных серверах, используя изоляцию моментального снимка Read Committed. При настройке активной георепликации база данных-получатель создается на указанном сервере. Исходная база данных становится базой данных-источником. База данных-источник асинхронно реплицирует зафиксированные транзакции в каждую базу данных-получателя. Реплицируются только полные транзакции. Хотя в любой момент база данных-получатель может немного отстать от базы данных-источника, в базе данных-получателе никогда не будет частично выполненных транзакций. Конкретные сведения о RPO можно найти в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).

Одно из основных преимуществ активной георепликации состоит в предоставлении решения для аварийного восстановления на уровне базы данных с небольшим временем восстановления. Размещая базу данных-получатель на сервере в другом регионе, вы обеспечиваете своему приложению максимальную устойчивость. Избыточность в различных регионах позволяет восстанавливать приложения после необратимой потери всего центра обработки данных или его частей, вызванной стихийным бедствием, неисправимыми человеческими ошибками или злонамеренными действиями. На следующем рисунке показан пример активной георепликации, настроенной с помощью базы данных-источника в северо-центральном регионе США и базы данных-получателя в юго-центральном регионе США.

![Отношение георепликации](./media/sql-database-active-geo-replication/geo-replication-relationship.png)

Другое важное преимущество заключается в том, что базы данных-получатели доступны для чтения и могут использоваться для разгрузки рабочих нагрузок только для чтения, например, заданий для составления отчетов. Если планируется использовать базу данных-получатель для балансировки нагрузки, можно создать ее в том же регионе, что и базу данных-источник. Создание базы данных-получателя в том же регионе не поможет повысить устойчивость приложения к катастрофическим внезапным отказам.  

Другие сценарии использования активной георепликации включают следующее:

* **Перенос баз данных**: с помощью активной георепликации можно перенести базу данных с одного сервера на другой с минимальным временем простоя.
* **Обновления приложения**: при обновлении приложения вы можете создать дополнительную базу данных-получатель как резервную копию на случай сбоя.

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в разделе [Разработка облачных решений для аварийного восстановления с помощью активной георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md).

## <a name="active-geo-replication-capabilities"></a>Возможности активной георепликации
Функция активной георепликации предоставляет следующие возможности.

* **Автоматическая асинхронная репликация**: базу данных-получатель можно создать, только добавив ее к существующей базе данных. Базу данных-получатель можно создать только на другом сервере базы данных SQL Azure. После создания база данных-получатель заполняется данными, которые копируются из базы данных-источника. Этот процесс называется заполнением. После создания и начального заполнения базы данных-получателя обновления базы данных-источника асинхронно и автоматически реплицируются в базу данных-получателя. Асинхронная репликация означает, что транзакции фиксируются в базе данных-источнике перед их репликацией в базу данных-получатель. 
* **Несколько баз данных-получателей**: две или более базы данных-получателя повышают избыточность и уровень защиты для базы данных-источника и приложения. Если существует несколько баз данных-получателей, то приложение остается защищенным даже при сбое одной из баз данных-получателей. Если же имеется только одна база данных-получатель и на ней происходит сбой, приложение подвергается более высокому риску, пока не будет создана новая база данных-получатель.
* **Базы данных-получатели, доступные для чтения**: приложение может получить доступ к базе данных-получателю только для чтения с использованием тех же или других субъектов безопасности, которые применяются для доступа к базе данных-источнику. База данных-получатель работает в режиме изоляции моментальных снимков, чтобы гарантировать, что репликация обновлений базы данных-источника (воспроизведение журнала) не будет задерживаться из-за запросов, выполняемых на базе данных-получателе.

> [!NOTE]
> Воспроизведение журнала на базе данных-получателе откладывается, если существуют обновления схемы, которые были получены из базы данных-источника, для которых необходимо выполнить блокировку схемы базы данных-получателя.
> 
> 

* **Активная георепликация баз данных в пуле эластичных БД**: активную георепликацию можно настроить для любой базы данных в любом пуле эластичных баз данных. База данных-получатель может находиться в другом пуле эластичных баз данных. Для обычных баз данных база данных-получатель может представлять собой пул эластичных баз данных и наоборот, при условии, что уровни служб совпадают. 
* **Настраиваемый уровень производительности для базы данных-получателя**. Базу данных-получатель можно создать с более низким уровнем производительности, чем у базы данных-источника. База данных-источник и база данных-получатель должны иметь один и тот же уровень обслуживания. Эта конфигурация не рекомендуется для приложений с высокой интенсивностью записи в базы данных, так как увеличение задержки репликации повышает риск потери значительного объема данных после отработки отказа. Кроме того, после отработки отказа производительность приложения будет снижена, пока новая база данных-источник не будет обновлена до более высокого уровня производительности. Диаграмма журнала операций ввода-вывода в процентах на портале Azure — это удобный способ оценить минимальный уровень производительности базы данных-получателя, необходимый для того, чтобы выдержать нагрузку репликации. Например, если уровень базы данных-источника — P6 (1000 DTU) и процент операций ввода-вывода для нее равен 50 %, то уровень базы-данных получателя должен быть не менее P4 (500 DTU). Данные журнала операций ввода-вывода также можно получить с помощью представления базы данных [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) или [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx).  Дополнительные сведения об уровнях производительности базы данных SQL см. в разделе [Параметры базы данных SQL и производительность](sql-database-service-tiers.md). 
* **Управляемые пользователем отработка отказа и восстановление размещения**: приложение или пользователь может в любой момент явным образом использовать базу данных-получатель в качестве базы данных-источника. Во время настоящего сбоя следует использовать параметр "unplanned", при котором база данных-получатель будет немедленно повышена до базы данных-источника. Когда работоспособность вышедшей из строя базы данных-источника будет восстановлена и она снова станет доступной, система автоматически пометит ее как базу данных-получатель и синхронизирует с новой базой данных-источником. Из-за асинхронного характера репликации во время внеплановой отработки отказа может быть потерян небольшой объем данных, если сбой базы данных-источника произойдет до того, как будет выполнена репликация самых последних изменений в базу данных-получатель. При сбое базы данных-источника с несколькими базами данных-получателями система автоматически перенастраивает отношения репликации и связывает оставшиеся базы данных-получатели с новой развернутой базой данных-источником без вмешательства пользователя. После устранения сбоя, который вызвал отработку отказа, желательно вернуть приложение в основной регион. Для этого необходимо вызвать команду отработки отказа с параметром "planned". 
* **Синхронизация учетных данных и правил брандмауэра**. Мы рекомендуем использовать [правила брандмауэра базы данных](sql-database-firewall-configure.md) для геореплицируемых баз данных. Таким образом, эти правила можно реплицировать в базу данных, чтобы все базы данных-получатели использовали те же правила брандмауэра, что и база данных-источник. Такой подход избавляет клиентов от необходимости вручную настраивать и обслуживать правила брандмауэра на серверах, на которых размещаются как базы данных-источники, так и базы данных-получатели. Аналогично, в случае получения доступа к данным с помощью [пользователей автономной базы данных](sql-database-manage-logins.md) базы данных-источники и базы данных-получатели всегда используют одни и те же учетные данные. Поэтому при отработке отказа можно избежать нарушений в работе из-за несоответствия имен для входа или паролей. Благодаря добавлению [Azure Active Directory](../active-directory/active-directory-whatis.md) клиенты могут управлять доступом пользователей к базам данных-источникам и базам данных-получателям, и им не нужно управлять учетными данными для баз данных.

## <a name="upgrading-or-downgrading-a-primary-database"></a>Повышение или понижение уровня производительности базы данных-источника
Вы можете повышать или понижать уровень производительности базы данных-источника (в рамках одного уровня служб) без отключения каких-либо баз данных-получателей. При повышении рекомендуется сначала повысить уровень производительности базы данных-получателя, а затем — уровень базы данных-источника. При понижении следует действовать в обратном порядке: сначала нужно понизить уровень производительности базы данных-источника, а после этого — базы данных-получателя. 

База данных-получатель и база данных-источник должны находиться в рамках одного уровня служб, поэтому при переносе базы данных-источника на другой уровень служб потребуется либо остановить действие ссылки на георепликацию и переименовать базу данных-получатель, либо просто удалить ее. После этого нужно будет перенести базу-данных источник на новый уровень служб и повторно настроить георепликацию. Новая база данных-получатель будет создана автоматически с тем же уровнем производительности по умолчанию, что и база данных-источник.

## <a name="preventing-the-loss-of-critical-data"></a>Предотвращение потери важных данных
Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. Ввиду асинхронной репликации потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp_wait_for_database_copy_sync](https://msdn.microsoft.com/library/dn467644.aspx). Вызов **sp_wait_for_database_copy_sync** блокирует вызывающий поток до репликации последней зафиксированной транзакции в базе данных-получателе. Процедура ожидает подтверждения базой данных-получателем всех транзакций в очереди. **sp_wait_for_database_copy_sync** ограничена конкретной связью непрерывной копии. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

> [!NOTE]
> Задержка вследствие вызова процедуры **sp_wait_for_database_copy_sync** может оказаться значительной. Задержка зависит от объема журнала транзакций в данный момент. Возврата результата вызова не происходит до полной репликации всего журнала. Вызывайте эту процедуру только в случае крайней необходимости.
> 
> 

## <a name="programmatically-managing-active-geo-replication"></a>Программное управление активной георепликацией
Как уже говорилось ранее, активной георепликацией можно также управлять программно с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан доступный для этого набор команд.

* **API Azure Resource Manager и безопасность на основе ролей**. Активная георепликация включает в себя набор [интерфейсов API Azure Resource Manager](https://msdn.microsoft.com/library/azure/mt163571.aspx) для управления, в том числе [командлеты PowerShell для Azure Resource Manager](sql-database-geo-replication-powershell.md). Эти интерфейсы API требуют использования групп ресурсов и поддерживают безопасность на основе ролей (RBAC). Дополнительные сведения о том, как реализовать контроль доступа на основе ролей, см. в статье [Управление доступом на основе ролей в Azure](../active-directory/role-based-access-control-configure.md).

> [!NOTE]
> Многие новые функции активной георепликации поддерживаются только в [REST API SQL Azure](../azure-resource-manager/resource-group-overview.md) и [командлетах PowerShell базы данных SQL Azure](https://msdn.microsoft.com/library/azure/mt163571.aspx) на основе [Azure Resource Manager](https://msdn.microsoft.com/library/azure/mt574084.aspx). Классический REST API (https://msdn.microsoft.com/library/azure/dn505719.aspx) и [командлеты базы данных SQL Azure (классическая модель)](https://msdn.microsoft.com/library/azure/dn546723.aspx) поддерживаются для обратной совместимости, поэтому рекомендуется использовать интерфейсы API на основе Azure Resource Manager. 
> 
> 

### <a name="transact-sql"></a>Transact-SQL
| Команда | Описание |
| --- | --- |
| [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) |Используйте аргумент ADD SECONDARY ON SERVER, чтобы создать базу данных-получатель для существующей базы данных и начать репликацию данных. |
| [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) |Используйте аргумент FAILOVER или FORCE_FAILOVER_ALLOW_DATA_LOSS, чтобы задать базу данных-получатель в качестве базы данных-источника для запуска отработки отказа. |
| [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) |Используйте аргумент REMOVE SECONDARY ON SERVER, чтобы завершить репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [sys.geo_replication_links (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575501.aspx) |Возвращает сведения о всех существующих связях репликации для каждой базы данных на логическом сервере Базы данных SQL Azure. |
| [sys.dm_geo_replication_link_status (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575504.aspx) |Получает время последней репликации, задержку при последней репликации и другие сведения о связи репликации для заданной базы данных SQL. |
| [sys.dm_operation_status (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270022.aspx) |Показывает состояние всех операций с базой данных, включая состояние связей репликации. |
| [sp_wait_for_database_copy_sync (база данных SQL Azure)](https://msdn.microsoft.com/library/dn467644.aspx) |Указывает приложению ждать, пока все зафиксированные транзакции не будут реплицированы и подтверждены активной базой данных-получателем. |
|  | |

### <a name="powershell"></a>PowerShell
| Командлет | Описание |
| --- | --- |
| [Get-AzureRmSqlDatabase](https://msdn.microsoft.com/en-us/library/azure/mt603648.aspx) |Получает одну или несколько баз данных. |
| [New-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt603689.aspx) |Создает базу данных-получатель для существующей базы данных и начинает репликацию данных. |
| [Set-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/en-us/library/mt619393.aspx) |Преобразует базу данных-получатель в базу данных-источник для запуска отработки отказа. |
| [Remove-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/en-us/library/mt603457.aspx) |Завершает репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [Get-AzureRmSqlDatabaseReplicationLink](https://msdn.microsoft.com/library/mt619330.aspx) |Получает связи георепликации между базой данных SQL Azure и группой ресурсов или SQL Server. |
|  | |

### <a name="rest-api"></a>Интерфейс REST API
| API | Описание |
| --- | --- |
| [Создание или обновление базы данных (createMode=Restore)](https://msdn.microsoft.com/library/azure/mt163685.aspx) |Создает, обновляет или восстанавливает базу данных-источник или базу данных-получатель. |
| [Получение, создание или обновление состояния базы данных](https://msdn.microsoft.com/library/azure/mt643934.aspx) |Возвращает состояние во время операции создания. |
| [Задание базы данных-получателя в качестве базы данных-источника (плановая отработка отказа)](https://msdn.microsoft.com/ibrary/azure/mt575007.aspx) |Повышение уровня базы данных-получателя в партнерстве георепликации до новой базы данных-источника. |
| [Задание базы данных-получателя в качестве базы данных-источника (внеплановая отработка отказа)](https://msdn.microsoft.com/library/azure/mt582027.aspx) |Принудительная отработка отказа на базу данных-получатель и задание ее в качестве базы данных-источника. |
| [Получение связей репликации](https://msdn.microsoft.com/library/azure/mt600929.aspx) |Получает все связи репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. |
| [Получение связи репликации](https://msdn.microsoft.com/library/azure/mt600778.aspx) |Получает определенную связь репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. |
|  | |

## <a name="next-steps"></a>Дальнейшие действия
* Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)
* Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь со статьей [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
* Чтобы узнать об использовании автоматически создаваемых резервных копий для восстановления, ознакомьтесь с [восстановлением базы данных из резервных копий, инициируемых службой](sql-database-recovery-using-backups.md).
* Чтобы узнать об использовании автоматически создаваемых резервных копий для архивации, ознакомьтесь с [копированием базы данных](sql-database-copy.md).
* Дополнительные сведения о требованиях к проверке подлинности для новых сервера-источника и базы данных-источника см. в статье [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).


