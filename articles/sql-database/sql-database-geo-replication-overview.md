.<properties
	pageTitle="Активная георепликация для базы данных SQL Azure"
	description="Активная георепликация позволяет настроить четыре реплики базы данных в любом из центров обработки данных Azure."
	services="sql-database"
	documentationCenter="na"
	authors="stevestein"
	manager="jhubbard"
	editor="monicar" />


<tags
	ms.service="sql-database"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
   ms.workload="NA"
	ms.date="07/14/2016"
	ms.author="sstein" />

# Обзор: активная георепликация для базы данных SQL

Активная георепликация позволяет настроить до 4 доступных для чтения баз данных-получателей в одном или в разных расположениях (регионах) центров обработки данных. Базы данных-получатели доступны для выполнения запросов и отработки отказа при сбое центра обработки данных или невозможности подключения к базе данных-источнику.

>[AZURE.NOTE] Активная георепликация (с доступными для чтения базами данных-получателями) теперь доступна для всех баз данных и всех уровней обслуживания. В апреле 2017 года недоступные для чтения базы данных-получатели будут удалены, и существующие недоступные для чтения базы данных будут автоматически преобразованы в доступные для чтения базы данных-получатели.

 Активную георепликацию можно настроить с помощью [портала Azure](sql-database-geo-replication-portal.md), [PowerShell](sql-database-geo-replication-powershell.md), [Transact-SQL](sql-database-geo-replication-transact-sql.md) или [REST API создания или обновления базы данных](https://msdn.microsoft.com/library/azure/mt163685.aspx).

> [AZURE.SELECTOR]
- [Настройка: портал Azure](sql-database-geo-replication-portal.md)
- [Настройка: PowerShell](sql-database-geo-replication-powershell.md)
- [Настройка: T-SQL](sql-database-geo-replication-transact-sql.md)

Если по какой-либо причине произойдет сбой вашей базы данных-источника (или вам просто потребуется перевести ее в автономный режим), вы можете выполнить *отработку отказа* на любую из доступных баз данных-получателей. При активации отработки отказа в одной из баз данных-получателей все прочие получатели автоматически связываются с новой базой данных-источником.

Отработку отказа на базу данных-получатель можно выполнить с помощью [портала Azure](sql-database-geo-replication-failover-portal.md), [PowerShell](sql-database-geo-replication-failover-powershell.md), [Transact-SQL](sql-database-geo-replication-failover-transact-sql.md), [REST API плановой отработки отказа](https://msdn.microsoft.com/ibrary/azure/mt575007.aspx) или [REST API внеплановой отработки отказа](https://msdn.microsoft.com/library/azure/mt582027.aspx).


> [AZURE.SELECTOR]
- [Отработка отказа: портал Azure](sql-database-geo-replication-failover-portal.md)
- [Отработка отказа: PowerShell](sql-database-geo-replication-failover-powershell.md)
- [Отработка отказа: T-SQL](sql-database-geo-replication-failover-transact-sql.md)

Функция активной георепликации реализует механизм обеспечения избыточности базы данных в одном регионе Microsoft Azure или в разных регионах (геоизбыточность). Активная георепликация асинхронно реплицирует зафиксированные транзакции из базы данных максимум на максимум четыре ее копии на разных серверах, используя изоляцию моментального снимка Read Committed. При настройке активной георепликации база данных-получатель создается на указанном сервере. Исходная база данных становится базой данных-источником. База данных-источник асинхронно реплицирует зафиксированные транзакции в каждую базу данных-получателя. Хотя в любой момент база данных-получатель может немного отстать от базы данных-источника, данные базы данных-получателя всегда будут транзакционно согласованы с изменениями, зафиксированными в базе данных-источнике.

Одно из основных преимуществ активной георепликации состоит в предоставлении решения для аварийного восстановления на уровне базы данных с очень низким временем восстановления. При размещении базы данных-получателя на сервере в другом регионе вы добавляете в свое приложение максимальную устойчивость. Избыточность в различных регионах позволяет восстанавливать приложения после необратимой потери всего центра обработки данных или его частей, вызванной стихийным бедствием, неисправимыми человеческими ошибками или злонамеренными действиями. На следующем рисунке показан пример активной георепликации, настроенной для базы данных уровня "Премиум" с базой данных-источником в северо-центральном регионе США и базой данных-получателем в юго-центральном регионе США.

![Отношение георепликации](./media/sql-database-active-geo-replication/geo-replication-relationship.png)

Другое важное преимущество заключается в том, что базы данных-получатели доступны для чтения и могут использоваться для разгрузки рабочих нагрузок только для чтения, например, заданий для составления отчетов. Если планируется использовать базу данных-получатель для балансировки нагрузки, можно создать ее в том же регионе, что и базу данных-источник. Однако это не повысит устойчивость приложения к критическим сбоям.

Другие сценарии использования активной георепликации включают следующее:

- **Перенос баз данных**: с помощью активной георепликации можно перенести базу данных с одного сервера на другой с минимальным временем простоя.
- **Обновления приложения**: при обновлении приложения вы можете создать дополнительную базу данных-получатель как резервную копию на случай сбоя.

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в статье [Разработка облачных решений для аварийного восстановления с помощью активной георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md).

## Возможности активной георепликации
Функция активной георепликации предоставляет следующие возможности.

- **Автоматическая асинхронная репликация**: базу данных-получатель можно создать, только добавив ее к существующей базе данных. Базу данных-получатель можно создать только на другом сервере базы данных SQL Azure. После создания база данных-получатель заполняется данными, которые копируются из базы данных-источника. Этот процесс называется заполнением. После создания и начального заполнения базы данных-получателя обновления базы данных-источника асинхронно и автоматически реплицируются в базу данных-получателя. Это означает, что транзакции фиксируются в базе данных-источнике перед их репликацией в базу данных-получателя. База данных SQL гарантирует, что после завершения начального заполнения базы данных-получателя она остается транзакционно согласованной все время.

- **Несколько баз данных-получателей**: две или более базы данных-получателя повышают избыточность и уровень защиты для базы данных-источника и приложения. Если существует несколько баз данных-получателей, приложение останется защищенным даже при сбое одной из баз данных-получателей. Если же имеется только одна база данных-получатель и на ней происходит сбой, приложение подвергается более высокому риску, пока не будет создана новая база данных-получатель.

- **Базы данных-получатели, доступные для чтения**: приложение может получить доступ к базе данных-получателю только для чтения с использованием тех же или других субъектов безопасности, которые применяются для доступа к базе данных-источнику. База данных-получатель работает в режиме изоляции моментальных снимков, чтобы гарантировать, что репликация обновлений базы данных-источника (воспроизведение журнала) не будет задерживаться из-за запросов, выполняемых на базе данных-получателе.

>[AZURE.NOTE] Воспроизведение журнала на базе данных-получателе будет отложено, если существуют обновления схемы, которые были получены с базы данных-источника, так как при этом необходимо выполнить блокировку схемы для базы данных-получателя.

- **Активная георепликация баз данных в пуле эластичных БД**: активную георепликацию можно настроить для любой базы данных в любом пуле эластичных баз данных. База данных-получатель может находиться в другом пуле эластичных баз данных. Для обычных баз данных база данных-получатель может представлять собой пул эластичных баз данных и наоборот, при условии, что уровни служб совпадают.

- **Настраиваемый уровень производительности для базы данных-получателя**: базу данных-получатель можно создать с более низким уровнем производительности, чем у базы данных-источника. База данных-источник и база данных-получатель должны иметь один и тот же уровень обслуживания. Эта конфигурация не рекомендуется для приложений с высокой активностью записи, так как она может привести к увеличению задержки репликации и, как следствие, к высокому риску потери значительного объема данных после отработки отказа. Кроме того, после отработки отказа производительность приложения будет снижена, пока новая база данных-источник не обновится до более высокого уровня производительности. Журнал операций ввода-вывода в процентах на портале Azure предоставляет хороший способ оценить уровень минимальной производительности базы данных-получателя, необходимый для того, чтобы выдержать нагрузку репликации. Например, если уровень базы данных-источника — P6 (1000 DTU) и процент операций ввода-вывода для нее равен 50 %, то уровень базы-данных получателя должен быть не менее P4 (500 DTU). Данные журнала операций ввода-вывода также можно получить с помощью представления базы данных [sys.resource\_stats](https://msdn.microsoft.com/library/dn269979.aspx) или [sys.dm\_db\_resource\_stats](https://msdn.microsoft.com/library/dn800981.aspx). Дополнительные сведения об уровнях производительности базы данных SQL см. в статье [Параметры базы данных SQL и производительность: возможности разных уровней служб](sql-database-service-tiers.md).

- **Управляемые пользователем отработка отказа и восстановление**: базу данных-получатель всегда можно использовать в качестве базы данных-источника (это явным образом может настроить приложение или пользователь). Во время настоящего сбоя следует использовать параметр "unplanned", при этом база данных-получатель будет немедленно переключена в базу данных-источник. Когда вышедшая из строя база данных-источник восстановится и снова станет доступной, система автоматически пометит ее как базу данных-получатель и синхронизирует с новой базой данных-источником. Из-за асинхронной природы репликации во время незапланированной отработки отказа может быть потерян небольшой объем данных перед тем, как будет выполнена репликация самых последних изменений в базу данных-получателя. При сбое базы данных-источника с несколькими базами данных-получателями система автоматически перенастроит отношения репликации и свяжет оставшиеся базы данных-получатели с новой развернутой базой данных-источником без вмешательства пользователя. После устранения сбоя, который вызвал отработку отказа, желательно вернуть приложение в основной регион. Для этого необходимо вызвать команду отработки отказа с параметром "planned".

- **Синхронизация учетных данных и правил брандмауэра**: мы рекомендуем использовать [правила брандмауэра базы данных](sql-database-firewall-configure.md) для географически реплицированных баз данных. Таким образом эти правила можно реплицировать в базу данных, чтобы все базы данных-получатели имели ту же конфигурацию брандмауэра, что и база данных-источник. Это избавляет клиентов от необходимости вручную настраивать и обслуживать правила брандмауэра на серверах, на которых размещаются как базы данных-источники, так и базы данных-получатели. Аналогично, в случае получения доступа к данным с помощью [пользователей автономной базы данных](sql-database-manage-logins.md) базы данных-источники и базы данных-получатели всегда используют одни и те же учетные данные. Благодаря этому при отработке отказа можно избежать нарушений в работе из-за несоответствия имен для входа или паролей. Благодаря добавлению [Azure Active Directory](../active-directory/active-directory-whatis.md) клиенты могут управлять доступом пользователей к базам данных-источникам и базам данных-получателям без необходимости управлять учетными данными для баз данных.

## Предотвращение потери важных данных
Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. За счет этого потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp\_wait\_for\_database\_copy\_sync](https://msdn.microsoft.com/library/dn467644.aspx). Вызов **sp\_wait\_for\_database\_copy\_sync** блокирует вызывающий поток до репликации последней зафиксированной транзакции в базе данных-получателе. Процедура ожидает подтверждения базой данных-получателем всех транзакций в очереди. Процедура **sp\_wait\_for\_database\_copy\_sync** ограничена связью с непрерывной копией. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

>[AZURE.NOTE] Задержка вследствие вызова процедуры **sp\_wait\_for\_database\_copy\_sync** может оказаться значительной. Задержка зависит от объема журнала транзакций в данный момент. Возврата не происходит до полной репликации всего журнала. Вызывайте эту процедуру только в случае крайней необходимости.

## Программное управление активной георепликацией

Как уже говорилось ранее, в дополнение к порталу Azure активной георепликацией можно управлять программно, с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан набор команд, доступных для этого.

- **API Azure Resource Manager и безопасность на основе ролей**: активная георепликация включает в себя набор [интерфейсов API Azure Resource Manager (ARM)](https://msdn.microsoft.com/library/azure/mt163571.aspx) для управления, в том числе [командлеты PowerShell для ARM](sql-database-geo-replication-powershell.md). Эти API-интерфейсы требуют использования групп ресурсов и поддерживают безопасность на основе ролей (RBAC). Дополнительные сведения о том, как реализовать контроль доступа на основе ролей, см. в статье [Использование назначений ролей для управления доступом к ресурсам Azure Active Directory](../active-directory/role-based-access-control-configure.md).

>[AZURE.NOTE] Многие новые функции активной георепликации поддерживаются только в [REST API Azure SQL](https://msdn.microsoft.com/library/azure/mt163571.aspx) и [командлетах PowerShell базы данных SQL Azure](https://msdn.microsoft.com/library/azure/mt574084.aspx) на основе [Azure Resource Manager (ARM)](../resource-group-overview.md). Существующие [REST API управления службами SQL Azure (классическая модель)](https://msdn.microsoft.com/library/azure/dn505719.aspx) и [командлеты базы данных SQL Azure (классическая модель)](https://msdn.microsoft.com/library/azure/dn546723.aspx) поддерживаются для обратной совместимости, поэтому рекомендуется использовать интерфейсы API на основе ARM.


### Transact-SQL

|Команда|Описание|
|-------|-----------|
|[ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx)|Используйте аргумент ADD SECONDARY ON SERVER, чтобы создать базу данных-получатель для существующей базы данных и начать репликацию данных.|
|[ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx)|Используйте аргумент FAILOVER или FORCE\_FAILOVER\_ALLOW\_DATA\_LOSS, чтобы задать базу данных-получатель в качестве базы данных-источник для запуска отработки отказа.
|[ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx)|Используйте аргумент REMOVE SECONDARY ON SERVER, чтобы завершить репликацию данных между базой данных SQL и указанной базой данных-получателем.|
|[sys.geo\_replication\_links (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575501.aspx)|Возвращает сведения о всех существующих связях репликации для каждой базы данных на логическом сервере базы данных SQL Azure.|
|[sys.dm\_geo\_replication\_link\_status (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575504.aspx)|Получает время последней репликации, задержку при последней репликации и другие сведения о связи репликации для заданной базы данных SQL.|
|[sys.dm\_operation\_status (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270022.aspx)|Показывает состояние всех операций с базой данных, включая состояние связей репликации.|
|[sp\_wait\_for\_database\_copy\_sync (база данных SQL Azure)](https://msdn.microsoft.com/library/dn467644.aspx)|Указывает приложению ждать, пока все зафиксированные транзакции не будут реплицированы и подтверждены активной базой данных-получателем.|
||||

### PowerShell

|Командлет|Описание|
|------|-----------|
|[Get-AzureRmSqlDatabase](https://msdn.microsoft.com/ru-RU/library/azure/mt603648.aspx)|Получает одну или несколько баз данных.|
|[New-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt603689.aspx)|Создает базу данных-получатель для существующей базы данных и начинает репликацию данных.|
|[Set-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/ru-RU/library/mt619393.aspx)|Преобразует базу данных-получатель в базу данных-источник для запуска отработки отказа.|
|[Remove-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/ru-RU/library/mt603457.aspx)|Завершает репликацию данных между базой данных SQL и указанной базой данных-получателем.|
|[Get-AzureRmSqlDatabaseReplicationLink](https://msdn.microsoft.com/library/mt619330.aspx)|Получает связи георепликации между базой данных SQL Azure и группой ресурсов или SQL Server.|
||||

### Интерфейс REST API

|API|Description (Описание)|
|---|-----------|
|[Создание или обновление базы данных (createMode=Restore)](https://msdn.microsoft.com/library/azure/mt163685.aspx)|Создает, обновляет или восстанавливает базу данных-источник или базу данных-получатель.|
|[Получение, создание или обновление состояния базы данных](https://msdn.microsoft.com/library/azure/mt643934.aspx)|Возвращает состояние во время операции создания.|
|[Задание базы данных-получателя в качестве базы данных-источника (плановая отработка отказа)](https://msdn.microsoft.com/ibrary/azure/mt575007.aspx)|Повышение уровня базы данных-получателя в партнерстве георепликации до новой базы данных-источника.|
|[Задание базы данных-получателя в качестве базы данных-источника (внеплановая отработка отказа)](https://msdn.microsoft.com/library/azure/mt582027.aspx)|Принудительная отработка отказа на базу данных-получатель и задание ее в качестве базы данных-источника.|
|[Получение связей репликации](https://msdn.microsoft.com/library/azure/mt600929.aspx)|Получает все связи репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo\_replication\_links.|
|[Получение связи репликации](https://msdn.microsoft.com/library/azure/mt600778.aspx)|Получает определенную связь репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo\_replication\_links.|
||||



## Дальнейшие действия

- Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).
- Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь со статьей [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
- Чтобы узнать об использовании автоматически создаваемых резервных копий для восстановления, ознакомьтесь с [восстановлением базы данных из резервных копий, инициируемых службой](sql-database-recovery-using-backups.md).
- Чтобы узнать об использовании автоматически создаваемых резервных копий для архивации, ознакомьтесь с [копированием базы данных](sql-database-copy.md).

<!---HONumber=AcomDC_0824_2016-->