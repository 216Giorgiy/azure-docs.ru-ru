<properties
	pageTitle="Активная георепликация для базы данных SQL Azure"
	description="В этом разделе объясняется, что такое активная георепликация для базы данных SQL, и рассматриваются особенности ее использования."
	services="sql-database"
	documentationCenter="na"
	authors="rothja"
	manager="jeffreyg"
	editor="monicar" />


<tags
	ms.service="sql-database"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="data-management"
	ms.date="10/21/2015"
	ms.author="jroth" />

# Активная георепликация для базы данных SQL Azure

## Обзор
Функция активной георепликации реализует механизм обеспечения избыточности базы данных в одном регионе Microsoft Azure или в разных регионах (геоизбыточность). Активная георепликация асинхронно реплицирует зафиксированные транзакции из базы данных максимум на четыре ее копии на разных серверах. Исходная база данных становится базой данных-источником непрерывной копии. Каждая непрерывная копия называется оперативной базой данных-получателем. База данных-источник асинхронно реплицирует зафиксированные транзакции в каждую оперативную базу данных-получатель. Хотя в любой момент оперативная база данных-получатель может немного отстать от базы данных-источника, данные базы данных-получателя всегда будут транзакционно согласованы с изменениями, зафиксированными в базе данных-источнике. Активная георепликация поддерживает четыре или три оперативные базы данных-получателя и одну автономную базу данных-получатель.

Одно из основных преимуществ активной георепликации состоит в предоставлении решения для аварийного восстановления на уровне базы данных. Используя активную георепликацию, можно настроить пользовательскую базу данных с уровнем обслуживания Premium для репликации транзакций в базы данных на разных серверах баз данных SQL Microsoft Azure в одном или разных регионах. Избыточность в различных регионах позволяет восстанавливать приложения после необратимой потери центра данных, вызванной стихийным бедствием, неисправимыми человеческими ошибками или злонамеренными действиями.

Другим важным преимуществом является то, что оперативные базы данных-получатели доступны для чтения. Следовательно, оперативные базы данных-получатели могут выступать в роли балансировщиков нагрузки для рабочих нагрузок чтения, например для создания отчетов. Кроме создания оперативной базы данных-получателя в другом регионе, для аварийного восстановления можно создать такую базу в том же регионе, но на другом сервере. Обе оперативные базы данных-получатели можно использовать для распределения рабочих нагрузок только для чтения, которые обслуживают клиентов, распределенных по нескольким регионам.

Другие сценарии использования активной георепликации включают следующее:

- **Перенос баз данных**: с помощью активной георепликации можно перенести базу данных с одного сервера на другой с минимальным временем простоя.
- **Обновление приложения**: оперативную базу данных-получатель можно использовать для отработки отказа.

В процессе достижения реальной непрерывности бизнес-процессов добавление избыточности между центрами данных к реляционному хранилищу является только частью решения. Для комплексного восстановления приложения (службы) после сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в статье [Разработка облачных решений для аварийного восстановления с помощью активной георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md).

## Возможности активной георепликации
Функция активной георепликации предоставляет следующие возможности.

- **Автоматическая асинхронная репликация**: когда начальное заполнение оперативной базы данных-получателя завершилось, обновления базы данных-источника асинхронно и автоматически копируются в базу данных-получателя. Это означает, что транзакции фиксируются в базе данных-источнике перед их копированием в оперативную базу данных-получатель. Тем не менее после начального заполнения оперативная база данных-получатель транзакционно согласована в любой момент времени.
	>[AZURE.NOTE]Асинхронная репликация не зависит от задержек, типичных для глобальных сетей, по которым подключаются удаленные центры данных.

- **Несколько оперативных баз данных-получателей**: две или более оперативные базы данных-получатели повышают избыточность и защиту для базы данных-источника и приложения. Если существует несколько оперативных баз данных-получателей, приложение будет защищено даже при сбое одной из таких баз данных. Если же имеется только одна база данных-получатель и на ней происходит сбой, приложение подвергается риску, пока не создается новая оперативная база данных-получатель.

- **Оперативные базы данных-получатели, доступные для чтения**: приложение может получить доступ к оперативной базе данных-получателю исключительно для чтения, используя те же меры безопасности, которые применяются для доступа к базе данных-источнику. Операции непрерывного копирования в оперативной базе данных-получателе имеют более высокий приоритет, чем доступ к приложению. Кроме того, если запросы к оперативной базе данных-получателю вызывают длительную блокировку таблиц, транзакции в базе данных-источнике в итоге могут завершиться с ошибкой.

- **Контролируемое пользователем завершение для отработки отказа**: прежде чем отрабатывать отказ приложения в оперативной базе данных-получателе, необходимо завершить связь непрерывной копии с базой данных-источником. Это можно сделать с помощью явного действия приложения, административного скрипта или вручную на портале. После завершения связи оперативная база данных-получатель становится автономной. Кроме этого, если база данных-источник не была доступной только для чтения, она становится доступной для чтения и записи. Далее в этой статье описаны две формы [завершения связи непрерывной копии](#termination-of-a-continuous-copy-relationship).

>[AZURE.NOTE]Активная георепликация поддерживается только для баз данных на уровне обслуживания «Премиум». Это относится к базам данных-источникам и к оперативным базам данных-получателям. Для оперативной базы данных-получателя необходимо настроить такой же уровень производительности, как у базы данных-источника, или более высокий. Изменения уровней производительности базы данных-источника не реплицируется автоматически для баз данных-получателей. Все обновления сначала должны применяться в базах данных-получателях, а затем — в базе данных-источнике. Дополнительные сведения об изменении уровней производительности см. в статье [Изменение уровней производительности](sql-database-scale-up.md). Существует две основных причины, по которым оперативная база данных-получатель должна быть по крайней мере не меньше базы данных-источника. У базы данных-получателя должно хватать мощности для обработки реплицированных транзакций со скоростью, с которой они обрабатываются в базе данных-источнике. Если база данных-получатель не обладает по меньшей мере такой же мощностью для обработки входящих транзакций, могут возникать задержки, которые в конечном итоге влияют на доступность базы данных-источника. Если мощность база данных-получателя меньше мощности базы данных-источника, отработка отказа может привести к снижению производительности и доступности приложения.

## Понятия, относящиеся к связи непрерывного копирования
Избыточность локальных данных и операционное восстановление являются стандартными возможностями базы данных SQL Azure. Каждая база данных располагает одной базой данных-источником и двумя локальными репликами баз данных-получателей. Они хранятся в одном центре данных, благодаря чему обеспечивается высокий уровень доступности в его пределах. Это означает, что базы данных активной георепликации тоже имеют избыточные реплики. То есть база данных-источник и оперативная база данных-получатель имеют две вторичные реплики. Тем не менее первичная реплика для базы данных-получателя обновляется непосредственно механизмом непрерывной копии и не может принимать обновления, инициированные приложением. На следующем рисунке показано, как активная георепликация расширяет избыточность базы данных в двух регионах Azure. Регион, в котором размещена база данных-источник, называется основным. Регион, в котором размещена база данных-получатель, называется дополнительным. На приведенном ниже рисунке Северная Европа является основным регионом. Дополнительным регионом является Западная Европа.

![Связь непрерывной копии](./media/sql-database-active-geo-replication/continuous-copy-relationships.gif)

Если база данных-источник становится недоступной, завершение связи непрерывной копии для данной оперативной базы данных-получателя превращает ее в автономную. Оперативная база данных-получатель наследует режим только для чтения или чтения и записи базы данных-источника, и на это не влияет завершение связи. Например, если база данных-источник доступна только для чтения, после завершения связи оперативная база данных-получатель тоже становится доступной только для чтения. На этом этапе приложение может отработать отказ и продолжить использовать оперативную базу данных-получатель. Чтобы обеспечить устойчивость в случае катастрофического сбоя в центре данных или длительного простоя основного региона, по крайней мере одна оперативная база данных-получатель должна находиться в другом регионе.

## Создание непрерывной копии
Можно создавать непрерывную копию только существующей базы данных. Создание непрерывной копии существующей базы данных полезно для реализации геоизбыточности. Непрерывную копию можно создать также для того, чтобы скопировать существующую базу данных на другой сервер базы данных SQL Azure. После создания база данных-получатель заполняется данными, которые копируются из базы данных-источника. Этот процесс называется заполнением. После завершения заполнения каждая новая транзакция реплицируется после ее фиксации в базе данных-источнике.

Сведения о создании непрерывной копии существующей базы данных см. в статье [Включение георепликации](sql-database-business-continuity-design.md#how-to-enable-geo-replication).

## Предотвращение потери важных данных
Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. За счет этого потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp\_wait\_for\_database\_copy\_sync](https://msdn.microsoft.com/library/dn467644.aspx). Вызов **sp\_wait\_for\_database\_copy\_sync** блокирует вызывающий поток до репликации последней зафиксированной транзакции в оперативной базе данных-получателе. Процедура ожидает подтверждения оперативной базой данных-получателем всех транзакций в очереди. Процедура **sp\_wait\_for\_database\_copy\_sync** ограничена определенной связью непрерывной копии. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

>[AZURE.NOTE]Задержка вследствие вызова процедуры **sp\_wait\_for\_database\_copy\_sync** может оказаться значительной. Она зависит от длины очереди и доступной пропускной способности. Вызывайте эту процедуру только в случае крайней необходимости.

## Завершение связи непрерывного копирования
Связь непрерывной копии может быть завершена в любой момент. В результате завершения связи непрерывной копии база данных-получатель не удаляется. Существует два способа завершения связи непрерывной копии.

- **Запланированное завершение**. Этот способ подходит для запланированных операций, при которых потеря данных недопустима. Плановое завершение может выполняться только в базе данных-источнике после заполнения оперативной базы данных-получателя. При плановом завершении все транзакции, зафиксированные в базе данных-источнике, сначала реплицируются в оперативную базу данных-получатель, а затем связь непрерывной копии завершается. Это предотвращает потерю данных в базе данных-получателе.
- **Незапланированное (принудительное) завершение**. Этот способ предназначен для реагирования на потерю базы данных-источника или одной из ее оперативных баз данных-получателей. Принудительное завершение можно выполнить в базе данных-источнике или получателе. Каждое принудительное завершение приводит к необратимой потере связи репликации между базой данных-источником и связанной оперативной базой данных-получателем. Кроме того, в результате принудительного завершения теряются все транзакции, которые не были реплицированы из базы данных-источника. Если применяется принудительное завершение, связь непрерывной копии немедленно завершается. Активные транзакции не реплицируются в оперативную базу данных-получатель. Следовательно, принудительное завершение может привести к необратимой потере всех транзакций, которые не были реплицированы из базы данных-источника.

>[AZURE.NOTE]Если в базе данных-источнике имеется только одна связь непрерывной копии, после ее завершения обновления в базе данных-источнике больше не будут защищены.

Дополнительные сведения о завершении связи непрерывной копии см. в статье [Восстановление базы данных SQL Azure после сбоя](sql-database-disaster-recovery.md).

## Дальнейшие действия
Дополнительные сведения об активной георепликации и описание дополнительных возможностей базы данных SQL для обеспечения непрерывности бизнес-процессов см. в статье [Общие сведения о непрерывности бизнес-процессов](sql-database-business-continuity.md).

<!---HONumber=AcomDC_0121_2016-->