<properties 
    pageTitle="Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL | Microsoft Azure" 
    description="Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL" 
    services="sql-database" 
    documentationCenter="" 
    authors="carlrabeler" 
    manager="jhubbard" 
    editor=""/>

<tags
    ms.service="sql-database"
    ms.devlang="NA"
    ms.topic="article"
    ms.tgt_pltfrm="NA"
    ms.workload="data-management"
    ms.date="04/27/2016"
    ms.author="carlrab"/>

# Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL


> [AZURE.SELECTOR]
- [Портал Azure](sql-database-geo-replication-failover-portal.md)
- [PowerShell](sql-database-geo-replication-failover-powershell.md)
- [T-SQL](sql-database-geo-replication-failover-transact-sql.md)


В этой статье объясняется, как запустить отработку отказа в базе данных-получателе SQL Azure с помощью Transact-SQL. Информацию о настройке георепликации для баз данных SQL Azure см. в [этой статье](sql-database-geo-replication-transact-sql.md).



Чтобы инициировать отработку отказа, необходимо следующее:

- Имя для входа с ролью DBManager в базе данных-источнике, привилегиями db\_ownership для локальной базы данных, которая будет геореплицирована. Кроме того, это имя для входа будет выступать в роли DBManager на серверах-партнерах, для которых вы настроите георепликацию.
- Последняя версия SQL Server Management Studio. Чтобы получить последнюю версию, перейдите к статье [Скачивание SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx). Дополнительные сведения об управлении логическими базами данных и серверами базы данных SQL Azure с помощью SQL Server Management Studio см. в статье [Управление базой данных SQL Azure с помощью SQL Server Management Studio](sql-database-manage-azure-ssms.md).



## Запуск плановой отработки отказа для превращения базы данных-получателя в базу данных-источник

С помощью инструкции **ALTER DATABASE** можно в запланированном порядке сделать базу данных-получателя источником. При этом текущая база данных-источник станет получателем. Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается. Эта функция предназначена для плановой отработки отказа (как во время отработки аварийного восстановления). Чтобы ее использовать, нужно, чтобы база данных-источник была доступна.

Эта команда выполняет следующий рабочий процесс:

1. Временно переводит репликацию в синхронный режим. В результате все транзакции, ожидающие обработки, переносятся в базу данных-получателя, а новые транзакции блокируются.

2. Две базы данных, связанные георепликацией, обмениваются ролями.

Эта последовательность гарантирует, что базы данных будут синхронизированы до переключения ролей, а значит потери данных не возникнут. В течение короткого периода (от 0 до 25 секунд), пока переключаются роли, обе базы данных будут недоступны. Если база данных-источник имеет несколько баз данных-получателей, команда автоматически перенастроится на другие базы данных-получатели для подключения к новой базе данных-источнику. Обычно вся операция занимает меньше минуты. Дополнительные сведения см. в статьях [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб](sql-database-service-tiers.md).


Чтобы запустить плановую отработку отказа, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Используйте следующую операцию **ALTER DATABASE** для переключения базы данных-получателя в основную роль.

        ALTER DATABASE <MyDB> FAILOVER;

4. Нажмите кнопку **Выполнить** для выполнения запроса.

>[AZURE.NOTE] В редких случаях бывает, что операцию нельзя завершить и что она зависла. Тогда вы можете выполнить команду принудительной отработки отказа (при этом будут потеряны данные).


## Запуск внеплановой отработки отказа для превращения базы данных-источника в базу данных-получателя

С помощью инструкции **ALTER DATABASE** можно во внеплановом порядке сделать базу данных-получателя источником. При этом текущая база данных-источник станет получателем, когда база данных-источник перестанет быть доступной. Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается.

Эта функция предназначена для аварийного восстановления в случаях, когда восстановить доступность базы данных крайне необходимо, а потеря некоторого объема данных является приемлемой. Когда вызывается принудительная отработка отказа, указанная база данных-получатель сразу становится источником и начинает принимать транзакции записи. Когда становится возможным повторно подключить первоначальную базу данных-источник к новой базе данных-источнику, сразу выполняется добавочная архивация первоначальной базы данных-источника, которая при этом становится получателем по отношению к новому источнику, то есть его репликой, выполняющей функцию синхронизации.

При этом функция «Восстановление до точки во времени» не поддерживается в базах данных-получателях. Поэтому следует обращаться в службу поддержки, если нужно восстановить потерянные данные, которые были записаны в прошлую базу данных-источник и которые перед принудительной отработкой отказа не удалось реплицировать в новый источник.

Если база данных-источник имеет несколько баз данных-получателей, команда автоматически перенастроится на другие базы данных-получатели для подключения к новой базе данных-источнику.

Чтобы запустить плановую отработку отказа, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Используйте следующую операцию **ALTER DATABASE** для переключения базы данных-получателя в основную роль.

        ALTER DATABASE <MyDB>   FORCE_FAILOVER_ALLOW_DATA_LOSS;

4. Нажмите кнопку **Выполнить** для выполнения запроса.

>[AZURE.NOTE] Если команда выполняется, когда одновременно доступны база данных-источник и база данных-получатель, старый источник становится новым получателем мгновенно и без синхронизации данных. Если при отправке команды источник выполняет транзакции, некоторые данные могут быть утеряны.



## Дополнительные ресурсы

- [Новые возможности георепликации](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/)
- [Разработка облачных приложений для непрерывности бизнес-процессов с использованием георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md)
- [Общие сведения о непрерывности бизнес-процессов](sql-database-business-continuity.md)
- [База данных SQL — документация](https://azure.microsoft.com/services/sql-database/)
- [Отработка аварийного восстановления](sql-database-disaster-recovery-drills.md)

<!---HONumber=AcomDC_0615_2016-->