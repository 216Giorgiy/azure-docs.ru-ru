<properties
    pageTitle="Настройка георепликации базы данных SQL Azure с помощью Transact-SQL | Microsoft Azure"
    description="Настройка георепликации базы данных SQL Azure с помощью Transact-SQL"
    services="sql-database"
    documentationCenter=""
    authors="carlrabeler"
    manager="jhubbard"
    editor=""/>

<tags
    ms.service="sql-database"
    ms.devlang="NA"
    ms.topic="article"
    ms.tgt_pltfrm="NA"
   ms.workload="sqldb-bcdr"
    ms.date="06/14/2016"
    ms.author="carlrab"/>

# Настройка георепликации базы данных SQL Azure с помощью Transact-SQL

> [AZURE.SELECTOR]
- [Обзор](sql-database-geo-replication-overview.md)
- [Портал Azure](sql-database-geo-replication-portal.md)
- [PowerShell](sql-database-geo-replication-powershell.md)
- [T-SQL](sql-database-geo-replication-transact-sql.md)

В этой статье показано, как настроить активную георепликацию базы данных SQL Azure с помощью Transact-SQL.

Чтобы инициировать отработку отказа с помощью Transact-SQL, ознакомьтесь с разделом [Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL](sql-database-geo-replication-failover-transact-sql.md).

>[AZURE.NOTE] Активная георепликация (с доступными для чтения базами данных-получателями) теперь доступна для всех баз данных и всех уровней обслуживания. В апреле 2017 г. недоступные для чтения базы данных-получатели будут удалены, и существующие недоступные для чтения базы данных-получатели будут автоматически преобразованы в доступные для чтения.

Для настройки активной георепликации с помощью Transact-SQL необходимо следующее.

- Подписка Azure.
- Логический сервер базы данных SQL Azure <MyLocalServer> и база данных SQL <MyDB> — база данных-источник, которую необходимо реплицировать.
- Один или несколько логических серверов <MySecondaryServer(n)> (мой сервер-получатель) базы данных SQL Azure. Логические серверы, которые будут серверами-партнерами, в которых будут созданы базы данных-получатели.
- Имя для входа с ролью DBManager в базе данных-источнике, привилегиями db\_ownership для локальной базы данных, которая будет геореплицирована. Кроме того, это имя для входа будет выступать в роли DBManager на серверах-партнерах, для которых вы настроите георепликацию.
- Последняя версия SQL Server Management Studio. Чтобы получить последнюю версию, перейдите к статье [Скачивание SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx). Дополнительные сведения об управлении логическими базами данных и серверами базы данных SQL Azure с помощью SQL Server Management Studio см. в статье [Управление базой данных SQL Azure с помощью SQL Server Management Studio](sql-database-manage-azure-ssms.md).

## Добавление базы данных-получателя

С помощью инструкции **ALTER DATABASE** на сервере-партнере можно создать геореплицированную базу данных-получатель. Эту инструкцию можно выполнить в базе данных master сервера, содержащего базу данных, которую нужно реплицировать. Геореплицированная база данных («база данных-источник») имеет то же имя, что и база данных, которая реплицируется, и — по умолчанию — тот же уровень обслуживания, что и база данных-источник. База данных-получатель может быть доступной или недоступной для чтения, отдельной или эластичной. Дополнительные сведения см. в статьях [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб](sql-database-service-tiers.md). После создания и заполнения базы данных-получателя начинается асинхронная репликация данных из базы данных-источника. Ниже описаны действия по настройке георепликации с помощью Management Studio. Описаны также действия по созданию доступных и недоступных для чтения баз данных-получателей, как эластичных, так и отдельных.

> [AZURE.NOTE] Если база данных существует на указанном сервере-партнере с тем же именем, что и база данных-источник, команда завершится с ошибкой.


### Добавление недоступной для чтения отдельной базы данных-получателя

Чтобы создать недоступную для чтения отдельную базу данных-получателя, выполните описанные ниже действия.

1. Убедитесь, что вы используете SQL Server Management Studio версии 13.0.600.65 или более поздней.

 	 > [AZURE.IMPORTANT] Загрузите [последнюю](https://msdn.microsoft.com/library/mt238290.aspx) версию среды SQL Server Management Studio. Рекомендуется всегда использовать самую последнюю версию Management Studio, чтобы обеспечить синхронизацию с обновлениями на портале Azure.


2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с недоступной для чтения базой данных-получателем на сервере MySecondaryServer1, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer1> WITH (ALLOW_CONNECTIONS = NO);

4. Нажмите кнопку **Выполнить** для выполнения запроса.


### Добавление доступной для чтения отдельной базы данных-получателя
Чтобы создать доступную для чтения отдельную базу данных-получатель, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с доступной для чтения базой данных-получателем на сервере-получателе, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer2> WITH (ALLOW_CONNECTIONS = ALL);

4. Нажмите кнопку **Выполнить** для выполнения запроса.



### Добавление недоступной для чтения эластичной базы данных-получателя

Чтобы создать недоступную для чтения эластичную базу данных-получатель, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с недоступной для чтения базой данных-получателем на сервере-получателе в пуле эластичных баз данных, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer3> WITH (ALLOW_CONNECTIONS = NO
           , SERVICE_OBJECTIVE = ELASTIC_POOL (name = MyElasticPool1));

4. Нажмите кнопку **Выполнить** для выполнения запроса.



### Добавление доступной для чтения эластичной базы данных-получателя
Чтобы создать доступную для чтения эластичную базу данных-получатель, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с доступной для чтения базой данных-получателем на сервере-получателе в пуле эластичных баз данных, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer4> WITH (ALLOW_CONNECTIONS = ALL
           , SERVICE_OBJECTIVE = ELASTIC_POOL (name = MyElasticPool2));

4. Нажмите кнопку **Выполнить** для выполнения запроса.



## Удаление базы данных-получателя

С помощью инструкции **ALTER DATABASE** можно навсегда завершить отношение репликации между базой данных-получателем и ее источником. Эта инструкция выполняется в базе данных master, на которой находится база данных-источник. После завершения этого отношения база данных-получатель становится обычной базой данных для чтения и записи. Если подключение к базе данных-получателю прервано, команда все равно будет выполнена. При этом получатель станет базой данных для чтения и записи только тогда, когда восстановится подключение. Дополнительные сведения см. в статьях [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб](sql-database-service-tiers.md).

Чтобы удалить геореплицированную базу данных-получатель из связи георепликации, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. С помощью приведенной ниже инструкции **ALTER DATABASE** удалите геореплицированную базу данных-получатель.

        ALTER DATABASE <MyDB>
           REMOVE SECONDARY ON SERVER <MySecondaryServer1>;

4. Нажмите кнопку **Выполнить** для выполнения запроса.

## Мониторинг конфигурации и работоспособности георепликации

К задачам мониторинга относятся мониторинг конфигурации георепликации и мониторинг работоспособности репликации данных. С помощью динамического административного представления **sys.dm\_geo\_replication\_links** в базе данных master вы можете вернуть информацию обо всех имеющихся каналах репликации, приходящихся на каждую базу данных на логическом сервере базы данных SQL Azure. Это представление содержит по строке на каждый канал репликации между базой данных-источником и базой данных-получателем. С помощью динамического административного представления **sys.dm\_replication\_status** можно вернуть по строке на каждую базу данных SQL Azure, которая сейчас задействована в канале репликации. Это относится как к базам данных-источникам, так и к базам данных-получателям. Если какая-либо база данных-источник задействована в более чем одном постоянном канале репликации, эта таблица содержит по строке на каждое такое отношение репликации. Это представление создается во всех базах данных, в том числе в логической базе данных master. Однако запрос к этому представлению в логической базе данных master выдает лишь пустой набор. С помощью динамического административного представления **sys.dm\_operation\_status** вы можете отобразить состояние всех операций базы данных, в том числе состояние каналов репликации. Дополнительные сведения см. в статьях [sys.dm\_geo\_replication\_links (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm\_geo\_replication\_link\_status (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575504.aspx) и [sys.dm\_operation\_status (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270022.aspx).

Чтобы отслеживать связь георепликации, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы отобразить все базы данных с соединениями георепликации, воспользуйтесь приведенной ниже инструкцией.

        SELECT database_id, start_date, modify_date, partner_server, partner_database, replication_state_desc, role, secondary_allow_connections_desc FROM [sys].geo_replication_links;

4. Нажмите кнопку **Выполнить** для выполнения запроса.
5. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **MyDB** и щелкните **Создать запрос**.
6. Чтобы отобразить задержки репликации и время последней репликации ваших баз данных-получателей MyDB, воспользуйтесь приведенной ниже инструкцией.

        SELECT link_guid, partner_server, last_replication, replication_lag_sec FROM sys.dm_geo_replication_link_status

7. Нажмите кнопку **Выполнить** для выполнения запроса.
8. Чтобы отобразить последние операции георепликации, связанные с базой данных MyDB, воспользуйтесь приведенной ниже инструкцией.

        SELECT * FROM sys.dm_operation_status where major_resource_id = 'MyDB'
        ORDER BY start_time DESC

9. Нажмите кнопку **Выполнить** для выполнения запроса.



## Дальнейшие действия

- Чтобы больше узнать об активной георепликации, ознакомьтесь с разделом [Обзор: активная георепликация для базы данных SQL](sql-database-geo-replication-overview.md).
- Чтобы изучить сценарии проектирования и восстановления непрерывности бизнес-процессов, ознакомьтесь со [сценариями обеспечения непрерывности](sql-database-business-continuity-scenarios.md).

<!---HONumber=AcomDC_0629_2016-->