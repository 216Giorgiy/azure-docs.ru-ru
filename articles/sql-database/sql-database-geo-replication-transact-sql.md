<properties
    pageTitle="Настройка георепликации баз данных SQL Azure с помощью Transact-SQL | Microsoft Azure"
    description="Настройка георепликации баз данных SQL Azure с помощью Transact-SQL."
    services="sql-database"
    documentationCenter=""
    authors="carlrabeler"
    manager="jeffreyg"
    editor=""/>

<tags
    ms.service="sql-database"
    ms.devlang="NA"
    ms.topic="article"
    ms.tgt_pltfrm="NA"
    ms.workload="data-management"
    ms.date="11/10/2015"
    ms.author="carlrab"/>

# Настройка георепликации базы данных SQL Azure с помощью Transact-SQL



> [AZURE.SELECTOR]
- [Azure preview portal](sql-database-geo-replication-portal.md)
- [PowerShell](sql-database-geo-replication-powershell.md)
- [Transact-SQL](sql-database-geo-replication-transact-sql.md)


В этой статье показано, как настроить георепликацию базы данных SQL Azure с помощью Transact-SQL.


Георепликация позволяет создать до четырех реплик (баз данных-получателей) в различных местах (регионах) расположения центров баз данных. Базы данных-получатели могут создаваться при сбое центра обработки данных или невозможности подключения к базе данных-источнику.

Георепликация доступна только для баз данных, относящихся к категориям «Стандартный» и «Премиум».

Базы данных Standard могут иметь одного не доступного для чтения получателя и должны использовать рекомендованный регион. Базы данных Premium могут иметь до четырех доступных для чтения получателей в любом доступном регионе.


Для настройки георепликации необходимо следующее.

- Подписка Azure. Если у вас еще нет подписки Azure, щелкните ссылку **БЕСПЛАТНАЯ ПРОБНАЯ ВЕРСИЯ** в верхней части этой страницы. После оформления подписки вернитесь к этой статье.
- Логический сервер базы данных SQL Azure <MyLocalServer> и база данных SQL <MyDB>. База данных-источник, которую необходимо реплицировать в другом географическом регионе.
- Один или несколько логических серверов <MySecondaryServer(n)> (мой сервер-получатель) базы данных SQL Azure. Логические серверы, которые будут серверами-партнерами, в которых будут созданы геореплицированные базы данных-получатели.
- Имя для входа, которое используется для роли DBManager в базе данных-источнике. Оно связано с правом db\_ownership локальной базы данных и будет использоваться для роли DBManager на серверах-партнерах, по направлению к которым выполняется георепликация.
- Последняя версия SQL Server Management Studio. Чтобы получить последнюю версию, перейдите к статье [Скачивание SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx). Дополнительные сведения об управлении логическими базами данных и серверами базы данных SQL Azure с помощью SQL Server Management Studio см. в статье [Управление базой данных SQL Azure с помощью SQL Server Management Studio](sql-database-manage-azure-ssms.md).

## Добавление базы данных-получателя

С помощью инструкции **ALTER DATABASE** на сервере-партнере можно создать геореплицированную базу данных-получатель. Эту инструкцию можно выполнить в базе данных master сервера, содержащего базу данных, которую нужно реплицировать. Геореплицированная база данных («база данных-источник») имеет то же имя, что и база данных, которая реплицируется, и — по умолчанию — тот же уровень обслуживания, что и база данных-источник. База данных-получатель может быть доступной или недоступной для чтения, отдельной или эластичной. Дополнительные сведения см. в статьях [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб](https://azure.microsoft.com/documentation/articles/sql-database-service-tiers/). После создания и заполнения базы данных-получателя начинается асинхронная репликация данных из базы данных-источника. Ниже описаны действия по настройке георепликации с помощью Management Studio. Описаны также действия по созданию доступных и недоступных для чтения баз данных-получателей, как эластичных, так и отдельных.

> [AZURE.NOTE]Если база данных-получатель находится на указанном сервере-партнере (потому что, например, существует или существовало отношение георепликации), команда не выполняется.


### Добавление недоступной для чтения отдельной базы данных-получателя

Чтобы создать недоступную для чтения отдельную базу данных-получателя, выполните описанные ниже действия.

1. Убедитесь, что вы используете SQL Server Management Studio версии 13.0.600.65 или более поздней.

 	 >[AZURE.IMPORTANT]Скачайте [последнюю](https://msdn.microsoft.com/library/mt238290.aspx) версию SQL Server Management Studio. Рекомендуется всегда использовать самую последнюю версию Management Studio, чтобы обеспечить синхронизацию с обновлениями на портале Azure.


2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицированной базой данных-источником с недоступной для чтения базой данных-получателем в <MySecondaryServer1>, воспользуйтесь следующей инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer1> WITH (ALLOW_CONNECTIONS = NO);

4. Нажмите кнопку **Выполнить** для выполнения запроса.


### Добавление доступной для чтения отдельной базы данных-получателя
Чтобы создать доступную для чтения отдельную базу данных-получатель, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицированной базой данных-источником с доступной для чтения базой данных-получателем на сервере-получателе, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer2> WITH (ALLOW_CONNECTIONS = ALL);

4. Нажмите кнопку **Выполнить** для выполнения запроса.



### Добавление недоступной для чтения эластичной базы данных-получателя
Чтобы создать недоступную для чтения эластичную базу данных-получатель, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицированной базой данных-источником с недоступной для чтения базой данных-получателем на сервере-получателе в пуле эластичных баз данных, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer3> WITH (ALLOW_CONNECTIONS = NO)
           , ELASTIC_POOL (name = MyElasticPool1);

4. Нажмите кнопку **Выполнить** для выполнения запроса.



### Добавление доступной для чтения эластичной базы данных-получателя
Чтобы создать доступную для чтения эластичную базу данных-получатель, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать локальную базу данных геореплицированной базой данных-источником с доступной для чтения базой данных-получателем на сервере-получателе в пуле эластичных баз данных, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer4> WITH (ALLOW_CONNECTIONS = NO)
           , ELASTIC_POOL (name = MyElasticPool2);

4. Нажмите кнопку **Выполнить** для выполнения запроса.



## Удаление базы данных-получателя

С помощью инструкции **ALTER DATABASE** можно навсегда завершить отношение репликации между базой данных-получателем и ее источником. Эта инструкция выполняется в базе данных master, на которой находится база данных-источник. После завершения этого отношения база данных-получатель становится обычной базой данных для чтения и записи. Если подключение к базе данных-получателю прервано, команда все равно будет выполнена. При этом получатель станет базой данных для чтения и записи только тогда, когда восстановится подключение. Дополнительные сведения см. в статьях [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб](https://azure.microsoft.com/documentation/articles/sql-database-service-tiers/).

Чтобы удалить геореплицированную базу данных-получателя из партнерства георепликации, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. С помощью приведенной ниже инструкции **ALTER DATABASE** удалите геореплицированную базу данных-получатель.

        ALTER DATABASE <MyDB>
           REMOVE SECONDARY ON SERVER <MySecondaryServer1>;

4. Нажмите кнопку **Выполнить** для выполнения запроса.


## Запуск плановой отработки отказа для превращения базы данных-получателя в базу данных-источник

С помощью инструкции **ALTER DATABASE** можно в запланированном порядке сделать базу данных-получателя источником. При этом текущая база данных-источник станет получателем. Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается. Эта функция предназначена для плановой отработки отказа (как во время отработки аварийного восстановления). Чтобы ее использовать, нужно, чтобы база данных-источник была доступна.

Эта команда выполняет следующий рабочий процесс:

1. Временно переводит репликацию в синхронный режим. В результате все транзакции, ожидающие обработки, переносятся в базу данных-получателя, а новые транзакции блокируются.

2. Две базы данных, связанные партнерством георепликации, обмениваются ролями.

Эта последовательность действий позволяет избежать потери данных. В течение короткого периода (от 0 до 25 секунд), пока переключаются роли, обе базы данных будут недоступны. Обычно вся операция занимает меньше минуты. Дополнительные сведения см. в статьях [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб](https://azure.microsoft.com/documentation/articles/sql-database-service-tiers/).


> [AZURE.NOTE]Если во время запуска команды база данных-источник недоступна, команда не выполняется и появляется сообщение об ошибке, в котором указано, что сервер-источник недоступен. В редких случаях бывает, что операцию нельзя завершить и что она зависла. Тогда вы можете выполнить команду принудительной отработки отказа (при этом будут потеряны данные).

Чтобы запустить плановую отработку отказа, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать геореплицированную базу данных базой данных-источником с доступной для чтения геореплицированной базой данных-получателем на <MySecondaryServer4> в <ElasticPool2>, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB> FAILOVER;

4. Нажмите кнопку **Выполнить** для выполнения запроса.



## Запуск внеплановой отработки отказа для превращения базы данных-источника в базу данных-получателя

С помощью инструкции **ALTER DATABASE** можно во внеплановом порядке сделать базу данных-получателя источником. При этом текущая база данных-источник станет получателем, когда база данных-источник перестанет быть доступной. Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается.

Эта функция предназначена для аварийного восстановления в случаях, когда восстановить доступность базы данных крайне необходимо, а потеря некоторого объема данных является приемлемой. Когда вызывается принудительная отработка отказа, указанная база данных-получатель сразу становится источником и начинает принимать транзакции записи. Когда становится возможным повторно подключить первоначальную базу данных-источник к новой базе данных-источнику, сразу выполняется добавочная архивация первоначальной базы данных-источника, которая при этом становится получателем по отношению к новому источнику, то есть его репликой, выполняющей функцию синхронизации.

При этом функция «Восстановление до точки во времени» не поддерживается в базах данных-получателях. Поэтому следует обращаться в службу поддержки, если нужно восстановить потерянные данные, которые были записаны в прошлую базу данных-источник и которые перед принудительной отработкой отказа не удалось реплицировать в новый источник.

> [AZURE.NOTE]Если команда выполняется, когда одновременно доступны база данных-источник и база данных-получатель, старый источник становится новым получателем, однако попытка синхронизировать данные не выполняется. Поэтому возможна потеря некоторых данных.


Если база данных-источник связана с несколькими базами данных-получателями, команда принесет результаты только на сервере-получателе, на котором ее выполнили. При этом другие базы данных-получатели не получат информации о том, что произошла принудительная отработка отказа. Нужно будет вручную восстановить конфигурацию с помощью интерфейса API «удаление получателя», а затем перенастроить георепликацию в этих дополнительных базах данных-получателях.

Чтобы принудительно удалить геореплицированную базу данных-получатель из партнерства георепликации, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы сделать <MyLocalDB> геореплицированной базой данных-источником с доступной для чтения базой данных-получателем на <MySecondaryServer4> в <ElasticPool2>, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE**.

        ALTER DATABASE <MyDB>   FORCE_FAILOVER_ALLOW_DATA_LOSS;

4. Нажмите кнопку **Выполнить** для выполнения запроса.

## Мониторинг конфигурации и работоспособности георепликации

К задачам мониторинга относятся мониторинг конфигурации георепликации и мониторинг работоспособности репликации данных. С помощью динамического административного представления **sys.dm\_geo\_replication\_links** в базе данных master вы можете вернуть информацию обо всех имеющихся каналах репликации, приходящихся на каждую базу данных на логическом сервере базы данных SQL Azure. Это представление содержит по строке на каждый канал репликации между базой данных-источником и базой данных-получателем. С помощью динамического административного представления **sys.dm\_replication\_status** можно вернуть по строке на каждую базу данных SQL Azure, которая сейчас задействована в канале репликации. Это относится как к базам данных-источникам, так и к базам данных-получателям. Если какая-либо база данных-источник задействована в более чем одном постоянном канале репликации, эта таблица содержит по строке на каждое такое отношение репликации. Это представление создается во всех базах данных, в том числе в логической базе данных master. Однако запрос к этому представлению в логической базе данных master выдает лишь пустой набор. С помощью динамического административного представления **sys.dm\_operation\_status** вы можете отобразить состояние всех операций базы данных, в том числе состояние каналов репликации. Дополнительные сведения см. в статьях [sys.dm\_geo\_replication\_links (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm\_geo\_replication\_link\_status (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575504.aspx) и [sys.dm\_operation\_status (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270022.aspx).

Чтобы отслеживать партнерство георепликации, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.

2. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.

3. Чтобы отобразить все базы данных и каналы георепликации, воспользуйтесь приведенными ниже инструкциями.

        SELECT database_id, start_date, modify_date, partner_server, partner_database, replication_state_desc, role, secondary_allow_connections_desc FROM [sys].geo_replication_links;

4. Нажмите кнопку **Выполнить** для выполнения запроса.
5. Откройте папку «Базы данных», разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **MyDB** и щелкните **Создать запрос**.
6. Чтобы отобразить задержки репликации и время последней репликации ваших баз данных-получателей MyDB, воспользуйтесь приведенной ниже инструкцией.

        SELECT link_guid, partner_server, last_replication, replication_lag_sec FROM sys.dm_geo_replication_link_status

7. Нажмите кнопку **Выполнить** для выполнения запроса.
8. Чтобы отобразить последние операции георепликации, связанные с базой данных MyDB, воспользуйтесь приведенной ниже инструкцией.

        SELECT * FROM sys.dm_operation_status where major_resource_is = 'MyDB'
        ORDER BY start_time DESC

9. Нажмите кнопку **Выполнить** для выполнения запроса.


## Дальнейшие действия

- [Отработка аварийного восстановления](sql-database-disaster-recovery-drills.md)


## Дополнительные ресурсы

- [Новые возможности георепликации](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication)
- [Разработка облачных приложений для непрерывности бизнес-процессов с использованием георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md)
- [Общие сведения о непрерывности бизнес-процессов](sql-database-business-continuity.md)
- [База данных SQL — документация](https://azure.microsoft.com/documentation/services/sql-database/)

<!---HONumber=Nov15_HO4-->