---
title: "Настройка георепликации базы данных SQL Azure с помощью Transact-SQL | Документация Майкрософт"
description: "Настройка георепликации базы данных SQL Azure с помощью Transact-SQL."
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: d94d89a6-3234-46c5-8279-5eb8daad10ac
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 10/13/2016
ms.author: carlrab
translationtype: Human Translation
ms.sourcegitcommit: 8d988aa55d053d28adcf29aeca749a7b18d56ed4
ms.openlocfilehash: 07593e7f1d92a9a5943714f662568fec10a8886a


---
# <a name="configure-active-geo-replication-for-azure-sql-database-with-transact-sql"></a>Настройка активной георепликации базы данных SQL Azure с помощью Transact-SQL

В этой статье показано, как настроить активную георепликацию базы данных SQL Azure с помощью Transact-SQL.

Чтобы инициировать отработку отказа с помощью Transact-SQL, ознакомьтесь с разделом [Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL](sql-database-geo-replication-failover-transact-sql.md).

> [!NOTE]
> Активная георепликация (с доступными для чтения базами данных-получателями) теперь доступна для всех баз данных и всех уровней обслуживания. В апреле 2017 г. недоступные для чтения базы данных-получатели будут удалены, и существующие недоступные для чтения базы данных-получатели будут автоматически преобразованы в доступные для чтения.
> 
> 

Для настройки активной георепликации с помощью Transact-SQL необходимо следующее.

* Подписка Azure.
* Логический сервер базы данных SQL Azure <MyLocalServer> и база данных SQL <MyDB>. База данных-источник, которую необходимо реплицировать.
* Один или несколько логических серверов <MySecondaryServer(n)> (мой сервер-получатель) базы данных SQL Azure. Логические серверы, которые будут серверами-партнерами, в которых будут созданы базы данных-получатели.
* Имя для входа с ролью DBManager в базе данных-источнике, привилегиями db_ownership для локальной базы данных, которая будет геореплицирована. Кроме того, это имя для входа будет выступать в роли DBManager на серверах-партнерах, для которых вы настроите георепликацию.
* SQL Server Management Studio (SSMS);

> [!IMPORTANT]
> Чтобы обеспечить синхронизацию с обновлениями Microsoft Azure и Базой данных SQL, рекомендуется всегда использовать последнюю версию Management Studio. [Обновите среду SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).
> 
> 

## <a name="add-secondary-database"></a>Добавление базы данных-получателя
Инструкция **ALTER DATABASE** позволяет создать на сервере-партнере геореплицированную базу данных-получатель. Эту инструкцию можно выполнить в базе данных master сервера, содержащего базу данных, которую нужно реплицировать. Геореплицированная база данных («база данных-источник») имеет то же имя, что и база данных, которая реплицируется, и — по умолчанию — тот же уровень обслуживания, что и база данных-источник. База данных-получатель может быть доступной или недоступной для чтения, отдельной или размещенной в пуле эластичных баз данных. Дополнительные сведения см. в статьях [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб базы данных SQL для отдельных баз данных и пулов эластичных баз данных](sql-database-service-tiers.md).
После создания и заполнения базы данных-получателя начинается асинхронная репликация данных из базы данных-источника. Ниже описаны действия по настройке георепликации с помощью Management Studio. Описаны также действия по созданию доступных и недоступных для чтения баз данных-получателей, как отдельных, так и размещенных в пуле эластичных баз данных.

> [!NOTE]
> Если база данных существует на указанном сервере-партнере с тем же именем, что и база данных-источник, команда завершится с ошибкой.
> 
> 

### <a name="add-non-readable-secondary-single-database"></a>Добавление недоступной для чтения отдельной базы данных-получателя
Чтобы создать недоступную для чтения отдельную базу данных-получателя, выполните описанные ниже действия.

1. Убедитесь, что вы используете SQL Server Management Studio версии 13.0.600.65 или более поздней.
   
   > [!IMPORTANT]
   > Загрузите [последнюю](https://msdn.microsoft.com/library/mt238290.aspx) версию среды SQL Server Management Studio. Рекомендуется всегда использовать самую последнюю версию Management Studio, чтобы обеспечить синхронизацию с обновлениями на портале Azure.
   > 
   > 
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с недоступной для чтения базой данных-получателем на сервере MySecondaryServer1 (MySecondaryServer1 — это данное вами понятное имя сервера), воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE** .
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer1> WITH (ALLOW_CONNECTIONS = NO);
4. Нажмите кнопку **Выполнить** для выполнения запроса.

### <a name="add-readable-secondary-single-database"></a>Добавление доступной для чтения отдельной базы данных-получателя
Чтобы создать доступную для чтения отдельную базу данных-получатель, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с доступной для чтения базой данных-получателем на сервере-получателе, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE** .
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer2> WITH (ALLOW_CONNECTIONS = ALL);
4. Нажмите кнопку **Выполнить** для выполнения запроса.

### <a name="add-non-readable-secondary-elastic-pool"></a>Добавление недоступной для чтения базы данных-получателя (в пуле эластичных баз данных)
Чтобы создать недоступную для чтения базу данных-получатель, размещенную в пуле эластичных баз данных, выполните приведенные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с недоступной для чтения базой данных-получателем на сервере-получателе в пуле эластичных баз данных, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE** .
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer3> WITH (ALLOW_CONNECTIONS = NO
           , SERVICE_OBJECTIVE = ELASTIC_POOL (name = MyElasticPool1));
4. Нажмите кнопку **Выполнить** для выполнения запроса.

### <a name="add-readable-secondary-elastic-pool"></a>Добавление доступной для чтения базы данных-получателя (в пуле эластичных баз данных)
Чтобы создать доступную для чтения базу данных-получатель, размещенную в пуле эластичных баз данных, выполните приведенные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. Чтобы сделать локальную базу данных геореплицируемой базой данных-источником с доступной для чтения базой данных-получателем на сервере-получателе в пуле эластичных баз данных, воспользуйтесь приведенной ниже инструкцией **ALTER DATABASE** .
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer4> WITH (ALLOW_CONNECTIONS = ALL
           , SERVICE_OBJECTIVE = ELASTIC_POOL (name = MyElasticPool2));
4. Нажмите кнопку **Выполнить** для выполнения запроса.

## <a name="remove-secondary-database"></a>Удаление базы данных-получателя
Инструкция **ALTER DATABASE** позволяет навсегда завершить отношение репликации между базой данных-получателем и ее источником. Эта инструкция выполняется в базе данных master, на которой находится база данных-источник. После завершения этого отношения база данных-получатель становится обычной базой данных для чтения и записи. Если подключение к базе данных-получателю прервано, команда все равно будет выполнена. При этом получатель станет базой данных для чтения и записи только тогда, когда восстановится подключение. Дополнительные сведения см. в статьях [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб базы данных SQL для отдельных баз данных и пулов эластичных баз данных](sql-database-service-tiers.md).

Чтобы удалить геореплицированную базу данных-получатель из связи георепликации, выполните описанные ниже действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. С помощью приведенной ниже инструкции **ALTER DATABASE** удалите геореплицированную базу данных-получатель.
   
        ALTER DATABASE <MyDB>
           REMOVE SECONDARY ON SERVER <MySecondaryServer1>;
4. Нажмите кнопку **Выполнить** для выполнения запроса.

## <a name="monitor-active-geo-replication-configuration-and-health"></a>Мониторинг конфигурации и работоспособности активной георепликации

К задачам мониторинга относятся мониторинг конфигурации георепликации и мониторинг работоспособности репликации данных.  С помощью динамического административного представления **sys.dm_geo_replication_links** в базе данных master можно вернуть сведения обо всех имеющихся каналах репликации, приходящихся на каждую базу данных на логическом сервере базы данных SQL Azure. Это представление содержит по строке на каждый канал репликации между базой данных-источником и базой данных-получателем. Динамическое административное представление **sys.dm_replication_link_status** позволяет вернуть по строке на каждую базу данных SQL Azure, которая сейчас задействована в канале репликации. Это относится как к базам данных-источникам, так и к базам данных-получателям. Если какая-либо база данных-источник задействована в более чем одном постоянном канале репликации, эта таблица содержит по строке на каждое такое отношение репликации. Это представление создается во всех базах данных, в том числе в логической базе данных master. Однако запрос к этому представлению в логической базе данных master выдает лишь пустой набор. Динамическое административное представление **sys.dm_operation_status** позволяет отобразить состояние всех операций базы данных, в том числе состояние каналов репликации. Дополнительные сведения см. в статьях [sys.geo_replication_links (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm_geo_replication_link_status (база данных SQL Azure)](https://msdn.microsoft.com/library/mt575504.aspx) и [sys.dm_operation_status (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270022.aspx).

Чтобы отслеживать партнерство активной георепликации, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure.
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. Чтобы отобразить все базы данных с соединениями георепликации, воспользуйтесь приведенной ниже инструкцией.
   
        SELECT database_id, start_date, modify_date, partner_server, partner_database, replication_state_desc, role, secondary_allow_connections_desc FROM [sys].geo_replication_links;
4. Нажмите кнопку **Выполнить** для выполнения запроса.
5. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **MyDB** и щелкните **Создать запрос**.
6. Чтобы отобразить задержки репликации и время последней репликации ваших баз данных-получателей MyDB, воспользуйтесь приведенной ниже инструкцией.
   
        SELECT link_guid, partner_server, last_replication, replication_lag_sec FROM sys.dm_geo_replication_link_status
7. Нажмите кнопку **Выполнить** для выполнения запроса.
8. Чтобы отобразить последние операции георепликации, связанные с базой данных MyDB, воспользуйтесь приведенной ниже инструкцией.
   
        SELECT * FROM sys.dm_operation_status where major_resource_id = 'MyDB'
        ORDER BY start_time DESC
9. Нажмите кнопку **Выполнить** для выполнения запроса.

## <a name="upgrade-a-non-readable-secondary-to-readable"></a>Обновление недоступной для чтения базы данных-получателя до доступной для чтения
В апреле 2017 года недоступные для чтения базы данных-получатели будут удалены, и существующие недоступные для чтения базы данных будут автоматически преобразованы в доступные для чтения базы данных-получатели. Если вы используете недоступные для чтения базы данных-получатели и хотите обновить их до доступных для чтения, то можете использовать следующие простые действия с каждой из этих баз данных.

> [!IMPORTANT]
> Нет метода, позволяющего самостоятельно обновить на месте недоступную для чтения базу данных-получатель до доступной для чтения. Если удалить единственную базу данных-получатель, то база данных-источник будет оставаться незащищенной вплоть до полной синхронизации новой базы данных-получателя. Если в соглашении об уровне обслуживания приложения указано, что база данных-источник всегда должна быть защищена, то стоит рассмотреть возможность создания параллельной базы данных-получателя на другом сервере перед выполнением инструкций по обновлению, описанных выше. Обратите внимание, что у каждой базы данных-источника может иметь до четырех баз данных-получателей.
> 
> 

1. Сначала подключитесь к серверу *базы данных-получателя* и удалите недоступную для чтения базу данных-получатель.  
   
        DROP DATABASE <MyNonReadableSecondaryDB>;
2. Теперь подключитесь к серверу *базы данных-источника* и добавьте новую базу данных-получатель, доступную для чтения.
   
        ALTER DATABASE <MyDB>
            ADD SECONDARY ON SERVER <MySecondaryServer> WITH (ALLOW_CONNECTIONS = ALL);

## <a name="next-steps"></a>Дальнейшие действия
* Чтобы больше узнать об активной георепликации, прочитайте статью [Обзор: активная георепликация для базы данных SQL](sql-database-geo-replication-overview.md).
* Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)




<!--HONumber=Feb17_HO3-->


