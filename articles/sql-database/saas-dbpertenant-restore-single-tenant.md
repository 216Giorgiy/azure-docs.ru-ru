---
title: Восстановление базы данных SQL Azure в мультитенантном приложении SaaS | Документация Майкрософт
description: Сведения о восстановлении баз данных SQL отдельных клиентов после случайного удаления данных.
keywords: руководство по базе данных sql
services: sql-database
author: stevestein
manager: craigg
ms.service: sql-database
ms.custom: scale out apps
ms.topic: article
ms.date: 05/10/2017
ms.author: sstein
ms.reviewer: billgib
ms.openlocfilehash: 7ae8bcb6172d9f9d56c531e149635434057fc2af
ms.sourcegitcommit: 8aab1aab0135fad24987a311b42a1c25a839e9f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2018
---
# <a name="restore-a-single-tenant-with-a-database-per-tenant-saas-application"></a>Восстановление отдельного клиента приложения SaaS, использующего одну базу данных на клиент

Модель с одной базой данных на клиент упрощает восстановление отдельного клиента до предыдущей точки во времени, не влияя на работу других клиентов.

В этом руководстве рассматривается два шаблона восстановления данных:

> [!div class="checklist"]

> * восстановить базу данных в параллельную базу данных (параллельное восстановление);
> * Восстановление базы данных "на месте" с заменой имеющейся базы данных


|||
|:--|:--|
| **Восстановление в параллельную базу данных** | Этот шаблон можно использовать для проверки, аудита, проверки соответствия и т. д., чтобы разрешить клиенту проверять свои данные для более ранней точки.  Текущая база данных клиента остается в сети и не изменяется. |
| **Восстановление "на месте"** | Обычно этот шаблон используется для восстановления клиента до предыдущей точки во времени после случайного удаления или повреждения данных. Исходная база данных переводится в автономный режим и заменяется восстановленной базой данных. |
|||

Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS Wingtip. Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных SQL Azure](saas-dbpertenant-get-started-deploy.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="introduction-to-the-saas-tenant-restore-patterns"></a>Общие сведения о шаблонах восстановления клиента SaaS

Данные отдельного клиента можно восстановить с использованием двух простых шаблонов. Так как базы данных клиента изолированы, восстановление одного клиента не влияет на данные других клиентов.  Функция восстановления до точки во времени (PITR) базы данных SQL используется в обоих шаблонах.  Служба PITR всегда создает новую базу данных.   

В первом шаблоне (**параллельное восстановление**) новая база данных создается параллельно с текущей базой данных клиента. Затем клиенту предоставляется доступ только для чтения к восстановленной базе данных. Восстановленные данные можно просмотреть и потенциально использовать для перезаписи текущих значений данных. Разработчик приложения определяет, как клиент получает доступ к восстановленной базе данных и какие возможности восстановления предоставляются. В некоторых случаях достаточно просто позволить клиенту просмотреть свои данные для более ранней точки во времени. 

Второй шаблон, **восстановление "на месте"**, удобно использовать, если данные были потеряны или повреждены и клиент хочет отменить изменения до более ранней точки во времени.  Во время восстановления базы данных клиент отключается от сети. Исходная база данных удаляется, а восстановленная база данных переименовывается соответствующим образом. Цепочка резервных копий исходной базы данных остается доступной после удаления, что позволяет при необходимости восстановить базу данных до более ранней точки во времени.

Если база данных использует [георепликацию](sql-database-geo-replication-overview.md) и восстанавливается параллельно, мы рекомендуем скопировать необходимые данные из восстановленной копии в исходную базу данных. После замены исходной базы данных восстановленной необходимо перенастроить и повторно синхронизировать георепликацию.

## <a name="get-the-wingtip-tickets-saas-database-per-tenant-application-scripts"></a>Получение скриптов для SaaS-приложения Wingtip Tickets c однотенантной БД

Сценарии для приложения SaaS Wingtip Tickets c мультитенантной базой данных и исходный код этого приложения вы найдете в репозитории GitHub [WingtipTicketsSaaS-DbPerTenant](https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant). Инструкции по скачиванию и разблокированию сценариев приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).

## <a name="before-you-start"></a>Перед началом работы

После создания базы данных может пройти 10–15 минут, прежде чем станет возможным ее восстановление из первой полной резервной копии.  Если вы только что установили приложение, подождите несколько минут, прежде чем реализовывать этот сценарий.

## <a name="simulate-a-tenant-accidentally-deleting-data"></a>Моделирование случайного удаления данных клиента

Чтобы продемонстрировать эти сценарии восстановления, сначала *случайно* удалите событие в одной из баз данных клиента. 

### <a name="open-the-events-app-to-review-the-current-events"></a>Просмотр текущих событий в приложении "События"

1. Откройте *концентратор событий* (http://events.wtp.&lt;user&gt;.trafficmanager.net) и щелкните **Contoso Concert Hall**:

   ![Концентратор событий](media/saas-dbpertenant-restore-single-tenant/events-hub.png)

1. Прокрутите список событий и запишите последнее:

   ![Последнее событие](media/saas-dbpertenant-restore-single-tenant/last-event.png)


### <a name="accidentally-delete-the-last-event"></a>"Случайное" удаление последнего события

1. Откройте сценарий ...\\Learning Modules\\Business Continuity and Disaster Recovery\\RestoreTenant\\*Demo-RestoreTenant.ps1* в *интегрированной среде сценариев PowerShell* и задайте следующее значение:
   * **$DemoScenario** = **1**, удаление последнего события (без продажи билетов).
1. Нажмите клавишу **F5**, чтобы запустить сценарий и удалить последнее событие. Должно отобразиться следующее сообщение с подтверждением.

   ```Console
   Deleting last unsold event from Contoso Concert Hall ...
   Deleted event 'Seriously Strauss' from Contoso Concert Hall venue.
   ```

1. После этого откроется страница событий Contoso. Прокрутите вниз и убедитесь, что событие исчезло. Если событие по-прежнему в списке, щелкните обновить.

   ![Последнее событие](media/saas-dbpertenant-restore-single-tenant/last-event-deleted.png)


## <a name="restore-a-tenant-database-in-parallel-with-the-production-database"></a>Восстановление базы данных клиента и рабочей базы данных

Эти действия позволяют восстановить базу данных Contoso Concert Hall до точки во времени перед удалением события. В этом сценарии предполагается, что вам требуется только просмотреть удаленные данные в параллельной базе данных.

 Сценарий *Restore-TenantInParallel.ps1* создает параллельную базу данных клиента *ContosoConcertHall\_old* и параллельную запись каталога. Этот шаблон лучше всего подходит для восстановления после незначительной потери данных или в случае, когда нужно проверить данные на соответствие и выполнить их аудит. Мы также рекомендуем использовать его в базах данных с [георепликацией](sql-database-geo-replication-overview.md).

1. Выполните действия в разделе [Моделирование случайного удаления данных клиента](#simulate-a-tenant-accidentally-deleting-data).
1. Откройте сценарий …\\Learning Modules\\Business Continuity and Disaster Recovery\\RestoreTenant\\_Demo-RestoreTenant.ps1_ в *интегрированной среде сценариев PowerShell*.
1. Задайте **$DemoScenario** = **2** и выполните *восстановление клиента в параллельном режиме*.
1. Нажмите клавишу **F5** для запуска скрипта.

Этот сценарий восстанавливает базу данных клиента до точки во времени перед удалением события. База данных восстанавливается в новую базу данных _ContosoConcertHall\_old_. Метаданные каталога в этой восстановленной базе данных удаляются, а затем база данных добавляется в каталог с помощью ключа, созданного на основе имени *ContosoConcertHall\_old*.

Демонстрационный сценарий открывает в браузере страницу событий для этой новой базы данных клиента. Обратите внимание на следующий фрагмент URL-адреса: ```http://events.wingtip-dpt.&lt;user&gt;.trafficmanager.net/contosoconcerthall_old```. Элемент *_old* в имени означает, что данные на странице получены из восстановленной базы данных.

Просмотрите список событий в браузере и убедитесь, что событие, удаленное в предыдущем разделе, восстановилось.

Обратите внимание на то, что, предоставив доступ к восстановленному клиенту как к дополнительному с собственным приложением событий, вы не сможете получить доступ к восстановленным данным. Но этот способ наглядно иллюстрирует шаблон восстановления. На самом деле вы, вероятно, обеспечите доступ только для чтения к старым данным и сохраните восстановленную базу данных на определенный период. В этом примере после завершения запись восстановленного клиента можно удалить, вызвав сценарий _Remove restored tenant_.

1. Задайте **$DemoScenario** = **4** и *удалите восстановленный клиент*.
1. **Выполните этот сценарий**, **нажав клавишу** **F5**.
1. После этого запись *ContosoConcertHall\_old* удаляется из каталога. Закройте страницу событий этого клиента в браузере.


## <a name="restore-a-tenant-in-place-replacing-the-existing-tenant-database"></a>Восстановление клиента "на месте" с заменой имеющейся базы данных

Эти действия позволяют восстановить клиент Contoso Concert Hall до точки во времени перед удалением события. Сценарий *Restore-TenantInPlace* восстанавливает базу данных клиента в новую базу данных и удаляет исходную.  Этот шаблон лучше всего подходит для восстановления после серьезного повреждения со значительной потерей данных, к которой нужно адаптировать клиент.

1. Откройте файл **Demo-RestoreTenant.ps1** в интегрированной среде сценариев PowerShell.
1. Задайте **$DemoScenario** = **5** и выполните *восстановление клиента "на месте"*.
1. Выполните этот сценарий, нажав клавишу **F5**.

Этот сценарий восстанавливает базу данных клиента то точки во времени перед удалением события. Сначала он отключает клиент Contoso Concert Hall от сети, чтобы предотвратить дальнейшие обновления. Затем из точки восстановления создается параллельная база данных.  В ее имя добавляется метка времени, чтобы имена восстановленной и имеющейся базы данных клиента не приводили к конфликтам. Затем старая база данных клиента удаляется, а восстановленной базе данных присваивается имя исходной. После этого работа клиента Contoso Concert Hall возобновляется и приложение получает доступ к восстановленной базе данных.

Вы успешно восстановили базу данных до точки во времени, предшествующей удалению события. После этого откроется страница событий. Проверьте, восстановилось ли последнее событие.

Обратите внимание на то, что после восстановления базы данных пройдет 10–15 минут, прежде чем ее полная резервная копия станет доступна для повторного восстановления. 

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]

> * восстановить базу данных в параллельную базу данных (параллельное восстановление);
> * восстановить базу данных "на месте".

[Manage schema for multiple tenants in the WTP SaaS application](saas-tenancy-schema-management.md) (Управление схемой нескольких клиентов в SaaS-приложении WTP)

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Дополнительные руководства по работе с приложением SaaS Wingtip](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)
* [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](sql-database-business-continuity.md)
* [Подробнее о резервном копировании базы данных SQL](sql-database-automated-backups.md)
