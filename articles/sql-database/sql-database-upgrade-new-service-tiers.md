<properties 
	pageTitle="Обновление баз данных SQL уровня Web или Business до новых уровней служб" 
	description="Переведите Базу данных SQL Azure уровня Web или Business на новый уровень служб и производительности: Basic, Standard и Premium." 
	services="sql-database" 
	documentationCenter="" 
	authors="stevestein" 
	manager="jeffreyg" 
	editor=""/>

<tags 
	ms.service="sql-database"
	ms.devlang="NA"
	ms.date="06/18/2015" 
	ms.author="sstein" 
	ms.workload="data-management" 
	ms.topic="article" 
	ms.tgt_pltfrm="NA"/>


# Обновление баз данных SQL уровня Web или Business до новых уровней служб

Так как базы данных SQL Azure уровня Web и Business устарели, и [срок их действия заканчивается в сентябре 2015 года](http://msdn.microsoft.com/library/azure/dn741330.aspx), самое время начать планировать их переход на уровни служб Basic, Standard или Premium.

Скачайте [Подробную инструкцию по миграции баз данных уровня Web и Business](http://download.microsoft.com/download/3/C/9/3C9FF3D8-E702-4F5D-A38C-5EFA1DBA73E6/Azure_SQL_Database_Migration_Cookbook.pdf).

> [AZURE.NOTE] [Pricing tier recommendations](sql-database-service-tier-advisor.md)Теперь для баз данных уровня Web и Business стали доступны.

## Обзор

<p> Базы данных SQL Azure уровня Web и Business работают в общей мультитенантной среде без зарезервированного объема ресурсов. Работа других баз данных в этой общей среде ресурсов может повлиять на производительность. Доступность ресурсов в определенный момент времени сильно зависит от параллельных нагрузок, существующих в системе. Это может привести к непостоянной и непредсказуемой производительности приложения базы данных. Клиенты сообщают, что такой непостоянной производительностью сложно управлять и хотелось бы получить более предсказуемое поведение.

Чтобы решить эту проблему, служба Базы данных SQL Azure представила новые уровни служб базы данных [(Basic, Standard и Premium)](http://msdn.microsoft.com/library/dn741340.aspx), которые обеспечивают стабильную производительность и разнообразие новых функций для безопасности и непрерывности коммерческой деятельности. Эти новые уровни служб призваны обеспечить определенный уровень ресурсов для нагрузки базы данных, независимо от других нагрузок клиента, существующих в этой среде. Это обеспечивает четко прогнозируемое поведение системы.

При этом возникают вопросы об оценке новых уровней служб и выбора оптимального уровня для текущих баз данных уровня Web и Business, а также о фактическом процессе обновления.

По большему счету, лучший выбор — это сочетание уровня служб и уровня производительности, которое обеспечит оптимальный баланс возможностей, производительности и стоимости и будет полностью соответствовать потребностям бизнеса и требованиям приложений.

Этот документ содержит интерактивную методологию по обновлению баз данных уровня Web или Business до одного из новых уровней служб и производительности.

Следует отметить, что базы данных SQL Azure не привязаны к конкретному уровню служб или уровню производительности. По мере изменения требований к базе данных вы можете с легкостью переходить с одних доступных уровней служб и уровней производительности на другие. На самом деле, за использование Баз данных SQL уровней Basic, Standard и Premium выставляются счета почасово. Каждую базу данных можно уменьшать и увеличивать 4 раза в течение 24 часов (с помощью [портала Azure или программных инструментов](http://msdn.microsoft.com/library/azure/ff394116.aspx)). Это значит, что вы можете отрегулировать уровень служб и уровень производительности таким образом, чтобы обеспечить необходимую производительность, набор возможностей и стоимость базы данных в зависимости от требований приложения и рабочей нагрузки. Также это означает, что операция оценки и изменения уровня служб и уровня производительности базы данных (увеличение и уменьшение) выполняется периодически, и поэтому она должна быть частью планового обслуживания и процедур настройки производительности.


## Переход баз данных версии Web и Business

Процесс перехода базы данных версии Web или Business на новый уровень служб и производительности не требует перевода базы данных в автономный режим. В процессе обновления база данных не прекращает работу. Во время фактического перехода на новый уровень производительности может произойти кратковременное (как правило порядка нескольких секунд) отключение от базы данных. Если в приложении предусмотрена обработка временных отказов подключения, то этого достаточно, чтобы обеспечить защиту от разъединений соединения на завершающем этапе обновления.

Обновление баз данных уровня Web или Business до новых уровней служб предусматривает выполнение следующих действий:


1. Определение уровня служб на основании функциональности компонентов
2. Определение приемлемого уровня производительности на основании истории использования ресурсов
3. Почему существующая производительность базы данных Web или Business относится к более высоким уровням Premium?
4. настройка рабочей нагрузки в соответствии с более низким уровнем производительности;
5. *Обновление до нового уровня служб или производительности*
6. Мониторинг обновления до нового уровня служб и производительности
7. Мониторинг базы данных после обновления



## 1. Определение уровня служб на основании функциональности компонентов

Уровни служб Basic, Standard и Premium предоставляют разные наборы возможностей, поэтому в первую очередь при выборе подходящего уровня необходимо определить, какой уровень обеспечивает минимальный набор возможностей, необходимых для вашего приложения и бизнеса.

Например, подумайте, как долго должны храниться резервные копии, нужны ли вам функции [стандартной или активной георепликации](http://msdn.microsoft.com/library/azure/dn783447.aspx), какой общий максимальный размер базы данных вам необходим и т. д. Эти требования позволяют определить оптимальный для вас минимальный уровень служб.

Уровень служб Basic обычно используется для очень маленьких баз данных с низкой активностью. Поэтому мы советуем выполнять обновление до уровня Standard или Premium, в зависимости от минимального уровня необходимых функций.

В следующей таблице сравниваются возможности новых уровней служб и показатели уровней производительности:

![Сравнение возможностей уровней служб][1]


**Дополнительные ресурсы для сравнения уровней служб и уровней производительности:**

| Статья | Описание |
|:--|:--|
|[Уровни служб (версии) в базе данных SQL Azure](http://msdn.microsoft.com/library/azure/dn741340.aspx)| Обзор уровней служб Basic, Standard и Premium.|
|[Уровни служб и уровни производительности в базе данных SQL Azure](http://msdn.microsoft.com/library/dn741336.aspx)| Приведены метрики и возможности для каждого уровня служб (а также информация о том, как отслеживать использование баз данных с помощью портала управления и динамических административных представлений). |
|[Что изменилось в уровнях обслуживания?](http://msdn.microsoft.com/library/dn369873.aspx#Different)| Дополнительная информация о разных уровнях служб, включая описание преимуществ одних уровней над другими. |
|[Обеспечение непрерывности работы базы данных SQL Azure](http://msdn.microsoft.com/library/azure/hh852669.aspx)|Информация о функциях обеспечения непрерывности бизнес-процессов и аварийного восстановления (восстановление на момент времени, геовосстановление, георепликация), доступных для разных уровней служб.|
|[Цены на базы данных SQL](http://azure.microsoft.com/pricing/details/sql-database/)|Подробная информация о стоимости разных уровней служб и уровней производительности.|

<br>

Выбрав подходящий уровень служб, который удовлетворяет требования вашей базы данных, необходимо выбрать уровень производительности, приемлемый для фактических рабочих нагрузок базы данных.



## 2. Определение приемлемого уровня производительности на основании истории использования ресурсов

Служба баз данных SQL Azure предоставляет информацию о сравнительно новом уровне служб и уровне производительности для вашей базы данных серии Web или Business на портале управления и в системных представлениях.

Так как для баз данных Web и Business не предусмотрены гарантированные единицы пропускной способности или ограничения ресурсов, мы нормализуем относительные значения в соответствии с объемом ресурсов, доступных для базы данных с уровнем производительности S2. Среднее относительное потребление DTU базы данных в любом заданном интервале можно вычислить как максимальное относительное значение ЦП, ввода-вывода и использования журнала в этом интервале.


Просмотрите общий обзор процентных показателей использования единиц пропускной способности базы данных (DTU) на портале управления, а затем перейдите к системным управлениям, чтобы просмотреть подробную информацию.

Кроме того, на новом портале управления Azure можно просмотреть уровень служб для базы данных уровня Web или Business, рекомендуемый при обновлении сервера до версии 12 Базы данных SQL Azure ([в некоторых регионах доступна только предварительная версия](sql-database-preview-whats-new.md#V12AzureSqlDbPreviewGaTable)).

### Как просмотреть рекомендуемый уровень служб на новом портале управления Azure
При обновлении сервера до версии 12 Базы данных SQL Azure на портале управления рекомендуется соответствующий уровень служб для базы данных уровня Web или Business. Рекомендация основана на результате анализа исторических данных потребления ресурсов базы данных.

**Новый портал управления**

1. Войдите на [новый портал управления](https://portal.azure.com) и перейдите к серверу, содержащему базу данных уровня Web или Business.
2. Щелкните **Последнее обновление** в колонке сервера.
3. Щелкните **Обновить этот сервер**.

Теперь в колонке **Обновить этот сервер** отображается список баз данных уровня Web или Business на сервере, а также рекомендуемый уровень служб.



### Как просматривать показатели потребления единиц пропускной способности базы данных на портале управления
На портале управления содержится информация о потреблении единиц DTU существующей базой данных версии Web или Business. Информация о единицах DTU доступна в текущей версии портала Azure.


**Портал управления**

1. Войдите на [портал управления](https://manage.windowsazure.com) и перейдите к существующей базе данных уровня Web или Business.
2. Щелкните вкладку **МОНИТОР**.
3. Нажмите кнопку **ДОБАВИТЬ МЕТРИКИ**.
4. Выберите **Процент использования DTU** и щелкните значок с галочкой внизу для подтверждения.

После подтверждения вы увидите данные по **проценту использования DTU** в таблице. Помните, что этот процент показан в сравнении с количеством использования единиц DTU в базе данных уровня Standard (S2), которое равно 50.

Также следует отметить, что эти данные основаны на среднем показателе выборок, которые берутся каждые 5 минут, поэтому в них могут не отображаться короткие всплески активности, произошедшие между выборками.

![Данные по проценту использования DTU][2]

Обратите внимание, что в примере выше показан средний показатель использования примерно 10 единиц DTU (19,23 % на 50 единиц) и максимальный показатель использования примерно 28 единиц DTU (55,83 % на 50 единиц). Если эти данные соответствуют моей обычной рабочей нагрузке, мне следует выбрать уровень Standard (S1) для начального перехода. Уровень Standard (S0) обеспечивает 10 единиц DTU (мой средний показатель использования), и, следовательно, моя база данных в среднем использовала бы 100 % емкости, что является не лучшим вариантом. Уровень S1, скорее всего, подошел бы для моего среднего показателя использования, но что насчет максимального показателя использования? Если мне известно, что пики происходят во время некоторых ночных процессов обслуживания, и они не влияют на фактическое использование клиентами, сниженная производительность в этом промежутке времени приемлема. Однако, если мне не известно, когда происходят пики активности, потребление единиц DTU требует дальнейшего анализа.

Просмотреть подробную информацию о потреблении ресурсов базы данных можно с помощью предоставленных системных представлений.


### Системные представления


Данные о потреблении ресурсов баз данных уровня Web и Business можно получить с помощью представления [sys.resource_stats](http://msdn.microsoft.com/library/azure/dn269979.aspx) в главной базе данных логического сервера, где расположена текущая база данных. Она отображает данные о потреблении ресурсов в процентах от ограничения уровня производительности. Это представление содержит данные по меньшей мере за 14 дней с пятиминутным интервалом.

> [AZURE.NOTE]Теперь в базах данных уровня Web и Business можно использовать представление [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) для повышения точности детализации (каждые 15 секунд) данных о потреблении ресурсов. Так как представление sys.dm_db_resource_stats сохраняет исторические данные только за один час, можно запрашивать это динамическое административное представление ежечасно и сохранять данные для дополнительного анализа.

Выполните следующий запрос в базе данных master, чтобы извлечь среднее значение потребления DTU для базы данных:

 
                   
     SELECT start_time, end_time
	 ,(SELECT Max(v)
         FROM (VALUES (avg_cpu_percent)
                    , (avg_physical_data_read_percent)
                    , (avg_log_write_percent)
    	   ) AS value(v)) AS [avg_DTU_percent]
    FROM sys.resource_stats
    WHERE database_name = '<your db name>'
    ORDER BY end_time DESC;

В данных, возвращаемых представлениями [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) и [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) для уровней Web и Business, указываются проценты относительно уровня производительности Standard S2. Например, если при выполнении в базе данных уровня Web или Business возвращается показатель 70 %, это означает, что потребление составляет 70 % от ограничения на уровне S2. Кроме того, для уровней Web и Business проценты могут отражать количество используемых ресурсов выше 100 %, которое также основано на ограничении на уровне S2.

Данные о потреблении DTU для базы данных уровня S2 позволяют нормализовать текущее потребление ваших баз данных уровня Web и Business с учетом нового уровня баз данных, а также узнать об оптимальном использовании. Например, если ваш средний показатель относительного потребления DTU составляет 80 %, это означает, что база данных потребляет единицы DTU на уровне 80 % от ограничения базы данных с уровнем производительности S2. Если это значение составляет больше 100 % в представлении **sys.resource_stats**, необходимо использовать уровень производительности, превышающий S2. Предположим, зафиксировано пиковое относительное значение DTU на уровне 300 %. Это означает, что вы потребляете в три раза больше ресурсов, чем допустимо на уровне S2. Чтобы определить оптимальный начальный размер, сравните количество единиц DTU, доступных на уровне S2 (50 единиц DTU), с аналогичными показателями других уровней(S3/P1 = 100 ед. DTU или 200 % от уровня S2, P2 = 200 ед. DTU или 400 % от уровня S2). Так как ваш показатель составляет 300 % на уровне S2, можно начать с уровня P2 и снова выполнить проверку.

В зависимости от процента использования DTU и максимального уровня, соответствующего вашей нагрузке, можно определить уровень служб и производительности, подходящий для нагрузки вашей базы данных (как указано процентным соотношением DTU и относительными значениями DTU для различных [уровней производительности)](http://msdn.microsoft.com/library/azure/dn741336.aspx). В таблице ниже приведено сопоставление потребления ресурсов для уровней Web или Business по сравнению с эквивалентным потреблением на новом уровне производительности.

![Потребление ресурсов][4]

> **Примечание**. Относительные значения DTU для различных уровней производительности приведены для рабочей нагрузки [стандартной Базы данных SQL Azure](http://msdn.microsoft.com/library/azure/dn741327.aspx). Так как нагрузка вашей базы данных, вероятно, отличается от стандартной, необходимо использовать приведенные выше расчеты для определения оптимального нового уровня служб вашей базы данных Web или Business. Обновив уровень служб своей базы данных, воспользуйтесь процедурой, описанной в предыдущем разделе, чтобы проверить или настроить оптимальный уровень служб, соответствующий вашей нагрузке.
> 
> Тогда как предложенный уровень производительности нового выпуска зависит от активности вашей базы данных за последние 14 дней, эти данные основываются на образцах данных потребления ресурсов, усредненных за последние 5 минут. Таким образом, могут остаться неучтенными короткие вспышки активности, продолжительность которых не превышает 5 минут. Поэтому это руководство следует использовать как начальную точку для обновления своей базы данных. После обновления базы данных до предложенного уровня потребуются дополнительные контроль, проверки и испытания, и уровень производительности базы данных может быть повышен или понижен, если потребуется.

Ниже приведен запрос базы данных master, который выполняет расчет для вашей базы данных уровня Web или Business и предлагает выпуск, вероятно соответствующий вашей нагрузке для каждого из этих пятиминутных интервалов.

> **Примечание**. Этот запрос предназначен только для баз данных уровня Web и Business и **не** гарантирует получение правильных результатов для баз данных новых уровней.

    WITH DTU_mapping AS
    ( SELECT *
        FROM ( VALUES (1, 10,'Basic'), (2, 20,'S0'), (3, 40,'S1'), (4, 100, 'S2')
                    , (5, 200, 'S3/P1'), (6, 1600,'Premium')
           ) AS t(id, percent_of_S2, target_edition)
    ), rc as
    ( SELECT start_time, end_time
           , (SELECT Max(v)
                FROM (VALUES (avg_cpu_percent)
                       		, (avg_physical_data_read_percent)
                       		, (avg_log_write_percent)
                   ) AS value(v)) as [avg_DTU_percent]
        FROM sys.resource_stats	
       WHERE database_name = 'WebDB'
    )
    SELECT rc.*
         , (SELECT TOP(1) t.target_edition
              FROM DTU_mapping AS t
             WHERE t.percent_of_S2 > CAST(1.2*rc.avg_DTU_percent as int)
             ORDER BY t.percent_of_S2) as target_edition
    FROM rc;

**Пример результата:**

![Пример результата](media/sql-database-upgrade-new-service-tiers/sample_result.png)

На графике изображена кривая среднего относительного потребления DTU в динамике. Ниже приведен образец графика для базы данных, показатели которой преимущественно соответствуют уровню S2 с несколькими вспышками пиковой активности, соответствующими уровню базы данных P1. Потребление DTU в динамике зависит от ограничений уровней Basic и P1. Чтобы полностью привести показатели этой базы данных к новому уровню, потребуется база данных с уровнем служб Premium и уровнем производительности P1. С другой стороны, база данных уровня S2 может подойти, если эти периодические вспышки, соответствующие уровню P1, возникают не часто.

![Использование DTU](media/sql-database-upgrade-new-service-tiers/DTU_usage.png)

**Влияние памяти на производительность**. Хотя память является одной из характеристик ресурсов, которая вносит свой вклад в оценку DTU, База данных SQL предназначена для использования всей доступной памяти для операций с базами данных. Поэтому потребление памяти не учитывается в показателе среднего потребления DTU в приведенном выше запросе. С другой стороны, если вы понижаете уровень производительности, количество доступной памяти для базы данных уменьшается. Это может повысить количество операций ввода-вывода, что скажется на показателе потребления DTU. Поэтому, прежде чем понизить уровень производительности, убедитесь, что у вас есть резерв операций ввода-вывода. Воспользуйтесь для этого динамическим административным представлением [sys.dm_ db_ resource_stats](http://msdn.microsoft.com/library/azure/dn800981.aspx), указанным выше.



## 3. Почему существующая производительность базы данных Web или Business относится к более высоким уровням Premium?

В базах данных версии Web и Business нет определенного объема ресурсов, который резервируется для любой отдельной базы данных. Кроме того, в этих базах данных отсутствует механизм, позволяющий клиентам увеличивать и уменьшать масштаб производительности. Это ведет к резким перепадам производительности этих баз данных — от слишком медленной до производительности уровня Premium. Этот непостоянный диапазон производительности *необоснованно* зависит от общего уровня потребления ресурсов другими базами данных с общим доступом в мультитенантной среде в любой момент времени.

Разумеется, целью служб базы данных SQL Azure является максимальное приближение уровня производительности всех баз данных Web и Business к оптимальному уровню в 100 %. Благодаря этим службам средняя производительность баз данных Web и Business соответствует уровню Premium. Именно поэтому производительность существующей базы данных можно сопоставить с текущими уровнями Premium. К сожалению, это вызывает несколько нереалистичные ожидания при сравнении баз данных Web и Business с новыми уровнями служб и уровнями производительности во время оценки уровней служб для перехода.

Чтобы более четко понять разницу между базами данных Web и Business, а также уровнями служб Basic, Standard и Premium, ознакомьтесь с рисунком ниже. Сравним 9 баз данных SQL, работающих по модели баз данных Web и Business с общими ресурсами, с 9 базами данных SQL, работающими по модели уровней служб Basic, Standard или Premium. В моделях уровня Web и Business четко видно влияние этих так называемых «шумных соседей» на другие базы данных в этом пуле общих ресурсов. Если одна база данных обрабатывает ресурсоемкую рабочую нагрузку, это влияет на все остальные базы данных в пуле, и доступные ресурсы начинают уменьшаться. На уровнях служб Basic, Standard и Premium для каждой базы данных ***выделяется*** определенный объем ресурсов, что обеспечивает существенную изоляцию других баз данных в общей среде от так называемого «шумного соседа» и поддерживает их производительность на уровне, выбранном для конкретной базы данных.

![Прогнозируемая производительность новых уровней служб][3]

Если общий процент потребления единиц DTU слишком велик, необходимо просмотреть касающиеся их подробные метрики, в особенности детальную информацию об операциях ввода-вывода журнала и использовании памяти. Это позволит обнаружить потенциальные области, в которых можно оптимизировать и уменьшить потребление единиц DTU.


## 4. Настройка рабочей нагрузки базы данных в соответствии с более низким уровнем производительности
Если анализ истории использования ресурсов вашей базы данных указывает на то, что вам следует перейти на уровень производительности, стоимость которого существенно дороже желаемой, можно попытаться дополнительно настроить производительность некоторых областей.

Учитывая ваши знания подробной информации о приложении, если уровень использования ресурсов кажется слишком высоким по сравнению с ожидаемым уровнем обычной рабочей нагрузки, возможно, вы можете оптимизировать работу приложения путем настройки производительности.

На самом деле, повторная настройка производительности может оптимизировать любую базу данных.

Помимо обычной настройки, например анализа индексов, планов выполнения т. д., следует оптимизировать процедуры доступа к данным для целевой базы данных SQL Azure.

| Статья | Описание |
|:--|:--|
| [Руководство по производительности базы данных SQL Azure](http://msdn.microsoft.com/library/dn369873.aspx) | В разделе «Настройка приложения» содержатся подробные указания и методы настройки производительности Базы данных SQL Azure.|
|[Средства контроля и настройки производительности](https://msdn.microsoft.com/library/ms179428.aspx)| Здесь содержатся ссылки и описания доступных инструментов для мониторинга событий в SQL Server и настройки структуры физической базы данных.|
|[Наблюдение и настройка производительности](https://msdn.microsoft.com/library/ms189081.aspx)|Раздел по настройке производительности SQL Server 2014 на сайте MSDN.|
| [Устранение неполадок производительности в SQL Server 2008](https://msdn.microsoft.com/library/dd672789.aspx) | Старый, но по-прежнему действующий технический документ по устранению общих проблем производительности, в котором содержится полезная информация об устранении неполадок памяти и узких мест ЦП.|
|[Решение проблем и оптимизация запросов в Базе данных SQL Azure](http://social.technet.microsoft.com/wiki/contents/articles/1104.troubleshoot-and-optimize-queries-with-azure-sql-database.aspx)|Старый, но по-прежнему действующий раздел о динамических административных представлениях и способах их использования для устранения неполадок.|



## 5. Обновление до нового уровня служб или производительности
Определив необходимый уровень служб и производительности для своей базы данных Web или Business, можно воспользоваться одним из множества способов обновления базы данных до этого уровня.

| Инструмент управления | Для изменения уровня служб и уровня производительности базы данных|
| :---| :---|
| [Портал управления Azure](https://manage.windowsazure.com) | Щелкните вкладку **МАСШТАБ** на странице панели мониторинга вашей базы данных. |
| [Azure PowerShell](http://msdn.microsoft.com/library/azure/dn546726.aspx) | Используйте командлет [Set-AzureSqlDatabase](http://msdn.microsoft.com/library/azure/dn546732.aspx). |
| [Интерфейс REST API управления службой](http://msdn.microsoft.com/library/azure/dn505719.aspx) | Используйте команду [Обновить базу данных](http://msdn.microsoft.com/library/dn505718.aspx).|
| [Transact-SQL](http://msdn.microsoft.com/library/bb510741.aspx) | Используйте оператор [ALTER DATABASE (Transact-SQL)](http://msdn.microsoft.com/library/ms174269.aspx). |

Дополнительную информацию см. в разделе [Изменение уровней служб и уровней производительности базы данных](http://msdn.microsoft.com/library/dn369872.aspx).


## 6. Мониторинг обновления до нового уровня служб и производительности
База данных SQL Azure содержит информацию о ходе операций управления (например, CREATE, ALTER, DROP), выполняемых в базе данных в динамическом административном представлении sys.dm_operation_status в главной базе данных логического сервера, на котором размещена ваша текущая база данных. [см. документацию по sys.dm _operation _status.](http://msdn.microsoft.com/library/azure/dn270022.aspx) Воспользуйтесь динамическим административным представлением состояния операции, чтобы узнать о ходе выполнения обновления базы данных. Приведенный ниже пример запроса содержит все операции управления, выполняемые для базы данных:

    SELECT o.operation, o.state_desc, o.percent_complete
    , o.error_code, o.error_desc, o.error_severity, o.error_state
    , o.start_time, o.last_modify_time
    FROM sys.dm_operation_status AS o
    WHERE o.resource_type_desc = 'DATABASE'
    and o.major_resource_id = '<database_name>'
    ORDER BY o.last_modify_time DESC;

Если обновление выполнялось с помощью портала управления, отображается оповещение портала о выполняемой операции.

### Что происходит, когда нагрузка базы данных достигает предельных значений после обновления?
Уровни производительности определяются и регулируются, чтобы обеспечить необходимые ресурсы для работы базы данных в условиях максимальной нагрузки, предусмотренной вашим уровнем служб или производительности (например, потребление ресурсов на уровне 100 %). Если ваша нагрузка достигнет предела по одному из показателей (ЦП, ввод-вывод данных, ввод-вывод журнала), вы продолжите получать ресурсы на максимально допустимом уровне, но может увеличиться задержка обработки ваших запросов. Превышение одного из этих ограничений не приведет к возникновению каких-либо ошибок, а только к замедлению обработки, которая со временем может перерасти в превышение времени ожидания запросов. При достижении максимального предельного значения количества параллельных пользовательских сеансов или запросов (рабочих потоков) отобразится [ошибка 10928 или 10929](http://msdn.microsoft.com/library/azure/dn338078.aspx).


## 7. Мониторинг базы данных после обновления
После обновления уровня служб базы данных Web или Business мы советуем регулярно отслеживать состояние базы данных, чтобы обеспечить надлежащую производительность приложений и оптимизированное использование ресурсов. Для мониторинга базы данных мы советуем выполнить приведенные ниже дополнительные действия.


**Данные о потреблении ресурсов**. Для баз данных уровня Basic, Standard и Premium более точные данные о потреблении доступны в новом динамическом административном представлении [sys.dm_ db_ resource_stats](http://msdn.microsoft.com/library/azure/dn800981.aspx) в базе данных пользователя. Это динамическое административное представление предоставляет данные о потреблении практически в реальном времени с 15-секундной детализацией за предыдущий час работы. Относительное потребление DTU за интервал вычисляется как максимальное относительное потребление показателей ЦП, операций ввода-вывода и журнала. Ниже приведен запрос, который вычисляет среднее относительное потребление DTU за последний час:

    SELECT end_time
    	 , (SELECT Max(v)
             FROM (VALUES (avg_cpu_percent)
                         , (avg_data_io_percent)
                         , (avg_log_write_percent)
    	   ) AS value(v)) AS [avg_DTU_percent]
    FROM sys.dm_db_resource_stats
    ORDER BY end_time DESC;

 
Дополнительная [документация](http://msdn.microsoft.com/library/dn800981.aspx) содержит подробную информацию об использовании динамического административного представления. [Руководство по производительности базы данных SQL Azure](http://msdn.microsoft.com/library/azure/dn369873.aspx) содержит информацию о мониторинге ваших приложений и их настройке.


- **Оповещения**. Настройте оповещения на портале управления Azure, чтобы получать уведомления о приближении показателя потребления DTU для обновленной базы данных до высокого уровня. На портале управления Azure можно настроить оповещения базы данных для различных метрик производительности, например DTU, ЦП, ввод-вывод и журнал. 

	Например, можно настроить оповещение в сообщении электронной почты об относительном потреблении DTU, если среднее относительное потребление DTU превышает 75 % за последние 5 минут. Дополнительную информацию о настройке уведомлений об оповещениях см. в разделе [Инструкции. Получение уведомлений и управление правилами уведомлений в Azure](http://msdn.microsoft.com/library/azure/dn306638.aspx).


- **Запланированное повышение или понижение уровня производительности**. Если ваше приложение выполняет задачи, требующие большего количества ресурсов только в определенное время и дни недели, можно воспользоваться [службой автоматизации Azure](http://msdn.microsoft.com/library/azure/dn643629.aspx), чтобы повышать или понижать уровень производительности своей базы данных, когда это необходимо.

	Например, повышение уровня производительности базы данных на неделю для выполнения обслуживания или пакетных операций с последующим понижением уровня. Такого рода планирование также полезно для выполнения больших ресурсоемких задач, например загрузки данных, перестройки индекса и т. д. Обратите внимание, что в основе модели выставления счетов в Базе данных SQL Azure лежит принцип почасового использования уровня служб и производительности. Такая гибкость позволяет планировать обновления более эффективно.



## Сводка
Служба базы данных SQL предоставляет данные телеметрии и средства для оценки нагрузок вашей базы данных Web или Business и определяет оптимальный уровень служб, доступный для обновления. Процесс обновления довольно простой и может быть выполнен без перевода базы данных в автономный режим и без потери данных. Обновленные базы данных смогут использовать преимущества прогнозируемой производительности и дополнительных функций, обеспеченных новыми уровнями служб.




<!--Image references-->
[1]: ./media/sql-database-upgrade-new-service-tiers/service-tier-features.png
[2]: ./media/sql-database-upgrade-new-service-tiers/portal-dtus.JPG
[3]: ./media/sql-database-upgrade-new-service-tiers/web-business-noisy-neighbor.png
[4]: ./media/sql-database-upgrade-new-service-tiers/resource_consumption.png

 

<!----HONumber=July15_HO4-->