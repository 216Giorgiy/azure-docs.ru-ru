---
title: "Подготовка новых клиентов и их каталогизация в приложении SaaS с помощью мультитенантной базы данных SQL Azure | Документация Майкрософт"
description: "Сведения о подготовке и каталогизации новых клиентов в приложении SaaS мультитенантной базы данных SQL Azure"
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: saas apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/20/2017
ms.author: billgib
ms.openlocfilehash: ec753027c8ce8040cbc574279a44eb24590fcb05
ms.sourcegitcommit: 62eaa376437687de4ef2e325ac3d7e195d158f9f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/22/2017
---
# <a name="provision-and-catalog-new-tenants-in-a-saas-application-using-a-sharded-multi-tenant-sql-database"></a>Подготовка новых клиентов и их каталогизация в приложении SaaS с помощью сегментированной мультитенантной базы данных SQL

В этом руководстве вы узнаете о шаблонах для подготовки клиентов и их каталогизации при работе с моделью сегментированной мультитенантной базы данных. 

Мультитенантная схема, которая включает идентификатор клиента в первичном ключе таблиц, содержащих данные клиента, позволяет хранить несколько клиентов в одной базе данных. Чтобы обеспечить поддержку большого числа клиентов, данные клиента распределяются по нескольким сегментам или базам данных. Данные любого клиента всегда полностью содержатся в одной базе данных.  Каталог используется для размещения сопоставления клиентов с базами данных.   

Вы также можете заполнить некоторые базы данных только одним клиентом. Базы данных, которые содержат несколько клиентов, позволяют сократить расходы на каждого клиента за счет их изоляции.  Базы данных, которые содержат только один клиент, выполняют изоляцию без лишних затрат.  Базы данных с несколькими клиентами и с одним клиентом можно совместно использовать в одном приложении SaaS для оптимизации затрат или изоляции каждого клиента. Клиенты могут получить собственные базы данных после завершения подготовки. Их также можно переместить в их собственные базы данных позже.

   ![Приложение с сегментированной мультитенантной базой данных и каталогом клиента](media/saas-multitenantdb-provision-and-catalog/MultiTenantCatalog.png)


## <a name="tenant-catalog-pattern"></a>Шаблон каталога клиента

Если данные клиента распределены по нескольким базам данных, важно знать, где хранятся данные каждого клиента. База данных каталога содержит сопоставление клиентов и баз данных, в которых хранятся их данные.

Каждый клиент определяется по ключу в каталоге. В SaaS-приложении Wingtip Tickets ключ клиента формируется из хэша имени клиента. Это позволяет приложению извлекать имя клиента из URL-адреса веб-страницы и использовать его для подключения к подходящей базе данных. Вы также можете использовать и другие схемы ключа клиента.

Благодаря использованию каталога можно изменить имя или расположение базы данных клиента после подготовки, не прерывая работу приложения.  В мультитенантной модели базы данных это обеспечивает перемещение клиента между базами данных.  Кроме того, каталог можно использовать, чтобы указать приложению, находится ли клиент в автономном режиме для обслуживания или других действий.

Вы можете расширить каталог, чтобы хранить дополнительные метаданные клиента или базы данных. Например, сведения об уровне или выпуске базы данных, версии схемы базы данных, имени клиента, плане обслуживания или соглашении об уровне обслуживания и другую информацию, которая позволяет осуществлять управление приложениями, поддержку пользователей или процессы DevOps.  

Каталог можно также использовать, чтобы создавать отчеты между клиентами, управлять схемой и извлекать данные для аналитики. 

### <a name="elastic-database-client-library"></a>Клиентская библиотека эластичной базы данных 
Каталог в SaaS-приложении Wingtip Tickets реализуется в базе данных *tenantcatalog* с помощью функций управления сегментами из [клиентской библиотеки эластичной базы данных (EDCL)](sql-database-elastic-database-client-library.md). Библиотека позволяет приложению создавать, администрировать и использовать карту сегментов на основе базы данных. Карта сегментов содержит список сегментов (баз данных) и сопоставления между ключами (идентификаторами клиента) и сегментами.  Функции EDCL можно использовать в приложениях или скриптах PowerShell при подготовке клиента, чтобы создавать записи в карте сегментов, а потом выполнить подключение к нужной базе данных. Библиотека кэширует сведения о подключении, чтобы уменьшить объем входящего трафика для базы данных каталога и ускорить подключение. 

> [!IMPORTANT]
> Данные сопоставления доступны в базе данных каталога. *Не изменяйте их*. Изменяйте данные сопоставления только с помощью интерфейсов API EDCL. Прямые манипуляции с данными сопоставления могут привести к повреждению каталога. Такие операции не поддерживаются.


## <a name="tenant-provisioning-pattern"></a>Шаблон подготовки клиента

При подготовке нового клиента в модели сегментированной мультитенантной базы данных сначала необходимо определить, будет ли клиент подготовлен в общей базе данных или ему предоставят собственную. Если он будет подготовлен в общей базе данных, следует определить, есть ли место в имеющейся базе данных или необходимо создать еще одну. Новая база данных должна быть подготовлена в нужном расположении с настройкой требуемого уровня обслуживания, инициализирована с надлежащей схемой и ссылочными данными, а затем зарегистрирована в каталоге. Наконец, можно добавить сопоставление клиентов, чтобы ссылаться на соответствующий сегмент.

Чтобы подготовить базу данных, выполните скрипты SQL, разверните файл BACPAC или скопируйте шаблон базы данных. SaaS-приложения Wingtip Tickets копируют шаблон базы данных, чтобы создать базы данных клиентов.

Метод подготовки базы данных должен охватывать общую стратегию управления схемой, чтобы обеспечить подготовку новых баз по последней схеме.  Это описано далее в руководстве [Управление схемой для нескольких клиентов в мультитенантном приложении, использующем базу данных SQL Azure](saas-tenancy-schema-management.md).  

Скрипты подготовки клиентов в этом руководстве включают подготовку клиента в имеющейся базе данных, используемой совместно с другими клиентами, и подготовку клиента в собственной базе данных. Данные клиента затем инициализируются и регистрируются в карте сегментов каталога. В примере приложения базам данных, которые содержат несколько клиентов, присваивается универсальное имя, например *tenants1*, *tenants2* и т. д. Базам данных, которые содержат один клиент, присваивается имя клиента. Определенные соглашения об именовании, используемые в примере, не являются критически важным требованием для шаблона, так как благодаря применению каталога базе данных можно присвоить любое имя.  

## <a name="provision-and-catalog-tutorial"></a>Руководство по подготовке и каталогизации

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]

> * подготавливать клиента в мультитенантной базе данных;
> * подготавливать клиента в однотенантной базе данных;
> * подготавливать пакет клиентов в мультитенантной и однотенантной базе данных;
> * регистрировать сопоставление баз данных и клиентов в каталоге.

Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS-приложение Wingtip Tickets c мультитенантной БД. Вы можете развернуть его менее чем за пять минут, используя инструкцию из статьи [Deploy and explore a sharded multi-tenant application that uses Azure SQL Database](saas-multitenantdb-get-started-deploy.md) (Развертывание и изучение сегментированного мультитенантного приложения, использующего Базу данных SQL Azure).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="get-the-wingtip-tickets-management-scripts"></a>Получение скриптов управления для приложения Wingtip Tickets

Скрипты управления и исходный код приложения доступны в репозитории GitHub [WingtipTicketsSaaS-MultiTenantDB](https://github.com/Microsoft/WingtipTicketsSaaS-MultiTenantDB). <!--See [Steps to download the Wingtip SaaS scripts](saas-tenancy-wingtip-app-guidance-tips.md#download-and-unblock-the-wingtip-saas-scripts).-->


## <a name="provision-a-tenant-in-a-shared-database-with-other-tenants"></a>Подготовка клиента в базе данных, используемой совместно с другими клиентами

Чтобы понять, как приложение Wingtip Tickets подготавливает новый клиент в общей базе данных, добавьте точку останова и перейдите к выполнению рабочего процесса:

1. В _интегрированной среде сценариев PowerShell_ откройте файл …\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ и задайте следующие параметры:
   * **$TenantName** = **Bushwillow Blues** — имя нового мероприятия.
   * **$VenueType** = **blues** — один из предопределенных типов мероприятия: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer (в нижнем реестре без пробелов).
   * Для параметра **$Scenario** =  установите значение **1**, чтобы *подготовить клиента в базе данных, используемой совместно с другими клиентами*.

1. Добавьте точку останова, поместив курсор в любом месте строки 38, содержащей *New-Tenant `*, и нажмите клавишу **F9**.

   ![точка останова](media/saas-multitenantdb-provision-and-catalog/breakpoint.png)

1. Нажмите клавишу **F5** для запуска сценария.

1. После остановки выполнения скрипта в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.

   ![debug](media/saas-multitenantdb-provision-and-catalog/debug.png)

Отслеживайте выполнение скрипта и используйте клавиши **F10** и **F11** (меню **Отладка**), чтобы обойти вызываемые функции или перейти в них по очереди. Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).


Ниже приведены основные этапы рабочего процесса подготовки.

* **Вычисление нового ключа клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
* **Проверка наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ еще не зарегистрирован.
* **Инициализация клиента в базе данных клиента по умолчанию.** База данных клиента обновляется для добавления информации о новом клиенте.  
* **Регистрация клиента в каталоге.** Сопоставление нового ключа клиента и имеющейся базы данных tenants1 добавляется в каталог. 
* **Добавление имени клиента в таблицу расширения каталога.** Имя мероприятия добавляется в таблицу клиентов в каталоге.  Здесь показано, как можно расширить базу данных каталога для поддержки дополнительных данных приложения.
* **Открытие страницы мероприятий для нового клиента.** Страница мероприятий *Bushwillow Blues* открыта в браузере:

   ![events](media/saas-multitenantdb-provision-and-catalog/bushwillow.png)


## <a name="provision-a-tenant-in-its-own-database"></a>Подготовка клиента в собственной базе данных

Теперь рассмотрите процесс создания клиента в собственной базе данных.

1. В файле …\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ задайте следующие параметры.
   * **$TenantName** = **Sequoia Soccer** — имя нового мероприятия.
   * **$VenueType** = **soccer** — один из предопределенных типов мероприятия: blues, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, *soccer* (в нижнем реестре без пробелов).
   * Для параметра **$Scenario** =  установите значение **2**, чтобы *подготовить клиента в базе данных, используемой совместно с другими клиентами*.

1. Добавьте новую точку останова, поместив курсор в любом месте строки 57, содержащей *&&nbsp;$PSScriptRoot\New-TenantAndDatabase `*, и нажмите клавишу **F9**.

   ![точка останова](media/saas-multitenantdb-provision-and-catalog/breakpoint2.png)

1. Нажмите клавишу **F5** для запуска скрипта.

1. После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.  С помощью клавиш **F10** и **F11** можно обойти функцию или перейти в нее для отслеживания выполнения.

Ниже приведены основные этапы рабочего процесса при трассировке скрипта.

* **Вычисление нового ключа клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
* **Проверка наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ еще не зарегистрирован.
* **Создание базы данных клиента.** База данных создается путем копирования базы данных *basetenantdb* с помощью шаблона Resource Manager.  Имя новой базы данных основано на имени клиента.
* **Добавление базы данных в каталог.** Новая база данных клиента регистрируется в качестве сегмента в каталоге.
* **Инициализация клиента в базе данных клиента по умолчанию.** База данных клиента обновляется для добавления информации о новом клиенте.  
* **Регистрация клиента в каталоге.** Сопоставление ключа нового клиента и базы данных *sequoiasoccer* добавляется в каталог.
* **Имя клиента добавляется в каталог.** Имя мероприятия добавляется в таблицу расширения клиентов в каталоге.
* **Открытие страницы мероприятий для нового клиента.** Страница мероприятий *Sequoia Soccer* открыта в браузере:

   ![events](media/saas-multitenantdb-provision-and-catalog/sequoiasoccer.png)


## <a name="provision-a-batch-of-tenants"></a>Подготовка пакета клиентов

В этом упражнении подготавливается пакет из 17 клиентов. Рекомендуется подготовить этот пакет клиентов перед выполнением задач других руководств по Wingtip Tickets, чтобы вы могли работать с большим количеством баз данных.

1. В *интегрированной среде сценариев PowerShell* откройте файл …\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* и измените значение параметра *$Scenario* на 3.
   * Для параметра **$Scenario** =  установите значение **3**, чтобы *подготовить пакет клиентов в общей базе данных*.
1. Нажмите клавишу **F5** для запуска скрипта.


### <a name="verify-the-deployed-set-of-tenants"></a>Проверка развернутого набора клиентов 
На этом этапе у вас есть клиенты, развернутые в общей базе данных, и клиенты, развернутые в собственных базах данных. С помощью портала Azure можно просмотреть созданные базы данных.  

* На [портале Azure](https://portal.azure.com) откройте сервер **tenants1-mt-\<Пользователь\>**, перейдя к списку серверов SQL.  Список **баз данных SQL** должен включать общую базу данных **tenants1** и базы данных для клиентов, которые расположены в собственных базах данных.

   ![список баз данных](media/saas-multitenantdb-provision-and-catalog/Databases.png)

Хотя на портале Azure отображаются базы данных клиентов, вы не можете просмотреть клиенты *внутри* общих баз данных. Полный список клиентов можно просмотреть на странице концентратора событий Wingtip Tickets или с помощью каталога.   

1. Откройте страницу концентратора событий в браузере (http:events.wingtip-mt.\<Пользователь\>.trafficmanager.net).  

   Полный список клиентов и их соответствующие базы данных можно просмотреть в каталоге. Представление SQL содержится в базе данных tenantcatalog, где имя клиента, хранящееся в таблице клиентов, объединяется с именем базы данных в таблице управления сегментами. В этом представлении хорошо показано ценность расширения метаданных, хранящихся в каталоге.

2. В *SQL Server Management Studio (SSMS)* подключитесь к серверу клиентов в **tenants1-mt.\<Пользователь\>.database.windows.net**, указав в качестве имени для входа **developer**, а в качестве пароля **P@ssword1**.

    ![Диалоговое окно подключения SSMS](media/saas-multitenantdb-provision-and-catalog/SSMSConnection.png)

2. В *обозревателе объектов* перейдите к представлениям в базе данных *tenantcatalog*.
2. Щелкните правой кнопкой мыши представление *TenantsExtended* и выберите **Select Top 1000 Rows** (Выбрать первые 1000 строк). Обратите внимание на сопоставление имени клиента и базы данных для разных клиентов.

    ![Представление ExtendedTenants в SSMS](media/saas-multitenantdb-provision-and-catalog/extendedtenantsview.png)
      
## <a name="other-provisioning-patterns"></a>Другие шаблоны подготовки

Ниже приведены другие интересные шаблоны подготовки.

**Предварительная подготовка баз данных в эластичных пулах.** В шаблоне предварительной подготовки учитывается тот факт, что при использовании эластичных пулов счета выставляются за пулы, а не за базы данных. Таким образом, можно добавить базы данных в эластичный пул до того, как они понадобятся, чтобы избежать лишних расходов. Предварительная подготовка баз данных в пуле и их выделение при необходимости может значительно сократить время подготовки клиента в базе данных. Вы можете заранее подготовить любое удобное количество баз данных, чтобы поддерживать буфер достаточного размера для ожидаемого темпа добавления клиентов.

**Автоматическая подготовка.** В шаблоне автоматической подготовки используется выделенная служба для автоматической подготовки серверов, пулов и баз данных, включая предварительную подготовку баз данных в эластичных пулах. При списании и удалении баз данных созданные пропуски в эластичных пулах могут заполняться службой подготовки в случае необходимости. Такая служба может быть простой или более сложной. С ее помощью можно, например, управлять подготовкой в нескольких географических регионах и (или) настраивать георепликацию для аварийного восстановления. С помощью шаблона автоматической подготовки клиентское приложение или скрипт может отправить запрос на подготовку в очередь для обработки службой подготовки, а затем будет выполнять запрос, чтобы получить данные о завершении. Если используется предварительная подготовка, запрос обрабатывается быстро, в то время как другая служба будет управлять подготовкой базы данных для замены в фоновом режиме.



## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]

> * Подготовка нового клиента в общей мультитенантной базе данных и в собственной базе данных.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.

Ознакомьтесь с [руководством по мониторингу производительности](saas-multitenantdb-performance-monitoring.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

<!--* Additional [tutorials that build upon the Wingtip SaaS application](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)-->
* [Клиентская библиотека эластичной базы данных](sql-database-elastic-database-client-library.md)
* [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)
