<properties 
    pageTitle="Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью PowerShell | Microsoft Azure" 
    description="Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью PowerShell" 
    services="sql-database" 
    documentationCenter="" 
    authors="stevestein" 
    manager="jhubbard" 
    editor=""/>

<tags
    ms.service="sql-database"
    ms.devlang="NA"
    ms.topic="article"
    ms.tgt_pltfrm="powershell"
    ms.workload="data-management" 
    ms.date="04/27/2016"
    ms.author="sstein"/>

# Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью PowerShell



> [AZURE.SELECTOR]
- [Портал Azure](sql-database-geo-replication-failover-portal.md)
- [PowerShell](sql-database-geo-replication-failover-powershell.md)
- [Transact-SQL](sql-database-geo-replication-failover-transact-sql.md)


В этой статье объясняется, как запустить плановую или незапланированную отработку отказа в базе данных SQL с помощью PowerShell. Информацию о настройке георепликации для баз данных SQL Azure см. в [этой статье](sql-database-geo-replication-powershell.md).



## Запуск плановой отработки отказа

С помощью командлета **Set-AzureRmSqlDatabaseSecondary** с параметром **-Failover** можно сделать базу данных-получателя источником. При этом текущая база данных-источник станет получателем. Эта функция предназначена для плановой отработки отказа (как во время отработки аварийного восстановления). Чтобы ее можно было использовать, база данных-источник должна быть доступна.

Эта команда выполняет следующий рабочий процесс:

1. Временно переключает репликацию в синхронный режим. При этом все незавершенные операции переводятся на получатель.

2. Две базы данных, связанные георепликацией, обмениваются ролями.

Эта последовательность гарантирует, что базы данных будут синхронизированы до переключения ролей, а значит потери данных не возникнут. В течение короткого периода (от 0 до 25 секунд), пока переключаются роли, обе базы данных будут недоступны. Обычно вся операция занимает меньше минуты. Дополнительные сведения см. в разделе [Set-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt619393.aspx).




Этот командлет возвращает результат при завершении процесса переключения с базы данных-получателя на базу данных-источник.

Следующая команда изменяет роли базы данных с именем mydb на сервере srv2 в группе ресурсов rg2 на роли базы данных-источника. Исходная база данных-источник, к которой была подключена база данных db2, переключится на базу данных-получателя после полной синхронизации двух баз данных.

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb" –ResourceGroupName "rg2” –ServerName "srv2”
    $database | Set-AzureRmSqlDatabaseSecondary -Failover


> [AZURE.NOTE] В редких случаях бывает, что операцию нельзя завершить и что она не отвечает. Тогда вы можете выполнить команду принудительной отработки отказа (внеплановая отработка отказа). При этом будут потеряны данные.


## Запуск внеплановой отработки отказа для превращения базы данных-источника в базу данных-получателя


С помощью командлета **Set-AzureRmSqlDatabaseSecondary** с параметрами **–Failover** и **-AllowDataLoss** можно во внеплановом порядке сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем, когда база данных-источник перестанет быть доступной.

Эта функция предназначена для аварийного восстановления в случаях, когда восстановить доступность базы данных крайне необходимо, а потеря некоторого объема данных является приемлемой. Когда вызывается принудительная отработка отказа, указанная база данных-получатель сразу становится источником и начинает принимать транзакции записи. Когда становится возможным повторно подключить первоначальную базу данных-источник к новой базе данных-источнику после принудительной отработки отказа, сразу выполняется добавочная архивация первоначальной базы данных-источника, которая при этом становится получателем по отношению к новому источнику, то есть его репликой.

Однако восстановление до точки во времени не поддерживается для баз данных-получателей. Поэтому если вы хотите восстановить данные, отправленные в старую базу данных-источник, которая не была реплицирована в новую базу данных-источник, то следует использовать CSS для восстановления базы данных до резервной копии из журнала.

> [AZURE.NOTE] Если команда выполняется, когда одновременно доступны база данных-источник и база данных-получатель, старый источник становится новым получателем мгновенно и без синхронизации данных. Если при отправке команды источник выполняет транзакции, некоторые данные могут быть утеряны.


Если база данных-источник имеет несколько получателей, команда будет выполнена частично. Получатель, на котором была выполнена команда, станет источником. Однако старый источник остается источником, то есть будут существовать два источника в несогласованном состоянии, а соединение между ними будет осуществляться с помощью приостановленной связи репликации. Пользователю будет необходимо вручную восстановить эту конфигурацию с помощью интерфейса API «удаление получателя» на любой из этих баз данных-источников.


Следующая команда изменяет роль базы данных с именем mydb на роль источника, если источник недоступен. Исходный источник, к которому подключена база данных mydb, станет получателем после своего возврата в сетевой режим. На этом этапе синхронизация может привести к потере данных.

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb" –ResourceGroupName "rg2” –ServerName "srv2”
    $database | Set-AzureRmSqlDatabaseSecondary –Failover -AllowDataLoss




## Дополнительные ресурсы

- [Новые возможности георепликации](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/)
- [Разработка облачных приложений для непрерывности бизнес-процессов с использованием георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md)
- [Общие сведения о непрерывности бизнес-процессов](sql-database-business-continuity.md)
- [База данных SQL — документация](https://azure.microsoft.com/documentation/services/sql-database/)
- [Отработка аварийного восстановления](sql-database-disaster-recovery-drills.md)

<!---HONumber=AcomDC_0608_2016-->