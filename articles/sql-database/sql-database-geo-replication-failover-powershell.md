---
title: "Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью PowerShell | Документация Майкрософт"
description: "Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью PowerShell"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 5849b600-89cb-4995-ae9f-0188a17b4e1b
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: powershell
ms.workload: data-management
ms.date: 08/29/2016
ms.author: sstein
translationtype: Human Translation
ms.sourcegitcommit: 8d988aa55d053d28adcf29aeca749a7b18d56ed4
ms.openlocfilehash: ac575284544819c6bed7ef84669b2793085a3dc6
ms.lasthandoff: 02/16/2017


---
# <a name="initiate-a-planned-or-unplanned-failover-for-azure-sql-database-with-powershell"></a>Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью PowerShell

В этой статье объясняется, как запустить плановую или незапланированную отработку отказа в базе данных SQL с помощью PowerShell. Сведения о настройке георепликации для баз данных SQL Azure см. в [этой статье](sql-database-geo-replication-powershell.md).

## <a name="initiate-a-planned-failover"></a>Запуск плановой отработки отказа
Командлет **Set-AzureRmSqlDatabaseSecondary** с параметром **-Failover** позволяет сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем. Эта функция предназначена для плановой отработки отказа (как во время отработки аварийного восстановления). Чтобы ее можно было использовать, база данных-источник должна быть доступна.

Эта команда выполняет следующий рабочий процесс:

1. Временно переключает репликацию в синхронный режим. При этом все незавершенные операции переводятся на получатель.
2. Две базы данных, связанные георепликацией, обмениваются ролями.  

Эта последовательность гарантирует, что базы данных будут синхронизированы до переключения ролей, а значит потери данных не возникнут. В течение короткого периода (от 0 до 25 секунд), пока переключаются роли, обе базы данных будут недоступны. Обычно вся операция занимает меньше минуты. Дополнительные сведения см. в статье [Set-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt619393\(v=azure.300\).aspx).

Этот командлет возвращает результат при завершении процесса переключения с базы данных-получателя на базу данных-источник.

Следующая команда изменяет роли базы данных с именем mydb на сервере srv2 в группе ресурсов rg2 на роли базы данных-источника. Исходная база данных-источник, к которой была подключена база данных db2, переключится на базу данных-получателя после полной синхронизации двух баз данных.

    $database = Get-AzureRmSqlDatabase -DatabaseName "mydb" -ResourceGroupName "rg2” -ServerName "srv2”
    $database | Set-AzureRmSqlDatabaseSecondary -Failover


> [!NOTE]
> В редких случаях бывает, что операцию нельзя завершить и что она не отвечает. Тогда вы можете выполнить команду принудительной отработки отказа (внеплановая отработка отказа). При этом будут потеряны данные.
> 
> 

## <a name="initiate-an-unplanned-failover-from-the-primary-database-to-the-secondary-database"></a>Запуск внеплановой отработки отказа для превращения базы данных-источника в базу данных-получателя
Командлет **Set-AzureRmSqlDatabaseSecondary** с параметрами **-Failover** и **-AllowDataLoss** позволяет во внеплановом порядке сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем, когда база данных-источник перестанет быть доступной.

Эта функция предназначена для аварийного восстановления в случаях, когда восстановить доступность базы данных крайне необходимо, а потеря некоторого объема данных является приемлемой. Когда вызывается принудительная отработка отказа, указанная база данных-получатель сразу становится источником и начинает принимать транзакции записи. Когда становится возможным повторно подключить первоначальную базу данных-источник к новой базе данных-источнику после принудительной отработки отказа, сразу выполняется добавочная архивация первоначальной базы данных-источника, которая при этом становится получателем по отношению к новому источнику, то есть его репликой.

Однако восстановление до точки во времени не поддерживается для баз данных-получателей. Поэтому если вы хотите восстановить данные, отправленные в старую базу данных-источник, которая не была реплицирована в новую базу данных-источник, то следует использовать CSS для восстановления базы данных до резервной копии из журнала.

> [!NOTE]
> Если команда выполняется, когда одновременно доступны база данных-источник и база данных-получатель, старый источник становится новым получателем мгновенно и без синхронизации данных. Если при отправке команды источник выполняет транзакции, некоторые данные могут быть утеряны.
> 
> 

Если база данных-источник имеет несколько получателей, команда будет выполнена частично. Получатель, на котором была выполнена команда, станет источником. Однако старый источник остается источником, то есть будут существовать два источника в несогласованном состоянии, а соединение между ними будет осуществляться с помощью приостановленной связи репликации. Пользователю будет необходимо вручную восстановить эту конфигурацию с помощью интерфейса API «удаление получателя» на любой из этих баз данных-источников.

Следующая команда изменяет роль базы данных с именем mydb на роль источника, если источник недоступен. Исходный источник, к которому подключена база данных mydb, станет получателем после своего возврата в сетевой режим. На этом этапе синхронизация может привести к потере данных.

    $database = Get-AzureRmSqlDatabase -DatabaseName "mydb" -ResourceGroupName "rg2” -ServerName "srv2”
    $database | Set-AzureRmSqlDatabaseSecondary -Failover -AllowDataLoss




## <a name="next-steps"></a>Дальнейшие действия
* После отработки отказа убедитесь, что для новой базы данных-источника настроены требования аутентификации ваших сервера и базы данных. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).
* Чтобы изучить восстановление после сбоя с помощью активной георепликации, включая предварительные и последующие действия и отработку аварийного восстановления, ознакомьтесь с разделом [Отработка аварийного восстановления](sql-database-disaster-recovery.md)
* Прочитайте запись блога Александра Носова об активной георепликации: [Spotlight on new Geo-Replication capabilities](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/)
* Сведения о проектировании облачных приложений для использования активной георепликации см. в статье [Создание приложения для аварийного восстановления облака с использованием активной георепликации в базе данных SQL](sql-database-designing-cloud-solutions-for-disaster-recovery.md).
* Сведения об использовании активной георепликации с пулами эластичных баз данных см. в статье [Стратегии аварийного восстановления для приложений с использованием пула эластичных баз данных SQL](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).
* Общие сведения об обеспечении непрерывности бизнес-процессов можно узнать в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)


