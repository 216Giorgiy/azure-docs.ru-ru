<properties
    pageTitle="Запросы к эластичным базам данных для сегментирования (горизонтальное секционирование) | Microsoft Azure"
    description="настройка эластичных запросов при горизонтальном секционировании"    
    services="sql-database"
    documentationCenter=""  
    manager="jeffreyg"
    authors="torsteng"/>

<tags
    ms.service="sql-database"
    ms.workload="sql-database"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="01/28/2016"
    ms.author="torsteng;sidneyh" />

# Запросы к эластичным базам данных на сегментирование (горизонтальное секционирование)

В этой статье объясняется, как настраивать запросы к эластичным базам данных в сценариях горизонтального секционирования и как выполнять такие запросы. Определение сценария горизонтального секционирования см. в статье [Обзор запросов к эластичным базам данных (предварительная версия)](sql-database-elastic-query-overview.md).

![Запрос по сегментам][1]

Рассматриваемые функции по умолчанию включены в [набор функций эластичной базы данных](sql-database-elastic-scale-introduction.md) SQL Azure.
 
## Создание объектов базы данных

Запрос к эластичной базе данных расширяет синтаксис T-SQL для обращения к тем уровням данных, которые используют сегментирование (или горизонтальное секционирование) для распределения данных по множеству баз данных. В этой статье приводится обзор инструкций языка DDL, связанных с эластичными запросами к сегментированным таблицам. Эти инструкции позволяют представлять метаданные уровня сегментированных данных через запрос к эластичной базе данных. Необходимым условием для запуска этих инструкций является создание карты сегментов с помощью клиентской библиотеки эластичной базы данных. Дополнительные сведения см. в статье [Управление картами сегментов](sql-database-elastic-scale-shard-map-management.md) или воспользуйтесь примером создания карты из статьи [Приступая к работе с инструментами эластичной базы данных](sql-database-elastic-scale-get-started.md).

Инструкции T-SQL, используемые при определении объектов для запроса к эластичной базе данных, приведены ниже. Кроме того, далее описано использование этих инструкций в сценарии горизонтального секционирования.

* [CREATE MASTER KEY](https://msdn.microsoft.com/library/ms174382.aspx) 

* [CREATE DATABASE SCOPED CREDENTIAL](https://msdn.microsoft.com/library/mt270260.aspx)

* [CREATE/DROP EXTERNAL DATA SOURCE](https://msdn.microsoft.com/library/dn935022.aspx)

* [CREATE/DROP EXTERNAL TABLE](https://msdn.microsoft.com/library/dn935021.aspx)

### 1\.1. Главный ключ и учетные данные для конкретной базы данных 

К учетным данным относятся идентификатор пользователя и пароль, используемые эластичным запросом для подключения к удаленным базам данных в базе данных SQL Azure. Чтобы создать необходимый главный ключ и учетные данные, используйте такой синтаксис:

    CREATE MASTER KEY ENCRYPTION BY PASSWORD = ’password’;
    CREATE DATABASE SCOPED CREDENTIAL <credential_name>  WITH IDENTITY = ‘<username>’,  
    SECRET = ‘<password>’
    [;]

Или, если нужно удалить учетные данные и ключ, используйте такой синтаксис:

    DROP DATABASE SCOPED CREDENTIAL <credential_name>;  
    DROP MASTER KEY;   

 
**Примечание.** Убедитесь, что значение *< username>* не содержит суффикс *@servername*.

### 1\.2. Внешние источники данных

Предоставьте сведения о карте сегментов и уровне данных путем определения внешнего источника данных. Внешний источник данных ссылается на вашу карту сегментов. Затем эластичный запрос использует внешний источник данных и соответствующую карту сегментов для перебора баз данных, входящих в уровень данных. Для создания внешнего источника данных используется следующий синтаксис:

	<External_Data_Source> ::=    
	CREATE EXTERNAL DATA SOURCE <data_source_name> WITH                               	           
			(TYPE = SHARD_MAP_MANAGER,
                   	LOCATION = '<fully_qualified_server_name>',
			DATABASE_NAME = ‘<shardmap_database_name>',
			CREDENTIAL = <credential_name>, 
			SHARD_MAP_NAME = ‘<shardmapname>’ 
                   ) [;] 
 
Удаление внешнего источника данных:

	DROP EXTERNAL DATA SOURCE <data_source_name>[;] 

#### Разрешения для CREATE/DROP EXTERNAL DATA SOURCE 

Пользователь должен иметь разрешение ALTER ANY EXTERNAL DATA SOURCE. Это разрешение включено в разрешение ALTER DATABASE.

**Пример**

В следующем примере демонстрируется использование инструкции CREATE для внешних источников данных.

	CREATE EXTERNAL DATA SOURCE MyExtSrc 
	WITH 
	( 
		TYPE=SHARD_MAP_MANAGER,
		LOCATION='myserver.database.windows.net', 
		DATABASE_NAME='ShardMapDatabase', 
		CREDENTIAL= SMMUser, 
		SHARD_MAP_NAME='ShardMap' 
	);
 
Список актуальных внешних источников данных можно получить в следующем представлении каталога:

	select * from sys.external_data_sources; 

Обратите внимание на то, что, когда обрабатывается эластичный запрос, для чтения карты сегментов и доступа к данным в сегментах используются одни и те же учетные данные.

### 1\.3. Внешние таблицы 
 
Эластичные запросы расширяют язык DDL внешней таблицы, добавляя ссылки на внешние таблицы, горизонтально секционированные между несколькими базами данных. Определение внешней таблицы включает следующие элементы:

* **Схема**: язык DDL внешней таблицы определяет схему, которую можно использовать в запросах. Схема из определения вашей внешней таблицы должна соответствовать схеме таблиц в сегментах, в которых непосредственно хранятся данные. 

* **Распределение данных**: язык DDL внешней таблицы определяет, в каком порядке вы распределяете данные на своем уровне данных. Обратите внимание, что база данных SQL Azure не проверяет соответствие распределения внешней таблицы с фактическим распределением по сегментам. Соответствие фактического распределения данных по сегментам с определением внешней таблицы вы контролируете самостоятельно.

* **Ссылка на уровень данных**: язык DDL внешней таблицы ссылается на внешний источник данных. Во внешнем источнике данных указывается карта сегментов, в которой есть внешняя таблица, содержащая сведения, необходимые для поиска всех баз данных на вашем уровне данных.

Используя внешний источник данных (в соответствии с инструкциями, приведенными в предыдущем разделе), вы можете создавать и удалять внешние таблицы при помощи следующего синтаксиса:

	CREATE EXTERNAL TABLE [ database_name . [ schema_name ] . | schema_name. ] table_name  
        ( { <column_definition> } [ ,...n ])     
	    { WITH ( <sharded_external_table_options> ) }
	) [;]  
	
	<sharded_external_table_options> ::= 
      DATA_SOURCE = <External_Data_Source>,       
	  [ SCHEMA_NAME = N'nonescaped_schema_name',] 
      [ OBJECT_NAME = N'nonescaped_object_name',] 
      DISTRIBUTION = SHARDED(<sharding_column_name>) | REPLICATED |ROUND_ROBIN

Предложение DATA\_SOURCE определяет внешний источник данных (в случае горизонтального секционирования это карта сегментов), используемый для внешней таблицы.

Предложения SCHEMA\_NAME и OBJECT\_NAME позволяют сопоставить определение внешней таблицы с таблицей из другой схемы в сегменте или таблицей с другим именем. Если эти предложения отсутствуют, то предполагается, что удаленный объект является таблицей «dbo», имя которой совпадает с именем внешней таблицы.

Предложения SCHEMA\_NAME и OBJECT\_NAME особенно нужны в тех случаях, когда имя удаленной таблицы уже занято в базе данных, в которой создается внешняя таблица. Например, вы хотите определить внешнюю таблицу для получения общего представления из представлений каталогов или динамических административных представлений, которые находятся на вашем развернутом уровне данных. Так как представления каталогов и динамические административные представления уже существуют локально, их имена нельзя использовать для определения внешней таблицы. Вместо этого вы можете задать другое имя и в предложениях SCHEMA\_NAME и OBJECT\_NAME использовать имя представления каталога или динамического административного представления. (См. пример ниже.)

Предложение DISTRIBUTION определяет распределение данных, используемое для этой таблицы:

* Ключевое слово SHARDED означает, что данные для этой таблицы секционированы горизонтально по базам данных на карте сегментов. Ключ секционирования для распределения данных указывается в параметре <sharding_column_name>.  

* Слово REPLICATED означает, что в каждой базе данных вашей карты сегментов имеются идентичные копии таблицы. База данных SQL Azure не поддерживает автоматическое сохранение копий таблиц. Вы должны самостоятельно позаботиться о соответствии реплик во всех базах данных.

* Слово ROUND\_ROBIN означает, что таблица распределяется с помощью горизонтального секционирования. Тем не менее используется распределение, зависимое от приложения.

Обработчик запросов использует сведения, указанные в предложении DISTRIBUTION, для создания наиболее эффективных планов запросов.

Для удаления внешней таблицы можно использовать следующую инструкцию:

	DROP EXTERNAL TABLE [ database_name . [ schema_name ] . | schema_name. ] table_name[;]  

Разрешения для инструкции **CREATE/DROP EXTERNAL TABLE**: требуются разрешения ALTER ANY EXTERNAL DATA SOURCE, необходимые также для ссылки на базовый источник данных.

**Вопросы безопасности.** Пользователи, имеющие доступ к внешней таблице, автоматически получают доступ к базовой удаленной таблице с учетными данными, указанными в определении внешнего источника данных. Вам следует тщательно следить за доступом к внешним таблицам во избежание нежелательного повышения привилегий при использовании учетных данных внешнего источника данных. Для предоставления и отмены доступа к внешней таблице используются разрешения SQL, применимые к обычным таблицам.

**Пример.** Далее показано создание внешней таблицы.

	CREATE EXTERNAL TABLE [dbo].[order_line]( 
		 [ol_o_id] int NOT NULL, 
		 [ol_d_id] tinyint NOT NULL,
		 [ol_w_id] int NOT NULL, 
		 [ol_number] tinyint NOT NULL, 
		 [ol_i_id] int NOT NULL, 
		 [ol_delivery_d] datetime NOT NULL, 
		 [ol_amount] smallmoney NOT NULL, 
		 [ol_supply_w_id] int NOT NULL, 
		 [ol_quantity] smallint NOT NULL, 
		 [ol_dist_info] char(24) NOT NULL 
	) 
	
	WITH 
	( 
		DATA_SOURCE = MyExtSrc, 
	 	SCHEMA_NAME = 'orders', 
	 	OBJECT_NAME = 'order_details', 
		DISTRIBUTION=SHARDED(ol_w_id)
	); 

В следующем примере показано получение списка внешних таблиц из текущей базы данных:

	select * from sys.external_tables; 

## Выполнение запроса 

### 2\.1. Запросы T-SQL с полным соответствием 

Определив внешний источник данных и внешние таблицы, вы можете использовать все возможности T-SQL для создания запросов к внешним таблицам.

**Пример для горизонтального секционирования.** С помощью следующего запроса устанавливается трехстороннее соединение между хранилищами, заказами и строками заказов. При этом используется несколько статистических выражений и выборочный фильтр. Здесь предполагается, что используется (1) горизонтальное секционирование (сегментирование) и (2) что сегментирование хранилищ, заказов и строк заказов выполняется по столбцу с идентификатором хранилища. В этом случае эластичный запрос может выровнять соединения в сегментах и параллельно обработать ресурсоемкую часть запроса в сегментах.

	select  
		 w_id as warehouse,
		 o_c_id as customer,
		 count(*) as cnt_orderline,
		 max(ol_quantity) as max_quantity,
		 avg(ol_amount) as avg_amount, 
		 min(ol_delivery_d) as min_deliv_date
	from warehouse 
	join orders 
	on w_id = o_w_id
	join order_line 
	on o_id = ol_o_id and o_w_id = ol_w_id 
	where w_id > 100 and w_id < 200 
	group by w_id, o_c_id 
 
### 2\.2. Хранимая процедура SP\_ EXECUTE\_FANOUT 

С функцией эластичных запросов вам становится доступна хранимая процедура, которая обеспечивает прямой доступ к сегментам. Эта процедура называется sp\_execute\_fanout и принимает следующие параметры:

* Имя сервера (nvarchar): полное имя логического сервера, на котором размещена карта сегментов. 
* Имя базы данных карты сегментов (nvarchar): имя базы данных карты сегментов. 
* Имя пользователя (nvarchar): имя пользователя для входа в базу данных карты сегментов. 
* Пароль (nvarchar): пароль пользователя. 
* Имя сегмента карты (nvarchar): имя карты сегментов, используемое в запросе. Оно находится в таблице \_ShardManagement.ShardMapsGlobal и используется по умолчанию при создании баз данных с помощью образца приложения, который представлен в статье [Приступая к работе с инструментами эластичной базы данных](sql-database-elastic-scale-get-started.md). По умолчанию в приложении используется имя CustomerIDShardMap.
*  Запрос: запрос T-SQL, выполняемый для каждого сегмента. 
*  Объявление параметра (nvarchar, необязательно): строка с определениями типов данных, используемых в параметрах запроса (например, для процедуры sp\_executesql). 
*  Список значений параметров (необязательно): разделенный запятыми список значений параметров (например, для процедуры sp\_executesql).  

В процедуре sp\_execute\_fanout данные карты сегментов, предоставляемые в параметрах вызова, используются для выполнения инструкции T-SQL в отношении всех сегментов, зарегистрированных в карте сегментов. Любые результаты объединяются с помощью семантики UNION ALL. Результаты также содержат дополнительный «виртуальный» столбец с именем сегмента.

Обратите внимание на то, что для подключения к базе данных карты сегментов и к сегментам используются одни и те же исходные данные.

Пример:

	sp_execute_fanout 
		N'myserver.database.windows.net', 
		N'ShardMapDb', 
		N'myuser', 
		N'MyPwd', 
		N'ShardMap', 
		N'select count(w_id) as foo from warehouse' 

## Подключение для инструментов  

Используйте обычные строки подключения SQL Server для подключения вашего приложения, инструментов бизнес-аналитики и интеграции данных к базе данных с определениями внешних таблиц. Убедитесь, что в качестве источника данных для вашего инструмента поддерживается SQL Server. Затем добавьте ссылку на запрос к эластичной базе данных, как к любой другой базе данных SQL Server, подключенной к приложению. После этого из своего инструмента или приложения вы сможете использовать внешние таблицы так, как если бы они были локальными таблицами.

## Рекомендации 

* Убедитесь, что брандмауэры баз данных SQL обеспечивают конечной базе данных с эластичными запросами доступ к базе данных карты сегментов и всем сегментам.  

* Эластичный запрос не предполагает проверку или распределение данных в соответствии с внешней таблицей. Если фактическое распространение данных отличается от определения таблицы, то результаты запросов могут быть непредсказуемыми.

* Функция эластичных запросов в настоящее время не позволяет исключать сегменты, когда предикаты для ключа сегментирования безопасно исключают определенные сегменты из процесса обработки.

* Эластичные запросы оптимальны, когда основная часть вычислений может быть выполнена в сегментах. Обычно наиболее эффективны запросы с предикатами выборочных фильтров, дающие возможность вычисления в сегментах или соединениях путем секционирования ключей с выравниванием по секциям для всех сегментов. Для других шаблонов запросов может потребоваться загрузка больших объемов данных из сегментов в головной узел, что может стать причиной снижения производительности.


[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]


<!--Image references-->
[1]: ./media/sql-database-elastic-query-horizontal-partitioning/horizontalpartitioning.png
<!--anchors-->

<!---HONumber=AcomDC_0204_2016-->