<properties 
    pageTitle="Настройка георепликации баз данных SQL Azure с помощью PowerShell | Microsoft Azure" 
    description="Сведения о георепликации для базы данных SQL Azure с помощью PowerShell." 
    services="sql-database" 
    documentationCenter="" 
    authors="stevestein" 
    manager="jeffreyg" 
    editor=""/>

<tags
    ms.service="sql-database"
    ms.devlang="NA"
    ms.topic="article"
    ms.tgt_pltfrm="powershell"
    ms.workload="data-management" 
    ms.date="12/01/2015"
    ms.author="sstein"/>

# Настройка георепликации базы данных SQL Azure с помощью PowerShell



> [AZURE.SELECTOR]
- [Azure portal](sql-database-geo-replication-portal.md)
- [PowerShell](sql-database-geo-replication-powershell.md)
- [Transact-SQL](sql-database-geo-replication-transact-sql.md)


В этой статье показано, как настроить георепликацию для базы данных SQL Azure с помощью PowerShell.

Георепликация позволяет создать до четырех реплик (баз данных-получателей) в различных местах (регионах) расположения центров баз данных. Базы данных-получатели могут создаваться при сбое центра обработки данных или невозможности подключения к базе данных-источнику.

Георепликация доступна только для баз данных, относящихся к категориям «Стандартный» и «Премиум».

Базы данных Standard могут иметь одного не доступного для чтения получателя и должны использовать рекомендованный регион. Базы данных Premium могут иметь до четырех доступных для чтения получателей в любом доступном регионе.

Для настройки георепликации необходимо следующее:

- Подписка Azure. Если вам требуется подписка Azure, нажмите в верхней части этой страницы кнопку **БЕСПЛАТНАЯ ПРОБНАЯ ВЕРСИЯ**. Оформив подписку, вернитесь к этой статье.
- База данных SQL Azure — база данных-источник, которую необходимо реплицировать в другом географическом регионе.
- Предварительная версия Azure PowerShell 1.0. Модули Azure PowerShell можно загрузить и установить, выполнив инструкции из раздела [Установка и настройка Azure PowerShell](powershell-install-configure.md).

> [AZURE.IMPORTANT]Начиная с выпуска предварительной версии Azure PowerShell 1.0, командлет Switch-AzureMode больше не доступен, а командлеты, которые были в модуле Azure ResourceManger, переименованы. В примерах в этой статье используется новое соглашение об именовании предварительной версии PowerShell 1.0. Дополнительные сведения см. в разделе [Устаревший командлет Switch-AzureMode в Azure PowerShell](https://github.com/Azure/azure-powershell/wiki/Deprecation-of-Switch-AzureMode-in-Azure-PowerShell).





## Настройка учетных данных и выбор подписки

Для начала установите доступ к учетной записи Azure. Для этого запустите PowerShell и выполните указанный ниже командлет. На экране входа в систему укажите те же адрес электронной почты и пароль, которые используются для входа на портал Azure.


	Login-AzureRmAccount

После успешного входа на экране будут отображаться некоторые сведения, включая идентификатор, под которым вы вошли в систему, и подписки Azure, к которым у вас есть доступ.


### Выбор подписки Azure

Для выбора подписки вам нужно знать ее идентификатор. Идентификатор подписки можно скопировать из данных, которые были показаны на предыдущем этапе. Если у вас несколько подписок и вам нужны дополнительные данные, выполните командлет **Get-AzureRmSubscription** и скопируйте нужные данные из полученных результатов. С помощью идентификатора подписки приведенный ниже командлет задает текущую подписку:

	Select-AzureRmSubscription -SubscriptionId 4cac86b0-1e56-bbbb-aaaa-000000000000

После успешного выполнения командлета **Select-AzureRmSubscription** вы вернетесь в командную строку PowerShell.



## Добавление базы данных-получателя


Следующие действия позволяют создать новую базу данных-получателя в связи георепликации.
  
Включить базу данных-получатель может только владелец или совладелец подписки.

Чтобы добавить базу данных-получатель на сервере-партнере в локальную базу данных на сервере, к которому выполняется подключение (база данных-источник), используйте командлет **New-AzureRmSqlDatabaseSecondary**.

Этот командлет заменяет параметр **Start-AzureSqlDatabaseCopy** на **–IsContinuous**. Он выдает объект **AzureRmSqlDatabaseSecondary**, который может использоваться другими командлетами для четкого определения конкретной связи репликации. Этот командлет возвращает результат после создания и полного заполнения базы данных-получателя. В зависимости от размера базы данных этот процесс может длиться от нескольких минут до нескольких часов.

Реплицированная база данных на сервере-получателе будет иметь такое же имя, как и база данных на сервере-источнике, и по умолчанию тот же уровень службы. База данных-получатель может быть доступной или недоступной для чтения, отдельной или эластичной. Дополнительные сведения см. в статьях [New-AzureRMSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt603689.aspx) и [Уровни служб](sql-database-service-tiers.md). После создания и заполнения базы данных-получателя начинается репликация данных из базы данных-источника в новую базу-данных-получателя. Ниже описано, как выполнить эту задачу с помощью PowerShell, чтобы создать доступную или недоступную для чтения базу данных-получателя с отдельной или эластичной базой данных.

Если партнерская база данных уже создана (например, в результате прекращения предыдущей связи георепликации), команда завершится неудачей.



### Добавление недоступной для чтения отдельной базы данных-получателя

Следующая команда создает недоступную для чтения базу данных-получателя базы данных mydb сервера srv2 в группе ресурсов rg2:

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb"
    $secondaryLink = $database | New-AzureRmSqlDatabaseSecondary –PartnerResourceGroupName "rg2" –PartnerServerName "srv2" -AllowConnections "None"



### Добавление доступной для чтения отдельной базы данных-получателя

Следующая команда создает доступную для чтения базу данных-получателя базы данных mydb сервера srv2 в группе ресурсов rg2:

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb"
    $secondaryLink = $database | New-AzureRmSqlDatabaseSecondary –PartnerResourceGroupName "rg2" –PartnerServerName "srv2" -AllowConnections "All"




### Добавление недоступной для чтения эластичной базы данных-получателя

Следующая команда создает недоступную для чтения базу данных-получателя базы данных mydb в пуле эластичных баз данных ElasticPool1 сервера srv2 в группе ресурсов rg2:

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb"
    $secondaryLink = $database | New-AzureRmSqlDatabaseSecondary –PartnerResourceGroupName "rg2" –PartnerServerName "srv2" –SecondaryElasticPoolName "ElasticPool1" -AllowConnections "None"


### Добавление доступной для чтения эластичной базы данных-получателя

Следующая команда создает доступную для чтения базу данных-получателя базы данных mydb в пуле эластичных баз данных ElasticPool1 сервера srv2 в группе ресурсов rg2:

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb"
    $secondaryLink = $database | New-AzureRmSqlDatabaseSecondary –PartnerResourceGroupName "rg2" –PartnerServerName "srv2" –SecondaryElasticPoolName "ElasticPool1" -AllowConnections "All"





## Удаление базы данных-получателя

С помощью командлета **Remove-AzureRmSqlDatabaseSecondary** можно навсегда завершить отношение репликации между базой данных-получателем и ее источником. После завершения этого отношения база данных-получатель становится базой данных для чтения и записи. Если подключение к базе данных-получателю прервано, команда все равно будет выполнена. При этом получатель станет базой данных для чтения и записи только тогда, когда восстановится подключение. Дополнительные сведения см. в разделах [Remove-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt603457.aspx) и [Уровни служб](sql-database-service-tiers.md).

Этот командлет заменяет Stop-AzureSqlDatabaseCopy для репликации.

Такое удаление эквивалентно принудительному завершению, которое удаляет канал репликации и оставляет бывшую базу данных-получателя в качестве автономной базы данных, репликация которой выполнена не полностью перед завершением работы. Все данные связи (если доступны) на предыдущем отправителе и предыдущем получателе будут очищены. Этот командлет возвращает результат при удалении связи репликации.


Чтобы удалить получателя, пользователи должны иметь доступ на запись к базе данных-источнику и базе данных-получателю в соответствии с RBAC. Дополнительные сведения см. в разделе "Контроль доступа на основе ролей".

Следующие действия удаляют связь репликации между базой данных с именем mydb и сервером srv2 из группы ресурсов rg2.

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb"
    $secondaryLink = $database | Get-AzureRmSqlDatabaseReplicationLink –SecondaryResourceGroup "rg2" –PartnerServerName "srv2"
    $secondaryLink | Remove-AzureRmSqlDatabaseSecondary 




## Запуск плановой отработки отказа

С помощью командлета **Set-AzureRmSqlDatabaseSecondary** с параметром **-Failover** можно сделать базу данных-получателя источником. При этом текущая база данных-источник станет получателем. Эта функция предназначена для плановой отработки отказа (как во время отработки аварийного восстановления). Чтобы ее можно было использовать, база данных-источник должна быть доступна.

Эта команда выполняет следующий рабочий процесс:

1. Временно переключает репликацию в синхронный режим. При этом все незавершенные операции переводятся на получатель.

2. Две базы данных, связанные партнерством георепликации, обмениваются ролями.

Эта последовательность действий позволяет избежать потери данных. В течение короткого периода (от 0 до 25 секунд), пока переключаются роли, обе базы данных будут недоступны. Обычно вся операция занимает меньше минуты. Дополнительные сведения см. в разделе [Set-AzureRmSqlDatabaseSecondary](https://msdn.microsoft.com/library/mt619393.aspx).


> [AZURE.NOTE]Если во время запуска команды база данных-источник недоступна, появляется сообщение об ошибке, в котором указано, что сервер-источник недоступен. В редких случаях бывает, что операцию нельзя завершить и что она зависла. Тогда вы можете выполнить команду принудительной отработки отказа (внеплановая отработка отказа). При этом будут потеряны данные.



Этот командлет возвращает результат при завершении процесса переключения с базы данных-получателя на базу данных-источник.

Следующая команда изменяет роли базы данных с именем mydb на сервере srv2 в группе ресурсов rg2 на роли базы данных-источника. Исходная база данных-источник, к которой была подключена база данных db2, переключится на базу данных-получателя после полной синхронизации двух баз данных.

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb” –ResourceGroupName "rg2” –ServerName "srv2”
    $database | Set-AzureRmSqlDatabaseSecondary -Failover



## Запуск внеплановой отработки отказа для превращения базы данных-источника в базу данных-получателя


С помощью командлета **Set-AzureRmSqlDatabaseSecondary** с параметрами **–Failover** и **-AllowDataLoss** можно во внеплановом порядке сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем, когда база данных-источник перестанет быть доступной.

Эта функция предназначена для аварийного восстановления в случаях, когда восстановить доступность базы данных крайне необходимо, а потеря некоторого объема данных является приемлемой. Когда вызывается принудительная отработка отказа, указанная база данных-получатель сразу становится источником и начинает принимать транзакции записи. Когда становится возможным повторно подключить первоначальную базу данных-источник к новой базе данных-источнику после принудительной отработки отказа, сразу выполняется добавочная архивация первоначальной базы данных-источника, которая при этом становится получателем по отношению к новому источнику, то есть его репликой.

Однако восстановление до точки во времени не поддерживается для баз данных-получателей. Поэтому если вы хотите восстановить данные, отправленные в старую базу данных-источник, которая не была реплицирована в новую базу данных-источник, то следует использовать CSS для восстановления базы данных до резервной копии из журнала.

> [AZURE.NOTE]Если команда выполняется, когда одновременно доступны база данных-источник и база данных-получатель, старый источник становится новым получателем, однако попытка синхронизировать данные не выполняется, поэтому может произойти потеря некоторых данных.


Если база данных-источник имеет несколько получателей, команда будет выполнена частично. Получатель, на котором была выполнена команда, станет источником. Однако старый источник остается источником, то есть будут существовать два источника в несогласованном состоянии, а соединение между ними будет осуществляться с помощью приостановленной связи репликации. Пользователю будет необходимо вручную восстановить эту конфигурацию с помощью интерфейса API «удаление получателя» на любой из этих баз данных-источников.


Следующая команда изменяет роль базы данных с именем mydb на роль источника, если источник недоступен. Исходный источник, к которому подключена база данных mydb, станет получателем после своего возврата в сетевой режим. На этом этапе синхронизация может привести к потере данных.

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb” –ResourceGroupName "rg2” –ServerName "srv2”
    $database | Set-AzureRmSqlDatabaseSecondary –Failover -AllowDataLoss



## Мониторинг конфигурации и работоспособности георепликации

К задачам мониторинга относятся мониторинг конфигурации георепликации и мониторинг работоспособности репликации данных.

Командлет [Get-AzureRmSqlDatabaseReplicationLink](https://msdn.microsoft.com/library/mt619330.aspx) можно использовать для получения сведений о каналах прямой репликации, отображаемых в представлении каталога sys.geo\_replication\_links.

Следующая команда отображает состояние канала репликации между базой данных-источником mydb и базой данных-получателем на сервере srv2 из группы ресурсов rg2.

    $database = Get-AzureRmSqlDatabase –DatabaseName "mydb”
    $secondaryLink = $database | Get-AzureRmSqlDatabaseReplicationLink –PartnerResourceGroup "rg2” –PartnerServerName "srv2”



   

## Дальнейшие действия

- [Отработка аварийного восстановления](sql-database-disaster-recovery-drills.md)




## Дополнительные ресурсы

- [Новые возможности георепликации](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication)
- [Разработка облачных приложений для непрерывности бизнес-процессов с использованием георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md)
- [Общие сведения о непрерывности бизнес-процессов](sql-database-business-continuity.md)
- [База данных SQL — документация](https://azure.microsoft.com/documentation/services/sql-database/)

<!---HONumber=AcomDC_1203_2015-->