---
title: "Рекомендации по синхронизации данных SQL Azure | Документация Майкрософт"
description: "Рекомендации по настройке и выполнению синхронизации данных SQL Azure"
services: sql-database
ms.date: 11/2/2017
ms.topic: article
ms.service: sql-database
author: douglaslMS
ms.author: douglasl
manager: craigg
ms.openlocfilehash: 7492fffd1c18a149ef12174c79d64b47afbaa3e4
ms.sourcegitcommit: ce934aca02072bdd2ec8d01dcbdca39134436359
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2017
---
# <a name="best-practices-for-azure-sql-data-sync-preview"></a>Рекомендации по синхронизации данных SQL (предварительная версия) 

В этой статье описываются рекомендации по синхронизации данных SQL (предварительная версия).

Общие сведения о синхронизации данных SQL см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL Azure (предварительная версия)](sql-database-sync-data.md).

## <a name="security-and-reliability"></a> Безопасность и надежность

### <a name="client-agent"></a>Агент клиента

-   Установите агент клиента, используя учетную запись с наименьшим уровнем привилегий и доступом к службе сети.

-   Лучше всего, если агент клиента установлен на компьютере отдельно от локального компьютера SQL Server.

-   Не регистрируйте локальную базу данных в нескольких агентах.

-   Даже если синхронизируются разные таблицы из разных групп синхронизации.

-   Регистрация локальной базы данных в нескольких агентах клиента создает проблемы при удалении одной из групп синхронизации.

### <a name="database-accounts-with-least-required-privilege"></a>Учетные записи базы данных с наименьшими требуемыми привилегиями.

-   **Для настройки синхронизации**. Создание/изменение таблицы, изменение базы данных, создание процедуры, выбор/изменение схемы, создание пользовательских типов.

-   **Для непрерывной синхронизации**. Выбор/вставка/обновление/удаление в таблицах, выбранных для синхронизации, а также в метаданных синхронизации и таблицах отслеживания, разрешение выполнения для хранимых процедур, созданных службой, разрешение выполнения для пользовательских типов таблиц.

-   **Для отмены подготовки**. Изменение части синхронизации таблиц, выбор/удаление в таблицах синхронизации метаданных, управление таблицами отслеживания синхронизации, хранимых процедур и пользовательских типов.

**Как можно использовать эти сведения, если в базе данных группы синхронизации есть только один набор учетных данных?**

-   Изменяйте учетные данные для разных этапов (например, учетные данные1 для настройки и учетные данные2 для непрерывной синхронизации).

-   Изменяйте разрешения для учетных данных (то есть изменяйте разрешение после настройки синхронизации).

## <a name="locate-hub"></a> Где найти центральную базу данных

### <a name="enterprise-to-cloud-scenario"></a>Сценарий перемещения из предприятия в облако

Чтобы свести к минимуму задержки, храните центральную базу данных в регионе максимальной концентрации трафика базы данных в группе синхронизации.

### <a name="cloud-to-cloud-scenario"></a>Сценарий перемещения из облака в облако

-   Когда все базы данных в группе синхронизации находятся в одном центре обработки данных, центральная база данных должна находиться в том же центре обработки данных. Эта конфигурация уменьшает время задержки и стоимость передачи данных между центрами обработки данных.

-   Когда базы данных в группе синхронизации находятся в нескольких центрах обработки данных, центральная база данных должна находиться в том же центре обработки данных, где и большинство баз данных и их трафик.

### <a name="mixed-scenarios"></a>Смешанные сценарии

Примените предыдущие рекомендации к более сложным конфигурациям групп синхронизации.

## <a name="database-considerations-and-constraints"></a> Рекомендации по базам данных и ограничения

### <a name="sql-database-instance-size"></a>Размер экземпляра базы данных SQL

Когда вы создаете экземпляр базы данных SQL, установите максимальный размер, чтобы он всегда превышал размер базы данных, которую вы развертываете. Если этого не сделать, синхронизация завершится ошибкой. Несмотря на отсутствие автоматического увеличения размера, увеличить размер базы данных после ее создания можно с помощью инструкции ALTER DATABASE. Убедитесь, что вы остаетесь в пределах размера экземпляра базы данных SQL.

> [!IMPORTANT]
> Синхронизация данных SQL хранит дополнительные метаданные в каждой базе данных. Обязательно учтите эти метаданные при определении необходимого пространства. Количество добавленных данных зависит от ширины таблиц (например, для узких таблиц требуются дополнительные накладные расходы) и объема трафика.

## <a name="table-considerations-and-constraints"></a> Рекомендации по таблицам и ограничения

### <a name="selecting-tables"></a>Выбор таблиц

Не все таблицы в базе данных должны находиться в [группе синхронизации](#sync-group). Выбор таблиц, которые нужно включить в группу синхронизации и исключить из нее (или включить в другую группу синхронизации), может повлиять на эффективность и затраты. Включите только те таблицы в группу синхронизации, которые требуются для бизнеса, а также те, от которых они зависят.

### <a name="primary-keys"></a>Первичные ключи

Каждая таблица в группе синхронизации должна иметь первичный ключ. Служба синхронизации данных SQL (предварительная версия) не может синхронизировать таблицы, у которых нет первичного ключа.

Перед вводом в эксплуатацию проверьте начальную и непрерывную синхронизацию в действии.

## <a name="provisioning-destination-databases"></a> Подготовка баз данных назначения

Компонент предварительного просмотра синхронизации данных SQL (предварительная версия) предоставляет автоматическую подготовку баз данных.

В этом разделе рассматриваются ограничения подготовки синхронизации данных SQL (предварительная версия).

### <a name="auto-provisioning-limitations"></a>Ограничения автоматической подготовки

Ниже приведены ограничения для автоматической подготовки синхронизации данных SQL (предварительная версия).

-   В таблице назначения создаются только выделенные столбцы.
Таким образом, если некоторые столбцы не являются частью группы синхронизации, они не подготавливаются в таблицах назначения.

-   Индексы создаются только для выбранных столбцов.
Если индекс исходной таблицы имеет столбцы, которые не являются частью группы синхронизации, они не подготавливаются в таблицах назначения.

-   Индексы столбцов типа XML не подготавливаются.

-   Проверочные ограничения не подготавливаются.

-   Существующие триггеры в исходных таблицах не подготавливаются.

-   Представления и хранимые процедуры не создаются в базе данных назначения.

### <a name="recommendations"></a>Рекомендации

-   Используйте возможность автоматической подготовки только для проверки службы в действии.

-   Для рабочей среды необходимо подготовить схему базы данных.

## <a name="avoid-a-slow-and-costly-initial-synchronization"></a> Избегайте медленной и дорогостоящей начальной синхронизации

В этом разделе рассматривается начальная синхронизация группы синхронизации и то, что можно сделать, чтобы избежать длительной и затратной начальной синхронизации.

### <a name="how-initial-synchronization-works"></a>Как работает начальная синхронизация

Когда вы создаете группу синхронизации, начните с данных в одной базе данных. Если у вас есть данные в нескольких базах данных, синхронизация данных SQL (предварительная версия) обрабатывает каждую строку как конфликт, требующий разрешения. По этой причине начальная синхронизация происходит медленно, от нескольких дней до нескольких месяцев, в зависимости от размера базы данных.

Кроме того, если базы данных находятся в разных центрах обработки данных, затраты на первоначальную синхронизацию увеличиваются, так как каждая строка должна перемещаться между различными центрами данных.

### <a name="recommendation"></a>Рекомендации

По возможности начинайте с данных только в одной базе данных группы синхронизации.

## <a name="design-to-avoid-synchronization-loops"></a> Проектируйте инфраструктуру так, чтобы избежать петель синхронизации

Петля синхронизации возникает, когда в группе синхронизации есть циклические ссылки, из-за которых каждое изменение одной базы данных реплицируется через базы данных в группе синхронизации циклически и бесконечно. Избегайте петель синхронизации, так как они ухудшают производительность и могут значительно повысить затраты.

## <a name="avoid-out-of-date-databases-and-sync-groups"></a> Избегайте устаревших баз данных и групп синхронизации

Группа синхронизации или база данных в группе синхронизации могут устареть. Если группа синхронизации устаревает, она перестает работать. Если база данных устаревает, данные могут быть потеряны. Лучше избегать этих ситуаций, чем выполнять восстановления после них.

### <a name="avoid-out-of-date-databases"></a>Избегайте появления устаревших баз данных

База данных получает состояние устаревшей, если она находилась в автономном режиме более 45 дней. Избегайте устаревания баз данных, контролируя, чтобы ни одна из них не отключалась на срок более 45 дней.

### <a name="avoid-out-of-date-sync-groups"></a>Избегайте появления устаревших групп синхронизации

Группа синхронизации считается устаревшей, если любые изменения в этой группе не распространялись на остальную часть группы синхронизации более 45 дней. Избегайте появления устаревших групп синхронизации. Для этого регулярно проверяйте журнал группы синхронизации. Убедитесь, что все конфликты решены и изменения успешно распространяются в базах данных групп синхронизации.

Причины, по которым группа синхронизации может не применять изменения, могут быть следующими:

-   Несовместимость схемы между таблицами.

-   Несовместимость данных между таблицами.

-   Вставка строки с нулевым значением в столбце, который не допускает нулевые значения.

-   Обновление строки со значением, которое нарушает ограничение внешнего ключа.

Вы можете предотвратить устаревание групп синхронизации следующим образом:

-   Обновите схему, разрешив значения, содержащиеся в строках с ошибками.

-   Обновите значения внешнего ключа, чтобы включить значения, содержащиеся в строках с ошибками.

-   Обновите значения данных в строке с ошибкой, чтобы она была совместима со схемой или внешними ключами в целевой базе данных.

## <a name="avoid-deprovisioning-issues"></a> Избегайте проблем с отменой подготовки

При определенных обстоятельствах отмена регистрации базы данных в агенте клиента может привести к сбою синхронизации.

### <a name="scenario"></a>Сценарий

1. Группа синхронизации A была создана с использованием экземпляра базы данных SQL и локальной базы данных SQL Server, которая связана с локальным агентом 1.

2. Та же самая локальная база данных регистрируется в локальном агенте 2 (этот агент не связан с какой-либо группой синхронизации).

3. При отмене регистрации локальной базы данных в локальном агенте 2 удаляются таблицы отслеживания или метаданных из группы синхронизации A для локальной базы данных.

4. Теперь операции группы синхронизации A завершаются следующей ошибкой — "The current operation could not be completed because the database is not provisioned for sync or you do not have permissions to the sync configuration tables" (Текущая операция не может быть завершена, потому что база данных не подготовлена для синхронизации или у вас нет разрешений для таблиц конфигурации синхронизации).

### <a name="solution"></a>Решение

Ситуации можно избежать, если не регистрировать базу данных в нескольких агентах.

Чтобы исправить ошибку:

1. Удалите базу данных из каждой группы синхронизации, к которой она принадлежит.

2. Добавьте базу данных обратно в каждую группу синхронизации, из которой вы только что удалили ее.

3. Разверните каждую затронутую группу синхронизации (в которой подготавливается база данных).

## <a name="handling-changes-that-fail-to-propagate"></a> Обработка изменений, которые не удается распространить

### <a name="reasons-that-changes-fail-to-propagate"></a>Причины, по которым не удается распространить изменения

Изменения не удается распространить по различным причинам, в том числе:

-   Несовместимость схемы или типа данных.

-   Попытка вставить нулевое значение в столбцах, не допускающих нуля.

-   Нарушение ограничений внешнего ключа.

### <a name="what-happens-when-changes-fail-to-propagate"></a>Что происходит, когда изменения не распространяются?

-   Группа синхронизации показывает, что находится в состоянии предупреждения.

-   Подробности содержатся в средстве просмотра журнала в пользовательском интерфейсе портала.

-   Если проблема не будет устранена в течение 45 дней, база данных станет устаревшей.

> [!NOTE]
> Эти изменения никогда не распространяются. Единственным способом восстановления является повторное создание группы синхронизации.

### <a name="recommendation"></a>Рекомендации

Регулярно отслеживайте состояние группы синхронизации и базы данных через интерфейс портала и журнала.

## <a name="modifying-your-sync-group"></a> Изменение группы синхронизации

Не пытайтесь удалить базу данных из группы синхронизации, а затем отредактировать группу без предварительного развертывания одного из этих изменений.

Сначала удалите базу данных из группы синхронизации. Затем разверните изменение и дождитесь отмены подготовки. После завершения этой операции можно отредактировать группу синхронизации и развернуть изменения.

Если вы попытаетесь удалить базу данных, а затем отредактировать группу синхронизации без предварительного развертывания одного из этих изменений, одна из операций завершится сбоем, а интерфейс портала может перейти в несогласованное состояние. В этом случае вы можете обновить страницу, чтобы восстановить правильное состояние.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о синхронизации данных SQL:

-   [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL](sql-database-sync-data.md)
-   [Начало работы с синхронизацией данных SQL Azure (предварительная версия)](sql-database-get-started-sql-data-sync.md)
-   [Устранение неполадок с синхронизацией данных SQL Azure (предварительная версия)](sql-database-troubleshoot-data-sync.md)

-   Полные примеры PowerShell, которые демонстрируют, как настроить синхронизацию данных SQL:
    -   [Использование PowerShell для синхронизации данных между несколькими базами данных SQL Azure](scripts/sql-database-sync-data-between-sql-databases.md)
    -   [Использование PowerShell для синхронизации данных между базой данных SQL Azure и локальной базой данных SQL Server](scripts/sql-database-sync-data-between-azure-onprem.md)

-   [Документация по REST API синхронизации данных SQL](https://github.com/Microsoft/sql-server-samples/raw/master/samples/features/sql-data-sync/Data_Sync_Preview_REST_API.pdf?raw=true)

Дополнительные сведения о Базе данных SQL:

-   [Обзор Базы данных SQL](sql-database-technical-overview.md)
-   [Управление жизненным циклом базы данных](https://msdn.microsoft.com/library/jj907294.aspx)
