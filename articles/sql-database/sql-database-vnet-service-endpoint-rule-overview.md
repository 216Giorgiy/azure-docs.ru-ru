---
title: "Конечные точки службы и правила виртуальной сети для базы данных SQL Azure | Документация Майкрософт"
description: "Пометьте подсеть как конечную точку службы виртуальной сети. Затем внесите конечную точку в виде правила виртуальной сети в список управления доступом к базе данных SQL Azure. После этого база данных SQL будет принимать подключения от всех виртуальных машин и других узлов в этой подсети."
services: sql-database
documentationcenter: 
author: MightyPen
manager: jhubbard
editor: 
tags: 
ms.assetid: 
ms.service: sql-database
ms.custom: VNet Service endpoints
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: On Demand
ms.date: 11/13/2017
ms.author: genemi
ms.openlocfilehash: ce223fbd6a69bc789f902f9478b5255edfd44844
ms.sourcegitcommit: b5c6197f997aa6858f420302d375896360dd7ceb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2017
---
# <a name="use-virtual-network-service-endpoints-and-rules-for-azure-sql-database"></a>Использование конечных точек службы и правил виртуальной сети для базы данных SQL Azure

*Правила виртуальной сети* — это одна из функций безопасности брандмауэра, обеспечивающая управление приемом сервером базы данных SQL Azure подключений из определенных подсетей в виртуальных сетях. В этой статье объясняется, почему правила виртуальной сети иногда являются лучшим вариантом для защиты подключений к базе данных SQL Azure.

Чтобы создать правило виртуальной сети, требуется [конечная точка службы виртуальной сети][vm-virtual-network-service-endpoints-overview-649d], используемая для ссылки.


> [!NOTE]
> В службе "База данных SQL Azure" эта функция доступна в виде предварительной версии во всех регионах, где представлено общедоступное облако Azure.

#### <a name="how-to-create-a-virtual-network-rule"></a>Как создать правило виртуальной сети

Если вы собираетесь просто создать правило виртуальной сети, то можете сразу перейти к инструкциям и пояснениям, приведенным [далее в этой статье](#anchor-how-to-by-using-firewall-portal-59j).






<a name="anch-terminology-and-description-82f" />

## <a name="terminology-and-description"></a>Терминология и описание

**Виртуальная сеть**. С подпиской Azure могут быть связаны виртуальные сети.

**Подсеть**. Виртуальная сеть содержит **подсети**. Все ваши виртуальные машины Azure назначены в подсети. Одна подсеть может содержать несколько виртуальных машин или других вычислительных узлов. Вычислительные узлы, которые находятся вне вашей виртуальной сети, не имеют доступа к ней, если только не настроить систему безопасности таким образом, чтобы предоставить им доступ.

**Конечная точка службы виртуальной сети**. [Конечная точка службы виртуальной сети][vm-virtual-network-service-endpoints-overview-649d] — это подсеть, значения свойств которой включают в себя одно или несколько формальных имен типов службы Azure. В этой статье мы рассмотрим тип **Microsoft.Sql**, который относится к службе Azure, которая называется Базой данных SQL.

**Правило виртуальной сети**. Правило виртуальной сети для сервера базы данных SQL — это подсеть, которая указана в списке управления доступом (ACL) сервера базы данных SQL. Для включения в ACL для базы данных SQL подсеть должна содержать имя типа **Microsoft.Sql**.

Правило виртуальной сети предписывает серверу базы данных SQL принимать подключения от всех узлов, находящихся в подсети.







<a name="anch-benefits-of-a-vnet-rule-68b" />

## <a name="benefits-of-a-virtual-network-rule"></a>Преимущества правила виртуальной сети

Пока вы не выполните соответствующие действия, виртуальные машины в подсети не могут взаимодействовать с базой данных SQL. Одно действие, которое устанавливает связь — это создание правила виртуальной сети. Основной причиной, по выбору подхода правило виртуальной сети требуется сравнить контрастность Если речь идет о конкурирующих параметры безопасности, предоставляемой брандмауэром.

#### <a name="a-allow-access-to-azure-services"></a>О. Разрешение доступа к службам Azure

В области брандмауэра есть кнопка **ON/OFF** (Вкл./выкл.) с надписью **Разрешить доступ к службам Azure**. Значение **ON** (Вкл.) разрешает подключение со всех IP-адресов Azure и из всех подсетей Azure. Эти Azure IP-адреса и подсети могут принадлежать не вам. Возможно, значение **ON** (Вкл.) делает вашу систему более открытой, чем требуется для базы данных SQL. Правила виртуальной сети обеспечивают более детализированный контроль.

#### <a name="b-ip-rules"></a>B. Правила фильтрации IP-адресов

Брандмауэр базы данных SQL позволяет указать диапазоны IP-адресов, подключения с которых принимаются базой данных SQL. Эта методика хорошо подходит для постоянных IP-адресов, которые находятся за пределами частной сети Azure. Однако за пределами частной сети Azure используется множество *динамических* IP-адресов. Динамические IP-адреса могут изменяться, например при перезапуске виртуальной машины. Было бы неразумно указывать динамический IP-адрес в правиле брандмауэра в рабочей среде.

Можно сохранить выбранный IP-адрес, присвоив виртуальной машине *статический* IP-адрес. Дополнительные сведения см. в разделе [Настройка частных IP-адресов для виртуальной машины с помощью портала Azure][vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w].

Однако применение статических IP-адресов может усложнить управление и создать дополнительные расходы при увеличении масштаба среды. Правила виртуальной сети проще устанавливать и контролировать.

#### <a name="c-cannot-yet-have-sql-database-on-a-subnet"></a>C. Пока еще невозможно разместить базу данных SQL в подсети

Если сервер базы данных SQL Azure был узлом в подсети виртуальной сети, то все узлы в этой виртуальной сети могли взаимодействовать с базой данных SQL. В этом случае виртуальные машины удалось связаться с базой данных SQL без необходимости все правила виртуальной сети или правил IP.

Однако к сентябрю 2017 года служба базы данных SQL Azure еще не вошла в список служб, которые могут быть назначены в подсеть.






<a name="anch-details-about-vnet-rules-38q" />

## <a name="details-about-virtual-network-rules"></a>Сведения о правилах виртуальной сети

В этом разделе приводятся некоторые сведения о правилах виртуальной сети.

#### <a name="only-one-geographic-region"></a>Только один географический регион

Каждая конечная точка службы виртуальной сети может использоваться только в одном регионе Azure. Конечная точка не поддерживает прием подключений из подсети в других регионах.

Любое правило виртуальной сети ограничена регионом, в котором используется базовая конечная точка.

#### <a name="server-level-not-database-level"></a>На уровне сервера, а не базы данных

Каждое правило виртуальной сети применяется ко всему серверу базы данных SQL Azure, не только к одной конкретной базе данных на сервере. Другими словами, правило виртуальной сети применяется на уровне сервера,а не на уровне базы данных.

- Для сравнения, правило фильтрации IP-адресов можно применить на любом уровне.

#### <a name="security-administration-roles"></a>Роли администратора безопасности

Роли безопасности для администрирования конечных точек службы виртуальной сети разделены. Требуется действие каждой из следующих ролей:

- **администратор сети:**&nbsp; включение конечной точки;
- **администратор базы данных:**&nbsp; обновление списка управления доступом (ACL) для добавления данной подсети на сервер базы данных SQL.

*Альтернатива RBAC*

Роли администратора сети и администратора базы данных имеют больше возможностей, чем требуется для управления правилами виртуальной сети. На самом деле для этого требуется только часть их возможностей.

У вас есть возможность использовать [управление доступом на основе ролей (RBAC)][rbac-what-is-813s] в Azure, чтобы создать отдельную настраиваемую роль с необходимыми правами. Эту настраиваемую роль можно использовать вместо роли администратора сети или администратора базы данных. Контактная зона потенциального нарушения безопасности будет меньше при добавлении пользователя в настраиваемую роль, чем при его добавлении в одну из двух основных ролей администратора.

> [!NOTE]
> В некоторых случаях база данных SQL Azure и подсеть виртуальной сети находятся в разных подписках. В таких случаях необходимо обеспечить следующую конфигурацию.
> - Обе подписки должны быть в одном клиенте Azure Active Directory.
> - Пользователь имеет необходимые разрешения для запуска операций, таких как включение конечных точек службы и добавление подсетью виртуальной сети на заданный сервер.

## <a name="limitations"></a>Ограничения

Для базы данных SQL Azure правила виртуальной сети имеют следующие ограничения.

- В настоящее время веб-приложение Azure в подсети с включенными **конечными точками службы** не функционирует правильно. Мы работаем над реализацией такой возможности.
    - Пока эта функция не будет полностью реализована, рекомендуем переместить веб-приложение в другую подсеть без включенных конечных точек службы для SQL.

- В брандмауэре для базы данных SQL каждое правило виртуальной сети ссылается на подсеть. Все такие упомянутые подсети должны размещаться в том же географическом регионе, где размещена база данных SQL.

- Каждый сервер базы данных SQL Azure может использовать до 128 записей ACL для любой заданной виртуальной сети.

- Правила виртуальной сети применяются только к виртуальным сетям Azure Resource Manager, но не к сетям на основе [классической модели развертывания][arm-deployment-model-568f].

- Включение конечных точек службы виртуальной сети для базы данных SQL Azure также включает конечные точки для служб MySQL и PostGres Azure. Тем не менее, если конечные точки включены в базе данных, подключиться через них к экземплярам MySQL или Postgres не удастся.
    - Основной причиной является то, что сейчас MySQL и PostGres не поддерживают списки управления доступом (ACL).

- К приведенным ниже элементам сети применяются диапазоны IP-адресов в брандмауэре, а правила виртуальной сети — нет:
    - [виртуальная частная сеть (VPN) типа "сеть — сеть"][vpn-gateway-indexmd-608y].
    - локальная среда с подключением [ExpressRoute][expressroute-indexmd-744v].

#### <a name="expressroute"></a>ExpressRoute

Если сеть подключена к сети Azure с использованием [ExpressRoute][expressroute-indexmd-744v], то для каждого канала настроены два общедоступных IP-адреса в Microsoft Edge. Эти два IP-адреса используются для подключения к службам Майкрософт, таким как служба хранилища Azure, с помощью общедоступного пиринга Azure.

Чтобы разрешить взаимодействие канала с базой данных SQL Azure, необходимо создать правила IP-сети для общедоступных IP-адресов каналов. Чтобы найти общедоступные IP-адреса канала ExpressRoute, отправьте запрос по ExpressRoute в службу поддержки через портал Azure.


<!--
FYI: Re ARM, 'Azure Service Management (ASM)' was the old name of 'classic deployment model'.
When searching for blogs about ASM, you probably need to use this old and now-forbidden name.
-->

## <a name="impact-of-removing-allow-all-azure-services"></a>Влияние удаления «Позволяет всем службам Azure»

Многим пользователям необходимо удалить **позволяет всем службам Azure** из свои серверы SQL Azure и заменить ее именем правила брандмауэра виртуальной сети.
Однако удаление это затрагивает следующие функции Azure SQLDB:

#### <a name="import-export-service"></a>Служба импорта и экспорта
На виртуальных машинах в Azure выполняется Azure SQLDB служба импорта и экспорта. Эти виртуальные машины не находятся в виртуальной сети и таким образом получить IP-адрес Azure при подключении к базе данных. Об удалении **позволяет всем службам Azure** эти виртуальные машины не смогут получить доступ к базам данных.
Проблему можно обойти. BACPAC импорта или экспорта непосредственно в коде с помощью API-Интерфейс DACFx. Убедитесь, что это развертывается на виртуальной машине, которая находится в подсети виртуальной сети, для которой заданы правила брандмауэра.

#### <a name="sql-database-query-editor"></a>Редактор запросов базы данных SQL
Редактор запросов базы данных SQL Azure развертывается на виртуальных машинах в Azure. Эти виртуальные машины не находятся в виртуальной сети. Поэтому виртуальные машины получить IP-адреса Azure при подключении к базе данных. Об удалении **позволяет всем службам Azure**эти виртуальные машины не смогут получить доступ к базам данных.

#### <a name="table-auditing"></a>Аудит таблицы
В настоящее существует два способа включения аудита базы данных SQL. Аудит таблицы завершается сбоем после включения конечные точки службы на сервере SQL Azure. Устранение рисков здесь является перемещение аудит больших двоичных объектов.


## <a name="impact-of-using-vnet-service-endpoints-with-azure-storage"></a>Эффект использования виртуальной сети конечные точки службы с хранилища Azure

Хранилище Azure реализации одной функции, можно ограничить возможность подключения к вашей учетной записи хранилища.
Если вы решили использовать эту функцию с помощью учетной записи хранилища, используемый сервером SQL Azure, могут возникнуть проблемы. Далее следует список и описание возможностей Azure SQLDB, затрагиваемые этим экземпляром.

#### <a name="azure-sqldw-polybase"></a>Azure SQLDW PolyBase
PolyBase обычно используется для загрузки данных в Azure SQLDW из учетных записей хранения. Если учетной записи хранения, загружаемых данных ограничивает доступ только к набору подсетей виртуальной сети, подключение из PolyBase к учетной записи будет приостановлено.

#### <a name="azure-sqldb-blob-auditing"></a>Большой двоичный объект Azure SQLDB аудита
Аудит больших двоичных объектов помещает журналы аудита в вашу учетную запись хранилища. Если эта учетная запись использует функции конечных точек службы СОБЫТИ подключения к учетной записи хранилища Azure SQLDB будет приостановлено.


## <a name="errors-40914-and-40615"></a>Ошибки 40914 и 40615

Ошибка подключения 40914 относится к *правилам виртуальных сетей*, указанным в области "Брандмауэр" на портале Azure. Ошибка 40615 отличается от предыдущей тем, что относится к *правилам IP-адресов* в брандмауэре.

#### <a name="error-40914"></a>Ошибка 40914

*Текст сообщения.* Невозможно открыть сервер *[имя-сервера]*, запрашиваемый именем входа. Клиенту запрещен доступ к серверу.

*Описание ошибки.* Клиент находится в подсети, которая содержит конечные точки сервера виртуальной сети. Но для сервера базы данных SQL Azure не установлено правило виртуальной сети, разрешающее подсети обмениваться данными с базой данных SQL.

*Устранение ошибки.* В области "Брандмауэр" портала Azure с помощью элемента управления правилами виртуальных сетей [добавьте правило виртуальной сети](#anchor-how-to-by-using-firewall-portal-59j) для этой подсети.

#### <a name="error-40615"></a>Ошибка 40615

*Текст сообщения.* Не удается открыть сервер {0}, запрашиваемый при попытке входа. Для клиента с IP-адресом '{1}' доступ к серверу не разрешен.

*Описание ошибки.* Клиент пытается подключиться с IP-адреса, который не авторизован на подключение к серверу базы данных SQL Azure. Брандмауэр сервера не содержит правило IP-адресов, разрешающее клиенту обмениваться данными с базой данных SQL с этого IP-адреса.

*Устранение ошибки.* Введите IP-адрес клиента в качестве правила IP-адреса. Это следует сделать в области "Брандмауэр" на портале Azure.


Список сообщений об ошибках базы данных SQL содержится в [этом документе][sql-database-develop-error-messages-419g].





<a name="anchor-how-to-by-using-firewall-portal-59j" />

## <a name="portal-can-create-a-virtual-network-rule"></a>Портал может создать правило виртуальной сети

В этом разделе показано, как с помощью [портала Azure][http-azure-portal-link-ref-477t] создать *правило виртуальной сети* в базе данных SQL Azure. Правило предписывает базе данных SQL принимать подключения из определенной подсети, которая помечена как *конечная точка службы виртуальной сети*.

#### <a name="powershell-alternative"></a>Альтернатива PowerShell

Создать правила виртуальной сети можно также с помощью сценария PowerShell. Для этого используется командлет **New-AzureRmSqlServerVirtualNetworkRule**. Если вам это интересно, ознакомьтесь с разделом [Создание конечной точки службы и правила виртуальной сети для базы данных SQL Azure с помощью PowerShell][sql-db-vnet-service-endpoint-rule-powershell-md-52d].

#### <a name="prerequisites"></a>Технические условия

Необходима подсеть, помеченная определенным *именем типа* конечной точки службы виртуальной сети, относящимся к базе данных SQL Azure.

- В нашем случае именем типа конечной точки является **Microsoft.Sql**.
- Если ваша подсеть, возможно, не помечена именем типа, прочитайте раздел [Проверка того, является ли подсеть конечной точкой][sql-db-vnet-service-endpoint-rule-powershell-md-a-verify-subnet-is-endpoint-ps-100].

<a name="a-portal-steps-for-vnet-rule-200" />

### <a name="azure-portal-steps"></a>Инструкции для портала Azure

1. Войдите на [портал Azure][http-azure-portal-link-ref-477t].

2. Выберите **Серверы SQL Server** &gt; **Брандмауэр или виртуальные сети**.

3. Задайте для элемента управления **Разрешить доступ к службам Azure** значение "Выкл.".

    > [!IMPORTANT]
    > Если оставить элемента управления присвоено значение ON, сервера базы данных SQL Azure принимает подключения от какой-либо подсети. Оставить элемент управления установлен в значение ON может быть слишком доступ с точки зрения безопасности. Используя конечные точки службы виртуальной сети Microsoft Azure с правилами виртуальной сети базы данных SQL можно уменьшить контактную зону системы безопасности.

4. Щелкните элемент управления **+ Добавить существующий** в разделе **Виртуальные сети**.

    ![Щелкните "Добавить существующий" (добавьте конечную точку подсети в виде правила SQL).][image-portal-firewall-vnet-add-existing-10-png]

5. В новой области **Создание или изменение** введите в элементы управления имена ресурсов Azure.

    > [!TIP]
    > Необходимо указать правильный **префикс адреса** для подсети. Его значение можно найти на портале.
    > Выберите **Все ресурсы** &gt; **Все типы** &gt; **Виртуальные сети**. Фильтр отобразит ваши виртуальные сети. Выберите свою виртуальную сеть и щелкните **Подсети**. Столбец **Диапазон адресов** содержит интересующий вас префикс адреса.

    ![Заполните поля для нового правила.][image-portal-firewall-create-update-vnet-rule-20-png]

6. Нажмите кнопку **ОК** в нижней части области.

7.  Созданное правило виртуальной сети отобразится в области брандмауэра.

    ![Просмотрите новое правило в области брандмауэра.][image-portal-firewall-vnet-result-rule-30-png]


> [!NOTE]
> Следующие состояния или состояний применяются к правилам:
> - **Все готово:** указывает, что операция, которой вы начали завершилась успешно.
> - **Ошибка:** указывает, что не удалось выполнить операцию, которой вы начали.
> - **Удалить:** только применяется к операции удаления и указывает, что правило был удален и больше не применяется.
> - **InProgress:** указывает, что операция не выполняется. Старое правило применяется, когда операция находится в этом состоянии.


<a name="anchor-how-to-links-60h" />

## <a name="related-articles"></a>Связанные статьи

- [Конечные точки служб виртуальной сети][vm-virtual-network-service-endpoints-overview-649d]
- [Правила брандмауэра уровня сервера и уровня базы данных SQL Azure][sql-db-firewall-rules-config-715d]

Функция правило виртуальной сети для базы данных SQL Azure стала доступна в конце сентября 2017 г.

## <a name="next-steps"></a>Дальнейшие действия

- [Создание конечной точки службы виртуальной сети, а затем правило виртуальной сети для базы данных SQL Azure с помощью PowerShell.][sql-db-vnet-service-endpoint-rule-powershell-md-52d]


<!-- Link references, to images. -->

[image-portal-firewall-vnet-add-existing-10-png]: media/sql-database-vnet-service-endpoint-rule-overview/portal-firewall-vnet-add-existing-10.png

[image-portal-firewall-create-update-vnet-rule-20-png]: media/sql-database-vnet-service-endpoint-rule-overview/portal-firewall-create-update-vnet-rule-20.png

[image-portal-firewall-vnet-result-rule-30-png]: media/sql-database-vnet-service-endpoint-rule-overview/portal-firewall-vnet-result-rule-30.png



<!-- Link references, to text, Within this same Github repo. -->

[arm-deployment-model-568f]: ../azure-resource-manager/resource-manager-deployment-model.md

[expressroute-indexmd-744v]: ../expressroute/index.md

[rbac-what-is-813s]: ../active-directory/role-based-access-control-what-is.md

[sql-db-firewall-rules-config-715d]: sql-database-firewall-configure.md

[sql-database-develop-error-messages-419g]: sql-database-develop-error-messages.md

[sql-db-vnet-service-endpoint-rule-powershell-md-52d]: sql-database-vnet-service-endpoint-rule-powershell.md

[sql-db-vnet-service-endpoint-rule-powershell-md-a-verify-subnet-is-endpoint-ps-100]: sql-database-vnet-service-endpoint-rule-powershell.md#a-verify-subnet-is-endpoint-ps-100

[vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w]: ../virtual-network/virtual-networks-static-private-ip-arm-pportal.md

[vm-virtual-network-service-endpoints-overview-649d]: https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview

[vpn-gateway-indexmd-608y]: ../vpn-gateway/index.md



<!-- Link references, to text, Outside this Github repo (HTTP). -->

[http-azure-portal-link-ref-477t]: https://portal.azure.com/




<!-- ??2
#### Syntax related articles
- REST API Reference, including JSON

- Azure CLI

- ARM templates
-->
