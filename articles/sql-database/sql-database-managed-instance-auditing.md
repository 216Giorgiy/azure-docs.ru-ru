---
title: Аудит управляемого экземпляра Базы данных SQL Azure | Документация Майкрософт
description: Узнайте, как приступить к аудиту управляемого экземпляра Базы данных SQL Azure с помощью T-SQL
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
f1_keywords:
- mi.azure.sqlaudit.general.f1
author: vainolo
ms.author: arib
ms.reviewer: vanto
manager: craigg
ms.date: 01/15/2019
ms.openlocfilehash: 04c4bba2647b9b17b1282c9a1608fd2e9325f661
ms.sourcegitcommit: 9999fe6e2400cf734f79e2edd6f96a8adf118d92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2019
ms.locfileid: "54427922"
---
# <a name="get-started-with-azure-sql-database-managed-instance-auditing"></a>Приступая к аудиту управляемого экземпляра Базы данных SQL Azure

Аудит [управляемого экземпляра Базы данных SQL](sql-database-managed-instance.md) отслеживает события базы данных и сохраняет их в журнал аудита в учетной записи хранения Azure. Аудит также дает следующие возможности:

- Аудит может помочь вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности.
- Средства аудита способствуют соблюдению стандартов соответствия, но не гарантируют их выполнение. Дополнительную информацию о программах Azure, поддерживающих проверку соблюдения стандартов, см. в [Центре управления безопасностью Azure](https://azure.microsoft.com/support/trust-center/compliance/).

## <a name="set-up-auditing-for-your-server-to-azure-storage"></a>Настройка аудита для сервера в службе хранилища Azure

В следующем разделе описывается настройка аудита для управляемого экземпляра.

1. Перейдите на [портал Azure](https://portal.azure.com).
1. Создайте **контейнер** службы хранилища Azure для хранения журналов аудита.

   1. Перейдите к хранилищу Azure, в котором вы намерены хранить журналы аудита.

      > [!IMPORTANT]
      > Используйте учетную запись хранения из же региона, где размещен сервер управляемого экземпляра, чтобы избежать операций чтения и записи между регионами.

   1. На странице учетной записи хранения перейдите на вкладку **Обзор** и щелкните **BLOB-объекты**.

      ![Мини-приложение больших двоичных объектов Azure](./media/sql-managed-instance-auditing/1_blobs_widget.png)

   1. В верхнем меню щелкните **+ Контейнер**, чтобы создать новый контейнер.

      ![Значок создания контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/2_create_container_button.png)

   1. Укажите **имя** контейнера, установите **закрытый** уровень общего доступа и щелкните **ОК**.

     ![Конфигурация создания контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/3_create_container_config.png)

1. После создания контейнера существует два способа настроить его в качестве целевого объекта для журналов аудита: [с помощью T-SQL](#blobtsql) или [с помощью пользовательского интерфейса SQL Server Management Studio (SSMS)](#blobssms):

   - <a id="blobtsql"></a>Настройте хранилище BLOB-объектов для журналов аудита с помощью T-SQL:

     1. В списке контейнеров щелкните только что созданный контейнер, а затем **Свойства контейнера**.

        ![Кнопка свойств контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/4_container_properties_button.png)

     1. Скопируйте URL-адрес контейнера, щелкнув значок копирования, и сохраните этот URL-адрес (например, в Блокноте) для дальнейшего использования. URL-адрес контейнера должен иметь формат `https://<StorageName>.blob.core.windows.net/<ContainerName>`.

        ![Копирование URL-адреса контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/5_container_copy_name.png)

     1. Создайте **маркер SAS** службы хранилища Azure, который предоставляет права доступа к учетной записи хранения для аудита Управляемого экземпляра:

        - Перейдите к учетной записи хранения Azure, в которой вы создали контейнер на предыдущем шаге.

        - Щелкните **Подписанный URL-адрес** в меню "Параметры хранилища".

          ![Значок подписанного URL-адреса в меню параметров хранилища.](./media/sql-managed-instance-auditing/6_storage_settings_menu.png)

        - Настройте SAS следующим образом.

          - **Допустимые службы**: BLOB-объект

          - **Дата начала**: чтобы избежать проблем, связанных с часовыми поясами, выберите вчерашний день.

          - **Дата окончания**: выберите дату окончания срока действия для этого маркера SAS.

            > [!NOTE]
            > Чтобы избежать сбоев аудита, не забудьте возобновить маркер по истечении срока действия.

          - Нажмите кнопку **Создать SAS**.
            
            ![Конфигурация SAS](./media/sql-managed-instance-auditing/7_sas_configure.png)

        - Когда вы щелкнете "Создать SAS", в нижней части страницы появится маркер SAS. Скопируйте маркер, щелкнув значок копирования, и сохраните его (например, в Блокноте) для дальнейшего использования.

          ![Копирование маркера SAS](./media/sql-managed-instance-auditing/8_sas_copy.png)

          > [!IMPORTANT]
          > Удалите символ знака вопроса (?) в начале маркера.

     1. Подключитесь к Управляемому экземпляру, используя SQL Server Management Studio (SSMS) или любое другое поддерживаемое средство.

     1. Выполните следующую инструкцию T-SQL, чтобы **создать новые учетные данные** с использованием URL-адреса контейнера и маркера SAS, которые вы создали на предыдущих этапах.

        ```SQL
        CREATE CREDENTIAL [<container_url>]
        WITH IDENTITY='SHARED ACCESS SIGNATURE',
        SECRET = '<SAS KEY>'
        GO
        ```

     1. Выполните следующую инструкцию T-SQL, чтобы создать новый аудит сервера (выберите любое удобное имя аудита и укажите URL-адрес контейнера, созданный ранее). Если значение `RETENTION_DAYS` не указано, по умолчанию используется значение 0 (неограниченный период удержания).

        ```SQL
        CREATE SERVER AUDIT [<your_audit_name>]
        TO URL ( PATH ='<container_url>' [, RETENTION_DAYS =  integer ])
        GO
        ```

      1. Продолжите, [создав спецификацию аудита сервера или спецификацию аудита базы данных](#createspec).

   - <a id="blobssms"></a>Настройте хранилище BLOB-объектов для журналов аудита с помощью SQL Server Management Studio (SSMS) 18 (предварительная версия):

     1. Подключитесь к управляемому экземпляру через пользовательский интерфейс SQL Server Management Studio (SSMS).

     1. Разверните корневой узел обозревателя объектов.

     1. Разверните узел **Безопасность**, щелкните правой кнопкой мыши узел **Аудиты** и щелкните "Создать аудит":

        ![Развертывание узла аудитов и безопасности](./media/sql-managed-instance-auditing/10_mi_SSMS_new_audit.png)

     1. Убедитесь, что в поле **Назначение аудита** выбрано значение "URL-адрес", и щелкните **Обзор**:

        ![Просмотр службы хранилища](./media/sql-managed-instance-auditing/11_mi_SSMS_audit_browse.png)

     1. Войдите в учетную запись Azure (необязательно):

        ![Вход в Azure](./media/sql-managed-instance-auditing/12_mi_SSMS_sign_in_to_azure.png)

     1. Выберите подписку, учетную запись хранения и контейнер больших двоичных объектов из раскрывающихся списков или создайте собственный контейнер, щелкнув **Создать**. Когда вы зададите все необходимые параметры, нажмите кнопку **ОК**:

        ![Выбор подписки Azure, учетной записи хранения и контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/13_mi_SSMS_select_subscription_account_container.png)

     1. Нажмите кнопку **ОК** в диалоговом окне "Создать аудит".

1. <a id="createspec"></a>После настройки контейнера больших двоичных объектов как целевого объекта для журналов аудита создайте спецификацию аудита сервера или аудита базы данных, как это делается для SQL Server:

   - [Руководство по созданию спецификации T-SQL для аудита сервера](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Руководство по созданию спецификации T-SQL для аудита базы данных](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

1. Включите аудит сервера, созданный на шаге 6:

    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>]
    WITH (STATE=ON);
    GO
    ```

Дополнительные сведения см. в следующих статьях:

- [Get started with Azure SQL Database Managed Instance Auditing](#auditing-differences-between-managed-instance-azure-sql-database-and-sql-server) (Приступая к аудиту управляемых экземпляров Базы данных SQL Azure)
- [CREATE SERVER AUDIT (Transact-SQL)](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-transact-sql)
- [ALTER SERVER AUDIT (Transact-SQL)](https://docs.microsoft.com/sql/t-sql/statements/alter-server-audit-transact-sql)

## <a name="set-up-auditing-for-your-server-to-event-hub-or-log-analytics"></a>Настройка аудита для сервера в концентраторе событий или Log Analytics

Журналы аудита из Управляемого экземпляра могут отправляться даже в концентраторы событий или Log Analytics с помощью Azure Monitor. В этом разделе описывается, как это настроить.

1. Откройте [портал Azure](https://portal.azure.com/) и перейдите к Управляемому экземпляру SQL.

2. Щелкните **Параметры диагностики**.

3. Щелкните **Включить диагностику**. Если диагностика уже включена, будет отображена кнопка *+Add diagnostic setting* (+ Добавить параметр диагностики).

4. Выберите **SQLSecurityAuditEvents** из списка журналов.

5. Выберите место назначения для событий аудита — концентратор событий, Log Analytics или оба варианта. Настройте необходимые параметры (например, рабочую область Log Analytics) для каждой цели.

6. Выберите команду **Сохранить**.

    ![Настройка параметров диагностики](./media/sql-managed-instance-auditing/9_mi_configure_diagnostics.png)

7. Подключитесь к Управляемому экземпляру, используя **SQL Server Management Studio (SSMS)** или любой другой поддерживаемый клиент.

8. Выполните следующую инструкцию T-SQL для создания аудита сервера.

    ```SQL
    CREATE SERVER AUDIT [<your_audit_name>] TO EXTERNAL_MONITOR;
    GO
    ```

9. Создайте спецификацию аудита сервера или спецификацию аудита базы данных, как для обычного сервера SQL Server.

   - [Руководство по созданию спецификации T-SQL для аудита сервера](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Руководство по созданию спецификации T-SQL для аудита базы данных](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

10. Включите аудит сервера, созданный на шаге 7.
 
    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>] WITH (STATE=ON);
    GO
    ```

## <a name="consume-audit-logs"></a>Использование журналов аудита

### <a name="consume-logs-stored-in-azure-storage"></a>Использование журналов аудита, которые хранятся в службе хранилища Azure

Просмотреть журналы аудита больших двоичных объектов можно несколькими способами.

- Системная функция `sys.fn_get_audit_file` (T-SQL) возвращает данные журнала аудита в табличном формате. Дополнительные сведения об использовании этой функции см. в статье [sys.fn_get_audit_file (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-functions/sys-fn-get-audit-file-transact-sql).

- Журналы аудита можно просматривать с помощью таких инструментов, как [обозреватель хранилищ Azure](https://azure.microsoft.com/features/storage-explorer/). В хранилище Azure журналы аудита сохраняются в виде коллекции файлов больших двоичных объектов в контейнере, который был определен для хранения журналов аудита. Дополнительные сведения об иерархии папки для хранения, соглашении об именовании и формате журнала см. в [документации по формату журнала аудита больших двоичных объектов](https://go.microsoft.com/fwlink/?linkid=829599).

- Полный список методов использования журналов аудита см. в статье о [начале работы с аудитом базы данных SQL](https://docs.microsoft.com/azure/sql-database/sql-database-auditing).

  > [!IMPORTANT]
  > Просмотр записей аудита на портале Azure (на панели "Записи аудита") сейчас не поддерживается для Управляемого экземпляра.

### <a name="consume-logs-stored-in-event-hub"></a>Использование журналов аудита, которые хранятся в концентраторе событий

Чтобы работать с данными журналов аудита из концентратора событий, необходимо настроить потоковую передачу для получения событий и их записи в целевой объект. Дополнительные сведения доступны в документации по Центрам событий Azure.

### <a name="consume-and-analyze-logs-stored-in-log-analytics"></a>Использование и анализ журналов, хранящихся в Log Analytics

Если журналы аудита записываются в Log Analytics, они будут доступны в рабочей области Log Analytics. В ней можно выполнять расширенный поиск в данных аудита. Перейдите в Log Analytics. В разделе *Общие* щелкните *Журналы* и введите простой запрос, например `search "SQLSecurityAuditEvents"`, чтобы просмотреть журналы аудита.  

Log Analytics предоставляет аналитические данные по работе систем в режиме реального времени, используя встроенный поиск и настраиваемые панели мониторинга для быстрого анализа миллионов записей по всем рабочим нагрузкам и серверам. Дополнительную полезную информацию о языке поиска и командах Log Analytics см. в [документации по поиску Log Analytics](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview).

## <a name="auditing-differences-between-managed-instance-azure-sql-database-and-sql-server"></a>Различия между аудитом управляемых экземпляров, Базы данных SQL Azure и SQL Server

Ниже перечислены основные различия между аудитом SQL Управляемого экземпляра, базы данных SQL Azure и SQL Server на локальном компьютере

- Для управляемого экземпляра аудит SQL выполняется на уровне сервера, а файлы журнала `.xel` сохраняются в учетной записи хранилища BLOB-объектов Azure.
- В базе данных SQL Azure аудит SQL выполняется на уровне базы данных.
- В SQL Server на локальном компьютере или виртуальной машине аудит SQL выполняется на уровне сервера, но события сохраняются в журналы событий файловой системы или журналы событий Windows.

Аудит XEvent в Управляемом экземпляре поддерживает цели хранилища BLOB-объектов Azure. Журналы файловой системы и журналы Windows **не поддерживаются**.

Основные различия в синтаксисе `CREATE AUDIT` для аудита в хранилище BLOB-объектов Azure:

- Новый синтаксис `TO URL` позволяет указать URL-адрес контейнера в хранилище BLOB-объектов Azure, куда будут помещены файлы `.xel`.
- Новый синтаксис `TO EXTERNAL MONITOR` позволяет использовать концентратор событий и Log Analytics в качестве назначения.
- Синтаксис `TO FILE` **не поддерживается**, так как управляемый экземпляр не может использовать файловые ресурсы Windows.
- Параметр завершения работы **не поддерживается**.
- Значение 0 для `queue_delay` **не поддерживается**.

## <a name="next-steps"></a>Дополнительная информация

- Полный список методов использования журналов аудита см. в статье о [начале работы с аудитом базы данных SQL](https://docs.microsoft.com/azure/sql-database/sql-database-auditing).
- Дополнительную информацию о программах Azure, поддерживающих проверку соблюдения стандартов, см. в [Центре управления безопасностью Azure](https://azure.microsoft.com/support/trust-center/compliance/).

<!--Image references-->









