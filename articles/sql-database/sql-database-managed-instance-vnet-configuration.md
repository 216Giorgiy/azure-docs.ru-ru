---
title: Конфигурация виртуальной сети для Управляемого экземпляра Базы данных SQL Azure | Документация Майкрософт
description: В этой статье описываются параметры конфигурации виртуальной сети (VNet) для Управляемого экземпляра Базы данных SQL Azure.
services: sql-database
author: srdan-bozovic-msft
manager: craigg
ms.service: sql-database
ms.custom: managed instance
ms.topic: conceptual
ms.date: 08/21/2018
ms.author: srbozovi
ms.reviewer: bonova, carlrab
ms.openlocfilehash: 748489785241c0eab6022e3585164974f330d6f9
ms.sourcegitcommit: ebd06cee3e78674ba9e6764ddc889fc5948060c4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/07/2018
ms.locfileid: "44049679"
---
# <a name="configure-a-vnet-for-azure-sql-database-managed-instance"></a>Настройка виртуальной сети для Управляемого экземпляра Базы данных SQL Azure

Управляемый экземпляр Базы данных SQL Azure (предварительная версия) должен быть развернут в [виртуальной сети (VNet)](../virtual-network/virtual-networks-overview.md). Это развертывание поддерживает следующие сценарии: 
- Подключение к управляемому экземпляру непосредственно из локальной сети 
- Подключение управляемого экземпляра к связанному серверу или другому локальному хранилищу данных 
- Подключение управляемого экземпляра к ресурсам Azure  

## <a name="plan"></a>План

Составьте план по развертыванию управляемого экземпляра в виртуальной сети в соответствии с ответами на следующие вопросы: 
- Сколько управляемых экземпляров вы планируете развертывать: один или несколько? 

  От числа управляемых экземпляров зависит минимальный размер подсети для их размещения. Дополнительные сведения см. в разделе [Определение размера подсети для управляемого экземпляра](#determine-the-size-of-subnet-for-managed-instances). 
- Будет ли управляемый экземпляр развернут в имеющейся виртуальной сети или же вы создадите для него новую? 

   Если вы планируете использовать имеющуюся виртуальную сеть, необходимо изменить ее конфигурацию, чтобы она соответствовала управляемому экземпляру. Дополнительные сведения см. в разделе [Изменение существующей виртуальной сети для управляемого экземпляра](#modify-an-existing-virtual-network-for-managed-instances). 

   Если вы планируете создать виртуальную сеть, см. раздел [Создание виртуальной сети для управляемого экземпляра](#create-a-new-virtual-network-for-managed-instances).

## <a name="requirements"></a>Требования

Для создания управляемого экземпляра внутри виртуальной сети необходимо выделить подсеть, которая соответствует следующим требованиям.
- **Выделенная подсеть**. С подсетью не должны быть связаны другие облачные службы и она не должна быть подсетью шлюза. Вы не сможете создать управляемый экземпляр в подсети, если в ней содержатся другие ресурсы, кроме управляемого экземпляра, а также не сможете позже добавить в такую подсеть другие ресурсы.
- **Отсутствие группы безопасности сети**. С подсетью не должна быть связана группа безопасности сети. 
- **Наличие определенной таблицы маршрутов**. Подсеть должна иметь пользовательскую таблицу маршрутов (UDR) с интернет-маршрутом следующего прыжка 0.0.0.0/0, который должен быть единственным назначенным ей маршрутом. Дополнительные сведения см. в разделе [Создание необходимой таблицы маршрутов и ее привязка](#create-the-required-route-table-and-associate-it)
3. **Наличие необязательной пользовательской DNS**. Если в виртуальной сети определена пользовательская DNS, то в список должен быть добавлен IP-адрес рекурсивных сопоставителей Azure (например, 168.63.129.16). Дополнительные сведения см. в статье [Configuring a Custom DNS for Azure SQL Database Managed Instance](sql-database-managed-instance-custom-dns.md) (Настройка пользовательской DNS для Управляемого экземпляра Базы данных SQL Azure).
4. **Отсутствие конечной точки службы**. С подсетью не должна быть связана конечная точка службы. При создании виртуальной сети отключите параметр "Конечные точки службы".
5. **Достаточно IP-адресов**. У подсети должно быть как минимум 16 IP-адресов (рекомендуемый минимум — 32 IP-адреса). Дополнительные сведения см. в разделе [Определение размера подсети для управляемого экземпляра](#determine-the-size-of-subnet-for-managed-instances).

> [!IMPORTANT]
> Если целевая подсеть не соответствует каким-либо из перечисленных выше требований, в ней невозможно развернуть управляемый экземпляр. Целевая виртуальная сеть и подсети должны соответствовать этим требованиям для управляемого экземпляра (до и после развертывания), так как любое их нарушение может привести к неисправности или недоступности экземпляра. Для восстановления из этого состояния необходимо создать новый экземпляр в виртуальной сети с соответствующими политиками сети, повторно создать данные уровня экземпляра и восстановить базы данных. Это приведет к простою ваших приложений в течение значительного времени.

С появлением _политики намерений сети_ группу безопасности сети (NSG) можно добавить в подсеть Управляемого экземпляра, после того как он будет создан.

Теперь группу безопасности сети можно использовать, чтобы сузить диапазон IP-адресов, из которых приложения и пользователи смогут запрашивать данные и управлять ими, путем фильтрации сетевого трафика, который поступает на порт 1433. 

> [!IMPORTANT]
> При настройке правил группы безопасности сети, которые будут ограничивать доступ к порту 1433, также необходимо вставить правила для входящих подключений наивысшего приоритета, отображаемые в таблице ниже. В противном случае политика намерений сети блокирует изменения как несоответствующие.

| ИМЯ       |ПОРТ                        |ПРОТОКОЛ|ИСТОЧНИК           |НАЗНАЧЕНИЕ|ДЕЙСТВИЕ|
|------------|----------------------------|--------|-----------------|-----------|------|
|управление  |9000, 9003, 1438, 1440, 1452|Любой     |Любой              |Любой        |РАЗРЕШИТЬ |
|mi_subnet   |Любой                         |Любой     |MI SUBNET        |Любой        |РАЗРЕШИТЬ |
|health_probe|Любой                         |Любой     |AzureLoadBalancer|Любой        |РАЗРЕШИТЬ |

Процесс маршрутизации также был улучшен. Теперь в дополнении к интернет-маршруту следующего прыжка 0.0.0.0/0 можно добавлять определяемый пользователем маршрут (UDR), чтобы направлять трафик в локальные закрытые диапазоны IP-адресов через шлюз виртуальной сети или устройство виртуальной сети.

##  <a name="determine-the-size-of-subnet-for-managed-instances"></a>Определение размера подсети для управляемого экземпляра

При создании Управляемого экземпляра Azure размещает несколько виртуальных машин, число которых зависит от уровня, выбранного во время подготовки. Поскольку виртуальные машины связанны с подсетью, им необходимы IP-адреса. Azure может выделить дополнительные виртуальные машины для обеспечения высокой доступности во время выполнения обычных операций и технического обслуживания. В результате число необходимых IP-адресов будет больше, чем число управляемых экземпляров в подсети. 

Для управляемого экземпляра необходимо не менее 16 и не более 256 IP-адресов в подсети. Поэтому при определении IP-адресов подсети для маски подсети можно использовать значения от /28 до /24. 

> [!IMPORTANT]
> Подсеть с 16-ю IP-адресами является абсолютным минимумом и обладает ограниченным потенциалом для дальнейшего развертывания Управляемого экземпляра. Настоятельно рекомендуется выбирать подсети с префиксом /27 или ниже. 

Если планируется развертывать несколько управляемых экземпляров внутри подсети и при этом необходимо оптимизировать размер подсети, для расчета нужно использовать такие параметры: 

- Azure использует пять IP-адресов в подсети для своих потребностей 
- Каждому экземпляру общего назначения требуются два адреса 
- Каждому критически важному для бизнеса экземпляру требуются четыре адреса.

**Пример**. Вы планируете использовать три экземпляра общего назначения и два критически важных для бизнеса экземпляра. Это означает, что требуется 5 + 3 * 2 + 2 * 4 = 19 IP-адресов. Поскольку диапазоны IP-адресов определяются как значения в степени 2, вам потребуется диапазон из 32 (2 ^ 5) IP-адресов. Таким образом, необходимо зарезервировать подсеть с маской подсети /27. 

> [!IMPORTANT]
> Вычисления, показанные выше, устареют с выпуском дополнительных усовершенствований. 

## <a name="create-a-new-virtual-network-for-managed-instance-using-azure-resource-manager-deployment"></a>Создание новой виртуальной сети для управляемого экземпляра с помощью развертывания Azure Resource Manager

Самый простой способ создания и настройки виртуальной сети — использовать шаблон развертывания Azure Resource Manager.

1. Войдите на портал Azure.

2. Используйте кнопку **Развертывание в Azure**, чтобы развернуть виртуальную сеть в облаке Azure.

  <a target="_blank" href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-sql-managed-instance-azure-environment%2Fazuredeploy.json" rel="noopener" data-linktype="external"> <img src="http://azuredeploy.net/deploybutton.png" data-linktype="external"> </a>

  Эта кнопка откроет форму, которую можно использовать для настройки сетевой среды, в которой можно развернуть управляемый экземпляр.

  > [!Note]
  > Этот шаблон Azure Resource Manager развертывает виртуальную сеть с двумя подсетями. Одна подсеть, называемая **ManagedInstances**, зарезервирована для управляемых экземпляров и имеет предварительно настроенную таблицу маршрутов, а другая подсеть, называемая **Defaul**, используется для других ресурсов, которые должны получить доступ к управляемому экземпляру (например, виртуальные машины Azure). Вы можете удалить подсеть **Default**, если она не нужна.

3. Настройка сетевой среды. В приведенной ниже форме можно настроить параметры сетевой среды.

![Настройка сети Azure](./media/sql-database-managed-instance-get-started/create-mi-network-arm.png)

Вы можете изменить имена виртуальной сети и подсетей и настроить диапазоны IP-адресов, связанные с сетевыми ресурсами. Как только вы нажмете кнопку "Купить", эта форма создаст и настроит вашу среду. Если вам не нужны две подсети, можно удалить подсеть, заданную по умолчанию. 

## <a name="modify-an-existing-virtual-network-for-managed-instances"></a>Изменение существующей виртуальной сети для управляемого экземпляра 

Просмотрев вопросы и ответы в этом разделе, вы узнаете, как добавить управляемый экземпляр в существующую виртуальную сеть. 

**Какая модель используется для развертывания существующей виртуальной сети: классическая или развертывание с помощью Resource Manager?** 

Управляемый экземпляр можно создать только в виртуальных сетях Resource Manager. 

**Вы хотите создать подсеть для управляемого экземпляра SQL или использовать имеющуюся?**.

Перед созданием подсети сделайте следующее: 

- Вычислите размер подсети, следуя инструкциям из раздела [Определение размера подсети для управляемого экземпляра](#determine-the-size-of-subnet-for-managed-instances).
- Следуйте инструкциям из статьи [Создание, изменение или удаление виртуальной сети](../virtual-network/virtual-network-manage-subnet.md). 
- Создайте таблицу маршрутов, которая содержит одну запись **0.0.0.0/0** в качестве интернет-маршрута следующего прыжка и свяжите ее с подсетью управляемого экземпляра.  

Если вы хотите создать Управляемый экземпляр внутри существующей подсети, мы рекомендуем использовать следующий сценарий PowerShell для подготовки подсети.
```powershell
$scriptUrlBase = 'https://raw.githubusercontent.com/Microsoft/sql-server-samples/master/samples/manage/azure-sql-db-managed-instance/prepare-subnet'

$parameters = @{
    subscriptionId = '<subscriptionId>'
    resourceGroupName = '<resourceGroupName>'
    virtualNetworkName = '<virtualNetworkName>'
    subnetName = '<subnetName>'
    }

Invoke-Command -ScriptBlock ([Scriptblock]::Create((iwr ($scriptUrlBase+'/prepareSubnet.ps1?t='+ [DateTime]::Now.Ticks)).Content)) -ArgumentList $parameters
```
Подготовка подсети выполняется в три простых шага:

- Проверка. Выбранная виртуальная сеть и подсеть проверяются на соответствие сетевым требованиям Управляемого экземпляра.
- Подтверждение. Пользователю предоставляется набор изменений, которые необходимо выполнить, чтобы подготовить подсеть для развертывания Управляемого экземпляра, и он получает запрос на согласие.
- Подготовка. Виртуальная сеть и подсеть настраиваются надлежащим образом.

**Настроен ли у вас пользовательский сервер DNS?** 

Если ответ утвердительный, см. статью [Configuring a Custom DNS for Azure SQL Database Managed Instance](sql-database-managed-instance-custom-dns.md) (Настройка пользовательской DNS для Управляемого экземпляра Базы данных SQL Azure). 

- Создайте необходимую таблицу маршрутов и выполните ее привязку: см. раздел [Создание необходимой таблицы маршрутов и ее привязка](#create-the-required-route-table-and-associate-it)

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения см. в статье [Общие сведения об Управляемом экземпляре Базы данных SQL Azure (предварительная версия)](sql-database-managed-instance.md).
- Чтобы узнать как создать виртуальную сеть и управляемый экземпляр, а также восстановить базу данных из резервной копии базы данных см. статью [Создание Управляемого экземпляра Базы данных SQL Azure на портале Azure](sql-database-managed-instance-get-started.md).
- Во избежание проблем при настройке DNS см. статью [Configuring a Custom DNS for Azure SQL Database Managed Instance](sql-database-managed-instance-custom-dns.md) (Настройка пользовательской DNS для Управляемого экземпляра Базы данных SQL Azure)
