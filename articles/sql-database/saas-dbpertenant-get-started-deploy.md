---
title: "Руководство по однотенантной базе данных SaaS в базе данных SQL Azure | Документация Майкрософт"
description: "Разверните и изучите мультитенантное приложение SaaS Wingtip Tickets, которое демонстрирует создание отдельной базы данных для каждого клиента и другие схемы работы с приложениями SaaS и базами данных SQL Azure."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: MightyPen
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/07/2017
ms.author: genemi
ms.openlocfilehash: cbe8a04abbf2dada7cc43e57e823c3a41bf83fe7
ms.sourcegitcommit: d1f35f71e6b1cbeee79b06bfc3a7d0914ac57275
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/22/2018
---
# <a name="deploy-and-explore-a-multi-tenant-saas-application-that-uses-the-database-per-tenant-pattern-with-azure-sql-database"></a>Развертывание и изучение мультитенантного приложения SaaS на основе базы данных SQL Azure, в котором используется отдельная база данных для каждого клиента

В этом руководстве вы развернете и изучите приложение SaaS Wingtip Tickets с *отдельной базой для каждого клиента* (Wingtip). В этом приложении SaaS сохраняются данные нескольких клиентов, и для каждого клиента создается отдельная база данных. Приложение разработано для демонстрации возможностей базы данных SQL Azure, которые упрощают работу со сценариями SaaS.

Если вы нажмете голубую кнопку **Развертывание в Azure**, то через пять минут вы получите мультитенантное приложение SaaS. Это приложение включает базу данных SQL Azure, выполняющуюся в облаке Microsoft Azure. Приложение развертывается с помощью трех примеров клиентов, каждый из которых содержит свою базу данных. Все базы данных развернуты в *эластичный пул* SQL. Приложение развертывается в подписку Azure. Вы получите полный доступ для изучения отдельных компонентов приложения и экспериментов с ними. Исходный код приложения C# и сценарии управления доступны в [репозитории GitHub WingtipTicketsSaaS-DbPerTenant][github-wingtip-dpt].

Из этого руководства вы узнаете следующее:

> [!div class="checklist"]
> - как развернуть приложение SaaS Wingtip;
> - где можно получить исходный код приложения и скрипты управления;
> - сведения о серверах, пулах и базах данных, формирующих приложение;
> - как сопоставить клиентов с данными с помощью *каталога*;
> - как подготовить новый клиент;
> - как выполнить мониторинг активности клиента в приложении.

Чтобы изучить различные модели проектирования и управления SaaS, вы можете ознакомиться с доступной [серией связанных руководств](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials). Они являются продолжением этого руководства, необходимого для выполнения первоначального развертывания.
Изучая руководства, вы можете понять способ реализации различных моделей SaaS, ознакомившись с приведенными сценариями.
В этих сценариях показано, как функции базы данных SQL упрощают развертывание приложений SaaS.

## <a name="prerequisites"></a>предварительным требованиям

Для работы с этим руководством выполните следующие предварительные требования:

* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="deploy-the-wingtip-tickets-saas-application"></a>Развертывание приложения SaaS Wingtip Tickets

#### <a name="plan-the-names"></a>Планирование имен

В инструкциях в этом разделе необходимо указать значение *user*, которое используется для обеспечения глобальной уникальности имен ресурсов, и значение *resource group* для всех ресурсов, созданных при развертывании приложения. Для пользователя с именем *Энн Финли* мы указали следующие сведения.
- *Пользователь:* **af1** *(ее инициалы и цифра. Используйте другое значение (например, af2) при развертывании приложения во второй раз.)*
- *Группа ресурсов:* **wingtip-dpt-af1** *(wingtip-dpt указывает, что это приложение, использующее одну базу данных на клиент. Добавление имени пользователя af1 позволяет сопоставить имя группы ресурсов с именами ресурсов, содержащихся в ней.)*

Теперь выберите ваши имена и запишите их. 

#### <a name="steps"></a>Действия

1. Откройте на портале Azure шаблон развертывания приложения SaaS Wingtip Tickets с отдельной базой данных для каждого клиента. Для этого нажмите кнопку **Развертывание в Azure**.

   <a href="https://aka.ms/deploywingtipdpt" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>

1. В шаблоне введите значения обязательных параметров.

    > [!IMPORTANT]
    > Некоторые проверки подлинности и брандмауэры сервера не защищены специально, так как предназначены для демонстрации. Рекомендуем создать *группу ресурсов*. Не используйте существующие группы ресурсов, серверы или пулы. Не используйте в рабочей среде это приложение, его скрипты или созданные им ресурсы. Поработав с приложением, удалите эту группу ресурсов, чтобы завершить связанное выставление счетов.

    - **Группа ресурсов** — выберите **Создать** и укажите выбранное ранее уникальное **имя** группы ресурсов. 
    - **Расположение** — выберите **Расположение** из раскрывающегося списка.
    - **Пользователь** — используйте значение имени пользователя, выбранное ранее.

1. Разверните приложения.

    - Установите флажок, чтобы принять условия.
    - Щелкните **Приобрести**.

1. Отслеживайте состояние развертывания. Для этого щелкните **Уведомления** (значок колокольчика справа от поля поиска). Развертывание приложения SaaS Wingtip Tickets занимает примерно пять минут.

   ![Развертывание выполнено](media/saas-dbpertenant-get-started-deploy/succeeded.png)

## <a name="download-and-unblock-the-wingtip-tickets-management-scripts"></a>Загрузка и разблокировка скриптов управления для приложения Wingtip Tickets

Пока выполняется развертывание приложения, загрузите исходный код и скрипты управления.

> [!IMPORTANT]
> Исполняемое содержимое (сценарии, библиотеки DLL) может быть заблокировано Windows, в то время как ZIP-файлы можно загрузить с внешнего источника, а затем извлечь их содержимое. Перед извлечением скриптов из ZIP-файла выполните указанные ниже действия, чтобы разблокировать ZIP-файл. Разблокировка гарантирует, что сценарии можно выполнять.

1. Перейдите к [репозиторию GitHub WingtipTicketsSaaS-DbPerTenant][github-wingtip-dpt].
2. Выберите **Clone or download** (Клонировать или скачать).
3. Выберите **Download ZIP** (Скачать ZIP-файл) и сохраните файл.
4. Щелкните правой кнопкой мыши файл **WingtipTicketsSaaS-DbPerTenant-master.zip** и выберите **Свойства**.
5. На вкладке **Общие** выберите **Разблокировать** и **Применить**.
6. Последовательно выберите **ОК**.
7. Извлеките файлы.

Скрипты находятся в папке *..\\WingtipTicketsSaaS-DbPerTenant-master\\Learning Modules*.

## <a name="update-the-user-configuration-file-for-this-deployment"></a>Обновление файла конфигурации пользователя для развертывания

Прежде чем запускать какие-либо сценарии, настройте значения *resource group* и *user* в файле *UserConfig.psm1*. Задайте для этих переменных значения, указанные во время развертывания.

1. В **интегрированной среде сценариев PowerShell** откройте файл ...\\Learning Modules\\**UserConfig.psm1**. 
2. В полях **ResourceGroupName** и **Name** введите специфические для развертывания значения (только в строках 10 и 11).
3. Сохраните изменения.

Эти значения используются почти во всех скриптах.

## <a name="run-the-application"></a>Выполнение приложения

Приложение служит витриной для объектов, в которых проводятся культурные мероприятия. Чаще всего это концертные залы, джаз-клубы, спортивные клубы и т. п. В Wingtip Tickets объекты регистрируются как клиенты. Это дает каждому из них простую возможность предоставлять клиентам список мероприятий и продавать билеты. Для каждого объекта создается персонализированный веб-сайт для отображения списка мероприятий и продажи билетов.

Внутри приложения каждый клиент получает базу данных SQL, развернутую в эластичный пул SQL.

Центральная страница **Концентратор событий** содержит список клиентов в вашем развертывании со ссылками.

1. Откройте *концентратор событий* в веб-браузере по адресу: http://events.wingtip-dpt.&lt;пользователь&gt;.trafficmanager.net. Значение &lt;пользователь&gt; замените именем пользователя для конкретного развертывания.

    ![Концентратор событий](media/saas-dbpertenant-get-started-deploy/events-hub.png)

2. Щелкните **Fabrikam Jazz Club** в *концентраторе событий*.

    ![События](./media/saas-dbpertenant-get-started-deploy/fabrikam.png)

#### <a name="azure-traffic-manager"></a>Azure Traffic Manager

Приложение Wingtip использует [*диспетчер трафика Azure*](../traffic-manager/traffic-manager-overview.md), чтобы управлять распределением входящих запросов. URL-адрес для доступа к странице событий для конкретного клиента указывается в следующем формате:

- http://events.wingtip-dpt.&lt;пользователь&gt;.trafficmanager.net/fabrikamjazzclub

В следующей таблице описываются элементы предыдущего формата.

| Часть URL-адреса        | ОПИСАНИЕ       |
| :-------------- | :---------------- |
| http://events.wingtip-dpt | Элементы события приложения Wingtip.<br /><br /> Суффикс *-dpt* отличает реализацию Wingtip Tickets, использующую *одну базу данных на клиент*, от других вариантов реализации. Например, от *изолированного* однотенантного приложения (*-sa*) или приложения, использующего *мультитенантную базу данных* (*-mt*). |
| .*&lt;пользователь&gt;* | В нашем примере *af1*. |
| .trafficmanager.net/ | базовый URL-адрес диспетчера трафика Azure. |
| fabrikamjazzclub | Указывает клиент *Fabrikam Jazz Club*. |
| &nbsp; | &nbsp; |

1. Приложение событий выполняет анализ имени клиента в URL-адресе.
2. С помощью имени клиента можно создать ключ.
3. Ключ используется, чтобы получить доступ к каталогу и обнаружить расположение базы данных клиента.
    - Каталог реализуется с помощью *управления сопоставлением сегментов*.
4. *Концентратор событий* использует расширенные метаданные из каталога для создания списка URL-адресов страниц событий для каждого клиента.

В рабочей среде обычно создается запись DNS CNAME, которая [*сопоставляет интернет-домен компании*](../traffic-manager/traffic-manager-point-internet-domain.md) с DNS-именем диспетчера трафика.

## <a name="start-generating-load-on-the-tenant-databases"></a>Запуск создания нагрузки в базах данных клиента

Теперь после развертывания приложение готово к работе.
Скрипт *Demo-LoadGenerator* PowerShell запускает рабочую нагрузку, выполняющуюся во всех клиентских базах данных.
Реальная нагрузка в приложении SaaS случайна и непредсказуема.
Для моделирования этого типа нагрузки генератор создает нагрузку со случайными пиковыми нагрузками или вспышками активности на каждом клиенте.
Пиковые нагрузки происходят со случайными интервалами.
Шаблон нагрузки появляется в течение нескольких минут. Поэтому перед мониторингом нагрузки генератор должен работать по крайней мере три или четыре минуты.

1. В *интегрированной среде сценариев PowerShell* откройте скрипт ...\\Learning Modules\\Utilities\\*Demo-LoadGenerator.ps1*.
1. Нажмите клавишу **F5**, чтобы запустить сценарий и генератор нагрузки. (Оставьте значения параметра по умолчанию.)
1. Вам будет предложено войти с учетной записью Azure и, при необходимости, выбрать подписку, которую вы хотите использовать.

Сценарий генератора нагрузки запускает фоновое задание для каждой базы данных в каталоге, а затем останавливается.  При повторном запуске сценарий генератора нагрузки сначала остановит все выполняемые фоновые задания, прежде чем запускать новые.

#### <a name="monitor-the-background-jobs"></a>Мониторинг фоновых заданий

Если вы хотите отслеживать фоновые задания и управлять ими, вы можете выполнить следующие командлеты:

- `Get-Job`
- `Receive-Job`
- `Stop-Job`

#### <a name="demo-loadgeneratorps1-actions"></a>Действия Demo-LoadGenerator.ps1

*Demo-LoadGenerator.ps1* имитирует активную рабочую нагрузку транзакций клиента. Следующие шаги описывают последовательность действий, которые инициирует *Demo-LoadGenerator.ps1*:

1. *Demo-LoadGenerator.ps1* запускает *LoadGenerator.ps1* в фоновом режиме.
    - Оба эти PS1-файлы хранятся в папках *Learning Modules\\Utilities\\*.

1. *LoadGenerator.ps1* перебирает все базы данных клиента в каталоге.

1. *LoadGenerator.ps1* запускает фоновое задание PowerShell для каждой базы данных клиента. 
    - По умолчанию фоновые задания выполняются в течение 120 минут.
    - Каждое задание создает нагрузку на ЦП в одной базе данных клиента, выполняя *sp_CpuLoadGenerator*.  Интенсивность и продолжительность нагрузки изменяется в зависимости от `$DemoScenario`. 
    - *sp_CpuLoadGenerator* циклически выполняет инструкцию SQL SELECT, которая создает высокую нагрузку на ЦП. Интервал времени между вызовами инструкции SELECT зависит от значений параметров, что позволяет управлять нагрузкой на ЦП. Уровни нагрузки и интервалы выбираются в случайном порядке, чтобы имитация нагрузки была более реалистичной.
    - Этот SQL-файл хранится в папке *WingtipTenantDB\\dbo\\StoredProcedures\\*.

1. Если `$OneTime = $false`, то генератор нагрузки запускает фоновые задания и продолжает работать, проверяя каждые 10 секунд, не были ли подготовлены новые клиенты. Если задать `$OneTime = $true`, то LoadGenerator запустит фоновые задания, а затем его выполнение на переднем плане будет остановлено. В рамках этого руководства оставьте `$OneTime = $false`.

  Если вы хотите остановить или перезапустить генератор нагрузки, используйте клавиши CTRL+C или CTRL+BREAK. 

  Если вы оставили генератор нагрузки работать на переднем плане, используйте другой экземпляр интегрированной среды сценариев PowerShell для запуска других сценариев PowerShell.

&nbsp;

Прежде чем перейти к следующему разделу, оставьте генератор нагрузки в состоянии вызова задания.

## <a name="provision-a-new-tenant"></a>Подготовка нового клиента

При первоначальном развертывании создается три примера клиента. Теперь вы создадите другой клиент, чтобы увидеть, как это влияет на развернутое приложение. Рабочий процесс подготовки новых клиентов для приложения Wingtip описан в статье [Сведения о подготовке новых клиентов и их регистрации в каталоге](saas-dbpertenant-provision-and-catalog.md). На этом этапе вы создадите клиент, что займет не больше одной минуты.

1. Откройте новый экземпляр *интегрированной среды сценариев PowerShell*.
1. Откройте файл …\\Learning Modules\Provision and Catalog\\*Demo-ProvisionAndCatalog.ps1*.
2. Нажмите клавишу **F5** для запуска скрипта. (Не изменяйте значения по умолчанию.)

   > [!NOTE]
   > Во многих скриптах SaaS Wingtip Tickets переменная *$PSScriptRoot* используется для перехода по папкам и вызова функций из других скриптов. Эта переменная вычисляется только при выполнении полного скрипта путем нажатия клавиши **F5**.  Если выделить несколько сценариев и запустить их (**F8**), может произойти ошибка. Поэтому выполните сценарии нажатием клавиши **F5**.

Новая база данных клиента:

- создана в эластичном пуле SQL;
- инициализирована;
- зарегистрирована в каталоге.

Когда подготовка успешно завершится, созданный сайт *События* для нового клиента откроется в браузере.

![Новый клиент](./media/saas-dbpertenant-get-started-deploy/red-maple-racing.png)

Обновите *концентратор событий*, чтобы отобразить в списке новый клиент.

## <a name="explore-the-servers-pools-and-tenant-databases"></a>Изучение серверов, пулов и клиентских баз данных

Теперь, когда вы запустили выполнение нагрузки в коллекции клиентов, давайте рассмотрим некоторые из развернутых ресурсов.

1. На [портале Azure](http://portal.azure.com) перейдите к списку серверов SQL Server и откройте сервер **catalog-dpt-&lt;пользователь&gt;**.
    - Этот сервер каталога содержит две базы данных: **tenantcatalog** и **basetenantdb**. Вторая из них является шаблоном базы данных, который копируется для создания новых клиентов.

   ![databases](./media/saas-dbpertenant-get-started-deploy/databases.png)

2. Вернитесь к списку серверов SQL.

3. Откройте сервер **tenants1-dpt-&lt;пользователь&gt;**, который содержит клиентские базы данных.

4. Обратите внимание на следующие элементы:
    - Каждая клиентская база данных является эластичной базой данных *уровня "Стандартный"* в пуле уровня "Стандартный" на 50 eDTU.
    - База данных *Red Maple Racing* — это подготовленная ранее клиентская база данных.

   ![server](./media/saas-dbpertenant-get-started-deploy/server.png)

## <a name="monitor-the-pool"></a>Отслеживание пула

После выполнения *LoadGenerator.ps1* несколько минут вы должны иметь достаточный объем данных, чтобы рассмотреть некоторые функции мониторинга. Эти функции встроены в пулы и базы данных.

Перейдите к серверу **tenants1-dpt-&lt;пользователь&gt;**, а затем щелкните **Pool1**, чтобы просмотреть использование ресурсов для пула. На следующих диаграммах показан генератор нагрузки, который работал в течение часа.

   ![Отслеживание пула](./media/saas-dbpertenant-get-started-deploy/monitor-pool.png)

- На первой диаграмме с меткой **Использование ресурсов** показано использование eDTU для пула в целом.
- На второй диаграмме показано использование eDTU для пяти наиболее активных баз данных в пуле.

На этих двух диаграммах хорошо видно, что эластичные пулы и база данных SQL хорошо подходят для непредсказуемых рабочих нагрузок приложения SaaS.
На диаграммах показано, что 4 базы данных передают 40 eDTU. Все базы данных легко поддерживаются пулом, рассчитанным на 50 eDTU. Пул с 50 единицами eDTU может поддерживать даже более высокие рабочие нагрузки.
Если они были подготовлены как автономные базы данных, каждая из них должна быть уровня S2 (50 DTU), чтобы поддерживать пиковые нагрузки.
Стоимость 4 автономных баз данных уровня S2 в 3 раза превышала бы стоимость пула.
На самом деле клиенты базы данных SQL используют до 500 баз данных в пулах на 200 eDTU.
Дополнительные сведения см. в статье об [отслеживании производительности примера приложения SaaS для WTP](saas-dbpertenant-performance-monitoring.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

- Дополнительные [руководства на основе приложения SaaS Wingtip Tickets с отдельной базой данных для каждого клиента](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials).
- Дополнительные сведения об эластичных пулах см. в статье [*Эластичные пулы помогают управлять несколькими базами данных SQL и масштабировать их*](sql-database-elastic-pool.md).
- Дополнительные сведения об эластичных заданиях см. в статье [*Управление масштабируемыми облачными базами данных*](sql-database-elastic-jobs-overview.md).
- Дополнительные сведения о шаблонах разработки для мультитенантных приложений SaaS и базы данных SQL Azure см. в [*этой статье*](saas-tenancy-app-design-patterns.md).


## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали следующее:

> [!div class="checklist"]
> - Развертывание приложения SaaS Wingtip Tickets
> - О серверах, пулах и базах данных, формирующих приложение.
> - О клиентах, сопоставленных с данными с помощью *каталога*.
> - Как подготовить новые клиенты.
> - Как просмотреть историю использования пула для отслеживания работы клиента.
> - Как удалить примеры ресурсов, чтобы прекратить связанное выставление счетов.

Далее ознакомьтесь со статьей [Сведения о подготовке новых клиентов и их регистрации в каталоге](saas-dbpertenant-provision-and-catalog.md).



<!-- Link references. -->

[github-wingtip-dpt]: https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant 

