<properties
   pageTitle="Шаблоны разработки мультитенантных приложений SaaS с использованием базы данных SQL Azure | Microsoft Azure" 
   description="В этой статье описаны требования и общие шаблоны архитектуры данных мультитенантных приложений баз данных, работающих в облачной среде, а также различные компромиссы, связанные с этими шаблонами. Также здесь объясняется, как служба базы данных SQL Azure с пулами эластичных баз данных и эластичными инструментами позволяет выполнить эти требования без компромиссов."
   keywords=""
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jhubbard"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="sqldb-design"
   ms.date="06/07/2016"
   ms.author="carlrab"/>

# Шаблоны разработки для мультитенантных приложений SaaS с использованием базы данных Azure SQL

В этой статье рассматриваются требования и общие шаблоны архитектуры данных для мультитенантных приложений базы данных программного обеспечения как услуги (SaaS), работающих в облачной среде, а также различные компромиссы, связанные с этими шаблонами. Также здесь объясняется, как служба базы данных SQL Azure с пулами эластичных баз данных и эластичными инструментами позволяет выполнить эти требования без компромиссов.

## Введение

Опыт работы с поставщиками приложений SaaS в течение нескольких последних лет показывает, что при разработке моделей аренды для уровней данных мультитенантных приложений разработчики часто принимают решение не в пользу долгосрочной перспективы. По крайней мере изначально простота разработки и низкая стоимость услуг поставщика облачных служб считались более важными, чем изоляция клиентов и масштабируемость приложений. Зачастую это приводит к проблемам со степенью удовлетворенности клиентов и дорогостоящему изменению курса в будущем.

В контексте этой статьи мультитенатное приложение — это приложение, расположенное в облачной среде и предоставляющее одинаковый набор служб нескольким сотням или тысячам клиентов, которые не используют данные совместно и не обращаются к данным друг друга. Первоначальная категория такой службы — это приложение SaaS, предоставляющее службы своим клиентам в облачной среде.

## Мультитенантные приложения

Мультитенантные приложения — выдающийся пример приложения с простым секционированием данных и рабочих нагрузок. Например, в мультитенантных приложениях данные и рабочие нагрузки обычно можно секционировать вдоль границ между клиентами, так как большинство запросов выполняются в рамках клиента. Это свойство присуще данным и рабочей нагрузке, а шаблоны приложений, рассматриваемые далее в статье, поддерживают его.

Эти приложения распределены по всему спектру облачных приложений:
- приложения баз данных от независимых поставщиков программного обеспечения, переходящие в облако в качестве приложений SaaS;
- приложения SaaS, созданные для облака с нуля;
- приложения для прямых потребителей или пользователей; 
- корпоративные приложения для сотрудников.

Облачные приложения SaaS и приложения SaaS, лежащие в основе приложений баз данных от независимых поставщиков программного обеспечения, обычно становятся мультитенантными приложениями. Эти приложения SaaS предоставляют клиентам возможности специального программного приложения как услуги. У клиентов есть доступ к службе приложения, и они полностью владеют связанными данными, хранимыми в приложении. Но чтобы воспользоваться преимуществами SaaS, клиенты должны отказаться от определенной части контроля над своими данными и передать их доверенному поставщику SaaS, который сможет обеспечить их защиту и изолировать их от данных других клиентов. Типичные примеры — приложения MYOB, SnelStart, Salesforce и т. д. Все эти приложения допускают секционирование вдоль границ между клиентами и поэтому поддерживают шаблоны приложений, которые рассматриваются в следующих разделах этой статьи.

Приложения, предоставляющие службы потребителям или сотрудникам в организации напрямую (их зачастую называют пользователями, а не клиентами), образуют другую категорию в спектре мультитенантных приложений. Клиенты подписываются на службу и не владеют данными, которые собирает и хранит поставщик услуг. К поставщикам услуг применяются менее строгие требования относительно изоляции данных клиентов, отличные от принятых государством законов о конфиденциальности. Типичные примеры — поставщики мультимедийного содержимого, например Netflix, Spotify, Xbox Live и т. д. К другим примерам приложений с простым секционированием можно отнести веб-приложения для клиентов или приложения "Интернета вещей", где каждый клиент или каждое устройство может служить в качестве раздела, а границы разделов можно размещать между разными пользователями или устройствами.

Но также понятно, что не все приложения можно легко секционировать по одному свойству, например клиенту, потребителю, пользователю или устройству. Представьте, например, сложные приложения планирования ресурсов предприятия (ERP) с продуктами, заказами и клиентами. Обычно у них сложная схема с тысячами тесно взаимосвязанных таблиц. Невозможно разработать такую стратегию секционирования, которая охватывала бы все таблицы и задания в рабочей нагрузке. Поэтому мы не будем рассматривать такие приложения далее в этой статье.

Шаблоны разработки мультитенантных приложений, рассматриваемые в следующих разделах, относятся ко всем шаблонам приложений выше с данными и рабочими нагрузками, которые легко секционируются. Но для простоты представления все они будут называться мультитенантными приложениями SaaS.

## Компромиссы при разработке мультитенантного приложения

Разработчикам, создающим мультитенантные приложения в облаке, нужно учесть следующие ключевые требования:

-	***Изоляция клиентов***. Разработчики должны обеспечить, что ни один клиент не сможет получить несанкционированный доступ к данным других клиентов. Это требование изоляции распространяется и на другие свойства, например защита от "шумных соседей", возможность восстановления данных конкретного клиента, возможность настройки для определенного клиента и т. д. 
-	***Стоимость облачных ресурсов***. Приложение SaaS должно иметь оптимальную цену. Поэтому при разработке мультитенантных приложений разработчики приложений SaaS должны оптимизировать стоимость использования облачных ресурсов (вычислительных ресурсов, ресурсов хранения и т. д.).
-	***Простота разработки и выполнения операций***. Поставщикам мультитенантных приложений требуется защитить данные путем изоляции, обслуживать приложения и схему базы данных, выполнять мониторинг работоспособности и устранять неполадки клиента. Сложность разработки и выполнения операций приложения создает дополнительные расходы и влечет неудовлетворенность клиентов.
-	***Масштабируемость***. Для успешной работы приложения SaaS нужно постепенно добавлять клиенты, а также дополнительную емкость для отдельных клиентов, требующих дополнительных ресурсов.

Но невозможно удовлетворить всем этим требованиям одновременно. Облачное решение с минимальной стоимостью может не быть самым удобным в плане разработки. Нередко можно наблюдать, как разработчики принимают необоснованные решения, руководствуясь четырьмя требованиями выше.

Важнейшим требованием в отношении мультитенантных приложений SaaS, которые разрабатываются с учетом рекомендаций других компаний, чаще всего является изоляция клиентов. Очень часто разработчиков привлекают явные преимущества простоты и стоимости, и они игнорируют изоляцию клиентов и масштабируемость. Из-за такого компромисса в будущем придется приложить дополнительные усилия и потратить дополнительные средства, так как по мере роста службы требования к изоляции клиента становятся все более важными и должны выполняться на уровне приложения.

Для мультитенантных приложений, предоставляющих потребительские службы для пользователей напрямую, изоляция клиентов может оказаться не столь приоритетной, как оптимизация стоимости облачных ресурсов.

Популярный шаблон разработки — объединение нескольких клиентов в одной или в нескольких базах данных. Воспринимаемые преимущества этого подхода — низкая стоимость, так как платить нужно только за несколько баз данных, и простота эксплуатации, которая достигается за счет работы с минимальным количеством баз данных. Для таких мультитенантных приложений SaaS со временем это решение приведет к существенным недостаткам в отношении изоляции клиентов и масштабируемости. Если клиенты нужно изолировать, необходимо будет приложить дополнительные усилия для защиты данных клиента от несанкционированного доступа или "шумных соседей" в общем хранилище. Это может значительно усложнить разработку приложений и увеличить затраты на поддержку изоляции. Аналогичным образом при добавлении новых клиентов правильное масштабирование уровня данных такого приложения обычно требует привлечения опытных разработчиков, которые смогут распределить данные клиента между несколькими базами данных.

## Модели данных мультитенантного приложения 

Общие рекомендации по разработке для размещения данных клиента можно представить в виде трех отдельных моделей.


  ![модели данных мультитенантного приложения](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-multi-tenant-data-models.png) Рис. 1. Общие рекомендации по разработке для моделей данных мультитенантных приложений
  
1.	***Отдельная база данных для каждого клиента***. При этом подходе каждый клиент размещается в своей базе данных. Все данные конкретного клиента ограничены базой данных и изолированы от других клиентов и их данных.
2.	***Сегментированная общая база данных***. При таком подходе используется несколько баз данных с несколькими клиентами, которые совместно используют одну базу данных, т. е. каждой базе данных назначается отдельный набор клиентов с использованием стратегии секционирования, например хэш-секционирование, секционирование по диапазонам или по спискам. Эту стратегию распределения данных часто называют сегментированием.
3.	***Одна общая база данных***. При этом подходе используется одна большая база данных, содержащая данные для всех клиентов, которые различаются по столбцу идентификатора клиента. 
  
> [AZURE.NOTE] В некоторых случаях разные клиенты также помещаются в разные схемы баз данных, где имя схемы используется для устранения неоднозначностей между разными клиентами. Этот подход не рекомендуется применять, так как при нем требуется использовать динамический SQL. Кроме того, он не может обеспечить эффективное кэширование плана. Следовательно, далее эта статья посвящена подходу с общей таблицей в этой категории.
 
## Характеристика популярных моделей данных мультитенантных приложений

Наряду с использованием модели данных мультитенантных приложений важно оценивать с точки зрения компромиссов разработки приложений, которые рассматривались в предыдущем разделе.

-	***Изоляция***. Уровень изоляции клиентов — это мера, определяющая степень изоляции клиентов, которой можно добиться при использовании модели данных.
-	***Стоимость облачных ресурсов***. При оптимизации стоимости облачных ресурсов учитывается объем общих ресурсов для клиентов. Стоимость ресурсов можно определить как стоимость вычислительных ресурсов и ресурсов хранения. 
-	***Стоимость разработки и выполнения операций***. Простота разработки и развертывания приложений, а также управления ими позволяет уменьшить общую стоимость работы приложения SaaS.  

Используя эти аспекты, можно охарактеризовать модели мультитенантных данных выше и использование базы данных и представить эти сведения на квадрантах, как показано на рис. 2 ниже. Уровень изоляции клиентов и объем общих ресурсов описывают параметры, размещаемые на оси X и Y. Большая диагональная стрелка посредине указывает на стоимость разработки и операций.

![популярные шаблоны](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-popular-application-patterns.png) Рис. 2. Характеристика популярных моделей данных мультитенантных приложений

В правом нижнем квадранте на рис. 2 показан подход, в котором используется одна потенциально большая общая база данных с общей таблицей (или отдельной схемой) в качестве одного из шаблонов приложений. Этот подход обеспечивает эффективное совместное использование ресурсов, так как все клиенты используют одинаковые ресурсы базы данных (ЦП, память и ввод-вывод) в одной базе данных. Тем не менее изоляция клиентов ограничена. Чтобы защитить клиенты друг от друга на уровне приложения, необходимо принять дополнительные меры. Это может привести к значительному увеличению стоимости разработки и выполнения операций при разработке приложений и управлении ими. Кроме того, масштабируемость ограничивается масштабом оборудования, используемого для размещения базы данных.

В средней части показан подход, при котором несколько клиентов сегментированы между несколькими разными базами данных (обычно между разными единицами масштабирования оборудования), а в каждой базе данных размещено подмножество клиентов. Такой подход позволяет решить проблемы масштабируемости предыдущего шаблона. Если требуется дополнительная емкость для добавления клиентов, их можно легко разместить в новых базах данных, выделенных новым единицам масштабирования оборудования. Тем не менее объем общих ресурсов сокращен, так как только клиенты, размещенные в одних и тех же единицах масштабирования, совместно используют ресурсы. Кроме того, при этом подходе уровень изоляции клиентов меняется несущественно, так как множество клиентов по-прежнему находятся в одном размещении и для них не реализована автоматическая защита от взаимного вмешательства. Сложность приложения остается высокой. Этот подход часто называют сегментированием.

Верхний левый квадрант на рис. 2 выше представляет собой третий подход. При этом каждый клиент помещается в отдельную базу данных. Для такого подхода характерны высокий уровень изоляции клиентов и малый объемом общих ресурсов, так как каждая база данных предоставляет собственные выделенные ресурсы. Этот подход идеален, если все клиенты демонстрируют прогнозируемую рабочую нагрузку. Но как только рабочие нагрузки клиентов становятся менее предсказуемыми (распространенный случай для SaaS), невозможно оптимизировать совместное использование ресурсов. В этом случае поставщик выделяет чрезмерное количество ресурсов в соответствии с требованиями или сокращает количество ресурсов, а это приводит к увлечению затрат или неудовлетворенности клиентов. Следовательно, предпочтительно увеличить объем общих ресурсов для клиентов, чтобы еще больше снизить стоимость решения. Увеличение количества баз данных также приводит к увеличению стоимости разработки и выполнения операций при разработке и обслуживании приложений. Мы вернемся к этим проблемам в следующем разделе. Тем не менее не стоит забывать, что этот метод обеспечивает максимальный уровень изоляции с минимальными усилиями для клиентов по сравнению с другими методами.

Кроме того, на выбор шаблона разработки также влияют следующие дополнительные факторы:

-	***Владение данными клиента***. Если клиент является владельцем своих данных, лучше всего подходит шаблон с использованием одной базы данных на клиента.
-	***Масштабирование***. Если приложение предназначено для множества клиентов, лучше всего применить подходы с совместным использованием базы данных, например сегментирование. Но в этом случае выставляются жесткие требования к изоляции.
-	***Стоимость и бизнес-модель***. Если доход на клиента слишком мал (менее одного доллара), требования к изоляции отходят на второй план. В этом случае разумно использовать общую базу данных. Если доход составляет несколько долларов или больше, можно использовать отдельную базу данных для каждого клиента. Это позволяет сократить расходы на разработку и выполнение операций.

Учитывая компромиссы выше, как показано на рис. 2, идеальная мультитенантная модель должна предусматривать высокий уровень изоляции клиентов и оптимальный уровень совместного использования ресурсов. Такая модель показана в верхнем правом квадранте.

## Поддержка мультитенантности с использованием Базы данных SQL Azure

База данных SQL Azure поддерживает все шаблоны мультитенантных приложений, указанных на рис. 2. Благодаря пулам эластичных баз данных теперь она также поддерживает новый шаблон приложения, который объединяет в себе преимущества изоляции и совместного использования ресурсов подхода с использованием одной базы данных для каждого клиента (верхний правый квадрант (зеленый) на рис. 3 ниже). Средства и возможности эластичных баз данных в базе данных SQL Azure позволяют оптимизировать стоимость разработки и выполнения операций при разработке и эксплуатации приложения с большим количеством баз данных (затененная область на рис. 3 ниже). С помощью этих средств можно создавать приложения и управлять ими, применяя любой из шаблонов с несколькими базами данных. В следующих подразделах подробно рассматриваются возможности базы данных SQL и ее преимущества для мультитенантных моделей.

![шаблон базы данных SQL](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-patterns-sqldb.png) Рис. 3. Шаблоны мультитенантных приложений с использованием Базы данных SQL Azure

## Модель, предусматривающая использование одной базы данных для каждого клиента, с пулами и инструментами эластичных БД

База данных SQL Azure предоставляет пулы эластичных баз данных для лучшей поддержки подхода с использованием одной базы данных для каждого клиента. При этом объединяются преимущества изоляции клиентов и совместного использования ресурсов в базах данных. Она разработана в качестве решения уровня данных для поставщиков SaaS, позволяющего создавать мультитенантные приложения. В сочетании со средствами эластичной базы данных мультитенантность становится встроенной, а задача по совместному использованию ресурсов клиентами перемещается из приложения на уровень службы базы данных. Управление или выполнение запросов в масштабе в нескольких базах данных упрощается благодаря заданиям обработки эластичных БД, запросам к эластичным базам данных, эластичным транзакциям и клиентской библиотеке эластичной базы данных.

| Требования к приложению | Возможности базы данных SQL |
| ------------------------ | ------------------------- |
| Изоляция клиентов и совместное использование ресурсов | [Пулы эластичных баз данных.](sql-database-elastic-pool.md) Эта функция позволяет выделить пул ресурсов баз данных SQL и распределить эти ресурсы между несколькими базами данных. Кроме того, отдельные базы данных могут извлекать из пула ресурсы, необходимые при пиковом потреблении емкости из-за изменений рабочей нагрузки клиентов. При необходимости масштаб пула эластичных БД можно увеличить или уменьшить. Пулы эластичных БД также обеспечивают простоту управления, мониторинга и устранения неполадок на уровне пула. |
| Простота разработки и выполнения операций в базах данных | [Пулы эластичных БД](sql-database-elastic-pool.md) (см. выше)|
||[Запрос к эластичной базе данных](sql-database-elastic-query-horizontal-partitioning.md) предоставляет возможность выполнять запросы к базам данных для формирования отчетов или выполнения анализа между клиентами.|
||[Задания обработки эластичных БД](sql-database-elastic-jobs-overview.md) предоставляют возможность упаковывать и надежно развертывать операции обслуживания или изменения схемы в нескольких базах данных.|
||[Эластичные транзакции](sql-database-elastic-scale.md) предоставляют возможность обрабатывать изменения в нескольких базах данных в атомарном и изолированном режиме. Это необходимо, если приложение требует полного выполнения операций с несколькими базами данных. |
||[Клиентская библиотека эластичной базы данных](sql-database-elastic-database-client-library.md) позволяет управлять распределением данных и сопоставлением клиентов с базами данных. |
||||

## Общие модели

Как описано выше, для большинства поставщиков SaaS подходы с использованием общей модели могут создавать проблемы с изоляцией клиентов, а также вызвать трудности при разработке и обслуживании приложений. Но для мультитенантных приложений, предоставляющих службы пользователям напрямую, требования к изоляции клиентов могут быть не такими приоритетными, как необходимость оптимизации затрат. В них можно очень плотно разместить клиенты в одной или нескольких базах данных, чтобы снизить затраты. Модели с общими базами данных, в которых используется одна или несколько сегментированных баз данных, повышают эффективность совместного использования ресурсов и уменьшают совокупную стоимость. База данных SQL Azure предоставляет некоторые возможности, которые позволяют клиентам обеспечить защиту и управление путем изоляции в масштабе на уровне данных.

| Требования к приложению | Возможности Базы данных SQL |
| ------------------------ | ------------------------- |
| Возможности обеспечения защиты путем изоляции | [Безопасность на уровне строк](https://msdn.microsoft.com/library/dn765131.aspx) |
|| [Схема базы данных](https://msdn.microsoft.com/library/dd207005.aspx) |
| Простота разработки и выполнения операций в базах данных | [Запросы к эластичным БД](sql-database-elastic-query-horizontal-partitioning.md) |
|| [Задания обработки эластичных БД](sql-database-elastic-jobs-overview.md) |
|| [Эластичные транзакции](sql-database-elastic-transactions-overview.md) |
|| [Клиентская библиотека эластичной базы данных](sql-database-elastic-database-client-library.md) |
|| [Разделение и объединение эластичной базы данных](sql-database-elastic-scale-overview-split-and-merge.md) |
||||

## Заключение

Требования к изоляции клиентов очень важны в большинстве мультитенантных приложений SaaS. Самый лучший вариант с точки зрения изоляции — это подход с использованием одной базы данных для каждого клиента. Остальные два подхода требуют множества дополнительных действий на уровне приложения. Изоляцию при этом должны обеспечивать опытные разработчики. Это существенно увеличивает затраты и риск. Если требования к изоляции не учитываются на ранней стадии разработки службы, в первых двух моделях со временем это может создать больше затрат. Основные недостатки модели с использованием одной базы данных для каждого клиента связаны с увеличением стоимости облачных ресурсов, вызванным ограниченным совместным использованием, а также обслуживанием большого количества баз данных и управлением ими. Зачастую разработчикам приложений SaaS очень сложно идти на эти компромиссы.

Хотя эти компромиссы и могут быть главными препятствиями для большинства поставщиков облачных служб баз данных, пул эластичных баз данных и возможности эластичных баз данных службы Базы данных Azure SQL позволяют устранить их. Разработчики SaaS могут сочетать характеристики изоляции, которые предлагает модель с использованием одной базы данных для каждого клиента, оптимизировать совместное использование ресурсов и применять улучшенное управление множеством баз данных благодаря эластичным БД и связанным средствам.

Для поставщиков мультитенантных приложений, которые не предъявляют требования к изоляции клиентов и могут очень плотно разместить клиенты в базе данных, чтобы сократить затраты, "общие" модели данных позволят повысить эффективность совместного использования ресурсов и уменьшить общую стоимость. Используя средства эластичных баз данных, библиотеки сегментирования и функции обеспечения безопасности Базы данных SQL Azure, поставщики SaaS могут создавать такие приложения и управлять ими.

## Дальнейшие действия

Пример приложения, демонстрирующий клиентскую библиотеку, см. в статье [Приступая к работе с инструментами эластичных баз данных](sql-database-elastic-scale-get-started.md).

Сведения о том, как преобразовать существующие базы данных, чтобы использовать эти инструменты, см. в статье [Перенос существующих баз данных для масштабирования](sql-database-elastic-convert-to-use-elastic-tools.md).

Сведения о том, как создать пул, см. в [руководстве](sql-database-elastic-pool-create-portal.md).

## Подробнее

[Что такое пул эластичных баз данных Azure](sql-database-elastic-pool.md)

[Общие сведения о возможностях эластичных баз данных](sql-database-elastic-scale-introduction.md)

## Вопросы и запросы на функции

Все возникшие вопросы задавайте на [форуме по базам данных SQL](http://social.msdn.microsoft.com/forums/azure/home?forum=ssdsgetstarted), а запросы новых функций оставляйте на [форуме отзывов и предложений по базам данных SQL](https://feedback.azure.com/forums/217321-sql-database/).









	

<!---HONumber=AcomDC_0608_2016-->