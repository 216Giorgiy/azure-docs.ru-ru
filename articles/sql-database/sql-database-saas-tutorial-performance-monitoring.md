---
title: "Мониторинг производительности приложения SaaS базы данных SQL | Документация Майкрософт"
description: "Мониторинг и контроль производительности для примера приложения базы данных SQL Azure Wingtip Tickets (WTP)"
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: tutorial
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: hero-article
ms.date: 05/10/2017
ms.author: billgib; sstein
ms.translationtype: Human Translation
ms.sourcegitcommit: fc4172b27b93a49c613eb915252895e845b96892
ms.openlocfilehash: af9511978718af10c97bee6af3a2835c9d2c1ff4
ms.contentlocale: ru-ru
ms.lasthandoff: 05/12/2017


---
# <a name="monitor-performance-of-the-wtp-sample-saas-application"></a>Мониторинг производительности примера приложения SaaS WTP

В этом руководстве рассматриваются несколько встроенных возможностей мониторинга и создания оповещений базы данных SQL и эластичных пулов, а также приведены основные сценарии управления производительностью приложений SaaS.

Приложение Wingtip Tickets создано на основе модели, предусматривающей использование одной базы данных для каждого объекта (клиента). Как и во многих приложениях SaaS, рабочую нагрузку клиента предсказать невозможно, так как пользователи могут покупать билеты в любое время. Чтобы воспользоваться преимуществами этого шаблона использования, базы данных клиента развертываются в пулы эластичных баз данных. Эластичные пулы оптимизируют затраты на решение за счет совместного использования ресурсов в нескольких базах данных. При использовании этого шаблона важно выполнять мониторинг использования ресурсов пула и базы данных, чтобы обеспечить достаточную загруженность пулов. Кроме того, необходимо убедиться, что отдельные базы данных имеют достаточно ресурсов, а пулы не превышают ограничения на использование [единиц eDTU](sql-database-what-is-a-dtu.md). В этом руководстве рассматриваются способы мониторинга баз данных и пулов и управления ими, а также приведены действия, которые необходимо предпринять в случае изменений рабочей нагрузки.

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]

> * Моделирование использования ресурсов в базах данных клиентов с помощью предоставленного генератора нагрузки.
> * Наблюдение за реакцией баз данных клиентов при увеличении нагрузки.
> * Увеличение масштаба эластичного пула из-за роста нагрузки на базу данных.
> * Подготовка второго эластичного пула для балансировки нагрузки базы данных.


Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение WTP. Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных Azure SQL](sql-database-saas-tutorial.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="introduction-to-saas-performance-management-patterns"></a>Общие сведения о шаблонах управления производительностью SaaS

Управление производительностью базы данных состоит из следующих этапов: компиляция и анализ данных о производительности с последующей настройкой параметров для обеспечения допустимого времени отклика приложения на основе полученных данных. При размещении нескольких клиентов пулы эластичных баз данных позволяют предоставлять ресурсы группам баз данных с непредсказуемыми рабочими нагрузками, а также управления этими ресурсами без лишних затрат. Используя определенные шаблоны рабочей нагрузки, средства можно сэкономить при наличии всего лишь двух баз данных уровня S3. Пул позволяет не только сэкономить расходы на ресурсы, но также устраняет необходимость постоянно выполнять мониторинг отдельных баз данных.

![Схема](./media/sql-database-saas-tutorial-performance-monitoring/app-diagram.png)

Пулы и содержащиеся в них базы данных по прежнему необходимо отслеживать. Это позволит убедиться, что они имеют нужную производительность. Настройте конфигурацию пула в соответствии с потребностями к общей рабочей нагрузке и предоставьте необходимое число единиц eDTU. Укажите максимальное и минимальное значение единиц eDTU на каждую базу данных в соответствии с конкретными требованиями приложения.

### <a name="performance-management-strategies"></a>Стратегии управления производительностью

* Чтобы не было необходимости вручную выполнять мониторинг производительности, мы советуем **настроить создание оповещений при превышении базами данных или пулами указанных значений**.
* Чтобы управлять краткосрочными колебаниями уровня производительности пула, можно **масштабировать уровень единиц eDTU пула**. Если эти колебания происходят постоянно и их можно предугадывать, **масштабирование пула можно запланировать и этот процесс будет выполняться автоматически**. Например,если рабочая нагрузка незначительная (ночью или на выходных), масштаб можно уменьшить.
* Чтобы управлять долгосрочными колебаниями или изменениями числа баз данных, **отдельные базы данных можно переместить в другие пулы**.
* Чтобы управлять временным возрастанием нагрузки *отдельной* базы данных, **ее можно изъять из пула и на некоторое время назначить индивидуальный уровень производительности**. После снижения нагрузки эту базу данных можно вернуть в пул. Если это известно заранее, базу данных можно переместить заблаговременно. Это позволяет убедиться, что база данных всегда имеет необходимые ресурсы, а также избежать влияния на другие базы данных в пуле. Если эта необходимость предсказуемая, например из-за увеличения уровня продаж билетов на популярное мероприятие, это поведение управления можно интегрировать в приложение.

На [портале Azure](https://portal.azure.com) доступны встроенные возможности мониторинга большинства ресурсов и создания оповещений. Для базы данных SQL средства мониторинга и создания оповещений доступны в базах данных и пулах. Эти встроенные средства относятся к конкретному ресурсу. Их удобно использовать при работе с небольшим числом ресурсов, чего нельзя сказать про работу с большим их количеством.

В сценариях с большим объемом данных можно использовать Log Analytics (OMS). Это отдельная служба Azure, которая предоставляет аналитические сведения на основе журналов диагностики и данных телеметрии, собранных в рабочей области Log Analytics. Эта служба может собирать данные телеметрии из многих служб, а также позволяет выполнять запросы и настраивать оповещения.

## <a name="get-the-wingtip-application-scripts"></a>Получение скриптов приложения Wingtip

Скрипты Wingtip Tickets и исходный код приложения доступны в репозитории GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS). Файлы скриптов находятся в папке [Learning Modules](https://github.com/Microsoft/WingtipSaaS/tree/master/Learning%20Modules). Скачайте папку **Learning Modules** на локальный компьютер, сохраняя ее структуру.

## <a name="provision-additional-tenants"></a>Подготовка дополнительных клиентов

Хотя преимущество можно получить при наличии всего лишь двух баз данных уровня S3, но чем больше баз данных в пуле, тем больше средств можно сэкономить. Чтобы полностью продемонстрировать принципы работы мониторинга производительности и управления ею, для работы с этим руководством необходимо развернуть по крайней мере 20 баз данных.

Если вы подготовили пакет клиентов в предыдущем руководстве, раздел [Моделирование использования ресурсов во всех базах данных клиентов](#simulate-usage-on-all-tenant-databases) можно пропустить.

1. Откройте скрипт …\\Learning Modules\\Provision and Catalog\\*Demo-PerformanceMonitoringAndManagement.ps1* в **интегрированной среде сценариев PowerShell**. Не закрывайте этот скрипт, так как он еще понадобится в рамках этого руководства.
1. Чтобы выбрать скрипт **подготовки пакета клиентов**, задайте параметр **$DemoScenario** = **1**.
1. Нажмите клавишу **F5** для запуска скрипта.

Этот скрипт развернет 17 клиентов менее чем за 5 минут.

Скрипт *New-TenantBatch* использует вложенный или связанный набор шаблонов [Resource Manager](../azure-resource-manager/index.md) для создания пакета клиентов, который по умолчанию копирует базу данных **baseTenantDb** на сервер каталога, чтобы создать базы данных клиента, а затем регистрирует их в этом каталоге и, наконец, инициализирует их с именем клиента и типом объекта. Это согласуется с принципом подготовки приложением WTP нового клиента. Все изменения, внесенные в базу данных *baseTenantDB*, применяются к подготовленным после клиентам. Сведения о выполнении изменения схемы [имеющихся](sql-database-saas-tutorial-schema-management.md) баз данных клиентов, в том числе о *"золотой"* базе данных, см. в статье *Управление схемой для нескольких клиентов в приложении SaaS WTP*.

## <a name="simulate-different-usage-patterns-by-generating-different-load-types"></a>Моделирование шаблонов использования на основе различных типов нагрузки

Скрипт *Demo-PerformanceMonitoringAndManagement.ps1* запускает генератор нагрузки с одним из доступных *типов нагрузки*.

| Демонстрация | Сценарий |
|:--|:--|
| 2 | Создание нагрузки с обычной интенсивностью (около 40 DTU). |
| 3 | Создание нагрузки с более длительными и частыми пиками на базу данных.|
| 4. | Создание нагрузки с интенсивным использованием единиц DTU при пиках на базу данных (около 80 DTU).|
| 5 | Создание нормальной нагрузки с высокой нагрузкой на отдельный клиент (около 95 DTU).|
| 6 | Создание неравномерной нагрузки между несколькими пулами.|

## <a name="simulate-usage-on-all-tenant-databases"></a>Моделирование использования ресурсов во всех базах данных клиентов

Генератор нагрузки применяет *искусственную* нагрузку на ЦП каждой базы данных клиента. Он запускает задание в каждой базе данных клиента, которое периодически вызывает хранимую процедуру, за счет чего создается нагрузка. Уровень (в единицах eDTU), продолжительность и интервалы нагрузки во всех базах данных отличаются, что позволяет моделировать непредсказуемую активность клиента.

1. Чтобы выполнить скрипт *создания нагрузки с обычной интенсивностью*, задайте параметр **$DemoScenario** = **2**.
1. Нажмите клавишу **F5**, чтобы применить эту нагрузку ко всем базам данных клиента.

Так как нагрузка имеет случайный характер, генератор должен работать примерно 10–20 минут. Это позволит обеспечить устойчивую активность и получить хороший шаблон.

> [!IMPORTANT]
> Генератор нагрузки выполняется как ряд заданий в локальном сеансе PowerShell. Не закрывайте вкладку *Demo-PerformanceMonitoringAndManagement.ps1*. Если закрыть эту вкладку или приостановить работу компьютера, выполнение заданий в генераторе нагрузки прекратится.

## <a name="monitor-resource-usage-using-the-portal"></a>Мониторинг использования ресурсов на портале

Чтобы отследить использование ресурсов на основе примененной нагрузки, откройте портал и перейдите к пулу, в котором содержатся базы данных клиента.

1. Откройте [портал Azure](https://portal.azure.com) и перейдите к серверу tenants1-&lt;пользователь&gt;.
1. Вы должны увидеть список баз данных клиента, в том числе новый пакет баз данных.
1. Прокрутите вниз и найдите эластичные пулы. Затем щелкните **Pool1**. В этом пуле содержатся все созданные ранее базы данных клиента.
1. Разверните колонку пула с диаграммой использования ресурсов пула и баз данных.

Значения на диаграмме использования ресурсов пула основаны на совокупном использовании ресурсов всеми находящимися в нем базами данных. На этой диаграмме показаны 5 наиболее активных баз данных:

![](./media/sql-database-saas-tutorial-performance-monitoring/pool1.png)

Так как в пуле есть и другие базы данных, на этой диаграмме также показана активность без учета этих 5 баз данных. Чтобы просмотреть дополнительные сведения, щелкните **Использование ресурсов базы данных**:

![](./media/sql-database-saas-tutorial-performance-monitoring/database-utilization.png)


## <a name="set-performance-alerts-on-the-pool"></a>Настройка оповещений производительности в пуле

Чтобы настроить оповещение в пуле, которое активируется при более \>75 % использования в течение 5 мин, сделайте следующее:

1. На [портале Azure](https://portal.azure.com) щелкните сервер *tenants1-\<пользователь\>* и выберите *Pool1*.
1. Щелкните **Правила оповещения**, а затем выберите **+ Добавить оповещение**:

   ![Добавление оповещения](media/sql-database-saas-tutorial-performance-monitoring/add-alert.png)

1. Укажите имя, например **High DTU**. 
1. Задайте следующие значения:
   * **"Метрика": eDTU percentage** (Процент eDTU);
   * **"Условие": "Больше"**;
   * **"Пороговое значение": 75**;
   * **"Период": "За последние 30 минут"**.

   ![настройка оповещения](media/sql-database-saas-tutorial-performance-monitoring/alert-rule.png)

Уведомления могут отправляться на адрес электронной почты учетной записи Azure или на указанные дополнительные электронные адреса (мы не советуем указывать дополнительные адреса, если вы используете подписку другого пользователя).

> [!NOTE]
> Оповещение отправляется только в случае превышения порогового значения за последние 30 минут. Чтобы генератор нагрузки мог проверить отправку оповещений, он должен работать в течение этого времени.


## <a name="scale-up-a-busy-pool"></a>Увеличение масштаба загруженного пула

Если общий уровень нагрузки пула достиг предела и используется 100 % единиц eDTU, снижается производительность отдельных баз данных и возможно уменьшение времени отклика на запрос во всех базах данных в пуле.

При краткосрочных повышениях нагрузки мы советуем увеличить масштаб пула, чтобы предоставить дополнительные ресурсы, или удалить содержащиеся в нем базы данных (перенести в другие пулы или изъять из пула и назначить индивидуальный уровень служб).

При долгосрочных повышениях нагрузки мы советуем оптимизировать использование индексов и запросов, чтобы улучшить производительность базы данных. В зависимости от чувствительности приложения к проблемам с производительностью мы советуем увеличить масштаб пула до достижения 100 % использования единиц eDTU. А оповещения позволяют предупредить об этом событии заранее.

Вы можете смоделировать загруженный пул, увеличив созданную генератором нагрузку. При более частых и длительных пиковых нагрузках баз данных повышается общая нагрузка на пул. Требования отдельных баз данных не изменяются. Масштаб пула можно легко увеличить на портале или с помощью PowerShell. В рамках этого руководства используется портал.

1. Чтобы выполнить скрипт _создания нагрузки с более длительными и частыми пиками на базу данных_, задайте параметр *$DemoScenario* = **3**. Это позволит повысить интенсивность общей нагрузки пула, не изменяя необходимую пиковую нагрузку каждой базы данных.
1. Нажмите клавишу **F5**, чтобы применить эту нагрузку ко всем базам данных клиента.


1. **Откройте колонку пула** **tenants1 или Pool1**.


1. Просмотрите показатели использования DTU пула с более высокой нагрузкой на диаграмме выше. Нагрузка начинает повышаться через несколько минут. Но вы сразу увидите, что пул начал достигать порогового значения использования, и когда нагрузка перейдет в устойчивое состояние, в пуле возникнет перегрузка.


1. Чтобы увеличить масштаб пула, щелкните **Настроить пул**.
1. Передвиньте ползунок **eDTU пула** в положение 100 (не выбирайте большее значение, чтобы ограничить расходы). Объем памяти, доступный для всех баз данных в пуле (параметр **ГБ пула**), связан с параметром eDTU. При увеличении числа единиц eDTU также увеличивается и доступная память. При изменении числа единиц eDTU пула индивидуальные параметры баз данных не изменяются (максимально на каждую базу данных по прежнему выделяется 50 единиц eDTU). Параметры каждой базы данных можно просмотреть справа в колонке **Настроить пул**.
1. Щелкните **Сохранить**, чтобы отправить запрос. В пуле класса "Стандартный" изменения вступают в силу примерно через 3–5 минут.

Вернитесь к колонке **Pool1** > **Обзор**, чтобы просмотреть диаграммы мониторинга. Просмотрите показатели после предоставления пулу дополнительных ресурсов (с несколькими базами данных и случайной нагрузкой эти показатели не всегда достоверные). Посмотрев на диаграммы, примите во внимание следующее: предельное значение на верхней диаграмме теперь составляет 100 единиц eDTU, а на нижней — по прежнему 50, так как максимально на каждую базу данных выделяется 50 единиц eDTU.

На протяжении всего процесса работа баз данных не прекращается, и они полностью доступны. Перед добавлением в базу данных новых единиц eDTU пула все активные подключения разрываются. В коде приложения всегда нужно реализовывать возможность возобновления разорванных подключений. Это позволит приложению повторно подключиться к базе данных в пуле с большим масштабом.

## <a name="create-a-second-pool-and-load-balance-databases-to-handle-increased-aggregate-load"></a>Создание второго пула и балансировка нагрузки баз данных для обработки более высокой общей нагрузки

Вместо увеличения масштаба пула вы можете создать второй пул и переместить базы данных в него, чтобы распределить нагрузку между двумя пулами. Новый пул должен находиться на том же сервере, что и первый.

1. Откройте **колонку сервера customers1-&lt;пользователь&gt;**. Если вы находитесь в колонке пула или базы данных, разверните элемент управления "Основное" и выберите имя сервера (как ярлык).
1. Щелкните **+ Создать пул**, чтобы создать пул на текущем сервере.
1. В шаблоне создания пула эластичных баз данных, укажите следующие значения:

    1. В поле **"Имя" введите Pool2**.
    1. Укажите ту же ценовую категорию (**Пул "Стандартный"**).
    1. Щелкните **Настроить пул**.
    1. В открывшейся колонке "Настроить пул" для параметра **"eDTU пула" установите значение 50 DTU**.
    1. Щелкните команду **Добавить базы данных**, чтобы просмотреть список баз данных на этом сервере, которые не входят в текущий пул.
    1. В списке **установите флажки** возле половины баз данных (10 из 20), чтобы переместить их в новый пул, и щелкните **Выбрать**.
    1. Щелкните **Выбрать** еще раз, чтобы применить изменения. Обратите внимание на цену за использование ресурсов на основе выбранных параметров в течение одного месяца.
    1. Нажмите кнопку **ОК**, чтобы создать пул с новой конфигурацией и переместить базы данных.

Этот процесс займет несколько минут. При перемещении работа баз данных не прекращается и они полностью доступны до момента закрытия открытых подключений. При повторном подключении клиент подключается к базе данных в новом пуле.

После создания пула он появится в колонке сервера customers1. Щелкните имя пула, чтобы открыть его колонку пула и просмотреть показатели производительности.

Использование ресурсов в пуле Pool1 снизилось, а нагрузка равномерно распределена между ним и пулом Pool2.

## <a name="manage-an-increased-load-on-a-single-database"></a>Управление ростом нагрузки на отдельную базу данных

Если нагрузка отдельной базы данных в пуле постоянно высокая, в зависимости от конфигурации пула это может влиять на ресурсы в пуле и другие базы данных. Если эта активность не прекращается в течение некоторого времени, базу данных можно временно изъять из пула. Это позволит предоставить базе данных больше ресурсов, чем другим базам данных в пуле, и изолировать ее. Ниже приведены действия, которые моделируют высокую нагрузку на базу данных Contoso Concert Hall из-за увеличения уровня продаж билетов на популярный концерт.

1. Выберите скрипт …\\**Demo-PerformanceManagementAndMonitoring.ps1**.
1. Чтобы выполнить скрипт **создания нормальной нагрузки с высокой нагрузкой на отдельный клиент (около 95 DTU), задайте для параметра $DemoScenario значение 5**.
1. Задайте параметр **$SingleTenantDatabaseName = contosoconcerthall**.
1. Чтобы выполнить скрипт, нажмите клавишу **F5**.
1. **Откройте колонку пула** **Customers1 или Pool1**.
1. Посмотрите на экран **Наблюдение за пулами эластичных БД** в верхней части колонки и обратите внимание на рост использования DTU пула. Через минуту или две должна начать расти нагрузка, а вы должны увидеть, что пул достигает порогового значения использования.
1. Посмотрите также на экран **Наблюдение за эластичными базами данных**.Там показаны наиболее активные базы данных за последний час. База данных contosoconcerthall также должна появиться в этом списке.
1. Щелкните **диаграмму** **Наблюдение за эластичными базами данных**. После этого откроется колонка **Использование ресурсов базы данных**, где вы можете просмотреть сведения о любой базе данных. Так вы можете просмотреть сведения для базы данных contosoconcerthall.
1. В списке баз данных **щелкните contosoconcerthall**. После этого откроется колонка этой базы данных.
1. Щелкните **Ценовая категория (единицы DTU масштабирования)** в контекстном меню, чтобы открыть колонку **Настройка производительности**, где можно указать уровень производительности отдельной базы данных.
1. Перейдите на вкладку **Стандартный**, чтобы открыть параметры масштабирования на уровне "Стандартный".
1. Установите **ползунок DTU** в положение 100. Обратите внимание, что это соответствует цели обслуживания **S3**, приведенной в скобках между единицами измерения размера DTU и памяти.
1. Щелкните **Применить**, чтобы изъять базу данных из пула и назначить ей уровень "Стандартный S3".
1. После развертывания просмотрите показатели базы данных contosoconcerthall и эластичного пула, из которой она была изъята, в соответствующих колонках.

Если нагрузка на базу данных contosoconcerthall ниже обычной, эту базу данных нужно быстро вернуть в пул, чтобы уменьшить расходы. Если нагрузку спрогнозировать невозможно, вы можете настроить оповещение в базе данных, которое будет срабатывать, если использование DTU опустится ниже максимального значения на базу данных в пуле. Перемещение базы данных в пул описано в упражнении 5.

## <a name="other-performance-management-patterns"></a>Другие шаблоны управления производительностью

**Упреждающее масштабирование.** В упражнении 6 показано, как масштабировать изолированную базу данных. При увеличении объема продаж билетов в приложении WTP базу данных Contoso Concert Hall можно заранее изъять из пула. В противном случае можно реализовать отправку оповещений, чтобы определять активность в пуле или базе данных. Вряд ли вы хотите, чтобы рост нагрузки влиял на производительность других клиентов в пуле. Если клиент может предсказать, как долго ему потребуются дополнительные ресурсы, вы можете настроить модуль runbook службы автоматизации Azure, чтобы изъять базу данных из пула, а затем вернуть ее по заданному расписанию.

**Самостоятельное масштабирование клиента.** Масштабирование легко выполняется через API управления. Вы можете легко реализовать масштабирование баз данных клиента в приложении клиента и предоставить эту возможность как компонент службы SaaS. Например, позвольте клиентам самостоятельно выполнять масштабирование, что позволит напрямую снизить расходы.

### <a name="scaling-a-pool-up-and-down-on-a-schedule-to-match-usage-patterns"></a>Масштабирование пула по расписанию в соответствии с шаблонами использования

Если показатель общего использования клиента можно спрогнозировать, реализуйте масштабирование по расписанию с помощью службы автоматизации Azure. Например, после 18:00 масштаб пула можно уменьшить, а в рабочие дни в 06:00 обратно увеличить.



## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Моделирование использования ресурсов в базах данных клиентов с помощью предоставленного генератора нагрузки.
> * Наблюдение за реакцией баз данных клиентов при увеличении нагрузки.
> * Увеличение масштаба эластичного пула из-за роста нагрузки на базу данных.
> * Подготовка второго эластичного пула для балансировки нагрузки базы данных.

[Restore a single tenant database](sql-database-saas-tutorial-restore-single-tenant.md) (Восстановление базы данных отдельного клиента)


## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по работе с SaaS-приложением WTP, использующим базу данных SQL Azure](sql-database-wtp-overview.md#sql-database-wtp-saas-tutorials)
* [Когда следует использовать эластичный пул?](sql-database-elastic-pool.md)
* [Служба автоматизации Azure](../automation/automation-intro.md)
* [Настройка и использование Log Analytics (OMS) с примером приложения SaaS WTP](sql-database-saas-tutorial-log-analytics.md)
