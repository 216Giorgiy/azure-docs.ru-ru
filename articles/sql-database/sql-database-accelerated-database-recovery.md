---
title: Ускоренное аварийное восстановление в Базе данных SQL Azure | Документация Майкрософт
description: В Базе данных Azure SQL доступна новая функция, обеспечивающая быстрое и последовательное восстановление базы данных, мгновенный откат транзакций и интенсивное усечение журнала для отдельных баз данных и баз данных в составе пула в Базе данных SQL Azure и Хранилище данных SQL Azure.
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: mashamsft
ms.author: mathoma
ms.reviewer: carlrab
manager: craigg
ms.date: 01/25/2019
ms.openlocfilehash: 6d962a40fe0e1a7658c0d5ac30c7fd04bfb7fb0f
ms.sourcegitcommit: 698a3d3c7e0cc48f784a7e8f081928888712f34b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2019
ms.locfileid: "55475454"
---
# <a name="accelerated-database-recovery-preview"></a>Ускоренное восстановление базы данных (предварительная версия)

**Ускоренное восстановление базы данных (ADR)** — это новая функция ядра СУБД SQL, которая значительно повышает доступность базы данных, особенно при наличии длительных транзакций, путем изменения процесса восстановления ядра СУБД SQL. Сейчас ADR доступен для отдельных баз данных и баз данных в составе пула в Базе данных SQL Azure и Хранилище данных SQL Azure. Ниже приведены основные преимущества ADR:

- **Быстрое и последовательное восстановление базы данных**

  Благодаря ADR длительные транзакции не влияют на общее время восстановления, что позволяет быстро и последовательно восстанавливать базу данных, независимо от количества активных транзакций в системе или их размеров.

- **Мгновенный откат транзакций**

  Благодаря ADR откат транзакций выполняется мгновенно, независимо от времени активации транзакции или количества выполненных обновлений.

- **Интенсивное усечение журнала**

  Благодаря ADR журнал транзакций интенсивно усекается даже при наличии активных длительных транзакций, что не позволяет ему выйти из-под управления.

## <a name="the-current-database-recovery-process"></a>Текущий процесс восстановления базы данных

Восстановление базы данных в SQL Server соответствует модели восстановления [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) и состоит из трех этапов, которые проиллюстрированы на следующей схеме. Их подробное описание представлено ниже.

![текущий процесс восстановления](./media/sql-database-accelerated-database-recovery/current-recovery-process.png)

- **Этап анализа**

  Прямой просмотр журнала транзакций с начала последней успешной контрольной точки (или регистрационного номера транзакции в журнале самой старой страницы) до конца для определения состояния каждой транзакции в момент остановки работы SQL Server.

- **Стадия повтора**

  Прямой просмотр журнала транзакций, начиная с самой старой незафиксированной транзакции и до конца, необходимый, чтобы вернуть базу данных в состояние, в котором она пребывала в момент сбоя, путем повтора всех операций.

- **Стадия отката**

  В каждой транзакции, которая была активна на момент сбоя, происходит перемещение по журналу назад и отменяются операции, выполненные в ходе этой транзакции.

Исходя из этой схемы, время, необходимое ядру СУБД SQL для восстановления после неожиданного перезапуска, (примерно) пропорционально размеру самой продолжительной активной транзакции в системе во время сбоя. Для восстановления требуется откат всех незавершенных транзакций. Требуемый отрезок времени пропорционален работе, выполненной транзакцией, и времени, в течение которого она была активной. Таким образом, процесс восстановления SQL Server может занять много времени при наличии длительных транзакций (таких как операции массовой вставки или операции создания индексов в большой таблице).

Кроме того, отмена или откат большой транзакции по этой схеме также может занять много времени, так как используется та же самая стадия восстановления (стадия отката), как описано выше.

Кроме того, ядро СУБД SQL не может усечь журнал транзакций при длительных транзакциях, потому что соответствующие записи журнала необходимы для процессов восстановления и отката. В результате такой разработки ядра СУБД SQL некоторые клиенты сталкиваются со следующей проблемой: размер журнала транзакций становится очень большим и журнал занимает слишком много места.

## <a name="the-accelerated-database-recovery-process"></a>Процесс ускоренного восстановления базы данных

С помощью функции ADR можно решить вышеуказанные проблемы, полностью изменив процесс восстановления ядра СУБД SQL следующим образом:

- Сделайте восстановление непрерывным или мгновенным, устранив необходимость сканировать журнал с или до начала самой старой активной транзакции. Благодаря ADR журнал транзакций обрабатывается только с последней успешной контрольной точки (или регистрационного номера транзакции в журнале (LSN) самой старой "грязной" страницы). В результате на время восстановления не влияют длительные транзакции.
- Уменьшите требуемое пространство журнала транзакций, так как больше не нужно обрабатывать журнал для всей транзакции. В результате журнал транзакций можно значительно усечь, так как создаются контрольные точки и резервные копии.

На высоком уровне ADR обеспечивает быстрое восстановление базы данных путем управления версиями всех физических изменений базы данных и отмены ограниченных логических операций, которые можно отменить почти мгновенно. Любая транзакция, которая была активна на момент сбоя, помечается как прерванная, и поэтому любые версии, созданные такими транзакциями, могут быть проигнорированы в параллельных запросах пользователей.

Процесс восстановления ADR состоит из тех же трех этапов, что и текущий процесс восстановления. Этапы восстановления ADR проиллюстрированы на следующей схеме, а их подробное описание представлено ниже.

![процесс восстановления ADR](./media/sql-database-accelerated-database-recovery/adr-recovery-process.png)

- **Этап анализа**

  На сегодняшний день процесс остается таким же, лишь добавлено восстановление sLog и копирование записей журнала для неверсионных операций.
- **Стадия повтора**

  Эта стадия разделена на два этапа.
  - Этап 1

      Повтор в sLog (самая старая незафиксированная транзакция до последней контрольной точки). Повтор — это быстрая операция, так как необходимо обработать всего несколько записей из sLog.
  - Этап 2

     Повтор в журнале транзакций начинается с последней контрольной точки (вместо самой старой незафиксированной транзакции).
- **Стадия отката**

   Стадия отката, выполняемая с помощью ADR, завершается почти мгновенно с использованием sLog для отката неверсионных операций и постоянного хранилища версий (PVS) с логической отменой для выполнения отката версий на уровне строк.

## <a name="adr-recovery-components"></a>Компоненты восстановления ADR

Ниже приведены четыре основных компонента ADR:

- **Постоянное хранилище версий (PVS)**

  Постоянное хранилище версий — это новое ядро СУБД SQL, предназначенное для хранения версий строк, созданных в базе данных, вместо традиционного хранилища версий `tempdb`. PVS позволяет изолировать ресурсы, а также повышает доступность получателей, доступных для чтения.

- **Логическая отмена**

  Логическая отмена — это асинхронный процесс, отвечающий за выполнение отката версий на уровне строк, который обеспечивает мгновенный откат транзакций и отмену всех версионных операций.

  - Позволяет отслеживать все прерванные транзакции.
  - Выполняет откат всех пользовательских транзакций с помощью PVS.
  - Снимает все блокировки сразу после отмены транзакции.

- **sLog**

  sLog — это дополнительный поток журналов в памяти, в котором хранятся записи журналов для неверсионных операций (например, недействительность кэша метаданных, блокировка и т. д.). Характеристики sLog:

  - Имеет небольшой объем и выполняется в памяти.
  - Сохраняется на диске путем сериализации во время выполнения процесса контрольной точки.
  - Периодически усекается по мере фиксации транзакций.
  - Ускоряет повтор и отмену, обрабатывая только неверсионные операции.  
  - Включает интенсивное усечение журнала транзакций, сохраняя только необходимые записи журнала.

- **Очистка**

  Очистка — это асинхронный процесс, который периодически активируется и очищает ненужные версии страниц.

## <a name="who-should-consider-accelerated-database-recovery"></a>Кому рекомендуется использовать ускоренное восстановление базы данных

Рекомендуем рассмотреть возможность включения ADR следующим клиентам:

- Клиентам, имеющим рабочие нагрузки с длительными транзакциями.
- Клиентам, у которых возникают случаи, когда активные транзакции значительно увеличивают журнал транзакций.  
- Клиентам, у которых в течение продолжительного периода недоступна база данных из-за долгого восстановления SQL Server (например, неожиданный перезапуск SQL Server или ручной откат транзакций).

## <a name="to-enable-adr-during-this-preview-period"></a>Включение ADR в течение периода предварительной версии

В течение периода предварительной версии этой функции отправьте электронное письмо по адресу [adr@microsoft.com](mailto:adr@microsoft.com), чтобы получить дополнительные сведения и начать использовать ускоренное восстановление базы данных (ADR). В сообщении электронной почты укажите имя сервера Базы данных SQL (для отдельных баз данных и баз данных в составе пула в Базе данных SQL и в Хранилище данных Azure). Так как это предварительная версия функции, в качестве сервера проверки укажите непроизводственный сервер.
