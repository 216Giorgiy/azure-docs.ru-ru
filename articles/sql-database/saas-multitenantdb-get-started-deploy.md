---
title: "Развертывание SaaS-приложения с сегментированной мультитенантной БД, использующего базу данных SQL Azure | Документация Майкрософт"
description: "Разверните и изучите SaaS-приложение Wingtip Tickets с сегментированной мультитенантной БД, которое демонстрирует шаблоны SaaS с помощью базы данных SQL Azure."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: billgib;MightyPen
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/13/2017
ms.author: sstein
ms.openlocfilehash: bc96221abf62677b53df43daa44a925ac5792043
ms.sourcegitcommit: 9a61faf3463003375a53279e3adce241b5700879
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2017
---
# <a name="deploy-and-explore-a-sharded-multi-tenant-application-that-uses-azure-sql-database"></a>Развертывание и изучение сегментированного мультитенантного приложения, использующего базу данных SQL Azure

В этом руководстве вы развернете и проанализируете пример SaaS-приложения с мультитенантной БД, которое называется Wingtip Tickets. Приложение Wingtip Tickets предназначено для демонстрации возможностей базы данных SQL Azure, которые упрощают реализацию сценариев SaaS.

Эта реализация Wingtips использует шаблон сегментированной мультитенатной базы данных. Сегментирование выполняется по идентификатору клиента. Данные клиента распределяются в конкретную базу данных в соответствии со значениями идентификаторов клиентов. Независимо от того, сколько клиентов содержит какая-либо база данных, все базы данных являются мультитенатными в том смысле, что схемы таблиц включают идентификатор клиента. 

Этот шаблон базы данных позволяет хранить один или несколько клиентов в каждом сегменте или базе данных. Вы можете оптимизировать затраты за счет того, что каждая база данных сегментируется несколькими клиентами. Или можно выполнить оптимизацию для изоляции, задав для каждого хранилища базы данных только один клиент. Можно выбрать разные варианты оптимизации отдельно для каждого клиента. Можно сделать этот выбор при первом сохранении клиента или изменить его позже. Приложение поддерживает любой из этих вариантов.

#### <a name="app-deploys-quickly"></a>Быстрое развертывание приложения

В приведенном ниже разделе о развертывании предоставлена кнопка **Развертывание в Azure**. Если ее нажать, приложение Wingtip будет полностью развернуто через пять минут. Приложение Wingtip выполняется в облаке Azure и использует базу данных SQL Azure. Wingtip развертывается в подписку Azure. Вы получите полный доступ для работы с отдельными компонентами приложения.

Приложение развертывается с данными для трех примеров клиентов. Клиенты будут храниться вместе в одной мультитенантной базе данных.

Вы можете скачать исходный код C# и PowerShell для Wingtip Tickets из [нашего репозитория на GitHub][link-github-wingtip-multitenantdb-55g].

#### <a name="learn-in-this-tutorial"></a>В этом руководстве рассматривается:

> [!div class="checklist"]

> - как развернуть приложение SaaS Wingtip;
> - где можно получить исходный код приложения и скрипты управления;
> - сведения о серверах и базах данных, формирующих приложение;
> - как сопоставить клиентов с данными с помощью *каталога*;
> - как подготовить новый клиент;
> - как выполнить мониторинг активности клиента в приложении.

Доступна серия связанных руководств, в основе которых лежит это первоначальное развертывание. В них рассматривается ряд шаблонов проектирования и управления SaaS. При работе с руководствами рекомендуется пошагово выполнять указанные выше скрипты, чтобы увидеть, как реализованы различные шаблоны SaaS.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством выполните следующие предварительные требования:

- Установите последнюю версию Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell][link-azure-get-started-powershell-41q].

## <a name="deploy-the-wingtip-tickets-app"></a>Развертывание приложения Wingtip Tickets

1. Нажмите кнопку **Развертывание в Azure**.
    - Откроется портал Azure с шаблоном развертывания SaaS-приложения Wingtip Tickets. Для шаблона нужно предоставить значения двух параметров: имя новой группы ресурсов и значение "пользователь", которое позволяет отличить это развертывание от других развертываний того же приложения. На следующем шаге содержатся сведения о настройке этих значений параметров.
        - Обязательно запомните точные значения, которые вы используете, так как они потребуются позже для файла конфигурации.

    [![Кнопка для развертывания в Azure.][image-deploy-to-azure-blue-48d]][link-aka-ms-deploywtp-mtapp-52k]

2. Введите необходимые значения параметров для развертывания.

    > [!IMPORTANT]
    > Некоторые параметры проверки подлинности и брандмауэра сервера намеренно сделаны ненадежными для упрощения демонстрации. Выберите **Создать группу ресурсов** и не используйте имеющиеся группы ресурсов, серверы или пулы. Не используйте это приложение или ресурсы, которые оно создает, для рабочей среды. Поработав с приложением, удалите эту группу ресурсов, чтобы завершить связанное выставление счетов.

    Для имени ресурса желательно использовать только строчные буквы, цифры и дефисы.

    - Для параметра **Группа ресурсов** выберите действие **Создать** и предоставьте **имя** новой группы ресурсов (с учетом регистра).
        - Рекомендуем использовать в именах групп ресурсов только буквы нижнего регистра.
        - В конце имени желательно добавить дефис, ваши инициалы и любую цифру, например так: *wingtip-af1*.
        - **Расположение** — выберите расположение из раскрывающегося списка.
    - Для параметра **Пользователь** мы предлагаем выбрать короткое значение **Пользователь**, например инициалы с одной цифрой: *af1*.

3. **Разверните приложение.**

    - Установите флажок, чтобы принять условия.
    - Щелкните **Приобрести**.

4. Отслеживайте состояние развертывания. Для этого щелкните **Уведомления** (значок колокольчика справа от поля поиска). Развертывание приложения Wingtip занимает примерно пять минут.

   ![Развертывание выполнено](media/saas-multitenantdb-get-started-deploy/succeeded.png)

## <a name="download-and-unblock-the-management-scripts"></a>Скачивание и разблокирование скриптов управления

Пока выполняется развертывание приложения, скачайте исходный код приложения и скрипты управления.

> [!IMPORTANT]
> Исполняемое содержимое (скрипты, библиотеки DLL) может быть заблокировано Windows, в то время как ZIP-файлы можно загрузить с внешнего источника, а затем извлечь их содержимое. Перед извлечением скриптов из ZIP-файла выполните указанные ниже действия, чтобы разблокировать ZIP-файл. Разблокировав ZIP-файл, вы подтверждаете, что скрипты могут выполняться.

1. Перейдите к [репозиторию GitHub WingtipTicketsSaaS MultiTenantDb](https://github.com/Microsoft/WingtipTicketsSaaS-MultiTenantDb).
2. Выберите **Clone or download** (Клонировать или скачать).
3. Выберите **Download ZIP** (Загрузить ZIP) и сохраните файл.
4. Щелкните правой кнопкой мыши файл **WingtipTicketsSaaS-MultiTenantDb-master.zip** и выберите **Свойства**.
5. На вкладке **Общие** выберите **Разблокировать** и **Применить**.
6. Нажмите кнопку **ОК**.
7. Извлеките файлы.

Скрипты находятся в папке *..\\WingtipTicketsSaaS-MultiTenantDb-master\\Learning Modules\\*.

## <a name="update-the-configuration-file-for-this-deployment"></a>Обновление файла конфигурации для развертывания

Перед запуском каких-либо скриптов настройте значения *группы ресурсов* и *пользователя* в файле **UserConfig.psm1**. Задайте для этих переменных те же значения, которые были указаны во время развертывания.

1. В *интегрированной среде сценариев PowerShell* откройте файл \\Learning Modules\\*UserConfig.psm1*.
2. В полях *ResourceGroupName* и *Name* введите специфические для развертывания значения (только в строках 10 и 11).
3. Сохраните изменения.

Значения, заданные в этом файле, используются всеми скриптами, поэтому очень важно, чтобы они были точными. При повторном развертывании приложения убедитесь, что вы выбрали другие значения группы ресурсов и пользователя. Затем обновите UserConfig с новыми значениями.

## <a name="run-the-application"></a>Выполнение приложения

Приложение демонстрирует различные объекты, например концертные залы, джазовые и спортивные клубы, в которых проходят определенные события. Объекты регистрируются как клиенты платформы Wingtip — для удобного перечисления событий и продажи билетов. Каждому объекту присваивается персонализированное веб-приложение для управления событиями и их перечисления, а также для продажи билетов. Все это выполняется независимо от других клиентов. На самом деле, данные каждого клиента по умолчанию хранятся в сегментированной мультитенантной базе данных.

Центральный **концентратор событий** содержит список клиентов в конкретном развертывании со ссылками.

1. Откройте *концентратор событий* в браузере:
    - http://events.wingtip.&lt;ПОЛЬЗОВАТЕЛЬ&gt;.trafficmanager.net &nbsp; *(Замените значением пользователя для своего развертывания.)*

    ![Концентратор событий](media/saas-multitenantdb-get-started-deploy/events-hub.png)

2. Щелкните **Fabrikam Jazz Club** в *концентраторе событий*.

   ![События](./media/saas-multitenantdb-get-started-deploy/fabrikam.png)

Чтобы управлять распределением входящего трафика, приложение использует [диспетчер трафика Azure](../traffic-manager/traffic-manager-overview.md). Страницы мероприятий, которые зависят от конкретного клиента, содержат имя клиента в URL-адресе. URL-адрес также содержит значение конкретного пользователя и соответствует такому формату:

- http://events.wingtip.&lt;ПОЛЬЗОВАТЕЛЬ&gt;.trafficmanager.net/*fabrikamjazzclub*
 
Приложение мероприятий анализирует имя клиента из URL-адреса и кэширует его, чтобы создать ключ для доступа к каталогу при помощи [управления размещением сегментов](sql-database-elastic-scale-shard-map-management.md). Каталог сопоставляет ключ с расположением базы данных клиента. В **концентраторе событий** перечислены все клиенты, зарегистрированные в каталоге. **Концентратор событий** использует расширенные метаданные в каталоге, чтобы получить имя клиента, связанное с каждым сопоставлением, для создания URL-адресов.

В рабочей среде обычно создают запись CNAME DNS, чтобы [указать интернет-домен компании](../traffic-manager/traffic-manager-point-internet-domain.md) для профиля диспетчера трафика.

## <a name="start-generating-load-on-the-tenant-databases"></a>Запуск создания нагрузки в базах данных клиента

Теперь после развертывания приложение готово к работе. Скрипт *Demo-LoadGenerator* PowerShell запускает рабочую нагрузку, выполняющуюся во всех клиентах. Реальная нагрузка в приложении SaaS обычно случайна и непредсказуема. Для моделирования этого типа нагрузки генератор создает нагрузку, распределенную по всем клиентам. В нагрузку включены случайные пиковые нагрузки в каждом клиенте, происходящие со случайными интервалами. Шаблон нагрузки появляется в течение нескольких минут, поэтому перед мониторингом нагрузки генератор должен работать по крайней мере три или четыре минуты.

1. В *интегрированной среде сценариев PowerShell* откройте скрипт ...\\Learning Modules\\Utilities\\*Demo-LoadGenerator.ps1*.
2. Нажмите клавишу **F5**, чтобы запустить скрипт и генератор нагрузки (оставьте значения параметра по умолчанию).

> [!IMPORTANT]
> Скрипт *Demo-LoadGenerator.ps1* отрывает другой сеанс PowerShell, где выполняется генератор нагрузки. Он выполняется в сеансе в качестве задачи переднего плана, которая вызывает фоновые задания создания нагрузки для каждого клиента.

После запуска задачи переднего плана она остается в состоянии вызова задания. Задача запускает дополнительные фоновые задания для любых новых клиентов, которые затем подготавливаются.

Закрытие сеанса PowerShell останавливает все задания.

Может потребоваться перезапустить сеанс генератора нагрузки для использования других значений параметров. Если да, закройте сеанс PowerShell для создания нагрузки и повторно запустите *Demo-LoadGenerator.ps1*.

## <a name="provision-a-new-tenant-into-the-sharded-database"></a>Подготовка нового клиента в сегментированной базе данных

Первоначальное развертывание включает в себя три примера клиентов в базе данных *Tenants1*. Давайте создадим другой клиент, чтобы увидеть, как это влияет на развернутое приложение. На этом шаге вы сможете быстро создать клиент.

1. В *интегрированной среде сценариев PowerShell* откройте файл \\Learning Modules\Provision and Catalog\\*Demo-ProvisionTenants.ps1*.
2. Нажмите клавишу **F5** для запуска скрипта (оставьте значения по умолчанию).

   > [!NOTE]
   > Множество скриптов SaaS-приложения Wingtip Tickets используют *$PSScriptRoot* для навигации по папкам, вызова других скриптов или импорта модулей. Эта переменная вычисляется только при выполнении полного скрипта путем нажатия клавиши **F5**.  Если выделить несколько скриптов и запустить их (**F8**), может произойти ошибка, поэтому нажмите клавишу **F5** при выполнении скриптов.

Новый клиент Red Maple Racing добавлен в базу данных *Tenants1* и зарегистрирован в каталоге. В вашем браузере откроется новый сайт продажи билетов *Events* клиента:

![Новый клиент](./media/saas-multitenantdb-get-started-deploy/red-maple-racing.png)

Обновите *концентратор событий*, чтобы увидеть в списке новый клиент.

## <a name="provision-a-new-tenant-in-its-own-database"></a>Подготовка нового клиента в собственной базе данных

Сегментированная мультитенантная модель позволяет выбрать, где подготавливать новый клиент: в базе данных, содержащей другие клиенты, или в собственной базе данных. В последнем случае данные клиента изолированы от данных других клиентов. Это позволяет управлять производительностью этого клиента независимо от других клиентов. Кроме того, изолированному клиенту проще восстановить данные до более раннего момента времени. Вы можете поместить клиентов бесплатной пробной версии или постоянных клиентов в мультитенантной базе данных, а премиум-клиентов в отдельных базах данных. При создании большого количества баз данных, содержащих только один клиент, ими всеми можно управлять в эластичном пуле, чтобы оптимизировать затраты ресурсов.  

Теперь подготовим другой клиент, в этот раз — в собственной базе данных.

1. В файле \\Learning Modules\\Provision and Catalog\*Demo-ProvisionTenants.ps1* измените *$TenantName* на **Salix Salsa**, *$VenueType* на **dance**, а *$Scenario* на **2**.

2. Нажмите клавишу **F5** для повторного запуска скрипта.
    - Нажатие клавиши F5 подготавливает новый клиент в отдельной базе данных. Базы данных и клиент регистрируются в каталоге. Затем браузер открывает страницу мероприятий клиента.

   ![Страница мероприятий Salix Salsa](./media/saas-multitenantdb-get-started-deploy/salix-salsa.png)

   - Прокрутите до нижней части страницы. В баннере отображается имя базы данных, в которой хранятся данные клиента.

3. Обновите концентратор событий, чтобы увидеть в списке два новых клиента.



## <a name="explore-the-servers-and-tenant-databases"></a>Изучение серверов и клиентских баз данных

Теперь рассмотрим подробнее некоторые из развернутых ресурсов:

1. На [портале Azure](http://portal.azure.com) перейдите к списку групп ресурсов. Откройте группу ресурсов, которая была создана при развертывании приложения.

   ![resource group](./media/saas-multitenantdb-get-started-deploy/resource-group.png)

2. Щелкните сервер **catalog-mt&lt;ПОЛЬЗОВАТЕЛЬ&gt;**. На сервере каталога содержится две базы данных с именем *tenantcatalog* и *basetenantdb*. База данных *basetenantdb* — это пустой шаблон базы данных. Он копируется для создания клиентской базы данных, используемой для нескольких клиентов или только для одного.

   ![сервер каталога](./media/saas-multitenantdb-get-started-deploy/catalog-server.png)

3. Вернитесь в группу ресурсов и выберите сервер *tenants1-mt*, который содержит клиентские базы данных.
    - База данных tenants1 — это мультитенантная база данных, в которой хранятся три исходных клиента, а также первый добавленный вами клиент. Она настроена как стандартная база данных с 50 DTU.
    - База данных **salixsalsa** содержит место проведения Salix Salsa в качестве единственного клиента. Она настроена в качестве стандартной базы данных с 50 DTU по умолчанию.

   ![Сервер клиентов](./media/saas-multitenantdb-get-started-deploy/tenants-server.png)


## <a name="monitor-the-performance-of-the-database"></a>Мониторинг производительности базы данных

Если генератор нагрузки выполнялся несколько минут, будет доступно достаточно данных телеметрии, чтобы рассмотреть некоторые функции мониторинга базы данных, встроенные в портал.

1. Перейдите на сервер **tenants1-mt&lt;ПОЛЬЗОВАТЕЛЬ&gt;** и щелкните **tenants1**, чтобы просмотреть сведения об использовании ресурсов базы данных, в которой есть четыре клиента. Каждый арендатор подвергается случайной высокой нагрузке от генератора нагрузки:

   ![Мониторинг tenants1](./media/saas-multitenantdb-get-started-deploy/monitor-tenants1.png)

   Диаграмма использования DTU хорошо демонстрирует, как мультитенантная база данных может поддерживать непредсказуемую рабочую нагрузку во многих клиентах. В этом случае генератор нагрузки применяет случайные нагрузки примерно по 30 DTU для каждого клиента. Эта нагрузка равнозначна использованию базы данных с 50 DTU на 60 %. Пики, которые превышают 60 %, являются результатом нагрузки, применяемой к более чем одному клиенту одновременно.

2. Перейдите на сервер **tenants1-mt&lt;ПОЛЬЗОВАТЕЛЬ&gt;** и щелкните базу данных **salixsalsa**, чтобы просмотреть использование ресурсов базы данных, которая содержит только один клиент.

   ![База данных salixsalsa](./media/saas-multitenantdb-get-started-deploy/monitor-salix.png)

Генератор нагрузки применяет аналогичную нагрузку для всех клиентов, независимо от того, в какой базе данных находится каждый клиент. База данных **salixsalsa** с одним клиентом может выдержать гораздо большую нагрузку, чем база данных с несколькими клиентами. 

> [!NOTE]
> Нагрузки, создаваемые генератором нагрузки, приведены исключительно в демонстрационных целях.  Ресурсы, выделенные для мультитенатных и однотенантных баз данных, а также количество клиентов, которых можно разместить в мультитенантной базе данных, зависит от фактических шаблонов рабочей нагрузки в приложении.


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]

> - как развернуть SaaS-приложение Wingtip Tickets c мультитенантной БД;
> - сведения о серверах и базах данных, формирующих приложение;
> - О клиентах, сопоставленных с данными с помощью *каталога*.
> - как подготавливать новые клиенты в мультитенатной базе данных и базе данных с одним клиентом.
> - Как просмотреть историю использования пула для отслеживания работы клиента.
> - Как удалить примеры ресурсов, чтобы прекратить связанное выставление счетов.

А теперь рекомендуем ознакомиться со статьей [Provision new tenants and register them in the catalog](sql-database-saas-tutorial-provision-and-catalog.md) (Подготовка новых клиентов и их регистрация в каталоге).



## <a name="additional-resources"></a>Дополнительные ресурсы

- Дополнительные сведения о шаблонах разработки для мультитенантных приложений SaaS и базы данных SQL Azure см. в [*этой статье*](https://docs.microsoft.com/azure/sql-database/sql-database-design-patterns-multi-tenancy-saas-applications).








<!--  Link references.

A [series of related tutorials] is available that build upon this initial deployment.
[link-wtp-overivew-jumpto-saas-tutorials-97j]: saas-multitenantdb-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials

-->

[link-aka-ms-deploywtp-mtapp-52k]: http://aka.ms/deploywtp-mtapp


[link-azure-get-started-powershell-41q]: https://docs.microsoft.com/powershell/azure/get-started-azureps

[link-github-wingtip-multitenantdb-55g]: https://github.com/Microsoft/WingtipTicketsSaaS-MultiTenantDB/





<!--  Image references.

[image-deploy-to-azure-blue-48d]: http://aka.ms/deploywtp-mtapp "Button for Deploy to Azure."

-->

[image-deploy-to-azure-blue-48d]: media/saas-multitenantdb-get-started-deploy/deploy.png

