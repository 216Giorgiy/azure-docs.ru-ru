---
title: "Высокая доступность службы базы данных SQL Azure | Документация Майкрософт"
description: "Узнайте о возможностях и функциях высокой доступности службы базы данных SQL Azure"
keywords: 
services: sql-database
documentationcenter: 
author: anosov1960
manager: jhubbard
ms.assetid: 
ms.service: sql-database
ms.custom: 
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: Inactive
ms.date: 12/13/2017
ms.author: sashan
ms.reviewer: carlrab
ms.openlocfilehash: c0a140c959f14c2e8ceaddad5d323f0900be5d2f
ms.sourcegitcommit: fa28ca091317eba4e55cef17766e72475bdd4c96
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2017
---
# <a name="high-availability-and-azure-sql-database"></a>Высокая доступность и база данных SQL Azure
С момента появления предложения PaaS Базы данных SQL Azure корпорация Майкрософт пообещала клиентам, что обеспечит высокую доступность в рамках этой службы и клиентам не придется управлять высокой доступностью, добавлять специальную логику для ее обеспечения или же принимать связанные с ней решения. Корпорация Майкрософт предлагает клиентам Соглашения об уровне обслуживания и полностью управляет конфигурацией и работой системы обеспечения высокой доступности. Соглашение об уровне обслуживания, предусматривающее высокий уровень доступности, применяется к Базе данных SQL в регионе и не обеспечивает защиту в случае регионального сбоя, вызванного форс-мажорными обстоятельствами (например, стихийное бедствие, война, гражданские беспорядки, действия государственного органа, терроризм или сбои сети или устройств, внешних по отношению к нашим центрам обработки данных, в том числе со стороны клиента или между стороной клиента и нашим центром обработки данных).

Для упрощения понятия высокой доступности корпорация Майкрософт использует следующие предположения:
1.  Аппаратные и программные сбои неизбежны.
2.  Рабочий персонал допускает ошибки, приводящие к сбоям.
3.  Операции запланированного обслуживания вызывают простои. 

Отдельные события случаются не часто, но в масштабах облака они происходят еженедельно и даже ежедневно. 

## <a name="fault-tolerant-sql-databases"></a>Отказоустойчивые базы данных SQL
Клиентов больше всего интересует отказоустойчивость собственных баз данных и в меньшей степени отказоустойчивость службы "База данных SQL" в целом. Непрерывная работа службы в течение 99,99 % времени не имеет смысла, если собственная база данных попадает в эти 0,01 % недоступных баз данных. Каждая база данных должна быть отказоустойчивой, а устранение сбоев никогда не должно приводить к потере совершенной транзакции. 

Для хранения данных База данных SQL использует локальное хранилище на непосредственно подключенных дисках или и виртуальных дисках (VHD) и удаленное хранилище на основе страничных BLOB-объектов в хранилище Azure класса Premium. 
- Локальное хранилище используется в базах данных уровня "Премиум" и пулах, которые предназначены для приложений OLTP с высокими требованиями к операциям ввода-вывода в секунду. 
- Удаленное хранилище используется для уровней обслуживания "Базовый" и "Стандартный", предназначенных для небольших, "холодных" или больших баз данных, которым требуется независимое масштабирование хранилища и вычислительных ресурсов. Они используют одностраничные BLOB-объекты для файлов базы данных и журналов, а также встроенную репликацию хранилищ и механизмы отказоустойчивости.

В обоих случаях механизмы репликации, обнаружение сбоев и восстановление базы данных SQL после них полностью автоматизированы и работают без вмешательства человека. Эта архитектура предотвращает потерю зафиксированных данных и обеспечивает наивысший приоритет защиты данных.

Основные преимущества:
- Клиенты получают максимальную выгоду от реплицированных баз данных без необходимости настраивать или поддерживать сложные аппаратные средства, программное обеспечение, операционную систему или среду виртуализации.
- Все свойства ACID реляционных баз данных поддерживаются системой.
- Отработка отказа автоматизирована и исключает потерю каких-либо зафиксированных данных.
- Маршрутизация подключения к основной реплике динамически управляется службой без необходимости использования логики приложения.
- Высокий уровень автоматизированного обеспечения избыточности предоставляется без дополнительной оплаты.

> [!NOTE]
> Описанная архитектура высокой доступности может быть изменена без предварительного уведомления. 

## <a name="data-redundancy"></a>Избыточность данных

Решение с высоким уровнем доступности в Базе данных SQL основано на технологии [AlwaysON](/sql/database-engine/availability-groups/windows/always-on-availability-groups-sql-server) SQL Server и позволяет работать с локальными и удаленными базами данных с минимальными различиями. В локальной конфигурации AlwaysON используется для сохранения, а в удаленной — для обеспечения доступности (низкое целевое время восстановления (RTO)). 

## <a name="local-storage"></a>Локальное хранилище

В случае локального хранилища каждая база данных выводится в сеть службой управления внутри области управления. Одна первичная реплика и по меньшей мере две вторичные (набор кворума) расположены внутри области клиента, охватывающей три независимые физические подсистемы в одном и том же центре обработки данных. Шлюз отправляет все операции чтения и записи в основную реплику. Операции записи асинхронно реплицируются во вторичные реплики. База данных SQL использует схему фиксации на основе кворума, при которой данные записываются в первичную и одну вторичную реплику, прежде чем транзакция фиксируется.

Система отработки отказа [Service Fabric](/azure/service-fabric/service-fabric-overview.md) автоматически восстанавливает реплики по мере сбоя узлов и поддерживает членство в кворуме, когда узлы выбывают из системы и присоединяются к ней. Плановое обслуживание тщательно координируется, чтобы обеспечить сохранение минимального числа реплик в наборе кворума (обычно 2). Эта модель хорошо подходит для баз данных уровня "Премиум", но требует избыточности вычислительных ресурсов и ресурсов хранения и стоит дороже.

## <a name="remote-storage"></a>Удаленное хранилище

Для конфигураций удаленных хранилищ (уровни "Базовый" и "Стандартный") в удаленном хранилище BLOB-объектов хранится ровно одна копия базы данных, что позволяет использовать возможности систем хранения для обеспечения долговечности, избыточности и обнаружения повреждения данных. 

На следующей схеме показана архитектура с высоким уровнем доступности.
 
![Архитектура с высоким уровнем доступности](./media/sql-database-high-availability/high-availability-architecture.png)

## <a name="failure-detection--recovery"></a>Обнаружение сбоев и восстановление 
Крупномасштабная распределенная система нуждается в высоконадежной системе обнаружения отказов, которая может надежно, быстро и максимально точно обнаруживать сбои. Для Базы данных SQL это система на базе Azure Service Fabric. 

Очевидно, когда в первичной реплике происходит сбой, работа не сможет продолжаться, потому что сначала все операции записи и чтения выполняются на первичной реплике. Этот процесс повышения уровня вторичной реплики до статуса первичной имеет целевое время восстановления (RTO), которое равно 30 секундам, и целевую точку восстановления (RPO) равную 0. Чтобы уменьшить влияние 30-секундного RTO, лучше всего попытаться повторно подключиться несколько раз с меньшим временем ожидания попыток неудачного соединения.

В случае сбоя вторичной реплики база данных имеет минимальный набор кворума без резервов. Service Fabric инициирует процесс реконфигурации, аналогичный процессу, который следует за сбоем первичной реплики, поэтому после короткого периода, в течение которого определяется, является ли сбой постоянным, создается другая вторичная реплика. В случае временного сбоя, такого как сбой операционной системы или обновление, новая реплика не создается немедленно, а вместо этого перезапускается узел со сбоем. 

Для конфигураций удаленного хранилища База данных SQL использует функцию AlwaysON, чтобы выполнять отработку отказа баз данных во время обновлений. Для этого заранее создается экземпляр SQL в ходе запланированного обновления, в рамках которого подключается и восстанавливается файл базы данных из удаленного хранилища. В случае сбоев процесса или других незапланированных событий Windows Fabric управляет доступностью экземпляра и подключает удаленный файл базы данных (в качестве последнего этапа восстановления).

## <a name="conclusion"></a>Заключение
База данных SQL Azure тесно интегрирована с платформой Azure и в значительной мере зависит от Service Fabric для обнаружения сбоев и восстановления данных, а также от Azure Storage Blob для защиты данных. В то же время База данных Azure SQL использует технологию AlwaysOn из готового продукта SQL Server для репликации и восстановления после сбоя. Сочетание этих технологий позволяет приложениям полностью реализовать преимущества смешанной модели хранения и поддерживать самые требовательные Соглашения об уровне обслуживания. 

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о [Service Fabric](/azure/service-fabric/service-fabric-overview.md).
- Дополнительные сведения о [диспетчере трафика Azure](/traffic-manager/traffic-manager-overview.md). 
