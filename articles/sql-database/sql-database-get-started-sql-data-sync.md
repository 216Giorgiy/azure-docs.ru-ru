---
title: Настройка синхронизации данных SQL Azure | Документация Майкрософт
description: В этом руководстве показано, как настроить синхронизацию данных SQL Azure
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: allenwux
ms.author: xiwu
ms.reviewer: douglasl
manager: craigg
ms.date: 11/07/2018
ms.openlocfilehash: 9175ed0b4f362a40e1d29a20a8378854b5f4cc81
ms.sourcegitcommit: eb9dd01614b8e95ebc06139c72fa563b25dc6d13
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2018
ms.locfileid: "53310392"
---
# <a name="tutorial-set-up-sql-data-sync-to-sync-data-between-azure-sql-database-and-sql-server-on-premises"></a>Руководство. Настройка синхронизации данных SQL между Базой данных SQL Azure и локальным сервером SQL Server

В этом руководстве вы узнаете, как для настроить синхронизацию данных SQL Azure, создав гибридную группу синхронизации, содержащую экземпляры базы данных SQL Azure и SQL Server. Новая группа синхронизации полностью настраивается и синхронизируется по заданному расписанию.

В этом руководстве предполагается, что у вас имеется некоторый опыт работы с базой данных SQL и SQL Server.

Общие сведения о синхронизации данных SQL см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL Azure](sql-database-sync-data.md).

Полные примеры PowerShell, которые демонстрируют, как настроить синхронизацию данных SQL, приведены в следующих статьях:

- [Использование PowerShell для синхронизации данных между несколькими базами данных SQL Azure](scripts/sql-database-sync-data-between-sql-databases.md)
- [Использование PowerShell для синхронизации данных между базой данных SQL Azure и локальной базой данных SQL Server](scripts/sql-database-sync-data-between-azure-onprem.md)

## <a name="step-1---create-sync-group"></a>Шаг 1. Создание группы синхронизации

### <a name="locate-the-data-sync-settings"></a>Поиск параметров синхронизации данных

1. В браузере перейдите на портал Azure.

2. На портале найдите базы данных SQL, воспользовавшись панелью мониторинга или значком баз данных SQL на панели инструментов.

    ![Список баз данных SQL Azure](media/sql-database-get-started-sql-data-sync/datasync-preview-sqldbs.png)

3. На странице **Базы данных SQL** выберите базу данных SQL, которую требуется использовать в качестве центральной базы данных для синхронизации данных. Откроется страница базы данных SQL.

    Центральная база данных концентратора является центральной конечной точкой в топологии синхронизации, в которой группа синхронизации имеет доступ ко множеству конечных точек с соответствующими базами данных. Остальные базы данных конечных точек в той же группе синхронизации, то есть все рядовые базы данных, синхронизируются с центральной базой данных.

4. На странице выбранной базы данных SQL выберите **Синхронизировать с другими базами данных**. Откроется страница синхронизации данных.

    ![Параметр "Синхронизировать с другими базами данных"](media/sql-database-get-started-sql-data-sync/datasync-preview-newsyncgroup.png)

### <a name="create-a-new-sync-group"></a>Создание группы синхронизации

1. На странице синхронизации данных выберите **Новая группа синхронизации**. Откроется страница **Новая группа синхронизации**, в которой будет выделен шаг 1, **Создание группы синхронизации**. Кроме того, откроется страница **Создание группы синхронизации данных**.

2. На странице **Создание группы синхронизации данных** выполните следующие действия.

   1. В поле **Имя группы синхронизации** введите имя новой группы синхронизации.

   2. В разделе **База данных для метаданных синхронизации** выберите, следует ли создать новую базу данных (рекомендуется) или использовать существующую.

        > [!NOTE]
        > Корпорация Майкрософт рекомендует создать пустую базу данных для метаданных синхронизации. Служба синхронизации данных создает таблицы в этой базе данных и часто выполняет рабочую нагрузку. Эта база данных автоматически совместно используется как база данных для метаданных синхронизации всеми группами синхронизации в выбранном регионе. Базу данных для метаданных синхронизации или ее имя нельзя изменить без удаления всех групп и агентов синхронизации в регионе.

        Если вы выбрали параметр **Новая база данных**, щелкните **Создать новую базу данных**. Откроется страница **База данных SQL**. На странице **База данных SQL** задайте имя и параметры новой базы данных. Нажмите кнопку **ОК**.

        Если вы выбрали параметр **Использовать существующую базу данных**, выберите базу данных из списка.

   3. В разделе **Автоматическая синхронизация** сначала выберите **Вкл.** или **Выкл.**

        Если вы выбрали **Вкл.**, в разделе **Частота синхронизации** введите число и выберите единицы измерения: секунды, минуты, часы или дни.

        ![Указание частоты синхронизации](media/sql-database-get-started-sql-data-sync/datasync-preview-syncfreq.png)

   4. В разделе **Устранение конфликтов** выберите "Выигрывает концентратор" или "Member wins" (Выигрывает член).

        Приоритет центра означает, что при возникновении конфликта данные из центральной базы данных перезаписывают конфликтующие данные в рядовой базе данных. Приоритет рядовой БД означает, что при возникновении конфликта данные из рядовой базы данных перезаписывают конфликтующие данные в центральной базе данных.

       ![Настройка устранения конфликтов](media/sql-database-get-started-sql-data-sync/datasync-preview-conflictres.png)

   5. Нажмите кнопку **ОК** и подождите, пока будет создана и развернута новая группа синхронизации.

## <a name="step-2---add-sync-members"></a>Шаг 2. Добавление членов синхронизации

После создания и развертывания группы синхронизации на странице **Новая группа синхронизации** выделяется шаг 2, **Добавление членов синхронизации**.

В разделе **Центральная база данных** введите существующие учетные данные для сервера Базы данных SQL, на котором расположена центральная база данных. Не вводите *новые* учетные данные в этом разделе.

![Центральная база данных добавлена в группу синхронизации](media/sql-database-get-started-sql-data-sync/datasync-preview-hubadded.png)

### <a name="add-an-azure-sql-database"></a>Добавление базы данных SQL Azure

В разделе **Рядовая база данных** можно дополнительно добавить в группу синхронизации базу данных SQL Azure, щелкнув **Добавление базы данных Azure**. Откроется страница **Настройка базы данных Azure**.

На странице **Настройка базы данных Azure** выполните следующие действия.

1. В поле **Имя участника синхронизации** укажите имя нового члена синхронизации. Это имя должно отличаться от имени самой базы данных.

2. В поле **Подписка** выберите связанную подписку Azure для выставления счетов.

3. В поле **Azure SQL Server** выберите существующий сервер базы данных SQL.

4. В поле **База данных SQL Azure** выберите существующую базу данных SQL.

5. В поле **Направления синхронизации** выберите параметр "Двунаправленная синхронизация", "К концентратору" или "Из концентратора".

    ![Добавление нового члена синхронизации для базы данных SQL](media/sql-database-get-started-sql-data-sync/datasync-preview-memberadding.png)

6. В полях **Имя пользователя** и **Пароль** введите существующие учетные данные для сервера Базы данных SQL, на котором расположена рядовая база данных. Не вводите *новые* учетные данные в этом разделе.

7. Нажмите кнопку **ОК** и подождите, пока будет создан и развернут новый член синхронизации.

    ![Добавлен новый член синхронизации для базы данных SQL](media/sql-database-get-started-sql-data-sync/datasync-preview-memberadded.png)

### <a name="add-on-prem"></a> Добавление локальной базы данных SQL Server

В разделе **Рядовая база данных** можно дополнительно добавить в группу синхронизации локальную базу данных SQL Server, щелкнув **Добавление локальной базы данных**. Откроется страница **Настройка локальной среды**.

На странице **Настройка локальной среды** выполните следующие действия.

1. Щелкните **Выбор шлюза агента синхронизации**. Откроется страница **Выбор агента синхронизации**.

    ![Выбор шлюза агента синхронизации](media/sql-database-get-started-sql-data-sync/datasync-preview-choosegateway.png)

2. На странице **Выбор шлюза агента синхронизации** укажите, следует ли использовать существующий агент или создать новый.

    Если вы выбрали параметр **Существующие агенты**, то выберите из списка имеющийся агент.

    Если вы выбрали параметр **Создание агента**, то выполните следующее.

   1. Скачайте программное обеспечение агента клиента синхронизации, воспользовавшись приведенной ссылкой, и установите его на компьютере, на котором размещен сервер SQL Server. Вы также можете скачать агент синхронизации данных SQL Azure непосредственно [на странице этого агента](https://www.microsoft.com/download/details.aspx?id=27693).

        > [!IMPORTANT]
        > Необходимо открыть исходящий TCP-порт 1433 в брандмауэре, чтобы позволить агенту клиента обмениваться данными с сервером.

   2. Введите имя агента.

   3. Выберите **Создание и генерация ключа**.

   4. Скопируйте ключ агента в буфер обмена.

        ![Создание агента синхронизации](media/sql-database-get-started-sql-data-sync/datasync-preview-selectsyncagent.png)

   5. Нажмите кнопку **ОК**, чтобы закрыть страницу **Выбор агента синхронизации**.

   6. На компьютере SQL Server найдите и запустите приложение агента клиента синхронизации.

        ![Приложение агента клиента синхронизации данных](media/sql-database-get-started-sql-data-sync/datasync-preview-clientagent.png)

   7. В приложении агента синхронизации выберите **Submit Agent Key** (Отправить ключ агента). Откроется диалоговое окно **Sync Metadata Database Configuration** (Конфигурация базы данных для метаданных синхронизации).

   8. В диалоговом окне **Sync Metadata Database Configuration** (Конфигурация базы данных для метаданных синхронизации) вставьте ключ агента, скопированный на портале Azure. Укажите также существующие учетные данные для сервера Базы данных SQL, на котором расположена база данных для метаданных. (Если вы создали новую базу данных для метаданных, то она находится на том же сервере, что и центральная база данных.) Нажмите кнопку **ОК** и дождитесь завершения настройки.

        ![Ввод ключа агента и учетных данных сервера](media/sql-database-get-started-sql-data-sync/datasync-preview-agent-enterkey.png)

        > [!NOTE]
        > Если на этом этапе произошла ошибка брандмауэра, необходимо создать правило брандмауэра в Azure, чтобы разрешить входящий трафик от компьютера SQL Server. Правило можно создать вручную на портале, но может оказаться проще создать его в SQL Server Management Studio (SSMS). В SSMS попытайтесь подключиться к центральной базе данных в Azure. Введите ее имя как <имя_центральной_базы_данных>.database.windows.net. Следуйте указаниям в диалоговом окне, чтобы настроить правило брандмауэра Azure. Затем вернитесь в приложение агента клиента синхронизации.

   9. В приложении агента клиента синхронизации щелкните **Register** (Зарегистрировать), чтобы зарегистрировать базу данных SQL Server в агенте. Откроется диалоговое окно **SQL Server Configuration** (Конфигурация SQL Server).

        ![Добавление и настройка базы данных SQL Server](media/sql-database-get-started-sql-data-sync/datasync-preview-agent-adddb.png)

   10. В диалоговом окне **SQL Server Configuration** (Конфигурация SQL Server) выберите, следует ли устанавливать подключение с использованием аутентификации SQL Server или аутентификации Windows. Если выбрана аутентификация SQL Server, то следует ввести существующие учетные данные. Укажите имя SQL Server и имя базы данных, которую требуется синхронизировать. Нажмите кнопку **Test connection** (Проверить подключение), чтобы проверить параметры. Затем нажмите кнопку **Save** (Сохранить). Зарегистрированная база данных появится в списке.

        ![База данных SQL Server зарегистрирована](media/sql-database-get-started-sql-data-sync/datasync-preview-agent-dbadded.png)

   11. Теперь можно закрыть приложение агента клиента синхронизации.

   12. На странице портала **Настройка локальной среды** щелкните **Выберите базу данных**. Откроется страница **Выбор базы данных**.

   13. На странице **Выбор базы данных** в поле **Имя участника синхронизации** укажите имя нового члена синхронизации. Это имя должно отличаться от имени самой базы данных. Выберите базу данных из списка. В поле **Направления синхронизации** выберите параметр "Двунаправленная синхронизация", "К концентратору" или "Из концентратора".

        ![Выбор локальной базы данных](media/sql-database-get-started-sql-data-sync/datasync-preview-selectdb.png)

   14. Нажмите кнопку **ОК**, чтобы закрыть страницу **Выбор базы данных**. Затем нажмите кнопку **ОК**, чтобы закрыть страницу **Настройка локальной среды**, и подождите, пока новый член синхронизации не будет создан и развернут. Наконец, нажмите кнопку **ОК**, чтобы закрыть страницу **Выбор членов синхронизации**.

        ![Локальная база данных добавлена в группу синхронизации](media/sql-database-get-started-sql-data-sync/datasync-preview-onpremadded.png)

3. Чтобы подключиться к службе синхронизации данных SQL и локальному агенту, добавьте имя пользователя в роль `DataSync_Executor`. Служба синхронизации данных создает эту роль в экземпляре SQL Server.

## <a name="step-3---configure-sync-group"></a>Шаг 3. Настройка группы синхронизации

После создания и развертывания группы синхронизации на странице **Новая группа синхронизации** выделяется шаг 3, **Настройка группы синхронизации**.

1. На странице **Таблицы** выберите базу данных из списка членов группы синхронизации, а затем щелкните **Обновить схему**.

2. Из списка доступных таблиц выберите таблицы, которые необходимо синхронизировать.

    ![Выбор таблиц для синхронизации](media/sql-database-get-started-sql-data-sync/datasync-preview-tables.png)

3. По умолчанию выбраны все столбцы в таблице. Если вы не хотите синхронизировать все столбцы, снимите флажки для столбцов, которые не нужно синхронизировать. Обязательно оставьте выбранным столбец первичного ключа.

    ![Выбор полей для синхронизации](media/sql-database-get-started-sql-data-sync/datasync-preview-tables2.png)

4. Наконец, щелкните **Сохранить**.

## <a name="faq-about-setup-and-configuration"></a>Вопросы и ответы по установке и настройке

### <a name="how-frequently-can-data-sync-synchronize-my-data"></a>Как часто функция синхронизации данных может синхронизировать мои данные?

Минимальный интервал времени между запусками синхронизации составляет пять минут.

### <a name="does-sql-data-sync-fully-create-and-provision-tables"></a>Используется ли функция "Синхронизация данных SQL" для полного создания и предоставления таблиц?

Если в целевой базе данных еще не созданы таблицы схемы синхронизации, то они будут созданы при помощи синхронизации данных SQL с указанным набором столбцов. Но такое поведение не подходит для создания полноценной схемы соответствия по следующим причинам:

- В таблице назначения создаются только выбранные вами столбцы. Если некоторые столбцы исходных таблиц не входят в группу синхронизации, они не подготавливаются в таблицах назначения.
- Индексы создаются только для выбранных столбцов. Если индекс исходной таблицы содержит столбцы, которые не входят в группу синхронизации, такой индекс не подготавливается в таблицах назначения.
- Индексы столбцов типа XML не подготавливаются.
- Проверочные ограничения не подготавливаются.
- Существующие триггеры в исходных таблицах не подготавливаются.
- Представления и хранимые процедуры не создаются в базе данных назначения.

Из-за этих ограничений мы рекомендуем применять следующий подход:

- В рабочей среде самостоятельно подготовьте полную схему соответствия.
- Для тестирования служб можно обойтись функцией автоматической подготовки в синхронизации данных SQL.

### <a name="why-do-i-see-tables-that-i-did-not-create"></a>Почему я вижу таблицы, созданные не мной?

Синхронизация данных создает вспомогательные таблицы в вашей базе данных для отслеживания изменений. Не удаляйте их, иначе функция синхронизации данных перестанет работать.

### <a name="is-my-data-convergent-after-a-sync"></a>Гарантируется ли согласованность данных после синхронизации?

Не обязательно. Если группа синхронизации включает концентратор и три оконечности (A, B и C), то синхронизация выполняется между концентратором и A, между концентратором и B, между концентратором и C. Если в базу данных A внесены изменения *после* синхронизации концентратора и A, то такие изменения не сохраняются в базах данных B и C вплоть до выполнения следующей задачи синхронизации.

### <a name="how-do-i-get-schema-changes-into-a-sync-group"></a>Как применить изменения схемы в группе синхронизации?

Все изменения схемы нужно вносить и распространять вручную.

1. Реплицируйте изменения схемы вручную в центр и все остальные члены синхронизации.
2. Обновление схемы синхронизации.

**Добавление новых таблиц и столбцов**.

Новые таблицы и столбцы не влияют на текущую синхронизацию. Они не учитываются при синхронизации данных, пока не будут добавлены в схему синхронизации. При добавлении новых объектов базы данных оптимальной будет следующая последовательность действий:

1. Добавьте новые таблицы или столбцы в центр и во все члены синхронизации.
2. Добавьте новые таблицы или столбцы в схему синхронизации.
3. Начните вставлять значения в новые таблицы и столбцы.

**Изменение типа данных столбца**.

Если изменить тип данных существующего столбца, синхронизация данных продолжает выполняться до тех пор, пока новые значения соответствуют исходному типу данных, определенному в схеме синхронизации. Например, если вы измените тип в базе данных-источнике с **int** на **bigint**, синхронизация данных будет продолжаться, пока вы не вставите слишком большое значение для типа **int**. Для завершения изменений реплицируйте вручную изменения схемы в центр и все члены синхронизации, а затем обновите саму схему синхронизации.

### <a name="how-can-i-export-and-import-a-database-with-data-sync"></a>Как экспортировать и импортировать базу данных с синхронизацией данных?

После того как вы экспортировали базу данных в виде файла с расширением `.bacpac` и импортировали его для создания новой базы данных, нужно выполнить два действия, чтобы использовать синхронизацию данных в новой базе данных.

1. Очистите объекты синхронизации данных и вспомогательные таблицы в **новой базе данных** с помощью [этого скрипта](https://github.com/vitomaz-msft/DataSyncMetadataCleanup/blob/master/Data%20Sync%20complete%20cleanup.sql). Этот скрип удаляет все необходимые объекты синхронизации данных из базы данных.
2. Повторно создайте группу синхронизации с новой базой данных. Если старая группа синхронизации больше не нужна, удалите ее.

## <a name="faq-about-the-client-agent"></a>Вопросы и ответы об агенте клиента

Часто задаваемые вопросы об агенте клиента см. в [этом разделе](sql-database-data-sync-agent.md#agent-faq).

## <a name="next-steps"></a>Дополнительная информация

Поздравляем! Вы создали группу синхронизации, которая включает и экземпляр базы данных SQL, и базу данных SQL Server.

Дополнительные сведения о синхронизации данных SQL:

-   Обзор: [Синхронизация данных в нескольких облачных и локальных базах данных с помощью функции синхронизации данных SQL Azure](sql-database-sync-data.md).
-   Настройка синхронизации данных
    - С помощью PowerShell
        -  [Использование PowerShell для синхронизации данных между несколькими базами данных SQL Azure](scripts/sql-database-sync-data-between-sql-databases.md)
        -  [Использование PowerShell для синхронизации данных между базой данных SQL Azure и локальной базой данных SQL Server](scripts/sql-database-sync-data-between-azure-onprem.md)
-   Агент синхронизации данных: [Агент синхронизации данных для синхронизации данных SQL Azure](sql-database-data-sync-agent.md).
-   Рекомендации: [Рекомендации по синхронизации данных SQL](sql-database-best-practices-data-sync.md).
-   Мониторинг: [Мониторинг синхронизации данных SQL с помощью Log Analytics](sql-database-sync-monitor-oms.md).
-   Устранение неполадок: [Устранение неполадок с синхронизацией данных SQL](sql-database-troubleshoot-data-sync.md).
-   Обновление схемы синхронизации
    -   С помощью Transact-SQL: [Автоматическая репликация изменений схемы при синхронизации данных SQL Azure](sql-database-update-sync-schema.md).
    -   С помощью PowerShell: [Использование PowerShell для обновления схемы синхронизации в существующей группе синхронизации](scripts/sql-database-sync-update-schema.md).

Дополнительные сведения о Базе данных SQL:

- [Обзор Базы данных SQL](sql-database-technical-overview.md)
- [Управление жизненным циклом базы данных](https://msdn.microsoft.com/library/jj907294.aspx)
