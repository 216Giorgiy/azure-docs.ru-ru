<properties
	pageTitle="Исправление временной потери подключения | Microsoft Azure"
	description="Меры по устранению, диагностике и предотвращению ошибок подключения и других временных сбоев при взаимодействии с базой данных SQL Azure."
	services="sql-database"
	documentationCenter=""
	authors="MightyPen"
	manager="jeffreyg"
	editor=""/>

<tags
	ms.service="sql-database"
	ms.workload="sql-database"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="11/17/2015"
	ms.author="genemi"/>


# Устранение временных сбоев и ошибок подключения к базе данных SQL


Эта статья содержит информацию о предотвращении, диагностике и устранении ошибок подключения и временных ошибок, которые происходят в клиентском приложении во время взаимодействия с базой данных SQL Azure.


<a id="i-transient-faults" name="i-transient-faults"></a>

## Временные сбои


Временный сбой — это ошибка, причина которой скоро устранится автоматически. Иногда временный сбой возникает потому, что система Azure быстро сменяет аппаратные ресурсы, чтобы лучше распределить нагрузку, связанную с разными рабочими нагрузками. Когда выполняется эта перенастройка, подключения к базе данных SQL Azure могут быть потеряны.


Если клиентская программа использует пакет ADO.NET, ваша программа получает исключение **SqlException** и таким образом узнает о временном сбое. Значение свойства **Number** можно сравнить со списком временных сбоев в верхней части раздела [Сообщения об ошибках для клиентских программ базы данных SQL](sql-database-develop-error-messages).


### Подключения и команды


Если временная ошибка возникает при попытке подключения, эту попытку нужно повторить через несколько секунд.


Если временная ошибка возникает, когда выполняется команда SQL-запроса, выполнение команды не нужно повторять сразу. Лучше заново установить подключение после некоторой задержки. Затем выполнение команды можно повторить.


<a id="j-retry-logic-transient-faults" name="j-retry-logic-transient-faults"></a>

## Логика повторных попыток при временных сбоях


Клиентские программы, в которых иногда происходит временный сбой, являются более надежными, если используют логику повторных попыток.


Если программа взаимодействует с базой данных SQL Azure через стороннее ПО промежуточного слоя, спросите поставщика, содержит ли это стороннее ПО логику повторных попыток на случай временных сбоев.


### Принципы повторных попыток


- Повторите попытку открыть подключение, если ошибка является временным сбоем.


- Выполнение SQL-инструкции SELECT, которая закончилась временным сбоем, не нужно повторять напрямую.
 - Лучше установите новое подключение, а затем повторно выполните инструкцию SELECT.


- Когда выполнение SQL-инструкции UPDATE заканчивается временным сбоем, то, прежде чем выполнять инструкцию UPDATE еще раз, нужно установить новое подключение.
 - Логика повторных попыток обеспечивает полноценное выполнение транзакции базы данных или откат всей транзакции.


#### Другие соображения по поводу повторных попыток


- Пакетная программа, которая автоматически запускается после окончания рабочего дня и завершает свою работу до наступления утра, может выполнять повторные попытки с продолжительными интервалами.


- Программа, использующая пользовательский интерфейс, должна учитывать, что человек не любит ждать очень долго.
 - Это не значит, что нужно повторять попытку каждые несколько секунд, так как подобная политика может затопить систему запросами.


### Увеличение интервала между повторными попытками



Рекомендуется подождать 5 секунд, прежде чем выполнять первую повторную попытку. Повторная попытка после ожидания менее 5 секунд может привести к перегрузке облачной службы. Для каждой последующей повторной попытки ожидание должно увеличиваться экспоненциально, но не более чем до 60 секунд.

Обсуждение *периода блокировки* для клиентов, которые используют ADO.NET, см. в статье [Пул подключений SQL Server (ADO.NET)](http://msdn.microsoft.com/library/8xx3tyca.aspx).

Кроме того, вы можете задать максимальное количество повторных попыток, которые программа должна выполнить перед автоматическим завершением работы.


### Образцы кода с логикой повторных попыток


В этой статье доступны образцы кода с логикой повторных попыток на разных языках программирования:

- [Простые примеры кода](sql-database-develop-quick-start-client-code-samples.md) 


<a id="k-test-retry-logic" name="k-test-retry-logic"></a>

## Тестирование логики повторных попыток


Чтобы протестировать логику повторных попыток, нужно имитировать или вызвать ошибку, которую можно исправить во время работы программы.


### Тестирование с отключением от сети


Один из способов протестировать логику повторных попыток — это отключить клиентский компьютер от сети во время работы программы. Произойдет ошибка: - **SqlException.Number** = 11001 - Сообщение: «Такой узел неизвестен».


В рамках первой повторной попытки программа может исправить опечатку, а затем попытаться подключиться.


Чтобы применить это поведение программы, следует отключить компьютер от сети, прежде чем запускать программу. Это позволит программе распознать параметр времени выполнения, который приводит к возникновению в программе ошибки 1. Временно добавьте 11001 в свой список ошибок, чтобы эта ошибка считалась временной. 2. Первое подключение выполните как обычно. 3. После выявления ошибки удалите 11001 из списка. 4. Отобразите сообщение о том, что пользователю следует подключить компьютер к сети. Приостановите дальнейшее выполнение с помощью метода **Console.ReadLine** или нажмите кнопку «ОК» в диалоговом окне. Клавишу ВВОД пользователю нужно нажимать после подключения компьютера к сети. 5. Попытайтесь подключиться еще раз. В этот раз попытка должна завершиться успехом


### Выполните проверку, сделав опечатку в имени базы данных при подключении.


Программа может намеренно сделать опечатку в имени пользователя перед первой попыткой подключения. Произойдет ошибка: - **SqlException.Number** = 18456 - Сообщение: «Пользователю WRONG\_MyUserName не удалось войти».


В рамках первой повторной попытки программа может исправить опечатку, а затем попытаться подключиться.


Чтобы это имело смысл, программа могла бы распознать параметр времени выполнения, который приводит к возникновению в программе ошибки 1. Временно добавьте 18456 в свой список ошибок, чтобы эта ошибка считалась временной. 2. Добавьте элемент «WRONG\_» к имени пользователя. 3. После выявления ошибки удалите 18456 из списка. 4. Удалите «WRONG\_» из имени пользователя. 5. Попытайтесь подключиться еще раз. В этот раз попытка должна завершиться успехом


<a id="a-connection-connection-string" name="a-connection-connection-string"></a>

## Подключение: строка подключения


Для подключения к базе данных SQL Azure используется строка подключения, несколько отличная от той, что используется для подключения к решению Microsoft SQL Server. С помощью [портала предварительной версии Azure](http://portal.azure.com/) скопируйте строку подключения для своей базы данных.


[AZURE.INCLUDE [sql-database-include-connection-string-20-portalshots](../../includes/sql-database-include-connection-string-20-portalshots.md)]



#### Время ожидания подключения — 30 секунд.


Подключение через Интернет не так надежно, как через частную сеть. Поэтому мы рекомендуем в строке подключения задать для параметра **Время ожидания подключения** значение **30** секунд (вместо 15 секунд).


<a id="b-connection-ip-address" name="b-connection-ip-address"></a>

## Подключение: IP-адрес


Чтобы принимать подключение от IP-адреса компьютера, на котором установлено клиентское приложение, нужно настроить сервер базы данных SQL. Для этого измените параметры брандмауэра с помощью [портала предварительной версии Azure](http://portal.azure.com/).


Если не задать IP-адрес, произойдет сбой программы и отобразится сообщение об ошибке, содержащее необходимый IP-адрес.


[AZURE.INCLUDE [sql-database-include-ip-address-22-v12portal](../../includes/sql-database-include-ip-address-22-v12portal.md)]


Дополнительные сведения см. в статье [Практическое руководство. Настройка параметров брандмауэра для базы данных SQL](sql-database-configure-firewall-settings.md).


<a id="c-connection-ports" name="c-connection-ports"></a>

## Подключение: порты


Обычно нужно убедиться лишь в том, что на компьютере, на котором установлено клиентское приложение, для исходящей связи открыт порт 1433.


Например, если ваша клиентская программа размещена на компьютере Windows, брандмауэр Windows на этом узле позволяет открыть порт 1433:


1. Откройте панель управления
2. & gt; Все элементы панели управления
3. &gt; Брандмауэр Windows
4. &gt; Дополнительные параметры
5. & gt; Правила для исходящих подключений
6. &gt; Действия
7. &gt; Создать правило


Если клиентская программа установлена на виртуальной машине Azure, см. статью <br/>[Порты, кроме 1433, для ADO.NET 4.5 и базы данных SQL версии 12](sql-database-develop-direct-route-ports-adonet-v12.md).


Основные сведения о конфигурации портов и IP-адресов см. в статье [Брандмауэр базы данных SQL Azure](sql-database-firewall-configure.md).


<a id="d-connection-ado-net-4-5" name="d-connection-ado-net-4-5"></a>

## Подключение: ADO.NET 4.5


Если для подключения к базе данных SQL Azure программа использует классы ADO.NET, например **System.Data.SqlClient.SqlConnection**, мы рекомендуем использовать компонент .NET Framework 4.5 или более поздней версии.


ADO.NET 4.5. Дополнительная поддержка протокола TDS 7.4. В эту поддержку входит улучшенное по сравнению с версией 4.0 подключение. 2. Поддержка пула подключений. В нее входит также эффективная проверка функционирования объекта соединения, который видит ваша программа.


Когда вы используете объект соединения, входящий в пул подключений, программе следует временно закрывать подключение, если она его сейчас не использует. Повторное открытие подключения обойдется вам дешевле, чем создание нового.


Если вы используете пакет ADO.NET 4.0 или более ранней версии, рекомендуем обновить его до последней версии. С июля 2015 года вы можете [загрузить пакет ADO.NET 4.6](http://blogs.msdn.com/b/dotnet/archive/2015/07/20/announcing-net-framework-4-6.aspx).


<a id="e-diagnostics-test-utilities-connect" name="e-diagnostics-test-utilities-connect"></a>

## Диагностика: проверяет, могут ли служебные программы подключаться


Если программе не удается подключиться к базе данных SQL Azure, в качестве диагностики можно попытаться подключиться с помощью служебной программы. В идеале служебная программа будет подключаться с помощью библиотеки, которую использует ваша программа.


На любом компьютере под управлением Windows вы можете воспользоваться такими служебными программами: - решение SQL Server Management Studio (ssms.exe), которое подключается с помощью пакета ADO.NET; - файл sqlcmd.exe, который подключается с помощью [ODBC](http://msdn.microsoft.com/library/jj730308.aspx).


После подключения проверьте, работает ли короткий SQL-запрос SELECT.


<a id="f-diagnostics-check-open-ports" name="f-diagnostics-check-open-ports"></a>

## Диагностика: проверка открытых портов


Предположим, вы подозреваете, что попытки подключения завершаются неудачей из-за проблем с портом. Вы можете запустить на компьютере служебную программу, которая отображает данные о конфигурациях порта.


В Linux могут быть полезны следующие служебные программы: `netstat -nap` и `nmap -sS -O 127.0.0.1` (вместо значения, приведенного в примере, укажите ваш IP-адрес).


В Windows можно использовать служебную программу [PortQry.exe](http://www.microsoft.com/download/details.aspx?id=17148). Ниже приведен пример выполнения, в рамках которого запрошены сведения о ситуации с портами на сервере базы данных SQL Azure и который запущен на ноутбуке.


```
[C:\Users\johndoe]
>> portqry.exe -n johndoesvr9.database.windows.net -p tcp -e 1433

Querying target system called:
 johndoesvr9.database.windows.net

Attempting to resolve name to IP address...
Name resolved to 23.100.117.95

querying...
TCP port 1433 (ms-sql-s service): LISTENING

[C:\Users\johndoe]
>>
```


<a id="g-diagnostics-log-your-errors" name="g-diagnostics-log-your-errors"></a>

## Диагностика: внесение ошибок в журнал


Эпизодические неисправности иногда лучше всего диагностировать, выявляя общий шаблон за несколько дней или недель подряд.


Клиент может помочь в диагностике. Для этого ему следует вносить в журнал все ошибки, с которыми он сталкивается. У вас может получиться коррелировать записи журнала со сведениями об ошибках, которые база данных SQL Azure вносит в журнал для внутренних целей.


Библиотека Enterprise Library 6 (EntLib60) использует классы, управляемые компонентом .NET. Это помогает вести журнал. Информацию об этом см. в статье [5 — Простое использование журнала: использование блока приложения ведения журнала](http://msdn.microsoft.com/library/dn440731.aspx).


<a id="h-diagnostics-examine-logs-errors" name="h-diagnostics-examine-logs-errors"></a>

## Диагностика: проверка системных журналов на наличие ошибок


Ниже приведены некоторые Transact-SQL-инструкции SELECT, которые запрашивают в журналах сведения об ошибках и прочую информацию.


| Запрос у журнала | Описание |
| :-- | :-- |
| `SELECT e.*`<br/>`FROM sys.event_log AS e`<br/>`WHERE e.database_name = 'myDbName'`<br/>`AND e.event_category = 'connectivity'`<br/>`AND 2 >= DateDiff`<br/>&nbsp;&nbsp;`(hour, e.end_time, GetUtcDate())`<br/>`ORDER BY e.event_category,`<br/>&nbsp;&nbsp;`e.event_type, e.end_time;` | В представлении [sys.event\_log](http://msdn.microsoft.com/library/dn270018.aspx) отображается информация об отдельных событиях, в том числе о тех, которые приводят к промежуточным сбоям.<br/><br/>В идеале вы можете коррелировать значения **start\_time** или **end\_time** с информацией о времени, когда ваша клиентская программа сталкивалась с ошибками.<br/><br/>**Совет.** Для запуска нужно подключиться к базе данных **master**. |
| `SELECT c.*`<br/>`FROM sys.database_connection_stats AS c`<br/>`WHERE c.database_name = 'myDbName'`<br/>`AND 24 >= DateDiff`<br/>&nbsp;&nbsp;`(hour, c.end_time, GetUtcDate())`<br/>`ORDER BY c.end_time;` | В представлении [sys.database\_connection\_stats](http://msdn.microsoft.com/library/dn269986.aspx) отображается агрегированное количество типов событий (для дополнительной диагностики).<br/><br/>**Совет.** Для запуска нужно подключиться к базе данных **master**. |


### Диагностика: поиск событий проблемы в журнале базы данных SQL


Искать записи о событиях проблемы можно в журнале базы данных SQL Azure. Попытайтесь использовать в базе данных **master** такую Transact-SQL-инструкцию SELECT:


```
SELECT
   object_name
  ,CAST(f.event_data as XML).value
      ('(/event/@timestamp)[1]', 'datetime2')                      AS [timestamp]
  ,CAST(f.event_data as XML).value
      ('(/event/data[@name="error"]/value)[1]', 'int')             AS [error]
  ,CAST(f.event_data as XML).value
      ('(/event/data[@name="state"]/value)[1]', 'int')             AS [state]
  ,CAST(f.event_data as XML).value
      ('(/event/data[@name="is_success"]/value)[1]', 'bit')        AS [is_success]
  ,CAST(f.event_data as XML).value
      ('(/event/data[@name="database_name"]/value)[1]', 'sysname') AS [database_name]
FROM
  sys.fn_xe_telemetry_blob_target_read_file('el', null, null, null) AS f
WHERE
  object_name != 'login_event'  -- Login events are numerous.
  and
  '2015-06-21' < CAST(f.event_data as XML).value
        ('(/event/@timestamp)[1]', 'datetime2')
ORDER BY
  [timestamp] DESC
;
```


#### Несколько возвращенных строк из sys.fn\_xe\_telemetry\_blob\_target\_read\_file


Ниже показано, как может выглядеть возвращенная строка. Отображаемые пустые значения могут не быть пустыми в других строках.


```
object_name                   timestamp                    error  state  is_success  database_name

database_xml_deadlock_report  2015-10-16 20:28:01.0090000  NULL   NULL   NULL        AdventureWorks
```


<a id="l-enterprise-library-6" name="l-enterprise-library-6"></a>

## Enterprise Library 6


Enterprise Library 6 (EntLib60) — это платформа классов .NET, которая помогает реализовывать надежные клиенты облачных служб, одной из которых является служба базы данных SQL Azure. Темы, посвященные каждой области, в которой библиотека EntLib60 может оказаться полезной, вы найдете в статье [Enterprise Library 6 — апрель 2013 года](http://msdn.microsoft.com/library/dn169621%28v=pandp.60%29.aspx).


Алгоритм повтора при временных сбоях — это пример области, в которой библиотека EntLib60 может быть полезной (см. статью [4 — Настойчивость, секрет всех побед: использование блока приложений для обработки временных ошибок](http://msdn.microsoft.com/library/dn440719%28v=pandp.60%29.aspx)).


Небольшой образец кода на языке C#, использующий библиотеку EntLib60 в своей логике повторных попыток, доступен в статье [Образец кода: логика повторных попыток из библиотеки Enterprise Library 6 в C# для подключения к базе данных SQL](sql-database-develop-entlib-csharp-retry-windows.md).


> [AZURE.NOTE]Исходный код для EntLib60 доступен для открытого [скачивания](http://go.microsoft.com/fwlink/p/?LinkID=290898). Корпорация Майкрософт не планирует обновлять функции и менять характер обслуживания библиотеки EntLib.


### Классы EntLib60 для временных сбоев и повторов


Следующие классы EntLib60 особенно полезны для логики повторных ошибок. Все они входят в пространство имен **Microsoft.Practices.EnterpriseLibrary.TransientFaultHandling** или в элементы, дочерние по отношению к этому пространству.

*В пространстве имен **Microsoft.Practices.EnterpriseLibrary.TransientFaultHandling**:*

- класс **RetryPolicy**;
 - метод **ExecuteAction**;


- класс **ExponentialBackoff**;


- класс **SqlDatabaseTransientErrorDetectionStrategy**;


- класс **ReliableSqlConnection**;
 - класс **ExecuteCommand**.


В пространстве имен **Microsoft.Practices.EnterpriseLibrary.TransientFaultHandling.TestSupport**:

- класс **AlwaysTransientErrorDetectionStrategy**;

- класс **NeverTransientErrorDetectionStrategy**.


Ниже приведены ссылки на сведения о библиотеке EntLib60.

- Бесплатная [загрузка книги «Руководство разработчика по Microsoft Enterprise Library», 2-е издание](http://www.microsoft.com/download/details.aspx?id=41145).

- Рекомендации: статья [Общие рекомендации по повторным попыткам](best-practices-retry-general.md) содержит отличное подробное изложение информации о логике повторных попыток.

- Загрузка на сайте NuGet компонента [Enterprise Library — Transient Fault Handling Application Block 6.0](http://www.nuget.org/packages/EnterpriseLibrary.TransientFaultHandling/).


### EntLib60: блок ведения журнала


- Блок ведения журнала — это очень гибкое и настраиваемое решение, которое позволяет выполнять такие действия:
 - создавать и хранить сообщения журнала в разных расположениях;
 - классифицировать и фильтровать сообщения;
 - собирать контекстную информацию, полезную для отладки, трассировки, аудита и выполнения общих требований к ведению журнала.


- Это решение извлекает функции ведения журнала из расположения журнала, что обеспечивает согласованность кода приложения независимо от расположения и типа хранилища журнала.


Дополнительные сведения см. в статье [5 — Простое использование журнала: использование блока приложения ведения журнала](https://msdn.microsoft.com/library/dn440731%28v=pandp.60%29.aspx).


### Исходный код метода EntLib60 IsTransient


Далее, после класса **SqlDatabaseTransientErrorDetectionStrategy**, идет исходный код на языке C# для метода **IsTransient**. Исходный код поясняет, какие ошибки считаются временными и приемлемыми для повторной попытки (версия за апрель 2013 г.).

Для удобочитаемости из этой копии удалены многочисленные строки **//comment**.


```
public bool IsTransient(Exception ex)
{
  if (ex != null)
  {
    SqlException sqlException;
    if ((sqlException = ex as SqlException) != null)
    {
      // Enumerate through all errors found in the exception.
      foreach (SqlError err in sqlException.Errors)
      {
        switch (err.Number)
        {
            // SQL Error Code: 40501
            // The service is currently busy. Retry the request after 10 seconds.
            // Code: (reason code to be decoded).
          case ThrottlingCondition.ThrottlingErrorNumber:
            // Decode the reason code from the error message to
            // determine the grounds for throttling.
            var condition = ThrottlingCondition.FromError(err);

            // Attach the decoded values as additional attributes to
            // the original SQL exception.
            sqlException.Data[condition.ThrottlingMode.GetType().Name] =
              condition.ThrottlingMode.ToString();
            sqlException.Data[condition.GetType().Name] = condition;

            return true;

          case 10928:
          case 10929:
          case 10053:
          case 10054:
          case 10060:
          case 40197:
          case 40540:
          case 40613:
          case 40143:
          case 233:
          case 64:
            // DBNETLIB Error Code: 20
            // The instance of SQL Server you attempted to connect to
            // does not support encryption.
          case (int)ProcessNetLibErrorCode.EncryptionNotSupported:
            return true;
        }
      }
    }
    else if (ex is TimeoutException)
    {
      return true;
    }
    else
    {
      EntityException entityException;
      if ((entityException = ex as EntityException) != null)
      {
        return this.IsTransient(entityException.InnerException);
      }
    }
  }

  return false;
}
```


## Дополнительные сведения


- [Пул подключений SQL Server (ADO.NET)](http://msdn.microsoft.com/library/8xx3tyca.aspx)


- [*Retrying* — это лицензированная общая библиотека Apache 2.0 для повторных попыток, написанная на языке **Python**, которая позволяет легко добавить режим повтора куда угодно.](https://pypi.python.org/pypi/retrying)

<!---HONumber=Nov15_HO4-->