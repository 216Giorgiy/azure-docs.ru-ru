<properties
   pageTitle="Общие сведения о транзакциях эластичной базы данных в базе данных SQL Azure (предварительная версия)"
   description="Общие сведения о транзакциях эластичной базы данных в базе данных SQL Azure (предварительная версия)"
   services="sql-database"
   documentationCenter=""
   authors="torsteng"
   manager="jeffreyg"
   editor="sidneyh"/>

<tags
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="sql-database"
   ms.date="11/02/2015"
   ms.author="torsteng"/>

# Общие сведения о транзакциях эластичной базы данных в базе данных SQL Azure (предварительная версия)

Возможности эластичной базы данных позволяют выполнять транзакции, охватывающие несколько баз данных в базе данных SQL Azure. Транзакции эластичной базы данных в базе данных SQL можно выполнять с помощью ADO.NET и приложений .NET. Кроме того, транзакции можно объединить с уже знакомыми приемами программирования, используя классы [System.Transaction](https://msdn.microsoft.com/library/system.transactions.aspx).

При локальном выполнении такого сценария, как правило, требуется использовать координатор распределенных транзакций Майкрософт (MSDTC). Так как MSDTC нельзя использовать с приложениями платформы как услуги в Azure, возможность координировать распределенные транзакции теперь интегрирована в саму базу данных SQL. Чтобы запустить распределенные транзакции, приложения можно подключить к любой базе данных SQL. При этом одна из баз данных будет отвечать за прозрачную координацию распределенных транзакций, как показано на следующем рисунке.

  ![Осуществление распределенных транзакций в базе данных SQL Azure с использованием транзакций эластичной базы данных][1]

## Распространенные сценарии

Транзакции эластичной базы данных в базе данных SQL позволяют вносить атомарные изменения в данные, хранящиеся в нескольких базах данных SQL, с помощью приложений. Эта предварительная версия ориентирована на клиентскую разработку на языке C# с использованием платформы .NET. В будущем планируется предоставить возможность такой работы на сервере с использованием T-SQL. Транзакции эластичной базы данных применяются в следующих сценариях.

* Приложения в Azure, использующие несколько баз данных. Этот сценарий предусматривает вертикальное секционирование данных между несколькими базами данных в базе данных SQL. В результате разные виды данных находятся в разных базах данных. При выполнении некоторых операций необходимо вносить изменения в данные, которые хранятся в нескольких базах данных. Приложение использует транзакции эластичной базы данных для скоординированного внесения изменений в базах данных и обеспечения атомарности.

* Приложения, использующие сегментированные базы данных. Этот сценарий предусматривает использование клиентской библиотеки эластичной базы данных или выполнения [самостоятельного сегментирования](http://social.technet.microsoft.com/wiki/contents/articles/17987.cloud-service-fundamentals.aspx) для горизонтального разделения данных между несколькими базами данных в базе данных SQL. Первый пример использования заключается в необходимости внести атомарные изменения в сегментированное мультитенантное приложение, если изменения распространяются на клиенты. Например, рассмотрим передачу данных из одного клиента в другой, при этом оба клиента находятся в разных базах данных. Второй пример предполагает точное сегментирование в целях соблюдения требований к емкости для клиентов большого размера. В свою очередь, это обычно означает, что некоторые атомарные операции необходимо выполнять в нескольких базах данных, которые использует один клиент. Третий пример предусматривает атомарное обновление, обеспечивающее возможность ссылаться на данные, реплицируемые в базах данных. Теперь благодаря предварительной версии стала возможна координация атомарных транзакционных операций со всеми этими строками в нескольких базах данных. Транзакции эластичной базы данных используют двухфазную фиксацию для обеспечения атомарности транзакций в базах данных. Этот вариант прекрасно подходит для тех случаев, когда в одной транзакции одновременно участвует менее 100 баз данных. Эти ограничения не применяются принудительно, но следует учитывать, что их превышение отрицательно влияет на производительность и успешность выполнения транзакций эластичной базы данных.


## Установка и миграция

Возможности для транзакций эластичной базы данных в базе данных SQL предоставляются с обновлениями библиотек .NET — System.Data.dll и System.Transactions.dll. Библиотеки DLL обеспечивают использование двухфазной фиксации для соблюдения атомарности. Чтобы начать разработку приложений, использующих транзакции эластичной базы данных, установите платформу [.NET 4.6.1 (версию-кандидат)](http://blogs.msdn.com/b/dotnet/archive/2015/10/29/announcing-net-framework-4-6-1-rc.aspx) или более поздней версии. При использовании платформы .NET предыдущей версии происходит ошибка повышения уровня транзакций до распределенных, после чего возникает исключение.

После установки можно использовать API распределенных транзакций в классах System.Transactions с подключением к базе данных SQL. При наличии приложений MSDTC, использующих эти API, просто повторно создайте существующие приложения .NET 4.6 после установки версии-кандидата. Если ваши проекты предназначены для использования на платформе .NET 4.6, обновленные библиотеки DLL версии-кандидата будут использоваться автоматически, а вызовы API распределенных транзакций и подключения к базе данных SQL будут успешными.

Учтите, что для выполнения транзакций эластичной базы данных не требуется установка MSDTC. Вместо этого управление такими транзакциями осуществляется непосредственно в базе данных SQL. Это значительно упрощает сценарии, в которых используется облако, так как для использования распределенных транзакций в базе данных SQL не нужно развертывать MSDTC. В разделе 4 более подробно описано развертывание транзакций эластичной базы данных и требуемой платформы .NET вместе с облачными приложениями в Azure.

## Разработка

###	Приложения, использующие несколько баз данных

В следующем примере кода знакомые приемы программирования используются в сочетании с System.Transactions .NET. Класс TransactionScope позволяет выполнить внешнюю транзакцию в .NET. («Внешняя транзакция» — это транзакция, которая происходит в текущем потоке.) В транзакции участвуют все подключения, установленные в TransactionScope. Если в транзакции задействовано несколько разных баз данных, ее уровень автоматически повышается и она стает распределенной. Результат транзакции можно изменить. Для этого необходимо задать в настройках области ее завершение, что позволяет обозначить выполнение фиксации.

	using (var scope = new TransactionScope())
	{
		using (var conn1 = new SqlConnection(connStrDb1))
		{
			conn1.Open();
			SqlCommand cmd1 = conn1.CreateCommand();
			cmd1.CommandText = string.Format("insert into T1 values(1)");
			cmd1.ExecuteNonQuery();
		}

		using (var conn2 = new SqlConnection(connStrDb2))
		{
			conn2.Open();
			var cmd2 = conn2.CreateCommand();
			cmd2.CommandText = string.Format("insert into T2 values(2)");
			cmd2.ExecuteNonQuery();
		}

		scope.Complete();
	}

### Приложения, использующие сегментированные базы данных
 
Транзакции эластичной базы данных в базе данных SQL также поддерживают координацию распределенных транзакций. При этом для установки подключений к развернутому уровню данных используется метод OpenConnectionForKey клиентской библиотеки эластичной базы данных. Рассмотрим случаи, когда необходимо обеспечить согласованность изменений транзакций для нескольких разных значений ключей сегментирования. Подключения к сегментам с разными значениями ключей сегментирования устанавливаются через посредника с использованием OpenConnectionForKey. В большинстве случаев устанавливаются подключения к разным сегментам. Поэтому для осуществления транзакций требуется выполнение распределенной транзакции. Этот подход показан в следующем примере кода. В нем предполагается использование переменной shardmap для представления карты сегментов в клиентской библиотеке эластичной базы данных:

	using (var scope = new TransactionScope())
	{
		using (var conn1 = shardmap.OpenConnectionForKey(tenantId1, credentialsStr))
		{
			conn1.Open();
			SqlCommand cmd1 = conn1.CreateCommand();
			cmd1.CommandText = string.Format("insert into T1 values(1)");
			cmd1.ExecuteNonQuery();
		}
		
		using (var conn2 = shardmap.OpenConnectionForKey(tenantId2, credentialsStr))
		{
			conn2.Open();
			var cmd2 = conn2.CreateCommand();
			cmd2.CommandText = string.Format("insert into T1 values(2)");
			cmd2.ExecuteNonQuery();
		}

		scope.Complete();
	}


## Настройка рабочих ролей Azure

Установку и развертывание версии .NET и библиотек, необходимых для осуществления транзакций эластичной базы данных в Azure (в гостевой ОС облачной службы), можно автоматизировать. Используйте задачи запуска, чтобы настроить рабочие роли Azure. Основные понятия и рекомендованные шаги см. в статье [Установка .NET для роли облачной службы](https://azure.microsoft.com/documentation/articles/cloud-services-dotnet-install-dotnet/).

## Мониторинг состояния транзакций

Используйте динамические административные представления для мониторинга состояния и хода выполнения текущих транзакций эластичной базы данных в базе данных SQL. Все представления, связанные с транзакциями, соответствуют распределенным транзакциям в базе данных SQL. Соответствующий список динамических административных представлений можно найти здесь: [Динамические административные представления и функции, связанные с транзакциями (Transact-SQL)](https://msdn.microsoft.com/library/ms178621.aspx).
 
Особенно полезны следующие динамические административные представления.

* **sys.dm\_tran\_active\_transactions** — позволяет просматривать список активных транзакций и их состояние. В столбце UOW (единица работы) можно просмотреть различные дочерние транзакции, которые относятся к одной распределенной транзакции. У всех транзакций в рамках одной распределенной транзакции одинаковое значение UOW. Дополнительную информацию см. в [документации по динамическому административному представлению](https://msdn.microsoft.com/library/ms174302.aspx).
* **sys.dm\_tran\_database\_transactions** — здесь можно просматривать дополнительную информацию о транзакциях, включая расположение транзакции в журнале. Дополнительную информацию см. в [документации по динамическому административному представлению](https://msdn.microsoft.com/library/ms186957.aspx).
* **sys.dm\_tran\_locks** — в этом представлении указывается информация о текущих блокировках транзакций. Дополнительную информацию см. в [документации по динамическому административному представлению](https://msdn.microsoft.com/library/ms190345.aspx).

## Ограничения 

В настоящее время в отношении транзакций эластичной базы данных в базе данных SQL действует ряд ограничений.

* Поддерживаются только транзакции, выполняемые между базами данных в базе данных SQL. В них не могут участвовать поставщики ресурсов и базы данных [X или Open XA](https://en.wikipedia.org/wiki/X/Open_XA), которые не принадлежат к базе данных SQL. Это означает, что транзакции эластичной базы данных не распространяются на локальные базы данных SQL Server и SQL Azure. Чтобы осуществлять распределенные транзакции локально, нужно использовать MSDTC. 
* Поддерживаются только транзакции, которые осуществляются с помощью приложения .NET и которые координирует клиент. Сейчас выполнение запросов T-SQL на серверах (например, BEGIN DISTRIBUTED TRANSACTION) не поддерживается, но в будущем мы планируем добавить эту возможность. 
* Поддерживаются только базы данных, которые принадлежат к базе данных SQL Azure версии 12.
* Кроме того, поддерживаются только базы данных, принадлежащие к одному логическому серверу базы данных SQL.

## Подробнее

Еще не оценили преимущества транзакций эластичной базы данных для приложений Azure? См. [схему документации](https://azure.microsoft.com/documentation/articles/sql-database-elastic-scale-documentation-map/). Все возникшие вопросы задавайте на [форуме по базам данных SQL](http://social.msdn.microsoft.com/forums/azure/home?forum=ssdsgetstarted), а запросы новых функций оставляйте на [форуме отзывов и предложений по базам данных SQL](http://feedback.azure.com/forums/217321-sql-database).

<!--Image references-->
[1]: ./media/sql-database-elastic-transactions-overview/distributed-transactions.png

<!---HONumber=Nov15_HO2-->