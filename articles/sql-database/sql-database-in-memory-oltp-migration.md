---
title: Повышение производительности транзакций SQL с помощью решения In-Memory OLTP | Microsoft Docs
description: Внедрите технологию In-Memory OLTP, чтобы повысить производительность транзакций в вашей базе данных SQL.
services: sql-database
documentationcenter: ''
author: jodebrui
manager: jhubbard
editor: MightyPen

ms.service: sql-database
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/18/2016
ms.author: jodebrui

---
# Повышение производительности приложений в Базе данных SQL с помощью выполняющейся в памяти OLTP (предварительная версия)
[Выполняющуюся в памяти OLTP](sql-database-in-memory.md) можно использовать для повышения производительности рабочей нагрузки OLTP в базах данных SQL Azure категории [Премиум](sql-database-service-tiers.md), не повышая уровень производительности.

Выполните следующие действия, чтобы внедрить выполняющуюся в памяти OLTP в существующую базу данных.

## Шаг 1. Убедитесь, что база данных категории «Премиум» поддерживает выполняющуюся в памяти OLTP
Базы данных категории «Премиум», созданные в ноябре 2015 г. или позже, поддерживают компонент In-Memory. Узнать, поддерживает ли база данных категории «Премиум» компонент In-Memory, можно с помощью следующей инструкции Transact-SQL. In-Memory поддерживается, если полученное значение равно 1 (не 0):

```
SELECT DatabasePropertyEx(Db_Name(), 'IsXTPSupported');
```

Сокращение *XTP* обозначает технологию *экстремальной обработки транзакций (Extreme Transaction Processing)*.

Если существующую базу данных нужно переместить в новую базу данных категории «Премиум» на сервере версии 12, вы можете воспользоваться следующими функциями экспорта и импорта данных.

#### Экспорт
Экспортируйте рабочую базу данных в BACPAC-файл с помощью:

* Функции [Экспорт](sql-database-export.md) на [портале](https://portal.azure.com/).
* Функции **Экспорт приложения уровня данных** в [последней версии SSMS.exe](http://msdn.microsoft.com/library/mt238290.aspx) (SQL Server Management Studio).
  
  1. В **обозревателе объектов** разверните узел **Базы данных**.
  2. Щелкните правой кнопкой мыши узел своей базы данных.
  3. Щелкните **Задачи** > **Экспорт приложения уровня данных**.
  4. Выполните инструкции, отображаемые в окне мастера.

#### Импорт
Импортируйте BACPAC-файл в новую базу данных категории «Премиум».

1. На [портале](https://portal.azure.com/) Azure сделайте следующее.
   
   * Перейдите на сервер.
   * Выберите пункт [Импорт базы данных](sql-database-import.md).
   * Выберите ценовую категорию «Премиум».
2. Импортируйте BACPAC-файл с помощью SSMS.
   
   * В **обозревателе объектов** щелкните правой кнопкой мыши узел **Базы данных**.
   * Щелкните **Импорт приложения уровня данных**.
   * Выполните инструкции, отображаемые в окне мастера.

## Этап 2. Определение объектов для переноса в In-Memory OLTP
Среда SSMS позволяет создать отчет **Обзор анализа производительности транзакций**, который затем можно запустить для базы данных с активной рабочей нагрузкой. В отчете определены таблицы и хранимые процедуры, которые подходят для миграции в компонент In-Memory OLTP.

Для создания отчета в среде SSMS выполните следующие действия:

* В **обозревателе объектов** щелкните узел своей базы данных правой кнопкой мыши.
* Щелкните **Отчеты** > **Стандартные отчеты** > **Обзор анализа производительности транзакций**.

Дополнительные сведения см. в статье [Определение необходимости переноса таблицы или хранимой процедуры в In-Memory OLTP](http://msdn.microsoft.com/library/dn205133.aspx).

## Шаг 3. Создание сопоставимой тестовой базы данных
Предположим, что согласно отчету ваша база данных содержит таблицу, которую лучше преобразовать в оптимизированную для памяти таблицу. Мы рекомендуем сначала проверить это утверждение.

Вам понадобится тестовая копия рабочей базы данных. У тестовой и рабочей баз данных должна быть одна категория службы.

Чтобы упростить тестирование, настройте тестовую базу данных следующим образом.

1. Подключитесь к новой тестовой базе данных с помощью SSMS.
2. Чтобы не использовать параметр WITH (SNAPSHOT) в запросах, настройте параметр базы данных, как показано в следующей инструкции T-SQL:
   
   ```
   ALTER DATABASE CURRENT
    SET
        MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT = ON;
   ```

## Шаг 4. Миграция таблиц
Вам нужно создать и заполнить копию оптимизированной для памяти таблицы, которую вы тестируете. Ее можно создать с помощью:

* удобного мастера оптимизации памяти в SSMS;
* вручную с помощью инструкций T-SQL.

#### Создание таблицы с помощью мастера оптимизации памяти в SSMS
Чтобы использовать этот параметр миграции, сделайте следующее.

1. Подключитесь к тестовой базе данных с помощью SSMS.
2. В **обозревателе объектов** щелкните правой кнопкой мыши таблицу, а затем выберите пункт **Помощник по оптимизации памяти**.
   
   * Отобразится мастер **Помощник по оптимизации памяти таблицы**.
3. В окне мастера щелкните **Проверка миграции** (или нажмите кнопку **Далее**). Так вы узнаете, содержит ли таблица функции, которые не поддерживаются в оптимизированных для памяти таблицах. Дополнительные сведения см. в следующих статьях:
   
   * *Контрольный список оптимизации памяти* в [помощнике по оптимизации памяти](http://msdn.microsoft.com/library/dn284308.aspx).
   * [Конструкции языка Transact-SQL не поддерживаются компонентом In-Memory OLTP](http://msdn.microsoft.com/library/dn246937.aspx).
   * [Миграция в компонент In-Memory OLTP](http://msdn.microsoft.com/library/dn247639.aspx).
4. Если в таблице нет неподдерживаемых функций, помощник выполнит фактический перенос схемы и данных автоматически.

#### Создание таблицы вручную с помощью инструкций T-SQL
Чтобы использовать этот параметр миграции, сделайте следующее.

1. Подключитесь к тестовой базе данных с помощью SSMS (или аналогичной служебной программы).
2. Получите полный сценарий T-SQL для таблицы и ее индексов.
   
   * В среде SSMS щелкните правой кнопкой мыши узел таблицы.
   * Щелкните **Создать сценарий для таблицы** > **Используя CREATE** > **Открыть в новом окне запроса**.
3. В окне сценария добавьте в инструкцию CREATE TABLE параметр WITH (MEMORY\_OPTIMIZED = ON).
4. При необходимости измените для индекса параметр CLUSTERED (Кластеризовано) на NONCLUSTERED (Некластеризовано).
5. Переименуйте существующую таблицу с помощью инструкции SP\_RENAME.
6. Создайте копию оптимизированной для памяти таблицы, выполнив отредактированный сценарий CREATE TABLE.
7. Скопируйте данные в оптимизированную для памяти таблицу с помощью инструкции INSERT...SELECT * INTO:

```
INSERT INTO <new_memory_optimized_table>
        SELECT * FROM <old_disk_based_table>;
```


## Шаг 5 (необязательный). Миграция хранимых процедур
Компонент In-Memory также может изменять хранимую процедуру для повышения производительности.

### Общие сведения о скомпилированных в собственном коде хранимых процедурах
Скомпилированная в собственном коде хранимая процедура должна иметь следующие параметры в условии T-SQL:

* NATIVE\_COMPILATION;
* SCHEMABINDING — в таблицах хранимых процедур определения столбцов нельзя изменять, если это может повлиять на хранимую процедуру (исключением является удаление хранимой процедуры).

Собственный модуль должен использовать один большой [блок ATOMIC](http://msdn.microsoft.com/library/dn452281.aspx) для управления транзакциями. Роли для явной транзакции BEGIN TRANSACTION или ROLLBACK TRANSACTION не существует. Если код обнаруживает нарушение бизнес-правила, он может завершить атомарный блок с помощью инструкции [THROW](http://msdn.microsoft.com/library/ee677615.aspx).

### Стандартная инструкция CREATE PROCEDURE для создания скомпилированных в собственном коде процедур
Как правило, инструкция T-SQL для создания скомпилированной хранимой процедуры имеет следующий вид:

```
CREATE PROCEDURE schemaname.procedurename
    @param1 type1, …
    WITH NATIVE_COMPILATION, SCHEMABINDING
    AS
        BEGIN ATOMIC WITH
            (TRANSACTION ISOLATION LEVEL = SNAPSHOT,
            LANGUAGE = N'your_language__see_sys.languages'
            )
        …
        END;
```

* Для TRANSACTION\_ISOLATION\_LEVEL значение SNAPSHOT является наиболее распространенным при создании скомпилированной хранимой процедуры. Тем не менее поддерживаются и другие значения.
  
  * REPEATABLE READ;
  * SERIALIZABLE.
* Значение LANGUAGE должно присутствовать в представлении sys.languages.

### Миграция хранимой процедуры
Этапы миграции

1. Получите скрипт CREATE PROCEDURE, чтобы создать интерпретируемую хранимую процедуру.
2. Перезапишите ее заголовок в соответствии с предыдущим шаблоном.
3. Убедитесь, используются ли в коде T-SQL хранимой процедуры функции, которые не поддерживаются для скомпилированных хранимых процедур. При необходимости устраните эту проблему.
   
   * Дополнительные сведения см. в статье [Проблемы с миграцией скомпилированных в собственном коде хранимых процедур](http://msdn.microsoft.com/library/dn296678.aspx).
4. С помощью SP\_RENAME переименуйте старую хранимую процедуру. Или просто удалите ее с помощью DROP.
5. Запустите измененный сценарий T-SQL CREATE PROCEDURE.

## Шаг 6. Запуск рабочей нагрузки в тестовой среде
Запустите рабочую нагрузку в тестовой базе данных, как если бы это была рабочая нагрузка, запущенная в рабочей базе данных. Вы увидите, насколько выросла производительность таблиц и хранимых процедур при использовании компонента In-Memory.

Основные атрибуты рабочей нагрузки:

* количество одновременных подключений;
* отношение количества операций чтения и записи.

Выполнить настройку и проверку тестовой нагрузки можно с помощью удобного средства ostress.exe, как описано [здесь](sql-database-in-memory.md).

Чтобы свести к минимуму задержки в сети, выполняйте проверку в географическом регионе Azure, в котором расположена ваша база данных.

## Шаг 7. Мониторинг после реализации
Рассмотрите возможность отслеживания влияния, оказываемого компонентом In-Memory в рабочей среде.

* [Мониторинг хранилища In-Memory](sql-database-in-memory-oltp-monitoring.md).
* [Мониторинг базы данных SQL Azure с помощью динамических представлений управления](sql-database-monitoring-with-dmvs.md)

## Связанные ссылки
* [In-Memory OLTP (оптимизация в памяти)](http://msdn.microsoft.com/library/dn133186.aspx)
* [Общие сведения о скомпилированных в собственном коде хранимых процедурах](http://msdn.microsoft.com/library/dn133184.aspx)
* [Помощник по оптимизации памяти](http://msdn.microsoft.com/library/dn284308.aspx)

<!---HONumber=AcomDC_0720_2016-->