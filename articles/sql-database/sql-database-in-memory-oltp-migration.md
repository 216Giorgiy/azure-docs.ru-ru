<properties
	pageTitle="Использование In-Memory OLTP для повышения производительности транзакций Azure SQL | Microsoft Azure"
	description="Внедрите технологию In-Memory OLTP, чтобы повысить производительность транзакций в вашей базе данных SQL."
	services="sql-database"
	documentationCenter=""
	authors="jodebrui"
	manager="jeffreyg"
	editor=""/>


<tags
	ms.service="sql-database"
	ms.workload="data-management"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="10/28/2015"
	ms.author="jodebrui"/>


# Повышение производительности приложения Azure SQL с помощью технологии In-Memory (предварительная версия)

Выполните следующие действия, чтобы оптимизировать производительность транзакций существующей базы данных SQL Azure категории «Премиум» с помощью технологии [In-Memory](sql-database-in-memory.md).

Для сравнения выберите рабочую нагрузку, аналогичную вашей производственной рабочей нагрузке, с аналогичным количеством параллельных подключений и соотношением операций чтения и записи. Чтобы свести к минимуму задержки в сети, рекомендуется выполнить тестовую рабочую нагрузку в регионе Azure, в котором размещена база данных.

## Этап 1. Копирование данных в новую базу данных категории «Премиум»
1.	Экспортируйте рабочую базу данных в BACPAC-файл с помощью:

	О. функции экспорта на [портале](https://portal.azure.com/); или

	B. функции экспорта в приложении уровня данных в SQL Server Management Studio.

2.	Импортируйте BACPAC-файл в новую базу данных категории «Премиум» на сервере V12:

	О. На портале: перейдите к серверу и выберите параметр импорта базы данных. Не забудьте выбрать ценовую категорию «Премиум».

	B. В SQL Server Management Studio (SSMS): подключитесь к серверу, щелкните правой кнопкой мыши узел «Базы данных» и выберите «Импорт приложения уровня данных».


## Этап 2. Определение объектов для переноса в In-Memory OLTP
SQL Server Management Studio (SSMS) включает отчет анализа производительности транзакций, который можно запустить для базы данных с активной рабочей нагрузкой, чтобы определить таблицы и хранимые процедуры, которые подходят для миграции в In-Memory OLTP. Дополнительные сведения см. в статье [Определение, должна ли таблица или хранимая процедура быть перенесена в In-Memory OLTP](https://msdn.microsoft.com/library/dn205133.aspx).

1.	Подключитесь к рабочей базе данных с помощью SSMS. Если у вас есть рабочая нагрузка в новой тестовой базе данных, можно подключиться к ней.
2.	Щелкните базу данных правой кнопкой мыши и последовательно выберите «Отчеты» -> «Стандартный отчет» -> «Отчет анализа производительности транзакций». Отчет позволяет определить таблицы и хранимые процедуры, которые можно оптимизировать благодаря In-Memory OLTP (в зависимости от использования).


## Этап 3. Перенос таблиц
1.	Подключитесь к новой тестовой базе данных с помощью SSMS. Чтобы избежать необходимости использовать параметр WITH (SNAPSHOT) в запросах, рекомендуется установить параметр базы данных MEMORY\_OPTIMIZED\_ELEVATE\_TO\_SNAPSHOT.
2.	После подключения к новой тестовой базе данных выполните следующую команду:

   	    ALTER DATABASE CURRENT SET MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT=ON

3.	Перенесите дисковые таблицы в таблице, оптимизированные для памяти, используя один из следующих способов:

	О. Мастер оптимизации памяти SSMS. После подключения к тестовой базе данных щелкните таблицу правой кнопкой мыши и выберите помощник по оптимизации памяти. С его помощью можно определить, есть ли в таблице функции, которые не поддерживаются в таблицах, оптимизированных для памяти. Если таких функций нет, помощник может выполнить перенос схемы и данных. Дополнительные сведения см. в статье о [помощнике по оптимизации памяти на сайте MSDN](https://msdn.microsoft.com/library/dn284308.aspx).

	B. Перенос вручную. Подключитесь к новой тестовой базе данных с помощью SSMS.

Чтобы перенести таблицу, выполните следующие действия.

1.	Создайте сценарий для таблицы: щелкните таблицу правой кнопкой мыши и выберите «Создать скрипт для таблицы» -> «Используя CREATE» -> «Новое окно запроса».
2.	Измените КЛАСТЕРИЗОВАННЫЙ индекс на НЕКЛАСТЕРИЗОВАННЫЙ и добавьте параметр WITH (MEMORY\_OPTIMIZED=ON).
3.	Если в таблице используются неподдерживаемые функции, реализуйте обходные пути. См. документы MSDN по обработке [распространенных неподдерживаемых функций](https://msdn.microsoft.com/library/dn247639.aspx).
4.	Переименуйте существующую таблицу с помощью sp\_rename.
5.	Создайте новую таблицу, оптимизированную для памяти, выполнив сценарий CREATE TABLE.
6.	Скопируйте данные, выполнив следующую инструкцию: ``INSERT INTO <new_memory_optimized_table> SELECT * FROM <old_disk_based_table>.

## Этап 4 (необязательно). Перенос хранимых процедур

Подключитесь к новой тестовой базе данных SQL Azure через [SQL Server Management Studio (SSMS)](https://msdn.microsoft.com/library/mt238290.aspx) (предварительная версия за сентябрь 2015 г. или более поздняя версия).

Определите все функции, которые не поддерживаются в скомпилированных в собственном коде хранимых процедурах. Для этого запустите [помощник по компиляции в собственный код](https://msdn.microsoft.com/library/dn284308.aspx) в старой процедуре. Обходные пути для распространенных неподдерживаемых функций задокументированы на сайте [MSDN](https://msdn.microsoft.com/library/dn296678.aspx).

При переносе хранимой процедуры в собственный код следует учитывать два фактора.

- Для собственных модулей требуются следующие параметры:

	- NATIVE\_COMPILATION;
	- SCHEMABINDING.



- Собственные модули используют [блоки ATOMIC](https://msdn.microsoft.com/library/dn452281.aspx) для управления транзакциями. Явные инструкции BEGIN TRAN, COMMIT или ROLLBACK не требуются.

Типичная хранимая процедура, скомпилированная в собственном коде, выглядит так:


   	    CREATE PROCEDURE schemaname.procedurename
   		@param1 type1, …
   		WITH NATIVE_COMPILATION, SCHEMABINDING
   		AS
   		BEGIN ATOMIC WITH (TRANSACTION ISOLATION LEVEL = SNAPSHOT, LANGUAGE = N'your_language')

   		…

   		END



Обратите внимание, что хотя для оптимизированных для памяти таблиц наиболее часто используется уровень изоляции SNAPSHOT, поддерживаются также уровни REPEATABLE READ и SERIALIZABLE.

##### Чтобы перенести хранимую процедуру, выполните следующие действия.

1.	Создайте сценарий для старой хранимой процедуры. Для этого щелкните процедуру правой кнопкой мыши и выберите «Создать скрипт для процедуры» -> «Используя CREATE» -> «Новое окно запроса».
2.	Перезапишите заголовок процедуры с помощью шаблона выше и удалите все инструкции BEGIN TRAN, ROLLBACK и COMMIT.
3.	Если в хранимой процедуре используются неподдерживаемые функции, реализуйте обходные пути. См. документы MSDN по обработке [распространенных неподдерживаемых функций](https://msdn.microsoft.com/library/dn296678.aspx).
4.	Удалите процедуру или переименуйте старую процедуру с помощью sp\_rename.
5.	Создайте новую хранимую процедуру, скомпилированную в собственном коде. Для этого выполните сценарий CREATE PROCEDURE.

## Этап 5. Запуск рабочей нагрузки
Запустите тестовую рабочую нагрузку для оптимизированных для памяти таблиц и скомпилированных в собственном коде хранимых процедур и измерьте прирост производительности.

## Дальнейшие действия

[Мониторинг хранилища In-Memory](https://azure.microsoft.com/documentation/articles/sql-database-in-memory-oltp-monitoring/).

[Мониторинг базы данных SQL Azure с помощью динамических представлений управления](sql-database-monitoring-with-dmvs.md)

<!---HONumber=Nov15_HO1-->