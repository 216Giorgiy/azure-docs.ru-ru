<properties
   pageTitle="Решения для аварийного восстановления облака: активная георепликация базы данных SQL | Microsoft Azure"
   description="Узнайте, как разрабатывать решения аварийного восстановления облака для планирования непрерывности бизнес-процессов, используя георепликацию для резервного копирования данных приложения в базе данных SQL Azure."
   keywords="аварийное восстановление облака, решения для аварийного восстановления, резервное копирование данных приложения, георепликация, планирование непрерывности бизнес-процессов"
   services="sql-database"
   documentationCenter=""
   authors="anosov1960"
   manager="jhubbard"
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-management"
   ms.date="04/25/2016"
   ms.author="sashan"/>

# Создание приложения для аварийного восстановления облака с использованием активной георепликации в базе данных SQL


> [AZURE.NOTE] [Active Geo-Replication]Раздел (sql-database-geo-replication-overview.md) теперь доступен для всех баз данных и всех уровней.



Узнайте, как использовать [активную георепликацию](sql-database-geo-replication-overview.md) в базе данных SQL для разработки приложений баз данных, устойчивых к региональным сбоям и аварийным простоям. При планировании непрерывности бизнес-процессов учитывается топология развертывания приложения, планируемое соглашение об уровне обслуживания, задержка трафика и расходы. В этой статье мы рассмотрим типичные модели создания приложений, а также преимущества и недостатки каждой из них.

## Модель разработки 1: активное — пассивное развертывание для аварийного восстановления облака с совмещенной базой данных

Этот вариант лучше всего подходит для приложений со следующими характеристиками:

+ Активный экземпляр находится в одном регионе Azure.
+ Значительная зависимость от доступа к данным для чтения и записи.
+ Межрегиональное подключение между логикой приложения и базой данных не допускается из-за задержки трафика и его стоимости.    

В этом случае топология развертывания приложения оптимизирована для обработки региональных аварий, когда затронуты все компоненты приложения и необходимо выполнить отработку отказа в качестве одной единицы. Для географической избыточности как логика приложения, так и база данных реплицируются в другой регион, но не используются для рабочей нагрузки приложения в нормальных условиях. В приложении в дополнительном регионе должно быть настроено использование строки подключения SQL к базе данных-получателю. В диспетчере трафика настроено использование [метода маршрутизации с отработкой отказа](../traffic-manager/traffic-manager-configure-failover-routing-method.md).

> [AZURE.NOTE] [Azure traffic manager](../traffic-manager/traffic-manager-overview.md) используется в этой статье только для иллюстрации. Можно использовать любое решение балансировки нагрузки, поддерживающее метод маршрутизации с отработкой отказа.

Помимо экземпляров основного приложения, рекомендуется развернуть небольшое [приложение с рабочей ролью](cloud-services-choose-me.md#tellmecs), которое отслеживает базу данных-источник, периодически отправляя команды T-SQL только для чтения. Его можно использовать для автоматического вызова отработки отказа и для создания предупреждения в консоли администрирования приложения или для обоих случаев. Чтобы на мониторинг не влияли общерегиональные сбои, необходимо развернуть экземпляры приложения мониторинга в каждом регионе и подключить их к базе данных в другом регионе. Активным должен быть только экземпляр в дополнительном регионе.

> [AZURE.NOTE] Оба приложения мониторинга должны быть активными и проверять базу данных-источник и базы данных-получателей. Последнюю можно использовать для обнаружения сбоя в дополнительном регионе и предупреждения об отсутствии защиты приложения.

На следующей схеме показана эта конфигурация до сбоя.

![Настройка георепликации базы данных SQL. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-1.png)

После сбоя в основном регионе приложение мониторинга обнаруживает, что база данных-источник недоступна, и создает оповещение. В зависимости от соглашения об уровне обслуживания для приложения можно настроить количество последовательных проб мониторинга, которые должны завершиться с ошибкой, прежде чем будет объявлено о сбое базы данных. Чтобы добиться согласованной отработки отказа в конечной точке приложения и базе данных, необходимо, чтобы приложение мониторинга выполнило следующие действия:

1. [Обновление состояния основной конечной точки](https://msdn.microsoft.com/library/hh758250.aspx) для запуска отработки отказа для конечной точки.
2. Вызов базы данных-получателя для [запуска отработки отказа базы данных](sql-database-geo-replication-portal.md).

После отработки отказа приложение будет обрабатывать запросы пользователей в дополнительном регионе, но останется совмещенным с базой данных, поскольку база данных-источник теперь будет в дополнительном регионе. Это показано на следующей схеме. На всех схемах сплошными линиями показаны активные подключения, пунктирными — приостановленные подключения, а знаки «стоп» означают триггеры действий.


![Георепликация: отработка отказа с помощью базы данных-получателя. Резервное копирование данных приложения.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-2.png)

Если сбой происходит в дополнительном регионе, канал репликации между базой данных-источником и базой данных-получателем будет приостановлен, а приложение мониторинга зарегистрирует оповещение о том,что база данных-источник не защищена. Это не повлияет на работу приложения, но база данных будет работать без защиты, и будет существовать риск последовательного сбоя обоих регионов.

> [AZURE.NOTE] Рекомендуется использовать только конфигурации развертывания с одним регионом аварийного восстановления. Это связано с тем, что большинство географических расположений Azure имеют два региона. Эти конфигурации не смогут защитить ваши приложения от масштабного сбоя в обоих регионах. В маловероятной ситуации такого сбоя можно восстановить базы данных в третьем регионе с помощью [операции геовосстановления](sql-database-disaster-recovery.md#recovery-using-geo-restore).

После устранения сбоя база данных-получатель будет автоматически синхронизирована с базой данных-отправителем. Во время синхронизации производительность базы данных-получателя может незначительно уменьшиться в зависимости от объема данных для синхронизации. На следующей схеме показан сбой в дополнительном регионе.

![Синхронизация базы данных-получателя с базой данных-источником. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-3.png)


Эта модель разработки имеет такие **преимущества**:

+ Строка подключения SQL задается при развертывании приложения в каждом регионе и не меняется после отработки отказа.
+ Отработка отказа не влияет на работу приложения, так как приложение и база данных всегда находятся в одном расположении.

Основным **недостатком** является то, что избыточный экземпляр приложения в дополнительном регионе используется только для аварийного восстановления.

## Модель разработки 2: активное — активное развертывание для балансировки нагрузки приложения
Этот вариант аварийного восстановления облака лучше всего подходит для приложений со следующими характеристиками:

+ Высокая доля операций чтения по отношению к операциям записи в базе данных.
+ Задержка записи базы данных не влияет на работу конечного пользователя.  
+ Логика только для чтения может быть отделена от логики чтения и записи с помощью другой строки подключения.
+ Логика только для чтения не зависит от полной синхронизации данных с последними обновлениями.  

Если ваше приложение имеет эти характеристики, балансировка нагрузки подключений конечного пользователя по нескольким экземплярам приложения в разных регионах может повысить производительность системы и эффективность работы конечного пользователя. Для этого каждый регион должен иметь активный экземпляр приложения с логикой чтения и записи, подключенной к базе данных-источнику в основном регионе. Логика только для чтения должна быть подключена к базе данных-получателю в том же регионе, что и экземпляр приложения. В диспетчере трафика следует настроить использование [циклической маршрутизации](../traffic-manager/traffic-manager-configure-round-robin-routing-method.md) или [маршрутизации производительности](../traffic-manager/traffic-manager-configure-performance-routing-method.md) с включенным для каждого экземпляра приложения [мониторингом конечной точки](../traffic-manager/traffic-manager-monitoring.md).

Как и в модели 1, следует рассмотреть возможность развертывания схожего приложения мониторинга. Но, в отличие от модели 1, оно не должно отвечать за запуск отработки отказа конечной точки.

> [AZURE.NOTE] Хотя эта модель использует несколько баз данных-получателей, только одна из них будет использоваться для отработки отказа по причинам, описанным ранее. Так как для этой модели требуется доступ к базе данных-получателю только для чтения, для нее необходима активная георепликация.

В диспетчере трафика должна быть настроена маршрутизация производительности, чтобы направлять подключения пользователей к экземпляру приложения, расположенному ближе к географическому положению пользователя. На следующей схеме показана эта конфигурация до сбоя. ![Никаких сбоев: маршрутизация трафика в ближайшее приложение. Георепликация.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-1.png)

При обнаружении сбоя базы данных в основном регионе инициируется отработка отказа базы данных-источника с использованием одного из дополнительных регионов, что приведет к изменению расположения базы данных-источника. Диспетчер трафика автоматически исключит автономную конечную точку из таблицы маршрутизации, но продолжит маршрутизацию трафика конечного пользователя на оставшиеся подключенные экземпляры. Поскольку база данных-источник теперь находится в другом регионе, все подключенные экземпляры должны изменить свои строки подключения SQL для чтения-записи и подключиться к новой базе данных-источнику. Важно, чтобы это изменение было внесено до начала отработки отказа базы данных. Строки подключения SQL только для чтения должны оставаться без изменений, т. к. они всегда указывают на базу данных в том же регионе. Этапы отработки отказа перечислены далее.

1. Изменение строк подключения SQL для чтения и записи таким образом, чтобы они указывали на новую базу данных-источник.
2. Вызов соответствующей базы данных-получателя для [запуска отработки отказа базы данных](sql-database-geo-replication-portal.md).

На следующей схеме показана новая конфигурация после отработки отказа. ![Настройка после отработки отказа. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-2.png)

В случае сбоя в работе одного из дополнительных регионов диспетчер трафика автоматически удалит автономную конечную точку в этом регионе из таблицы маршрутизации. Канал репликации для базы данных-получателя в этом регионе будет приостановлен. Поскольку остальные регионы получат дополнительный пользовательский трафик, может измениться производительность приложения во время сбоя. После устранения сбоя база данных-получатель в затронутом регионе будет сразу же синхронизирована с базой данных-отправителем. Во время синхронизации производительность базы данных-получателя может незначительно уменьшиться в зависимости от объема данных для синхронизации. На следующей схеме показан сбой в одном из дополнительных регионов.

![Сбой в дополнительном регионе. Аварийное восстановление облака: георепликация.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-3.png)

Ключевое **преимущество** этого шаблона заключается в том, что можно масштабировать рабочую нагрузку приложения в нескольких дополнительных регионах для достижения оптимальной производительности конечных пользователей. **Недостатки** этого варианта:

+ Подключения для чтения и записи между экземплярами приложения и базой данных имеют разные задержки и стоимость.
+ Во время сбоя затрагивается производительность приложения.
+ Необходимо, чтобы экземпляры приложения динамически изменяли строку подключения SQL после отработки отказа базы данных.  

> [AZURE.NOTE] Подобный подход можно использовать для разгрузки специализированных рабочих нагрузок, например заданий по созданию отчетов, средств бизнес-аналитики или резервного копирования. Обычно эти рабочие нагрузки используют значительные ресурсы базы данных, поэтому рекомендуется назначить для них одну из баз данных-получателей с уровнем производительности, соответствующим ожидаемой рабочей нагрузке.

## Модель разработки 3: активное — пассивное развертывание для сохранения данных  
Этот вариант лучше всего подходит для приложений со следующими характеристиками:

+ Любая потеря данных представляет собой большой риск для бизнеса, отработка отказа базы данных может использоваться только в качестве последнего средства, когда сбой является необратимым.
+ Приложение может работать в режиме только для чтения в течение определенного времени.

В этой модели приложение переходит в режим только для чтения при подключении к базе данных-получателю. Логика приложения в основном регионе совмещена с базой данных-источником и работает в режиме чтения и записи, логика приложения в дополнительном регионе совмещена с базой данных-получателем и готова для работы в режиме только для чтения. В диспетчере трафика следует настроить использование [маршрутизации отработки отказа](../traffic-manager/traffic-manager-configure-failover-routing-method.md) с [мониторингом конечных точек](../traffic-manager/traffic-manager-monitoring.md), включенным для каждого экземпляра приложения.

На следующей схеме показана эта конфигурация до сбоя. ![Активное — пассивное развертывание перед отработкой отказа. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-1.png)

Когда диспетчер трафика обнаруживает сбой подключения к основному региону, он автоматически переключает пользовательский трафик на экземпляр приложения в дополнительном регионе. Для этой модели важно **не** инициировать отработку отказа базы данных после обнаружения сбоя. Приложение в дополнительном регионе активируется и работает в режиме только для чтения, используя базу данных-получатель. Это показано на следующей схеме.

![Сбой: приложение в режиме только для чтения. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-2.png)

После устранения сбоя в основном регионе диспетчер трафика определит восстановление подключения в основном регионе и переключит пользовательский трафик обратно на экземпляр приложения в основном регионе. Этот экземпляр приложения возобновляет работу и работает в режиме чтения и записи, используя базу данных-источник.

> [AZURE.NOTE] Так как для этой модели требуется доступ к базе данных-получателю только для чтения, для нее необходима активная георепликация.

В случае сбоя в дополнительном регионе диспетчер трафика отметит конечную точку приложения в основном регионе как точку с пониженной производительностью, а канал репликации будет приостановлен. Однако это не повлияет на работу приложения во время сбоя. После устранения сбоя база данных-получатель будет сразу синхронизирована с базой данных-отправителем. Во время синхронизации производительность базы данных-получателя может незначительно уменьшиться в зависимости от объема данных для синхронизации.

![Сбой: база данных-получатель Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-3.png)

Эта модель разработки имеет несколько **преимуществ**:

+ Она позволяет избежать потери данных при временном сбое.
+ Для нее не требуется развертывание приложения мониторинга, поскольку восстановление запускается диспетчером трафика.
+ Время простоя зависит только от того, как быстро диспетчер трафика обнаруживает сбой подключения. Этот параметр можно настроить.

**Недостатки**:

+ Приложение должно поддерживать работу в режиме только для чтения.
+ Необходимо динамически переключиться на него при подключении к базе данных только для чтения.
+ Для возобновления операций чтения и записи требуется восстановление основного региона, а это означает, что полный доступ к данным может отсутствовать в течение нескольких часов или даже дней.

> [AZURE.NOTE] В случае необратимого сбоя службы в регионе необходимо будет вручную активировать отработку отказа базы данных и принять потери данных. Приложение будет работать в дополнительном регионе с доступом к базе данных для чтения и записи.

## Планирование непрерывности бизнеса-процессов: выбор проекта приложения для аварийного восстановления облака

В зависимости от выбранной стратегии аварийного восстановления облака вы можете объединить или расширить эти шаблоны проектирования для наилучшего соответствия требованиям приложения. Как уже упоминалось, выбор стратегии зависит от соглашения об уровне обслуживания, предлагаемого клиентам, и топологии развертывания приложения. Чтобы помочь вам принять решение, в следующей таблице сравниваются варианты с учетом предполагаемой потери данных или целевой точки восстановления (RPO) и оценки времени восстановления (ERT).

| Модель | RPO | ERT
| :--- |:--- | :---
| Активное — пассивное развертывание для аварийного восстановления с доступом к совмещенной базе данных | Доступ для чтения и записи < 5 секунд | Время обнаружения сбоя + вызов API отработки отказа + тест проверки приложения
| Активное — активное развертывание для балансировки нагрузки приложения | Доступ для чтения и записи < 5 секунд | Время обнаружения сбоя + вызов API отработки отказа + изменение строки подключения SQL + тест проверки приложения
| Активное — пассивное развертывание для сохранения данных | Доступ только для чтения < 5 секунд, доступ для чтения и записи = 0 | Доступ только для чтения = время обнаружения ошибки подключения + тест проверки приложения <br>Доступ для чтения и записи = время для устранения сбоя

## Дальнейшие действия

- Сведения об использовании и настройке активной георепликации для аварийного восстановления см. в разделе [Обзор: активная георепликация для базы данных SQL](sql-database-geo-replication-overview.md).
- Сведения об использовании геовосстановления для аварийного восстановления см. в разделе [Обзор. Геовосстановление базы данных SQL Azure](sql-database-geo-restore.md).

## Дополнительные ресурсы

- [Обзор. Непрерывность облачных бизнес-процессов и аварийное восстановление баз данных с базой данных SQL](sql-database-business-continuity.md)
- [Обзор. Функция восстановления до точки во времени в Базе данных SQL](sql-database-point-in-time-restore.md)
- [Геовосстановление](sql-database-geo-restore.md)
- [Активная георепликация](sql-database-geo-replication-overview.md)
- [Проектирование приложений для аварийного восстановления в облаке](sql-database-designing-cloud-solutions-for-disaster-recovery.md)
- [Финализация восстановленной Базы данных SQL Azure](sql-database-recovered-finalize.md)
- [Настройки безопасности для георепликации](sql-database-geo-replication-security-config.md)
- [Часто задаваемые вопросы о непрерывности бизнес-процессов и аварийном восстановлении в базах данных SQL](sql-database-bcdr-faq.md)

<!---HONumber=AcomDC_0622_2016-->