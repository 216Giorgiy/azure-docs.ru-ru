---
title: "Разработка службы высокой доступности с помощью базы данных SQL Azure | Документация Майкрософт"
description: "Сведения о разработке приложений для высокодоступных служб с помощью базы данных SQL Azure."
keywords: "аварийное восстановление облака, решения для аварийного восстановления, резервное копирование данных приложения, георепликация, планирование непрерывности бизнес-процессов"
services: sql-database
documentationcenter: 
author: anosov1960
manager: jhubbard
editor: monicar
ms.assetid: e8a346ac-dd08-41e7-9685-46cebca04582
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-management
ms.date: 04/21/2017
ms.author: sashan
ms.translationtype: Human Translation
ms.sourcegitcommit: 95b8c100246815f72570d898b4a5555e6196a1a0
ms.openlocfilehash: b1b67a83a25159414a80382030903d300aad71f7
ms.contentlocale: ru-ru
ms.lasthandoff: 05/18/2017


---
# <a name="designing-highly-available-services-using-azure-sql-database"></a>Разработка службы высокой доступности с помощью базы данных SQL Azure

При создании и развертывании высокодоступных служб в базе данных SQL Azure следует использовать [группы отработки отказа и активную георепликацию](sql-database-geo-replication-overview.md). Они обеспечивают устойчивость к региональным сбоям и аварийным простоям и быстрое восстановление в базах данных-получателях. В этой статье рассматриваются общие шаблоны приложений и изложены преимущества и компромиссы каждого варианта в зависимости от требований к развертыванию приложения, соглашению об уровне обслуживания, на которое вы ориентируетесь, задержкам трафика и расходам. Сведения об использовании активной георепликации с пулами эластичных баз данных см. в статье [Стратегии аварийного восстановления для приложений с использованием пула эластичных баз данных SQL](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).

## <a name="design-pattern-1-active-passive-deployment-for-cloud-disaster-recovery-with-a-co-located-database"></a>Модель разработки 1: активное — пассивное развертывание для аварийного восстановления облака с совмещенной базой данных
Этот вариант лучше всего подходит для приложений со следующими характеристиками:

* Активный экземпляр находится в одном регионе Azure.
* Значительная зависимость от доступа к данным для чтения и записи.
* Межрегиональное подключение между веб-приложением и базой данных не допускается из-за задержки трафика и его стоимости.    

В этом случае топология развертывания приложений оптимизирована для обработки региональных аварий, когда затронуты все компоненты приложения и необходимо выполнить его отработку отказа как единого целого. Для обеспечения геоизбыточности как логика приложения, так и база данных реплицируются в другой регион, но не используются для рабочей нагрузки приложения в обычных условиях. В приложении в дополнительном регионе должно быть настроено использование строки подключения SQL к базе данных-получателю. В диспетчере трафика настроено использование [метода маршрутизации с отработкой отказа](../traffic-manager/traffic-manager-configure-failover-routing-method.md).  

> [!NOTE]
> [Диспетчер трафика Azure](../traffic-manager/traffic-manager-overview.md) используется в этой статье только для иллюстрации. Можно использовать любое решение балансировки нагрузки, поддерживающее метод маршрутизации с отработкой отказа.    
>

На следующей схеме показана эта конфигурация до сбоя.

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-1.png)

После сбоя в основном регионе служба базы данных SQL обнаружит, что база данных-источник недоступна, и вызовет отработку отказа в базу данных-получатель на основе параметров политики автоматической отработки отказа. В зависимости от соглашения об уровне обслуживания приложения вы можете задать льготный период между обнаружением сбоя и отработкой отказа. Настройка льготного периода снижает риск потери данных, гарантируя отработку отказа только тогда, когда сбой является катастрофическим и доступность региона нельзя быстро восстановить. Если диспетчер трафика инициирует отработку отказа конечной точки, прежде чем группа отработки отказа активирует отработку отказа базы данных, веб-приложение не сможет повторно подключиться к базе данных. Попытка приложения повторно подключиться будет выполнена автоматически, как только отработка отказа базы данных завершится. 

> [!NOTE]
> Чтобы достигнуть полностью согласованной отработки отказа приложения и баз данных, вам необходимо разработать свой собственный метод мониторинга и использовать ручную отработку отказа конечных точек веб-приложений и баз данных.
>

После завершения отработки отказа конечных точек приложения и базы данных приложение повторно начнет обрабатывать запросы пользователей в регионе Б и останется совместно размещенным с базой данных, так как база данных-источник теперь находится в регионе Б. Этот сценарий проиллюстрирован на следующей схеме. На всех схемах сплошными линиями показаны активные подключения, пунктирными — приостановленные подключения, а знаки "стоп" означают триггеры действий.

![Георепликация: отработка отказа с помощью базы данных-получателя Резервное копирование данных приложения.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-2.png)

Если сбой происходит в дополнительном регионе, то канал репликации между базой данных-источником и базой данных-получателем будет приостановлен, но отработка отказа не активируется из-за того, что сбой не повлиял на базу данных-источник. Доступность приложения в этом случае не будет затронута, но оно будет работать без защиты, и будет существовать риск последовательного сбоя обоих регионов.

> [!NOTE]
> Рекомендуется использовать только конфигурации развертывания с одним регионом аварийного восстановления. Это связано с тем, что большинство географических расположений Azure имеют два региона. Эти конфигурации не смогут защитить ваши приложения от масштабного сбоя в обоих регионах. В маловероятной ситуации такого сбоя можно восстановить базы данных в третьем регионе с помощью [операции геовосстановления](sql-database-disaster-recovery.md#recover-using-geo-restore).
>

После устранения сбоя база данных-получатель будет автоматически повторно синхронизирована с базой данных-источником. Во время синхронизации производительность базы данных-источника может незначительно уменьшиться в зависимости от объема данных для синхронизации. На следующей схеме показан сбой в дополнительном регионе.

![Синхронизация базы данных-получателя с базой данных-источником. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-3.png)

Эта модель разработки имеет такие **преимущества** :

* Одно и то же веб-приложение развертывается в обоих регионах без какой-либо особой для региона конфигурации и никакой дополнительной логики для реагирования на отработку отказа. 
* Отработка отказа не влияет на работу приложения, так как веб-приложение и база данных всегда находятся в одном расположении.

Основным **недостатком** является то, что избыточный экземпляр приложения в дополнительном регионе используется только для аварийного восстановления.

## <a name="design-pattern-2-active-active-deployment-for-application-load-balancing"></a>Модель разработки 2: активное — активное развертывание для балансировки нагрузки приложения
Этот вариант аварийного восстановления облака лучше всего подходит для приложений со следующими характеристиками:

* Высокая доля операций чтения по отношению к операциям записи в базе данных.
* Для работы конечного пользователя более критична задержка чтения базы данных, а не задержка записи. 
* Логика только для чтения может быть отделена от логики чтения и записи с помощью другой строки подключения.
* Логика только для чтения не зависит от полной синхронизации данных с последними обновлениями.  

Если ваше приложение имеет эти характеристики, то балансировка нагрузки подключений пользователя между несколькими экземплярами приложения в разных регионах может существенно улучшить эффективность работы пользователя. Два региона должны быть выбраны в качестве пары для аварийного восстановления, а группа отработки отказа должна включать базы данных в этих регионах. Для реализации балансировки нагрузки каждый регион должен иметь активный экземпляр приложения с логикой чтения и записи, подключенный к конечной точке прослушивателя чтения и записи группы отработки отказа. Это гарантирует, что отработка отказа будет автоматически инициирована, если сбой повлияет на базу данных-источник. Логику только для чтения в веб-приложении следует подключать напрямую к базе данных в этом регионе. В диспетчере трафика следует настроить использование [маршрутизации производительности](../traffic-manager/traffic-manager-configure-performance-routing-method.md) с включенным для каждого экземпляра приложения [мониторингом конечной точки](../traffic-manager/traffic-manager-monitoring.md).

Как и в модели 1, следует рассмотреть возможность развертывания схожего приложения мониторинга. Но, в отличие от модели 1, приложение мониторинга не должно отвечать за активацию отработки отказа конечной точки.

> [!NOTE]
> Хотя эта модель использует несколько баз данных-получателей, только одна из баз данных-получателей в регионе В будет использоваться для отработки отказа и должна быть частью группы отработки отказа.
>

В диспетчере трафика должна быть настроена маршрутизация производительности, чтобы направлять подключения пользователей к экземпляру приложения, расположенному ближе к географическому положению пользователя. На следующей схеме показана эта конфигурация до сбоя.

![Никаких сбоев: маршрутизация трафика в ближайшее приложение. Георепликация](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-1.png)

Если сбой базы данных будет обнаружен в регионе А, группа отработки отказа автоматически запустит отработку отказа базы данных-источника в регионе А в базу данных-получатель в регионе Б. Это также автоматически обновит конечную точку прослушивателя записи и чтения до региона Б, так что подключения чтения и записи в веб-приложении не будут затронуты. Диспетчер трафика исключит автономную конечную точку из таблицы маршрутизации, но продолжит маршрутизацию трафика пользователя на оставшиеся экземпляры в сети. Строки подключения SQL только для чтения останутся без изменений, так как они всегда указывают на базу данных в том же регионе. 

На следующей схеме показана новая конфигурация после отработки отказа.

![Настройка после отработки отказа. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-2.png)

В случае сбоя в работе одного из дополнительных регионов диспетчер трафика автоматически удалит автономную конечную точку в этом регионе из таблицы маршрутизации. Канал репликации для базы данных-получателя в этом регионе будет приостановлен. Так как в данном случае остальные регионы получат дополнительный трафик пользователей, производительность приложения во время сбоя может снизиться. После устранения сбоя база данных-получатель в затронутом регионе будет сразу же синхронизирована с базой данных-источником. Во время синхронизации производительность базы данных-получателя может незначительно уменьшиться в зависимости от объема данных для синхронизации. На следующей схеме показан сбой в регионе Б.

![Сбой в дополнительном регионе. Аварийное восстановление облака: георепликация](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-3.png)

Ключевое **преимущество** этой модели заключается в том, что можно масштабировать рабочую нагрузку приложения в нескольких дополнительных регионах для достижения оптимальной производительности пользователей. **Недостатки** этого варианта:

* Подключения для чтения и записи между экземплярами приложения и базой данных имеют разные задержки и стоимость.
* Во время сбоя затрагивается производительность приложения.

> [!NOTE]
> Подобный подход можно использовать для разгрузки специализированных рабочих нагрузок, например заданий по созданию отчетов, средств бизнес-аналитики или архивации. Обычно эти рабочие нагрузки используют значительные ресурсы базы данных, поэтому рекомендуется назначить для них одну из баз данных-получателей с уровнем производительности, соответствующим ожидаемой рабочей нагрузке.
>

## <a name="design-pattern-3-active-passive-deployment-for-data-preservation"></a>Модель разработки 3: активное — пассивное развертывание для сохранения данных
Этот вариант лучше всего подходит для приложений со следующими характеристиками:

* Любая потеря данных представляет собой большой риск для бизнеса. Отработка отказа базы данных может использоваться только в качестве последнего средства, когда сбой является катастрофическим.
* Приложение поддерживает режимы работы только для чтения и чтения-записи и может работать в режиме только для чтения в течение определенного периода времени.

В этом шаблоне приложение переключается в режим только для чтения, когда подключения для чтения и записи начинают получать ошибки времени ожидания. Веб-приложение развертывается в обоих регионах и включает подключение к конечной точке прослушивателя чтения и записи и другое подключение к конечной точке прослушивателя только для чтения. В диспетчере трафика следует настроить использование [маршрутизации отработки отказа](../traffic-manager/traffic-manager-configure-failover-routing-method.md) с [мониторингом конечных точек](../traffic-manager/traffic-manager-monitoring.md), включенным для конечной точки приложения в каждом регионе.

На следующей схеме показана эта конфигурация до сбоя.

![Активное — пассивное развертывание перед отработкой отказа. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-1.png)

Когда диспетчер трафика обнаруживает сбой подключения в регионе А, он автоматически переключает пользовательский трафик на экземпляр приложения в регионе Б. При использовании этого шаблона важно установить достаточно продолжительный льготный период до отработки отказа с потерей данных, например 24 часа. Это обеспечит предотвращение потери данных, если в течение этого времени сбой будет устранен. При активации веб-приложения в регионе Б операции чтения и записи будут завершаться сбоем. На этом этапе следует переключиться в режим только для чтения. В этом режиме запросы будут автоматически направляться в базу данных-получатель. Если сбой катастрофический, он не будет устранен в течении льготного периода, и группа отработки отказа активирует отработку отказа. После этого прослушиватель записи и чтения станет доступен и вызовы к нему перестанут завершаться сбоем. Это показано на следующей схеме.

![Сбой: приложение в режиме только для чтения. Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-2.png)

Если сбой в основном регионе устранен в течение льготного периода, диспетчер трафика определит восстановление возможности подключения в основном регионе и переключит трафик пользователей обратно на экземпляр приложения в регионе А. Этот экземпляр приложения возобновит работу и продолжит работать в режиме чтения и записи с помощью базы данных-источника в регионе А.

В случае сбоя в регионе Б диспетчер трафика обнаружит сбой конечной точки приложения в регионе Б и группа отработки отказа переключит прослушиватель только для чтений в регион А. Этот сбой не влияет на пользователя, но база данных-источник будет доступна во время сбоя. Это показано на следующей схеме.

![Сбой: база данных-получатель Аварийное восстановление облака.](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-3.png)

Как только сбой будет устранен, база данных-получатель немедленно синхронизируется с базой данных-источником и прослушиватель чтения и записи переключится обратно на базу данных-источник в регионе Б. Во время синхронизации производительность базы данных-получателя может незначительно ухудшиться в зависимости от объема данных для синхронизации.

Эта модель разработки имеет несколько **преимуществ**:

* Она позволяет избежать потери данных при временном сбое.
* Время простоя зависит только от того, как быстро диспетчер трафика обнаруживает сбой подключения. Этот параметр можно настроить.

**Компромисс**:

* Приложение должно поддерживать работу в режиме только для чтения.

> [!NOTE]
> В случае необратимого сбоя службы в регионе необходимо вручную активировать отработку отказа базы данных и принять потери данных. Приложение будет работать в дополнительном регионе с доступом к базе данных для чтения и записи.
>

## <a name="business-continuity-planning-choose-an-application-design-for-cloud-disaster-recovery"></a>Планирование непрерывности бизнеса-процессов: выбор проекта приложения для аварийного восстановления облака
В зависимости от выбранной стратегии аварийного восстановления облака вы можете объединить или расширить эти шаблоны проектирования для наилучшего соответствия требованиям приложения.  Как уже упоминалось, выбор стратегии зависит от соглашения об уровне обслуживания, предлагаемого клиентам, и топологии развертывания приложений. Чтобы помочь вам принять решение, в приведенной ниже таблице сравниваются варианты с учетом предполагаемой потери данных или целевой точки восстановления (RPO) и оценки времени восстановления (ERT).

| Модель | RPO | ERT |
|:--- |:--- |:--- |
| Активное — пассивное развертывание для аварийного восстановления с доступом к совмещенной базе данных |Доступ для чтения и записи < 5 секунд |Время обнаружения сбоя и срок жизни DNS |
| Активное — активное развертывание для балансировки нагрузки приложения |Доступ для чтения и записи < 5 секунд |Время обнаружения сбоя и срок жизни DNS |
| Активное — пассивное развертывание для сохранения данных |Доступ только для чтения < 5 с | Доступ только для чтения = 0 |
||Доступ только для чтения = 0 | Доступ только для чтения = время обнаружения сбоя + льготный период с потерей данных |
|||

## <a name="next-steps"></a>Дальнейшие действия
* Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь с разделом [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md)
* Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)
* Чтобы узнать об использовании создаваемых автоматически резервных копий для восстановления, ознакомьтесь с [восстановлением базы данных из резервных копий, инициируемых службой](sql-database-recovery-using-backups.md)
* Чтобы узнать о более быстрых вариантах восстановления, ознакомьтесь со сведениями об [активной георепликации](sql-database-geo-replication-overview.md).  
* Чтобы узнать об использовании автоматически создаваемых резервных копий для архивации, ознакомьтесь с [копированием базы данных](sql-database-copy.md)
* Сведения об использовании активной георепликации с пулами эластичных баз данных см. в статье [Стратегии аварийного восстановления для приложений с использованием пула эластичных баз данных SQL](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).

