---
title: База данных SQL Azure. Чтение запросов в репликах | Документация Майкрософт
description: База данных SQL Azure позволяет распределять рабочие нагрузки только для чтения, используя емкость реплик только для чтения (горизонтальное масштабирование для чтения).
services: sql-database
ms.service: sql-database
ms.subservice: scale-out
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: sstein, carlrab
manager: craigg
ms.date: 03/28/2019
ms.openlocfilehash: d9ad859ef24b51dc337dc23281d2fe4e1eada1e6
ms.sourcegitcommit: f8c592ebaad4a5fc45710dadc0e5c4480d122d6f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2019
ms.locfileid: "58619897"
---
# <a name="use-read-only-replicas-to-load-balance-read-only-query-workloads"></a>Использовать только для чтения для запроса только для чтения распределять рабочие нагрузки

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но все будущие разработки — для модуля Az.Sql. Для этих командлетов см. в разделе [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле Az и в модуле AzureRm практически идентичны.

Функция **Горизонтальное масштабирование для чтения** позволяет распределять рабочие нагрузки службы "База данных SQL Azure" только для чтения, используя емкость одной реплики только для чтения.

Все базы данных уровня "Премиум" ([модель приобретения на основе единиц DTU](sql-database-service-tiers-dtu.md)) или "Критически важный для бизнеса" ([модель приобретения на основе виртуальных ядер](sql-database-service-tiers-vcore.md)) автоматически подготавливаются с несколькими репликами AlwaysOn для поддержки соглашения об уровне обслуживания по доступности. Это показано на следующей схеме.

![Реплики только для чтения](media/sql-database-read-scale-out/business-critical-service-tier-read-scale-out.png)

Вторичные реплики, подготавливаются того же размера вычислений, что и первичная реплика. Благодаря функции **Горизонтальное масштабирование для чтения** можно распределять рабочие нагрузки базы данных SQL только для чтения за счет емкости одной из реплик только для чтения вместо совместного использования реплики для чтения и записи. Таким образом рабочая нагрузка только для чтения изолируется от главных рабочих нагрузок чтения и записи и не влияет на их производительность. Эта функция предназначена для приложений, в которые включены такие логически разделенные рабочие нагрузки только для чтения, как аналитика, и поэтому она может обеспечить повышение производительности с помощью этой дополнительной емкости без дополнительных затрат.

Чтобы использовать функции масштабирования чтения с определенной базы данных, необходимо явно включить его при создании базы данных, либо уже после этого путем изменения ее конфигурации с помощью PowerShell, вызвав [AzSqlDatabase набора](/powershell/module/az.sql/set-azsqldatabase) или [New AzSqlDatabase](/powershell/module/az.sql/new-azsqldatabase) командлетов или через REST API Azure Resource Manager с помощью [базы данных: Создание или обновление](https://docs.microsoft.com/rest/api/sql/databases/createorupdate) метод.

После включения масштабирование для чтения для базы данных приложений, подключающихся к базе данных, будет направляться шлюзом реплику чтения и записи или только для чтения реплики базы данных согласно `ApplicationIntent` свойства, настроенного в Строка подключения приложения. Дополнительные сведения о свойстве `ApplicationIntent` см. в разделе об [указании назначения приложения](https://docs.microsoft.com/sql/relational-databases/native-client/features/sql-server-native-client-support-for-high-availability-disaster-recovery#specifying-application-intent).

Если масштабирование для чтения отключено или установлено свойство ReadScale на уровне служб, который не поддерживается, то все подключения направляются к реплике для чтения и записи независимо от свойства `ApplicationIntent`.

> [!NOTE]
> Запрос данных Store, расширенных событий, SQL Profiler и функции аудита не поддерживаются в репликах только для чтения. 
## <a name="data-consistency"></a>Согласованность данных

Одним из преимуществ реплик является то, что реплики всегда находятся в состоянии транзакционной согласованности, но в разные моменты времени может возникать небольшая задержка между различными репликами. Горизонтальное масштабирование для чтения поддерживает согласованность на уровне сеанса. Это значит, что если сеанс только для чтения будет повторно подключаться после ошибки подключения, которая была вызвана недоступностью реплики, он может быть перенаправлен к реплике, которая не полностью синхронизирована с текущей репликой для чтения и записи. Аналогично Если приложение записывает данные с помощью сеанса чтения и записи и сразу же считывает их с помощью сеанса только для чтения, это возможно, что последние обновления, не видны сразу в реплике. Задержка вызвана операцию повтора журнала асинхронных транзакций.

> [!NOTE]
> Задержки репликации в пределах региона случаются крайне редко.

## <a name="connect-to-a-read-only-replica"></a>Подключение к реплике только для чтения

При включении для базы данных горизонтального масштабирования для чтения предоставляемый клиентом параметр `ApplicationIntent` в строке подключения определяет, куда направляется подключение: к реплике для записи или к реплике только для чтения. В частности, если значение `ApplicationIntent` — `ReadWrite` (по умолчанию), подключение направляется к реплике базы данных для чтения и записи. Также происходит и без этой функции. Если значение `ApplicationIntent` — `ReadOnly`, подключение направляется к реплике, доступной только для чтения.

Например, следующая строка подключения позволяет подключить клиента к реплике только для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```SQL
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadOnly;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

Обе приведенные ниже строки подключения подключают подключить клиента к реплике для чтения и записи (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```SQL
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadWrite;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;

Server=tcp:<server>.database.windows.net;Database=<mydatabase>;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

## <a name="verify-that-a-connection-is-to-a-read-only-replica"></a>Убедитесь, что подключение выполняется к реплике только для чтения

Можно проверить, подключены ли вы к реплике только для чтения, выполнив приведенный ниже запрос. Он возвращает READ_ONLY при подключении к реплике только для чтения.

```SQL
SELECT DATABASEPROPERTYEX(DB_NAME(), 'Updateability')
```

> [!NOTE]
> В отдельно взятый момент времени только одна из реплик AlwaysON доступна в сеансах только для чтения.

## <a name="monitoring-and-troubleshooting-read-only-replica"></a>Мониторинг и устранение неполадок реплика только для чтения

При подключении к реплике только для чтения, доступны метрики производительности с помощью `sys.dm_db_resource_stats` динамического административного Представления. Для доступа к статистике плана запросов, используйте `sys.dm_exec_query_stats`, `sys.dm_exec_query_plan` и `sys.dm_exec_sql_text` динамических административных представлений.

> [!NOTE]
> Динамическое административное Представление `sys.resource_stats` в логической базе данных master возвращает ЦП использования и хранилища данных первичной реплики.


## <a name="enable-and-disable-read-scale-out"></a>Включение и отключение горизонтального масштабирования для чтения

Горизонтальное масштабирование для чтения по умолчанию включено для [Управляемого экземпляра](sql-database-managed-instance.md) уровня "Критически важный для бизнеса". Оно должно быть явно включено на уровнях "Премиум" или "Критически важный для бизнеса" для [базы данных, размещенной на сервере Базы данных SQL](sql-database-servers.md). Ниже описаны методы включения и отключения горизонтального масштабирования для чтения.

### <a name="powershell-enable-and-disable-read-scale-out"></a>PowerShell: Включение и отключение горизонтального масштабирования для чтения

Для управления горизонтальным масштабированием для чтения в Azure PowerShell требуется выпуск Azure PowerShell за декабрь 2016 года или более поздней версии. Последнюю версию Azure PowerShell см. [здесь](https://docs.microsoft.com/powershell/azure/install-az-ps).

Включить или отключить масштабирование для чтения в Azure PowerShell, вызвав [набора AzSqlDatabase](/powershell/module/az.sql/set-azsqldatabase) командлета и передавая нужное значение — `Enabled` или `Disabled` --для `-ReadScale` параметра. Кроме того, можно использовать [New AzSqlDatabase](/powershell/module/az.sql/new-azsqldatabase) командлет, чтобы создать новую базу данных с помощью чтения поддержкой функции горизонтального масштабирования.

Например, чтобы включить для имеющейся базы данных функцию горизонтального масштабирования для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <myresourcegroup> -ServerName <myserver> -DatabaseName <mydatabase> -ReadScale Enabled
```

Чтобы отключить для имеющейся базы данных функцию горизонтального масштабирования для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <myresourcegroup> -ServerName <myserver> -DatabaseName <mydatabase> -ReadScale Disabled
```

Чтобы создать базу данных с поддержкой функции горизонтального масштабирования для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```powershell
New-AzSqlDatabase -ResourceGroupName <myresourcegroup> -ServerName <myserver> -DatabaseName <mydatabase> -ReadScale Enabled -Edition Premium
```

### <a name="rest-api-enable-and-disable-read-scale-out"></a>REST API: Включение и отключение горизонтального масштабирования для чтения

Чтобы создать базу данных с поддержкой функции горизонтального масштабирования для чтения, включить или отключить эту функцию для имеющейся базы данных, создайте или обновите соответствующую сущность базы данных, задав для свойства `readScale` значение `Enabled` или `Disabled`, как в приведенном ниже примере запроса.

```rest
Method: PUT
URL: https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{GroupName}/providers/Microsoft.Sql/servers/{ServerName}/databases/{DatabaseName}?api-version= 2014-04-01-preview
Body:
{
   "properties":
   {
      "readScale":"Enabled"
   }
}
```

Дополнительные сведения см. в статье о [создании или обновлении базы данных](https://docs.microsoft.com/rest/api/sql/databases/createorupdate).

## <a name="using-tempdb-on-read-only-replica"></a>С помощью базы данных TempDB на реплики только для чтения

База данных TempDB не реплицируется на реплики только для чтения. Каждая реплика имеет свою собственную версию базы данных TempDB, который создается при создании реплики. Это гарантирует, что база данных TempDB может обновляться и могут быть изменены во время выполнения запроса. Если рабочая нагрузка только для чтения зависит от того, с помощью объектов базы данных TempDB, следует создать эти объекты как часть сценария запроса. 

## <a name="using-read-scale-out-with-geo-replicated-databases"></a>Использование горизонтального масштабирования для чтения с геореплицированными базами данных

Если масштабирование для чтения используется для загрузки баланс рабочих нагрузок только для чтения базы данных, которая выполняется георепликация (например, в качестве члена группы отработки отказа), убедитесь, что масштабирование для чтения включена на сервере-источнике и географически реплицированных баз данных-получателей. Эта конфигурация гарантирует, что те же возможности балансировки нагрузки продолжает, когда приложение подключается к новой первичной реплики после отработки отказа. Если подключение к геореплицированной базе данных-получателю выполняется с включенной функцией масштабирования для чтения, ваши сеансы с `ApplicationIntent=ReadOnly` будут направляться в одну из реплик, так же как и в случае с маршрутизацией подключений к базе данных-источнику.  Сеансы без `ApplicationIntent=ReadOnly` будут направляться в первичную реплику геореплицированной базы данных-получателя (тоже только для чтения). Так как геореплицированная база данных-получатель и база данных-источник имеют разные конечные точки, раньше для доступа к получателю не требовалось настраивать `ApplicationIntent=ReadOnly`. Для обеспечения обратной совместимости в динамическом административном представлении `sys.geo_replication_links` отображается `secondary_allow_connections=2` (разрешены любые подключения клиента).

> [!NOTE]
> Циклический перебор или другие с балансировкой нагрузки маршрутизации между локальной реплики базы данных-получателя не поддерживается.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об использовании PowerShell для задания масштабирование для чтения, см. в разделе [набора AzSqlDatabase](/powershell/module/az.sql/set-azsqldatabase) или [New AzSqlDatabase](/powershell/module/az.sql/new-azsqldatabase) командлетов.
- Дополнительные сведения об использовании интерфейса REST API для включения функции горизонтального масштабирования для чтения см. в [этой статье](https://docs.microsoft.com/rest/api/sql/databases/createorupdate).
