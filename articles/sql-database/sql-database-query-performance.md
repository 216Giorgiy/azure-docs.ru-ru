<properties 
   pageTitle="Анализ производительности запросов базы данных Azure SQL" 
   description="Мониторинг производительности запросов определяет запросы, максимально использующие ресурсы процессора, в базе данных SQL Azure." 
   services="sql-database" 
   documentationCenter="" 
   authors="stevestein" 
   manager="jeffreyg" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="data-management" 
   ms.date="02/03/2015"
   ms.author="sstein"/>

# Анализ производительности запросов базы данных Azure SQL


Управление производительностью реляционных баз данных и ее настройка являются сложной задачей, требующей значительного опыта и времени. Анализ производительности запросов позволяет тратить меньше времени на устранение неполадок с производительностью базы данных, предоставляя следующие возможности:

- Более глубокое понимание потребления ресурсов базы данных (DTU). 
- Определение запросов, максимально использующих ресурсы процессора. Этот показатель можно настроить и улучшить производительность. 
- Возможность получить подробные сведения о запросе.

## Предварительные требования

- Анализ производительности запросов доступен только с базой данных SQL Azure версии 12.
- Для анализа производительности запросов в базе данных должно быть запущено [хранилище запросов](https://msdn.microsoft.com/library/dn817826.aspx). Если хранилище запросов еще не запущено, портал предложит вам его включить.

 
## Разрешения

Для использования анализа производительности запросов необходимо [управление доступом на основе ролей](role-based-access-control-configure.md) с такими разрешениями:

- разрешения **читатель**, **владелец**, **участник**, **участник базы данных SQL** или **участник сервера SQL Server** для просмотра основных ресурсов, потребляющих запросы и диаграммы; 
- разрешения **владелец**, **участник**, **участник базы данных SQL** или **участник сервера SQL Server** для просмотра текста запросов.



## Использование анализа производительности запросов

Анализ производительности запросов легко использовать:

- Просмотрите список самых ресурсоемких запросов. 
- Выберите отдельный запрос, чтобы просмотреть сведения о нем.
- Щелкните **Параметры**, чтобы настроить отображение данных или отобразить другой момент времени.
- Откройте [Помощник по индексу](sql-database-index-advisor.md) и проверьте наличие каких-либо рекомендаций.



> [AZURE.NOTE] Хранилище запросов должно сохранить несколько часов данных, чтобы база данных SQL могла предоставить анализ производительности запросов. Если в базе данных нет активности или хранилище запросов было неактивно в течение определенного времени, диаграммы не будут содержать данные этого периода. Можно включить хранилище запросов в любой момент, если оно не запущено.



## Просмотр запросов, максимально использующих ресурсы процессора

На [портале](http://portal.azure.com) выполните следующие действия.

1. Перейдите к базе данных SQL и выберите элемент **Анализ производительности запросов**. 

    ![Анализ производительности запросов][1]

    Откроется представление популярных запросов и список запросов, наиболее активно использующих ресурсы процессора.

1. Щелкните диаграмму, чтобы просмотреть подробные сведения.<br>Верхняя строка показывает общий процент DTU для базы данных, а полосы — процент ресурсов процессора, использованных выбранными запросами за нужный период времени (например, если выбрана **Прошлая неделя**, каждая полоса соответствует одному дню).

    ![наиболее ресурсоемкие запросы][2]

    В приведенной ниже таблице представлены сводные данные по видимым запросам.

    -	Средняя загрузка ЦП на запрос за период наблюдения. 
    -	Общая длительность каждого запроса.
    -	Общее число выполнений определенного запроса.


	Выделите отдельные запросы или отмените их выделение, чтобы включить их в диаграмму или исключить из нее.


1. Если данные устарели, нажмите кнопку **Обновить**.
1. Либо щелкните **Параметры**, чтобы настроить отображение данных об использовании ресурсов процессора или отобразить другой период времени.

    ![Параметры](./media/sql-database-query-performance/settings.png)

## Просмотр подробных сведений для отдельного запроса

Чтобы просмотреть сведения о запросе, выполните следующие действия.

1. Щелкните любой запрос в списке популярных запросов.

    ![сведения](./media/sql-database-query-performance/details.png)

4. Откроется представление сведений, в котором использование ресурсов процессора запросами разбито по времени.
3. Щелкните диаграмму для получения сведений.<br>Верхняя строка показывает общий процент DTU, а полосы процент ресурсов процессора, используемых выбранным запросом.
4. Изучите данные, чтобы увидеть подробные показатели, в том числе длительность, количество выполнений, процент использования ресурсов для каждого интервала, в течение которого выполнялся запрос.
    
    ![сведения о запросе][3]

1. Либо щелкните **Параметры**, чтобы настроить отображение данных об использовании ресурсов процессора или отобразить другой период времени.


## 	Оптимизация конфигурации хранилища запросов для анализа производительности запросов

При работы с анализом производительности запросов хранилище запросов может выдавать следующие сообщения:

- "Хранилище запросов достигло максимальной емкости и не собирает новые данные".
- "Хранилище запросов для этой базы данных находится в режиме только для чтения и не собирает данные о производительности".
- "Параметры хранилища запросов не оптимальны для анализа производительности запросов".

Обычно эти сообщения отображаются, когда хранилище запросов не может собирать новые данные. Устранить эту проблему можно одним из следующих способов:

-	изменить политику хранения и отслеживания хранилища запросов;
-	увеличить размер хранилища запросов; 
-	очистить хранилище запросов.

### Рекомендуемая политика хранения и отслеживания

Политики хранения бывают двух видов.

- На основе размера: если имеет значение AUTO, по достижении максимального размера хранилища данные автоматически удаляются.
- На основе времени: по умолчанию имеет значение 30 дней, означающее, что если в хранилище запросов закончится место, данные запросов старше 30 дней будут удалены. 

Для политики отслеживания доступны следующие параметры.

- **ALL**: перехватываются все запросы. Это вариант по умолчанию.
- **AUTO**: редкие запросы и запросы с незначительным временем компиляции и выполнения игнорируются. Пороговые значения счетчика, а также времени компиляции и выполнения определяются внутренним образом.
- **NONE**: хранилище запросов не отслеживает новые запросы.
	
Рекомендуем выбрать для всех политик параметр AUTO и настроить удаление через 30 дней:

    ALTER DATABASE [YourDB] 
    SET QUERY_STORE (SIZE_BASED_CLEANUP_MODE = AUTO);
    	
    ALTER DATABASE [YourDB] 
    SET QUERY_STORE (CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 30));
    
    ALTER DATABASE [YourDB] 
    SET QUERY_STORE (QUERY_CAPTURE_MODE = AUTO);

Увеличение размера хранилища запросов. Для этого нужно подключиться к базе данных и отправить следующий запрос:

    ALTER DATABASE [YourDB]
    SET QUERY_STORE (MAX_STORAGE_SIZE_MB = 1024);

При очистке хранилища запросов из него удаляются все хранящиеся в нем данные.

    ALTER DATABASE [YourDB] SET QUERY_STORE CLEAR;


## Сводка

Анализ производительности запросов помогает понять влияние рабочей нагрузки запросов и его связь с потреблением ресурсов базы данных. Благодаря этой функции можно узнать о наиболее ресурсоемких запросах и легко определить запросы, которые нужно исправить, прежде чем они станут проблемными. Щелкните элемент **Анализ производительности запросов** в базе данных, чтобы увидеть наиболее ресурсоемкие запросы.




## Дальнейшие действия

Рабочие нагрузки базы данных являются динамическими и меняются непрерывно. Отслеживайте запросы и продолжайте их настраивать для повышения производительности.

Для получения дополнительных рекомендаций по повышению производительности базы данных SQL щелкните [Помощник по индексу](sql-database-index-advisor.md) в колонке **Анализ производительности запросов**.

![Помощник по индексу](./media/sql-database-query-performance/ia.png)


<!--Image references-->
[1]: ./media/sql-database-query-performance/tile.png
[2]: ./media/sql-database-query-performance/top-queries.png
[3]: ./media/sql-database-query-performance/query-details.png

<!---HONumber=AcomDC_0204_2016-->