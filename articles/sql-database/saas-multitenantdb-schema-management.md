---
title: "Управление схемой базы данных SQL Azure в примере мультитенантного приложения | Документация Майкрософт"
description: "Управление схемой для нескольких клиентов в мультитенантном приложении, использующем базу данных SQL Azure"
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/14/2017
ms.author: billgib
ms.openlocfilehash: e4b8e38d20ec408869f2228597afdf2f9620515b
ms.sourcegitcommit: f847fcbf7f89405c1e2d327702cbd3f2399c4bc2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2017
---
# <a name="manage-schema-for-multiple-tenants-in-a-multi-tenant-application-that-uses-azure-sql-database"></a>Управление схемой для нескольких клиентов в мультитенантном приложении, использующем Базу данных SQL Azure

В [первом руководстве по SaaS-приложению Wingtip Tickets c мультитенантной базой данных](saas-multitenantdb-get-started-deploy.md) показано, как приложение может подготовить сегментированную мультитенантную базу данных и зарегистрировать ее в каталоге. Как и любое приложение, SaaS-приложение Wingtip Tickets будет развиваться со временем и иногда будет требовать изменений в базе данных, таких как новые или измененные схемы, справочные данные и стандартные задачи обслуживания баз данных для обеспечения оптимальной производительности приложения. С приложением SaaS эти изменения необходимо развертывать скоординировано в потенциально большом количестве баз данных клиентов. Чтобы эти изменения были внесены в будущие базы данных клиентов, их нужно включить в процесс подготовки.

В этом руководстве рассматривается два сценария: развертывание обновления справочных данных на всех клиентах и перенастройка индекса для таблицы, содержащей справочные данные. [Задания обработки эластичных баз данных](sql-database-elastic-jobs-overview.md) используются для выполнения этих операций во всех базах данных клиентов, а *"золотая"* база данных клиента используется как шаблон для новых баз данных.

Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]

> * Создание учетной записи заданий.
> * Выполнение запроса к нескольким клиентам.
> * Обновление данных во всех клиентских базах данных.
> * Создание индекса для таблицы во всех базах данных клиента.


Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS-приложение Wingtip Tickets c мультитенантной БД. Вы можете развернуть его менее чем за пять минут, используя инструкцию из статьи [Deploy and explore a sharded multi-tenant application that uses Azure SQL Database](saas-multitenantdb-get-started-deploy.md) (Развертывание и изучение сегментированного мультитенантного приложения, использующего Базу данных SQL Azure).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).
* Установите последнюю версию SQL Server Management Studio (SSMS). [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms) (Скачивание SQL Server Management Studio (SSMS))

> [!NOTE]
> В этом руководстве используются функции службы базы данных SQL в ограниченной предварительной версии (задания обработки эластичных баз данных). Если вы хотите пройти это руководство, отправьте идентификатор вашей подписки по адресу SaaSFeedback@microsoft.com с темой "Задания обработки эластичных баз данных (предварительная версия)". Получив подтверждение о включении подписки, [скачайте и установите предварительную версию командлетов заданий](https://github.com/jaredmoo/azure-powershell/releases). Это ограниченная предварительная версия, поэтому если у вас возникнут вопросы или необходимость получить поддержку, напишите по адресу SaaSFeedback@microsoft.com.


## <a name="introduction-to-saas-schema-management-patterns"></a>Общие сведения о шаблонах управления схемой SaaS

Благодаря модели сегментированной мультитенантной базы данных, используемой в этом примере, база данных может содержать любое количество клиентов. В этом примере рассматривается возможность использования комбинации мультитенантных и однотенантных баз данных, что обеспечивает "гибридную" модель управления клиентами. Обслуживать такие базы данных и управлять ими довольно сложно. [Задания обработки эластичных БД](sql-database-elastic-jobs-overview.md) упрощают администрирование уровня данных SQL и управление им. Задания позволяют вам безопасно и надежно выполнять задачи (скрипты T-SQL) в группах баз данных независимо от действий пользователя. Этот метод можно использовать для развертывания схемы и обычных изменений справочных данных по всем клиентам в приложении. Задания обработки эластичных БД также могут использоваться для обслуживания *"золотой"* копии базы данных, которая используется для создания клиентов, обеспечивая ее самыми последними схемами и справочными данными.

![экран](media/saas-multitenantdb-schema-management/schema-management.png)

## <a name="elastic-jobs-limited-preview"></a>Ограниченная предварительная версия заданий обработки эластичных БД

Существует новая версия заданий обработки эластичных БД, которая является интегрированным компонентом баз данных SQL и не требует дополнительных служб или компонентов. Сейчас новая версия заданий обработки эластичных БД находится на этапе ограниченной предварительной версии. Эта ограниченная предварительная версия поддерживает создание учетных записей заданий для PowerShell и создание и управление заданиями для T-SQL.

## <a name="get-the-wingtip-tickets-saas-multi-tenant-database-application-source-code-and-scripts"></a>Получение скриптов и исходного кода для SaaS-приложения Wingtip Tickets c мультитенантной БД

Сценарии для приложения SaaS Wingtip Tickets c мультитенантной базой данных и исходный код этого приложения вы найдете в репозитории GitHub [WingtipTicketsSaaS-MultitenantDB](https://github.com/microsoft/WingtipTicketsSaaS-MultiTenantDB). Инструкции по скачиванию и разблокированию сценариев приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md). 

## <a name="create-a-job-account-database-and-new-job-account"></a>Создание базы данных учетных записей заданий и учетной записи задания

В этом руководстве требуется создать базу данных учетных записей задания и учетную запись с помощью PowerShell. Подобно MSDB и агенту SQL, задания обработки эластичных БД используют базу данных SQL Azure для хранения определений заданий, сведений об их состоянии и журнала. Создав учетную запись задания, вы можете сразу создавать и отслеживать задания.

1. **В интегрированной среде сценариев PowerShell** откройте файл *…\\Learning Modules\\Schema Management\\Demo-SchemaManagement.ps1*.
1. Нажмите клавишу **F5** для запуска скрипта.

Скрипт *Demo-SchemaManagement.ps1* вызовет скрипт *Deploy-SchemaManagement.ps1* для создания базы данных *S2* с именем **jobaccount** в каталоге сервера. Затем он создаст учетную запись задания, передавая базу данных jobaccount как параметр для вызова создания учетной записи задания.

## <a name="create-a-job-to-deploy-new-reference-data-to-all-tenants"></a>Создание задания и развертывание новых справочных данных на всех клиентах

Каждая база данных клиентов включает набор типов объектов в таблице **VenueTypes**, которые определяют вид событий, проводимых на том или ином объекте. В этом упражнении вы развернете обновление во всех базах данных, чтобы добавить два дополнительных типа объектов: *Motorcycle Racing* (Мотогонки) и *Swimming Club* (Клуб плавания). Эти типы объектов соответствуют фоновому изображению, которое отображается в приложении событий клиента.

Щелкните раскрывающееся меню с типами объектов и убедитесь, что доступно только 10 из них, а вариантов "Мотоциклетные гонки" и "Плавательный клуб" нет в списке.

Давайте создадим задание для обновления таблицы **VenueTypes** во всех базах данных клиентов и добавим новые типы объектов.

Чтобы создать задание, мы используем набор системно хранимых процедур заданий, созданный в базе данных jobaccount при создании учетной записи задания.

1. В среде SSMS подключитесь к серверу клиента: tenants1-mt-\<пользователь\>.database.windows.net
2. Перейдите к базе данных *tenants1* на сервере *tenants1-mt-\<пользователь\>.database.windows.net* и запросите таблицу *VenueTypes*, чтобы убедиться, что *Motorcycle Racing* и *Swimming Club* **отсутствуют** в списке результатов.
3. Подключитесь к серверу каталогов: catalog-mt-\<пользователь\>.database.windows.net
4. Подключитесь к базе данных jobaccount на сервере каталогов.
5. В среде SSMS откройте файл …\\Learning Modules\\Schema Management\\DeployReferenceData.sql.
6. Измените инструкцию: set @User = &lt;пользователь&gt;, заменив значение "пользователь" значением, использованным при развертывании SaaS-приложения Wingtip Tickets c мультитенантной базой данных.
7. Нажмите клавишу **F5** для запуска скрипта.

В сценарии *DeployReferenceData.sql* обратите внимание на следующее:
* **sp\_add\_target\_group** создает целевую группу с именем DemoServerGroup. Теперь добавьте целевые элементы в группу.
* **sp\_add\_target\_group\_member** добавляет тип целевого элемента *server* (сервер). При этом считается, что все базы данных на этом сервере (обратите внимание, что сервер tenants1-mt-&lt;пользователь&gt; содержит базу данных клиентов) во время выполнения задания должны быть включены в задание. Также эта процедура добавляет тип целевого элемента *database* для "золотой" базы данных (basetenantdb), которая находится на сервере catalog-mt-&lt;пользователь&gt;, и, наконец, тип целевого элемента *database* для включения базы данных adhocreporting, которая будет использоваться в последующем руководстве.
* **sp\_add\_job** создает задание с названием Reference Data Deployment (Развертывание эталонных данных).
* **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления ссылочной таблицы VenueTypes.
* Остальные представления в скрипте отображают сведения о существовании объектов и отслеживают выполнение задания мониторинга. С помощью этих запросов можно просмотреть значение состояния в столбце **lifecycle**, чтобы определить, когда задание будет успешно завершено в базе данных клиентов и двух дополнительных базах данных, содержащих ссылочную таблицу.

В среде SSMS перейдите к базе данных клиента на сервере *tenants1-mt-&lt;пользователь&gt;* и запросите таблицу *VenueTypes*, чтобы убедиться, что *Motorcycle Racing* и *Swimming Club* **добавлены* в таблицу.


## <a name="create-a-job-to-manage-the-reference-table-index"></a>Создание задания для управления индексом справочной таблицы

Как и предыдущее упражнение, это упражнение создает задание для пересоздания индекса первичного ключа справочной таблицы — обычная операция управления базой данной, которую администратор может выполнить после передачи больших объемов данных в таблицу.


1. В среде SSMS подключитесь к базе данных jobaccount на сервере catalog-mt-&lt;пользователь&gt;.database.windows.net.
2. В среде SSMS откройте файл …\\Learning Modules\\Schema Management\\OnlineReindex.sql.
3. Нажмите клавишу **F5** для запуска скрипта.

В сценарии *OnlineReindex.sql* обратите внимание на следующее:
* **sp\_add\_job** создает новое задание с именем Online Reindex PK\_\_VenueTyp\_\_265E44FD7FD4C885.
* **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления индекса.
* Остальные представления в скрипте отслеживают выполнение задания. С помощью этих запросов можно просмотреть значение состояния в столбце **lifecycle**, чтобы определить, когда задание будет успешно завершено во всех целевых элементах группы.

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]

> * Создание учетной записи заданий для запроса нескольких клиентов.
> * Обновление данных во всех клиентских базах данных.
> * Создание индекса для таблицы во всех базах данных клиента.

Далее см. статью [Выполнение запросов автоматизированной системы отчетности к нескольким базам данных SQL Azure](saas-multitenantdb-adhoc-reporting.md).


## <a name="additional-resources"></a>Дополнительные ресурсы

<!--* Additional tutorials that build upon the Wingtip Tickets SaaS Multi-tenant Database application deployment (*Tutorial link to come*)
(saas-multitenantdb-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)-->
* [Управление масштабируемыми облачными базами данных](sql-database-elastic-jobs-overview.md)
* [Создание развернутых баз данных SQL Azure и управление ими с помощью заданий обработки эластичных БД (предварительная версия)](sql-database-elastic-jobs-create-and-manage.md)
