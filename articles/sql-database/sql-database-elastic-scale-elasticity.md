<properties 
	pageTitle="Эластичность сегментов" 
	description="Объясняет основные понятия и содержит примеры эластичности сегментов, которая дает возможность легко масштабировать базы данных SQL Azure." 
	services="sql-database" 
	documentationCenter="" 
	manager="jeffreyg" 
	authors="sidneyh" 
	editor=""/>

<tags 
	ms.service="sql-database" 
	ms.workload="sql-database" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/17/2015" 
	ms.author="sidneyh"/>

# Эластичность сегментов 

**Эластичность сегментов** позволяет разработчикам приложений динамически увеличивать и уменьшать ресурсы базы данных в соответствии с потребностями, при этом можно оптимизировать производительность приложений, а также минимизировать затраты. **Инструменты эластичных баз данных** SQL Azure в сочетании с [уровнями служб Basic, Standard и Premium](http://msdn.microsoft.com/library/azure/dn741340.aspx) позволяют получить очень удобные сценарии эластичности. Средства работы с эластичными базами данных предоставляет возможность выполнять горизонтальное масштабирование. Это шаблон проектирования, в котором базы данных (также [известные как "сегменты"](sql-database-elastic-scale-glossary.md)) добавляются или удаляются из набора сегментов для увеличения или уменьшения вместимости. Аналогичным образом уровни служб базы данных SQL обеспечивают возможности **вертикального масштабирования**. Это означает, что для ресурсов отдельной базы данных можно увеличивать или уменьшать масштаб в соответствии с потребностями. Совместное применение вертикального масштабирования одного сегмента и горизонтального масштабирования множества сегментов предоставляет разработчикам приложений возможность создать чрезвычайно гибкую среду, масштабируемую в соответствии с потребностями в производительности, вместимости и оптимизации затрат.

Возможности новых **пулов эластичных баз данных** максимально упрощают вертикальное масштабирование. Пулы позволяют увеличивать или уменьшать потребление ресурсов отдельных баз данных *автоматически* в рамках общего бюджета группы. В данной статье описываются другие методы реализации механизма на основе политик управления вертикальным масштабированием, а также некоторые общие сценарии для автоматизации операций горизонтального масштабирования для приложений, в которых не используются преимущества пулов эластичных баз данных.

## Пример горизонтального масштабирования: пиковый спрос на билеты

Традиционный сценарий горизонтального масштабирования представляет приложение, обрабатывающее транзакции, связанные с билетами на концерты. При обычном количестве клиентов приложение использует минимальный объем ресурсов базы данных для обработки операций покупки. Но если в продажу поступают билеты на популярный концерт, отдельная база данных не может справиться с пиковым спросом клиентов.

Чтобы обработать транзакции в значительно увеличившемся количестве, выполняется горизонтальное масштабирование приложения. Теперь приложение может распределять нагрузку, связанную с транзакциями, по нескольким сегментам. Если потребность в дополнительных ресурсах исчезает, уменьшается масштаб уровня баз данных, и приложение возвращается к обычной работе. В этом случае горизонтальное масштабирование позволяет приложению увеличивать масштабирование в соответствии со спросом клиентов и уменьшать его, если ресурсы уже не нужны.

## Пример вертикального масштабирования: телеметрия

Традиционный сценарий вертикального масштабирования представляет приложение, которое использует **набор сегментов** для хранения данных оперативной телеметрии. При таком сценарии все данные телеметрии за один день удобнее размещать в одном сегменте. В этом приложении данные за текущий день принимаются в определенный сегмент, а для последующих дней готовится новый сегмент. Затем рабочие данные можно рассматривать как устаревшие или запрашивать их по мере необходимости.

Для приема данных телеметрии при высоких нагрузках предпочтительнее использовать более высокий уровень служб. Другими словами, база данных уровня Premium лучше базы данных уровня Basic. Как только достигается предельное значение вместимости базы данных, она переключается с приема данных на анализ и отчетность. С этой целью задаче соответствует производительность уровня Standard. Таким образом можно выполнить вертикальное масштабирование, чтобы снизить уровень служб для сегментов (кроме сегмента, созданного последним) в соответствии с более низким требованиями по производительности для старых данных.

Вертикальное масштабирование также может применяться для повышения производительности отдельной базы данных, чтобы повысить общую производительность. Рассмотрим пример приложения для оформления налоговых деклараций. Во время формирования данные одного клиента лучше хранить в одной базе данных и повысить производительность этого сегмента. В зависимости от приложения, вертикальное масштабирование с увеличением и уменьшением выделения ресурсов полезно для оптимизации требований как к стоимости, так и к производительности.

Сочетание горизонтального и вертикального масштабирования на уровне баз данных является основой масштабируемости для приложений и эластичности сегментов.

В данном документе предоставляется контекст для сценариев эластичности сегментов, а также ссылки на примеры реализации вертикального и горизонтального масштабирования.

## Механизм эластичности сегментов 

Вертикальное и горизонтальное масштабирование – это функция трех основных компонентов:

1. **Телеметрия**
2. **Правило**
3. **Действие**   

## Телеметрия

**Эластичность, определяемая данными**, составляет основу эластичного масштабирования приложений. Телеметрия используется, чтобы на основе данных принимать решения о необходимости вертикального или горизонтального масштабирования в зависимости от требований к производительности.

#### Источники данных телеметрии
В случае базы данных SQL Azure существует несколько основных источников, которые можно использовать в качестве источников данных эластичного сегментирования.

1. **Телеметрия производительности** предоставляется с пятиминутными интервалами в представлении **sys.resource\_stats**. 
2. Почасовые **данные телеметрии вместимости базы** данных предоставляются в представлении **sys.resource\_usage**.  

Производительность использования ресурсов можно проанализировать, опрашивая главную БД с использованием следующего запроса, где Shard\_20140623 – имя целевой базы данных.

    SELECT TOP 10 *  
    FROM sys.resource_stats  
    WHERE database_name = 'Shard_20140623'  
    ORDER BY start_time DESC 

**Данные телеметрии** производительности можно подытожить за определенный период времени (семь дней в запросе, приведенном ниже), чтобы устранить неустановившиеся характеристики.

    SELECT  
    avg(avg_cpu_percent) AS 'Average CPU Utilization In Percent', 
        max(avg_cpu_percent) AS 'Maximum CPU Utilization In Percent', 
        avg(avg_physical_data_read_percent) AS 'Average Physical Data Read Utilization In Percent', 
        max(avg_physical_data_read_percent) AS 'Maximum Physical Data Read Utilization In Percent', 
        avg(avg_log_write_percent) AS 'Average Log Write Utilization In Percent', 
        max(avg_log_write_percent) AS 'Maximum Log Write Utilization In Percent', 
        avg(active_session_count) AS 'Average # of Sessions', 
        max(active_session_count) AS 'Maximum # of Sessions', 
        avg(active_worker_count) AS 'Average # of Workers', 
        max(active_worker_count) AS 'Maximum # of Workers' 
    FROM sys.resource_stats  
    WHERE database_name = ' Shard_20140623' AND start_time > DATEADD(day, -7, GETDATE()); 

**Вместимость базы** данных можно измерять с помощью подобного запроса к представлению **sys.resource\_usage**. Максимальное значение столбца **storage\_in\_megabytes** дает текущий объем базы данных. Такие данные телеметрии полезны для горизонтального масштабирования приложения, если для определенного сегмента достигается предел вместимости.

    SELECT TOP 10 * 
    FROM [sys].[resource_usage] 
    WHERE database_name = 'Shard_20140623'  
    ORDER BY time DESC 

По мере поступления данных в определенный сегмент желательно составить прогноз на следующий день и определить, насколько вместимость сегмента достаточна для обработки предстоящей рабочей нагрузки. Хотя это и не настоящая реализация линейной регрессии, следующий запрос возвращает значение максимальной разницы вместимости базы данных за два последовательных дня. После этого такие данные телеметрии можно применять к правилу, которое будет реализовано действием (или бездействием).

    WITH MaxDatabaseDailySize AS( 
        SELECT 
            ROW_NUMBER() OVER (ORDER BY convert(date, [time]) DESC) as [Order], 
            CONVERT(date,[time]) as [date],  
            MAX(storage_in_megabytes) as [MaxSizeDay] 
        FROM [sys].[resource_usage] 
        WHERE  
            database_name = 'Shard_20140623' 
        GROUP BY CONVERT(date,[time]) 
        ) 
    
    SELECT 
        MAX(ISNULL(Size.[MaxSizeDay] - PreviousDaySize.[MaxSizeDay], 0)) 
    FROM  
        MaxDatabaseDailySize Size INNER JOIN 
        MaxDatabaseDailySize PreviousDaySize ON Size.[order]+1 = PreviousDaySize.[order] 
    WHERE 
        Size.[order] < 8 

## правило;  

Правило является механизмом принятия решений, который определяет необходимость выполнения действия. Некоторые правила очень просты, некоторые намного сложнее. Как показано в следующем фрагменте кода, правило, ориентированное на вместимость, можно составить так, чтобы при достижении значения $SafetyMargin для сегмента, например 80 % от максимальной вместимости, подготавливался новый сегмент.

    # Determine if the current DB size plus the maximum daily delta size is greater than the threshold 
    if( ($CurrentDbSizeMb + $MaxDbDeltaMb) -gt ($MaxDbSizeMb * $SafetyMargin))  
    {#provision new shard} 

Учитывая вышеупомянутые источники данных, можно составить ряд правил для реализации многочисленных сценариев эластичности сегментов.

## Действие  

В зависимости от результата выполнения правила следует действие (или бездействие). Чаще всего нужно сделать следующее:

* повышение или понижение уровня служб или уровня производительности сегмента; 
* добавление или удаление сегмента из набора сегментов.

Обратите внимание, что в решениях горизонтального и вертикального масштабирования результат действия не проявляется немедленно. Например, при вертикальном масштабировании выдача команды ALTER DATABASE для повышения уровня служб базы данных Basic до базы данных Premium занимает разное количество времени. Длительность во многом зависит от размера базы данных (дополнительную информацию см. в статье [Изменение уровней служб и уровней производительности](http://msdn.microsoft.com/library/azure/dn369872.aspx)). Аналогично, выделение или подготовка нового сегмента не происходит мгновенно. Таким образом, как при вертикальном, так и при горизонтальном масштабировании приложений следует учитывать ненулевой промежуток времени для изменения или подготовки новой базы данных.

## Пример сценария эластичности сегментов 

В примере, показанном на рисунке ниже, представлены два сценария эластичного масштабирования: 1) горизонтальное масштабирование сегмента сопоставления; 2) вертикальное масштабирование отдельного сегмента.

![Прием оперативных данных][1]

Чтобы выполнить горизонтальное масштабирование, используется правило (зависящее от объема данных или размера базы данных) для подготовки нового сегмента и его регистрации в схеме сегментов; таким образом происходит повышение уровня базы данных по горизонтали. Чтобы выполнить вертикальное масштабирование, реализуется второе правило, по условиям которого версия любого сегмента старше одного дня понижается от выпуска Premium до выпуска Standard или Basic.

Снова рассмотрим сценарий телеметрии: сегментирование приложения по дате. Приложение постоянно собирает данные телеметрии, при этом во время загрузки требуется выпуск с большой производительностью и с меньшей для устаревающих данных. Данные за текущий день, Tnow, записываются в базу данных с высокоскоростным доступом (Premium). Как только наступает полночь, сегмент предыдущего дня (теперь это T-1) уже не используется для приема данных. Текущие данные принимаются в текущий сегмент Tnow. Новый сегмент (T+1) должен быть подготовлен и зарегистрирован в сопоставлении сегментов до наступления следующего дня.

Для этого можно готовить новый сегмент перед наступлением каждого нового дня, либо новый сегмент готовится, если вместимость текущего сегмента (Tnow) приближается к максимальному значению. При использовании любого метода сохраняется локальность всех данных телеметрии, созданных за определенный день. Чтобы обеспечить большую степень детализации, можно использовать почасовое сегментирование. После подготовки нового сегмента, поскольку T-1 используется для создания запросов и отчетов, рекомендуется уменьшить уровень производительности базы данных и снизить затраты. По мере устаревания содержимого БД можно еще понизить уровень производительности и (или) архивировать содержимое БД в хранилище Azure, либо удалить данные, в зависимости от приложения.

## Выполнение сценариев эластичности сегментов  

Для упрощения реализации сценариев горизонтального и вертикального масштабирования создан ряд [примеров сценариев эластичности сегментов](http://go.microsoft.com/?linkid=9862617), которые опубликованы в Центре сценариев. Модули Runbook для PowerShell, созданные для запуска в службе автоматизации Azure, предоставляют ряд методов взаимодействия с клиентскими библиотеками эластичной базы данных и базой данных SQL Azure. На основе таких примеров кода, или используя их части, можно создавать необходимые скрипты для автоматизации сценариев горизонтального и вертикального масштабирования приложений (или масштабирования обоих типов).

[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-elasticity/data-ingestion.png

<!--anchors-->
[Telemetry]: #telemetry
[Rule]: #rule
[Action]: #action
 

<!---HONumber=August15_HO6-->