<properties
    pageTitle="Запросы к эластичным базам данных для межбазовых запросов (вертикальное секционирование) | Microsoft Azure"
    description="настройка межбазовых запросов для вертикального секционирования"    
    services="sql-database"
    documentationCenter=""  
    manager="jeffreyg"
    authors="torsteng"/>

<tags
    ms.service="sql-database"
    ms.workload="sql-database"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="01/06/2016"
    ms.author="torsteng;sidneyh" />

# Запросы к эластичным базам данных для межбазовых запросов (вертикальное секционирование)

В этой статье объясняется, как настраивать эластичные запросы в сценариях межбазовых запросов (вертикальное секционирование) и как выполнять такие запросы. Определение сценария вертикального секционирования см. в статье [Обзор запросов к эластичным базам данных SQL Azure (предварительная версия)](sql-database-elastic-query-overview.md).

![Запросы между таблицами в разных базах данных][1]

## Создание объектов базы данных

В сценариях вертикального секционирования эластичные запросы расширяют текущую схему данных T-SQL для обращения к таблицам, хранимым в удаленных базах данных. В этой статье приводится обзор инструкций DDL для настройки эластичных запросов с целью прозрачного доступа к удаленным таблицам. Данные инструкции DDL позволяют создать представление метаданных, состоящее из удаленных таблиц в локальной базе данных.

**Примечание.** В отличие от горизонтального секционирования эти инструкции DDL не требуют определения уровня данных с помощью карты сегментов через клиентскую библиотеку эластичной базы данных.

Инструкции T-SQL, используемые при определении объектов базы данных для эластичного запроса, приведены ниже. Кроме того, далее описано использование этих инструкций в сценарии вертикального секционирования.

* [CREATE MASTER KEY](https://msdn.microsoft.com/library/ms174382.aspx) 

* [CREATE DATABASE SCOPED CREDENTIAL](https://msdn.microsoft.com/library/mt270260.aspx)

* [CREATE/DROP EXTERNAL DATA SOURCE](https://msdn.microsoft.com/library/dn935022.aspx)

* [CREATE/DROP EXTERNAL TABLE](https://msdn.microsoft.com/library/dn935021.aspx)

### 1\.1. Главный ключ и учетные данные для конкретной базы данных 

К учетным данным относятся идентификатор пользователя и пароль, используемые эластичным запросом для подключения к удаленным базам данных в базе данных SQL Azure. Чтобы создать необходимый главный ключ и учетные данные, используйте такой синтаксис:

    CREATE MASTER KEY ENCRYPTION BY PASSWORD = ’password’;
    CREATE DATABASE SCOPED CREDENTIAL <credential_name>  WITH IDENTITY = ‘<username>’,  
    SECRET = ‘<password>’
    [;]
    
Чтобы удалить учетные данные, выполните указанные ниже действия.
    
    DROP DATABASE SCOPED CREDENTIAL <credential_name>;  
    DROP MASTER KEY;   

 
Убедитесь, что значение *< username>* не содержит суффикс *@servername*.

### 1\.2. Внешние источники данных

Для предоставления эластичным запросам сведений об удаленных базах данных вам нужно определить внешние источники данных. Синтаксис для создания и удаления внешних источников данных определяется следующим образом.

    <External_Data_Source> ::=
    CREATE EXTERNAL DATA SOURCE <data_source_name> WITH 
               (TYPE = RDBMS,
                LOCATION = ’<fully_qualified_server_name>’,
                DATABASE_NAME = ‘<remote_database_name>’,  
                CREDENTIAL = <credential_name> 
                ) [;] 

Обратите внимание на параметр TYPE, который определяет этот источник данных как реляционную СУБД.

Для удаления внешнего источника данных можно использовать следующую инструкцию:

    DROP EXTERNAL DATA SOURCE <data_source_name>[;]

#### Разрешения для CREATE/DROP EXTERNAL DATA SOURCE 

Пользователь должен иметь разрешение ALTER ANY EXTERNAL DATA SOURCE. Это разрешение включено в разрешение ALTER DATABASE.

**Пример**

В следующем примере демонстрируется использование инструкции CREATE для внешних источников данных.

	CREATE EXTERNAL DATA SOURCE RemoteReferenceData 
	WITH 
	( 
		TYPE=RDBMS, 
		LOCATION='myserver.database.windows.net', 
		DATABASE_NAME='ReferenceData', 
		CREDENTIAL= SqlUser 
	); 
 
Список актуальных внешних источников данных можно получить в следующем представлении каталога:

    select * from sys.external_data_sources; 

### 1\.3. Внешние таблицы 

Эластичные запросы расширяют существующий синтаксис доступа к внешним таблицам, позволяя определять внешние таблицы, использующие внешние источники данных типа реляционной СУБД. Определение внешней таблицы для вертикального секционирования содержит следующие элементы:

* **Схема**: язык DDL внешней таблицы определяет схему, которую можно использовать в запросах. Схема из определения вашей внешней таблицы должна соответствовать схеме таблиц в удаленной базе данных, в которой хранятся данные. 

* **Ссылка на удаленную базу данных**: язык DDL внешней таблицы ссылается на внешний источник данных. Внешний источник данных указывает логическое имя сервера и имя удаленной базы данных, в которой фактически хранятся данные из таблицы.

Используя внешний источник данных (в соответствии с инструкциями, приведенными в предыдущем разделе), вы можете создавать внешние таблицы при помощи следующего синтаксиса:

	CREATE EXTERNAL TABLE [ database_name . [ schema_name ] . | schema_name . ] table_name  
    ( { <column_definition> } [ ,...n ])     
	{ WITH ( <rdbms_external_table_options> ) } 
	)[;] 
	
	<rdbms_external_table_options> ::= 
      DATA_SOURCE = <External_Data_Source>, 
      [ SCHEMA_NAME = N'nonescaped_schema_name',] 
      [ OBJECT_NAME = N'nonescaped_object_name',] 

Предложение DATA\_SOURCE определяет внешний источник данных (в случае вертикального секционирования это удаленная база данных), используемый для внешней таблицы.

Предложения SCHEMA\_NAME и OBJECT\_NAME позволяют сопоставить определение внешней таблицы с таблицей из другой схемы в удаленной базе данных или таблицей с другим именем. Это полезно, если вы хотите связать внешнюю таблицу с представлением каталога или динамическим административным представлением вашей удаленной базы данных. Это пригодится также в любой ситуации, в которой имя удаленной таблицы уже локально занято.

Следующая инструкция DDL удаляет существующее определение внешней таблицы из локального каталога. Эта операция не влияет на удаленную базу данных.

	DROP EXTERNAL TABLE [ database_name . [ schema_name ] . | schema_name. ] table_name[;]  

**Разрешения для инструкции CREATE/DROP EXTERNAL TABLE**: для схемы данных внешней таблицы требуются разрешения ALTER ANY EXTERNAL DATA SOURCE, необходимые также для ссылки на базовый источник данных.

**Вопросы безопасности.** Пользователи, имеющие доступ к внешней таблице, автоматически получают доступ к базовой удаленной таблице с учетными данными, указанными в определении внешнего источника данных. Вам следует тщательно следить за доступом к внешним таблицам во избежание нежелательного повышения привилегий при использовании учетных данных внешнего источника данных. Для предоставления и отмены доступа к внешней таблице используются разрешения SQL, применимые к обычным таблицам.


 **Пример.** Далее показано создание внешней таблицы.

	CREATE EXTERNAL TABLE [dbo].[customer]( 
		[c_id] int NOT NULL, 
		[c_firstname] nvarchar(256) NULL, 
		[c_lastname] nvarchar(256) NOT NULL, 
		[street] nvarchar(256) NOT NULL, 
		[city] nvarchar(256) NOT NULL, 
		[state] nvarchar(20) NULL, 
		[country] nvarchar(50) NOT NULL, 
	) 
	WITH 
	( 
	       DATA_SOURCE = RemoteReferenceData 
	); 

В следующем примере показано получение списка внешних таблиц из текущей базы данных:

	select * from sys.external_tables; 

## Выполнение запроса

### 2\.1. Запросы T-SQL с полным соответствием 

Определив внешний источник данных и внешние таблицы, вы можете использовать все возможности T-SQL для создания запросов к внешним таблицам.

**Пример вертикального секционирования.** Следующий запрос выполняет трехстороннее соединение между двумя локальными таблицами заказов и строк заказов с удаленной таблицей клиентов. Ниже приведен пример варианта использования ссылочных данных в эластичном запросе:

	SELECT  	
	 c_id as customer,
	 c_lastname as customer_name,
	 count(*) as cnt_orderline, 
	 max(ol_quantity) as max_quantity,
	 avg(ol_amount) as avg_amount,
	 min(ol_delivery_d) as min_deliv_date
	FROM customer 
	JOIN orders 
	ON c_id = o_c_id
	JOIN  order_line 
	ON o_id = ol_o_id and o_c_id = ol_c_id
	WHERE c_id = 100

  
## Подключение для инструментов

Используйте обычные строки подключения SQL Server для подключения ваших инструментов бизнес-аналитики и средств интеграции данных к серверу баз данных SQL, где включены эластичные запросы и определены внешние таблицы. Убедитесь, что в качестве источника данных для вашего инструмента поддерживается SQL Server. Затем добавьте ссылку на эластичную базу данных запросов и ее внешние таблицы так же, как и ссылку на любую другую базу данных SQL Server, к которой вы подключались бы с помощью своего средства.

## Рекомендации 
 
* Убедитесь, что эластичный запрос к конечной базе данных имеет доступ к удаленной базе данных. Для этого откройте доступ для служб Azure в конфигурации брандмауэра базы данных SQL. Кроме того, убедитесь, что учетные данные, указанные в определении внешнего источника данных, позволяют войти в удаленную базу данных и имеют разрешения на доступ к удаленной таблице.  

* Эластичные запросы оптимальны, когда основная часть вычислений может быть выполнена в удаленной базе данных. Обычно наиболее эффективны запросы с предикатами выборочных фильтров, дающие возможность вычисления в удаленных базах данных, или соединениями, которые могут быть полностью выполнены в удаленной базе данных. Для других шаблонов запросов может потребоваться загрузка больших объемов данных из удаленной базы данных, и эти шаблоны могут сработать неэффективно.


[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]


<!--Image references-->
[1]: ./media/sql-database-elastic-query-vertical-partitioning/verticalpartitioning.png


<!--anchors-->

<!---HONumber=AcomDC_0107_2016-->