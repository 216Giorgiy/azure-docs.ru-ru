<properties 
    pageTitle="Миграция федераций" 
    description="В этой статье описана процедура миграции существующего приложения, созданного с использованием функции федераций, в модель эластичной базы данных." 
    services="sql-database" 
    documentationCenter="" 
    manager="jeffreyg" 
    authors="sidneyh" 
    editor=""/>

<tags 
    ms.service="sql-database" 
    ms.workload="sql-database" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="08/14/2015" 
    ms.author="sidneyh"/>

# Миграция федераций 

В сентябре 2015 года функция федераций баз данных SQL Azure и выпуски Web Edition и Business Edition станут недоступны. С этого момента приложения, в которых используются функции федераций, перестанут выполняться. Чтобы миграция прошла удачно, начните ее как можно раньше Это позволит спланировать и выполнить ее должным образом.

Если ваше приложение еще не готово работать, не опираясь на федерации, свяжитесь со службой технической поддержки Майкрософт в соответствии с инструкциями [здесь](https://support.microsoft.com/kb/3087180).

В этом документе приводятся контекст, примеры и общая информация о программе миграции федераций, которые наглядно демонстрируют успешный перенос действующего приложения с использованием федераций в интерфейсы API [клиентской библиотеки эластичной базы данных](http://go.microsoft.com/?linkid=9862592) для сегментирования. В этом документе описана рекомендуемая процедура миграции приложения с функцией федераций без перемещения данных.

Миграция такого приложения на платформу, использующую инструменты эластичной базы данных, состоит из трех основных этапов.

1. [Создание диспетчера сопоставления сегментов из корня федерации](#create-a-shard-map-manager-from-a-federation-root) 
2. [Изменение существующего приложения](#modify-the-existing-application)
3. [Отключение существующих элементов федерации](#switch-out-existing-federation-members)
    

### Пример инструмента для миграции
Чтобы упростить этот процесс, была создана [программа миграции федераций](http://go.microsoft.com/?linkid=9862613). Она позволяет выполнить шаги 1 и 3.

## Создание диспетчера сопоставления сегментов из корня федерации
Первый шаг миграции приложения с функцией федераций предусматривает клонирование метаданных корня федерации в конструкции диспетчера сопоставления сегментов.

![Клонирование корня федерации в диспетчер сопоставления сегментов][1]
 
Запустите существующее приложение с функцией федераций в тестовой среде.
 
Используйте **программу миграции федераций**, чтобы клонировать метаданные корня федераций в конструкциях [диспетчера сопоставления сегментов](http://go.microsoft.com/?linkid=9862595) клиентской библиотеки эластичной базы данных. Как и корень федерации, база данных диспетчера сопоставления сегментов является автономной базой данных, содержащий сопоставления сегментов (т. е. федерации), ссылки на сегменты (т. е. элементы федерации) и сопоставления диапазонов.

Клонирование корня федерации в диспетчер сопоставлений сегментов – это копирование и трансляция метаданных. Никакие метаданные в корне федерации не изменяются. Обратите внимание, что клонирование корня федерации с помощью утилиты для миграции является одномоментной операцией, поэтому изменения как в корне федерации, так и в сопоставлениях сегментов не будут отражены в другом соответствующем хранилище данных. В случае внесения изменений в корень федерации во время тестирования новых API состояние сопоставления сегментов можно обновить с помощью программы миграции федераций.

![Миграция существующего приложения для использования интерфейсов API инструментов эластичных баз данных][2]

## Изменение существующего приложения 

При наличии диспетчера сопоставления сегментов элементов федераций и зарегистрированных с помощью этого диспетчера диапазонов (регистрация осуществляется с помощью служебной программы миграции) параметры существующего приложения с функцией федераций можно изменить таким образом, чтобы в нем использовалась клиентская библиотека эластичной базы данных. Как показано на рисунке выше, маршруты подключений к приложению через API будут проходить через диспетчер сопоставления сегментов к соответствующим элементам федерации (а теперь также к сегментам). Сопоставление элементов федерации с диспетчером сопоставления сегментов позволяет параллельно использовать две версии приложения. Одна из них использует федерации, а другая — клиентскую библиотеку эластичной базы данных. Обе они выполняются параллельно для проверки функциональности.

Во время миграции в существующее приложение необходимо внести два основных изменения.


#### Изменение 1. Создание экземпляра объекта диспетчера сопоставления сегментов 

В отличие от федераций, API инструментов эластичной базы данных взаимодействуют с диспетчером сопоставления сегментов через класс **ShardMapManager**. Экземпляр объекта **ShardMapManager** и сопоставления сегментов можно создать вот так:
     
    //Instantiate ShardMapManger Object 
    ShardMapManager shardMapManager = ShardMapManagerFactory.GetSqlShardMapManager(
                            connectionStringSMM, ShardMapManagerLoadPolicy.Lazy); 
    RangeShardMap<T> rangeShardMap = shardMapManager.GetRangeShardMap<T>(shardMapName) 
    
#### Изменение 2. Маршрутизация подключений к соответствующим сегментам 

При использовании федераций подключение устанавливается к конкретному элементу федерации с помощью команды USE FEDERATION следующим образом:

    USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=OFF`

При использовании интерфейсов API для инструментов эластичной базы данных подключение к конкретному сегменту устанавливается с помощью [маршрутизации на основе данных](sql-database-elastic-scale-data-dependent-routing.md), при этом используется метод **OpenConnectionForKey** класса **RangeShardMap**.

    //Connect and issue queries on the shard with key=100 
    using (SqlConnection conn = rangeShardMap.OpenConnectionForKey(100, csb))  
    { 
         using (SqlCommand cmd = new SqlCommand()) 
         { 
            cmd.Connection = conn; 
            cmd.CommandText = "SELECT * FROM customer";
     
            using (SqlDataReader dr = cmd.ExecuteReader()) 
            { 
                  //Perform action on dr 
            } 
        } 
    }

Все шаги, описанные в этом разделе, обязательны, но они могут подходить не для всех сценариев миграции. Подробную информацию см. в [общем обзоре инструментов эластичной базы данных](sql-database-elastic-scale-introduction.md) и [Справочнике по интерфейсам API](http://go.microsoft.com/?linkid=9862604).

## Отключение существующих элементов федерации 

![Отключение элементов федерации для сегментов][3]

После изменения приложения и включения в него интерфейсов API для инструментов эластичной базы данных для завершения миграции приложения с функцией федераций остается выполнить команду **SWITCH OUT** для элементов федераций (дополнительную информацию см. в справочнике MSDN для [ALTER FEDERATION (База данных Azure SQL](http://msdn.microsoft.com/library/dn269988(v=sql.120).aspx)). В конечном итоге после выполнения команды **SWITCH OUT** для конкретного элемента федерации будут удалены все ограничения для федераций, а его метаданные, по которым элемент федерации обрабатывается как обычная База данных SQL Azure, ничем не будут отличаться от метаданных любой другой Базы данных SQL Azure.

Обратите внимание, что выполнение команды **SWITCH OUT** для элемента федерации — необратимая операция и ее нельзя отменить. После выполнения этой команды для базы данных невозможно восстановить поддержку федераций и выполнить команду USE FEDERATION.

Чтобы выполнить переключение, к команде ALTER FEDERATION был добавлен дополнительный аргумент, чтобы ОТКЛЮЧИТЬ(SWITCH OUT) члена федерации. Хотя команду можно применить к отдельным членам федерации, утилита для миграции предоставляет возможность программно перебирать всех членов федерации, выполняя операцию переключения для каждого из них.

После переключения всех существующих элементов федерации миграция приложения будет завершена. После отключения всех элементов федерации советуем выполнить операцию DROP FEDERATION в корне. Это никак не повлияет на любого из предыдущих элементов, но позволит корневой базе данных быстро перейти с выпуска Web Edition и Business Edition.
  
Служебная программа миграции федераций предоставляет ряд возможностей.

1.    Клонирование корня федерации в диспетчер сопоставлений сегментов. Можно выбрать установку существующего диспетчера сопоставления сегментов на новую базу данных Azure SQL (рекомендуется) или на существующую базу данных корня федерации.
2.    Выполнение команды SWITCH OUT для всех элементов федерации.


## Сравнение возможностей

Хотя инструменты эластичной базы данных предоставляют множество дополнительных возможностей (например, [многосегментные запросы](sql-database-elastic-scale-multishard-querying.md), [разбиение и объединение сегментов](sql-database-elastic-scale-overview-split-and-merge.md), [эластичность сегментов](sql-database-elastic-scale-elasticity.md), [кэширование на стороне клиента](sql-database-elastic-scale-shard-map-management.md) и многое другое), существует несколько примечательных особенностей федераций, которые не поддерживают инструменты эластичной базы данных.
  
- Использование **FILTERING=ON**. Вместо этого для фильтрации строк советуем использовать безопасность на уровне строк (RLS). Как и при фильтрации в федерации, при применении безопасности на уровне строк ко всем запросам в сегментированной таблице автоматически добавляется предикат. Дополнительную информацию см. в разделе [Мультитенантные приложения с инструментами эластичных баз данных и безопасностью на уровне строк](sql-database-elastic-tools-multi-tenant-row-level-security.md). 
 
 Вы также можете создать логику фильтрации в запросе, который отправляется для сегмента. Например:

        --Example of USE FEDERATION with FILTERING=ON
        USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=ON 
        SELECT * FROM customer

 Такой же результат можно получить так:

        --Example of USE FEDERATION with filtering in the WHERE clause 
        USE FEDERATION CustomerFederation(cid=100) WITH RESET, FILTERING=OFF 
        SELECT * FROM customer WHERE CustomerId = 100 

- При **разбиении** сегментов для инструментов эластичной базы данных отсутствует полноценная поддержка подключения к сети. При выполнении этой операции каждый отдельный шардлет во время перемещения переходит в состояние «Не готов».
- Чтобы использовать функцию разбиения сегментов, подготовку базы данных и управление схемой, необходимо выполнять вручную.

## Дополнительные замечания

* Осенью 2015 года прекратится поддержка федераций, а также выпусков Business Edition и Web Edition. В рамках миграции приложения использующего федерации настоятельно рекомендуется выполнить тестирование производительности на Базовой, Стандартной и Премиум версиях. 

* После выполнения инструкции SWITCH OUT для элемента федерации результирующая база данных будут поддерживать все возможностей базы данных SQL Azure (т. е. новые издания, резервное копирование, восстановление на определенный момент времени, аудит и т. п.)

##Вам нужно больше времени для миграции? 
Если ваше приложение еще не готово работать, не опираясь на федерации, свяжитесь со службой технической поддержки Майкрософт в соответствии с инструкциями [здесь](https://support.microsoft.com/kb/3087180).

[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Anchors-->
[Create Shard Map Manager from a Federation Root]: #create-shard-map-manager
[Modify the Existing Application]: #Modify-the-Existing-Application
[Switch Out Existing Federation Members]: #Switch-Out-Existing-Federation-Members


<!--Image references-->
[1]: ./media/sql-database-elastic-scale-federation-migration/migrate-1.png
[2]: ./media/sql-database-elastic-scale-federation-migration/migrate-2.png
[3]: ./media/sql-database-elastic-scale-federation-migration/migrate-3.png
 

<!---HONumber=Oct15_HO3-->