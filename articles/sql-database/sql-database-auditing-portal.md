---
title: "Портал Azure: управление аудитом базы данных SQL | Документация Майкрософт"
description: "Сведения о настройке аудита базы данных SQL Azure на портале Azure для отслеживания всех событий базы данных и записи их в журнал аудита для вашей учетной записи хранения Azure."
services: sql-database
documentationcenter: 
author: ronitr
manager: jhubbard
editor: giladm
ms.assetid: 89c2a155-c2fb-4b67-bc19-9b4e03c6d3bc
ms.service: sql-database
ms.custom: secure and protect
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 2/25/2017
ms.author: ronitr; giladm
translationtype: Human Translation
ms.sourcegitcommit: fb56545df42e997e5960eec73ae59e9334731392
ms.openlocfilehash: 8c6fa92764cb720a0c71a24d839d3e73ce3ba447
ms.lasthandoff: 03/02/2017


---

# <a name="configure-and-manage-sql-database-auditing-in-the-azure-portal"></a>Настройка аудита базы данных SQL и управление им на портале Azure

Здесь описывается настройка аудита и управление им на портале Azure. Сведения о настройке аудита и управлении им с помощью PowerShell см. в разделе [Настройка аудита базы данных SQL и управление им с помощью PowerShell](sql-database-auditing-powershell.md). Сведения о настройке аудита и управлении им с помощью REST API см. в разделе [Настройка аудита базы данных SQL и управление им с помощью REST API](sql-database-auditing-rest.md).

Общие сведения об аудите базы данных SQL см. в статье [Приступая к работе с аудитом базы данных SQL](sql-database-auditing.md).

## <a name="configure-blob-auditing"></a>Настройка аудита больших двоичных объектов

1. Откройте [портал Azure](https://portal.azure.com) по адресу https://portal.azure.com.
2. Перейдите в колонку параметров базы данных SQL или SQL Server, где нужно выполнить аудит. В колонке "Параметры" выберите **Аудит и обнаружение угроз**.

    ![Область навигации](./media/sql-database-auditing-get-started/1_auditing_get_started_settings.png)
3. В колонке для настройки аудита базы данных можно установить флажок **Наследовать настройки от сервера**. Это означает, что аудит базы данных будет выполняться в соответствии с настройками сервера. Установив этот флажок, вы увидите ссылку **Просмотр настроек аудита сервера**, позволяющую просмотреть или изменить настройки аудита сервера.

    ![Область навигации][2]
4. Если вы хотите включить аудит больших двоичных объектов на уровне базы данных (в дополнение или вместо аудита на уровне сервера), **снимите** флажок **Наследовать настройки аудита от сервера**, **включите** аудит и выберите тип аудита **BLOB-объект**.

    ![Область навигации][3]
5. Выберите **Сведения о хранилище**, чтобы открыть колонку хранилища журналов аудита. Выберите учетную запись хранения Azure, в которой будут сохраняться журналы, и срок хранения, по истечении которого старые журналы будут удалены. Затем нажмите кнопку **ОК** внизу. **Совет.** Для того чтобы в полной мере воспользоваться возможностями шаблонов отчетов об аудите, используйте одну и ту же учетную запись хранения для всех баз данных.

    <a id="storage-screenshot"></a>
    ![Область навигации][4]
6. Настроить события аудита можно с помощью [PowerShell](sql-database-auditing-powershell.md) или [REST API](sql-database-auditing-rest.md).
7. После настройки параметров аудита можно включить новую функцию "Обнаружение угроз (предварительная версия)" и указать адреса электронной почты для получения предупреждений системы безопасности. Функция "Обнаружение угроз" позволяет настроить упреждающие оповещения об аномальной активности в базах данных, которая может указывать на потенциальные угрозы безопасности. Дополнительные сведения см. в статье [Обнаружение угроз для базы данных SQL](sql-database-threat-detection.md).
8. Щелкните **Сохранить**.


## <a name="table-auditing"></a>Аудит таблиц

> [!IMPORTANT]
> Перед настройкой **аудита таблиц** проверьте, пользуетесь ли вы ["клиентом нижнего уровня"](sql-database-auditing-and-dynamic-data-masking-downlevel-clients.md). Кроме того, если установлены строгие параметры брандмауэра, учтите, что при включении аудита таблиц [IP-адрес конечной точки базы данных изменится](sql-database-auditing-and-dynamic-data-masking-downlevel-clients.md).
>

1. Откройте [портал Azure](https://portal.azure.com) по адресу https://portal.azure.com.
2. Перейдите в колонку параметров базы данных SQL или SQL Server, где нужно выполнить аудит. В колонке "Параметры" выберите **Аудит и обнаружение угроз** (*[см. снимок экрана в разделе "Аудит BLOB-объектов"](#auditing-screenshot)*).
3. В колонке для настройки аудита базы данных можно установить флажок **Наследовать настройки от сервера**. Это означает, что аудит базы данных будет выполняться в соответствии с настройками сервера. Установив этот флажок, вы увидите ссылку **Просмотр настроек аудита сервера**, позволяющую просмотреть или изменить настройки аудита сервера.

    ![Область навигации][2]
4. Если вы не хотите наследовать настройки аудита от сервера, **снимите** флажок **Наследовать настройки аудита от сервера**, **включите** аудит и выберите тип аудита **Таблица**.

    ![Область навигации][3-tbl]
5. Выберите **Сведения о хранилище**, чтобы открыть колонку хранилища журналов аудита. Выберите учетную запись хранения Azure, в которой будут сохраняться журналы, и срок хранения, по истечении которого старые журналы будут удалены. **Совет.** Для того чтобы в полной мере воспользоваться возможностями шаблонов отчетов об аудите, используйте одну и ту же учетную запись хранения для всех баз данных (*[см. снимок экрана в разделе "Аудит BLOB-объектов"](#storage-screenshot)*).
6. Щелкните **События аудита** , чтобы указать, какие события требуют аудита. В колонке "Журнал событий" щелкните **Успех** и **Отказ**, чтобы включить в журнал все события, или выберите отдельные категории событий.

    ![Область навигации][5]
7. После настройки параметров аудита можно включить новую функцию "Обнаружение угроз (предварительная версия)" и указать адреса электронной почты для получения предупреждений системы безопасности. Функция "Обнаружение угроз" позволяет настроить упреждающие оповещения об аномальной активности в базах данных, которая может указывать на потенциальные угрозы безопасности. Дополнительные сведения см. в статье [Обнаружение угроз для базы данных SQL](sql-database-threat-detection.md).
8. Щелкните **Сохранить**.

## <a name="auditing-geo-replicated-databases"></a>Аудит географически реплицированных баз данных

При использовании географически реплицированных баз данных можно настроить аудит для базы данных-источника, базы данных-получателя или для обеих баз данных в зависимости от типа аудита.

**Аудит таблиц.** Вы можете настроить отдельную политику на уровне базы данных или на уровне сервера для каждой из двух баз данных (источника и получателя).

**Аудит больших двоичных объектов.** Выполните следующие действия.

1. **База данных-источник.** Включите аудит больших двоичных объектов на сервере или в самой базе данных.
2. **База данных-получатель.** Аудит больших двоичных объектов можно включить и выключить только в параметрах аудита базы данных-источника.

   * Включите аудит больших двоичных объектов в базе данных-источнике. Его необходимо включить для самой *базы данных-источника*, а не для сервера.
   * После включения аудита больших двоичных объектов в базе данных-источнике он станет доступным в базе данных-получателе.

    > [!IMPORTANT]
    > По умолчанию настройки хранилища для базы данных-получателя будут совпадать с настройками для базы данных-источника, что приведет к появлению трафика между регионами. Чтобы избежать этого, включите аудит больших двоичных объектов на сервере-получателе и настройте локальное хранилище в параметрах хранилища сервера-получателя. Такая настройка переопределит место хранения для базы данных-получателя, и в результате каждая база данных будет хранить журналы аудита в своем локальном хранилище.  

## <a name="viewing-blob-auditing-logs"></a>Просмотр журналов аудита больших двоичных объектов

Журналы аудита больших двоичных объектов сохраняются в виде коллекции файлов больших двоичных объектов в контейнере с именем **sqldbauditlogs**.

Дополнительные сведения об иерархии папок для хранения журналов аудита больших двоичных объектов, соглашении об именовании больших двоичных объектов и формате журнала см. в [справочнике по формату журнала аудита (скачать DOC-файл)](https://go.microsoft.com/fwlink/?linkid=829599).

Просмотреть журналы аудита BLOB-объектов можно несколькими способами:

* На [портале Azure](https://portal.azure.com) откройте соответствующую базу данных. В верхней части колонки "Аудит и обнаружение угроз" щелкните **Просмотреть журналы**.

    ![Область навигации][10]

    Откроется колонка "Записи аудита", в которой вы сможете просматривать журналы.

    - Для просмотра записей за определенную дату щелкните **Фильтр** в верхней части колонки записей аудита.
    - Можно переключаться между записями аудита, которые создаются политиками аудита для сервера и для базы данных.

    ![Область навигации][11]
* Скачайте файлы журналов из контейнера больших двоичных объектов службы хранилища Azure с портала или с помощью такого инструмента, как [Azure Storage Explorer](http://storageexplorer.com/).

    После загрузки файла дважды щелкните по нему, чтобы открыть, просмотреть и проанализировать файл в среде SSMS.

* Дополнительные методы

   * В Azure Storage Explorer можно скачать несколько файлов одновременно. Для этого щелкните правой кнопкой мыши необходимую вложенную папку (вложенную папку, включающую все файлы журнала для определенной даты) и выберите **Сохранить как**, чтобы сохранить файлы журнала в локальной папке.

       Загрузив несколько файлов (или файлы за весь день, как описано выше), их можно объединить локально следующим образом:

       **Откройте SSMS и выберите "Файл" -> "Открыть" -> "Объединить расширенные события". Затем укажите все файлы для слияния**
   * Программным способом:

     * [библиотека C# для считывания расширенных событий](https://blogs.msdn.microsoft.com/extended_events/2011/07/20/introducing-the-extended-events-reader/);
     * [запросы к файлам расширенных событий с помощью PowerShell](https://sqlscope.wordpress.com/2014/11/15/reading-extended-event-files-using-client-side-tools-only/).

   * Вы создали [образец приложения](https://github.com/Microsoft/Azure-SQL-DB-auditing-OMS-integration), которое выполняется в Azure и использует общедоступные API OMS для отправки в OMS журналов аудита SQL, где их можно затем обрабатывать через панель мониторинга OMS.

## <a name="viewing-table-audit-logs"></a>Просмотр журналов аудита таблиц

Журналы аудита таблиц сохраняются в виде коллекции таблиц службы хранилища Azure с префиксом **SQLDBAuditLogs**.

Дополнительные сведения о формате журнала аудита таблиц см. в [Справочнике по формату журнала аудита таблиц (скачать DOC-файл)](http://go.microsoft.com/fwlink/?LinkId=506733).

Просмотреть журналы аудита таблиц можно несколькими способами:

* На [портале Azure](https://portal.azure.com) откройте соответствующую базу данных. В верхней части колонки "Аудит и обнаружение угроз" щелкните **Просмотреть журналы**.

    ![Область навигации][10]

    Откроется колонка "Записи аудита", в которой вы сможете просматривать журналы.

    * Для просмотра записей за определенную дату щелкните **Фильтр** в верхней части колонки записей аудита.
    * Можно скачать и просмотреть журналы аудита в формате Excel, щелкнув **Открыть в Excel** в верхней части колонки записей аудита.

    ![Область навигации][12]

* Кроме того, можно воспользоваться предварительно настроенным шаблоном, который доступен в виде [таблицы Excel](http://go.microsoft.com/fwlink/?LinkId=403540). Он быстро проанализировать данные журнала. Чтобы использовать шаблон с вашими журналами аудита, вам потребуется Excel 2013 и выше и [Power Query(http://www.microsoft.com/download/details.aspx?id=39379).

* Помимо этого, можно импортировать журналы аудита в шаблон Excel непосредственно из учетной записи хранения Azure с помощью Power Query. После этого вы сможете просматривать записи аудита и создавать панели управления и отчеты на основе данных журнала.

    ![Область навигации][9]

## <a name="storage-key-regeneration"></a>Повторное создание ключа хранилища
Обычно в рабочей среде приходится периодически обновлять ключи хранилища. При обновлении ключей необходимо повторно сохранить политику аудита. Процесс таков:

1. В колонке "Сведения о хранилище" измените значение параметра **Ключ доступа к хранилищу** с *Источник* на *Получатель* и нажмите кнопку **ОК** внизу. Затем щелкните **СОХРАНИТЬ** в верхней части колонки настройки аудита.

    ![Область навигации][6]
2. Перейдите в колонку конфигурации хранилища и **повторно создайте** *первичный ключ доступа*.

    ![Область навигации][8]
3. Вернитесь в колонку настройки аудита, измените значение параметра **Ключ доступа к хранилищу** с *Получатель* на *Источник* и нажмите кнопку **ОК** внизу. Затем щелкните **Сохранить** в верхней части колонки настройки аудита.
4. Вернитесь в колонку настройки хранилища и **повторно создайте** *ключ доступа получателя* (для подготовки к следующему циклу обновления ключей).


<!--Anchors-->
[Azure SQL Database Auditing overview]: #subheading-1
[Set up auditing for your database]: #subheading-2
[Analyze audit logs and reports]: #subheading-3
[Practices for usage in production]: #subheading-5
[Storage Key Regeneration]: #subheading-6
[Automation (PowerShell / REST API)]: #subheading-7
[Blob/Table differences in Server auditing policy inheritance]: (#subheading-8)  

<!--Image references-->
[1]: ./media/sql-database-auditing-get-started/1_auditing_get_started_settings.png
[2]: ./media/sql-database-auditing-get-started/2_auditing_get_started_server_inherit.png
[3]: ./media/sql-database-auditing-get-started/3_auditing_get_started_turn_on.png
[3-tbl]: ./media/sql-database-auditing-get-started/3_auditing_get_started_turn_on_table.png
[4]: ./media/sql-database-auditing-get-started/4_auditing_get_started_storage_details.png
[5]: ./media/sql-database-auditing-get-started/5_auditing_get_started_audited_events.png
[6]: ./media/sql-database-auditing-get-started/6_auditing_get_started_storage_key_regeneration.png
[7]: ./media/sql-database-auditing-get-started/7_auditing_get_started_activity_log.png
[8]: ./media/sql-database-auditing-get-started/8_auditing_get_started_regenerate_key.png
[9]: ./media/sql-database-auditing-get-started/9_auditing_get_started_report_template.png
[10]: ./media/sql-database-auditing-get-started/10_auditing_get_started_blob_view_audit_logs.png
[11]: ./media/sql-database-auditing-get-started/11_auditing_get_started_blob_audit_records.png
[12]: ./media/sql-database-auditing-get-started/12_auditing_get_started_table_audit_records.png

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о настройке аудита базы данных и управлении им с помощью PowerShell см. в разделе [Настройка аудита базы данных SQL и управление им с помощью PowerShell](sql-database-auditing-powershell.md).
* Сведения о настройке аудита базы данных и управлении им с помощью REST API см. в разделе [Настройка аудита базы данных SQL и управление им с помощью REST API](sql-database-auditing-rest.md).
* Общие сведения об аудите базы данных см. в статье [Приступая к работе с аудитом базы данных SQL](sql-database-auditing.md).


