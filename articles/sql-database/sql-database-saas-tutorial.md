---
title: "Руководство по мультитенантному приложению SaaS, использующему базу данных SQL Azure | Документация Майкрософт"
description: "Разверните и изучите мультитенантное приложение SaaS Wingtip, демонстрирующее шаблоны SaaS с использованием базы данных SQL Azure."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/26/2017
ms.author: sstein
ms.openlocfilehash: f624485d32901abb5f0d01c86fc30ddaaae261a3
ms.sourcegitcommit: e5355615d11d69fc8d3101ca97067b3ebb3a45ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2017
---
# <a name="deploy-and-explore-a-multi-tenant-application-that-uses-azure-sql-database---wingtip-saas"></a>Развертывание и изучение мультитенантного приложения, использующего базу данных SQL Azure — SaaS Wingtip

В этом руководстве рассматривается развертывание и изучение приложения SaaS для Wingtip. Для обслуживания нескольких клиентов приложение использует шаблон приложения SaaS, в котором на один клиент используется одна база данных. Приложение разработано для демонстрации возможностей базы данных SQL Azure, которые упрощают работу со сценариями SaaS.

Если вы нажмете кнопку *Развертывания в Azure* ниже, то через пять минут вы получите облачное мультитенантное приложение SaaS, использующее базу данных SQL. Приложение развертывается с помощью трех примеров клиентов, каждый из которых содержит свою базу данных, развернутую в эластичный пул SQL. Приложение развертывается в подписку Azure, предоставляя полный доступ для изучения отдельных компонентов приложения и работы с ними. Исходный код и скрипты управления приложения доступны в репозитории GitHub WingtipSaaS.


Из этого руководства вы узнаете следующее:

> [!div class="checklist"]

> * как развернуть и изучить мультитенантное приложение SaaS Wingtip;
> * где можно получить исходный код приложения и скрипты управления;
> * О серверах, пулах и базах данных, формирующих приложение.
> * о сопоставлении клиентов с данными с помощью *каталога*;
> * как подготовить нового клиент;
> * как выполнить мониторинг активности клиента в приложении.

Чтобы изучить различные модели проектирования и управления SaaS, вы можете ознакомиться с доступной [серией связанных руководств](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials), которые являются продолжением этого руководства, необходимого для выполнения первоначального развертывания. Изучая руководства, постарайтесь разобраться с приведенными сценариями, а также понять способ реализации различных моделей SaaS. Знакомство со сценариями, представленными в каждом руководстве, необходимо, чтобы разобраться с реализацией множества возможностей базы данных SQL, упрощающих разработку приложений SaaS.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством выполните следующие предварительные требования:

* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="deploy-the-wingtip-saas-application"></a>Развертывание приложения SaaS Wingtip

Развертывание приложения SaaS Wingtip:

1. Если нажать кнопку **Развертывание в Azure**, на портале Azure откроется шаблон развертывания SaaS Wingtip. Для шаблона требуется два значения параметра: имя для новой группы ресурсов и имя пользователя, являющееся отличительным признаком этого развертывания среди других развертываний приложения SaaS Wingtip. На следующем шаге содержатся сведения о настройке этих значений.

   Запишите точные значения, которые вы используете, так как их нужно будет ввести в файле конфигурации позже.

   <a href="http://aka.ms/deploywtpapp" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>

1. Введите необходимые значения параметров для развертывания.

    > [!IMPORTANT]
    > Некоторые проверки подлинности и брандмауэры сервера не защищены специально, так как предназначены для демонстрации. **Создайте группу ресурсов** и не используйте имеющиеся группы ресурсов, серверы или пулы. Не используйте это приложение или ресурсы, которые оно создает, для рабочей среды. Поработав с приложением, удалите эту группу ресурсов, чтобы завершить связанное выставление счетов.

    * **Группа ресурсов** — щелкните **Создать** и укажите **имя** новой группы ресурсов. **Расположение** — выберите расположение из раскрывающегося списка.
    * **Пользователь** — для некоторых ресурсов требуются глобально уникальные имена. Чтобы гарантировать уникальность имени, при каждом развертывании приложения указывайте значение, по которому созданные ресурсы будут отличаться от ресурсов, созданных при других развертываниях приложения Wingtip. Мы рекомендуем использовать короткое имя **пользователя**, в частности инициалы и какое-либо число (например, *bg1*), а затем использовать это значение для имени группы ресурсов (например, *wingtip-bg1*). Параметр **Пользователь** может содержать только буквы, цифры и дефисы (без пробелов). В качестве первого и последнего символа используйте букву или цифру (желательно символы нижнего регистра).


1. **Разверните приложение.**

    * Установите флажок, чтобы принять условия.
    * Щелкните **Приобрести**.

1. Отслеживайте состояние развертывания. Для этого щелкните **Уведомления** (значок колокольчика справа от поля поиска). Развертывание приложения SaaS Wingtip занимает примерно пять минут.

   ![Развертывание выполнено](media/sql-database-saas-tutorial/succeeded.png)

## <a name="download-and-unblock-the-wingtip-saas-scripts"></a>Загрузка и разблокировка скриптов SaaS Wingtip

Пока выполняется развертывание приложения, загрузите исходный код и скрипты управления.

> [!IMPORTANT]
> Исполняемое содержимое (скрипты, библиотеки DLL) может быть заблокировано Windows, в то время как ZIP-файлы можно загрузить с внешнего источника, а затем извлечь их содержимое. При извлечении скриптов из ZIP-файла выполните указанные ниже действия, чтобы разблокировать ZIP-файл перед извлечением. После этого скрипты можно выполнять.

1. Перейдите к [репозиторию GitHub SaaS Wingtip](https://github.com/Microsoft/WingtipSaaS).
1. Выберите **Clone or download** (Клонировать или скачать).
1. Выберите **Download ZIP** (Загрузить ZIP) и сохраните файл.
1. Щелкните правой кнопкой мыши файл **WingtipSaaS-master.zip** и выберите **Свойства**.
1. На вкладке **Общие** выберите **Разблокировать** и **Применить**.
1. Нажмите кнопку **ОК**.
1. Извлеките файлы.

Скрипты находятся в папке *..\\WingtipSaaS-master\\Learning Modules*.

## <a name="update-the-configuration-file-for-this-deployment"></a>Обновление файла конфигурации для развертывания

Перед запуском каких-либо скриптов настройте значения *группы ресурсов* и *пользователя* в файле **UserConfig.psm1**. Задайте для этих переменных значения, указанные во время развертывания.

1. В *интегрированной среде сценариев PowerShell* откройте файл \\Learning Modules\\*UserConfig.psm1*.
1. В полях *ResourceGroupName* и *Name* введите специфические для развертывания значения (только в строках 10 и 11).
1. Сохраните изменения.

Если задать эти значения, относящиеся к развертыванию, здесь, вам не понадобится обновлять их в каждом скрипте.

## <a name="run-the-application"></a>Выполнение приложения

Приложение демонстрирует различные объекты, например концертные залы, джазовые и спортивные клубы, в которых проходят определенные события. Объекты регистрируются как клиенты платформы Wingtip — для удобного перечисления событий и продажи билетов. Каждому объекту присваивается персонализированное веб-приложение для управления событиями и их перечисления, а также для продажи билетов. Все это выполняется независимо от других клиентов. На самом деле каждый клиент получает базу данных SQL, развернутую в эластичный пул SQL.

Основной **концентратор событий** предоставляет список URL-адресов клиента, уникальных для развертывания.

1. Откройте _концентратор событий_ в веб-браузере: http://events.wtp.&lt;пользователь&gt;.trafficmanager.net. Параметр "Пользователь" замените именем пользователя развертывания.

    ![Концентратор событий](media/sql-database-saas-tutorial/events-hub.png)

1. Щелкните **Fabrikam Jazz Club** в *концентраторе событий*.

   ![События](./media/sql-database-saas-tutorial/fabrikam.png)


Чтобы управлять распределением входящего трафика, приложение использует [*диспетчер трафика Azure*](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview). Для страниц событий для определенного клиента необходимо, чтобы имена клиентов были включены в URL-адреса. Все URL-адреса клиента содержат уникальное значение *пользователя* и представлены в следующем формате: http://events.wtp.&lt;пользователь&gt;.trafficmanager.net/*fabrikamjazzclub*. Приложение событий анализирует имя клиента из URL-адреса и использует его, чтобы создать ключ для доступа к каталогу при помощи [*управления размещением сегментов*](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-scale-shard-map-management). Каталог сопоставляет ключ с расположением базы данных клиента. **Концентратор событий** использует расширенные метаданные в каталоге, чтобы получить имя клиента, связанное с каждой базой данных, чтобы предоставить список URL-адресов.

В рабочей среде обычно создают запись CNAME DNS, чтобы [*указать интернет-домен компании*](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-point-internet-domain) для профиля диспетчера трафика.

## <a name="start-generating-load-on-the-tenant-databases"></a>Запуск создания нагрузки в базах данных клиента

Теперь после развертывания приложение готово к работе. Скрипт *Demo-LoadGenerator* PowerShell запускает рабочую нагрузку, выполняющуюся во всех клиентских базах данных. Реальная нагрузка в приложении SaaS обычно случайна и непредсказуема. Для имитации этого типа нагрузки генератор создает нагрузку, распределенную по всем клиентам, со случайными пиковыми нагрузками в каждом клиенте, происходящими со случайными интервалами. По этой причине шаблон нагрузки появляется в течение нескольких минут, поэтому перед мониторингом нагрузки генератор должен работать по крайней мере три или четыре минуты.

1. В *интегрированной среде сценариев PowerShell* откройте скрипт ...\\Learning Modules\\Utilities\\*Demo-LoadGenerator.ps1*.
1. Нажмите клавишу **F5**, чтобы запустить скрипт и генератор нагрузки (оставьте значения параметра по умолчанию).

> [!IMPORTANT]
> Для этого откройте новое окно интегрированной среды сценариев PowerShell. Генератор нагрузки выполняется как ряд заданий в локальном сеансе PowerShell. Скрипт *Demo-LoadGenerator.ps1* запускает скрипт генератора фактической нагрузки, выполняющийся как задача переднего плана, а также несколько заданий создания фоновой нагрузки. Задание генератора нагрузки вызывается для каждой базы данных, зарегистрированной в каталоге. Задания выполняются в локальном сеансе PowerShell, поэтому при его закрытии все задания останавливаются. Если приостановить работу компьютера, создание нагрузки будет приостановлено и будет возобновлено после включения компьютера.

После того, как генератор нагрузки вызывает задания создания нагрузки для каждого клиента, задача переднего плана остается в состоянии вызова заданий, в котором она запускает дополнительные фоновые задания для любых новых клиентов, которые затем подготавливаются. Вы можете нажать клавиши *CTRL+C* или кнопку *Остановить*, чтобы остановить задачу переднего плана, но имеющиеся фоновые задания будут продолжать создавать нагрузку на каждую базу данных. Если необходимо отслеживать и контролировать фоновые задания, используйте *Get-Job*, *Receive-Job* и *Stop-Job*. Во время выполнения задачи переднего плана нельзя использовать сеанс PowerShell для выполнения других скриптов. Для этого откройте новое окно интегрированной среды сценариев PowerShell.

Если необходимо перезапустить сеанс генератора нагрузки, например, с разными параметрами, можно остановить задачу переднего плана, а затем повторно запустить скрипт *Demo-LoadGenerator.ps1*. При повторном выполнении скрипта *Demo-LoadGenerator.ps1* сначала останавливаются все выполняемые задания, а затем перезапускается генератор, в результате чего запускается новый набор заданий с использованием текущих параметров.

Пока оставьте генератор нагрузки в состоянии вызова задания.


## <a name="provision-a-new-tenant"></a>Подготовка нового клиента

При первоначальном развертывании создаются три примера клиента, но давайте создадим другого клиента, чтобы увидеть, как это влияет на развернутое приложение. Рабочий процесс подготовки клиентов SaaS Wingtip подробно описан в [руководстве по подготовке и каталогам](sql-database-saas-tutorial-provision-and-catalog.md). На этом шаге вы сможете быстро создать клиент.

1. В *интегрированной среде сценариев PowerShell* откройте файл \\Learning Modules\Provision and Catalog\\*Demo-ProvisionAndCatalog.ps1*.
1. Нажмите клавишу **F5** для запуска скрипта (оставьте значения по умолчанию).

   > [!NOTE]
   > Во многих скриптах SaaS Wingtip используется переменная *$PSScriptRoot*. Это позволяет переходить по папкам, чтобы вызывать функции в других скриптах. Эта переменная вычисляется только при выполнении скрипта путем нажатия клавиши **F5**.  Если выделить несколько скриптов и запустить их (**F8**), может произойти ошибка, поэтому нажмите клавишу **F5** при выполнении скриптов.

Новая база данных клиента создается в эластичном пуле SQL, инициализируется и регистрируется в каталоге. После успешной подготовки в браузере появится созданный сайт продажи билетов клиента *События*:

![Новый клиент](./media/sql-database-saas-tutorial/red-maple-racing.png)

Обновите *концентратор событий*, чтобы увидеть в списке новый клиент.


## <a name="explore-the-servers-pools-and-tenant-databases"></a>Изучение серверов, пулов и клиентских баз данных

Теперь, когда вы запустили выполнение нагрузки в коллекции клиентов, давайте рассмотрим некоторые из развернутых ресурсов.

1. На [портале Azure](http://portal.azure.com) перейдите к списку серверов SQL Server и откройте сервер **catalog-&lt;пользователь&gt;**. Сервер каталога содержит две базы данных — **tenantcatalog** и **basetenantdb** (пустая *"золотая"* база данных или шаблон базы данных, скопированный для создания клиентов).

   ![databases](./media/sql-database-saas-tutorial/databases.png)

1. Вернитесь к списку серверов SQL Server и откройте сервер **tenants1-&lt;пользователь&gt;**, который содержит клиентские базы данных. Каждая клиентская база данных является эластичной базой данных _уровня "Стандартный"_ в пуле уровня "Стандартный" на 50 eDTU. Кроме того, обратите внимание, что существует база данных _Red Maple Racing_ (подготовленная ранее клиентская база данных).

   ![server](./media/sql-database-saas-tutorial/server.png)

## <a name="monitor-the-pool"></a>Отслеживание пула

Если генератор нагрузки выполнялся несколько минут, тогда доступен достаточный объем данных, чтобы рассмотреть некоторые функции мониторинга, встроенные в пулы и базы данных.

1. Перейдите к серверу **tenants1 -&lt;пользователь&gt;**и щелкните **Pool1**, чтобы просмотреть сведения об использовании ресурсов для пула (на следующих графиках генератор нагрузки работал в течение часа):

   ![Отслеживание пула](./media/sql-database-saas-tutorial/monitor-pool.png)

На этих диаграммах хорошо видно, насколько хорошо подходят эластичные пулы и база данных SQL для рабочих нагрузок приложения SaaS. Четыре базы данных, каждая из которых передает 40 eDTU, легко поддерживаются пулом, рассчитанным на 50 eDTU. Если они были подготовлены как автономные базы данных, каждая из них должна быть уровня S2 (50 DTU), чтобы поддерживать пиковые нагрузки. Стоимость 4 автономных баз данных уровня S2 в 3 раза превышала бы стоимость пула, а для пула по-прежнему предусмотрен большой резерв, так что он может вместить гораздо большее число баз данных. На самом деле клиенты базы данных SQL используют до 500 баз данных в пулах на 200 eDTU. Дополнительные сведения см. в статье об [отслеживании производительности примера приложения SaaS для WTP](sql-database-saas-tutorial-performance-monitoring.md).


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]

> * как развернуть и изучить мультитенантное приложение SaaS Wingtip;
> * О серверах, пулах и базах данных, формирующих приложение.
> * О клиентах, сопоставленных с данными с помощью *каталога*.
> * Как подготовить новые клиенты.
> * Как просмотреть историю использования пула для отслеживания работы клиента.
> * Как удалить примеры ресурсов, чтобы прекратить связанное выставление счетов.

А теперь мы рекомендуем ознакомиться со статьей [Provision new tenants and register them in the catalog](sql-database-saas-tutorial-provision-and-catalog.md) (Подготовка новых клиентов и их регистрация в каталоге).



## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по приложению SaaS Wingtip](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)
* Дополнительные сведения об эластичных пулах см. в статье [*Эластичные пулы помогают управлять несколькими базами данных SQL и масштабировать их*](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-pool).
* Дополнительные сведения об эластичных заданиях см. в статье [*Управление масштабируемыми облачными базами данных*](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-jobs-overview).
* Дополнительные сведения о шаблонах разработки для мультитенантных приложений SaaS и базы данных SQL Azure см. в [*этой статье*](https://docs.microsoft.com/azure/sql-database/sql-database-design-patterns-multi-tenancy-saas-applications).
