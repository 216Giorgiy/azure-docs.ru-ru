<properties 
	pageTitle="Политики в службе управления API Azure | Microsoft Azure" 
	description="Сведения о создании, изменении и настройке политик в службе управления API." 
	services="api-management" 
	documentationCenter="" 
	authors="steved0x" 
	manager="douge" 
	editor=""/>

<tags 
	ms.service="api-management" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/12/2016" 
	ms.author="sdanie"/>


#Политики в Azure API Management

В службе управления API Azure политики представляют собой одну из эффективных функций системы, позволяющих издателю изменять поведение интерфейса API путем его настройки. Политика — это коллекция операторов, которые выполняются последовательно по запросу интерфейса API или при получении из него ответа. К часто используемым операторам относятся преобразование формата из XML в JSON, а также ограничение скорости вызовов, позволяющее ограничивать количество входящих вызовов от разработчика. Также существует много готовых политик.

Полный перечень операторов политик и их параметров см. в документе [Справочник по политикам][].

Политики применяются внутри шлюза, который находится между потребителем интерфейса API и управляемым API. Шлюз получает все запросы и обычно отправляет их без изменения в базовый API. Однако политика может применять изменения как для входящего запроса, так и для исходящего ответа.

Выражения политики можно использовать в качестве значений атрибутов или текстовых значений в любой политике управления API, если в ней не указано иное. Некоторые политики, например [Управление потоками][] и [Задание переменной][], основаны на выражениях политики. Подробнее: [Расширенные политики][] и [Выражения политики][].

## <a name="scopes"></a>Как настраивать политики
Политики можно настраивать глобально или на уровне [продукта][], [API][] или [операции][]. Для настройки политики перейдите в редактор политик на портале издателя.

![Меню «Политики»][policies-menu]

Редактор политик состоит из трех основных разделов: область политики \(сверху\), определение политики, где политики можно редактировать, \(слева\) и список операторов \(справа\):

![Редактор политик][policies-editor]

Чтобы начать процесс настройки политики, необходимо сначала выбрать область, в которой эта политика должна применяться. На снимке экрана ниже выбран продукт **Starter**. Следует отметить, что символ квадрата рядом с именем политики указывает, что политика уже применена на этом уровне.

![Область][policies-scope]

Так как политика уже применена, конфигурация показана в виде определения.

![Настройка][policies-configure]

Сначала политика отображается в режиме «только для чтения». Чтобы изменить определение, щелкните действие **Настроить политику**.

![Редактирование][policies-edit]

Определение политики представляет собой простой XML-документ, который описывает последовательность входящих и исходящих операторов. Файл XML можно редактировать прямо в окне определения. Перечень операторов отображается справа, а операторы, применимые к текущей области, включены и выделены \(как показано в примере **Ограничить скорость вызовов** на снимке экрана выше\).

При щелчке разрешенного оператора будет добавлен соответствующий XML-код в местоположении курсора в виде определения.

>[AZURE.NOTE] Если политика, которую требуется добавить, не включена, убедитесь, что вы находитесь в правильной области действия этой политики. Каждая инструкция политики предназначена для использования в определенных областях и разделах политики. Чтобы просмотреть разделы политики и области ее действия, ознакомьтесь с разделом **Использование** для этой политики в [справочнике по политикам][].

Полный перечень операторов политик и их параметров см. в документе [Справочник по политикам][].

Например, для добавления нового оператора с целью ограничения входящих запросов на указанные IP-адреса поместите курсор внутрь XML-элемента `inbound` и щелкните оператор **Ограничить IP-адреса вызывающего объекта**.

![Политики ограничения][policies-restrict]

При этом будет добавлен фрагмент XML-кода в элемент `inbound`, который будет содержать указания о том, как настроить оператор.

	<ip-filter action="allow | forbid">
		<address>address</address>
		<address-range from="address" to="address"/>
	</ip-filter>

Для ограничения входящих запросов и принятия только тех запросов, которые поступают с IP-адреса 1.2.3.4, измените XML-код следующим образом:

	<ip-filter action="allow">
		<address>1.2.3.4</address>
	</ip-filter>

![Сохранить][policies-save]

По окончании процесса настройки операторов для политики щелкните **Сохранить**, и изменения будут немедленно распространены на шлюз управления API.

##<a name="sections"></a>Общая информация о конфигурации политики

Политика — это набор операторов, которые выполняются для создания запроса и получения ответа. Конфигурация делится соответствующим образом на разделы `inbound`, `backend`, `outbound` и `on-error`, как показано в следующей конфигурации.

	<policies>
	  <inbound>
	    <!-- statements to be applied to the request go here -->
	  </inbound>
	  <backend>
	    <!-- statements to be applied before the request is forwarded to 
	         the backend service go here -->
	  </backend>
	  <outbound>
	    <!-- statements to be applied to the response go here -->
	  </outbound>
	  <on-error>
	    <!-- statements to be applied if there is an error condition go here -->
	  </on-error>
	</policies> 

Если во время обработки запроса произошла ошибка, все оставшиеся действия в разделах `inbound`, `backend` или `outbound` пропускаются, и начинают выполняться операторы из раздела `on-error`. Поместив операторы политики в раздел `on-error`, вы можете просмотреть ошибку с помощью свойства `context.LastError`, изучить и настроить ответ на ошибку с помощью политики `set-body`, а также настроить, что именно происходит при возникновении ошибки. Существуют коды ошибок для встроенных действий и для ошибок, которые могут возникать во время обработки оператора политики. Дополнительные сведения см. в статье [Обработка ошибок в политиках управления API](https://msdn.microsoft.com/library/azure/mt629506.aspx).

Так как политики могут быть указаны на разных уровнях \(глобальном, продукта, API и операции\), конфигурация позволяет указать порядок, в котором операторы определения политики будут выполняться применительно к родительской политике.

Области политики вычисляются в следующем порядке.

1. Глобальная область
2. Область продукта
3. Область API
4. Область операций

Операторы внутри них вычисляются с учетом размещения элемента `base` при его наличии.

Например, если у вас есть политика на глобальном уровне и политика, настроенная для API, то при каждом использовании этого API будут применяться обе политики. API Management позволяет детерминированным образом упорядочивать объединенные операторы политик через основной элемент.

	<policies>
    	<inbound>
        	<cross-domain />
        	<base />
        	<find-and-replace from="xyz" to="abc" />
    	</inbound>
	</policies>

В примере определения политики, приведенном выше, оператор `cross-domain` будет выполняться перед любыми более высокими политиками, после которых, в свою очередь, будет следовать политика `find-and-replace`.

Если одна и та же политика встречается в операторе политики дважды, применяется наиболее недавно вычисленная политика. Это можно использовать для переопределения политик, которые определены в области более высокого уровня. Чтобы просмотреть политики в текущей области в редакторе политик, щелкните **Recalculate effective policy for selected scope** \(Пересчитать эффективную политику для выбранной области\).

Обратите внимание, что для глобальной политики не существует родительской политики, поэтому использовать в ней элемент `<base>` бесполезно.

## Дальнейшие действия

Посмотрите следующие видео о выражениях политики.

> [AZURE.VIDEO policy-expressions-in-azure-api-management]

[Справочник по политикам]: api-management-policy-reference.md
[справочнике по политикам]: api-management-policy-reference.md
[продукта]: api-management-howto-add-products.md
[API]: api-management-howto-add-products.md#add-apis
[операции]: api-management-howto-add-operations.md

[Расширенные политики]: https://msdn.microsoft.com/library/azure/dn894085.aspx
[Управление потоками]: https://msdn.microsoft.com/library/azure/dn894085.aspx#choose
[Задание переменной]: https://msdn.microsoft.com/library/azure/dn894085.aspx#set_variable
[Выражения политики]: https://msdn.microsoft.com/library/azure/dn910913.aspx

[policies-menu]: ./media/api-management-howto-policies/api-management-policies-menu.png
[policies-editor]: ./media/api-management-howto-policies/api-management-policies-editor.png
[policies-scope]: ./media/api-management-howto-policies/api-management-policies-scope.png
[policies-configure]: ./media/api-management-howto-policies/api-management-policies-configure.png
[policies-edit]: ./media/api-management-howto-policies/api-management-policies-edit.png
[policies-restrict]: ./media/api-management-howto-policies/api-management-policies-restrict.png
[policies-save]: ./media/api-management-howto-policies/api-management-policies-save.png

<!---HONumber=AcomDC_0413_2016-->