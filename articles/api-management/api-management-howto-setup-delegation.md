<properties 
	pageTitle="Делегирование пользователю регистрации и подписки на продукт" 
	description="Узнайте, как делегировать регистрации пользователей и подписки на продукты третьим лицам в службе управления API Azure." 
	services="api-management" 
	documentationCenter="" 
	authors="antonba" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="api-management" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="06/18/2015" 
	ms.author="antonba"/>

# Делегирование пользователю регистрации и подписки на продукт

Делегирование позволяет использовать ваш существующий веб-сайт для обработки входа и регистрации разработчика и подписки на продукты вместо применения встроенной функции на портале разработчика. В результате этого веб-сайт будет владеть пользовательскими данными и проверять эти шаги в соответствии с вашими настройками.

## <a name="delegate-signin-up"></a>Делегирование входа и регистрации разработчика

Для делегирования входа и регистрации разработчика на существующем веб-сайте будет нужно создавать специальную конечную точку делегирования на своем сайте, которая действует как точка входа для любого подобного запроса, инициируемого с портала разработчика службы управления API.

Итоговый рабочий процесс будет иметь следующий вид:

1. Разработчик щелкает ссылку для входа или регистрации на портале разработчика API Management
2. Браузер перенаправляется в конечную точку делегирования
3. В свою очередь, конечная точка делегирования перенаправляется или представляет интерфейс пользователя, который предлагает пользователю войти в систему или зарегистрироваться
4. При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс


Сначала следует настроить службу управления API так, чтобы он направлял запросы через вашу конечную точку делегирования. На портале издателя управления API щелкните **Безопасность** и перейдите на вкладку **Делегирование**. Для активации параметра "Делегирование входа и регистрации" установите соответствующий флажок.

![Страница «Делегирование»][api-management-delegation-signin-up]

* Выберите для себя нужный URL-адрес своей специальной конечной точки делегирования и введите его в поле **URL-адрес конечной точки делегирования**. 

* В поле **Ключ проверки подлинности делегирования** введите секретный ключ, который будет использоваться для вычисления сигнатуры, благодаря которой будет можно убедиться, что запрос действительно поступает из службы управления Azure API. Вы можете нажать кнопку **Создать**, и служба управления API сгенерирует для вас случайный ключ.

Теперь необходимо создать **конечную точку делегирования**. Для этого следует выполнить несколько действий:

1. Получите запрос в следующей форме:

	> *http://www.yourwebsite.com/apimdelegation?operation=SignIn&returnUrl={URL of source page}&salt={string}&sig={string}*

	Параметры запроса для входа или регистрации: **operation** – определяет тип запроса на делегирование (в данном случае это может быть только **SignIn**); **returnUrl** – URL-адрес страницы, где пользователь щелкнул ссылку для входа или регистрации; **salt** – специальная строка случайных данных, используемая для вычисления хэша безопасности; **sig** – вычисленный хэш безопасности, который будет использоваться для сравнения с вашим вычисленным хэшем.

2. Убедитесь, что запрос поступает из службы управления Azure API (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)

	* Вычислите хэш HMAC-SHA512 строки на основе параметров запроса **returnUrl** и **salt** ([на приведенном ниже примере кода]).
        > **returnUrl**
		 
	* Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. Если нет, отклоните запрос.

2. Убедитесь, что вы получаете запрос на вход или регистрацию: для параметра запроса **operation** будет установлено значение **SignIn**.

3. Предоставление пользователю интерфейса для входа или регистрации

4. Если пользователь регистрируется, для него необходимо создать соответствующую учетную запись в API Management. Выполните операцию [Создание пользователя] с помощью интерфейса API Management REST API. После этого убедитесь, что вы ввели тот же идентификатор пользователя, что и идентификатор, который указан в вашем хранилище пользователей, или идентификатор, который можно отслеживать.

5. После успешной проверки подлинности пользователя:

	* [запросите маркер единого входа (SSO)] через API Management REST API

	* добавьте параметр запроса returnUrl в URL-адреса SSO, который вы получили из вызова API, указанного выше:
		> например https://customer.portal.azure-api.net/signin-sso?token&returnUrl=/return/url

	* перенаправьте пользователя на вышеупомянутый URL-адрес

Помимо использования операции **SignIn**, вы можете управлять учетными записями, выполнив указанные выше действия и одну из следующих операций.

-	**ChangePassword**;
-	**ChangeProfile**;
-	**CloseAccount**.

Для операций управления учетными записями необходимо передать следующие параметры запроса.

-	**operation** – определяет тип запроса на делегирование (ChangePassword, ChangeProfile или CloseAccount).
-	**userId** – идентификатор пользователя учетной записи для управления.
-	**salt** – специальная строка случайных данных, используемая для вычисления хэша безопасности.
-	**sig** – вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем.

## <a name="delegate-product-subscription"></a>Делегирование подписки на продукт

Процедура делегирования подписки на продукт похожа на процедуру делегирования входа или регистрации пользователя. Итоговый рабочий процесс будет иметь следующий вид:

1. Разработчик выбирает продукт на портале разработчика API Management и щелкает кнопку «Подписка»
2. Браузер перенаправляется в конечную точку делегирования
3. Конечная точка делегирования выполняет требуемые шаги подписки на продукт. Эту процедуру выполняете вы. В нее могут входить перенаправление на другую страницу для запроса сведений о выставлении счетов, формулирование дополнительных вопросов или просто сохранение информации без выполнения действий пользователя
4. При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс

Чтобы включить функцию на странице **Делегирование** щелкните **Делегировать подписку на продукт**.

Затем убедитесь, что конечная точка делегирования выполняет следующие действия:


1. Получите запрос в следующей форме:

	> *http://www.yourwebsite.com/apimdelegation?operation={operation}&productId={product to subscribe to}&userId={user making request}&salt={string}&sig={string}*

	Параметры запроса для подписки на продукт: **operation** – определяет тип запроса на делегирование. Допустимые значения для запросов подписки на продукт: Subscribe – запрос на подписку пользователя на данный продукт с помощью предоставленного идентификатора (см. ниже); Unsubscribe – запрос на отмену подписки пользователя на продукт; Renew – запрос на обновление подписки (например, подписки с возможно истекающим сроком действия); **productId** – идентификатор продукта, запрошенный пользователем для подписки; **userId** – идентификатор пользователя, для которого выполняется запрос; **salt** – специальная строка случайных данных, используемая для вычисления хэша безопасности; **sig** – вычисленный хэш безопасности, используемый для сравнения с вашим вычисленным хэшем.


2. Убедитесь, что запрос поступает из службы управления Azure API (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)

	* Вычислите хэш HMAC-SHA512 строки на основании параметров запроса **productId**, **userId** и **salt**:
		> **productId****userId**
		 
	* Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. В противном случае, отклоните запрос.
	
3. Выполните процедуру обработки подписки на продукт на основании типа операции, запрашиваемой в параметре **operation** - например, выставление счетом, дополнительные вопросы и т. д.

4. В случае успешной подписки пользователя на продукт на вашей стороне подпишите пользователя на продукт службы управления API путем [вызова интерфейса REST API для подписки на продукт].

5. Перенаправьте пользователя обратно на адрес **redirectUrl**, который был указан при получении запроса.

## <a name="delegate-example-code"></a>Пример кода ##

В этих примерах кода показано, как получить *ключ проверки делегирования*, который задается на странице делегирования портала управления API, и как создать HMAC, который затем используется для проверки подписи, подтверждающей действительность переданного returnUrl. Тот же код с незначительными изменениями подходит для productId и userId.

**Код C# для создания хэша returnUrl**

    using System.Security.Cryptography;

    string key = "delegation validation key";
    string returnUrl = "returnUrl query parameter";
    string salt = "salt query parameter";
    string signature;
    using (var encoder = new HMACSHA512(Convert.FromBase64String(key)))
    {
        signature = Convert.ToBase64String(encoder.ComputeHash(Encoding.UTF8.GetBytes(salt + "\n" + returnUrl)));
        // change to (salt + "\n" + productId + "\n" + userId) when delegating product subscription
        // compare signature to sig query parameter
    }


**Код NodeJS для создания хэша returnUrl**

	var crypto = require('crypto');
	
	var key = 'delegation validation key'; 
	var returnUrl = 'returnUrl query parameter';
	var salt = 'salt query parameter';
	
	var hmac = crypto.createHmac('sha512', new Buffer(key, 'base64'));
	var digest = hmac.update(salt + '\n' + returnUrl).digest();
    // change to (salt + "\n" + productId + "\n" + userId) when delegating product subscription
    // compare signature to sig query parameter
	
	var signature = digest.toString('base64');

## Дальнейшие действия

Дополнительную информацию о делегировании см. в следующем видео.

> [AZURE.VIDEO delegating-user-authentication-and-product-subscription-to-a-3rd-party-site]

[Delegating developer sign-in and sign-up]: #delegate-signin-up
[Delegating product subscription]: #delegate-product-subscription
[запросите маркер единого входа (SSO)]: http://go.microsoft.com/fwlink/?LinkId=507409
[Создание пользователя]: http://go.microsoft.com/fwlink/?LinkId=507655#CreateUser
[вызова интерфейса REST API для подписки на продукт]: http://go.microsoft.com/fwlink/?LinkId=507655#SSO
[Next steps]: #next-steps
[на приведенном ниже примере кода]: #delegate-example-code

[api-management-delegation-signin-up]: ./media/api-management-howto-setup-delegation/api-management-delegation-signin-up.png

<!---HONumber=July15_HO3-->