---
title: "Как использовать управление API Azure с виртуальными сетями"
description: "Узнайте, как настроить подключение к виртуальной сети в управлении API Azure и обращаться к веб-службам через него."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/20/2016
ms.author: antonba
translationtype: Human Translation
ms.sourcegitcommit: 2ea002938d69ad34aff421fa0eb753e449724a8f
ms.openlocfilehash: 7dfbf0e460dc8de13a4a71c1f925c93f6238df5d


---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a>Как использовать управление API Azure с виртуальными сетями
Виртуальные сети Azure позволяют размещать любые ресурсы Azure в сети, недоступной из Интернета, доступом к которой управляете вы сами. Эти сети можно подключать к локальным сетям с помощью разных технологий VPN. Начать изучение виртуальных сетей Azure лучше всего со статьи [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md).

Службу управления API Azure можно подключить к виртуальной сети, чтобы у нее был доступ к внутренним службам, размещенным в сети, и чтобы в этой сети были доступны портал разработчика и шлюз API.

## <a name="enable-vpn"> </a>Включение подключения к виртуальной сети
> Возможность подключения к виртуальным сетям доступна только на уровнях **Премиум** и **Developer**. Чтобы перейти на другой уровень, откройте службу управления API на портале Azure и перейдите на вкладку **Scale and pricing** (Масштаб и цены). В разделе **Ценовая категория** выберите уровень "Премиум" и нажмите кнопку "Сохранить".
> 
> 

Чтобы включить подключения к виртуальным сетям, откройте службу управления API на портале Azure и перейдите на страницу **Виртуальная сеть**.

![Меню "Виртуальная сеть" для управления API][api-management-using-vnet-menu]

Выберите нужный тип доступа.

* **Внешний**: шлюз управления API и портал разработчика доступны из общедоступного Интернета через внешнюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

![Общедоступный пиринг][api-management-vnet-public]

* **Внутренний**: шлюз управления API и портал разработчика доступны только из виртуальной сети через внутреннюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

![Частный пиринг][api-management-vnet-private]

Будет показан список всех регионов, где предоставляется служба управления API. Выберите виртуальную сеть и подсеть для каждого региона. Список заполняется классическими виртуальными сетями и виртуальными сетями ARM, имеющимися в подписках Azure, которые настроены в настраиваемом регионе.

![Выбор VPN][api-management-setup-vpn-select]

Щелкните **Сохранить** в верхней части экрана. 

> Во время обновления невозможно будет выполнять операции управления службой управления API. Шлюз управления API и портал разработчика останутся доступными для использования.
> Обратите внимание, что виртуальный IP-адрес экземпляра службы управления API может изменяться при каждом включении или отключении виртуальной сети.
> 
> 

## <a name="enable-vnet-powershell"> </a>Включение подключения к виртуальной сети с помощью командлетов PowerShell
Возможность подключения к виртуальной сети можно также включить с помощью командлета PowerShell [Set-AzureRmApiManagementVirtualNetworks](https://msdn.microsoft.com/library/mt619277.aspx).

## <a name="connect-vnet"> </a>Подключение к веб-службе, размещенной в виртуальной сети
После подключения службы управления API к виртуальной сети обращение к размещенным в ней внутренним службам ничем не будет отличаться от обращения к общедоступным службам. Просто введите локальный IP-адрес или имя узла (если для виртуальной сети настроен DNS-сервер) веб-службы в поле **URL-адрес веб-службы** при создании нового API или редактировании существующего.

![Добавление интерфейса API из VPN][api-management-setup-vpn-add-api]

## <a name="custom-dns"> </a>Настройка пользовательского DNS-сервера
Управление API зависит от нескольких служб Azure. Если служба управления API размещается в виртуальной сети, в которой используется пользовательский DNS-сервер, необходимо иметь возможность разрешения имен узлов этих служб Azure. Следуйте [этим](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) рекомендациям по настройке пользовательского DNS-сервера. Ознакомьтесь со схемами и таблицей портов ниже.

## <a name="ports-required"> </a>Порты, необходимые для управления API
> Если какой-либо из этих портов недоступен, служба управления API может не работать должным образом и может стать недоступной. Блокировка одного или нескольких из этих портов является самой распространенной проблемой неправильной настройки при использовании управления API в виртуальной сети.
> 
> 

При размещении экземпляра службы управления API в виртуальной сети используются порты, указанные в следующей таблице.

| Порты | Направление | Транспортный протокол | Назначение | Источник и назначение | Тип доступа |
| --- | --- | --- | --- | --- | --- |
| 80, 443 |Входящий трафик |TCP |Подключения клиентов к службе управления API |INTERNET — VIRTUAL_NETWORK |Внешний |
| 3443 |Входящий трафик |TCP |Конечная точка управления |INTERNET — VIRTUAL_NETWORK |Внешний и внутренний |
| 80, 443 |Исходящие |TCP |Зависимость для службы хранилища Azure и служебной шины Azure |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| 1433 |Исходящие |TCP |Зависимость от SQL Azure |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| 9350, 9351, 9352, 9353, 9354 |Исходящие |TCP |Зависимость для служебной шины |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| 5671 |Исходящие |AMQP |Зависимость для политики ведения журнала концентратора событий |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| 6381, 6382, 6383 |Входящий и исходящий трафик |UDP |Зависимость для кэша Redis |VIRTUAL_NETWORK — VIRTUAL_NETWORK |Внешний и внутренний |
| 445 |Исходящие |TCP |Зависимость для общей папки Azure для GIT |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |

## <a name="limitations"> </a>Ограничения
* Подсеть, содержащая экземпляры службы управления API, не может содержать ресурсы Azure каких-либо других типов.
* Эта подсеть и служба управления API должны находиться в одной подписке.
* Невозможно переместить между подписками подсеть, содержащую экземпляры службы управления API.
* При использовании внутренней виртуальной сети будет доступен только внутренний IP-адрес из диапазона, перечисленного в документе [RFC 1918](https://tools.ietf.org/html/rfc1918). Общедоступный IP-адрес предоставить невозможно.
* При развертывании службы управления API с внутренними виртуальными сетями в нескольких регионах пользователи отвечают за управление собственной балансировкой, так как им принадлежит служба DNS.

## <a name="related-content"> </a>Связанная информация
* [Создание виртуальной сети с VPN-подключением типа "сеть — сеть" с помощью портала Azure][Создание виртуальной сети с VPN-подключением типа "сеть — сеть" с помощью портала Azure]
* [Как использовать инспектор API для трассировки вызовов в службе управления API Azure][Как использовать инспектор API для трассировки вызовов в службе управления API Azure]

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Включение VPN-подключений]: #enable-vpn
[Подключение к веб-службе за VPN]: #connect-vpn
[Связанная информация]: #related-content


[Создание виртуальной сети с VPN-подключением типа "сеть — сеть" с помощью портала Azure]: ../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md
[Как использовать инспектор API для трассировки вызовов в службе управления API Azure]: api-management-howto-api-inspector.md



<!--HONumber=Nov16_HO3-->


