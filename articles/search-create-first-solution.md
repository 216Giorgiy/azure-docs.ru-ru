<properties title="Создайте свое первое решение с использованием Поиска Azure" pageTitle="Создайте свое первое решение с использованием Поиска Azure" description="Создайте свое первое решение с использованием Поиска Azure" metaKeywords="" services="" solutions="" documentationCenter="" authors="Heidist" manager="mblythe" videoId="" scriptId="" />

<tags ms.service="azure-search" ms.devlang="" ms.workload="search" ms.topic="article" ms.tgt_pltfrm="" ms.date="09/23/2014" ms.author="heidist" />

# Создайте свое первое решение с использованием Поиска Azure

-   [Предварительные требования][Предварительные требования]
-   [Создание индекса Поиска Azure][Создание индекса Поиска Azure]
-   [Обзор CatalogIndexer][Обзор CatalogIndexer]
-   [Создание приложения MVC4 с помощью Поиска Azure][Создание приложения MVC4 с помощью Поиска Azure]
-   [Обзор AdventureWorksWeb][Обзор AdventureWorksWeb]
-   [Дальнейшие действия][Дальнейшие действия]

## Обзор

В данном примере рассматривается поисковое приложение, созданное для компании Adventure Works, занимающейся производством велосипедов. По итогам выполнения всех заданий данного учебника будет создан онлайн-каталог продукции, обладающий широкими возможностями для поиска, среди которых: многоаспектная навигация, различные параметры для сортировки поисковых результатов, а также всплывающие по мере ввода поисковых запросов подсказки.

![][0]

Данный демонстрационный пример позволяет начать работу с Поиском Azure посредством выполнения следующих упражнений:

-   Создание индекса Поиска Azure.
-   Выполнение загрузки документов (данных) в индекс службы Поиска Azure из базы данных SQL Server.
-   Создание MVC4 приложения на ASP.NET, которое использует Поиск Azure для выполнения следующих операций:

    -   Поиск и отображение результатов, полученных из индекса службы Поиска Azure
    -   Отображение подсказок по мере ввода текста поисковых запросов в поле Поиска
    -   Фильтрация поисковых результатов на основе использования концепции аспектов

## Предварительные требования

-   Visual Studio 2012 или более поздней версии с ASP.NET MVC 4 и SQL Server. Вы можете скачать Visual Studio 2013 Express через Интернет из [Центра загрузки][Центра загрузки].
-   Служба "Поиск Azure". Вам понадобятся имя службы поиска и ключ администратора. Более подробная информация приводится в разделе [Начало работы со службой Поиска Azure][Начало работы со службой Поиска Azure].
-   [Демонстрационный проект Поиска Azure для Adventure Works на CodePlex][Демонстрационный проект Поиска Azure для Adventure Works на CodePlex]. На вкладке Source Code (Исходный код) нажмите **Download** (Загрузить), чтобы скачать ZIP-архив с решением.

    ![][1]

Это решение содержит два проекта:

-   **CatalogIndex** — здесь выполняется создание индекса для Поиска Azure и загрузка данных, включенных в настоящий проект, из базы данный SQL Server.
-   **AdventureWorksWeb** является приложением, созданным на базе MVC4 и предназначенным для отправки запросов в индекс Поиска Azure. Использование этого учебника предполагает наличие у вас достаточных знаний по работе с ASP.NET MVC.

[WACOM.INCLUDE [Для работы с этим учебником необходима учетная запись Azure:](../includes/free-trial-note.md)]

## Создание индекса Поиска Azure

На данном этапе с помощью **CatalogIndex** вы создадите новый индекс Поиска Azure, обозначаемый как "каталог" и строящийся на основе базы данных SQL Server AdventureWorks.

1.  В Visual Studio откройте демонстрационное решение на базе поиска Azure с названием **AdventureWorksCatalog.sln**.
2.  Щелкните правой кнопкой мыши на **CatalogIndexer** в Обозревателе решений и выберите пункт **Назначить запускаемым проектом**, что приведет к запуску именно этого приложения, а не проекта **AdventureWorksWeb** после нажатия клавиши **F5**.
3.  Откройте файл **App.config** в этом проекте и присвойте параметрам "SearchServiceName" и "SearchServiceApiKey" соответствующие значения для доступа к службе Поиска Azure. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.
4.  Дополнительно в файле App.config находится параметр "SourceSqlConnectionString", который указывает на базу данных SQL Server 2014 Express (здесь сервер совпадает с базой данных LocalDB версии 11.0). При использовании другой версии SQL Server внесите в название сервера соответствующие изменения. Например, если имеется локальный экземпляр по умолчанию, можно использовать обозначения "(local)" или "localhost".
5.  Сохраните файл **App.config**.
6.  Нажмите клавишу **F5**, чтобы запустить проект.

Должна открыться командная оболочка со следующим текстовым сообщением: "Создается индекс..."

Через некоторое время после завершения операции должно появиться сообщение: "Завершено. Для продолжения нажмите <enter>:"

![][2]

Нажмите клавишу **Enter**, чтобы закрыть это приложение. На данном этапе произошло создание индекса для службы Поиска Azure.

> [WACOM.NOTE] Появление сообщений о таких ошибках, как "неверное значение ключа attachdbfilename" или других ошибок присоединения базы данных, может свидетельствовать о возникновении конфликта на уровне контроля учетных записей (UAC). В рамках настоящего демонстрационного примера для исправления этих ошибок необходимо выполнить следующие действия:
>  Скопируйте решение в новый или уже существующий каталог (например, Temp), доступ к которому есть у авторизованных пользователей.
> Используйте пункт меню **Запустить от имени администратора**, чтобы запустить Visual Studio.
> Откройте решение, скомпилируйте его, а затем нажмите клавишу **F5**, чтобы создать индекс.

Чтобы удостовериться в создании индекса и в загрузке документа, перейдите в панель мониторинга службы Поиска в [Портале предварительной версии Azure][Портале предварительной версии Azure]. Значение параметра "Использование" для индекса должно увеличиться на единицу, и в наличии должно быть 294 документа: по одному для каждого продукта из базы данных.

Щелкните на заголовок **Индексы**, чтобы открыть список индексов. В результате этого появится выпадающий список индексов, в котором должен присутствовать новый индекс и счетчик документов.

![][3]

## Обзор CatalogIndexer

А теперь давайте более подробно познакомимся с проектом **CatalogIndexer** и выясним принципы его работы.

1.  Откройте файл **Program.cs** из Обозревателя решений и перейдите к функции `Main(string[] args)`.

    Обратите внимание на то, каким образом эта функция создает универсальный код ресурса (URI) с именем `_serviceURI` на основе конкретной службы Поиска Azure, а затем создает HttpClient с именем `_httpClient`, который использует ключ API для авторизации в этой службе Поиска.

2.  `ChangeEnumeratorSql` и `ChangeSet` используется для перечисления данных из таблицы продуктов в базе данных SQL Server AdventureWorks.

3.  На основе данных, полученных из этой таблицы, выполняется вызов `ApplyChanges` для того, чтобы применить эти данные к индексу Поиска Azure.

4.  Перейдите к функции `ApplyChanges` в этом же файле. Обратите внимание на то, каким образом эта функция выполняет удаление индекса, если он уже существует (`DeleteCatalogIndex`), а затем создает новый индекс с названием "каталог" (`CreateCatalogIndex`).

5.  Перейдите к функции `CreateCatalogIndex` и обратите внимание на то, как создается индекс по схеме, соответствующей столбцам из таблицы продуктов на SQL Server. В каждом поле имеется параметр "Тип" (например, `Edm.String` или `Edm.Double`), а также атрибуты, которые определяют предназначение этих полей. Более подробная информация о данных атрибутах приводится в [документации API REST для службы Поиска Azure][документации API REST для службы Поиска Azure].

6.  Вернитесь к функции `ApplyChanges`. Обратите внимание на то, как эта функция циклически обрабатывает данные, имеющиеся в нумерованном списке изменений `ChangeSet`. Вместо того чтобы применять эти изменения последовательно, они разбиваются на группы по 1 000 штук, а затем передаются в службу Поиска. Такой подход является более эффективным по сравнению с последовательной обработкой документов.

Теперь после знакомства с процессом создания и заполнения индекса с помощью реляционных данных c SQL Server рассмотрим создание каталога продуктов, в котором используются эти поисковые данные.

## Создание приложения MVC4 с помощью Поиска Azure

На данном этапе мы создадим и запустим поисковое приложение в веб-браузере.

1.  В Visual Studio откройте демонстрационное решение на базе поиска Azure с названием **AdventureWorksCatalog.sln**.

2.  Щелкните правой кнопкой мыши **AdventureWorksWeb** в обозревателе решений и выберите команду **Назначить запускаемым проектом**.

3.  Откройте в этом проекте файл **Web.config** и присвойте параметрам "SearchServiceName" и "SearchServiceApiKey" значения, соответствующие службе поиска Azure. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.

4.  Сохраните файл **Web.config**.

5.  Нажмите клавишу **F5**, чтобы запустить проект. Если возникнет ошибка сборки, следуйте инструкциям по [устранению неполадок][устранению неполадок].

    ![][4]

6.  Оставьте поле поиска пустым и нажмите кнопку **Поиск**, при этом отобразятся все 294 продукта.

7.  Обратите внимание на перечень аспектов, расположенный с левой стороны. Нажмите на один из этих аспектов. Это приведет к повторному выполнению процедуры поиска, но при этом произойдет добавление выбранного вами аспекта для фильтрации обнаруженных результатов. В файле **HomeController.cs** можно добавить точку останова в первую строку функции `Search`, что позволит последовательно продвигаться по каждой строке нажатием клавиши F11.

8.  Введите поисковый шаблон, например "mountain bikes" (горные велосипеды). По мере ввода текстовых символов появится выпадающий список подсказок с обнаруженными по запросу результатами поиска.

    ![][5]

Рисунок, уже приводившийся в начале данного демонстрационного проекта, вновь приводится ниже в качестве напоминания об освещенных здесь вопросах. В предыдущих разделах обсуждались следующие темы: многоаспектная навигация (отображающаяся с левой стороны), счетчик документов, присутствующий вверху страницы, подсказки, параметры сортировки для отбора результатов по наибольшей степени соответствия, по алфавитному порядку или по цене.

![][0]

## Обзор AdventureWorksWeb

Проект AdventureWorksWeb иллюстрирует, как можно использовать ASP.NET MVC 4 для организации взаимодействия между службой Поиска Azure и веб-приложением. В этом разделе будут рассмотрены отдельные части программного кода приложения и их предназначение.

1.  В обозревателе решений разверните элемент **AdventureWorksWeb** | **Controller** и откройте файл **HomeController.cs**

    Данный контроллер MVC предназначен для управления взаимодействием из окна просмотра индекса. В начале программного кода контроллера можно заметить ссылку на функцию `CatalogSearch _catalogSearch`, которая создает объект подключения HttpClient для службы Поиска Azure. Программный код для этой функции `CatalogSearch` находится в файле **CatalogSeach.cs**

2.  В фале **HomeController.cs** имеется две основные функции:

    **Поиск**: Когда пользователь нажимает на кнопку поиска или выбирает какой-либо аспект, происходит вызов данной функции, предназначенной для сбора найденных результатов и отправки их в окно просмотра индекса для последующего отображения.

    **Подсказка**: По мере ввода пользователем шаблона в поле поиска, происходит вызов данной функции, возвращающей список подсказок на основе информации, присутствующей в индексе Поиска Azure.

Давайте разберем работу двух этих функций более подробно.

1.  У присутствующей в файле **HomeController.cs** функции `Search` можно заметить обращение к `_catalogSearch.Search`, где в свою очередь имеется объект подключения к службе поиска Azure. При вызове поисковой функции из файла **CatalogSearch.cs** видно, что она использует эти параметры при создании запроса для службы поиска Azure. Результаты запроса хранятся в объекте JSON с именем `result`, а затем возвращаются в окно просмотра `Index`, где обрабатываются и отображаются в виде веб-страницы.

2.  Откройте файл **Index.cshtml** из каталога Views | Home. Здесь есть программный код, отвечающий за обработку этих результатов.

3.  Остановите работу приложения, если оно запущено, и откройте файл **Index.cshtml** из каталога Views | Home. В конце этого файла имеется функция, написанная на JavaScript, которая использует `JQuery $(function ())`. Эта функция вызывается при загрузке страницы. В ней используется функция автозаполнения JQuery, которая связана с обратным вызовом от поискового текстового поля, обозначенного как "q". Когда пользователь вводит в это поле какой-либо текст, происходит вызов этой функции автозаполнения, которая в свою очередь обращается к /home/suggest с введенным поисковым шаблоном. `/home/suggest` является ссылкой на функцию из файла **HomeController.cs** с названием `Suggest`.

4.  Откройте файл **HomeController.cs** и перейдите к функции "Suggest" (Подсказка). Данный программный код в значительной степени совпадает с функцией "Search" (Поиск), которая использует объект `_catalogSearch` для вызова функции из файла **CatalogSearch.cs** с названием `Suggest`. Вместо того чтобы отправлять поисковый запрос, функция `Suggest` обращается к [Suggestions API][Suggestions API], которая на основе введенного в текстовое поле шаблона формирует список возможных подсказок. Эти значения возвращаются в файл **Index.cshtml** и автоматически отображаются в поле поиска по мере ввода поискового шаблона.

Здесь может возникнуть вопрос относительно критериев, на основе которых служба Поиска Azure выполняет отбор полей, используемых для формирования подсказок. Ответ на него был дан ранее в разделе о создании индекса. В функции `CreateCatalogIndex` из файла Program.cs в проекте **CatalogIndexer** присутствует атрибут с именем `Suggestions`. Когда значение этого атрибута равно `True`, это означает, что служба Поиска Azure может использовать его в качестве поля для получения подсказок

Давайте это проверим.

1.  Скомпилируйте приложение еще раз, а затем нажмите клавишу **F5**, чтобы его запустить.

2.  В поле поиска введите слово "Road" (Дорога). После непродолжительного времени вы увидите отображающийся внизу текстового поля список товаров с подсказками, которые могут заинтересовать пользователя.

Можно добавить точку останова в функцию `Suggest` из файла **HomeController.cs** и последовательно отследить каждый вызов, который выполняется для формирования списка подсказок, нажимая клавишу F11.

На этом демонстрация проекта завершена. Вы познакомились со всеми основными операциями, о которых нужно знать при создании приложения на базе ASP.NET MVC4 с использованием Поиска Azure.

## Устранение ошибки "Невозможно загрузить файл или сборку System.Web.Mvc"

Если при сборке AdventureWorksWeb вы получаете сообщение об ошибке Could not load file or assembly 'System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35' or one of its dependencies (Невозможно загрузить файл или сборку System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35 или один из зависимых компонентов), попробуйте выполнить эти действия, чтобы устранить ошибку.

1.  Откройте консоль диспетчера пакетов: **Tools (Сервис)** | **NuGet Package Manager (Диспетчер пакетов NuGet)** | **Package Manager Console (Консоль диспетчера пакетов)**
2.  В командной строке PM\> введите Update-package -reinstall Microsoft.AspNet.Mvc.
3.  Когда вам будет предложено перезагрузить файл, выберите **Yes to All** (Да для всех).
4.  Повторно выполните сборку и попробуйте еще раз нажать **F5**.

## Дальнейшие действия

Для самостоятельного изучения дополнительных возможностей попробуйте добавить страницу "Details" (Сведения), которая открывается, когда пользователь нажимает указателем мыши на один из поисковых результатов. В качестве подготовки выполните следующие действия:

-   Изучите [API Lookup][API Lookup], это позволит выполнять отправку запросов в службу Поиска Azure для вызова определенного документа (например, можно передавать параметр "productID", отвечающий за идентификацию товара).
-   Добавьте новую функцию в файл **HomeController.cs** и присвойте ей название "Details" (Сведения). Добавьте соответствующее поле просмотра **Details.cshtml**, которое будет получать результаты от упомянутой API Lookup и отображать их.
-   Познакомьтесь со следующими дополнительными примерами программного кода и видеоматериалами, относящимися к теме геопространственного поиска: [Канал 9 — Поиск Azure и геопространственные данные][Канал 9 — Поиск Azure и геопространственные данные], а также [CodePlex: Пример по созданию геопространственного Поиска Azure][CodePlex: Пример по созданию геопространственного Поиска Azure]

Также можно ознакомиться с документацией [API REST для службы Поиска Azure][документации API REST для службы Поиска Azure] в MSDN.

<!--Anchors--> <!--Image references-->

  [Предварительные требования]: #sub-1
  [Создание индекса Поиска Azure]: #sub-2
  [Обзор CatalogIndexer]: #sub-3
  [Создание приложения MVC4 с помощью Поиска Azure]: #sub-4
  [Обзор AdventureWorksWeb]: #sub-5
  [Дальнейшие действия]: #next-steps
  [0]: ./media/search-create-first-solution/AzureSearch_Create1_WebApp.PNG
  [Центра загрузки]: http://www.microsoft.com/ru-ru/download/details.aspx?id=40747
  [Начало работы со службой Поиска Azure]: ../search-get-started/
  [Демонстрационный проект Поиска Azure для Adventure Works на CodePlex]: http://go.microsoft.com/fwlink/p/?LinkID=510972
  [1]: ./media/search-create-first-solution/AzureSearch_Create1_CodeplexDownload.PNG
  [2]: ./media/search-create-first-solution/AzureSearch_Create1_ConsoleMsg.PNG
  [Портале предварительной версии Azure]: https://portal.azure.com
  [3]: ./media/search-create-first-solution/AzureSearch_Create1_DashboardIndexes.PNG
  [документации API REST для службы Поиска Azure]: http://msdn.microsoft.com/ru-ru/library/azure/dn798935.aspx
  [устранению неполадок]: #err-mvc
  [4]: ./media/search-create-first-solution/AzureSearch_Create1_WebAppEmpty.PNG
  [5]: ./media/search-create-first-solution/AzureSearch_Create1_Suggestions.PNG
  [Suggestions API]: http://msdn.microsoft.com/ru-ru/library/azure/dn798936.aspx
  [API Lookup]: http://msdn.microsoft.com/ru-ru/library/azure/dn798929.aspx
  [Канал 9 — Поиск Azure и геопространственные данные]: http://channel9.msdn.com/Shows/Data-Exposed/Azure-Search-and-Geospatial-Data
  [CodePlex: Пример по созданию геопространственного Поиска Azure]: http://azuresearchgeospatial.codeplex.com
