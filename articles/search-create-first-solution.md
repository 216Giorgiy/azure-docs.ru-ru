<properties title="Create your first search solution using Azure Search" pageTitle="Создайте свое первое решение с использованием Поиска Azure" description="Создайте свое первое решение с использованием Поиска Azure" metaKeywords="" services="" solutions="" documentationCenter="" authors="Heidist" manager="mblythe" videoId="" scriptId="" />

<tags ms.service="azure-search" ms.devlang="" ms.workload="search" ms.topic="article"  ms.tgt_pltfrm="" ms.date="09/23/2014" ms.author="heidist" />

# Создайте свое первое решение с использованием Поиска Azure

+ [Необходимые условия](#sub-1)
+ [Создание индекса Поиска Azure](#sub-2)
+ [Обзор CatalogIndexer](#sub-3)
+ [Разработка приложения MVC4 с помощью Поиска Azure](#sub-4)
+ [Обзор AdventureWorksWeb](#sub-5)
+ [Дальнейшие действия](#next-steps)

<h2>Обзор</h2>

<p>В данном примере рассматривается поисковое приложение, созданное для компании Adventure Works, занимающейся производством велосипедов. По итогам выполнения всех заданий данного учебника будет создан онлайн-каталог продукции, обладающий широкими возможностями для поиска, среди которых: многоаспектная навигация, различные параметры для сортировки поисковых результатов, а также всплывающие по мере ввода поисковых запросов подсказки.

   ![][7]

Данный демонстрационный пример позволяет начать работу с Поиском Azure посредством выполнения следующих упражнений:

+	Создание индекса Поиска Azure.
+	Выполнение загрузки документов (данных) в индекс службы Поиска Azure из базы данных SQL Server.
+	Создание MVC4 приложения на ASP.NET, которое использует Поиск Azure для выполнения следующих операций:
	+	Поиск и отображение результатов, полученных из индекса службы Поиска Azure
	+	Отображение подсказок по мере ввода текста поисковых запросов в поле Поиска
	+	Фильтрация поисковых результатов на основе использования концепции аспектов


<h2 id="sub-1">Предварительные требования</h2>

+	Visual Studio 2012 или более поздней версии с ASP.NET MVC 4 и SQL Server. Если программное обеспечение еще не установлено, можно скачать такие бесплатные экспресс-выпуски: [Visual Studio 2013 Express](http://www.visualstudio.com/ru-ru/products/visual-studio-express-vs.aspx) и [Microsoft SQL Server 2014 Express](http://msdn.microsoft.com/ru-ru/evalcenter/dn434042.aspx).
+	Служба "Поиск Azure". Вам понадобятся имя службы поиска и ключ администратора. См. статью [Начало работы с Поиском Azure](../search-get-started/) для получения дополнительных сведений.
+	[Демонстрационный проект "Поиск Azure в Adventure Works" на CodePlex](http://go.microsoft.com/fwlink/p/?LinkID=510972). На вкладке "Источник" щелкните **Скачать**, чтобы скачать ZIP-файл этого решения. 

    ![][12]


Это решение содержит два проекта:

+	**CatalogIndex** создает индекс Поиска Azure и загружает данные с базы данных SQL Server, вложенной в проект.
+	**AdventureWorksWeb** - это приложение MVC4, запрашивающее индекс Поиска Azure. Использование этого учебника предполагает наличие у вас достаточных знаний по работе с ASP.NET MVC.

[WACOM.INCLUDE [You need an Azure account to complete this tutorial:](../includes/free-trial-note.md)]


<h2 id="sub-2">Создание индекса Поиска Azure</h2>

На этом этапе понадобится использовать **CatalogIndex** для создания индекса Поиска Azure с именем catalog на основании данных, содержащихся в базе денных AdventureWorks сервера SQL Server.

1.	В Visual Studio откройте демонстрационное решение Поиска Azure с именем **AdventureWorksCatalog.sln**.  
2.	Щелкните правой кнопкой мыши **CatalogIndexer** в обозревателе решений и выберите команду **Назначить запускаемым проектом**, чтобы при нажатии кнопки **F5** запускать это приложение, а не проект **AdventureWorksWeb**.
3.	Откройте файл **App.config** в этом проекте и замените значения параметров SearchServiceName и SearchServiceApiKey значениями параметров своей службы поиска Azure. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.
4.	Дополнительно в файле App.config находится параметр "SourceSqlConnectionString", который указывает на базу данных SQL Server 2014 Express (здесь сервер совпадает с базой данных LocalDB версии 11.0). При использовании другой версии SQL Server внесите в название сервера соответствующие изменения. Например, если имеется локальный экземпляр по умолчанию, можно использовать обозначения "(local)" или "localhost".
5.	Сохраните файл **App.config**.
6.	Нажмите кнопку **F5**, чтобы запустить проект.

Должна открыться командная оболочка со следующим текстовым сообщением: "Создается индекс..."

Через некоторое время после завершения операции должно появиться сообщение: "Завершено.  Нажмите клавишу <ВВОД>, чтобы продолжить:"

   ![][8]

Нажмите клавишу **ВВОД**, чтобы закрыть приложение. На данном этапе произошло создание индекса для службы Поиска Azure. 

> [WACOM.NOTE] Если возникнет ошибка, например "Недопустимое значение ключа attachdbfilename" или другая ошибка присоединения базы данных, возможно, существует конфликт на уровне контроля учетных записей. В этом демонстрационном решении можно обойти указанные выше проблемы, выполнив такие действия: 
> Скопируйте решение в новую или существующую папку (например, Temp), доступ к которой может получить любой зарегистрированный пользователь. 
> Запустите Visual Studio с помощью команды **Запуск от имени администратора**. 
> Откройте решение, выполните сборку, а затем нажмите клавишу **F5**, чтобы создать индекс.

Чтобы проверить создание индекса и состояние передачи документа, перейдите на панель мониторинга своей службы поиска на [портале Azure Preview](https://portal.azure.com). Значение параметра "Использование" для индекса должно увеличиться на единицу, и в наличии должно быть 294 документа: по одному для каждого продукта из базы данных.

Щелкните плитку **Indexes** (Индексы), чтобы отобразить список индексов. В результате этого появится выпадающий список индексов, в котором должен присутствовать новый индекс и счетчик документов.

   ![][9]


<h2 id="sub-3">Обзор CatalogIndexer</h2>

Рассмотрим подробнее проект **CatalogIndexer**, чтобы узнать, как он работает.

1.	Откройте файл **Program.cs** в обозревателе решений и перейдите к функции Main(string[] args).

    Обратите внимание, как эта функция выполняет сборку Uri с именем _serviceURI на основании вашей службы поиска Azure, а затем создает параметр HttpClient с именем _httpClient, который использует ваш ключ API для регистрации в этой службе поиска.

2.	Параметры ChangeEnumeratorSql и ChangeSet служат для перечисления данных из таблицы Products в вашу базу данных AdventureWorks сервера SQL Server. 

3.	Затем, на основании данных, полученных из этой таблицы, вызывается функция ApplyChanges для применения этих данных к вашему индексу Поиска Azure.

4.	Перейдите к функции ApplyChanges в этом же файле. Обратите внимание, как эта функция удаляет индекс, если он уже существует (DeleteCatalogIndex), а затем создает новый индекс с именем catalog (CreateCatalogIndex).  

5.	Перейдите к функции CreateCatalogIndex и обратите внимание, как создается индекс с использованием схемы, сопоставляющей столбцы с таблицы Products в SQL Server. Для каждого поля предусмотрено свойство Type (т. е. Edm.String или Edm.Double), а также атрибуты, определяющие назначение этих полей. Подробнее об этих атрибутах можно узнать в статье [Документация по интерфейсу API REST Поиска Azure](http://msdn.microsoft.com/ru-ru/library/azure/dn798935.aspx).

6.	Вернитесь к функции ApplyChanges. Обратите внимание, как эта функция создает сквозной цикл всех данных в наборе перечисленных изменений ChangeSet. Вместо того чтобы применять эти изменения последовательно, они разбиваются на группы по 1000 штук, а затем передаются в службу Поиска. Такой подход является более эффективным по сравнению с последовательной обработкой документов.

Теперь после знакомства с процессом создания и заполнения индекса с помощью реляционных данных c SQL Server рассмотрим создание каталога продуктов, в котором используются эти поисковые данные.


<h2 id="sub-4">Создание приложения MVC4 с помощью Поиска Azure</h2>

На данном этапе мы создадим и запустим поисковое приложение в веб-браузере.

1.	В Visual Studio откройте демонстрационное решение Поиска Azure с именем **AdventureWorksCatalog.sln**.  

2.	Щелкните правой кнопкой мыши **AdventureWorksWeb** в обозревателе решений и выберите команду **Назначить запускаемым проектом**.

3.	Откройте файл **Web.config** в этом проекте и замените значения параметров SearchServiceName и SearchServiceApiKey значениями параметров своей службы поиска Azure. Если ваша служба поиска называется mysearch.search.windows.net, то в качестве имени службы нужно ввести mysearch.

4.	Сохраните файл **Web.config**.

5.	Нажмите кнопку **F5**, чтобы запустить проект. Следуйте этим указаниям по [устранению неполадок],(#err-mvc) если возникнет ошибка сборки. 

    ![][10]

6.	Оставьте поле поиска пустым и щелкните **Поиск**, чтобы возвратить все 294 продукта.

7.	Обратите внимание на перечень аспектов, расположенный с левой стороны. Нажмите на один из этих аспектов. Это приведет к повторному выполнению процедуры поиска, но при этом произойдет добавление выбранного вами аспекта для фильтрации обнаруженных результатов. Возможно, потребуется добавить точку останова в первую строку функции поиска в файле **HomeController.cs**, чтобы пройти (F11) каждую строку.

7.	Введите поисковый шаблон, например "mountain bikes" (горные велосипеды). По мере ввода текстовых символов появится выпадающий список подсказок с обнаруженными по запросу результатами поиска.

    ![][11]

Рисунок, уже приводившийся в начале данного демонстрационного проекта, вновь приводится ниже в качестве напоминания об освещенных здесь вопросах. В предыдущих разделах обсуждались следующие темы: многоаспектная навигация (отображающаяся с левой стороны), счетчик документов, присутствующий вверху страницы, подсказки, параметры сортировки для отбора результатов по наибольшей степени соответствия, по алфавитному порядку или по цене.

   ![][7]


<h2 id="sub-5">Обзор AdventureWorksWeb</h2>

Проект AdventureWorksWeb иллюстрирует, как можно использовать ASP.NET MVC 4 для организации взаимодействия между службой Поиска Azure и веб-приложением. В этом разделе будут рассмотрены отдельные части программного кода приложения и их предназначение.

1.	В обозревателе решений разверните каталог **AdventureWorksWeb** | **Controller** и откройте файл **HomeController.cs**

    Данный контроллер MVC предназначен для управления взаимодействием из окна просмотра индекса.  В верхней части контроллера содержится ссылка на функцию CatalogSearch _catalogSearch, которая создает объект соединения HttpClient с вашей службой поиска Azure. Код этой функции CatalogSearch расположен в файле **CatalogSeach.cs**

2. В файле **HomeController.cs** предусмотрены две главные функции:

	**Search** (Поиск). Когда пользователь нажимает на кнопку поиска или выбирает какой-либо аспект, происходит вызов данной функции, предназначенной для сбора найденных результатов и отправки их в окно просмотра индекса для последующего отображения.

	**Suggest** (Подсказка). По мере ввода пользователем шаблона в поле поиска, происходит вызов данной функции, возвращающей список подсказок на основе информации, присутствующей в индексе Поиска Azure.

Давайте разберем работу двух этих функций более подробно.  

3.	В функции поиска файла **HomeController.cs** содержится ссылка на функцию _catalogSearch.Search, которая содержит объект соединения с вашей службой поиска Azure. При вызове функции поиска, расположенной в файле **CatalogSearch.cs**, можно заметить, что она использует эти параметры для создания запроса Поиска Azure. Результаты запроса сохраняются в объекте JSON с именем result, а затем возвращаются в представление Index (Индекс), где анализируются и отображаются на веб-странице.

4.	Откройте файл **Index.cshtml** из каталога Views | Home, чтобы просмотреть код, используемый для анализа этих результатов.

5.	Остановите приложение, если оно еще работает, и откройте файл **Index.cshtml** из каталога Views | Home.  В конце этого файла содержится функция JavaScript, использующая запрос JQuery $(function ()). Эта функция вызывается при загрузке страницы. В ней используется функция автозаполнения JQuery, которая связана с обратным вызовом от поискового текстового поля, обозначенного как "q". Когда пользователь вводит в это поле какой-либо текст, происходит вызов этой функции автозаполнения, которая в свою очередь обращается к /home/suggest с введенным поисковым шаблоном.  /home/suggest - это ссылка на функцию подсказки в файле **HomeController.cs**.

6.	Откройте файл **HomeController.cs** и перейдите к функции подсказки. Этот код почти не отличается от функции поиска, использующей объект _catalogSearch для вызова функции подсказки из файла **CatalogSearch.cs**. Вместо создания поискового запроса, функция подсказки вызывает команду [Suggestions API](http://msdn.microsoft.com/ru-ru/library/azure/dn798936.aspx), которая на основе введенного в текстовое поле шаблона формирует список возможных подсказок. Значения возвращаются в файл **Index.cshtml** и автоматически добавляются в поле поиска как варианты автозаполнения.

Здесь может возникнуть вопрос относительно критериев, на основе которых служба Поиска Azure выполняет отбор полей, используемых для формирования подсказок. Ответ на него был дан ранее в разделе о создании индекса. В функции CreateCatalogIndex файла Program.cs проекта **CatalogIndexer** существует атрибут Suggestions (Предложения).  Если для него установлено значение True, то служба поиска Azure может использовать его в качестве поля для извлечения предложений

Давайте это проверим.  

7.	Еще раз выполните сборку приложения и нажмите клавишу **F5**, чтобы запустить его.

8.	В поле поиска введите слово "Road" (Дорога).  После непродолжительного времени вы увидите отображающийся внизу текстового поля список товаров с подсказками, которые могут заинтересовать пользователя.  

Может потребоваться добавить точку останова к функции подсказки, содержащейся в файле **HomeController.cs**, и пройти через (F11) все вызовы, с помощью которых создается список предложений.

На этом демонстрация проекта завершена. Вы познакомились со всеми основными операциями, о которых нужно знать при создании приложения на базе ASP.NET MVC4 с использованием Поиска Azure.


<h2 id="err-mvc">Устранение ошибки "Невозможно загрузить файл или сборку System.Web.Mvc"</h2>

Если при сборке AdventureWorksWeb вы получаете сообщение об ошибке Could not load file or assembly 'System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35' or one of its dependencies (Невозможно загрузить файл или сборку System.Web.Mvc, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35 или один из зависимых компонентов), попробуйте выполнить эти действия, чтобы устранить ошибку.

1. Откройте консоль диспетчера пакетов: **Tools (Сервис)** | **NuGet Package Manager (Диспетчер пакетов NuGet)** | **Package Manager Console (Консоль диспетчера пакетов)**
2. В командной строке PM> введите Update-package -reinstall Microsoft.AspNet.Mvc.
3. При появлении запроса на повторную загрузку файла нажмите кнопку **Yes to All** (Да для всех).
4. Повторите сборку решения и снова нажмите клавишу **F5**.


<h2 id="next-steps">Дальнейшие действия</h2>

Для самостоятельного изучения дополнительных возможностей попробуйте добавить страницу "Details" (Сведения), которая открывается, когда пользователь нажимает указателем мыши на один из поисковых результатов. В качестве подготовки выполните следующие действия:

+	Ознакомьтесь с [интерфейсом API Lookup](http://msdn.microsoft.com/ru-ru/library/azure/dn798929.aspx), чтобы узнать, как создавать запросы Поиска Azure для извлечения определенного документа (например, можно передать значения идентификатора продукта).
+	Попробуйте добавить новую функцию Details (Сведения) в файл **HomeController.cs**. Добавьте соответствующее представление **Details.cshtml**, в котором будут обрабатываться и выводится результаты этой подстановки.
+	Познакомьтесь со следующими дополнительными примерами программного кода и видеоматериалами, относящимися к теме геопространственного поиска: [Канал 9 - Поиск Azure и геопространственные данные](http://channel9.msdn.com/Shows/Data-Exposed/Azure-Search-and-Geospatial-Data), а также [CodePlex: пример создания геопространственного Поиска Azure](http://azuresearchgeospatial.codeplex.com)

Кроме того, можно просмотреть статью [Интерфейс API REST для Поиска Azure](http://msdn.microsoft.com/ru-ru/library/azure/dn798935.aspx) в библиотеке MSDN.


<!--Anchors-->
[Необходимые условия]: #sub-1
[Создание индекса Поиска Azure]: #sub-2
[Обзор CatalogIndexer]: #sub-3
[Разработка приложения MVC4 с помощью Поиска Azure]: #sub-4
[Обзор AdventureWorksWeb]: #sub-5
[Дальнейшие действия]: #next-steps


<!--Image references-->
[7]: ./media/search-create-first-solution/AzureSearch_Create1_WebApp.PNG
[8]: ./media/search-create-first-solution/AzureSearch_Create1_ConsoleMsg.PNG
[9]: ./media/search-create-first-solution/AzureSearch_Create1_DashboardIndexes.PNG
[10]: ./media/search-create-first-solution/AzureSearch_Create1_WebAppEmpty.PNG
[11]: ./media/search-create-first-solution/AzureSearch_Create1_Suggestions.PNG
[12]: ./media/search-create-first-solution/AzureSearch_Create1_CodeplexDownload.PNG

<!--HONumber=35.2-->
