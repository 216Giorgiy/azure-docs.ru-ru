<properties 
   pageTitle="Просмотр журналов диагностики Azure Data Lake Analytics | Microsoft Azure" 
   description="Из этой статьи вы узнаете, как настроить журналы диагностики для Azure Data Lake Analytics и просмотреть их. " 
   services="data-lake-analytics" 
   documentationCenter="" 
   authors="Blackmist" 
   manager="paulettm" 
   editor="cgronlun"/>
 
<tags
   ms.service="data-lake-analytics"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="big-data" 
   ms.date="08/11/2016"
   ms.author="larryfr"/>

# Доступ к журналам диагностики для Azure Data Lake Analytics

Узнайте, как включить ведение журнала диагностики для учетной записи Data Lake Analytics и просматривать журналы, собранные для этой учетной записи.

Организации могут включать ведение журналов диагностики, чтобы в учетных записях Azure Data Lake Analytics собирать журналы аудита доступа к данным. Эти журналы содержат такие сведения:

* список пользователей, которые получали доступ к данным;
* частота доступа к данным;
* объем данных, хранящихся в учетной записи.

## Предварительные требования

- **Подписка Azure.**. См. [Бесплатная пробная версия Azure](https://azure.microsoft.com/pricing/free-trial/).
- **Включите свою подписку Azure** для общедоступной предварительной версии Data Lake Analytics. См. [инструкции](data-lake-analytics-get-started-portal.md#signup).
- **Учетная запись Azure Data Lake Analytics**. Следуйте инструкциям, приведенным в [руководстве по началу работы с Azure Data Lake Analytics с помощью портала Azure](data-lake-analytics-get-started-portal.md).

## Включение ведения журналов

1. Войдите на новый [портал Azure](https://portal.azure.com).

2. Откройте свою учетную запись Data Lake Analytics. В колонке учетной записи Data Lake Analytics выберите **Параметры**, а затем щелкните **Параметры диагностики**.

3. В колонке **Диагностика** внесите следующие изменения, чтобы настроить ведение журнала диагностики:

	![Включение ведения журналов диагностики](./media/data-lake-analytics-diagnostic-logs/enable-diagnostic-logs.png "Включение ведения журнала диагностики для веб-приложений в службе приложений Azure")

	* Чтобы включить ведение журналов диагностики, для параметра **Состояние** установите значение **Включено**.
	* Можно выбрать хранение и обработку данных одним из двух способов.
		* Выберите параметр **Export to Event Hub** (Экспорт в концентратор событий), чтобы передавать поток данных журнала в концентратор событий Azure. Этот параметр следует использовать, если есть конвейер последующей обработки для анализа входящих журналов в режиме реального времени. При выборе этого параметра необходимо указать сведения о концентраторе событий Azure, который вы хотите использовать.
		* Выберите параметр **Export to Storage Account** (Экспорт в учетную запись хранения), чтобы сохранять журналы в учетной записи хранения Azure. Этот параметр следует использовать, если вы хотите архивировать данные. Если выбран этот параметр, необходимо указать учетную запись хранения Azure для сохранения журналов.
	* Укажите, хотите ли вы получить журналы аудита или журналы запросов, либо и те, и другие.
	* Укажите число дней, в течение которых должны храниться данные.
	* Щелкните **Сохранить**.

Включив параметры диагностики, вы сможете просматривать журналы на вкладке **Журналы диагностики**.

## Просмотр журналов

Существует два способа просмотра данных журнала для учетной записи Data Lake Analytics:

* из раздела параметров учетной записи Data Lake Analytics;
* из учетной записи хранения Azure, в которой хранятся данные.

### Использование представления параметров Data Lake Analytics

1. В колонке **Параметры** учетной записи Data Lake Analytics щелкните **Журналы диагностики**.

	![Просмотр ведения журнала диагностики](./media/data-lake-analytics-diagnostic-logs/view-diagnostic-logs.png "Просмотр журналов диагностики")

2. В колонке **Журналы диагностики** должны отображаться журналы, упорядоченные по категориям **Журналы аудита** и **Журналы запросов**.
	* В журналы запросов записываются все запросы API к учетной записи Data Lake Analytics.
	* Журналы аудита похожи на журналы запросов, но содержат более подробную статистику операций с учетной записью Data Lake Analytics. Например, вызов API для одной передачи в журнале запросов может породить несколько операций добавления в журналах аудита.

3. Щелкните ссылку **Скачать** для каждой записи журнала, чтобы скачать журналы.

### Использование учетной записи хранения Azure, в которой хранятся данные

1. Откройте колонку учетной записи хранения Azure, связанную с Data Lake Analytics для ведения журнала, и щелкните "BLOB-объекты". В колонке **Служба BLOB-объектов** отображается два контейнера.

	![Просмотр ведения журнала диагностики](./media/data-lake-analytics-diagnostic-logs/view-diagnostic-logs-storage-account.png "Просмотр журналов диагностики")

	* В контейнере **insights-logs-audit** содержатся журналы аудита.
	* В контейнере **insights-logs-requests** содержатся журналы запросов.

2. Журналы в этих контейнерах хранятся с использованием следующей структуры:

        resourceId=/
          SUBSCRIPTIONS/
            <<SUBSCRIPTION_ID>>/
              RESOURCEGROUPS/
                <<RESOURCE_GRP_NAME>>/
                  PROVIDERS/
                    MICROSOFT.DATALAKEANALYTICS/
                      ACCOUNTS/
                        <DATA_LAKE_ANALYTICS_NAME>>/
                          y=####/
                            m=##/
                              d=##/
                                h=##/
                                  m=00/
                                    PT1H.json
    
    > [AZURE.NOTE] Записи `##` в пути обозначают год, месяц, день и час создания журнала. Служба Data Lake Analytics создает один файл каждый час, поэтому параметр `m=` всегда содержит значение `00`.

	Например, полный путь к журналу аудита может выглядеть таким образом:
    
        https://adllogs.blob.core.windows.net/insights-logs-audit/resourceId=/SUBSCRIPTIONS/<sub-id>/RESOURCEGROUPS/myresourcegroup/PROVIDERS/MICROSOFT.DATALAKEANALYTICS/ACCOUNTS/mydatalakeanalytics/y=2016/m=07/d=18/h=04/m=00/PT1H.json

	Аналогично, полный путь к журналу запросов может выглядеть так:
    
        https://adllogs.blob.core.windows.net/insights-logs-requests/resourceId=/SUBSCRIPTIONS/<sub-id>/RESOURCEGROUPS/myresourcegroup/PROVIDERS/MICROSOFT.DATALAKEANALYTICS/ACCOUNTS/mydatalakeanalytics/y=2016/m=07/d=18/h=14/m=00/PT1H.json

## Структура журнала

В журналах аудита и запросов используется формат JSON. В этом разделе мы рассмотрим структуру JSON для журналов запросов и аудита.

### Журналы запросов

Ниже приведен пример записи журнала запросов в формате JSON. Каждый большой двоичный объект имеет один корневой объект под названием **records**, который содержит массив объектов журнала.

	{
	"records": 
	  [		
		. . . .
		,
		{
			 "time": "2016-07-07T21:02:53.456Z",
			 "resourceId": "/SUBSCRIPTIONS/<subscription_id>/RESOURCEGROUPS/<resource_group_name>/PROVIDERS/MICROSOFT.DATALAKEANALYTICS/ACCOUNTS/<data_lake_analytics_account_name>",
			 "category": "Requests",
			 "operationName": "GetAggregatedJobHistory",
			 "resultType": "200",
			 "callerIpAddress": "::ffff:1.1.1.1",
			 "correlationId": "4a11c709-05f5-417c-a98d-6e81b3e29c58",
			 "identity": "1808bd5f-62af-45f4-89d8-03c5e81bac30",
			 "properties": {
                 "HttpMethod":"POST",
                 "Path":"/JobAggregatedHistory",
                 "RequestContentLength":122,
                 "ClientRequestId":"3b7adbd9-3519-4f28-a61c-bd89506163b8",
                 "StartTime":"2016-07-07T21:02:52.472Z",
                 "EndTime":"2016-07-07T21:02:53.456Z"
                 }
		}
		,
		. . . .
	  ]
	}

#### Схема журнала запросов

| Name (Имя) | Тип | Описание |
|-----------------|--------|--------------------------------------------------------------------------------|
| Twitter в режиме реального | Строковый | Метка времени журнала (в формате UTC). |
| resourceId | Строка | Идентификатор ресурса, с которым была выполнена операция. |
| category | Строка | Категория журнала. Например, **Requests**. |
| operationName | Строковый | Имя операции, добавленной в журнал. Например, GetAggregatedJobHistory. |
| resultType | Строка | Состояние операции. Например, 200. |
| callerIpAddress | Строка | IP-адрес клиента, отправившего запрос. |
| correlationId | Строковый | Идентификатор журнала. С помощью этого значения можно группировать связанные записи журнала. |
| identity | Объект | Идентификатор, для которого был создан журнал. |
| properties | JSON | Дополнительные сведения см. в следующем разделе ("Схема свойств журнала запросов"). |

#### Схема свойств журнала запросов

| Имя | Тип | Описание |
|----------------------|--------|-----------------------------------------------------------|
| HttpMethod | Строка | Метод HTTP, использованный для операции. Например, GET. |
| Путь | Строковый | Путь выполнения операции. |
| RequestContentLength | int | Длина содержимого HTTP-запроса. |
| ClientRequestId | Строковый | Идентификатор, однозначно определяющий данный запрос. |
| StartTime | Строка | Время получения запроса сервером. |
| EndTime | Строковый | Время отправки ответа сервером. |

### Журналы аудита

Ниже приведен пример записи журнала аудита в формате JSON. Каждый большой двоичный объект имеет один корневой объект под названием **records**, который содержит массив объектов журнала.

	{
	"records": 
	  [		
		. . . .
		,
		{
			 "time": "2016-07-28T19:15:16.245Z",
			 "resourceId": "/SUBSCRIPTIONS/<subscription_id>/RESOURCEGROUPS/<resource_group_name>/PROVIDERS/MICROSOFT.DATALAKEANALYTICS/ACCOUNTS/<data_lake_ANALYTICS_account_name>",
			 "category": "Audit",
			 "operationName": "JobSubmitted",
			 "identity": "user@somewhere.com",
			 "properties": {
                 "JobId":"D74B928F-5194-4E6C-971F-C27026C290E6",
                 "JobName": "New Job", 
                 "JobRuntimeName": "default",
                 "SubmitTime": "7/28/2016 7:14:57 PM"
                 }
		}
		,
		. . . .
	  ]
	}

#### Схема журнала аудита

| Имя | Тип | Описание |
|-----------------|--------|--------------------------------------------------------------------------------|
| Twitter в режиме реального | Строковый | Метка времени журнала (в формате UTC). |
| resourceId | Строка | Идентификатор ресурса, с которым была выполнена операция. |
| category | Строка | Категория журнала. Например, **Audit**. |
| operationName | Строковый | Имя операции, добавленной в журнал. Например, JobSubmitted. |
| resultType | Строка | Подсостояние состояния задания (operationName). |
| resultSignature | Строка | Дополнительные сведения о состоянии задания (operationName). |
| identity | Строка | Пользователь, который запросил операцию. Пример: susan@contoso.com. |
| properties | JSON | Дополнительные сведения см. в следующем разделе ("Схема свойств журнала аудита"). |

> [AZURE.NOTE] Свойства __resultType__ и __resultSignature__ содержат информацию о результате операции. У них только в том случае есть значение, если операция завершена. К примеру, у них есть значение, когда у свойства __operationName__ есть значение __JobStarted__ или __JobEnded__.

#### Схема свойств журнала аудита

| Имя | Тип | Описание |
|------------|--------|------------------------------------------|
| JobId | Строковый | Идентификатор, присвоенный заданию. |
| JobName | Строка | Имя, указанное для задания. |
| JobRunTime | Строка | Среда выполнения, используемая для обработки задания. |
| SubmitTime | Строка | Время отправки задания (в формате UTC). |
| StartTime | Строка | Время начала выполнения задания после отправки (в формате UTC). |
| EndTime | Строка | Время завершения задания. |
| Параллелизм | Строка | Количество единиц Data Lake Analytics, запрошенных для этого задания во время отправки. |

> [AZURE.NOTE] Свойства __SubmitTime__, __StartTime__, __EndTime__ и __Parallelism__ содержат информацию об операции. У них только в том случае есть значение, если операция началась или уже завершена. К примеру, у свойства __SubmitTime__ появляется значение после того, как свойство __operationName__ получает значение __JobSubmitted__.

## Обработка данных журнала

В Azure Data Lake Analytics есть пример обработки и анализа данных журнала. Этот пример можно найти по адресу [https://github.com/Azure/AzureDataLake/tree/master/Samples/AzureDiagnosticsSample](https://github.com/Azure/AzureDataLake/tree/master/Samples/AzureDiagnosticsSample).


## Дальнейшие действия

- [Обзор аналитики озера данных Microsoft Azure](data-lake-analytics-overview.md)

<!---HONumber=AcomDC_0817_2016-->