<properties 
	pageTitle="Настройка защиты между локальными виртуальными машинами VMWare или физическими серверами и Azure" 
	description="Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин, размещаемых на локальных серверах VMWare, в Azure, а также между физическими локальными серверами и Azure." 
	services="site-recovery" 
	documentationCenter="" 
	authors="raynew" 
	manager="jwhit" 
	editor="tysonn"/>

<tags 
	ms.service="site-recovery" 
	ms.workload="backup-recovery" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="03/26/2015" 
	ms.author="raynew"/>


# Настройка защиты между локальными виртуальными машинами VMWare или физическими серверами и Azure

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнеса и восстановления после сбоев (BCDR), управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Описание возможных сценариев развертывания см. в статье [Обзор Azure Site Recovery](hyper-v-recovery-manager-overview.md).

В этом пошаговом руководстве описывается развертывание Site Recovery:

- ** для защиты локальных виртуальных машин VMWare в Azure;**
- **защиты локальных физических серверов Windows и Linux в Azure.**

Преимущества для предприятий

- Защита физических серверов Windows или Linux.
- Простая репликация, отработка отказа и восстановление с помощью портала Azure Site Recovery.
- Репликация данных через Интернет, VPN-подключение типа "сеть-сеть" или Azure ExpressRoute.   
- Восстановление размещения (восстановление) из Azure в локальную инфраструктуру VMWare. 
- Упрощенное обнаружение виртуальных машин VMWare.
- Согласованность нескольких виртуальных машин, обеспечивающая совместное восстановление виртуальных машин и физических серверов с определенными нагрузками до согласованной точки данных.
- Планы восстановления для упрощения отработки отказа и восстановления нагрузок с многоуровневым размещением на нескольких машинах.

Эта функция в настоящее время находится на стадии предварительной версии. См. раздел [Дополнительные условия использования для предварительных версий](preview-supplemental-terms).

## Об этом руководстве

Руководство включает обзор и предварительные требования к развертыванию. Оно содержит пошаговые процедуры настройки всех компонентов развертывания и включения защиты для виртуальных машин и серверов. В заключение приводится процедура тестирования отработки отказа для подтверждения правильной работы всех компонентов.

Если у вас возникают проблемы, опубликуйте свои вопросы на [форуме по службам восстановления Azure](http://go.microsoft.com/fwlink/?LinkId=313628).

## Обзор

На этой схеме приведены компоненты развертывания.

![New vault](./media/site-recovery-vmware-to-azure/ASRVMWare_Arch.png)

### Компоненты развертывания

- **Локальные компьютеры** - локальные компьютеры, для которых требуется обеспечить защиту. Это виртуальные машины, выполняющиеся в низкоуровневой оболочке VMWare, или физические серверы под управлением Windows или Linux.

- **Локальный сервер обработки** - защищенные компьютеры отправляют данные репликации на локальный сервер обработки. Сервер обработки выполняет ряд действий с этими данными. Он оптимизирует их перед отправкой на главный целевой сервер в Azure. Он включает дисковый кэш для кэширования получаемых данных репликации. Кроме того, он обеспечивает принудительную установку службы Mobility, которая должна быть установлена на всех защищаемых виртуальных машинах и физических серверах, и выполняет автоматическое обнаружение серверов VMWare vCenter. Сервер обработки представляет собой виртуальный или физический сервер под управлением Windows Server 2012 R2. Рекомендуется разместить его в той же сети и сегменте локальной сети, что и защищаемые компьютеры, однако он может выполняться в другой сети при наличии у защищаемых компьютеров доступа к этой сети третьего уровня. Во время развертывания выполняется настройка сервера обработки и его регистрация в сервере конфигурации.

- **Хранилище Azure Site Recovery** - хранилище координирует и организует репликацию данных, отработку отказа и восстановление между локальным сайтом и Azure.

- **Сервер конфигурации Azure** - сервер конфигурации координирует взаимодействие между защищенными компьютерами, сервером обработки и главными целевыми серверами в Azure. Он настраивает репликацию и координирует восстановление в Azure при возникновении отработки отказа. Сервер конфигурации выполняется на виртуальной машине Azure уровня Standard A3 в подписке Azure. В ходе развертывания выполняется настройка сервера и его регистрация в хранилище Azure Site Recovery.

- **Главный целевой сервер** - главный целевой сервер в Azure содержит данные репликации с защищенных виртуальных машин. Данные размещаются на присоединенных виртуальных жестких дисках, созданных в хранилище BLOB-объектов в учетной записи хранения Azure. Сервер развертывается как виртуальная машина Azure, сервер Windows, основанный на образе коллекции Windows Server 2012 R2 (для защиты компьютеров Windows), или сервер Linux, основанный на образе коллекции OpenLogic CentOS 6.6 (для защиты компьютеров Linux). Доступны два уровня размера виртуальных машин - Standard A3 и Standard D14. Этот сервер подключается к той же сети Azure, что и сервер конфигурации. Во время развертывания выполняется создание сервера и его регистрация на сервере конфигурации.

- **Служба Mobility** - служба Mobility устанавливается на всех защищаемых виртуальных машинах VMWare или физических серверах Windows/Linux. Эта служба передает данные репликации на сервер обработки, который, в свою очередь, передает их на главный целевой сервер в Azure. Сервер обработки может автоматически устанавливать службу Mobility на защищенных компьютерах. Кроме того, эту службу можно развернуть вручную, используя внутреннюю процедуру развертывания программного обеспечения вашего предприятия.

- **Каналы передачи и репликации данных** - для этого компонента предусмотрено несколько вариантов. Обратите внимание, что ни один из вариантов не требует открытия входящих сетевых портов на защищенных компьютерах. Все сетевое взаимодействие инициируется локальным сайтом.
	- **Через Интернет** - передача и репликация данных с защищенных локальных серверов и Azure через защищенное общедоступное интернет-подключение. Это вариант по умолчанию.
	- **VPN или ExpressRoute** - передача и репликация данных между локальными серверами и Azure через VPN-подключение. Вам потребуется настроить подключение VPN типа "сеть-сеть" или [ExpressRoute](expressroute) между локальным сайтом и сетью Azure. 

 
## Планирование загрузки

- Чтобы обеспечить оптимальную производительность и воспользоваться преимуществами функции согласованности нескольких виртуальных машин, выполняющей восстановление нескольких защищенных машин до согласованной точки данных, рекомендуется организовать виртуальные машины в группы защиты по нагрузке.
- Невозможно обеспечить защиту одной машины на нескольких главных целевых серверах, так как при репликации дисков виртуальный жесткий диск, отражающий размер диска, создается в хранилище BLOB-объектов Azure и присоединяется к главному целевому серверу как диск данных. Тем не менее, конечно, можно настроить защиту нескольких виртуальных машин с помощью одного главного целевого сервера.
- Виртуальная машина главного целевого сервера может быть типа Azure Standard A4 или D14.
	- Диск Standard A4 позволяет добавить 16 дисков данных (максимум 1023 ГБ на диск) на каждую виртуальную машину.
	- Диск Standard D14 позволяет добавить 32 диска данных (максимум 1023 ГБ на диск) на каждую виртуальную машину.
- Учтите, что один диск, присоединенный к главному целевому серверу, зарезервирован в качестве диска хранения. Azure Site Recovery позволяет определить период хранения и выполнять восстановление защищенных компьютеров в любое время в пределах этого периода. Диск хранения обеспечивает ведение журнала изменений диска на протяжении периодов хранения.  Таким образом, число доступных дисков для A4 снижается до 15, а для D14 - до 31. 
- Масштабирование развертывания осуществляется путем добавления нескольких серверов обработки и главных целевых серверов. Развертывание второго главного целевого сервера требуется, если на существующем главном целевом сервере недостаточно свободных дисков. Развертывание дополнительного сервера обработки требуется, если скорость изменения данных защищенных компьютеров превышает емкость существующего сервера обработки. Учтите, что серверы обработки и главные целевые серверы не требуют сопоставления "один к одному". Вы можете выполнить развертывание первого сервера обработки с вторым главным целевым сервером и т. д.
Сервер обработки использует дисковый кэш. Убедитесь в наличии достаточного для кэша места на диске C:/. Размер кэша определяется скоростью изменения данных на защищаемых компьютерах. Как правило, рекомендуется, чтобы размер каталога кэша составлял 600 ГБ для средних развертываний, тем не менее необходимый размер можно определить, используя следующие рекомендации.

	![Cache guidelines](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerSize.png)


## Перед началом работы

### Предварительные требования Azure

- Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/). Можно начать с использования [пробной версии](http://aka.ms/try-azure). 
- Для хранения реплицируемых данных потребуется учетная запись хранения Azure. На учетной записи необходимо включить георепликацию. Она должна находиться в том же регионе, что и хранилище Azure Site Recovery, и быть связана с той же подпиской. Дополнительные сведения см. в статье [Введение в хранилище Microsoft Azure](http://go.microsoft.com/fwlink/?LinkId=398704).
- Вам потребуется виртуальная сеть Azure, в которой будут развернуты сервер конфигурации и главный целевой сервер. Ее регион и подписка должны совпадать с регионом и подпиской хранилища Azure Site Recovery.
- Убедитесь в наличии достаточного количества ресурсов Azure для развертывания всех компонентов. Дополнительные сведения см. в разделе [Ограничения подписки Azure](azure-subscription-service-limits).
- Убедитесь, что защищаемые виртуальные машины соответствуют требованиям Azure. 

	- **Число дисков**. Один защищенный сервер может поддерживать максимум 31 диск.
	- **Размеры дисков**. Емкость одного диска не должна превышать 1023 ГБ.
	- **Кластеризация**. Кластеризованные серверы не поддерживаются.
	- **Загрузка**. Загрузка UEFI (Unified Extensible Firmware Interface)или EFI (Extensible Firmware Interface) не поддерживается.
	- **Тома**. Тома с шифрованием Bitlocker не поддерживаются.
	- **Имена серверов**. Имена должны содержать от 1 до 63 символов (букв, цифр и дефисов). Имя должно начинаться с буквы или цифры и заканчиваться буквой или цифрой. После настройки защиты для компьютера можно изменить его имя Azure.	

	Дополнительные сведения о требованиях Azure см. в статье [Поддержка виртуальных машин](https://msdn.microsoft.com/library/azure/dn469078.aspx#BKMK_E2A).

### Требования к компонентам сценария

- Сервер обработки
	- Сервер обработки можно развернуть на физическом компьютере или виртуальной машине под управлением Windows Server 2012 R2 с последними обновлениями. Он устанавливается на диск C:/.
	- Серверу требуется как минимум 8 ядер, ОЗУ 64 ГБ и 300 ГБ свободного места на диске C (рекомендуется).
	- Сервер рекомендуется размещать в той же сети и подсети, что и защищаемые компьютеры.
	- Установите на сервере интерфейс командной строки VMware vSphere 5.1, чтобы он мог выполнять автоматическое обнаружение серверов VMWare vCenter.
- Путь установки для сервера конфигурации, главного целевого сервера, сервера обработки и серверов восстановления размещения должен содержать только латинские символы. Например, для главного целевого сервера под управлением Linux путь должен иметь следующий вид: **/usr/local/ASR**.

### Предварительные требования VMWare

- Сервер VMWare vCenter для управления низкоуровневыми оболочками VMware vSphere. Он должен работать под управлением vCenter 5.0 или более поздней версии с последними обновлениями. 
- Одна или несколько низкоуровневых оболочек, содержащих защищаемые виртуальные машины VMWare. Низкоуровневая оболочка должна работать под управлением ESX/ESXi 5.0 или более поздней версии с последними обновлении.
- На виртуальных машинах VMWare, обнаруженных с помощью сервера vCenter, должно быть установлено и запущено ПО VMware Tools.

### Предварительные требования для защищенных компьютеров Windows

На защищенных физических серверах или виртуальных машинах VMWare под управлением Windows должны соблюдаться следующие условия.

- Установка поддерживаемой 64-разрядной операционной системы: Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2 с пакетом обновлений 1 (SP1) как минимум.
- Имена узлов, точки подключения, имена устройств и системный путь Windows (например, C:\Windows) должны быть только на английском языке.
- Операционная система должна устанавливаться на диске C:.
- Поддерживаются обычные варианты хранения для серверов Windows.
- Правила брандмауэра на защищенных компьютерах должны позволять им получать доступ к серверу конфигурации и главным целевым серверам в Azure. 
- Если после отработки отказа требуется подключаться к виртуальным машинам Windows в Azure с помощью функции удаленного рабочего стола, убедитесь, что эта функция включена для локальных компьютеров. Если подключение выполняется не через VPN, правила брандмауэра должны разрешать подключения удаленного рабочего стола через Интернет.

### Предварительные требования для защищенных компьютеров Linux

На защищенных физических серверах или виртуальных машинах VMWare под управлением Linux должны соблюдаться следующие условия.

- Поддерживаемая операционная система: Centos 6.4, 6.5, 6.6 (32- или 64-разрядная); Oracle Enterprise Linux 6.4, 6.5 (32- или 64-разрядная) с ядром, совместимым с Red Hat, или Unbreakable Enterprise Kern 3 (UEK3), SUSE Linux Enterprise Server 11 SP3 (32- или 64-разрядная).
- Имена узлов, точки подключения, имена устройств и системные пути и имена файлов Linux (например, /etc/; /usr) должны быть только на английском языке.
- Защиту можно включить для локальных компьютеров со следующими характеристиками хранилища.
	- Файловая система: EXT3, ETX4, ReiserFS, XFS
	- Многоканальное программное обеспечение: средство сопоставления устройств - режим Multipath
	- Диспетчер томов: LVM2
	- Физические серверы с хранилищем контроллера HP CCISS не поддерживаются.
- Правила брандмауэра на защищенных компьютерах должны позволять им получать доступ к серверу конфигурации и главным целевым серверам в Azure.
- Чтобы иметь возможность подключаться к виртуальным машинам Azure под управлением Linux после отработки отказа с помощью клиента SSH, убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы и правила брандмауэра разрешают SSH-подключение к виртуальной машине.  

### Предварительные требования сторонних компонентов

Правильное функционирование некоторых компонентов развертывания в этом сценарии зависит от стороннего программного обеспечения. Полный список такого ПО см. в разделе <a href="#thirdparty">Уведомления и сведения о стороннем программном обеспечении</a>. 

## Шаг 1. Создание хранилища

1. Выполните вход на [портал управления](https://portal.azure.com).


2. Разверните узел **Службы данных** > **Службы восстановления** и щелкните элемент **Хранилище Site Recovery**.


3. Выберите **Создать** > **Быстрое создание**.
	
4. В поле **Имя** введите понятное имя для идентификации хранилища.

5. В поле **Область** выберите географический регион для хранилища архивации. Сведения о поддерживаемых регионах см. в разделе "Регионы" страницы [Расценки на службу восстановления сайтов Azure](href="http://go.microsoft.com/fwlink/?LinkId=389880).

6. Щелкните элемент **Создать хранилище**. 

	![New vault](./media/site-recovery-vmware-to-azure/ASRVMWare_CreateVault.png)

Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. Хранилище будет указано как **активное** на главной странице **служб восстановления**.

## Шаг 2. Развертывание сервера конфигурации


1. На странице **Службы восстановления** щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Quick Start Icon](./media/site-recovery-vmware-to-azure/ASRVMWare_QuickStartIcon.png)

2. В раскрывающемся списке выберите элемент **Между локальным узлом с VMware/физическими серверами и Azure**.
3. В разделе **Подготовка целевых ресурсов** щелкните пункт **Развертывание сервера конфигурации**.

	![Deploy configuration server](./media/site-recovery-vmware-to-azure/ASRVMWare_DeployCS.png)

4. Укажите сведения о сервере конфигурации и учетные данные для подключения к серверу. Выберите сеть Azure, в которой будет размещаться сервер. Укажите внутренний IP-адрес и подсеть, которые будут назначены серверу. При нажатии кнопки **ОК** для сервера конфигурации в вашей подписке будет создана виртуальная машина типа Standard A3, основанная на образе коллекции Windows Server 2012 R2 Azure Site Recovery. Она создается как первый экземпляр в новой облачной службе с зарезервированным общедоступным IP-адресом.

	![Configuration server settings](./media/site-recovery-vmware-to-azure/ASRVMWare_CSDetails.png)

5. Ход выполнения можно отслеживать на вкладке **Задания**.

	![Monitor progress](./media/site-recovery-vmware-to-azure/ASRVMWare_MonitorConfigServer.png)

8.  После развертывания сервера конфигурации запишите назначенный ему общедоступный IP-адрес, который отображается на странице **Виртуальные машины** портала Azure. Затем на вкладке **Конечные точки** запишите общий порт HTTPS, сопоставленный с частным портом 443. Эти сведения потребуются вам в дальнейшем при регистрации главного целевого сервера и сервера обработки в сервере конфигурации. Сервер конфигурации развертывается с четырьмя общедоступными конечными точками:

	- 443 - канал HTTPS, используемый для координации передачи данных между серверами компонентов и Azure;
	- 9443 - для средства восстановления размещения и обмена данными восстановления размещения;
	- удаленный рабочий стол;
	- PowerShell.


## Шаг 3. Регистрация сервера конфигурации в хранилище

1. В разделе **Подготовка целевых ресурсов** щелкните пункт **Загрузка ключа регистрации**. Файл ключа создается автоматически. Ключ действителен в течение пяти дней после создания. Скопируйте файл на сервер конфигурации.
2. На странице **Панель мониторинга** виртуальной машины нажмите кнопку **Подключение**. Используйте загруженный RDP-файл для входа на сервер конфигурации с помощью удаленного рабочего стола.  При первом входе в систему мастер установки и регистрации Azure Site Recovery запускается автоматически.

	![Registration](./media/site-recovery-vmware-to-azure/ASRVMWareRegister1.png)

3. Следуйте инструкциям мастера. Вам потребуется загрузить и установить сервер MySQL Server и указать для него учетные данные. На странице **Регистрация Azure Site Recovery** перейдите к файлу ключа, скопированному на сервер.

	![Registration key](./media/site-recovery-vmware-to-azure/ASRVMWareRegister2.png)

4. После завершения регистрации создается парольная фраза. Скопируйте ее в надежное место. Она потребуется для прохождения проверки подлинности и регистрации сервера обработки и главного целевого сервера в сервере конфигурации. Кроме того, она используется для обеспечения целостности канала при обмене данными с сервером конфигурации. Парольную фразу можно создать повторно, однако при этом потребуется заново регистрировать главный целевой сервер и сервер обработки с помощью новой парольной фразы.

	![Passphrase](./media/site-recovery-vmware-to-azure/ASRVMWareRegister2.png)

После регистрации сервер конфигурации будет добавлен на страницу **Серверы конфигурации** в хранилище.

## Шаг 4. Настройка VPN-подключения
 
К серверу можно подключаться через Интернет или используя подключение VPN или ExpressRoute. Интернет-подключение использует конечные точки виртуальных машин в сочетании с общедоступным виртуальным IP-адресом сервера. VPN-подключение использует внутренний IP-адрес сервера в сочетании с частными портами конечной точки.
 
VPN-подключение к серверу можно настроить следующим образом.

1. Если вы еще не настроили подключение типа "сеть-сеть" или подключение ExpressRoute Azure, дополнительные сведения см. здесь:

	- [ExpressRoute or VPN - What's right for me](http://azure.microsoft.com/blog/2014/06/10/expressroute-or-virtual-network-vpn-whats-right-for-me/) (ExpressRoute или VPN. Что выбрать?)
	- [Настройка подключения "сеть-сеть" к виртуальной машине Azure](https://msdn.microsoft.com/library/azure/dn133795.aspx)
	- [Настройка подключения ExpressRoute](https://msdn.microsoft.com/library/azure/dn606306.aspx) 
	
2. В хранилище щелкните пункт **Серверы** > **Серверы конфигурации** > нужный сервер конфигурации > **Настроить**.
3. В разделе **Параметры подключения** задайте для параметра **Тип подключения** значение **VPN**. Если вы настроили VPN в отсутствие интернет-доступа из локального сайта, обязательно выберите вариант VPN. В противном случае сервер обработки не сможет отправлять данные репликации на общедоступные конечные точки главного целевого сервера.

	![Enable VPN](./media/site-recovery-vmware-to-azure/ASRVMWare_EnableVPN.png)

## Шаг 5. Развертывание главного целевого сервера

1. В разделе **Подготовка целевых ресурсов** щелкните пункт **Развертывание главного целевого сервера**.
2. Укажите сведения о главном целевом сервере и учетные данные. Сервер будет развернут в той же сети Azure, что и сервер конфигурации, на котором вы его регистрируете. После завершения процедуры будет создана виртуальная машина Azure с образом коллекции Windows или Linux. 

	![Target server settings](./media/site-recovery-vmware-to-azure/ASRVMWare_TSDetails.png)

3. Виртуальная машина главного целевого сервера Windows создается со следующими общедоступными конечными точками TCP.

	- Пользовательская - общий порт используется для отправки данных репликации через Интернет. Частный порт 9443 используется сервером обработки для отправки данных на главный целевой сервер через VPN-подключение.
	- Пользовательская1 - частный порт 9080 используется сервером обработки для отправки данных на главный целевой сервер через VPN-подключение.
	- PowerShell - частный порт: 5986.
	- Удаленный рабочий стол - частный порт: 3389.

4. Виртуальная машина главного целевого сервера Linux создается со следующими конечными точками.

	- Пользовательская - общий порт используется для отправки данных репликации через Интернет. Частный порт 9443 используется сервером обработки для отправки данных на главный целевой сервер через VPN-подключение.
	- Пользовательская1 - частный порт 9080 используется сервером обработки для отправки данных на главный целевой сервер через VPN-подключение.
	- SSH - частный порт 22.

5. На странице **Виртуальные машины** дождитесь запуска виртуальной машины. 

	- При настройке сервера Windows запишите сведения об удаленном рабочем столе.
	- При настройке сервера Linux и подключении через VPN запишите внутренний IP-адрес виртуальной машины. При подключении через Интернет запишите общедоступный IP-адрес.
6.  Войдите в систему сервера, чтобы завершить установку и зарегистрировать его на сервере конфигурации. На сервере под управлением Windows

	1. Запустите подключение удаленного рабочего стола к виртуальной машине. При первом входе в систему в окне PowerShell запустится сценарий. Не закрывайте окно. После выполнения сценария автоматически откроется окно средства настройки агента узла (Host Agent Config) для регистрации сервера.
	2. В средстве **Host Agent Config** укажите внутренний IP-адрес сервера конфигурации и порт 443. Можно использовать внутренний адрес и частный порт 443, даже если подключение выполняется не в режиме VPN, так как виртуальная машина присоединена к той же сети Azure, что и сервер конфигурации. Оставьте параметр **Использовать HTTPS** включенным. Введите парольную фразу для сервера конфигурации, записанную ранее. Нажмите кнопку **ОК**, чтобы зарегистрировать сервер. Примечание. Параметры преобразования сетевых адресов (NAT) на странице можно игнорировать. Они не используются.

	![Windows master target server](./media/site-recovery-vmware-to-azure/ASRVMWare_TSRegister.png)

6. На сервере под управлением Linux
	1. Скопируйте [TAR-файл установщика сервера](http://go.microsoft.com/fwlink/?LinkID=529757&clcid=0x409) на виртуальную машину, используя клиент SFTP. Кроме того, можно войти в систему и использовать программу Wget, чтобы загрузить файл по ссылке на странице быстрого запуска. 
	2. Войдите в систему сервера, используя клиент SSH. Примечание. Если подключение к сети Azure выполняется через VPN, используйте внутренний IP-адрес. В противном случае используйте внешний IP-адрес и общедоступную конечную точку SSH.
	3. Извлеките файлы из пакета gzip установщика, выполнив команду: **tar -xvzf Microsoft-ASR_UA_8.2.0.0_RHEL6-64***.   

		![Linux master target server](./media/site-recovery-vmware-to-azure/ASRVMWare_TSLinuxTar.png)

	4. Перейдите в каталог, в который вы извлекли содержимое TAR-файла, и выполните команду **sudo ./install.sh**. Выберите параметр **2. Master Target** (Главный целевой). Для других параметров оставьте значения по умолчанию.

		![Register target server](./media/site-recovery-vmware-to-azure/ASRVMWare_TSLinux.png)

	5. После завершения установки на экран выводится командная строка интерфейса настройки узла **Host Config Interface**. Не изменяйте размер окна. 
	6. С помощью клавиш со стрелками выберите **Global** (Глобально) и нажмите клавишу ВВОД.
	7. В поле **Enter the IP address** (Введите IP-адрес) введите внутренний адрес сервера конфигурации и порт 22.
	8.  Введите парольную фразу сервера конфигурации, которую вы записали ранее, и нажмите клавишу ВВОД. Нажмите **Quit** (Выход), чтобы завершить установку. Примечание. При использовании клиента PuTTY для SSH-подключения к виртуальной машине можно использовать для вставки сочетание клавиш SHIFT + INSERT. 
	9.  Нажмите клавишу со стрелкой вправо, чтобы выйти из программы, и нажмите клавишу ВВОД.

		![Master target server settings](./media/site-recovery-vmware-to-azure/ASRVMWare_TSLinux2.png)

7. Подождите несколько минут (5-10) и на странице **Серверы** > **Серверы конфигурации** убедитесь, что главный целевой сервер указан на вкладке **Сведения о сервере** как зарегистрированный. Если не удалось зарегистрировать сервер под управлением Linux, снова запустите средство настройки узла из каталога /usr/local/ASR/Vx/bin/hostconfigcli. Вам потребуется настроить разрешения доступа, запустив chmod от имени суперпользователя.

	![Verify target server](./media/site-recovery-vmware-to-azure/ASRVMWare_TSList.png)

## Шаг 6. Развертывание локального сервера обработки

1. На странице быстрого запуска щелкните **Install Process Server on-premises** (Локальная установка сервера обработки) > **Download and install the process server** (Загрузить и установить сервер обработки).

	![Install process server](./media/site-recovery-vmware-to-azure/ASRVMWare_PSDeploy.png)

2. Скопируйте загруженный ZIP-файл на сервер, на котором вы собираетесь установить сервер обработки. ZIP-файл содержит два файла установки:

	- Microsoft-ASR_CX_TP_8.2.0.0_Windows*,
	- Microsoft-ASR_CX_8.2.0.0_Windows*.

3. Распакуйте архив и скопируйте установочные файлы в папку на сервере.
4. Запустите файл установки **Microsoft-ASR_CX_TP_8.2.0.0_Windows*** и выполните инструкции. При этом будут установлены сторонние компоненты, необходимые для развертывания.
5. Затем запустите файл **Microsoft-ASR_CX_8.2.0.0_Windows***.
6. На странице **Server Mode** (Режим сервера) выберите **Process Server** (Сервер обработки).
7.	В разделе **Configuration Server Details** (Сведения о сервере конфигурации) при подключении по VPN укажите внутренний IP-адрес сервера конфигурации и порт 443. В противном случае укажите общедоступный виртуальный IP-адрес и сопоставленную общедоступную конечную точку HTTP.
8.	Снимите флажок **Verify Mobility service software signature** (Проверять подпись программного обеспечения службы Mobility), если хотите отключить проверку при использовании автоматической принудительной установки службы. Проверка подписи требует наличия подключения к Интернету с сервера обработки.
9.	Введите парольную фразу сервера конфигурации.

	![Register configuration server](./media/site-recovery-vmware-to-azure/ASRVMWare_CSRegister.png)

8. Завершите установку сервера. Помните, что вам потребуется установить на сервере интерфейс командной строки VMware vSphere 5.1, чтобы иметь возможность обнаруживать серверы vCenter.

	![Register process server](./media/site-recovery-vmware-to-azure/ASRVMWare_PSRegister2.png)

Проверьте успешность регистрации сервера обработки в хранилище (пункты **Сервер конфигурации** > **Сведения о сервере**).

![Validate process server](./media/site-recovery-vmware-to-azure/ASRVMWare_ProcessServerRegister.png)

Примечание. Если вы не отключили проверку подписи для службы Mobility при регистрации сервера обработки, это можно сделать позднее следующим образом.

1. Войдите в систему сервера обработки с правами администратора и откройте файл C:\pushinstallsvc\pushinstaller.conf для редактирования. В разделе **[PushInstaller.transport]** добавьте следующую строку: **SignatureVerificationChecks="0"**. Сохраните и закройте файл.
1. Перезапустите службу InMage PushInstall.


## Шаг 7. Добавление серверов vCenter

1. На вкладке **Серверы** > **Серверы конфигурации** выберите сервер конфигурации и щелкните его, чтобы добавить сервер vCenter.

	![Select vCenter server](./media/site-recovery-vmware-to-azure/ASRVMWare_AddVCenter.png)

2. Укажите сведения для сервера vCenter и выберите сервер обработки, который будет использоваться для его обнаружения.  Сервер обработки должен быть в той же подсети, что и сервер vCenter, на нем должен быть установлен интерфейс командной строки VMware vSphere 5.1.
3. После завершения обнаружения сервер vCenter будет указан в разделе сведений о сервере конфигурации.
	
	![vCenter server settings](./media/site-recovery-vmware-to-azure/ASRVMWare_AddVCenter2.png)


## Шаг 8. Создание группы защиты

1. Откройте вкладку **Защищенные элементы** > **Группа защиты** и щелкните, чтобы добавить группу защиты.

	![Create protection group](./media/site-recovery-vmware-to-azure/ASRVMWare_CreatePG1.png)

2. На странице **Specify Protection Group Settings** (Укажите параметры группы защиты) укажите имя для группы и выберите сервер конфигурации, на котором требуется создать группу.

	![Protection group settings](./media/site-recovery-vmware-to-azure/ASRVMWare_CreatePG2.png)

3. На странице **Specify Replication Settings** (Укажите параметры репликации) настройте параметры репликации, которые будут использоваться для всех компьютеров в группе.   

	![Protection group replication](./media/site-recovery-vmware-to-azure/ASRVMWare_CreatePG3.png)

4. Параметры
	- **Multi VM consistency** (Согласованность нескольких виртуальных машин). При включении этого параметра создаются общие точки восстановления, соответствующие приложениям, для компьютеров в группе защиты. Этот параметр имеет самое большое значение, когда на всех компьютерах в группе защиты выполняется одна и та же нагрузка. Все компьютеры будут восстановлены до одной точки данных. Доступно только для серверов Windows. 
	- **Пороговое значение RPO**. При превышении значением RPO непрерывной репликации защиты данных заданного порогового значения RPO будут создаваться оповещения.
	- **Recovery point retention** (Хранение точки восстановления). Задает период хранения. Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
	- **Периодичность создания соответствующих приложению снимков**. Указывает, насколько часто будут создаваться точки восстановления, содержащие моментальные снимки, согласованные с приложениями.

Создание групп защиты можно отслеживать на странице **Защищенные элементы**. 

## Шаг 9. Принудительная установка службы Mobility

При добавлении компьютеров в группу защиты служба Mobility автоматически принудительно устанавливается на каждый компьютер сервером обработки. Чтобы использовать этот автоматический механизм принудительной установки для защищенных компьютеров под управлением Windows, на каждом компьютере потребуется выполнить следующие действия.

1. Настройте в брандмауэре Windows разрешение **Общий доступ к файлам и принтерам** и **Инструментарий управления Windows**. Для компьютеров, принадлежащих домену, можно настроить политику брандмауэра с помощью объекта групповой политики.
2. Учетная запись, используемая для принудительной установки, должна входить в группу "Администраторы" на защищаемом компьютере. Учтите, что эти учетные данные используются только для принудительной установки. Они не сохраняются службой Mobility в каком-либо расположении и сбрасываются после включения защиты для сервера. Эти учетные данные указываются при добавлении компьютера в группу защиты.

	![Mobility credentials](./media/site-recovery-vmware-to-azure/ASRVMWare_PushCredentials.png)

3. Если учетная запись администратора не является учетной записью домена, вам потребуется отключить управление доступом удаленных пользователей на локальном компьютере. Для этого в разделе HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System создайте запись LocalAccountTokenFilterPolicy (если она не существует) и задайте для нее значение DWORD. 

Для защиты компьютеров под управлением Linux необходимо выполнить следующие действия.

1. Убедитесь, что учетная запись принадлежит привилегированному пользователю на исходном сервере Linux.
1. Установите последние пакеты openssh, openssh-server, openssl на защищаемом компьютере.
1. Включите порт SSH 22.
2. Включите подсистему SFTP и проверку подлинности с помощью пароля в файле конфигурации SSHD.
	1. Войдите в систему с учетной записью привилегированного пользователя.
	2. В файле /etc/ssh/sshd_config найдите строку, которая начинается с PasswordAuthentication. Раскомментируйте строку и измените значение с no на yes. 

		![Linux mobility](./media/site-recovery-vmware-to-azure/ASRVMWare_LinuxPushMobility1.png)

	4. Найдите строку, которая начинается с Subsystem, и раскомментируйте ее. 

		![Linux push mobility](./media/site-recovery-vmware-to-azure/ASRVMWare_LinuxPushMobility1.png)

## Шаг 10. Добавление компьютеров в группу защиты

1. Откройте вкладку **Защищенные элементы** > **Группа защиты** > **Машины** и добавьте физические компьютеры или виртуальные машины, управляемые обнаруженным сервером vCenter. Рекомендуется настроить отражение группами защиты нагрузок, чтобы добавлять компьютеры, на которых выполняется определенное приложение, в одну группу.

	![Add machines](./media/site-recovery-vmware-to-azure/ASRVMWare_PushCredentials.png)

2. На странице **выбора виртуальных машин** мастера **добавления виртуальных машин** выберите сервер VCenter, а затем виртуальные машины на этом сервере.

	![Add V-Center server](./media/site-recovery-vmware-to-azure/ASRVMWare_SelectVMs.png)

3. При добавлении компьютеров в группу защиты служба Mobility автоматически устанавливается с локального сервера обработки. Для правильной работы механизма принудительной установки необходимо настроить защищенные компьютеры, как описано в предыдущем шаге.
4. На странице **выбора виртуальных машин** выберите сервер vCenter, который используется для управления защищаемыми виртуальными машинами, а затем выберите виртуальные машины.

4. Выберите серверы и хранилище, которые будут использоваться для репликации. 

	![vCenter server](./media/site-recovery-vmware-to-azure/ASRVMWare_MachinesResources.png)

5. Укажите учетные данные пользователя для исходного сервера. Это необходимо для автоматической установки службы Mobility на исходных компьютерах. Для сервера Windows учетная запись должна иметь права администратора на исходном сервере. Для сервера Linux учетная запись должна иметь права суперпользователя на сервере.

	![Linux credentials](./media/site-recovery-vmware-to-azure/ASRVMWare_VMMobilityInstall.png)

6. Установите флажок, чтобы завершить добавление компьютеров в группу защиты и запустить начальную репликацию для каждого компьютера. Ход выполнения можно отслеживать на странице **Задания**.

	![Add V-Center server](./media/site-recovery-vmware-to-azure/ASRVMWare_PGJobs.png)

7. Кроме того, перейдите на вкладку **Защищенные элементы** > <группа защиты> > **Виртуальные машины**, где можно отслеживать состояние защиты. После завершения начальной репликации и синхронизации данных компьютеров для них будет отображаться состояние **Защищено**.

	![Virtual machine jobs](./media/site-recovery-vmware-to-azure/ASRVMWare_PGJobs.png)

## Шаг 11. Настройка свойств защищенных машин

1. После того как компьютерам будет назначено состояние **Защищено**, можно приступить к настройке свойств отработки отказа. В разделе сведений группы защиты выберите компьютер и откройте вкладку **Настройка**.
2. Можно изменить имя, которое будет назначено компьютеру в Azure после отработки отказа, и размер виртуальной машины Azure. Кроме того, вы можете выбрать сеть Azure, к которой будет подключаться компьютер после отработки отказа. Обратите внимание на следующее:

	- Имя компьютера Azure должно соответствовать требованиям Azure, которые приведены в разделе предварительных требований.
	- По умолчанию реплицированные виртуальные машины в Azure не подключаются к сети Azure. Если требуется обеспечить обмен данными для реплицированных виртуальных машин, настройте для них одну сеть Azure.

	![Set virtual machine properties](./media/site-recovery-vmware-to-azure/ASRVMWare_VMProperties.png)

## Шаг 12. Запуск отработки отказа

1. Перейдите на страницу **Планы восстановления** и добавьте план восстановления. Укажите сведения о плане и выберите в качестве цели **Azure**.

	![Configure recovery plan](./media/site-recovery-vmware-to-azure/ASRVMWare_RP1.png)

2. На странице **выбора виртуальных машин** выберите группу защиты, а затем выберите компьютеры в группе для добавления в план восстановления.

	![Add virtual machines](./media/site-recovery-vmware-to-azure/ASRVMWare_RP2.png)

3. При необходимости можно настроить план, создав группы и указав порядок выполнения отработки отказа для виртуальных машин в плане восстановления. Кроме того, можно добавить запросы для выполняемых вручную действий и сценариев.

	![Customize recovery plan](./media/site-recovery-vmware-to-azure/ASRVMWare_RP2.png)

5. На странице **Планы восстановления** выберите план и нажмите кнопку **Тестовая отработка отказа**.
6. В разделе **Подтвердить обработку отказа** проверьте направление отработки отказа (в Azure) и выберите точку восстановления, до которой будет выполняться отработка отказа. 
7. Дождитесь завершения выполнения задания отработки отказа, а затем убедитесь, что отработка отказа была выполнена правильно и реплицированные виртуальные машины успешно запускаются в Azure.

<a name="thirdparty"></a><h2>THIRD-PARTY SOFTWARE NOTICES AND INFORMATION</h2>

Do Not Translate or Localize

The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”).  Microsoft is the not original author of the Third Party Code.  The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.

The information in Section A is regarding Third Party Code components from the projects listed below. Such licenses and information are provided for informational purposes only.  This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.  

The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms. 

The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=530254)  h. Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.


<!--HONumber=49-->