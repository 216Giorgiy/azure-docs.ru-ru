---
title: "Как использовать MXChip IoT DevKit для подключения к службе подготовки устройств к добавлению в Центр Интернета вещей Azure | Документация Майкрософт"
description: "Как использовать MXChip IoT DevKit для подключения к службе подготовки устройств к добавлению в Центр Интернета вещей Azure."
services: iot-dps
keywords: 
author: liydu
ms.author: liydu
ms.date: 02/20/2018
ms.topic: article
ms.service: iot-dps
documentationcenter: 
manager: timlt
ms.devlang: na
ms.custom: mvc
ms.openlocfilehash: 77c8a6a5e384d27dca2582cc0fedc2bd23c0592e
ms.sourcegitcommit: 83ea7c4e12fc47b83978a1e9391f8bb808b41f97
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2018
---
# <a name="connect-mxchip-iot-devkit-to-azure-iot-hub-device-provisioning-service"></a>Подключение MXChip IoT DevKit к службе подготовки устройств к добавлению в Центр Интернета вещей Azure

Эта статья содержит сведения о настройке DevKit для автоматической регистрации в Центре Интернета вещей с помощью службы подготовки устройств. Из этого учебника вы узнаете следующее:

* настройка глобальной конечной точки службы подготовки устройств на устройстве;
* создание сертификата X.509 с помощью уникального секрета устройства (UDS);
* регистрация отдельного устройства;
* проверка регистрации устройства.

[MXChip IoT DevKit](https://aka.ms/iot-devkit) — это универсальная совместимая с Arduino плата со множеством периферийных устройств и датчиков. Вы можете выполнить для нее разработку с помощью [расширения Visual Studio Code для Arduino](https://aka.ms/arduino). Она предоставляется с расширяющимся [каталогом проектом](https://microsoft.github.io/azure-iot-developer-kit/docs/projects/), чтобы помочь вам выполнить прототипирование решений Интернета вещей, использующих службы Microsoft Azure.

## <a name="before-you-begin"></a>Перед началом работы

Для работы с этим руководством требуется следующее:

* Подготовить DevKit с помощью [руководства по началу работы](https://docs.microsoft.com/azure/iot-hub/iot-hub-arduino-iot-devkit-az3166-get-started).
* Обновить встроенное ПО до последней версии (>= 1.3.0) с помощью [этого](https://microsoft.github.io/azure-iot-developer-kit/docs/firmware-upgrading/) руководства.
* Создать и связать Центр Интернета вещей с экземпляром службы подготовки устройств, используя сведения в статье [Настройка службы подготовки устройств для Центра Интернета вещей на портале Azure](https://docs.microsoft.com/en-us/azure/iot-dps/quick-setup-auto-provision).

## <a name="set-up-the-device-provisioning-service-configuration-on-the-device"></a>настройка конфигурации службы подготовки устройств на устройстве.

Чтобы разрешить DevKit подключиться к созданному экземпляру службы подготовки устройств, сделайте следующее:

1. На портале Azure выберите колонку **Обзор** службы подготовки устройств и запишите значения **глобальной конечной точки устройства** и **области идентификатора**.
  ![Глобальная конечная точка службы подготовки устройств и область идентификатора](./media/how-to-connect-mxchip-iot-devkit/dps-global-endpoint.png)

2. Установите на компьютер систему `git` и добавьте ее в переменные среды, доступные в командном окне. Чтобы установить последнюю версию, перейдите на [страницу со средствами клиента Git от Software Freedom Conservancy](https://git-scm.com/download/).

3. Откройте окно командной строки. Клонируйте репозиторий GitHub, чтобы получить примеры кода службы подготовки устройств.
  ```bash
  git clone https://github.com/DevKitExamples/DevKitDPS.git
  ```

4. Запустите VS Code, подключите DevKit к компьютеру и откройте папку с клонированным кодом.

5. Откройте **DevKitDPS.ino**, найдите `[Global Device Endpoint]` и `[ID Scope]` и замените их значениями, которые вы только что записали.
  ![Конечная точка DPS](./media/how-to-connect-mxchip-iot-devkit/endpoint.png) Вы можете оставить строку **registrationId** пустой. Приложение создаст ее на основе MAC-адреса и версии встроенного ПО. Если вы хотите ее настроить, в идентификаторе регистрации необходимо использовать цифры и буквы нижнего регистра и дефисы (максимум 128 символов). Дополнительные сведения см. в статье [Как управлять регистрацией устройств с помощью портала Azure](https://docs.microsoft.com/en-us/azure/iot-dps/how-to-manage-enrollments).

6. Чтобы создать и передать код в DevKit, откройте **Quick Open** в VS Code (Windows — `Ctrl+P`, macOS — `Cmd+P`) и введите **task device-upload**.

7. В окне вывода появятся сведения об успешном выполнении задания.

## <a name="save-unique-device-secret-on-stsafe-security-chip"></a>Сохранение уникального секрета устройства в микросхеме безопасности STSAFE

Службу подготовки устройств можно настроить на устройстве в соответствии с ее [аппаратным модулем безопасности (HSM)](https://azure.microsoft.com/en-us/blog/azure-iot-supports-new-security-hardware-to-strengthen-iot-security/). DevKit использует [обработчик композиций для удостоверения устройств (DICE)](https://trustedcomputinggroup.org/wp-content/uploads/Foundational-Trust-for-IOT-and-Resource-Constrained-Devices.pdf) от [организации TCG](https://trustedcomputinggroup.org). С помощью **уникального секрета устройства**, сохраненного в микросхеме безопасности STSAFE в DevKit, можно создать уникальный сертификат [X.509](https://docs.microsoft.com/en-us/azure/iot-dps/tutorial-set-up-device#select-a-hardware-security-module) устройства. Сертификат можно позднее использовать при регистрации в службе подготовки устройств.

Обычный **уникальный секрет устройства** представляет собой строку, состоящую из 64 знаков. Ниже приведен пример уникального секрета устройства.

```
19e25a259d0c2be03a02d416c05c48ccd0cc7d1743458aae1cb488b074993eae
```

Каждый из двух символов используется в качестве шестнадцатеричного значения при расчете безопасности. Указанный выше пример уникального секрета устройства сопоставляется со следующими значениями: "`0x19`, `0xe2`, `0x5a`, `0x25`, `0x9d`, `0x0c`, `0x2b`, `0xe0`, `0x3a`, `0x02`, `0xd4`, `0x16`, `0xc0`, `0x5c`, `0x48`, `0xcc`, `0xd0`, `0xcc`, `0x7d`, `0x17`, `0x43`, `0x45`, `0x8a`, `0xae`, `0x1c`, `0xb4`, `0x88`, `0xb0`, `0x74`, `0x99`, `0x3e`, `0xae`".

Чтобы сохранить уникальный секрет устройства в DevKit, сделайте следующее:

1. Откройте Serial Monitor с помощью средства, такого как Putty. Дополнительные сведения см. в статье [Use Configuration Mode](https://microsoft.github.io/azure-iot-developer-kit/docs/use-configuration-mode/) (Использование режима настройки).

2. Чтобы перейти в режим настройки, подключите DevKit к компьютеру и нажмите и отпустите кнопку Reset (Сброс), удерживая нажатой кнопку A. На экране появится идентификатор DevKit и надпись **Configuration** (Настройка).

3. Воспользуйтесь указанным выше длинным примером строки уникального секрета устройства и измените один или несколько символов на другие значения между `0` и `f`. Его можно использовать как собственный уникальный секрет устройства.

4. В окне Serial Monitor введите **set_dps_uds [ваше_значение_UDS]** и нажмите клавишу ВВОД, чтобы его сохранить.
  > [!NOTE]
  > Например, если вы задали уникальный идентификатор устройства, изменив последние два символа на `f`, необходимо ввести следующую команду: **set_dps_uds 19e25a259d0c2be03a02d416c05c48ccd0cc7d1743458aae1cb488b074993eff**.

5. Не закрывая окно Serial Monitor, нажмите кнопку Reset (Сброс) на DevKit.

6. Запишите **MAC-адрес DevKit** и значение **версии встроенного ПО DevKit**.
  ![Версия встроенного ПО](./media/how-to-connect-mxchip-iot-devkit/firmware-version.png)

## <a name="generate-x509-certificate"></a>Создание сертификата X.509

### <a name="windows"></a>Windows

1. Откройте проводник и перейдите к папке с клонированным примером кода DSP. Найдите и скопируйте файлы **DPS.ino.bin** и **DPS.ino.map** в папку **.build**.
  ![Созданные файлы](./media/how-to-connect-mxchip-iot-devkit/generated-files.png)
  > [!NOTE]
  > Если вы изменили конфигурацию `built.path` Arduino на другую папку, необходимо найти эти файлы в настроенной папке.

2. Вставьте эти два файла в папку **tools** на одном уровне с папкой **.build**.

3. Выполните команду **dps_cert_gen.exe** и следуйте инструкциям, чтобы ввести **уникальный секрет устройства**, **MAC-адрес** для DevKit и **версию встроенного ПО** для создания сертификата X.509.
  ![Выполнение команды dps-cert-gen.exe](./media/how-to-connect-mxchip-iot-devkit/dps-cert-gen.png)

4. В окне вывода появятся сведения об успешном завершении процесса создания. **PEM-файл** сертификата будет сохранен в той же папке.

## <a name="create-a-device-enrollment-entry-in-the-device-provisioning-service"></a>Создание записи регистрации устройства в службе подготовки устройств

1. На портале Azure откройте службу подготовки. Откройте раздел **Управление регистрациями** и выберите вкладку **Индивидуальные регистрации**. ![Индивидуальные регистрации](./media/how-to-connect-mxchip-iot-devkit/individual-enrollments.png)

2. Щелкните **Добавить**.

3. В разделе **Механизм** выберите **X.509**.
  ![Передача сертификата](./media/how-to-connect-mxchip-iot-devkit/upload-cert.png)

4. В поле **PEM-файл или CER-файл сертификата** передайте имеющийся **PEM-файл** сертификата.

5. Значения остальных параметров оставьте без изменений и нажмите кнопку **Сохранить**.

## <a name="start-the-devkit"></a>Запуск DevKit

1. Запустите VS Code и откройте Serial Monitor.

2. Нажмите кнопку **Reset** (Сброс) на DevKit.

Вы увидите, что DevKit начал регистрацию в службе подготовки устройств.

![Выходные данные VS Code](./media/how-to-connect-mxchip-iot-devkit/vscode-output.png)

## <a name="verify-the-devkit-is-registered-on-iot-hub"></a>Проверка регистрации DevKit в Центре Интернета вещей

После загрузки устройства необходимо выполнить следующие действия.

1. Устройство отправляет запрос на регистрацию в службу подготовки устройств.
2. Служба подготовки устройств отправляет обратный запрос регистрации, на который отвечает устройство.
3. При успешной регистрации служба подготовки устройств отправляет обратно к устройству универсальный код ресурса Центра Интернета вещей, идентификатор устройства и зашифрованный ключ.
4. Затем клиентское приложение Центра Интернета вещей на устройстве подключается к центру.
5. При успешном подключении к центру устройство отобразится в средстве Device Explorer Центра Интернета вещей.
  ![Устройство зарегистрировано](./media/how-to-connect-mxchip-iot-devkit/device-registered.png)

## <a name="change-device-id"></a>Изменение идентификатора устройства

**AZ3166** — это стандартный идентификатор устройства, зарегистрированный в Центре Интернета вещей Azure. Если вы хотите его изменить, выполните [эти инструкции](https://microsoft.github.io/azure-iot-developer-kit/docs/customize-device-id/).

## <a name="problems-and-feedback"></a>Проблемы и обратная связь

Если вы столкнулись с проблемами, то можете ознакомиться с [часто задаваемыми вопросами](https://microsoft.github.io/azure-iot-developer-kit/docs/faq/) или обратиться к нам по одному из таких каналов:

* [Gitter.im](http://gitter.im/Microsoft/azure-iot-developer-kit)
* [Stackoverflow](https://stackoverflow.com/questions/tagged/iot-devkit)

## <a name="next-steps"></a>Дополнительная информация

Теперь вы узнали, как подготовить DevKit для безопасной регистрации устройства в службе подготовке устройств с помощью DICE, чтобы автоматически выполнять регистрацию в Центре Интернета вещей. Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * настройка глобальной конечной точки службы подготовки устройств на устройстве;
> * создание сертификата X.509 с помощью уникального секрета устройства (UDS);
> * регистрация отдельного устройства;
> * проверка регистрации устройства.

Перейдите к следующему руководству:

> [!div class="nextstepaction"]
> [Создание и подготовка имитированного устройства доверенного платформенного модуля (ТРМ) с помощью пакета SDK для устройства C для службы подготовки устройств Центра Интернета вещей](./quick-create-simulated-device.md)

