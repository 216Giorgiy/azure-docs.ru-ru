---
title: Как использовать MXChip IoT DevKit для подключения к службе "Подготовка устройств к добавлению в Центр Интернета вещей Azure" | Документация Майкрософт
description: Использование MXChip IoT DevKit для подключения к службе "Подготовка устройств к добавлению в Центр Интернета вещей Azure"
services: iot-dps
keywords: ''
author: liydu
ms.author: liydu
ms.date: 02/20/2018
ms.topic: article
ms.service: iot-dps
documentationcenter: ''
manager: timlt
ms.devlang: na
ms.custom: mvc
ms.openlocfilehash: 502f22a39622e9a8341e1daca8c9899fd8b7d7d1
ms.sourcegitcommit: d74657d1926467210454f58970c45b2fd3ca088d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
---
# <a name="connect-the-mxchip-iot-devkit-to-the-azure-iot-hub-device-provisioning-service"></a>Подключение MXChip IoT DevKit к службе "Подготовка устройств к добавлению в Центр Интернета вещей Azure"

Эта статья содержит сведения о настройке MXChip IoT DevKit для автоматической регистрации в Центре Интернета вещей Azure с помощью службы "Подготовка устройств к добавлению в Центр Интернета вещей Azure". Из этого руководства вы узнаете, как выполнять такие задачи:

* настройка глобальной конечной точки службы подготовки устройств на устройстве;
* создание сертификата X.509 с помощью уникального секрета устройства (UDS);
* регистрация отдельного устройства;
* проверка устройства на наличие регистрации.

[MXChip IoT DevKit](https://aka.ms/iot-devkit) — это универсальная совместимая с Arduino плата со множеством периферийных устройств и датчиков. Вы можете выполнить для нее разработку с помощью [расширения Visual Studio Code для Arduino](https://aka.ms/arduino). DevKit предоставляется с расширяющимся [каталогом проектов](https://microsoft.github.io/azure-iot-developer-kit/docs/projects/), чтобы помочь вам выполнить прототипирование решений Интернета вещей, использующих службы Azure.

## <a name="before-you-begin"></a>Перед началом работы

Для работы с этим руководством сначала следует выполнить следующие задачи:

* Подготовьте DevKit по инструкциям из статьи [Подключение платы IoT DevKit AZ3166 к Центру Интернета вещей Azure в облаке](https://docs.microsoft.com/azure/iot-hub/iot-hub-arduino-iot-devkit-az3166-get-started).
* Обновите новейшее встроенное ПО до версии 1.3.0 или более новой, воспользовавшись руководством по [обновлению встроенного ПО DevKit](https://microsoft.github.io/azure-iot-developer-kit/docs/firmware-upgrading/).
* Создайте и свяжите центр Интернета вещей с экземпляром службы подготовки устройств, следуя шагам из руководства [Настройка службы подготовки устройств для Центра Интернета вещей на портале Azure](https://docs.microsoft.com/en-us/azure/iot-dps/quick-setup-auto-provision).

## <a name="set-up-the-device-provisioning-service-configuration-on-the-device"></a>Настройка конфигурации службы подготовки устройств на устройстве

Чтобы подключить DevKit к созданному экземпляру службы подготовки устройств, сделайте следующее:

1. На портале Azure выберите панель **Обзор** службы подготовки устройств и запишите значения **глобальной конечной точки устройства** и **области идентификатора**.
  ![Глобальная конечная точка службы подготовки устройств и область идентификатора](./media/how-to-connect-mxchip-iot-devkit/dps-global-endpoint.png)

2. Убедитесь, что `git` установлен на компьютере и добавлен в переменные среды, доступные в командном окне. Чтобы установить последнюю версию, перейдите на [страницу со средствами клиента Git от Software Freedom Conservancy](https://git-scm.com/download/).

3. Откройте окно командной строки. Клонируйте репозиторий GitHub для примера кода службы подготовки устройств.
  ```bash
  git clone https://github.com/DevKitExamples/DevKitDPS.git
  ```

4. Откройте Visual Studio Code, подключите DevKit к компьютеру, а затем откройте папку с клонированным кодом.

5. Откройте файл **DevKitDPS.ino**. Найдите и замените значения `[Global Device Endpoint]` и `[ID Scope]` значениями, которые вы только что записали.
  ![Конечная точка DPS](./media/how-to-connect-mxchip-iot-devkit/endpoint.png) Вы можете оставить строку **registrationId** пустой. Приложение создаст ее на основе MAC-адреса и версии встроенного ПО. Если вы хотите настроить идентификатор регистрации, необходимо использовать только цифры, буквы нижнего регистра и дефисы (максимум 128 символов). Дополнительные сведения см. в статье [Как управлять регистрацией устройств с помощью портала Azure](https://docs.microsoft.com/en-us/azure/iot-dps/how-to-manage-enrollments).

6. Чтобы создать и передать код в DevKit, откройте Quick Open в VS Code (Windows — `Ctrl+P`, macOS — `Cmd+P`) и введите *task device-upload*.

7. В окне выходных данных будет отображено состояние выполнения задания (успешно или нет).

## <a name="save-a-unique-device-secret-on-an-stsafe-security-chip"></a>Сохранение уникального секрета устройства в микросхеме безопасности STSAFE

Службу подготовки устройств можно настроить на устройстве в соответствии с ее [аппаратным модулем безопасности](https://azure.microsoft.com/en-us/blog/azure-iot-supports-new-security-hardware-to-strengthen-iot-security/). MXChip IoT DevKit использует [обработчик композиций для удостоверения устройств](https://trustedcomputinggroup.org/wp-content/uploads/Foundational-Trust-for-IOT-and-Resource-Constrained-Devices.pdf) от [организации TCG](https://trustedcomputinggroup.org). С помощью *уникального секрета устройства*, сохраненного в микросхеме безопасности STSAFE в DevKit, можно создать уникальный сертификат [X.509](https://docs.microsoft.com/en-us/azure/iot-dps/tutorial-set-up-device#select-a-hardware-security-module) устройства. Сертификат можно использовать позже при регистрации в службе подготовки устройств.

Как указано в следующем примере, типичным уникальным секретом устройства является 64-символьная строка.

```
19e25a259d0c2be03a02d416c05c48ccd0cc7d1743458aae1cb488b074993eae
```

Каждый из двух символов используется в качестве шестнадцатеричного значения при расчете безопасности. Предыдущий пример уникального секрета устройства сопоставляется со следующими значениями: `0x19`, `0xe2`, `0x5a`, `0x25`, `0x9d`, `0x0c`, `0x2b`, `0xe0`, `0x3a`, `0x02`, `0xd4`, `0x16`, `0xc0`, `0x5c`, `0x48`, `0xcc`, `0xd0`, `0xcc`, `0x7d`, `0x17`, `0x43`, `0x45`, `0x8a`, `0xae`, `0x1c`, `0xb4`, `0x88`, `0xb0`, `0x74`, `0x99`, `0x3e`, `0xae`.

Чтобы сохранить уникальный секрет устройства в DevKit, сделайте следующее:

1. Откройте Serial Monitor с помощью таких инструментов, как Putty. Дополнительные сведения см. в статье [Use configuration mode](https://microsoft.github.io/azure-iot-developer-kit/docs/use-configuration-mode/) (Использование режима настройки).

2. Чтобы перейти в режим настройки, подключите DevKit к компьютеру, затем нажмите и отпустите кнопку **Сброс**, удерживая нажатой кнопку **A**. Будет показан идентификатор DevKit и надпись "Настройка".

3. Воспользуйтесь указанным примером строки уникального секрета устройства и измените один или несколько символов на другие значения между `0` и `f` в своем уникальном секрете устройства.

4. В окне Serial Monitor введите *set_dps_uds [ваше_значение_уникального_секрета_устройства]* и нажмите клавишу ВВОД.
  > [!NOTE]
  > Например, если вы задали уникальный идентификатор устройства, изменив последние два символа на `f`, необходимо ввести следующую команду: set_dps_uds 19e25a259d0c2be03a02d416c05c48ccd0cc7d1743458aae1cb488b074993eff.

5. Не закрывая окно Serial Monitor, нажмите кнопку **Сброс** на DevKit.

6. Запишите **MAC-адрес DevKit** и значения **версии встроенного ПО DevKit**.
  ![Версия встроенного ПО](./media/how-to-connect-mxchip-iot-devkit/firmware-version.png)

## <a name="generate-an-x509-certificate"></a>Создание сертификата X.509

### <a name="windows"></a>Windows

1. Откройте проводник и перейдите в папку, которая содержит пример кода службы подготовки устройств, клонированный ранее. Найдите и скопируйте файлы **DPS.ino.bin** и **DPS.ino.map** из папки **.build** в папку, которая содержит код.
  ![Созданные файлы](./media/how-to-connect-mxchip-iot-devkit/generated-files.png)
  > [!NOTE]
  > Если путь `built.path` конфигурации Arduino был изменен, вам необходимо найти эти файлы в новой папке, которую вы указали в качестве пути.

2. Вставьте эти два файла в папку **tools**, которая находится на одном уровне с папкой **.build**.

3. Запустите **dps_cert_gen.exe**. Следуйте инструкциям, чтобы ввести **уникальный секрет устройства**, **MAC-адрес** для DevKit и **версию встроенного ПО** для создания сертификата X.509.
  ![Выполнение команды dps-cert-gen.exe](./media/how-to-connect-mxchip-iot-devkit/dps-cert-gen.png)

4. После создания сертификата X.509 сертификат **PEM** будет сохранен в той же папке.

## <a name="create-a-device-enrollment-entry-in-the-device-provisioning-service"></a>Создание записи регистрации устройства в службе подготовки устройств

1. Перейдите в службу подготовки на портале Azure. Последовательно выберите вкладки **Управление регистрациями** и **Индивидуальные регистрации**. ![Индивидуальные регистрации](./media/how-to-connect-mxchip-iot-devkit/individual-enrollments.png)

2. Выберите **Добавить**.

3. В поле **Механизм** выберите **X.509**.
  ![Отправка сертификата](./media/how-to-connect-mxchip-iot-devkit/upload-cert.png)

4. В поле **Certificate .pem or .cer file** (PEM-файл или CER-файл сертификата) передайте **PEM-файл** сертификата, который вы только что создали.

5. Оставьте без изменений значения остальных параметров и выберите **Сохранить**.

## <a name="start-the-devkit"></a>Запуск DevKit

1. Откройте VS Code и Serial Monitor.

2. Нажмите кнопку **Reset** (Сброс) на DevKit.

Вы увидите, что DevKit начал регистрацию в службе подготовки устройств.

![Выходные данные VS Code](./media/how-to-connect-mxchip-iot-devkit/vscode-output.png)

## <a name="verify-that-the-devkit-is-registered-with-azure-iot-hub"></a>Убедитесь, что DevKit зарегистрирован в центре Интернета вещей Azure

После загрузки устройства выполняются следующие действия:

1. Устройство отправляет запрос на регистрацию в службу подготовки устройств.
2. Служба подготовки устройств отправляет обратный запрос регистрации, на который отвечает устройство.
3. При успешной регистрации служба подготовки устройств отправляет обратно к устройству универсальный код ресурса Центра Интернета вещей, идентификатор устройства и зашифрованный ключ.
4. Клиентское приложение Центра Интернета вещей на устройстве подключается к центру.
5. При успешном подключении к центру устройство отобразится в средстве Device Explorer Центра Интернета вещей.
  ![Устройство зарегистрировано](./media/how-to-connect-mxchip-iot-devkit/device-registered.png)

## <a name="change-the-device-id"></a>Изменение идентификатора устройства

*AZ3166* — это идентификатор устройства по умолчанию, зарегистрированный в Центре Интернета вещей Azure. Если необходимо изменить идентификатор, следуйте инструкциям из статьи [Customize device ID](https://microsoft.github.io/azure-iot-developer-kit/docs/customize-device-id/) (Настройка идентификатора устройства).

## <a name="problems-and-feedback"></a>Проблемы и обратная связь

Если вы столкнулись с проблемами, ознакомьтесь с [часто задаваемыми вопросами](https://microsoft.github.io/azure-iot-developer-kit/docs/faq/) об IoT DevKit или войдите в один из таких каналов, чтобы получить поддержку.

* [Gitter.im](http://gitter.im/Microsoft/azure-iot-developer-kit)
* [Stackoverflow](https://stackoverflow.com/questions/tagged/iot-devkit)

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как безопасно зарегистрировать устройство в службе подготовки устройств с помощью обработчика композиций для удостоверения устройств, после чего устройство может автоматически зарегистрироваться в Центре Интернета вещей Azure. 

Таким образом, вы научились выполнять такие задачи:

> [!div class="checklist"]
> * настройка глобальной конечной точки службы подготовки устройств на устройстве;
> * создание сертификата X.509 с помощью уникального секрета устройства;
> * регистрация отдельного устройства;
> * проверка устройства на наличие регистрации.

Дополнительные сведения см. в статье [Создание и подготовка имитированного устройства доверенного платформенного модуля (ТРМ) с помощью пакета SDK для устройства C для службы подготовки устройств Центра Интернета вещей](./quick-create-simulated-device.md).

