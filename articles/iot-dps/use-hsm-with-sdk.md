---
title: "Практическое руководство Azure — использование разных HSM с клиентским пакетом SDK для службы подготовки устройств | Документация Майкрософт"
description: "Практическое руководство по Azure. Использование разных HSM с физическими устройствами и симуляторами при помощи клиентского пакета SDK для службы подготовки устройств."
services: iot-dps
keywords: 
author: yzhong94
ms.author: yizhon
ms.date: 08/28/2017
ms.topic: hero-article
ms.service: iot-dps
documentationcenter: 
manager: 
ms.devlang: na
ms.custom: mvc
ms.translationtype: HT
ms.sourcegitcommit: 47ba7c7004ecf68f4a112ddf391eb645851ca1fb
ms.openlocfilehash: a5649ab873993d20803cb01a4b0ecc278c3ce16c
ms.contentlocale: ru-ru
ms.lasthandoff: 09/14/2017

---

# <a name="how-to-use-different-hardware-security-modules-with-device-provisioning-service-client-sdk"></a>Как использовать разные аппаратные модули безопасности с помощью клиентского пакета SDK для службы подготовки устройств
В статье приведены инструкции по применению разных [аппаратных модулей безопасности (HSM)](https://azure.microsoft.com/blog/azure-iot-supports-new-security-hardware-to-strengthen-iot-security/) с клиентским пакетом SDK для C для службы подготовки устройств при использовании физических устройств и симуляторов.  Служба подготовки поддерживает два режима проверки подлинности: X**.**509 и доверенный платформенный модуль (TPM).

## <a name="prerequisites"></a>Предварительные требования

Подготовьте среду разработки в соответствии с инструкциями в разделе "Подготовка среды разработки" руководства [Создание и подготовка виртуального устройства с помощью службы подготовки устройств Центра Интернета вещей (предварительная версия)] (./quick-create-simulated-device.md).

## <a name="enable-authentication-with-different-hsms"></a>Включение аутентификации с использованием разных модулей HSM

Перед регистрацией на портале Azure для физического устройства или симулятора нужно включить режим аутентификации (X**.**509 или TPM).  Перейдите в корневую папку для azure-iot-sdk-c.  Выполните указанную команду в соответствии с выбранным режимом аутентификации.

### <a name="use-x509-with-simulator"></a>Использование X**.**509 с симулятором

Служба подготовки поставляется с эмулятором DICE (обработчик композиции для удостоверений устройств), который создает сертификат X**.**509 для аутентификации устройства.  Чтобы включить аутентификацию X**.**509, выполните следующую команду:

```
cmake -Ddps_auth_type=x509 ..
```

Сведения, касающиеся оборудования с DICE, можно найти [здесь](https://azure.microsoft.com/blog/azure-iot-supports-new-security-hardware-to-strengthen-iot-security/).

### <a name="use-x509-with-hardware"></a>Использование X**.**509 с оборудованием

Службу подготовки можно использовать с X**.**509 для другого оборудования.  Для обмена данными между оборудованием и пакетом SDK требуется интерфейс.  Сведения об интерфейсе можно получить у производителя HSM.

### <a name="use-tpm"></a>Использование TPM

Служба подготовки может подключаться к микросхемам TPM оборудования Windows и Linux с использованием маркера SAS.  Чтобы включить аутентификацию TPM, выполните следующую команду:

```
cmake -Ddps_auth_type=tpm ..
```

### <a name="use-tpm-with-simulator"></a>Использование TPM с симулятором

Если у вас нет устройства с микросхемами TPM, можно использовать симулятор для разработки в ОС Windows.  Чтобы включить аутентификацию TPM, выполните следующую команду и запустите симулятор TPM:

```
cmake -Ddps_auth_type=tpm_simulator ..
```

## <a name="build-the-sdk"></a>Сборка пакета SDK
Перед регистрацией устройства выполните сборку пакета SDK.

### <a name="linux"></a>Linux
- Вот как выполнить сборку SDK в Linux:
    ```
    cd azure-iot-sdk-c
    mkdir cmake
    cd cmake
    cmake ..
    cmake --build .  # append '-- -j <n>' to run <n> jobs in parallel
    ```
- Чтобы создать двоичные файлы отладки, добавьте соответствующий параметр CMake в команду создания проекта, например:
    ```
    cmake -DCMAKE_BUILD_TYPE=Debug ..
    ```

- Для создания пакета SDK доступны разные [варианты конфигурации CMake](https://cmake.org/cmake/help/v3.6/manual/cmake.1.html). Например, можно отключить один из доступных стеков протоколов, добавив аргумент в команду создания проекта CMake:
    ```
    cmake -Duse_amqp=OFF ..
    ```
- Кроме того, можно создать и запустить модульный тест:
    ```
    cmake -Drun_unittests=ON ..
    cmake --build .
    ctest -C "debug" -V
    ```

### <a name="windows"></a>Windows
- Чтобы выполнить сборку пакета SDK в Windows, следуйте инструкциям по созданию файлов проекта ниже:
    - Откройте командную строку разработчика для VS2015.
    - Выполните следующие команды CMake из корня репозитория:
      ```
      cd azure-iot-sdk-c
      mkdir cmake
      cd cmake
      cmake -G "Visual Studio 14 2015" ..
      ```
    Эта команда отвечает за создание библиотек x86. Для создания x64 измените аргумент генератора cmake: 
    ```
    cmake .. -G "Visual Studio 14 2015 Win64"
    ```

- После успешного создания проекта в папке `cmake` появится файл решения Visual Studio (.sln). Чтобы создать пакет SDK,
    - откройте **cmake\azure_iot_sdks.sln** в Visual Studio и выполните сборку **ИЛИ**
    - выполните следующую команду в командной строке, которая использовалась для создания файлов проекта:
      ```
      cmake --build . -- /m /p:Configuration=Release
      ```
- Чтобы выполнить сборку двоичных файлов отладки, используйте соответствующий аргумент MSBuild: 
    ```
    cmake --build . -- /m /p:Configuration=Debug`
    ```
- Для создания пакета SDK доступны разные варианты конфигурации CMake. Например, можно отключить один из доступных стеков протоколов, добавив аргумент в команду создания проекта CMake:
    ```
    cmake -G "Visual Studio 14 2015" -Duse_amqp=OFF ..
    ```
- Кроме того, можно создать и запустить модульные тесты:
    ```
    cmake -G "Visual Studio 14 2015" -Drun_unittests=ON ..
    cmake --build . -- /m /p:Configuration=Debug
    ctest -C "debug" -V
    ```
  
### <a name="libraries-to-include"></a>Библиотеки, которые необходимо включить
- В пакет SDK требуется включить следующие библиотеки:
    - служба подготовки — dps_http_transport dps_client, dps_security_client;
    - безопасность Центра Интернета вещей — iothub_security_client.

## <a name="create-a-device-enrollment-entry-in-dps"></a>Создание записи для регистрации устройств в DPS

### <a name="tpm"></a>TPM
Если вы используете TPM, выполните инструкции в разделе [Создание и подготовка виртуального устройства с помощью службы подготовки устройств Центра Интернета вещей (предварительная версия)](./quick-create-simulated-device.md), чтобы создать запись регистрации устройств в DPS и смоделировать первую загрузку.

### <a name="x509"></a>X**.**509
1. Чтобы зарегистрировать устройство в службе подготовки, запишите ключ подтверждения и идентификатор регистрации для каждого устройства, которое отображается в средстве подготовки клиентского пакета SDK. Выполните следующую команду, чтобы распечатать сертификат корневого ЦС (для групп регистрации) и сертификат подписавшего (для отдельной регистрации):
      ```
      ./azure-iot-sdk-c/dps_client/tools/x509_device_provision/x509_device_provision.exe
      ```
2. Войдите на портал Azure, нажмите кнопку **Все ресурсы** в меню слева и откройте службу DPS.
   - Отдельная регистрация X**.**509: в колонке сводки для службы подготовки устройств выберите **Управление регистрациями**. На вкладке **Отдельные регистрации** и нажмите кнопку **Добавить** сверху. Выберите для *механизма* аттестации удостоверений значение **X**.**509** и передайте сертификат подписчика по запросу в колонке. Затем нажмите кнопку **Сохранить**. 
   - Групповая регистрация X**.**509: в колонке сводки для службы подготовки устройств выберите **Управление регистрациями**. Выберите вкладку **Групповые регистрации** и нажмите кнопку **Добавить** вверху. Выберите для *механизма* аттестации удостоверений значение **X**.**509**, введите имена группы и сертификата и передайте сертификат корневого ЦС по запросу в колонке. Затем нажмите кнопку **Сохранить**. 

## <a name="connecting-to-iot-hub-after-provisioning"></a>Подключение к Центру Интернета вещей после подготовки

После подготовки устройства с помощью службы подготовки API использует режим проверки подлинности HSM для подключения к Центру Интернета вещей: 
  ```
  IOTHUB_CLIENT_LL_HANDLE handle = IoTHubClient_LL_CreateFromDeviceAuth(iothub_uri, device_id, iothub_transport);
  ```

