<properties
	pageTitle="Устранение неполадок системы диагностики Azure"
	description="Устранение неполадок при использовании системы диагностики Azure в облачных службах Azure и виртуальных машинах."
	services="multiple"
	documentationCenter=".net"
	authors="rboucher"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="multiple"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="dotnet"
	ms.topic="article"
	ms.date="02/20/2016"
	ms.author="robb"/>


# Устранение неполадок с помощью системы диагностики Azure
Информация об устранении неполадок с помощью системы диагностики Azure. Дополнительные сведения о системе диагностики Azure см. в [обзоре системы диагностики Azure](azure-diagnostics.md#cloud-services).

## Система диагностики Azure не запускается
Диагностика состоит из двух компонентов: подключаемого модуля гостевого агента и агента мониторинга.

В роли облачной службы файлы журнала подключаемого модуля гостевого агента расположены в файле:

	*%SystemDrive%\ WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics<DiagnosticsVersion>*\CommandExecution.log

В виртуальной машине Azure файлы журнала подключаемого модуля гостевого агента расположены в файле:

		C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics<DiagnosticsVersion>\CommandExecution.log

Подключаемый модуль возвращает следующие коды ошибок:

Код выхода|Описание
---|---
0|Успешно.
-1|Общая ошибка.
-2|Невозможно загрузить RCF-файл.<p>Это внутренняя ошибка, возникающая, только когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине.
-3|Не удалось загрузить файл конфигурации системы диагностики.<p><p>Объяснение. Такой результат возникает, если файл конфигурации не прошел проверку на соответствие схеме. Следует предоставить файл конфигурации, соответствующий схеме.
-4|Другой экземпляр системы диагностики агента мониторинга уже использует локальный каталог ресурсов.<p><p>Решение. Измените значение **LocalResourceDirectory**.
-6|Попытка средства запуска подключаемого модуля гостевого агента запустить систему диагностики с помощью неправильно составленной команды.<p><p>Это внутренняя ошибка, возникающая только когда средство запуска подключаемого модуля гостевого агента вызван вручную, неправильно и на виртуальной машине.
-10|Подключаемый модуль системы диагностики был завершен с необработанным исключением.
-11|Гостевому агенту не удалось создать процесс, отвечающий за запуск и отслеживание агента мониторинга.<p><p>Решение. Убедитесь, что для запуска новых процессов достаточно системных ресурсов.<p>
-101|Недопустимые аргументы при вызове подключаемого модуля системы диагностики.<p><p>Это внутренняя ошибка, возникающая только когда средство загрузки подключаемого модуля гостевого агента вызван вручную, неправильно и на виртуальной машине.
-102|Процесс подключаемого модуля не может инициализироваться.<p><p>Решение. Убедитесь, что для запуска новых процессов достаточно системных ресурсов.
-103|Процесс подключаемого модуля не может инициализироваться. Как правило, не удается создать объект ведения журнала.<p><p>Решение. Убедитесь, что для запуска новых процессов достаточно системных ресурсов.
-104|Не удалось загрузить RCF-файл, предоставленный гостевым агентом.<p><p>Это внутренняя ошибка, возникающая только когда средство запуска подключаемого модуля гостевого агента вызван вручную, неправильно и на виртуальной машине.
-105|Подключаемому модулю системы диагностики не удается открыть файл конфигурации системы диагностики.<p><p>Это внутренняя ошибка, возникающая только когда подключаемый модуль системы диагностики вызван вручную, неправильно и на виртуальной машине.
-106|Не удалось прочесть конфигурационный файл системы диагностики.<p><p>Объяснение. Такой результат возникает, если файл конфигурации не прошел проверку на соответствие схеме. Решением будет предоставить файл конфигурации, соответствующий схеме. XML-файл, переданный в расширение системы диагностики, можно найти в папке *%SystemDrive%\\WindowsAzure\\Config* на виртуальной машине. Откройте соответствующий XML-файл и выполните поиск **Microsoft.Azure.Diagnostics**, а затем найдите поле **xmlCfg**. Данные в кодировке base64, поэтому необходимо [раскодировать их](http://www.bing.com/search?q=base64+decoder), чтобы просмотреть данные XML, загруженные системой диагностики.<p>
-107|Недопустимая передача каталога ресурсов в агент мониторинга.<p><p>Это внутренняя ошибка, возникающая, только когда агент мониторинга вызван вручную, неправильно и на виртуальной машине.</p>
-108 |Не удалось преобразовать файл конфигурации системы диагностики в файл конфигурации агента мониторинга.<p>Это внутренняя ошибка, которая может возникать, только если подключаемый модуль системы диагностики вызван вручную с помощью недопустимого файла конфигурации.<p>
-110|Общая ошибка конфигурации системы диагностики.<p><p>Это внутренняя ошибка, которая может возникать, только если подключаемый модуль системы диагностики вызван вручную с помощью недопустимого файла конфигурации.
-111|Не удалось запустить агент мониторинга.<p><p>Решение. Убедитесь, что системных ресурсов достаточно.
-112|Общая ошибка


## Журнал данных диагностики не записывается в службу хранилища Azure
Данные диагностики Azure хранятся в службе хранилища Azure.

Наиболее распространенная причина недостающих данных событий — это некорректно определенная информация об учетной записи хранения.

Решение. Исправьте файл конфигурации диагностики и повторно установите систему диагностики. Если проблема повторится после повторной установки расширения системы диагностики, то может потребоваться более тщательная отладка и просмотр ошибок агента мониторинга. До того, как данные событий передаются в вашу учетную запись хранения, они сохраняются в папке LocalResourceDirectory.

Для роли облачной службы LocalResourceDirectory это:

	C:\Resources\Directory<CloudServiceDeploymentID>.<RoleName>.DiagnosticStore\WAD<DiagnosticsMajorandMinorVersion>\Tables

Для виртуальных машин LocalResourceDirectory это:

	C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics<DiagnosticsVersion>\WAD<DiagnosticsMajorandMinorVersion>\Tables

Если в папке LocalResourceDirectory нет файлов, агент мониторинга не сможет запуститься. Обычно причина этого — недопустимый файл конфигурации. Это событие должно быть записано в файл CommandExecution.log.

Если агент мониторинга успешно собирает данные событий, то вы увидите TSF-файлы для каждого события, определенного в файле конфигурации. Агент мониторинга регистрирует обнаруженные ошибки в файле MaEventTable.tsf. Для изучения содержимого этого файла можно использовать приложение tabel2csv, чтобы преобразовать TSF-файл в файл значений, разделенных запятыми (CSV-файл):

В роли облачной службы:

	%SystemDrive%\Packages\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics<DiagnosticsVersion>\Monitor\x64\table2csv maeventtable.tsf

*% SystemDrive %* в роли облачной службы — обычно диск D:.

В виртуальной машине:

	C:\Packages\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics<DiagnosticsVersion>\Monitor\x64\table2csv maeventtable.tsf

Приведенная выше команда создает файл журнала *maeventtable.csv*, который можно открыть, чтобы изучить сообщения о сбое.


## Таблицы данных диагностики не найдены
Таблицы в службе хранилища Azure, содержащие данные диагностики Azure, именуются с помощью следующего примера кода:

		if (String.IsNullOrEmpty(eventDestination)) {
		    if (e == "DefaultEvents")
		        tableName = "WADDefault" + MD5(provider);
		    else
		        tableName = "WADEvent" + MD5(provider) + eventId;
		}
		else
		    tableName = "WAD" + eventDestination;

Пример:

		<EtwEventSourceProviderConfiguration provider=”prov1”>
		  <Event id=”1” />
		  <Event id=”2” eventDestination=”dest1” />
		  <DefaultEvents />
		</EtwEventSourceProviderConfiguration>
		<EtwEventSourceProviderConfiguration provider=”prov2”>
		  <DefaultEvents eventDestination=”dest2” />
		</EtwEventSourceProviderConfiguration>

Это создает четыре таблицы:

Событие|Имя таблицы
---|---
provider=”prov1” &lt;Event id=”1” /&gt;|WADEvent+MD5(“prov1”)+”1”
provider=”prov1” &lt;Event id=”2” eventDestination=”dest1” /&gt;|WADdest1
provider=”prov1” &lt;DefaultEvents /&gt;|WADDefault+MD5(“prov1”)
provider=”prov2” &lt;DefaultEvents eventDestination=”dest2” /&gt;|WADdest2

<!---HONumber=AcomDC_0302_2016-->