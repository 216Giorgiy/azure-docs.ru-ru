<properties
	pageTitle="Создание веб-ролей и рабочих ролей"
	description="Руководство по созданию веб-ролей и рабочих ролей PHP в облачной службе Azure и настройке среды выполнения PHP."
	services=""
	documentationCenter="php"
	authors="tfitzmac"
	manager="wpickett"
	editor="mollybos"/>

<tags
	ms.service="cloud-services"
	ms.workload="tbd"
	ms.tgt_pltfrm="na"
	ms.devlang="PHP"
	ms.topic="article"
	ms.date="06/09/2015"
	ms.author="tomfitz"/>

#Как создать веб-роли и рабочие роли PHP

## Обзор

В этом руководстве будет показано, как создать веб-роли или рабочие роли PHP в среде разработки Windows, как выбрать определенную версию PHP из доступных встроенных версий, изменить конфигурацию PHP, включить расширения и, наконец, как развернуть решение в Azure. Здесь также описывается, как создать веб-роль или рабочую роль для использования среды выполнения PHP (с настраиваемой конфигурацией и расширениями), которая предоставляется пользователем.

## Что такое веб-роли и рабочие роли PHP?
Azure предоставляет три вычислительных модели для выполнения приложений: [веб-сайты Azure][execution model-web sites], [виртуальные машины Azure][execution model-vms] и [облачные службы Azure][execution model-cloud services]. Все три модели поддерживают PHP. Облачные службы, которые включают веб-роли и рабочие роли, предоставляют *платформу как службу (PaaS)*. В рамках облачной службы веб-роль предоставляет выделенный веб-сервер IIS для размещения веб-приложений переднего плана, тогда как рабочая роль может выполнять асинхронные, долгосрочные или постоянные задачи, независимые от пользовательских действий и пользовательского ввода.

Дополнительные сведения см. в разделе [Что такое облачная служба?].

## Загрузка пакета Azure SDK для PHP

[Пакет Azure SDK для PHP] состоит из нескольких компонентов. В данной статье будут использоваться два компонента: Azure PowerShell и эмуляторы Azure. Эти два компонента можно установить с помощью установщика веб-платформы Майкрософт здесь: [Установка Azure PowerShell и эмуляторов Azure][install ps and emulators].

## Практическое руководство. Создание проекта облачной службы

Первым шагом в создании веб-роли или рабочей роли PHP является создание проекта службы Azure. Проект службы Azure представляет собой логический контейнер для веб-ролей или рабочих ролей, а также содержит файлы [определения службы (CSDEF)] и [конфигурации службы (CSCFG)] проекта.

Чтобы создать новый проект службы Azure, запустите Azure PowerShell от имени администратора и выполните следующую команду:

	PS C:\>New-AzureServiceProject myProject

Эта команда создаст новый каталог (`myProject`), в который можно добавить веб-роли и рабочие роли.

## Практическое руководство. Добавление веб-ролей и рабочих ролей PHP

Чтобы добавить в проект веб-роль PHP, выполните следующую команду из корневого каталога проекта.

	PS C:\myProject> Add-AzurePHPWebRole roleName

Для рабочей роли используйте следующую команду:

	PS C:\myProject> Add-AzurePHPWorkerRole roleName

> [AZURE.NOTE]Параметр `roleName` не обязателен. Если он опущен, имя роли будет создано автоматически. Первой созданной веб-ролью будет `WebRole1`, второй — `WebRole2` и т. д. Первой созданной рабочей ролью будет `WorkerRole1`, второй — `WorkerRole2` и т. д.

## Практическое руководство. Определение встроенной версии PHP

При добавлении в проект PHP веб-роли или рабочей роли, файлы конфигурации проекта изменяются таким образом, чтобы можно было установить PHP в каждом экземпляре веб-роли или рабочей роли вашего приложения при его развертывании. Чтобы посмотреть версию PHP, которая будет установлена по умолчанию, выполните следующую команду:

	PS C:\myProject> Get-AzureServiceProjectRoleRuntime

Выход приведенной выше команды будут выглядеть аналогично, приведенным ниже данным. В этом примере флаг `IsDefault` установлен в значение `true` для PHP 5.3.17, что указывает, что это будет версия PHP, установленная по умолчанию.

	Runtime Version		PackageUri						IsDefault
	------- ------- 	----------  					---------
   	Node 0.6.17      	http://nodertncu.blob.core...   False
   	Node 0.6.20         http://nodertncu.blob.core...   True
   	Node 0.8.4          http://nodertncu.blob.core...   False
	IISNode 0.1.21      http://nodertncu.blob.core...   True
  	Cache 1.8.0         http://nodertncu.blob.core...   True
    PHP 5.3.17          http://nodertncu.blob.core...   True
    PHP 5.4.0           http://nodertncu.blob.core...   False

Можно установить версию среды выполнения PHP в любой из указанных версий PHP. Например, чтобы задать версию PHP 5.4.0 (для роли с именем `roleName`), используйте следующую команду:

	PS C:\myProject> Set-AzureServiceProjectRole roleName php 5.4.0

> [AZURE.NOTE]В будущем больше версий PHP могут оказаться доступными, а доступные версии могут измениться.

## Практическое руководство. Настройка встроенной среды выполнения PHP

У вас есть полный контроль над конфигурацией среды выполнения PHP, которая устанавливается при выполнении описанных выше действий, включая изменение параметров `php.ini` и включение расширений.

Чтобы настроить встроенную среду выполнения PHP, выполните следующие действия.

1. Добавьте новую папку с именем `php` в каталог `bin` вашей веб-роли. Что касается рабочей роли, добавьте ее в корневой каталог роли.
2. В папке `php` создайте другую папку с именем `ext`. Поместите в эту папку любые файлы с расширением `.dll` (например, `php_mongo.dll`), которые следует включить.
3. Добавьте файл `php.ini` в папку `php`. Включите любые пользовательские расширения и задайте любые директивы PHP в этом файле. Например, если вы хотите включить `display_errors` и включить расширение `php_mongo.dll`, содержимое вашего файла `php.ini` будет такое:

		display_errors=On
		extension=php_mongo.dll

> [AZURE.NOTE]Те параметры, которые не задаются явным образом в предоставляемом вами файле `php.ini`, будут автоматически сброшены в значения по умолчанию. Тем не менее, следует помнить, что вы можете добавить полный файл `php.ini`.

## Практическое руководство. Использование собственной среды выполнения PHP
В некоторых случаях вместо выбора встроенной среды выполнения PHP и настройки в соответствии с указанными выше инструкциями вам может понадобиться предоставить собственную среду выполнения PHP. Например, можно использовать ту же среду выполнения PHP в веб-роли или рабочей роли, которая используется в среде разработки, что гарантирует отсутствие перемен в поведении приложения после его перевода в рабочую среду.

### Настройка веб-роли для использования собственной среды выполнения PHP

Чтобы настроить веб-роль для использования предоставленной среды выполнения PHP, выполните приведенные ниже действия.

1. Создайте проект службы Azure и добавьте веб-роль PHP, как описано в разделах [Практическое руководство. Создание проекта облачных служб](#how-to-create-a-cloud-services-project) и [Практическое руководство. Добавление веб-ролей и рабочих ролей PHP](#how-to-add-php-web-or-worker-roles) выше.
2. Создайте папку `php` в папке `bin`, которая находится в корневом каталоге веб-роли, затем добавьте среду выполнения PHP (все двоичные файлы, файлы конфигурации, подпапки и т. д.) в папку `php`.
3. (ДОПОЛНИТЕЛЬНО) Если среда выполнения PHP использует [драйверы Microsoft для PHP для SQL Server][sqlsrv drivers], необходимо настроить веб-роль для установки [SQL Server Native Client 2012][sql native client] после ее подготовки. Для этого добавьте установщик `sqlncli.msi` в папку `bin` в корневом каталоге веб-роли. Загрузить этот установщик можно здесь: [Установщик sqlncli.msi x64]. Скрипт запуска, описанный на следующем шаге, запустит установщик без вмешательства пользователя при подготовке роли. Если среда выполнения PHP не использует драйверы Microsoft для PHP для SQL Server, можно удалить следующую строку из скрипта, показанного на следующем шаге.

		msiexec /i sqlncli.msi /qn IACCEPTSQLNCLILICENSETERMS=YES

4. Следующим шагом является определение задачи запуска, которая настраивает [Службы IIS][iis.net], чтобы обработка запросов для страниц `.php` выполнялась с помощью вашей среды PHP. Для этого откройте файл`setup_web.cmd` (в файле `bin` корневого каталога веб-роли) в текстовом редакторе и замените его содержимое на следующий скрипт:

		@ECHO ON
		cd "%~dp0"

		if "%EMULATED%"=="true" exit /b 0

		msiexec /i sqlncli.msi /qn IACCEPTSQLNCLILICENSETERMS=YES

		SET PHP_FULL_PATH=%~dp0php\php-cgi.exe
		SET NEW_PATH=%PATH%;%RoleRoot%\base\x86

		%WINDIR%\system32\inetsrv\appcmd.exe set config -section:system.webServer/fastCgi /+"[fullPath='%PHP_FULL_PATH%',maxInstances='12',idleTimeout='60000',activityTimeout='3600',requestTimeout='60000',instanceMaxRequests='10000',protocol='NamedPipe',flushNamedPipe='False']" /commit:apphost
		%WINDIR%\system32\inetsrv\appcmd.exe set config -section:system.webServer/fastCgi /+"[fullPath='%PHP_FULL_PATH%'].environmentVariables.[name='PATH',value='%NEW_PATH%']" /commit:apphost
		%WINDIR%\system32\inetsrv\appcmd.exe set config -section:system.webServer/fastCgi /+"[fullPath='%PHP_FULL_PATH%'].environmentVariables.[name='PHP_FCGI_MAX_REQUESTS',value='10000']" /commit:apphost
		%WINDIR%\system32\inetsrv\appcmd.exe set config -section:system.webServer/handlers /+"[name='PHP',path='*.php',verb='GET,HEAD,POST',modules='FastCgiModule',scriptProcessor='%PHP_FULL_PATH%',resourceType='Either',requireAccess='Script']" /commit:apphost
		%WINDIR%\system32\inetsrv\appcmd.exe set config -section:system.webServer/fastCgi /"[fullPath='%PHP_FULL_PATH%'].queueLength:50000"

5. Добавьте файлы вашего приложения в корневой каталог веб-роли. Это будет корневой каталог веб-сервера.

6. Опубликуйте приложение, как описано в разделе [Практическое руководство. Публикация приложения](#how-to-publish-your-application) ниже.

> [AZURE.NOTE]Скрипт `download.ps1` (в папке `bin` корневого каталога веб-роли) можно удалить после выполнения приведенных выше действий для использования собственной среды выполнения PHP.

### Настройка рабочей роли для использования собственной среды выполнения PHP

Чтобы настроить рабочую роль для использования предоставленной среды выполнения PHP, выполните приведенные ниже действия.

1. Создайте проект службы Azure и добавьте рабочую роль PHP, как описано в разделах [Практическое руководство. Создание проекта облачных служб](#how-to-create-a-cloud-services-project) и [Практическое руководство. Добавление веб-ролей и рабочих ролей PHP](#how-to-add-php-web-or-worker-roles) выше.
2. Создайте папку`php` в корневом каталоге рабочей роли, а затем добавьте среду выполнения PHP (все двоичные файлы, файлы конфигурации, подпапки и т. д.) в папку `php`.
3. (ДОПОЛНИТЕЛЬНО) Если среда выполнения PHP использует [драйверы Microsoft для PHP для SQL Server][sqlsrv drivers], необходимо настроить рабочую роль для установки [SQL Server Native Client 2012][sql native client] после ее подготовки. Для этого добавьте установщик `sqlncli.msi` в корневой каталог рабочей роли. Загрузить этот установщик можно здесь: [Установщик sqlncli.msi x64]. Скрипт запуска, описанный на следующем шаге, запустит установщик без вмешательства пользователя при подготовке роли. Если среда выполнения PHP не использует драйверы Microsoft для PHP для SQL Server, можно удалить следующую строку из скрипта, показанного на следующем шаге.

		msiexec /i sqlncli.msi /qn IACCEPTSQLNCLILICENSETERMS=YES

4. Следующим шагом является определение задачи запуска, которая добавляет исполняемый файл `php.exe` в переменную среды PATH рабочей роли при подготовке роли. Для этого откройте файл `setup_worker.cmd` (в корневом каталоге рабочей роли) в текстовом редакторе и замените его содержимое на следующий скрипт:

		@echo on

		cd "%~dp0"

		echo Granting permissions for Network Service to the web root directory...
		icacls ..\ /grant "Network Service":(OI)(CI)W
		if %ERRORLEVEL% neq 0 goto error
		echo OK

		if "%EMULATED%"=="true" exit /b 0

		msiexec /i sqlncli.msi /qn IACCEPTSQLNCLILICENSETERMS=YES

		setx Path "%PATH%;%~dp0php" /M

		if %ERRORLEVEL% neq 0 goto error

		echo SUCCESS
		exit /b 0

		:error

		echo FAILED
		exit /b -1

5. Добавьте файлы вашего приложения в корневой каталог рабочей роли.

6. Опубликуйте приложение, как описано в разделе [Практическое руководство. Публикация приложения](#how-to-publish-your-application) ниже.

## Практическое руководство. Выполнение приложения в эмуляторах вычисления и хранилища

Эмуляторы вычислений и хранилища Azure предоставляют локальную среду, в которой можно протестировать приложение Azure перед развертыванием его в облаке. Существует несколько различий между эмуляторами и средой Azure. Чтобы лучше понять эти аспекты, изучите разделы [Различия между эмулятором вычислений и Azure](http://msdn.microsoft.com/library/windowsazure/gg432960.aspx) и [Различия между эмулятором хранилища и службами хранилища Azure](http://msdn.microsoft.com/library/windowsazure/gg433135.aspx).

Обратите внимание, что необходимо установить PHP локально для использования эмулятора вычислений. Эмулятор вычислений будет использовать локальную установку PHP для запуска приложения.

Чтобы выполнить свой проект в эмуляторах, выполните следующую команду из корневого каталога своего проекта.

	PS C:\MyProject> Start-AzureEmulator

Должен появиться результат, аналогичный приведенному ниже.

	Creating local package...
	Starting Emulator...
	Role is running at http://127.0.0.1:81
	Started

Вы можете просмотреть приложение, работающее в эмуляторе, открыв веб-браузер и перейдя по локальному адресу, показанному в выходных данных (`http://127.0.0.1:81` в примере выходных данных выше).

Чтобы остановить эмуляторы, выполните следующую команду:

	PS C:\MyProject> Stop-AzureEmulator

## Практическое руководство. Публикация приложения

Чтобы опубликовать свое приложение, необходимо сначала импортировать параметры публикации с помощью командлета **Import-PublishSettingsFile**, затем можно запустить публикацию приложения с помощью командлета **Publish-AzureServiceProject**. Сведения по использованию каждого из этих командлетов можно найти в разделах [Практическое руководство. Импорт параметров публикации] и [Практическое руководство. Развертывание облачной службы в Azure] соответственно.

[execution model-web sites]: /develop/net/fundamentals/compute/#WebSites
[execution model-vms]: /develop/net/fundamentals/compute/#VMachine
[execution model-cloud services]: /develop/net/fundamentals/compute/#CloudServices
[Пакет Azure SDK для PHP]: /develop/php/common-tasks/download-php-sdk/
[install ps and emulators]: http://go.microsoft.com/fwlink/?LinkId=253447&clcid=0x409
[Что такое облачная служба?]: /manage/services/cloud-services/what-is-a-cloud-service/
[определения службы (CSDEF)]: http://msdn.microsoft.com/library/windowsazure/ee758711.aspx
[конфигурации службы (CSCFG)]: http://msdn.microsoft.com/library/windowsazure/ee758710.aspx
[iis.net]: http://www.iis.net/
[sql native client]: http://msdn.microsoft.com/sqlserver/aa937733.aspx
[sqlsrv drivers]: http://php.net/sqlsrv
[Установщик sqlncli.msi x64]: http://go.microsoft.com/fwlink/?LinkID=239648
[Практическое руководство. Импорт параметров публикации]: /develop/php/how-to-guides/powershell-cmdlets/#ImportPubSettings
[Практическое руководство. Развертывание облачной службы в Azure]: /develop/php/how-to-guides/powershell-cmdlets/#Deploy

<!---HONumber=August15_HO6-->