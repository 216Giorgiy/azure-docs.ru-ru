<properties
	pageTitle="Архивация журналов диагностики Azure | Microsoft Azure"
	description="Узнайте, как выполнить архивацию журналов диагностики Azure для долгосрочного хранения в учетной записи хранения."
	authors="johnkemnetz"
	manager="rboucher"
	editor=""
	services="monitoring-and-diagnostics"
	documentationCenter="monitoring-and-diagnostics"/>

<tags
	ms.service="monitoring-and-diagnostics"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/26/2016"
	ms.author="johnkem"/>

# Архивация журналов диагностики Azure
В этой статье описано, как настроить архивацию [журналов диагностики Azure](monitoring-overview-of-diagnostic-logs.md) в учетной записи хранения с помощью портала Azure, командлетов PowerShell, интерфейса командной строки или REST API. Архивацию целесообразно применять, если вам нужно хранить журналы диагностики с использованием необязательной политики хранения для аудита, статического анализа или резервного копирования.

## Предварительные требования
Прежде чем начать, необходимо [создать учетную запись хранения](../storage/storage-create-storage-account.md#create-a-storage-account) для архивации журналов диагностики. Настоятельно рекомендуется не использовать имеющуюся учетную запись хранения, в которой содержатся другие данные (не данные мониторинга), чтобы лучше контролировать доступ к данным мониторинга. Но если в учетную запись хранения вы архивируете журнал действий и метрики диагностики, целесообразно использовать эту учетную запись и для хранения журналов диагностики. Так все данные мониторинга будут храниться в одном расположении. Используйте учетную запись хранения общего назначения, а не учетную запись хранения больших двоичных объектов.

## Параметры диагностики
Для архивации журналов диагностики с помощью любого из описанных ниже методов укажите **параметр диагностики** для конкретного ресурса. Параметр диагностики для ресурса определяет категории журналов, которые хранятся или передаются в виде потока, а также выходное расположение — хранилище учетной записи и (или) концентратор событий. Он также определяет политику хранения событий (продолжительность хранения в днях) для каждой категории журналов, содержащихся в учетной записи хранения. Если для политики хранения задано значение 0, события для такой категории журналов хранятся неограниченное время. [Подробные сведения о параметрах диагностики см. здесь](monitoring-overview-of-diagnostic-logs.md#diagnostic-settings).

## Архивация журналов диагностики с помощью портала

1. На портале в колонке ресурсов щелкните ресурс, для которого нужно включить архивацию журналов диагностики.
2. В разделе **Мониторинг** меню параметров ресурса щелкните **Диагностика**.

    ![Меню ресурсов: раздел мониторинга](media/monitoring-archive-diagnostic-logs/diag-log-monitoring-sec.png)
3. Установите флажок **Экспорт в учетную запись хранения**, а затем выберите учетную запись. При необходимости с помощью ползунков **Хранение (дни)** укажите продолжительность хранения этих журналов в днях. Нулевое значение означает, что журналы будут храниться неограниченно долго.

	![Колонка "Журналы диагностики"](media/monitoring-archive-diagnostic-logs/diag-log-monitoring-blade.png)
4. Щелкните **Сохранить**.

Журналы диагностики архивируются в эту учетную запись хранения по мере создания новых данных событий.

## Архивация журналов диагностики с помощью командлетов PowerShell

```
Set-AzureRmDiagnosticSetting -ResourceId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/testresourcegroup/providers/Microsoft.Network/networkSecurityGroups/testnsg -StorageAccountId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage -Categories networksecuritygroupevent,networksecuritygrouprulecounter -Enabled $true -RetentionEnabled $true -RetentionInDays 90
```

| Свойство | Обязательно | Описание |
|------------------|----------|-------------------------------------------------------------------------------------------------------|
| ResourceId | Да | Идентификатор ресурса, для которого будет указан параметр диагностики. |
| StorageAccountId | Нет | Идентификатор учетной записи хранения, в которую будут сохранены журналы диагностики. |
| Категории | Нет | Разделенный запятыми список категорий журналов, которые будут включены. |
| Включено | Да | Логическое значение, определяющее включение и отключение диагностики на этом ресурсе. |
| RetentionEnabled | Нет | Логическое значение, определяющее включение политики хранения на этом ресурсе. |
| RetentionInDays | Нет | Количество дней, в течение которых будут храниться события. Нулевое значение означает, что журналы хранятся неограниченно долго. |

## Архивация журналов диагностики с помощью межплатформенного интерфейса командной строки

```
azure insights diagnostic set --resourceId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/testresourcegroup/providers/Microsoft.Network/networkSecurityGroups/testnsg --storageId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage –categories networksecuritygroupevent,networksecuritygrouprulecounter --enabled true
```

| Свойство | Обязательно | Описание |
|------------------|----------|-------------------------------------------------------------------------------------------------------|
| resourceId | Да | Идентификатор ресурса, для которого будет указан параметр диагностики. |
| storageId | Нет | Идентификатор учетной записи хранения, в которую будут сохранены журналы диагностики. |
| categories | Нет | Разделенный запятыми список категорий журналов, которые будут включены. |
| включено | Да | Логическое значение, определяющее включение и отключение диагностики на этом ресурсе. |

## Архивация журналов диагностики с помощью REST API
Подробные сведения о настройке параметра диагностики с помощью REST API Insights см. [здесь](https://msdn.microsoft.com/library/azure/dn931931.aspx).

## Схема журналов диагностики в учетной записи хранилища
Когда вы настроите архивацию, в учетной записи хранения будет создан контейнер хранилища, как только в одной из включенных категорий журналов возникнет событие журнала. Большие двоичные объекты, содержащиеся в контейнере, имеют одинаковый формат в журналах диагностики и действий. Вот как выглядит структура большого двоичного объекта:

> insights-logs-{имя категории журнала}/resourceId=/SUBSCRIPTIONS/{код подписки}/RESOURCEGROUPS/{имя группы ресурсов}/PROVIDERS/{имя поставщика ресурсов}/{тип ресурса}/{имя ресурса}/y={год цифрами, 4 цифры}/m={месяц цифрами, 2 цифры}/d={день цифрами, 2 цифры}/h={время цифрами, 2 цифры, 24-часовой формат}/m=00/PT1H.json

Или даже еще проще:

> insights-logs-{имя категории журнала}/resourceId=/{resource Id}/y={год цифрами, 4 цифры}/m={месяц цифрами, 2 цифры}/d={день цифрами, 2 цифры}/h={время цифрами, 2 цифры, 24-часовой формат}/m=00/PT1H.json

Например, большой двоичный объект может иметь такое имя:

> insights-logs-networksecuritygrouprulecounter/resourceId=/SUBSCRIPTIONS/s1id1234-5679-0123-4567-890123456789/RESOURCEGROUPS/TESTRESOURCEGROUP/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUP/TESTNSG/y=2016/m=08/d=22/h=18/m=00/PT1H.json

Каждый большой двоичный объект PT1H.json содержит большой двоичный объект JSON с событиями, произошедшими в течение часа, указанного в URL-адресе этого объекта (например, h=12). В течение заданного часа события добавляются в файл PT1H.json по мере возникновения. Значение минуты (m=00) всегда равно 00, так как события журнала диагностики разбиваются на отдельные большие двоичные объекты каждый час.

В файле PT1H.json каждое событие сохраняется в массиве records в следующем формате:

```
{
	"records": [
		{
			"time": "2016-07-01T00:00:37.2040000Z",
			"systemId": "46cdbb41-cb9c-4f3d-a5b4-1d458d827ff1",
			"category": "NetworkSecurityGroupRuleCounter",
			"resourceId": "/SUBSCRIPTIONS/s1id1234-5679-0123-4567-890123456789/RESOURCEGROUPS/TESTRESOURCEGROUP/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/TESTNSG",
			"operationName": "NetworkSecurityGroupCounters",
			"properties": {
				"vnetResourceGuid": "{12345678-9012-3456-7890-123456789012}",
				"subnetPrefix": "10.3.0.0/24",
				"macAddress": "000123456789",
				"ruleName": "/subscriptions/ s1id1234-5679-0123-4567-890123456789/resourceGroups/testresourcegroup/providers/Microsoft.Network/networkSecurityGroups/testnsg/securityRules/default-allow-rdp",
				"direction": "In",
				"type": "allow",
				"matchedConnections": 1988
			}
		}
	]
}
```

| Имя элемента | Описание |
|---------------|-------------------------------------------------------------------------------------------------------------|
| Twitter в режиме реального | Метка времени, когда служба Azure создала событие при обработке соответствующего этому событию запроса. |
| resourceId | Идентификатор ресурса для затронутого ресурса. |
| operationName | Имя операции. |
| category | Категория журналов для события. |
| properties | Набор пар `<Key, Value>` (например, Dictionary) c подробным описанием события. |

> [AZURE.NOTE] Свойства и их использование зависят от ресурса.

## Дальнейшие действия
- [Скачивание больших двоичных объектов для анализа](../storage/storage-dotnet-how-to-use-blobs.md#download-blobs)
- [Потоковая передача журналов диагностики Azure в концентраторы событий](monitoring-stream-diagnostic-logs-to-event-hubs.md)
- [Обзор журналов диагностики Azure](monitoring-overview-of-diagnostic-logs.md)

<!---HONumber=AcomDC_0831_2016-->