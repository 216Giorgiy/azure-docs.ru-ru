<properties
	pageTitle="Azure Insights. Рекомендации по автомасштабированию Azure Insights | Microsoft Azure"
	description="Изучите принципы эффективного использования автомасштабирования в Azure Insights."
	authors="kamathashwin"
	manager=""
	editor=""
	services="monitoring-and-diagnostics"
	documentationCenter="monitoring-and-diagnostics"/>

<tags
	ms.service="monitoring-and-diagnostics"
	ms.workload="na"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/15/2016"
	ms.author="ashwink"/>

# Рекомендации по автомасштабированию Azure Insights

Информация, приведенная в разделах этого документа, поможет вам понять рекомендации по автомасштабированию в Azure Insights. После просмотра этой информации вы сможете эффективнее использовать автомасштабирование в инфраструктуре Azure.

## Основные понятия автомасштабирования

- У ресурса может быть только *один* параметр автомасштабирования.
- У параметра автомасштабирования может быть один или несколько профилей, и каждый профиль может содержать одно или несколько правил автомасштабирования.
- Параметр автомасштабирования масштабирует экземпляры горизонтально, то есть *разворачивает* их, увеличивая число экземпляров, или *сворачивает*, уменьшая их число. Параметр автомасштабирования определяет максимальное, минимальное и используемое по умолчанию число экземпляров.
- Задание автомасштабирования всегда считывает связанную метрику для масштабирования по ней, проверяя, превышено ли пороговое значение для разворачивания или сворачивания. Список метрик для автомасштабирования можно просмотреть в разделе [Azure Insights autoscaling common metrics](insights-autoscale-common-metrics.md).
- Все пороговые значения вычисляются на уровне экземпляров. Например, "развернуть еще 1 экземпляр, если средняя загрузка ЦП > 80 % и число экземпляров равно 2" означает, что разворачивание выполняется, когда средняя загрузки ЦП во всех экземплярах превышает 80 %.
- Вы всегда будете получать уведомления о сбоях по электронной почте. В частности, их будут получать владелец, участник и читатели целевого ресурса. Кроме того, вы всегда будете получать сообщение о *восстановлении* после того, как работа службы автомасштабирования будет восстановлена после сбоя и она начнет нормально функционировать.
- Вы может согласиться на получение уведомлений об успешных операциях масштабирования по электронной почте и через веб-перехватчики.

## Рекомендации по автомасштабированию

Используйте следующие рекомендации для автомасштабирования.

### Обязательно используйте разные минимальное и максимальное значения с соответствующим интервалом между ними
Если у вас есть параметр, у которого максимальное и минимальное значения равны 2, и текущее количество экземпляров равно 2, масштабирование будет невозможно. Рекомендуется обеспечить достаточный интервал между минимальным и максимальным количеством экземпляров. Служба автомасштабирования всегда будет масштабировать экземпляры в этих границах, включая их. Однако предположим, вы решили вручную масштабировать (изменить) число экземпляров до значения, превышающего максимальное. При следующем запуске задание автомасштабирования проверит, превышает ли текущее количество экземпляров максимальное значение. Если это так, оно выполнит сворачивание, оставив максимальное число экземпляров, независимо от того, какое пороговое значение задано в правилах. Аналогично, если вы вручную зададите текущее количество экземпляров меньше минимального значения, то во время следующего запуска задание автомасштабирования развернет минимальное число экземпляров.

### Всегда используйте сочетание правил разворачивания и сворачивания, которые выполняют увеличение и уменьшение числа экземпляров

Если использовать только одну часть сочетания, то служба автомасштабирования будет сворачивать (или разворачивать) экземпляры, пока не достигнет максимального (или минимального) числа.

### Не переключайтесь между порталом Azure и классическим порталом Azure при управлении автомасштабированием
Для облачных служб и служб приложений (веб-приложений) используйте портал Azure (portal.azure.com), чтобы создавать параметры автомасштабирования и управлять ими. Для наборов масштабирования виртуальных машин используйте PoSH, CLI или REST API, чтобы создавать параметры автомасштабирования и управлять ими. Не переключайтесь между классическим порталом Azure (manage.windowsazure.com) и порталом Azure (portal.azure.com) при управлении конфигурациями автомасштабирования. У классического портала Azure и его серверной базы есть ограничения. Перейдите на портал Azure, чтобы управлять автомасштабированием с помощью графического пользовательского интерфейса. Вы можете использовать автомасштабирование с помощью PowerShell, CLI или REST API (через обозреватель ресурсов Azure).

### Выберите соответствующий статистический показатель для диагностической метрики
Для диагностических метрик можно выбрать одно из следующих опорных значений для масштабирования: *Средний*, *Минимальный*, *Максимальный* и *Общий*. Наиболее распространенные статистический показатель — *Средний*.

### Внимательно выберите пороговые значения для всех типов метрик
Рекомендуется тщательно выбирать различные пороговые значения для разворачивания и сворачивания в зависимости от практических ситуаций.

Мы *не рекомендуем* приведенные ниже примеры автомасштабирования с одинаковыми или достаточно близкими пороговыми значениями в условиях разворачивания и сворачивания.

- Увеличение числа экземпляров на 1, если число потоков ≤ 600
- Уменьшение числа экземпляров на 1, если число потоков ≥ 600


Рассмотрим пример того, что может привести к противоречивому поведению. Предположим, что сначала было два экземпляра, и затем среднее число потоков на один экземпляр увеличилось до 625. Служба автомасштабирования разворачивает третий экземпляр. Затем предположим, что среднее число потоков на экземпляр уменьшилось до 575. Перед уменьшением масштаба служба автомасштабирования пытается оценить, какое конечное состояние будет после сворачивания. Например, 575 x 3 (текущее число экземпляров) = 1725 / 2 (итоговое число экземпляров после уменьшения масштаба) = 862,5 потока. Это означает, что если среднее число потоков не меняется или даже немного уменьшается, службе автомасштабирования сразу после сворачивания придется опять разворачивать новый экземпляр. Однако после повторного разворачивания весь опять процесс повторится, что приведет к бесконечному циклу. Чтобы избежать этой *нестабильной* ситуации, служба автомасштабирования вообще не меняет масштаб. Вместо этого она пропускает, а затем повторно оценивает условие при следующем выполнении задания службы. Это многих может сбить с толку, ведь все выглядело так, будто автомасштабирование не работало, когда среднее число потоков было равно 575.

Этот механизм оценки во время сворачивания реализован, чтобы избежать описанную выше нестабильную ситуацию. Следует помнить об этом механизме, выбирая одинаковые пороговые значения для разворачивания и сворачивания.

Мы рекомендуем задать соответствующий интервал между пороговыми значениями разворачивания и сворачивания. Например, рассмотрим более удачное сочетание правил.

- Увеличение числа экземпляров на 1, если загрузка ЦП ≥ 80
- Уменьшение числа экземпляров на 1, если загрузка ЦП ≤ 60

Посмотрим, как работает данный пример. Предположим, что с самого начала существуют два экземпляра. Если средняя загрузка ЦП во всех экземплярах достигает 80 %, то служба автомасштабирования разворачивает третий экземпляр. Теперь предположим, что со временем загрузка ЦП снижается до 60 %. Правило сворачивания службы автомасштабирования оценивает конечное состояние, которое будет после сворачивания. Например, 60 x 3 (текущее число экземпляров) = 180 / 2 (итоговое число экземпляров после уменьшения масштаба) = 90. Поэтому служба автомасштабирования не сворачивает экземпляр, так как после этого ей пришлось бы тут же развернуть его. Вместо этого она пропускает уменьшение масштаба. Далее предположим, что к моменту следующей проверки загрузка ЦП продолжала уменьшаться и снизилась до 50. Служба снова оценивает ее: 50 x 3 экземпляра = 150 / 2 экземпляра = 75. Это меньше порогового значения разворачивания, равного 80, поэтому служба успешно сворачивает один экземпляр, оставив два.

### Рекомендации по пороговым значениям масштабирования для специальных метрик
 Для специальных метрик, таких как метрика длины очереди хранилища или длины очереди служебной шины, пороговое значение — это среднее число сообщений, доступных для текущего числа экземпляров. Тщательно выбирайте пороговое значение этой метрики.

Проиллюстрируем пример, чтобы вы лучше поняли, как это работает.

- Увеличение числа экземпляров на 1, когда число сообщений в очереди хранилища ≥ 50
- Уменьшение числа экземпляров на 1, когда число сообщений в очереди хранилища ≤ 10

Предположим, что с самого начала существуют два экземпляра. Затем предположим, что сообщения продолжают поступать, и когда вы просматриваете очередь хранилища, их общее число достигает 50. Вы можете предположить, что служба автомасштабирования должна начать действие разворачивания. Однако обратите внимание, что число сообщений для каждого экземпляра по-прежнему 50 / 2 = 25. Так что разворачивание не происходит. Чтобы произошло первое разворачивание, общее число сообщений в очереди хранилища должно достичь 100. Далее предположим, что общее количество сообщений достигло 100. После действия разворачивания добавляется третий экземпляр. Следующее действие развертывания не будет выполнено, пока общее число сообщений в очереди не достигнет 150. Рассмотрим действие сворачивания. Предположим, что число экземпляров равно 3. Первое действие сворачивания происходит, когда общее число сообщений в очереди достигает 30, то есть получается 30 / 3 = 10 сообщений на экземпляр. А это и есть пороговое значение сворачивания.

### Рекомендации по масштабированию при настройке нескольких профилей в параметре автомасштабирования

В параметре автомасштабирования можно выбрать профиль по умолчанию, который применяется всегда, вне зависимости от расписания или времени. Также можно выбрать профиль повторения или профиль для фиксированного периода с диапазоном дат и времени.

Когда служба автомасштабирования обрабатывает их, она всегда выполняет проверку в следующем порядке:

1. профиль с фиксированной датой;
2. профиль повторения;
3. профиль по умолчанию ("Всегда").

Если соблюдено какое-либо условие профиля, служба автомасштабирования не проверяет следующее за ним условие профиля. Служба автомасштабирования обрабатывает только один профиль за раз. Это означает, что если требуется добавить условие обработки из профиля нижнего уровня, то необходимо включить соответствующие правила в текущий профиль.

Рассмотрим это на примере.

На следующем рисунке показан параметр автомасштабирования с профилем по умолчанию с минимальным числом экземпляров, равным 2, и максимальным числом экземпляров, равным 10. В этом примере настроены правила для разворачивания в случае, когда число сообщений в очереди превышает 10, и сворачивания, когда это число меньше 3. Итак, теперь ресурс может масштабироваться в пределах 2–10 экземпляров.

Кроме того, имеется профиль повторения, настроенный на "Понедельник". В нем задано минимальное число экземпляров, равное 2, и максимальное число экземпляров, равное 12. Это означает, если бы в понедельник, когда служба автомасштабирования впервые проверит это условие, число экземпляров было 2, она бы масштабировала их, увеличив число до нового минимального значения, т. е. до 3. Пока служба автомасштабирования будет определять, что это условие профиля соблюдено (понедельник), она будет обрабатывать только правила развертывания и сворачивания ресурсов ЦП, настроенные для этого профиля. Пока что она не будет проверять длину очереди. Тем не менее, если также требуется проверять условие длины очереди, необходимо добавить эти правила из профиля по умолчанию в профиль для понедельника.

Аналогично, когда служба автомасштабирования переключится обратно на профиль по умолчанию, сначала она проверит, соблюдены ли условия минимального и максимального числа экземпляров. Если на тот момент число экземпляров будет равно 12, служба свернет два из них, оставив 10, т. е. максимальное число для профиля по умолчанию.

![Параметры автомасштабирования](./media/insights-autoscale-best-practices/insights-autoscale-best-practices.png)

### Рекомендации по масштабированию при настройке нескольких правил в профиле
Бывают случаи, когда требуется задать несколько правил в профиле. Ниже приведен набор правил автомасштабирования, используемых при настройке нескольких правил.

Для запуска *разворачивания* службе автомасштабирования достаточно, чтобы было выполнено любое из правил. Для запуска *сворачивания* службе автомасштабирования требуется, чтобы были выполнены все правила.
 
Чтобы проиллюстрировать это, предположим, что заданы следующие 4 правила автомасштабирования:
 
- если загрузка ЦП < 30 %, свернуть 1 экземпляр;
- ​если объем используемой памяти < 50 %, свернуть 1 экземпляр;
- ​если загрузка ЦП > 75 %, развернуть1 экземпляр;
- ​если объем используемой памяти > 75 %, развернуть 1 экземпляр.

Будет происходить следующее.
- Если ресурсы ЦП загружены на 76 % и занято 50 % памяти, будет выполнено развертывание.
- Если ресурсы ЦП загружены на 50 % и занято 76 % памяти, будет выполнено развертывание.
 
С другой стороны, если ресурсы ЦП загружены на 25 % и занято 51 % памяти, служба автомасштабирования **не будет** выполнять сворачивание. Для этого ресурсы ЦП должны быть загружены на 29 % и должно быть занято 49 % памяти.

### Всегда выбирайте безопасное число экземпляров по умолчанию
Число экземпляров по умолчанию важно, так как это число экземпляров, устанавливаемое службой автомасштабирования, когда метрики недоступны. Поэтому выберите число экземпляров по умолчанию, являющееся безопасным для рабочих нагрузок.

### Настройка уведомлений об автомасштабировании
Служба автомасштабирования уведомляет администраторов и участников по электронной почте при возникновении любого из следующих условий:
- Службе автомасштабирования не удается выполнить действие.
- Службе автомасштабирования не доступны метрики для принятия решения по масштабированию.
- Метрики для принятия решения по масштабированию стали доступны (восстановились). Помимо приведенных условий можно настроить уведомления по электронной почте или через веб-перехватчики, чтобы узнавать об успешных действиях масштабирования.

<!---HONumber=AcomDC_0810_2016-->