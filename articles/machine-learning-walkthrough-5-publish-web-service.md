<properties title="Step 5: Publish the Azure Machine Learning web service" pageTitle="Step 5: Publish the Machine Learning web service | Azure" description="Step 5: Publish a scoring experiment in Azure Machine Learning Studio as an ML API web service" metaKeywords="" services="" solutions="" documentationCenter="" authors="garye" videoId="" scriptId="" />

<tags ms.service="machine-learning" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="garye"></tags>

Это пятый шаг из пошагового руководства [Разработка прогнозирующего решения с помощью Azure ML][Разработка прогнозирующего решения с помощью Azure ML].

1.  [Создание рабочего пространства ML][Создание рабочего пространства ML]
2.  [Отправка существующих данных][Отправка существующих данных]
3.  [Создание нового эксперимента][Создание нового эксперимента]
4.  [Подготовка и оценка моделей][Подготовка и оценка моделей]
5.  **Публикация веб-службы**
6.  [Доступ к веб-службе][Доступ к веб-службе]

------------------------------------------------------------------------

# Шаг 5. Публикация веб-службы машинного обучения Azure

Чтобы сделать прогнозную модель более удобной для других пользователей, мы опубликуем ее как веб-службу в Azure. Пользователь сможет отправлять в службу набор данных из заявки на кредит, а служба будет возвращать прогноз кредитного риска.

Для этого необходимо выполнить следующие действия:

-   подготовить эксперимент для публикации;
-   опубликовать его на промежуточном сервере, где можно его тестировать;
-   после того, как мы решим, что эксперимент готов, внедрить его на рабочем сервере.

Прежде чем двигаться дальше, следует создать копию эксперимента для правки. Таким образом можно будет вернуться к эксперименту для обучения в любое время, когда потребуется продолжить работу с модулями.

1.  Внизу холста нажмите кнопку **Сохранить как**.
2.  Дайте копии эксперимента понятное имя. По умолчанию к исходному имени эксперимента добавляется "- Copy". В нашем случае давайте дадим имя "Credit Risk Prediction - Scoring Experiment" (Прогнозирование кредитных рисков - эксперимент для оценки).
3.  Нажмите кнопку **ОК**.

Теперь в списке экспериментов Студии машинного обучения Microsoft Azure можно видеть как исходный эксперимент, так и его копию.

![Список экспериментов][Список экспериментов]

## Подготовка эксперимента для оценки

Чтобы подготовить модель к публикации в качестве веб-службы, необходимо выполнить два действия.

Во-первых, нужно преобразовать эксперимент из *эксперимента для обучения* в *эксперимент для оценки*. Вплоть до этого момента мы экспериментировали с обучением нашей модели. Но опубликованная служба больше не будет выполнять обучение — она будет оценивать данные, введенные пользователем. Поэтому мы сохраним копию модели, которую обучали, а затем удалим все компоненты нашего эксперимента, предназначенные для обучения.

Во-вторых, веб-служба машинного обучения Azure будет принимать входные данные от пользователя и возвращать результат, поэтому нужно идентифицировать точки ввода и вывода в нашем эксперименте.

### Преобразование эксперимента для обучения в эксперимент для оценки

Предположим, мы решили, что лучше всего подходит увеличивающаяся модель дерева. Поэтому в первую очередь следует удалить модули обучения SVM.

1.  Удалите **двухклассовый метод опорных векторов**.
2.  Удалите модули **Обучение модели** и **Оценка модели**, которые были к нему подключены.
3.  Удалите модуль **Преобразование данных масштабированием**.

Теперь сохраним увеличивающуюся модель дерева, которую мы обучали. Затем можно будет удалить остальные модули в эксперименте, которые использовались для обучения, и заменить их обученной моделью.

1.  Щелкните правой кнопкой мыши порт вывода оставшегося модуля **Обучение модели** и выберите команду **Сохранить как обученную модель**.
2.  Введите имя и описание обученной модели. В данном примере дадим этой модели имя "Credit Risk Prediction" (Прогнозирование кредитных рисков).

    > **Примечание**. После сохранения этой обученной модели она появляется в палитре модулей и становится доступной для использования в других экспериментах.

3.  Найдите модель в палитре модулей, введя "credit risk" в поле **Поиск**, а затем перетащите обученную модель **прогнозирования кредитных рисков** на холст эксперимента.
4.  Удалите модули **Двухклассовое увеличивающееся дерево решений** и **Обучение модели**.
5.  Соедините вывод модели **прогнозирования кредитных рисков** с левым вводом модуля **Оценка модели**.

Теперь у нас в эксперименте имеется сохраненная обученная версия модели вместо исходных модулей обучения.

В эксперименте есть и другие компоненты, которые мы добавили только для обучения и для сравнения двух алгоритмов модели. Их также можно удалить.

-   **Разделение**
-   Оба модуля **Выполнение скрипта R**
-   **Анализ модели**

Еще один момент: В исходных данных кредитной карты был столбец "Кредитный риск". Мы передали этот столбец в модуль **обучения модели**, чтобы он мог обучать модель для прогнозирования значений кредитного риска. Но теперь, когда модель обучена, нам не нужно больше передавать этот столбец — обученная модель будет прогнозировать это значение. Для удаления этого столбца из потока данных мы используем модуль **Столбцы проекта**.

1.  Найдите и перетащите **Столбцы проекта** на холст.
2.  Соедините этот модуль с выводом модуля **Редактор метаданных** (теперь, когда модули **Разделение** и **Выполнение скрипта R** удалены).
3.  Выберите модуль **Столбцы проекта** и щелкните **Запустить средство выбора столбцов**.
4.  В раскрывающемся списке оставьте выбранным значение "Все столбцы".
5.  Нажмите знак "плюс" (+), чтобы создать новую строку раскрывающегося списка.
6.  В этом новом раскрывающемся списке выберите "Исключить названия столбцов" и введите "Кредитный риск" в текстовом поле (можно также указать этот столбец по его номеру 21).
7.  Нажмите кнопку **ОК**.

    > Совет. Средство выбора столбцов выполняет логику раскрывающихся списков в том порядке, в котором они появляются. В данном случае мы указали модулю **Столбцы проекта** проходить по всем столбцам, кроме столбца "Кредитный риск". Если бы мы пропустили первый раскрывающийся список, модуль вообще не проходил бы по столбцам.

8.  Соедините вывод модуля **Столбцы проекта** с правым вводом модуля **Оценка модели**.

Теперь наш эксперимент должен выглядеть следующим образом:

![Оценка обученной модели][Оценка обученной модели]

### Выбор ввода и вывода службы

В исходной модели данные для оценки передавались в правый порт ввода ("Набор данных") модуля **Оценка модели**, а результат оценки появлялся в порте вывода ("Оцененный набор данных"). Мы хотим, чтобы после запуска службы данные пользователей и результаты использовали те же порты.

1.  Щелкните правой кнопкой мыши правый порт ввода модуля **Обучение модели** и выберите команду **Set as Publish Input** (Сохранить как ввод публикации). Данные пользователя должны включать все данные характеристического вектора.

    > **Совет.** Если требуется выполнять какие-либо операции с данными пользователя до передачи их в модуль оценки (например, мы таким образом использовали модуль **Преобразование данных масштабированием**, чтобы подготовить данные для модели SVM), просто оставьте этот модуль в веб-службе и установите в качестве точки ввода службы порт ввода этого модуля.

2.  Щелкните правой кнопкой порт вывода и выберите команду **Set as Publish Output** (Установить как вывод публикации). Вывод модуля оценки модели будет возвращаться этой службой. Сюда входит характеристический вектор, прогноз кредитного риска и значение вероятности оценки.

    > **Совет.** Если требуется, чтобы веб-служба возвращала только часть этих данных (например, не нужно возвращать характеристический вектор полностью), можно добавить модуль **Столбцы проекта** после модуля **Оценка модели**, настроить его, чтобы он исключал ненужные столбцы, а затем установить в качестве точки вывода веб-службы порт вывода модуля **Столбцы проекта**.

> **Примечание.** Возможно, вас удивляет, почему мы оставили набор данных UCI German Credit Card Data и связанные с ним модули подключенными к модулю **оценки модели**. Планируется, что служба будет использовать пользовательские данные, а не исходный набор данных, так почему они оставлены подключенными?

Действительно, службе не нужны исходные данные кредитных карт. Но по-прежнему нужна схема для этих данных, включающая такие сведения, как общее число столбцов, а также какие столбцы являются числовыми. Эти данные схемы необходимы для интерпретации пользовательских данных. Мы оставили эти компоненты подключенными, чтобы модуль оценки имел схему набора данных при запуске службы. Данные не используются, используется только схема.

Запустите эксперимент в последний раз (нажмите **ВЫПОЛНИТЬ**). Чтобы проверить, что модуль по-прежнему работает, щелкните правой кнопкой мыши вывод модуля **Оценка модели** и выберите команду **Визуализировать**. Вы увидите исходные данные со значениями кредитного риска ("Scored Labels") и значениями вероятности оценки ("Scored Probabilities").

## Публикация веб-службы

Чтобы опубликовать веб-службу, полученную из нашего эксперимента, нажмите кнопку **ОПУБЛИКОВАТЬ ВЕБ-СЛУЖБУ** под холстом и при запросе нажмите кнопку **ДА**. Студия машинного обучения Microsoft Azure публикует эксперимент как веб-службу на промежуточном сервере машинного обучения и выводит панель мониторинга службы.

> **Совет.** После публикации веб-службы ее можно обновить. Например, если требуется изменить модель, просто измените эксперимент для обучения, сохраненный ранее, отладьте параметры модели и сохраните обученную модель (перезаписав ту, которая была сохранена ранее). При следующем открытии эксперимента для оценки появится уведомление, сообщающее о том, что кое-что было изменено (в данном случае это ваша обученная модель), и вы можете обновить эксперимент. После повторной публикации эксперимента он заменит веб-службу, используя обновленную модель.

Службу можно настраивать на вкладке **КОНФИГУРАЦИЯ**. На этой вкладке можно изменить имя службы (по умолчанию она получает имя эксперимента) и предоставить ее описание. Можно также дать входным и выходным столбцам более понятные метки.

С переключателем **READY FOR PRODUCTION?** (Готово для рабочей среды?) мы будем работать немного позже.

## Тестирование веб-службы

На странице **ПАНЕЛЬ МОНИТОРИНГА** щелкните ссылку **Тест** под заголовком **Промежуточные службы**. Появится диалоговое окно, предлагающее ввести входные данные для службы. Это те же столбцы, которые были в исходном немецком наборе данных для кредитного риска.

Введите набор данных и нажмите кнопку **ОК**.

Результаты, созданные веб-службой, отображаются внизу панели мониторинга. Итак, служба настроена; отображенные результаты созданы модулем оценки.

## Продвижение веб-службы на рабочий сервер

До сих пор служба работала на промежуточном сервере машинного обучения. Когда она будет полностью подготовлена к использованию конечными пользователями, можно запросить ее продвижение на рабочий сервер.

На вкладке **КОНФИГУРАЦИЯ** установите для переключателя **READY FOR PRODUCTION?** (Готово для рабочей среды?) значение "ДА". ИТ-администратору будет отправлено уведомление, что эта веб-служба готова к использованию конечными пользователями. Затем администратор может продвинуть ее на рабочий сервер.

![Продвижение веб-службы в рабочую среду][Продвижение веб-службы в рабочую среду]

------------------------------------------------------------------------

**Далее: [Доступ к веб-службе][Доступ к веб-службе]**

  [Разработка прогнозирующего решения с помощью Azure ML]: ../machine-learning-walkthrough-develop-predictive-solution/
  [Создание рабочего пространства ML]: ../machine-learning-walkthrough-1-create-ml-workspace/
  [Отправка существующих данных]: ../machine-learning-walkthrough-2-upload-data/
  [Создание нового эксперимента]: ../machine-learning-walkthrough-3-create-new-experiment/
  [Подготовка и оценка моделей]: ../machine-learning-walkthrough-4-train-and-evaluate-models/
  [Доступ к веб-службе]: ../machine-learning-walkthrough-6-access-web-service/
  [Список экспериментов]: ./media/machine-learning-walkthrough-5-publish-web-service/publish1.png
  [Оценка обученной модели]: ./media/machine-learning-walkthrough-5-publish-web-service/publish2.png
  [Продвижение веб-службы в рабочую среду]: ./media/machine-learning-walkthrough-5-publish-web-service/publish3.png
