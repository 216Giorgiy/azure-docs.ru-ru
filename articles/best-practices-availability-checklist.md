<properties
   pageTitle="Контрольный список для обеспечения доступности | Microsoft Azure"
   description="Контрольный список с рекомендациями по вопросам доступности, возникающим во время проектирования."
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="12/15/2015"
   ms.author="masashin"/>

# Контрольный список для обеспечения доступности

![](media/best-practices-availability-checklist/pnp-logo.png)

## Проектирование приложений

- **Избегайте единых точек отказа.** Все компоненты, службы, ресурсы и вычислительные сущности должны развертываться в нескольких экземплярах, чтобы предотвратить влияние на доступность единой точки отказа. Это относится и к механизмам аутентификации. Проектируйте приложение так, чтобы его можно было настроить для использования нескольких экземпляров, а также для автоматического обнаружения сбоев и перенаправления запросов в исправные экземпляры там, где платформы не делают это автоматически.
- **Выполняйте декомпозицию рабочей нагрузки для разных соглашениях об уровне обслуживания.** Если служба состоит из критический важной и менее важной рабочей нагрузки, управляйте ими по-разному и укажите функции службы и число экземпляров в соответствии с их требованиями доступности.
- **Сводите к минимуму и понимайте зависимости службы.** Сведите к минимуму количество различных используемых служб, где это возможно, и убедитесь, что вы понимаете все функции и зависимости службы, которые существуют в системе. Сюда относится характер этих зависимостей и влияние сбоя или понижения производительности в каждой из них на приложение в целом. Корпорация Майкрософт гарантирует не менее 99,9 % доступности для большинства служб, но это означает, что каждая дополнительная служба, от которой зависит приложение, потенциально уменьшает общую доступность по соглашению об уровне обслуживания системы на 0,1 %.
- **Проектируйте задачи и сообщений как идемпотентные, где это возможно,** чтобы повторяющиеся запросы не создавали проблем. Например, служба может действовать как получатель, который обрабатывает сообщения, отправленные как запросы другими частями системы, действующими как производители. Если сбой объекта-получателя происходит после обработки сообщения, но до подтверждения, что оно обработано, производитель может отправить повторный запрос, который может быть обработан другим экземпляром объекта-получателя. По этой причине объекты-получатели и операции, которые они выполняют, должны быть идемпотентными, чтобы повторение ранее выполненных операций не приводило к недопустимым результатам. Это может означать обнаружение повторяющихся сообщений или обеспечение согласованности с помощью оптимистичной методики обработки конфликтов.
- **Используйте брокер сообщений, реализующий высокий уровень доступности, для важных транзакций.** Во многих сценариях для запуска задач или обращения к удаленным службам используется обмен сообщениями для передачи инструкций между приложением и целевой службой. Для наилучшей производительности у приложения должна быть возможность отправить сообщение, а затем вернуться к обработке других запросов без необходимости ожидать ответа. Чтобы гарантировать доставку сообщений, системе обмена сообщениями следует обеспечивать высокий уровень доступности. Очереди сообщений служебной шины реализуют семантику _минимум однажды_, при которой каждое сообщение, отправленное в очередь, не будет потеряно, несмотря на то, что при определенных обстоятельствах могут быть доставлены дубликаты. Если обработка сообщений идемпотентна (см. предыдущий пункт), то повторная доставка не должно стать проблемой.
- **Проектируйте приложения так, чтобы при достижении лимита ресурсов их производительность понижалась корректно**, и выполняли соответствующие действия, чтобы свести к минимуму влияние на пользователя. В некоторых случаях нагрузка на приложение может превышать возможности одной или нескольких частей, вызывая ограничение доступности и сбои подключений. Масштабирование позволяет обойти эту проблему, но может и оно имеет предел, обусловленный такими факторами, как доступность ресурсов или затраты. Спроектируйте приложение таким образом, чтобы в этом случае его производительность могла корректно автоматически понижаться. Например, если в системе электронной коммерции подсистема обработки заказов испытывает высокую нагрузку (или даже полностью неисправна), эту часть системы можно временно отключить, позволив работать другим функциональным возможностям (например, функции просмотра каталога продуктов). Может понадобиться отложить запросы к неисправной подсистеме, например, по-прежнему позволяя клиентам размещать заказы, но сохраняя их в очереди или применяя другой механизм безопасного хранения для последующей обработки, когда подсистема обработки заказов снова не станет доступна.
- **Корректно обрабатывайте внезапные всплески активности.** Большинству приложений время от времени требуется обрабатывать меняющиеся рабочие нагрузки, например первые пики утром в бизнес-приложении или при выпуске нового продукта на сайте электронной коммерции. Автоматическое масштабирование позволяет справиться с нагрузкой, но подключение дополнительных экземпляров к сети для обработки запросов может потребовать какого-то времени. Предотвратите перегрузку приложения при внезапных и непредвиденных всплесках активности, спроектировав его так, чтобы оно ставило в очередь запросы к службам, которые использует, и корректно понижало производительность, когда очереди близки к полному заполнению. Убедитесь, что при отсутствии всплесков производительности и мощности достаточно, чтобы опустошить очереди и обработать необработанные запросы. Дополнительную информацию см. в разделе [Шаблон балансировки нагрузки на основе очередей](https://msdn.microsoft.com/library/dn589783.aspx).

## Развертывание и обслуживание

- **Развертывайте по несколько экземпляров ролей для каждой службы.** Корпорация Майкрософт предоставляет гарантии доступности для служб, которые вы создаете и развертываете, но эти гарантии действительны только при развертывании по крайней мере двух экземпляров каждой роли в службе. Тогда одна роль может быть недоступна, пока другая остается активной. Это особенно важно, если необходимо выполнять развертывание обновлений в динамической системе без прерывания действий клиентов; экземпляры могут остановлены и обновлены по отдельности, пока остальные остаются в сети.
- **Размещайте приложения в нескольких центрах обработки данных.** Хотя и крайне маловероятно, но возможно отключение всего центра обработки данных из-за таких событий, как стихийное бедствие или неисправность магистрали Интернета. Критически важные бизнес-приложения должны быть размещены в более чем одном центре обработки данных, чтобы обеспечить максимальную доступность. Это дает дополнительное преимущество в том, что позволяет уменьшить задержку для локальных пользователей и предоставляет дополнительные возможности для обеспечения гибкости при обновлении приложений.
- **Автоматизируйте и тестируйте задачи развертывания и обслуживания.** Распределенные приложения состоят из нескольких частей, которые должны работать вместе. Поэтому развертывание должно быть автоматизировано с помощью проверенных и надежных механизмов, например сценариев и приложений развертывания, которые обновляют и проверяют конфигурацию, а также автоматизируют процесс развертывания. Автоматизированные методы должны также использоваться для обновления всех или части приложений. Важно протестировать все эти процессы полностью, чтобы удостовериться, что ошибки не приводят к дополнительным простоям. У всех инструментов развертывания должны быть соответствующие ограничения безопасности для защиты развернутого приложения. Внимательно определяйте и применяйте политики развертывания и сведите к минимуму необходимость вмешательства человека.
- **Рассмотрите возможность использования промежуточной и рабочей среды для платформы**, где это возможно. Например, использование промежуточной и рабочей сред облачных служб Azure позволяет приложениям мгновенно переключаться между собой благодаря переключению виртуальных IP-адресов. Тем не менее, если вы предпочитаете локальное размещение или одновременное развертывание различных версий приложения с постепенным переносом пользователей, то нельзя будет использовать операцию переключения виртуальных IP-адресов.
- **Применяйте изменения конфигурации без повторного использования** экземпляра, если это возможно. Во многих случаях параметры конфигурации для службы или приложения Azure можно изменить без необходимости перезапуска роли. Роли предоставляют события, которые могут быть обработаны, чтобы обнаруживать изменения конфигурации и применять их к компонентам в приложении. Тем не менее, некоторые изменения основных параметров платформы потребуют перезапуска роли. При создании компонентов и служб обеспечьте максимальную доступность и сведите к минимуму время простоя, спроектировав их таким образом, чтобы они принимали изменения параметров конфигурации без необходимости перезапуска всего приложения.
- **Используйте домены обновления, чтобы свести к нулю время простоя при обновлениях.** Такие единицы вычислений Azure, как веб-роли и рабочие роли, назначаются доменам обновления. Домены обновления группируют экземпляры роли вместе, чтобы после последовательного обновления каждая роль в домене обновления была по очереди остановлена, обновлена и перезапущена. Это позволяет свести к минимуму влияние на доступность приложения. Для службы можно указать количество доменов обновления, которое должно быть создано, при ее развертывании.

	> [AZURE.NOTE] Роли также распределяются по доменам сбоя, каждый из которых является достаточно независимым от других доменов сбоя с точки зрения серверной стойки, подачи питания и охлаждения, чтобы свести к минимуму вероятность возникновения сбоя, влияющего на все экземпляры роли. Это распределение выполняется автоматически и не управляется.

- **Настройте группы доступности для виртуальных машин Azure.** Размещение двух или больше виртуальных машин в одной группе доступности гарантирует, что эти виртуальные машины не будет развернуты в одном домене сбоя. Чтобы добиться максимальной доступности, следует создать несколько экземпляров каждой критически важной виртуальной машины, используемой системой, и поместить эти экземпляры в одну группе доступности. Если вы используете несколько виртуальных машин, которые предназначены для разных целей, создайте группу доступности для каждой из них и добавьте экземпляры каждой виртуальной машины в каждую группу доступности. Например, если вы создали отдельные виртуальные машины для веб-сервера и сервера отчетов, создайте одну группу доступности для веб-сервера, а другую — для сервера отчетов. Добавьте экземпляры виртуальной машины веб-сервера в группу доступности веб-сервера и добавьте экземпляры виртуальной машины сервера отчетов в группу доступности сервера отчетов.

## Управление данными

- **Воспользуйтесь преимуществами репликации данных** с использованием локальной и географической избыточности. Данные в службе хранилища Azure автоматически реплицируются для защиты от потери в случае сбоя инфраструктуры, и некоторые факторы репликации можно настроить. Например, доступные только для чтения копии данных могут реплицироваться в более чем один географический регион (это называется глобально избыточное хранилище с доступом на чтение или RA-GRS). Обратите внимание, что использование RA-GRS влечет за собой дополнительную оплату, см. страницу [Цены на хранилища Azure](https://azure.microsoft.com/pricing/details/storage/) на веб-сайте корпорации Майкрософт, чтобы получить дополнительную информацию.
- **Используйте оптимистичный параллелизм и согласованность в конечном счете** там, где это возможно. Транзакции, которые блокируют доступ к ресурсам из-за блокировки (пессимистичный параллелизм), могут привести к снижению производительности и значительно уменьшить доступность. Эти проблемы могут стать особенно ощутимыми в распределенных системах. Во многих случаях тщательное проектирование и такие методы, как секционирование, могут свести к минимуму вероятность конфликта обновлений. Если данные реплицируются или считывается из отдельно обновляемого хранилища, в конечном счете они будут согласованными, но преимущества обычно заметно перевешивает влияние на доступность из-за использования транзакций для обеспечения мгновенной согласованности.
- **Используйте периодическое резервное копирование и восстановление на определенный момент** и обеспечьте их соответствие цели точки восстановления (RPO). Автоматически и регулярно создавайте резервные копии данных, которые не сохраняются в другом месте, и убедитесь, что можете гарантированно восстановить данные и само приложение в случае сбоя. Репликация данных — это не резервное копирование, так как ошибки и несогласованности из-за сбоев, ошибок или вредоносных операций будут реплицированы во все хранилища. Процесс резервного копирования должен быть безопасным, чтобы обеспечить защиту данных во время передачи и хранения. Базы данных или части хранилища данных обычно восстанавливаются до состояния в более ранний момент времени с помощью журналов транзакций. Microsoft Azure предоставляет функции резервного копирования для данных, хранящихся в базе данных SQL Microsoft Azure. Данные экспортируются в пакет резервных копий в хранилище больших двоичных объектов Microsoft Azure и могут быть скачаны в безопасное локальное расположение для хранения.
- **Включите параметр высокого уровня доступности для обеспечения дополнительной копии кэша Redis.** При использовании кэша Redis выберите вариант Standard, чтобы обеспечить дополнительную копию содержимого. Дополнительную информацию см. на странице [Создание кэша в кэше Redis для Azure](https://msdn.microsoft.com/library/dn690516.aspx) на веб-сайте Майкрософт.

## Ошибки и сбои

- **Введите понятие времени ожидания.** Службы и ресурсы могут стать недоступными, что приводит к сбою запросов. Убедитесь, что применяемые значения времени ожидания подходят как для каждой службы или ресурса, так и для клиента, обращающегося к ним (в некоторых случаях можно разрешить большее время ожидания для конкретного экземпляра клиента, в зависимости от контекста и других действий, выполняемых клиентом). Очень короткое время ожидания может привести к чрезмерному повторению операций со службами и ресурсами, задержка которых значительна, но очень длительное время ожидания может привести к блокировке, когда в очередь поставлено большое количество запросов, ожидающих ответа службы или ресурса.
- **Повторяйте неудачные операции, вызванные временными сбоями.** Разработайте стратегию повторов для доступа ко всем службам и ресурсам там, где они по своей природе не поддерживают автоматический повтор подключения. Используйте стратегию, которая включает в себя интервал между повторными попытками, возрастающий при увеличении количества сбоев. Это предотвратит перегрузку ресурса и позволит корректно восстановить его работоспособность и обработать запросы в очереди. Постоянные повторные попытки с очень короткими задержками могут усугубить проблему.
- **Останавливайте отправку запросов во избежание лавинообразного накопления сбоев**, когда удаленные службы недоступны. Возможны ситуации, когда временные или другие ошибки, различающиеся по степени серьезности от частичной потери подключения до полного сбоя службы, требуют намного больше времени, чем ожидается, для возврата в обычный режим. Кроме того, если служба очень занята, сбой в одной из частей системы может привести к лавинообразному накоплению сбоев и, в свою очередь, блокированию многих операций, удерживающих критические системные ресурсы, например память, потоки и подключения к базе данных. Вместо постоянных попыток повторить операцию, которая, скорее всего, не будет успешно выполнена, приложение должно быстро принять сбой операции и обработать этот сбой. Вы можете использовать шаблон размыкателя, чтобы отклонять запросы для определенных операций в заданные периоды. В статье [Шаблон размыкателя](https://msdn.microsoft.com/library/dn589784.aspx) на веб-сайте Майкрософт приведены дополнительные сведения.
- **Составьте или вернитесь к нескольким компонентам**, чтобы снизить влияние недоступности или отключения определенной службы. Проектируйте приложения таким образом, чтобы использовать преимущества нескольких экземпляров, не влияя на операции и существующие подключения, где это возможно. Используйте несколько экземпляров и распределяйте запросы между ними. Выявляйте неработоспособные экземпляры и не отправляйте запросы к ним. Все это позволит добиться максимальной доступности.
- **Возвращайтесь к другой службе или рабочему процессу**, где это возможно. Например, при сбое записи в базу данных SQL временно сохраните данные в хранилище больших двоичных объектов и предоставьте возможность воспроизвести записи в хранилище больших двоичных объектов в базу данных SQL, когда служба станет доступной. В некоторых случаях у завершенной сбоем операции может быть альтернативное действие, которое позволяет приложению продолжать работать даже при сбое компонента или службы. По возможности выявляйте сбои и перенаправляйте запросы в другие службы, которые могут предложить подходящие альтернативные функциональные возможности, либо в резервные экземпляры или экземпляры с меньшими функциональными возможностями, которые могут обеспечивать основные операции, пока основная служба отключена.

## Мониторинг и аварийное восстановление

- **Предоставьте расширенный инструментарий для обработки возможных сбоев и событий сбоев**, чтобы сообщать о ситуации эксплуатационному персоналу. Для сбоев, которые вероятны, но еще не произошли, предоставьте достаточно данных, чтобы эксплуатационный персонал мог определить причину, уменьшить последствия ситуации и обеспечить доступность системы. Для сбоев, которые уже произошли, приложение должно возвращать соответствующее сообщение об ошибке для пользователя, но при этом пытаться продолжить работу, пусть и с ограниченными функциональными возможностями. Во всех случаях система мониторинга должна записывать всеобъемлющие данные, чтобы эксплуатационный персонал мог быстро восстановить работу приложения, а конструкторы и разработчики при необходимости могли изменить систему для предотвращения подобных ситуаций в будущем.
- **Наблюдайте за работоспособностью системы, реализовав функции проверки.** Работоспособность и производительность приложения могут незаметно снижаться с течением времени, пока не произойдет сбой. Один из способов защититься от этого — реализовать зонды или функции проверки, которые регулярно выполняются извне приложения. Эти проверки могут быть просто измерением времени отклика приложения в целом, отдельных частей приложения, отдельных служб, которые используются приложением, или отдельных компонентов. Функции проверки могут выполнять процессы, чтобы обеспечить получение ими допустимых результатов, измерять задержку и проверять доступность, а также извлекать информацию из системы.
- **Регулярно тестируйте все системы отработки отказа и резервирования**, чтобы убедиться, что они доступны и работают так, как ожидается. Изменения систем и операций могут повлиять на резервные функции и функции отработки отказа, но влияние может быть не обнаружено, пока не произойдет сбой основной системы или она не окажется перегружена. Рекомендуется протестировать это, прежде чем придется расплачиваться за реальную ошибку во время выполнения.
- **Протестируйте системы мониторинга.** Автоматизированные системы отработки отказа и резервирования, а также визуализация работоспособности и производительности системы с использованием панелей мониторинга зависят от того, правильно ли функционируют мониторинг и инструментирование. Если происходит сбой этих элементов, они пропускают важную информацию или сообщают неточные данные, то оператор может и не понять, что система неисправна или сбоит.
- **Отслеживайте ход выполнения длительных рабочих процессов** и повторяйте попытку в случае сбоя. Длительных рабочие процессы часто состоят из нескольких шагов. При проектировании таких типов рабочих процессов убедитесь, что каждый шаг независим и может быть повторен, чтобы свести к минимуму вероятность того, что придется выполнить откат всего рабочего процесса или осуществить несколько компенсирующих транзакций. Отслеживайте ход выполнения длительных рабочих процессов и управляйте им, реализовав шаблон, например супервизор агента планировщика. Дополнительную информацию см. на странице [шаблона супервизора агента планировщика](https://msdn.microsoft.com/library/dn589780.aspx) на веб-сайте Майкрософт.
- **Планируйте аварийное восстановление.** Убедитесь, что у вас есть задокументированный, согласованный и полностью протестированный план восстановления после любого типа сбоя, приводящего к недоступности части или всей основной системы. Регулярно тестируйте процедуры, а также убедитесь, что все сотрудники ознакомлены с процессом.

<!---HONumber=AcomDC_0128_2016-->