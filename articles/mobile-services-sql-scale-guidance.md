<properties linkid="mobile-services-sql-scale-guidance" urlDisplayName="Scale mobile services backed by Azure SQL Database" pageTitle="Scale mobile services backed by Azure SQL Database - Azure Mobile Services" metaKeywords="" description="Learn how to diagnose and fix scalability issues in your mobile services backed by SQL Database" metaCanonical="" services="" documentationCenter="Mobile" title="Scale mobile services backed by Azure SQL Database" authors="yavorg" solutions="" manager="" editor="mollybos" />

<tags ms.service="mobile-services" ms.workload="mobile" ms.tgt_pltfrm="mobile-multiple" ms.devlang="multiple" ms.topic="article" ms.date="01/01/1900" ms.author="yavorg" />

# Масштабирование мобильных служб, поддерживаемых базой данных Azure SQL

Мобильные службы Azure существенно упрощают процесс ознакомления и формирования приложения, которое подключается к облачному серверу, где данные хранятся в базе данных SQL. По мере роста вашего приложения процедура масштабирования ваших экземпляров службы является такой же простой, как и настройка параметров масштабирования на портале для добавления дополнительных вычислительных и сетевых ресурсов. Однако для масштабирования базы данных SQL, поддерживающей вашу службу, требуется выполнить определенное предварительное планирование и мониторинг, так как нагрузка на службу возрастает. В этом документе представлены несколько эффективных методов непрерывного обеспечения высокого уровня производительности мобильных служб, которые поддерживаются с помощью SQL.

В этом разделе рассматриваются следующие основные разделы:

1.  [Диагностирование проблем][Диагностирование проблем]
2.  [Индексация][Индексация]
3.  [Структура схемы][Структура схемы]
4.  [Структура запросов][Структура запросов]
5.  [Архитектура службы][Архитектура службы]
6.  [Расширенный поиск проблем][Расширенный поиск проблем]

<a name="Diagnosing"></a>

## Диагностирование проблем

Если вы предполагаете, что ваша мобильная служба испытывает проблемы под нагрузкой, перейдите сначала на вкладку **Панель мониторинга** для вашей службы на [портале управления Azure][портале управления Azure]. Здесь следует проверить следующее:

-   Ваши измерители использования, включая **вызовы API** и счетчики **активных устройств** не нарушили квоту
-   Состояние **Мониторинг конечной точки** указывает, что служба активна (состояние доступно только в том случае, если служба использует уровень Standard, и мониторинг конечной точки включен)

Если какое-либо из вышеупомянутых условий не соблюдается, попробуйте настроить параметры масштабирования на вкладке *Масштаб*. Если это не устраняет проблему, проанализируйте, может ли база данных Azure SQL быть источником данной проблемы. В следующих разделах рассматриваются несколько разных подходов для диагностики потенциальных проблем.

### Выбор правильного уровня базы данных SQL

Важно понимать различные уровни базы данных, имеющиеся в вашем распоряжении. Это позволит обеспечивать выбор нужного уровня с учетом потребностей вашего приложения. База данных Azure SQL предлагает два разных выпуска базы данных с различными уровнями:

-   Выпуск Web Edition и Business Edition
-   Выпуск Basic, Standard и Premium (в настоящее время в предварительной версии)

Несмотря на то, что выпуски Web Edition и Business Edition полностью поддерживаются, такая поддержка будет полостью прекращена 24 апреля 2015 г., как указано в разделе [Вопросы и ответы по остановке выпусков Web и Business][Вопросы и ответы по остановке выпусков Web и Business]. В преддверии к данному событию мы предлагаем своим новым клиентам начать использовать предварительную версию выпусков Basic, Standard и Premium, если это допускают требования к их приложениям.

#### Выпуск Web Edition и Business Edition

В настоящее время это выпуск по умолчанию, используемый мобильными службами. Ниже указаны некоторые рекомендации по выбору уровня для вашей базы данных:

-   **Свободные 20 МБ в базе данных** - используйте только в целях разработки
-   **Web и Business** - используйте для разработки и производственных служб. Эти два уровня обеспечивают одинаковый уровень производительности, хотя уровень Web поддерживает только базы данных с размером до 5 Гбайт. Для более крупных баз данных используйте уровень Business.

#### Выпуски Basic, Standard и Premium

Этот новый выпуск содержит несколько новых уровней и имеет новые возможности мониторинга, которые еще более упрощают процесс понимания и обеспечения уровня производительности базы данных. Для использования этого выпуска с вашей мобильной службой выполните следующее:

1.  Перейдите на страницу [Функции предварительной версии][Функции предварительной версии] и подпишитесь на **Новые уровни служб для баз данных SQL**
2.  После активации функции предварительной версии запустите [портал управления Azure][портале управления Azure].
3.  Выберите **+NEW** на панели инструментов, а затем **Службы данных**, **База данных SQL**, **Быстрое создание**.
4.  Введите имя базы данных, а затем выберите **Новый сервер базы данных SQL** в поле **Сервер**. Будет создан сервер, который использует новый выпуск Basic, Standard и Premium.
5.  Введите данные в остальные поля и щелкните **Создание базы данных SQL**. Будет создана база данных емкостью 100 МБ, использующая уровень Basic.
6.  Настройка своей мобильной службы для использования только что созданной базы данных

    -   Если вы создаете новую мобильную службу выберите **+NEW**, **Вычислить**, **Мобильная служба**, **Создать**. На следующем экране введите значения, выберите **Использовать существующую базу данных SQL** в поле **База данных**, а затем нажмите **Далее**. На следующем экране выберите базу данных, созданную на шаге 5, а затем нажмите **OK**.
    -   Если у вас уже есть мобильная служба, перейдите на вкладку **Настройка** для этой службы и выберите **Изменение базы данных** на панели инструментов. На следующем экране выберите **Использовать существующую базу данных SQL** в поле **База данных SQL**, и затем нажмите **Далее**. На следующем экране выберите базу данных, созданную на шаге 5, а затем нажмите **OK**.

Ниже приведены несколько рекомендаций по выбору правильного уровня для вашей базы данных:

-   **Basic** - используйте во время разработки или для небольших производственных служб, где в заданный момент времени в базу данных предполагается отправлять одиночный запрос
-   **Standard** - используйте для производственных служб, где предполагается одновременная отправка нескольких запросов в базу данных
-   **Premium** - используйте для крупных производственных служб с большим количеством одновременных запросов, высокой пиковой нагрузкой и ожидаемым малым временем задержки для каждого запроса.

Дополнительные сведения о том, когда следует использовать тот или иной уровень, см. в разделе [Причины применения новых уровней служб][Причины применения новых уровней служб]

### Анализ метрик базы данных

После знакомства с уровнями базы данных можно рассмотреть метрики производительности базы данных, которые помогают выбрать варианты масштабировании в пределах отдельного уровня, а также между уровнями.

1.  Запустите [портал управления Azure][портале управления Azure].
2.  На вкладке «Мобильные службы» выберите службу, с которой вы хотите работать.
3.  Перейдите на вкладку **Настройка**.
4.  Выберите имя **База данных SQL** в разделе **Параметры базы данных**. В результате вы перейдете на вкладку «База данных Azure SQL» на портале.
5.  Перейдите на вкладку **Монитор**
6.  С помощью кнопки **Добавить метрики** добавьте необходимые метрики. Включите следующие метрики:

    -   *Процент ЦП* (доступна только на уровнях Basic/Standard/Premium)
    -   *Процент чтения физических данных* (доступна только на уровнях Basic/Standard/Premium)
    -   *Процент записей в журнал* (доступна только на уровнях Basic/Standard/Premium)
    -   *Хранилище*

7.  Следите за метриками во временном окне, когда ваша служба будет испытывать проблемы.

    ![Портал управления Azure - Метрики базы данных SQL][Портал управления Azure - Метрики базы данных SQL]

Если какая-либо метрика превышает 80%-ый уровень использования в течение длительного периода времени, это может указывать на проблему производительности. Дополнительные сведения об уровнях использования базы данных см. в разделе [Основные сведения об использовании ресурсов][Основные сведения об использовании ресурсов].

Если метрики указывают на высокий уровень использования вашей базы данных, в качестве первой меры уменьшения уровня нагрузки рассмотрите возможность **масштабирования вверх базы данных на более высокий уровень службы**. Для немедленного устранения проблем перейдите на вкладку **Масштаб** для базы данных и масштабируйте вверх базу данных. В результате сумма вашего счета возрастет.
![Портал управления Azure - Масштаб базы данных SQL][Портал управления Azure - Масштаб базы данных SQL]

Как можно скорее рассмотрите следующие дополнительные шаги по уменьшению уровня нагрузки:

-   **Настройте свою базу данных.**
     Благодаря оптимизации базы данных, во многих случаях степень использования базы данных можно уменьшить и предотвратить необходимость масштабирования вверх до более высокого уровня.
-   **Проанализируйте архитектуру своей службы.**
     Часто ваша нагрузка на службу не распределяется равномерно в течение времени, но содержит «всплески» с большим числом запросов. Вместо масштабирования вверх базы данных для обработки таких всплесков, в результате чего в период малого числа запросов нагрузка на базу будет низкой, часто можно настроить архитектуру службы так, чтобы избежать появления таких всплесков, или обрабатывать их без перегрузки базы данных.

В остальных разделах этого документа изложены рекомендации по реализации таких способов уменьшения уровня нагрузки.

### Настройка предупреждений

В качестве профилактической меры для основных метрик базы данных часто полезно настроить предупреждения, чтобы убедиться, чтобы у вас будет достаточно времени для реагирования в случае истощения ресурсов.

1.  Перейдите на вкладку **Мониторинг** для базы данных, для которой вы хотите настроить предупреждения.
2.  Убедитесь, что отображаются соответствующие метрики (см. предыдущий раздел)
3.  Выберите метрику, для которой вы хотите настроить предупреждение, а затем щелкните **Добавить правило**
    ![Портал управления Azure - Предупреждение SQL][Портал управления Azure - Предупреждение SQL]
4.  Введите имя и описание для предупреждения
    ![Портал управления Azure - Имя и описание предупреждения SQL][Портал управления Azure - Имя и описание предупреждения SQL]
5.  Укажите значение, используемое в качестве порога предупреждения. Выберите значение **80%**, чтобы предусмотреть некоторое время на реагирование. Также укажите адрес электронной почты, который вы регулярно проверяете.
    ![Портал управления Azure - Порог предупреждения SQL и адрес электронной почты][Портал управления Azure - Порог предупреждения SQL и адрес электронной почты]

Дополнительный сведения о диагностике проблем SQL см. в разделе [Расширенная диагностика][Расширенная диагностика] ниже в этом документе.

<a name="Indexing"></a>

## Индексация

При обнаружении проблем производительности запросов в первую очередь следует проанализировать структуру своих индексов. Индексы имеют важное значение, так как они непосредственно влияют на способ выполнения запросов ядром SQL.

Например, если вам часто приходится искать элемент в конкретном поле, для этого столбца целесообразно добавить индекс. В противном случае ядро SQL будет принудительно выполнять сканирование таблицы и считывать каждую физическую запись (или, по крайней мере, столбец запроса), и число записей на диске может оказаться довольно большим.

Следовательно, при частом применении операторов WHERE или JOIN в конкретных столбцах необходимо убедиться, что вы их индексируете. Дополнительные сведения см. в разделе [Создание индексов][Создание индексов].

Если индексы настолько хороши, а сканирование таблицы настолько плохое, не означает ли это, что необходимо просто индексировать каждый столбец в таблице? Если ответить коротко, то «вероятно нет». Индексы занимают место и сами создают дополнительную нагрузку: при любой вставке данных в таблицу структуры индекса для каждого из индексированных столбцов необходимо обновлять. Ниже приведены рекомендации по выбору индексов столбцов.

### Рекомендации по структуре индексов

Как указано выше, не всегда целесообразно добавлять большое количество индексов в таблицу, так как сами индексы могут оказаться дорогостоящим инструментом (как с точки зрения производительности, так и с точки зрения расходования памяти).

#### Рекомендации по запросам

-   Добавляйте индексы в столбцы, которые часто используются в предикатах (например, предложения WHERE) и условиях объединения, а также учитывайте рекомендации по базе данных, изложенные ниже.
-   Создавайте запросы, которые вставляют или изменяют максимально возможное число строк в одном операторе, вместо того, чтобы использовать несколько запросов для обновления тех же строк. Если имеется только один оператор, ядро базы данных будет обрабатывать индексы более оптимальным образом.

#### Рекомендации по базе данных

Большое количество индексов в таблице влияет на производительность операторов INSERT, UPDATE, DELETE и MERGE, так как при изменении данных в таблице все индексы необходимо будет соответствующим образом настраивать.

-   Для **активно обновляемых** таблиц старайтесь не индексировать активно обновляемые столбцы.
-   Для таблиц, которые **обновляются редко**, но содержат большой объем данных, используйте много индексов. Это может улучшить производительность запросов, которые не изменяют данные (например, операторы SELECT), так как оптимизатор запросов будет иметь больше возможностей поиска наилучшего метода доступа.

Индексация небольших таблиц может оказаться неоптимальным решением, так как в данном случае оптимизатору запросов при поиске данных может потребоваться больше времени для прохода по индексу, чем простое сканирование таблицы. Следовательно, индексы в небольших таблицах могут никогда не использоваться, но их будет необходимо всегда обрабатывать при изменении данных в таблице.

<a name="CreatingIndexes"></a>

### Создание индексов

#### Сервер JavaScript

Для настройки индекса для столбца на сервере JavaScript выполните следующую процедуру:

1.  Откройте свою мобильную службу на [портале управления Azure][портале управления Azure].
2.  Перейдите на вкладку **Данные**.
3.  Выберите таблицу, которую нужно изменить.
4.  Нажмите вкладку **Столбцы**.
5.  Выберите столбец. В командной строке щелкните **Задать индекс**:

    ![Портал мобильных служб - Задание индекса][Портал мобильных служб - Задание индекса]

В этом представлении также можно удалять индексы.

#### Сервер .NET.

Для определения индекса на платформе Entity Framework используйте атрибут `[Index]` в полях, которые необходимо индексировать. Например:

    public class TodoItem : EntityData
    {
        public string Text { get; set; }

        [Index]
        public bool Complete { get; set; }
    }
         

Дополнительные сведения об индексах см. в разделе [Заметки об индексе на платформе Entity Framework][Заметки об индексе на платформе Entity Framework]. Дополнительные рекомендации по оптимизации индексов см. в разделе [Расширенная индексация][Расширенная индексация] ниже в этом документе.

<a name="Schema"></a>

## Структура схемы

Ниже рассматриваются несколько вопросов, которые следует учитывать при выборе типов данных для своих объектов, что, в свою очередь, влияет на схему базы данных SQL. Настройка схемы может во многих случаях существенно повышать уровень производительности, так как SQL поддерживает настраиваемые оптимизированные способы обработки индексации и хранения для различных( типов данных:

-   **Используйте предоставленный столбец идентификаторов**. Каждая таблица мобильной службы поступает со столбцом идентификаторов по умолчанию, настроенным как первичный ключ, и имеет свой индекс. Дополнительный столбец идентификаторов создавать не нужно.
-   **Используйте корректные типы данных в своей модели.** Если вы знаете, что некоторое свойство вашей модели будет численным или логическим значением, используйте его именно в таком виде в своей модели, а не в виде строки. На сервере JavaScript используйте литералы, например, `true` вместо `"true"` и `5` вместо`"5"`. На сервере .NET используйте типы `int` и `bool` при объявлении свойств своей модели. Это позволит базе данных SQL создать правильную схему для данных типов, что в результате повысит эффективность запросов.

<a name="Query"></a>

## Структура запросов

Ниже приведены несколько рекомендаций, которые следует учитывать при запросе базы данных:

-   **Всегда выполняйте операции объединения в базе данных.** Часто будет необходимо объединять записи из двух или более таблиц, когда объединяемые записи используют совместно общее поле (это также называется *объединением (join)*). Данная операция может оказаться неэффективной, если она выполняется неправильно, так как она может извлекать все объекты из обеих таблиц, а затем выполнять итерации со всеми такими объектами. Операции такого типа лучше всего оставить самой базе данных (иногда может сложиться ошибочное мнение, что их легче выполнять в клиенте или в коде мобильной службы).

    -   Не выполняйте операции объединения в коде своего приложения
    -   Не выполняйте операции объединения в коде своей мобильной службы. При использовании сервера JavaScript убедитесь, что [объект таблицы][объект таблицы] не обрабатывает операции объединения. Используйте непосредственно [объект mssql][объект mssql], чтобы обеспечить выполнение операций объединения в базе данных. Дополнительные сведения см. в разделе [Объединение реляционных таблиц][Объединение реляционных таблиц]. При использовании сервера .NET и выполнении запроса через LINQ объединения автоматически обрабатываются на уровне базы данных платформой Entity Framework.
-   **Реализуйте постраничный просмотр.** Запросы, отправляемые в базу данных, иногда могут приводить к тому, что клиенту будет возвращаться большое количество записей. Для уменьшения размера и времени задержки операций используйте режим постраничного просмотра.

    -   По умолчанию, ваша мобильная служба будет ограничивать все входящие запросы по размеру страницы (до 50), а вручную можно запрашивать до 1000 записей. Дополнительные сведения см. в разделе «Возврат данных на страницах» для [магазина Windows][магазина Windows], [iOS][iOS], [Android][Android], [HTML/JavaScript][HTML/JavaScript] и [Xamarin][Xamarin].
    -   Для запросов, отправляемых из кода вашей мобильной службы, размер страницы, задаваемый по умолчанию, отсутствует. Если ваше приложение не реализует постраничный просмотр, применяйте для своих запросов ограничения по умолчанию (это можно использовать и в качестве профилактической меры). На сервере JavaScript в [объекте запроса][объекте запроса] используйте оператор **take**. При использовании сервера .NET используйте [метод Take][метод Take] как часть своего запроса LINQ.

Дополнительные сведения об улучшении структуры запросов, включая способ анализа планов запроса, см. в разделе [Структура расширенных запросов][Структура расширенных запросов] ниже в этом документе.

<a name="Architecture"></a>

## Архитектура службы

Представьте себе сценарий, когда вы собираетесь отправлять push-уведомление всем своим клиентам для проверки некоторого нового контента в вашем приложении. В случае, когда клиенты отвечают, используя ссылку в уведомлении, будет запускаться приложение. В этом случае может отправляться вызов в вашу мобильную службу и выполняться запрос в вашей базы данных SQL. Так как потенциально миллионы клиентов выполняют данное действие в течение всего нескольких минут, это будет формировать скачок нагрузки на SQL, уровень которой может быть на несколько порядков выше, чем допустимый уровень нагрузки для вашего приложения в устойчивом состоянии. Для устранения такой проблемы можно масштабировать ваше приложение вверх на более высокий уровень SQL во время всплеска, а затем вниз, однако такое решение требует ручного вмешательства и приводит к увеличению затрат. Во многих случаях незначительные тонкие настройки архитектуры вашей мобильной службы могут существенно выравнивать нагрузку, создаваемую клиентами на вашу базу данных SQL, и устранять нежелательные всплески из-за большого числа запросов. Такие изменения можно часто реализовать очень легко при минимальном воздействии на удобство работы ваших клиентов. Ниже приведены некоторые примеры:

-   **Распределение нагрузки по времени.** Если вы контролируете временные параметры определенных событий (например, широковещательную передачу push-уведомлений), которые, предположительно будут создавать всплеск запросов, и временные параметры таких событий не являются критически важными, распределяйте их по времени. В примере выше пользователям вашего приложения, возможно, будет удобно получать уведомления о новом контенте приложения в виде пакетов в течение всего дня, а не практически одновременно. Объединяйте своих клиентов в группы — это позволит обеспечивать поочередную доставку пакетов. В случае использования концентраторов уведомлений можно применять дополнительный тег для отслеживания пакета, а затем отправлять push-уведомление на этот тег — это очень удобный и несложный способ реализации данной стратегии. Дополнительные сведения о тегах см. в разделе [Использование концентраторов уведомлений для отправки экстренных сообщений][Использование концентраторов уведомлений для отправки экстренных сообщений].
-   **Если это возможно, широко используйте хранилище больших двоичных объектов и таблиц.** Во многих случаях контент, который клиенты будут просматривать во время всплеска, является фактически статическим и не подлежит хранению в базе данных SQL, так как маловероятно, что вам будет нужна возможность реляционного запроса данного контента. В таком случае контент рекомендуется хранить в хранилище больших двоичных объектов или таблиц. Доступ к общедоступным большим двоичным объектам в хранилище больших двоичных объектов можно получать непосредственно из устройства. Чтобы получать безопасный доступ к большим двоичным объектам или использовать хранилище таблиц, для защиты своего ключа доступа к хранилищу вам будет нужно проходить через пользовательский интерфейс API мобильных служб. Дополнительные сведения см. в разделе [Загрузка изображений в хранилище Azure с помощью мобильных служб][Загрузка изображений в хранилище Azure с помощью мобильных служб].
-   **Используйте кэш в памяти**. Другим возможным способом хранения данных, который может применяться во время всплесков трафика, является использование кэша в памяти, например, [кэша Azure][кэша Azure]. Это означает, что входящие запросы смогут получать необходимую информацию прямо из памяти, а не постоянно запрашивать ее в базе данных.

<a name="Advanced"></a>

## Расширенный поиск проблем

В этом разделе рассматриваются некоторые расширенные диагностические задачи, которые могут оказаться полезными, если уже выполненные действия не позволили полностью устранить проблему.

### Предварительные требования

Для выполнения некоторых диагностических задач в этом разделе вам будет необходим доступ к средству управления для баз данных SQL, например, **SQL Server Management Studio** или функция управления, встроенная в **портал управления Azure**.

SQL Server Management Studio представляет собой бесплатное приложение Windows, которое предоставляет наиболее широкие возможности. Если у вас нет доступа к компьютеру Windows (например, в случае использования ПК Mac), провизионируйте виртуальную машину в Azure, как показано в разделе [Создание виртуальной машины, на которой выполняется Windows Server][Создание виртуальной машины, на которой выполняется Windows Server], а затем дистанционно подключитесь к ней. Если вы планируете использовать ВМ, прежде всего, для выполнения пакета SQL Server Management Studio, то будет достаточно применить экземпляр **Basic A0** (ранее назывался «Очень мелкий»).

Портал управления Azure содержит встроенные функции управления, которые несколько ограничены по своим возможностям, но доступны без локальной установки.

Следующая процедура позволяет получить информацию о соединении для базы данных SQL, поддерживающей вашу мобильную службу, а затем использовать любой из этих двух инструментов для подключения к ней. Вы можете выбрать любой инструмент.

#### Получение информации о соединении SQL

1.  Запустите [портал управления Azure][портале управления Azure].
2.  На вкладке «Мобильные службы» выберите службу, с которой вы хотите работать.
3.  Перейдите на вкладку **Настройка**.
4.  Выберите имя **База данных SQL** в разделе **Параметры базы данных**. В результате вы перейдете на вкладку «База данных Azure SQL» на портале.
5.  Выберите **Настроить правила брандмауэра Windows Azure для этого IP-адреса**.
6.  Запишите адрес сервера в разделе **Подключение к вашей базе данных**, например: *mcml4otbb9.database.windows.net*.

#### Среда SQL Server Management Studio

1.  Перейдите в раздел [Выпуски SQL Server - Express][Выпуски SQL Server - Express]
2.  Найдите раздел **SQL Server Management Studio** и нажмите кнопку **Загрузка** внизу.
3.  Выполняйте процедуру настройки до тех пор, пока не будет запущено приложение:

    ![Среда SQL Server Management Studio][Среда SQL Server Management Studio]

4.  В диалоговом окне **Подключение к серверу** введите следующие значения:

    -   Имя сервера: *адрес сервера, который вы получили ранее*
    -   Проверка подлинности: *Проверка подлинности SQL Server*
    -   Имя для входа: *имя для входа в систему, которое вы выбрали при создании сервера*
    -   Пароль: *пароль, который вы выбрали при создании сервера*

5.  Теперь соединение должно быть установлено.

#### Портал управления базами данных SQL

1.  На вкладке «База данных Azure SQL» для вашей базы данных нажмите кнопку **Управление**
2.  Настройте соединение со следующими значениями:

    -   Сервер: *должно быть введено предварительно заданное правильное значение*
    -   База данных: *оставьте поле пустым*
    -   Имя пользователя: *имя для входа в систему, которое вы выбрали при создании сервера*
    -   Пароль: *пароль, который вы выбрали при создании сервера*

3.  Теперь соединение должно быть установлено.

    ![Портал управления Azure - база данных SQL][Портал управления Azure - база данных SQL]

<a name="AdvancedDiagnosing"></a>

### Расширенная диагностика

Прямо на **портале управления Azure** можно выполнять много диагностических задач, однако некоторые сложные диагностические задачи можно выполнять только с помощью **SQL Server Management Studio** или на **портале управления базы данных SQL**. Мы будем использовать динамические административные представления, то есть, представления, в которых диагностическая информация о вашей базе данных появляется автоматически. В этом разделе рассматривается несколько запросов, которые можно выполнять в данных представлениях для анализа различных метрик. Дополнительные сведения см. в разделе [Мониторинг базы данных SQL с помощью динамических административных представлений][Мониторинг базы данных SQL с помощью динамических административных представлений].

После выполнения процедуры в предыдущем разделе для подключения к базе данных в SQL Server Management Studio выберите базу данных в **обозревателе объектов**. Для вывода списка административных представлений разверните **Представления**, а затем **Системные представления**. Для выполнения запросов, указанных ниже, щелкните **Новый запрос** после выбора базы данных в **обозревателе объектов**, а затем вставьте запрос и щелкните **Выполнить**.

![SQL Server Management Studio - Динамические административные представления][SQL Server Management Studio - Динамические административные представления]

С другой стороны, если вы используете портал управления базы данных SQL, выберите сначала свою базу данных, а затем щелкните **Новый запрос**.

![Портал управления базы данных SQL - Новый запрос][Портал управления базы данных SQL - Новый запрос]

Для выполнения любого из запросов, указанных ниже, вставьте его в окно и щелкните **Запуск**.

![Портал управления базы данных SQL - Запуск запроса][Портал управления базы данных SQL - Запуск запроса]

#### Расширенные метрики

В случае использования уровней Basic, Standard и Premium портал управления предоставляет несколько готовых метрик. Однако при использовании уровней Web и Business на портале доступна только метрика хранилища. Но, независимо от применяемого уровня, эти и другие метрики можно очень просто получить с помощью административного представления **[sys.resource\_stats][sys.resource\_stats]**. Рассмотрим следующий запрос:

    SELECT TOP 10 * 
    FROM sys.resource_stats 
    WHERE database_name = 'todoitem_db' 
    ORDER BY start_time DESC

> [WACOM.NOTE]
>  Выполните этот запрос в базе данных **master** на своем сервере — в этой базе данных имеется только представление **sys.resource\_stats**.

Результат будет содержать следующие полезные метрики: ЦП (% ограничения для уровня), Хранилище (в мегабайтах), Чтение физических данных (% ограничения для уровня), Записи в журнал (% ограничения для уровня), Память (% ограничения для уровня), Число рабочих процессов, Число сеансов и т. д.

#### События связности SQL

Представление **[sys.event\_log][sys.event\_log]** содержит подробные сведения о событиях, связанных с подключениями.

    select * from sys.event_log 
    where database_name = 'todoitem_db'
    and event_type like 'throttling%'
    order by start_time desc

> [WACOM.NOTE]
>  Выполните этот запрос в базе данных **master** на своем сервере — в этой базе данных имеется только представление **sys.event\_log**.

<a name="AdvancedIndexing"></a>

### Расширенная индексация

Таблица или представление могут содержать следующие типы индексов:

-   **Кластеризованный**. Кластеризованный индекс указывает, как записи физически хранятся на диске. Для таблицы должен иметься только один кластеризованный индекс, так как сами строки данных могут быть отсортированы только в одном порядке.

-   **Некластеризованный**. Некластеризованные индексы хранятся отдельно от строк данных и используются для поиск на основе значения индекса. Все некластеризованные индексы в таблице используют значения ключей из кластеризованного индекса в качестве ключа поиска.

Аналогичный пример из реальной жизни: рассмотрим книгу или техническое описание. Содержимое каждой страницы представляет собой запись, номер страницы — кластеризованный индекс, а индекс разделов в конце книги — некластеризованный индекс. Каждое значение в индексе разделов указывает на кластеризованный индекс, то есть, номер страницы.

> [WACOM.NOTE]
> По умолчанию, сервер JavaScript мобильных служб Azure устанавливает значение **\_createdAt** в качестве кластеризованного индекса. Если вы удаляете этот столбец или хотите иметь другой кластеризованный индекс, выполните [рекомендации по структуре кластеризованного индекса][рекомендации по структуре кластеризованного индекса], указанные ниже. На сервере .NET класс `EntityData` определяет `CreatedAt` в качестве кластеризованного индекса с помощью аннотации `[Index(IsClustered = true)]`.

<a name="ClusteredIndexes"></a>

#### Рекомендации по структуре кластеризованного индекса

Каждая таблица должна иметь кластеризованный индекс в столбце (или столбцах, в случае составного ключа) со следующими свойствами:

-   Narrow - использует малый тип данных или является [составным ключом][составным ключом] небольшого количества узких столбцов
-   Unique или mostly unique (Уникальный или практически уникальный)
-   Static - значение изменяется редко
-   Ever-increasing (Постоянно увеличивающийся)
-   (необязательно) Fixed-width (С фиксированной шириной)
-   (необязательно) nonnull (непустой)

Причина для свойства **narrow** состоит в том, что все другие индексы в таблице используют значения ключей из кластеризованного индекса в качестве ключей поиска. В примере индекса разделов в конце книги кластеризованный индекс представляет собой номер страницы и является небольшим числом. Если бы вместо него в кластеризованный индекс было бы включено название главы, то сам индекс разделов был бы гораздо длиннее, так как значение ключа имело бы следующий вид — название главы, номер страницы.

Ключ должен иметь свойство **static** и **ever-increasing** во избежание обработки физического местоположения записей (это означает либо физическое перемещение записей, либо потенциальную фрагментацию хранилища путем разделения страниц, где хранятся записи).

Кластеризованный индекс будет самым удобным для запросов, выполняющим следующие действия:

-   Возвращать диапазон значений с помощью операторов, например, BETWEEN, \>, \>=, \< и \<=.

    -   После того, как будет найдена строка с первым значением при использовании кластеризованного индекса, строки с последующими индексированными значениями будут гарантированно физически смежными.
-   Использовать предложения JOIN; обычно они представляют собой столбцы внешних ключей.
-   Использовать предложения ORDER BY или GROUP BY.

    -   Индекс в столбцах, указанных в предложении ORDER BY или GROUP BY, может устранить необходимость в сортировке данных для ядра базы данных, так как строки уже отсортированы. Это повышает производительность запросов.

#### Создание кластеризованных индексов на платформе Entity Framework

Для настройки кластеризованного индекса на сервере .NET с помощью платформы Entity Framework настройте свойство `IsClustered` аннотации. Например, это определение атрибута `CreatedAt` в `Microsoft.WindowsAzure.Mobile.Service.EntityData`:

    [Index(IsClustered = true)]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    [TableColumnAttribute(TableColumnType.CreatedAt)]
    public DateTimeOffset? CreatedAt { get; set; }

#### Создание индексов в схеме базы данных

Для сервера JavaScript кластеризованный индекс таблицы можно модифицировать только путем прямого изменения схемы базы данных либо в SQL Server Management Studio, либо на портале базы данных Azure SQL.

В следующих руководствах описывается, как настраивать кластеризованный или некластеризованный индекс путем прямого изменения схемы базы данных:

-   [Создание и изменение ограничений для ПЕРВИЧНОГО КЛЮЧА][Создание и изменение ограничений для ПЕРВИЧНОГО КЛЮЧА]
-   [Создание некластеризованных индексов][Создание некластеризованных индексов]
-   [Создание кластеризованных индексов][Создание кластеризованных индексов]
-   [Создание уникальных индексов][Создание уникальных индексов]

#### Поиск верхних N отсутствующих индексов

SQL-запросы можно создавать в динамических административных представлениях, которые будут содержать более подробные сведения об использовании ресурсов отдельными запросами или эвристические данные о том, какие индексы следует добавить. Следующий запрос определяет, какие 10 отсутствующих индексов будут обеспечивать самое большое ожидаемое совокупное усовершенствование (в порядке убывания) для запросов пользователя.

    SELECT TOP 10 *
    FROM sys.dm_db_missing_index_group_stats
    ORDER BY avg_total_user_cost * avg_user_impact * (user_seeks + user_scans)
    DESC;

Следующий пример запроса выполняет операцию объединения среди этих таблиц с целью получения списка столбцов, которые должны быть частью каждого отсутствующего индекса, и вычисляет 'преимущество индекса', чтобы определить, нужно ли будет принимать во внимание заданный индекс:

    SELECT * from 
    (
        SELECT 
        (user_seeks+user_scans) * avg_total_user_cost * (avg_user_impact * 0.01) AS index_advantage, migs.*
        FROM sys.dm_db_missing_index_group_stats migs
    ) AS migs_adv,
      sys.dm_db_missing_index_groups mig,
      sys.dm_db_missing_index_details mid
    WHERE
      migs_adv.group_handle = mig.index_group_handle and
      mig.index_handle = mid.index_handle
      AND migs_adv.index_advantage > 10
    ORDER BY migs_adv.index_advantage DESC;

Дополнительные сведения см. в разделах [Мониторинг базы данных SQL с помощью динамических административных представлений][Мониторинг базы данных SQL с помощью динамических административных представлений] и [Динамические административные представления отсутствующих индексов][Динамические административные представления отсутствующих индексов].

<a name="AdvancedQuery"></a>

### Усовершенствованная структура запросов

Часто бывает сложно понять, какие запросы являются самыми дорогостоящими для базы данных.

#### Поиск верхних N запросов

В следующем примере возвращаются сведения о пяти первых запросах, отсортированных по среднему времени ЦП. В этом примере выполняется сбор запросов по хэшу запроса, то есть логически схожие запросы группируются по общему потреблению ресурсов.

    SELECT TOP 5 query_stats.query_hash AS "Query Hash", 
        SUM(query_stats.total_worker_time) / SUM(query_stats.execution_count) AS "Avg CPU Time",
        MIN(query_stats.statement_text) AS "Statement Text"
    FROM 
        (SELECT QS.*, 
        SUBSTRING(ST.text, (QS.statement_start_offset/2) + 1,
        ((CASE statement_end_offset 
            WHEN -1 THEN DATALENGTH(st.text)
            ELSE QS.statement_end_offset END 
                - QS.statement_start_offset)/2) + 1) AS statement_text
         FROM sys.dm_exec_query_stats AS QS
         CROSS APPLY sys.dm_exec_sql_text(QS.sql_handle) as ST) as query_stats
    GROUP BY query_stats.query_hash
    ORDER BY 2 DESC;

Дополнительные сведения см. в разделе [Мониторинг базы данных SQL с помощью динамических административных представлений][Мониторинг базы данных SQL с помощью динамических административных представлений]. В дополнение к выполнению запроса **Портал управления базы данных SQL** позволяет увидеть эти данные путем щелчка **Сводка** для базы данных, а затем **Производительность запросов**:

![Портал управления базы данных SQL - производительность запросов][Портал управления базы данных SQL - производительность запросов]

#### Анализ плана запроса

Как только вы определили дорогостоящие запросы или планируете развернуть код с помощью новых запросов и хотели бы проанализировать их производительность, можно воспользоваться специальными средствами, которые позволяют эффективно анализировать **план запроса**. План запроса позволяет увидеть, какие операции занимают основные время ЦП и ресурсы ввода-вывода в ходе выполнения заданного SQL-запроса. Для анализа плана запроса в **SQL Server Management Studio** используйте выделенные кнопки панели инструментов.

![SQL Server Management Studio - план запроса][SQL Server Management Studio - план запроса]

Для анализа плана запроса на **портале управления базы данных SQL** используйте выделенные кнопки панели инструментов.

![Портал управления базы данных SQL - план запроса][Портал управления базы данных SQL - план запроса]

## См. также

-   [Документация по базе данных Azure SQL][Документация по базе данных Azure SQL]
-   [Производительность и масштабирование базы данных Azure SQL][Производительность и масштабирование базы данных Azure SQL]
-   [Устранение неполадок базы данных SQL Azure][Устранение неполадок базы данных SQL Azure]

### Индексация

-   [Основы индексирования][Основы индексирования]
-   [Общие правила проектирования индекса][Общие правила проектирования индекса]
-   [Правила проектирования уникального индекса][Правила проектирования уникального индекса]
-   [Правила проектирования кластеризованного индекса][Правила проектирования кластеризованного индекса]
-   [Ограничения для первичного и внешнего ключей][составным ключом]
-   [Сколько стоит ключ?][Сколько стоит ключ?]

### Entity Framework

-   [Вопросы производительности для платформы Entity Framework 5][Вопросы производительности для платформы Entity Framework 5]
-   [Кодирование аннотаций для первых данных][Кодирование аннотаций для первых данных]

<!-- IMAGES -->
<!-- LINKS -->
<!-- MSDN -->
<!-- EF -->
<!-- BLOG LINKS -->

  [Диагностирование проблем]: #Diagnosing
  [Индексация]: #Indexing
  [Структура схемы]: #Schema
  [Структура запросов]: #Query
  [Архитектура службы]: #Architecture
  [Расширенный поиск проблем]: #Advanced
  [портале управления Azure]: http://manage.windowsazure.com
  [Вопросы и ответы по остановке выпусков Web и Business]: http://msdn.microsoft.com/ru-ru/library/azure/dn741330.aspx
  [Функции предварительной версии]: https://account.windowsazure.com/previewfeatures
  [Причины применения новых уровней служб]: http://msdn.microsoft.com/ru-ru/library/azure/dn369873.aspx#Reasons
  [Портал управления Azure - Метрики базы данных SQL]: ./media/mobile-services-sql-scale-guidance/3.png
  [Основные сведения об использовании ресурсов]: http://msdn.microsoft.com/ru-ru/library/azure/dn369873.aspx#Resource
  [Портал управления Azure - Масштаб базы данных SQL]: ./media/mobile-services-sql-scale-guidance/4.png
  [Портал управления Azure - Предупреждение SQL]: ./media/mobile-services-sql-scale-guidance/5.png
  [Портал управления Azure - Имя и описание предупреждения SQL]: ./media/mobile-services-sql-scale-guidance/6.png
  [Портал управления Azure - Порог предупреждения SQL и адрес электронной почты]: ./media/mobile-services-sql-scale-guidance/7.png
  [Расширенная диагностика]: #AdvancedDiagnosing
  [Создание индексов]: #CreatingIndexes
  [Портал мобильных служб - Задание индекса]: ./media/mobile-services-sql-scale-guidance/set-index-portal-ui.png
  [Заметки об индексе на платформе Entity Framework]: http://msdn.microsoft.com/ru-ru/data/jj591583.aspx#Index
  [Расширенная индексация]: #AdvancedIndexing
  [объект таблицы]: http://msdn.microsoft.com/ru-ru/library/windowsazure/jj554210.aspx
  [объект mssql]: http://msdn.microsoft.com/ru-ru/library/windowsazure/jj554212.aspx
  [Объединение реляционных таблиц]: http://azure.microsoft.com/ru-ru/documentation/articles/mobile-services-how-to-use-server-scripts/#joins
  [магазина Windows]: http://azure.microsoft.com/ru-ru/documentation/articles/mobile-services-windows-dotnet-how-to-use-client-library/#paging
  [iOS]: http://azure.microsoft.com/ru-ru/documentation/articles/mobile-services-ios-how-to-use-client-library/#paging
  [Android]: http://azure.microsoft.com/ru-ru/documentation/articles/mobile-services-android-how-to-use-client-library/#paging
  [HTML/JavaScript]: http://azure.microsoft.com/ru-ru/documentation/articles/mobile-services-html-how-to-use-client-library/#paging
  [Xamarin]: http://azure.microsoft.com/ru-ru/documentation/articles/partner-xamarin-mobile-services-how-to-use-client-library/#paging
  [объекте запроса]: http://msdn.microsoft.com/ru-ru/library/azure/jj613353.aspx
  [метод Take]: http://msdn.microsoft.com/ru-ru/library/vstudio/bb503062(v=vs.110).aspx
  [Структура расширенных запросов]: #AdvancedQuery
  [Использование концентраторов уведомлений для отправки экстренных сообщений]: http://azure.microsoft.com/ru-ru/documentation/articles/notification-hubs-windows-store-dotnet-send-breaking-news/
  [Загрузка изображений в хранилище Azure с помощью мобильных служб]: http://azure.microsoft.com/ru-ru/documentation/articles/mobile-services-dotnet-backend-windows-store-dotnet-upload-data-blob-storage/
  [кэша Azure]: http://azure.microsoft.com/ru-ru/services/cache/
  [Создание виртуальной машины, на которой выполняется Windows Server]: http://azure.microsoft.com/ru-ru/documentation/articles/virtual-machines-windows-tutorial/
  [Выпуски SQL Server - Express]: http://www.microsoft.com/ru-ru/server-cloud/products/sql-server-editions/sql-server-express.aspx
  [Среда SQL Server Management Studio]: ./media/mobile-services-sql-scale-guidance/1.png
  [Портал управления Azure - база данных SQL]: ./media/mobile-services-sql-scale-guidance/2.png
  [Мониторинг базы данных SQL с помощью динамических административных представлений]: http://go.microsoft.com/fwlink/p/?linkid=309725&clcid=0x409
  [SQL Server Management Studio - Динамические административные представления]: ./media/mobile-services-sql-scale-guidance/8.png
  [Портал управления базы данных SQL - Новый запрос]: ./media/mobile-services-sql-scale-guidance/9.png
  [Портал управления базы данных SQL - Запуск запроса]: ./media/mobile-services-sql-scale-guidance/10.png
  [sys.resource\_stats]: http://msdn.microsoft.com/ru-ru/library/dn269979.aspx
  [sys.event\_log]: http://msdn.microsoft.com/ru-ru/library/azure/jj819229.aspx
  [рекомендации по структуре кластеризованного индекса]: #ClusteredIndexes
  [составным ключом]: http://msdn.microsoft.com/ru-ru/library/ms179610(v=sql.120).aspx
  [Создание и изменение ограничений для ПЕРВИЧНОГО КЛЮЧА]: http://technet.microsoft.com/ru-ru/library/ms181043(v=sql.105).aspx
  [Создание некластеризованных индексов]: http://technet.microsoft.com/ru-ru/library/ms189280.aspx
  [Создание кластеризованных индексов]: http://technet.microsoft.com/ru-ru/library/ms186342(v=sql.120).aspx
  [Создание уникальных индексов]: http://technet.microsoft.com/ru-ru/library/ms187019.aspx
  [Динамические административные представления отсутствующих индексов]: sys-missing-index-stats
  [Портал управления базы данных SQL - производительность запросов]: ./media/mobile-services-sql-scale-guidance/11.png
  [SQL Server Management Studio - план запроса]: ./media/mobile-services-sql-scale-guidance/12.png
  [Портал управления базы данных SQL - план запроса]: ./media/mobile-services-sql-scale-guidance/13.png
  [Документация по базе данных Azure SQL]: http://azure.microsoft.com/ru-ru/documentation/services/sql-database/
  [Производительность и масштабирование базы данных Azure SQL]: http://go.microsoft.com/fwlink/p/?linkid=397217&clcid=0x409
  [Устранение неполадок базы данных SQL Azure]: http://msdn.microsoft.com/ru-ru/library/azure/ee730906.aspx
  [Основы индексирования]: http://technet.microsoft.com/ru-ru/library/ms190457(v=sql.105).aspx
  [Общие правила проектирования индекса]: http://technet.microsoft.com/ru-ru/library/ms191195(v=sql.105).aspx
  [Правила проектирования уникального индекса]: http://technet.microsoft.com/ru-ru/library/ms187019(v=sql.105).aspx
  [Правила проектирования кластеризованного индекса]: http://technet.microsoft.com/ru-ru/library/ms190639(v=sql.105).aspx
  [Сколько стоит ключ?]: http://www.sqlskills.com/blogs/kimberly/how-much-does-that-key-cost-plus-sp_helpindex9/
  [Вопросы производительности для платформы Entity Framework 5]: http://msdn.microsoft.com/ru-ru/data/hh949853
  [Кодирование аннотаций для первых данных]: http://msdn.microsoft.com/ru-ru/data/jj591583.aspx
