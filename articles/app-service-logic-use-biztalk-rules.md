<properties 
   pageTitle="Использование правил BizTalk" 
   description="В этой статье описываются функции правил BizTalk и предоставляются инструкции по их использованию." 
   services="app-service\logic" 
   documentationCenter=".net,nodejs,java" 
   authors="anuragdalmia" 
   manager="dwrede" 
   editor=""/>

<tags
   ms.service="app-service-logic"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="integration" 
   ms.date="02/27/2015"
   ms.author="andalmia"/>

#Использование правил BizTalk 

Бизнес-правила инкапсулируют политики и решения, которые управляют бизнес-процессами. Эти политики могут формально определяться в процедурных руководствах, контрактах или могут существовать в виде знаний и профессионального опыта сотрудников. Эти политики являются динамическими и с течением времени могут изменяться в результате изменений бизнес-планов, нормативов или по другим причинам.

Для реализации этих политик на традиционных языках программирования требуется значительное время и координация. Кроме того, в создании и обслуживании бизнес-политик не принимают участие сотрудники, не являющиеся программистами. Бизнес-правила BizTalk предоставляют способ быстрой реализации этих политик и отделения остальной части бизнес-процессов. Это позволяет вносить необходимые изменения в бизнес-политики без влияния на остальные части бизнес-процесса.

##Причины использования правил

Существует 3 основные причины использования бизнес-правил BizTalk в бизнес-процессах:

* отделение бизнес-логики от кода приложения;
- предоставление бизнес-аналитикам большей степени контроля над управлением бизнес-логикой;
+ более быстрая реализация изменений бизнес-логики в рабочей среде.

###Основные понятия правил

##Словарь

Термины, используемые для определения условий и действий правил, обычно выражаются в доменной или отраслевой номенклатуре. Например, пользователь электронной почты записывает правила в терминах "сообщения, полученные от" и "сообщения, полученные после", а бизнес-аналитик в области страхования записывает правила в терминах "факторы риска" и "сумма покрытия".
В основе этой доменной терминологии лежат технологические артефакты (объекты, таблицы базы данных и XML-документы), которые реализуют условия и действия правил. Словари предназначены для устранения разрыва между бизнес-семантикой и реализацией.

Например, привязка данных для статуса утверждения может указывать на определенный столбец в определенной строке в определенной базе данных, что представляется в виде SQL-запроса. Вместо того чтобы вставлять в правило такого рода сложное представление, можно создать словарное определение, связанное с такой привязкой данных, с понятным именем "Состояние". Далее можно включать "Состояние" в любое количество правил, и обработчик правил будет извлекать соответствующие данные из таблицы.
_Словарь_ - это набор определений, состоящий из понятных имен для вычислительных объектов, используемых в условиях и действиях правил. Словарные определения облегчают чтение, понимание и совместное использование правил пользователями в конкретной бизнес-сфере.

##Правило

Бизнес-правила представляют собой декларативные операторы, управляющие поведением бизнес-процессов. Правило состоит из условия и действий. Условие проверяется, и, если оно оценивается как истинное (true), обработчик правил инициирует одно или несколько действий.
Правила в инфраструктуре бизнес-правил задаются в следующем формате:

_IF_ _условие_ _THEN_ _действие_

Рассмотрим следующий пример.

*IF сумма меньше или равна доступным средствам*  
*THEN провести транзакцию и распечатать квитанцию*

Это правило определяет, будет ли проводиться транзакция, путем применения бизнес-логики в виде сравнения двух денежных значений - суммы транзакции и доступных средств.
Вы можете использовать бизнес-правило для создания, изменения и развертывания бизнес-правил. Вы также можете выполнять указанные выше задачи программными средствами.

###Условия

Условие - это логическое выражение, имеющее значение true или false, которое состоит из одного или нескольких предикатов.
В нашем примере предикат "меньше или равно" применяется к сумме и доступным средствам. Такое условие всегда будет оцениваться как истинное (true) или ложное (false).
Предикаты можно объединять с помощью логических операторов AND, OR и NOT, чтобы формировать логическое выражение, которое может быть довольно большим, но всегда будет оцениваться как истинное или ложное.

###Действия

Действия - это функциональные последствия оценки условия. Если условие правила удовлетворяется, инициируется соответствующее действие (или действия).
В нашем примере "провести транзакцию" и "распечатать квитанцию" - это действия, которые выполняются тогда и только тогда, когда условие (в данном случае "IF сумма меньше или равна доступным средствам") является истинным (true).
Действия в инфраструктуре бизнес-правил представляются путем выполнения операций SET в XML-документах.

##Политика

Политика - это логическая группа правил. Вы создаете политику, сохраняете ее, выполняете тестирование и, когда результат вас устроит, используете ее в рабочей среде.

###Создание политики

Политики можно создать на портале правил. Политика может содержать сколь угодно большой набор правил, но обычно политика составляется из правил, относящихся к конкретной бизнес-сфере в контексте приложения, которое будет использовать политику.

###Тестирование политики
Вы можете эффективно выполнять тестовые запуски политики, прежде чем использовать ее в рабочей среде. На портале правил можно предоставить входные данные для политики, запустить ее и просмотреть ее выходные данные. Выходные данные включают журналы, выполнение правил, оценку условий и итоговые результаты.

##Простой сценарий - требование о выплате страхового возмещения
Давайте возьмем простой сценарий и пройдем по шагам создания бизнес-логики для этого сценария.

![Alt text][1]

В очень простом сценарии требования о выплате страхового возмещения заявитель подает свое требование о выплате (посредством любого клиента, например через веб-сайт, телефонное приложение и т. п.). Этот запрос требования отправляется в блок обработки требований, и, в зависимости от результата обработки, данное требование может быть утверждено, отклонено или передано для дальнейшей обработки вручную.
Блок обработки требований в нашем сценарии будет включать бизнес-логику для системы. Если мы более пристально рассмотрим этот блок, то можем увидеть следующее.

![Alt text][2]
 
Теперь давайте реализуем эту бизнес-логику с помощью бизнес-правил.


##Создание приложения API правил
1.	Войдите на портал Azure и откройте домашнюю страницу. 
2.	Последовательно выберите в меню Создать -> Marketplace -> Приложения API -> Правила Biz Talk -> Создать
 
![Alt text][3]

3.	В новой открывшейся колонке введите следующие сведения.  
	1. Имя - дайте имя вашему приложению API правил.
	1. План размещения приложения - выберите или создайте план веб-хостинга.
	1. Ценовая категория - выберите ценовую категорию для этого приложения.
	1. Группа ресурсов - выберите или создайте группу ресурсов, в которой должно находиться это приложение.
	1. Расположение - укажите географическое расположение, где планируется развернуть это приложение.
4.	Нажмите кнопку "Создать". В течение нескольких минут ваше приложение API правил BizTalk будет создано.

##Создание словаря
Следующим шагом после создания приложения API правил BizTalk является создание словарей. Предполагается, что это упражнение чаще всего будут выполнять разработчики. Для этого выполните следующие действия.
1.	Перейдите к созданному приложению API, последовательно выбрав в меню пункты Обзор -> Приложения API -> <Ваше приложение API правил>. Должна открыться панель мониторинга приложения API правил, аналогичная приведенной ниже.
 
![Alt text][4]

2.	Выберите компонент "Определения словаря". Откроется экран создания словаря. Нажмите кнопку "Добавить", чтобы приступить к добавлению новых определений словаря.
В настоящее время поддерживается два типа определений словаря - литеральное и XML.

##Литеральное определение
1.	После нажатия кнопки "Добавить" открывается новая колонка добавления определения. Введите следующие значения.
  1.	Имя - только буквы и цифры, без специальных символов. Это имя также должно быть уникальным в рамках существующего списка определений словаря.
  2.	Описание - необязательное поле.
  3.	Тип - поддерживается два типа. В данном примере выберите литеральный тип.
  4.	Тип ввода - пользователи могут выбрать тип данных определения. В настоящее время можно выбрать 4 типа данных.
    i.	String - это строковые значения, которые должны вводиться в двойных кавычках ("Пример строки").  
    ii.	Boolean - логическое значение, true или false.  
    iii.	Number - любое десятичное число.  
    iv.	DateTime - означает, что определение имеет тип даты. Даты должны вводиться в формате "мм/дд/гггг чч:мм:сс AM\PM".  
    v.	Ввод - в этом поле вводится значение определения. Значения, которые здесь вводятся, должны соответствовать выбранному типу данных. Пользователь может вводить одно значение, набор значений, разделенных запятыми, или диапазон значений с помощью ключевого слова to. Например, пользователь может ввести единственное значение 1; набор значений 1, 2, 3; диапазон значений 1 to 5. Обратите внимание, что диапазон поддерживается только для чисел.

##XML-определение
1.	Если в качестве типа словаря выбран XML, необходимо указать следующие входные данные.  
  a.	Схема - если щелкнуть это свойство, откроется новая колонка, в которой пользователь может выбрать одну из списка уже отправленных схем или отправить новую схему.   
  b.	XPATH - это свойство разблокируется только после выбора схемы на предыдущем шаге. Если его щелкнуть, откроется выбранная схема, и пользователь может выбрать в ней узел, для которого требуется создать определение словаря.  
  c.	ФАКТ - это свойство определяет, какие объекты данных должны загружаться в обработчик правил для обработки. Это дополнительное свойство, и по умолчанию в нем устанавливается родительский объект выбранного XPATH. Свойство ФАКТ имеет особенно важное значение в сценариях с использованием цепочки и коллекции.

### Массовое добавление
Приведенные выше действия охватывают взаимодействие по созданию определений словаря. После создания определения словаря отображаются в форме списка. Иногда требуется создать сразу несколько определений из одной схемы вместо того, чтобы повторять указанные выше действия по одному. В этом случае очень удобно использовать возможность массового добавления. 
При нажатии кнопки "Массовое добавление" открывается новая колонка. Сначала нужно выбрать схему, для которой требуется создать несколько определений. При нажатии этого свойства открывается новая колонка, в которой пользователь может выбрать схему в списке уже отправленных схем или отправить новую схему.
Теперь разблокируется свойство XPATHS. При нажатии этого свойства откроется просмотр схемы, где можно выбрать несколько узлов.
В качестве имен нескольких определений, которые создаются одновременно, по умолчанию устанавливаются имена выбранных узлов. Эти имена можно изменить в любое время после создания.

##Создание политики
Предполагается, что после того как разработчик создаст необходимые словари, бизнес-аналитик будет создавать бизнес-политики на портале Azure.  
	1.	В созданном приложении правил имеется компонент "Политика", щелкнув который, пользователь переходит на страницу создания политики.  
	2.	На этой странице отображается список политик, имеющихся в данном конкретном приложении правил. Пользователь может добавить новую политику, просто введя имя политики и перейдя на вкладку. В одном приложении API правил может находиться несколько политик.  
	3.	Если пользователь щелкает созданную политику, открывается страница сведений о политике, где отображаются правила, существующие в этой политике.  
	4.	Чтобы добавить новое правило, нажмите кнопку "Добавить". Откроется новая колонка.

##Создание правила
Правило - это набор инструкций условия и действий. Действия выполняются, если условие оценивается как истинное (true). В колонке создания правила задайте уникальное имя правила (для этой политики) и описание (необязательно).
Для создания сложных условных операторов можно использовать поле "Условие". Далее приводится список поддерживаемых ключевых слов.  
1. 	And (И) - условный оператор  
2. 	Or (ИЛИ) - условный оператор  
3. 	does\_not\_exist (не существует)  
4. 	exists (существует)  
5. 	нет  
6. 	is\_equal\_to (равно)  
7. 	is\_greater\_than (больше)  
8. 	is\_greater\_than\_equal\_to (больше или равно)  
9. 	is\_in (в)  
10. is\_less\_than (меньше)  
11. is\_less\_than\_equal\_to (меньше или равно)  
12. is\_not\_in (нет в)  
13. is\_not\_equal\_to (не равно)  
14. mod (модуль)  
15. true  

Поле действий (Then) может содержать несколько инструкций, по одной в строке, для создания действий, которые должны выполняться. Далее приводится список поддерживаемых ключевых слов.  
1.	equals (равно)  
2.	нет  
3.	true  
4.	halt  
5.	mod (модуль)  
6.	null  
7.	update (обновить)  

Поля условия и действий предоставляют технологию Intellisense, чтобы помочь пользователю быстро создать правило. Ее можно вызвать, нажав сочетание клавиш CTRL + ПРОБЕЛ или просто начав ввод. Будут автоматически отфильтровываться и показываться ключевые слова, соответствующие введенным символам. Окно Intellisense будет показывать все ключевые слова и определения словаря.

##Явное прямое построение цепочки
Правила BizTalk поддерживают явное прямое построение цепочки. Это означает, что если пользователям требуется повторно оценить правила в ответ на определенные действия, они могут вызвать это с помощью определенных ключевых слов. Поддерживаются следующие ключевые слова.  
   1.	Update <определение словаря> - это ключевое слово выполняет переоценку всех правил, использующих в своих условиях указанное определение словаря.  
   2.	Halt - это ключевое слово останавливает все выполнения правил.

##Включение и отключение правил
Каждое правило в политике можно включать или отключать. По умолчанию все правила включены. Отключенные правила не выполняются во время выполнения политики. Включать и отключать правила можно либо непосредственно в колонке правила, используя команды в панели команд вверху колонки, либо из политики, используя пункт включения или отключения в контекстном меню (открывающемся при щелчке правила правой кнопкой мыши).

##Приоритет правил
Все правила политики выполняются по порядку. Приоритет выполнения определяется порядком, в котором правила расположены в политике. Этот приоритет можно изменить, просто перетащив правило. 

##Тестирование политики
После создания политики и перед ее использованием в рабочей среде можно подготовить тестирование этой политики. С помощью команды "Проверить политику" пользователи могут перейти в колонку тестирования политики. В этой колонке отображается список используемых в политике определений словаря, для которых требуется ввод данных пользователем. Пользователи могут вручную добавить значения этих входных данных для своих сценариев тестирования. Кроме того, пользователи могут импортировать тестовые XML-данные для входных данных. После ввода всех входных данных можно запустить тестирование, и выходные данные для каждого определения словаря будут отображены в выходном столбце для удобного сравнения. Чтобы просмотреть журналы, понятные бизнес-аналитику, нажмите "Просмотреть журналы", чтобы вывести журналы выполнения. Чтобы сохранить журналы, нажмите "Сохранить выходные данные", и все связанные с тестированием данные будут сохранены для независимого анализа.

## Использование правил в приложениях логики
После создания и тестирования политики она готова к использованию. Пользователи могут создать новое приложение логики, последовательно выбрав в меню Создать -> Приложение логики. В конструкторе правила BizTalk доступны в коллекции справа. Их можно перетаскивать на поверхность конструктора. После этого появляется возможность выбрать целевое приложение API правил. Затем становится доступным список политик, которые можно настраивать. Выберите конкретную политику, после чего нужно ввести входные данные, необходимые для этой политики. Можно использовать выходные данные приложения API правил для дальнейшего принятия решений.

## Использование правил с помощью API
Приложение API правил можно также вызывать с помощью широкого набора доступных API. Таким образом, пользователи не ограничиваются только потоком и могут использовать правила в любом приложении, выполняя вызовы REST.

## Изменение словаря и политики
Одно из основных преимуществ использования бизнес-правил заключается в том, что изменения бизнес-логики можно реализовать в рабочей среде гораздо быстрее. Все изменения словаря и политик немедленно применяются в рабочей среде. Пользователю просто нужно перейти в соответствующее определение словаря или в политику и внести нужные изменения, чтобы привести их в действие.

<!--Image references-->
[1]: ./media/biztalk-rules-deploy-create-manage/InsuranceScenario.PNG	
[2]: ./media/biztalk-rules-deploy-create-manage/InsuranceBusinessLogic.png
[3]: ./media/biztalk-rules-deploy-create-manage/RulesDocImg3.png
[4]: ./media/biztalk-rules-deploy-create-manage/RulesDocImg4.png


<!--HONumber=49-->