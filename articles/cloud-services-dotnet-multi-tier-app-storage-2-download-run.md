<properties linkid="develop-net-tutorials-multi-tier-web-site-2-download-and-run" pageTitle="Azure Cloud Service Tutorial: ASP.NET MVC Web Role, Worker Role, Azure Storage Tables, Queues, and Blobs" metaKeywords="Azure tutorial, Azure storage tutorial, Azure multi-tier tutorial, MVC Web Role tutorial, Azure worker role tutorial, Azure blobs tutorial, Azure tables tutorial, Azure queues tutorial" description="Learn how to create a multi-tier app using ASP.NET MVC and Azure. The app runs in a cloud service, with web role and worker roles, and uses Azure storage tables, queues, and blobs." metaCanonical="" services="cloud-services,storage" documentationCenter=".NET" title="Azure Cloud Service Tutorial: ASP.NET MVC Web Role, Worker Role, Azure Storage Tables, Queues, and Blobs" authors="riande,tdykstra" solutions="" manager="wpickett" editor="mollybos" />

<tags ms.service="cloud-services" ms.workload="web" ms.tgt_pltfrm="na" ms.devlang="dotnet" ms.topic="article" ms.date="01/01/1900" ms.author="riande,tdykstra" />

# Настройка и развертывание приложения службы электронной почты Azure — 2 из 5

Это второй из пяти учебников в серии. В нем показано, как построить и развернуть образец приложения службы электронной почты Azure. Сведения о приложении и самой серии учебников см. в [первом учебнике серии][первом учебнике серии].

В этом учебнике вы узнаете следующее:

-   Как настроить компьютер для разработки в Azure с помощью пакета Azure SDK.
-   Как настроить и протестировать приложение службы электронной почты Azure на локальном компьютере.
-   Как опубликовать приложение в Azure.
-   Как просмотреть и изменить таблицы, очереди и BLOB-объекты Azure с помощью обозревателя серверов Visual Studio.
-   Как настроить трассировку и просматривать данные трассировки.
-   Как масштабировать приложение, увеличивая число экземпляров рабочих ролей.

### Сегменты учебника

-   [Настройка среды разработки][Настройка среды разработки]
-   [Загрузка и запуск готового решения][Загрузка и запуск готового решения]
-   Просмотр хранилища разработки в Visual Studio
-   [Создание учетной записи хранения Azure][Создание учетной записи хранения Azure]
-   [Создание облачной службы][Создание облачной службы]
-   [Настройка приложения для доступа к хранилищу Azure][Настройка приложения для доступа к хранилищу Azure]
-   [Настройка приложения для использования SendGrid][Настройка приложения для использования SendGrid]
-   [Развертывание приложения в Azure][Развертывание приложения в Azure]
-   [Продвижение приложения из промежуточной среды в рабочую][Продвижение приложения из промежуточной среды в рабочую]
-   [Настройка трассировки и просмотр данных трассировки][Настройка трассировки и просмотр данных трассировки]
-   [Добавление еще одного экземпляра рабочей роли для обработки повышенной нагрузки][Добавление еще одного экземпляра рабочей роли для обработки повышенной нагрузки]

[WACOM.INCLUDE [установка-sdk-2013-только](../includes/install-sdk-2013-only.md)]

## <a name="downloadcnfg"></a><span class="short-header">Загрузка и запуск</span>Загрузка и запуск готового решения

1.  Загрузите и распакуйте [готовое решение][готовое решение].

2.  Запустите Visual Studio.

3.  В меню **Файл** выберите **Открыть проект**, перейти к папке, куда вы загрузили решение, а затем откройте файл решения.

4.  Чтобы построить решение, нажмите CTRL+SHIFT+B.

    По умолчанию Visual Studio автоматически запускает содержимое пакета NuGet, которое не включено в файл *.zip* Если пакеты не восстановлены, установите их вручную, перейдя к диалогу **Управление пакетами для NuGet решения** и нажав кнопку **Восстановить** вверху справа.

5.  В **обозревателя решений** убедитесь, что **AzureEmailService** выбран в качестве запускаемого проекта.

6.  Для запуска приложения нажмите сочетание клавиш CTRL+F5.

    Домашняя страница приложения открывается в браузере.

7.  Щелкните **Списки адресов** в строке меню.

    (Экран показывает стиль веб-страницы из шаблона проекта Visual Studio 2012, но содержимое в Visual Studio 2013 то же самое.)

    ![Запустите приложение.][Запустите приложение.]

8.  Щелкните **Создать**.

9.  Введите некоторые тестовые данные и нажмите кнопку **Создать**.

    ![Запустите приложение.][1]

10. Создайте еще пару элементов списка рассылки.

    ![Страница индексов списков рассылки][Страница индексов списков рассылки]

11. Нажмите кнопку **Подписчики**, а затем добавьте нескольких подписчиков. Установите для параметра **Проверено** значение `true`.

    ![Страница индексов подписчиков][Страница индексов подписчиков]

12. Подготовьтесь к добавлению сообщений путем создания файла *TXT*, который содержит текст отправляемого сообщения электронной почты. Затем создайте файл *HTM*, который содержит тот же текст, но с некоторым количеством HTML-кода (например, выделите одно из слов в сообщении полужирным шрифтом или курсивом). Эти файлы потребуются вам на следующем шаге.

13. Нажмите кнопку **Сообщения**, а затем добавьте несколько сообщений. Выберите файлы, созданные на предыдущем шаге. Не изменяйте запланированную дату, которая по умолчанию перенесена на одну неделю в будущее. Приложение не может отправлять сообщения, пока не настроен компонент SendGrid.

    ![Страница создания сообщения][Страница создания сообщения]

    ![Страница индексов сообщений][Страница индексов сообщений]

    Вводимые и просматриваемые вами данные управляются эмулятором хранилища Azure. Эмулятор хранилища использует базу данных SQL Server Express LocalDB для эмуляции работы хранилища Azure в облаке. В приложении используется эмулятор хранения, поскольку именно так был настроен проект во время его загрузки. Этот параметр хранится в файлах *CSCFG* проекта **AzureEmailService**. Файл *ServiceConfiguration.Local.cscfg* определяет, что именно используется при локальном запуске приложения в Visual Studio, а файл *ServiceConfiguration.Cloud.cscfg* определяет, что используется при развертывании приложения в облаке. Позже вы узнаете, как настроить приложение на использование созданной ранее учетной записи хранилища Azure.

14. Закройте браузер.

## <a name="StorageExpVS"></a>Просмотр хранилища разработки в Visual Studio

Обозреватель **Хранилище Azure** в **обозревателе серверов** обеспечивает удобную работу напрямую с ресурсами хранилища Azure.

1.  В меню **Вид** Visual Studio выберите элемент **Обозреватель серверов**.

2.  Разверните узел **Azure**, затем узел **Хранилище** и затем разверните узел **(Разработка)** под узлом **Хранилище Azure**.

    Если регистрация в Azure в Visual Studio еще не проведена, то появится запрос на учетные данные Azure. Введите учетные данные для учетной записи подписки, с которой необходимо запустить облачную службу.

3.  Разверните узел **Таблицы** для просмотра таблиц, созданных на предыдущих шагах.

    ![Обозреватель серверов][Обозреватель серверов]

4.  Дважды щелкните таблицу **MailingList**.

    ![Обозреватель хранилищ VS][Обозреватель хранилищ VS]

    Обратите внимание, как окно показывает разные схемы в таблице. Сущности `MailingList` имеют свойство `Description` и `FromEmailAddress`, а сущности `Subscriber` имеют свойство `Verified` (плюс `SubscriberGUID`, которое не показано, поскольку изображение недостаточно широкое). Таблица содержит столбцы для всех свойств, и если конкретная строка таблицы предназначена для сущности, не имеющей заданного свойства, эта ячейка будет пуста.

Другой инструмент, который можно использовать для работы с ресурсами хранилища Azure, — это [проводник хранилища Azure][проводник хранилища Azure].

## <a name="createWASA"></a>Создайте учетную запись хранения Azure

При выполнении примера приложения в Visual Studio можно получить доступ к таблицам, очередям и BLOB-объектам в эмуляторе хранения Azure или в учетной записи хранилища Azure в облаке. Этот раздел учебника посвящен созданию учетной записи хранения Azure, которую вы настроите для дальнейшего использования Visual Studio в данном учебнике.

1.  Откройте в браузере [портал управления Azure][портал управления Azure].

2.  На [портале управления Azure][портал управления Azure] щелкните элемент **Хранилище** и нажмите кнопку **Создать**.

![Новое хранилище][Новое хранилище]

1.  Щелкните **Быстрое создание**.

![Быстрое создание][Быстрое создание]

1.  В поле ввода URL-адреса введите префикс URL-адреса.

    Этот префикс в сочетании с текстом, который отображается под полем, будет уникальным URL-адресом для вашей учетной записи хранения. Если введенный префикс уже используется другим пользователем, вы увидите над полем сообщение "Имя хранилища уже используется", и вам придется выбрать другой префикс.

2.  Задайте область, в которой требуется развернуть приложение.

3.  В раскрывающемся списке **Репликация** установите значение **Локально избыточное**.

    При включении георепликации для учетной записи хранения хранящиеся данные реплицируются в дополнительное расположение для обеспечения возможности отработки отказа в это расположение в случае крупной аварии в основном расположении. Георепликация может потребовать дополнительных затрат. Для учетных записей тестирования и разработки оплачивать георепликацию обычно не требуется. Дополнительные сведения см. в разделе [Управление учетными записями хранения][Управление учетными записями хранения].

4.  Щелкните **Создать учетную запись хранения**.

    На следующем рисунке показано создание учетной записи хранилища с URL-адресом `aestest3.core.windows.net`.

    ![Создание хранилища с префиксом URL-адреса][Создание хранилища с префиксом URL-адреса]

    Выполнение этого шага может занять несколько минут. Во время ожидания вы можете повторить эти шаги и создать рабочую учетную запись хранения. Часто удобно иметь тестовую учетную запись хранения для локальной разработки, еще одну учетную запись хранения для тестирования в Azure, а также рабочую учетную запись хранения.

5.  Выберите тестовую учетную запись, созданную на предыдущем шаге, а затем щелкните значок **Управления ключами доступа**.

    ![Управление ключами][Управление ключами]

    ![Ключи GUID][Ключи GUID]

    Visual Studio автоматически настроит строки подключения с одним из этих ключей, когда учетная запись хранилища будет выбрана. Можно обновить строки подключения вручную.

    Существует два ключа, чтобы можно было периодически изменять используемый ключ без перерывов в обслуживании для реального приложения. Вы повторно создаете ключ, который не используете, а затем можете изменить строку подключения в приложении, чтобы использовать повторно созданный ключ. В случае наличия всего одного ключа при повторном создании ключа приложения потеряет подключение к учетной записи хранения. Приведенные на изображении ключи недействительны, поскольку они были созданы повторно после записи изображения.

## <a name="createcloudsvc"></a><span class="short-header">Создание облачной службы</span>Создание облачной службы

1.  На [портале управления Azure][портал управления Azure] щелкните элемент **Облачные службы** и нажмите кнопку **Создать**.

    ![Быстрое создание облака][Быстрое создание облака]

2.  Щелкните **Быстрое создание**.

3.  В поле ввода URL-адреса введите префикс URL-адреса.

    Как и URL-адрес хранилища, этот URL-адрес должен быть уникальным, и вы получите сообщение об ошибке, если выбранный префикс уже используется другим пользователем.

4.  Задайте область, в которой требуется развернуть приложение.

    Облачную службу следует создавать в той же области, где вы создали учетную запись хранения. Когда облачная служба и учетная запись хранения находятся в разных центрах обработки данных (различных областях), увеличивается задержка и вам потребуется оплачивать пропускную способность за пределами центра обработки данных. Пропускная способность в рамках центра обработки данных предоставляется бесплатно.

    Территориальные группы Azure обеспечивают механизм для минимизации расстояния между ресурсами в центре обработки данных, что позволяет уменьшить задержку. В этом учебнике территориальные группы не используются. Дополнительные сведения см. в разделе [Создание территориальной группы в Azure][Создание территориальной группы в Azure].

5.  Выберите **Создать облачную службу**.

    На следующем рисунке облачная служба создается с использованием URL-адреса aescloud.cloudapp.net.

    ![Создание хранилища с префиксом URL-адреса][2]

## <a name="conf4azureStorage"></a><span class="short-header">Использование учетной записи хранилища</span>Настройка приложения на использование учетной записи хранилища Azure

Далее вы узнаете, как настроить приложение таким образом, чтобы при запуске в Visual Studio оно использовало вашу учетную запись хранения Azure, а не хранилище разработки.

1.  В **обозревателе решений** щелкните правой кнопкой мыши элемент **MvcWebRole** в области **Роли** проекта **AzureEmailService**, а затем выберите пункт **Свойства**.

    ![Щелкните элемент "Свойства" правой кнопкой мыши][Щелкните элемент "Свойства" правой кнопкой мыши]

2.  В окне **MvcWebRole [Role]** откройте вкладку **Настройки**.

3.  В раскрывающемся списке **Конфигурация службы** выберите значение **Локально**.

4.  Выберите запись **StorageConnectionString**, и вы увидите кнопку с многоточием (**...**) в правом конце строки. Нажмите эту кнопку с многоточием, чтобы открыть диалоговое окно **Строка подключения учетной записи хранения**.

    ![Щелкните элемент "Свойства" правой кнопкой мыши][3]

5.  В диалоговом окне **Создать строку подключения хранилища**, щелкните **Ваша подписка** и затем выберите **Подписка** и **Имя учетной записи** хранилища.

    ![Щелкните элемент "Свойства" правой кнопкой мыши][4]

6.  Следуйте той же процедуре, которую использовали для строки подключения `StorageConnectionString`, чтобы задать строку подключения `Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString`.

7.  Выполните ту же процедуру, которую использовали для двух строк подключения, для роли MvcWebRole, чтобы задать строки подключения для ролей WorkerRoleA и workerRoleB.

8.  Откройте файл **ServiceConfiguration.Local.cscfg**, расположенный в проекте **AzureEmailService**.

    В элементе `Role` для `MvcWebRole` будет показан элемент `ConfigurationSettings` с настройками, которые были обновлены через интерфейс Visual Studio.

          <Role name="MvcWebRole">
            <Instances count="1" />
            <ConfigurationSettings>
              <Setting name="Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString" value="DefaultEndpointsProtocol=https;AccountName=[name];AccountKey=[Key]" />
              <Setting name="StorageConnectionString" value="DefaultEndpointsProtocol=https;AccountName=aestest;AccountKey=[Key]" />
            </ConfigurationSettings>
          </Role>

    В элементах `Role` для двух рабочих ролей отображаются две одинаковых строки подключения.

    Можно отредактировать эти файлы напрямую вместо использования окна **[Роль]** в Visual Studio Дополнительные сведения о файлах конфигурации см. в разделе [Настройка проекта Azure][Настройка проекта Azure].

### Тестирование приложения, настроенного на использование вашей учетной записи хранилища

1.  Для запуска приложения нажмите сочетание клавиш CTRL+F5. Введите некоторые данные, выбрав ссылки **Списки рассылки**, **Подписчики** и **Сообщения**, как уже делали ранее.

2.  В Visual Studio в откройте **обозреватель сервера**.

3.  Разверните узел **Хранилище** под узлом **Azure** и затем разверните узел для учетной записи хранилища, которое настроено для использования

4.  Разверните **Таблицы** и дважды щелкните таблицу `MailingList`, чтобы увидеть данные, введенные на страницах **Список адресов** и **Подписчик** приложения.

### Дополнительные действия по отключению автоматического запуска эмулятора хранения Azure

Если эмулятор хранения не используется, можно уменьшить время запуска проекта и использовать меньше локальных ресурсов за счет отключения автоматического запуска эмулятора хранения Azure.

1.  В **обозревателе решений** щелкните правой кнопкой мыши облачный проект **AzureEmailService**, а затем выберите пункт **Свойства**.

    ![Выбор свойств облачного проекта][Выбор свойств облачного проекта]

2.  Выберите вкладку **Разработка**.

3.  Задайте значение **False** для параметра **Запустить эмулятор хранения Azure**.

    ![Отключение автоматического запуска эмулятора хранения][Отключение автоматического запуска эмулятора хранения]

    **Примечание**. Задавайте значение false для данного параметра только в том случае, если не собираетесь использовать эмулятор хранения.

    В этом окне также можно изменить файл **конфигурации службы**, который используется при локальном запуске приложения из среды **Локально** в **Облако** (с *ServiceConfiguration.Local.cscfg* на *ServiceConfiguration.Cloud.cscfg*).

4.  На панели задач Windows щелкните правой кнопкой мыши значок эмулятора вычислений и выберите пункт **Завершить работу эмулятора хранилища**.

    ![ASE][ASE]

## <a name="sendGrid"></a><span class="short-header">SendGrid</span>Настройка приложения для использования SendGrid

Пример приложения использует SendGrid для отправки сообщений электронной почты. Для отправки сообщений электронной почты с помощью SendGrid необходимо настроить учетную запись SendGrid, а затем обновить файл конфигурации с учетными данными SendGrid.

<div class="note"><p><strong>Примечание.</strong> Если вы не хотите или не можете использовать SendGrid, этот компонент можно легко заменить на собственную службу электронной почты. Код, использующий SendGrid, изолирован в двух методах рабочей роли B. В учебнике 5 поясняется, что именно нужно изменить, чтобы реализовать другой метод отправки сообщений электронной почты. Если вы хотите сделать это, можете пропустить данную процедуру и продолжить работу с этим учебником; все остальное в приложении (веб-страницы, электронная почта, планирование и т. д.) будет работать, за исключением фактической отправки сообщений электронной почты.</p></div>

### Создание учетной записи SendGrid

1.  Выполните инструкции, приведенные в разделе [Отправка электронной почты с помощью SendGrid в Azure][Отправка электронной почты с помощью SendGrid в Azure], чтобы зарегистрировать бесплатную учетную запись.

### Обновление учетных данных SendGrid в свойствах рабочей роли

Когда вы задавали учетные данные учетной записи хранения для веб-роли и двух рабочих ролей, можно было заметить, что рабочая роль B имела три параметра, отсутствовавшие в веб-роли и рабочей роли A. Теперь данным пользовательским интерфейсом можно воспользоваться для настройки этих трех параметров (выберите значение **Облако** в раскрывающемся списке **Конфигурация службы**).

Дальнейшие действия показывают альтернативный метод задания свойств путем изменения файла конфигурации.

1.  Отредактируйте файл *ServiceConfiguration.Cloud.cscfg* в проекте `AzureEmailService` и введите значения имени пользователя и пароля SendGrid, которые вы получили на предыдущем шаге в элементе `WorkerRoleB`, который содержит эти настройки. В следующем коде показан элемент WorkerRoleB.

    ![SendGridSettings][SendGridSettings]

2.  Также присутствует параметр AzureMailServiceURL. Установите значением URL-адрес, выбранный при создании облачной службы Azure, например: "<http://aescloud.cloudapp.net>".

Путем обновления файла конфигурации облака вы настраиваете параметры, которые будут использоваться при выполнении приложения в облаке. Если вы хотите, чтобы приложение отправляло сообщения электронной почты во время локального выполнения, необходимо также обновить файл *ServiceConfiguration.Local.cscfg*.

## <a name="deployAz"></a><span class="short-header">Развертывание в Azure</span>Развертывание приложения в Azure

Для развертывания приложения можно создать пакет в Visual Studio и загрузить его с помощью портала управления Azure либо опубликовать непосредственно из Visual Studio. В этом учебнике будет использоваться метод публикации.

Сначала вы публикуете приложение в промежуточной среде, а затем это промежуточное развертывание переносится в рабочую среду.

### Реализация ограничений по IP-адресам

При развертывании в промежуточной среде приложение будет доступно для всех тех, кто знает его URL-адрес. Таким образом, первым шагом является реализация ограничений по IP-адресам, предотвращающая несанкционированный доступ. В реальном приложении необходимо реализовать механизм проверки подлинности и авторизации, такой как система удостоверений ASP.NET, но эти функции исключены из примера приложения для упрощения настройки, развертывания и тестирования.

1.  Откройте файл *Web.Release.config*, который размещен в корневой папке проекта `MvcWebRole`, и замените значение 127.0.0.1 атрибута **ipAddress** на ваш IP-адрес. (Чтобы открыть файл **Web.Release.config** в **обозревателе решений**, необходимо развернуть файл *Web.config*.)

    Ваш IP-адрес можно найти путем поиска строки "Найти мой IP" в [Bing][Bing] или другой поисковой системе.

    При публикации приложения применяются указанные в файле *Web.release.config* преобразования, а в файле *web.config*, который развертывается в облаке, обновляются элементы ограничений по IP-адресам. Преобразованный файл *web.config* можно просмотреть в папке *AzureEmailService\\MvcWebRole\\obj\\Release\\TransformWebConfig\\transformed* после создания пакета.

### Настройка приложения для использования вашей учетной записи хранилища при запуске в облаке

Учетные данные учетной записи хранения для веб-роли и двух рабочих ролей, которые вы задавали ранее в рамках этого учебника, использовались при локальном запуске приложения. Теперь необходимо задать учетные данные учетной записи хранения, используемые при запуске приложения в облаке.

Для данного тестового запуска вы будете использовать те же учетные данные для облака, которые используются для локального запуска. При развертывании рабочего приложения обычно используется учетная запись для рабочей среды, отличная от тестовой учетной записи. Кроме того, в рабочей среде рекомендуется использовать разные учетные записи для диагностики connectionString и для строки подключения к хранилищу, но для данного тестового запуска будет использоваться одна и та же учетная запись.

Можно использовать тот же пользовательский интерфейс для настройки строк подключения (просто убедитесь, что в раскрывающемся списке **Конфигурация службы** выбрано значение **Облако**). В качестве альтернативы можно изменить файл конфигурации, как описано в следующих шагах.

1.  Откройте файл *ServiceConfiguration.Local.cscfg* в проекте **AzureEmailService** и скопируйте элементы `Setting` для `StorageConnectionString` и `Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString`.

2.  Откройте файл *ServiceConfiguration.Cloud.cscfg* в проекте **AzureEmailService** и вставьте скопированные элементы в элемент `Configuration Settings` для `MvcWebRole`, `WorkerRoleA` и `WorkerRoleB`, заменив элементы `Setting`, которые уже есть здесь.

3.  Убедитесь, что для веб-роли и элементов двух рабочих ролей заданы одинаковые строки подключения.

### Публикация приложения

1.  Если программа Visual Studio еще не открыта, запустите Visual Studio и откройте решение **AzureEmailService**.

2.  Щелкните правой кнопкой мыши облачный проект **AzureEmailService** и выберите **Опубликовать**.

    ![Пакет][Пакет]

    Появляется диалоговое окно **Опубликовать приложение Azure**.

    ![Облачный пакет][Облачный пакет]

3.  Если ранее вы воспользовались автоматическим методом импорта учетных данных учетной записи хранилища, ваша подписка Azure находится в раскрывающемся списке, где можно выбрать ее и нажать кнопку **Далее**. В противном случае щелкните элемент **Вход для загрузки учетных данных** и следуйте инструкциям, приведенным в разделе [Настройка приложения для хранилища Azure][Настройка приложения для доступа к хранилищу Azure], чтобы загрузить и импортировать свои параметры публикации.

4.  На вкладке **Общие настройки** проверьте, что в раскрывающемся списке **Облачная служба** выбрана нужная облачная служба.

5.  В раскрывающемся списке **Среда** измените значение **Рабочая среда** на **Промежуточная среда**.

    ![Панель мониторинга][Панель мониторинга]

6.  Оставьте значение по умолчанию **Выпуск** для параметра **Конфигурация построения** и значение **Облако** для параметра **Конфигурация службы**.

    Заданные на вкладке **Дополнительно** значения по умолчанию подходят для работы с этим учебником. На вкладке **Дополнительно** доступно несколько параметров, которые могут быть полезны при разработке и тестировании. Дополнительные сведения о вкладке "Дополнительно" см. в разделе [Мастер публикации приложения Azure][Мастер публикации приложения Azure].

7.  Нажмите кнопку **Далее**.

8.  На шаге **Сводка** мастера щелкните значок **сохранить** (значок дискеты, расположенный справа от раскрывающегося списка "Целевой профиль") для сохранения параметров публикации.

    В следующий раз при публикации приложения будут использоваться сохраненные параметры, поэтому вам не придется повторно применять мастер публикации.

9.  Просмотрите параметры, а затем щелкните элемент **Опубликовать**.

    ![Публикация][Публикация]

В Visual Studio открывается окно **Журнал действий Azure**.

1.  Нажмите значок со стрелкой вправо, чтобы развернуть сведения о развертывании.

    ![pub][pub]
    ![pub][5]

    Развертывание может занять около 5 минут и более.

2.  После завершения развертывания щелкните элемент **URL-адрес веб-сайта** для запуска приложения.

    ![Панель мониторинга][6]

3.  Введите некоторые данные на веб-страницах **Список рассылки**, **Подписчик** и **Сообщение** для тестирования приложения.

    **Примечание**. Удалите приложение после завершения тестирования, чтобы не платить за неиспользуемые ресурсы. При использовании [бесплатной пробной учетной записи Azure][бесплатной пробной учетной записи Azure] три развернутых роли выработают месячный лимит за пару недель. Чтобы удалить развертывание с помощью портала управления Azure, выберите облачную службу и щелкните элемент**УДАЛИТЬ** в нижней части страницы, а затем выберите развертывание в рабочей или промежуточной среде.

    ![Публикация][7]

4.  В журнале действий Azure в Visual Studio выберите **Открыть в обозревателе сервера**.

    Развертывание можно отслеживать в области **Среда выполнения приложений Azure** **обозревателя серверов**. Если в мастере **публикации приложения Azure** выбран параметр **Включить удаленный рабочий стол для всех ролей**, можно щелкнуть правой кнопкой мыши экземпляр роли и выбрать пункт **Подключение с помощью удаленного рабочего стола**.

    ![Публикация][8]

## <a name="swap"></a>Продвижение приложения из промежуточной среды в рабочую

1.  В левой области [портала управления Azure][портал управления Azure] щелкните значок **Облачные службы**, а затем выберите облачную службу и щелкните вкладку **Панель мониторинга**.

2.  Щелкните **Переключить**.

3.  Нажмите кнопку **Да** для переключения виртуального IP-адреса (VIP). Выполнение этого шага может занять несколько минут.

    ![Панель мониторинга][9]

4.  На вкладке **Панель мониторинга** для развертывания **Рабочая среда** выполните прокрутку вниз до раздела **Cводка**, находящегося в правом нижнем углу страницы. Обратите внимание, что значение **URL-адрес сайта** изменилось с префикса GUID на имя вашей облачной службы.

    ![Панель мониторинга][10]

5.  Щелкните ссылку под пунктом **URL-адрес узла** или скопируйте и вставьте ее браузер для тестирования приложения в рабочей среде.

    Если вы не изменяли параметры учетной записи хранения, при запуске приложения в облаке отображаются данные, введенные во время тестирования промежуточной версии приложения.

## <a name="trace"></a>Настройка трассировки и просмотр данных трассировки

Трассировка является крайне полезным средством для отладки облачного приложения. В этом разделе учебника вы узнаете, как просмотреть данные трассировки.

1.  Убедитесь, что строка подключения диагностики настроена на использование учетной записи хранилища Azure, а не хранилища разработки.

    Если вы следовали инструкциям, приведенным ранее в этом учебнике, они будут одинаковыми. В их совпадении можно убедиться, воспользовавшись пользовательским интерфейсом Visual Studio (вкладка **Параметры** в окне **Свойства** для роли) или просмотрев файлы *ServiceConfiguration.\*.cscfg*.

**Примечание.** Для трассировки данных рекомендуется использовать учетную запись хранения, отличную от учетной записи хранения, применяемой для данных в рабочей среде, но в целях упрощения процесса в этом учебнике для трассировки настраивается та же учетная запись.

1.  В Visual Studio откройте *WorkerRoleA.cs* в проекте **WorkerRoleA**, найдите `ConfigureDiagnostics` и проверьте метод `ConfigureDiagnostics`.

        private void ConfigureDiagnostics()
        {
            DiagnosticMonitorConfiguration config = DiagnosticMonitor.GetDefaultInitialConfiguration();
            config.ConfigurationChangePollInterval = TimeSpan.FromMinutes(1d);
            config.Logs.BufferQuotaInMB = 500;
            config.Logs.ScheduledTransferLogLevelFilter = LogLevel.Verbose;
            config.Logs.ScheduledTransferPeriod = TimeSpan.FromMinutes(1d);

            DiagnosticMonitor.Start(
                "Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString",
                config);
        }

    В этом коде метод `DiagnosticMonitor` настроен для хранения до 500 МБ данных трассировки (при объеме свыше 500 МБ выполняется перезапись наиболее старых данных) и всех сообщений трассировки (LogLevel.Verbose). Метод `ScheduledTransferPeriod` передает данные трассировки в хранилище каждую минуту. Необходимо задать `ScheduledTransferPeriod` для сохранения данных трассировки.

    Метод `ConfigureDiagnostics` в каждой из рабочих ролей и веб-ролей настраивает прослушиватель трассировки для записи данных при вызове API трассировки. Дополнительные сведения см. в разделе [Использование трассировки в облачных приложениях Windows Azure][Использование трассировки в облачных приложениях Windows Azure].

2.  В **обозревателе сервера** дважды щелкните **WADLogsTable** (раскройте **Azure** / **Хранилище** / **имя\_вашей\_учетной\_записи\_хранения** / **Таблицы**) для учетной записи хранилища, которая была добавлена ранее. Можно ввести [фильтр служб данных WCF][фильтр служб данных WCF] для ограничения числа отображаемых сущностей. На следующем рисунке отображаются только предупреждения и сообщения об ошибках.

    ![Панель мониторинга][11]

## <a name="addRole"></a>Добавление еще одного экземпляра рабочей роли для обработки повышенной нагрузки

Существует два подхода к масштабированию вычислительных ресурсов в ролях Azure — посредством задания [размера виртуальной машины][размера виртуальной машины] или задания числа экземпляров запущенных виртуальных машин.

Размер виртуальной машины указывается в атрибуте `vmsize` элемента `WebRole` или `WorkerRole` файле *ServiceDefinition.csdef*. Параметр по умолчанию — `Small`, он предоставляет одно ядро и 1,75 ГБ ОЗУ. Для многопоточных приложений, которые используют большой объем памяти, места на диске и пропускной способности, можно увеличить размер виртуальной машины для повышения производительности. Например, виртуальная машина `ExtraLarge` имеет 8 ядер ЦП и 14 ГБ ОЗУ. Увеличение объема памяти, числа ядер ЦП, размера диска и пропускной способности на одном компьютере называется *вертикальным масштабированием*. В число подходящих кандидатов для вертикального масштабирования входят веб-приложения ASP.NET, использующие [асинхронные методы][асинхронные методы]. Описание ресурсов, предоставляемых для каждого из размеров виртуальных машин, см. в разделе [Размеры виртуальных машин][размера виртуальной машины].

Рабочая роль B в этом приложении выступает в качестве ограничивающего фактора при высокой нагрузке, так как она выполняет работу по отправке сообщений электронной почты. (Рабочая роль A просто создает сообщения очередь, что не требует большого объема ресурсов). Поскольку рабочая роль B не является многопоточной и не имеет большого объема памяти, она не слишком хорошо подходит для вертикального масштабирования. Рабочая роль B допускает линейное масштабирование (то есть может почти вдвое увеличивать производительности при удвоении числа экземпляров) за счет увеличения числа экземпляров. Увеличение количества вычислительных операций называется *горизонтальным масштабированием*. Каждый экземпляр сопряжен с определенными затратами, поэтому горизонтальное масштабирование следует осуществлять только в том случае, когда того требует приложение.

Можно производить горизонтальное масштабирование веб-роли или рабочей роли, обновляя значение параметра в пользовательском интерфейсе Visual Studio или напрямую изменяя файлы *ServiceConfiguration.\*.cscfg.* Число экземпляров указано на вкладке **Конфигурация** в окне **Свойства** роли, а также в элементе `Instances` в *CSCFG*-файлах. При обновлении параметра необходимо развернуть обновленный файл конфигурации, чтобы изменения вступили в силу. Другим вариантом при кратковременном увеличении нагрузки может быть изменение числа экземпляров роли вручную или настройкой Azure для автоматического изменения числа экземпляров на основе указанного критерия. Дополнительные сведения об автоматическом масштабировании см. по ссылкам, приведенным в конце [последнего учебника данной серии][последнего учебника данной серии].

В этом разделе учебника вы будете осуществлять горизонтальное масштабирование рабочей роли B с помощью портала управления, но сначала вы узнаете, как это реализуется в Visual Studio.

Чтобы сделать это в Visual Studio, щелкните правой кнопкой мыши роль в области **Роли** облачного проекта и выберите пункт **Свойства**.

![Щелкните элемент "Свойства" правой кнопкой мыши][Щелкните элемент "Свойства" правой кнопкой мыши]

Затем откройте расположенную слева вкладку **Конфигурация** и выберите **Облако** в раскрывающемся списке **Конфигурация службы**.

![Число экземпляров][Число экземпляров]

Обратите внимание, что на этой вкладке также можно настроить размер виртуальной машины.

Ниже объясняется, как выполнять горизонтальное масштабирование с помощью портала управления Azure.

1.  На портале управления выберите облачную службу, а затем щелкните элемент **Масштабирование**.

2.  Увеличьте число экземпляров для рабочей роли B и нажмите кнопку **Сохранить**.

    ![Увеличение числа экземпляров][Увеличение числа экземпляров]

    Для подготовки новых виртуальных машин к работе может потребоваться несколько минут.

3.  Выберите вкладку **Экземпляры**, чтобы просмотреть каждый экземпляр роли в приложении.

    ![Просмотр экземпляров][Просмотр экземпляров]

## <a name="nextsteps"></a>Дальнейшие действия

Теперь вы знаете, как настроить, развернуть и масштабировать готовое приложение. В следующих учебниках описано построение приложения с нуля. В [следующем учебнике][следующем учебнике] вы построите веб-роль.

Ссылки на дополнительные ресурсы по работе с таблицами, очередями и BLOB-объектами хранилища Azure приведены [в конце последнего учебника данной серии][в конце последнего учебника данной серии].

<div><a href="/ru-ru/develop/net/tutorials/multi-tier-web-site/3-web-role/" class="site-arrowboxcta download-cta">Учебник 3</a></div>

  [первом учебнике серии]: /ru-ru/develop/net/tutorials/multi-tier-web-site/1-overview/
  [Настройка среды разработки]: #setupdevenv
  [Загрузка и запуск готового решения]: #downloadcnfg
  [Создание учетной записи хранения Azure]: #createWASA
  [Создание облачной службы]: #createcloudsvc
  [Настройка приложения для доступа к хранилищу Azure]: #conf4azureStorage
  [Настройка приложения для использования SendGrid]: #sendGrid
  [Развертывание приложения в Azure]: #deployAz
  [Продвижение приложения из промежуточной среды в рабочую]: #swap
  [Настройка трассировки и просмотр данных трассировки]: #trace
  [Добавление еще одного экземпляра рабочей роли для обработки повышенной нагрузки]: #addRole
  [готовое решение]: http://code.msdn.microsoft.com/Windows-Azure-Multi-Tier-eadceb36
  [Запустите приложение.]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-mailinglist1.png
  [1]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-create1.png
  [Страница индексов списков рассылки]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-mailing-list-index-page.png
  [Страница индексов подписчиков]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-subscribers-index-page.png
  [Страница создания сообщения]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-message-create-page.png
  [Страница индексов сообщений]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-message-index-page.png
  [Обозреватель серверов]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-serverExplorer.png
  [Обозреватель хранилищ VS]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-wasVSdata.png
  [проводник хранилища Azure]: http://azurestorageexplorer.codeplex.com/
  [портал управления Azure]: http://manage.windowsazure.com
  [Новое хранилище]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-portal-new-storage.png
  [Быстрое создание]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-storage-quick.png
  [Управление учетными записями хранения]: /ru-ru/manage/services/storage/how-to-manage-a-storage-account/
  [Создание хранилища с префиксом URL-адреса]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-create-storage-url-test.png
  [Управление ключами]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-manage-keys.png
  [Ключи GUID]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-guid-keys.PNG
  [Быстрое создание облака]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-new-cloud.png
  [Создание территориальной группы в Azure]: http://msdn.microsoft.com/ru-ru/library/jj156209.aspx
  [2]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-create-cloud.png
  [Щелкните элемент "Свойства" правой кнопкой мыши]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-rt-prop.png
  [3]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-elip.png
  [4]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-enter.png
  [Настройка проекта Azure]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee405486.aspx
  [Выбор свойств облачного проекта]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-aesp.png
  [Отключение автоматического запуска эмулятора хранения]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-1.png
  [ASE]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-se4.png
  [Отправка электронной почты с помощью SendGrid в Azure]: http://www.windowsazure.com/ru-ru/develop/net/how-to-guides/sendgrid-email-service/ "SendGrid"
  [SendGridSettings]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-sg.png
  [Bing]: http://www.bing.com/search?q=find+my+IP&qs=n&form=QBLH&pq=find+my+ip&sc=8-10&sp=-1&sk= "find my IP"
  [Пакет]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-6.png
  [Облачный пакет]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-16.png
  [Панель мониторинга]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-7.png
  [Мастер публикации приложения Azure]: http://msdn.microsoft.com/library/windowsazure/hh535756.aspx "pub wiz"
  [Публикация]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-8.png
  [pub]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-11.png
  [5]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-9.png
  [6]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-c55.png
  [бесплатной пробной учетной записи Azure]: http://www.windowsazure.com/ru-ru/pricing/free-trial/ "free-trial account"
  [7]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-19.png
  [8]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-12.png
  [9]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-c6.png
  [10]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-c7.png
  [Использование трассировки в облачных приложениях Windows Azure]: http://blogs.msdn.com/b/windowsazure/archive/2012/10/24/using-trace-in-windows-azure-cloud-applications-1.aspx " Использование трассировки Windows Azure"
  [фильтр служб данных WCF]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ff683669.aspx "WCF filter"
  [11]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-trc.png
  [размера виртуальной машины]: http://msdn.microsoft.com/ru-ru/library/windowsazure/ee814754.aspx "VM sizes"
  [асинхронные методы]: http://www.asp.net/mvc/tutorials/mvc-4/using-asynchronous-methods-in-aspnet-mvc-4 "Async MVC"
  [последнего учебника данной серии]: /ru-ru/develop/net/tutorials/multi-tier-web-site/5-worker-role-b/
  [Число экземпляров]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-instanceCnt.png
  [Увеличение числа экземпляров]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-in3.png
  [Просмотр экземпляров]: ./media/cloud-services-dotnet-multi-tier-app-storage-1-download-run/mtas-in2.png
  [следующем учебнике]: /ru-ru/develop/net/tutorials/multi-tier-web-site/3-web-role/
  [в конце последнего учебника данной серии]: /ru-ru/develop/net/tutorials/multi-tier-web-site/5-worker-role-b/#nextsteps
