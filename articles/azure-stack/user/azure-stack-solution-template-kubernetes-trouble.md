---
title: Устранение неполадок развертывания Kubernetes в Azure Stack | Документация Майкрософт
description: Узнайте, как устранять неполадки развертывания в Kubernetes в Azure Stack.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
pms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/29/2018
ms.author: mabrigg
ms.reviewer: waltero
ms.openlocfilehash: 472dfc04cea65cab39d177bb214c417d229b71d2
ms.sourcegitcommit: 5d837a7557363424e0183d5f04dcb23a8ff966bb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2018
ms.locfileid: "52956726"
---
# <a name="troubleshoot-your-deployment-to-kubernetes-to-azure-stack"></a>Устранение неполадок развертывания в Kubernetes (K8) в Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

> [!Note]  
> Система Kubernetes доступна в Azure Stack в предварительной версии.

В статье рассматривается устранение неполадок кластера Kubernetes. Вы можете проверить оповещение о развертывании и просмотреть состояние развертывания с помощью элементов, необходимых для развертывания. Вам может потребоваться сбор журналов из Azure Stack или виртуальных машин Linux, которые размещены в Kubernetes. Вам может также потребоваться работать совместно с администратором Azure Stack, чтобы получить журналы из конечной точки администрирования.

## <a name="overview-of-deployment"></a>Общие сведения о развертывании

Прежде чем приступать к устранению неполадок в кластере, рассмотрите процесс развертывания кластера Azure Stack Kubernetes. Развертывание создает шаблон решения Azure Resource Manager для создания виртуальных машин и установки обработчика ACS для кластера.

### <a name="deployment-workflow"></a>Рабочий процесс развертывания

В примере ниже показан общий процесс для развертывания кластера.

![Процесс развертывания кластера](media/azure-stack-solution-template-kubernetes-trouble/002-Kubernetes-Deploy-Flow.png)

### <a name="deployment-steps"></a>Шаги по развертыванию

1. Выполните сбор данных о количестве входных параметров из элемента marketplace.

    Введите значения, которые необходимо настроить в кластере Kubernetes, в том числе:
    -  **Имя пользователя**. Это имя пользователя для виртуальных машин Linux, которые являются частью кластера Kubernetes и динамического административного представления.
    -  **Открытый ключ SSH**. Это ключ, используемый для авторизации на всех виртуальных машинах Linux, созданных как часть кластера Kubernetes и динамического административного представления.
    -  **Субъект-служба**. Это идентификатор, используемый поставщиком облачных служб Azure Kubernetes. Идентификатор клиента определяется как идентификатор приложения во время создания субъекта-службы. 
    -  **Секрет клиента**. Это ключ, полученный при создании субъекта-службы.

2. Создайте виртуальную машину развертывания и расширение пользовательских скриптов.
    -  Создайте развертывание виртуальной машины Linux с помощью образа Linux Marketplace, **Ubuntu Server 16.04-LTS**.
    -  Скачайте и запустите расширение для пользовательских скриптов из Marketplace. Скрипт — это **настраиваемый скрипт для Linux 2.0**.
    -  Выполните пользовательский скрипт DVM. Скрипт выполняет следующие задачи:
        1. Получает конечную точку коллекции из конечной точки метаданных Azure Resource Manager.
        2. Получает идентификатор ресурса Active Directory из конечной точки метаданных Azure Resource Manager.
        3. Загружает модель API для обработчика ACS.
        4. Развертывает обработчик ACS для кластера Kubernetes и сохраняет профиль облака Azure Stack для `/etc/kubernetes/azurestackcloud.json`.
3. Создайте главные виртуальные машины.

4. Скачайте и запустите расширения для пользовательских скриптов.

5. Выполнение главного скрипта.

    Скрипт выполняет следующие задачи:
    - Устанавливает такие ресурсы etcd, Docker и Kubernetes, как kubelet. Etcd — это хранилище распределенных значений ключа, которое предоставляет способ хранения данных в кластере виртуальных машин. Docker поддерживает минималистские уровни виртуализации операционной системы, которая известна как контейнеры. Kubelet — агент узла, который выполняется на каждом узле Kubernetes.
    - Настраивает службу etcd.
    - Настраивает службу kubelet.
    - Запускает kubelet. Эта задача предусматривает указанные ниже действия.
        1. Запуск службы API.
        2. Запуск службы контроллера.
        3. Запуск службы Планировщика.
6. Создайте виртуальные машины агента.

7. Скачивание и запуск расширения для пользовательских сценариев.

7. Выполнение сценария агента. Пользовательский сценарий агента выполняет следующие задачи:
    - Устанавливает etcd.
    - Настраивает службу kubelet.
    - Соединяет кластер Kubernetes.

## <a name="steps-for-troubleshooting"></a>Сведения об устранении неполадок

Вы можете собирать журналы на виртуальных машинах, поддерживающих кластер Kubernetes. Можно также проверить, существует ли журнал развертывания. Вам может потребоваться обратиться к администратору Azure Stack для проверки версии Azure Stack, которую необходимо использовать, а также получить журналы из Azure Stack, связанные с развертыванием.

1. Проверьте [состояние развертывания](#review-deployment-status) и [извлеките журналы](#get-logs-from-a-vm) из главного узла в кластере Kubernetes.
2. Убедитесь, что у вас установлена последняя версия Azure Stack. Если вы не уверены, какая версия используется, обратитесь к администратору Azure Stack. Для элемента 0.3.0 кластера Kubernetes из Marketplace требуется Azure Stack версии 1808 или более поздней.
3.  Просмотрите файлы создания виртуальной машины. Возможно были следующие проблемы:  
    - Открытый ключ может быть недопустимым. Проверьте ключ, который вы создали.  
    - Создание виртуальной машины может вызывать внутреннюю ошибку или активировать ошибку создания. Ряд факторов могут быть причиной ошибок, включая ограничения емкости подписки Azure Stack.
    - Убедитесь, что полное доменное имя для виртуальной машины начинается с символа повторяющегося префикса.
4.  Если состояние виртуальной машины — **ОК**, оцените DVM. Если DVM содержит сообщение об ошибке:

    - Открытый ключ может быть недопустимым. Проверьте ключ, который вы создали.  
    - Обратитесь к администратору Azure Stack для получения журналов Azure Stack с помощью привилегированных конечных точек. Дополнительные сведения см. в статье о [средствах диагностики Azure Stack](https://docs.microsoft.com/azure/azure-stack/azure-stack-diagnostics).
5. Если у вас есть вопрос о развертывании, вы можете разместить его или поискать ответы на вопрос на [форуме Azure Stack](https://social.msdn.microsoft.com/Forums/azure/home?forum=azurestack). 

## <a name="review-deployment-status"></a>Проверка состояния развертывания

Состояние развертывания можно проверить при развертывании кластера Kubernetes для проверки любых проблем.

1. Откройте [портал Azure Stack](https://portal.local.azurestack.external).
2. Выберите **Группы ресурсов**, а затем выберите имя группы ресурсов, используемое при развертывании кластера Kubernetes.
3. Выберите **Развертывания**, а затем **Имя развертывания**.

    ![Устранение неполадок](media/azure-stack-solution-template-kubernetes-trouble/azure-stack-kub-trouble-report.png)

4.  Ознакомьтесь с информацией в окне устранения неполадок. Каждый развернутый шаблон предоставляет следующие сведения.
    
    | Свойство | ОПИСАНИЕ |
    | ----     | ----        |
    | Ресурс | Имя ресурса. |
    | type | Поставщик ресурсов и тип ресурса. |
    | Status | Состояние элемента. |
    | TimeStamp | Метка времени в формате UTC. |
    | Сведения об операции | Сведения об операции, такие как вовлеченный в операцию поставщик ресурсов, конечная точка ресурса и имя ресурса. |

    Каждый элемент содержит зеленый или красный значок состояния.

## <a name="get-logs-from-a-vm"></a>Получение журналов из виртуальной машины

Чтобы создать журналы, вам необходимо подключиться к главной виртуальной машине кластера, открыть строку bash и запустить сценарий. Главную виртуальную машину можно найти в группе кластерных ресурсов. Она называется `k8s-master-<sequence-of-numbers>`. 

### <a name="prerequisites"></a>Предварительные требования

Вам нужна строка bash на компьютере для управления Azure Stack. Используете bash для выполнения сценариев, которые получают доступ к журналам. На компьютере Windows можно использовать строку bash, установленную с помощью Git. Самую последнюю версию Git можно скачать [здесь](https://git-scm.com/downloads).

### <a name="get-logs"></a>Получение журналов

Для получения журналов сделайте следующее:

1. Откройте строку bash. Если вы используете Git на компьютере Windows, строку bash можно открыть по следующему пути: `c:\programfiles\git\bin\bash.exe`.
2. Выполните следующие команды bash:

    ```Bash  
    mkdir -p $HOME/kuberneteslogs
    cd $HOME/kuberneteslogs
    curl -O https://raw.githubusercontent.com/msazurestackworkloads/azurestack-gallery/master/diagnosis/getkuberneteslogs.sh
    sudo chmod 744 getkuberneteslogs.sh
    ```

    > [!Note]  
    > В Windows нет необходимости запускать `sudo`. Можно просто использовать `chmod 744 getkuberneteslogs.sh`.

3. Выполните в одном сеансе следующую команду с параметрами, обновленными в соответствии с вашей средой.

    ```Bash  
    ./getkuberneteslogs.sh --identity-file id_rsa --user azureuser --vmdhost 192.168.102.37
    ```

4. Проверьте параметры и задайте значения в зависимости от вашей среды.
    | Параметр           | ОПИСАНИЕ                                                                                                      | Пример                                                                       |
    |---------------------|------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
    | -i, --identity-file | Файл закрытого ключа RSA для подключения Kubernetes к главной виртуальной машине. Ключ должен начинаться с `-----BEGIN RSA PRIVATE KEY-----`. | C:\data\privatekey.pem                                                        |
    | -h, --host          | Общедоступный IP-адрес или полное доменное имя главного кластера Kubernetes виртуальной машины. Имя виртуальной машины начинается с `k8s-master-`.                       | IP-адрес: 192.168.102.37<br><br>Полное доменное имя: k8s-12345.local.cloudapp.azurestack.external      |
    | -u, --user          | Имя пользователя кластера Kubernetes в главной виртуальной машине. Это имя задается при настройке элемента marketplace.                                                                    | azureuser                                                                     |
    | -d, --vmdhost       | Общедоступный IP-адрес или полное доменное имя DVM. Имя виртуальной машины начинается с `vmd-`.                                                       | IP-адрес: 192.168.102.38<br><br>Служба доменных имен (DNS): vmd-dnsk8-frog.local.cloudapp.azurestack.external |

   Когда вы добавляете значения параметров, это может быть в виде следующего кода:

    ```Bash  
    ./getkuberneteslogs.sh --identity-file "C:\secretsecret.pem" --user azureuser --vmdhost 192.168.102.37
     ```

    Успешное выполнение создает журналы.

    ![Созданные журналы](media/azure-stack-solution-template-kubernetes-trouble/azure-stack-generated-logs.png)


4. Извлеките журналы из папок, созданных командой. Команда создает папки и присваивает им метку времени.
    - KubernetesLogs*YYYY-MM-DD-XX-XX-XX-XXX*
        - Dvmlogs
        - Acsengine-kubernetes-dvm.log

## <a name="next-steps"></a>Дополнительная информация

[Развертывание Kubernetes в Azure Stack](azure-stack-solution-template-kubernetes-deploy.md)

[Добавление Kubernetes в Azure Stack Marketplace](../azure-stack-solution-template-kubernetes-cluster-add.md)

[Kubernetes в Azure](https://docs.microsoft.com/azure/container-service/kubernetes/container-service-kubernetes-walkthrough)
