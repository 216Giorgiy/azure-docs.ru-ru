---
title: Создание пограничного решения машинного обучения с помощью Azure и Azure Stack | Документация Майкрософт
description: Узнайте, как создать пограничное решение машинного обучения с помощью Python в Azure и Azure Stack.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 09/24/2018
ms.author: mabrigg
ms.reviewer: Anjay.Ajodha
ms.openlocfilehash: 30dbdff584f1bea955072e96a5e0f03cfe4c92c1
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "46963736"
---
# <a name="tutorial-create-an-edge-machine-learning-solution-with-azure-and-azure-stack"></a>Руководство по созданию пограничного решения машинного обучения с помощью Azure и Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Узнайте, как создать пограничное решение машинного обучения с помощью Azure и Azure Stack.

В рамках этого руководства вы создадите пример среды и выполните в ней следующие действия:

> [!div class="checklist"]
> - создание учетной записи хранения и контейнера для размещения очищенных данных;
> - создание виртуальной машины Ubuntu для обработки и анализа данных (DSVM) на портале Azure;
> - развертывание в Azure Служб машинного обучения Azure для построения и обучения моделей;
> - создание учетных записей Служб машинного обучения Azure;
> - развертывание реестра контейнеров Azure и его использование;
> - развертывание кластера Kubernetes в Azure Stack;
> - создание учетной записи хранения Azure Stack и очереди службы хранилища для данных;
> - создание новой функции Azure Stack для перемещения очищенных данных из Azure Stack в Azure.

**Когда следует использовать это решение:**

 -  ваша организация уже использует подход DevOps или намерена применить его в ближайшем будущем;
 -  вы хотите реализовать методы CI/CD для своей реализации Azure Stack и общедоступного облака;
 -  вы хотите объединить конвейеры CI/CD, размещенные в облачных и локальных средах;
 -  вам нужна возможность разработки приложений в облачной или локальной службе;
 -  вы хотите единообразно применять навыки разработки для облачных и локальных приложений.

> [!Tip]  
> ![hybrid-pillars.png](./media/azure-stack-solution-cloud-burst/hybrid-pillars.png)  
> Microsoft Azure Stack — это расширение Azure.re. Azure Stack обеспечивает гибкость и высокую скорость внедрения инноваций облачных вычислений в локальной среде. Только это гибридное облако позволяет создавать и развертывать гибридные приложения в любой точке мира.  
> 
> В техническом документе [Design Considerations for Hybrid Applications](https://aka.ms/hybrid-cloud-applications-pillars) (Рекомендации по проектированию гибридных приложений) рассматриваются основные аспекты качества программного обеспечения (размещение, масштабируемость, доступность, устойчивость, управляемость и безопасность) для разработки, развертывания и эксплуатации гибридных приложений. Рекомендации помогут оптимизировать разработку гибридных приложений и сократить проблемы в рабочих средах.

## <a name="prerequisites"></a>Предварительные требования

Для создания гибридного конвейера CI/CD требуется несколько компонентов, подготовка которых может занять некоторое время:

 -  Партнер Azure OEM или поставщик оборудования могут развернуть производственный Azure Stack, а все пользователи могут развертывать набор разработки Azure Stack (ASDK).

 -  Оператор Azure Stack также должен развернуть Службу приложений, создать планы и предложения, создать подписку клиента и добавить образ Windows Server 2016.

 -  Нужно настроить гибридную сеть и Службу приложений (см. также статью [об интеграции приложений с виртуальными сетями](https://docs.microsoft.com/azure/app-service/web-sites-integrate-with-vnet)).

 -  Закрытый [агент сборки и выпуска](https://docs.microsoft.com/vsts/pipelines/agents/agents?view=vsts) для интеграции VSTS должен быть настроен перед развертыванием (прежде чем начинать, убедитесь, что все используемые компоненты соответствуют требованиям).

Необходимо иметь знания по Azure и Azure Stack. Чтобы получить дополнительные сведения для начала работы, ознакомьтесь с этими статьями:

 -  [Введение в Azure](https://azure.microsoft.com/overview/what-is-azure/).

 -  [Основные понятия Azure Stack](https://docs.microsoft.com/azure/azure-stack/azure-stack-key-features).

 -  [Руководство по решению гибридной CI/CD в Azure Stack](/azure-stack-solution-pipeline.md).

**Таблицы Azure**

 -  Подписка Azure — создайте [бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

 -  Новый URL-адрес веб-интерфейса, созданный [веб-приложением](https://docs.microsoft.com/azure/app-service/app-service-web-overview) в Azure.

 -  Развертывание [Kubernetes для Службы контейнеров Azure (ACS)](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-solution-template-kubernetes-deploy) в Azure.

 -  Развертывание службы Машинного обучения Azure (предварительная версия) описано в [руководстве из 4 частей](https://docs.microsoft.com/azure/machine-learning/desktop-workbench/tutorial-classifying-iris-part-1).

 -  [Учетная запись](https://docs.microsoft.com/azure/machine-learning/desktop-workbench/experimentation-service-template) службы "Экспериментирование в Машинном обучении Azure".

**Azure Stack**

 -  Используйте систему с Azure Stack или разверните Пакет средств разработки Azure Stack.

    - Инструкции по установке Azure Stack см. в статье [Установка Пакета средств разработки Azure Stack (ASDK)](/articles/azure-stack/asdk/asdk-install).
     - [https://github.com/mattmcspirit/azurestack/blob/master/deployment/ConfigASDK.ps1](https://github.com/mattmcspirit/azurestack/blob/master/deployment/ConfigASDK.ps1) Для завершения этой установки может потребоваться несколько часов.

 -  Развертывание служб PaaS [Службы приложений](https://docs.microsoft.com/azure/azure-stack/azure-stack-app-service-deploy) в Azure Stack

 -  [План и предложения](https://docs.microsoft.com/azure/azure-stack/azure-stack-plan-offer-quota-overview) в среде Azure Stack.

 -  [Подписка клиента](https://docs.microsoft.com/azure/azure-stack/azure-stack-subscribe-plan-provision-vm) в среде Azure Stack.

 -  Образ виртуальной машины Ubuntu Server (доступна в [Azure Stack Marketplace](https://buildazure.com/2016/05/04/azure-marketplace-ubuntu-server-16-04-lts/)), которая будет располагаться в той же подписке клиента в Azure Stack, что и частный агент сборки и виртуальные машины Kubernetes. Если этот образ недоступен, обратитесь к оператору Azure Stack, чтобы добавить его в среду. (Не используйте сборку Ubuntu 18.04, которая пока не поддерживается.)

 -  Веб-приложения в подписке клиента (запишите новый URL-адрес веб-приложения для последующего использования.)

 -  Развертывание виртуальной машины VSTS для частного агента сборки на базе Linux в подписке клиента.

 -  Развертывание [Kubernetes для Службы контейнеров Azure (ACS)](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-solution-template-kubernetes-deploy) в Azure Stack.

**Средства для разработчиков**

 -  [Рабочая область VSTS](https://www.visualstudio.com/docs/setup-admin/team-services/sign-up-for-visual-studio-team-services). Во время процесса регистрации создается проект с именем MyFirstProject.

 -  Установка [Visual Studio 2017](https://docs.microsoft.com/visualstudio/install/install-visual-studio) с настроенным входом в [VSTS](https://www.visualstudio.com/docs/setup-admin/team-services/connect-to-visual-studio-team-services).

 -  [Локальная копия](https://www.visualstudio.com/docs/git/gitquickstart) проекта.

 -  Установка [подсистемы Linux для Windows 10](https://docs.microsoft.com/windows/wsl/install-win10) (чтобы использовать BASH и SSH).

 -  Установка [Docker для ОС Windows](https://download.docker.com/win/stable/Docker%20for%20Windows%20Installer.exe).

 -  Установка [Azure Machine Learning Workbench (предварительная версия)](https://aka.ms/azureml-wb-msi).

 -  Установка среды [Python](https://www.python.org/ftp/python/3.7.0/python-3.7.0rc1-amd64.exe).

**VSTS**.

 -  **Учетная запись VSTS**. Выполните быструю настройку непрерывной интеграции для сборки, тестирования и развертывания. Дополнительные сведения об учетных записях VSTS см. в статье [Quickstart: Create your organization](https://docs.microsoft.com/vsts/accounts/create-account-msa-or-work-student?view=vsts) (Краткое руководство по созданию организации).

 -  **Репозиторий кода**. Используя существующие репозитории кода GitHub, BitBucket, DropBox, One Drive и TFS, платформа VSTS позволяет настроить сразу несколько репозиториев для кода, упрощая конвейер разработки. Дополнительные сведения о репозиториях кода см. в [руководстве по началу работы с Git и VSTS](https://docs.microsoft.com/vsts/git/gitquickstart?view=vsts&tabs=visual-studio).

 -  **Подключение службы.** Подключайте внешние и удаленные службы для выполнения задач тестирования, сборки и (или) развертывания. Дополнительные сведения о подключении служб к VSTS см. в статье [о конечных точках служб для сборки и выпуска](https://docs.microsoft.com/vsts/build-release/concepts/library/service-endpoints?view=vsts).

 -  **Определения сборки.** Определите автоматизированные процедуры сборки и соберите набор задач через каталог задач. Дополнительные сведения об определениях сборки см. в документации [по созданию определений сборки](https://docs.microsoft.com/vsts/build-release/actions/ci-cd-part-1?view=vsts).

 -  **Определения выпуска.** Определите процесс развертывания для коллекции сред, где развернуты артефакты приложения. Дополнительные сведения об определениях выпуска см. в документации [о создании определений выпуска](https://docs.microsoft.com/vsts/build-release/actions/ci-cd-part-1?view=vsts).

 -  **Пул размещенных агентов сборки Linux для VSTS.** Быстро компилируйте, тестируйте и развертывайте приложения с помощью размещенного агента, который администрирует и обслуживает корпорация Майкрософт. Дополнительные сведения о размещенных агентах сборки VSTS см. в документации [по размещенным агентам](https://docs.microsoft.com/vsts/build-release/concepts/agents/hosted?view=vsts).

## <a name="step-1-create-a-storage-account"></a>Шаг 1. Создание учетной записи хранения

создание учетной записи хранения и контейнера для размещения очищенных данных;

1.  Войдите на [*портал Azure*](https://portal.azure.com/).

2.  На портале Azure разверните меню слева, чтобы открыть меню служб, и выберите **Все службы**. Прокрутите вниз до пункта **Хранилище** и выберите **Учетные записи хранения**. В появившемся окне **Учетные записи хранения** выберите **Добавить**.

3.  Введите имя учетной записи хранения.

    > [!Note]  
    > Имя учетной записи хранения должно содержать от 3 до 24 символов и состоять только из цифр и строчных букв. Имя учетной записи хранения должно быть уникальным в Azure. Портал Azure сообщит, если выбранное имя учетной записи хранения уже используется.

4.  Укажите модель развертывания **Resource Manager**.

5.  Выберите тип учетной записи хранения **Общего назначения версии 1**, затем укажите уровень производительности **Стандартный**.

6.  Выберите для учетной записи хранения тип хранилища репликации **GRS**.

7.  Выберите новую подписку учетной записи хранения.

8.  Выберите существующую группу ресурсов или создайте новую.

9.  Выберите географический регион для учетной записи хранения.

10. Щелкните **Create** (Создать), чтобы создать учетную запись хранения.

    ![Alt text](\media\azure-stack-solution-machine-learning\image1.png)

11.  Выберите только что созданную учетную запись хранения.

12.  Щелкните **Большие двоичные объекты**.

    ![Alt text](media\azure-stack-solution-machine-learning\image2.png)

13.  Щелкните **+ Контейнер**, а затем **Контейнер**.

    ![Alt text](media\azure-stack-solution-machine-learning\image3.png)

14.  Присвойте контейнеру имя **uploadeddata** и выберите тип доступа **Контейнер**.

15.  Щелкните **Создать**.

    ![Alt text](media\azure-stack-solution-machine-learning\image4.png)

## <a name="step-2-create-a-data-science-virtual-machine"></a>Шаг 2. Создание виртуальной машины для обработки и анализа данных

Создайте виртуальную машину Ubuntu для обработки и анализа данных (DSVM) на портале Azure.

1.  Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com/).

2.  Щелкните ссылку **+Создать** и выполните поиск по запросу "Виртуальная машина Linux для обработки и анализа данных".

    ![Alt text](media\azure-stack-solution-machine-learning\image5.png)

1.  Выберите из списка **Виртуальная машина для обработки и анализа данных для Linux (Ubuntu)** и следуйте инструкциям на экране, чтобы создать виртуальную машину для обработки и анализа данных.

    ![Alt text](media\azure-stack-solution-machine-learning\image6.png)

> Важно!  
> Для параметра *Тип проверки подлинности* **выберите значение** Пароль**.

Поместите новую DSVM в ту же группу ресурсов, что и созданную учетную запись хранения. Все пограничные объекты машинного обучения развертываются в Azure в этой группе ресурсов.

1.  В разделе "Параметры" настройте дополнительные возможности

    a.  Выберите **учетную запись хранения**, созданную ранее.

    b.  Создайте новые объекты **виртуальной сети**, **подсети** и **общедоступного IP-адреса**. Имена по умолчанию будут создаваться на основе имени группы ресурсов.

    c.  Создайте новую **NSG**, для которой должны автоматически примениться нужные правила.

    d.  В поле **Учетная запись хранения диагностики** выберите созданную ранее учетную запись хранения.

    д.  Примечание: когда для подписки Azure включена и настроена служба AAD, можно включить еще и управляемое удостоверение службы.

2.  Нажмите кнопку **ОК**.

### <a name="connect-to-the-dsvm"></a>Подключение к DSVM

После создания DSVM подключитесь к этой виртуальной машине из подсистемы Windows для Linux.

```Bash  
    ssh <user>@<DSVM Public IP>
```

1.  Введите "YES" (Да), чтобы подтвердить подключение к виртуальной машине.

2.  Введите пароль, созданный для DSVM.

### <a name="update-the-dsvm"></a>Обновление DSVM 

```Bash  
sudo su 
apt-get update 
apt-get -y upgrade 
apt-get -y dist-upgrade 
apt-get -y autoremove
```

## <a name="step-3-deploy-azure-machine-learning-services"></a>Шаг 3. Развертывание Служб машинного обучения Azure

Развертывание в Azure Служб машинного обучения Azure.

Служба "Машинное обучение Microsoft Azure" (предварительная версия) — это полнофункциональное интегрированное решение для расширенной аналитики, обработки и анализа данных. Оно позволяет специалистам по обработке и анализу данных подготавливать данные, разрабатывать эксперименты и развертывать модели в масштабах облака.

В этом разделе объясняется, как выполнить такие задачи:

> [!div class="checklist"]
> - создание учетных записей служб для служб машинного обучения Azure;
> - установка службы Azure Machine Learning Workbench и вход в нее;
> - создание проекта в Workbench;
> - запуск скрипта в этом проекте;
> - получение доступа к интерфейсу командной строки (CLI).

В рамках портфеля Microsoft Azure для служб машинного обучения Azure требуется подписка Azure. Чтобы получить подписку Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

Вам потребуются соответствующие разрешения для создания ресурсов, например групп ресурсов, виртуальных машин и т. д.

Приложение Azure Machine Learning Workbench можно установить только в следующих операционных системах:

 -  Windows 10 или Windows Server 2016;
 -  macOS Sierra или High Sierra.

## <a name="step-4-create-azure-machine-learning-services"></a>Шаг4. Создание Служб машинного обучения Azure

Создание учетных записей Служб машинного обучения Azure.

Учетные записи для Машинного обучения Azure можно подготовить на портале Azure.

1.  Войдите на [портал Azure](https://portal.azure.com/) с учетными данными для нужной подписки Azure. Чтобы получить подписку Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

    ![Alt text](media\azure-stack-solution-machine-learning\image7.png)

1.  Нажмите кнопку **Создать ресурс** (+) в левом верхнем углу окна портала.

    ![Создание ресурса на портале Azure](media\azure-stack-solution-machine-learning\image8.png)

1.  Введите **машинное обучение** в строке поиска. Выберите результат поиска с именем **Экспериментирование в Машинном обучении (Предварительная версия)**.

    ![Поиск в службе "Машинное обучение Azure"](media\azure-stack-solution-machine-learning\image9.png)

1.  В области **Экспериментирование в Машинном обучении** прокрутите до нижней части страницы и выберите **Создать**, чтобы начать определение учетной записи для экспериментирования.

    ![Служба "Экспериментирование в Машинном обучении Azure". Создание учетной записи экспериментирования](media\azure-stack-solution-machine-learning\image10.png)

1.  В области **Экспериментирование в Машинном обучении** настройте учетную запись службы "Экспериментирование в Машинном обучении".

    | Параметр | Предлагаемое значение для руководства | ОПИСАНИЕ |
    |---------------------------------------|----------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | Имя учетной записи Экспериментирования | Уникальное имя | Введите уникальное имя для идентификации учетной записи. Используйте название отдела или проекта, которое лучше всего подходит для этого эксперимента. Имя должно содержать от 2 до 32 алфавитно-цифровых символов и дефис (-). |
    | Подписка | Подписка | Выберите подписку Azure, которую вы хотите использовать для этого эксперимента. Если существует несколько подписок, выберите ту, в которой взимается плата за этот ресурс. |
    | Группа ресурсов | Группа ресурсов | Используйте группу ресурсов, которая есть в подписке или введите имя, чтобы создать группу ресурсов для этой учетной записи экспериментирования. |
    | Расположение | Ближайший к пользователям регион | Выберите ближайшее к пользователям и ресурсам данных расположение. |
    | Число рабочих мест | 2 | Введите число рабочих мест. Узнайте, как [места влияют на цену](https://azure.microsoft.com/pricing/details/machine-learning/).<br><br>В этом кратком руководстве требуются только два рабочих места. Рабочее место можно добавить или удалить на портале Azure. |
    | Учетная запись хранения | Уникальное имя | Выберите **Создать** и укажите имя, чтобы создать [учетную запись хранения Azure](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account?tabs=portal). Имя должно состоять только из буквенно-цифровых символов, и его длина должна находиться в диапазоне от 3 до 24 символов. Кроме того, можно щелкнуть **Использовать существующий** и выбрать из списка имеющуюся учетную запись хранения. Учетная запись хранения является обязательным ресурсом. В ней хранятся артефакты проекта и данные журнала выполнения. |
    | Рабочая область для учетной записи Экспериментирования | IrisGarden<br>(имя, используемое в руководствах) | Введите имя для рабочей области в этой учетной записи. Имя должно содержать от 2 до 32 алфавитно-цифровых символов и дефис (-). Эта рабочая область содержит инструменты для создания, публикации экспериментов и управления ими. |
    | Назначьте владельца рабочей области. | Учетная запись | Выберите свою учетную запись в качестве владельца рабочей области. |
    | Создание учетной записи службы "Управление моделями" | **check** | Создайте учетную запись службы "Управление моделями". Она будет использоваться для развертывания моделей и управления ими в виде служб реального времени. <br><br>Хотя это необязательно, мы рекомендуем создавать учетную запись Управления моделями одновременно с учетной записью Экспериментирования. |
    | Имя учетной записи | Уникальное имя | Выберите уникальное имя для учетной записи Управления моделями. Используйте название отдела или проекта, которое лучше всего подходит для этого эксперимента. Имя должно содержать от 2 до 32 алфавитно-цифровых символов и дефис (-). |
    | Ценовая категория Управления моделями | **Разработка и тестирование** | Щелкните **Ценовая категория не выбрана**, чтобы указать ценовую категорию для учетной записи Управления моделями. Для экономии выберите ценовую категорию DEVTEST, если она доступна в вашей подписке (ограниченная доступность). В противном случае выберите ценовую категорию S1. Нажмите кнопку "Выбрать", чтобы сохранить выбранную ценовую категорию. |
    | Закрепить на панели мониторинга | проверка | Установите флажок **Закрепить на панели мониторинга**, чтобы отслеживать работу учетной записи Экспериментирования в Машинном обучении на странице передней панели мониторинга портала Azure. |

    ![Конфигурация учетной записи службы "Экспериментирование в Машинном обучении"](media\azure-stack-solution-machine-learning\image11.png)

1.  Выберите **Создать**, чтобы начать процесс создания учетной записи службы "Экспериментирование" и учетной записи службы "Управление моделями".

    ![Конфигурация учетной записи службы "Экспериментирование в Машинном обучении"](media\azure-stack-solution-machine-learning\image12.png)

    Создание учетной записи может занять несколько минут. Состояние процесса развертывания можно проверить, выбрав значок уведомлений (колокольчик) на панели инструментов Azure.

    ![Уведомления на портале Azure](media\azure-stack-solution-machine-learning\image13.png)

### <a name="install-and-log-in-to-workbench"></a>Установка Workbench и вход в нее 

Azure Machine Learning Workbench доступна для Windows или macOS. Ознакомьтесь со списком [поддерживаемых платформ](https://docs.microsoft.com/azure/machine-learning/service/quickstart-installation).

**Внимание!** Установка может занять до одного часа.

1.  Скачайте и запустите последний установщик Workbench.

    > [!Important]  
    > Дождитесь, пока установщик полностью скопируется на диск, а затем запустите его из целевого каталога. Не запускайте его сразу из мини-приложения для скачивания в браузере.<br>**В ОС Windows:<br>** a. Скачайте [AmlWorkbenchSetup.msi](https://aka.ms/azureml-wb-msi).<br>b. Дважды щелкните скачанный установщик в проводнике.

1.  Следуйте инструкциям на экране, чтобы выполнить установку.

    **Установка может занять до 30 минут. **
    
    `Windows: C:\\Users\\<user>\\AppData\\Local\\AmlWorkbench`
    
    Программа установки скачает и настроит все необходимые зависимости, например Python, Miniconda и другие связанные библиотеки. Эта установка также включает программу командной строки Azure (Azure CLI), которая работает на всех платформах.

1.  Запустите Workbench, нажав кнопку **Launch Workbench** (Запуск Workbench) на последней странице программы установки.

    Если установщик закрыт, запустите его с помощью ярлыка **Machine Learning Workbench** на рабочем столе.

1.  Выберите **Войти с помощью учетной записи Майкрософт**, чтобы пройти аутентификацию в Azure Machine Learning Workbench. Используйте те же учетные данные, с которыми на портале Azure вы создали учетные записи Экспериментирования и Управления моделями.

    После входа Workbench использует первую учетную запись Экспериментирования, которую найдет в подписках Azure, и отобразит все рабочие области и проекты, связанные с этой учетной записью.

    > [!Tip]  
    > Вы можете переключиться на другую учетную запись Экспериментирования с помощью значка в левом нижнем углу окна приложения Workbench.

### <a name="create-a-new-project-in-workbench"></a>Создание проекта в Workbench

1.  Откройте приложение Azure Machine Learning Workbench и при необходимости выполните вход.

    - В Windows его можно запустить с помощью ярлыка на рабочем столе **Machine Learning Workbench**.

    - В macOS выберите **Azure ML Workbench** на панели запуска.

1.  В области **Проекты** щелкните значок плюса (+), чтобы создать **проект**.

    ![Новая рабочая область](media\azure-stack-solution-machine-learning\image14.png)

1.  Заполните поля форм и нажмите кнопку **Создать**, чтобы создать проект в Workbench.

    | Поле | Предлагаемое значение для руководства | ОПИСАНИЕ |
    |-------------------------------------|------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | Имя проекта | myIris | Введите уникальное имя для идентификации учетной записи. Используйте название отдела или проекта, которое лучше всего подходит для этого эксперимента. Имя должно содержать от 2 до 32 алфавитно-цифровых символов и дефис (-). |
    | каталог проекта; | c:\Temp\ | Укажите каталог, в котором создается проект. |
    | описание проекта; | Не указывайте. | Дополнительное поле, полезное для описания проектов. |
    | Visualstudio.com GIT Repository URL (URL-адрес репозитория Git на сайте Visualstudio.com) | Не указывайте. | Дополнительное поле. Свяжите проект с репозиторием Git в Visual Studio Team Services для системы управления версиями и совместной работы. [Сведения о настройке репозитория](https://docs.microsoft.com/azure/machine-learning/desktop-workbench/using-git-ml-project). |
    | Selected workspace (Выбранная рабочая область) | IrisGarden (если он существует) | Выберите рабочую область, созданную для учетной записи Экспериментирования на портале Azure. <br>В примере для краткого руководства список содержит рабочую область с именем IrisGarden. В других случаях примените рабочую область, имя которой совпадает с именем учетной записи экспериментирования, или любой другой учетной записи. |
    | Шаблон проекта | Classifying Iris (Классификация цветков ириса) | Шаблоны содержат скрипты и данные, которые можно использовать для изучения продукта. Скрипты и данные в этом шаблоне используются для работы с этим кратким руководством и другими руководствами на этом сайте документации. |

    ![Новый проект](media\azure-stack-solution-machine-learning\image15.png)

1.  Новый проект создан. Вместе с ним откроется панель мониторинга. Изучите домашнюю страницу проекта, источники данных, записные книжки и файлы исходного кода.

    ![Открытие проекта](media\azure-stack-solution-machine-learning\image16.png)

### <a name="attach-a-dsvm-compute-target"></a>Подключение целевого объекта вычислений виртуальной машины для обработки и анализа данных

После создания виртуальной машины для обработки и анализа данных ее можно подключить к проекту Машинного обучения Azure.

1.  В приложении Azure ML Workbench запустите интерфейс командной строки Azure ML Workbench, выбрав команды **Файл**->**Открыть PowerShell**

    ![Alt text](media\azure-stack-solution-machine-learning\image17.png)

1.  Когда откроется командная строка PowerShell, введите в ней следующую команду:

    ```PowerShell  
        az login
    ```

1.  Вы увидите такую строку приглашения:

     ![Alt text](media\azure-stack-solution-machine-learning\image18.png)

1.  Перейдите на сайт, который указан в этой строке и введите предоставленный код.

    ![Alt text](media\azure-stack-solution-machine-learning\image19.png)

1.  Выберите "Продолжить" при появлении соответствующего запроса, затем выберите учетную запись Azure, с которой связана учетная запись Экспериментирования в Машинном обучении Azure.

    ![Alt text](media\azure-stack-solution-machine-learning\image20.png)

1.  Интерфейс командной строки Azure Machine Learning Workbench отправит следующее сообщение:

    ![Alt text](media\azure-stack-solution-machine-learning\image21.png)

1.  Получив сообщение об успешном входе в учетную запись Машинного обучения и в рабочую область, подключите DSVM.

    ```PowerShell  
        az ml computetarget attach remotedocker --name <compute target name> --address <ip address or FQDN> --username <admin username> --password <admin password>
    ```

    Появится следующее уведомление:

    ![Alt text](media\azure-stack-solution-machine-learning\image22.png)

    ```PowerShell  
        # prepare the Docker image on the DSVM 
        az ml experiment prepare -c <compute target name>
    ```

Этот процесс может занять некоторое время и автоматически создаст значительный объем текста, поскольку он получает несколько образов docker, регистрирует их и применяет к ним необходимый код и приложения.

Теперь на этой DSVM можно выполнять эксперименты.

### <a name="create-a-data-preparation-package"></a>Создание пакета подготовки данных

Теперь начинайте подготовку данных в Azure Machine Learning Workbench. Каждое преобразование, выполняемое в Workbench, хранится в формате JSON в локальном пакете подготовки данных (файл \*.dprep). Этот пакет подготовки данных является основным контейнером для работы по подготовке данных в Workbench.

Пакет подготовки данных можно позднее передать в среду выполнения (например, local-C\#/CoreCLR, Scala/Spark или Scala/HDI).

1.  Щелкните значок папки, чтобы открыть представление "Файлы", а затем откройте файл **iris.csv**.

    В этом файле содержится таблица с 5 столбцами и 50 строками. Четыре столбца являются числовыми столбцами признаков. Пятый столбец является строковым целевым столбцом. Ни один из столбцов не имеет имен заголовков.

    ![iris.csv](media\azure-stack-solution-machine-learning\image23.png)

1.  В **представлении данных** щелкните значок плюса (**+**), чтобы добавить новый источник данных. Откроется страница **Добавление источника данных**.

    ![Представление данных в Azure Machine Learning Workbench](media\azure-stack-solution-machine-learning\image24.png)

1.  Выберите **Текстовые файлы (\*.csv, \*.json, \*.txt., ...)**.

    ![Источник данных в Azure Machine Learning Workbench](media\azure-stack-solution-machine-learning\image25.png)

1.  Щелкните **Далее**.

2.  Перейдите к файлу **iris.csv** и щелкните **Готово**. В результате для таких параметров, как разделитель и типы данных, будут использоваться значения по умолчанию.

    > [!Important]  
    > Выберите файл **iris.csv** из текущего каталога проекта для этого упражнения. Иначе последующие шаги могут завершиться ошибкой.

    ![Выбор файла iris](media\azure-stack-solution-machine-learning\image26.png)

1.  Создается файл с именем `*iris-1.dsource`. Файлу присвоено уникальное имя с постфиксом `-1`, так как в примере проекта уже есть ненумерованный файл **iris.dsource**.

    Откроется файл, и отобразятся данные. Набор заголовков столбцов от **Column1** до **Column5** добавляется в этот набор данных автоматически. Прокрутите страницу вниз и убедитесь, что последняя строка набора данных пуста. Эта пустая строка создается из-за лишнего разрыва строки в CSV-файле.

    ![Представление данных iris](media\azure-stack-solution-machine-learning\image27.png)

1.  Нажмите кнопку **Метрики**. Гистограммы будут созданы и отобразятся на экране.

    Переключитесь обратно в представление данных, нажав кнопку **Данные**.

    ![Представление данных iris](media\azure-stack-solution-machine-learning\image28.png)

1.  Просмотрите гистограммы. Для каждого столбца вычислен полный набор статистических данных.

    ![Представление данных iris](media\azure-stack-solution-machine-learning\image29.png)

1.  Чтобы приступить к созданию пакета подготовки данных, нажмите кнопку **Подготовка**. Откроется диалоговое окно **Подготовка**.

    Пример проекта содержит файл подготовки данных **iris.dprep**, выбранный по умолчанию.

    ![Представление данных iris](media\azure-stack-solution-machine-learning\image30.png)

1.  Создайте пакет подготовки данных, выбрав в меню элемент **+ New Data Preparation Package** (+ Создать пакет подготовки данных).

    ![Представление данных iris](media\azure-stack-solution-machine-learning\image31.png)

1.  Введите новое значение для имени пакета (используйте **iris-1**) и нажмите кнопку **ОК**.

    Будет создан пакет подготовки данных с именем **iris-1.dprep**, который откроется в редакторе подготовки данных.

    ![Представление данных iris](media\azure-stack-solution-machine-learning\image32.png)

    Теперь нужно выполнить подготовку данных.

1.  Выбирайте заголовок каждого столбца, чтобы редактировать текст заголовка. Затем переименуйте каждый столбец следующим образом:

    Введите значения **длины чашелистика**, **ширины чашелистика**, **длины лепестка**, **ширины лепестка** и **видов цветов** в соответствующих столбцах.

    ![Переименование столбцов](media\azure-stack-solution-machine-learning\image33.png)

1.  Посчитайте разные значения:

    1.  Выберите столбец **Виды цветов**.

    2.  Щелкните его правой кнопкой мыши.

    3.  В меню выберите пункт **Число значений**.

        Откроется панель **инспекторов**, расположенная под данными. Отобразится гистограмма с четырьмя полосами. Целевой столбец имеет четыре разных значения: **Iris_virginica**, **Iris_versicolor**, **Iris-setosa**и **(null)**.

    ![Выбор числа значений](media\azure-stack-solution-machine-learning\image34.png)

    ![Гистограмма "Число значений"](media\azure-stack-solution-machine-learning\image35.png)

1.  Чтобы отфильтровать значения null, выберите строку "(null)" и значок минуса (**-**).

    Затем строка (null) станет серого цвета, указывая, что она была отфильтрована.

    ![Фильтрация значений null](media\azure-stack-solution-machine-learning\image36.png)

1.  Обратите внимание на отдельные шаги по подготовке данных, которые описаны в области **Шаги**. Когда вы переименовывали столбцы и фильтровали строки со значением null, все эти действия записывались в этап подготовки данных. Вы можете изменить любой из этих шагов, в том числе настроить параметры, изменить порядок действий или удалить некоторые шаги.

    ![Alt text](media\azure-stack-solution-machine-learning\image37.png)

1.  Закройте редактор подготовки данных. Выберите значок **x** на вкладке **iris-1** со значком графика, чтобы закрыть вкладку. Изменения будут автоматически сохранены в файле **iris-1.dprep**, который отображается под заголовком **Data Preparations** (Подготовка данных).

    ![закройте](media\azure-stack-solution-machine-learning\image38.png)

### <a name="generate-python-code-to-invoke-a-data-preparation-package"></a>Создание кода Python для вызова пакета подготовки данных

Выходные данные пакета подготовки данных можно использовать непосредственно в записной книжке Python или Jupyter. Пакеты можно выполнять в разных средах выполнения, например в локальных средах Python, Spark (в том числе в Docker) и HDInsight.

1.  Найдите файл **iris 1.dprep** на вкладке "Подготовка данных".

2.  Щелкните файл **iris-1.dprep** правой кнопкой мыши и выберите пункт **Generate Data Access Code File** (Создать файл с кодом доступа к данным) из контекстного меню.

    ![Создание кода](media\azure-stack-solution-machine-learning\image39.png)

    Откроется новый файл с именем **iris-1.py** со следующими строками кода, который вызывают логику, созданную в виде пакета подготовки данных:

    ```Python
    # Use the Azure Machine Learning data preparation package
    from azureml.dataprep import package

    # Use the Azure Machine Learning data collector to log various metrics
    from azureml.logging import get_azureml_logger
    logger = get_azureml_logger()

    # This call will load the referenced package and return a DataFrame.
    # If run in a PySpark environment, this call returns a
    # Spark DataFrame. If not, it will return a Pandas DataFrame.
    df = package.run('iris-1.dprep', dataflow_idx=0)
    # Remove this line and add code that uses the DataFrame
    df.head(10)
    ```

    В зависимости от контекста выполнения кода параметр drep представляет разные виды кадров данных.

    -  При выполнении в среде выполнения Python используется [кадр данных pandas](https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.html).

    -  При выполнении контекста Spark используется [кадр данных Spark](https://spark.apache.org/docs/latest/sql-programming-guide.html).

### <a name="review-irissklearnpy-and-the-configuration-files"></a>Просмотр файлов конфигурации и файла iris_sklearn.py

1.  Открыв проект, нажмите кнопку **Файлы** (значок папки) на крайней левой панели, чтобы открыть список файлов в папке проекта.

    ![Открытие проекта в Azure Machine Learning Workbench](media\azure-stack-solution-machine-learning\image40.png)

1.  Выберите файл сценария Python **iris_sklearn.py**.

    ![Выбор сценария](media\azure-stack-solution-machine-learning\image41.png)

    На новой вкладке текстового редактора в Workbench откроется код.

    > [!Note]  
    > Отображаемый код может не совпадать с кодом на снимке экрана выше, так как пример проекта постоянно обновляется.

    ![Открытие файла](media\azure-stack-solution-machine-learning\image42.png)

1.  Проверьте код скрипта Python, чтобы ознакомиться со стилем программирования.

    Скрипт **iris_sklearn.py** выполняет следующие задачи.  

    -  Загружает пакет подготовки данных по умолчанию с именем **iris.dprep** для создания [pandas DataFrame](https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.html).

    -   Добавляет случайные компоненты, чтобы усложнить задачу. Случайность необходима, так как "Ирисы Фишера" — это небольшой набор данных, который можно легко классифицировать почти со 100 %-й точностью.

    -  Использует библиотеку машинного обучения scikit-learn, чтобы создать модель логистической регрессии. Эта библиотека поставляется с Azure Machine Learning Workbench по умолчанию.

    -  Сериализует модель путем вставки библиотеки [pickle](https://docs.python.org/3/library/pickle.html) в файл в папке `outputs`.

    -  Загружает сериализованную модель, а затем десериализирует ее обратно во временную память.

    -  Использует десериализованную модель для прогнозирования на основе новой записи.

    -  Отображает два графика, матрицу неточностей и многоклассовую кривую рабочих характеристик приемника (ROC) с помощью библиотеки [matplotlib](https://matplotlib.org/), а затем сохраняет их в папку outputs. Установите эту библиотеку в среде, если ее еще нет.

    -  Автоматически отображает графики скорости регуляризации и точности модели в журнале выполнения. Объект `run_logger` используется во всех операциях для записи коэффициента регуляризации и точности модели в журналы.

### <a name="run-irissklearnpy-in-the-local-environment"></a>Запуск файла iris_sklearn.py в локальной среде

1.  Запустите интерфейс командной строки (CLI) службы "Машинное обучение Azure".

    1.  Запустите Azure Machine Learning Workbench.

    2.  В меню Workbench выберите **Файл**> **Open Command Prompt** (Открыть командную строку).

    Окно интерфейса командной строки Машинного обучения Azure запускается в папке проекта `C:\Temp\\myIris\` в Windows. Это тот же проект, который вы создали в первой части этого руководства.

    > [!Important]  
    > В окне CLI выполните следующие действия.

1.  Установите в окне интерфейса командной строки библиотеку построения Python **matplotlib**, если она еще не установлена.

    Скрипт **iris_sklearn.py** имеет зависимости от двух пакетов Python (**scikit-learn** и **matplotlib**). Azure Machine Learning Workbench устанавливает для удобства пакет **scikit-learn**. Но может потребоваться и установка **matplotlib**.

    Если продолжить работу, не установив **matplotlib**, код в этом руководстве может выполняться успешно. Тем не менее код не сможет создать выходные данные матрицы неточностей и графики многоклассовой кривой ROC, как показано в визуализациях журнала.

    ```CLI
    pip install matplotlib
    python -m pip install --upgrade pip
    ```

    Процесс установки может занять около минуты.

1.  Вернитесь к приложению Workbench.

2.  Найдите вкладку с именем **iris_sklearn.py**.

    ![Поиск вкладки со скриптом](media\azure-stack-solution-machine-learning\image43.png)

1.  На панели инструментов этой вкладки выберите **локальную** среду выполнения и andiris_sklearn.pyas в качестве скрипта для выполнения. Эти параметры могут быть уже выбранными.

    ![Alt text](media\azure-stack-solution-machine-learning\image44.png)

1.  Перейдите к правой части панели инструментов и введите 0.01 в поле **Аргументы**.

    Это значение соответствует коэффициенту регуляризации для модели логистической регрессии.

    ![Выбор локальной среды и скрипта](media\azure-stack-solution-machine-learning\image45.png)

1.  Нажмите кнопку **Запустить**. Будет запланировано выполнение задания. Задания перечислены на панели **Задания** с правой стороны окна Workbench.

    ![Выбор локальной среды и скрипта](media\azure-stack-solution-machine-learning\image46.png)

    Через несколько секунд состояние задания изменится с **Отправка** на **Выполнение**, а затем — на **Завершено**.

1.  Выберите **Завершено** в тексте состояния задания на панели **Задания**.

    ![Запуск sklearn](media\azure-stack-solution-machine-learning\image47.png)

    Откроется всплывающее окно, отображающее текст стандартного потока вывода (stdout) этого запуска. Чтобы закрыть текст stdout, нажмите кнопку **Закрыть** (**x**) в правом верхнем углу всплывающего окна.

    ![Стандартные выходные данные](media\azure-stack-solution-machine-learning\image48.png)

1.  В том же состоянии задания на панели **Задания** выберите синий текст **iris_sklearn.py \[n\] **(* где n — это номер запуска) над разделом с состоянием **Завершено** и временем начала. Откроется окно **свойств запуска**, в котором отобразятся следующие сведения об этом запуске:

    -  сведения о **свойствах запуска**;

    -  **Outputs**

    -  **Метрики**

    -  **визуализации** (если есть);

    -  **Журналы**

    По завершении запуска во всплывающем окне отобразятся следующие результаты:

    > [!Note]  
    > Так как выше в этом руководстве вы включили случайный выбор компонентов в набор для обучения, ваши результаты могут отличаться от приведенных здесь.

    ```Python  
        Python version: 3.5.2 |Continuum Analytics, Inc.| (default, Jul  5 2016, 11:41:13) [MSC v.1900 64 bit (AMD64)]

        Iris dataset shape: (150, 5)
        Regularization rate is 0.01
        LogisticRegression(C=100.0, class_weight=None, dual=False, fit_intercept=True,
            intercept_scaling=1, max_iter=100, multi_class='ovr', n_jobs=1,
            penalty='l2', random_state=None, solver='liblinear', tol=0.0001,
            verbose=0, warm_start=False)
        Accuracy is 0.6792452830188679

        ==========================================
        Serialize and deserialize using the outputs folder.

        Export the model to model.pkl
        Import the model from model.pkl
        New sample: [[3.0, 3.6, 1.3, 0.25]]
        Predicted class is ['Iris-setosa']
        Plotting confusion matrix...
        Confusion matrix in text:
        [[50  0  0]
        [ 1 37 12]
        [ 0  4 46]]
        Confusion matrix plotted.
        Plotting ROC curve....

        ROC curve plotted.
        Confusion matrix and ROC curve plotted. See them in Run History details pane.

    ```

1.  Закройте вкладку **свойств запуска** и вернитесь на вкладку **iris_sklearn.py**.

1.  Повторите для дополнительных запусков.

Введите ряд значений в поле **Аргументы** в диапазоне от `0.001` до `10`. Нажмите кнопку **Запустить**, чтобы запустить код еще несколько раз. Значение аргумента, который вы каждый раз меняете, в коде передается модели логистической регрессии, в результате чего вы каждый раз получаете разные результаты.

### <a name="review-the-run-history-in-detail"></a>Подробный просмотр журнала выполнения

В Azure Machine Learning Workbench каждое выполнение скрипта записывается в журнале выполнения. Вы можете просмотреть журнал выполнения для определенного скрипта, открыв представление **Запуски**.

1.  Нажмите кнопку **Запуски** (значок часов) на панели инструментов слева, чтобы открыть список **Запуски**. Затем выберите **iris_sklearn.py**, чтобы отобразить **панель мониторинга запусков** для iris_sklearn.py.

    ![Представление "Запуски"](media\azure-stack-solution-machine-learning\image49.png)

1.  Откроется вкладка **Панель мониторинга запусков**.

    Просмотрите статистику, записанную для нескольких запусков. Графики отображаются в верхней части вкладки. Каждому запуску присвоен порядковый номер, а сведения о запуске отображаются в таблице в нижней части экрана.

    ![Панель мониторинга запуска](media\azure-stack-solution-machine-learning\image50.png)

1.  Отфильтруйте таблицу. Затем выберите любой из графиков, чтобы просмотреть состояние, длительность, точность и частоту регуляризации для каждого запуска.

2.  Установите флажки рядом с двумя или несколькими выполнениями в таблице **Запуски**. Нажмите кнопку **Сравнить**, чтобы открыть панель подробного сравнения. Сравните результаты.

3.  Чтобы вернуться к разделу **Run Dashboard** (Панель мониторинга запусков), нажмите кнопку **Список запуска** со стрелкой назад в верхней левой части панели **Comparison** (Сравнение).

    ![Возвращение к списку запусков](media\azure-stack-solution-machine-learning\image51.png)

1.  Выберите отдельный запуск, чтобы просмотреть подробные сведения о запуске. Обратите внимание: статистика для выбранного запуска доступна в разделе **Свойства запуска**. Файлы, записанные в выходную папку, перечислены в разделе **Выходные данные**, где их можно скачать.

    ![Сведения о запуске](media\azure-stack-solution-machine-learning\image52.png)

Два графика, матрица неточностей и многоклассовая кривая ROC отображаются в разделе **Визуализации**. Все файлы журнала также доступны в разделе **Журналы**.

### <a name="run-scripts-in-the-azure-machine-learning-ml-workbench-cli-window"></a>Выполнение скриптов в локальном окне Azure Machine Learning Workbench CLI

1.  Запустите интерфейс командной строки (CLI) службы "Машинное обучение Azure".

    1.  Запустите Azure Machine Learning Workbench.

    2.  В меню Workbench выберите **Файл** > **Open Command Prompt** (Открыть командную строку).

    Командная строка запускается в папке проекта `C:\\Temp\\myIris` в Windows. Это тот же проект, который вы создали в первой части этого руководства.

    > [!Important]  
    > В окне CLI выполните следующие действия.

1.  В окне CLI войдите в Azure. [Подробнее о команде az login](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest).

    Этот шаг можно пропустить, если вы уже вошли в систему.

1.  В командной строке введите:

    ```CLI
        az login
    ```

    Эта команда возвращает код, который можно ввести в браузере на сайте [https://aka.ms/devicelogin](https://aka.ms/devicelogin).

1.  Перейдите в браузере по адресу [https://aka.ms/devicelogin](https://aka.ms/devicelogin). Введите код, который вы получили в интерфейсе командной строки.

    Приложение Workbench и CLI используют независимые кэши учетных данных для доступа к ресурсам Azure. Повторная аутентификация не требуется, пока не истечет срок действия кэшированного маркера.

1.  Если у организации есть несколько подписок Azure (корпоративная среда), укажите используемую подписку. Найдите подписку, настройте ее идентификатор и проверьте работу.

1.  Список всех подписок Azure, к которым осуществляется доступ, можно получить с помощью следующей команды:

    ```CLI
        az account list -o table 
    ```

    Команда **az account list** возвращает список доступных подписок для вашего имени входа. Если таких подписок несколько, найдите значение идентификатора для используемой подписки.

1.  Задайте подписку Azure, которую вы хотите использовать в качестве учетной записи по умолчанию:

    ```CLI
        az account set -s <the-subscription-id
    ```

    где <your-subscription-i> — это значение идентификатора используемой подписки. Не используйте квадратные скобки.

1.  Подтвердите новые параметры подписки, отправив запрос на получение сведений о текущей подписке.

    ```CLI
        az account show
    ```

1.  В окне CLI отправьте скрипт **iris_sklearn.py** в качестве эксперимента.

    Начнется выполнение iris_sklearn.py в локальном контексте вычислений.

1.  Действия для ОС Windows.

    ```CLI
        az ml experiment submit -c local .\\iris_sklearn.py
    ```

1.  Действия для MacOS.

    ```CLI
        az ml experiment submit -c local iris_sklearn.py
    ```

    Вы должны получить примерно такой результат: 

    ```
        RunId: myIris_1521077190506

    Executing user inputs .....
    ===========================

    Python version: 3.5.2 |Continuum Analytics, Inc.| (default, Jul  2 2016, 17:52:12) 
    [GCC 4.2.1 Compatible Apple LLVM 4.2 (clang-425.0.28)]

    Iris dataset shape: (150, 5)
    Regularization rate is 0.01
    LogisticRegression(C=100.0, class_weight=None, dual=False, fit_intercept=True,
            intercept_scaling=1, max_iter=100, multi_class='ovr', n_jobs=1,
            penalty='l2', random_state=None, solver='liblinear', tol=0.0001,
            verbose=0, warm_start=False)
    Accuracy is 0.6792452830188679

    ==========================================
    Serialize and deserialize using the outputs folder.

    Export the model to model.pkl
    Import the model from model.pkl
    New sample: [[3.0, 3.6, 1.3, 0.25]]
    Predicted class is ['Iris-setosa']
    Plotting confusion matrix...
    Confusion matrix in text:
    [[50  0  0]
    [ 1 37 12]
    [ 0  4 46]]
    Confusion matrix plotted.
    Plotting ROC curve....
    ROC curve plotted.
    Confusion matrix and ROC curve plotted. See them in Run History details page.

    Execution Details
    =================
    RunId: myIris_1521077190506

    ```

6.  Просмотрите выходные данные. Все выходные данные и результаты должны быть такими же, как при выполнении скрипта из Workbench.

7.  Вернитесь к Workbench и сделайте следующее.

    Выберите значок папки на левой панели, чтобы вывести список файлов проекта.  Откройте скрипт Python с именем **run.py**. Этот скрипт удобен для циклического перебора разных частот регуляризации. 

    ![Возвращение к списку запусков](media\azure-stack-solution-machine-learning\image53.png)

1.  Запустите эксперимент несколько раз с разной частотой.

    Этот скрипт запускает ` aniris_sklearn.pyjob` с частотой регуляризации `10.0` (чрезмерно большое число). Для следующего запуска скрипт сокращает частоту наполовину и продолжает это делать, пока значение не окажется менее `0.005`. Скрипт содержит следующий код:

    ![Возвращение к списку запусков](media\azure-stack-solution-machine-learning\image54.png)

1.  Запустите скрипт **run.py** из командной строки следующим образом.

    ```CLI
        python run.py
    ```
Эта команда отправляет `iris_sklearn.py` несколько раз с разной частотой регуляризации.

Когда `run.py` завершит выполнение, Workbench отобразит графики разных метрик в представлении списка журнала выполнения.

### <a name="run-scripts-in-an-ubuntu-based-data-science-virtual-machine-dsvm-on-azure"></a>Запуск скриптов на виртуальной машине Ubuntu для обработки и анализа данных (DSVM) в Azure

Чтобы выполнить скрипт в контейнере Docker на удаленном компьютере Linux, необходимо иметь доступ SSH (имя пользователя и пароль) для запуска этого компьютера. Кроме того, на удаленном компьютере должна быть установлена и запущена подсистема Docker.

1.  Измените созданный файл <your DSVM Name>.runconfig в папке aml_config и измените значение платформы по умолчанию PySparktoPython:

    ```yaml  
    Framework: Python
    ```
1.  Выполните в окне CLI ту же команду, что и ранее, только на этот раз используйте target*<DSVM>* для выполнения iris_sklearn.py в удаленном контейнере Docker (замените <DSVM> именем виртуальной машины для обработки и анализа данных без скобок):

    ```CLI
        az ml experiment submit -c <DSVM> iris_sklearn.py
    ```

Эта команда выполняется так же, как в среде docker-python, но на удаленной виртуальной машине Linux. Окно CLI отображает те же выходные данные.

### <a name="download-the-model-pickle-file"></a>Загрузка файла, содержащего модель

В предыдущей части этого руководства мы локально выполнили скрипт **iris_sklearn.py** в Machine Learning Workbench. При помощи этого скрипта была сериализована модель логистической регрессии с использованием популярного пакета Python [pickle](https://docs.python.org/3/library/pickle.html) для сериализации объектов.

1.  Откройте приложение Azure Machine Learning Workbench. Затем откройте проект **myIris**, созданный в предыдущих частях этой серии руководств.

2.  Открыв проект, нажмите кнопку **Файлы** на панели слева, чтобы в папке проекта отобразился список файлов.

3.  Выберите файл **iris_sklearn.py**. На новой вкладке текстового редактора в Workbench откроется код Python.

4.  Просмотрите **iris_sklearn.py** файл и найдите, где создан сериализованный файл. При помощи сочетания клавиш CTRL+F откройте диалоговое окно **поиска**. Затем найдите в коде Python слово **pickle**.

Этот фрагмент кода показывает, как создан сериализованный выходной файл. Выходной файл на диске называется **model.pkl**.

    ```Python
        print("Export the model to model.pkl")
        f = open('./outputs/model.pkl', 'wb')
        pickle.dump(clf1, f)
        f.close()

    ```

1.  Найдите сериализованный файл модели в списке выходных файлов последнего запуска.

    Когда выполняется скрипт **iris_sklearn.py**, файл модели сохраняется в папке **outputs** с именем **model.pkl**. Эта папка находится в среде выполнения, выбранной для запуска скрипта, а не в локальной папке проекта. 

    1. Чтобы найти этот файл, нажмите кнопку **Запуски** (значок часов) на панели слева, которая отображает спи сок **Все запуски**.  

    2. Откроется вкладка **Все запуски**. В таблице запусков выберите один из последних запусков, для которого были указаны целевой объект **local** (локально) и имя сценария **iris_sklearn.py**.  

    3. Откроется панель **свойств запуска**. В верхней правой части этой панели вы увидите раздел **Выходные данные**. d\. Чтобы скачать сериализованный файл, установите флажок рядом с файлом **model.pkl** и щелкните **Загрузить**. Сохраните файл в корневую папку проекта. Этот файл потребуется при выполнении дальнейших действий.  

    ![Загрузка сериализованного файла](media\azure-stack-solution-machine-learning\image55.png)

### <a name="get-scoring-script-and-schema-files"></a>Получение скрипта оценки и файлов схемы

Чтобы развернуть веб-службу и файл модели, нам потребуется скрипт оценки. Вместо него можно использовать схему для входных данных веб-службы. Скрипт оценки загружает файл **model.pkl** из текущей папки и использует его для создания новых прогнозов.

1.  Откройте приложение Azure Machine Learning Workbench. Затем откройте проект **myIris**, созданный в предыдущей части этой серии руководств.

2.  Открыв проект, нажмите кнопку **Файлы** на панели слева, чтобы в папке проекта отобразился список файлов.

3.  Выберите файл **score_iris.py**. Откроется скрипт Python. Этот файл используется как файл оценки.

    ![Файл оценки](media\azure-stack-solution-machine-learning\image56.png)

1.  Чтобы получить файл схемы, запустите этот скрипт. Выберите на панели команд среду **local** (локальная) и скрипт **score_iris.py**, а затем выберите **Запустить**.

    При помощи этого скрипта разделе **Выходные данные** создается JSON-файл со схемой входных данных для нашей модели.

1.  Обратите внимание на панель **Задания** справа на **панели мониторинга проекта**. Подождите, пока для состояния последнего задания **score_iris.py** не отобразится надпись **Выполнено** зеленого цвета. После этого перейдите по гиперссылке **score_iris.py** рядом с данными последнего запуска задания, чтобы просмотреть сведения.

2.  На панели **свойств запуска** в разделе **Выходные данные** выберите только что созданный файл **service_schema.json**. Установите флажок рядом с именем файла и выберите **Загрузить**. Сохраните этот файл в корневой папке проекта.

3.  Вернитесь к предыдущей вкладке со скриптом **score_iris.py**. Использование коллекции данных позволяет сохранять входные данные модели и прогнозы веб-службы. Для сбора данных важное значение имеют следующие этапы.

4.  Изучите в начале этого файла код, который импортирует класс **ModelDataCollector**. Он содержит функции сбора данных для модели:

    ```Python  
        from azureml.datacollector import ModelDataCollector
    ```

1.  Изучите следующий код функции **init()**, при помощи которого создается **ModelDataCollector**:

    ```Python  
        global inputs_dc, prediction_dc
        inputs_dc = ModelDataCollector('model.pkl',identifier="inputs")
        prediction_dc = ModelDataCollector('model.pkl', identifier="prediction")
    ```

1.  Изучите приведенный ниже код функции **run(input_df)**, предназначенный для сбора входных данных и прогнозов:

    ```Python  
        inputs_dc.collect(input_df)
        prediction_dc.collect(pred)
    ```

Теперь подготовьте среду для ввода модели в эксплуатацию.

## <a name="step-5-deploy-and-use-azure-container-registry"></a>Шаг 5. Развертывание и использование реестра контейнеров Azure

Развертывание реестра контейнеров Azure и его использование.

Создайте реестр контейнеров Azure с помощью команды**az acr create**. Имя реестра должно быть уникальным в пределах Azure и содержать от 5 до 50 буквенно-цифровых символов. Группа ресурсов остается той же.

    ```CLI
        az acr create --resource-group <ResourceGroup> --name  <acrName> --sku Basic
    ```

### <a name="container-registry-login"></a>Вход в реестр контейнеров

Выполните команду **az acr login**, чтобы войти в экземпляр ACR. Укажите уникальное имя реестра контейнеров, заданное при его создании.

    ```CLI
        az acr login --name <acrName>
    ```

После выполнения эта команда возвращает сообщение "Login Succeeded" (Вход выполнен).

### <a name="prepare-to-operationalize-locally-for-development-and-testing-the-service"></a>Подготовка к локальному вводу в эксплуатацию для разработки и тестирования службы

Используйте развертывание в *локальном режиме*, чтобы запустить контейнер Docker на локальном компьютере, например для разработки и тестирования.

Локально запущенная подсистема Docker потребуется, чтобы выполнить следующие действия. Для отображения соответствующего сообщения справки в конце каждой команды можно использовать флаг `-h`.

    > [!Note]  
    > If Docker engine is not locally available, proceed by creating a cluster in Azure for deployment and keep the cluster for re-use, or delete it after the tutorial to avoid ongoing charges.

    > [!Note]  
    > Web services deployed locally do not appear in Azure Portal's list of services. They will be running in Docker on the local machine.

1.  Откройте интерфейс командной строки (CLI). В приложении Machine Learning Workbench в меню **Файл** выберите **Open Command Prompt** (Открыть командную строку).

    Откроется окно командной строки, где текущим каталогом будет папка проекта **c:\\temp\\myIris**.

1.  Убедитесь, что поставщик ресурсов Azure **Microsoft.ContainerRegistry** зарегистрирован в вашей подписке. Зарегистрировать этот поставщик ресурсов нужно до создания среды на шаге 3. С помощью следующей команды вы можете проверить, зарегистрирован ли он:

    ```CLI
        az provider list --query "\[\].{Provider:namespace, Status:registrationState}" --out table
    ```

    Проверьте эти выходные данные:

    ```CLI
        Provider                                    Status 
        --------                                    --------
        Microsoft.Authorization                     Registered 
        Microsoft.ContainerRegistry                 Registered 
        microsoft.insights                          Registered 
        Microsoft.MachineLearningExperimentation    Registered 
    ```

    Если **Microsoft.ContainerRegistry** не зарегистрирован, используйте эту команду:

    ```CLI
    az provider register --namespace Microsoft.ContainerRegistry
    ```

    Регистрация может занять несколько минут. Состояние регистрации можно проверить с помощью команды **az provider list** или следующей команды:

    ```CLI
    az provider show -n Microsoft.ContainerRegistry
    ```

    В третьей строке выходных данных отображается статус регистрации: **"registrationState": "Registering"**. Подождите немного и повторяйте команду **show**, пока в выходных данных не отобразится состояние **"registrationState": "Registered"**.

1.  Создайте среду. Этот шаг выполняется однократно для каждой среды.

    Для следующей команды установки требуется разрешение на доступ к подписке уровня участника. Нужен доступ с правами участника к группе ресурсов, в которую выполняется развертывание. Укажите имя группы ресурсов в строке команды установки с помощью флага -g.

    ```CLI
    az ml env setup -n <new deployment environment name> --location <e.g. eastus2> -g <existing resource group name>
    ```

    Следуйте инструкциям на экране, чтобы подготовить учетную запись хранения для образов Docker, реестр контейнеров Azure для списка образов Docker и учетную запись Azure Application Insights для сбора данных телеметрии. **При использовании выключателя -c команда дополнительно создаст кластер службы контейнеров**.

    Среду можно определить по имени кластера. Расположение должно совпадать с тем, которое указывалось при создании учетной записи Управления моделями на портале Azure.

    Чтобы убедиться, что эта среда настроена успешно, выполните следующую команду для проверки состояния.

    ```CLI
    az ml env show -n <deployment environment name> -g <existing resource group name>
    ```

    У параметра "Состояние подготовки" должно быть значение Succeeded (Успешно) (как показано ниже). Проверьте это, прежде чем продолжать настройку среды на шаге 5.

    ![Состояние подготовки](media\azure-stack-solution-machine-learning\image57.png)

1.  Настройте среду.

    После установки с помощью приведенной ниже команды задайте переменные среды, которые нужны для ее ввода в эксплуатацию. Используйте то же имя среды, что и на шаге 3 ранее. После установки используйте имя группы ресурсов, которое отображалось в окне команды.

    ```CLI
        az ml env set -n <deployment environment name> -g <existing resource group name>
    ```

1.  Чтобы проверить, правильно ли настроена среда реализации для локального развертывания веб-службы, введите следующую команду:

    ```CLI
    az ml env show
    ```

    Теперь создайте веб-службу в режиме реального времени.

    > [!Note]  
    > Учетную запись и среду Управления моделями можно повторно использовать для последующего развертывания веб-служб. Не нужно создавать их для каждой веб-службы. С учетной записью или средой может быть связано несколько веб-служб.

### <a name="create-a-real-time-web-service-by-using-separate-commands"></a>Создание веб-службы в режиме реального времени с помощью отдельных команд

Вместо представленной выше команды **az ml service create realtime** можно выполнить эти шаги по отдельности.

Сначала зарегистрируйте модель. Затем создайте манифест, соберите образ Docker и создайте веб-службу. Этот пошаговый подход предоставляет больше гибкости. Кроме того, можно повторно использовать созданные на предыдущих шагах сущности.

1. Зарегистрируйте модель, указав имя сериализованного файла.

    ```CLI
    az ml model register --model model.pkl --name model.pkl
    ```

    После выполнения этой команды вы получите идентификатор модели.

2.  Создайте манифест.

    Чтобы создать манифест, используйте следующую команду с идентификатором модели, полученным на предыдущем этапе: 
    
    ```CLI
    az ml manifest create --manifest-name <new manifest name> -f score_iris.py -r python -i <model ID> -s service_schema.json
    ```

    После выполнения этой команды вы получите идентификатор манифеста.

3.  Создайте образ Docker.

    Чтобы создать образ Docker, используйте следующую команду с идентификатором манифеста, полученным на предыдущем этапе. Также можно применить зависимости conda с помощью параметра `-c`. 
    
    ```CLI
    az ml image create -n irisimage --manifest-id <manifest ID> -c aml_config\conda_dependencies.yml
    ```
    
    После выполнения этой команды вы получите идентификатор образа Docker.

2.  Создайте службу.

    Чтобы создать службу, используйте следующую команду с идентификатором образа, полученным на предыдущем этапе: 
    
    ```CLI
    az ml service create realtime --image-id <image ID> -n irisapp --collect-model-data true
    ```
    
    После выполнения этой команды вы получите идентификатор веб-службы.
    
    И наконец, запустите веб-службу.

## <a name="step-6-deploy-a-kubernetes-cluster-to-azure-stack"></a>Шаг 6. Развертывание кластера Kubernetes в Azure Stack

Развертывание кластера Kubernetes в Azure Stack.

Kubernetes можно установить с помощью шаблонов Azure Resource Manager, созданных модулем службы контейнеров Azure в Azure Stack. [*Kubernetes*](https://kubernetes.io/) — это система с открытым кодом для автоматизации развертывания, масштабирования и управления приложениями в контейнерах. [*Контейнер*](https://www.docker.com/what-container) содержится в образе наподобие виртуальной машины. В отличие от виртуальной машины, в образ контейнера помещены ресурсы, необходимые только для запуска приложения, например код, среда выполнения для этого кода, определенные библиотеки и параметры.

Kubernetes можно использовать для следующих целей:

 -  Разработка обновляемых приложений с высокой масштабируемостью, которые можно развернуть в считаные секунды.

 -  Упрощение структуры приложения и повышение его надежности с помощью различных приложений Helm. [*Helm*](https://github.com/kubernetes/helm) — это средство упаковки с открытым кодом, которое помогает установить приложения Kubernetes и управлять их жизненным циклом.

 -  Простой мониторинг и диагностика работоспособности приложений с помощью функций масштабирования и обновления.

> [!Note]  
> Установка кластера займет около часа, учтите это при планировании процесса.

### <a name="prerequisites-for-kubernetes-cluster-deployment"></a>Необходимые условия для развертывания кластера Kubernetes

Чтобы приступить к работе, проверьте разрешения и готовность Azure Stack.

1.  Убедитесь, что элемент **Создать кластер Kubernetes (предварительная версия)** доступен в Azure Stack Marketplace. Если этот элемент отсутствует, обратитесь к оператору Azure Stack, чтобы добавить этот элемент в среду Azure Stack.

2.  Проверьте, можете ли вы создавать приложения в клиенте Azure Active Directory (Azure AD). Эти разрешения необходимы для развертывания Kubernetes.

    Инструкции по проверке разрешений см. в разделе [*Check Azure Active Directory permissions*](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-create-service-principal-portal) (Проверка разрешений Azure Active Directory).

3.  Создайте пару открытого и закрытого ключей SSH для входа на виртуальную машину Linux в Azure Stack. Открытый ключ потребуется при создании кластера. Инструкции вы найдете в статье [о создании ключа аутентификации для SSH](#generate-an-authenticatio-key-for-ssh).

4.  Убедитесь в наличии действующей подписки на портале клиента Azure Stack и достаточного количества общедоступных IP-адресов для добавления новых приложений.

    Кластер не может быть развернут в подписке **администратора** Azure Stack. Используйте подписку **пользователя**.

###  <a name="generate-an-authentication-key-for-ssh"></a>Создание ключа аутентификации для SSH

В подсистеме Windows для Linux сеанса выполните следующие команды, чтобы создать ключ аутентификации: 

1. Тип:

    ```Bash  
    ssh-keygen -t rsa
    ```
    
2. Выберите `id_rsa` при появлении соответствующего запроса. 
3. Создайте парольную фразу в ответ на запрос. Важно записать этот пароль для последующего использования. 
    Выходные данные будут выглядеть следующим образом. 
    
    ```Bash  
    Your identification has been saved in `id_rsa`.
    Your public key has been saved in `id_rsa.pub`. 
    The key fingerprint is: SHA256:lUtUUjzaqWqGeolEPKeBmsnrhcNGM9Dn2OxYatt05SE  <user>@<machine-name>
    The key's randomart image is:  
    ```
    ![Alt text](media\azure-stack-solution-machine-learning\image58.png)

4. После создания ключа вставьте данные этого ключа, используя следующие команды: 
    ```Bash
    cat id_rsa.pub
    ```
    Выходные данные будут выглядеть следующим образом. 
    ```Bash
    ssh-rsa  AAAAB3NzaC1yc2EAAAADAQABAAABAQDHaWrAktR3BlQ356T8Qvv8O2Q/U/hsXQwS9xJbuduuc9lkJwddzgmNCyM9PooZWYtGVXyHU6SC3YH1XkwqGtKhtPb03d24hmhX1euAaqIqHHSp4WgUS5s1gNsp37L8QCSGNCnF31FWavI8bnjOjccUkMowKl8iyGN++5UyQgNuynEVUbFJjrntoDL66HUu88xDxTcVB7rqDr2QKFwYJkg4HSoHYpezJd7W8kcmv33eh0xs8nlDA7Dzu7zXpyVc54bH9XtPR6EUXaQa+UqKaNlQNiJqEs+1X/zNuK9V6NLVNiO0h3jCHI3K8o4VnZyRKHCQProasiiPLUUJ6SF/RTLN  <user>@<machine-name>
    ```
    
5. Скопируйте созданный ключ в поле "Открытый ключ SSH".

### <a name="create-a-service-principal-in-azure-ad"></a>Создание субъекта-службы в Azure AD

1.  Войдите на глобальный [*портал Azure*](http://www.poartal.azure.com/).

2.  Для входа используйте клиент Azure AD, связанный с экземпляром Azure Stack.

3.  Создадим приложение Azure AD.

    1. Последовательно выберите элементы **Azure Active Directory** > **+ Регистрация приложений**> **Регистрация нового приложения**.
    2. Введите **имя** приложения. 
    3. Выберите **Веб-приложение или API**. 
    4. Введите `http://localhost` в поле **URL-адрес для входа**. 
    5. Нажмите кнопку **Создать**.

1.  Запишите значение **идентификатора приложения**. Этот идентификатор понадобится при создании кластера и используется как **Идентификатор клиента для субъекта-службы**.

2.  Последовательно выберите **Параметры** > **Ключи**.

    1. Введите **описание**. 
    2. Выберите для параметра **Срок действия** значение **Срок действия неограничен**. 
    3. Щелкните **Сохранить**. Запишите строку ключа. Эта строка ключа понадобится при создании кластера и используется как **Секрет клиента для субъекта-службы**.

### <a name="give-the-service-principal-access"></a>Предоставление доступа субъекту-службе

Предоставьте субъекту-службе доступ к вашей подписке, чтобы он мог создать ресурсы.

1.  Войдите на [портал администрирования](https://adminportal.local.azurestack.external/).

2.  Выберите **Больше служб**  > **Подписки пользователей ** > **+ Добавить**.

3.  Выберите созданную подписку.

4.  Последовательно выберите **Управление доступом (IAM)** > **+ Добавить**.

5.  Выберите роль **Владелец**.

6.  Выберите имя приложения, созданное для субъекта-службы. Введите это имя в поле поиска, если потребуется.

7.  Щелкните **Сохранить**.

8.  Откройте [портал Azure Stack](https://portal.local.azurestack.external).

9.  Выберите **+Создать** > **Среда выполнения приложений** > **Kubernetes Cluster (Кластер Kubernetes)**. Нажмите кнопку **Создать**.

    ![Развертывание шаблона решений](media\azure-stack-solution-machine-learning\image59.png)

10\. В колонке "Создание кластера Kubernetes" выберите раздел **Основные сведения**.

    ![Deploy Solution Template](media\azure-stack-solution-machine-learning\image60.png)

11. Введите **имя пользователя администратора виртуальной машины Linux**. Это имя пользователя для виртуальных машин Linux, которые являются частью кластера Kubernetes и динамического административного представления.

12. Введите **открытый ключ SSH**, используемый для авторизации на всех компьютерах Linux, созданных как часть кластера Kubernetes и динамического административного представления.

13. Введите **префикс DNS главного профиля**, уникальный для региона. Это должно быть уникальное в пределах региона имя, например `ask8s-12345`. Постарайтесь выбрать то же имя, что и для группы ресурсов.

    > [!Note]  
    > Для каждого кластера используйте новый уникальный префикс DNS главного профиля.

14. Введите **количество профилей пула агентов**. Счетчик содержит число агентов в кластере. Можно указать значение от 1 до 4.

15. Введите **идентификатор клиента субъекта-службы**. Он используется поставщиком облачных служб Azure для Kubernetes.

16. Введите **Секрет клиента субъекта-службы**, созданный при создании приложения субъекта-службы.

17. Введите **версию поставщика облачных служб Azure для Kubernetes**. Это версия поставщика Azure для Kubernetes. Azure Stack выпускает специальную сборку Kubernetes для каждой версии Azure Stack.

18. Выберите идентификатор **подписки**.

19. Введите имя новой группы ресурсов или выберите существующую. Имя ресурса должно содержать буквенно-цифровые символы. Оно вводится в нижнем регистре.

20. Выберите **расположение** группы ресурсов. Это регион, выбранный для установки Azure Stack.

### <a name="specify-the-azure-stack-settings"></a>Указание параметров Azure Stack

1.  Выберите **параметры метки Azure Stack**.

    ![Развертывание шаблона решений](media\azure-stack-solution-machine-learning\image61.png)

2.  Введите значение в поле **Конечная точка Azure Resource Manager клиента**. Это конечная точка Azure Resource Manager, к которой устанавливается подключение, чтобы создать группу ресурсов кластера Kubernetes. Для интегрированной системы следует получить конечную точку у оператора Azure Stack. Если вам нужен Пакет средств разработки Azure Stack (ASDK), используйте `https://management.local.azurestack.external`.

3.  Введите **идентификатор клиента**. В статье [*Получение идентификатора клиента*](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-create-service-principal-portal) описано, как узнать значение идентификатора клиента.

### <a name="install-kubectl-on-windows-powershell-environment"></a>Установка kubectl в среде Windows PowerShell

Из среды WSL выполните следующие команды, чтобы установить в ней kubectl.

```PowerShell  
Install-script -name install-kubectl -scope CurrentUser -force
Install-kubectl.ps1 -downloadlocation “C:\Users\<Current User>\Documents\Kube
```

### <a name="install-kubectl-on-the-windows-subsystem-for-linux-environment"></a>Установка kubectl в подсистеме Windows для среды Linux

Из среды WSL выполните следующие команды, чтобы установить в ней kubectl.

```Bash  
    apt-get update && apt-get install -y apt-transport-https
    curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
    cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
    deb http://apt.kubernetes.io/ kubernetes-xenial main
    EOF
    apt-get update
    apt-get install -y kubectl
```

### <a name="configure-kubectl"></a>Настройка kubectl

Чтобы kubectl мог найти кластер Kubernetes и обратиться к нему, нужен *файл kubeconfig*. Он создается автоматически при создании кластера с помощью kube-up.sh или развертывании кластера Minikube. В [*руководствах по началу работы*](https://kubernetes.io/docs/setup/) вы найдете дополнительные сведения о создании кластеров. Чтобы использовать кластер, созданный другим пользователем, изучите [*документ по предоставлению общего доступа к кластеру*](https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/). По умолчанию конфигурация kubectl находится в файле **~.kube/config**.

### <a name="check-the-kubectl-configuration"></a>Проверка конфигурации kubectl

Убедитесь, что kubectl настроен правильно, получив состояние кластера:

```Bash  
kubectl cluster-info
```

Если отображается URL-адрес ответа, значит для kubectl правильно настроен доступ к кластеру.

Если kubectl настроен неверно или не может подключиться к кластеру Kubernetes, отображается следующее сообщение:

```Bash  
The connection to the server <server-name:port> was refused -  did you specify the right host or port?
```

Например, при выполнении кластера Kubernetes на локальном ноутбуке, потребуется дополнительное средство (minikube или его аналог) для повторного выполнения указанных выше команд.

Если kubectl cluster-info возвращает URL-адрес ответа, но кластер по-прежнему недоступен, проверьте правильность настройки с помощью команды:

```Bash  
> kubectl cluster-info dump
```

### <a name="enable-shell-autocompletion"></a>Включение автоматического завершения в оболочке

kubectl поддерживает автозавершение, что упрощает использование оболочки.

Скрипт завершения формируется в kubectl и доступен из профиля.

### <a name="connect-to-the-kubernetes-cluster"></a>Подключение к кластеру Kubernetes

Чтобы подключиться к кластеру, потребуется клиент командной строки Kubernetes (**kubectl**). Инструкции по подключению к кластеру и управлению им можно найти в [документации по Службе контейнеров Azure](https://docs.microsoft.com/azure/container-service/dcos-swarm/).

Для подключения кластера Kubernetes можно использовать любой SSH-клиент. Мы рекомендуем выбрать подсистему Windows для Linux (WSL). Компьютер, который подключается к кластеру Kubernetes, будет находиться в группе ресурсов, созданной для этого кластера, и его имя будет начинаться с префикса vmd-edge-ml-stack.

```Bash  
ssh <user>@vmd-edge-ml-stack.<FQDN of Kubernetes Machine in  Azure Stack>
```

После подключения к компьютеру Kubernetes запустите следующую команду для получения файла конфигурации Kubernetes.

```Bash  
sudo find / -name \*kubeconfig\* -type f
```

Результат должен выглядеть следующим образом.

```Bash  
/var/lib/waagent/custom-script/download/0/acs-engine/_output/edgemlstack/kubeconfig/kubeconfig.<regionname>.json
```

Скопируйте путь к файлам и выполните следующую команду, вставив в нее скопированный ранее путь к файлу kubeconfig:

```Bash  
sudo cat  /var/lib/waagent/custom-script/download/0/acs-engine/_output/edgemlstack/kubeconfig/kubeconfig.<regionname>.json
```

Выходные данные представляют собой большой блок текста с необработанным содержимым в формате JSON. Скопируйте этот текст и вставьте этот код в файл Visual Studio, затем сохраните его в виде файла JSON. Это действие создает локальный файл kubeconfig.json. (Сохраните его в папке /mnt/c/users/<current user>/documents/Kube с именем kubeconfig.json.)

### <a name="configure-the-kubernetes-cluster"></a>Настройка кластера Kubernetes

После получения локального JSON-файл, выполните в новом сеансе WSL следующие команды для настройки кластера.

```Bash  
    cd /mnt/c/users/<current user>/documents/Kube
    kubectl proxy
    kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
    kubectl proxy
    set KUBECONFIG=”/mnt/c/users/<current user>/documents/Kube/kubeconfig.json”
    kubectl.exe config view
```

Параметры конфигурации Kubernetes будут определены (см. выходные данные ниже).

![Alt text](media\azure-stack-solution-machine-learning\image62.png)

Запустите службу локального прокси-сервера:

```Bash  
kubectl proxy
```

Перейдите к пользовательскому интерфейсу кластера kubernetes по следующему адресу: `https://localhost:8001`.

![Alt text](media\azure-stack-solution-machine-learning\image63.png)

Теперь у вас есть место для развертывания контейнера и сам контейнер, который размещен в облаке и доступен из локальной среды.

![Alt text](media\azure-stack-solution-machine-learning\image64.png)

С помощью любого удобного редактора кода измените файл **iris_deployment.yaml** (расположенный в каталоге /*mnt/c/users/<current user>/documents/Kube*), чтобы значения **webservicename**,  **Image** и **Name** для контейнера соответствовали среде развертывания.

![Alt text](media\azure-stack-solution-machine-learning\image65.png)

Для порта контейнера задайте значение **5001.**

![Alt text](media\azure-stack-solution-machine-learning\image66.png)

А затем создайте **imagePullSecret**:

### <a name="create-a-secret-in-the-cluster-that-holds-the-authorization-token"></a>Создание в кластере секрета, который содержит маркер авторизации

Кластер Kubernetes использует секрет с типом **docker-registry** для аутентификации в реестре контейнеров и извлечения частного образа.

Создайте этот секрет и присвойте ему имя **azuremlcr**:

```Bash  
kubectl create secret docker-registry azuremlcr --docker-server=<your-registry-server> --docker-username=<your-name> --docker-password= "<your-pword>" --docker-email=<your-email>
```

Найдите следующие значения:

- **<имя сервера реестра>** обозначает **сервер входа** реестра контейнеров Azure;
- **<ваше имя>** соответствует **имени пользователя** для реестра контейнеров Azure;
- **<ваш пароль>** соответствует **паролю** для реестра контейнеров Azure. Пароль следует указывать в кавычках;
- **<электронная почта>** идентифицирует пользователя с доступом для чтения и записи к контейнеру.
- Эти сведения можно найти через пункты **Контейнер Azure****Реестр** в разделе **Ключи доступа**.
- Учетные данные docker теперь заданы для кластера в секрете с именем **azuremlcr**.

Сохраните файл **iris_deployment.yaml**, который расположен в папке /*mnt/c/users/<current user>/documents/Kube*.

### <a name="create-the-kubernetes-container"></a>Создание контейнера Kubernetes

```Bash  
kubectl.exe create -f /mnt/c/users/<current  user>/documents/Kube/iris_deployment.yaml
```

    ![Alt text](media\azure-stack-solution-machine-learning\image67.png)

Проверьте состояние развертывания.

```Bash  
Kubectl get deployments
```

    ![Alt text](media\azure-stack-solution-machine-learning\image68.png)

Процесс развертывания может занять некоторое время.

### <a name="configure-visual-studio-team-services-to-deploy-automatically"></a>Настройка автоматического развертывания для Visual Studio Team Services

#### <a name="create-a-team-project"></a>Создание командного проекта

1.  Проверьте [членство в группе администраторов для коллекции проектов.](https://docs.microsoft.com/vsts/organizations/security/set-project-collection-level-permissions?view=vsts) Чтобы создавать командные проекты, разрешение **Создавать новые проекты** должно иметь значение **Разрешить**.

2.  На странице "Проекты" щелкните **Создать проект**.

    ![Alt text](media\azure-stack-solution-machine-learning\image69.png)

1.  Присвойте проекту имя **HybridMLIris**.

2.  Выберите для него тип системы управления версиями **Git**.

3.  Выберите процесс и щелкните **Создать**.

    ![Alt text](media\azure-stack-solution-machine-learning\image70.png)

### <a name="import-some-code--create-repository"></a>Импорт кода; Создание репозитория

Для кода YAML требуется репозиторий Git.

#### <a name="add-user-to-the-git-repo"></a>Добавление пользователя в репозиторий GIT

1.  На панели мониторинга проекта по умолчанию выберите действие "Создать учетные данные Git".

    ![Alt text](media\azure-stack-solution-machine-learning\image71.png)

1.  Введите пароль в соответствующее поле и сохраните учетные данные Git.

    ![Alt text](media\azure-stack-solution-machine-learning\image72.png)

1.  Инициализируйте репозиторий, выбрав команду **Инициализировать** и создав файл **README**.

    ![Alt text](media\azure-stack-solution-machine-learning\image73.png)

#### <a name="clone-the-git-repository-locally-and-upload-the-code"></a>Клонируйте репозиторий Git локально и отправьте в него код. 

1.  Создайте на компьютере каталог по адресу `c:\\users\\<User>\\source\\repos\\hybridMLIris` и клонируйте репозиторий.

    ```Bash  
    sudo mkdir /mnt/c/users/<User>/source sudo mkdir /mnt/c/users/<User>/source/repos sudo mkdir /mnt/c/users/<User>/source/repos/hybridMLIris cd /mnt/c/users/<User>/source/repos/hybridMLIris sudo git clone  https://<yourvstssite>.visualstudio.com/HybridMLIris/_git/HybridMLIris
    ```

    ![Alt text](media\azure-stack-solution-machine-learning\image74.png)

1.  Перейдите к только что клонированному репозиторию:

    ```Bash  
    ls
    cd ./HybridMLIris
    ```
    
    ![Alt text](media\azure-stack-solution-machine-learning\image75.png)

1.  Скопируйте файл **iris_deployment.yaml** в этот репозиторий.

    ```Bash  
    cp /mnt/c/users/<User>/documents/Kube/iris_deployment.yaml  /mnt/c/users/<User>/source/repos/HybridMLIris/HybridMLIris/iris_deployment.yaml
    ``` 

1.  Зафиксируйте изменения в GIT.

    ```Bash  
    git add . git commit -m Added Deployment YAML git push
    ```

    ![Alt text](media\azure-stack-solution-machine-learning\image76.png)

### <a name="prepare-the-private-build-and-release-agent-for-vsts-integration"></a>Подготовка частного агента сборки и выпуска к интеграции с Visual Studio Team Services

#### <a name="prerequisites"></a>Предварительные требования

Visual Studio Team Services (VSTS) выполняет аутентификацию в Azure Resource Manager с помощью субъекта-службы. Чтобы VSTS могла предоставлять ресурсы в подписке Azure Stack, ей требуется роль участника.\ **Ниже приведены основные шаги, которые нужно выполнить для настройки такой аутентификации.**

1.  Необходимо создать субъект-службу или использовать уже существующую.

2.  Для субъекта-службы необходимо создать ключи проверки подлинности.

3.  Подписку Azure Stack необходимо проверить в механизме управления доступом на основе ролей, чтобы разрешить имени субъекта-службы быть частью роли "Участник".

4.  В VSTS нужно создать новое определение службы с использованием конечных точек Azure Stack, а также информации об имени субъекта-службы.

#### <a name="service-principal-creation"></a>Создание субъекта-службы

Ознакомьтесь с инструкциями по [созданию субъекта-службы](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications) и выберите для него тип приложения "Веб-приложение или API".

**Создание ключа доступа**

Субъекту-службе требуется ключ для проверки подлинности. Создайте ключ, выполнив действия в этом разделе.

1.  В Azure Active Directory в разделе **Регистрации приложений** выберите нужное приложение.

    ![Выбор приложения](media\azure-stack-solution-machine-learning\image77.png)

1.  Запишите значение **идентификатора приложения. Это значение будет использовано для настройки конечной точки службы в VSTS.**

    ![Alt text](media\azure-stack-solution-machine-learning\image78.png)

1.  Чтобы создать ключ проверки подлинности, щелкните **Параметры**.

    ![Выбор элемента "Параметры"](media\azure-stack-solution-machine-learning\image79.png)

1.  Выберите **Ключи**.

    ![Пункт "Ключи"](media\azure-stack-solution-machine-learning\image80.png)

1.  Введите описание и срок действия ключа. Затем нажмите кнопку **Сохранить**.

    ![Сохранение ключа](media\azure-stack-solution-machine-learning\image81.png)

После этого отобразится значение ключа. Скопируйте это значение, так как оно будет использовано позже. **Значение ключа** и идентификатор приложения нужны для входа от имени приложения. Сохраните значение ключа так, чтобы приложение могло получить его.

![Alt text](media\azure-stack-solution-machine-learning\image82.png)

#### <a name="get-tenant-id"></a>Получение идентификатора клиента

Как часть конфигурации конечной точки службы, VSTS требует **идентификатор клиента**, который соответствует каталогу AAD, в который была развернута метка Azure Stack. Следуйте указаниям в этом разделе, чтобы получить идентификатор клиента.

1.  Выберите **Azure Active Directory**.

    ![Выбор Azure Active Directory](media\azure-stack-solution-machine-learning\image83.png)

1.  Чтобы получить идентификатор клиента, щелкните **Свойства** для клиента Azure AD.

    ![Выбор свойств Azure AD](media\azure-stack-solution-machine-learning\image84.png)

1.  Скопируйте **идентификатор каталога**. Это и есть идентификатор клиента.

    ![tenant ID](media\azure-stack-solution-machine-learning\image85.png)

Предоставление субъекту-службы прав на развертывание ресурсов в подписке Azure Stack

Чтобы предоставить доступ к ресурсам в подписке, назначьте приложению роль. Укажите, какая роль предоставит приложению необходимые разрешения. Дополнительные сведения о доступных ролях см. в статье [RBAC: встроенные роли](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles).

Задайте область действия на уровне подписки, группы ресурсов или ресурса. Разрешения наследуют более низкие уровни области действия. Например, добавление приложения в роль читателя для группы ресурсов означает, что оно может считывать группу ресурсов и все содержащиеся в ней ресурсы.

1.  Перейдите на уровень области действия, которому вы хотите назначить приложение. Например, чтобы назначить роль в области действия подписки выберите **Подписки**.

    ![Alt text](media\azure-stack-solution-machine-learning\image86.jpeg)

1.  Выберите **подписку** (группу ресурсов или ресурс), которой будет назначено приложение.

    ![выбрать подписку для назначения](media\azure-stack-solution-machine-learning\image87.png)

1.  Выберите **Управление доступом (IAM)**.

    ![выбрать доступ](media\azure-stack-solution-machine-learning\image88.png)

1.  Выберите **Добавить**.

    ![выбрать "добавить"](media\azure-stack-solution-machine-learning\image89.png)

1.  Выберите роль для назначения приложению. На следующем изображении представлена роль **Владелец**.

    ![Alt text](media\azure-stack-solution-machine-learning\image90.png)

1.  По умолчанию приложения Azure Active Directory не отображаются среди доступных вариантов. Чтобы найти приложение, **укажите его имя** в поле поиска, затем выберите приложение.

    ![Alt text](media\azure-stack-solution-machine-learning\image91.png)

1.  Выберите **Сохранить**, чтобы завершить назначение роли. Вы увидите приложение в списке пользователей, которым назначена эта роль для выбранной области действия.

### <a name="role-based-access-control"></a>Управление доступом на основе ролей

Управление доступом на основе ролей (RBAC) Azure обеспечивает точное управление доступом для Azure и Azure Stack. С помощью RBAC можно предоставлять пользователям доступ, строго необходимый для выполнения поставленных перед ними задач. Дополнительные сведения об управлении доступом на основе ролей см. в статье [Использование управления доступом на основе ролей для контроля доступа к ресурсам в подписке Azure](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal?toc=%252fazure%252factive-directory%252ftoc.json).

**Пулы агентов VSTS**

Чтобы не управлять каждым агентом по отдельности, упорядочивайте их в **пулы агентов**. Пул агентов определяет общую границу для всех агентов в этом пуле. В VSTS пулы агентов действуют в области учетной записи VSTS, поэтому вы можете совместно использовать пулы агентов в нескольких командных проектах. Дополнительные сведения и руководство по созданию пулов агентов VSTS см. в статье [Agent pools and queues](https://docs.microsoft.com/vsts/build-release/concepts/agents/pools-queues?view=vsts) (Очереди и пулы агентов).

**Добавление личного маркера доступа для Azure Stack**

 -  Войдите в учетную запись VSTS и выберите имя **профиля учетной записи**.

 -  Выберите **Управление безопасностью**, чтобы получить доступ к странице создания маркера.

![Alt text](media\azure-stack-solution-machine-learning\image92.png)

![Alt text](media\azure-stack-solution-machine-learning\image93.jpeg)

![Alt text](media\azure-stack-solution-machine-learning\image94.jpeg)

> [!Note]  
> Получите сведения о маркере. Они не будут отображаться, когда вы перейдете с этой страницы.

1.  Скопируйте **маркер**.

    ![Alt text](media\azure-stack-solution-machine-learning\image95.png)

#### <a name="install-the-vsts-build-agent-on-the-azure-stack-hosted-build-server"></a>Установка агента сборки VSTS на сервере сборки, размещенном в Azure Stack

1.  Подключитесь к **серверу сборки**, развернутому на узле Azure Stack.

    > [!Note]  
    > Убедитесь, что размещенный сервер сборки Azure Stack доступен из Интернета. В противном случае обратитесь оператору Azure Stack, чтобы получить доступ.

    ```Bash  
    ssh <user>@<buildserver.publicip>
    ```

2.  Обновите сервер сборки Ubuntu до последней версии (18.04):

    ```Bash  
    sudo su
    apt-get update
    apt-get upgrade
    apt-get dist-upgrade
    apt-get autoremove
    do-release-upgrade -d
    ```

    > [!Note]  
    > Эта операция может занять некоторое время.

2.  Установите обязательные приложения на сервере сборки. В оболочке bash на серевере сборки под управлением Ubuntu выполните следующие команды:

    ```Bash  
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.asc.gpg
    sudo mv microsoft.asc.gpg /etc/apt/trusted.gpg.d/
    wget -q https://packages.microsoft.com/config/ubuntu/18.04/prod.list 
    sudo mv prod.list /etc/apt/sources.list.d/microsoft-prod.list
    sudo chown root:root /etc/apt/trusted.gpg.d/microsoft.asc.gpg
    sudo chown root:root /etc/apt/sources.list.d/microsoft-prod.list
    sudo apt-get install apt-transport-https
    sudo apt-get update
    sudo apt-get install liblttng-ust0 libcurl3 libssl1.0.0 curl lsb-release libkrb5-3 zlib1g libicu60 aspnetcore-runtime-2.1 dotnet-sdk-2.1
    wget https://github.com/PowerShell/PowerShell/releases/download/v6.1.0-preview.3/powershell-preview_6.1.0-preview.3-1.ubuntu.18.04_amd64.deb
    sudo dpkg -i powershell-preview_6.1.0-preview.3-1.ubuntu.18.04_amd64.deb
    sudo apt-get install -f
    AZ_REPO=$(lsb_release -cs)
    echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main" | \
        sudo tee /etc/apt/sources.list.d/azure-cli.list
    curl -L https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add –
    sudo apt-get update && sudo apt-get install azure-cli
    ```

2.  Скачайте и разверните в качестве службы агент сборки, используя **личный маркер доступа**, и запустите его от имени учетной записи администратора виртуальной машины.

    ![Alt text](media\azure-stack-solution-machine-learning\image96.png)

    ```Bash  
        cd \home\<user>
        sudo mkdir myagent && cd myagent
        wget https://vstsagentpackage.azureedge.net/agent/2.134.2/vsts-agent-linux-x64-2.134.2.tar.gz
        sudo tar zxvf vsts-agent-linux-x64-2.134.2.tar.gz
    ```

2.  Перейдите в извлеченную папку агента сборки. Выполните следующий код.

    ```Bash  
        cd ..
        sudo chmod -R 777 myagent
        cd myagent
        ./config.sh
    ```

    ![Alt text](media\azure-stack-solution-machine-learning\image97.png)

2.  Когда завершится выполнение команды **./config.sh**, запустите следующий код, который настраивает запуск службы во время загрузки сервера и запускает эту службу:

    ```Bash  
    sudo ./svc.sh install
    sudo ./svc.sh start
    ```

Агент теперь отображается в папке VSTS.

#### <a name="endpoint-creation-permissions"></a>Разрешения на создание конечной точки

Пользователи могут создавать конечные точки, поэтому сборки VSTO могут развертывать приложения службы приложений в стек. VSTS подключается к агенту сборки, который затем подключается к Azure Stack.

![Alt text](media\azure-stack-solution-machine-learning\image98.png)

1.  В меню **параметров** выберите **Безопасность**.

2.  В списке **Группы VSTS** слева выберите **Создатели конечных точек**.

    ![Alt text](media\azure-stack-solution-machine-learning\image99.png)

3.  На вкладке **Члены** выберите **+Добавить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image100.png)

1.  Введите **username** (имя пользователя) и выберите имя пользователя из списка.

2.  Щелкните **Save changes** (Сохранить изменения).

    ![Alt text](media\azure-stack-solution-machine-learning\image101.png)

3.  В списке **Группы VSTS** слева выберите **Администраторы конечной точки**.

4.  На вкладке **Члены** выберите **+Добавить**.

5.  Введите **имя пользователя** и выберите этого пользователя из списка.

6.  Щелкните **Save changes** (Сохранить изменения).

    ![buchatech](media\azure-stack-solution-machine-learning\image102.jpeg)

    Агент сборки в Azure Stack получает инструкции от VSTS, который затем передает сведения о конечной точке для взаимодействия с Azure Stack.

    Подключение между VSTS и Azure Stack установлено.

    ![Alt text](media\azure-stack-solution-machine-learning\image103.png)

### <a name="configure-build-and-release-definitions"></a>Настройка определений сборки и выпуска

Теперь, когда установлены подключения, вам следует вручную сопоставить созданную конечную точку Azure, AKS и реестр контейнеров Azure с определениями сборки и выпуска.

#### <a name="create-the-build-definition-for-the-yaml-code"></a>Создание определения сборки для кода YAML

1.  Выберите раздел сборки в узле "Сборка и выпуск" и создайте новое определение.

    ![Alt text](media\azure-stack-solution-machine-learning\image104.png)

1.  Выберите VSTS Git, а затем созданный ранее репозиторий.

    ![Alt text](media\azure-stack-solution-machine-learning\image105.png)

1.  Выберите шаблон пустого конвейера

    ![Alt text](media\azure-stack-solution-machine-learning\image106.png)

1.  Присвойте сборке имя **Copy Artifact** (Копировать артефакт) и выберите сервер сборки Azure Stack в качестве очереди агента.

    ![Alt text](media\azure-stack-solution-machine-learning\image107.png)

1.  Выберите в процессах этап 1 и переименуйте его в **Copy Artifact** (Копировать артефакт), затем **добавьте задачу** к этому этапу:

    ![Alt text](media\azure-stack-solution-machine-learning\image108.png)

1.  Выберите **Публикация артефактов сборки** из списка **служебных программ** и щелкните **Добавить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image109.png)

1.  Выберите **путь для публикации** и найдите файл **iris_deployment.yaml**.

    ![Alt text](media\azure-stack-solution-machine-learning\image110.png)

1.  Присвойте артефакту имя **iris_deployment** и выберите место публикации **Visual Studio Team Services или TFS**.

    ![Alt text](media\azure-stack-solution-machine-learning\image111.png)

1.  Щелкните **Сохранить и поместить в очередь**.

    ![Alt text](media\azure-stack-solution-machine-learning\image112.png)

1.  Проверьте состояние сборки, выбрав идентификатор сборки.

    ![Alt text](media\azure-stack-solution-machine-learning\image113.png)

В случае успешного выполнения выходные данные будут выглядеть следующим образом.

![Alt text](media\azure-stack-solution-machine-learning\image114.png)

#### <a name="create-the-release-definition-for-the-yaml-code"></a>Создание определения выпуска для кода YAML

1.  Выберите раздел "Выпуски" в узле "Сборка и выпуск" и создайте новое определение.

    ![Alt text](media\azure-stack-solution-machine-learning\image115.png)

1.  Выберите шаблон пустого конвейера.

    ![Alt text](media\azure-stack-solution-machine-learning\image106.png)

1.  Назовите новую среду "Azure Stack".

    ![Alt text](media\azure-stack-solution-machine-learning\image116.png)

1.  Добавьте новый артефакт, щелкнув **Артефакты** и **+ Добавить**

2.  Выберите типа источника "Сборка" и проект **HybridMLIris**.

3.  Теперь выберите определение сборки, созданное ранее для источника.

4.  Затем щелкните **Добавить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image117.png)

1.  Выберите Azure Stack в списке сред и добавьте новую задачу в Azure Stack.

    ![Alt text](media\azure-stack-solution-machine-learning\image118.png)


1.  На этапе настройки агента выберите в качестве очереди агента размещенный сервер сборки Azure Stack.

    ![Alt text](media\azure-stack-solution-machine-learning\image119.png)

1.  Добавить новую задачу для этого этапа, для параметра "Развертывание" выберите развертывание в задачу Kubernetes и щелкните "Добавить".

    ![Alt text](media\azure-stack-solution-machine-learning\image120.png)


1.  Присвойте имя **Kubectl Apply** (установлено по умолчанию) и выберите команду "Применить".

    ![Alt text](media\azure-stack-solution-machine-learning\image121.png)

    Создайте новое подключение службы Kubernetes.

#### <a name="create-kubernetes-service-endpoint"></a>Создание конечной точки службы Kubernetes

1.  В разделе "Подключение службы Kubernetes" нажмите кнопку **+ Создать** и выберите из списка **Kubernetes**. Эту конечную точку можно использовать для подключения **VSTS** и **службы контейнеров Azure (AKS)**.

2.  **Имя подключения**: укажите имя подключения.

3.  **URL-адрес сервера**: укажите адрес службы контейнера в формате "http://{адрес сервера API}

4.  **Kubeconfig**: чтобы получить значение Kubeconfig, выполните следующие команды Azure в командной строке с правами администратора.

    > [!Important]  
    > В окне CLI выполните следующие действия.

6.  В окне CLI войдите в Azure. [Подробнее о команде az login](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest).

7.  В командной строке введите:

    ```CLI
        az login
    ```

10. Эта команда возвращает код, который можно ввести в браузере на сайте <https://aka.ms/devicelogin>.

11. Перейдите в браузере по адресу <https://aka.ms/devicelogin>. При появлении запроса введите в браузере код, который вы получили в CLI.

    ![Конечная точка службы Kubernetes](media\azure-stack-solution-machine-learning\image122.png)

1.  Введите следующую команду в командной строке, чтобы получить учетные данные для доступа к кластеру Kubernetes.

### <a name="azure-ml-workbench-cli"></a>Интерфейс командной строки Azure Machine Learning Workbench

az aks get-credentials resource-group <yourResourceGroup> name <yourazurecontainerservice>

![Конечная точка службы Kubernetes](media\azure-stack-solution-machine-learning\image123.png)

1.  Перейдите к папке **.kube** в домашнем каталоге (например: C:\\Users\\<user>\\Documents\\Kube)

2.  Скопируйте содержимое файла **config** и вставьте его в окне подключения Kubernetes. Нажмите кнопку **ОК**.

    ![Конечная точка службы Kubernetes](media\azure-stack-solution-machine-learning\image124.png)
    

3.  Завершив создание конечной точки Kubernetes и выбрав ее, установите флажок "Использовать файлы конфигурации", чтобы добавить файл конфигурации. Затем перейдите к файлу iris_deployment.yaml в списке связанных артефактов.

    ![Alt text](media\azure-stack-solution-machine-learning\image125.png)

    ![Alt text](media\azure-stack-solution-machine-learning\image126.png)

4.  Сохраните определение выпуска.

#### <a name="check-the-status-of-the-release-definition"></a>Проверьте состояние определения выпуска. 

Сразу после сохранения определения выпуска VSTS автоматически начнет выпуск.

Проверьте состояние развертывания, выполнив быструю команду в командной строке WSL и зайдя в пользовательский интерфейс Kubernetes.

```Bash  
kubectl get deployments
```

Пока продолжается процесс развертывания, результат должен выглядеть примерно так.

![Alt text](media\azure-stack-solution-machine-learning\image127.png)

```Bash  
kubectl proxy
```

Когда пользовательский интерфейс kubernetes, перейдите к развертыванию по адресу [**https://localhost:8001/**](https://localhost:8001/) и откройте элементы **Рабочие нагрузки->Наборы реплик**.

![Alt text](media\azure-stack-solution-machine-learning\image128.png)

### <a name="deploy-the-yaml-service"></a>Развертывание службы YAML

#### <a name="upload-the-irisserviceyaml-to-the-repository-and-sync-changes"></a>Отправка iris_service.yaml в репозиторий и синхронизация изменений

1.  Перейдите к только что клонированному репозиторию:

    ```Bash  
    cd /mnt/c/users/<User>/source/repos/HybridMLIris/HybridMLIris/
    ```

    ![Alt text](media\azure-stack-solution-machine-learning\image75.png)

1.  Скопируйте файл **iris_deployment.yaml** в этот репозиторий.

    ```Bash  
    cp /mnt/c/users/<User>/documents/Kube/iris_service.yaml  /mnt/c/users/<User>/source/repos/HybridMLIris/HybridMLIris/iris_service.yaml
    ```

1.  Зафиксируйте изменения в GIT.

    ```Bash  
    git add .
    git commit -m “Added Service YAML” 
    git push
    ```

![Alt text](media\azure-stack-solution-machine-learning\image129.png)

#### <a name="update-the-build-definition-for-the-yaml-code"></a>Обновление определения сборки для кода YAML

1.  Выберите раздел сборки в узле "Сборка и выпуск" и выберите только что созданное определение.

    ![Alt text](media\azure-stack-solution-machine-learning\image130.png)

2.  Нажмите кнопку "Изменить", чтобы изменить определение.

    ![Alt text](media\azure-stack-solution-machine-learning\image131.png)

3.  **Добавьте задачу** в этот этап. Выберите **Публикация артефактов сборки** из списка **служебных программ** и щелкните **Добавить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image108.png)

4.  Присвойте имя **Kubectl Apply** (установлено по умолчанию) и выберите команду "Применить".



#### <a name="update-the-release-definition-for-the-yaml-code"></a>Изменение определения выпуска для кода YAML

1.  Выберите раздел "Выпуски" в узле "Сборка и выпуск", затем выберите созданное ранее определение выпуска. Теперь выберите ссылку Изменить.

    ![Alt text](media\azure-stack-solution-machine-learning\image132.png)

1.  Выберите **Azure Stack** в списке сред и добавьте новую задачу в Azure Stack.

    ![Alt text](media\azure-stack-solution-machine-learning\image133.png)

1.  Добавить **новую задачу** для этого этапа, для параметра **Развертывание** выберите **развертывание в задачу Kubernetes** и щелкните **Добавить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image134.png)

1.  Присвойте имя **Kubectl Apply** (установлено по умолчанию) и выберите команду "Применить".

    ![Alt text](media\azure-stack-solution-machine-learning\image109.png)

1.  В качестве подключения службы Kubernates выберите созданное ранее подключение Azure Stack, затем установите флажок **Использовать файлы конфигурации**, чтобы добавить файл конфигурации. Перейдите к файлу iris_service.yaml в списке связанных артефактов.

    ![Alt text](media\azure-stack-solution-machine-learning\image135.png)


    ![Alt text](media\azure-stack-solution-machine-learning\image136.png)

1.  Сохраните определение выпуска.

#### <a name="check-the-status-of-the-release-definition"></a>Проверка состояния определения выпуска

Сразу после сохранения определения выпуска VSTS автоматически начнет выпуск.

Проверьте состояние развертывания, выполнив быструю команду в командной строке WSL и зайдя в пользовательский интерфейс Kubernetes.

```Bash  
kubectl get deployments
```

Пока продолжается процесс развертывания, результат должен выглядеть примерно так.

![Alt text](media\azure-stack-solution-machine-learning\image127.png)


```Bash  
kubectl proxy
```

Когда пользовательский интерфейс kubernetes, перейдите к развертыванию по адресу [**https://localhost:8001/**](https://localhost:8001/) и откройте элементы **Рабочие нагрузки->Наборы реплик**.

![Alt text](media\azure-stack-solution-machine-learning\image137.png)


### <a name="kubernetes-scoring-and-validation"></a>Оценка и проверка Kubernetes

Откройте пользовательский интерфейс Kubernetes

```Bash  
kubectl proxy
```

Откройте пользовательский интерфейс Kubernetes и поочередно выберите **Развертывания** -> **Развертывание Iris** -> **Новый набор реплик** -> **Iris-Deployment-<идентификатор_развертывания>**.

![Alt text](media\azure-stack-solution-machine-learning\image138.png)

Затем перейдите к разделу **Службы** и выберите **внешнюю конечную точку** службы, чтобы проверить ее работу.

![Alt text](media\azure-stack-solution-machine-learning\image139.png)

Отобразится сообщение проверки, аналогичное приведенному ниже:

![Alt text](media\azure-stack-solution-machine-learning\image140.png)

#### <a name="create-azure-stack-scoring-function-app-in-the-azure-stack-portal"></a>Создание приложения-функции Azure Stack для оценки на портале Azure Stack

В приложении-функции будет размещаться выполнение каждой функции. Оно позволяет группировать функции в логические единицы и упрощает развертывание и совместное использование ресурсов, а также управление ими.

1.  На портале Azure нажмите кнопку **Создать** в верхнем левом углу, а затем выберите **Интернет и мобильные устройства** >**Приложение-функция**.

    ![Alt text](media\azure-stack-solution-machine-learning\image141.png)

1.  Присвойте функции имя **data-functions** и поместите ее в ту же группу ресурсов, что и остальное содержимое Машинного обучения. Позвольте средству автоматически создать новый план службы приложений для использования, указав созданную ранее учетную запись хранения.

    ![Определение параметров для нового приложения-функции](media\azure-stack-solution-machine-learning\image142.png)

1.  Выберите **Создать**, чтобы подготовить и развернуть приложение-функцию.

2.  Выберите значок уведомления в правом верхнем углу портала. Вы должны увидеть сообщение **Развертывание выполнено**.

    ![Определение параметров нового приложения-функции](media\azure-stack-solution-machine-learning\image143.png)

1.  Выберите **Перейти к ресурсу**, чтобы просмотреть новое приложение-функцию.

    ![Alt text](media\azure-stack-solution-machine-learning\image144.png)

1.  Создайте новую функцию, выбрав **Функции** и нажав кнопку **+ Создать функцию**.

    ![Alt text](media\azure-stack-solution-machine-learning\image145.png)

1.  Выбор триггера HTTP

    ![Alt text](media\azure-stack-solution-machine-learning\image146.png)

1.  Выберите язык **C\#** и присвойте функции имя **clean-score-data**, а также укажите уровень авторизации **Анонимный**.

    ![Alt text](media\azure-stack-solution-machine-learning\image147.png)

1.  Скопируйте и вставьте в эту функцию содержимое примера кода для clean-score-data.

    ![Alt text](media\azure-stack-solution-machine-learning\image148.png)

#### <a name="use-postman-to-validate-functions"></a>Проверка функций с помощью Postman

Чтобы убедиться, что вы правильно настроили Kbernetes и Функции, примените бесплатное приложение Postman для тестирования и проверки схем и функций. Чтобы запустить этот процесс, прежде всего следует собрать некоторые сведения из экземпляра Kubernetes.

1.  Откройте пользовательский интерфейс Kubernetes и поочередно выберите **Развертывания** -> **Развертывание Iris** -> **Новый набор реплик** -> **Iris-Deployment-<идентификатор_развертывания>**.

    ![Alt text](media\azure-stack-solution-machine-learning\image138.png)

1.  Затем перейдите к разделу **Службы** и скопируйте значение **Внешняя конечная точка**.

    ![Alt text](media\azure-stack-solution-machine-learning\image149.png)

1.  Скачайте и установите приложение Postman [отсюда](https://www.getpostman.com/apps), если потребуется.

2.  Войдите в приложение Postman и закройте диалоговое окно создания файла.

    ![Alt text](media\azure-stack-solution-machine-learning\image150.png)

1.  В приложение Postman, выберите POST...

    ![Alt text](media\azure-stack-solution-machine-learning\image151.png)

1.  Вставьте URL-адрес **внешней конечной точки** в приложение Postman в разделе **URL-адрес запроса**, добавив в конец этого URL-адреса  **\\score**, как показано ниже.

    ![Alt text](media\azure-stack-solution-machine-learning\image152.png)

1.  Выберите вкладку **Текст** и выберите в ней тип данных **Необработанные**, затем **JSON**.

    ![Alt text](media\azure-stack-solution-machine-learning\image153.png)

1.  В веб-браузере откройте адрес **внешней конечной точки**. Добавив к URL-адресу строку **/swagger.json**, вы получите файл Swagger для службы, который используется для проверки установки.

    ![Alt text](media\azure-stack-solution-machine-learning\image154.png)

1.  Скопируйте пример, представленный в файле **Swagger.JSON**.

2.  В приложении Postman вставьте этот пример в текст запроса Post и щелкните **Отправить**. Это действие возвращает значение, аналогичное представленному ниже.

    ![Alt text](media\azure-stack-solution-machine-learning\image155.png)

## <a name="step-7-create-an-azure-stack-storage-account-and-storage-queue"></a>Шаг 7. Создание учетной записи хранения Azure Stack и очереди службы хранилища

Создание учетной записи хранения Azure Stack и очереди службы хранилища для данных.

1.  Войдите на портал пользователя Azure Stack. (У каждого экземпляра Azure Stack есть уникальный URL-адрес портала.)

2.  На портале пользователя Azure Stack разверните меню слева, чтобы открыть меню служб, и выберите **Все службы**. Прокрутите вниз до пункта **Хранилище** и выберите **Учетные записи хранения**. В появившемся окне **Учетные записи хранения** выберите **Добавить**.

3.  Введите имя учетной записи хранения.

4.  Выберите для учетной записи хранения тип хранилища репликации **LRS**.

5.  Выберите существующую группу ресурсов или создайте новую.

6.  Выберите вариант **Локально** в качестве расположения учетной записи хранения.

7.  Щелкните **Создать**, чтобы создать учетную запись хранения.

    ![Alt text](media\azure-stack-solution-machine-learning\image156.png)

1.  Выберите только что созданную учетную запись хранения.

2.  Щелкните **Очереди**.

    ![Alt text](media\azure-stack-solution-machine-learning\image157.png)

1.  Щелкните **+ Очередь**, присвойте очереди имя и щелкните **ОК.**

    ![Alt text](media\azure-stack-solution-machine-learning\image158.png)

1.  Получите **строку подключения** для очереди службы хранилища и скопируйте его.

    ![Alt text](media\azure-stack-solution-machine-learning\image159.png)

1.  Перейдите к приложению-функции Azure и выберите **Параметры приложения**.

    ![Alt text](media\azure-stack-solution-machine-learning\image160.png)

1.  На странице параметров приложения для приложения-функции прокрутите вниз и выберите **+ Добавить новый параметр**.

    ![Alt text](media\azure-stack-solution-machine-learning\image161.png)

1.  Введите имя учетной записи хранения в поле **Имя**, добавив к нему постфикс _STORAGE.

Теперь приложение будет понимать, что это конечная точка учетной записи хранения.

1.  Теперь вставьте строку подключения в поле **Значение**.

    ![Alt text](media\azure-stack-solution-machine-learning\image162.png)

1.  Прокрутите страницу параметров приложения вверх до самого начала и выберите **Сохранить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image163.png)

### <a name="update-the-scoring-function-to-use-storage-queue"></a>Настройка очереди службы хранилища для функции оценки

1.  Щелкните действие **интегрировать** для функции и снимите выбор с флажка **GET**.

2.  Щелкните **Сохранить**.

3.  Затем выберите **+ Новые выходные данные** в разделе выходных данных.

    ![Alt text](media\azure-stack-solution-machine-learning\image164.png)

1.  Затем выберите **Хранилище очередей Azure** и выберите **Выбрать**.

    ![Alt text](media\azure-stack-solution-machine-learning\image165.png)

1.  В поле **Имя очереди** укажите созданную ранее очередь службы хранилища, затем укажите в поле **Подключение к учетной записи хранения** созданное ранее подключение к учетной записи и выберите **Сохранить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image166.png)

## <a name="step-8-create-a-function-to-handle-clean-data"></a>Шаг 8. Создание функции для обработки очищенных данных

Создайте новую функцию Azure Stack для перемещения очищенных данных из Azure Stack в Azure.

1.  Создайте новую функцию, выбрав **Функции** и нажав кнопку **+ Создать функцию**.

    ![Alt text](media\azure-stack-solution-machine-learning\image167.png)

1.  Выберите **Триггер таймера**.

    ![Alt text](media\azure-stack-solution-machine-learning\image168.png)

1.  Выберите язык **C\#**  и присвойте функции имя **upload-to-azure** и настройте расписание **0 0 \*/1 \* \* \***, что в нотации CRON означает запуск каждый час.

    ![Alt text](media\azure-stack-solution-machine-learning\image169.png)

### <a name="get-the-connection-string-to-the-azure-hosted-storage-account"></a>Получение строки подключения к размещенной учетной записи хранения Azure

1.  Перейдите к <https://portal.azure.com>, затем выберите созданную ранее **учетную записи хранения Azure**.

2.  Выберите **ключи доступа**, затем скопируйте **строку подключения** к учетной записи хранения.

    ![Alt text](media\azure-stack-solution-machine-learning\image170.png)

### <a name="update-the-upload-to-azure-function-to-use-the-azure-hosted-storage"></a>Настройка размещенного хранилища Azure для функции upload-to-azure

1.  Перейдите к приложению-функции Azure и выберите **Параметры приложения**.

    ![Alt text](media\azure-stack-solution-machine-learning\image171.png)

1.  На странице параметров приложения для приложения-функции прокрутите вниз и выберите **+ Добавить новый параметр**.

    ![Alt text](media\azure-stack-solution-machine-learning\image172.png)

1.  Введите имя учетной записи хранения в поле **Имя**, добавив к нему постфикс _STORAGE.

Теперь приложение будет понимать, что это конечная точка учетной записи хранения.

1.  Вставьте строку подключения к размещенной учетной записи хранилища Azure в поле **Значение**.

    ![Alt text](media\azure-stack-solution-machine-learning\image173.png)

1.  Прокрутите страницу параметров приложения вверх до самого начала и выберите **Сохранить**.

    ![Alt text](media\azure-stack-solution-machine-learning\image174.png)

1.  Вернитесь к функции **upload-to-azure**.

2.  Выберите для функции действие **интегрировать**.

3.  Затем выберите **+ Новые выходные данные** в разделе выходных данных.

    ![Alt text](media\azure-stack-solution-machine-learning\image175.png)

1.  Затем выберите **Хранилище BLOB-объектов Azure** и щелкните **Выбрать**.

    ![Alt text](media\azure-stack-solution-machine-learning\image176.png)

1.  В поле **Путь** укажите созданный ранее контейнер хранения в формате **uploadeddata/{произвольный_идентификатор}.txt** и задайте в параметре **Подключение к учетной записи хранения** созданное ранее подключение к учетной записи хранения Azure, затем щелкните **Сохранить.**

    ![Alt text](media\azure-stack-solution-machine-learning\image177.png)

1.  Скопируйте и вставьте в эту функцию содержимое примера кода для **upload-to-azure**.

2.  Внесите необходимые изменения, чтобы указать строку подключения к учетной записи хранилища.

3.  Сохраните и запустите этот код.

    ![Alt text](media\azure-stack-solution-machine-learning\image178.png)

1.  Проверьте размещенную в Azure учетную запись хранения и убедитесь, что в облако переданы обработанные данные. Если все нормально, результат будет выглядеть примерно так.

    ![Alt text](media\azure-stack-solution-machine-learning\image179.png)

Данные успешно очищены от конфиденциальных данных службой Машинного обучения Azure Stack, размещенной в Kubernetes, и переданы в общедоступное облако Azure из локальной службы Azure Stack через размещенные приложения-функции Azure Stack. Данные можно подготовить к передаче даже в сценариях пограничной или отключенной системы.

## <a name="next-steps"></a>Дополнительная информация

 - Дополнительные сведения о шаблонах для облака Azure см. в статье [Конструктивные шаблоны облачных решений](https://docs.microsoft.com/azure/architecture/patterns).