---
title: Серверы размещения SQL в Azure Stack | Документация Майкрософт
description: Добавление экземпляров SQL для подготовки через поставщик ресурсов адаптера SQL.
services: azure-stack
documentationCenter: ''
author: jeffgilb
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/05/2018
ms.author: jeffgilb
ms.reviewer: jeffgo
ms.openlocfilehash: 4dfeff0e22a541a39a59c37c869af41a7e444fa6
ms.sourcegitcommit: 3d0295a939c07bf9f0b38ebd37ac8461af8d461f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/06/2018
ms.locfileid: "43842504"
---
# <a name="add-hosting-servers-for-the-sql-resource-provider"></a>Добавление серверов размещения для поставщика ресурсов SQL

Вы можете разместить экземпляр SQL на виртуальной машине [Azure Stack](azure-stack-poc.md) или на виртуальной машине за пределами среды Azure Stack при условии, что поставщик ресурсов SQL может подключаться к этому экземпляру.

## <a name="overview"></a>Обзор

Прежде чем добавить сервер размещения SQL, просмотрите следующие общие обязательные требования.

### <a name="mandatory-requirements"></a>Обязательные требования

* Включите проверку подлинности SQL на экземпляре SQL Server. Виртуальная машина поставщика ресурсов SQL не присоединена к домену, она может подключаться к серверу размещения только путем проверки подлинности SQL.
* Сделайте IP-адреса для экземпляров SQL общедоступными при их установке в Azure Stack. Поставщик ресурсов и пользователи, такие как веб-приложения, обмениваются данными через пользовательскую сеть, поэтому требуется подключение к экземпляру SQL в этой сети.

### <a name="general-requirements"></a>Общие требования

* Назначьте экземпляр SQL для использования с рабочими нагрузками пользователя и поставщика ресурсов. Вы не можете использовать экземпляр SQL, который применяется любой другой службой. Это ограничение также применяется к службам приложений.
* Настройте учетную запись с соответствующим уровнем привилегий для поставщика ресурсов (как описано ниже).
* За управление экземплярами SQL и их узлами отвечает пользователь.  Например, поставщик ресурсов не применяет обновления, не обрабатывает резервные копии или не изменяет учетные данные.

### <a name="sql-server-virtual-machine-images"></a>Образы виртуальных машин SQL Server

Образы виртуальных машины SQL IaaS доступны через функцию управления Marketplace. Эти образы совпадают с доступными в Azure виртуальными машинами SQL.

Перед развертыванием виртуальной машины SQL с использованием элемента Marketplace, всегда скачивайте последнюю версию **расширения SQL IaaS**. Расширение IaaS и соответствующие усовершенствования портала предоставляют дополнительные функции, такие как автоматическая установка исправлений и резервное копирование. Дополнительные сведения о расширении см. в разделе [Автоматизация задач управления на виртуальных машинах Azure с помощью расширения агента SQL Server (модель с использованием Resource Manager)](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-agent-extension).

Есть и другие варианты развертывания виртуальных машин SQL, в том числе с помощью шаблонов из [коллекции быстрого запуска Azure Stack](https://github.com/Azure/AzureStack-QuickStart-Templates).

> [!NOTE]
> Любые серверы размещения, установленные в многоузловом Azure Stack, должны быть созданы из подписки пользователя, а не подписки поставщика по умолчанию. Их необходимо создать с пользовательского портала или из сеанса PowerShell с помощью соответствующего имени входа. Все серверы размещения — это подлежащие оплате виртуальные машины, которые должны иметь соответствующие лицензии SQL. Администратор служб _может_ быть владельцем такой подписки.

### <a name="required-privileges"></a>Необходимые разрешения

Можно создать пользователя с более низкими привилегиями, чем системный администратор SQL. Пользователю необходимы разрешения только для выполнения следующих операций:

* База данных. Создание, изменение, с вложением (только для решения Always On), перенос, резервное копирование.
* Группа доступности: изменение, присоединение, добавление или удаление базы данных.
* Имя входа: создание, выбор, изменение, перенос, отмена.
* Выберите операции: \[master\].\[sys\].\[availability_group_listeners\] (группы доступности AlwaysOn) sys.availability_replicas (группы доступности AlwaysOn), sys.databases, \[master\].\[sys\].\[dm_os_sys_memory\], SERVERPROPERTY, \[master\].\[ sys\].\[ availability_groups\] (группы доступности AlwaysOn), sys.master_files.

### <a name="additional-security-information"></a>Дополнительные сведения о безопасности

Ниже приведены дополнительные указания по безопасности.

* Хранилище Azure Stack шифруется с помощью BitLocker, поэтому любой экземпляр SQL в Azure Stack будет использовать зашифрованное хранилище BLOB-объектов.
* Поставщик ресурсов SQL полностью поддерживает TLS 1.2. Для всех серверов SQL Server под управлением SQL RP настраивается _только_ протокол TLS 1.2. Он используется по умолчанию в RP. Все поддерживаемые версии SQL Server поддерживают TLS 1.2. См. статью [Поддержка TLS 1.2 для Microsoft SQL Server](https://support.microsoft.com/en-us/help/3135244/tls-1-2-support-for-microsoft-sql-server).
* Чтобы обеспечить шифрование всех данных, передаваемых на сервер SQL Server, задайте параметр **ForceEncryption** с помощью диспетчера конфигурации SQL Server. См. раздел [Настройка принудительного использования зашифрованных соединений на сервере](https://docs.microsoft.com/sql/database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine?view=sql-server-2017#ConfigureServerConnections).
* Убедитесь в том, что все клиентские приложения также обмениваются данными через защищенные соединения.
* RP доверяет сертификатам, используемым экземплярами SQL Server.

## <a name="provide-capacity-by-connecting-to-a-standalone-hosting-sql-server"></a>Указание емкости путем подключения к автономному серверу размещения SQL

Можно использовать автономные (без высокой доступности) серверы SQL любого выпуска SQL Server 2014 или SQL Server 2016. Убедитесь, что у вас есть учетные данные для учетной записи с правами системного администратора.

Чтобы добавить автономный сервер размещения, который уже настроен, выполните следующие действия.

1. Войдите на портал оператора Azure Stack в качестве администратора служб.

2. Выберите **Все службы**&gt; **Ресурсы администрирования** &gt; **Серверы размещения SQL**.

   ![Серверы размещения SQL](./media/azure-stack-sql-rp-deploy/sqlhostingservers.png)

   В разделе **Серверы размещения SQL** можно подключить поставщик ресурсов SQL к экземплярам SQL Server, которые выступят в качестве серверной части поставщика ресурсов.

   ![Панель мониторинга адаптера SQL](./media/azure-stack-sql-rp-deploy/sqlrp-hostingserver.png)

3. Щелкните**Добавить**, а затем предоставьте сведения о подключении для экземпляра SQL Server в колонку **Добавление сервера размещения SQL**.

   ![Добавление сервера размещения SQL](./media/azure-stack-sql-rp-deploy/sqlrp-newhostingserver.png)

    Необязательно дополнительно включать имя экземпляра, а также предоставлять номер порта, если экземпляр не назначен порту 1433 по умолчанию.

   > [!NOTE]
   > Пока экземпляр SQL может быть доступен Azure Resource Manager пользователя и администратора, он может находиться под контролем поставщика ресурсов. Экземпляр SQL __должен__ быть выделен исключительно для поставщика ресурсов.

4. При добавлении серверов, им должен быть присвоен существующий номер SKU или создан новый номер SKU. В разделе **Добавление сервера размещения SQL**, выберите **номера SKU**.

   * Чтобы использовать существующий номер SKU, выберите доступный номер SKU, а затем выберите **Создать**.
   * Чтобы создать номер SKU, выберите **+ Создание номера SKU**. Введите требуемые данные в поле **Создание номера SKU** и щелкните **ОК**.

     ![Создание номера SKU](./media/azure-stack-sql-rp-deploy/sqlrp-newsku.png)

## <a name="provide-high-availability-using-sql-always-on-availability-groups"></a>Предоставление высокого уровня доступности с помощью группы доступности SQL Always On

Настройка экземпляров SQL AlwaysOn требует дополнительных шагов и наличия трех виртуальных машин (или физических компьютеров) В этой статье предполагается, что вы хорошо понимаете принцип работы групп доступности AlwaysOn. Дополнительные сведения см. в следующих статьях:

* [Введение в группы доступности AlwaysOn SQL Server на виртуальных машинах Azure](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-overview)
* [Группы доступности AlwaysOn (SQL Server)](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/always-on-availability-groups-sql-server?view=sql-server-2017)

> [!NOTE]
> Поставщик ресурсов адаптера SQL поддерживает _только_ экземпляры SQL 2016 Enterprise с пакетом обновления 1 (SP1) или более поздней версии для групп доступности AlwaysOn. Эта конфигурация адаптера требует наличия новых функций SQL, таких как автоматическое заполнение.

### <a name="automatic-seeding"></a>Автоматическое заполнение

Необходимо включить [автоматическое заполнение](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/automatically-initialize-always-on-availability-group) в каждой группе доступности для каждого экземпляра SQL Server.

Чтобы включить автоматическое заполнение для всех экземпляров, измените и выполните следующую команду SQL в первичной реплике для каждого дополнительного экземпляра:

  ```sql
  ALTER AVAILABILITY GROUP [<availability_group_name>]
      MODIFY REPLICA ON '<secondary_node>'
      WITH (SEEDING_MODE = AUTOMATIC)
  GO
  ```

Обратите внимание на то, что имя группы доступности должно быть заключено в квадратные скобки.

Во вторичных узлах выполните следующую команду SQL:

  ```sql
  ALTER AVAILABILITY GROUP [<availability_group_name>] GRANT CREATE ANY DATABASE
  GO
  ```

### <a name="configure-contained-database-authentication"></a>Настройка проверки подлинности автономной базы данных

Перед добавлением автономной базы данных в группу доступности необходимо присвоить параметру сервера contained database authentication значение 1 в каждом экземпляре сервера, в котором размещается реплика доступности для группы доступности. Дополнительные сведения см. в статье [Параметр конфигурации сервера contained database authentication](https://docs.microsoft.com/sql/database-engine/configure-windows/contained-database-authentication-server-configuration-option?view=sql-server-2017).

Чтобы задать параметр сервера contained database authentication для каждого экземпляра, используйте следующие команды:

  ```sql
  EXEC sp_configure 'contained database authentication', 1
  GO
  RECONFIGURE
  GO
  ```

### <a name="to-add-sql-always-on-hosting-servers"></a>Добавление серверов размещения для SQL Always On

1. Войдите на портал администрирования Azure Stack в качестве администратора служб.

2. Выберите **Browse** (Обзор) &gt; **Ресурсы администрирования** &gt; **SQL Hosting Servers** (Серверы размещения SQL) &gt;**+Add** (+Добавить).

   В разделе **SQL Hosting Servers** (Серверы размещения SQL) можно подключить поставщика ресурсов SQL Server к фактическим экземплярам SQL Server, которые выступают в качестве серверной части поставщика ресурсов.

3. Заполните форму информацией о подключении своего экземпляра SQL Server. Убедитесь в том, что используется адрес полного доменного имени прослушивателя Always On (и дополнительный номер порта и имя экземпляра). Предоставьте информацию для учетной записи, настроенной с правами системного администратора.

4. Установите флажок Always On Availability Group (Группа доступности Always On), чтобы включить поддержку для экземпляров групп доступности SQL Always On.

   ![Включение решения Always On](./media/azure-stack-sql-rp-deploy/AlwaysOn.PNG)

5. Добавьте экземпляр SQL Always On в SKU.

   > [!IMPORTANT]
   > Нельзя смешивать отдельные серверы с экземплярами Always On в одном номере SKU. Попытка смешивания типов после добавления первого сервера размещения приведет к ошибке.

## <a name="sku-notes"></a>Примечания номеров SKU

Вы можете использовать номер SKU для различения предложений служб. Например, у вас может быть экземпляр SQL "Корпоративный", имеющий следующие характеристики:
  
* Большая емкость
* Высокая производительность
* Высокая доступность

В этом выпуске номера SKU невозможно назначать определенным пользователям или группам.

 Отображение номеров SKU на портале может занять до часа. Пользователи не смогут создать базу данных, пока не будет полностью создан SKU.

>[!TIP]
>Используйте имя номера SKU, которое отображает описание возможностей серверов в номере SKU, таких как емкость и производительность. Имя предоставляет возможность пользователям развернуть свои базы данных в соответствующем номере SKU.

Как показала лучшая методика, все серверы размещения в номере SKU должны иметь одинаковые ресурсы и характеристики производительности.

## <a name="make-the-sql-databases-available-to-users"></a>Предоставление пользователям баз данных SQL

Создайте планы и предложения для предоставления пользователям баз данных SQL. Добавьте службу **Microsoft.SqlAdapter** в план и создайте квоту.

## <a name="next-steps"></a>Дополнительная информация

[Создание баз данных SQL](azure-stack-sql-resource-provider-databases.md)
