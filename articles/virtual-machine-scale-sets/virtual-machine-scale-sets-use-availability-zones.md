---
title: Создание масштабируемого набора Azure, который использует зоны доступности | Документация Майкрософт
description: Узнайте, как создавать масштабируемые наборы виртуальных машин Azure, которые используют зоны доступности для повышения избыточности и минимизации простоев
services: virtual-machine-scale-sets
documentationcenter: ''
author: iainfoulds
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm
ms.devlang: na
ms.topic: article
ms.date: 03/07/2018
ms.author: iainfou
ms.openlocfilehash: dee06eee045bc24c2864333a66a6d145a771b3ad
ms.sourcegitcommit: 20d103fb8658b29b48115782fe01f76239b240aa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2018
---
# <a name="create-a-virtual-machine-scale-set-that-uses-availability-zones"></a>Создание масштабируемого набора Azure, который использует зоны доступности
Чтобы предотвратить сбои масштабируемых наборов виртуальных машин на уровне центра обработки данных, можно создать масштабируемые наборы в зонах доступности. Регионы Azure, которые поддерживают зоны доступности, имеют по крайней мере три отдельные зоны, для каждой из которых предусмотрены собственные независимые источники питания, сети и системы охлаждения. Дополнительные сведения см. в статье [Общие сведения о зонах доступности в Azure (предварительная версия)](../availability-zones/az-overview.md).


## <a name="single-zone-and-zone-redundant-scale-sets"></a>Однозонные масштабируемые наборы и масштабируемые наборы, избыточные в пределах зоны
При развертывании масштабируемого набора виртуальных машин можно использовать одну или несколько зон доступности в регионе.

Когда вы создаете масштабируемый набор в одной зоне, вы определяете, в какой зоне задействованы все экземпляры виртуальных машин, а управление масштабируемым набором и его автоматическое масштабирование осуществляется только в этой зоне. Масштабируемый набор, избыточный в пределах зоны, позволяет создать единый масштабируемый набор в рамках нескольких зон. При создании экземпляров виртуальных машин по умолчанию они будут равномерно распределяется в пределах зон. Если прерывание происходит в одной из зон, масштабируемый набор не масштабируется автоматически для увеличения емкости. Лучше всего настроить правила автоматического масштабирования на основе использования ЦП или памяти. Правила автоматического масштабирования позволят масштабируемому набору реагировать на потерю экземпляров виртуальных машин в этой зоне путем развертывания новых экземпляров в остальных рабочих зонах.

Чтобы использовать зоны доступности, масштабируемый набор должен быть создан в [поддерживаемом регионе Azure](../availability-zones/az-overview.md#regions-that-support-availability-zones). Вы можете создать масштабируемый набор, использующий зоны доступности, с помощью одного из следующих методов:

- [портал Azure](#use-the-azure-portal)
- [Azure CLI 2.0](#use-the-azure-cli-20)
- [Azure PowerShell](#use-azure-powershell)
- [Шаблоны диспетчера ресурсов Azure](#use-azure-resource-manager-templates)

## <a name="availability-considerations"></a>Вопросы доступности
Начиная с версии API 2017-12-01, при попытке развертывания масштабируемого набора в одну или несколько зон вы можете выбрать развертывание с максимальным распространением или со статическим распространением между 5 доменами сбоя. Если выбрать максимальное распространение, масштабируемый набор распределяет виртуальные машины между максимальным количеством доступных доменов сбоя в каждой зоне. Это может быть больше или меньше пяти доменов сбоя на зону. С другой стороны, при выборе статического распространения между 5 доменами сбоя масштабируемый набор распространяет виртуальные машины точно между 5 доменами сбоя в зоне. Если масштабируемому набору не удается найти 5 отдельных доменов сбоя в каждой зоне для удовлетворения запроса на распределение, запрос завершится ошибкой.

**Для большинства рабочих нагрузок рекомендуются вариант развертывания с использованием максимального распространения**, так как в большинстве случаев он обеспечивает лучшее распространение. Если необходимо, чтобы реплики распространялись между отдельными изолированными аппаратными блоками, рекомендуется распространять их между несколькими доступными зонами и использовать максимальное распространение в каждой зоне. Обратите внимание, что при максимальном распространении в представлении экземпляра масштабируемого набора виртуальных машин и в метаданных экземпляра отображается только один домен сбоя, независимо от количества доменов сбоя, по которым фактически распределены виртуальные машины. Распределение в каждой зоне является неявным.

Чтобы использовать максимальное распространение, установите для параметра "platformFaultDomainCount" значение 1. Чтобы использовать статическое распространение между 5 доменами сбоя, установите для параметра "platformFaultDomainCount" значение 5. В версии API 2017-12-01 для параметра "platformFaultDomainCount" по умолчанию установлено значение 1 для однозонных масштабируемых наборов и тех, которые распределены между зонами. В данный момент для региональных масштабируемых наборов поддерживается только статическое распространение между 5 доменами сбоя.

Кроме того, при развертывании масштабируемого набора можно выбрать развертывание с одной или несколькими [группами размещения](./virtual-machine-scale-sets-placement-groups.md) на зону доступности (для региональных наборов масштабирования выбор состоит в том, чтобы иметь одну или несколько групп размещения в регионе). Для большинства рабочих нагрузок рекомендуется использовать несколько групп размещения, что обеспечивает лучшее масштабирование. В версии API 2017-12-01 для масштабируемых наборов (однозонных и распределенных между зонами) по умолчанию используются несколько групп размещения, но для региональных масштабируемых наборов по умолчанию используется одна группа размещения.

>[!NOTE]
> При выборе максимального распределения необходимо использовать несколько групп размещения.

И наконец, для масштабируемых наборов, развернутых в нескольких зонах, также можно выбрать между вариантом наилучшей балансировки зон и строгой балансировки зон. Масштабируемый набор считается сбалансированным, если количество виртуальных машин в каждой зоне не отличается более чем на 1 по отношению к одному из количеств во всех других зонах масштабируемого набора. Например, масштабируемый набор с 2 виртуальными машинами в зоне 1, 3 виртуальными машинами в зоне 2 и 3 виртуальными машинами в зоне 3 считается сбалансированным. Однако масштабируемый набор с 1 виртуальной машиной в зоне 1, 3 виртуальными машинами в зоне 2 и 3 виртуальными машинами в зоне 3 считается несбалансированным. Виртуальные машины в масштабируемом наборе могут быть успешно созданы, но применение расширения к этим машинам завершится сбоем. Эти виртуальные машины с ошибкой расширения все еще будут учитываться в процессе определения того, является ли масштабируемый набор сбалансированным. Например, масштабируемый набор с 3 виртуальными машинами в зоне 1, 3 виртуальными машинами в зоне 2 и 3 виртуальными машинами в зоне 3 считается сбалансированным, даже если все расширения завершились ошибкой в зоне 1, а все расширения в зонах 2 и 3 были успешными. При выборе наилучшей балансировки зон масштабируемый набор пытается выполнять свертывание и развертывание виртуальных машин, поддерживая баланс. Однако, если по некоторым причинам это сделать невозможно (например, одна зона выходит из строя, поэтому масштабируемый набор не может создать в ней виртуальную машину), тогда для успешного масштабирования масштабируемый набор позволит временный дисбаланс зон. При последующих попытках горизонтального масштабирования масштабируемый набор добавляет виртуальные машины в зоны, которым они необходимы, чтобы он снова стал сбалансированным. Аналогичным образом при последующих попытках масштабирования масштабируемый набор удаляет виртуальные машины из зон, где их должно быть меньше. С другой стороны, при использовании строгой балансировки зон масштабирование будет завершено ошибкой, если оно приведет к несбалансированному состоянию.

Чтобы использовать вариант наилучшей балансировки зон, установите для параметра "zoneBalance" значение false (это значение установлено по умолчанию в версии API 2017-12-01). Чтобы использовать строгую балансировку зон, установите для параметра "zoneBalance" значение true.

## <a name="use-the-azure-portal"></a>Использование портала Azure
Процесс создания масштабируемого набора, использующего зону доступности, описан в статье [Создание масштабируемого набора виртуальных машин с помощью Azure PowerShell](quick-create-portal.md). Убедитесь, что вы зарегистрированы [в предварительной версии зон доступности](http://aka.ms/azenroll). При выборе поддерживаемого региона Azure можно создать масштабируемый набор в одной из доступных зон, как показано в следующем примере:

![Создание масштабируемого набора в одной зоне доступности](media/virtual-machine-scale-sets-use-availability-zones/create-portal-single-az.png)

Масштабируемый набор и вспомогательные ресурсы, такие как подсистема балансировки нагрузки Azure и общедоступный IP-адрес, создаются в одной зоне, указанной вами.


## <a name="use-the-azure-cli-20"></a>Использование Azure CLI 2.0
Процесс создания масштабируемого набора, использующего зону доступности, описан в статье [Создание масштабируемого набора виртуальных машин с помощью Azure PowerShell](quick-create-cli.md). Чтобы использовать зоны доступности, необходимо создать масштабируемый набор в поддерживаемом регионе Azure и [зарегистрироваться в предварительной версии зон доступности](http://aka.ms/azenroll).

Добавьте параметр `--zones` в команду [az vmss create](/cli/azure/vmss#az_vmss_create) и укажите, какую зону использовать (например, зону *1*, *2* или *3*). В следующем примере создается однозонный масштабируемый набор *myScaleSet* в зоне *1*:

```azurecli
az vmss create \
    --resource-group myResourceGroup \
    --name myScaleSet \
    --image UbuntuLTS \
    --upgrade-policy-mode automatic \
    --admin-username azureuser \
    --generate-ssh-keys \
    --zones 1
```
Полный пример однозонного масштабируемого набора и сетевых ресурсов см. в этом [примере сценария CLI](https://github.com/Azure/azure-docs-cli-python-samples/blob/master/virtual-machine-scale-sets/create-single-availability-zone/create-single-availability-zone.sh.).

### <a name="zone-redundant-scale-set"></a>Масштабируемый набор, избыточный в пределах зоны
Чтобы создать масштабируемый набор, избыточный в пределах зоны, используйте общедоступный IP-адрес и подсистему балансировки нагрузки с номером SKU *Стандартный*. Для повышения избыточности в рамках номера SKU *Стандартный* создаются сетевые ресурсы, избыточные в пределах зоны. Дополнительные сведения см. в статье [Azure Load Balancer Standard overview (preview)](../load-balancer/load-balancer-standard-overview.md) (Обзор Azure Load Balancer уровня "Стандартный" (предварительная версия)). 

Чтобы создать масштабируемый набор, избыточный в пределах зоны, укажите несколько зон с помощью параметра `--zones`. В следующем примере создается масштабируемый набор, избыточный в пределах зоны, с именем *myScaleSet* в зонах *1,2 и 3*:

```azurecli
az vmss create \
    --resource-group myResourceGroup \
    --name myScaleSet \
    --image UbuntuLTS \
    --upgrade-policy-mode automatic \
    --admin-username azureuser \
    --generate-ssh-keys \
    --zones {1,2,3}
```

Создание и настройка всех ресурсов и виртуальных машин масштабируемого набора в указанных зонах занимает несколько минут. Полный пример масштабируемого набора, избыточного в пределах зоны, и сетевых ресурсов см. в этом [примере сценария CLI](https://github.com/Azure/azure-docs-cli-python-samples/blob/master/virtual-machine-scale-sets/create-zone-redundant-scale-set/create-zone-redundant-scale-set.sh).


## <a name="use-azure-powershell"></a>Использование Azure PowerShell
Процесс создания масштабируемого набора, использующего зону доступности, описан в статье [Создание масштабируемого набора виртуальных машин с помощью Azure PowerShell](quick-create-powershell.md). Чтобы использовать зоны доступности, необходимо создать масштабируемый набор в поддерживаемом регионе Azure и [зарегистрироваться в предварительной версии зон доступности](http://aka.ms/azenroll). Добавьте параметр `-Zone` в команду [New-AzureRmVmssConfig](/powershell/module/azurerm.compute/new-azurermvmssconfig) и укажите требуемую зону (например, *1*, *2* или *3*). 

В следующем примере создается файл конфигурации однозонного масштабируемого набора с именем *vmssConfig* в зоне *1* региона *Восточная часть США 2*:

```powershell
$vmssConfig = New-AzureRmVmssConfig `
    -Location "East US 2" `
    -SkuCapacity 2 `
    -SkuName "Standard_DS2" `
    -UpgradePolicyMode Automatic `
    -Zone "1"
```

Полный пример однозонного масштабируемого набора и сетевых ресурсов см. в этом [примере сценария PowerShell](https://github.com/Azure/azure-docs-powershell-samples/blob/master/virtual-machine-scale-sets/create-single-availability-zone/create-single-availability-zone.ps1).

### <a name="zone-redundant-scale-set"></a>Масштабируемый набор, избыточный в пределах зоны
Чтобы создать масштабируемый набор, избыточный в пределах зоны, используйте общедоступный IP-адрес и подсистему балансировки нагрузки с номером SKU *Стандартный*. Для повышения избыточности в рамках номера SKU *Стандартный* создаются сетевые ресурсы, избыточные в пределах зоны. Дополнительные сведения см. в статье [Azure Load Balancer Standard overview (preview)](../load-balancer/load-balancer-standard-overview.md) (Обзор Azure Load Balancer уровня "Стандартный" (предварительная версия)).

Чтобы создать масштабируемый набор, избыточный в пределах зоны, укажите несколько зон с помощью параметра `-Zone`. В следующем примере создается файл конфигурации масштабируемого набора, избыточного в пределах зоны, с именем *myScaleSet* в зонах *1, 2 и 3* региона *Восточная часть США 2*:

```powershell
$vmssConfig = New-AzureRmVmssConfig `
    -Location "East US 2" `
    -SkuCapacity 2 `
    -SkuName "Standard_DS2" `
    -UpgradePolicyMode Automatic `
    -Zone "1", "2", "3"
```

При создании общедоступного IP-адреса с помощью команды [New-AzureRmPublicIpAddress](/powershell/module/azurerm.network/new-azurermpublicipaddress) или подсистемы балансировки нагрузки с помощью команды [New-AzureRmLoadBalancer](/powershell/module/AzureRM.Network/New-AzureRmLoadBalancer), укажите *-SKU "Standard"* для создания сетевых ресурсов, избыточных в пределах зоны. Необходимо также создать группы безопасности сети и правила, чтобы разрешить любой трафик. Дополнительные сведения см. в статье [Azure Load Balancer Standard overview (preview)](../load-balancer/load-balancer-standard-overview.md) (Обзор Azure Load Balancer уровня "Стандартный" (предварительная версия)).

Полный пример масштабируемого набора, избыточного в пределах зоны, и сетевых ресурсов см. в этом [примере сценария PowerShell](https://github.com/Azure/azure-docs-powershell-samples/blob/master/virtual-machine-scale-sets/create-zone-redundant-scale-set/create-zone-redundant-scale-set.ps1).


## <a name="use-azure-resource-manager-templates"></a>Использование шаблонов диспетчера ресурсов Azure
Создание масштабируемого набора, использующего зону доступности, описано в статьях о начале работы для [Linux](quick-create-template-linux.md) или [Windows](quick-create-template-windows.md). Чтобы использовать зоны доступности, необходимо создать масштабируемый набор в поддерживаемом регионе Azure и [зарегистрироваться в предварительной версии зон доступности](http://aka.ms/azenroll). Добавьте свойство `zones` в тип ресурса *Microsoft.Compute/virtualMachineScaleSets* в шаблон и укажите требуемую зону (например, *1*, *2* или *3*).

В следующем примере создается однозонный масштабируемый набор Linux с именем *myScaleSet* в зоне *1* региона *Восточная часть США 2*:

```json
{
  "type": "Microsoft.Compute/virtualMachineScaleSets",
  "name": "myScaleSet",
  "location": "East US 2",
  "apiVersion": "2017-12-01",
  "zones": ["1"],
  "sku": {
    "name": "Standard_A1",
    "capacity": "2"
  },
  "properties": {
    "upgradePolicy": {
      "mode": "Automatic"
    },
    "virtualMachineProfile": {
      "storageProfile": {
        "osDisk": {
          "caching": "ReadWrite",
          "createOption": "FromImage"
        },
        "imageReference":  {
          "publisher": "Canonical",
          "offer": "UbuntuServer",
          "sku": "16.04-LTS",
          "version": "latest"
        }
      },
      "osProfile": {
        "computerNamePrefix": "myvmss",
        "adminUsername": "azureuser",
        "adminPassword": "P@ssw0rd!"
      }
    }
  }
}
```

Полный пример однозонного масштабируемого набора и сетевых ресурсов см. в этом [примере шаблона Resource Manager](https://github.com/Azure/vm-scale-sets/blob/master/zones/singlezone.json).

### <a name="zone-redundant-scale-set"></a>Масштабируемый набор, избыточный в пределах зоны
Чтобы создать масштабируемый набор, избыточный в пределах зоны, укажите несколько значений в свойстве `zones` типа ресурса *Microsoft.Compute/virtualMachineScaleSets*. В следующем примере создается масштабируемый набор, избыточный в пределах зоны, с именем *myScaleSet* в зонах *1,2 и 3* региона *Восточная часть США 2*:

```json
{
  "type": "Microsoft.Compute/virtualMachineScaleSets",
  "name": "myScaleSet",
  "location": "East US 2",
  "apiVersion": "2017-12-01",
  "zones": [
        "1",
        "2",
        "3"
      ]
}
```

При создании общедоступного IP-адреса или подсистемы балансировки нагрузки укажите свойство *"sku": { "name": "Standard" }"* для создания сетевых ресурсов, избыточных в пределах зоны. Необходимо также создать группы безопасности сети и правила, чтобы разрешить любой трафик. Дополнительные сведения см. в статье [Azure Load Balancer Standard overview (preview)](../load-balancer/load-balancer-standard-overview.md) (Обзор Azure Load Balancer уровня "Стандартный" (предварительная версия)).

Полный пример масштабируемого набора, избыточного в пределах зоны, и сетевых ресурсов см. в этом [примере шаблона Resource Manager](https://github.com/Azure/vm-scale-sets/blob/master/zones/multizone.json).


## <a name="next-steps"></a>Дополнительная информация
После создания масштабируемого набора в зоне доступности см. статьи [Развертывание приложения в масштабируемых наборах виртуальных машин](virtual-machine-scale-sets-deploy-app.md) или [Обзор автомасштабирования с помощью масштабируемых наборов виртуальных машин Azure](virtual-machine-scale-sets-autoscale-overview.md).
