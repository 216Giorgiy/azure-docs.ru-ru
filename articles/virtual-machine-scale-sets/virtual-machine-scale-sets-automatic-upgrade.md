---
title: Автоматические обновления образа ОС при использовании масштабируемых наборов виртуальных машин Azure | Документация Майкрософт
description: Узнайте, как выполнять автоматическое обновление образа операционной системы на экземплярах виртуальных машин в масштабируемом наборе
services: virtual-machine-scale-sets
documentationcenter: ''
author: rajsqr
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/25/2018
ms.author: rajraj
ms.openlocfilehash: c8ba9ac3150b5a84b2902afaaefcf78c76764fed
ms.sourcegitcommit: f0c2758fb8ccfaba76ce0b17833ca019a8a09d46
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/06/2018
ms.locfileid: "51036196"
---
# <a name="azure-virtual-machine-scale-set-automatic-os-image-upgrades"></a>Автоматические обновления образа ОС масштабируемого набора виртуальных машин Azure

Автоматическое обновление образа ОС — это компонент масштабируемых наборов виртуальных машин Azure, который автоматически обновляет все виртуальные машины до последней версии образа ОС.

Автоматическое обновление ОС имеет следующие характеристики:

- После настройки последний образ ОС, опубликованный издателем, автоматически применяется к масштабируемому набору без вмешательства пользователя.
- Пакеты экземпляров последовательно обновляются каждый раз, когда издатель публикует новый образ платформы.
- Обновление интегрируется с проверкой работоспособности приложения.
- Эта функция подходит для всех размеров виртуальных машин, а также для образов платформ Windows и Linux.
- Автоматические обновления можно в любое время отключить (обновление ОС также можно инициировать вручную).
- Диск ОС виртуальной машины заменяется новым диском ОС с последней версией образа. Запускаются настраиваемые расширения и сценарии пользовательских данных, а сохраненные диски данных сохраняются.
- Сейчас шифрование дисков Azure (в предварительной версии) не поддерживается.  

## <a name="how-does-automatic-os-image-upgrade-work"></a>Как работает автоматическое обновление образа ОС?

Обновление выполняется путем замены диска операционной системы виртуальной машины на новый, созданный с использованием последней версии образа. Настроенные расширения и скрипты пользовательских данных выполняются, а сохраненные диски данных сохраняются. Чтобы свести к минимуму время простоя приложений, обновления выполняются для пакетов виртуальных машин и в любое время обновляется не более чем 20 % масштабируемого набора. Вы также можете интегрировать проверку работоспособности приложений Azure Load Balancer. Настоятельно рекомендуется добавить пакет пульса приложения и проверять успешность обновления для каждого пакета в процессе обновления. Шаги выполнения: 

1. Перед началом процесса обновления оркестратор проверит, что не более чем 20 % экземпляров являются неработоспособными. 
2. Определите пакет экземпляров виртуальных машин для обновления. При этом пакет должен содержать максимум 20 % от общего количества экземпляров.
3. Обновите образ ОС этого пакета экземпляров виртуальных машин.
4. Если клиент настроил проверки работоспособности приложения, обновление останавливается на 5 минут, чтобы пробы вернули сообщение о работоспособности, прежде чем перейти к обновлению следующего пакета. 
5. Если остались экземпляры для обновления, перейдите к шагу 1 для следующего пакета. В противном случае обновление будет завершено.

Оркестратор обновления ОС масштабируемого набора проверяет общее состояние работоспособности экземпляров виртуальных машин перед обновлением каждого пакета. При обновлении пакета может быть выполнено другое параллельное плановое или внеплановое обслуживание в центрах обработки данных Azure, которое может повлиять на доступность ваших виртуальных машин. Следовательно, возможно, что временно более 20 % экземпляров могут быть недоступны. В таких случаях в конце обновления текущего пакета обновление масштабируемого набора прекращается.

## <a name="supported-os-images"></a>Поддерживаемые образы ОС
В настоящее время поддерживаются только определенные образы платформ ОС. Сейчас невозможно использовать самостоятельно созданные пользовательские образы. 

Сейчас поддерживаются следующие номера SKU (в дальнейшем будут добавлены дополнительные):
    
| ИЗДАТЕЛЬ               | Предложение ОС      |  Sku               |
|-------------------------|---------------|--------------------|
| Canonical               | UbuntuServer  | 16.04-LTS          |
| Canonical               | UbuntuServer  | 18.04-LTS*        | 
| Rogue Wave (OpenLogic)  | CentOS        | 7.5*              | 
| CoreOS                  | CoreOS        | Stable             | 
| Корпорация Майкрософт   | WindowsServer | 2012-R2-Datacenter | 
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter    | 
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter-Smalldisk |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter-with-Containers |

* В данный момент реализуется поддержка этих образов, и вскоре они будут доступны во всех регионах Azure. 

## <a name="requirements-for-configuring-automatic-os-image-upgrade"></a>Требования к настройке автоматического обновления образа ОС

- Для свойства *version* образа платформы следует установить значение *latest*.
- Используйте проверки работоспособности приложений для масштабируемых наборов, не относящихся к Service Fabric.
- Убедитесь, что ресурсы, указанные в модели масштабируемого набора, доступны и актуальны. 
  Например, универсальный код ресурса (URI) SAS для начальной загрузки полезных данных в свойствах расширения виртуальной машины, полезные данные в учетной записи хранения, ссылки на секреты в модели. 

## <a name="configure-automatic-os-image-upgrade"></a>Настройка автоматического обновления образа ОС
Чтобы настроить автоматическое обновление образа ОС, убедитесь, что свойство *automaticOSUpgradePolicy.enableAutomaticOSUpgrade* установлено как *true* в определении модели масштабируемого набора. 

```
PUT or PATCH on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/myScaleSet?api-version=2018-10-01`
```

```json
{ 
  "properties": { 
    "upgradePolicy": { 
      "automaticOSUpgradePolicy": { 
        "enableAutomaticOSUpgrade":  true 
      } 
    } 
  } 
} 
```

В следующем примере используется Azure CLI (2.0.47 или более поздней версии) для настройки автоматического обновления масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*:

```azurecli
az vmss update --name myVMSS --resource-group myResourceGroup --set UpgradePolicy.AutomaticOSUpgradePolicy.EnableAutomaticOSUpgrade=true
```
Поддержка настройки этого свойства с помощью Azure PowerShell будет реализована в ближайшее время.

## <a name="using-application-health-probes"></a>Использование проверок работоспособности приложений 

Во время обновления ОС экземпляры виртуальных машин в масштабируемом наборе обновляются по одному пакету. Обновление должно продолжаться, только если приложение клиента работоспособно на обновленных экземплярах виртуальных машин. Мы рекомендуем настроить приложение таким образом, чтобы оно сообщало о работоспособности в модуль обновления ОС масштабируемого набора. По умолчанию при обновлении ОС платформа анализирует состояние энергопотребления виртуальной машины и состояние подготовки расширений, чтобы определить, является ли экземпляр виртуальной машины работоспособным после обновления. Во время обновления ОС экземпляра виртуальной машины диск ОС экземпляра заменяется новым диском на основе последней версии образа. После обновления ОС настроенные расширения запускаются на этих виртуальных машинах. Приложение считается работоспособным, только если все расширения на виртуальной машине успешно подготовлены. 

Для масштабируемого набора можно дополнительно настроить проверки работоспособности приложений, с помощью которых платформа сможет получать точную информацию о текущем состоянии приложения. Проверки работоспособности приложения — это проверки пользовательского балансировщика нагрузки, которые используются в качестве сообщения о работоспособности. Приложение, работающее на экземпляре виртуальной машины из масштабируемого набора, может отвечать на внешние HTTP- или TCP-запросы, указывающие на его работоспособность. Дополнительные сведения о работе проверок пользовательского балансировщика нагрузки см. в статье [Проверки балансировщика нагрузки](../load-balancer/load-balancer-custom-probe-overview.md). Проверка работоспособности приложения не требуется для автоматического обновления ОС, но настоятельно рекомендуется выполнять ее.

Если масштабируемый набор настроен для использования нескольких групп размещения, необходимо использовать проверки с [балансировщиком нагрузки уровня "Стандартный"](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-overview).

### <a name="configuring-a-custom-load-balancer-probe-as-application-health-probe-on-a-scale-set"></a>Настройка пользовательской проверки балансировщика нагрузки в качестве проверки работоспособности приложения в масштабируемом наборе
Мы рекомендуем явно создать проверку балансировщика нагрузки на работоспособность масштабируемого набора. Вы можете использовать одну конечную точку для имеющейся проверки HTTP или TCP, но для проверки работоспособности может потребоваться подход, отличный от традиционного для проверки балансировщика нагрузки. Например, при традиционной проверке балансировщика нагрузки может вернуться сообщение о нерабочем состоянии, если нагрузка на экземпляр слишком высока. Такая проверка может оказаться непригодной для определения работоспособности экземпляра во время автоматического обновления ОС. Настройте для проверки высокую частоту (менее двух минут).

Проверка балансировщика нагрузки может быть указана в параметре *networkProfile* масштабируемого набора и может быть связана либо с внутренним, либо с общедоступным балансировщиком нагрузки следующим образом:

```json
"networkProfile": {
  "healthProbe" : {
    "id": "[concat(variables('lbId'), '/probes/', variables('sshProbeName'))]"
  },
  "networkInterfaceConfigurations":
  ...
```
> [!NOTE]
> При использовании автоматического обновления ОС с помощью Service Fabric домен обновления развертывает новый образ ОС, чтобы обеспечить высокий уровень доступности для служб, работающих в Service Fabric. Для использования автоматических обновлений ОС в Service Fabric ваш кластер должен быть настроен на использование уровня надежности Silver или выше. Дополнительные сведения о характеристиках устойчивости кластера Service Fabric см. в [этой документации](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster).

### <a name="keep-credentials-up-to-date"></a>Поддержание актуальности учетных данных
Если ваш масштабируемый набор использует любые учетные данные для доступа к внешним ресурсам, например, если настроено расширение виртуальной машины, которое использует маркер SAS для учетной записи хранения, убедитесь, что учетные данные обновлены. Если срок действия всех учетных данных, в том числе сертификатов и маркеров, истек, обновление завершится сбоем, а первый пакет виртуальных машин останется в состоянии сбоя.

В случае сбоя аутентификации ресурса рекомендуем выполнить следующие шаги по восстановлению виртуальных машин и повторному включению автоматического обновления ОС.

* Повторно создайте маркер (или любые другие учетные данные), переданный в ваши расширения.
* Убедитесь, что все учетные данные, используемые внутри виртуальной машины для взаимодействия с внешними сущностями, обновлены.
* Обновите расширения в модели масштабируемого набора с новыми маркерами.
* Разверните обновленный масштабируемый набор, в котором будут обновлены все экземпляры виртуальных машин, включая сбойные. 

## <a name="get-the-history-of-automatic-os-image-upgrades"></a>Получение журнала автоматического обновления образа ОС 
Вы можете проверить журнал последнего обновления ОС масштабируемого набора с помощью Azure PowerShell, Azure CLI 2.0 или интерфейсов REST API. Можно просмотреть журнал для последних пяти попыток обновлений операционной системы в течение последних двух месяцев.

### <a name="azure-powershell"></a>Azure PowerShell
В следующем примере используется Azure PowerShell для проверки состояния масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*:

```powershell
Get-AzureRmVmss -ResourceGroupName myResourceGroup -VMScaleSetName myVMSS -OSUpgradeHistory
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
В следующем примере используется Azure CLI (2.0.47 или более поздней версии) для проверки состояния масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*:

```azurecli
az vmss get-os-upgrade-history --resource-group myResourceGroup --name myVMSS
```

### <a name="rest-api"></a>REST API
В следующем примере используется REST API для проверки состояния масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*:

```
GET on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/myScaleSet/osUpgradeHistory?api-version=2018-10-01`
```
Документацию по этому API можно найти по адресу: https://docs.microsoft.com/rest/api/compute/virtualmachinescalesets/getosupgradehistory.

Вызов GET возвращает подобные свойства:

```json
{
  "value": [
    {
      "properties": {
        "runningStatus": {
          "code": "RollingForward",
          "startTime": "2018-07-24T17:46:06.1248429+00:00",
          "completedTime": "2018-04-21T12:29:25.0511245+00:00"
        },
        "progress": {
          "successfulInstanceCount": 16,
          "failedInstanceCount": 0,
          "inProgressInstanceCount": 4,
          "pendingInstanceCount": 0
        },
        "startedBy": "Platform",
        "targetImageReference": {
          "publisher": "MicrosoftWindowsServer",
          "offer": "WindowsServer",
          "sku": "2016-Datacenter",
          "version": "2016.127.20180613"
        },
        "rollbackInfo": {
          "successfullyRolledbackInstanceCount": 0,
          "failedRolledbackInstanceCount": 0
        }
      },
      "type": "Microsoft.Compute/virtualMachineScaleSets/rollingUpgrades",
      "location": "westeurope"
    }
  ]
} 
```

## <a name="how-to-get-the-latest-version-of-a-platform-os-image"></a>Как получить последнюю версию образа платформы ОС? 

Вы можете получить версии образов для автоматического обновления ОС (для поддерживаемых номеров SKU) с помощью приведенных ниже примеров: 

```
GET on `/subscriptions/subscription_id/providers/Microsoft.Compute/locations/{location}/publishers/{publisherName}/artifacttypes/vmimage/offers/{offer}/skus/{skus}/versions?api-version=2018-10-01`
```

```powershell
Get-AzureRmVmImage -Location "westus" -PublisherName "Canonical" -Offer "UbuntuServer" -Skus "16.04-LTS"
```

```azurecli
az vm image list --location "westus" --publisher "Canonical" --offer "UbuntuServer" --sku "16.04-LTS" --all
```

## <a name="deploy-with-a-template"></a>Развертывание с помощью шаблона

Следующий шаблон можно использовать для развертывания масштабируемого набора, для которого используются <a href='https://github.com/Azure/vm-scale-sets/blob/master/preview/upgrade/autoupdate.json'>последовательные автоматические обновления Ubuntu 16.04-LTS</a>.

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fvm-scale-sets%2Fmaster%2Fpreview%2Fupgrade%2Fautoupdate.json" target="_blank">
    <img src="http://azuredeploy.net/deploybutton.png"/>
</a>

## <a name="next-steps"></a>Дополнительная информация
Дополнительные примеры использования автоматических обновлений ОС с масштабируемыми наборами см. на странице [предварительной версии функций в репозитории GitHub](https://github.com/Azure/vm-scale-sets/tree/master/preview/upgrade).
