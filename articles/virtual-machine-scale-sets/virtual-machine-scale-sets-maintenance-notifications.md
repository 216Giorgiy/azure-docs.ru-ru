---
title: Работа с уведомлениями об обслуживании масштабируемых наборов виртуальных машин в Azure | Документация Майкрософт
description: Сведения о просмотре уведомлений об обслуживании масштабируемых наборов виртуальных машин в Azure и запуске самообслуживания.
services: virtual-machine-scale-sets
documentationcenter: ''
author: shants123
editor: ''
tags: azure-service-management,azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/09/2018
ms.author: shants
ms.openlocfilehash: 4ce984686c2bb320d5d32771d31b81cdec1153af
ms.sourcegitcommit: 0a84b090d4c2fb57af3876c26a1f97aac12015c5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2018
ms.locfileid: "38506261"
---
# <a name="handling-planned-maintenance-notifications-for-virtual-machine-scale-sets"></a>Работа с уведомлениями о плановом обслуживании масштабируемых наборов виртуальных машин

Azure периодически выполняет обновления, чтобы повысить надежность, производительность и безопасность инфраструктуры узлов, в которой работают виртуальные машины. Обновления — это изменения, такие как исправление среды размещения или модернизация оборудования и вывод его из эксплуатации. Большинство этих обновлений не влияют на работу размещенных виртуальных машин. Но в некоторых случаях они все же оказывают определенное воздействие:

- Если обслуживание не требует перезагрузки, Azure с помощью миграции на месте приостанавливает работу виртуальной машины во время обновления узла. Эти операции обслуживания, не требующие перезагрузки, выполняются по доменам сбоя, и их выполнение будет прервано, если будет получено предупреждение о проблемах с работоспособностью.

- Если для обслуживания требуется перезагрузка, вы получите уведомление во время планирования обслуживания. В этих случаях вам предоставляется временное окно, в котором вы можете начать обслуживание самостоятельно в удобное для вас время.


Плановое обслуживание, требующее перезагрузки, запланировано в волнах. Каждая волна имеет разную область (регионы).

- Волна начинается с уведомления клиентов. По умолчанию уведомление отправляется владельцу и совладельцам подписки. С помощью [оповещений журнала действий](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md) Azure вы можете добавить дополнительных получателей и методы доставки уведомлений, такие как электронная почта, текстовые сообщения или веб-перехватчики.  
- С момента создания уведомления начинается *период самообслуживания*. До завершения этого периода вы можете самостоятельно выяснить, для каких виртуальных машин запланировано обновление на этом этапе, и выполнить для них упреждающее обслуживание с учетом собственных пожеланий к графику работы.
- После периода самообслуживания, начинается *период запланированного обслуживания*. В некоторый момент этого периода Azure назначает и применяет для вашей виртуальной машины необходимые операции обслуживания. 

Два периода нужны, чтобы у вас было достаточно времени для запуска обслуживания и перезагрузки виртуальной машины до того, как Azure начнет обслуживание автоматически.


Чтобы получить информацию об окнах обслуживания и запустить самообслуживание для виртуальных машин, включенных в масштабируемые наборы виртуальных машин, используйте портал Azure, PowerShell, REST API или CLI.

  
## <a name="should-you-start-maintenance-during-the-self-service-window"></a>Нужно ли начинать обслуживание в период самообслуживания?  

Следующие рекомендации помогут решить, есть ли смысл использовать эту возможность для обслуживания по собственному графику.

> [!NOTE] 
> Самостоятельное обслуживание может оказаться недоступным для некоторых виртуальных машин. Чтобы определить, доступно ли упреждающее обслуживание для ваших виртуальных машин, проверьте наличие ссылки **Начать сейчас** в информации о состоянии обслуживания. Самообслуживание в настоящее время недоступно для облачных служб (веб-ролей и рабочих ролей) и Service Fabric.


Мы не рекомендуем применять самообслуживание для развертываний, использующих **наборы доступности**, поскольку для них соблюдаются высокие требования к доступности и любые обновления в любой момент времени могут затрагивать только один домен обновления. 

- Позвольте Azure управлять запуском обслуживания. При проведении обслуживания, требующего перезагрузки, следует помнить, что обслуживание выполняется по доменам обновления, домены обновления необязательно обслуживаются последовательно и между обслуживанием доменов обновлений происходит 30-минутная пауза.
- Если для вас недопустима временная потеря мощности или пропускной способности (в объеме, обратно пропорциональном количеству доменов обновления), эту проблему можно легко устранить: добавьте на весь период обслуживания необходимое количество дополнительных экземпляров.
- Для обслуживания, не требующего перезагрузки, обновления применяются на уровне домена сбоя. 
    
**Не применяйте** режим самообслуживания в следующих ситуациях. 

- Если вы часто завершаете работу виртуальных машин, вручную, с помощью DevTest Labs, автоматического завершения работы или по расписанию. Перезагрузка может сбросить текущее состояние обслуживания, что приведет к дополнительным простоям.
- Если вы используете виртуальные машины в течение короткого периода, то есть они наверняка будут удалены до завершения периода обслуживания. 
- Если вы используете рабочие нагрузки с большим объемом информации о состоянии, которая хранится на локальном (временном) диске и должна сохраняться после обновления. 
- Если вы часто изменяете размер виртуальной машины, поскольку это действие может привести к сбросу состояния обслуживания. 
- Если вы настроили запланированные события, которые выполняют для рабочей нагрузки упреждающую отработку отказа или корректное завершение работы за 15 минут до выключения на обслуживание.

Обязательно **используйте** самообслуживание, если вы намерены использовать виртуальную машину без перерыва в течение всего периода запланированного обслуживания и ваша система не соответствует ни одному из "блокирующих" условий, которые перечислены выше. 

Режим самообслуживания лучше всего подходит для следующих ситуаций.

- Если вам нужно сообщить руководству или клиенту точное время обслуживания. 
- Если вам важно завершить обслуживание не позднее определенной даты. 
- Если вам важно соблюдать определенную последовательность обслуживания, например, чтобы гарантировать безопасное восстановление для многоуровневого приложения.
- Если вам нужна пауза более 30 минут для восстановления виртуальных машин между периодами обслуживания двух доменов обновления. Чтобы управлять длительностью пауз между обслуживанием доменов обновления, запускайте обслуживание виртуальных машин только для одного домена обновления.

 
## <a name="view-virtual-machine-scale-sets-impacted-by-maintenance-in-the-portal"></a>Просмотр масштабируемых наборов виртуальных машин, в отношении которые будет выполняться обслуживание, на портале

Когда будет запланирована очередная волна обслуживания, вы сможете просмотреть список соответствующих масштабируемых наборов виртуальных машин на портале Azure. 

1. Войдите на [портале Azure](https://portal.azure.com).
2. В области навигации слева выберите **Все службы**, а затем — **Масштабируемые наборы виртуальных машин**.
3. Вверху страницы **Масштабируемые наборы виртуальных машин** выберите действие **Изменить столбцы**, чтобы открыть список доступных столбцов.
4. В разделе **Доступные столбцы** выберите элемент **Самообслуживание** и с помощью кнопок со стрелочками переместите его в список **Выбранные столбцы**. В раскрывающемся списке **Доступные столбцы** вместо значения **Все** можно выбрать значение **Свойства**, чтобы было проще найти элемент **Самообслуживание**. Когда элемент **Самообслуживание** будет в списке **Выбранные столбцы**, нажмите кнопку **Применить** в нижней части страницы. 

Когда вы выполните описанную выше процедуру, столбец **Самообслуживание** появится в списке масштабируемых наборов виртуальных машин. Для каждого масштабируемого набора виртуальных машин в столбце "Самообслуживание" может быть одно из следующих значений.

| Значение | ОПИСАНИЕ |
|-------|-------------|
| Да | По меньшей мере одна из виртуальных машин в этом наборе находится в окне самообслуживания. В период самообслуживания обслуживание можно запустить в любое время. | 
| Нет | В этом наборе нет ни одной виртуальной машины, находящейся в окне самообслуживания. | 
| - | Все эти виртуальные машины не будут затронуты предстоящей волной планового обслуживания.| 

## <a name="notification-and-alerts-in-the-portal"></a>Уведомление и оповещения на портале

Azure извещает расписание планового обслуживания, отправив сообщение владельцу подписки или группе совладельцев. Можно добавить дополнительных получателей и каналы для получения этой информации путем создания оповещений журнала действий Azure. Дополнительные сведения см. в статье [Мониторинг действий подписки с помощью журнала действий Azure] (../monitoring-and-diagnostics/monitoring-overview-activity-logs.md).

1. Войдите на [портале Azure](https://portal.azure.com).
2. В меню слева выберите **Монитор**. 
3. На панели **Монитор — Оповещения (классические)** щелкните **Добавить оповещение журнала действий**.
4. Введите данные на странице **Добавить оповещение журнала действий**, обязательно указав следующие **критерии**:
   - **Категория событий** — работоспособность службы.
   - **Службы** — масштабируемые наборы виртуальных машин и виртуальные машины.
   - **Тип** — плановое обслуживание. 
    
Дополнительные сведения о том, как настроить оповещения журнала действий, см. в разделе [Создание оповещений журнала действий](../monitoring-and-diagnostics/monitoring-activity-log-alerts.md).
    
    
## <a name="start-maintenance-on-your-virtual-machine-scale-set-from-the-portal"></a>Запуск обслуживания масштабируемого набора виртуальных машин на портале

В информации о масштабируемых наборах виртуальных машин содержатся дополнительные сведения, связанные с обслуживанием. Если по крайней мере одна виртуальная машина в масштабируемом наборе виртуальных машин включена в очередную волну планового обслуживания, в верхней части страницы появится уведомление. Щелкните это уведомление, чтобы перейти на страницу **Обслуживание** и узнать, какой экземпляр виртуальной машины будет затронут плановым обслуживанием. 

На этой же странице можно самостоятельно запустить обслуживание. Для этого установите флажок рядом с нужной виртуальной машиной и щелкните **Начать обслуживание**.

Как только вы запустите обслуживание, соответствующие виртуальные машины из масштабируемого набора начнут обслуживаться и станут временно недоступны. Если вы пропустите период самообслуживания, вам будет доступна информация о времени, когда Azure проведет автоматическое обслуживание этого масштабируемого набора виртуальных машин.
 
## <a name="check-maintenance-status-using-powershell"></a>Проверка состояния обслуживания с помощью PowerShell

Чтобы узнать, на когда запланировано обслуживание виртуальных машин в масштабируемых наборах виртуальных машин, можно также использовать Azure PowerShell. Информацию о плановом обслуживании можно получить, выполнив командлет [Get AzureRmVmss](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmss) с параметром `-InstanceView`.
 
Сведения об обслуживании возвращаются, только если имеется запланированное обслуживание. Если нет запланированного обслуживания, затрагивающего этот экземпляр виртуальной машины, командлет не возвращает информацию об обслуживании. 

```powershell
Get-AzureRmVmss -ResourceGroupName rgName -VMScaleSetName vmssName -InstanceId id -InstanceView
```

В разделе MaintenanceRedeployStatus возвращаются следующие свойства: 
| Значение | ОПИСАНИЕ   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на виртуальной машине ||
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| PreMaintenanceWindowEndTime           | Завершение периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. ||
| MaintenanceWindowEndTime              | Завершение периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. ||
| LastOperationResultCode               | Результат последней попытки инициирования обслуживания на виртуальной машине ||



### <a name="start-maintenance-on-your-vm-instance-using-powershell"></a>Запуск обслуживания экземпляра виртуальной машины с помощью PowerShell

Если для параметра **IsCustomerInitiatedMaintenanceAllowed** задано значение True, обслуживание виртуальной машины можно запустить с помощью командлета [Set-AzureRmVmss](/powershell/module/azurerm.compute/set-azurermvmss) с параметром `-PerformMaintenance`.

```powershell
Set-AzureRmVmss -ResourceGroupName rgName -VMScaleSetName vmssName -InstanceId id -PerformMaintenance 
```

## <a name="check-maintenance-status-using-cli"></a>Проверка состояния обслуживания с помощью CLI

Сведения о плановом обслуживании можно получить с помощью команды [az vmss list-instances](/cli/azure/vmss?view=azure-cli-latest#az-vmss-list-instances).
 
Сведения об обслуживании возвращаются, только если имеется запланированное обслуживание. Если нет запланированного обслуживания, затрагивающего этот экземпляр виртуальной машины, команда не возвращает информацию об обслуживании. 

```azure-cli
az vmss list-instances -g rgName -n vmssName --expand instanceView
```

Для каждого экземпляра виртуальной машины в разделе MaintenanceRedeployStatus возвращаются следующие свойства: 
| Значение | ОПИСАНИЕ   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на виртуальной машине ||
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| PreMaintenanceWindowEndTime           | Завершение периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. ||
| MaintenanceWindowEndTime              | Завершение периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. ||
| LastOperationResultCode               | Результат последней попытки инициирования обслуживания на виртуальной машине ||


### <a name="start-maintenance-on-your-vm-instance-using-cli"></a>Запуск обслуживания экземпляра виртуальной машины с помощью CLI

Если для параметра `IsCustomerInitiatedMaintenanceAllowed` задано значение True, обслуживание экземпляра виртуальной машины можно инициировать таким вызовом:

```azure-cli
az vmss perform-maintenance -g rgName -n vmssName --instance-ids id
```

## <a name="faq"></a>Часто задаваемые вопросы


**Вопрос. Зачем вам нужно перезагружать сейчас мою виртуальную машину?**

**Ответ.** Хотя обновления платформы Azure преимущественно не оказывают влияния на доступность виртуальных машин, иногда мы не можем избежать перезагрузки виртуальных машин, размещенных в Azure. Мы хотим внести несколько изменений, и для этого нам нужно перезапустить наши серверы. Это, в свою очередь, приведет к перезагрузке виртуальных машин.

**Вопрос. Безопасно ли выполнять рекомендации по обеспечению высокой доступности с помощью группы доступности?**

**Ответ.** Для виртуальных машин, развернутых в группе доступности или масштабируемом наборе виртуальных машин, применяется концепция доменов обновления. Во время обслуживания Azure учитывает ограничения доменов обновления и не выполняет перезагрузку виртуальных машин из разных доменов обновления (в пределах одной и той же группы доступности).  Azure также ожидает минимум 30 минут, прежде чем переходить к следующей группе виртуальных машин. 

Дополнительные сведения о высоком уровне доступности есть в статье о [регионах и доступности виртуальных машин в Azure](../virtual-machines/windows/regions-and-availability.md).

**Вопрос. Как происходит информирование о плановом обслуживании?**

**Ответ.** Процедура планового обслуживания начинается с настройки расписания для одного или нескольких регионов Azure. Вскоре после этого владельцам подписки отправляется уведомление по электронной почте (одно сообщение для каждой подписки). Дополнительные каналы и получатели для этого уведомления можно настроить с помощью оповещений журнала действий. При развертывании виртуальной машины в регионе, в котором плановое обслуживание назначено по расписанию, вы не получите уведомление. Вам нужно будет проверить состояние обслуживания виртуальной машины.

**Вопрос. Информация о плановом обслуживании не отображается на портале, в PowerShell или интерфейсе командной строки. В чем проблема?**

**Ответ.** Сведения о плановом обслуживании доступны в ходе этой процедуры только для виртуальных машин, которые включены в плановое обслуживание. Другими словами, если данные не отображаются, это значит, что процедура обслуживания уже завершена (или не начата) или виртуальная машина уже размещена на обновленном сервере.

**Вопрос. Можно ли точно узнать, когда моя виртуальная машина будет затронута?**

**Ответ.** При планировании расписания мы определяем временное окно в несколько дней. Но точная последовательность серверов (и связанных виртуальных машин) в рамках этого окна неизвестна. Если клиенту нужно знать точное время обслуживания виртуальных машин, он может применить [запланированные события](../virtual-machines/windows/scheduled-events.md) и запросы из виртуальных машин, чтобы получить уведомление за 15 минут до перезагрузки виртуальной машины.

**Вопрос. Как долго моя виртуальная машина будет перезагружаться?**

**Ответ.** Перезагрузка в течение периода самообслуживания может занять несколько минут в зависимости от размера виртуальной машины. Перезагрузка, инициированная Azure в период запланированного обслуживания, обычно занимает около 25 минут. Если вы используете облачные службы (рабочие роли и веб-роли), масштабируемые наборы виртуальных машин или группы доступности, то вы получите дополнительную паузу 30 минут между обновлением разных групп (доменов обновления) виртуальных машин в период запланированного обслуживания. 

**Вопрос. Информация об обслуживании не отображается в виртуальных машинах. В чем может быть проблема?**

**Ответ.** Есть несколько причин, по которым вы можете не видеть информацию об обслуживании в виртуальных машинах:
   - Вы используете подписку, отмеченную в Майкрософт как внутренняя.
   - Для виртуальных машин не запланировано обслуживание. Процедура обслуживания завершена, отменена или изменена так, чтобы не влиять на виртуальные машины.
   - В представлении списка виртуальных машин отсутствует столбец **Обслуживание**. Хотя мы добавили этот столбец в представление по умолчанию, клиенты, которые настроили отображение пользовательских столбцов, должны вручную добавить столбец **Обслуживание** в представление списка виртуальных машин.

**Вопрос. Для моей виртуальной машины запланировано обслуживание во второй раз. Почему?**

**Ответ.** Есть несколько ситуаций, когда для виртуальной машины может быть запланирована еще одна процедура после обслуживания с повторным развертыванием:
   - Мы отменили процедуру обслуживания и перезапустили ее с другими полезными данными. Мы обнаружили неисправные полезные данные, и нам просто нужно развернуть дополнительные полезные данные.
   - Виртуальная машина *восстановлена* на другой узел из-за сбоя оборудования.
   - Вы решили остановить (отменить распределение) и перезапустить виртуальную машину.
   - Вы настроили **автоматическое завершение работы** для виртуальной машины.

## <a name="next-steps"></a>Дополнительная информация

Узнайте, как зарегистрироваться для событий обслуживания прямо из виртуальной машины с помощью функции [запланированных событий](../virtual-machines/windows/scheduled-events.md).
