---
title: "Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин | Документация Майкрософт"
description: "Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин. Описание типичных проблем и способов их устранения."
services: virtual-machine-scale-sets
documentationcenter: 
author: gbowerman
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: c7d87b72-ee24-4e52-9377-a42f337f76fa
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: windows
ms.devlang: na
ms.topic: article
ms.date: 10/28/2016
ms.author: guybo
ms.translationtype: Human Translation
ms.sourcegitcommit: 197ebd6e37066cb4463d540284ec3f3b074d95e1
ms.openlocfilehash: bd45a0fb99a77851aa7b91d23bd4b830b6f5cc7b
ms.contentlocale: ru-ru
ms.lasthandoff: 03/31/2017

---
# <a name="troubleshooting-autoscale-with-virtual-machine-scale-sets"></a>Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин
**Описание проблемы.** Вы создали в Azure Resource Manager инфраструктуру автоматического масштабирования с помощью масштабируемых наборов виртуальных машин (например, развернув шаблон, похожий на этот: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale) и установили определенные правила масштабирования. Все работает великолепно, но независимо от уровня нагрузки на виртуальные машины автомасштабирование не выполняется.

## <a name="troubleshooting-steps"></a>Действия по устранению неполадок
Вот некоторые моменты, которые следует проверить в такой ситуации.

* Сколько ядер у каждой виртуальной машины и все ли они загружены?
  В приведенном выше шаблоне быстрой настройки Azure есть сценарий do_work.php, который загружает только одно ядро. Если вы используете более крупные виртуальные машины, чем одноядерная, например Standard_A1 и D1, такую загрузку следует запускать несколько раз. Узнать количество ядер в виртуальных машинах вам поможет статья [Размеры виртуальных машин в Azure](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* Сколько виртуальных машин в вашем масштабируемом наборе и все ли они выполняют работу?
  
    Событие развертывания происходит только тогда, когда средняя нагрузка на процессор для **всех** виртуальных машин в наборе масштабирования превышает пороговое значение в течение определенного интервала, который установлен в правилах автоматического масштабирования.
* Возможно, вы пропустили события масштабирования?
  
    Проверьте, нет ли записей о событиях масштабирования в журналах аудита на портале Azure. Возможно, вы пропустили произошедшее увеличение или уменьшение масштаба. Можно отфильтровать элементы, введя в соответствующее поле запрос "Масштаб".
  
    ![Журналы аудита][audit]
* Отличаются ли пороговые значения для увеличения и уменьшения масштаба?
  
    Предположим, что вы установили такие правила: увеличивать масштаб, если среднее использование ЦП в течение 5 минут превышает 50 %; уменьшать масштаб, если среднее использование ЦП меньше 50 %. Такая конфигурация настройки приводит к нестабильности. Когда загрузка ЦП приблизится к пороговому значению, действия по увеличению и уменьшению масштаба будут выполняться постоянно, непрерывно изменяя размер набора. Служба автомасштабирования пытается предотвратить эту проблему, и в результате масштабирование может не выполняться вовсе. Поэтому убедитесь, что пороговые значения для действий по увеличению и уменьшению масштаба ощутимо отличаются.
* Вы сами написали шаблон JSON?
  
    В нем легко допустить ошибку. Мы рекомендуем взять за основу уже готовый и проверенный шаблон (например, см. приведенный выше), а затем поэтапно вносить в него небольшие изменения. 
* Можете ли вы выполнить увеличение или уменьшение масштаба вручную?
  
    Попробуйте вручную изменить количество виртуальных машин в масштабируемом наборе. Для этого повторно разверните ресурс набора, указав другое значение для параметра capacity. Здесь вы найдете пример подходящего шаблона: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing. Если потребуется, измените этот шаблон, чтобы в нем был указан тот же размер виртуальных машин, который используется в вашем масштабируемом наборе. Если вам удается изменить количество виртуальных машин вручную, значит, проблема связана именно с автоматическим масштабированием.
* Проверьте ресурсы Microsoft.Compute/virtualMachineScaleSet и Microsoft.Insights в [обозревателе ресурсов Azure](https://resources.azure.com/)
  
    Это незаменимый инструмент для устранения неполадок, в котором отображается состояние ресурсов Azure Resource Manager. Откройте свою подписку и обратите внимание на группу ресурсов, в которой вы устраняете неполадки. В разделе поставщика вычислительных ресурсов найдите созданный масштабируемый набор виртуальных машин и откройте для него представление экземпляра. Здесь вы увидите состояние развертывания набора. Также проверьте представление экземпляра для виртуальных машин, входящих в масштабируемый набор. Затем перейдите к поставщику ресурса Microsoft.Insights и проверьте, правильно ли там указаны правила автоматического масштабирования.
* Работает ли расширение службы диагностики и отправляет ли оно данные о производительности?
  
    **Обновление.** Автомасштабирование Azure усовершенствовано для использования конвейера метрик на основе узла, для которого больше не требуется устанавливать расширение диагностики. Это значит, что при создании приложения для автомасштабирования с помощью нового конвейера следующие несколько разделов не пригодятся. Пример шаблонов Azure, которые были преобразованы для использования конвейера узла, находится по адресу: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale. 
  
    Для автомасштабирования рекомендуется использовать метрики на базе узла по следующим причинам:
  
  * Меньшее количество перемещаемых элементов, так как расширения диагностики устанавливать не нужно.
  * Простые шаблоны. Просто добавьте правила автомасштабирования аналитики в имеющийся шаблон масштабируемого набора.
  * Более надежная система отчетов и ускоренный запуск новых виртуальных машин.
    
    Вы можете продолжать использовать расширение диагностики, только если вам понадобятся возможности составления отчетов и масштабирования диагностики памяти. Метрики на основе узла не позволяют формировать отчеты о памяти.
    
    Учитывая только что сказанное, следуйте указаниям в оставшейся части этой статьи, если вы все еще используете расширения диагностики для автомасштабирования.
    
    Автомасштабирование в Azure Resource Manager можно (но не нужно) выполнять с использованием расширения виртуальной машины, которое называется расширением системы диагностики. Это расширение передает данные о производительности в учетную запись хранения, которая указана в шаблоне. Затем служба Azure Monitor обрабатывает эти данные.
    
    Если служба аналитики не может получить данные о виртуальных машинах (например, если они отключены), вам будет отправлено сообщение по электронной почте. Проверьте почтовый ящик, который вы указали при создании учетной записи Azure.
    
    Также вы можете самостоятельно проверить эти данные. Откройте учетную запись хранения Azure в Cloud Explorer. Например, войдите в систему с помощью [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2), выберите подписку Azure, которую вы используете, и имя учетной записи хранения для диагностики, которая указана в определении расширения диагностики в шаблоне развертывания.
    
    ![Cloud Explorer][explorer]
    
    Вы увидите множество таблиц, в которых хранятся данные, собранные от каждой виртуальной машины. Давайте для примера выберем виртуальную машину Linux и метрику загрузки процессора. Посмотрите на последние строки. Visual Studio Cloud Explorer поддерживает язык запросов, поэтому вы можете создать запрос для получения самых свежих данных, например: Timestamp gt datetime’2016-02-02T21:20:00Z’ (время указано в формате UTC). Соответствуют ли выбранным правилам масштабирования те данные, которые вы здесь видите? В приведенном ниже примере загрузка ЦП для виртуальной машины 20 за последние 5 минут поднялась до уровня 100 %.
    
    ![Таблицы хранилища][tables]
    
    Если данных здесь нет, это значит, что проблема связана с расширением системы диагностики, которое запущено на виртуальных машинах. Если данные есть, проблема вызвана ошибкой в правилах масштабирования или в службе аналитики. Проверьте [состояние Azure](https://azure.microsoft.com/status/).
    
    Если все описанные шаги не принесли результата и у вас все еще есть проблемы с автомасштабированием, опубликуйте свой вопрос на форумах [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp) или на сайте [Stack Overflow](http://stackoverflow.com/questions/tagged/azure) или же обратитесь в службу поддержки. Подготовьте шаблон и представление данных о производительности, чтобы предоставить их вместе с запросом.

[audit]: ./media/virtual-machine-scale-sets-troubleshoot/image3.png
[explorer]: ./media/virtual-machine-scale-sets-troubleshoot/image1.png
[tables]: ./media/virtual-machine-scale-sets-troubleshoot/image4.png

