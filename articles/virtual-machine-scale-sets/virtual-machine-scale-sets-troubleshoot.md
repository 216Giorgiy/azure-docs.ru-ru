<properties
	pageTitle="Устранение неполадок при автоматическом масштабировании масштабируемых наборов виртуальных машин | Microsoft Azure"
	description="Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин. Описание типичных проблем и способов их устранения."
	services="virtual-machine-scale-sets"
	documentationCenter=""
	authors="gbowerman"
	manager="timlt"
	editor=""
	tags="azure-resource-manager"/>

<tags
	ms.service="virtual-machine-scale-sets"
	ms.workload="na"
	ms.tgt_pltfrm="windows"
	ms.devlang="na"
	ms.topic="article"
	ms.date="03/28/2016"
	ms.author="guybo"/>
    
# Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин

**Описание проблемы.** Вы создали в Azure Resource Manager инфраструктуру автоматического масштабирования с помощью масштабируемых наборов виртуальных машин (например, развернув шаблон, похожий на этот: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-lapstack-autoscale) и установили определенные правила масштабирования. Все работает великолепно, но независимо от уровня нагрузки на виртуальные машины автоматическое масштабирование не выполняется.

## Действия по устранению неполадок

Вот некоторые моменты, которые следует проверить в такой ситуации.

- Сколько ядер у каждой виртуальной машины и все ли они загружены? В приведенном выше шаблоне быстрой настройки Azure есть сценарий do\_work.php, который загружает только одно ядро. Если вы используете более крупные виртуальные машины, чем Standard\_A1, такую загрузку следует запускать несколько раз. Узнать количество ядер в виртуальных машинах вам поможет статья [Размеры виртуальных машин в Azure](../virtual-machines/virtual-machines-windows-sizes.md).

- Сколько виртуальных машин в вашем масштабируемом наборе и все ли они выполняют работу?

    Событие развертывания происходит только тогда, когда средняя нагрузка на процессор для **всех** виртуальных машин в наборе масштабирования превышает пороговое значение в течение определенного интервала, который установлен в правилах автоматического масштабирования.

- Возможно, вы пропустили события масштабирования?

    Проверьте, нет ли записей о событиях масштабирования в журналах аудита на портале Azure. Возможно, вы пропустили произошедшее увеличение или уменьшение масштаба. Можно отфильтровать элементы, введя в соответствующее поле запрос "Масштаб".

	![Журналы аудита][audit]

- Отличаются ли пороговые значения для увеличения и уменьшения масштаба?

    Предположим, что вы установили такие правила: увеличивать масштаб, если среднее использование ЦП в течение 5 минут превышает 50 %; уменьшать масштаб, если среднее использование ЦП меньше 50 %. Такая конфигурация настройки приводит к нестабильности. Когда загрузка ЦП приблизится к пороговому значению, действия по увеличению и уменьшению масштаба будут выполняться постоянно, непрерывно изменяя размер набора. Служба автомасштабирования пытается предотвратить эту проблему, и в результате масштабирование может не выполняться вовсе. Поэтому убедитесь, что пороговые значения для действий по увеличению и уменьшению масштаба ощутимо отличаются.

- Вы сами написали шаблон JSON?

    В нем легко допустить ошибку. Мы рекомендуем взять за основу уже готовый и проверенный шаблон (например, см. приведенный выше), а затем поэтапно вносить в него небольшие изменения. Шаблон должен учитывать параметры учетной записи хранения для расширения диагностики, масштабируемого набора и ресурса Microsoft.Insights. Кроме того, он должен правильно ссылаться на имена метрик производительности, которые отличаются для Windows и Linux.

- Можете ли вы выполнить увеличение или уменьшение масштаба вручную?

    Попробуйте вручную изменить количество виртуальных машин в масштабируемом наборе. Для этого повторно разверните ресурс набора, указав другое значение для параметра capacity. Здесь вы найдете пример подходящего шаблона: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing. Если потребуется, измените этот шаблон, чтобы в нем был указан тот же размер виртуальных машин, который используется в вашем масштабируемом наборе. Если вам удается изменить количество виртуальных машин вручную, значит, проблема связана именно с автоматическим масштабированием.

- Проверьте ресурсы Microsoft.Compute/virtualMachineScaleSet и Microsoft.Insights в [обозревателе ресурсов Azure](https://resources.azure.com/).

    Это незаменимый инструмент для устранения неполадок, в котором отображается состояние ресурсов Azure Resource Manager. Щелкните подписку и изучите группу ресурсов, с которой возникла проблема. В разделе поставщика вычислительных ресурсов найдите созданный масштабируемый набор виртуальных машин и откройте для него представление экземпляра. Здесь вы увидите состояние развертывания набора. Также проверьте представление экземпляра для виртуальных машин, входящих в масштабируемый набор. Затем перейдите к поставщику ресурса Microsoft.Insights и проверьте, правильно ли там указаны правила автоматического масштабирования.

- Работает ли расширение службы диагностики и отправляет ли оно данные о производительности?
 
    Автомасштабирование в Azure Resource Manager работает, используя расширение системы диагностики для виртуальных машин (для Linux и Windows используются разные расширения). Это расширение передает данные о производительности в учетную запись хранения, которая указана в шаблоне. Затем служба аналитики Azure обрабатывает эти данные.

    Если служба аналитики не может получить данные о виртуальных машинах (например, если они отключены), вам будет отправлено сообщение по электронной почте. Проверьте почтовый ящик, который вы указали при создании учетной записи Azure.

    Также вы можете самостоятельно проверить эти данные. Откройте учетную запись хранения Azure в Cloud Explorer. Например, войдите в систему с помощью [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2). Выберите подписку Azure, которую вы используете, и имя учетной записи хранения для службы диагностики, которая указана в определении расширения диагностики в шаблоне развертывания.

	![Обозреватель облака][explorer]

    Вы увидите множество таблиц, в которых хранятся данные, собранные от каждой виртуальной машины. Давайте для примера выберем виртуальную машину Linux и метрику загрузки процессора. Посмотрите на последние строки. Visual Studio Cloud Explorer поддерживает язык запросов, поэтому вы можете создать запрос для получения самых свежих данных, например: Timestamp gt datetime’2016-02-02T21:20:00Z’ (время указано в формате UTC). Соответствуют ли выбранным правилам масштабирования те данные, которые вы здесь видите? В приведенном ниже примере загрузка ЦП для виртуальной машины 20 за последние 5 минут поднялась до уровня 100 %.

	![Таблицы хранилища][tables]

    Если данных здесь нет, это значит, что проблема связана с расширением системы диагностики, которое запущено на виртуальных машинах. Если данные есть, проблема вызвана ошибкой в правилах масштабирования или в службе аналитики. Проверьте [состояние Azure](https://azure.microsoft.com/status/).

    Если все описанные шаги не принесли результата, опубликуйте свой вопрос на форумах [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp) или на сайте [Stack overflow](http://stackoverflow.com/questions/tagged/azure) или же обратитесь в службу поддержки. Подготовьте шаблон и представление данных о производительности, чтобы предоставить их вместе с запросом.

[audit]: ./media/virtual-machine-scale-sets-troubleshoot/image3.png
[explorer]: ./media/virtual-machine-scale-sets-troubleshoot/image1.png
[tables]: ./media/virtual-machine-scale-sets-troubleshoot/image4.png

<!---HONumber=AcomDC_0427_2016-->