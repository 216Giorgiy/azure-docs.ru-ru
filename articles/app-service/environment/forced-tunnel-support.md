---
title: "Настройка принудительного туннелирования в среде службы приложений Azure"
description: "Настройка ASE для работы с принудительным туннелированием исходящего трафика."
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 384cf393-5c63-4ffb-9eb2-bfd990bc7af1
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/10/2017
ms.author: ccompy
ms.openlocfilehash: cd89bd23074dec1de6fa0e8784d42a5c539938b1
ms.sourcegitcommit: 6a22af82b88674cd029387f6cedf0fb9f8830afd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/11/2017
---
# <a name="configure-your-app-service-environment-with-forced-tunneling"></a>Настройка принудительного туннелирования в среде службы приложений

Среда службы приложений (ASE) — это развертывание службы приложений Azure в виртуальной сети Azure клиента. Многие клиенты настраивают свои виртуальные сети как расширения локальных сетей с помощью подключений VPN или ExpressRoute. Из-за корпоративной политики или других ограничений безопасности они настраивают маршруты для отправки всего исходящего трафика в локальную среду, прежде чем он попадет в Интернет. Изменение маршрутизации виртуальной сети таким образом, чтобы исходящий трафик из нее проходил через подключение VPN или ExpressRoute в локальную среду, называется принудительным туннелированием.  

Принудительное туннелирование может вызвать проблемы для ASE. ASE имеет ряд внешних зависимостей, которые перечислены в этой [документации по сетевой архитектуре ASA][network]. Среда службы приложений по умолчанию требует, чтобы вся исходящая связь проходила через подготовленный ею виртуальный IP-адрес.

Маршруты — это важный аспект того, что такое принудительное туннелирование и как с ним работать. В виртуальной сети Azure маршрутизация выполняется на основе совпадения самого длинного префикса (LPM).  При наличии нескольких маршрутов с одинаковыми совпадающими значениями LPM маршрут выбирается по источнику в следующем порядке:

1. определяемый пользователем маршрут;
1. маршрут BGP (если используется ExpressRoute);
1. Системные маршруты

Дополнительные сведения о маршрутизации в виртуальной сети см. в статье [Маршрутизация трафика в виртуальной сети][routes]. 

Если вы хотите, чтобы ASE работала в виртуальной сети с принудительным туннелированием, у вас есть два варианта:

1. Настроить в ASE прямой доступ к Интернету.
1. Изменить конечную точку исходящего трафика для ASE.

## <a name="enable-your-ase-to-have-direct-internet-access"></a>Настройка в ASE прямого доступа к Интернету

Ниже описан метод, обеспечивающий работу среды ASE, если виртуальная сеть настроена с ExpressRoute.

* Настройте ExpressRoute для объявления маршрута 0.0.0.0/0. Это по умолчанию приведет к принудительному туннелированию всего исходящего трафика в локальную среду.
* Создайте определяемый пользователем маршрут. Примените его к подсети со средой ASE, добавив к адресу префикс 0.0.0.0/0 и указав для следующего прыжка тип Интернет.

После этих двух изменений исходящий трафик из подсети ASE в Интернет не будет принудительно направляться по маршруту ExpressRoute, а среда ASE возобновит работу.

> [!IMPORTANT]
> Определяемые пользователем маршруты должны быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute. В приведенном выше примере используется широкий диапазон адресов 0.0.0.0/0. Он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.
>
> Среды ASE с конфигурациями ExpressRoute, осуществляющие перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга, не поддерживаются. Конфигурации ExpressRoute с настроенным общедоступным пирингом получают объявления маршрутов от корпорации Майкрософт. Эти объявления содержат большой набор диапазонов IP-адресов Microsoft Azure. Если диапазоны адресов перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети ASE принудительно туннелируются в локальную сетевую инфраструктуру клиента. В настоящее время этот сетевой поток не поддерживается по умолчанию в средах ASE. Чтобы решить эту проблему, необходимо остановить перекрестное объявление маршрутов между путями общедоступного и частного пиринга.  Другим решением является настройка ASE для работы в конфигурации с принудительным туннелированием.

## <a name="change-the-egress-endpoint-for-your-ase"></a>Изменение конечной точки исходящего трафика для ASE ##

В этом разделе описывается, как настроить ASE для работы в конфигурации с принудительным туннелированием путем изменения конечной точки исходящего трафика, используемой ASE. Если исходящий трафик из ASE принудительно туннелируется в локальную сеть, вам необходимо разрешить этот трафик к источнику из IP-адресов, отличных от виртуального IP-адреса ASE.

ASE не только имеет внешние зависимости, но также должна прослушивать входящий трафик для управления. ASE должна иметь возможность реагировать на такой трафик, а ответы не могут быть отправлены обратно с другого адреса, потому что это прерывает подключение TCP.  Таким образом, для изменения конечной точки исходящего трафика ASE требуется три шага.

1. Настройте таблицу маршрутизации, чтобы гарантировать, что входящий трафик управления может вернуться с одного и того же IP-адреса.
1. Добавьте IP-адреса, которые будут использоваться для исходящего трафика на брандмауэр ASE.
1. Установите маршруты для туннелирования исходящего трафика из ASE.

![Сетевой поток с принудительным туннелированием][1]

Вы можете настроить в ASE разные адреса исходящего трафика, когда ASE уже работает или во время развертывания ASE.  

### <a name="changing-the-egress-address-after-the-ase-is-operational"></a>Изменение адреса исходящего трафика после запуска ASE ###
1. Получите IP-адреса, которые вы хотите использовать в качестве IP-адресов исходящего трафика ASE. Если вы выполняете принудительное туннелирование, тогда это будут ваши преобразования сетевых адресов или IP-адреса шлюза.  Если вы хотите перенаправить исходящий трафик ASE через виртуальный сетевой модуль, то адресом исходящего трафика будет общедоступный IP-адрес виртуального сетевого модуля.
2. Настройте адреса исходящего трафика в сведениях о конфигурации ASE. Войдите на сайт resource.azure.com и перейдите к: Subscription/<subscription id>/resourceGroups/<ase resource group>/providers/Microsoft.Web/hostingEnvironments/<ase name>, где вы увидите файл JSON, который описывает вашу ASE.  Убедитесь, что вверху отображаются строка "read/write".  Нажмите кнопку "Изменить", прокрутите вниз и измените userWhitelistedIpRanges с  

       "userWhitelistedIpRanges": null 
      
  на строку, приведенную ниже. Используйте адреса, которые нужно задать в качестве диапазона адресов исходящего трафика. 

      "userWhitelistedIpRanges": ["11.22.33.44/32", "55.66.77.0/24"] 

  Щелкните PUT в верху. Это активирует операцию масштабирования в ASE и настроит брандмауэр.
   
3. Создайте или измените таблицу маршрутов и заполните правила, чтобы разрешить доступ к/из адресов управления, которые соответствуют местоположению вашей ASE.  Адреса управления см. в статье [Адреса управления среды службы приложений][management]. 

4. Отрегулируйте маршруты, применяемые к подсети ASE, с помощью таблицы маршрутов или маршрутов BGP.  

Если ASE не отвечает на портале, имеется проблема с изменениями.  Возможно, список адресов для исходящего трафика был неполным, трафик был потерян или заблокирован.  

### <a name="create-a-new-ase-with-a-different-egress-address"></a>Создание службы ASE с другим адресом исходящего трафика  ###

Если в виртуальной сети уже настроено принудительное туннелирование всего трафика, вам нужно предпринять дополнительные шаги для создания работоспособной ASE. Это означает, что вам необходимо настроить использование другой конечной точки исходящего трафика во время создания ASE.  Для этого вам нужно создать ASE с помощью шаблона, который указывает разрешенные адреса исходящего трафика.

1. Получите IP-адреса для использования в качестве адресов исходящего трафика для ASE.
1. Предварительно создайте подсеть, которая будет использоваться ASE. Это необходимо, чтобы вы могли устанавливать маршруты, а также потому, что это требуется для шаблона.  
1. Создайте таблицу маршрутов с IP-адресами управления, которые соответствуют местоположению ASE, и назначьте ее ASE.
1. Следуйте указаниям, приведенным в статье [Создание среды ASE с помощью шаблона Azure Resource Manager][template], и извлеките соответствующий шаблон.
1. Отредактируйте раздел "resources" файла azuredeploy.json. Включите в строку **userWhitelistedIpRanges** ваши значения, например:

       "userWhitelistedIpRanges":  ["11.22.33.44/32", "55.66.77.0/30"]

Если параметр настроен правильно, ASE должна запуститься без проблем.  


<!--IMAGES-->
[1]: ./media/forced-tunnel-support/forced-tunnel-flow.png

<!--Links-->
[management]: ./management-addresses.md
[network]: ./network-info.md
[routes]: ../../virtual-network/virtual-networks-udr-overview.md
[template]: ./create-from-template.md
