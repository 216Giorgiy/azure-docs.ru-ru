<properties
	pageTitle="Проверка подлинности и авторизация в службе приложений Azure | Microsoft Azure"
	description="Принципы использования и обзор функции проверки подлинности и авторизации в службе приложений Azure"
	services="app-service"
	documentationCenter=""
	authors="mattchenderson"
	manager="erikre"
	editor=""/>

<tags
	ms.service="app-service"
	ms.workload="mobile"
	ms.tgt_pltfrm="na"
	ms.devlang="multiple"
	ms.topic="article"
	ms.date="04/25/2016"
	ms.author="mahender"/>
    
# Проверка подлинности и авторизация в службе приложений Azure

## Что такое проверка подлинности и авторизация службы приложений?

Проверка подлинности и авторизация службы приложений — это функция, которая позволяет пользователям приложения выполнять вход без изменений кода, необходимых в серверной части приложения. Она является простым способом обеспечения защиты приложения и работы с данными пользователей.

Служба приложений использует федеративную идентификацию, при которой сторонний поставщик удостоверений сохраняет учетные записи и проверяет подлинность пользователей. Приложение использует эту информацию об удостоверении поставщика вместо того, чтобы хранить ее самостоятельно. Служба приложений поддерживает пять поставщиков удостоверений по умолчанию: _Azure Active Directory_, _Facebook_, _Google_, _учетная запись Майкрософт_ и _Twitter_. Ваше приложение может использовать любое количество поставщиков удостоверений, позволяя конечным пользователям выбрать способ входа. Вы также можете расширить встроенную поддержку поставщиков удостоверений, добавив другого поставщика удостоверений или [собственное настраиваемое решение для идентификации][custom-auth].

Чтобы немедленно приступить к работе, ознакомьтесь с одним из следующих учебников.

- [Добавление проверки подлинности в приложение iOS][iOS] (или в приложение [Android], [Windows], [Xamarin.iOS], [Xamarin.Android], [Xamarin.Forms] или [Cordova])
- [Проверка подлинности пользователя для приложений API в службе приложений Azure][apia-user]

## Как устроена проверка подлинности в службе приложений

Чтобы проверять подлинность с помощью одного из поставщиков удостоверений, сначала необходимо настроить поставщик удостоверений так, чтобы ему было известно о вашем приложении. Затем поставщик удостоверений предоставит вам идентификаторы и секреты, которые необходимо передать службе приложений. На этом отношение доверия завершается, и после этого служба приложений может проверять утверждения пользователей от поставщика удостоверений, например маркеры проверки подлинности.

Для входа с использованием одного из этих поставщиков пользователь должен быть перенаправлен на конечную точку входа для этого поставщика. Если клиенты используют веб-браузер, можно сделать так, чтобы служба приложений автоматически перенаправляла на конечную точку входа все запросы, не прошедшие проверку подлинности. В противном случае необходимо перенаправить клиентов в `{your App Service base URL}/.auth/login/<provider>`, где `<provider>` — _aad_, _facebook_, _google_, _microsoft_ или _twitter_. В следующих разделах описаны сценарии для API и мобильных устройств.

Файл cookie у пользователей, которые взаимодействуют с приложением, будет настроен таким образом, чтобы при переходе к вашему приложению проверка подлинности для них оставалась непройденной. Для других типов клиентов, например мобильных устройств, клиенту будет выдан веб-маркер JSON (JWT), который должен присутствовать в заголовке `X-ZUMO-AUTH`. В пакетах SDK для клиента мобильных приложений это будет сделано автоматически. Кроме того, в заголовок `Authorization` можно напрямую включить маркер идентификации Azure Active Directory или маркер доступа как [токен носителя](https://tools.ietf.org/html/rfc6750).

Служба приложений будет проверять все файлы cookie и маркеры, выпущенные вашим приложением, позволяя пользователям проходить проверку подлинности. Для ограничения доступа к приложению обратитесь к разделу [Авторизация](#authorization) ниже.

### Мобильная проверка подлинности с пакетом SDK поставщика

Выполнив все настройки на серверной стороне, можно изменить мобильные клиенты для входа в службу приложений. Существует два подхода:

- использование пакета SDK, опубликованного указанным поставщиком удостоверений, для определения удостоверения и последующего получения доступа к службе приложений.
- использование одной строки кода для входа пользователей с помощью пакета SDK клиента для мобильных приложений;

>[AZURE.TIP] Многие приложения должны использовать пакет SDK поставщика для поддержки более естественной процедуры входа и использования возможности обновления и других преимуществ, предлагаемых конкретным поставщиком.

При работе с пакетом SDK поставщика процедура входа очень тесно привязывается к ОС платформы, в которой выполняется приложение. При этом вы также получаете маркер поставщика и некоторые сведения о пользователях на стороне клиента, что упрощает использование Graph API и настройку пользовательского интерфейса. Иногда в блогах и на форумах это может называться "клиентским потоком" или "управляемым клиентом потоком", так как управление входом на клиенте выполняет код, и код клиента имеет доступ к маркеру поставщика.

Полученный маркер поставщика необходимо отправить в службу приложений для проверки. После того как служба приложений проверит маркер, она создает новый маркер службы приложений, который возвращается клиенту. Пакет SDK для клиента мобильных приложений содержит вспомогательные методы, которые управляют этим обменом и автоматически присоединяют маркеры ко всем запросам к серверной части приложения. Если необходимо, разработчик также может сохранить ссылку на маркер поставщика.

### Мобильная проверка подлинности без пакета SDK поставщика

Если вы не хотите настраивать пакет SDK поставщика, можно сделать так, чтобы мобильные приложения службы приложений выполняли вход за вас. Клиентский пакет SDK мобильных приложений будет открывать выбранному вами поставщику веб-представление и осуществлять процедуру входа. Иногда в блогах и на форумах это называется "серверным потоком" или "управляемым сервером потоком", так как входом управляет сервер, и пакет SDK клиента никогда не получает маркер поставщика.

Код, необходимый для запуска этого потока, рассматривается в учебнике по проверке подлинности для каждой платформы. В конце потока у клиентского пакета SDK есть маркер службы приложений, и маркер автоматически присоединяется ко всем запросам, отправляемым к серверной части приложения.

### Взаимодействие между службами

Наряду с предоставлением доступа к приложению пользователям также можно разрешить другому доверенному приложению вызывать ваш собственный интерфейс API. Например, можно сделать так, чтобы одно приложение службы приложений вызывало API в другом. В этом случае для получения маркера используются учетные данные службы вместо учетных данных пользователя. Учетная запись службы в терминологии Azure Active Directory также называется *субъектом-службой*, а проверка подлинности с использованием такой учетной записи называется сценарием взаимодействия между службами.

>[AZURE.IMPORTANT] Так как мобильные приложения работают на клиентских устройствах, эти приложения _не_ считаются доверенными и не должны использовать основной поток службы. Вместо этого они должны использовать один из потоков пользователя, рассмотренных выше.

В сценариях взаимодействия между службами служба приложений может защитить приложение с помощью Azure Active Directory. Вызывающее приложение просто предоставляет маркер проверки подлинности субъекта-службы AAD, полученный после предоставления идентификатора клиента и секрета клиента от AAD. Пример такого сценария для приложений API ASP.NET приводится в руководстве [Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure][apia-service].

Если в сценарии взаимодействия между службами вы хотите обойтись без проверки подлинности службы приложений, используйте сертификаты клиентов или базовую проверку подлинности. Сведения о клиентских сертификатах в Azure см. в статье [Настройка взаимной проверки подлинности TLS для веб-приложения](../app-service-web/app-service-web-configure-tls-mutual-auth.md). Сведения о базовой проверке подлинности в ASP.NET см. в статье [Фильтры проверки подлинности в веб-API 2 ASP.NET](http://www.asp.net/web-api/overview/security/authentication-filters).

Проверка подлинности учетной записи службы из приложения логики службы приложений в приложение API — это особый вариант проверки подлинности, который описан в статье [Использование настраиваемого интерфейса API, размещенного в службе приложений, с приложениями логики](../app-service-logic/app-service-logic-custom-hosted-api.md).

## <a name="authorization"></a>Принцип действия авторизации в службе приложений

У вас есть полный контроль над тем, какие запросы могут быть отправлены вашему приложению. Проверку подлинности и авторизацию службы приложений можно настроить для любого из следующих вариантов:

- Приложению могут отправляться только запросы, прошедшие проверку подлинности.

	Если из браузера поступает анонимный запрос, служба приложений перенаправляет его на страницу входа выбранного поставщика удостоверений. Если запрос приходит с мобильного устройства, будет возвращен ответ HTTP _401 — Не санкционировано_.

	В этом случае в клиентском приложении не нужен никакой код для проверки подлинности. Если требуется более контролируемая авторизация, можно воспользоваться сведениями о пользователе в коде.

- Приложению могут отправляться все запросы, но запросы проверки подлинности нужно проверять и передавать сведения о проверке подлинности в заголовках HTTP.

	В этом случае решение об авторизации должно приниматься в коде приложения. Такая схема обеспечивает большую гибкость в обработке анонимных запросов, но требует написания кода.
	
- Приложению могут отправляться все запросы. Сведения о проверке подлинности в запросах не используются.

	В этом случае функция аутентификации и авторизации отключена. Все задачи проверки подлинности и авторизации полностью ложатся на код приложения.

Выбрать выполняемое действие можно с помощью параметра **Действие, выполняемое, если запрос не прошел проверку подлинности** на портале. При выборе варианта "Входить с..." для одного из поставщиков все запросы будут должны пройти проверку подлинности. При выборе варианта "Разрешить запрос (без выполнения действий)" решение об авторизации выполняется в коде, но сведения о проверке подлинности по-прежнему предоставляются. Если вы хотите выполнять всю обработку в коде, функцию проверки подлинности и авторизации компонента можно отключить.

## Работа с удостоверениями пользователей в приложении

Служба приложений передает некоторые сведения о пользователе в приложение с помощью специальных заголовков. Эти заголовки не могут использоваться во внешних запросах, и если они присутствуют, это означает, что они были установлены службой приложений при проверке подлинности или авторизации. Некоторые примеры заголовков включают:

* X-MS-CLIENT-PRINCIPAL-NAME
* X-MS-CLIENT-PRINCIPAL-ID
* X-MS-TOKEN-FACEBOOK-ACCESS-TOKEN
* X-MS-TOKEN-FACEBOOK-EXPIRES-ON

Сведения из этих заголовков можно получить с помощью кода, написанного на любом языке или в любой платформе. Для приложений ASP.NET 4.6 автоматически настраивается класс ClaimsPrincipal с соответствующими значениями.

Приложение может получить дополнительные сведения о пользователях, отправив запрос HTTP GET на конечную точку приложения `/.auth/me`. Если в запрос был включен действительный маркер, будут возвращены полезные данные JSON со сведениями об используемом поставщике, маркером базового поставщика и другими данными пользователя. Пакеты SDK для серверной части мобильных приложений предоставляют вспомогательные методы для работы с этими данными ([Node.JS](../app-service-mobile/app-service-mobile-node-backend-how-to-use-server-sdk.md/#howto-tables-getidentity), [.NET](../app-service-mobile/app-service-mobile-dotnet-backend-how-to-use-server-sdk.md/#user-info)).

## Документация и дополнительные ресурсы

### Поставщики удостоверений
В следующих учебниках содержатся сведения о настройке службы приложений для использования разных поставщиков проверки подлинности.

- [Настройка приложения для использования имени входа Azure Active Directory][AAD]
- [Настройка приложения для использования имени входа Facebook][Facebook]
- [Настройка приложения для использования имени входа Google][Google]
- [Настройка приложения для использования входа по учетной записи Майкрософт][MSA]
- [Настройка приложения для использования имени входа Twitter][Twitter]

Если вы хотите использовать систему удостоверений, отличную от указанных здесь, можете использовать [предварительную версию поддержки настраиваемой проверки подлинности в серверном пакете SDK .NET для мобильных приложений][custom-auth]. Она может использоваться с веб-приложениями, мобильными приложениями или приложениями API.

### Мобильные приложения
В следующих учебниках показано, как добавить проверку подлинности в мобильные клиенты с использованием серверного потока.

- [Добавление проверки подлинности в приложение iOS][iOS]
- [Добавление проверки подлинности в приложение Android][Android]
- [Добавление проверки подлинности в приложение Windows][Windows]
- [Добавление проверки подлинности в приложение Xamarin.iOS][Xamarin.iOS]
- [Добавление проверки подлинности в приложение Xamarin.Android][Xamarin.Android]
- [Добавление проверки подлинности в приложение Xamarin.iOS][Xamarin.Forms]
- [Добавление проверки подлинности в приложение Cordova][Cordova]

Если вы хотите использовать в AAD поток, ориентированный на клиента, воспользуйтесь следующими руководствами:

- [Использование библиотеки проверки подлинности Active Directory для iOS][ADAL-iOS]
- [Использование библиотеки проверки подлинности Active Directory для Android][ADAL-Android]
- [Использование библиотеки проверки подлинности Active Directory для Windows и Xamarin][ADAL-dotnet]

### Приложения API
Защита приложений API описана в следующих учебниках:

- [Проверка подлинности пользователя для приложений API в службе приложений Azure][apia-user]
- [Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure][apia-service]









[apia-user]: ../app-service-api/app-service-api-dotnet-user-principal-auth.md
[apia-service]: ../app-service-api/app-service-api-dotnet-service-principal-auth.md

[iOS]: ../app-service-mobile/app-service-mobile-ios-get-started-users.md
[Android]: ../app-service-mobile/app-service-mobile-android-get-started-users.md
[Xamarin.iOS]: ../app-service-mobile/app-service-mobile-xamarin-ios-get-started-users.md
[Xamarin.Android]: ../app-service-mobile/app-service-mobile-xamarin-android-get-started-users.md
[Xamarin.Forms]: ../app-service-mobile/app-service-mobile-xamarin-forms-get-started-users
[Windows]: ../app-service-mobile/app-service-mobile-windows-store-dotnet-get-started-users.md
[Cordova]: ../app-service-mobile/app-service-mobile-cordova-get-started-users.md

[AAD]: ../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md
[Facebook]: ../app-service-mobile/app-service-mobile-how-to-configure-facebook-authentication.md
[Google]: ../app-service-mobile/app-service-mobile-how-to-configure-google-authentication.md
[MSA]: ../app-service-mobile/app-service-mobile-how-to-configure-microsoft-authentication.md
[Twitter]: ../app-service-mobile/app-service-mobile-how-to-configure-twitter-authentication.md

[custom-auth]: ../app-service-mobile/app-service-mobile-dotnet-backend-how-to-use-server-sdk.md#custom-auth

[ADAL-Android]: ../app-service-mobile/app-service-mobile-android-how-to-use-client-library.md/#adal
[ADAL-iOS]: ../app-service-mobile/app-service-mobile-ios-how-to-use-client-library.md/#adal
[ADAL-dotnet]: ../app-service-mobile/app-service-mobile-dotnet-how-to-use-client-library.md/#adal

<!---HONumber=AcomDC_0504_2016-->