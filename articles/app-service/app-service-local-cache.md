<properties
   pageTitle="Общие сведения о локальном кэше службы приложений Azure"
   description="В этой статье описывается, как включить, изменить размер и опросить состояние функции локального кэша службы приложений Azure."
   services="app-service"
   documentationCenter="app-service"
   authors="SyntaxC4"
   manager="yochayk"
   editor=""
   tags="optional"
   keywords="Для использования только специалистами в области SEO. Разделяйте термины запятыми. Перед изменением содержимого статьи, содержащей эти термины, проконсультируйтесь со своим специалистом в области SEO."/>

<tags
   ms.service="app-service"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="03/04/2016"
   ms.author="cfowler"/>

# Общие сведения о локальном кэше службы приложений Azure

Содержимое веб-приложений Azure хранится в службе хранилища Azure и доступно в долгосрочном режиме в общей папке содержимого. Эта схема рассчитана на работу с различными приложениями и имеет следующие атрибуты:

* Содержимое разделяется между несколькими экземплярами виртуальных машин веб-приложения. 
* Содержимое хранится в долгосрочном режиме и может быть изменено путем запуска веб-приложений. 
* Файлы журналов и диагностических данных доступны в той же общей папке содержимого. 
* При публикации нового содержимого происходит явное обновление содержимого общей папки. То же самое можно сделать с помощью веб-сайта диспетчера управления службами, запустив веб-приложение напрямую (обычно некоторые технологии, такие как ASP.NET, автоматически перезапускают веб-приложение при каких-либо изменениях файлов для учета последнего обновления). 

Хотя многие веб-приложения используют одну или все из этих возможностей, некоторым веб-приложениям нужно лишь высокопроизводительное хранилище содержимого в режиме только для чтения, которое они смогут запустить с высоким уровнем доступности. Эти приложения могут использовать специальную копию содержимого экземпляра виртуальной машины, которая здесь называется "локальным кэшем". _Локальный кэш_ позволяет получить представление вашего содержимого от лица веб-роли. Это содержимое являет из себя кэш содержимого хранилища с записью и отклонением, который создается при запуске узла асинхронно. Когда кэш готов, сайт переключается на работу с кэшированным содержимым. Веб-приложения, работающие с локальном кэшем, получают следующие преимущества:

* Они защищены от задержек, возникающих при доступе к содержимому хранилища Azure. 
* На них не влияет запланированное обслуживание или незапланированные простои серверов, на которых размещена общая папка содержимого, и любые другие перебои в работе службы хранилища Azure. 
* Меньшее количество перезагрузок приложения из-за изменений общего ресурса хранилища. 

## Как локальный кэш изменяет поведение службы приложений

* Локальный кэш — это копия папок /site и /siteextensions веб-приложения. Он создается на локальном экземпляре виртуальной машины при запуске веб-приложения. Размер локального кэша каждого веб-приложения по умолчанию ограничен 300 МБ, но может быть увеличен до 1 ГБ. 
* Локальный кэш доступен для чтения и записи, однако при перемещении виртуальных машин или перезапуске веб-приложения изменения кэша будут отклонены. Локальный кэш не должен использоваться для приложений, которые сохраняют в хранилище содержимого критически важные данные. 
* Веб-приложения могут продолжать записывать файлы журналов и диагностических данных, как они делают это в настоящее время. Однако файлы журналов и данных сохраняются локально на виртуальной машине и затем периодически копируются в общую папку хранилища. Наилучшим вариантом является копирование в общую папку хранилища, а результаты обратной записи могут быть потеряны из-за внезапного сбоя экземпляра виртуальной машины. 
* В структуре папок для файлов журналов и данных для веб-приложений, использующих локальный кэш, есть некоторые изменения. Теперь в каталогах хранилища "LogFiles" и "Data" есть подкаталоги, использующие следующий шаблон именования: "уникальный идентификатор" + метка времени. Каждый из подкаталогов соответствует экземпляру виртуальной машины, на котором запущено веб-приложение.  
* При публикации изменений в веб-приложение через любой из механизмов публикации будет выполняться публикация в общую папку содержимого. Это вызвано структурой системы, так как мы хотим, чтобы публикуемое содержимое хранилось долгосрочно. Чтобы обновить локальный кэш веб-приложения, его необходимо перезагрузить. Этот шаг кажется вам избыточным? Чтобы сделать жизненный цикл простым, выполните инструкции, описанные ниже.
* В папке D:\\home будет размещаться локальный кэш. В папке D:\\local будет по-прежнему размещаться временное хранилище конкретной виртуальной машины. 
* На веб-сайте диспетчера управления службами в качестве представления содержимого по умолчанию по-прежнему будет отображаться общая папка хранилища. Чтобы посмотреть, на что похожа папка локального кэша, можно перейти к https://[site-name].scm.azurewebsites.net/VFS/LocalSiteRoot/LocalCache.

## Как включить локальный кэш в службе приложений Azure

Локальный кэш настраивается с помощью нескольких зарезервированных параметров приложения. Эти параметры приложения можно настроить следующими способами:

* [Портал Azure](#Configure-Local-Cache-Portal)
* [Диспетчер ресурсов Azure](#Configure-Local-Cache-ARM)

### Практическое руководство. Настройка локального кэша на портале Azure
<a name="Configure-Local-Cache-Portal"></a>

Для включения локального кэша для отдельных веб-приложений с помощью параметра приложения. `WEBSITE_LOCAL_CACHE_OPTION` = `Always`

![Параметры приложений портала Azure: локальный кэш](media/app-service-local-cache/app-service-local-cache-configure-portal.png)

### Практическое руководство. Настройка локального кэша с помощью диспетчера ресурсов Azure
<a name="Configure-Local-Cache-ARM"></a>

```
...

{
    "apiVersion": "2015-08-01",
    "type": "config",
    "name": "appsettings",
    "dependsOn": [
        "[resourceId('Microsoft.Web/sites/', variables('siteName'))]"
    ],
    "properties": {
        "WEBSITE_LOCAL_CACHE_OPTION": "Always",
        "WEBSITE_LOCAL_CACHE_SIZEINMB": "300" 
    }
}

...
```

## Как изменить размер локального кэша службы приложений?

По умолчанию размер локального кэша равен **300 МБ**. Он включает каталоги Site и SiteExtensions, которые копируются из хранилища содержимого, а также любые другие локально созданные каталоги журналов и данных. Чтобы увеличить это ограничение, используйте параметр приложения `WEBSITE_LOCAL_CACHE_SIZEINMB`. Размер можно увеличить до **1 ГБ** (1000 МБ) на веб-приложение.

## Рекомендации по использованию локального кэша службы приложений

Рекомендуется использовать локальный кэш в сочетании с функцией [промежуточной среды](../app-service-web/web-sites-staged-publishing.md).

* Добавьте _прикрепленный_ параметр приложения `WEBSITE_LOCAL_CACHE_OPTION` со значением `Always` в свою **рабочую область**. При использовании `WEBSITE_LOCAL_CACHE_SIZEINMB` также добавьте его в качестве прикрепленного параметра в рабочую область. 
* Создайте промежуточную область и выполните публикацию в свою промежуточную область. Промежуточная область обычно не использует локальный кэш для упрощения жизненного цикла построения, развертывания для промежуточной области, но при этом использует преимущества локального кэша для рабочей области. 
*	Протестируйте свой веб-сайт относительно промежуточной области.  
*	Когда будете готовы, выполните [операцию обмена](../app-service-web/web-sites-staged-publishing.md#to-swap-deployment-slots) между **промежуточной** и **рабочей** областями.  
*	Прикрепленные параметры определяются по именам и привязаны к области. Поэтому при обмене между промежуточной и рабочей областями промежуточная область наследует параметры локального кэша приложения. Через несколько минут новая рабочая область будет запущена для локального кэша и будет разогрета в рамках разогрева области после обмена. Поэтому после окончания обмена областей рабочий слот будет работать с локальным кэшем.

## Часто задаваемые вопросы

### Как узнать, можно ли использовать локальный кэш с моим веб-приложением? 

Если веб-приложению необходимы высокая производительность и надежное хранилище содержимого, а также если это веб-приложение не сохраняет в хранилище важных данных во время работы и общий размер хранилища не превышает 1 ГБ, то ответ — "Да"! Чтобы получить общий размер каталогов сайта и расширений сайта, можно использовать "Использование диска веб-приложениями Azure".
 
### Как включить локальный кэш? 

См. раздел "Рекомендации по использованию локального кэша" выше.
 
### Как узнать, переключился ли мой веб-сайт на использование локального кэша? 

При использовании функции локального кэша с промежуточной средой операция обмена не будет завершена, пока локальный кэш не разогрелся. Чтобы определить, работает ли веб-сайт с локальным кэшем, можно проверить переменную среды для процесса рабочей роли WEBSITE\_LOCALCACHE\_READY. Используйте приведенные инструкции на странице [переменных среды процесса рабочей роли](https://github.com/projectkudu/kudu/wiki/Process-Threads-list-and-minidump-gcdump-diagsession#process-environment-variable), чтобы получить доступ к переменным среды процесса рабочей роли для нескольких экземпляров.
 
### Я только что опубликовал новые изменения, но они еще не распространились на мое веб-приложение. Почему? 
Если веб-приложение использует локальный кэш, необходимо перезапустить свой веб-сайт, чтобы получить последние изменения. Не хотите делать это на рабочем сайте? Обратитесь к варианту с рабочими областями, описанному выше.
 
### Где находятся мои журналы? 

С локальным кэшем папки журналов и данных выглядят немного иначе. Однако структура подкаталогов остается прежней, за исключением того, что они размещаются в подкаталоге с названием вида "уникальный идентификатор виртуальной машины + отметка времени".
 
### Я включил локальный кэш, но мое веб-приложение все равно перезапускается. Почему? Я подумал, что локальный кэш поможет снизить частоту перезапуска приложения. 

Локальный кэш помогает предотвратить перезапуск веб-приложений, которые используют хранилище. Тем не менее, ваше веб-приложение все равно может быть перезапущено во время планируемых обновлений инфраструктуры виртуальной машины. Общее количество перезапусков с локальным кэшем должно быть меньше.

<!---HONumber=AcomDC_0323_2016-->