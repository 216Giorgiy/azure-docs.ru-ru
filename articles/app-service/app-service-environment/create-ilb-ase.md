---
title: "Создание и использование внутренней подсистемы балансировки нагрузки со средой службы приложений Azure"
description: "Сведения о создании и использовании изолированной от Интернета среды службы приложений Azure"
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 0f4c1fa4-e344-46e7-8d24-a25e247ae138
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/13/2017
ms.author: ccompy
ms.translationtype: Human Translation
ms.sourcegitcommit: cb4d075d283059d613e3e9d8f0a6f9448310d96b
ms.openlocfilehash: 8bc82a297ef8e3f1beac773a6a3b0c4a9b80334f
ms.contentlocale: ru-ru
ms.lasthandoff: 06/26/2017

---
# <a name="create-and-use-an-internal-load-balancer-with-an-app-service-environment"></a>Создание и использование внутренней подсистемы балансировки нагрузки со средой службы приложений #

Среда службы приложений (ASE) — это развернутая служба приложений Azure в подсети виртуальной сети Azure. Существует два способа развертывания ASE: 

- с виртуальным IP-адресом на основе внешнего IP-адреса, что часто называют _внешней средой ASE_;
- с виртуальным IP-адресом на основе внутреннего IP-адреса, что часто называют _средой службы приложений с внутренней подсистемой балансировки нагрузки_, так как внутренней конечной точкой является внутренняя подсистема балансировки нагрузки (ILB). 

В этой статье показано, как создать _ASE с подсистемой ILB_.  Общие сведения об ASE см. в статье [An Introduction to the App Service Environments][Intro] (Знакомство со средой службы приложений). Сведения о создании внешней среды ASE см. в статье [Create an external App Service Environment][MakeExternalASE] (Создание внешней среды службы приложений).

## <a name="overview"></a>Обзор ##

ASE можно развернуть с конечной точкой, доступной через Интернет, или с IP-адресом в вашей виртуальной сети. Чтобы задать IP-адрес виртуальной сети, среду службы приложений необходимо развернуть с внутренней подсистемой балансировки нагрузки. При развертывании среды службы приложений с внутренней подсистемой балансировки нагрузки необходимо наличие следующих компонентов:

-   ваш собственный домен, в котором создаются приложения;
-   Сертификат, используемый для HTTPS.
-   управление службой DNS для домена.

Это дает следующие возможности:

-   безопасное размещение в облаке приложений из интрасети, доступ к которым осуществляется через VPN типа "сеть — сеть" или ExpressRoute;
-   размещение в облаке приложений, которые не указаны на общедоступных DNS-серверах;
-   создание изолированных от Интернета внутренних приложений, с которыми можно безопасно интегрировать свои внешние приложения.

***Отключенные функциональные возможности***

Существует ряд функций, недоступных при использовании среды службы приложений с внутренней подсистемой балансировки нагрузки:

-   Использование SSL на основе IP-адреса.
-   назначение IP-адресов конкретным приложениям;
-   приобретение и использование сертификата с приложением на портале. По-прежнему можно получать сертификаты непосредственно в ЦС и использовать их с приложениями, но только не на портале Azure.

## <a name="create-an-ilb-ase"></a>Создание среды службы приложений с внутренней подсистемой балансировки нагрузки ##

Чтобы создать ASE с внутренним балансировщиком нагрузки, выполните следующее.

1.  На портале Azure выберите **Создать -&gt; Интернет+мобильные устройства -&gt; Среда службы приложений**.
2.  Выберите свою подписку.
3.  Выберите или создайте группу ресурсов.
4.  Выберите или создайте виртуальную сеть.
5.  Если вы выбрали виртуальную сеть, создайте подсеть. Задайте для подсети достаточно большой размер с учетом увеличения среды службы приложений в будущем. Рекомендуемый размер — `/25`. Такая подсеть содержит 128 адресов и может обслуживать среду службы приложений максимального размера. Не используйте размер подсети `/29` или меньше.  Для инфраструктуры требуется по крайней мере 5 адресов.  Даже при размере `/28` вы сможете выполнять масштабирование до 11 экземпляров в подсети `/28`. Если вы считаете, что когда-нибудь превысите максимальное количество в 100 экземпляров в планах службы приложений, или вам понадобится выполнить масштабирование примерно до 100 экземпляров, но путем более быстрого масштабирования внешнего интерфейса, используйте размер /24 с 256 адресами.
6.  Выберите **Виртуальная сеть/расположение -&gt; Virtual Network Configuration** (Конфигурация виртуальной сети) и задайте для параметра **Тип VIP** значение **Внутренний**.
7.  Укажите имя домена. Указанный домен будет использоваться для приложений, создаваемых в этой среде службы приложений. Существуют некоторые ограничения. Нельзя использовать такие имена:
    - net;
    - azurewebsites.net;
    - p.azurewebsites.net;
    - &lt;имя_ASE&gt;.p.azurewebsites.net.

    Кроме того, если вы планируете использовать пользовательское доменное имя для приложений, размещенных в этой среде ASE, это имя не должно перекрываться с доменным именем, используемым средой ASE. В среде ASE с ILB с доменным именем _contoso.com_ нельзя использовать следующие пользовательские доменные имена для приложений:
    - www.contoso.com;
    - abcd.def.contoso.com;
    - abcd.contoso.com.

    Если вы знаете, какие пользовательские доменные имена будете использовать для приложений, развертываемых в среде ASE с ILB, выберите домен для этой среды во время ее создания, чтобы избежать конфликта имен. В этом примере можно использовать такое имя, как _contoso internal.com_.
8.  Нажмите кнопку **ОК** и щелкните **Создать**.

    ![][1]

В колонке "Виртуальная сеть" есть параметр **Virtual Network Configuration** (Конфигурация виртуальной сети). Он позволяет выбрать внешний или внутренний виртуальный IP-адрес. По умолчанию используется значение **Внешний**. Если выбрать значение **Внешний**, для среды службы приложений будет использоваться виртуальный IP-адрес, доступный из Интернета. Если выбрать значение **Внутренний**, для ASE будет настроена внутренняя подсистема балансировки нагрузки с IP-адресом в виртуальной сети.

Если выбрать вариант **Внутренний**, возможность добавлять дополнительные IP-адреса для среды службы приложений исчезнет, и вместо этого необходимо будет указать домен ASE. В ASE с внешним виртуальным IP-адресом имя среды указывается в домене для приложений, создаваемых в этой среде.

Если указан **Внутренний** **виртуальный IP-адрес**, имя среды ASE не используется в имени домена для этой среды. В этом случае домен указывается явным образом. Если используется домен ***contoso.corp.net*** и вы создали в этой среде ASE приложение с именем ***timereporting***, URL-адрес этого приложения будет выглядеть так: ***timereporting.contoso.corp.net***.

## <a name="apps-in-an-ilb-ase"></a>Приложения в ASE с внутренним балансировщиком нагрузки ##

Создание приложения в ASE и ASE с внутренним балансировщиком нагрузки не отличается.

1.  На портале Azure выберите **Создать &gt; Интернет+мобильные устройства &gt; Интернет**, либо **Мобильные**, либо **Приложение API**.
2.  Введите имя приложения.
3.  Выберите подписку.
4.  Выберите или создайте группу ресурсов.
5.  Выберите или создайте план службы приложений. Если необходимо создать план службы приложений, выберите свою среду ASE в качестве расположения, а также выберите рабочий пул, в котором будет создан этот план. При создании плана службы приложений следует выбрать ASE в качестве расположения и рабочий пул. При указании имени приложения вы увидите, что домен в имени вашего приложения заменяется доменом ASE.
6.  Нажмите кнопку **Создать**. Следует установить флажок **Закрепить на панели мониторинга** , если требуется отобразить приложение на панели мониторинга.

    ![][2]

Доменное имя в имени приложения обновится с учетом домена ASE.

## <a name="post-ilb-ase-creation-validation"></a>Проверка после создания ASE с внутренним балансировщиком нагрузки ##

ASE с внутренним балансировщиком нагрузки немного отличается от ASE без такового. Как уже было сказано, в ней нужно управлять собственной службой DNS, а также необходимо предоставлять собственный сертификат для подключений по протоколу HTTPS.

После создания среды ASE вы заметите, что в доменном имени отображается указанный вами домен, а в меню **Параметры** появился новый элемент **Сертификат ILB**. ASE создается с сертификатом, в котором не указан домен ASE с ILB. Если использовать ASE с этим сертификатом, в браузере отобразится сообщение о том, что указан недопустимый сертификат. Этот сертификат позволяет упростить тестирование протокола HTTPS. Но предполагается, что вы отправите собственный сертификат, связанный с доменом ASE с подсистемой ILB, независимо от того, является ли он самозаверяющим или получен из ЦС.

![][3]

Есть множество способов получить действительный SSL-сертификат, в частности можно получить сертификат от внутреннего центра сертификации, приобрести его у внешнего поставщика и использовать самозаверяющий сертификат. Независимо от источника SSL-сертификата для него необходимо соответствующим образом настроить следующие атрибуты:

-   _Subject_ — для этого атрибута необходимо задать значение _\*.имя_корневого_домена_.
-   _Subject Alternative Name_ — этот атрибут должен содержать два значения: _\*.имя_корневого_домена_ и _\*.scm.имя_корневого_домена_. Вторая запись требуется, так как для SSL-соединения с сайтом SCM или Kudu, связанному с каждым приложением, будет использоваться адрес в формате _имя_приложения.scm.имя_корневого_домена_.

После получения действительного SSL-сертификата требуется выполнить еще два дополнительных подготовительных действия. SSL-сертификат необходимо преобразовать в PFX-файл и сохранить в таком формате. PFX-файл должен содержать все промежуточные и корневые сертификаты, а также быть защищен паролем.

Чтобы создать собственный сертификат с помощью PowerShell, используйте команды, приведенные ниже.  Обязательно укажите доменное имя среды ASE с ILB вместо *internal.contoso.com*. 

    $certificate = New-SelfSignedCertificate -certstorelocation cert:\localmachine\my -dnsname "\*.internal-contoso.com","\*.scm.internal-contoso.com"
    
    $certThumbprint = "cert:\localMachine\my\" +$certificate.Thumbprint
    $password = ConvertTo-SecureString -String "CHANGETHISPASSWORD" -Force -AsPlainText
    
    $fileName = "exportedcert.pfx" 
    Export-PfxCertificate -cert $certThumbprint -FilePath $fileName -Password $password

Сертификат, созданный с помощью этих команд PowerShell, по-прежнему будет вызывать ошибку в браузерах, так как он не был создан ЦС из цепочки сертификатов браузера. Единственный способ получить сертификат, который не будет вызывать ошибку в браузере, — приобрести его в коммерческом ЦС из цепочки сертификатов браузера.  

![][4]

Чтобы отправить сертификаты и протестировать доступ, сделайте следующее:

1.  Перейдите к пользовательскому интерфейсу среды ASE после ее создания (**ASE > Параметры > Сертификаты ILB**).
2.  Задайте сертификат ILB, выбрав PFX-файл сертификата, и введите пароль. На выполнение этой операции потребуется некоторое время, после чего отобразится сообщение о том, что выполняется отправка.
3.  Получите адрес ILB для ASE (**ASE > Свойства > Виртуальный IP-адрес**).
4.  Создайте веб-приложение в среде ASE после ее создания.
5.  Создайте виртуальную машину в этой виртуальной сети (если вы этого еще не сделали).

    > [!NOTE] 
    > Не создавайте виртуальную машину в одной подсети с ASE. В противном случае настройка будет прервана.
    >
    >

6.  Задайте DNS для домена среды ASE. Можно указать в DNS подстановочные знаки с именем домена или, если вы хотите выполнить несколько простых проверок, можно изменить файл hosts на виртуальной машине, чтобы в качестве имени веб-приложения задать виртуальный IP-адрес. Если доменное имя вашей среды ASE — _.ilbase.com_ и вы создали веб-приложение с именем _mytestapp_, его адрес — _mytestapp.ilbase.com_. Позднее вы настроите разрешение имени _mytestapp.ilbase.com_ в адрес ILB. (В Windows файл hosts находится в папке C:\Windows\System32\drivers\…\_) Чтобы протестировать публикацию веб-развертывания или доступ к расширенной консоли, вам потребуется также создать запись для _mytestapp.scm.ilbase.com_.
7.  Откройте браузер на этой виртуальной машине и перейдите по адресу ***http://mytestapp.ilbase.com*** (или по имени своего веб-приложения в домене).
8.  Откройте браузер на этой виртуальной машине и перейдите по адресу ***https://mytestapp.ilbase.com***. Если используется самозаверяющий сертификат, необходимо учесть, что уровень безопасности будет снижен.

IP-адрес ILB указан в разделе **IP-адреса**. В нем также указаны внешние виртуальные IP-адреса и IP-адреса для входящего трафика управления.

![][5]

### <a name="functions-and-the-ilb-ase"></a>Функции и ASE с подсистемой ILB

При использовании решения "Функции" в среде ASE с ILB может возникнуть ошибка с сообщением *Сейчас не удается извлечь ваши функции.  Повторите попытку позже*.  Это обусловлено тем, что пользовательский интерфейс решения "Функции" использует сайт SCM по протоколу HTTPS.  Так происходит, когда сертификат HTTP используется для среды ASE, у которой нет корневого сертификата в браузере.  При этом в браузерах IE и Edge параметр *accept-invalid-cert* нельзя применить одновременно на нескольких вкладках. Вы можете выбрать один из следующих способов:

- добавить сертификат в хранилище доверенных сертификатов; 
- использовать Chrome, но сначала перейти на сайт SCM, принять недоверенный сертификат, а затем перейти на портал.

## <a name="dns-configuration"></a>Настройка DNS ##

При использовании внешнего виртуального IP-адреса службой DNS управляет Azure. Любое приложение, созданное в ASE, автоматически добавляется в службу DNS Azure, которая является общедоступной. В ASE с ILB необходимо управлять собственной службой DNS. Для заданного домена, например _contoso.net_, необходимо создать записи А в DNS, указывающие на адрес ILB, для:

- *.contoso.net;
- *.scm.contoso.net.

Если домен среды ASE с ILB используется для нескольких операций за пределами этой среды, может потребоваться управлять службой DNS для каждого имени приложения. Это усложняет задачу, так как необходимо добавлять имя каждого нового приложения в службу DNS при его создании. Поэтому мы рекомендуем использовать выделенный домен.

## <a name="publishing-with-an-ilb-ase"></a>Публикация с использованием ASE с подсистемой ILB ##

Для каждого создаваемого приложения предоставляются две конечные точки. В ASE с ILB это *&lt;имя_приложения>.&lt;домен_ASE_с_ILB>* и *&lt;имя_приложения>.scm.&lt;домен_ASE_с_ILB>*. 

Если выбрать имя сайта SCM, вы перейдете в консоль Kudu, которая называется **расширенным порталом**, на портале Azure. Консоль Kudu предоставляет множество возможностей, в том числе просмотр переменных среды, просмотр данных диска, использование консоли и многое другое. Дополнительные сведения см. на странице, посвященной [консоли Kudu для службы приложений Azure][Kudu]. 

В мультитенантной службе приложений и внешней среде ASE применяется единый вход между порталом Azure и консолью Kudu. Тем не менее в среде ASE с ILB необходимо использовать учетные данные публикации для входа в консоль Kudu.

Веб-системы непрерывной интеграции, такие как GitHub и VSTS, не работают со средой ASE с ILB, так как конечная точка публикации недоступна через Интернет. Вместо этого необходимо использовать систему непрерывной интеграции, в которой применяется модель полного извлечения, например Dropbox.

Для конечных точек публикации приложений в среде ASE с ILB используется домен, созданный вместе со средой. Это можно увидеть в профиле публикации приложения и в колонке приложения на портале (в разделе **Обзор** > **Основное** и в разделе **Свойства**). При наличии среды ASE с ILB с поддоменом *contoso.net* и приложения с именем *mytest* вы перейдете по протоколу FTP по адресу *mytest.contoso.net* и выполните веб-развертывание по адресу *mytest.scm.contoso.net*.

## <a name="coupling-an-ilb-ase-with-a-waf-device"></a>Взаимозависимость среды ASE с подсистемой ILB и устройства WAF ##

Служба приложений Azure предоставляет множество мер безопасности для защиты системы и обнаружения взлома приложения. Лучший способ защиты веб-приложения — создание зависимости между платформой размещения, например службой приложений Azure, и брандмауэром веб-приложения (WAF). Так как конечная точка приложения в среде ASE с ILB изолирована от сети, этот способ подойдет идеально.  

Дополнительные сведения о настройке ASE с ILB и устройства WAF см. в статье [Настройка брандмауэра веб-приложения (WAF) для среды службы приложений][ASEWAF]. В этой статье объясняется, как использовать виртуальный модуль Barracuda со средой ASE. Другой способ — использовать шлюз приложений Azure. Шлюз приложений использует основные правила OWASP для защиты всех приложений, размещенных за этим шлюзом. Дополнительные сведения о шлюзе приложений Azure см. в статье [Брандмауэр веб-приложения (WAF)][AppGW].

### <a name="getting-started"></a>Приступая к работе ###

Все статьи и практические руководства, посвященные средам службы приложений, доступны в [файле сведений для сред службы приложений][ASEReadme].

Сведения о том, как начать работу со средами службы приложений, см. в статье [Introduction to App Service Environment][Intro] (Знакомство со средой службы приложений).

Дополнительные сведения о платформе службы приложений Azure см. в [этой статье](http://azure.microsoft.com/documentation/articles/app-service-value-prop-what-is/).
 
<!--Image references-->
[1]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-network.png
[2]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-webapp.png
[3]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-certificate.png
[4]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-certificate2.png
[5]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-ipaddresses.png

<!--Links-->
[Intro]: ./intro.md
[MakeExternalASE]: ./create-external-ase.md
[MakeASEfromTemplate]: ./create-from-template.md
[MakeILBASE]: ./create-ilb-ase.md
[ASENetwork]: ./network-info.md
[ASEReadme]: ./readme.md
[UsingASE]: ./using-an-ase.md
[UDRs]: ../../virtual-network/virtual-networks-udr-overview.md
[NSGs]: ../../virtual-network/virtual-networks-nsg.md
[ConfigureASEv1]: ../../app-service-web/app-service-web-configure-an-app-service-environment.md
[ASEv1Intro]: ../../app-service-web/app-service-app-service-environment-intro.md
[webapps]: ../../app-service-web/app-service-web-overview.md
[mobileapps]: ../../app-service-mobile/app-service-mobile-value-prop.md
[APIapps]: ../../app-service-api/app-service-api-apps-why-best-platform.md
[Functions]: ../../azure-functions/index.yml
[Pricing]: http://azure.microsoft.com/pricing/details/app-service/
[ARMOverview]: ../../azure-resource-manager/resource-group-overview.md
[ConfigureSSL]: ../../app-service-web/web-sites-purchase-ssl-web-site.md
[Kudu]: http://azure.microsoft.com/resources/videos/super-secret-kudu-debug-console-for-azure-web-sites/
[AppDeploy]: ../../app-service-web/web-sites-deploy.md
[ASEWAF]: ../../app-service-web/app-service-app-service-environment-web-application-firewall.md
[AppGW]: ../../application-gateway/application-gateway-web-application-firewall-overview.md

