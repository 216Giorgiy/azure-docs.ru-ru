---
title: "Рекомендации по работе с сетями при помощи среды службы приложений Azure"
description: "Сведения о трафике в среде ASE, а также установке групп NSG и определяемых пользователем маршрутов при ее помощи"
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 955a4d84-94ca-418d-aa79-b57a5eb8cb85
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/08/2017
ms.author: ccompy
ms.translationtype: Human Translation
ms.sourcegitcommit: cb4d075d283059d613e3e9d8f0a6f9448310d96b
ms.openlocfilehash: d19590c23da43e08ea42cd278347e01d87433a58
ms.contentlocale: ru-ru
ms.lasthandoff: 06/26/2017

---
# <a name="networking-considerations-for-an-app-service-environment"></a>Рекомендации по работе с сетями в среде службы приложений #

## <a name="overview"></a>Обзор ##

[Среда службы приложений][Intro] (ASE) — это развернутая служба приложений Azure в подсети виртуальной сети Azure.  Есть два типа развертывания для ASE.

- _Внешняя ASE_ — предоставляет приложения, размещенные в ASE, по доступному в Интернете IP-адресу. Дополнительные сведения см. в разделе о [создании внешней среды ASE][MakeExternalASE].
- _ASE с ILB_ — предоставляет приложения в ASE по IP-адресу в вашей виртуальной сети Azure.  Внутренняя конечная точка является внутренней подсистемой балансировки нагрузки (ILB). Поэтому среда называется ASE с ILB. Дополнительные сведения см. в статье о [создании и использовании ILB для ASE][MakeILBASE].

Сейчас доступны две версии ASE. Исходная версия ASE называется ASEv1, а более новая — ASEv2. Сведения об ASEv1 см. в статье [Введение в среду службы приложения][ASEv1Intro]. ASEv1 можно развернуть в классической виртуальной сети или в виртуальной сети Resource Manager. ASEv2 можно развернуть только в виртуальной сети Resource Manager.

Все вызовы из ASE поступают в Интернет через виртуальный IP-адрес виртуальной сети, присвоенный ASE. Общедоступным IP-адресом этого виртуального IP-адреса является исходный IP-адрес для всех вызовов из ASE, поступающих в Интернет.  Если приложения в вашей среде ASE отправляют вызовы к ресурсам в виртуальной сети или в VPN, исходный IP-адрес будет одним из IP-адресов в подсети, используемой ASE.  Среда ASE размещена в виртуальной сети, и ее ресурсы доступны для ASE без дополнительной настройки. Если виртуальная сеть подключена к локальной, ее ресурсы также доступны для ASE без дополнительной настройки среды или приложения.

![][1] 

При использовании внешней ASE общедоступный виртуальный IP-адрес также является конечной точкой, с которой приложения ASE будут сопоставлять данные для HTTP/S, FTP/S, веб-развертывания и удаленной отладки.

![][2]

При использовании ASE с ILB конечной точкой для HTTP/S, FTP/S, веб-развертывания и удаленной отладки будет IP-адрес ILB.

Стандартные порты доступа для приложения:

| Использование | Из | Кому |
|----------|---------|-------------|
|  HTTP/HTTPS  | Настраивается пользователем |  80, 443 |
|  FTP/FTPS    | Настраивается пользователем |  21, 990, 10001-10020 |
|  Удаленная отладка в Visual Studio  |  Настраивается пользователем |  4016, 4018, 4020, 4022 |

Эти порты применимы, если вы используете внешнюю ASE или ASE с ILB. Во внешней ASE переход к этим портам осуществляется по общедоступному виртуальному IP-адресу. В ASE с ILB переход к этим портам осуществляется в ILB. Обратите внимание, что блокировка порта 443 может повлиять на некоторые возможности, предоставляемые на портале. Дополнительные сведения см. в разделе [Зависимости портала](#portaldep).

## <a name="ase-dependencies"></a>Зависимости ASE ##

Зависимости ASE для входящего трафика:

| Использование | Из | Кому |
|-----|------|----|
| управления | Интернет | Подсеть ASE: 454, 455 |
|  Внутренний обмен данными ASE | Подсети ASE: все порты | Подсети ASE: все порты
|  Разрешение входящего трафика Azure Load Balancer | Azure Load Balancer | Любой

Помимо системы мониторинга, входящий трафик обеспечивает контроль и управление ASE. Исходные IP-адреса для этого трафика не являются постоянными. Это означает, что в конфигурации безопасности сети необходимо разрешить доступ со всех IP-адресов через порты 454 и 455.

Что касается доступа исходящего трафика, среда ASE зависит от различных внешних систем. Эти зависимости системы определяются при помощи DNS-имен и не сопоставляются с фиксированным набором IP-адресов. Это означает, что ASE требуется доступ исходящего трафика из подсети ASE для всех внешних IP-адресов через различные порты. Зависимости ASE для исходящего трафика:

| Использование | Из | Кому |
|-----|------|----|
| Хранилище Azure | Подсеть ASE | table.core.windows.net, blob.core.windows.net, queue.core.windows.net, file.core.windows.net: 80, 443, 445 (445 необходим только для ASEv1) |
| База данных SQL | Подсеть ASE | database.windows.net: 1433, 11000-11999, 14000-14999 (Дополнительные сведения см. в статье об [использовании портов базы данных Sql V12](../../sql-database/sql-database-develop-direct-route-ports-adonet-v12.md))|
| Управление Azure | Подсеть ASE | management.core.windows.net, management.azure.com: 443 
| Проверка сертификатов SSL |  Подсеть ASE            |  ocsp.msocsp.com, mscrl.microsoft.com, crl.microsoft.com: 443
| Azure Active Directory        | Подсеть ASE            |  Интернет: 443
| Управление службой приложений        | Подсеть ASE            |  Интернет: 443
| Azure DNS                     | Подсеть ASE            | Интернет: 53
| Внутренний обмен данными ASE    | Подсети ASE: все порты | Подсети ASE: все порты

Если у ASE нет доступа к этим зависимостям, среда прекращает работу. Если это происходит достаточно долго, ASE переходит в состояние приостановки.

**DNS пользователь**

Если в виртуальной сети настроен определенный пользователем DNS-сервер, она будет использоваться для рабочих нагрузок клиента. ASE по-прежнему необходим обмен данными со службой DNS Azure в целях управления. 

Если виртуальная сеть настроена при помощи DNS пользователя на другом конце VPN, DNS-сервер должен быть доступен из подсети, в которой размещена ASE.

<a name="portaldep"></a>
## <a name="portal-dependencies"></a>Зависимости портала ##

Помимо функциональных зависимостей ASE, есть несколько дополнительных элементов, относящихся к интерфейсу портала. Некоторые возможности на портале Azure зависят от прямого доступа к _сайту диспетчера служб_. Для каждого приложения в службе приложений Azure предусмотрено два URL-адреса. Первый URL-адрес предназначен для доступа к вашему приложению. Второй URL-адрес предназначен для доступа к сайту диспетчера служб, который также называется _Консоль Kudu_. Ниже перечислены некоторые компоненты, использующие сайт диспетчера служб.

-   Веб-задания
-   Functions
-   Поток журнала
-   Kudu
-   расширения.
-   Обозреватель процессов
-   Консоль

При использовании ASE с ILB возникают значительные сложности, так как сайт диспетчера служб недоступен в Интернете вне виртуальной сети. Поэтому возможности, зависящие от доступа к сайту диспетчера служб, отключены на портале Azure, если приложение размещено в ASE с ILB.

Многие возможности, зависящих от доступа к сайту диспетчера служб, доступны непосредственно в консоли Kudu. Можно напрямую подключиться к ней, не используя портал. Если приложение размещено в ASE с ILB, войдите в систему с учетными данными для публикации. Формат URL-адреса для доступа к сайту диспетчера служб из приложения, размещенного в ASE с ILB: 

```
<appname>.scm.<domain name the ILB ASE was created with> 
```

Таким образом, если доменное имя вашей среды ASE с ILB — *contoso.net*, а имя приложения — *testapp*, приложение будет доступно по адресу *testapp.contoso.net*, а связанный с ним сайт диспетчера служб — по адресу *testapp.scm.contoso.net*.

## <a name="ase-ip-addresses"></a>IP-адреса ASE ##

В ASE есть несколько IP-адресов, на которые следует обратить внимание. К ним относятся:

- Общедоступный IP-адрес для входящего трафика — используется для трафика приложений во внешней ASE и ASE с ILB.
- Общедоступный IP-адрес для исходящего трафика — используется в качестве IP-адреса для исходящих подключений ASE из виртуальной сети, которым не назначен маршрут VPN.
- IP-адрес ILB — при использовании ASE с ILB.
- Присвоенные приложению адреса с SSL на основе IP — могут применяться, только если используется внешняя ASE и настроен SSL на основе IP-адреса.

Все эти IP-адреса можно просмотреть в ASEv2 на портале Azure в пользовательском интерфейсе ASE. Если вы используете ASE с ILB, отображается IP-адрес для ILB.

![][3]

**IP-адрес, присвоенный приложению**

Внешняя ASE позволяет назначать IP-адреса отдельным приложениям. В ASE с ILB такая возможность не предусмотрена. Дополнительные сведения о настройке приложения для получения IP-адреса см. в статье [Привязывание существующего настраиваемого SSL-сертификата к веб-приложениям Azure](../../app-service-web/app-service-web-tutorial-custom-ssl.md).

Если у приложения есть собственный адрес с SSL на основе IP, ASE резервирует два порта для сопоставления с этим IP-адресом. Один порт используется для трафика HTTP, а другой — для трафика HTTPS. Эти порты указаны в разделе IP-адресов пользовательского интерфейса ASE. Порты должны быть открыты для трафика, поступающего с виртуального IP-адреса, иначе приложения будут недоступны. Это важно помнить при настройке групп безопасности сети.

## <a name="network-security-groups"></a>группы сетевой безопасности; ##

[Группы безопасности сети][NSGs] (NSG) дают возможность управлять сетевым доступом в виртуальной сети. При использовании портала действует неявное правило всеобщего запрета с самым низким приоритетом. Поэтому необходимо создать правила разрешения.

В среде ASE нет доступа к виртуальным машинам, используемым для ее размещения. Они входят в подписку под управлением Майкрософт. Чтобы ограничить доступ к приложениям в ASE, задайте в подсети ASE группы NSG. При этом обязательно обратите внимание на зависимости ASE. Блокировка любой зависимости остановит работу ASE.

Группы NSG можно настроить на портале Azure или с помощью PowerShell. Для упрощения здесь описана настройка на портале Azure. Группы NSG создаются и управляются на портале в разделе **Сеть** как ресурс верхнего уровня.

В соответствии с требованиями к входящему и исходящему трафику, группы NSG должны быть оформлены, как показано ниже. В этом примере диапазон адресов в виртуальной сети — _192.168.250.0/16_, а диапазон адресов в подсети с ASE — _192.168.251.128/25_.

Первые два требования к входящему трафику для работы ASE представлены в верхней части примера. Они отвечают за управление и внутренний обмен данными в ASE. Другие записи можно настроить во всех клиентах и использовать для управления сетевым доступом к приложениям в ASE.   

![][4]

Помимо правила по умолчанию, активирующего обмен данными между IP-адресами в виртуальной сети и подсетью ASE, действует правило по умолчанию, которое позволяет подсистеме балансировки нагрузки (или общедоступному виртуальному IP-адресу) обмениваться данными с ASE.  Правила по умолчанию можно просмотреть, щелкнув *Правила по умолчанию* рядом со значком *Добавить*. Если поместить правило всеобщего запрета после приведенных правил NSG, это будет препятствовать трафику между виртуальным IP-адресом и ASE. Чтобы запретить трафик, поступающий из виртуальной сети, обязательно добавьте собственное правило для разрешения входящего трафика, указав для источника значение AzureLoadBalancer, для назначения — значение Any (Любое), а для диапазона портов — \*.  Поскольку правило NSG применяется только к подсети ASE, указывать конкретное назначение не требуется.

Если приложению присвоен IP-адрес, убедитесь, что используемые с ним порты открыты. Их можно просмотреть в пользовательском интерфейсе, последовательно выбрав пункты **Среда службы приложений** > **IP-адреса**.  

Все элементы правил исходящего трафика, кроме последнего, обязательны. Они обеспечивают доступ к сети для зависимостей ASE, которые упоминались ранее в этом документе. При блокировке любого из элементов ASE прекратит работу. Последний элемент в списке позволяет среде ASE обмениваться данными с другими ресурсами в виртуальной сети.

![][5]

Определив группы NSG, необходимо присвоить их подсети, в которой размещена ASE. Если вы не помните название виртуальной сети или подсети ASE, можно найти его на портале управления ASE. Чтобы присвоить подсети группу NSG, перейдите к пользовательскому интерфейсу подсети и выберите NSG.

## <a name="routes"></a>Маршруты ##

При настройке виртуальной сети с помощью ExpressRoute маршрутизация зачастую сопровождается проблемами. В виртуальной сети Azure существует три типа маршрутов:

-   Системные маршруты
-   Маршруты BGP
-   Определяемые пользователем маршруты.

Маршруты BGP переопределяют системные маршруты. Определяемые пользователем маршруты переопределяют маршруты BGP. Дополнительные сведения о маршрутах в виртуальных сетях Azure см. в статье [Определяемые пользователем маршруты и IP-пересылка][UDRs]

В базе данных SQL, используемой ASE для управления системой, предусмотрен список разрешений. Передача данных должна осуществляться с общедоступного виртуального IP-адреса ASE. Если ответы на входящие запросы управления отправляются по ExpressRoute, адрес ответа отличается от целевого. Это нарушает связь TCP.

Ниже описан самый простой метод, обеспечивающий работу среды ASE, если виртуальная сеть настроена при помощи ExpressRoute.

-   Настройте ExpressRoute для объявления маршрута _0.0.0.0/0_ и принудительного туннелирования всего исходящего трафика в локальную среду по умолчанию.
-   Создайте определяемый пользователем маршрут и примените его к подсети со средой службы приложений, добавив к адресу префикс _0.0.0.0/0_ и указав для следующего прыжка тип _Интернет_.

После этих двух изменений исходящий трафик из подсети ASE в Интернет не будет принудительно направляться по маршруту ExpressRoute и ASE возобновит работу. 

> [!IMPORTANT]
> Определяемые пользователем маршруты должны быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute. В приведенном выше примере используется широкий диапазон адресов 0.0.0.0/0. Он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.
>

Среды службы приложений с конфигурациями ExpressRoute, осуществляющие перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга, не поддерживаются. Конфигурации ExpressRoute с настроенным общедоступным пирингом будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Если эти диапазоны адресов перекрестно объявляются по пути закрытого пиринга, то все исходящие сетевые пакеты из подсети среды службы приложений будут принудительно туннелироваться в локальную сетевую инфраструктуру клиента. В настоящее время этот сетевой поток не поддерживается в среде службы приложений. Чтобы решить эту проблему, необходимо остановить перекрестное объявление маршрутов между путем общедоступного и закрытого пиринга.

Создание определяемого пользователем маршрута

1.  Перейдите на портал Azure и последовательно выберите элементы **Сеть** > **Таблицы маршрутов**.
2.  Создайте таблицу маршрутов в том же регионе, где находится виртуальная сеть.
3.  В пользовательском интерфейсе таблицы маршрутов последовательно выберите элементы **Маршруты** > **Добавить**.
4.  Задайте для параметра **Тип следующего прыжка** значение **Интернет**, а для параметра **Префикс адреса** — значение _0.0.0.0/0_ и нажмите кнопку **Сохранить**.

Вы увидите похожий экран:

![][6]

Создав таблицу маршрутов, перейдите к подсети с ASE. Выберите свою таблицу маршрутов из списка на портале. После сохранения изменений отобразится список групп NSG и маршрутов, указанных в подсети.

![][7]

### <a name="deploying-into-existing-azure-virtual-networks-that-are-integrated-with-expressroute"></a>Развертывание в существующих виртуальных сетях Azure, интегрированных с ExpressRoute ###

Чтобы развернуть ASE в виртуальной сети, уже интегрированной с ExpressRoute, предварительно настройте подсеть, в которой будет развернута среда ASE. Затем выполните развертывание, воспользовавшись шаблоном Resource Manager. Чтобы создать ASE в виртуальной сети, где уже выполнена настройка ExpressRoute, следуйте инструкциям ниже.

- Создайте подсеть для размещения ASE.

    > [!NOTE]
    > В подсети должна размещаться исключительно среда ASE. Обязательно выберите достаточно большое адресное пространство для будущего расширения, так как впоследствии его уже не удастся изменить. Рекомендуемый размер — `/25` с 128 адресами.
- Создайте определяемые пользователем маршруты (т. е. таблицы маршрутов), как описано выше, и задайте их для подсети.
- Создайте ASE при помощи шаблона Resource Manager, выполнив инструкции в статье о [создании ASE с помощью шаблона ARM][MakeASEfromTemplate].

<!--Image references-->
[1]: ./media/network_considerations_with_an_app_service_environment/networkase-overflow.png
[2]: ./media/network_considerations_with_an_app_service_environment/networkase-overflow2.png
[3]: ./media/network_considerations_with_an_app_service_environment/networkase-ipaddresses.png
[4]: ./media/network_considerations_with_an_app_service_environment/networkase-inboundnsg.png
[5]: ./media/network_considerations_with_an_app_service_environment/networkase-outboundnsg.png
[6]: ./media/network_considerations_with_an_app_service_environment/networkase-udr.png
[7]: ./media/network_considerations_with_an_app_service_environment/networkase-subnet.png

<!--Links-->
[Intro]: ./intro.md
[MakeExternalASE]: ./create-external-ase.md
[MakeASEfromTemplate]: ./create-from-template.md
[MakeILBASE]: ./create-ilb-ase.md
[ASENetwork]: ./network-info.md
[ASEReadme]: ./readme.md
[UsingASE]: ./using-an-ase.md
[UDRs]: ../../virtual-network/virtual-networks-udr-overview.md
[NSGs]: ../../virtual-network/virtual-networks-nsg.md
[ConfigureASEv1]: ../../app-service-web/app-service-web-configure-an-app-service-environment.md
[ASEv1Intro]: ../../app-service-web/app-service-app-service-environment-intro.md
[webapps]: ../../app-service-web/app-service-web-overview.md
[mobileapps]: ../../app-service-mobile/app-service-mobile-value-prop.md
[APIapps]: ../../app-service-api/app-service-api-apps-why-best-platform.md
[Functions]: ../../azure-functions/index.yml
[Pricing]: http://azure.microsoft.com/pricing/details/app-service/
[ARMOverview]: ../../azure-resource-manager/resource-group-overview.md
[ConfigureSSL]: ../../app-service-web/web-sites-purchase-ssl-web-site.md
[Kudu]: http://azure.microsoft.com/resources/videos/super-secret-kudu-debug-console-for-azure-web-sites/
[AppDeploy]: ../../app-service-web/web-sites-deploy.md
[ASEWAF]: ../../app-service-web/app-service-app-service-environment-web-application-firewall.md
[AppGW]: ../../application-gateway/application-gateway-web-application-firewall-overview.md

