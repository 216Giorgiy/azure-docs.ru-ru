---
title: Руководство. Мониторинг сетевого взаимодействия с помощью портала Azure | Документация Майкрософт
description: Сведения о мониторинге сетевого взаимодействия между двумя виртуальными машинами с помощью монитора подключения, возможности службы "Наблюдатель за сетями Azure".
services: network-watcher
documentationcenter: na
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
Customer intent: I need to monitor communication between a VM and another VM. If the communication fails, I need to know why, so that I can resolve the problem.
ms.service: network-watcher
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/27/2018
ms.author: jdial
ms.custom: mvc
ms.openlocfilehash: bfd9552a0d7c3b1e631fcc1a25d240608754c6a3
ms.sourcegitcommit: ca05dd10784c0651da12c4d58fb9ad40fdcd9b10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
---
# <a name="tutorial-monitor-network-communication-between-two-virtual-machines-using-the-azure-portal"></a>Руководство. Мониторинг сетевого взаимодействия между двумя виртуальными машинами с помощью портала Azure

Успешное взаимодействие между виртуальной машиной и конечной точкой, такой как другая виртуальная машина, может иметь решающее значение для вашей организации. Иногда изменения конфигурации могут нарушить эту связь. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * создание двух виртуальных машин;
> * мониторинг сетевого взаимодействия между виртуальными машинами с помощью монитора подключения, возможности Наблюдателя за сетями;
> * диагностика и устранение проблем со связью между двумя виртуальными машинами.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на [портале Azure](https://portal.azure.com).

## <a name="create-vms"></a>Создание виртуальных машин

Создайте две виртуальные машины.

### <a name="create-the-first-vm"></a>Создание первой виртуальной машины

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Вычисление**, а затем выберите операционную систему. В этом руководстве используется **Windows Server 2016 Datacenter**.
3. Введите или выберите следующие значения, примите значения по умолчанию для остальных параметров и нажмите кнопку **ОК**:

    |Параметр|Значение|
    |---|---|
    |ИМЯ|myVm1|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов| Выберите **Создать новую**, а затем введите **myResourceGroup**.|
    |Расположение| Выберите **Восточная часть США**.|

4. Выберите размер виртуальной машины и щелкните **Выбрать**.
5. В разделе **Параметры** выберите **Расширения**. Выберите **Добавить расширение**, а затем — **Network Watcher Agent for Windows** (Агент Наблюдателя за сетями для Windows), как показано на следующем рисунке.

    ![Расширение "Агент Наблюдателя за сетями"](./media/connection-monitor/nw-agent-extension.png)

6. В разделе **Network Watcher Agent for Windows** (Агент Наблюдателя за сетями для Windows) выберите **Создать**, в разделе **Установить расширение** нажмите кнопку **ОК**, а затем и в разделе **Расширения** нажмите кнопку **ОК**.
7. Оставьте значения по умолчанию для остальных **параметров** и нажмите кнопку **ОК**.
8. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины.

### <a name="create-the-second-vm"></a>Создание второй виртуальной машины

Снова выполните шаги из раздела [Создание первой виртуальной машины](#create-the-first-vm) со следующими изменениями.

|Шаг|Параметр|Значение|
|---|---|---|
| 1 | Выберите **виртуальную машину Ubuntu Server 17.10** |                                                                         |
| 3 | ИМЯ                              | myVm2                                                                   |
| 3 | Authentication type (Тип проверки подлинности)               | Вставьте свой открытый ключ SSH или выберите **Пароль** и введите пароль. |
| 3 | Группа ресурсов                    | Щелкните **Использовать существующую** и выберите **myResourceGroup**.                 |
| 6 | расширения.                        | **Сетевой агент для Linux**                                             |

Развертывание виртуальной машины занимает несколько минут. Дождитесь окончания развертывания виртуальной машины, прежде чем приступить к выполнению следующих шагов.

## <a name="create-a-connection-monitor"></a>Создание монитора подключения

Создайте монитор подключения для мониторинга подключения по TCP-порту 22 между *myVm1* и *myVm2*.

1. В левой области портала выберите **Все службы**.
2. Начните вводить *наблюдатель за сетями* в поле **Фильтр**. Когда в результатах поиска появится **Наблюдатель за сетями**, выберите его.
3. В разделе **Мониторинг** выберите **Connection monitor** (Монитор подключений).
4. Щелкните **+ Добавить**.
5. Укажите информацию о подключении, которое требуется отслеживать, а затем выберите **Добавить**. В примере, показанном на следующем рисунке, отслеживается подключение между виртуальными машинами *myVm1* и *myVm2* через порт 22.

    | Параметр                  | Значение               |
    | ---------                | ---------           |
    | ИМЯ                     | myVm1-myVm2(22)     |
    | Источник                   |                     |
    | Виртуальная машина.          | myVm1               |
    | Место назначения              |                     |
    | Выбор виртуальной машины |                     |
    | Виртуальная машина.          | myVm2               |
    | Порт                     | 22                  |

    ![Добавление монитора подключения](./media/connection-monitor/add-connection-monitor.png)

## <a name="view-a-connection-monitor"></a>Просмотр монитора подключения

1. Выполните шаги 1–3 в разделе [Создание монитора подключения](#create-a-connection-monitor) для просмотра мониторинга подключения. Отобразится список имеющихся мониторов подключения, как показано на следующем рисунке.

    ![Мониторы подключения](./media/connection-monitor/connection-monitors.png)

2. Выберите монитор с именем **myVm1-myVm2(22)**, чтобы просмотреть сведения о мониторе, как показано на следующем рисунке.

    ![Сведения о мониторе](./media/connection-monitor/vm-monitor.png)

    Обратите внимание на следующие сведения:

    | Элемент                     | Значение                      | Сведения                                                     |
    | ---------                | ---------                  |--------                                                     |
    | Status                   | Доступен                  | Позволяет узнать, доступна ли конечная точка.|
    | Средний круговой путь          | Позволяет узнать время кругового пути для установки подключения (в миллисекундах). Монитор подключения проверяет подключения каждые 60 секунд, поэтому вы можете отслеживать задержку с течением времени.                                         |
    | Hops                     | Монитор подключения предоставляет сведения о прыжках между двумя конечными точками. В этом примере подключение установлено между двумя виртуальными машинами в той же виртуальной сети, поэтому имеется только один прыжок — на IP-адрес 10.0.0.5. При наличии каких-либо системных или пользовательских маршрутов, маршрутизации трафика между виртуальными машинами через VPN-шлюз или, например, сетевое виртуальное устройство, будут перечислены дополнительные прыжки.                                                                                                                         |
    | Состояние                   | Зеленые отметки для каждой конечной точки показывают, что конечные точки работоспособны.    ||

## <a name="view-a-problem"></a>Просмотр неполадок

По умолчанию Azure позволяет осуществлять связь по всем портам между виртуальными машинами в одной виртуальной сети. Со временем вы или кто-либо из вашей организации может переопределить правила по умолчанию Azure, непреднамеренно вызвав сбои в связи. Выполните следующие шаги, чтобы инициировать неполадку со связью, а затем снова просмотрите монитор подключения.

1. В поле поиска в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите группу безопасности сети **myVm2-nsg**.
3. Выберите **Правила безопасности для входящего трафика**, а затем щелкните **Добавить**, как показано на следующем рисунке.

    ![Правила безопасности для входящего трафика](./media/connection-monitor/inbound-security-rules.png)

4. Правило **AllowVnetInBound** — это правило по умолчанию, позволяющее осуществлять связь между всеми виртуальными машинами в виртуальной сети. Создайте правило с более высоким приоритетом (меньшее число), чем правило **AllowVnetInBound**, которое отклоняет входящую связь через порт 22. Выберите или введите приведенные ниже сведения, примите значения по умолчанию и щелкните **Добавить**.

    | Параметр                 | Значение          |
    | ---                     | ---            |
    | Диапазоны портов назначения | 22             |
    | Действие                  | Запрет           |
    | Приоритет                | 100            |
    | ИМЯ                    | DenySshInbound |

5. Так как монитор подключения выполняет проверку с интервалом 60 секунд, подождите несколько минут, а затем в левой части портала выберите **Наблюдатель за сетями**, затем — **Монитор подключения**  и монитор **myVm1-myVm2(22)**. Теперь результаты отличаются от показанных на следующем рисунке.

    ![Сведения о сбое в мониторе](./media/connection-monitor/vm-monitor-fault .png)

    В столбце состояния сетевого интерфейса **myvm2529** отображается красный восклицательный знак.

6. Чтобы узнать, почему состояние изменилось, выберите 10.0.0.5, как на предыдущем рисунке. Монитор подключения сообщает вам следующую причину сбоя связи: *Traffic blocked due to the following network security group rule: UserRule_DenySshInbound* (Трафик заблокирован из-за следующего правила группы безопасности сети: UserRule_DenySshInbound).

    Если вы не знали, что кто-то реализовал правило безопасности, которое вы создали на шаге 4, с помощью монитора подключений вы узнаете, что это правило вызывает неполадки со связью. Затем вы можете изменить, переопределить или удалить это правило, чтобы восстановить связь между виртуальными машинами.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как отслеживать подключение между двумя виртуальными машинами, а также о том, что правило группы безопасности сети может запретить связь с виртуальной машиной. Сведения о различных ответах, которые может возвратить монитор подключения, см. в [этом разделе](network-watcher-connectivity-overview.md#response). Кроме того, вы можете отслеживать подключение между виртуальными машинами, полными доменными именами, IP-адресами или универсальными кодами ресурсов.

В какой-то момент вы обнаружите, что ресурсы в виртуальной сети не могут взаимодействовать с ресурсами в других сетях, подключенных с помощью шлюза виртуальной сети Azure. Перейдите к следующему руководству, чтобы узнать, как выполнить диагностику проблемы с помощью шлюза виртуальной сети.

> [!div class="nextstepaction"]
> [Руководство по диагностике проблем с обменом данными между сетями](diagnose-communication-problem-between-networks.md)