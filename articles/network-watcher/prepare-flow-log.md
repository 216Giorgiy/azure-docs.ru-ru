---
title: Изменение журнала потоков группы безопасности сети Azure | Документация Майкрософт
description: Ознакомьтесь с изменениями журнала потоков группы безопасности сети Azure.
services: network-watcher
documentationcenter: na
author: jimdial
manager: jeconnoc
editor: ''
ms.assetid: ''
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/16/2018
ms.author: jdial
ms.openlocfilehash: b3a5ca929c83f70c31d667c2d9c811623691cff8
ms.sourcegitcommit: 1aedb52f221fb2a6e7ad0b0930b4c74db354a569
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2018
ms.locfileid: "40180672"
---
# <a name="network-security-group-flow-logs--version-2--upcoming-changes"></a>Журналы потоков группы безопасности сети версии 2 — предстоящие изменения

Формат журналов потоков групп безопасности сети изменяется начиная с 15 сентября 2018 года. Добавленные поля предоставляют вам информацию о состоянии потока и инкрементное количество байтов и пакетов, переданных в каждом направлении. Это изменение затронет приложения, выполняющие синтаксический анализ журналов потоков. Эти приложения должны быть обновлены соответствующим образом. В этой статье описываются подробности изменения.

## <a name="what-is-changing"></a>Что изменяется?

Версия журнала потоков группы безопасности сети изменится с версии 1 на 2, и в свойство *flowTuples* в журналах будут добавлены дополнительные поля. Подробная информация о формате представлена ​​в статье о [моделировании потока в версии 2](#how-is-a-flow-modeled-in-version-2).

### <a name="version-1-flow-tuple-format"></a>Формат кортежа потока версии 1

```
"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,D"
```

### <a name="version-2-flow-tuple-format"></a>Формат кортежа потока версии 2

```
"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1,103,1,186"
```

## <a name="when-will-this-change-take-place"></a>Когда произойдет это изменение?

Это изменение вступит в силу **15 сентября 2018 года** в центрально-западной части США. Развертывание изменений в регионах общедоступного облака завершится к 31 ноября 2018 года, после чего будут доступны только журналы версии 2.

## <a name="am-i-affected-by-the-change"></a>Затронет ли меня изменение?

Это изменение может затронуть вас, если вы создаете или используете приложение, которое обрабатывает данные журналов потоков групп безопасности сети.

### <a name="if-i-use-traffic-analytics"></a>Если я использую решение "Аналитика трафика"?

Нет. Переход с ведения журнала потоков NSG версии 1 на версию 2 не повлияет на Аналитику трафика. Усовершенствования, которые ожидаются в ближайшее время, будут касаться дополнительных сведений о сеансах и пропускной способности в версии 2 журналов потоков.

### <a name="if-im-using-third-party-tooling"></a>Если я использую сторонние средства?

Об изменении формата журнала было сообщено заранее всем, кто предоставляет [партнерские решения Наблюдателя за сетями](https://azure.microsoft.com/services/network-watcher). Обратитесь к поставщику за подробной информацией.

### <a name="if-i-have-built-a-custom-application-or-integration"></a>Что если используется собственное приложение или реализована интеграция?

**Да**, вам нужно будет изменить приложение для обработки журналов потоков NSG в новом формате.

## <a name="what-is-the-new-flow-logging-format"></a>Что представляет собой новый формат ведения журнала потоков?

Журналы потоков версии 2 содержат кортежи потоков в следующем формате:

```
"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1,103,1,186".
```

В следующей таблице приведены имена и описания свойств кортежей потоков группы безопасности сети версии 2. Полные примеры записей можно найти в [примере события версии 2](#version2sampleevent).

| Имя свойства                        | Значение           | ОПИСАНИЕ                                                                                                                                                 |
| ------------------------------------ | --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Метка времени                           | 1493763938      | Метка времени, соответствующая записи потока. Используется формат UNIX EPOCH.                                                                                       |
| Исходный IP-адрес                    | 185.170.185.105 |                                                                                                                                                             |
| Конечный IP-адрес               | 10.2.0.4        |                                                                                                                                                             |
| Исходный порт                          | 35370           |                                                                                                                                                             |
| Конечный порт                     | 23              |                                                                                                                                                             |
| Протокол трафика                     | T               | **T**: TCP; **U**: UDP.                                                                                                                                  |
| Направление потока трафика               | I               | **I**: входящий трафик; **O**: исходящий трафик.                                                                                                         |
| Решение по трафику                     | A               | **А**: поток был разрешен; **D**: поток был отклонен.                                                                                                         |
| Состояние потока                           | C               | **B**: начать при создании потока. Статистика не предоставляется. **C**: продолжить для текущего потока. Статистика предоставляется с интервалом в 5 минут. **Е**: завершить после окончания потока. Статистика предоставляется.                                                                                                                                                        |
| Пакеты от источника к назначению      | 1               | Общее количество TCP- и UDP-пакетов, отправленных из источника в место назначения с момента последнего обновления.                                                                  |
| Байты, отправленные от источника к назначению   | 103             | Общее количество байт TCP- и UDP-пакетов, отправленных из источника в место назначения с момента последнего обновления. Байты пакетов включают в себя заголовок пакета и полезные данные.         |
| Пакеты, отправленные от источника к назначению | 1               | Общее количество TCP- и UDP-пакетов, отправленных из назначения к источнику с момента последнего обновления.                                                                  |
| Байты, отправленные от назначения к источнику   | 186             | Общее количество байт TCP- и UDP-пакетов, отправленных из назначения к источнику с момента последнего обновления. Байты пакетов включают в себя заголовок пакета и полезные данные.             |

## <a name="how-is-a-flow-modeled-in-version-2"></a>Как поток моделируется в версии 2?

В версии 2 журналов введено состояние потока. Состояние потока *B* регистрируется, когда инициируется поток. Состояние потока *C* и состояние потока *E* отмечают продолжение потока и его завершение соответственно. Оба состояния, *C* и *E*, содержат информацию о пропускной способности трафика.

**Пример**. Кортежи потока из TCP-диалога между 185.170.185.105:35370 и 10.2.0.4:23:

"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,A,B,,,," "1493695838,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1021,588096,8005,4610880" "1493696138,185.170.185.105,10.2.0.4,35370,23,T,I,A,E,52,29952,47,27072"

### <a name="how-does-the-format-differ-from-version-1"></a>Чем формат отличается от версии 1?

В версии 1 кортеж потока ["1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,D"] создается каждый раз при установке или попытке установить поток (случай запрета).

### <a name="how-are-bytes-and-packets-accounted-for"></a>Как учитываются байты и пакеты?

Для состояний продолжения *C* и окончания *E* потока счетчики байтов и пакетов являются совокупными счетчиками со времени предыдущей записи кортежа потока. Для предыдущего примера общее количество переданных пакетов равно 1021+52+8005+47 = 9125. Общее число переданных байтов: 588096+29952+4610880+27072 = 5256000.

### <a name="if-my-application-doesnt-understand-the-traffic-bandwidth-fields-how-does-version-2-affect-the-application"></a>Если мое приложение не распознает поля пропускной способности трафика, как версия 2 влияет на приложение?

Приложения, использующие ведение журнала потоков для групп безопасности сети версии 1, обычно подсчитывают количество уникальных потоков. Если для учета состояния потока не производится никаких изменений в синтаксическом анализе, вы можете увидеть неточное увеличение количества передаваемых потоков. Подсчет уникальных потоков может быть выполнен путем игнорирования кортежей потока в состояниях потока *C* и *E*.

## <a name="can-i-control-the-version-format-i-receive"></a>Могу ли я управлять форматом версии, который я получу?

Нет. Включение и отключение журналов потоков не влияет на формат выходных данных журналов. Изменение версии журналов с версии 1 на версию 2 будет происходить в зависимости от региона. Когда регион обновляется с версии 1 до версии 2, вы можете видеть журналы потоков NSG в обоих форматах. После завершения развертывания будут доступны только журналы версии 2.

## <a name="while-the-change-occurs-can-i-see-both-formats-for-the-same-network-security-group"></a>Пока происходит изменение, могу ли видеть оба формата для одной и той же группы безопасности сети?

Да. В пределах региона переход будет происходить на основе каждого MAC-адреса. Так как группа безопасности сети может применяться ко многим компьютерам, в хранилище могут быть записаны журналы в обоих форматах. Журналы будут иметь либо версию 1, либо версию 2.

## <a name="will-i-see-duplicate-data"></a>Данные будут дублироваться?

Данные ведения журнала потоков не будут дублироваться в различных форматах. Поток будет записан в формате версии 1 или версии 2, пока происходит изменение.

## <a name="how-can-i-test-the-new-format-ahead-of-time"></a>Как можно протестировать новый формат заранее?

Да. Вы можете [скачать пример](https://aka.ms/nsgflowlogsv2blobsample) файла журнала потоков пробной версии 2, чтобы использовать его для тестирования вашего решения.

## <a name="are-there-changes-to-configuration-and-management-of-network-security-group-flow-logging"></a>Имеются ли изменения в настройке и управлении ведением журнала потоков для групп безопасности сети?

Нет. Поддержка учетных записей хранения Azure в подписках, которые совместно используют один клиент Azure Active Directory, [выпущена](https://azure.microsoft.com/blog/new-azure-network-watcher-integrations-and-network-security-group-flow-logging-updates/) ранее в этом году. Это изменение позволяет сократить количество учетных записей хранения, необходимых при управлении журналами потоков групп безопасности сети.

## <a name="questions-or-feedback"></a>Есть вопросы или предложения?

Мы будем рады вашим отзывам об удобстве работы с журналами потоков групп безопасности сети и Наблюдателем за сетями. Отзывы и предложения можно предоставить через Интернет или по электронной почте AzureNetworkWatcher@microsoft.com.

## <a name="version-2-sample"></a>Пример версии 2

```json
{

"records": [

{

"time": "2018-08-03T17:00:54.5657764Z",

"systemId": "bbd48473-8ce0-4834-99bb-2e13b9b23ff8",

"category": "NetworkSecurityGroupFlowEvent",

"resourceId":
"/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FLOWLOGSV2DEMO/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/MULTITIERAPP2-NSG",

"operationName": "NetworkSecurityGroupFlowEvents",

"properties": {

"Version": 2,

"flows": [

{

"rule": "DefaultRule_AllowInternetOutBound",

"flows": [

{

"mac": "002248034CC3",

"flowTuples": [

"1533315592,10.1.1.6,204.79.197.200,62375,80,T,O,A,B,,,,",

"1533315595,10.1.1.6,204.79.197.200,62373,80,T,O,A,E,30,1784,92,123631",

"1533315597,10.1.1.6,204.79.197.200,62376,80,T,O,A,B,,,,",

"1533315601,10.1.1.6,204.79.197.200,62374,80,T,O,A,E,13,866,87,123079",

"1533315603,10.1.1.6,204.79.197.200,62377,80,T,O,A,B,,,,",

"1533315604,10.1.1.6,204.79.197.200,62375,80,T,O,A,E,33,1946,90,123247",

"1533315608,10.1.1.6,204.79.197.200,62378,80,T,O,A,B,,,,",

"1533315610,10.1.1.6,204.79.197.200,62376,80,T,O,A,E,20,1244,92,123355",

"1533315613,10.1.1.6,204.79.197.200,62379,80,T,O,A,B,,,,",

"1533315616,10.1.1.6,204.79.197.200,62377,80,T,O,A,E,24,1460,92,123355",

"1533315619,10.1.1.6,204.79.197.200,62380,80,T,O,A,B,,,,",

"1533315622,10.1.1.6,204.79.197.200,62378,80,T,O,A,E,23,1406,93,123409",

"1533315624,10.1.1.6,204.79.197.200,62381,80,T,O,A,B,,,,",

"1533315628,10.1.1.6,204.79.197.200,62379,80,T,O,A,E,16,1028,88,123133",

"1533315630,10.1.1.6,204.79.197.200,62382,80,T,O,A,B,,,,",

"1533315631,10.1.1.6,204.79.197.200,62380,80,T,O,A,E,13,866,87,123079",

"1533315635,10.1.1.6,204.79.197.200,62384,80,T,O,A,B,,,,",

"1533315637,10.1.1.6,204.79.197.200,62381,80,T,O,A,E,15,974,86,123025",

"1533315640,10.1.1.6,204.79.197.200,62385,80,T,O,A,B,,,,",

"1533315643,10.1.1.6,204.79.197.200,62382,80,T,O,A,E,16,1028,88,123139",

"1533315646,10.1.1.6,204.79.197.200,62386,80,T,O,A,B,,,,",

"1533315649,10.1.1.6,204.79.197.200,62384,80,T,O,A,E,21,1298,92,123355",

"1533315651,10.1.1.6,204.79.197.200,62387,80,T,O,A,B,,,,"

]

}

]

}

]

}

},

{

"time": "2018-08-03T17:01:54.5668880Z",

"systemId": "bbd48473-8ce0-4834-99bb-2e13b9b23ff8",

"category": "NetworkSecurityGroupFlowEvent",

"resourceId":
"/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FLOWLOGSV2DEMO/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/MULTITIERAPP2-NSG",

"operationName": "NetworkSecurityGroupFlowEvents",

"properties": {

"Version": 2,

"flows": [

{

"rule": "DefaultRule_DenyAllInBound",

"flows": [

{

"mac": "002248034CC3",

"flowTuples": [

"1533315685,80.211.83.37,10.1.1.6,45321,81,T,I,D,B,,,,"

]

}

]

},

{

"rule": "DefaultRule_AllowInternetOutBound",

"flows": [

{

"mac": "002248034CC3",

"flowTuples": [

"1533315655,10.1.1.6,204.79.197.200,62385,80,T,O,A,E,20,1244,87,123079",

"1533315657,10.1.1.6,204.79.197.200,62388,80,T,O,A,B,,,,",

"1533315658,10.1.1.6,204.79.197.200,62386,80,T,O,A,E,26,1568,92,123355",

"1533315662,10.1.1.6,204.79.197.200,62389,80,T,O,A,B,,,,",

"1533315664,10.1.1.6,204.79.197.200,62387,80,T,O,A,E,15,974,88,123133",

"1533315667,10.1.1.6,204.79.197.200,62390,80,T,O,A,B,,,,",

"1533315670,10.1.1.6,204.79.197.200,62388,80,T,O,A,E,18,1136,88,123139",

"1533315673,10.1.1.6,204.79.197.200,62391,80,T,O,A,B,,,,",

"1533315676,10.1.1.6,204.79.197.200,62389,80,T,O,A,E,14,920,87,123079",

"1533315678,10.1.1.6,204.79.197.200,62392,80,T,O,A,B,,,,",

"1533315679,10.1.1.6,204.79.197.200,62390,80,T,O,A,E,31,1838,94,123739",

"1533315684,10.1.1.6,204.79.197.200,62393,80,T,O,A,B,,,,",

"1533315685,10.1.1.6,204.79.197.200,62391,80,T,O,A,E,28,1676,101,141199",

"1533315689,10.1.1.6,204.79.197.200,62394,80,T,O,A,B,,,,",

"1533315691,10.1.1.6,204.79.197.200,62392,80,T,O,A,E,21,1298,93,123409",

"1533315694,10.1.1.6,204.79.197.200,62395,80,T,O,A,B,,,,",

"1533315697,10.1.1.6,204.79.197.200,62393,80,T,O,A,E,26,1568,91,123393",

"1533315700,10.1.1.6,204.79.197.200,62396,80,T,O,A,B,,,,",

"1533315703,10.1.1.6,204.79.197.200,62394,80,T,O,A,E,14,920,89,123187",

"1533315705,10.1.1.6,204.79.197.200,62397,80,T,O,A,B,,,,",

"1533315706,10.1.1.6,204.79.197.200,62395,80,T,O,A,E,13,866,87,123079",

"1533315711,10.1.1.6,204.79.197.200,62398,80,T,O,A,B,,,,"

]

}

]

}

]

}

}

]

}
```

## <a name="version-1-sample"></a>Пример версии 1

```json
{ 

    "records": [ 

        { 

            "time": "2017-02-16T22:00:32.8950000Z", 

            "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434", 

            "category": "NetworkSecurityGroupFlowEvent", 

            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG", 

            "operationName": "NetworkSecurityGroupFlowEvents", 

            "properties": { 

                "Version": 1, 

                "flows": [ 

                    { 

                        "rule": "DefaultRule_DenyAllInBound", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282421,42.119.146.95,10.1.0.4,51529,5358,T,I,D" 

                                ] 

                            } 

                        ] 

                    }, 

                    { 

                        "rule": "UserRule_default-allow-rdp", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282370,163.28.66.17,10.1.0.4,61771,3389,T,I,A", 

                                    "1487282393,5.39.218.34,10.1.0.4,58596,3389,T,I,A", 

                                    "1487282393,91.224.160.154,10.1.0.4,61540,3389,T,I,A", 

                                    "1487282423,13.76.89.229,10.1.0.4,53163,3389,T,I,A" 

                                ] 

                            } 

                        ] 

                    } 

                ] 

            } 

        }, 

        { 

            "time": "2017-02-16T22:01:32.8960000Z", 

            "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434", 

            "category": "NetworkSecurityGroupFlowEvent", 

            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG", 

            "operationName": "NetworkSecurityGroupFlowEvents", 

            "properties": { 

                "Version": 1, 

                "flows": [ 

                    { 

                        "rule": "DefaultRule_DenyAllInBound", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282481,195.78.210.194,10.1.0.4,53,1732,U,I,D" 

                                ] 

                            } 

                        ] 

                    }, 

                    { 

                        "rule": "UserRule_default-allow-rdp", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282435,61.129.251.68,10.1.0.4,57776,3389,T,I,A",

                                    "1487282454,84.25.174.170,10.1.0.4,59085,3389,T,I,A",

                                    "1487282477,77.68.9.50,10.1.0.4,65078,3389,T,I,A"

                                ] 

                            } 

                        ] 

                    } 

                ] 

            } 

        } 

    ] 
}
```