---
title: "Диагностика локального подключения через VPN-шлюз с помощью Наблюдателя за сетями Azure | Документация Майкрософт"
description: "В этой статье описывается диагностика локальных подключений через VPN-шлюз при помощи устранения неполадок ресурса Наблюдателя за сетями Azure."
services: network-watcher
documentationcenter: na
author: georgewallace
manager: timlt
editor: 
ms.assetid: aeffbf3d-fd19-4d61-831d-a7114f7534f9
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/22/2017
ms.author: gwallace
translationtype: Human Translation
ms.sourcegitcommit: cfe4957191ad5716f1086a1a332faf6a52406770
ms.openlocfilehash: c7576ce3e802e66ebea6ba83927609ed81fe0869
ms.lasthandoff: 03/09/2017

---

# <a name="diagnose-on-premise-connectivity-via-vpn-gateways"></a>Диагностика локальных подключений через VPN-шлюзы

VPN-шлюз Azure позволяет создать гибридное решение, устраняющее необходимость в безопасном подключении между локальной сетью и виртуальной сетью Azure. Ваши требования являются уникальными, как и выбираемое локальное VPN-устройство. В настоящее время Azure поддерживает [несколько VPN-устройств](../vpn-gateway/vpn-gateway-about-vpn-devices.md#a-namedevicetableavalidated-vpn-devices), которые постоянно проверяются совместно с поставщиками устройств. Просмотрите параметры конфигурации устройства перед началом настройки локального VPN-устройства. VPN-шлюз Azure настраивается с помощью набора [поддерживаемых параметров IPsec](../vpn-gateway/vpn-gateway-about-vpn-devices.md#IPSec), которые используются для установления подключений. В данный момент нет какого-либо способа указать или выбрать определенное сочетание параметров IPsec для VPN-шлюза Azure. Для успешного установления подключения между локальной средой и Azure параметры локального VPN-устройства должны соответствовать параметрам IPsec, предписанным VPN-шлюзом Azure. В противном случае подключение будет утрачено. На данный момент устранение этих неполадок является нетривиальным, и на выявление и устранение проблемы обычно требуется несколько часов.

С помощью функции устранения неполадок Наблюдателя за сетями Azure можно диагностировать проблемы шлюза и подключений и за несколько минут получить достаточно информации, чтобы принять обоснованное решение для устранения проблемы.

[!INCLUDE [network-watcher-preview](../../includes/network-watcher-public-preview-notice.md)]

## <a name="scenario"></a>Сценарий

Требуется настроить подключение типа "сеть — сеть" между Azure и локальной средой, используя Cisco ASA в качестве локального VPN-шлюза. Чтобы реализовать такой сценарий, потребуется следующее.

1. Шлюз виртуальной сети — VPN-шлюз в Azure.
1. Шлюз локальной сети — представление [локального VPN-шлюза (CISCO ASA)](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md#LocalNetworkGateway) в облаке Azure.
1. Подключение типа "сеть — сеть" (на основе политики) — [подключение между VPN-шлюзом и локальным устройством CISCO ASA](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md#a-namecreateconnectiona8-create-a-site-to-site-vpn-connection).
1. [Настройка CISCO ASA](https://github.com/Azure/Azure-vpn-config-samples/tree/master/Cisco/Current/ASA).

Подробное пошаговое руководство по настройке конфигурации "сеть — сеть" можно найти в статье [Создание виртуальной сети с подключением типа "сеть — сеть" с помощью портала Azure](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md). 

Один из важных этапов — настройка параметров связи IPsec. Любая ошибка в настройках приведет к потере подключения между локальной сетью и Azure. В настоящее время VPN-шлюзы Azure настроены для поддержки приведенных ниже параметров IPsec на этапе 1. Обратите внимание, что, как упоминалось ранее, эти параметры нельзя изменить.  Как можно видеть в таблице ниже, алгоритмы шифрования, поддерживаемые VPN-шлюзом Azure, это AES256, AES128 и 3DES.

### <a name="ike-phase-1-setup"></a>Этап 1 настройки протокола IKE

| **Свойство** | **PolicyBased** | **Стандартный или высокопроизводительный VPN-шлюз с маршрутизацией на основе маршрутов** |
| --- | --- | --- |
| Версия IKE |IKEv1 |IKEv2 |
| Группа Диффи — Хелмана |Группа 2 (1024 бита) |Группа 2 (1024 бита) |
| Метод проверки подлинности |Общий ключ |Общий ключ |
| Алгоритмы шифрования |AES256 AES128 3DES |AES256 3DES |
| Алгоритм хэширования |SHA1(SHA128) |SHA1(SHA128), SHA2(SHA256) |
| Время существования сопоставления безопасности первого этапа (время) |28&800; сек |10&800; секунд |
 
Как пользователю, вам потребуется настроить Cisco ASA. Пример конфигурации можно найти на сайте [GitHub](https://github.com/Azure/Azure-vpn-config-samples/blob/master/Cisco/Current/ASA/ASA_9.1_and_above_Show_running-config.txt). Помимо прочих настроек необходимо также указать алгоритм хэширования. Cisco ASA поддерживает больше [алгоритмов шифрования и хеширования](http://www.cisco.com/c/en/us/about/security-center/next-generation-cryptography.html), чем VPN-шлюз Azure. Невольно вы настроили Cisco ASA для использования SHA-512 в качестве алгоритма хэширования. Так как этот алгоритм не поддерживается для подключений на основе политик, VPN-подключение не будет работать.

Такие проблемы трудно устранять, а их первопричины часто неочевидны. В этом случае можно открыть запрос в службу поддержки, чтобы получить помощь в устранении данной проблемы. Но с помощью API устранения неполадок Наблюдателя за сетями Azure вы сможете выявлять эти проблемы самостоятельно. 

## <a name="troubleshooting-using-azure-network-watcher"></a>Устранение неполадок с помощью Наблюдателя за сетями Azure

Чтобы диагностировать подключение, подключитесь к Azure PowerShell и выполните командлет `Start-AzureRmNetworkWatcherResourceTroubleshooting`. Дополнительные сведения об использовании этого командлета см. в статье [Устранение неполадок шлюза виртуальной сети и подключений с помощью Наблюдателя за сетями Azure и PowerShell](network-watcher-troubleshoot-manage-powershell.md). Для завершения командлетом этой операции может потребоваться несколько минут. 

После выполнения командлета можно перейти к расположению хранения, указанному в командлете, чтобы получить подробную информацию о проблеме и просмотреть журналы. Наблюдатель за сетями Azure создает ZIP-папку, которая содержит приведенные ниже файлы.

![1][1]

Откройте файл IKEErrors.txt, и вы увидите приведенную ниже ошибку, что указывает на проблему из-за неправильной настройки параметров локального протокола IKE. 

```
Error: On-premises device rejected Quick Mode settings. Check values. 
     based on log : Peer sent NO_PROPOSAL_CHOSEN notify
```

Подробные сведения об ошибке можно получить из Scrubbed-wfpdiag.txt. В этом случае сообщается о наличии ошибки `ERROR_IPSEC_IKE_POLICY_MATCH`, которая привела к тому, что подключение не работает должным образом.

Еще одной распространенной ошибкой при настройке является неправильное указание общих ключей. Если в предыдущем примере вы указали разные общие ключи, то файл IKEErrors.txt будет содержать следующую ошибку: `Error: Authentication failed. Check shared key`.

Функция устранения неполадок Наблюдателя за сетями Azure позволяет диагностировать и устранить неполадки VPN-шлюза и подключений так же легко, как выполнить простой командлет PowerShell. В настоящее время поддерживается диагностика приведенных ниже условий. Кроме того, мы работаем над добавлением дополнительных условий. 

### <a name="gateway"></a>Шлюз

| Тип ошибки | Причина | Журнал|
|---|---|---|
| NoFault | Ошибка не обнаружена. |Да|
| GatewayNotFound | Не удается найти шлюз или шлюз не подготовлен. |Нет|
| PlannedMaintenance |  Выполняется обслуживание экземпляра шлюза.  |Нет|
| UserDrivenUpdate | Идет обновление, инициированное пользователем. Это может быть операция изменения размера. | Нет |
| VipUnResponsive | Не удается связаться с первичным экземпляром шлюза. Это происходит при сбое пробы работоспособности. | Нет |
| PlatformInActive | Существует проблема с платформой. | Нет|
| ServiceNotRunning | Базовая служба не выполняется. | Нет|
| NoConnectionsFoundForGateway | У шлюза нет подключений. Это всего лишь предупреждение.| Нет|
| ConnectionsNotConnected | Ни одно из подключений не установлено. Это всего лишь предупреждение.| Да|
| GatewayCPUUsageExceeded | Текущее использование ЦП шлюза превышает 95 %. | Да |

### <a name="connection"></a>Подключение

| Тип ошибки | Причина | Журнал|
|---|---|---|
| NoFault | Ошибка не обнаружена. |Да|
| GatewayNotFound | Не удается найти шлюз или шлюз не подготовлен. |Нет|
| PlannedMaintenance | Выполняется обслуживание экземпляра шлюза.  |Нет|
| UserDrivenUpdate | Идет обновление, инициированное пользователем. Это может быть операция изменения размера.  | Нет |
| VipUnResponsive | Не удается связаться с первичным экземпляром шлюза. Это происходит при сбое пробы работоспособности. | Нет |
| ConnectionEntityNotFound | Отсутствует конфигурация подключения. | Нет |
| ConnectionIsMarkedDisconnected | Подключение отмечено как "разъединенное". |Нет|
| ConnectionNotConfiguredOnGateway | Для базовой службы не настроено подключение. | Да |
| ConnectionMarkedStandy | Базовая служба помечена как ждущая.| Да|
| Аутентификация | Несоответствие предварительного ключа. | Да|
| PeerReachability | Одноранговый шлюз недоступен. | Да|
| IkePolicyMismatch | У однорангового шлюза имеются политики IKE, которые не поддерживаются в Azure. | Да|
| WfpParse Error | Ошибка при анализе журнала WFP. |Да|

## <a name="next-steps"></a>Дальнейшие действия

Научитесь проверять подключения VPN-шлюза с помощью PowerShell и службы автоматизации Azure, ознакомившись с разделом [Мониторинг VPN-шлюзов с помощью средства устранения неполадок наблюдателя за сетями Azure](network-watcher-monitor-with-azure-automation.md).

[1]: ./media/network-watcher-diagnose-on-premises-connectivity/figure1.png

