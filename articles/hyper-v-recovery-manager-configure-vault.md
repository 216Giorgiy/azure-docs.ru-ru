<properties 
	pageTitle="Учебник. Настройка защиты между локальными сайтами VMM" 
	description="Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин Hyper-V между локальными сайтами VMM." 
	services="site-recovery" 
	documentationCenter="" 
	authors="raynew" 
	manager="jwhit" 
	editor="tysonn"/>

<tags 
	ms.service="site-recovery" 
	ms.workload="backup-recovery" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="02/18/2015" 
	ms.author="raynew"/>


# Приступая к работе с Azure Site Recovery:  Восстановление из локальной сети в локальную сеть для защиты узла VMM с репликацией Hyper-V


<div class="dev-callout"> 

<p>Azure Site Recovery (служба восстановления сайтов) помогает реализовать стратегии непрерывности бизнеса и рабочей нагрузки, управляя процессами репликации, отработки отказа и восстановления виртуальных машин в ряде сценариев развертывания.<p>

<P>Этот учебник содержит инструкции по развертыванию Azure Site Recovery для организации и автоматизации защиты рабочей нагрузки, выполняемой между двумя локальными узлами VMM, с помощью репликации Hyper-V.  По возможности в учебнике используются самый быстрый путь развертывания и параметры по умолчанию.</P>

<UL>
<LI>Подробные инструкции по полному развертыванию см. в руководствах <a href="http://go.microsoft.com/fwlink/?LinkId=321294">Планирование</a> и <a href="http://go.microsoft.com/fwlink/?LinkId=321295">Развертывание</a> .</LI>
<LI>Подробные сведения о дополнительных сценариях развертывания Azure Site Recovery содержатся в <a href="http://go.microsoft.com/fwlink/?LinkId=518690">Обзоре Azure Site Recovery</a>.</LI>
<LI>При возникновении проблем с данным учебником см. вики-статью <a href="http://go.microsoft.com/fwlink/?LinkId=389879">Azure Site Recovery: распространенные ошибки и способы их устранения</a>или задайте вопросы на <a href="http://go.microsoft.com/fwlink/?LinkId=313628">форуме по службам восстановления Azure</a>.</LI>
</UL>

</div>


<h2><a id="before"></a>Предварительные требования</h2> 
<div class="dev-callout"> 
<P>Прежде чем приступить к работе с учебником, убедитесь в выполнении всех предварительных требований.</P>

<UL>
<LI><b>Учетная запись Azure.</b> Потребуется учетная запись Azure. Если ее нет, см. раздел <a href="http://aka.ms/try-azure">Бесплатное пробное использование Azure</a>. Информацию о ценах на подписку можно получить в разделе <a href="http://go.microsoft.com/fwlink/?LinkId=378268">Расценки на диспетчер службы восстановления сайтов Azure</a>.</LI>
<LI><b>Сервер VMM.</b> Понадобится как минимум один сервер VMM, работающий под управлением System Center 2012 с пакетом обновления 1 (SP1) или System Center 2012 R2.</LI>
<LI><b>Облака VMM.</b> Требуется как минимум одно облако на исходном сервере VMM, который вы хотите защитить, и одно на конечном сервере VMM. Если вы используете один сервер VMM, для него необходимо настроить два облака. Основное облако, которые вы хотите защитить, должно содержать следующее:<UL>
	<LI>Одна или несколько групп узлов VMM</LI>
	<LI>Один или несколько серверов или кластеров узлов Hyper-V в каждой группе узлов.</LI>
	<li>Одна или несколько виртуальных машин, расположенных на исходном сервере Hyper-V в облаке.</li>
		</UL></LI>
<LI>**Сети**. При необходимости можно настроить сопоставление сети, чтобы оптимально разместить реплики виртуальных машин на серверах узла Hyper-V после отработки отказа и обеспечить их подключение к соответствующим сетям виртуальных машин. При включении сетевого сопоставления виртуальная машина из основного расположения будет подключена к сети, а ее реплика из целевого расположения будет подключена к сопоставленной ей сети. Если не настроить сетевое сопоставление, то виртуальные машины не будут подключаться к сетям виртуальных машин после отработки отказа. Это руководство содержит пошаговую демонстрацию настроек и не включает сопоставление сетей, о котором можно прочитать подробнее в разделах:</LI>
	<UL>
	<LI><a href="http://go.microsoft.com/fwlink/?LinkId=522289">Сетевое сопоставление</a> в руководстве по планированию.</LI>
	<LI><a href="http://go.microsoft.com/fwlink/?LinkId=522293">Включение сетевого сопоставления</a> руководства по развертыванию.</LI>
	</UL></LI>

</UL>



<h2><a id="tutorial"></a>Пошаговые указания</h2> 

После проверки необходимых условий выполните следующие действия:
<UL>
<LI><a href="#vault">Шаг 1. Создание хранилища</a>- Создайте хранилище Azure Site Recovery.</LI>
<LI><a href="#download">Шаг 2. Установка приложения поставщика на каждом сервере VMM</a>- Создайте регистрационный ключ хранилища и скачайте установочный файл поставщика. Запустите программу установки на каждом сервере VMM, чтобы установить поставщик и зарегистрировать сервер VMM в хранилище.</LI>
<LI><a href="#clouds">Шаг 3. Настройка защиты облака</a>- Настройте параметры защиты для облаков VMM. Эти параметры защиты применяются ко всем виртуальным машинам в облаке, которые можно включить для защиты Azure Site Recovery.</LI>
<LI><a href="#storagemapping">Шаг 4. настройка сопоставления хранилищ</a>- Если требуется указать, где хранятся данные репликации, можно настроить сопоставление хранилищ. Этот параметр сопоставляет классификации хранилищ на исходном сервере VMM с классификациями хранилищ на целевом сервере.</LI>
<LI><a href="#enablevirtual">Шаг 5. Включение защиты для виртуальных машин</a>- Включите защиту виртуальных машин, расположенных в защищенных облаках VMM.</LI>
<LI><a href="#recovery plans">Шаг 6. Настройка и запуск планов восстановления</a>- Создайте план восстановления и выполните тестовую отработку отказа, чтобы убедиться в выполнении плана.</LI>

</UL>




<a name="vault"></a> <h2>Шаг 1. Создание хранилища</h2>

1. Выполните вход на [портал управления](https://manage.windowsazure.com).


2. Разверните <b>Службы данных</b>, затем <b>Службы восстановления</b>и нажмите <b>Хранилище Site Recovery</b>.


3. Нажмите кнопку <b>Создать</b> , а затем - <b>Быстрое создание</b>.
	
4. В поле <b>Имя</b>введите понятное имя для идентификации хранилища.

5. В поле <b>Регион</b>выберите географический регион для хранилища. Для проверки поддерживаемых регионов см. подраздел "География доступных регионов" раздела <a href="http://go.microsoft.com/fwlink/?LinkId=389880">Расценки на службу восстановления сайтов Azure</a>

6. Щелкните <b>Создать хранилище</b>. 

	![New Vault](./media/hyper-v-recovery-manager-configure-vault/SR_HvVault.png)

<P>Проверьте строку состояния, чтобы убедиться, что хранилище успешно создано. Хранилище будет указано с состоянием <b>Активно</b> на главной странице служб восстановления.</P>

<a name="upload"></a> <h2>Шаг 2. Настройка хранилища</h2>


1. В диалоговом окне <b>Службы восстановления</b> щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Quick Start Icon](./media/hyper-v-recovery-manager-configure-vault/SR_QuickStartIcon.png)

2. В раскрывающемся списке выберите **Между двумя локальными узлами Hyper-V**.
3. В разделе **Подготовка серверов VMM** выберите пункт **Создать регистрационный ключ**. Ключ действителен в течение пяти дней после создания. Скопируйте файл на сервер VMM. Он вам потребуется при настройке поставщика.

	![Registration key](./media/hyper-v-recovery-manager-configure-vault/SR_E2ERegisterKey.png)
	



<a name="download"></a> <h2>Шаг 3. Установка поставщика Azure Site Recovery</h2>
	

1. На странице <b>Быстрый запуск</b> раздела **Подготовка серверов VMM** щелкните <b>Загрузить поставщик Microsoft Azure Site Recovery для установки на серверах VMM</b> , чтобы получить последнюю версию установочного файла поставщика.

2. Запустите этот файл на исходном и целевом серверах VMM.

3. В разделе **Проверка предварительных требований** выберите остановку службы VMM, чтобы начать установку приложения поставщика. Служба остановится и будет перезапущена автоматически после завершения установки. 

	![Prerequisites](./media/hyper-v-recovery-manager-configure-vault/SR_ProviderPrereq.png)

4. Обновления можно настроить в **Центре обновления Майкрософт**. Если этот параметр включен, то обновления поставщика будут устанавливаться в соответствии с вашей политикой Центра обновления Майкрософт.

	![Microsoft Updates](./media/hyper-v-recovery-manager-configure-vault/SR_ProviderUpdate.png)

После установки приложения поставщика продолжите установку, чтобы зарегистрировать сервер в хранилище.

5. На странице "Подключение к Интернету" укажите, как запущенный на сервере VMM поставщик подключается к Интернету. <b>Использовать параметры прокси-сервера по умолчанию</b> , чтобы использовать настроенные на сервере параметры подключения к Интернету по умолчанию.

	![Internet Settings](./media/hyper-v-recovery-manager-configure-vault/SR_ProviderProxy.png)

6. В поле **Регистрационный ключ** укажите, что вы скачали его с Azure Site Recovery и скопировали на сервер VMM.
7. В поле **Имя хранилища** проверьте имя хранилища, в котором будет зарегистрирован сервер.
8. В поле **Имя сервера** укажите понятное имя, описывающее сервер VMM в хранилище.

	![Server registration](./media/hyper-v-recovery-manager-configure-vault/SR_ProviderRegKeyServerName.png)


9. В поле синхронизации **Первоначальные метаданные в облаке** укажите, нужно ли синхронизировать метаданные для всех облаков сервера VMM в хранилище. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM.


7. В поле **Шифрование данных** создайте сертификат для шифрования данных, защищенных в Azure. 
Этот параметр не важен для плана действий, описанного в данном руководстве.

	![Server registration](./media/hyper-v-recovery-manager-configure-vault/SR_ProviderSyncEncrypt.png)

8. Нажмите кнопку <b>Зарегистрировать</b> для завершения процесса. После регистрации метаданные с сервера VMM извлекаются службой Azure Site Recovery. Сервер отображается на вкладке <b>Ресурсы</b> страницы **Серверы** в хранилище.




<h2><a id="clouds"></a>Шаг 4. настройка параметров защиты облаков</h2>

После регистрации серверов VMM можно настроить параметры защиты облачных систем. Параметр **Синхронизировать облачные данные с хранилищем** был включен при установке поставщика, поэтому все облака на сервере VMM появятся на вкладке <b>Защищенные элементы</b> в хранилище.

![Published Cloud](./media/hyper-v-recovery-manager-configure-vault/SR_CloudsList.png)

1. На странице быстрого запуска щелкните **Настроить защиту для облаков VMM**.
2. На вкладке **Защищенные элементы** выберите облако, которое нужно настроить, и перейдите на вкладку **Конфигурация**. Обратите внимание на следующее:
3. В разделе <b>Цель</b>выберите <b>VMM</b>.
4. В поле <b>Целевое расположение</b>выберите локальный сервер VMM, управляющий облаком, которое требуется использовать для восстановления.
4. В элементе <b>Целевое облако</b>укажите целевое облако, которое требуется использовать для отработки отказа виртуальных машин в исходном облаке. Обратите внимание на следующее:
	- Рекомендуется выбрать целевое облако, удовлетворяющее требованиям к восстановлению для виртуальных машин, которые планируется защитить.
	- Облако может относиться только к одной паре облаков - в качестве основного или целевого.

6. В поле <b>Периодичность копирования</b> оставьте значение по умолчанию. Это значение указывает, как часто следует синхронизировать данные между исходным и конечным расположениями. Оно применяется только при работе узла Hyper-V в Windows Server 2012 R2. Для других серверов используется значение по умолчанию, равное 5 минутам.
7. В поле <b>Дополнительные точки восстановления</b>оставьте значение по умолчанию. Это значение указывает, следует ли создавать дополнительные точки восстановления. При использовании нулевого значения по умолчанию на сервере узла реплики хранится только последняя точка восстановления для основной виртуальной машины.
8. В поле <b>Периодичность создания соответствующих приложению моментальных снимков</b>оставьте значение по умолчанию. Это значение указывает, как часто создаются моментальные снимки. Снимки используют службу теневого копирования томов (VSS), чтобы обеспечить согласованное состояние приложение при создании моментального снимка.  Если вы хотите задать это значение при работе с учебником, убедитесь, что оно меньше количества заданных дополнительных точек восстановления.
	![Configure protection settings](./media/hyper-v-recovery-manager-configure-vault/SR_CloudSettingsE2E.png)
9. В поле <b>Сжатие данных при передаче</b>укажите, требуется ли сжимать передаваемые реплицированные данные. 
10. В поле <b>Проверка подлинности</b>укажите, как осуществляется проверка подлинности трафика между серверами основного узла и узла восстановления Hyper-V. При прохождении данного учебника рекомендуется выбрать протокол HTTPS, если у вас не настроена рабочая среда Kerberos. Azure Site Recovery автоматически настроит сертификаты для аутентификации HTTPS. Никакой дополнительной настройки не требуется. Обратите внимание, что этот параметр используется только при запуске серверов узлов Hyper-V в Windows Server 2012 R2.
11. В поле <b>Порт</b>оставьте значение по умолчанию. Это значение задает номер порта, через который исходный и конечный компьютеры узла Hyper-V прослушивают трафик репликации.
12. В поле <b>Метод репликации</b>укажите, как будет осуществляться начальная репликация данных из исходного расположения в целевое перед началом обычной репликации. 
	- <b>По сети</b>- копирование данных через сеть может требовать много времени и ресурсов. Рекомендуется использовать этот параметр, если облако содержит виртуальные машины с относительно небольшими виртуальными жесткими дисками, а основной сервер VMM подключен к дополнительному серверу VMM через широкополосное соединение. Можно немедленно начать копирование или выбрать соответствующее время. При использовании репликации по сети рекомендуется запланировать ее на часы наименьшей нагрузки.
	- <b>Автономно</b>- этот метод указывает, что начальная репликация будет выполняться с помощью внешнего носителя. Это удобно, если требуется избежать снижения производительности сети, а также для местоположений, находящихся на большом расстоянии друг от друга. Для использования этого метода необходимо указать расположение экспорта в исходном облаке и расположение импорта в целевом облаке. При включении защиты для виртуальной машины виртуальный жесткий диск копируется в указанное расположение экспорта. Вы отправляете его на целевой сайт и копируете в расположение импорта. Система копирует импортированные сведения на виртуальные машины реплики. Полный список необходимых условий репликации в автономном режиме см. в разделе <a href="http://go.microsoft.com/fwlink/?LinkId=323469">Шаг 3. Настройка параметров защиты для облаков VMM</a> руководства по развертыванию.
13. Выберите **Удалить виртуальную машину реплики** чтобы указать, что виртуальная машина реплики должна быть удалена, если защита виртуальной машины прекращена в результате выбора параметра **Удалить защиту виртуальной машины** на вкладке "Виртуальные машины" в свойствах облака. Когда этот параметр включен, то при отключении защиты виртуальная машина удаляется из Azure Site Recovery, параметры Site Recovery для виртуальной машины удаляются из консоли VMM, также удаляется реплика.
	![Configure protection settings](./media/hyper-v-recovery-manager-configure-vault/SR_CloudSettingsE2ERep.png)

<p>После сохранения параметров создается задание, которое можно отслеживать на вкладке <b>Задания</b> . Все сервера узлов Hyper-V в исходном облаке VMM могут быть настроены для репликации. Параметры облака можно изменить на вкладке <b>Настройка</b> . Чтобы изменить целевое расположение или целевое облако после сохранения конфигурации, необходимо удалить эту конфигурацию облака и затем повторно настроить облако.</p>

<h2><a id="storagemapping"></a>Шаг 5. настройка сопоставления хранилищ</h2>

<p>Этот учебник описывает самый простой путь развертывания Azure Site Recovery в тестовой среде. При желании настроить сетевое сопоставление в рамках этого руководства следуйте инструкциям в разделе <a href="http://go.microsoft.com/fwlink/?LinkId=402535">Настройка сопоставления хранилищ</a> руководства по развертыванию.</p>


<h2><a id="enablevirtual"></a>Шаг 6. Включение защиты виртуальной машины</h2>
<p>После успешной настройки серверов, облаков и сетей можно включить защиту для виртуальных машин в облаке.</p>
<OL>
<li>На вкладке <b>Виртуальные машины</b> облака, в котором расположена виртуальная машина, щелкните <b>Включить защиту</b> и выберите <b>Добавить виртуальные машины</b>. </li>
<li>Из списка виртуальных машин в облаке выберите те, которые хотите защитить.</li> 
</OL>

![Enable virtual machine protection](./media/hyper-v-recovery-manager-configure-vault/SR_EnableProtectionVM.png)


<P>За ходом выполнения действия "Включение защиты", в том числе и за первоначальной репликацией, можно наблюдать на вкладке **Задания**. После запуска задачи финализации защиты виртуальная машина готова к отработке отказа. После включения защиты и репликации виртуальных машин вы сможете просматривать их в Azure.</p>



![Virtual machine protection job](./media/hyper-v-recovery-manager-configure-vault/SR_VMJobs.png)


<h2><a id="recoveryplans"></a>Шаг 7. Тестирование развертывания</h2>

Проведите тестирование развертывания, чтобы убедиться, что аварийный переход виртуальных машин и данных на другой ресурс происходит должным образом. Для этого требуется создать план восстановления, выбрав группы репликации. Затем нужно запустить тестовую отработку отказа для плана.

1. На вкладке **Планы восстановления** выберите **Создать план восстановления**.
2. Укажите имя плана восстановления, а также исходный и целевой серверы VMM. Исходный сервер должен содержать виртуальные машины, активированные для отработки отказа и восстановления. Выберите **Hyper-V** для просмотра только тех облаков, которые настроены для репликации Hyper-V.

	![Create recovery plan](./media/hyper-v-recovery-manager-configure-vault/SRE2E_RP1.png)

3. В разделе **Выбор виртуальной машины** выберите группы репликации. Все виртуальные машины, связанные с группой репликации, будут выбраны и добавлены в план восстановления. Эти виртуальные машины добавляются в группу плана восстановления по умолчанию - группу 1. При необходимости можно внести дополнительные группы. Обратите внимание, что после репликации виртуальные машины запустятся в соответствии с порядком групп плана восстановления.

	![Add virtual machines](./media/hyper-v-recovery-manager-configure-vault/SRE2E_RP2.png)	

4. Плана восстановления отобразится в списке на вкладке **Планы восстановления** после того, как будет создан. 
5. На вкладке **Планы восстановления** выберите план и щелкните **Тестовая отработка отказа**.
6. На странице **Подтверждение тестовой отработки отказа** выберите **Нет**. Обратите внимание, что реплики виртуальных машин, перешедших на другой ресурс, не будут подключены к какой-либо сети, если этот параметр включен. В данном случае проверяется, происходит ли аварийный переход виртуальной машины на другой ресурс, но не проверяется сетевая среда репликации. Если требуется выполнить более полное тестирование отработки отказа, см. раздел <a href="http://go.microsoft.com/fwlink/?LinkId=522291">Тестирование локального развертывания на сайте MSDN</a>.

	![Select test network](./media/hyper-v-recovery-manager-configure-vault/SRSAN_TestFailover1.png)


7. Тестовая виртуальная машина будет создана на том же узле, что и реплика виртуальной машины. Она не добавляется в облако, в котором находится реплика виртуальной машины.
8. Когда репликация завершена, реплика виртуальной машины получит IP-адрес, отличный от IP-адреса основной виртуальной машины. Если адреса выдаются из DHCP-сервера, то DNS будет обновляться автоматически. Если DHCP не используется и нужно убедиться, что адреса совпадают, необходимо запустить несколько скриптов.
9. Запустите пример скрипта для получения IP-адреса.
    **$vm = Get-SCVirtualMachine -Name <VM_NAME>
	$na = $vm[0].VirtualNetworkAdapters>
	$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
	$ip.address**  
11. Запустите пример скрипта для обновления DNS, указав IP-адрес, полученный с помощью предыдущего примера скрипта.

	**[string]$Zone,
	[string]$name,
	[string]$IP
	)
	$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
	$newrecord = $record.clone()
	$newrecord.RecordData[0].IPv4Address  =  $IP
	Set-DnsServerResourceRecord -zonename com -OldInputObject $record -NewInputObject $Newrecord**


<h3><a id="runtest"></a>Мониторинг активности</h3>
<p>Можно использовать <b>вкладку Задания</b> и <b>Панель мониторинга</b> , чтобы просматривать и отслеживать выполнение основных заданий в хранилище Azure Site Recovery, в том числе настройку защиты для облака, включение и отключение защиты для виртуальной машины, выполнение отработки отказа (запланированной, незапланированной или тестовой) и фиксирование незапланированной отработки отказа.</p>

<p>На вкладке <b>Задания</b> можно просматривать задания, их подробности и ошибки, запускать запросы извлечения заданий, отвечающих конкретным критериям, экспортировать задания в Excel и перезапускать неудавшиеся задания.</p>

<p>Из <b>Панели мониторинга</b> можно скачивать последние версии установочных файлов поставщика и агента, получать информацию о конфигурации хранилища, просматривать количество виртуальных машин, защитой которых управляет хранилище, просматривать последние задания, управлять сертификатом хранилища и проводить повторную синхронизацию виртуальных машин.</p>

<p>Дополнительные сведения о взаимодействии с заданиями и панелью мониторинга см. в <a href="http://go.microsoft.com/fwlink/?LinkId=398534">Руководстве по эксплуатации и мониторингу</a>.</p>
	
<h2><a id="next"></a>Дальнейшие действия</h2>
<UL>
<LI>Сведения о планировании и развертывании Azure Site Recovery в полной производственной среде см. в <a href="http://go.microsoft.com/fwlink/?LinkId=321294">руководстве по планированию для Azure Site Recovery</a> и <a href="http://go.microsoft.com/fwlink/?LinkId=321295">руководстве по развертыванию для Azure Site Recovery</a>.</LI>
<LI>При наличии вопросов обращайтесь на <a href="http://go.microsoft.com/fwlink/?LinkId=313628">форум по службам восстановления Azure</a>.</LI> 
</UL>

<!--HONumber=35.2-->

<!--HONumber=46--> 
