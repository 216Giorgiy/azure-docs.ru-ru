<properties pageTitle="How to implement disaster recovery using service backup and restore in Azure API Management" metaKeywords="" description="Learn how to use backup and restore to perform disaster recovery in Azure API Management." metaCanonical="" services="api-management" documentationCenter="API Management" title="How to implement disaster recovery using service backup and restore in Azure API Management" authors="sdanie" solutions="" manager="" editor="" />

<tags ms.service="api-management" ms.workload="mobile" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="sdanie" />

# Реализация аварийного восстановления с помощью функций резервного копирования и восстановления службы в Azure API Management
Выбрав службу Azure API Management для публикации интерфейсов API и управления ими, вы получаете множество возможностей по обеспечению отказоустойчивости и организации инфраструктуры, которые в противном случае вам пришлось бы проектировать и внедрять самостоятельно. Платформа Azure устраняет большую часть потенциальных сбоев при относительно небольших затратах.

Чтобы обеспечить восстановление в случае проблем с доступностью в регионе, в котором размещена ваша служба API Management, необходимо быть готовым к ее воссозданию в другом регионе в любой момент. В зависимости от целевых показателей доступности и времени восстановления вам, возможно, потребуется создать резервную службу в одном или нескольких регионах, а затем наладить постоянную синхронизацию ее конфигурации и содержимого с активной службой. Функция резервного копирования и восстановления службы служит необходимым фундаментом для реализации стратегии аварийного восстановления.

Функция резервного копирования и восстановления службы доступна через API REST управления службами. Инструкции по получению доступа к API см. в разделе [Проверка подлинности запросов к диспетчеру ресурсов Azure][Проверка подлинности запросов к диспетчеру ресурсов Azure].

## Содержание раздела

- [Резервное копирование службы API Management][Резервное копирование службы API Management]
- [Восстановление службы API Management][Восстановление службы API Management]

## <a name="step1"></a> Резервное копирование службы API Management
Чтобы выполнить резервное копирование службы API Management, отправьте следующий HTTP-запрос:

`POST https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/backup?api-version={api-version}`

где:

* `subscriptionId` — идентификатор подписки, включающей в себя службу API Management, резервное копирование которой вы пытаетесь выполнить;
* `resourceGroupName` — строка в формате "Api-Default-{service-region}", где `service-region` — это регион Azure, в котором размещена служба API Management, подлежащая резервному копированию (например, `North-Central-US`);
* `serviceName` — имя службы API Management, резервное копирование которой вы выполняете, на момент ее создания;
* `api-version` — замените на `2014-02-14`.

В теле запроса укажите целевую учетную запись хранения Azure, ключ доступа, имя контейнера BLOB-объектов и имя резервной копии:

	'{  
	    storageAccount : "{storage account for the backup}",  
	    accessKey : "{access key for the account}",  
	    containerName : "{backup container name}",  
	    backupName : "{backup blob name}"  
	}'

Для заголовка запроса `Content-Type` установите значение `application\json`.

Резервное копирование — это длительная операция, которая может занять много минут. Если запрос выполнен успешно и процесс резервного копирования инициирован, вы получите код состояния ответа `202 Accepted` с заголовком `Location`. Чтобы отслеживать состояние операции, отправляйте запросы GET на URL-адрес, указанный в заголовке `Location`. Пока резервное копирование выполняется, вы будете получать код состояния "202 Accepted". Код ответа `200 OK` указывает на то, что резервное копирование успешно завершено.

**Примечание**.

- **Контейнер**, указанный в теле запроса, **должен существовать**.
- Пока выполняется резервное копирование, **не предпринимайте никаких действий по управлению службой**, таких как повышение или понижение уровня, смена доменного имени и т. д.
- Восстановление **резервной копии гарантируется только в течение 7 дней** с момента ее создания.
- **Данные об использовании**, применяемые при создании аналитических отчетов, **не включаются** в резервную копию. Для периодического извлечения аналитических отчетов с целью их дальнейшего помещения на хранение используйте [API REST Azure API Management][API REST Azure API Management].
- Частота резервного копирования службы влияет на цель точки восстановления. Чтобы максимально снизить этот показатель, мы советуем настроить регулярное резервное копирование, а также выполнять резервное копирование по требованию после внесения важных изменений в службу API Management.
- **Изменения**, внесенные в конфигурацию службы (например, интерфейсы API, политики, внешний вид портала разработчика) во время резервного копирования, **могут не быть включены в резервную копию. В этом случае они будут утеряны**.

## <a name="step2"></a> Восстановление службы API Management
Чтобы восстановить службу API Management из ранее созданной резервной копии, отправьте следующий HTTP-запрос:

`POST https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/restore?api-version={api-version}`

где:

- `subscriptionId` — идентификатор подписки, включающей в себя службу API Management, которую нужно восстановить из резервной копии;
- `resourceGroupName` — строка в формате "Api-Default-{service-region}", где `service-region` — это регион Azure, в котором размещена восстанавливаемая из резервной копии служба API Management (например, `North-Central-US`);
- `serviceName` — имя восстанавливаемой службы API Management на момент ее создания;
- `api-version` — замените на `2014-02-14`.

В теле запроса укажите расположение файла резервной копии, т. е. учетную запись хранения Azure, ключ доступа, имя контейнера BLOB-объектов и имя резервной копии:

	'{  
	    storageAccount : "{storage account for the backup}",  
	    accessKey : "{access key for the account}",  
	    containerName : "{backup container name}",  
	    backupName : "{backup blob name}"  
	}'

Для заголовка запроса `Content-Type` установите значение `application\json`.

Восстановление — это длительная операция, которая может занять до 30 минут и более. Если запрос выполнен успешно и процесс восстановления инициирован, вы получите код состояния ответа `202 Accepted` с заголовком `Location`. Чтобы отслеживать состояние операции, отправляйте запросы GET на URL-адрес, указанный в заголовке `Location`. Пока восстановление выполняется, вы будете получать код состояния "202 Accepted". Код ответа `200 OK` указывает на то, что восстановление успешно завершено.

**Примечание**.

- **Уровень** восстанавливаемой службы **должен соответствовать** уровню службы в резервной копии.
- **Изменения**, внесенные в конфигурацию службы (например, интерфейсы API, политики, внешний вид портала разработчика) во время восстановления, **могут быть перезаписаны**.

[Проверка подлинности запросов к диспетчеру ресурсов Azure]: http://msdn.microsoft.com/ru-ru/library/dn790557.aspx
[Резервное копирование службы API Management]: #step1
[Восстановление службы API Management]: #step2
[API REST Azure API Management]: http://msdn.microsoft.com/ru-ru/library/azure/dn781421.aspx
