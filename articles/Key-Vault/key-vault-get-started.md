<properties 
	pageTitle="Приступая к работе с хранилищем ключей Azure | Обзор" 
	description="Этот учебник поможет вам начать работу с хранилищем ключей Azure. В нем содержится информация о создании зафиксированного контейнера (хранилища), хранении криптографических ключей и секретов, а также об управлении ими в Azure." 
	services="key-vault" 
	documentationCenter="" 
	authors="cabailey" 
	manager="mbaldwin"/>

<tags 
	ms.service="key-vault" 
	ms.workload="identity" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="05/04/2015" 
	ms.author="cabailey"/>

# Приступая к работе с хранилищем ключей Azure #

## Введение  
Этот учебник поможет вам начать работу с хранилищем ключей Azure, которое в настоящее время доступно в предварительной версии. В нем содержится информация о создании зафиксированного контейнера (хранилища), хранении криптографических ключей и секретов, а также об управлении ими в Azure. Он представляет собой пошаговое руководство по использованию Windows PowerShell для создания хранилища, содержащего ключ или пароль, который вы сможете использовать с приложением Azure. В нем также показано, как приложение может использовать этот ключ или пароль в дальнейшем.

**Предполагаемое время выполнения:** 20 минут

>[AZURE.NOTE]В этом учебнике нет указаний по написанию приложения Azure, что предусматривает один из шагов, но показано, как авторизовать приложение для использования ключей или секретов в хранилище ключей.
>
>В период действия предварительной версии нельзя настроить хранилище ключей Azure на портале Azure. Вместо этого используйте эти указания по работе с Azure PowerShell.

Общую информацию о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](key-vault-whatis.md)

## Предварительные требования 

Для работы с этим учебником требуется:

- подписка на Microsoft Azure. Если у вас нет подписки, вы можете зарегистрироваться для использования [бесплатной пробной версии](../../../pricing/free-trial);
- Azure PowerShell версии 0.9.1 или более поздней. Чтобы установить последнюю версию и связать ее со своей подпиской Azure, см. статью [Как установить и настроить Azure PowerShell](../powershell-install-configure.md);
- приложение, для которого вы будете настраивать использование ключа или пароля, созданного по этому учебнику. Пример приложения доступен в [Центре загрузки Майкрософт](http://www.microsoft.com/ru-ru/download/details.aspx?id=45343). Указания см. в сопутствующем файле Readme.


Этот учебник предназначен для начинающих пользователей Windows PowerShell, но предполагается, что вы знакомы с основными понятиями, такими как модули, командлеты и сеансы. Дополнительные сведения о Windows PowerShell см. в разделе [Начало работы с Windows PowerShell](https://technet.microsoft.com/library/hh857337.aspx).

Чтобы получить подробную справку для любого командлета, встречающегося в этом учебнике, используйте командлет Get-Help.

	Get-Help <cmdlet-name> -Detailed

Например, чтобы получить справку для командлета Add-AzureAccount, введите:

	Get-Help Add-AzureAccount -Detailed

Чтобы ознакомиться с диспетчером ресурсов Azure в Windows PowerShell, можно также прочитать следующие учебники:

- [Как установить и настроить Azure PowerShell](../powershell-install-configure.md)
- [Использование Windows PowerShell с диспетчером ресурсов](../powershell-azure-resource-manager.md)


## <a id="connect"></a>Подключение к подпискам ##

Запустите сеанс Azure PowerShell и войдите в учетную запись Azure, используя следующую команду:

    Add-AzureAccount

Во всплывающем окне браузера введите имя пользователя и пароль учетной записи Azure. Windows PowerShell получит все подписки, связанные с этой учетной записью, и по умолчанию будет использовать первую из них.

Если у вас есть несколько подписок и нужно указать лишь одну из них, которая будет использоваться для хранилища ключей Azure, введите следующую команду, чтобы увидеть подписки своей учетной записи:

    Get-AzureSubscription

Далее, чтобы указать подписку, которую нужно использовать, введите:

    Select-AzureSubscription -SubscriptionName <subscription name>

Дополнительную информацию о настройке Azure PowerShell см. в статье [Как установить и настроить Azure PowerShell](../powershell-install-configure.md).

## <a id="switch"></a>Переключение в режим использования диспетчера ресурсов Azure ##

Для выполнения командлетов хранилища ключей Azure требуется диспетчер ресурсов Azure, поэтому введите следующую команду, чтобы переключиться в режим этого диспетчера:

	Switch-AzureMode AzureResourceManager

## <a id="resource"></a>Создание новой группы ресурсов ##

При использовании диспетчера ресурсов Azure все связанные ресурсы создаются внутри группы ресурсов. Для примера мы создадим новую группу ресурсов с именем ContosoResourceGroup:

	New-AzureResourceGroup –Name 'ContosoResourceGroup' –Location 'East Asia'

Используйте команду [Get-AzureLocation](https://msdn.microsoft.com/library/azure/dn654582.aspx) для параметра -Location, чтобы указать альтернативное расположение. Если вам необходима дополнительная информация, введите `Get-Help Get-AzureLocation`.


## <a id="vault"></a>Создание хранилища ключей ##

Используйте командлет [New-AzureKeyVault](https://msdn.microsoft.com/library/azure/dn903602.aspx) для создания хранилища ключей. Этот командлет предусматривает три обязательных параметра: **имя группы ресурсов**, **имя хранилища ключей** и **географическое расположение**.

Например, если вы используете хранилище с именем **ContosoKeyVault**, группу ресурсов с именем **ContosoResourceGroup** и расположение **Восточная Азия**, введите:

    New-AzureKeyVault -VaultName 'ContosoKeyVault' -ResourceGroupName 'ContosoResourceGroup' -Location 'East Asia' 

В выходных данных командлета будут показаны свойства хранилища ключей, которое вы только что создали. Среди всех свойств есть два самых важных:

- **имя**. В этом примере — ContosoKeyVault. Вы будете использовать это имя для выполнения других командлетов хранилища ключей;
- **vaultUri**. В этом примере — https://contosokeyvault.vault.azure.net/. Необходимо, чтобы приложения, использующие ваше хранилище через REST API, использовали этот URI.

Теперь ваша учетная запись Azure авторизована, и вы можете выполнять любые операции в этом хранилище ключей. Пока что это недоступно для других учетных записей.

## <a id="add"></a>Добавление ключа или секрета в хранилище ключей ##

Если вам необходимо создать ключ с программной защитой для собственного использования с помощью хранилища ключей Azure, используйте командлет [Add-AzureKeyVaultKey](https://msdn.microsoft.com/library/azure/dn868048.aspx) и введите следующее:

    $key = Add-AzureKeyVaultKey -VaultName 'ContosoKeyVault' -Name 'ContosoFirstKey' -Destination 'Software'


Однако если на диске C:\\ в PFX-файле с именем softkey.pfx есть ключ, защищенный с помощью программного обеспечения, который нужно передать в хранилище ключей Azure, введите следующую команду, чтобы задать переменную **securepfxpwd** для пароля **123** PFX-файла:

    $securepfxpwd = ConvertTo-SecureString –String '123' –AsPlainText –Force

Затем введите следующую команду для импорта ключа из PFX-файла, который защищает его с помощью программного обеспечения в службе хранилища ключей:

    $key = Add-AzureKeyVaultKey -VaultName 'ContosoKeyVault' -Name 'ContosoFirstKey' -KeyFilePath 'c:\softkey.pfx' -KeyFilePassword $securepfxpwd


Теперь созданный или переданный в хранилище ключей Azure ключ можно вызвать, используя его URI. Например, **https://ContosoKeyVault.vault.azure.net/Keys/ContosoFirstKey/a10f5336-9d93-44a3-9e26-e86e3488b768**.

Чтобы отобразить URI для этого ключа, введите:

	$Key.key.kid

Чтобы добавить секрет в хранилище ключей Azure, который представляет собой пароль с именем SQLPassword и значением Pa$$w0rd, сначала преобразуйте значение Pa$$w0rd в защищенную строку. Для этого введите следующее:

	$secretvalue = ConvertTo-SecureString 'Pa$$w0rd' -AsPlainText -Force

Затем введите следующее:

	$secret = Set-AzureKeyVaultSecret -VaultName 'ContosoKeyVault' -Name 'SQLPassword' -SecretValue $secretvalue

Теперь пароль, добавленный в хранилище ключей Azure, можно вызвать, используя его URI. Например, **https://ContosoVault.vault.azure.net/Secrets/778c3e43-3fdb-4cdf-b58e-7f501eb41d68**.

Чтобы отобразить URI для этого секрета, введите:

	$secret.Id

Давайте просмотрим только что созданный ключ или секрет.

- Чтобы просмотреть свой ключ, введите `Get-AzureKeyVaultKey –VaultName 'ContosoKeyVault'`.
- Чтобы просмотреть свой секрет, введите `Get-AzureKeyVaultSecret –VaultName 'ContosoKeyVault'`.

Теперь хранилище ключей и ключ или секрет готовы для использования в приложениях. Необходимо авторизовать приложения для их использования.

## <a id="register"></a>Регистрация приложения в Azure Active Directory ##

Обычно этот шаг выполняет разработчик на отдельном компьютере. Он не относится к хранилищу ключей Azure, но включен в этот учебник для полноты картины.


>[AZURE.IMPORTANT]Чтобы завершить прохождение этого учебника, учетная запись, хранилище и приложение, которое вы будете регистрировать на этом шаге, должны находиться в одном каталоге Azure.

Приложения, которые используют хранилища ключей, должны пройти аутентификацию с использованием маркера Azure Active Directory. Для этого владельцу приложения необходимо сначала зарегистрировать приложение в Azure Active Directory. В конце регистрации владелец приложения получает следующие значения.


- **Идентификатор приложения** (также известный как идентификатор клиента) и **ключ аутентификации** (также известный как общий секрет). Для получения маркера приложение должно предоставить Azure Active Directory оба этих значения. Настроенный способ предоставления зависит от приложения. В примере приложения, использующего хранилище ключей, владелец задает эти значения в файле app.config.



Чтобы зарегистрировать приложение в Azure Active Directory:

1. Войдите на портал Azure.
2. Слева щелкните **Active Directory**, а затем выберите каталог, в котором вам необходимо зарегистрировать приложение. <br> <br> Примечание. Вам необходимо выбрать каталог, содержащий подписку Azure, которую вы использовали для создания хранилища ключей. Если вам не известно, какой это каталог, щелкните **Параметры**, найдите подписку, использованную для создания хранилища ключей, и запишите имя каталога, отображающегося в последнем столбце.

3. Щелкните **ПРИЛОЖЕНИЯ**. Если в каталоге нет добавленных приложений, на этой странице отобразится только ссылка **Добавить приложение**. Щелкните ссылку или, как вариант, можно щелкнуть **ДОБАВИТЬ** на панели команд.
4.	В мастере **ДОБАВЛЕНИЕ ПРИЛОЖЕНИЯ** на странице **Что необходимо сделать?** щелкните **Добавить приложение, разрабатываемое моей организацией**.
5.	На странице **Расскажите о своем приложении** укажите имя своего приложения и выберите **ВЕБ-ПРИЛОЖЕНИЕ И/ИЛИ ВЕБ-API** (по умолчанию). Щелкните значок «Далее».
6.	На странице **Свойства приложения** укажите данные в полях **URL-АДРЕС ВХОДА** и **URI КОДА ПРИЛОЖЕНИЯ** для своего веб-приложения. Если в вашем приложении нет этих значений, можно придумать их для этого шага (например, можно указать http://test1.contoso.com в обоих полях). Не важно, существуют ли эти сайты. Важно то, что URI кода приложения отличается для каждого приложения в каталоге. Каталог использует эту строку для идентификации приложения.
7.	Щелкните значок «Готово», чтобы сохранить изменения в мастере.
8.	На странице «Быстрый запуск» щелкните **НАСТРОИТЬ**. 
9.	Прокрутите страницу до раздела **ключей**, выберите длительность и щелкните **СОХРАНИТЬ**. Страница обновится и отобразится значение ключа. Необходимо настроить приложение, указав это значение ключа и значение **ИДЕНТИФИКАТОР КЛИЕНТА** (указания по этой конфигурации зависят от конкретного приложения).
10.	Скопируйте значение идентификатора клиента на этой странице. Вы будете использовать его на следующем шаге, чтобы задать разрешения в своем хранилище.




## <a id="authorize"></a>Авторизация приложения для использования ключа или секрета ##


Чтобы авторизовать приложение для получения доступа к ключу или секрету в хранилище, используйте командлет [Set-AzureKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/dn903607.aspx).

Например, если имя хранилища — ContosoKeyVault, а идентификатор клиента приложения — 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed, и нужно авторизовать это приложение для расшифровки и подписи с использованием ключей в вашем хранилище, выполните следующее:

	Set-AzureKeyVaultAccessPolicy -VaultName 'ContosoKeyVault' -ServicePrincipalName 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed -PermissionsToKeys decrypt,sign



## <a id="HSM"></a>Использование аппаратного модуля безопасности ##

Чтобы обеспечить более высокий уровень защиты, можно импортировать ключи или создать их в аппаратных модулях безопасности (ключи никогда не покидают их пределов). Аппаратные модули безопасности сертифицированы по стандарту FIPS 140-2 уровня 2. Если это требование вас не касается, пропустите этот подраздел и перейдите к подразделу [Удаление хранилища ключей, а также связанных ключей и секретов](#delete).

Чтобы создать ключи, защищенные аппаратным модулем безопасности, у вас должна быть [подписка на хранилище, которая поддерживает ключи, защищенные аппаратным модулем безопасности](../../../pricing/free-trial).


При создании хранилища добавьте параметр SKU:

	New-AzureKeyVault -VaultName 'ContosoKeyVaultHSM' -ResourceGroupName 'ContosoResourceGroup' -Location 'East Asia' -SKU 'Premium'

В это хранилище можно добавлять ключи с программной защитой (как показано выше) и ключи, защищенные аппаратным модулем безопасности. Чтобы создать ключ, защищенный аппаратным модулем безопасности, задайте значение HSM для параметра Destination:

	$key = Add-AzureKeyVaultKey -VaultName 'ContosoKeyVaultHSM' -Name 'ContosoFirstHSMKey' -Destination 'HSM'

Вы можете использовать следующую команду для импорта ключа из PFX-файла на своем компьютере. Эта команда импортирует ключ в аппаратные модули безопасности в службе хранилища ключей:

	$key = Add-AzureKeyVaultKey -VaultName 'ContosoKeyVaultHSM' -Name 'ContosoFirstHSMKey' -KeyFilePath 'c:\softkey.pfx' -KeyFilePassword $securepfxpwd -Destination 'HSM'

Следующая команда импортирует пакет собственного ключа клиента (BYOK). Это дает возможность создать ключ в своем локальном аппаратном модуле безопасности и передать его в аппаратные модули безопасности в службе хранилища ключей так, чтобы ключ не покидал их пределы:

	$key = Add-AzureKeyVaultKey -VaultName 'ContosoKeyVaultHSM' -Name 'ContosoFirstHSMKey' -KeyFilePath 'c:\ITByok.byok' -Destination 'HSM'

Более подробные указания по созданию пакета BYOK см. в разделе [Как использовать ключи, защищенные аппаратным модулем безопасности, с помощью хранилища ключей Azure](https://msdn.microsoft.com/library/azure/dn903624.aspx).

## <a id="delete"></a>Удаление хранилища ключей, а также связанных ключей и секретов ##

Если больше нет необходимости в хранилище ключей и содержащемся в нем ключе или секрете, можно удалить его, используя командлет [Remove-AzureKeyVault](https://msdn.microsoft.com/library/azure/dn903603.aspx):

	Remove-AzureKeyVault -VaultName 'ContosoKeyVault'

Как вариант, можно удалить всю группу ресурсов Azure, которая включает в себя хранилище ключей и другие ресурсы, которые вы добавили в эту группу:

	Remove-AzureResourceGroup -ResourceGroupName 'ContosoResourceGroup'


## <a id="other"></a>Другие командлеты Azure PowerShell ##

Вот другие команды, которые могут быть полезны при управлении хранилищем ключей Azure:

- `$Keys = Get-AzureKeyVaultKey -VaultName 'ContosoKeyVault'` — эта команда отображает все ключи и выбранные свойства в виде таблицы;
- `$Keys[0]` — эта команда отображает полный список свойств для указанного ключа;
- `Get-AzureKeyVaultSecret` — эта команда перечисляет все имена секретов и выбранные свойства в виде таблицы;
- `Remove-AzureKeyVaultKey -VaultName 'ContosoKeyVault' -Name 'ContosoFirstKey'` — пример того, как удалить конкретный ключ;
- `Remove-AzureKeyVaultSecret -VaultName 'ContosoKeyVault' -Name 'SQLPassword'` — пример того, как удалить конкретный секрет.






## <a id="next"></a>Дальнейшие действия ##

Полный список командлетов Windows PowerShell для хранилища ключей Azure см. в разделе [Командлеты для хранилища ключей Azure](https://msdn.microsoft.com/library/azure/dn868052.aspx).

Справочные материалы по программированию см. в разделах [Справочник по REST API хранилища ключей Azure](https://msdn.microsoft.com/library/azure/dn903609.aspx) и [Справочник по API клиента C# для хранилища ключей Azure](https://msdn.microsoft.com/library/azure/dn903628.aspx).



<!--HONumber=54--> 