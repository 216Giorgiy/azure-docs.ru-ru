<properties linkid="dev-ruby-how-to-service-bus-queues" urlDisplayName="Service Bus Queues" pageTitle="How to use Service Bus queues (Ruby) - Azure" metaKeywords="Azure Service Bus queues, Azure queues, Azure messaging, Azure queues Ruby" description="Learn how to use Service Bus queues in Azure. Code samples written in Ruby." metaCanonical="" services="service-bus" documentationCenter="Ruby" title="How to Use Service Bus Queues" authors="guayan" solutions="" manager="" editor="" />

<tags ms.service="service-bus" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="ruby" ms.topic="article" ms.date="01/01/1900" ms.author="guayan" />

# Использование очередей Service Bus

В этом руководстве показано, как использовать очереди Service Bus. Примеры написаны
с помощью Ruby и используют пакет Azure. Здесь описаны такие
сценарии, как **создание очередей, отправка и получение сообщений**, а также
**удаление очередей**. Дополнительные сведения об очередях см. в разделе [Дальнейшие действия][Дальнейшие действия].

## Оглавление

-   [Что такое очереди Service Bus?][Что такое очереди Service Bus?]
-   [Создание пространства имен службы][Создание пространства имен службы]
-   [Получение учетных данных управления по умолчанию для пространства имен][Получение учетных данных управления по умолчанию для пространства имен]
-   [Создание приложения Ruby][Создание приложения Ruby]
-   [Настройка приложения для использования шины обслуживания][Настройка приложения для использования шины обслуживания]
-   [Настройка подключения к Service Bus Azure][Настройка подключения к Service Bus Azure]
-   [Создание очереди][Создание очереди]
-   [Отправка сообщений в очередь][Отправка сообщений в очередь]
-   [Получение сообщений из очереди][Получение сообщений из очереди]
-   [Обработка сбоев приложения и нечитаемых сообщений][Обработка сбоев приложения и нечитаемых сообщений]
-   [Дальнейшие действия][Дальнейшие действия]

[WACOM.INCLUDE [howto-service-bus-queues](../includes/howto-service-bus-queues.md)]

## <span id="create-a-ruby-application"></span></a>Создание приложения Ruby

Создайте приложение Ruby. Инструкции см. в разделе [Создание приложения Ruby в Azure][Создание приложения Ruby в Azure].

## <span id="configure-your-application-to-use-service-bus"></span></a>Настройка приложения для использования Service Bus

Для использования Azure Service Bus необходимо загрузить и использовать пакет Ruby Azure, который содержит набор библиотек, взаимодействующих со службами REST хранилища.

### Использование RubyGems для получения пакета

1.  Используйте интерфейс командной строки, например **PowerShell** (Windows), **Terminal** (Mac) или **Bash** (Unix).

2.  Введите "gem install azure" в окне командной строки, чтобы установить пакеты и зависимости.

### Импорт пакета

Используйте свой любимый текстовый редактор, чтобы добавить следующий код в начало файла Ruby, где планируется использовать хранилище.

    require "azure"

## <span id="setup-a-windows-azure-service-bus-connection"></span></a>Настройка подключения к Service Bus Azure

Модуль Azure считывает переменные среды **AZURE\_SERVICEBUS\_NAMESPACE** и **AZURE\_SERVICEBUS\_ACCESS\_KEY**
для получения сведений, необходимых для подключения к пространству имен шины обслуживания Azure. Если эти переменные среды не заданы, необходимо указать сведения о пространстве имен перед использованием **Azure::ServiceBusService** с помощью следующего кода:

    Azure.config.sb_namespace = "<your azure service bus namespace>"
    Azure.config.sb_access_key = "<your azure service bus access key>"

## <span id="how-to-create-a-queue"></span></a>Практическое руководство. Создание очереди

Объект **Azure::ServiceBusService** позволяет работать с очередями. Чтобы создать очередь, используйте метод **create\_queue()**. В следующем примере создается очередь или выводится ошибка, если она возникла.

    azure_service_bus_service = Azure::ServiceBusService.new
    begin
      queue = azure_service_bus_service.create_queue("test-queue")
    rescue
      puts $!
    end

Можно также передать объект **Azure::ServiceBus::Queue** с дополнительными параметрами, которые позволяют переопределить параметры очереди по умолчанию, например срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить максимальный размер очереди 5 ГБ и срок жизни 1 минута.

    queue = Azure::ServiceBus::Queue.new("test-queue")
    queue.max_size_in_megabytes = 5120
    queue.default_message_time_to_live = "PT1M"

    queue = azure_service_bus_service.create_queue(queue)

## <span id="how-to-send-messages-to-a-queue"></span></a>Практическое руководство. Отправка сообщений в очередь

Чтобы отправить сообщение в очередь шины обслуживания, приложение вызывает метод **send\_queue\_message()** объекта **Azure::ServiceBusService**. Сообщения, отправленные (и полученные) из очередей шины обслуживания — это объекты **Azure::ServiceBus::BrokeredMessage**. У них есть набор стандартных свойств (например, **label** и **time\_to\_live**), словарь, используемый для хранения настраиваемых свойств приложения, и тело произвольных данных приложения. Приложение может задать текст сообщения, передав строковое значение как сообщение, а все необходимые стандартные свойства будут заполнены значениями по умолчанию.

В следующем примере показано, как отправить тестовое сообщение с именем очереди test-queue с помощью метода **send\_queue\_message()**.

    message = Azure::ServiceBus::BrokeredMessage.new("test queue message")
    message.correlation_id = "test-correlation-id"
    azure_service_bus_service.send_queue_message("test-queue", message)

Очереди Service Bus поддерживают максимальный размер сообщения 256 КБ (максимальный размер заголовка, который содержит стандартные и настраиваемые свойства приложения, составляет 64 КБ). Ограничения на количество сообщений в очереди нет, но есть максимальный общий размер сообщений, содержащихся в очереди. Этот размер очереди, определяемый в момент ее создания, не должен превышать 5 ГБ.

## <span id="how-to-receive-messages-from-a-queue"></span></a>Практическое руководство. Получение сообщений из очереди

Сообщения извлекаются из очереди с помощью метода **receive\_queue\_message()** объекта **Azure::ServiceBusService**. По умолчанию сообщения считываются и блокируются без удаления из очереди. Однако вы можете удалить сообщения из очереди после их чтения, установив для параметра **:peek\_lock** значение **false**.

По умолчанию чтение и удаление выполняются в 2 этапа, что позволяет поддерживать приложения, не способные обрабатывать отсутствующие сообщения. Получив запрос, Service Bus находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению. Когда приложение завершает обработку сообщения (или сохраняет его для будущей обработки), она завершает второй этап процесса получения, вызывая метод **delete\_queue\_message()** и указывая сообщение для удаления в качестве параметра. Метод **delete\_queue\_message()** помечает сообщение как используемое и удаляет его из очереди.

Если параметр **:peek\_lock** имеет значение **false**, чтение и удаление сообщения становится очень простым процессом и оптимально подходит для сценариев, в которых приложение может не обработать сообщение в случае сбоя. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Поскольку Service Bus помечает сообщение как использованное, то когда после своего перезапуска приложение снова начнет обрабатывать сообщения, оно пропустит сообщение, использованное до сбоя.

В примере ниже показано, как можно получать и обрабатывать сообщения с помощью метода **receive\_queue\_message()**. Сначала пример получает и удаляет сообщение с помощью параметра **:peek\_lock**, для которого задано значение **false**, затем он получает другое сообщение и удаляет его с помощью метода **delete\_queue\_message()**.

    message = azure_service_bus_service.receive_queue_message("test-queue", 
      { :peek_lock => false })
    message = azure_service_bus_service.receive_queue_message("test-queue")
    azure_service_bus_service.delete_queue_message(message)

## <span id="how-to-handle-application-crashes-and-unreadable-messages"></span></a>Обработка сбоев приложения и нечитаемых сообщений

Service Bus предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если приложение-получатель по каким-либо причинам не может обработать сообщение, то оно может вызвать метод **unlock\_queue\_message()** объекта **Azure::ServiceBusService**. После этого Service Bus разблокирует сообщение в очереди и сделает его доступным для приема тем же или другим приложением-пользователем.

Кроме того, с сообщением, заблокированным в очереди, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), Service Bus разблокирует сообщение автоматически и сделает его доступным для приема.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода **delete\_queue\_message()**, сообщение будет повторно доставлено в приложение после его перезапуска. Часто этот подход называют **обработать хотя бы один раз**, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Часто это достигается с помощью свойства **message\_id** сообщения, которое остается постоянным для различных попыток доставки.

## <span id="next-steps"></span></a> Дальнейшие действия

Вы узнали основные сведения об очередях Service Bus. Для получения дополнительных сведений используйте следующие далее ссылки.

-   См. справочник MSDN: [очереди, разделы и подписки][очереди, разделы и подписки]
-   Посетите репозиторий [Azure SDK для Ruby][Azure SDK для Ruby] на веб-сайте GitHub

Сравнение очередей Service Bus Azure, описанных в этой статье, и очередей Service Bus Azure, описанных в статье [Использование службы очередей Azure][Использование службы очередей Azure], см. в статье [Очереди Azure и очереди Service Bus Azure — сходство и отличия][Очереди Azure и очереди Service Bus Azure — сходство и отличия]

  [Дальнейшие действия]: #next-steps
  [Создание пространства имен службы]: #create-a-service-namespace
  [Получение учетных данных управления по умолчанию для пространства имен]: #obtain-default-credentials
  [Создание приложения Ruby]: #create-a-ruby-application
  [Настройка приложения для использования шины обслуживания]: #configure-your-application-to-use-service-bus
  [Настройка подключения к Service Bus Azure]: #setup-a-windows-azure-service-bus-connection
  [Создание очереди]: #how-to-create-a-queue
  [Отправка сообщений в очередь]: #how-to-send-messages-to-a-queue
  [Получение сообщений из очереди]: #how-to-receive-messages-from-a-queue
  [Обработка сбоев приложения и нечитаемых сообщений]: #how-to-handle-application-crashes-and-unreadable-messages
  [howto-service-bus-queues]: ../includes/howto-service-bus-queues.md
  [Создание приложения Ruby в Azure]: /ru-ru/develop/ruby/tutorials/web-app-with-linux-vm/
  [очереди, разделы и подписки]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh367516.aspx
  [Azure SDK для Ruby]: https://github.com/WindowsAzure/azure-sdk-for-ruby
  [Использование службы очередей Azure]: /ru-ru/develop/ruby/how-to-guides/queue-service/
  [Очереди Azure и очереди Service Bus Azure — сходство и отличия]: http://msdn.microsoft.com/ru-ru/library/windowsazure/hh767287.aspx
