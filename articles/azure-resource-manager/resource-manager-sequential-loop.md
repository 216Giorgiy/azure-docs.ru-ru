---
title: "Последовательный цикл в шаблонах Azure | Документация Майкрософт"
description: "Описывается, как расширить функциональные возможности шаблонов Azure Resource Manager, чтобы реализовать последовательные циклы при развертывании нескольких экземпляров типа ресурса."
services: guidance, azure-resource-manager
documentationcenter: na
author: petertaylor9999
manager: christb
editor: 
ms.service: guidance
ms.topic: article
ms.date: 04/18/2017
ms.author: petertay
translationtype: Human Translation
ms.sourcegitcommit: db7cb109a0131beee9beae4958232e1ec5a1d730
ms.openlocfilehash: 44d59488600e05d6ae80a169b5d682e8fa94ccc5
ms.lasthandoff: 04/18/2017


---

# <a name="patterns-for-extending-the-functionality-of-azure-resource-manager-templates---sequential-looping"></a>Примеры расширения функциональных возможностей шаблонов Azure Resource Manager. Последовательные циклы

Шаблоны Azure Resource Manager поддерживают развертывание группы идентичных ресурсов с помощью цикла копирования. Цикл копирования в объекте ресурса можно использовать для выполнения итерации строк массива, которые затем будут использоваться для формирования уникальных имен ресурсов. Цикл копирования в объекте ресурса может также использоваться для выполнения итерации массива переменных, которые описывают ресурс.

Все эти шаблоны вполне успешно работают, но только при отсутствии зависимостей между членами группы. Во время цикла итерации Resource Manager пытается развертывать ресурсы параллельно. Если первый ресурс зависит от второго, то развертывание может завершиться ошибкой, если Resource Manager развернет второй ресурс раньше первого.

Проблема заключается в том, что сейчас Resource Manager не поддерживает `dependsOn` внутри цикла итерации. Однако эту функцию можно реализовать с помощью имеющихся возможностей Resource Manager и творческого подхода к именованию ресурсов. 

## <a name="sequential-looping-pattern"></a>Схема последовательного цикла

Схема следующая: первому ресурсу присваивается имя, получаемое путем объединения префикса имени и `0` (или другого первого индекса цикла). Второй ресурс использует цикл копирования, и в цикле копирования имя следующего ресурса представляет собой объединение префикса имени и результата функции `copyIndex(1)`, которая добавляет 1 к текущему значению `copyIndex()`. Второй ресурс также содержит элемент `dependsOn`, который ссылается на объединение префикса имени и результата функции `copyIndex()`. Этот подход устанавливает связь `dependsOn` между следующим и предыдущим ресурсами. Resource Manager откладывает развертывание следующего ресурса, пока не будет развернут предыдущий ресурс.

Ниже приведен шаблон, демонстрирующий этот подход. Тип ресурса Microsoft.Resources/deployments — просто вложенный шаблон, который на самом деле ничего не развертывает.

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "numberToDeploy": {
      "type": "int",
      "minValue": 2,
      "defaultValue": 5
    }
  },
  "variables": {
    "count": "[sub(parameters('numberToDeploy'), 1)]"
  },
  "resources": [
    {
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "name": "loop-0",
      "properties": {
        "mode": "Incremental",
        "parameters": {},
        "template": {
          "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {},
          "variables": {},
          "resources": [],
          "outputs": {
            "collection": {
              "type": "string",
              "value": "loop-0 "
            }
          }
        }
      }
    },
    {
      "apiVersion": "2015-01-01",
      "type": "Microsoft.Resources/deployments",
      "name": "[concat('loop-', copyIndex(1))]",
      "dependsOn": [
        "[concat('loop-', copyIndex())]"
      ],
      "copy": {
        "name": "iterator",
        "count": "[variables('count')]"
      },
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {},
          "variables": {},
          "resources": [],
          "outputs": {
            "collection": {
              "type": "string",
              "value": "[concat(reference(concat('loop-',copyIndex())).outputs.collection.value,'loop-',copyIndex(1), ' ')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "result": {
      "type": "string",
      "value": "[reference(concat('loop-',variables('count'))).outputs.collection.value]"
    }
  }
}

```
В этом шаблоне первый объект ресурса назван `loop-0`. Во втором объекте ресурса имя следующего ресурса представляет собой объединение слова `loop-` и результата функции `copyIndex(1)`: `loop-1`. Элемент `dependsOn` ссылается на предыдущий ресурс, так как он представляет собой объединение слова `loop-` и результата функции `copyIndex()`: `loop-0`. Шаблон в втором объекте ресурса повторяется до достижения `count`, заканчивая ресурсом с именем `loop-4`, который посредством `dependsOn` зависит от `loop-3`. Обратите внимание на переменную `count`, которая вычитает `1` из параметра `numberToDeploy`, чтобы обеспечить счет с нуля.

## <a name="try-the-template"></a>Пробное использование шаблона

Если вы хотите поэкспериментировать с этим шаблоном, выполните следующее.

1.    Перейдите на портал Azure, щелкните значок "+" и найдите тип ресурса "Развертывание шаблона". Выберите его в результатах поиска.
2.    На открывшейся странице "Развертывание шаблона" нажмите кнопку "Создать". Перейдите в колонку "Настраиваемое развертывание", чтобы увидеть, что шаблон не содержит ресурсов.
3.    Щелкните значок "Изменить".
4.    Удалите пустой шаблон в правой области.
5.    Скопируйте и вставьте предыдущий пример шаблона в область справа.
6.    Нажмите кнопку "Сохранить".
7.    Вы вернетесь в область "Настраиваемое развертывание", но на этот раз в ней будет несколько раскрывающихся списков. Выберите свою подписку, создайте новую или используйте существующую группу ресурсов и выберите расположение. Ознакомьтесь с условиями и нажмите кнопку "Принимаю".
8.    Нажмите кнопку "Приобрести".

Чтобы убедиться в том, что ресурсы развертываются последовательно, щелкните "Группы ресурсов", а затем выберите группу ресурсов, выбранную ранее. Нажмите кнопку "Развертывания" в колонке группы ресурсов, и вы увидите ресурсы, развернутые в последовательном порядке, с соответствующей меткой времени.

![Развертывание шаблона с последовательным циклом в Azure Resource Manager](./media/resource-manager-sequential-loop/deployments.png)

## <a name="next-steps"></a>Дальнейшие действия

Используйте этот подход в шаблонах, добавляя ресурсы во вложенный шаблон. Можно либо создать их непосредственно в элементе template ресурса `Microsoft.Resources/deployments` или создать ссылки на них с помощью элемента `templateLink`. Тип ресурса в примере — вложенный шаблон, но могут развертываться ресурсы любого типа. Единственным исключением является то, что в цикле итерации невозможно ссылаться на дочерние ресурсы.

* Вводные сведения о создании нескольких экземпляров ресурса см. в разделе [Развертывание нескольких экземпляров ресурсов в шаблонах Azure Resource Manager](resource-group-create-multiple.md).
* Этот подход также реализован в [проекте стандартных блоков шаблона](https://github.com/mspnp/template-building-blocks) и [эталонных архитектурах Azure](/azure/architecture/reference-architectures/).
