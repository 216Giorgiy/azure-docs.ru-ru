<properties
    pageTitle="Stream Analytics: выявление мошенничества в режиме реального времени | Microsoft Azure"
    description="Информация о том, как с помощью службы Stream Analytics создать решение для выявления мошенничества в режиме реального времени. Используйте концентратор событий для обработки событий в реальном времени."
    keywords="обнаружение аномалий, обнаружение мошенничества, обнаружение аномалий в реальном времени"
    services="stream-analytics"
    documentationCenter=""
    authors="jeffstokes72"
    manager="jhubbard"
    editor="cgronlun" />

<tags
    ms.service="stream-analytics"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="data-services"
    ms.date="09/26/2016"
    ms.author="jeffstok" />




# <a name="get-started-using-azure-stream-analytics:-real-time-fraud-detection"></a>Приступая к работе с Azure Stream Analytics: выявление мошенничества в режиме реального времени

Узнайте, как с помощью службы Azure Stream Analytics создать комплексное решение для выявления мошенничества в режиме реального времени. Переносите события в концентраторы событий Azure, составляйте запросы Stream Analytics для агрегирования данных или отправки предупреждений, а также отправляйте результаты в приемник выходных данных для анализа данных с обработкой в режиме реального времени. В статье рассматривается вопрос обнаружения аномалий в реальном времени для телекоммуникационной отрасли, но приведенная в примере методика одинаково подходит и для обнаружения других видов мошенничества (например, кража кредитных карт или персональных данных).

Stream Analytics — это полностью управляемая служба, обеспечивающая масштабируемую обработку сложных событий с низкой задержкой и высоким уровнем доступности посредством потоковой передачи данных в облако. Дополнительные сведения см. в статье [Введение в Azure Stream Analytics](stream-analytics-introduction.md).


## <a name="scenario:-telecommunications-and-sim-fraud-detection-in-real-time"></a>Сценарий. Выявление мошенничества в отношении телекоммуникаций и SIM-карт в режиме реального времени

У поставщика телекоммуникационных услуг есть большой объем данных для входящих вызовов. Организации необходимо:

* Сократить объем данных до поддерживаемого уровня, а также проанализировать сведения об использовании клиентом по времени и географическим регионам.
* Обнаруживать мошенничества в отношении SIM-карт (когда один пользователь одновременно выполняет несколько вызовов из разных географических расположений) в режиме реального времени, чтобы с легкостью реагировать на угрозы путем уведомления клиентов или завершения работы службы.

В канонических сценариях Интернета вещей (IoT) используется огромный объем телеметрических данных или данных с датчиков. Клиенты хотят статистически обрабатывать данные или получать предупреждения об аномалиях в режиме реального времени.

## <a name="prerequisites"></a>Предварительные требования

- Скачайте файл [TelcoGenerator.zip](http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip) из Центра загрузки Майкрософт.
- Дополнительно: исходный код генератора событий с сайта [GitHub](https://aka.ms/azure-stream-analytics-telcogenerator)

## <a name="create-azure-event-hubs-input-and-consumer-group"></a>Создание входных данных концентраторов событий и группы потребителей Azure

В этом примере приложения создаются события, которые принудительно отправляются в экземпляр концентратора событий для обработки в режиме реального времени. Для получения данных событий в Stream Analytics рекомендуется использовать концентраторы событий Service Bus. Дополнительные сведения о концентраторах событий см. в [Документации по служебной шине Azure](/documentation/services/service-bus/).

Чтобы создать концентратор событий, сделайте следующее.

1.  На [портале Azure](https://manage.windowsazure.com/) щелкните **Создать** > **Службы приложений** > **Служебная шина** > **Концентратор событий** > **Быстрое создание**. Укажите имя, регион и новое или существующее пространство имен, чтобы создать концентратор событий.  
2.  Рекомендуем, чтобы каждое задание Stream Analytics считывалось из отдельной группы получателей концентратора событий. Позже мы проведем вас по процессу создания группы потребителей. [Дополнительные сведения о группах потребителей](https://msdn.microsoft.com/library/azure/dn836025.aspx). Для создания группы потребителей перейдите к только что созданному концентратору событий и нажмите кнопку **Группы потребителей**, затем щелкните **Создать** в нижней части страницы и укажите имя группы потребителей.
3.  Чтобы предоставить доступ к концентратору событий, необходимо создать политику общего доступа. Перейдите на вкладку **Настройка** в окне концентратора событий.
4.  В разделе **Политики общего доступа** создайте новую политику с разрешением **Управление**.

    ![Политики общего доступа, в которых можно создать политику с разрешениями на управление.](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-shared-access-policies.png)

5.  В нижней части страницы нажмите кнопку **СОХРАНИТЬ** .
6.  Перейдите на **панель мониторинга** и нажмите внизу страницы кнопку **Сведения о подключении**. Затем скопируйте и сохраните сведения о подключении.

## <a name="configure-and-start-the-event-generator-application"></a>Настройка и запуск приложения генератора событий

Мы создали клиентское приложение, с помощью которого создается пример метаданных входящих вызовов, которые отправляются в концентратор событий. Для настройки этого приложения выполните следующие действия.  

1.  Скачайте [файл TelcoGenerator.zip](http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip) и распакуйте его в каталог.

    > [AZURE.NOTE] Windows может заблокировать загруженный ZIP-файл. Щелкните правой кнопкой мыши файл и выберите **Свойства**. Если появляется сообщение "Этот файл получен с другого компьютера и, возможно, был заблокирован с целью защиты компьютера", установите флажок **Разблокировать** и нажмите кнопку "Применить".

2.  Замените значения Microsoft.ServiceBus.ConnectionString и EventHubName в файле telcodatagen.exe.config на строку подключения и имя концентратора событий.

    К строке подключения, скопированной из портала Azure, добавляется имя подключения. Не забудьте удалить ";EntityPath=<value>" из поля "add key=".

3.  Запустите приложение. Оно используется следующим образом.

    telcodatagen.exe [#NumCDRsPerHour] [вероятность мошенничества с SIM-картами] [#DurationHours]

В следующем примере в течение двух часов будет создано 1000 событий с вероятностью мошенничества 20 %.

    telcodatagen.exe 1000 .2 2

Отобразятся записи, отправляемые в концентратор событий. Ниже определены некоторые ключевые поля, которые будут использоваться в этом приложении для выявления мошенничества в реальном времени:

| Record | Определение |
| ------------- | ------------- |
| CallrecTime | Метка времени начала вызова. |
| SwitchNum | Телефонный переключатель, используемый для совершения вызова. |
| CallingNum | Номер телефона звонящего. |
| CallingIMSI | Идентификатор IMSI.  Уникальный идентификатор звонящего. |
| CalledNum | Номер телефона получателя звонка. |
| CalledIMSI | Идентификатор IMSI.  Уникальный идентификатор получателя звонка. |


## <a name="create-a-stream-analytics-job"></a>Создание задания Stream Analytics
Теперь, когда у нас есть поток телекоммуникационных событий, можно настроить задание Stream Analytics, чтобы анализировать эти события в режиме реального времени.

### <a name="provision-a-stream-analytics-job"></a>Подготовка задания Stream Analytics

1.  На портале Azure щелкните **Создать** > **Службы данных** > **Stream Analytics** > **Быстрое создание**.
2.  Укажите следующие значения и щелкните **СОЗДАТЬ ЗАДАНИЕ АНАЛИТИКИ ПОТОКА**:

    * **ИМЯ ЗАДАНИЯ**— введите имя задания.

    * **РЕГИОН**— выберите регион, в котором должно выполняться задание. Рекомендуем поместить задание в концентратор событий в том же регионе, чтобы улучшить производительность и избежать лишних затрат на передачу данных между регионами.

    * **Учетная запись хранения**: выберите учетную запись хранения Azure, которую вы хотите использовать для хранения данных отслеживания всех заданий Stream Analytics, запущенных в этом регионе. Можно выбрать существующую учетную запись хранения или создать новую.

3.  Щелкните **АНАЛИТИКА ПОТОКА** в области слева, чтобы открыть список заданий Stream Analytics.

    ![Значок службы Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-service-icon.png)

    Новое задание будет отображаться с состоянием **СОЗДАНО**. Обратите внимание, что кнопка **НАЧАЛО** в нижней части страницы отключена. Прежде чем запустить задание, необходимо настроить для него запрос, входные и выходные данные.

### <a name="specify-job-input"></a>Укажите вход данных для задания
1.  В задании Stream Analytics щелкните **Входные данные** в верхней части страницы, а затем — **Добавить входные данные**. В открывшемся диалоговом окне вы сможете выполнить ряд действий по настройке входных данных.
2.  Щелкните **Поток данных** и нажмите кнопку со стрелкой вправо.
3.  Щелкните **Концентратор событий**и нажмите кнопку со стрелкой вправо.
4.  На третьей странице введите или выберите следующие значения:

    * **Псевдоним входных данных**: введите понятное имя для входных данных этого задания, например *CallStream*. В дальнейшем это имя будет использоваться в запросе.

    * **Концентратор событий**: если созданный концентратор событий находится в той же подписке, что и задание Stream Analytics, выберите пространство имен, которому принадлежит концентратор.

        Если концентратор событий находится в другой подписке, выберите пункт **Использовать концентратор событий из другой подписки** и введите вручную информацию в полях **Пространство имен служебной шины**, **Имя концентратора событий**, **Имя политики концентратора событий**, **Ключ политики концентратора событий** и **Количество секций концентратора событий**.

    * **Имя концентратора событий**: выберите имя концентратора событий.

    * **Имя политики концентратора событий**: выберите политику для концентратора событий, созданную ранее в этом учебнике.

    * **Группа потребителей концентратора событий**: введите группу пользователей, созданную ранее в соответствии с инструкциями этого руководства.

5.  Щелкните стрелку вправо.
6.  Укажите следующие значения:

    * **ФОРМАТ СЕРИАЛИЗАТОРА СОБЫТИЙ**: JSON;
    * **КОДИРОВКА**— UTF8.
7.  Нажмите кнопку **Проверить**, чтобы добавить этот источник и убедиться, что Stream Analytics может успешно подключаться к концентратору событий.

### <a name="specify-job-query"></a>Укажите запрос задания

Stream Analytics поддерживает простую декларативную модель запроса для описания преобразований для обработки в режиме реального времени. Дополнительные сведения о языке см. в разделе [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/dn834998.aspx). Этот учебник поможет создать и проверить несколько запросов потока данных вызова в режиме реального времени.

#### <a name="optional:-sample-input-data"></a>Необязательно: пример входных данных
Чтобы проверить запрос на фактических данных задания, можно использовать функцию **Пример данных** для извлечения событий из потока и создания JSON-файла событий для тестирования.  Для этого выполните следующие действия. Кроме того, мы предоставили пример файла [Telco.json](https://github.com/Azure/azure-stream-analytics/blob/master/Sample%20Data/telco.json) для тестирования.

1.  Выберите входные данные концентратора событий и нажмите кнопку **Пример данных** в нижней части страницы.
2.  В появившемся окне укажите **Время начала** сбора данных и **Продолжительность** сбора дополнительных данных.
3.  Нажмите кнопку **Проверить**, чтобы начать сбор входных данных.  Создание файла может занять пару минут.  После завершения процесса нажмите кнопку **Сведения**, скачайте созданный JSON-файл и сохраните его.

    ![Скачивание и сохранение обработанных данных в JSON-файле](./media/stream-analytics-real-time-fraud-detection/stream-analytics-download-save-json-file.png)

#### <a name="pass-through-query"></a>Запрос к серверу

Чтобы архивировать все события, можно отправить запрос к серверу для считывания всех полей в полезных данных для события или сообщения. Прежде отправьте простой запрос к серверу, чтобы заполнить все поля события.

1.  Щелкните **ЗАПРОС** в верхней части страницы задания Stream Analytics.
2.  Добавьте в редакторе следующий код:

        SELECT * FROM CallStream

    > [AZURE.IMPORTANT] Убедитесь, что имя входного источника соответствует имени входных данных, указанному ранее.

3.  В редакторе запросов щелкните **Тест** .
4.  Укажите тестовый файл. Используйте файл, созданный с помощью этой процедуры, или файл [telco.json](https://github.com/Azure/azure-stream-analytics/blob/master/Samples/SampleDataFiles/Telco.json).
5.  Нажмите кнопку **Проверить** и просмотрите результаты, которые отображаются под определением запроса.

    ![Результаты определения запроса](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sim-fraud-output.png)


### <a name="column-projection"></a>Заполнение столбцов

Теперь сократим набор возвращаемых полей.

1.  Измените запрос в редакторе кода на:

        SELECT CallRecTime, SwitchNum, CallingIMSI, CallingNum, CalledNum
        FROM CallStream

2.  Щелкните **Повтор** в редакторе запросов, чтобы просмотреть результаты запроса.

    ![Выходные данные в редакторе запросов.](./media/stream-analytics-real-time-fraud-detection/stream-analytics-query-editor-output.png)

### <a name="count-of-incoming-calls-by-region:-tumbling-window-with-aggregation"></a>Количество входящих вызовов по региону: "переворачивающееся" окно с агрегированием

Для сравнения количества входящих вызовов на регион мы используем метод [TumblingWindow](https://msdn.microsoft.com/library/azure/dn835055.aspx). Он позволяет получить данные о числе входящих вызовов, которые каждые 5 секунд группируются по параметру **SwitchNum**.

1.  Измените запрос в редакторе кода на:

        SELECT System.Timestamp as WindowEnd, SwitchNum, COUNT(*) as CallCount
        FROM CallStream TIMESTAMP BY CallRecTime
        GROUP BY TUMBLINGWINDOW(s, 5), SwitchNum

    В этом запросе используется ключевое слово **Timestamp By**, позволяющее задать поле метки времени в полезных данных, используемых при вычислении временных распределений. Если это поле не указано, при выполнении операций с окнами будет использоваться время поступления каждого события в концентратор событий. См. раздел ["Время прибытия и время приложения" в справочнике по языку запросов Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx).

    Обратите внимание, что вы можете получить доступ к метке времени конца каждого окна с помощью свойства **System.Timestamp** .

2.  Щелкните **Повтор** в редакторе запросов, чтобы просмотреть результаты запроса.

    ![Результаты запроса по Timestand By](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-query-editor-rerun.png)

### <a name="sim-fraud-detection-with-a-self-join"></a>Выявление мошенничества в отношении SIM-карт с помощью самосоединения

Чтобы определить потенциально мошеннические действия, мы выполним поиск вызовов, которые один пользователь совершает из нескольких мест менее чем за 5 секунд.  Для проверки таких случаев поток событий вызовов необходимо [объединить](https://msdn.microsoft.com/library/azure/dn835026.aspx) с самим собой.

1.  Измените запрос в редакторе кода на:

        SELECT System.Timestamp as Time, CS1.CallingIMSI, CS1.CallingNum as CallingNum1,
        CS2.CallingNum as CallingNum2, CS1.SwitchNum as Switch1, CS2.SwitchNum as Switch2
        FROM CallStream CS1 TIMESTAMP BY CallRecTime
        JOIN CallStream CS2 TIMESTAMP BY CallRecTime
        ON CS1.CallingIMSI = CS2.CallingIMSI
        AND DATEDIFF(ss, CS1, CS2) BETWEEN 1 AND 5
        WHERE CS1.SwitchNum != CS2.SwitchNum

2.  Щелкните **Повтор** в редакторе запросов, чтобы просмотреть результаты запроса.

    ![Результаты запроса соединения](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-query-editor-join.png)

### <a name="create-output-sink"></a>Создание приемника выходных данных 

Теперь, когда мы определили поток событий, входные данные концентратора событий для приема событий и запрос для выполнения преобразования потока, остался последний этап — определить приемник выходных данных задания. Мы будем записывать события, связанные с мошенническими действиями, в хранилище BLOB-объектов Azure.

Выполните следующие действия, чтобы создать контейнер для хранилища BLOB-объектов, если он еще не создан.

1.  Используйте существующую учетную запись хранения или создайте новую. Для этого щелкните **Создать > Службы данных > Служба хранилища > Быстрое создание** и следуйте указаниям на экране.
2.  Выберите учетную запись хранения, щелкните **Контейнеры** в верхней части страницы, а затем нажмите кнопку **Добавить**.
3.  В поле **Имя** укажите имя контейнера, а в поле **Доступ** задайте **Разрешение на доступ к общедоступному большому двоичному объекту**.

## <a name="specify-job-output"></a>Укажите выходные данные задания

1.  В задании Stream Analytics щелкните **Выходные данные** в верхней части страницы, а затем — **Добавить выходные данные**. В открывшемся диалоговом окне вы сможете выполнить ряд действий по настройке выходных данных.
2.  Выберите **Хранилище BLOB-объектов**, а затем нажмите кнопку справа.
3.  На третьей странице введите или выберите следующие значения:

    * **Выходной псевдоним**: введите понятное имя для этих выходных данных задания.
    * **Подписка**: если хранилище BLOB-объектов создано в той же подписке, что и задание Stream Analytics, щелкните **Использовать учетную запись хранения из текущей подписки**. Если хранилище связано с другой подпиской, выберите **Использовать учетную запись хранения из другой подписки** и вручную заполните поля **Учетная запись хранения**, **Ключ учетной записи хранения** и **Контейнер**.
    * **УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ**: выберите имя учетной записи хранения.
    * **КОНТЕЙНЕР**: выберите имя контейнера.
    * **Префикс имени файла**: введите префикс файла, который следует использовать при записи выходных данных в BLOB-объект.

4.  Щелкните стрелку вправо.
5.  Укажите следующие значения:

    * **ФОРМАТ СЕРИАЛИЗАТОРА СОБЫТИЙ**: JSON;
    * **КОДИРОВКА**— UTF8.

6.  Нажмите кнопку **Проверить**, чтобы добавить этот источник и убедиться, что служба Stream Analytics может подключиться к учетной записи хранения.

## <a name="start-job-for-real-time-processing"></a>Запуск задания для обработки в режиме реального времени

Входные данные, запрос и выходные данные указаны, и теперь можно запустить задание Stream Analytics для выявления мошенничества в режиме реального времени.

1.  На **панели мониторинга** задания щелкните **Запустить** в нижней части страницы.
2.  В открывшемся диалоговом окне выберите **Время запуска задания** и нажмите кнопку **Проверить** в нижней части диалогового окна. Состояние задания изменится на **Запуск**, а затем — на **Выполняется**.

## <a name="view-fraud-detection-output"></a>Просмотр выходных данных при выявлении мошенничества

Чтобы просматривать запись событий, связанных с мошенническими действиями, в выходные данные в режиме реального времени, воспользуйтесь такими инструментами, как [Обозреватель хранилищ Azure](http://storageexplorer.com/) или [Обозреватель Azure](http://www.cerebrata.com/products/azure-explorer/introduction).  

![Выявление мошенничества. Связанные с мошенническими действиями события, просмотренные в режиме реального времени](./media/stream-analytics-real-time-fraud-detection/stream-ananlytics-view-real-time-fraudent-events.png)

## <a name="get-support"></a>Получение поддержки
За дополнительной помощью обращайтесь на наш [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureStreamAnalytics).


## <a name="next-steps"></a>Дальнейшие действия

- [Введение в Azure Stream Analytics](stream-analytics-introduction.md)
- [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
- [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx)
- [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)



<!--HONumber=Oct16_HO2-->


