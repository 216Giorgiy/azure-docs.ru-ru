---
title: Выходные данные Azure Stream Analytics в Cosmos DB
description: Из этой статьи вы узнаете, как с помощью Azure Stream Analytics сохранять выходные данные в Azure Cosmos DB в формате JSON, что позволяет архивировать данные и уменьшать задержки запросов в отношении неструктурированных данных JSON.
services: stream-analytics
author: mamccrea
ms.author: mamccrea
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 01/11/2019
ms.custom: seodec18
ms.openlocfilehash: 1f142d7551859396b789ee0594880f077e4a7f9f
ms.sourcegitcommit: c61777f4aa47b91fb4df0c07614fdcf8ab6dcf32
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2019
ms.locfileid: "54267136"
---
# <a name="azure-stream-analytics-output-to-azure-cosmos-db"></a>Выходные данные Azure Stream Analytics в Azure Cosmos DB  
Stream Analytics позволяет направлять данные из [Azure Cosmos DB](https://azure.microsoft.com/services/documentdb/) в формат JSON, позволяя архивировать данные и уменьшать задержки запросов в отношении неструктурированных данных JSON. В этом документе представлены некоторые рекомендации по реализации данной конфигурации.

Тем, кто не знаком с Cosmos DB, мы рекомендуем просмотреть [схему обучения работе с Azure Cosmos DB](https://azure.microsoft.com/documentation/learning-paths/documentdb/). 

> [!Note]
> В настоящее время Azure Stream Analytics поддерживает соединение только с Azure Cosmos DB при помощи **SQL API**.
> Другие API Azure Cosmos DB в данный момент не поддерживаются. Если указать модулю Azure Stream Analytics учетные записи Azure Cosmos DB, созданные при помощи других API, это может привести к неправильному сохранению данных. 

## <a name="basics-of-cosmos-db-as-an-output-target"></a>Основные сведения о Cosmos DB как объекте вывода данных
Использование выходных данных Azure Cosmos DB в Stream Analytics позволяет записывать результаты обработки потока данных в коллекцию Cosmos DB в формате JSON. Stream Analytics не создает коллекции в базе данных. Их требуется создавать заранее. Благодаря этому вы контролируете выставление счетов за использование коллекций Cosmos DB. Кроме того, вы можете регулировать производительность, целостность и емкость своих коллекций напрямую с помощью [API-интерфейсов Cosmos DB](https://msdn.microsoft.com/library/azure/dn781481.aspx).

> [!Note]
> Необходимо добавить 0.0.0.0 в список разрешенных IP-адресов брандмауэра Azure Cosmos DB.

Ниже приведены некоторые параметры коллекций Cosmos DB.

## <a name="tune-consistency-availability-and-latency"></a>Настройка согласованности, доступности и задержки
Для соответствия требованиям вашего приложения служба Azure Cosmos DB позволяет настроить базу данных и коллекции и отрегулировать уровень согласованности, доступности и задержки. В зависимости от того, какие уровни согласованности чтения потребуются вашему сценарию для чтения и записи задержки, вы можете выбирать уровень согласованности в своей учетной записи базы данных. Кроме того, Azure Cosmos DB по умолчанию активирует синхронное индексирование для каждой операции CRUD в вашей коллекции. Это еще один полезный параметр для контроля производительности операций чтения и записи в Azure Cosmos DB. Дополнительные сведения см. в статье об [изменении уровней согласованности в для базы данных и запросов](../cosmos-db/consistency-levels.md).

## <a name="upserts-from-stream-analytics"></a>Вставка и обновление Upsert в Stream Analytics
Интеграция Stream Analytics с Azure Cosmos DB позволяет вставлять или обновлять записи в коллекции с помощью заданного столбца идентификатора документа. Этот процесс называется также *Upsert*.

Stream Analytics использует оптимистичный подход Upsert, при котором обновления выполняются только тогда, когда операция вставки завершается ошибкой из-за конфликта с идентификатором документа. Это обновление выполняется службой как исправление, поэтому оно допускает частичное обновление документа. Другими словами, добавление новых свойств или замена существующего свойства выполняется последовательно. Тем не менее изменение значений свойств массива в документе JSON приводит к перезаписи всего массива, то есть массивы не объединяются.

Если входящий документ JSON содержит существующее поле идентификатора, это поле автоматически используется в качестве столбца идентификаторов документов в Cosmos DB и все последующие операции записи обрабатываются следующим образом:
- для уникальных идентификаторов выполняется вставка;
- если для повторяющихся идентификаторов и параметра Document ID задано значение "ID", выполняется операция upsert;
- если для повторяющихся идентификаторов и параметра Document ID не задано значение, после первого документа возникает ошибка.

Если вы хотите сохранить <i>все</i> документы, включая документы с повторяющимся идентификатором, переименуйте поле идентификатора в запросе (с ключевым словом AS) и разрешите Cosmos DB автоматически создавать поле идентификатора или заменять идентификатор значением из другого столбца (с помощью ключевого слова AS или с помощью параметра Document ID).

## <a name="data-partitioning-in-cosmos-db"></a>Секционирование данных в Cosmos DB
Режим [неограниченный](../cosmos-db/partition-data.md) для Azure Cosmos DB — это рекомендуемый способ секционирования данных, так как Azure Cosmos DB автоматически масштабирует разделы на основе рабочей нагрузки. При записи в неограниченные контейнеры Stream Analytics используются столько же параллельных модулей записи, сколько и на предыдущем шаге запроса или в схеме разбиения входных данных.
> [!Note]
> В настоящее время Azure Stream Analytics поддерживает только неограниченные коллекции с ключами разделов на верхнем уровне. Например, `/region` поддерживается. Вложенные ключи разделов (например, `/region/name`) не поддерживаются. 

Фиксированные коллекции Azure Cosmos DB Stream Analytics не позволяет увеличить или уменьшить, когда они уже полные. Верхний предел их пропускной способности: 10 ГБ и 10 000 ЕЗ/с.  Чтобы перенести данные из контейнера фиксированного размера в контейнер неограниченного размера (например, с ключом секции и пропускной способностью не менее 1000 ЕЗ/с), вам нужно использовать [средство миграции данных](../cosmos-db/import-data.md) или [библиотеку канала изменений](../cosmos-db/change-feed.md).

Запись в несколько фиксированных контейнеров устарела и не является рекомендуемым подходом для масштабирования вашего задания Stream Analytics. Подробные сведения об этом есть также в статье о [секционировании и масштабировании в Cosmos DB](../cosmos-db/sql-api-partition-data.md).

## <a name="cosmos-db-settings-for-json-output"></a>Параметры Cosmos DB для выходных данных JSON

При создании Cosmos DB как средства обработки выходных данных в Stream Analytics создается запрос информации, показанный ниже. В этом разделе объясняются определения свойств.

![экран выходных данных documentdb stream analytics](media/stream-analytics-documentdb-output/stream-analytics-documentdb-output-1.png)

|Поле           | ОПИСАНИЕ|
|-------------   | -------------|
|Псевдоним выходных данных    | Псевдоним для ссылки на эти выходные данные в запросе ASA.|
|Подписка    | Выберите подписку Azure.|
|Идентификатор учетной записи      | Имя или универсальный код ресурса (URI) конечной точки учетной записи Azure Cosmos DB.|
|Ключ учетной записи     | Общедоступный ключ доступа к учетной записи Azure Cosmos DB.|
|База данных        | Имя базы данных Azure Cosmos DB.|
|Шаблон имен коллекций | Имя для используемой коллекции. `MyCollection` — это пример допустимых входных данных; должна существовать одна коллекция с именем `MyCollection`.  |
|Идентификатор документа     | Необязательный элемент. Имя столбца в выходных событиях используется как уникальный ключ, на котором должны основываться операции вставки или обновления. Если оставить это поле пустым, все события будут вставлены, без возможности обновления.|
