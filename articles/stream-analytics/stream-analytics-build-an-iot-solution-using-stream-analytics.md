<properties 
	pageTitle="Создание решения IOT с помощью Stream Analytics | Microsoft Azure" 
	description="Учебник по началу работы с решением IOT Stream Analytics (сценарий с пунктом сбора платы)"
	keywords=""
	documentationCenter=""
	services="stream-analytics"
	authors="jeffstokes72" 
	manager="paulettm" 
	editor="cgronlun"
/>

<tags 
	ms.service="stream-analytics" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="data-services" 
	ms.date="02/18/2016" 
	ms.author="jeffstok"
/>

# Создание решения IOT с помощью Stream Analytics

## Введение

В этом учебнике содержатся инструкции по анализу данных в режиме реального времени с использованием Azure Stream Analytics. Служба потоковой обработки Azure позволяет разработчикам легко справляться с большими объемами постоянно меняющихся данных путем объединения потоков данных, таких как сведения о посещении, данные журналов, созданные устройствами события с историческими записями или справочные сведения, для легкого и быстрого получения бизнес-информации. Являясь полностью управляемой службой потоковой обработки в режиме реального времени, которая размещена на платформе Microsoft Azure, Azure Stream Analytics обеспечивает высокую надежность, малую задержку и масштабируемую обработку, что помогает приступить к работе за считанные минуты.

После работы с этим учебником вы сможете выполнить следующие задачи:

-   Изучить портал Azure Stream Analytics.
-   Настроить и развернуть задание потоковой передачи.
-   Сформулировать реальные проблемы и устранить их с помощью языка запросов Stream Analytics.
-   Уверенно разрабатывать решения потоковой передачи для клиентов с помощью Azure Streaming Analytics.
-   Использовать процедуры мониторинга и ведения журнала для устранения неполадок.

## Предварительные требования

Для успешного выполнения заданий в этом учебнике необходимо соблюсти следующие предварительные требования.

-   Последняя версия [Azure PowerShell](../powershell-install-configure.md)
-   Visual Studio 2015 или бесплатная версия [Visual Studio Community](https://www.visualstudio.com/products/visual-studio-community-vs.aspx)
-   [Подписка Azure](https://azure.microsoft.com/pricing/free-trial/)
-   Права администратора на компьютере
-   Скачайте [TollApp.zip](http://download.microsoft.com/download/D/4/A/D4A3C379-65E8-494F-A8C5-79303FD43B0A/TollApp.zip) из Центра загрузки Майкрософт.
-   Необязательно: исходный код генератора событий TollApp из [GitHub](https://github.com/streamanalytics/samples/tree/master/TollApp).

## Введение в сценарий "Hello, Toll!"


Станции сбора дорожной платы представляют собой распространенное явление — они встречаются на многих скоростных дорогах, мостах и туннелях по всему миру. Каждая станция имеет несколько пунктов, которые могут работать в ручном режиме, когда водитель останавливается и передает деньги служащему, или в автоматическом, когда размещенный на крыше пункта датчик сканирует RFID-карту, прикрепленную на ветровом стекле автомобиля, во время его проезда через пункт. Проезд автомобилей через станции сбора платы можно легко представить в виде потока событий, в котором выполняются интересные операции.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image1.jpg)

## Входящие данные

Мы будем работать с двумя потоками данных, создаваемыми датчиками, которые установлены на въездах и выездах станций сбора платы, и со статическим набором данных, содержащим данные регистрации транспортного средства.

### Входной поток данных

Входной поток данных содержит сведения об автомобилях, въезжающих на пункты сбора платы.
  
  
| ИД пункта сбора | Время въезда | LicensePlate | Состояние | Убедитесь, | Модель | Тип транспортного средства | Вес транспортного средства | Плата | Тег |
|---------|-------------------------|--------------|-------|--------|---------|--------------|----------------|------|-----------|
| 1 | 10\.09.2014 12:01:00.000 | JNB 7001 | Нью-Йорк | Honda | CRV | 1 | 0 | 7 | |
| 1 | 10\.09.2014 12:02:00.000 | YXZ 1001 | Нью-Йорк | Toyota | Camry | 1 | 0 | 4 | 123456789 |
| 3 | 10\.09.2014 12:02:00.000 | ABC 1004 | CT | Ford | Taurus | 1 | 0 | 5 | 456789123 |
| 2 | 10\.09.2014 12:03:00.000 | XYZ 1003 | CT | Toyota | Corolla | 1 | 0 | 4 | |
| 1 | 10\.09.2014 12:03:00.000 | BNJ 1007 | Нью-Йорк | Honda | CRV | 1 | 0 | 5 | 789123456 |
| 2 | 10\.09.2014 12:05:00.000 | CDE 1007 | Нью-Джерси | Toyota | 4x4 | 1 | 0 | 6 | 321987654 |
  

Далее приведено краткое описание столбцов:
  
  
| ИД пункта сбора | ИД пункта взимания дорожного сбора, однозначно идентифицирующий пункт сбора |
|--------------|----------------------------------------------------------------|
| Время въезда | Дата и время въезда транспортного средства на пункт сбора платы в формате UTC |
| LicensePlate | Номерной знак транспортного средства |
| Состояние | Штат в США |
| Убедитесь, | Изготовитель транспортного средства |
| Модель | Номер модели транспортного средства |
| Тип транспортного средства | 1 — для пассажирского и 2 — для коммерческого транспорта |
| Тип веса | Вес транспортного средства в тоннах. 0 — для пассажирского транспорта. |
| Плата | Значение платы в долларах США |
| Тег | Электронная метка на автомобиле для автоматической оплаты. Пустая метка, если оплата осуществляется вручную. |


### Выходной поток данных

Выходной поток данных содержит сведения об автомобилях, выезжающих из пунктов сбора платы.
  
  
| **ИД пункта сбора** | **Время выезда** | **LicensePlate** |
|------------|------------------------------|------------------|
| 1 | 10\.09.2014T12:03:00.0000000Z | JNB 7001 |
| 1 | 10\.09.2014T12:03:00.0000000Z | YXZ 1001 |
| 3 | 10\.09.2014T12:04:00.0000000Z | ABC 1004 |
| 2 | 10\.09.2014T12:07:00.0000000Z | XYZ 1003 |
| 1 | 10\.09.2014T12:08:00.0000000Z | BNJ 1007 |
| 2 | 10\.09.2014T12:07:00.0000000Z | CDE 1007 |

Далее приведено краткое описание столбцов:
  
  
| столбец | Описание |
|--------------|-----------------------------------------------------------------|
| ИД пункта сбора | ИД пункта взимания дорожного сбора, однозначно идентифицирующий пункт сбора |
| Время выезда | Дата и время выезда транспортного средства с пункта сбора платы в формате UTC |
| LicensePlate | Номерной знак транспортного средства |

### Данные регистрации коммерческого транспортного средства

Мы будем использовать статический снимок базы данных регистрации коммерческих транспортных средств.
  
  
| LicensePlate | ИД регистрации | Срок действия истек |
|--------------|----------------|---------|
| SVT 6023 | 285429838 | 1 |
| XLZ 3463 | 362715656 | 0 |
| BAC 1005 | 876133137 | 1 |
| RIV 8632 | 992711956 | 0 |
| SNY 7188 | 592133890 | 0 |
| ELH 9896 | 678427724 | 1 |                      

Далее приведено краткое описание столбцов:
  
  
| столбец | Описание |
|--------------|-----------------------------------------------------------------|
| LicensePlate | Номерной знак транспортного средства |
| ИД регистрации | ИД регистрации |
| Срок действия истек | 0 — если регистрация транспортного средства действительна. 1 — если срок регистрации истек. |


## Настройка среды для Azure Stream Analytics

Для работы с этим учебником вам потребуется подписка Microsoft Azure. Корпорация Майкрософт предлагает бесплатную пробную версию служб Microsoft Azure, как описано ниже.

Если у вас нет учетной записи Azure, вы можете получить бесплатную пробную версию, перейдя к <http://azure.microsoft.com/pricing/free-trial/>.

Примечание. Чтобы зарегистрироваться для получения бесплатной пробной версии, потребуется мобильное устройство, которое может принимать текстовые сообщения, и действительная кредитная карта.

Обязательно выполните шаги в разделе "Очистка учетной записи Azure" в конце этого упражнения, чтобы максимально эффективно использовать 200 долл. США на счете Azure.

## Подготовка ресурсов Azure, необходимых для работы с учебником

В этом учебнике требуется 2 концентратора событий для получения потоков данных: "Въезд" и "Выезд". Для вывода результатов выполнения заданий Stream Analytics мы будем использовать базу данных SQL Azure. Для хранения справочных данных о регистрации транспортных средств мы будем использовать хранилище Azure.

Для создания всех необходимых ресурсов можно использовать сценарий Setup.ps1 в папке TollApp на сайте GitHub. Его рекомендуется выполнить для экономии времени. Если вы хотите узнать больше о настройке этих ресурсов на портале Azure, см. приложение "Настройка ресурсов для учебника на портале Azure".

Скачайте и сохраните вспомогательную папку [TollApp](http://download.microsoft.com/download/D/4/A/D4A3C379-65E8-494F-A8C5-79303FD43B0A/TollApp.zip) и файлы.

Откройте окно "Microsoft Azure PowerShell" **ОТ ИМЕНИ АДМИНИСТРАТОРА**. Если у вас нет Azure PowerShell, следуйте инструкциям по установке в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md).

Windows автоматически блокирует файлы PS1, DLL и EXE, скачанные из Интернета. Перед выполнением сценария необходимо задать политику выполнения. Убедитесь, что окно Azure PowerShell открыто от имени администратора. Выполните команду "Set-ExecutionPolicy unrestricted". При появлении запроса введите "Y".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image2.png)

Выполните "Get-ExecutionPolicy", чтобы убедиться, что команда сработала.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image3.png)

Перейдите в каталог, где находятся сценарии и приложение генератора.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image4.png)

Введите ".\\Setup.ps1", чтобы настроить учетную запись Azure, создать и настроить все необходимые ресурсы и приступить к созданию событий. Сценарий случайным образом выберет регион для создания ресурсов. Если вы хотите указать регион явным образом, можно передать параметр "-location", как показано в примере ниже.

**\\Setup.ps1 -location "Центральная часть США"**

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image5.png)

Сценарий откроет страницу входа в Microsoft Azure. Введите свои учетные данные.

Обратите внимание, что если у вас есть доступ к нескольким подпискам, вам будет предложено ввести имя подписки, которая будет использоваться для работы с заданиями учебника.

Выполнение сценария может занять несколько минут. После его завершения выходные данные должны выглядеть, как показано на снимке экрана ниже.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image6.PNG)

Также появится еще одно окно, аналогичное приведенному ниже. Это приложение отправляет события в ваш концентратор событий и требуется для запуска заданий из учебника. Поэтому до завершения работы с учебником приложение должно работать, а окно — оставаться открытым.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image7.png)

Теперь вы можете увидеть все созданные ресурсы на портале управления Azure. Перейдите к <https://manage.windowsazure.com> и войдите с использованием своих учетных данных.

### Концентраторы событий

Щелкните пункт меню "Служебная шина" в левой части портала управления Azure, чтобы просмотреть концентраторы событий, созданные сценарием из предыдущего раздела.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image8.png)

Вы увидите все доступные пространства имен в вашей подписке. Щелкните то, которое начинается с "TollData". (В нашем примере — TollData4637388511.) Перейдите на вкладку "Концентраторы событий".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image9.png)

В этом пространстве имен вы увидите два созданных концентратора событий с именами *entry* и *exit*.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image10.png)

### Контейнер хранилища Azure

Щелкните пункт меню "Хранилище" в левой части портала управления Azure, чтобы увидеть контейнер хранилища, используемый в лабораторной среде.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image11.png)

Щелкните тот, который начинается с "tolldata" (в нашем примере — tolldata4637388511). Откройте вкладку "Контейнеры", чтобы увидеть созданный контейнер.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image12.png)

Щелкните контейнер "tolldata", чтобы увидеть отправленный JSON-файл с данными регистрации транспортных средств.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image13.png)

### База данных SQL Azure

Щелкните пункт меню "Базы данных SQL" в левой части портала управления Azure, чтобы увидеть базу данных SQL Azure, которая будет использоваться в лабораторной среде.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image14.png)

Щелкните "TollDataDB".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image15.png)

Скопируйте имя сервера без номера порта (например, *имя\_сервера*.database.windows.net).

## Подключение к базе данных из Visual Studio

Мы будем использовать Visual Studio для доступа к результатам запроса в выходной базе данных.

Подключитесь к базе данных Azure (целевой) из Visual Studio.

1) Откройте Visual Studio, выберите "Инструменты", а затем — "Подключение к базе данных".

2) При запросе выберите "Microsoft SQL Server" в качестве источника данных.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image16.png)

3) В поле "Имя сервера" вставьте имя SQL Server, скопированное в предыдущем разделе на портале Azure (т. е. *имя\_сервера*.database.windows.net).

4) В поле "Проверка подлинности" выберите "Проверка подлинности SQL Server".

5) В качестве имени входа введите "tolladmin", а в качестве пароля — "123toll!".

6) В качестве базы данных выберите TollDataDB.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image17.jpg)
    
7) Нажмите кнопку "ОК".

8) Откройте обозреватель серверов.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image18.png)
  
9) См. 4 таблицы, созданные в базе данных TollDataDB.
  
![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image19.jpg)
  
## Генератор событий — пример проекта TollApp

Сценарий PowerShell автоматически начинает отправку событий, используя пример приложения TollApp. Никаких дополнительных действий выполнять не нужно.

Однако если вас интересуют подробности реализации, вы можете найти исходный код приложения TollApp на сайте GitHub в разделе [samples/TollApp](https://github.com/streamanalytics/samples/tree/master/TollApp).

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image20.png)

##Создание задания Stream Analytics

На портале Azure откройте Stream Analytics и нажмите кнопку "Создать" в левом нижнем углу страницы, чтобы создать задание аналитики.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image21.png)

Щелкните "Быстрое создание". Выберите тот же регион, где с помощью сценария создаются другие ресурсы.

Для параметра "Учетная запись хранения регионального мониторинга" выберите "Создать учетную запись хранения" и присвойте ей любое уникальное имя. С помощью этой учетной записи Azure Stream Analytics будет хранить сведения о наблюдении за всеми последующими заданиями.

В нижней части страницы щелкните "Создать задание Stream Analytics".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image22.png)

## Определение источников входных данных

На портале щелкните созданное задание аналитики.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image23.jpg)

Откройте вкладку "Входные данные", чтобы определить источник данных.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image24.jpg)

Нажмите кнопку "Добавить входные данные".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image25.png)

На первой странице выберите "Поток данных".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image26.png)

На второй странице мастера выберите "Концентратор событий".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image27.png)

В качестве псевдонима входных данных введите "EntryStream".

Щелкните раскрывающийся список "Концентратор событий" и выберите концентратор, начинающийся с "TollData" (например: TollData9518658221).

Выберите "entry" в качестве имени концентратора событий и "all" в качестве имени политики концентратора событий.

Настройки будут выглядеть следующим образом:

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image28.png)

Перейдите на следующую страницу. Выберите значения в формате JSON с кодировкой UTF8.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image29.png)

Чтобы завершить работу мастера, нажмите кнопку "ОК" в нижней части диалогового окна.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image30.jpg)

Выполните ту же последовательность действий, чтобы создать входные данные концентратора событий для потока с событиями "Выезд". Убедитесь, что на 3-й странице введены значения, показанные на снимке экрана ниже.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image31.png)

Теперь у вас определены два потока входных данных.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image32.jpg)

Далее мы добавим входные данные "Справочные данные" для файла большого двоичного объекта с данными регистрации автомобиля.

Щелкните "Добавить входные данные". Выберите "Справочные данные".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image33.png)

На следующей странице выберите учетную запись хранения, которая начинается с "tolldata". Контейнер должен иметь имя "tolldata", а большой двоичный объект в шаблоне пути — "registration.json". Имя файла зависит от регистра и должно быть введено строчными буквами.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image34.png)

Выберите значения, как показано ниже, на следующей странице, и нажмите кнопку "ОК", чтобы завершить работу мастера.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image35.png)

Все входные данные определены.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image36.jpg)

## Определение выходных данных

Перейдите на вкладку "Выходные данные" и нажмите кнопку "Добавить выходные данные".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image37.jpg)

Выберите "База данных SQL".

Выберите имя сервера, которое использовалось в разделе "Подключение к базе данных из Visual Studio". База данных должна иметь имя "TollDataDB".

Введите "tolladmin" в качестве имени пользователя и "123toll!" в качестве пароля. Для имени таблицы задайте "TollDataRefJoin".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image38.jpg)

## Запрос в службе Azure Stream Analytics

Вкладка "Запрос" содержит запрос SQL, который выполняет преобразование входящих данных.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image39.jpg)

В этом учебнике мы попытаемся ответить на несколько бизнес-вопросов, связанных с данными платы, и построим запросы Stream Analytics, используемые в Azure Stream Analytics для нахождения нужного ответа.

Прежде чем приступить к первому заданию Azure Stream Analytics, давайте рассмотрим некоторые сценарии и синтаксис запроса.

## Общие сведения о языке запросов Azure Stream Analtyics
-----------------------------------------------------

Допустим, нам нужно подсчитать количество автомобилей, въезжающих на пункт сбора платы. Поскольку это непрерывный поток событий, нам важно определить "период времени". Поэтому наш вопрос должен выглядеть следующим образом: "Количество автомобилей, въезжающих на пункт сбора платы каждые 3 минуты". Это количество часто называют "переворачивающимся".

Давайте взглянем на запрос Azure Stream Analytics, которые отвечает на этот вопрос.

    SELECT TollId, System.Timestamp AS WindowEnd, COUNT(*) AS Count
    FROM EntryStream TIMESTAMP BY EntryTime
    GROUP BY TUMBLINGWINDOW(minute, 3), TollId

Как видно, Azure Stream Analytics использует язык запросов, подобный SQL, с несколькими дополнительными расширениями для включения аспектов задания времени.

Дополнительные сведения об используемых в запросах конструкциях [Управление временем](https://msdn.microsoft.com/library/azure/mt582045.aspx) и [Оконные расширения](https://msdn.microsoft.com/library/azure/dn835019.aspx) см. на сайте MSDN.

## Тестирование запросов в службе Azure Stream Analytics

Теперь, когда мы написали наш первый запрос Azure Stream Analytics, настало время его тестирования с помощью файлов-примеров, расположенных в папке TollApp по указанному ниже пути:

**..\\TollApp\\TollApp\\Data**

Эта папка содержит следующие файлы:

1.  Entry.json

2.  Exit.json

3.  Registration.json

## Вопрос 1. Количество автомобилей, въезжающих в пункт сбора платы

Откройте портал управления Azure и перейдите к созданному заданию Azure Stream Analytics. Откройте вкладку "Запрос" и вставьте запрос, скопированный из предыдущего раздела.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image40.png)

Чтобы сверить этот запрос с образцом данных, нажмите кнопку "Тестировать". В открывшемся окне перейдите к файлу Entry.json (образец данных из потока событий EntryTime).

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image41.png)

Убедитесь, что отображаются нужные результаты запроса.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image42.jpg)

## Вопрос 2. Общее время, затрачиваемое каждым автомобилем на проезд через пункт сбора платы

Мы хотим узнать среднее время, необходимое для проезда через пункт сбора платы, чтобы оценить эффективность и качество обслуживания.

Для этого необходимо присоединить поток, содержащий EntryTime, к потоку, содержащему ExitTime. Потоки будут объединены по столбцам TollId и LicencePlate. Для использования оператора JOIN требуется указать запас, описывающий допустимую разницу во времени между объединенными событиями. Мы будем использовать функцию DATEDIFF, чтобы указать, что события должны происходить с интервалом не более 15 минут. Мы также применим функцию DATEDIFF к значениям времени въезда и выезда для вычисления фактического времени, проводимого автомобилем в пункте оплаты. Обратите внимание на различия использования DATEDIFF при применении в инструкции SELECT по сравнению с условием JOIN.

    SELECT EntryStream.TollId, EntryStream.EntryTime, ExitStream.ExitTime, EntryStream.LicensePlate, DATEDIFF (minute , EntryStream.EntryTime, ExitStream.ExitTime) AS DurationInMinutes
    FROM EntryStream TIMESTAMP BY EntryTime
    JOIN ExitStream TIMESTAMP BY ExitTime
    ON (EntryStream.TollId= ExitStream.TollId AND EntryStream.LicensePlate = ExitStream.LicensePlate)
    AND DATEDIFF (minute, EntryStream, ExitStream ) BETWEEN 0 AND 15

Чтобы протестировать этот запрос, обновите запрос на вкладке "Запрос" задания.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image43.jpg)

Щелкните "Тестировать" и укажите образцы входных файлов для EntryTime и ExitTime.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image44.png)

Установите флажок, чтобы проверить запрос и просмотреть выходные данные.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image45.png)

## Вопрос 3. Сообщать обо всех коммерческих транспортных средствах с истекшим сроком действия регистрации

Azure Stream Analytics может использовать статические снимки данных для объединения с потоками временных данных. Чтобы продемонстрировать эту возможность, мы будем использовать следующий пример вопроса.

Если коммерческое транспортное средство зарегистрировано в компании автодорожных сборов, оно может проезжать через пункт оплаты без остановки для проверки. Для выявления всех коммерческих транспортных средств с истекшим сроком действия регистрации мы будем использовать таблицу подстановки "Регистрация коммерческих транспортных средств".

    SELECT EntryStream.EntryTime, EntryStream.LicensePlate, EntryStream.TollId, Registration.RegistrationId
    FROM EntryStream TIMESTAMP BY EntryTime
    JOIN Registration
    ON EntryStream.LicensePlate = Registration.LicensePlate
    WHERE Registration.Expired = '1'

Обратите внимание, что для тестирования запроса с использованием справочных данных требуется определить источник входных данных для справочных данных (что было сделано на шаге 5).

Чтобы протестировать этот запрос, вставьте запрос на вкладку "Запрос", щелкните "Тестировать" и укажите 2 источника входных данных:

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image46.png)

Просмотрите результаты запроса.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image47.png)

## Запуск задания Stream Analytics


После написания первого запроса Azure Stream Analytics можно завершить конфигурацию и запустить задание. Сохраните запрос из вопроса 3. Будут созданы выходные данные, которые соответствуют схеме таблицы выходных данных **TollDataRefJoin**.

Перейдите на панель мониторинга задания и нажмите кнопку "Запустить".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image48.jpg)

В открывшемся диалоговом окне измените время начала вывода на настраиваемое время. В качестве часа задайте значение часа назад. Это гарантирует обработку всех событий из концентратора событий с момента создания событий в начале этого учебника. Установите флажок, чтобы запустить задание.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image49.png)

Запуск задания может занять несколько минут. Состояние отображается на странице верхнего уровня для Stream Analytics.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image50.jpg)

## Проверка результатов в Visual Studio

Откройте обозреватель серверов Visual Studio и щелкните правой кнопкой мыши таблицу TollDataRefJoin. Выберите "Показать данные таблицы" для просмотра выходных данных задания.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image51.jpg)

## Масштабирование заданий в службе Azure Stream Analytics

Azure Stream Analytics поддерживает масштабируемость и позволяет обрабатывать большие объемы данных. С помощью предложения **PARTITION BY** служба Azure Stream Analytics указывает системе, что на этом шаге будет выполняться масштабирование. PartitionId — это специальный, добавленный системой столбец, который совпадает с идентификатором раздела входных данных (концентратора событий).

    SELECT TollId, System.Timestamp AS WindowEnd, COUNT(*)AS Count
    FROM EntryStream TIMESTAMP BY EntryTime PARTITION BY PartitionId
    GROUP BY TUMBLINGWINDOW(minute,3), TollId, PartitionId    

Остановите текущее задание, обновите запрос на вкладке "Запрос" и откройте вкладку "Масштаб".

Единицы потоковой передачи определяют объем вычислительной мощности, которую может получать задание.

Передвиньте ползунок в положение 6.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image52.jpg)

Перейдите на вкладку "Выходные данные" и измените имя таблицы SQL на "TollDataTumblingCountPartitioned".

Теперь при запуске задания Azure Stream Analytics будет распределять нагрузку среди большего количества вычислительных ресурсов и сможет улучшить производительность. Обратите внимание, что приложение TollApp также отправляет события, секционированные по TollId.

## Мониторинг

Вкладка "Мониторинг" содержит статистические данные по выполнению задания.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image53.png)

С вкладки "Панель мониторинга" можно получить доступ к журналам операций.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image54.jpg)

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image55.png)

Чтобы просмотреть дополнительные сведения об определенном событии, выберите событие и нажмите кнопку "Сведения".

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image56.png)

## Заключение

В этом учебнике мы привели общие сведения о службе Azure Stream Analytics. Мы показали, как настроить входные и выходные данные для задания Stream Analytics. На основе сценария "Данные о сборе платы" мы узнали о распространенных проблемах, возникающих в среде передачи данных, и способах их устранения с помощью простых запросов SQL в службе Azure Stream Analytics. Мы описали конструкции расширений SQL для работы с временными данными. Было показано, как объединить потоки данных, как дополнить поток данных статическими справочными сведениями. Мы рассмотрели масштабирование запросов для достижения более высокой пропускной способности.

Несмотря на то, что в этом учебнике хорошо представлена вступительная информация, он является далеко не полным. Дополнительные шаблоны запросов на языке SQL можно найти [здесь](stream-analytics-stream-analytics-query-patterns.md). Дополнительные сведения об Azure Stream Analytics см. в [документации в Интернете](https://azure.microsoft.com/documentation/services/stream-analytics/).

## Очистка учетной записи Azure

Остановите выполнение задания Stream Analytics с портала Azure.

Сценарий Setup.ps1 создаст 2 концентратора событий и сервер базы данных SQL Azure. Следующие инструкции предназначены для удаления ресурсов по завершении изучения этого учебника.

В окне PowerShell введите ".\\Cleanup.ps1". Будет запущен сценарий, который удалит ресурсы, используемые в этом учебнике.

Обратите внимание, что ресурсы идентифицируются по имени. Убедитесь, что перед подтверждением удаления вы внимательно просмотрели каждый элемент.

![](media/stream-analytics-build-an-iot-solution-using-stream-analytics/image57.png)

<!---HONumber=AcomDC_0224_2016-->