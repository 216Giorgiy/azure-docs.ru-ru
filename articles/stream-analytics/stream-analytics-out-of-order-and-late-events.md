---
title: "Обработка порядка событий и просрочки с помощью Azure Stream Analytics | Документация Майкрософт"
description: "Узнайте об обработке неупорядоченных или поздних событий в потоках данных Stream Analytics."
keywords: "не по порядку, поздний, события"
documentationcenter: 
services: stream-analytics
author: jseb225
manager: jhubbard
editor: cgronlun
ms.assetid: 
ms.service: stream-analytics
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: data-services
ms.date: 04/20/2017
ms.author: jeanb
ms.openlocfilehash: 208dfa14d5d18e106d654539cd80bafdeb90cdf8
ms.sourcegitcommit: 80eb8523913fc7c5f876ab9afde506f39d17b5a1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2017
---
# <a name="azure-stream-analytics-event-order-consideration"></a>Рассмотрение порядка событий Azure Stream Analytics

## <a name="understand-arrival-time-and-application-time"></a>Анализ времени получения и времени приложения

В потоке временных данных событий каждому событию присваивается метка времени. Azure Stream Analytics присваивает каждому событию метку времени, используя время получения или время приложения. В столбце System.Timestamp указана метка времени, присвоенная событию. Время получения присваивается в источнике входных данных, когда событие достигает источника. Время получения — это значение свойства EventEnqueuedTime для входных данных концентратора событий и [время последнего изменения большого двоичного объекта](https://docs.microsoft.com/en-us/dotnet/api/microsoft.windowsazure.storage.blob.blobproperties.lastmodified?view=azurestorage-8.1.3) для входных данных большого двоичного объекта. Время приложения присваивается при создании события и является частью полезных данных. Для обработки событий по времени приложения используйте предложение "Timestamp by" в запросе SELECT. Если предложение "Timestamp by" отсутствует, то события обрабатываются по времени получения. Доступ ко времени получения можно получить с помощью свойства EventEnqueuedTime для концентратора событий и свойства BlobLastModified для входных данных большого двоичного объекта. Azure Stream Analytics создает выходные данные в порядке меток времени и предоставляет несколько параметров для работы с неупорядоченными данными.


## <a name="azure-stream-analytics-handling-of-multiple-streams"></a>Azure Stream Analytics: обработка нескольких потоков

Задание Azure Stream Analytics объединяет события из нескольких временных шкал в нескольких случаях. В их числе:

* Создание выходных данных из нескольких разделов. Запросы без явного разделения по PartitionId должны были бы объединять события из всех разделов.
* Объединение двух или более различных источников входных данных.
* Присоединение источников входных данных.

В сценариях, где объединены несколько временных шкал, Azure Stream Analytics будет выдавать выходные данные для метки времени *t1* только после того, как все объединенные источники достигнут времени *t1*.
Например, если запрос считывает данные из раздела *концентратора событий* с двумя разделами и в одном из разделов *P1* есть события до времени *t1*, а другом разделе *P2* есть события до времени *t1 + x*, выходные данные выводятся до времени *t1*.
Однако если явно указано предложение *"Разделение по PartitionId"*, оба раздела работают независимо друг от друга.
Установка допустимого интервала поступления с задержкой используется для устранения проблем при отсутствии данных в некоторых разделах.

## <a name="configuring-late-arrival-tolerance-and-out-of-order-tolerance"></a>Настройка допустимого интервала поступления с задержкой и интервала для событий, полученных в неправильном порядке
С неупорядоченными входными потоками происходит одно из следующих событий:
* сортировка (и, следовательно, **удаление**);
* корректировка системой с учетом пользовательской политики.

При обработке по **времени приложения** Stream Analytics допускает неупорядоченные события и события, поступившие с задержкой. На портале Azure в разделе **Упорядочение событий** доступны следующие параметры: 

![Обработка событий Stream Analytics](media/stream-analytics-event-handling/stream-analytics-event-handling.png)

**Допустимый интервал поступления с задержкой**
* Эта настройка применяется только при обработке по времени приложения. В ином случае она игнорируется.
* Это максимальная разница между временем получения и временем приложения. Если время приложения предшествует значению (время получения – интервал поступления с задержкой), то ему присваивается значение (время получения – интервал поступления с задержкой).
* Если одновременно используется несколько секций из одного входного потока или нескольких входных потоков, то допустимый интервал поступления с задержкой является максимальным временем, которое каждая секция ожидает поступления новых данных. 

Если коротко, то интервал поступления с задержкой — это максимальная задержка между созданием события и его получением в источнике входных данных.
Сначала выполняется корректировка на основе допустимого интервала поступления с задержкой, а затем корректируются события, полученные в неправильном порядке. В столбце **System.Timestamp** будет указана конечная метка времени, присвоенная событию.

**Интервал для событий, полученных в неправильном порядке**
* Последовательность событий, полученных в неправильном порядке, но в пределах заданного "интервала для событий, полученных в неправильном порядке", **корректируется по метке времени**. 
* События, поступающие позже допустимого, **удаляются или корректируются**.
    * **Корректировка** предполагает изменение значения времени к крайнему допустимому. 
    * **Удаление** предполагает удаление.

Чтобы изменить последовательность событий, полученных в пределах "интервала для событий, полученных в неправильном порядке", выходные данные запроса **задерживаются на такой же интервал**.

**Пример**

* Допустимый интервал поступления с задержкой = 10 минут.<br/>
* Интервал для событий, полученных в неправильном порядке = 3 минуты<br/>
* Обработка по времени приложения<br/>
* События:
   * Событие 1. _Время приложения_ = 00:00:00, _время получения_ = 00:10:01, _System.Timestamp_ = 00:00:01, корректируется, так как значение (_время прибытия_ - _время приложения_) больше, чем допустимый интервал поступления с задержкой.
   * Событие 2. _Время приложения_ = 00:00:01, _время получения_ = 00:10:01, _System.Timestamp_ = 00:00:01, не корректируется, так как время приложения входит в интервал поступления с задержкой.
   * Событие 3. _Время приложения_ = 00:10:00, _время получения_ = 00:10:02, _System.Timestamp_ = 00:10:00, не корректируется, так как время приложения входит в интервал поступления с задержкой.
   * Событие 4. _Время приложения_ = 00:09:00, _время получения_ = 00:10:03, _System.Timestamp_ = 00:09:00, принимается с исходной меткой времени, так как время приложения входит в допустимый интервал для событий, полученных в неправильном порядке.
   * Событие 5. _Время приложения_ = 00:06:00, _время получения_ = 00:10:04, _System.Timestamp_ = 00:07:00, корректируется, так как время приложения раньше интервала для событий, полученных в неправильном порядке.

## <a name="practical-considerations"></a>Практические рекомендации
*Допустимый интервал поступления с задержкой* — это максимальная разница между временем приложения и временем получения.
Кроме того, события, которые прибыли позже, чем настроенный *допустимый интервал поступления с задержкой*, при обработке по времени приложения корректируются до применения параметра *интервала для событий, полученных в неправильном порядке*. Таким образом эффективный интервал для событий, полученных в неправильном порядке, — это минимальная разница между допустимым интервалом поступления с задержкой и интервалом для событий, полученных в неправильном порядке.

Причины поступления неупорядоченных событий в потоке включают следующие:
* Разница в показаниях часов между отправителями.
* Переменная задержка между отправителем и источником входных событий.

События приходят с опозданием по следующим причинам:
* На протяжении интервала отправляется пакет событий.
* Задержка между отправкой события и получением события на источнике входных данных.

При настройке *допустимого интервала поступления с задержкой* и *интервала для событий, полученных в неправильном порядке*, для конкретного задания следует учитывать правильность, требования к задержке и вышеперечисленные факторы.

Ниже приводятся несколько примеров.

### <a name="example-1"></a>Пример 1 
Запрос содержит предложение "Разделение по PartitionId" и в пределах одного раздела события отправляются с помощью методов синхронной отправки. Синхронные методы отправки блокируются до тех пор, пока события не будут отправлены.
В этом случае неупорядочение равно нулю, так как события отправляются в порядке с явным подтверждением перед отправкой следующего события. Позднее прибытие — это максимальная задержка между генерированием события и отправкой события, а также максимальная задержка между отправителем и источником входных данных.

### <a name="example-2"></a>Пример 2
Запрос содержит предложение "Разделение по PartitionId" и в пределах одного раздела события отправляются с помощью методов асинхронной отправки. Методы асинхронной отправки могут инициировать несколько отправлений одновременно, что может привести к неупорядоченным событиям.
В этом случае интервал для событий, полученных в неправильном порядке, и опоздание — это максимальная задержка между генерированием события и отправкой события, а также максимальная задержка между отправителем и источником входных данных.

### <a name="example-3"></a>Пример 3
В запросе нет предложения "Разделение по PartitionId" и существует по крайней мере два раздела.
Конфигурация та же, что и в примере 2. Однако отсутствие данных в одном из разделов может задержать выходные данные с учетом значения дополнительного допустимого интервала поступления с задержкой.

## <a name="to-summarize"></a>Итог
* Допустимый интервал поступления с задержкой и период поступления неупорядоченных событий должны настраиваться с учетом правильности, требований к задержке и способа отправки событий.
* Мы рекомендуем настроить интервал для событий, полученных в неправильном порядке, меньше, чем допустимый интервал поступления с задержкой.
* При объединении нескольких временных шкал отсутствие данных в одном из источников или разделов может задержать выходные данные с учетом значения дополнительного допустимого интервала поступления с задержкой.

## <a name="get-help"></a>Получение справки
Дополнительную помощь вы можете получить на нашем [форуме Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureStreamAnalytics).

## <a name="next-steps"></a>Дальнейшие действия
* [Что такое Stream Analytics?](stream-analytics-introduction.md)
* [Приступая к работе с Azure Stream Analytics: выявление мошенничества в режиме реального времени](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md)
* [Stream Analytics Query Language Reference](https://msdn.microsoft.com/library/azure/dn834998.aspx) (Справочник по языку запросов Stream Analytics)
* [Stream Analytics management REST API reference](https://msdn.microsoft.com/library/azure/dn835031.aspx) (Справочник по API-интерфейсу REST для управления Stream Analytics)
