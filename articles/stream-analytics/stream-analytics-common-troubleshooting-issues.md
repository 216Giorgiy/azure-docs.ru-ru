---
title: Устранение неполадок в случае неправильного формата входных событий в Azure Stream Analytics
description: Как определить, какое событие во входных данных вызывает проблему в задании Stream Analytics
services: stream-analytics
author: jasonwhowell
manager: Kfile
ms.author: jasonh
ms.reviewer: jasonh
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 03/05/2018
ms.openlocfilehash: fcbb03b4d9aed797cf99c374661c743d39f81276
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="common-issues-in-stream-analytics-and-steps-to-troubleshoot"></a>Распространенные проблемы в Stream Analytics и инструкции по их устранению

## <a name="troubleshoot-for-malformed-input-events"></a>Устранение неполадок в случае неправильного формата входных событий

Если входной поток задания Stream Analytics содержит сообщения неправильного формата, возникают проблемы сериализации. К сообщениям неправильного формата относятся случаи неверной сериализации, например отсутствие скобок в объекте JSON или неверный формат метки времени. Когда задание Stream Analytics получает неправильно сформированное сообщение, это сообщение отклоняется, а пользователь получает предупреждение. Символ предупреждения появляется на плитке **Входные данные** задания Stream Analytics (он отображается, пока задание находится в рабочем состоянии):

![Плитка "Входные данные"](media/stream-analytics-malformed-events/inputs_tile.png)

Чтобы просмотреть сведения предупреждения, вы можете включить журналы диагностики. Для входных событий неправильного формата в журналах выполнения создается запись о том, что не удалось выполнить десериализацию входных событий JSON из ресурса <blob URI>. 

### <a name="troubleshooting-steps"></a>Действия по устранению неполадок

1. Перейдите к плитке входных данных и щелкните ее, чтобы просмотреть предупреждения.
2. На плитке сведений о входных данных отображается набор предупреждений с подробными сведениями о проблеме. Ниже приведен пример предупреждающего сообщения, в котором отображаются раздел, смещение и порядковые номера с данными JSON неправильного формата. 

   ![Предупреждающее сообщение со смещением](media/stream-analytics-malformed-events/warning_message_with_offset.png)

3. Чтобы получить данные JSON, которые были представлены в неправильном формате, запустите код CheckMalformedEvents.cs. Его можно найти в [репозитории примеров GitHub](https://github.com/Azure/azure-stream-analytics/tree/master/Samples/CheckMalformedEventsEH). При помощи этого кода считываются идентификатор раздела и смещение, а затем выводятся данные для этого смещения. 

4. После считывания данных можно проанализировать и исправить формат сериализации. 

## <a name="handling-duplicate-records-when-using-azure-sql-database-as-output-for-a-stream-analytics-job"></a>Обработка повторяющихся записей при использовании службы "База данных SQL Azure"для выходных данных задания Stream Analytics

При настройке службы "База данных SQL Azure" для выходных данных задания Stream Analytics выполняется массовая вставка записей в целевую таблицу. Обычно Azure Stream Analytics гарантирует [по крайней мере однократную доставку]( https://msdn.microsoft.com/azure/stream-analytics/reference/event-delivery-guarantees-azure-stream-analytics) в приемник выходных данных. Но можно обеспечить и [исключительно однократную доставку]( https://blogs.msdn.microsoft.com/streamanalytics/2017/01/13/how-to-achieve-exactly-once-delivery-for-sql-output/) для выходных данных SQL. Для этого в таблице SQL нужно определить уникальное ограничение. 

Когда в таблице SQL, содержащей повторяющиеся записи, будут установлены уникальные ограничения ключей, в Azure Stream Analytics удаляется повторяющаяся запись. Для этого данные разбиваются на пакеты и пакеты рекурсивно вставляются, пока не будет обнаружена такая запись. Если в конвейере значительное число повторяющихся строк, разделение и рекурсивная поочередная вставка данных с пропуском повторяющихся записей занимает много времени. Если в журнале действий в течение последнего часа отображается несколько предупреждающих сообщений о нарушении ключа, вполне вероятно, что обработка выходных данных SQL замедляет выполнение всего задания. Чтобы устранить эту проблему, нужно [настроить индекс]( https://docs.microsoft.com/sql/t-sql/statements/create-index-transact-sql), который вызывает нарушение ключа, включив параметр IGNORE_DUP_KEY. Этот параметр позволяет пропускать в SQL повторяющиеся значения при массовой вставке. В таком случае в SQL Azure вместо сообщения об ошибке отображается предупреждающее сообщение. Azure Stream Analytics больше не создают сообщения об ошибке при нарушении первичного ключа.

Если IGNORE_DUP_KEY настраивается для нескольких типов индексов, обратите внимание на следующее:

* IGNORE_DUP_KEY нельзя установить для первичного ключа или уникального ограничения, в котором используется ALTER INDEX. Индекс нужно удалить и создать повторно.  
* Вы можете задать параметр IGNORE_DUP_KEY для уникального индекса при помощи ALTER INDEX. Это ограничение отличается от PRIMARY KEY или UNIQUE и создается с использованием определения CREATE INDEX или INDEX.  
* IGNORE_DUP_KEY не применяется к индексам хранилища столбцов, так как нельзя обеспечить уникальность таких индексов.  

## <a name="next-steps"></a>Дополнительная информация

* [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)

