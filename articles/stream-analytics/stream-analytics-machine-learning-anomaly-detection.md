---
title: "Руководство по обнаружению аномалий в Azure (предварительная версия) | Документация Майкрософт"
description: "Сведения об использовании Stream Analytics и машинного обучения для обнаружения аномалий."
services: stream-analytics
documentationcenter: 
author: dubansal
manager: jhubbard
ms.service: stream-analytics
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: data-services
ms.date: 03/28/2017
ms.author: dubansal
ms.openlocfilehash: ff8571c6447f32ef9a435f5200803e76f6013ffa
ms.sourcegitcommit: 9292e15fc80cc9df3e62731bafdcb0bb98c256e1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/10/2018
---
# <a name="using-the-anomalydetection-operator"></a>Использование оператора ANOMALYDETECTION

> [!IMPORTANT]
> Эта функция доступна в режиме предварительной версии. Мы не рекомендуем использовать ее в рабочей среде.

Оператор **ANOMALYDETECTION** можно использовать для обнаружения аномалий в потоках событий.
Например, медленное сокращение свободной памяти в течение длительного времени может свидетельствовать об утечке памяти. Также может значительно увеличиваться или уменьшаться число запросов к веб-службе, которые обычно демонстрируют стабильность.

Он проверяет наличие следующих типов аномалий за указанный период времени:

- двунаправленное изменение уровня;
- медленная положительная тенденция;
- медленная отрицательная тенденция.

Интервал времени в прошлом, который необходимо охватить (от текущего события), ограничивается с помощью предложения **LIMIT DURATION**. При необходимости оператор **ANOMALYDETECTION** можно ограничить только теми событиями, которые соответствуют определенному свойству или условию. Для этого используется предложение **WHEN**.

Он также может обрабатывать отдельные группы событий на основе ключа, указанного в предложении **PARTITION BY**. Обучение и прогнозирование в каждой секции выполняется независимо.

## <a name="syntax"></a>Синтаксис

`ANOMALYDETECTION(<scalar_expression>) OVER ([PARTITION BY <partition key>] LIMIT DURATION(<unit>, <length>) [WHEN boolean_expression])` 


## <a name="example-usage"></a>Пример использования

`SELECT id, val, ANOMALYDETECTION(val) OVER(PARTITION BY id LIMIT DURATION(hour, 1) WHEN id > 100) FROM input`|


## <a name="arguments"></a>Аргументы

- **scalar_expression**

  Скалярное выражение, по которому будет выполняться обнаружение аномалий. Это выражение типа float или bigint, которое возвращает однозначное (скалярное) значение. Выражение с подстановочным знаком **\*** не допускается. **scalar_expression** не должно содержать других аналитических функций или внешних функций.

- **OVER ( [ предложение_partition_by ] предложение_limit_duration [предложение_when])**

- **partition_by_clause** 

  Предложение `PARTITION BY <partition key>` разделяет изучение и обучение на отдельные секции. Другими словами, для каждого значения `<partition key>` будет использоваться отдельная модель, и для изучения и обучения в этой модели будут использоваться только события с этим значением. Например,

  `SELECT sensorId, reading, ANOMALYDETECTION(reading) OVER(PARTITION BY sensorId LIMIT DURATION(hour, 1)) FROM input`

  выполнит обучение операции чтения и оценит ее на соответствие другим операциям чтения только одного датчика.

- **предложение limit_duration** DURATION(\<единица\>, \<длительность\>)

  Указывает, какой интервал времени в прошлом (от текущего события) охватывается при вычислении **ANOMALYDETECTION**. В описании функции DATEDIFF приводятся подробные сведения о поддерживаемых единицах и их сокращения.

- **when_clause** 

  Указывает логическое условие для событий, которые учитываются при вычислении **ANOMALYDETECTION**.

## <a name="return-types"></a>Типы возвращаемого значения

Функция возвращает запись, которая содержит в качестве выходных данных все три оценки. Свойства, связанные с различными типами средств обнаружения аномалий, имеют следующие имена:

- BiLevelChangeScore
- SlowPosTrendScore
- SlowNegTrendScore

Чтобы извлечь из записи отдельные значения, используйте функцию **GetRecordPropertyValue**. Например: 

`SELECT id, val FROM input WHERE (GetRecordPropertyValue(ANOMALYDETECTION(val) OVER(LIMIT DURATION(hour, 1)), 'BiLevelChangeScore')) > 3.25` 


Аномалия определенного типа обнаруживается, когда один из этих показателей аномалий превышает пороговое значение. Пороговым значением может быть любое число с плавающей запятой \>= 0. Пороговое значение — это компромисс между чувствительностью и достоверностью. Например, более низкое пороговое значение сделает обнаружение более чувствительным к изменениям и создаст больше оповещений. А более высокое пороговое значение может сделать обнаружение менее чувствительным и более достоверным, но при этом некоторые аномалии будут маскироваться. Точное пороговое значение, которое следует использовать, зависит от конкретного сценария. Не существует верхнего предела, но рекомендуемый диапазон — от 3,25 до 5.

## <a name="algorithm"></a>Алгоритм

Оператор **ANOMALYDETECTION** использует семантику скользящего окна, которая означает, что вычисление выполняется для события, которое входит в функцию, и для этого события создается оценка. Вычисление основано на мартингалах заменяемости, которые проверяют, изменилось ли распределение значений события. Если изменилось, то это значит, что обнаружена потенциальная аномалия. Возвращаемая оценка является показателем уровня достоверности данной аномалии. В целью внутренней оптимизации **ANOMALYDETECTION** вычисляет оценку аномалии события на основе соотношения *d* к *2d* событий, где *d* — это указанный размера окна обнаружения.

**ANOMALYDETECTION** ожидает, что входные временные ряды будут единообразными. Поток событий может сделать единообразным, если применить статистическую обработку с помощью "переворачивающегося" или "прыгающего" окна. В сценариях, где разрыв между событиями всегда меньше, чем период статистической обработки, "переворачивающегося" окна будет достаточно, чтобы сделать временные ряды единообразными. Если этот разрыв может быть больше, то разрывы заполняются повторением последнего значения с помощью "прыгающего" окна. Оба этих сценария могут применяться в приведенном ниже примере.

## <a name="performance-guidance"></a>Рекомендации по производительности

- Используйте для заданий 6 единиц хранения. 
- Отправляйте события с интервалом не менее 1 секунды.
- Несекционированный запрос, использующий функцию **ANOMALYDETECTION**, может в результате привести к задержке вычисления в среднем около 25 мс.
- Задержка при выполнении секционированного запроса незначительно отличается в зависимости от количества секций, так как при таком запросе число вычислений выше. Тем не менее, задержка примерно такая же, как и в случае с несекционированным запросом, если общее число событий по всем секциям сопоставимо.
- При считывании данных не в режиме реального времени большой объем данных принимается быстро. Обработка этих данных в настоящее время происходит значительно медленнее. Было замечено, что при таких сценариях задержка увеличивалась линейно с количеством точек данных в окне, а не с увеличением размера окна или интервала между событиями как такового. Чтобы сократить задержку в случаях работы не в режиме реального времени, по возможности используйте меньший размер окна. Кроме того, можно запускать задание от текущего времени. Несколько примеров задержки при несекционированном запросе: 
    - 60 точек данных в окне обнаружения могут привести к задержке в 10 секунд, если пропускная способность — 3 Мбит/с; 
    - при 600 точках данных задержка может достигать 80 секунд, если пропускная способность — 0,4 Мбит/с.

## <a name="example"></a>Пример

Следующий запрос можно использовать для вывода оповещения при обнаружении аномалии.
Когда входной поток не единообразен, с помощью шага статистической обработки можно преобразовать его в единообразные временные ряды. В этом примере используется **AVG**, но конкретный тип статистической обработки зависит от сценария пользователя. Более того, если временные ряды содержат разрывы, которые больше периода статистической обработки, то во временных рядах не будет событий для запуска процесса обнаружения аномалий (в соответствии с семантикой скользящего окна). В результате предположение о единообразии будет нарушено, когда поступит следующее событие. В таких ситуациях необходим способ заполнения разрывов во временных рядах. Одним из возможных решений является использование последнего события в каждом "прыгающем" окне, как показано ниже.

    WITH AggregationStep AS 
    (
         SELECT
               System.Timestamp as tumblingWindowEnd,

               AVG(value) as avgValue

         FROM input
         GROUP BY TumblingWindow(second, 5)
    ),

    FillInMissingValuesStep AS
    (
          SELECT
                System.Timestamp AS hoppingWindowEnd,

                TopOne() OVER (ORDER BY tumblingWindowEnd DESC) AS lastEvent

         FROM AggregationStep
         GROUP BY HOPPINGWINDOW(second, 300, 5)

    ),

    AnomalyDetectionStep AS
    (

          SELECT
                hoppingWindowEnd,
                lastEvent.tumblingWindowEnd as lastTumblingWindowEnd,
                lastEvent.avgValue as lastEventAvgValue,
                system.timestamp as anomalyDetectionStepTimestamp,

                ANOMALYDETECTION(lastEvent.avgValue) OVER (LIMIT DURATION(hour, 1)) as
                scores

          FROM FillInMissingValuesStep
    )

    SELECT
          alert = 1,
          hoppingWindowEnd,
          lastTumblingWindowEnd,
          lastEventAvgValue,
          anomalyDetectionStepTimestamp,
          scores

    INTO output

    FROM AnomalyDetectionStep

    WHERE

        CAST(GetRecordPropertyValue(scores, 'BiLevelChangeScore') as float) >= 3.25

        OR CAST(GetRecordPropertyValue(scores, 'SlowPosTrendScore') as float) >=
        3.25

       OR CAST(GetRecordPropertyValue(scores, 'SlowNegTrendScore') as float) >=
       3.25

## <a name="references"></a>Ссылки

* [Anomaly Detection – Using Machine Learning to Detect Abnormalities in Time Series Data](https://blogs.technet.microsoft.com/machinelearning/2014/11/05/anomaly-detection-using-machine-learning-to-detect-abnormalities-in-time-series-data/) (Обнаружение аномалий в данных временных рядов с помощью машинного обучения)
* [API обнаружения аномалий в машинном обучении](https://docs.microsoft.com/en-gb/azure/machine-learning/machine-learning-apps-anomaly-detection-api)
* [Time Series Anomaly Detection](https://msdn.microsoft.com/library/azure/mt775197.aspx) (Обнаружение аномалий во временных рядах)

## <a name="get-support"></a>Получение поддержки
За дополнительной помощью обращайтесь на наш [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/home?forum=AzureStreamAnalytics).

## <a name="next-steps"></a>Дальнейшие действия

* [Введение в Azure Stream Analytics](stream-analytics-introduction.md)
* [Приступая к работе с Azure Stream Analytics](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)

