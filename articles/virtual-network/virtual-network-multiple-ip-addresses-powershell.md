<properties
   pageTitle="Назначение виртуальным машинам нескольких IP-адресов с помощью PowerShell | Microsoft Azure"
   description="Узнайте, как назначить несколько IP-адресов виртуальной машине с использованием Azure PowerShell."
   services="virtual-network"
   documentationCenter="na"
   authors="jimdial"
   manager="carmonm"
   editor=""
   tags="azure-resource-manager"
/>
<tags
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="10/05/2016"
   ms.author="jdial;annahar" />



# <a name="assign-multiple-ip-addresses-to-virtual-machines"></a>Назначение виртуальным машинам нескольких IP-адресов

К виртуальной машине Azure можно подключить один или несколько сетевых интерфейсов. Каждому сетевому интерфейсу назначается один или несколько общедоступных или частных IP-адресов. Дополнительные сведения об IP-адресах в Azure см. в статье [IP-адреса в Azure](virtual-network-ip-addresses-overview-arm.md). В этой статье объясняется, как использовать Azure PowerShell для назначения сетевому интерфейсу нескольких IP-адресов в модели развертывания с помощью Azure Resource Manager.

Назначение нескольких IP-адресов сетевому интерфейсу виртуальной машины предоставляет следующие возможности:

- возможность размещать на одном сервере несколько веб-сайтов или служб с разными IP-адресами и SSL-сертификатами;
- возможность использовать виртуальную машину в качестве виртуального сетевого устройства, такого как брандмауэр или балансировщик нагрузки.

[AZURE.INCLUDE [virtual-network-preview](../../includes/virtual-network-preview.md)]

Чтобы зарегистрироваться для получения предварительной версии, отправьте сообщение электронной почты с темой [Несколько IP-адресов](mailto:MultipleIPsPreview@microsoft.com?subject=Request%20to%20enable%20subscription%20%3csubscription%20id%3e) , указав идентификатор подписки и описание предполагаемого использования.
## <a name="scenario"></a>Сценарий

В этой статье нужно связать три IP-конфигурации с сетевым интерфейсом.
В следующих примерах конфигурации будут созданы и назначены сетевому интерфейсу с тремя частными IP-адресами и одним назначенным ей общедоступным IP-адресом:

- IPConfig-1 — с динамическим частным IP-адресом (по умолчанию) и общедоступным IP-адресом из ресурса общедоступного IP-адреса с именем PIP1;
- IPConfig-2 — со статическим частным IP-адресом и без общедоступного IP-адреса;
- IPConfig-3 — с динамическим частным IP-адресом и без общедоступного IP-адреса.

    ![Замещающий текст](./media/virtual-network-multiple-ip-addresses-powershell/OneNIC-3IP.png)

В этом сценарии предполагается наличие группы ресурсов под названием *RG1*, в которой есть виртуальная сеть с именем *VNet1* и подсеть с именем *Subnet1*. Кроме того, предполагается наличие виртуальной машины с именем *VM1*, связанного с ней сетевого интерфейса с именем *VM1 NIC1* и общедоступного IP-адреса с именем *PIP1*.

[В этой статье](./virtual-machines/virtual-machines-windows-ps-create.md ) рассматривается создание указанных выше ресурсов, если они не были созданы ранее.

## <a name="a-name-createacreate-a-vm-with-multiple-ip-addresses"></a><a name = "create"></a>Создание виртуальной машины с несколькими IP-адресами

1. Откройте командную строку PowerShell и выполните остальные действия в этом разделе в пределах одного сеанса PowerShell. Если вы еще не установили и не настроили PowerShell, выполните шаги, описанные в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md) .

2. Измените значения приведенных ниже переменных со знаком "$" на [расположение](https://azure.microsoft.com/regions) Azure, в котором находится виртуальная сеть, имя [группы ресурсов](../resource-group-overview.md#resource-groups), виртуальную сеть в группе ресурсов, подсеть, к которой нужно подключить сетевой интерфейс, и имя сетевого интерфейса.

        $Location = "westcentralus"
        $RgName   = "RG1"
        $VNetName   = "VNet1"
        $SubnetName = "Subnet1"
        $NicName     = "VM1-NIC1"
        $PIP = "PIP"

    Если вы не знаете имя имеющегося расположения Azure или группы ресурсов, введите следующие команды:

        Get-AzureRmLocation      | Format-Table Location
        Get-AzureRmResourceGroup | Format-Table ResourceGroupName

    <a name="subnet"></a>Сетевой интерфейс необходимо подключить к подсети в рамках имеющейся виртуальной сети Azure (VNet). Три компонента — сетевой интерфейс, подсеть и виртуальная сеть — должны находиться в одном регионе и [подписке](../azure-glossary-cloud-terminology.md#subscription).  Дополнительные сведения о виртуальных сетях и их создании см. в статьях [Обзор виртуальной сети](virtual-networks-overview.md) и [Создание виртуальной сети](virtual-networks-create-vnet-arm-ps.md).

    Если имя имеющейся виртуальной сети неизвестно, введите следующую команду и замените *VNet1* в предыдущей переменной именем виртуальной сети.

        Get-AzureRmVirtualNetwork | Format-Table Name

    Если возвращен пустой список, необходимо создать виртуальную сеть. Чтобы узнать, как это сделать, см. статью [Создание виртуальной сети](virtual-networks-create-vnet-arm-ps.md).

    Выполните следующие команды, чтобы получить имя подсетей в виртуальной сети, и замените *Subnet1* на имя подсети.

        $VNet = Get-AzureRmVirtualNetwork -Name $VNetName -ResourceGroupName $RgName
        $VNet.Subnets | Format-Table Name, AddressPrefix

4. Введите следующую команду, чтобы получить подсеть и назначить ее переменной.

        $Subnet = $VNet.Subnets | Where-Object { $_.Name -eq $SubnetName }

5. <a name="ipconfigs"></a>Определите IP-конфигурации, которые необходимо назначить сетевому интерфейсу. В каждой конфигурации может быть один статический или динамический частный IP-адрес и один ресурс общедоступного IP-адреса, связанный со статическим или динамическим адресом.

    Добавьте или удалите необходимое количество следующих конфигураций в зависимости от количества IP-адресов, которые требуется назначить сетевому интерфейсу, и параметров, которые требуется настроить.

    **IPConfig-1**

    Измените значение *PIP1* на имя имеющегося ресурса общедоступного IP-адреса, который находится в том расположении, где создается сетевой интерфейс, и который не связан с другим сетевым интерфейсом. Измените *RG1* на имя группы ресурсов, в которой находится ресурс общедоступного IP-адреса. Измените *IPConfig-1* на имя, которое необходимо назначить первой IP-конфигурации. Введите следующие команды:

        $PIP1 = Get-AzureRmPublicIPAddress -Name "PIP1" -ResourceGroupName $RgName

        $IpConfigName1 = "IPConfig-1"
        $IPConfig1     = New-AzureRmNetworkInterfaceIpConfig -Name $IPConfigName1 -Subnet $Subnet -PublicIpAddress $PIP1 -Primary

    Запишите коммутатор *-Primary* . При назначении нескольких IP-конфигураций сетевому интерфейсу одну конфигурацию необходимо назначить в качестве *первичной*. Если имя имеющегося ресурса общедоступного IP-адреса неизвестно, введите следующую команду:

        Get-AzureRMPublicIPAddress |Format-Table Name, Location, IPAddress, IpConfiguration

    Если столбец **IPConfiguration** не содержит значения в возвращенных данных, ресурс общедоступного IP-адреса не связан с имеющимся сетевым интерфейсом и может использоваться. Если список пуст или нет доступных ресурсов общедоступных IP-адресов, можно создать IP-адрес с помощью команды **New-AzureRmPublicIPAddress** .

    >[AZURE.NOTE] За общедоступные IP-адреса взимается номинальная плата. Дополнительные сведения о ценах на IP-адреса см. на странице [Цены на IP-адреса](https://azure.microsoft.com/pricing/details/ip-addresses).

    **IPConfig-2**

    Измените *IPConfig-2* на имя, которое нужно присвоить второй IP-конфигурации, и измените *10.0.0.5* на неиспользуемый допустимый IP-адрес для подсети, которой назначается сетевой интерфейс. Введите следующие команды:

        $IPConfigName2 = "IPConfig-2"
        $IPAddress = 10.0.0.5

        $IPConfig2 = New-AzureRmNetworkInterfaceIpConfig -Name $IPConfigName2 -Subnet $Subnet -PrivateIpAddress $IPAddress

    Если диапазон IP-адресов, назначенных подсети, неизвестен, введите следующую команду:

        $VNet.Subnets | Format-Table Name, AddressPrefix

    **IPConfig-3**

    Измените *IPConfig-3* на имя, которое необходимо присвоить третьей IP-конфигурации, и введите следующие команды:

        $IPConfigName3 = "IPConfig-3"
        $IPConfig3 = New-AzureRmNetworkInterfaceIpConfig -Name $IPConfigName3 -Subnet $Subnet

    >[AZURE.NOTE] Сетевому интерфейсу можно назначить до 250 частных IP-адресов. Количество общедоступных IP-адресов, которые можно использовать в пределах подписки, ограничено. Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-subscription-service-limits.md#networking-limits---azure-resource-manager).

6. Создайте сетевой интерфейс, используя IP-конфигурации, определенные на предыдущем шаге.

        $nic = New-AzureRmNetworkInterface -Name $NicName -ResourceGroupName $RgName -Location $Location -IpConfiguration $IpConfig1,$IpConfig2,$IpConfig3

7. Подключите сетевой интерфейс при создании виртуальной машины, выполнив действия, описанные в статье [Создание виртуальной машины Windows с помощью Resource Manager и PowerShell](../virtual-machines/virtual-machines-windows-ps-create.md) . Хотя в статье описывается создание виртуальной машины под управлением Windows Server, эти действия применимы и для виртуальной машины под управлением Linux (в отличие от другой операционной системы). Выполните шаги 1–3 этой статьи. Пропустите шаги 4 и 5 и выполните шаг 6 в статье "Создание виртуальной машины Windows с помощью Resource Manager и PowerShell".

    >[AZURE.WARNING] Шаг 6 в статье "Создание виртуальной машины Windows с помощью Resource Manager и PowerShell" завершится ошибкой, если изменить переменную с именем $nic на шаге 6 этой статьи или если предыдущие шаги в этой статье не выполнены.

8. Просмотрите частные IP адреса, назначенные сетевому интерфейсу с помощью DHCP Azure, и ресурс общедоступного IP-адреса, назначенный сетевому интерфейсу. Для этого введите следующую команду:

        $nic.IpConfigurations | Format-Table Name, PrivateIPAddress, PublicIPAddress, Primary

9. <a name="os"></a>Добавьте вручную все вторичные частные IP-адреса (IP-адреса со значением *False* в столбце **Primary** в выходных данных на предыдущем шаге) для конфигурации TCP/IP в операционной системе. Частный IP-адрес, назначенный *IPConfig-1* на шаге 5, автоматически назначается операционной системе через DHCP Azure, так как это *первичная* конфигурация.


**Windows**

1. В командной строке введите *ipconfig /all*.  Отображается только *первичный* частный IP-адрес (через службу DHCP).
2. После этого выполните *ncpa.cpl* в окне командной строки. Откроется новое окно.
3. Откройте свойства **Подключения к локальной сети**.
4. Дважды щелкните "Протокол IP версии 4 (TCP/IPv4)".
5. Выберите **Использовать следующий IP-адрес** и введите следующие значения:
    - **IP-адрес**— *первичный* частный IP-адрес.
    - **Маска подсети**— в зависимости от своей подсети. Например, если подсеть — /24, то маска подсети — 255.255.255.0.
    - **Шлюз по умолчанию**— первый IP-адрес в подсети. Если подсеть — 10.0.0.0/24, то IP-адрес шлюза по умолчанию — 10.0.0.1.
    - Щелкните **Использовать следующие адреса DNS-серверов** и введите следующие значения:
        - **Предпочитаемый DNS-сервер** — 168.63.129.16, если собственный DNS-сервер не используется.  Если используется, введите IP-адрес DNS-сервера.
    - Нажмите кнопку **Дополнительно** и добавьте дополнительные IP-адреса. Добавьте каждый вторичный частный IP-адрес, указанный на шаге 8, для сетевого интерфейса с той же подсетью, которая указана для первичного IP-адреса.
    - Нажмите кнопку **ОК**, чтобы закрыть настройки TCP/IP, а затем нажмите кнопку **ОК** еще раз, чтобы закрыть параметры адаптера. После этого подключение к удаленному рабочему столу будет установлено заново.

6. В командной строке введите *ipconfig /all*. Отобразятся все добавленные IP-адреса, а DHCP будет отключен.


**Linux (Ubuntu)**

1. Откройте окно терминала.
2. Нужно войти с правами привилегированного пользователя. Чтобы стать им, выполните следующую команду:

            sudo -i
3. Обновите файл конфигурации сетевого интерфейса (предполагается "eth0").
    - Сохраните имеющийся элемент строки для DHCP. В результате этого первичный IP-адрес будет настроен так, как он был настроен до этого.
    - Добавьте конфигурацию для дополнительного статического IP-адреса с помощью следующих команд:

                cd /etc/network/interfaces.d/
                ls

        Должен отобразиться CFG-файл.
4. Откройте файл: vi *имя файла*.

    В конце этого файла будут следующие строки:

            auto eth0
            iface eth0 inet dhcp
5. Добавьте следующие строки после имеющихся строк в этом файле:

            iface eth0 inet static
            address <your private IP address here>
6. Сохраните файл с помощью следующей команды:

            :wq
7.  Сбросьте сетевой интерфейс, выполнив следующую команду:

            sudo ifdown eth0 && sudo ifup eth0

    >[AZURE.IMPORTANT] Если используется удаленное подключение, запустите скрипты ifdown и ifup в одной и той же строке.
8. Проверьте, добавлен ли IP-адрес к сетевому интерфейсу, с помощью следующей команды:

            ip addr list eth0

    Должен отобразиться IP-адрес, добавленный как часть списка.

**Linux (Redhat, CentOS и другие)**

1. Откройте окно терминала.
2. Нужно войти с правами привилегированного пользователя. Чтобы стать им, выполните следующую команду:

            sudo -i
3. Введите пароль и следуйте инструкциям. После того как вы станете привилегированным пользователем, перейдите к сетевой папке скриптов, используя следующую команду:

            cd /etc/sysconfig/network-scripts
4. Выведите список связанных IFCFG-файлов, используя следующую команду:

            ls ifcfg-*

    В списке файлов должен быть файл *ifcfg-eth0* .
5. Скопируйте файл *ifcfg-eth0* и назовите его *ifcfg-eth0:0*, используя следующую команду:

            cp ifcfg-eth0 ifcfg-eth0:0
6. Измените файл *ifcfg-eth0:0* , используя следующую команду:

            vi ifcfg-eth1
7. Измените имя устройства на соответствующее имя в файле, в этом случае на *eth0:0*. Для этого используйте следующую команду:

            DEVICE=eth0:0
8. Измените строку *IPADDR = YourPrivateIPAddress* в соответствии с IP-адресом.
9. Сохраните файл, используя следующую команду:

            :wq
10. Перезапустите сетевые службы и убедитесь, что изменения вступили в силу, выполнив следующие команды:

            /etc/init.d/network restart
            Ipconfig

    В возвращенном списке должен содержаться добавленный IP-адрес — *eth0:0*.

## <a name="a-nameaddaadd-ip-addresses-to-an-existing-vm"></a><a name="add"></a>Добавление IP-адресов в имеющуюся виртуальную машину

Чтобы добавить дополнительные IP-адреса в имеющийся сетевой интерфейс, сделайте следующее:

1. Откройте командную строку PowerShell и выполните остальные действия в этом разделе в пределах одного сеанса PowerShell. Если вы еще не установили и не настроили PowerShell, выполните шаги, описанные в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md) .

2. Измените значения переменных со знаком "$" на имя сетевого интерфейса, к которому необходимо добавить IP-адреса, а также имя группы ресурсов и расположения, где находится сетевой интерфейс.

        $NicName     = "RG1-VM1-NIC1"
        $RgName   = "RG1"
        $NicLocation = "westcentralus"

    Если имя сетевого интерфейса, который необходимо изменить, неизвестно, введите следующие команды, а затем измените значения предыдущих переменных.

        Get-AzureRmNetworkInterface | Format-Table Name, ResourceGroupName, Location

3. Создайте переменную и назначьте ее существующему сетевому интерфейсу, выполнив следующую команду:

        $nic = Get-AzureRmNetworkInterface -Name $NicName -ResourceGroupName $RgName

4. Получите идентификатор подсети, к которой подключен сетевой интерфейс, выполнив [шаг 3](#subnet) из раздела "Создание виртуальной машины с несколькими IP-адресами" этой статьи.

5. Создайте IP-конфигурации, которые необходимо добавить в сеть, следуя инструкциям на [шаге 5](#ipconfigs) из раздела "Создание виртуальной машины с несколькими IP-адресами" этой статьи.

6. Измените *$IPConfigName4* на имя IP-конфигурации, созданной на предыдущем шаге. Чтобы добавить конфигурацию, введите следующую команду:

        Add-AzureRmNetworkInterfaceIpConfig -Name $IPConfigName4 -NetworkInterface $nic -Subnet $Subnet1

7. Настройте для сетевого интерфейса IP-конфигурацию, введя следующую команду:

        Set-AzureRmNetworkInterface -NetworkInterface $nic

8. Добавьте IP-адреса, добавленные в сетевой интерфейс, в операционную систему виртуальной машины, следуя инструкциям на [шаге 9](#os) из раздела "Создание виртуальной машины с несколькими IP-адресами" этой статьи.



<!--HONumber=Oct16_HO2-->


