---
title: "Назначение виртуальным машинам нескольких IP-адресов с помощью PowerShell | Документация Майкрософт"
description: "Сведения о назначении виртуальной машине нескольких IP-адресов с помощью PowerShell при использовании Resource Manager."
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: 
tags: azure-resource-manager
ms.assetid: c44ea62f-7e54-4e3b-81ef-0b132111f1f8
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/16/2016
ms.author: jdial;annahar
translationtype: Human Translation
ms.sourcegitcommit: a0d8a6dbe793bc4ea5211e772439d931c8e84a04
ms.openlocfilehash: cf2a57f96576b18692dd42a9680d7f3b8d8f7c69


---
# <a name="assign-multiple-ip-addresses-to-virtual-machines-using-powershell"></a>Назначение виртуальным машинам нескольких IP-адресов с помощью PowerShell

> [!div class="op_single_selector"]
> * [Портал Azure](virtual-network-multiple-ip-addresses-portal.md)
> * [PowerShell](virtual-network-multiple-ip-addresses-powershell.md)
> * [ИНТЕРФЕЙС КОМАНДНОЙ СТРОКИ](virtual-network-multiple-ip-addresses-cli.md)
>

К виртуальной машине Azure можно подключить один или несколько сетевых адаптеров. Каждому такому адаптеру статически или динамически назначается один или несколько общедоступных или частных IP-адресов. Назначение нескольких IP-адресов виртуальной машине дает следующие возможности:

* Возможность размещать на одном сервере несколько веб-сайтов или служб с разными IP-адресами и SSL-сертификатами.
* возможность использовать виртуальную машину в качестве виртуального сетевого устройства, такого как брандмауэр или балансировщик нагрузки.
* Возможность добавления любых частных IP-адресов любых сетевых карт во внутренний пул Azure Load Balancer. Раньше во внутренний пул можно было добавить только основной IP-адрес для основной сетевой карты. Дополнительные сведения о балансировке нагрузки в конфигурациях с несколькими IP-адресами см. в [этой статье](../load-balancer/load-balancer-multiple-ip.md).

Каждому сетевому адаптеру, подключенному к виртуальной машине, присвоена одна или несколько конфигураций IP-адресов. Каждая конфигурация получает один статический или динамический частный IP-адрес. Также каждой конфигурации может быть присвоен один ресурс общедоступного IP-адреса. Ресурс общедоступного IP-адреса включает один динамический или статический IP-адрес. Дополнительные сведения об IP-адресах в Azure см. в статье [IP-адреса в Azure](virtual-network-ip-addresses-overview-arm.md).

В этой статье объясняется, как с помощью PowerShell назначить несколько IP-адресов виртуальной машине, созданной по модели развертывания с помощью Azure Resource Manager. Для ресурсов, созданных с помощью классической модели развертывания, нельзя назначить несколько IP-адресов. Дополнительные сведения о моделях развертывания Azure см. в статье [Azure Resource Manager vs. classic deployment: Understand deployment models and the state of your resources](../resource-manager-deployment-model.md) (Развертывание с помощью Azure Resource Manager и классическое развертывание. Общие сведения о моделях развертывания и состоянии ресурсов).

[!INCLUDE [virtual-network-preview](../../includes/virtual-network-preview.md)]

## <a name="scenario"></a>Сценарий
Создается виртуальная машина с одним сетевым адаптером. Она подключается к виртуальной сети. Виртуальной машине нужно присвоить три разных *частных* и два *общедоступных* IP-адреса. IP-адреса назначаются следующим IP-конфигурациям.

* **IPConfig-1:** назначает *динамический* частный IP-адрес (по умолчанию) и *статический* общедоступный IP-адрес.
* **IPConfig-2:** назначает *статический* частный IP-адрес и *статический* общедоступный IP-адрес.
* **IPConfig-3:** назначает *динамический* частный IP-адрес и не назначает общедоступный IP-адрес.
  
    ![Несколько IP-адресов](./media/virtual-network-multiple-ip-addresses-powershell/OneNIC-3IP.png)

Когда создается сетевой адаптер, с ним связываются IP-конфигурации. Когда создается виртуальная машина, к ней подключается сетевой адаптер. Типы IP-адресов в этом сценарии указаны только для примера. Вы можете использовать любые типы IP-адресов и назначений, какие вам потребуются.

## <a name="a-name--createacreate-a-vm-with-multiple-ip-addresses"></a><a name = "create"></a>Создание виртуальной машины с несколькими IP-адресами

Вы можете создать пример виртуальной машины с несколькими IP-адресами, как описано в нашем сценарии. Измените имена переменных и типы IP-адресов в соответствии с требованиями этой реализации.

1. Откройте командную строку PowerShell и выполните остальные действия в этом разделе в пределах одного сеанса PowerShell. Если вы еще не установили и не настроили PowerShell, выполните шаги, описанные в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md) .
2. Зарегистрируйтесь для получения предварительной версии, отправив с помощью [этой ссылки](mailto:MultipleIPsPreview@microsoft.com?subject=Request%20to%20enable%20subscription%20%3csubscription%20id%3e) сообщение электронной почты. Укажите в нем идентификатор своей подписки и опишите предполагаемое использование. Не переходите к следующим этапам, пока не будут выполнены следующие условия:
    - вы получите по электронной почте уведомление о возможности использовать предварительную версию;
    - вы выполните все инструкции, приведенные в этом сообщении электронной почты.
3. Выполните этапы 1–4 статьи [Создание виртуальной машины Windows с помощью Resource Manager и PowerShell](../virtual-machines/virtual-machines-windows-ps-create.md). Не выполняйте этап 5 (создание ресурса общедоступного IP-адреса и сетевого интерфейса). Если вы изменили имена каких-либо переменных, используемых в этой статье, изменяйте их также при выполнении остальных этапов. Чтобы создать виртуальную машину Linux, используйте операционную систему Linux, а не Windows.
4. Создайте переменную для хранения объекта подсети, созданного на этапе 4 (создание виртуальной сети) статьи о создании виртуальной машины Windows. Для этого выполните следующую команду:

    ```powershell
    $SubnetName = $mySubnet.Name
    $Subnet = $myVnet.Subnets | Where-Object { $_.Name -eq $SubnetName }
    ```
5. Определите IP-конфигурации, которые необходимо назначить сетевому интерфейсу. Конфигурации можно добавлять, удалять или изменять по мере необходимости. В сценарии описаны следующие конфигурации.

    **IPConfig-1**

    Выполните указанные ниже команды, чтобы создать:
    - ресурс общедоступного IP-адреса с общедоступным статическим IP-адресом;
    - IP-конфигурацию с ресурсом общедоступного IP-адреса и динамическим частным IP-адресом.

    ```powershell
    $myPublicIp1     = New-AzureRmPublicIpAddress -Name "myPublicIp1" -ResourceGroupName $myResourceGroup -Location $location -AllocationMethod Static
    $IpConfigName1  = "IPConfig-1"
    $IpConfig1      = New-AzureRmNetworkInterfaceIpConfig -Name $IpConfigName1 -Subnet $Subnet -PublicIpAddress $myPublicIp1 -Primary
    ```

    Обратите внимание на переключатель `-Primary` в предыдущей команде. При назначении нескольких IP-конфигураций сетевому интерфейсу одну конфигурацию необходимо назначить в качестве *первичной*.

    > [!NOTE]
    > За общедоступные IP-адреса взимается номинальная плата. Дополнительные сведения о ценах на IP-адреса см. на странице [Цены на IP-адреса](https://azure.microsoft.com/pricing/details/ip-addresses). Число общедоступных IP-адресов, которые можно использовать в одной подписке, ограничено. Сведения об ограничениях см. в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-subscription-service-limits.md#networking-limits).
    >

    **IPConfig-2**

    Измените значение переменной **$IPAddress** на доступный допустимый IP-адрес в созданной подсети. Чтобы проверить, доступен ли адрес 10.0.0.5 в подсети, выполните команду `Test-AzureRmPrivateIPAddressAvailability -IPAddress 10.0.0.5 -VirtualNetwork $myVnet`. Если адрес доступен, в выходных данных возвращается значение *True*, а если нет — значение *False* и список доступных адресов. Выполните следующие команды, чтобы создать ресурс общедоступного IP-адреса и IP-конфигурацию с общедоступным статическим IP-адресом и частным статическим IP-адресом.
    
    ```powershell
    $IpConfigName2 = "IPConfig-2"
    $IPAddress     = 10.0.0.5
    $myPublicIp2   = New-AzureRmPublicIpAddress -Name "myPublicIp2" -ResourceGroupName $myResourceGroup `
    -Location $location -AllocationMethod Static
    $IpConfig2     = New-AzureRmNetworkInterfaceIpConfig -Name $IpConfigName2 `
    -Subnet $Subnet -PrivateIpAddress $IPAddress -PublicIpAddress $myPublicIp2
    ```

    **IPConfig-3**

    Выполните следующие команды, чтобы создать IP-конфигурацию с частным динамическим IP-адресом без общедоступного IP-адреса.

    ```powershell
    $IpConfigName3 = "IpConfig-3"
    $IpConfig3 = New-AzureRmNetworkInterfaceIpConfig -Name $IPConfigName3 -Subnet $Subnet
    ```
6. Создайте сетевой интерфейс, используя IP-конфигурации, определенные на предыдущем шаге, с помощью следующей команды:

    ```powershell
    $myNIC = New-AzureRmNetworkInterface -Name myNIC -ResourceGroupName $myResourceGroup `
    -Location $location -IpConfiguration $IpConfig1,$IpConfig2,$IpConfig3
    ```
    > [!NOTE]
    > Хотя в этом руководстве все IP-конфигурации назначаются одному сетевому адаптеру, вы также можете назначить несколько IP-конфигураций любому сетевому адаптеру, связанному с виртуальной машиной. Дополнительные сведения о создании виртуальной машины с несколькими сетевыми интерфейсами см. в [этой статье](virtual-network-deploy-multinic-arm-ps.md).

7. Выполните этап 6 статьи [Создание виртуальной машины Windows с помощью Resource Manager и PowerShell](../virtual-machines/virtual-machines-windows-ps-create.md). 

    > [!WARNING]
    > Этап 6 создания виртуальной машины завершается сбоем, если:
    > - вы изменили переменную $myNIC при выполнении этапа 6 этой статьи;
    > - вы не завершили предыдущие этапы этой статьи и статьи о создании виртуальной машины Windows.
    >
8. Просмотрите частные IP-адреса и ресурсы общедоступных IP-адресов, назначенные сетевому интерфейсу. Для этого выполните следующую команду:

    ```powershell
    $myNIC.IpConfigurations | Format-Table Name, PrivateIPAddress, PublicIPAddress, Primary
    ```

## <a name="a-nameosconfigaadd-ip-addresses-to-a-vm-operating-system"></a><a name="OsConfig"></a>Добавление IP-адресов в операционную систему виртуальной машины

Подключитесь к виртуальной машине, созданной с несколькими частными IP-адресами, и войдите в нее. Все частные IP-адреса (включая основные), добавленные в виртуальную машину, необходимо добавить вручную. Сделайте следующее для операционной системы виртуальной машины:

### <a name="windows"></a>Windows

1. В командной строке введите *ipconfig /all*.  Отображается только *первичный* частный IP-адрес (через службу DHCP).
2. Введите *ncpa.cpl* в командной строке, чтобы открыть окно **Сетевые подключения**.
3. Откройте свойства **Подключения к локальной сети**.
4. Дважды щелкните Internet Protocol version 4 (IPv4) (Протокол IP версии 4 (IPv4)).
5. Выберите **Использовать следующий IP-адрес** и введите следующие значения:

    * **IP-адрес**— *первичный* частный IP-адрес.
    * **Маска подсети**— в зависимости от своей подсети. Например, если подсеть — /24, то маска подсети — 255.255.255.0.
    * **Шлюз по умолчанию**— первый IP-адрес в подсети. Если подсеть — 10.0.0.0/24, то IP-адрес шлюза по умолчанию — 10.0.0.1.
    * Щелкните **Использовать следующие адреса DNS-серверов** и введите следующие значения:
        * **Предпочитаемый DNS-сервер.** Введите 168.63.129.16, если собственный DNS-сервер не используется.  При использовании собственного DNS-сервера введите IP-адрес своего сервера.
    * Нажмите кнопку **Дополнительно** и добавьте дополнительные IP-адреса. Добавьте каждый вторичный частный IP-адрес, указанный на шаге 8, для сетевого интерфейса с той же подсетью, которая указана для первичного IP-адреса.
    * Нажмите кнопку **ОК**, чтобы закрыть настройки TCP/IP, а затем нажмите кнопку **ОК** еще раз, чтобы закрыть параметры адаптера. После этого подключение к удаленному рабочему столу восстановится.
6. В командной строке введите *ipconfig /all*. Отобразятся все добавленные IP-адреса, а DHCP будет отключен.
    
### <a name="linux-ubuntu"></a>Linux (Ubuntu)

1. Откройте окно терминала.
2. Нужно войти с правами привилегированного пользователя. В противном случае введите следующую команду:

    ```bash
    sudo -i
    ```

3. Обновите файл конфигурации сетевого интерфейса (предполагается "eth0").

    * Сохраните имеющийся элемент строки для DHCP. Основной IP-адрес остается настроенным, как и ранее.
    * Добавьте конфигурацию для дополнительного статического IP-адреса с помощью следующих команд:

        ```bash
        cd /etc/network/interfaces.d/
        ls
        ```

    Должен отобразиться CFG-файл.
4. Откройте файл: vi *имя файла*.

    В конце этого файла будут следующие строки:

    ```bash
    auto eth0
    iface eth0 inet dhcp
    ```

5. Добавьте следующие строки после имеющихся строк в этом файле:

    ```bash
    iface eth0 inet static
    address <your private IP address here>
    ```

6. Сохраните файл с помощью следующей команды:

    ```bash
    :wq
    ```

7. Сбросьте сетевой интерфейс, выполнив следующую команду:

    ```bash
    sudo ifdown eth0 && sudo ifup eth0
    ```

    > [!IMPORTANT]
    > Если используется удаленное подключение, запустите скрипты ifdown и ifup в одной и той же строке.
    >

8. Проверьте, добавлен ли IP-адрес к сетевому интерфейсу, с помощью следующей команды:

    ```bash
    Ip addr list eth0
    ```

    Должен отобразиться IP-адрес, добавленный как часть списка.
    
### <a name="linux-redhat-centos-and-others"></a>Linux (Redhat, CentOS и другие)

1. Откройте окно терминала.
2. Нужно войти с правами привилегированного пользователя. В противном случае введите следующую команду:

    ```bash
    sudo -i
    ```

3. Введите пароль и следуйте инструкциям. После того как вы станете привилегированным пользователем, перейдите к сетевой папке скриптов, используя следующую команду:

    ```bash
    cd /etc/sysconfig/network-scripts
    ```

4. Выведите список связанных IFCFG-файлов, используя следующую команду:

    ```bash
    ls ifcfg-*
    ```

    В списке файлов должен быть файл *ifcfg-eth0* .

5. Скопируйте файл *ifcfg-eth0* и назовите его *ifcfg-eth0:0*, используя следующую команду:

    ```bash
    cp ifcfg-eth0 ifcfg-eth0:0
    ```

6. Измените файл *ifcfg-eth0:0* , используя следующую команду:

    ```bash
    vi ifcfg-eth1
    ```

7. Измените имя устройства на соответствующее имя в файле, в этом случае на *eth0:0*. Для этого используйте следующую команду:

    ```bash
    DEVICE=eth0:0
    ```

8. Измените строку *IPADDR = YourPrivateIPAddress* в соответствии с IP-адресом.
9. Сохраните файл, используя следующую команду:

    ```bash
    :wq
    ```

10. Перезапустите сетевые службы и убедитесь, что изменения вступили в силу, выполнив следующие команды:

    ```bash
    /etc/init.d/network restart
    Ipconfig
    ```

    В возвращенном списке должен содержаться добавленный IP-адрес — *eth0:0*.

## <a name="a-nameaddaadd-ip-addresses-to-a-vm"></a><a name="add"></a>Добавление IP-адресов в виртуальную машину

Выполнив следующие шаги, вы сможете назначить дополнительные частные или общедоступные IP-адреса существующим сетевым адаптерам. Примеры созданы на основе [сценария](#Scenario), описанного в этой статье.

1. Откройте командную строку PowerShell и выполните остальные действия в этом разделе в пределах одного сеанса PowerShell. Если вы еще не установили и не настроили PowerShell, выполните шаги, описанные в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md) .
2. Зарегистрируйтесь для получения предварительной версии, отправив с помощью [этой ссылки](mailto:MultipleIPsPreview@microsoft.com?subject=Request%20to%20enable%20subscription%20%3csubscription%20id%3e) сообщение электронной почты. Укажите в нем идентификатор своей подписки и опишите предполагаемое использование. Не переходите к следующим этапам, пока не будут выполнены следующие условия:
    - вы получите по электронной почте уведомление о возможности использовать предварительную версию;
    - вы выполните все инструкции, приведенные в этом сообщении электронной почты.
3. Измените значения переменных со знаком "$" на имя сетевого интерфейса, к которому необходимо добавить IP-адрес, а также имя группы ресурсов и расположения, где находится сетевой интерфейс.

    ```powershell
    $NICname         = "myNIC"
    $myResourceGroup = "myResourceGroup"
    $location        = "westcentralus"
    ```

    Если имя сетевого интерфейса, который необходимо изменить, неизвестно, введите следующие команды, а затем измените значения предыдущих переменных.

    ```powershell
    Get-AzureRmNetworkInterface | Format-Table Name, ResourceGroupName, Location
    ```
4. Создайте переменную и назначьте ее существующему сетевому интерфейсу, выполнив следующую команду:

    ```powershell
    $myNIC = Get-AzureRmNetworkInterface -Name $NICname -ResourceGroupName $myResourceGroup
    ```
5. В следующих командах измените параметры *myVNet* и *mySubnet* на имена виртуальной сети и подсети, к которым подключен сетевой интерфейс. Чтобы получить объекты виртуальной сети и подсети, к которым подключен сетевой интерфейс, выполните следующие команды:

    ```powershell
    $myVnet = Get-AzureRMVirtualnetwork -Name myVNet -ResourceGroupName $myResourceGroup
    $Subnet = $myVnet.Subnets | Where-Object { $_.Name -eq "mySubnet" }
    ```
    Если вы не знаете имя виртуальной сети или подсети, к которым подключен сетевой интерфейс, выполните следующую команду:
    ```powershell
    $mynic.IpConfigurations
    ```
    В возращенных выходных данных найдите текст, похожий на следующий:

        Subnet   : {
                     "Id": "/subscriptions/[Id]/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet"

    В полученных выходных данных *myVnet* — это имя виртуальной сети, а *mySubnet* —имя подсети, к которой подключен сетевой интерфейс.

6. Выполните действия, описанные в одном из следующих разделов, с учетом задач.

    **Добавление частного IP-адреса**
    
    Чтобы добавить к сетевому интерфейсу частный IP-адрес, нужно создать IP-конфигурацию. Следующая команда создает конфигурацию со статическим IP-адресом 10.0.0.7. Если вам нужен динамический частный IP-адрес, удалите из этой команды элемент `-PrivateIpAddress 10.0.0.7`. Указываемый статический IP-адрес должен быть свободен в используемой подсети. Мы советуем сначала проверить доступность адреса. Для этого выполните команду `Test-AzureRmPrivateIPAddressAvailability -IPAddress 10.0.0.7 -VirtualNetwork $myVnet`. Если IP-адрес доступен, в выходных данных возвращается значение *True*, а если нет — значение *False* и список доступных адресов.

    ```powershell
    Add-AzureRmNetworkInterfaceIpConfig -Name IPConfig-4 -NetworkInterface `
     $myNIC -Subnet $Subnet -PrivateIpAddress 10.0.0.7
    ```
    Вы можете создать любое количество конфигураций, указывая для них уникальные имена и уникальные частные IP-адреса (если используются статические IP-адреса).

    **Добавление общедоступного IP-адреса**
    
    Чтобы добавить общедоступный IP-адрес, его нужно связать с новой или имеющейся IP-конфигурацией. Выполните шаги, описанные в одном из следующих разделов, в соответствии с задачами.

    > [!NOTE]
    > За общедоступные IP-адреса взимается номинальная плата. Дополнительные сведения о ценах на IP-адреса см. на странице [Цены на IP-адреса](https://azure.microsoft.com/pricing/details/ip-addresses). Число общедоступных IP-адресов, которые можно использовать в одной подписке, ограничено. Сведения об ограничениях см. в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-subscription-service-limits.md#networking-limits).
    >

    **Связывание ресурса с новой IP-конфигурацией**
    
    Чтобы добавить общедоступный IP-адрес в новую IP-конфигурацию, необходимо добавить и частный IP-адрес, так как все IP-конфигурации должны иметь частный IP-адрес. В конфигурацию можно добавить имеющийся ресурс общедоступного IP-адреса или создать новый. Чтобы создать ресурс, выполните следующую команду:
    
    ```powershell
    $myPublicIp3   = New-AzureRmPublicIpAddress -Name "myPublicIp3" -ResourceGroupName $myResourceGroup `
    -Location $location -AllocationMethod Static
    ```

    Чтобы создать новую IP-конфигурацию с частным динамическим IP-адресом и связанным ресурсом общедоступного IP-адреса *myPublicIp3*, выполните следующую команду:

    ```powershell
    Add-AzureRmNetworkInterfaceIpConfig -Name IPConfig-4 -NetworkInterface `
     $myNIC -Subnet $Subnet -PublicIpAddress $myPublicIp3
    ```

    **Связывание ресурса с имеющейся IP-конфигурацией**
    Ресурс общедоступного IP-адреса может быть связан только с такой IP-конфигурацией, у которой еще нет такого ресурса. Чтобы определить, связан ли с конкретной IP-конфигурацией какой-либо общедоступный IP-адрес, выполните следующую команду:

    ```powershell
    $myNIC.IpConfigurations | Format-Table Name, PrivateIPAddress, PublicIPAddress, Primary
    ```

    Найдите в возвращаемых данных строку, похожую на приведенную ниже.

        Name       PrivateIpAddress PublicIpAddress                                           Primary
        ----       ---------------- ---------------                                           -------
        IPConfig-1 10.0.0.4         Microsoft.Azure.Commands.Network.Models.PSPublicIpAddress    True
        IPConfig-2 10.0.0.5         Microsoft.Azure.Commands.Network.Models.PSPublicIpAddress   False
        IpConfig-3 10.0.0.6                                                                     False

    Столбец **PublicIpAddress** для IP-конфигурации *IpConfig-3* пуст. Это означает, что в настоящее время с этой конфигурацией не связан никакой общедоступный IP-адрес. Вы можете добавить к конфигурации IpConfig-3 имеющийся ресурс общедоступного IP-адреса или создать новый ресурс, выполнив следующую команду:

    ```powershell
    $myPublicIp3   = New-AzureRmPublicIpAddress -Name "myPublicIp3" -ResourceGroupName $myResourceGroup `
    -Location $location -AllocationMethod Static
    ```

    Чтобы связать ресурс общедоступного IP-адреса с имеющейся IP-конфигурацией с именем *IPConfig-3*, выполните следующую команду:
    
    ```powershell
    Set-AzureRmNetworkInterfaceIpConfig -Name IpConfig-3 -NetworkInterface $mynic -Subnet $Subnet -PublicIpAddress $myPublicIp3
    ```

7. Настройте для сетевого интерфейса IP-конфигурацию, выполнив следующую команду:

    ```powershell
    Set-AzureRmNetworkInterface -NetworkInterface $myNIC
    ```

8. Просмотрите частные IP адреса и ресурсы общедоступных IP-адресов, назначенные сетевому адаптеру. Для этого введите следующую команду.

    ```powershell   
    $myNIC.IpConfigurations | Format-Table Name, PrivateIPAddress, PublicIPAddress, Primary
    ```

9. Добавьте в операционную систему виртуальной машины IP-адреса, которые вы ранее назначили сетевому адаптеру. Для этого выполните инструкции из раздела [Добавление IP-адресов в операционную систему виртуальной машины](#OsConfig) этой статьи.



<!--HONumber=Nov16_HO3-->


