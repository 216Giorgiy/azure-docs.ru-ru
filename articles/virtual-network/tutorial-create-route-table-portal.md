---
title: Маршрутизация сетевого трафика — портал Azure | Документация Майкрософт
description: Сведения о маршрутизации сетевого трафика с помощью таблицы маршрутов при использовании портала Azure.
services: virtual-network
documentationcenter: virtual-network
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-network
ms.devlang: azurecli
ms.topic: article
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 03/05/2018
ms.author: jdial
ms.custom: ''
ms.openlocfilehash: 4cc814e1fd3ee8979662695f9dec3dcce335dc2a
ms.sourcegitcommit: 168426c3545eae6287febecc8804b1035171c048
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2018
---
# <a name="route-network-traffic-with-a-route-table-using-the-azure-portal"></a>Маршрутизация сетевого трафика с помощью таблицы маршрутов с использованием портала Azure

По умолчанию Azure автоматически маршрутизирует трафик между всеми подсетями в виртуальной сети. Для переопределения маршрутизации Azure по умолчанию можно создать собственные маршруты. Возможность создания настраиваемых маршрутов полезна, если, к примеру, требуется маршрутизировать трафик между подсетями через брандмауэр. В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Создание таблицы маршрутов
> * Создание маршрута
> * Связывание таблицы маршрутов с подсетью виртуальной сети.
> * Тестирование маршрутизации.
> * Устранение неполадок с маршрутизацией.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="log-in-to-azure"></a>Вход в Azure 

Войдите на портал Azure по адресу http://portal.azure.com.

## <a name="create-a-route-table"></a>Создание таблицы маршрутов

По умолчанию Azure маршрутизирует трафик между всеми подсетями в виртуальной сети. Дополнительные сведения о маршрутах Azure по умолчанию см. в разделе о [системных маршрутах](virtual-networks-udr-overview.md). Чтобы переопределить маршрутизацию Azure по умолчанию, создайте заполненную таблицу маршрутов и свяжите ее с подсетью виртуальной сети.

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Сетевые подключения**, а затем — **Таблица маршрутов**.
3. Выберите вашу **подписку**, а затем выберите или введите следующие сведения и нажмите кнопку **Создать**:
 
    ![Создание таблицы маршрутов](./media/tutorial-create-route-table-portal/create-route-table.png) 

## <a name="create-a-route"></a>Создание маршрута

Таблица маршрутов содержит несколько маршрутов или не содержит их вообще. 

1. В поле *Search resources, services, and docs* (Поиск ресурсов, служб и документов) в верхней части портала введите *myRouteTablePublic*. Когда таблица **myRouteTablePublic** появится в результатах поиска, выберите ее.
2. В разделе **Параметры** выберите **Маршруты**, а затем щелкните **+ Добавить**, как показано на следующем рисунке:

    ![Добавление маршрута](./media/tutorial-create-route-table-portal/add-route.png) 
 
4. В разделе **Добавление маршрута** выберите или введите следующие сведения, а затем нажмите кнопку **ОК**:
    - **Имя маршрута**: *ToPrivateSubnet*.
    - **Префикс адреса**: 10.0.1.0/24.
    - **Тип следующего прыжка**: выберите **Виртуальный модуль**.
    - **Адрес следующего прыжка**: 10.0.2.4.

    Маршрут будет направлять весь трафик, предназначенный для префикса адреса 10.0.1.0/24, через сетевой виртуальный модуль с IP-адресом 10.0.2.4. Сетевой виртуальный модуль и подсеть с указанным префиксом адреса создаются на последующих этапах. Этот маршрут переопределяет маршрут по умолчанию Azure, который перенаправляет трафик между подсетями напрямую. Каждый маршрут определяет тип следующего прыжка, который указывает Azure, как маршрутизировать трафик. В этом примере тип следующего прыжка — *VirtualAppliance*. Дополнительные сведения обо всех доступных типах следующих прыжков в Azure, а также случаях их использования см. в [этой статье](virtual-networks-udr-overview.md#custom-routes).

## <a name="associate-a-route-table-to-a-subnet"></a>Связывание таблицы маршрутов с подсетью

Чтобы можно было связать таблицу маршрутов с подсетью, необходимо создать виртуальную сеть и подсеть.

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Щелкните **Сеть** и выберите **Виртуальная сеть**.
3. В разделе **Создание виртуальной сети** выберите или введите следующие сведения, а затем нажмите кнопку **Создать**:
    
    - **Имя**: *myVirtualNetwork*.
    - **Адресное пространство**: *10.0.0.0/16*.
    - **Подписка**: выберите свою подписку.
    - **Группа ресурсов**: установите флажок **Использовать существующий** и выберите **myResourceGroup**.
    - **Расположение**: Выберите *Восточная часть США*.
    - **Имя подсети**: *Public*.
    - **Диапазон адресов:** *10.0.0.0/24*.

4. В поле **Search resources, services, and docs** (Поиск ресурсов, служб и документов) в верхней части портала введите *myVirtualNetwork*. Когда в результатах поиска появится пункт **myVirtualNetwork**, выберите его.
5. Добавьте две дополнительные подсети в виртуальную сеть. В разделе **Параметры** выберите  **Подсети**, а затем — **+ Подсеть**, как показано на следующем рисунке:

    ![Добавление подсети](./media/tutorial-create-route-table-portal/add-subnet.png) 

6. Выберите или введите соответствующие сведения, а затем нажмите кнопку **ОК**:
    - **Имя**: Private.
    - **Адресное пространство**: *10.0.1.0/24*.

7. Выполните шаги 5 и 6 еще раз, указав следующие сведения:
    - **Имя**: DMZ.
    - **Адресное пространство**: *10.0.2.0/24*.

Таблицу маршрутов можно связать с несколькими подсетями или не связывать ни с одной. Подсеть может иметь не более одной таблицы маршрутов, связанной с ней. Исходящий трафик из подсети маршрутизируется на основе маршрутов по умолчанию Azure. Любые настраиваемые маршруты, добавленные в таблицу маршрутов, связываются с подсетью. Свяжите таблицу маршрутов *myRouteTablePublic* с подсетью *Public*:

1. По завершении предыдущего шага появляется поле **myVirtualNetwork — подсети**. В разделе **Параметры** выберите **Подсети**, а затем — **Public**.
2. Как показано на рисунке ниже, выберите **Таблица маршрутов**, а затем — **MyRouteTablePublic**.

    ![Связывание таблицы маршрутов](./media/tutorial-create-route-table-portal/associate-route-table.png) 

3. Щелкните **Сохранить**.

## <a name="test-routing"></a>Тестирование маршрутизации

Чтобы протестировать маршрутизацию, создайте виртуальную машину, которая будет служить в качестве сетевого виртуального модуля, через который проходит маршрут, созданный на предыдущем шаге. После создания сетевого виртуального модуля необходимо развернуть виртуальную машину в подсетях *Public* (Общая) и *Private* (Частная). Затем маршрутизируйте трафик из подсети *Public* в подсеть *Private* через сетевой виртуальный модуль.

### <a name="create-a-network-virtual-appliance"></a>Создание сетевого виртуального модуля

На предыдущем шаге был создан маршрут, указывающий сетевой виртуальный модуль в качестве типа следующего прыжка. Виртуальная машина, на которой выполняется сетевое приложение, часто называется сетевым виртуальным модулем. В рабочей среде развертываемый сетевой виртуальный модуль чаще всего представляет собой предварительно настроенную виртуальную машину. В [Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/category/networking?search=network%20virtual%20appliance&page=1) доступны несколько сетевых виртуальных модулей. В этой статье описывается создание базовой виртуальной машины.

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Вычисления**, а затем — **Windows Server 2016 Datacenter**. Вы можете выбрать другую ОС, однако в оставшейся части этого руководства предполагается, что выбрано **Windows Server 2016 Datacenter**. 
3. Выберите или введите следующие сведения в поле **Основные сведения**, а затем нажмите кнопку **ОК**.
    - **Имя**: *myVmNva*.
    - **Группа ресурсов**. Установите флажок **Использовать существующий** и выберите *myResourceGroup*.
    - **Расположение**. Выберите *Восточная часть США*.

    Введенные **имя пользователя** и **пароль** понадобятся позже. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm). Выбранные **расположение** и **подписка** должны совпадать с расположением и подпиской виртуальной сети. Не обязательно выбирать группу ресурсов, в которой была создана виртуальная сеть, но в данном руководстве используется эта группа ресурсов.
4. Выберите размер виртуальной машины в области **Выбор размера**.
5. Выберите или введите следующие сведения в поле **Параметры**, а затем нажмите кнопку **ОК**.
    - **Виртуальная сеть**. Убедитесь, что выбрана сеть **myVirtualNetwork**. В противном случае выберите **Виртуальная сеть**, а затем в разделе **Выберите виртуальную сеть** выберите **myVirtualNetwork**.
    - **Подсеть**: выберите **Подсеть**, а затем в разделе **Выберите подсеть** выберите **DMZ**.
    - **Общедоступный IP-адрес**: выберите **Общедоступный IP-адрес** и в разделе **Выберите общедоступный IP-адрес** щелкните **Нет**. Этой виртуальной машине не назначен общедоступный IP-адрес, поэтому у нее не будет подключений к Интернету.
6. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины.

Создание виртуальной машины занимает несколько минут. Не переходите к следующему шагу до тех пор, пока Azure не завершит создание виртуальной машины и не откроет окно со сведениями о ней.

При создании виртуальной машины в подсети *DMZ* в Azure также был создан [сетевой интерфейс](virtual-network-network-interface.md), который был подключен к этой машине. Необходимо включить IP-пересылку для каждого сетевого интерфейса Azure, перенаправляющего трафик, предназначенный для любого IP-адреса, не назначенного сетевому интерфейсу.

1. В окне, которое открывается для виртуальной машины после ее создания, в разделе **Параметры** выберите **Сети**, а затем — **myvmnva158** (сетевой интерфейс Azure, созданный для виртуальной машины, имеет другой номер после **myvmnva**), как показано на следующем рисунке:

    ![Сетевые подключения виртуальных машин](./media/tutorial-create-route-table-portal/virtual-machine-networking.png) 

    При создании сетевого виртуального модуля в подсети *DMZ* Azure автоматически создала сетевой интерфейс, присоединила его к виртуальной машине и назначила ему частный IP-адрес *10.0.2.4*. 

2. В разделе **Параметры** выберите **Конфигурации IP**, щелкните **Включено** для параметра **IP-пересылка** и, наконец, нажмите кнопку **Сохранить**, как показано на следующем рисунке:

    ![Включение IP-пересылки](./media/tutorial-create-route-table-portal/enable-ip-forwarding.png) 

### <a name="create-virtual-machines"></a>Создание виртуальных машин

Создайте две виртуальные машины в виртуальной сети, чтобы в дальнейшем можно было проверить, что трафик из подсети *Public* направляется в подсеть *Private* через сетевой виртуальный модуль.

Выполните шаги 1–6 раздела о [создании сетевого виртуального устройства](#create-a-network-virtual-appliance). Используйте те же параметры в шагах 3 и 5, за исключением следующих изменений:

|Виртуальная машина.   |ИМЯ      |Подсеть      | Общедоступный IP-адрес     |
|---------         |--------- | -----------|---------              |
|Виртуальная машина 1 | myVmWeb  | Общедоступные     | Примите значения по умолчанию, показанные на портале |
|Виртуальная машина 2 | myVmMgmt | Private    | Примите значения по умолчанию, показанные на портале |

Пока Azure создает виртуальную машину *myVmWeb*, можно создать виртуальную машину *myVmMgmt*. Прежде чем приступать к дальнейшим действиям, необходимо дождаться завершения создания в Azure обеих виртуальных машин.

### <a name="route-traffic-through-a-network-virtual-appliance"></a>Маршрутизация трафика через виртуальный сетевой модуль

1. В поле *поиска* в верхней части портала введите *myVmMgmt*. Когда виртуальная машина **myVmMgmt** появится в результатах поиска, выберите ее.
2. Подключите удаленный рабочий стол к виртуальной машине *myVmMgmt*, выбрав **Подключить**, как показано на следующем рисунке:

    ![Подключение к виртуальной машине](./media/tutorial-create-route-table-portal/connect-to-virtual-machine.png)  

3. Чтобы подключиться к виртуальной машине, откройте скачанный RDP-файл. При появлении запроса выберите **Подключиться**.
4. Введите имя пользователя и пароль, указанный при создании виртуальной машины, а затем нажмите кнопку **ОК**. (Возможно, нужно будет выбрать **Дополнительные варианты** и **Использовать другую учетную запись**, чтобы указать учетные данные, введенные при создании виртуальной машины.)
5. При входе в систему может появиться предупреждение о сертификате. Чтобы продолжить процесс подключения, выберите **Да**.
6. Для проверки маршрутизации позже будет использоваться команда tracert.exе. Команда tracert использует протокол ICMP, блокируемый брандмауэром Windows. Включите протокол ICMP через брандмауэр Windows, введя в командной строке следующую команду:

    ```
    netsh advfirewall firewall add rule name=Allow-ping protocol=icmpv4 dir=in action=allow
    ```

    Хотя в этой статье и используется команда tracert для тестирования маршрутизации, не рекомендуется разрешать входящий трафик по протоколу ICMP через брандмауэр Windows в рабочей среде.
7. Вы включили IP-пересылку в Azure для сетевого интерфейса виртуальной машины в разделе [Включение IP-пересылки](#enable-ip-forwarding). Внутри виртуальной машины операционная система или приложение, работающее на виртуальной машине, также должны иметь возможность перенаправлять сетевой трафик. При развертывании сетевого виртуального модуля в рабочей среде он обычно фильтрует, регистрирует или выполняет какую-либо другую функцию перед пересылкой трафика. Однако в этой статье операционная система просто перенаправляет весь трафик, который она получает. Включите IP-пересылку в операционной системе на *myVmNva*, выполнив следующие шаги на виртуальной машине *myVmMgmt*:

    Подключитесь к виртуальной машине *myVmNva* по протоколу удаленного рабочего стола, выполнив следующую команду из командной строки:

    ``` 
    mstsc /v:myvmnva
    ```
    
    Чтобы включить IP-пересылку в операционной системе, введите следующую команду в PowerShell:

    ```powershell
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Name IpEnableRouter -Value 1
    ```
    
    Перезагрузите виртуальную машину, что также приведет к отключению сеанса удаленного рабочего стола.
8. Будучи подключенными к виртуальной машине *myVmMgmt*, после перезапуска виртуальной машины *myVmNva* создайте сеанс подключения к удаленному рабочему столу виртуальной машины *myVmWeb* с помощью следующей команды:

    ``` 
    mstsc /v:myVmWeb
    ```
    
    Включите протокол ICMP через брандмауэр Windows, введя в командной строке следующую команду:

    ```
    netsh advfirewall firewall add rule name=Allow-ping protocol=icmpv4 dir=in action=allow
    ```

9. Для тестирования маршрутизации сетевого трафика между виртуальными машинами *myVmMgmt* и *myVmWeb* введите в командной строке следующую команду:

    ```
    tracert myvmmgmt
    ```

    Ответ будет выглядеть примерно так:
    
    ```
    Tracing route to myvmmgmt.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.1.4]
    over a maximum of 30 hops:
        
    1    <1 ms     *        1 ms  10.0.2.4
    2     1 ms     1 ms     1 ms  10.0.1.4
        
    Trace complete.
    ```
      
    Можно заметить, что первому прыжку соответствует 10.0.2.4. Это частный IP-адрес сетевого виртуального модуля. Второй прыжок — 10.0.1.4. Это частный IP-адрес виртуальной машины *myVmMgmt*. Из-за маршрута, добавленного в таблицу маршрутов *myRouteTablePublic* и связанного с подсетью *Public*, трафик в Azure был маршрутизирован через NVA, а не напрямую в подсеть *Private*.
10.  Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmWeb*, оставаясь подключенными к виртуальной машине *myVmMgmt*.
11. Для тестирования маршрутизации сетевого трафика между виртуальными машинами *myVmWeb* и *myVmMgmt* введите в командной строке следующую команду:

    ```
    tracert myvmweb
    ```

    Ответ будет выглядеть примерно так:

    ```
    Tracing route to myvmweb.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.0.4]
    over a maximum of 30 hops:
    
    1     1 ms     1 ms     1 ms  10.0.0.4
    
    Trace complete.
    ```

    Теперь можно видеть, что трафик направляется непосредственно из виртуальной машины *myVmMgmt* на виртуальную машину *myVmWeb*. По умолчанию Azure маршрутизирует трафик между подсетями напрямую.
12. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmMgmt*.

## <a name="troubleshoot-routing"></a>Устранение неполадок с маршрутизацией

Как было упомянуто ранее, Azure применяет маршруты по умолчанию, которые при необходимости можно переопределить собственными вариантами. Иногда трафик может не маршрутизироваться ожидаемым образом. Можно использовать возможность [следующего прыжка](../network-watcher/network-watcher-check-next-hop-portal.md) Наблюдателя за сетями в Azure, чтобы определить способ маршрутизации трафика между двумя виртуальными машинами в Azure. 

1. В поле *Поиск* в верхней части портала введите *Наблюдатель за сетями*. Когда в результатах поиска появится **Наблюдатель за сетями**, выберите его.
2. В разделе **Средства диагностики сети** выберите **Следующий прыжок**.
3. Для тестирования маршрутизации трафика из виртуальной машины *myVmWeb* (10.0.0.4) к виртуальной машине *myVmMgmt* (10.0.1.4) выберите свою подписку, введите сведения, показанные на следующем рисунке (имя вашего **сетевого интерфейса** будет немного отличаться), а затем выберите **Следующий прыжок**:

    ![Следующий прыжок](./media/tutorial-create-route-table-portal/next-hop.png)  

    В **итоговых выходных данных** сообщается, что IP-адрес следующего прыжка для трафика из *myVmWeb* в *myVmMgmt* — 10.0.2.4 (*myVmNva*), что следующий тип прыжка — *VirtualAppliance*, а таблица маршрутов, которая вызывает маршрутизацию, — *myRouteTablePublic*.

Действующие маршруты для каждого сетевого интерфейса представляют собой комбинацию маршрутов по умолчанию Azure и любых определяемых вами маршрутов. Чтобы просмотреть все маршруты, действующие для сетевого интерфейса виртуальной машины, выполните следующие действия:

1. В поле *Поиск* в верхней части портала введите *myVmWeb*. При появлении **myVmWeb** в результатах поиска выберите ее.
2. В разделе **Параметры** выберите **Сети**, а затем выберите **myvmweb369** (сетевой интерфейс Azure, созданный для вашей виртуальной машины, имеет другой номер после **myvmweb**).
3. В разделе **Поддержка и устранение неполадок** выберите **Действующие маршруты**, как показано на следующем рисунке:

    ![Действующие маршруты](./media/tutorial-create-route-table-portal/effective-routes.png) 

    Вы видите маршруты Azure по умолчанию и маршрут, добавленный в таблицу маршрутов *myRouteTablePublic*. Дополнительные сведения о том, как Azure выбирает маршрут из списка маршрутов, см. в [этом разделе](virtual-networks-udr-overview.md#how-azure-selects-a-route).

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна. 

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

При работе с этой статьей вы создали таблицу маршрутов и связали ее с подсетью. Вы также создали сетевой виртуальный модуль, который направляет трафик из общедоступной подсети в частную подсеть. Хотя в виртуальной сети можно развернуть множество ресурсов Azure, ресурсы для некоторых служб PaaS Azure развернуть невозможно. Тем не менее вы все же можете ограничить доступ к ресурсам некоторых служб PaaS в Azure трафиком только из подсети виртуальной сети. Перейдите к следующему руководству, чтобы узнать, как ограничить сетевой доступ к ресурсам PaaS Azure.

> [!div class="nextstepaction"]
> [Настройка конечных точек служб виртуальной сети](virtual-network-service-endpoints-configure.md#azure-portal)
