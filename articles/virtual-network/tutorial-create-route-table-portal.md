---
title: Руководство. Маршрутизация сетевого трафика с помощью портала Azure | Документы Майкрософт
description: В этом руководстве описано, как маршрутизировать сетевой трафик с помощью таблицы маршрутов и портала Azure.
services: virtual-network
documentationcenter: virtual-network
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
Customer intent: I want to route traffic from one subnet, to a different subnet, through a network virtual appliance.
ms.assetid: ''
ms.service: virtual-network
ms.devlang: azurecli
ms.topic: tutorial
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 03/13/2018
ms.author: jdial
ms.custom: mvc
ms.openlocfilehash: 81478ace72a538f4970e114cd704fd64ceb94aa6
ms.sourcegitcommit: 756f866be058a8223332d91c86139eb7edea80cc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2018
ms.locfileid: "37344905"
---
# <a name="tutorial-route-network-traffic-with-a-route-table-using-the-azure-portal"></a>Руководстве. Маршрутизация сетевого трафика с помощью таблицы маршрутов и портала Azure

По умолчанию Azure автоматически маршрутизирует трафик между всеми подсетями в виртуальной сети. Для переопределения маршрутизации Azure по умолчанию можно создать собственные маршруты. Возможность создания настраиваемых маршрутов полезна, если, к примеру, требуется маршрутизировать трафик между подсетями через виртуальный сетевой модуль. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание таблицы маршрутов
> * Создание маршрута
> * Создание виртуальной сети с несколькими подсетями
> * Связывание таблицы маршрутов с подсетью
> * Создание виртуального сетевого модуля, который перенаправляет трафик
> * Развертывание виртуальных машин в разных подсетях
> * Направление трафика из одной подсети в другую через виртуальный сетевой модуль

При необходимости инструкции из этого руководства можно выполнить с помощью [Azure CLI](tutorial-create-route-table-cli.md) или [Azure PowerShell](tutorial-create-route-table-powershell.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="log-in-to-azure"></a>Вход в Azure 

Войдите на портал Azure по адресу http://portal.azure.com.

## <a name="create-a-route-table"></a>Создание таблицы маршрутов

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Сетевые подключения**, а затем — **Таблица маршрутов**.
3. Введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и щелкните **Создать**:

    |Параметр|Значение|
    |---|---|
    |Действие|myRouteTablePublic|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов | Выберите **Создать новую**, а затем введите *myResourceGroup*.|
    |Расположение|Восток США|
 
    ![Создание таблицы маршрутов](./media/tutorial-create-route-table-portal/create-route-table.png) 

## <a name="create-a-route"></a>Создание маршрута

1. В поле *Search resources, services, and docs* (Поиск ресурсов, служб и документов) в верхней части портала введите *myRouteTablePublic*. Когда таблица **myRouteTablePublic** появится в результатах поиска, выберите ее.
2. В разделе **Параметры** выберите **Маршруты**, а затем щелкните **+ Добавить**, как показано на следующем рисунке:

    ![Добавление маршрута](./media/tutorial-create-route-table-portal/add-route.png) 
 
3. В разделе **Добавление маршрута** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и щелкните **Создать**:

    |Параметр|Значение|
    |---|---|
    |Имя маршрута|ToPrivateSubnet|
    |Префикс адреса| 10.0.1.0/24|
    |Тип следующего прыжка | Выберите **Виртуальный модуль**.|
    |Адрес следующего прыжка| 10.0.2.4|

## <a name="associate-a-route-table-to-a-subnet"></a>Связывание таблицы маршрутов с подсетью

Чтобы связать таблицу маршрутов с подсетью, необходимо создать виртуальную сеть и подсеть. Теперь вы сможете связать таблицу маршрутов с подсетью.

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Щелкните **Сеть** и выберите **Виртуальная сеть**.
3. В разделе **Создание виртуальной сети** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и щелкните **Создать**:

    |Параметр|Значение|
    |---|---|
    |Действие|myVirtualNetwork|
    |Пространство адресов| 10.0.0.0/16|
    |Подписка | Выберите свою подписку.|
    |Группа ресурсов|Щелкните **Use existing** (Использовать существующую), а затем выберите **myResourceGroup**.|
    |Расположение|Выберите *Восточная часть США*.|
    |Имя подсети|Общедоступные|
    |Диапазон адресов|10.0.0.0/24|
    
4. В поле **Search resources, services, and docs** (Поиск ресурсов, служб и документов) в верхней части портала введите *myVirtualNetwork*. Когда в результатах поиска появится пункт **myVirtualNetwork**, выберите его.
5. В разделе **Параметры** выберите  **Подсети**, а затем — **+ Подсеть**, как показано на следующем рисунке:

    ![Добавление подсети](./media/tutorial-create-route-table-portal/add-subnet.png) 

6. Выберите или введите соответствующие сведения, а затем нажмите кнопку **ОК**:

    |Параметр|Значение|
    |---|---|
    |Действие|Private|
    |Пространство адресов| 10.0.1.0/24|

7. Выполните шаги 5 и 6 еще раз, указав следующие сведения:

    |Параметр|Значение|
    |---|---|
    |Действие|DMZ|
    |Пространство адресов| 10.0.2.0/24|

8. По завершении предыдущего шага появляется поле **myVirtualNetwork — подсети**. В разделе **Параметры** выберите **Подсети**, а затем — **Public**.
9. Как показано на рисунке ниже, выберите **Таблица маршрутов**, затем выберите **MyRouteTablePublic** и щелкните **Сохранить**.

    ![Связывание таблицы маршрутов](./media/tutorial-create-route-table-portal/associate-route-table.png) 

## <a name="create-an-nva"></a>Создание виртуального сетевого модуля

Виртуальный сетевой модуль представляет собой виртуальную машину, которая выполняет сетевые функции, такие как маршрутизация, защита брандмауэром или оптимизация доступа к глобальной сети.

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Вычисления**, а затем — **Windows Server 2016 Datacenter**. Вы можете выбрать другую ОС, однако в оставшейся части этого руководства предполагается, что выбрано **Windows Server 2016 Datacenter**. 
3. Выберите или введите следующие сведения в поле **Основные сведения**, а затем нажмите кнопку **ОК**.

    |Параметр|Значение|
    |---|---|
    |Действие|myVmNva|
    |Имя пользователя|Введите выбранное имя пользователя.|
    |Пароль|Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Группа ресурсов| Щелкните **Use existing** (Использовать существующую), а затем выберите *myResourceGroup*.|
    |Расположение|Выберите **Восточная часть США**.|
4. Выберите размер виртуальной машины в области **Выбор размера**.
5. Выберите или введите следующие сведения в поле **Параметры**, а затем нажмите кнопку **ОК**.

    |Параметр|Значение|
    |---|---|
    |Виртуальная сеть|Если не выбрана сеть myVirtualNetwork, щелкните **Виртуальная сеть**, а затем в разделе **Выберите виртуальную сеть** выберите **myVirtualNetwork**.|
    |Подсеть|Выберите **Подсеть**, а затем в разделе **Выберите подсеть** щелкните **DMZ**. |
    |Общедоступный IP-адрес| Выберите **Общедоступный IP-адрес** и в разделе **Выберите общедоступный IP-адрес** щелкните **Нет**. Этой виртуальной машине не назначается общедоступный IP-адрес, так как мы не планируем подключаться к ней из Интернета.
6. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины.

    Создание виртуальной машины занимает несколько минут. Переходите к следующему шагу только после того, как Azure завершит создание виртуальной машины и откроет окно с данными о ней.

7. В окне, которое открывается для виртуальной машины после ее создания, в разделе **Параметры** выберите **Сети**, а затем — **myvmnva158** (сетевой интерфейс Azure, созданный для виртуальной машины, имеет имя **myvmnva** с другим номером), как показано на следующем рисунке:

    ![Сеть виртуальной машины](./media/tutorial-create-route-table-portal/virtual-machine-networking.png) 

8. В сетевом интерфейсе должна быть включена IP-пересылка, чтобы он мог перенаправлять отправленный ему сетевой трафик, который не предназначен для его собственного IP-адреса. В разделе **Параметры** выберите **Конфигурации IP**, щелкните **Включено** для параметра **IP-пересылка** и, наконец, нажмите кнопку **Сохранить**, как показано на следующем рисунке:

    ![Включение IP-пересылки](./media/tutorial-create-route-table-portal/enable-ip-forwarding.png) 

## <a name="create-virtual-machines"></a>Создание виртуальных машин

Создайте в виртуальной сети две виртуальные машины, чтобы на следующем шаге с их помощью проверить, что трафик из подсети *Public* направляется в подсеть *Private* через виртуальный сетевой модуль. Выполните шаги 1–6 из раздела [Создание виртуального сетевого модуля](#create-a-network-virtual-appliance). Используйте те же параметры в шагах 3 и 5, за исключением следующих изменений:

|Имя виртуальной машины      |Подсеть      | Общедоступный IP-адрес     |
|--------- | -----------|---------              |
| myVmPublic  | Общедоступные     | Примите значения по умолчанию, показанные на портале |
| myVmPrivate | Private    | Примите значения по умолчанию, показанные на портале |

Вы можете заняться созданием виртуальной машины *myVmPrivate*, пока Azure создает виртуальную машину *myVmPublic*. Прежде чем переходить к дальнейшим действиям, дождитесь, пока Azure создаст обе виртуальные машины.

## <a name="route-traffic-through-an-nva"></a>Перенаправление трафика через виртуальный сетевой модуль

1. В поле *Поиск* в верхней части портала введите *myVmPrivate*. Когда в результатах поиска появится виртуальная машина **myVmPrivate**, щелкните ее.
2. Подключите удаленный рабочий стол к виртуальной машине *myVmPrivate*, выбрав **Подключиться**, как показано на следующем рисунке:

    ![Подключение к виртуальной машине ](./media/tutorial-create-route-table-portal/connect-to-virtual-machine.png)  

3. Чтобы подключиться к виртуальной машине, откройте скачанный RDP-файл. При появлении запроса выберите **Подключиться**.
4. Введите имя пользователя и пароль, которые вы указали при создании виртуальной машины (возможно, для этого придется выбрать **Дополнительные варианты** и **Использовать другую учетную запись**). Затем нажмите кнопку **ОК**.
5. При входе в систему может появиться предупреждение о сертификате. Чтобы продолжить процесс подключения, выберите **Да**.
6. Для проверки маршрутизации позже будет использоваться средство трассировки маршрута. Средство трассировки маршрута использует протокол ICMP, который запрещен в брандмауэре Windows. Разрешите протокол ICMP в брандмауэре Windows с помощью следующей команды PowerShell в виртуальной машине *myVmPrivate*:

    ```powershell
    New-NetFirewallRule –DisplayName “Allow ICMPv4-In” –Protocol ICMPv4
    ```

    Хотя в этом руководстве для тестирования маршрутизации используется средство трассировки маршрута, не рекомендуется разрешать входящий трафик по протоколу ICMP через брандмауэр Windows в рабочей среде.
7. Вы уже включили в Azure IP-пересылку для сетевого интерфейса виртуальной машины, выполнив инструкции из раздела [Включение IP-пересылки](#enable-ip-forwarding). Операционная система или приложение, работающие на виртуальной машине, также должны уметь перенаправлять сетевой трафик. Чтобы включить IP-пересылку в операционной системе виртуальной машины *myVmNva*:

    Из командной строки виртуальной машины *myVmPrivate* подключитесь к виртуальной машине *myVmNva* по протоколу удаленного рабочего стола:

    ``` 
    mstsc /v:myvmnva
    ```
    
    Чтобы включить IP-пересылку в операционной системе, введите следующую команду PowerShell в виртуальной машине *myVmNva*:

    ```powershell
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Name IpEnableRouter -Value 1
    ```
    
    Перезапустите виртуальную машину *myVmNva*. При этом автоматически завершится сеанс удаленного рабочего стола.
8. Когда виртуальная машина *myVmNva* перезапустится, создайте сеанс удаленного рабочего стола для виртуальной машины *myVmPublic*, сохраняя подключение к виртуальной машине *myVmPrivate*:

    ``` 
    mstsc /v:myVmPublic
    ```
    
    Разрешите протокол ICMP в брандмауэре Windows с помощью следующей команды PowerShell на виртуальной машине *myVmPublic*:

    ```powershell
    New-NetFirewallRule –DisplayName “Allow ICMPv4-In” –Protocol ICMPv4
    ```

9. Протестируйте маршрутизацию сетевого трафика к виртуальной машине *myVmPrivate* от виртуальной машины *myVmPublic*, выполнив следующую команду PowerShell на виртуальной машине *myVmPublic*:

    ```
    tracert myVmPrivate
    ```

    Ответ будет выглядеть примерно так:
    
    ```
    Tracing route to myVmPrivate.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.1.4]
    over a maximum of 30 hops:
        
    1    <1 ms     *        1 ms  10.0.2.4
    2     1 ms     1 ms     1 ms  10.0.1.4
        
    Trace complete.
    ```
      
    Можно заметить, что первым прыжком указан частный IP-адрес виртуального сетевого модуля (10.0.2.4). Второй прыжок — 10.0.1.4. Это частный IP-адрес виртуальной машины *myVmPrivate*. Из-за маршрута, добавленного в таблицу маршрутов *myRouteTablePublic* и связанного с подсетью *Public*, трафик в Azure был маршрутизирован через NVA, а не напрямую в подсеть *Private*.
10.  Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPublic*, сохраняя подключение к виртуальной машине *myVmPrivate*.
11. Протестируйте маршрутизацию сетевого трафика к виртуальной машине *myVmPublic* от виртуальной машины *myVmPrivate*, выполнив следующую команду интерфейса командной строки на виртуальной машине *myVmPrivate*:

    ```
    tracert myVmPublic
    ```

    Ответ будет выглядеть примерно так:

    ```
    Tracing route to myVmPublic.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.0.4]
    over a maximum of 30 hops:
    
    1     1 ms     1 ms     1 ms  10.0.0.4
    
    Trace complete.
    ```

    Вы увидите, что трафик направляется непосредственно от виртуальной машины *myVmPrivate* на виртуальную машину *myVmPublic*. По умолчанию Azure маршрутизирует трафик между подсетями напрямую.
12. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPrivate*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна. 

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

При работе с этим руководстве вы создали таблицу маршрутов и связали ее с подсетью. Вы также создали простой виртуальный сетевой модуль, который направляет трафик из общедоступной подсети в частную подсеть. [Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/category/networking) предоставляет широкий выбор предварительно настроенных виртуальных сетевых модулей для разных сетевых функций, например модули брандмауэра и оптимизация доступа к глобальной сети. См. дополнительные сведения о [маршрутизации](virtual-networks-udr-overview.md) и [управлении таблицей маршрутов](manage-route-table.md).


Хотя в виртуальной сети можно развернуть множество ресурсов Azure, ресурсы для некоторых служб PaaS Azure развернуть невозможно. Тем не менее вы все же можете ограничить доступ к ресурсам некоторых служб PaaS в Azure трафиком только из подсети виртуальной сети. Перейдите к следующему руководству, чтобы узнать, как ограничить сетевой доступ к ресурсам Azure PaaS.

> [!div class="nextstepaction"]
> [Настройка конечных точек служб виртуальной сети](tutorial-restrict-network-access-to-resources.md)
