---
title: Мониторинг операций, событий и счетчиков для групп безопасности сети | Microsoft Docs
description: Включение ведения журналов счетчиков, событий и операций для групп безопасности сети
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
tags: azure-resource-manager

ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 07/14/2016
ms.author: jdial

---
# Аналитика журналов для групп безопасности сети
В Azure можно использовать различные виды журналов для управления группами безопасности сети (NSG) и устранения возникающих в них неполадок. К некоторым из этих журналов можно получить доступ через портал. Кроме того, можно извлечь все журналы из хранилища BLOB-объектов Azure и просматривать их с помощью таких инструментов, как [Log Analytics](../log-analytics/log-analytics-azure-networking-analytics.md), Excel и PowerBI. В списке ниже приведены дополнительные сведения о различных типах журналов.

* **Журналы аудита.** В [журналах аудита Azure](../azure-portal/insights-debugging-with-events.md) (прежнее название — операционные журналы) можно просмотреть все операции, отправляемые в ваши подписки Azure, и состояние этих операций. По умолчанию журналы аудита включены, и их можно просмотреть на портале предварительной версии Azure.
* **Журналы событий.** Этот журнал позволяет просмотреть правила, NSG примененные к виртуальным машинам и экземплярам ролей на основе MAC-адреса. Состояние этих правил регистрируется каждые 60 секунд.
* **Журналы счетчиков.**. Этот журнал позволяет просмотреть, сколько раз каждое правило NSG было применено для запрета или разрешения трафика.

> [!WARNING]
> Журналы доступны только для ресурсов, развернутых в модели развертывания диспетчера ресурсов. Журналы нельзя использовать для ресурсов в классической модели развертывания. Чтобы получить более полное представление об этих двух моделях, см. статью [Общие сведения о развертывании диспетчера ресурсов и классическом развертывании](../resource-manager-deployment-model.md).
> 
> 

## Включение ведения журналов
Ведение журналов аудита автоматически включено постоянно для каждого ресурса диспетчера ресурсов. Ведение журналов событий и счетчиков необходимо включить, чтобы начать сбор соответствующих данных. Чтобы включить ведение журнала, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com). Если группа безопасности сети еще не создана, [создайте ее](virtual-networks-create-nsg-arm-ps.md).
2. На портале предварительной версии последовательно выберите пункты **Обзор** >> **Группы безопасности сети**.
   
   ![Портал предварительной версии — группы безопасности сети](./media/virtual-network-nsg-manage-log/portal-enable1.png)
3. Выберите существующую группу безопасности сети.
   
    ![Портал предварительной версии — параметры групп безопасности сети](./media/virtual-network-nsg-manage-log/portal-enable2.png)
4. В колонке **Параметры** щелкните **Диагностика**, а затем на панели **Диагностика** рядом с полем **Состояние** щелкните **Вкл.**
5. В колонке **Параметры** щелкните **Учетная запись хранения** и выберите существующую учетную запись хранения или создайте новую.

> [AZURE.INFORMATION] Для журналов аудита отдельная учетная запись хранения не требуется. За использование хранилища для журналов событий и правил взимается плата.
> 
> 

1. В раскрывающемся списке непосредственно под элементом **Учетная запись хранения** выберите, что именно следует регистрировать — события, счетчики или то и другое, — а затем нажмите кнопку **Сохранить**.
   
    ![Портал предварительной версии — журналы диагностики](./media/virtual-network-nsg-manage-log/portal-enable3.png)

## Журнал аудита
Этот журнал (прежнее название — «операционный журнал») создается в Azure по умолчанию. Журналы хранятся в течение 90 дней в хранилище журналов событий Azure. Дополнительные сведения об этих журналах см. в статье [Просмотр журналов событий и аудита](../azure-portal/insights-debugging-with-events.md).

## Журнал счетчиков
Этот журнал создается только в том случае, если он включен для конкретной группы безопасности сети, как описано выше. Данные хранятся в учетной записи хранения, указанной при включении ведения журнала. Каждое правило, примененное к ресурсам, заносится в журнал в формате JSON, как показано ниже.

    {
        "time": "2015-09-11T23:14:22.6940000Z",
        "systemId": "e22a0996-e5a7-4952-8e28-4357a6e8f0c5",
        "category": "NetworkSecurityGroupRuleCounter",
        "resourceId": "/SUBSCRIPTIONS/D763EE4A-9131-455F-8C5E-876035455EC4/RESOURCEGROUPS/INSIGHTOBONRP/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/NSGINSIGHTOBONRP",
        "operationName": "NetworkSecurityGroupCounters",
        "properties": {
            "vnetResourceGuid":"{DD0074B1-4CB3-49FA-BF10-8719DFBA3568}",
            "subnetPrefix":"10.0.0.0/24",
            "macAddress":"001517D9C43C",
            "ruleName":"DenyAllOutBound",
            "direction":"Out",
            "type":"block",
            "matchedConnections":0
            }
    }

## Журнал событий
Этот журнал создается только в том случае, если он включен для конкретной группы безопасности сети, как описано выше. Данные хранятся в учетной записи хранения, указанной при включении ведения журнала. В журнал записываются следующие данные:

    {
        "time": "2015-09-11T23:05:22.6860000Z",
        "systemId": "e22a0996-e5a7-4952-8e28-4357a6e8f0c5",
        "category": "NetworkSecurityGroupEvent",
        "resourceId": "/SUBSCRIPTIONS/D763EE4A-9131-455F-8C5E-876035455EC4/RESOURCEGROUPS/INSIGHTOBONRP/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/NSGINSIGHTOBONRP",
        "operationName": "NetworkSecurityGroupEvents",
        "properties": {
            "vnetResourceGuid":"{DD0074B1-4CB3-49FA-BF10-8719DFBA3568}",
            "subnetPrefix":"10.0.0.0/24",
            "macAddress":"001517D9C43C",
            "ruleName":"AllowVnetOutBound",
            "direction":"Out",
            "priority":65000,
            "type":"allow",
            "conditions":{
                "destinationPortRange":"0-65535",
                "sourcePortRange":"0-65535",
                "destinationIP":"10.0.0.0/8,172.16.0.0/12,169.254.0.0/16,192.168.0.0/16,168.63.129.16/32",
                "sourceIP":"10.0.0.0/8,172.16.0.0/12,169.254.0.0/16,192.168.0.0/16,168.63.129.16/32"
            }
        }
    }

## Просмотр и анализ журнала аудита
Данные журнала аудита можно просматривать и анализировать с помощью любого из следующих методов.

* **Средства Azure.** Информацию из журналов аудита можно получать с помощью Azure PowerShell, интерфейса командной строки (CLI) Azure, интерфейса REST API Azure или портала предварительной версии Azure. Пошаговые инструкции для каждого метода подробно описаны в статье [Операции аудита с помощью диспетчера ресурсов](../resource-group-audit.md).
* **Power BI.** Если у вас еще нет учетной записи [Power BI](https://powerbi.microsoft.com/pricing), ее можно опробовать бесплатно. Используя [пакет содержимого журналов аудита Azure для Power BI](https://powerbi.microsoft.com/documentation/powerbi-content-pack-azure-audit-logs/), можно анализировать данные с помощью предварительно настроенных панелей мониторинга, которые можно использовать как есть или дополнительно настроить.

## Просмотр и анализ журналов счетчиков и событий
Служба Azure [Log Analytics](../log-analytics/log-analytics-azure-networking-analytics.md) собирает файлы журнала событий и счетчика из вашей учетной записи хранилища BLOB-объектов и включает в себя представления и мощные инструменты поиска для анализа журналов.

Можно также подключиться к учетной записи хранения и извлечь записи журнала в формате JSON для журналов событий и счетчиков. После загрузки JSON-файлов их можно преобразовать в формат CSV и просматривать в Excel, PowerBI или другом средстве визуализации данных.

> [!TIP]
> Если вы знакомы с Visual Studio и основными понятиями изменения значений констант и переменных в C#, можно использовать [средства преобразования журнала](https://github.com/Azure-Samples/networking-dotnet-log-converter), доступные на сайте GitHub.
> 
> 

## Дальнейшие действия
* Визуализация счетчика и журналов событий с помощью [Log Analytics](../log-analytics/log-analytics-azure-networking-analytics.md).
* Запись блога [Визуализация журналов аудита Azure с помощью Power BI](http://blogs.msdn.com/b/powerbi/archive/2015/09/30/monitor-azure-audit-logs-with-power-bi.aspx).
* Запись блога [Просмотр и анализ журналов аудита Azure с помощью Power BI и других средств](https://azure.microsoft.com/blog/analyze-azure-audit-logs-in-powerbi-more/).

<!---HONumber=AcomDC_0810_2016-->