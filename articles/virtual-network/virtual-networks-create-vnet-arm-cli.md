---
title: Создание виртуальной сети Azure с несколькими подсетями с помощью Azure CLI | Документация Майкрософт
description: Сведения о создании виртуальной сети с несколькими подсетями с помощью Azure CLI.
services: virtual-network
documentationcenter: ''
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-network
ms.devlang: azurecli
ms.topic: ''
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/01/2018
ms.author: jdial
ms.custom: ''
ms.openlocfilehash: 0b0bfae02147910d98231d7c93f5ab260f26364f
ms.sourcegitcommit: a0be2dc237d30b7f79914e8adfb85299571374ec
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2018
ms.locfileid: "29880534"
---
# <a name="create-a-virtual-network-with-multiple-subnets-using-the-azure-cli"></a>Создание виртуальной сети с несколькими подсетями с помощью интерфейса командной строки Azure

Виртуальная сеть позволяет разным типам ресурсов Azure обмениваться данными друг с другом в частном порядке и взаимодействовать через Интернет. Создание нескольких подсетей в виртуальной сети помогает сегментировать сеть, чтобы вы могли фильтровать потоки трафика между подсетями и управлять ими. В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Создать виртуальную сеть
> * Создание подсети
> * Тестирование взаимодействия по сети между виртуальными машинами

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать CLI локально, для выполнения инструкций в этом руководстве вам понадобится Azure CLI 2.0.4 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0](/cli/azure/install-azure-cli.md). 

## <a name="create-a-virtual-network"></a>Создать виртуальную сеть

Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az_group_create). В следующем примере создается группа ресурсов с именем *myResourceGroup* в расположении *eastus*.

```azurecli-interactive 
az group create --name myResourceGroup --location eastus
```

Создайте виртуальную сеть с помощью команды [az network vnet create](/cli/azure/network/vnet#az_network_vnet_create). В следующем примере создается виртуальная сеть с именем *myVirtualNetwork* и префиксом адреса *10.0.0.0/16*. Команда создает одну подсеть с именем *Public* (Общая) и префиксом адреса *10.0.0.0/24*.

```azurecli-interactive 
az network vnet create \
  --name myVirtualNetwork \
  --resource-group myResourceGroup \
  --address-prefixes 10.0.0.0/16 \
  --subnet-name Public \
  --subnet-prefix 10.0.0.0/24
```

Так как в предыдущей команде расположение не указано, Azure создает виртуальную сеть в расположении, в котором находится группа ресурсов *myResourceGroup*. **Префиксы адресов** и **префикс подсети** указаны в нотации CIDR. Указанный префикс адреса включает IP-адреса 10.0.0.0–10.0.255.254. Значение префикса, заданное для подсети, должно быть в пределах префикса адреса, определенного для виртуальной сети. Azure DHCP назначает ресурсам, развертываемым в подсети, IP-адреса на основе префикса адреса подсети. Azure назначает ресурсам, развертываемым в **общей** подсети, только адреса 10.0.0.4–10.0.0.254, так как первые четыре адреса (10.0.0.0–10.0.0.3 для подсети в этом примере) и последний адрес (в этом примере — 10.0.0.255) зарезервированы в каждой подсети.

## <a name="create-a-subnet"></a>Создание подсети

Создайте подсеть с помощью команды [az network vnet subnet create](/cli/azure/network/vnet/subnet#az_network_vnet_subnet_create). В следующем примере создается подсеть с именем *Частная* в пределах виртуальной сети *myVirtualNetwork* и префиксом адреса *10.0.1.0/24*. Префикс адреса должен быть в пределах префикса адреса, определенного для виртуальной сети. Он не может перекрывать префикс адреса любых других подсетей в виртуальной сети.

```azurecli-interactive 
az network vnet subnet create \
  --vnet-name myVirtualNetwork \
  --resource-group myResourceGroup \
  --name Private \
  --address-prefix 10.0.1.0/24
```

Прежде чем развертывать виртуальные сети и подсети Azure для использования в рабочей среде, мы рекомендуем внимательно ознакомиться с [рекомендациями по использованию адресного пространства](manage-virtual-network.md#create-a-virtual-network) и [ограничениями виртуальной сети](../azure-subscription-service-limits.md?toc=%2fazure%2fvirtual-network%2ftoc.json#azure-resource-manager-virtual-networking-limits). После развертывания ресурсов в подсетях для некоторых изменений виртуальной сети и подсети, например изменений диапазонов адресов, может потребоваться повторно развернуть существующие ресурсы Azure, которые были развернуты в подсетях.

## <a name="test-network-communication"></a>Тестирование взаимодействия по сети

Виртуальная сеть позволяет разным типам ресурсов Azure обмениваться данными друг с другом в частном порядке и взаимодействовать через Интернет. Одним из таких ресурсов, который можно развернуть в виртуальной сети, является виртуальная машина. Создайте в виртуальной сети две виртуальные машины, чтобы в дальнейшем можно было проверить обмен данными между ними по сети и через Интернет.

### <a name="create-virtual-machines"></a>Создание виртуальных машин

Создайте виртуальную машину с помощью команды [az vm create](/cli/azure/vm#az_vm_create). В следующем примере создается виртуальная машина с именем *myVmWeb* в *общей* подсети. Параметр `--no-wait` позволяет Azure выполнять команду в фоновом режиме, поэтому вы можете перейти к следующей команде. Для упрощения работы с этим руководством используется пароль. Ключи обычно используются в рабочей среде. Если вы используете ключи, для выполнения оставшихся инструкций необходимо также настроить перенаправление агента SSH. Дополнительные сведения о перенаправлении агента SSH см. в документации для клиента SSH. В следующей команде замените значение `<replace-with-your-password>` паролем по своему выбору.

```azurecli-interactive
adminPassword="<replace-with-your-password>"

az vm create \
  --resource-group myResourceGroup \
  --name myVmWeb \
  --image UbuntuLTS \
  --vnet-name myVirtualNetwork \
  --subnet Public \
  --admin-username azureuser \
  --admin-password $adminPassword \
  --no-wait
```

Azure автоматически назначает виртуальной машине частный IP-адрес 10.0.0.4, так как это первый доступный IP-адрес в *общей* подсети. 

Создайте виртуальную машину в *частной* подсети.

```azurecli-interactive 
az vm create \
  --resource-group myResourceGroup \
  --name myVmMgmt \
  --image UbuntuLTS \
  --vnet-name myVirtualNetwork \
  --subnet Private \
  --admin-username azureuser \
  --admin-password $adminPassword
```
Создание виртуальной машины занимает несколько минут. После создания виртуальной машины Azure CLI возвращает выходные данные следующего вида. 

```azurecli 
{
  "fqdns": "",
  "id": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVmMgmt",
  "location": "eastus",
  "macAddress": "00-0D-3A-23-9A-49",
  "powerState": "VM running",
  "privateIpAddress": "10.0.1.4",
  "publicIpAddress": "13.90.242.231",
  "resourceGroup": "myResourceGroup"
}
```

В приведенном примере можно видеть, что параметр **privateIpAddress** имеет значение *10.0.1.4*. Azure создает [сетевой интерфейс](virtual-network-network-interface.md), подключает его к виртуальной машине, назначает интерфейсу частный IP-адрес и **macAddress**. Azure DHCP автоматически назначает сетевому интерфейсу адрес 10.0.1.4, так как это первый доступный IP-адрес в *частной* подсети. Частные IP- и MAC-адреса остаются назначенными сетевому интерфейсу до его удаления. 

Запишите значение **publicIpAddress**. Позже этот адрес будет использоваться для доступа к виртуальной машине из Интернета. Хотя виртуальной машине не обязательно иметь общедоступный IP-адрес, Azure по умолчанию назначает его каждой виртуальной машине, которую вы создаете. Чтобы подключиться к виртуальной машине через Интернет, ей нужно назначить общедоступный IP-адрес. Все виртуальные машины могут устанавливать исходящие подключения к Интернету, независимо от того, назначен ли им общедоступный IP-адрес. См. дополнительные сведения об [исходящих интернет-подключениях в Azure](../load-balancer/load-balancer-outbound-connections.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

Виртуальные машины, создаваемые в этой статье, имеют один [сетевой интерфейс](virtual-network-network-interface.md) с одним динамически назначенным IP-адресом. Развернув виртуальную машину, вы можете [добавить несколько общедоступных и частных IP-адресов или изменить способ назначения IP-адреса на статический](virtual-network-network-interface-addresses.md#add-ip-addresses). Вы можете [добавлять сетевые интерфейсы](virtual-network-network-interface-vm.md#vm-add-nic) в количестве, поддерживаемом [размером виртуальной машины](../virtual-machines/linux/sizes.md?toc=%2fazure%2fvirtual-network%2ftoc.json), который вы выбрали при ее создании. Вы также можете [включить виртуализацию операций ввода-вывода с единым корнем (SR-IOV)](create-vm-accelerated-networking-cli.md) для виртуальной машины, но только если размер создаваемой виртуальной машины поддерживает такую возможность.

### <a name="communicate-between-virtual-machines-and-with-the-internet"></a>Обмен данными между виртуальными машинами и через Интернет

Используйте следующую команду для создания сеанса SSH с виртуальной машиной *myVmMgmt*. Замените `<publicIpAddress>` общедоступным IP-адресом виртуальной машины. В предыдущем примере общедоступный IP-адрес — *13.90.242.231*. При запросе пароля введите пароль, указанный при работе с разделом [Создание виртуальных машин](#create-virtual-machines).

```bash 
ssh azureuser@<publicIpAddress>
```

Часто в целях безопасности ограничивается число виртуальных машин, к которым могут устанавливаться удаленные подключения в виртуальной сети. В этом руководстве виртуальная машина *myVmMgmt* используется для управления виртуальной машиной *myVmWeb* в виртуальной сети. Чтобы подключиться по SSH к виртуальной машине *myVmWeb* из виртуальной машины *myVmMgmt*, выполните следующую команду:

```bash 
ssh azureuser@myVmWeb
```

Для обмена данными между виртуальными машинами *myVmMgmt* и *myVmWeb*, введите в командной строке следующую команду:

```
ping -c 4 myvmmgmt
```

Вы получите результат, аналогичный приведенному ниже.
    
```
PING myvmmgmt.hxehizax3z1udjnrx1r4gr30pg.bx.internal.cloudapp.net (10.0.1.4) 56(84) bytes of data.
64 bytes from 10.0.1.4: icmp_seq=1 ttl=64 time=1.45 ms
64 bytes from 10.0.1.4: icmp_seq=2 ttl=64 time=0.628 ms
64 bytes from 10.0.1.4: icmp_seq=3 ttl=64 time=0.529 ms
64 bytes from 10.0.1.4: icmp_seq=4 ttl=64 time=0.674 ms

--- myvmmgmt.hxehizax3z1udjnrx1r4gr30pg.bx.internal.cloudapp.net ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3029ms
rtt min/avg/max/mdev = 0.529/0.821/1.453/0.368 ms
```
      
Как видите, адрес виртуальной машины *myVmMgmt* — 10.0.1.4. Это первый доступный IP-адрес в диапазоне адресов *частной* подсети, в которой вы развернули виртуальную машину *myVmMgmt* на предыдущем шаге.  Как видите, полное доменное имя виртуальной машины — *myvmmgmt.hxehizax3z1udjnrx1r4gr30pg.bx.internal.cloudapp.net*. Хотя часть доменного имени *hxehizax3z1udjnrx1r4gr30pg* отличается для виртуальной машины, остальные части одинаковы. По умолчанию все виртуальные машины Azure используют службу Azure DNS. Все виртуальные машины в виртуальной сети могут разрешать имена других виртуальных машин в той же виртуальной сети, используя службу Azure DNS по умолчанию. Вместо этой службы вы можете использовать свой DNS-сервер или возможность размещения частного домена, которую предоставляет служба Azure DNS. Дополнительные сведения см. в разделе [Разрешение имен с помощью собственного DNS-сервера](virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) или в статье [Использование Azure DNS для частных доменов](../dns/private-dns-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

Используйте следующие команды, чтобы установить веб-сервер nginx на виртуальную машину *myVmWeb*.

```bash 
# Update package source
sudo apt-get -y update

# Install NGINX
sudo apt-get -y install nginx
```

После установки nginx закройте сеанс SSH с *myVmWeb*. В результате останется открытой командная строка для виртуальной машины *myVmMgmt*. Введите следующую команду, чтобы получить экран приветствия nginx из виртуальной машины *myVmWeb*.

```bash
curl myVmWeb
```

Вернется экран приветствия nginx.

Закройте сеанс SSH с виртуальной машиной *myVmMgmt*.

При создании виртуальной машины *myVmWeb* в Azure для нее также создается и назначается общедоступный IP-адрес с именем *myVmWebPublicIP*. Получите общедоступный адрес, назначенный Azure, с помощью команды [az сети public-ip show](/cli/azure/network/public-ip#az_network_public_ip_show).

```azurecli-interactive
az network public-ip show \
  --resource-group myResourceGroup \
  --name myVmWebPublicIP \
  --query ipAddress
```

На компьютере введите следующую команду, заменив значение `<publicIpAddress>` на адрес, возвращенный предыдущей командой:

```bash
curl <publicIpAddress>
```

Попытка свернуть экран приветствия nginx на вашем компьютере завершится ошибкой. Это происходит потому, что при развертывании виртуальной машины в Azure по умолчанию создается группа безопасности сети для каждой виртуальной машины. 

В этой группе содержатся правила безопасности, которые разрешают или запрещают исходящий и входящий сетевой трафик по портам или IP-адресам. Сетевая группа безопасности по умолчанию, созданная Azure, поддерживает взаимодействие между ресурсами через все порты в одной виртуальной сети. Для виртуальных машин Linux группа безопасности сети по умолчанию отклоняет весь входящий трафик из Интернета на всех портах, кроме TCP-порта 22 (SSH). В результате, по умолчанию вы также можете подключиться по протоколу SSH напрямую к виртуальной машине *myVmWeb* из Интернета, даже если порт 22 не должен быть открытым для веб-сервера. Так как для команды `curl` используется порт 80, то подключение через Интернет завершится сбоем, потому что в группе безопасности сети по умолчанию нет такого правила, которое разрешает прохождение трафика через порт 80.

## <a name="clean-up-resources"></a>Очистка ресурсов

Вы можете удалить ненужную группу ресурсов и все содержащиеся в ней ресурсы, выполнив команду [az group delete](/cli/azure/group#az_group_delete).

```azurecli-interactive 
az group delete --name myResourceGroup --yes
```

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как развернуть виртуальную сеть с несколькими подсетями. Вы также узнали, что при создании виртуальной машины Linux в Azure создается сетевой интерфейс, который подключается к виртуальной машине, и группа безопасности сети, разрешающая только тот трафик из Интернета, который проходит через порт 22. Перейдите к следующему руководству, чтобы узнать, как фильтровать сетевой трафик для подсетей, а не отдельных виртуальных машин.

> [!div class="nextstepaction"]
> [Создание групп безопасности сети с помощью Azure CLI](./virtual-networks-create-nsg-arm-cli.md)
