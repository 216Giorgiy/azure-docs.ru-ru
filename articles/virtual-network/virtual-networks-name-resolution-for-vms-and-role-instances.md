<properties 
   pageTitle="Разрешение имен для виртуальных машин и экземпляров ролей"
   description="Сценарии разрешения имен для Azure IaaS, гибридных решений, между различными облачными службами, Active Directory и с помощью DNS-сервера"
   services="virtual-network"
   documentationCenter="na"
   authors="GarethBradshawMSFT"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="09/02/2015"
   ms.author="joaoma" />

# Разрешение имен для ВМ и экземпляров ролей

В зависимости от того, как вы используете Azure для размещения IaaS, PaaS и гибридных решений, вам может понадобиться разрешить созданным виртуальным машинам и экземплярам ролей взаимодействовать друг с другом. Хотя это взаимодействие может осуществляться с помощью IP-адресов, гораздо проще использовать имена узлов, которые легко запоминаются и не меняются.

Если для экземпляров ролей и виртуальных машин, размещенных в Azure, требуется разрешение доменных имен на доступ к внутренним IP-адресах, это можно сделать с помощью одного из двух методов:

- [разрешение имен Azure;](#azure-provided-name-resolution)

- [разрешение имен с помощью собственного DNS-сервера.](#name-resolution-using-your-own-dns-server)

Тип разрешения имен зависит от способа взаимодействия виртуальных машин и экземпляров ролей друг с другом.

**В следующей таблице представлены сценарии и соответствующие решения для разрешения имен.**

| **Сценарий** | **Тип разрешения имен** | **Дополнительные сведения см. в разделах:** |
|--------------|----------------------------------|-------------------------------|
| Разрешение имен между экземплярами ролей или виртуальными машинами, расположенными в одной облачной службе | разрешение имен Azure; | [разрешение имен Azure;](#azure-provided-name-resolution)|
| Разрешение имен между виртуальными машинами и экземплярами ролей в одной виртуальной сети | Разрешение имен Azure (только для развертываний на основе ARM) или разрешение имен с помощью собственного DNS-сервера | [Разрешение имен Azure](#azure-provided-name-resolution), [разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server) и [требования к DNS-серверу](#dns-server-requirements) |
| Разрешение имен между виртуальными машинами и экземплярами ролей в разных виртуальных сетях | Разрешение имен с помощью собственного DNS-сервера| [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server) и [требования к DNS-серверу](#dns-server-requirements)|
| Между расположениями: разрешение имен между экземплярами ролей или виртуальными машинами в Azure и локальными компьютерами| Разрешение имен с помощью собственного DNS-сервера| [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server) и [требования к DNS-серверу](#dns-server-requirements)|
| Обратный просмотр внутренних IP-адресов| Разрешение имен с помощью собственного DNS-сервера| [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server) и [требования к DNS-серверу](#dns-server-requirements)|
| Разрешение имен для доменов, не являющихся общедоступными (например, доменов Active Directory)| Разрешение имен с помощью собственного DNS-сервера| [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server) и [требования к DNS-серверу](#dns-server-requirements)|
| Разрешение имен между экземплярами ролей, расположенными не в виртуальной сети, а в различных облачных службах| Не применяется Подключение между виртуальными машинами и экземплярами ролей в разных облачных службах не поддерживается за пределами виртуальной сети.| Не применяется|


## разрешение имен Azure;

Вместе с разрешением общедоступных DNS-имен Azure предоставляет разрешение внутренних имен для виртуальных машин и экземпляров ролей, которые находятся в той же виртуальной сети или облачной службе. Виртуальные машины или экземпляры в облачной службе используют один и тот же DNS-суффикс, поэтому достаточно будет только имени узла. Но в классических виртуальных сетях разные облачные службы имеют разные DNS-суффиксы, поэтому для разрешения имен между разными облачными службами требуется полное доменное имя. В виртуальных сетях на основе ARM DNS-суффикс является одинаковым во всей виртуальной сети, поэтому полное доменное имя не требуется. DNS-имя можно назначить сетевой карте или виртуальной машине. Несмотря на то что разрешение имен Azure не требует настройки, это не самый лучший выбор для всех сценариев развертывания, как показано в приведенной выше таблице.

> [AZURE.NOTE] Что касается веб-ролей и рабочих ролей, вы можете также получать доступ ко внутренним IP-адресам экземпляров ролей на основе имени роли и номера экземпляра с помощью REST API управления службами Azure. Дополнительные сведения см. в статье [Справочник по REST API управления службами ](https://msdn.microsoft.com/library/azure/ee460799.aspx).

### Функции и рекомендации

**Функции**

- Простота использования: для использования разрешения имен, предоставляемого Azure, дополнительные настройки не нужны.

- Служба разрешения имен Azure отличается высокой доступностью, что устраняет необходимость создавать кластеры DNS-серверов и управлять ими.

- Предоставляется разрешение имен между экземплярами ролей или виртуальными машинами, расположенными в одной облачной службе, без необходимости указывать полное доменное имя.

- Предоставляется разрешение имен между виртуальными машинами в виртуальной сети на основе ARM без необходимости указывать полное доменное имя. В классических виртуальных сетях полное доменное имя требуется при разрешении имен в разных облачных службах.

- Вместо использования автоматически создаваемых имен вы можете создавать имена узлов, которые понятно описывают ваши развертывания.

**Рекомендации**

- Разрешение имен между виртуальными сетями, а также между службой Azure и локальными машинами недоступно.

- Созданный Azure DNS-суффикс нельзя изменить.

- Собственные записи нельзя регистрировать вручную.

- WINS и NetBIOS не поддерживаются. (Вы не можете просмотреть список виртуальных машин в браузере сети в проводнике Windows.)

- Имена узлов должны быть DNS-совместимыми (они могут содержать только символы 0–9, a–z и «-» и не могут начинаться или заканчиваться на «-». См. раздел 2 RFC 3696.)

- Трафик запросов DNS регулируется для каждой виртуальной машины. Это не должно влиять на большинство приложений. Если наблюдается регулирование запросов, проверьте, включено ли кэширование на стороне клиента. Дополнительные сведения см. в разделе [Наиболее эффективное использование разрешения имен Azure](#Getting-the-most-from-Azure-provided-name-resolution).

- Для всех классических виртуальных сетей зарегистрированы только те виртуальные машины, которые находятся в первых 180 облачных службах. Это не относится к виртуальным сетям на основе ARM.


### Наиболее эффективное использование разрешения имен Azure
**Кэширование на стороне клиента**

Не каждый запрос DNS должен отправляться по сети. Кэширование на стороне клиента помогает уменьшить задержку и повысить устойчивость к нестабильной работе сети, разрешая повторяющиеся запросы DNS из локального кэша. Записи DNS содержат сведения о сроке жизни (TTL). Это позволяет кэшу хранить записи максимально долго, не влияя на их актуальность. Следовательно, кэширование на стороне клиента подходит для большинства ситуаций.

По умолчанию DNS-клиент Windows имеет встроенный кэш DNS. В некоторых дистрибутивах Linux возможность кэширования не включена по умолчанию. Поэтому рекомендуется включать ее на каждой виртуальной машине под управлением Linux (после проверки на отсутствие локального кэша).

Существует несколько разных доступных пакетов кэширования DNS, включая dnsmasq. Ниже описаны шаги по установке пакета dnsmasq на наиболее распространенные версии ОС.

- **Ubuntu (используется пакет resolvconf)**:
	- просто установите пакет dnsmasq (sudo apt-get install dnsmasq).
- **SUSE (используется пакет netconf)**:
	- установите пакет dnsmasq (sudo zypper install dnsmasq); 
	- активируйте службу dnsmasq (systemctl enable dnsmasq.service); 
	- запустите службу dnsmasq (systemctl start dnsmasq.service); 
	- измените путь /etc/sysconfig/network/config и замените блок NETCONFIG\_DNS\_FORWARDER="" текстом dnsmasq;
	- укажите в файле resolv.conf (netconfig update) кэш в качестве локального сопоставителя DNS.
- **OpenLogic (используется пакет NetworkManager)**:
	- установите пакет dnsmasq (sudo yum install dnsmasq);
	- активируйте службу dnsmasq (systemctl enable dnsmasq.service);
	- запустите службу dnsmasq (systemctl start dnsmasq.service);
	- добавьте строку prepend domain-name-servers 127.0.0.1; в файл /etc/dhclient-eth0.conf;
	- перезапустите сетевую службу (service network restart), чтобы указать кэш в качестве локального сопоставителя DNS.

> [AZURE.NOTE]\: пакет dnsmasq — один из многих доступных пакетов кэша DNS для ОС Linux. Перед его использованием проверьте, соответствует ли он вашим потребностям, а также не установлен ли у вас другой кэш.

**Повторные попытки на стороне клиента**

DNS использует преимущественно протокол UDP. Поскольку протокол UDP не гарантирует доставку сообщений, логика повторных попыток обрабатывается в самом протоколе DNS. Каждый DNS-клиент (ОС) может реализовывать разную логику повторных попыток в зависимости от предпочтений создателей.

 - ОС Windows выполняет повторную попытку через 1 с, затем через 2 и 4 с, а затем снова через 4 с. 
 - Повторные попытки в ОС Linux по умолчанию выполняются через 5 с. Рекомендуется изменить этот параметр, чтобы повторные попытки выполнялись 5 раз с интервалом в 1 с.  

Чтобы проверить текущие параметры на виртуальной машине под управлением ОС Linux, введите команду cat /etc/resolv.conf и просмотрите строку options:

	options timeout:1 attempts:5

Файл resolv.conf обычно создается автоматически; его не следует изменять. Шаги по добавлению строки options отличаются в разных дистрибутивах.

- **Ubuntu** (используется пакет resolvconf):
	- добавьте строку options в /etc/resolveconf/resolv.conf.d/head; 
	- выполните resolvconf -u для обновления.
- **SUSE** (используется пакет netconf):
	- добавьте параметр timeout:1 attempts:5 в блок NETCONFIG\_DNS\_RESOLVER\_OPTIONS="" в /etc/sysconfig/network/config; 
	- выполните netconfig update для обновления.
- **OpenLogic** (используется пакет NetworkManager):
	- добавьте echo "options timeout:1 attempts:5" в /etc/NetworkManager/dispatcher.d/11-dhclient; 
	- выполните service network restart для обновления.

## Разрешение имен с помощью собственного DNS-сервера

Если ваши требования к разрешению имен превышают возможности Azure, вы можете использовать собственные DNS-серверы. При использовании собственных DNS-серверов вы несете ответственность за управление записями DNS.

> [AZURE.NOTE] Мы советуем избегать использования внешнего DNS-сервера, если этого не требует ваш сценарий развертывания.

## Требования к DNS-серверу

Если вы планируете использовать разрешение имен, не предоставляемое Azure, указанный вами DNS-сервер должен поддерживать следующие возможности.

- Поскольку DNS-серверы заменят серверы, предоставляемые Azure, решение DNS должно отвечать требованиям к взаимодействию виртуальных машин. Если при взаимодействии виртуальных машин используются имена узлов, они должны быть зарегистрированы в DNS-серверах. Это зависит от множества факторов, но [в этом документе](virtual-networks-name-resolution-ddns.md) приводится несколько полезных советов.

- Если используется динамический протокол DNS, на DNS-сервере необходимо отключить функцию очистки записей. Аренда DHCP для IP-адресов в Azure долгосрочная, что может привести к удалению записей с DNS-сервера во время очистки.

- Для разрешения внешних доменных имен на DNS-сервере должна быть включена рекурсия.

- DNS-сервер должен быть доступен (по порту TCP или UDP 53) клиентам, которые запрашивают разрешение имен, а также службам и виртуальным машинам, которые регистрируют их имена.

- Мы советуем также защитить DNS-сервер от доступа из Интернета, так как многие всплывающие окна ищут открытые рекурсивные сопоставители DNS.

- Если в качестве DNS-серверов используются виртуальные машины Azure, для оптимальной производительности следует отключить IPv6 и назначить [общедоступный IP-адрес уровня экземпляра](virtual-networks-instance-level-public-ip.mp) каждой виртуальной машине, выполняющей роль DNS-сервера.
	- Если вы решили использовать Windows Server в качестве DNS-сервера, ознакомьтесь с приведенными [в этой статье](http://blogs.technet.com/b/networking/archive/2015/08/19/name-resolution-performance-of-a-recursive-windows-dns-server-2012-r2.aspx) сведениями об анализе производительности и оптимизациях.


## Указание DNS-серверов

Вы можете указать несколько DNS-серверов для использования виртуальными машинами и экземплярами ролей. В каждом запросе DNS клиент сначала пытается использовать основной DNS-сервер, обращаясь к альтернативным серверам, только если основной не отвечает. Иными словами, нагрузка для запросов DNS не сбалансирована на разных DNS-серверах. Поэтому ваши DNS-серверы должны быть указаны в правильном порядке для вашей среды.

> [AZURE.NOTE] Если изменить параметры DNS в файле конфигурации развернутой виртуальной сети, потребуется перезапустить каждую виртуальную машину, чтобы изменения вступили в силу.

### Настройка DNS-сервера на портале управления

При создании виртуальной сети на портале управления вы можете указать IP-адреса и имена нужных DNS-серверов. После создания виртуальной сети экземпляры ролей и виртуальные машины, которые развертываются в виртуальной сети, автоматически настраиваются в соответствии с указанными параметрами DNS. DNS-серверы, указанные для конкретной облачной службы (классическая версия Azure) или сетевой карты (развертывания на основе ARM) имеют более высокий приоритет по сравнению с DNS-серверами, указанными для виртуальной сети. См. статью [Настройка виртуальной сети на портале управления](virtual-networks-settings.md).

### Настройка DNS-сервера с помощью файлов конфигурации (классическая версия Azure)

Для классических виртуальных сетей параметры DNS можно указать с помощью двух разных файлов конфигурации: файла *конфигурации сети* и файла *конфигурации службы*.

Файл конфигурации сети описывает виртуальные сети в вашей подписке. Когда экземпляры ролей или виртуальные машины добавляются в облачную службу в виртуальной сети, параметры DNS из файла конфигурации сети применяются к каждому экземпляру роли или виртуальной машине, если не указаны DNS-серверы для конкретной облачной службы.

Файл конфигурации службы создается для каждой облачной службы, добавляемой в Azure. При добавлении экземпляров ролей или виртуальных машин в облачную службу параметры DNS из файла конфигурации службы применяются к каждому экземпляру роли или виртуальной машине.

> [AZURE.NOTE] DNS-серверы в файле конфигурации службы переопределяют параметры в файле конфигурации сети.


## Дальнейшие действия

[Схема конфигурации службы Azure](https://msdn.microsoft.com/library/azure/ee758710)

[Схема конфигурации виртуальной сети](https://msdn.microsoft.com/library/azure/jj157100)

[Настройка параметров виртуальной сети на портале управления](virtual-networks-settings.md)

[Настройка виртуальной сети с помощью файла конфигурации сети](virtual-networks-using-network-configuration-file.md)

<!---HONumber=AcomDC_0204_2016-->