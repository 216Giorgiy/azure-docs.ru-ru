<properties 
   pageTitle="Повышение производительности сети для виртуальной машины с использованием PowerShell | Microsoft Azure"
   description="Сведения о настройке повышения производительности сети для виртуальной машины Azure с помощью PowerShell."
   services="virtual-network"
   documentationCenter="na"
   authors="jimdial"
   manager="carmonm"
   editor=""
   tags="azure-resource-manager"
/>
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="09/23/2016"
   ms.author="jdial" />

# Повышение производительности сети для виртуальной машины

Функция повышения производительности сети позволяет использовать виртуализацию ввода-вывода с единым корнем (SR-IOV) для виртуальной машины. Этот высокопроизводительный метод обеспечивает обход узла на пути к данным, что уменьшает задержку, дрожание и нагрузку ЦП. Он предназначен для ресурсоемких рабочих нагрузок сети на виртуальных машинах поддерживаемых типов. В этой статье объясняется, как настроить повышение производительности сети в модели развертывания с помощью Azure Resource Manager, используя PowerShell.

На следующем рисунке приведена схема обмена данными между двумя виртуальными машинами с функцией повышения производительности сети и без нее.

![Сравнение](./media/virtual-network-accelerated-networking-powershell/image1.png)

Без использования функции повышения производительности сети весь входящий и исходящий сетевой трафик виртуальной машины должен проходить через узел и виртуальный коммутатор. Виртуальный коммутатор обеспечивает принудительное применение всех политик, таких как группы безопасности сети, списки управления доступом, изоляция, и использование других служб виртуализации сети для сетевого трафика. Дополнительные сведения см. в статье [Hyper-V Network Virtualization and Virtual Switch](https://technet.microsoft.com/library/jj945275.aspx) (Виртуализация сети Hyper-V и виртуальный коммутатор).

При использовании функции повышения производительности сети трафик поступает на сетевую карту, а затем перенаправляется на виртуальную машину. Все сетевые политики, которые применяет виртуальный коммутатор без этой функции, разгружаются и применяются на аппаратном уровне. Благодаря применению политик на аппаратном уровне сетевая карта может перенаправлять сетевой трафик непосредственно на виртуальную машину в обход узла и виртуального коммутатора. При этом все политики, примененные на узле, сохраняются.

Возможности функции повышения производительности сети применяются только к той виртуальной машине, где она включена. Для получения наилучших результатов необходимо включить эту функцию по крайней мере на двух виртуальных машинах, подключенных к одной виртуальной сети. При обмене данными между виртуальными или локальными сетями эта функция практически не влияет на общую задержку.

[AZURE.INCLUDE [virtual-network-preview](../../includes/virtual-network-preview.md)]

##Преимущества

- **Уменьшение задержки (больше пакетов в секунду).** Благодаря обходу виртуального коммутатора на пути к данным на узле не выполняется обработка политики пакетов. Таким образом, увеличивается число пакетов, которые могут быть обработаны на виртуальной машине.
- **Уменьшение дрожания.** Обработка с помощью виртуального коммутатора зависит от числа политик, которые необходимо применить, и рабочей нагрузки ЦП, выполняющего обработку. Так как принудительное применение политик осуществляется на аппаратном уровне, эта зависимость устраняется за счет доставки пакетов непосредственно на виртуальную машину. Это позволяет избежать обмена данными между узлом и виртуальной машиной, прерываний работы программного обеспечения и переключений контекста.
- **Уменьшение нагрузки ЦП.** Обход виртуального коммутатора на узле приводит к меньшему использованию ЦП для обработки сетевого трафика.

## Ограничения

При использовании этой возможности действуют следующие ограничения:
 
- **Создание сетевого интерфейса.** Функцию повышения производительности сети можно включить только в новом сетевом интерфейсе. Ее нельзя включить в имеющемся сетевом интерфейсе.
- **Создание виртуальной машины.** Сетевой интерфейс с включенным повышением производительности сети можно подключить к виртуальной машине при ее создании. Этого нельзя сделать для имеющейся виртуальной машины.
- **Регионы.** Эта функция доступна только в таких регионах Azure, как западно-центральная часть США и Западная Европа. Набор поддерживаемых регионов будет расширяться в будущем.
- **Поддерживаемые операционные системы.** Microsoft Windows Server 2012 R2 и Windows Server 2016 Technical Preview 5. Вскоре будет добавлена поддержка Linux и Windows Server 2012.
- **Размер виртуальной машины.** Standard\_D15\_v2 и Standard\_DS15\_v2 — единственные поддерживаемые размеры экземпляров виртуальных машин. Дополнительные сведения см. в статье [Размеры виртуальных машин в Azure](../virtual-machines/virtual-machines-windows-sizes.md). Набор поддерживаемых размеров экземпляров виртуальных машин будет расширяться в будущем.

Сведения об изменениях этих ограничений будут публиковаться на [этой странице](https://azure.microsoft.com/updates/?product=virtual-network&updatetype=&platform=).

## Создание виртуальной машины Windows с повышением производительности сети

1. Откройте командную строку PowerShell и выполните остальные действия в этом разделе в пределах одного сеанса PowerShell. Если вы еще не установили и не настроили PowerShell, выполните шаги, описанные в статье [Установка и настройка Azure PowerShell](../powershell-install-configure.md).
2. Чтобы зарегистрироваться для получения предварительной версии, отправьте сообщение электронной почты с темой [Подписка на повышение производительности сети](mailto:axnpreview@microsoft.com?subject=Request%20to%20enable%20subscription%20%3csubscription%20id%3e), указав идентификатор подписки и описание предполагаемого использования.
3. Зарегистрируйте функцию с помощью своей подписки, используя следующие команды:

		Register-AzureRmProviderFeature -FeatureName AllowAcceleratedNetworkingFeature -ProviderNamespace Microsoft.Network
		Register-AzureRmResourceProvider -ProviderNamespace Microsoft.Network

4. Замените *westcentralus* на другое расположение, поддерживаемое этой функцией, которое указано в разделе [Ограничения](#limitations) этой статьи (при необходимости). Чтобы задать переменную для расположения, введите следующую команду:

		$locName = "westcentralus"

5. Замените *RG1* на имя группы ресурсов, которая будет содержать новый сетевой интерфейс, и введите следующие команды, чтобы создать ее.

		$rgName = "RG1"
		New-AzureRmResourceGroup -Name $rgName -Location $locName

6. Измените *VM1 NIC1* на желаемое имя сетевого интерфейса, а затем введите следующую команду:

		$NICName = "VM1-NIC1"

7. Сетевой интерфейс необходимо подключить к подсети в имеющейся виртуальной сети Azure, которая находится в том же расположении и принадлежит к той же [подписке](../azure-glossary-cloud-terminology.md#subscription), что и сетевой интерфейс. Если вы не знакомы с виртуальными сетями, прочитайте статью [Обзор виртуальных сетей](virtual-networks-overview.md). Чтобы создать виртуальную сеть, выполните действия, описанные в статье [Создание виртуальной сети](virtual-networks-create-vnet-arm-ps.md). Измените значения приведенных ниже переменных со знаком "$" на имя виртуальной сети и подсети, к которым необходимо подключить сетевой интерфейс, и имя группы ресурсов, в которой находится виртуальная сеть.

		$VNetName   = "VNet1"
		$SubnetName = "Subnet1"

	Если имя имеющейся виртуальной сети в расположении, выбранном на шаге 3, неизвестно, введите следующие команды:
		
		$VirtualNetworks = Get-AzureRmVirtualNetwork
		$VirtualNetworks | Where-Object {$_.Location -eq $locName} | Format-Table Name, Location
		
	Если возвращен пустой список, необходимо создать виртуальную сеть в нужном расположении. Чтобы создать виртуальную сеть, выполните действия, описанные в статье [Создание виртуальной сети](virtual-networks-create-vnet-arm-ps.md).

	Введите следующие команды, чтобы получить имя подсетей в виртуальной сети, и замените *Subnet1* именем подсети.
		
		$VNet = Get-AzureRmVirtualNetwork -Name $VNetName -ResourceGroupName $rgName
		$VNet.Subnets | Format-Table Name, AddressPrefix

8. Введите следующую команду, чтобы получить виртуальную сеть и подсеть, а также назначить их переменным.

		$VNet = Get-AzureRmVirtualNetwork -Name $VNetName -ResourceGroupName $rgName
		$Subnet = $VNet.Subnets | Where-Object { $_.Name -eq $SubnetName }

9. Определите имеющийся ресурс общедоступного IP-адреса, который можно связать с сетевым интерфейсом, чтобы подключиться к нему через Интернет. Если вам не требуется доступ к виртуальной машине с помощью сетевого интерфейса через Интернет, этот шаг можно пропустить. При отсутствии общедоступного IP-адреса к виртуальной машине необходимо подключиться с другой виртуальной машины, подключенной к той же виртуальной сети.

	Измените *PIP1* на имя имеющегося ресурса общедоступного IP-адреса, который находится в том расположении, где создается сетевой интерфейс, и который не связан с другим сетевым интерфейсом. При необходимости измените $rgName на имя группы ресурсов, в которой существует ресурс общедоступного IP-адреса, и введите следующую команду:

		$PIP1 = Get-AzureRmPublicIPAddress -Name "PIP1" -ResourceGroupName $rgName

	Если имя имеющегося ресурса общедоступного IP-адреса неизвестно, введите следующую команду:

		$PublicIPAddresses = Get-AzureRmPublicIPAddress
		$PublicIPAddresses | Where-Object { $_.Location -eq $locName } |Format-Table Name, Location, IPAddress, IpConfiguration

	Если столбец **IPConfiguration** не содержит значения в возвращенных данных, ресурс общедоступного IP-адреса не связан с имеющимся сетевым интерфейсом и может использоваться. Если список пуст или нет доступных ресурсов общедоступных IP-адресов, можно создать IP-адрес с помощью команды New-AzureRmPublicIPAddress.

	>[AZURE.NOTE] За общедоступные IP-адреса взимается номинальная плата. Дополнительные сведения о ценах см. на странице [Цены на IP-адреса ](https://azure.microsoft.com/pricing/details/ip-addresses).
10. Если вы решили не добавлять ресурс общедоступного IP-адреса к интерфейсу, удалите *- PublicIPAddress $PIP1* в конце следующей команды. Создайте сетевой интерфейс с повышением производительности сети, введя следующую команду:

		$nic = New-AzureRmNetworkInterface -Location $locName -Name $NICName -ResourceGroupName $rgName -Subnet $Subnet -EnableAcceleratedNetworking -PublicIpAddress $PIP1 

11. Назначьте сетевой интерфейс виртуальной машине во время ее создания, следуя инструкциям, описанным в шагах 3 и 6 статьи [Создание виртуальной машины Windows с помощью Resource Manager и PowerShell](../virtual-machines/virtual-machines-windows-ps-create.md). На шаге 6 в пункте 2 замените *Standard\_A1* на один из размеров виртуальной машины, перечисленных в разделе [Ограничения](#limitations) этой статьи.

	>[AZURE.NOTE] Если вы изменили *имена* переменных $locName, $rgName или $nic, приведенные в этой статье, вам не удастся выполнить шаг 6, описанный в статье "Создание виртуальной машины Windows с помощью Resource Manager и PowerShell". Однако вы можете изменить *значения* переменных.

12. После создания виртуальной машины скачайте [драйвер повышения производительности сети](https://gallery.technet.microsoft.com/Azure-Accelerated-471b5d84), подключитесь к виртуальной машине и запустите на ней программу установки драйвера.

13. Щелкните правой кнопкой мыши кнопку Windows и выберите **Диспетчер устройств**. Убедитесь, что в списке **сетевых адаптеров**, который нужно развернуть, есть виртуальный адаптер **Mellanox ConnectX-3 Virtual Function Ethernet Adapter**, как показано на следующем рисунке.

	![Диспетчер устройств](./media/virtual-network-accelerated-networking-powershell/image2.png)

<!---HONumber=AcomDC_0928_2016-->