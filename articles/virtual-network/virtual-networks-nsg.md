<properties 
   pageTitle="Группа безопасности сети"
   description="Узнайте, что собой представляют группы безопасности сети (NSG)."
   services="virtual-network"
   documentationCenter="na"
   authors="telmosampaio"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="10/22/2015"
   ms.author="telmos" />

# Группа безопасности сети

С помощью группы безопасности сети вы можете контролировать входящий трафик экземпляров виртуальных машин в вашей виртуальной сети. Группа безопасности сети содержит правила контроля доступа, которые разрешают или запрещают трафик в зависимости от направления трафика, протокола, исходного и целевого адреса и порта. Эти правила можно изменять в любое время, при этом изменения применяются ко всем связанным экземплярам.

>[AZURE.WARNING]Группы безопасности сети можно использовать только в региональных виртуальных сетях. Если вы пытаетесь защитить конечные точки в развертывании, где нет виртуальной сети или используется виртуальная сеть, связанная с группой сходства, см. раздел [Список контроля доступа (ACL) конечной точки](./virtual-networks-acl.md). Кроме того, вы можете [перенести свою виртуальную сеть в региональную](./virtual-networks-migrate-to-regional-vnet.md).

![Группы NSG](./media/virtual-network-nsg-overview/figure1.png)

На приведенном рисунке показана виртуальная сеть с двумя подсетями и четыре виртуальные машины (две в каждой подсети). Обратите внимание, что в подсети *BackEnd* с виртуальными машинами напрямую связаны общедоступные IP-адреса, а виртуальные машины в подсети *FrontEnd* находятся за балансировщиком нагрузки Azure. Группы безопасности сети, связанные с каждой подсетью, позволяют управлять потоком трафика в подсеть независимо от их происхождения (виртуальный IP-адрес или общедоступный IP-адрес).

>[AZURE.NOTE]На одном экземпляре виртуальной машины нельзя одновременно использовать списки ACL для конечных точек и группы NSG. Если вам нужна группа NSG, но у вас уже есть список ACL для конечных точек, сначала удалите этот список. Сведения о том, как это сделать, см. в статье [Управление списками управления доступом для конечных точек с помощью PowerShell](virtual-networks-acl-powershell.md).

## Как работает группа безопасности сети

Группы безопасности сети отличаются от списков ACL для конечных точек. Списки ACL работают только с общим портом входной конечной точки. Группа NSG работает с экземплярами виртуальных машин и управляет всем трафиком, который виртуальная машина принимает и отправляет.

Группа безопасности сети имеет *имя*, описательную метку и сопоставлена с тем или иным *регионом*. Группа содержит правила двух типов: для **входящего** и **исходящего** трафика. Правила для входящего трафика применяются к входящим пакетам виртуальной машины, а правила для исходящего трафика — к исходящим пакетам. Правила применяются на узле, на котором находится виртуальная машина. Чтобы входящий или исходящий пакет был пропущен, он должен соответствовать **разрешающему** правилу. В противном случае он удаляется.

### Правила групп безопасности сети (NSG)

Правила обрабатываются в порядке приоритета. Например, правило с меньшим номером приоритета (например, 100) обрабатывается до правила с большим номером приоритета (например, 200). Если обнаружено совпадение, дальнейшая обработка правил прекращается.

У каждого правила есть приведенные ниже свойства.

|Свойство|Описание|Примеры значений|
|---|---|---|
|**Описание**|Описание правила.|Разрешить входящий трафик для всех виртуальных машин в подсети X.|
|**Протокол**|Протокол правила для сопоставления.|TCP, UDP или *| |**Исходный диапазон портов**|Диапазон портов источника правила для сопоставления.|80, 100–200, *| |**Конечный диапазон портов**|Диапазон портов назначения правила для сопоставления.|80, 100–200, *| |**Префикс IP-адреса**|Префикс адреса источника правила для сопоставления.|10\.10.10.1, 10.10.10.0/24, VIRTUAL\_NETWORK|
|**Префикс адреса назначения**|Префикс адреса назначения правила для сопоставления.|10\.10.10.1, 10.10.10.0/24, VIRTUAL\_NETWORK|
|**Направление**|Направление трафика правила для сопоставления.|inbound или outbound|
|**Приоритет**|Приоритет правила. Правила проверяются в порядке приоритета. Когда применяется правило, соответствие дополнительным правилам не проверяется.|10, 100, 65000|
|**Access**|Тип доступа, применяемый при соответствии правилу.|allow или deny|

### Теги по умолчанию

Теги по умолчанию — это системные идентификаторы для определения категорий IP-адресов. Для свойств *префикс адреса источника* и *префикс адреса назначения* можно использовать теги по умолчанию. Существует три доступных тега по умолчанию.

- **VIRTUAL\_NETWORK**. Этот тег обозначает все адресное пространство сети. Он включает адресное пространство виртуальной сети (диапазоны CIDR, определенные в Azure) и все адресное пространство подключенных локальных сетей и виртуальных сетей Azure.

- **AZURE\_LOADBALANCER**. Этот тег обозначает балансировщик нагрузки для инфраструктуры Azure. Он преобразовывается в IP-адрес центра обработки данных Azure, где инициируются пробы работоспособности Azure. Тег необходим, только если связанная с группой NSG виртуальная машина или набор виртуальных машин входит в состав набора с балансировкой нагрузки.

- **INTERNET**. Этот тег обозначает пространство IP-адресов, которые находятся за пределами виртуальной сети и к которым можно получить доступ из общедоступного сегмента Интернета. К этим IP-адресам относится также общедоступный IP-адрес, принадлежащий Azure.

### Правила по умолчанию

Группа NSG содержит правила по умолчанию. Эти правила нельзя удалить, но у них самый низкий приоритет, поэтому их можно переопределить, создав другие правила. В правилах по умолчанию определены рекомендуемые платформой параметры. Как показано в таблице правил по умолчанию ниже, входящий и исходящий трафик виртуальной сети разрешен в обоих направлениях.

По умолчанию исходящий трафик в Интернет разрешен, входящий трафик из Интернета заблокирован. Существует правило по умолчанию, которое разрешает балансировщику нагрузки Azure инициировать пробы работоспособности виртуальной машины. Вы можете переопределить это правило, если виртуальная машина или набор виртуальных машин в группе NSG не входят в набор с балансировкой нагрузки.

Существуют такие правила по умолчанию:

**Входящий трафик**

| Имя | Приоритет | Исходный IP-адрес | Исходный порт | Конечный IP-адрес | Конечный порт | Протокол | Доступ |
|-----------------------------------|----------|--------------------|-------------|-----------------|------------------|----------|--------|
| РАЗРЕШИТЬ ВХОДЯЩИЙ ТРАФИК ВИРТУАЛЬНОЙ СЕТИ | 65000 | VIRTUAL\_NETWORK | * | VIRTUAL\_NETWORK | * | * | РАЗРЕШИТЬ |
| РАЗРЕШИТЬ ВХОДЯЩИЙ ТРАФИК БАЛАНСИРОВЩИКА НАГРУЗКИ AZURE | 65001 | AZURE\_LOADBALANCER | * | * | * | * | РАЗРЕШИТЬ |
| ЗАПРЕТИТЬ ВЕСЬ ВХОДЯЩИЙ ТРАФИК | 65500 | * | * | * | * | * | ЗАПРЕТИТЬ |

**Исходящий трафик**

| Имя | Приоритет | Исходный IP-адрес | Исходный порт | Конечный IP-адрес | Конечный порт | Протокол | Доступ |
|-------------------------|----------|-----------------|-------------|-----------------|------------------|----------|--------|
| РАЗРЕШИТЬ ИСХОДЯЩИЙ ТРАФИК ВИРТУАЛЬНОЙ СЕТИ | 65000 | VIRTUAL\_NETWORK | * | VIRTUAL\_NETWORK | * | * | РАЗРЕШИТЬ |
| РАЗРЕШИТЬ ИСХОДЯЩИЙ ИНТЕРНЕТ-ТРАФИК | 65001 | * | * | ИНТЕРНЕТ | * | * | РАЗРЕШИТЬ |
| ЗАПРЕТИТЬ ВЕСЬ ИСХОДЯЩИЙ ТРАФИК | 65500 | * | * | * | * | * | ЗАПРЕТИТЬ |

## Связывание групп NSG

Группу безопасности сети можно связать с виртуальными машинами, сетевыми картами и подсетями.

- **Связывание группы безопасности сети с виртуальной машиной.** При связывании группы безопасности сети с виртуальной машиной правила доступа к сети в этой группе NSG применяются ко всему входящему и исходящему трафику данной виртуальной машины. 

- **Связывание группы безопасности сети с сетевой картой.** При связывании группы безопасности сети с сетевой картой правила доступа к сети в этой группе NSG применяются только для данной сетевой карты. Это означает, что если группа NSG применяется к одной сетевой карте на виртуальной машине с несколькими сетевыми картами, она не затрагивает трафик других сетевых карт.

- **Связывание группы безопасности сети с подсетью.** При связывании группы безопасности сети с подсетью правила доступа к сети этой группы NSG применяются ко всем виртуальным машинам в данной подсети.

С виртуальной машиной, сетевой картой, используемой этой виртуальной машиной, и подсетью, к которой привязана сетевая карта, можно сопоставить разные группы безопасности сети. В этом случае все правила доступа к сети применяются к трафику в следующем порядке:

- **Входящий трафик**
	1. Группа NSG подсети.
	2. Группа NSG сетевой карты.
	3. Группа NSG виртуальной машины.
- **Исходящий трафик**
	1. Группа NSG виртуальной машины.
	2. Группа NSG сетевой карты.
	3. Группа NSG подсети.

![Списки ACL группы NSG](./media/virtual-network-nsg-overview/figure2.png)

>[AZURE.NOTE]Хотя к подсети, виртуальной машине или сетевой карте можно привязать только одну группу безопасности сети, ту же самую группу NSG можно связать с любым необходимым количеством ресурсов.

## Рекомендации по проектированию

При разработке групп NSG необходимо понимать особенности взаимодействия виртуальных машин со службами инфраструктуры и со службами PaaS, размещенными Azure. Доступ к большинству служб Azure PaaS, таких как базы данных SQL и хранилище, можно получить только через общедоступный адрес в Интернете. То же самое касается и зондов балансировки нагрузки.

Стандартным сценарием в Azure является разделение ролей виртуальных машин и PaaS в подсетях в зависимости от необходимости доступа к Интернету для этих объектов. В таком сценарии может быть подсеть с виртуальными машинами или экземплярами ролей, для которых требуется доступ к службам Azure Paas, таким как базы данных SQL и хранилище, но для которых не требуется входящий и исходящий обмен данными через общий доступ в Интернете.

См. правило NSG для такого сценария:

| Имя | Приоритет | Исходный IP-адрес | Исходный порт | Конечный IP-адрес | Конечный порт | Протокол | Access |
|------|----------|-----------|-------------|----------------|------------------|----------|--------|
|БЕЗ ДОСТУПА К ИНТЕРНЕТУ|100| VIRTUAL\_NETWORK|&#42;|ИНТЕРНЕТ|&#42;|TCP|ЗАПРЕТИТЬ| 

Так как правило запрещает доступ к Интернету из виртуальной сети, у виртуальных машин не будет доступа ко всем службам Azure PaaS, для которых необходима общедоступная конечная точка в Интернете, такая как база данных SQL.

Вместо запрещающего правила используйте правило, которое разрешает доступ к Интернету из виртуальной сети, но запрещает обратный доступ, как показано ниже:

| Имя | Приоритет | Исходный IP-адрес | Исходный порт | Конечный IP-адрес | Конечный порт | Протокол | Access |
|------|----------|-----------|-------------|----------------|------------------|----------|--------|
|К ИНТЕРНЕТУ|100| VIRTUAL\_NETWORK|&#42;|ИНТЕРНЕТ|&#42;|TCP|РАЗРЕШИТЬ|
|ИЗ ИНТЕРНЕТА|110| ИНТЕРНЕТ|&#42;|VIRTUAL\_NETWORK|&#42;|TCP|ЗАПРЕТИТЬ| 

>[AZURE.WARNING]Azure использует специальную подсеть, известную как подсеть **шлюза**, для обработки VPN-шлюза к другим виртуальным и локальным сетям. Связывание группы NSG с этой подсетью приведет к тому, что VPN-шлюз перестанет функционировать должным образом. НЕ связывайте группы NSG с подсетями шлюза!

### Специальные правила

Необходимо также учитывать особые правила, перечисленные ниже. Убедитесь, что вы не заблокировали трафик, разрешенный этими правилами, в противном случае инфраструктура не сможет взаимодействовать с основными службами Azure.

- **Виртуальный IP-адрес главного узла**. Базовые службы инфраструктуры, например DHCP, DNS и служба наблюдение за работоспособностью системы, работают через IP-адрес виртуализированного узла 168.63.129.16. Этот общедоступный IP-адрес принадлежит корпорации Майкрософт. Он является единственным виртуализированным IP-адресом, используемым для этих целей во всех регионах. Адрес сопоставляется с физическим IP-адресом сервера (главного узла), на котором размещена виртуальная машина. Главный узел выполняет функции ретранслятора DHCP, рекурсивного сопоставителя DNS-имен и источника проб работоспособности, инициируемых балансировщиком нагрузки и виртуальными машинами. Обмен данными с этим IP-адресом не является атакой.

- **Лицензирование (служба управления ключами)**. Для используемых на виртуальных машинах образов Windows требуется лицензия. С этой целью на соответствующие серверы узлов, на которых работает служба управления ключами, отправляется запрос на получение лицензии. Для этого всегда используется исходящий порт 1688.

### ICMP-трафик

Текущие правила NSG разрешают использовать только протоколы *TCP* и *UDP*. Для *ICMP* нет отдельного тега. Тем не менее, по умолчанию ICMP-трафик в виртуальной сети разрешен правилами для входящего трафика виртуальной сети. Они разрешают входящий и исходящий трафик в виртуальной сети на любом порте и по любому протоколу.

## Ограничения

При разработке групп NSG необходимо учитывать следующие ограничения.

|**Описание**|**Ограничение**|
|---|---|
|Количество групп NSG, которые можно связать с подсетью, виртуальной машиной или сетевой картой|1|
|Число групп NSG в регионе на подписку|100|
|Правил группы NSG на группу NSG|200|

Перед разработкой решения обязательно ознакомьтесь со всеми [ограничениями, касающимися сетевых служб в Azure](../azure-subscription-service-limits/#networking-limits).

## Дальнейшие действия

- [Создайте группы безопасности сети на основе классической модели развертывания](virtual-networks-create-nsg-classic-ps.md).
- [Разверните группы безопасности сети в диспетчере ресурсов](virtual-networks-create-nsg-arm-pportal.md).

<!---HONumber=Nov15_HO1-->