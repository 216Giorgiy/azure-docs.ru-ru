<properties 
   pageTitle="Группа безопасности сети"
   description="Узнайте, что собой представляют группы безопасности сети (NSG)."
   services="traffic-manager"
   documentationCenter="na"
   authors="telmosampaio"
   manager="carolz"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="06/08/2015"
   ms.author="telmos" />

# Группа безопасности сети

С помощью группы безопасности сети вы можете контролировать входящий трафик экземпляров виртуальных машин в вашей виртуальной сети. Группа безопасности сети (NSG) — это объект верхнего уровня, связанный с вашей подпиской. Группа NSG содержит правила контроля доступа, с помощью которых можно разрешить или блокировать входящий трафик в экземплярах виртуальных машин. Эти правила можно изменять в любое время, при этом изменения применяются ко всем связанным экземплярам. Чтобы работать с группой NSG, у вас должна быть виртуальная сеть, связанная с определенным регионом (расположением).

>[AZURE.WARNING]Группы NSG несовместимы с виртуальными сетями, которые связаны с территориальной группой. Если у вас нет региональной виртуальной сети, но вам нужно управлять входящим трафиком конечных точек, см. статью [Сетевой список управления доступом](../virtual-networks-acl).

Группу NSG можно связать с виртуальной машиной или подсетью виртуальной сети. Если группа NSG связана с виртуальной машиной, ее правила применяются ко всему входящему и исходящему трафику экземпляра виртуальной машины. Если группа связана с подсетью виртуальной сети, правила действуют по отношению ко всему входящему и исходящему трафику ВСЕХ экземпляров виртуальных машин в подсети. Виртуальную машину или подсеть можно связать только с одной группой NSG, при этом каждая группа может содержать не более 200 правил. В одной подписке может быть не более 100 групп NSG.

>[AZURE.NOTE]На одном экземпляре виртуальной машины нельзя одновременно использовать списки ACL для конечных точек и группы NSG. Если вам нужна группа NSG, но у вас уже есть список ACL для конечных точек, сначала удалите этот список. Сведения о том, как это сделать, см. в статье [Управление списками управления доступом для конечных точек с помощью PowerShell](https://msdn.microsoft.com/library/azure/dn376543.aspx).

## Как работает группа безопасности сети

Группы безопасности сети отличаются от списков ACL для конечных точек. Списки ACL работают только с общим портом входной конечной точки. Группа NSG работает с экземплярами виртуальных машин и управляет всем трафиком, который виртуальная машина принимает и отправляет.

Группа безопасности сети имеет *имя*, описательную метку и сопоставлена с тем или иным *регионом*. Группа содержит правила двух типов: для **входящего** и **исходящего** трафика. Правила для входящего трафика применяются к входящим пакетам виртуальной машины, а правила для исходящего трафика — к исходящим пакетам. Правила применяются на узле, на котором находится виртуальная машина. Чтобы входящий или исходящий пакет был пропущен, он должен соответствовать **разрешающему** правилу. В противном случае он удаляется.

Правила обрабатываются в порядке приоритета. Например, правило с меньшим номером приоритета (например, 100) обрабатывается до правила с большим номером приоритета (например, 200). Если обнаружено совпадение, дальнейшая обработка правил прекращается.

В правиле указываются такие данные:

- **Имя.**. Уникальный идентификатор правила.

- **Тип**. Входящий или исходящий трафик.

- **Приоритет**. <You can specify an integer between 100 and 4096>

- **Исходный IP-адрес**. Маршрутизация CIDR для исходного диапазона IP-адресов.

- **Исходный диапазон портов**. <integer or range between 0 and 65536>

- **Конечный диапазон IP-адресов**. Маршрутизация CIDR для конечного диапазона IP-адресов.

- **Конечный диапазон портов**. <integer or range between 0 and 65536>

- **Протокол**. <Разрешены протоколы TCP, UDP или «*»>.

- **Доступ**. Разрешение или запрет.

### Правила по умолчанию

Группа NSG содержит правила по умолчанию. Эти правила нельзя удалить, но у них самый низкий приоритет, поэтому их можно переопределить, создав другие правила. В правилах по умолчанию определены рекомендуемые платформой параметры. Как показано в таблице правил по умолчанию ниже, входящий и исходящий трафик виртуальной сети разрешен в обоих направлениях.

По умолчанию исходящий трафик в Интернет разрешен, входящий трафик из Интернета заблокирован. Существует правило по умолчанию, которое разрешает балансировщику нагрузки Azure инициировать пробы работоспособности виртуальной машины. Вы можете переопределить это правило, если виртуальная машина или набор виртуальных машин в группе NSG не входят в набор с балансировкой нагрузки.

Существуют такие правила по умолчанию:

**Входящий трафик**

| Имя | Приоритет | Исходный IP-адрес | Исходный порт | Конечный IP-адрес | Конечный порт | Протокол | Доступ |
|-----------------------------------|----------|--------------------|-------------|-----------------|------------------|----------|--------|
| РАЗРЕШИТЬ ВХОДЯЩИЙ ТРАФИК ВИРТУАЛЬНОЙ СЕТИ | 65000 | VIRTUAL_NETWORK | * | VIRTUAL_NETWORK | * | * | РАЗРЕШИТЬ |
| РАЗРЕШИТЬ ВХОДЯЩИЙ ТРАФИК БАЛАНСИРОВЩИКА НАГРУЗКИ AZURE | 65001 | AZURE_LOADBALANCER | * | * | * | * | РАЗРЕШИТЬ |
| ЗАПРЕТИТЬ ВЕСЬ ВХОДЯЩИЙ ТРАФИК | 65500 | * | * | * | * | * | ЗАПРЕТИТЬ |

**Исходящий трафик**

| Имя | Приоритет | Исходный IP-адрес | Исходный порт | Конечный IP-адрес | Конечный порт | Протокол | Доступ |
|-------------------------|----------|-----------------|-------------|-----------------|------------------|----------|--------|
| РАЗРЕШИТЬ ИСХОДЯЩИЙ ТРАФИК ВИРТУАЛЬНОЙ СЕТИ | 65000 | VIRTUAL_NETWORK | * | VIRTUAL_NETWORK | * | * | РАЗРЕШИТЬ |
| РАЗРЕШИТЬ ИСХОДЯЩИЙ ИНТЕРНЕТ-ТРАФИК | 65001 | * | * | ИНТЕРНЕТ | * | * | РАЗРЕШИТЬ |
| ЗАПРЕТИТЬ ВЕСЬ ИСХОДЯЩИЙ ТРАФИК | 65500 | * | * | * | * | * | ЗАПРЕТИТЬ |

### Специальные правила для инфраструктуры

Правила NSG являются явными. Трафик запрещается или разрешается только в соответствии с правилами NSG. Существует, тем не менее, два типа трафика, которые разрешены всегда вне зависимости от правил группы NSG. Это требуется для обеспечения надлежащей работы инфраструктуры.

- **Виртуальный IP-адрес главного узла**. Базовые службы инфраструктуры, например DHCP, DNS и служба наблюдение за работоспособностью системы, работают через IP-адрес виртуализированного узла 168.63.129.16. Этот общедоступный IP-адрес принадлежит корпорации Майкрософт. Он является единственным виртуализированным IP-адресом, используемым для этих целей во всех регионах. Адрес сопоставляется с физическим IP-адресом сервера (главного узла), на котором размещена виртуальная машина. Главный узел выполняет функции ретранслятора DHCP, рекурсивного сопоставителя DNS-имен и источника проб работоспособности, инициируемых балансировщиком нагрузки и виртуальными машинами. Обмен данными с этим IP-адресом не является атакой.

- **Лицензирование (служба управления ключами)**. Для используемых на виртуальных машинах образов Windows требуется лицензия. С этой целью на соответствующие серверы узлов, на которых работает служба управления ключами, отправляется запрос на получение лицензии. Для этого всегда используется исходящий порт 1688.

### Теги по умолчанию

Теги по умолчанию — это системные идентификаторы для определения категорий IP-адресов. Теги задаются в пользовательских правилах. Существуют такие теги по умолчанию:

- **VIRTUAL_NETWORK**. Этот тег обозначает все адресное пространство сети. Сюда входят адресное пространство виртуальной сети (маршрутизация CIDR IP-адресов в Azure) и все адресное пространство подключенных локальных сетей. Сюда также относятся адресные пространства подключений типа «виртуальная сеть — виртуальная сеть».

- **AZURE_LOADBALANCER**. Этот тег обозначает балансировщик нагрузки для инфраструктуры Azure. Он преобразовывается в IP-адрес центра обработки данных Azure, где инициируются пробы работоспособности Azure. Тег необходим, только если связанная с группой NSG виртуальная машина или набор виртуальных машин входит в состав набора с балансировкой нагрузки.

- **INTERNET**. Этот тег обозначает пространство IP-адресов, которые находятся за пределами виртуальной сети и к которым можно получить доступ из общедоступного сегмента Интернета. К этим IP-адресам относится также общедоступный IP-адрес, принадлежащий Azure.

### Порты и их диапазоны

Правила NSG можно задавать как для одного исходного или конечного порта, так и для целого диапазона портов. Это особенно полезно, когда для какого-то приложения нужно открыть широкий диапазон портов (например, FTP). Диапазон может состоять только из последовательного набора номеров портов. Номер одного порта указывать нельзя.

Чтобы указать диапазон портов, используйте параметр *DestinationPortRange* со знаком «-» в начале:

	Get-AzureNetworkSecurityGroup -Name ApptierSG `
	| Set-AzureNetworkSecurityRule -Name FTP -Type Inbound -Priority 600 -Action Allow `
		-SourceAddressPrefix INTERNET -SourcePortRange * `
		-DestinationAddressPrefix * -DestinationPortRange 100-500 -Protocol *

### ICMP-трафик

Текущие правила NSG разрешают использовать только протоколы TCP и UDP. Для ICMP нет отдельного тега. Тем не менее, по умолчанию ICMP-трафик в виртуальной сети разрешен правилами для входящего трафика виртуальной сети. Они разрешают входящий и исходящий трафик в виртуальной сети на любом порте и по любому протоколу («*»).

## Связывание групп NSG

Связывание группы NSG с виртуальной машиной. Когда группа NSG напрямую связана с виртуальной машиной, правила доступа к сети в этой группе применяются ко всему входящему трафику виртуальной машины. Когда правила группы NSG меняются, изменения вступают в силу через несколько минут. Когда связь группы NSG с виртуальной машиной отменяется, параметры системы возвращаются к исходным значениям, то есть тем, что были заданы до связывания с группой.

Связывание группы NSG с подсетью. Когда группа NSG связывается с подсетью, правила доступа к сети в этой группе применяются ко всем виртуальным машинам подсети. Когда правила доступа в группе NSG меняются, изменения вступают в силу через несколько минут.

Связывание группы NSG с подсетью и виртуальной машиной. Вы можете связать одну группу NSG с виртуальной машиной, а другую — с подсетью, в которой эта виртуальная машина находится. Такой сценарий поддерживается. В этом случае виртуальная машина получает два уровня защиты. Если трафик входящий, то пакет сначала проверяется на соответствие правилам доступа, которые заданы в подсети, а затем — на соответствие правилам доступа, которые заданы в виртуальной машине. Если трафик исходящий, все происходит наоборот (см. диаграмму ниже).

![Списки ACL группы NSG](./media/virtual-networks-nsg/IC757774.png)

Когда группа NSG связана с виртуальной машиной или подсетью, правила контроля доступа к сети становятся очень явными. Платформа не будет использовать неявные правила, чтобы разрешить трафик к тому или иному порту. В таком случае, если вы создадите конечную точку виртуальной машины, вам также нужно будет создать правило, разрешающее входящий трафик из Интернета. Если этого не сделать, виртуальный IP-адрес <Port> будет недоступным извне.

Рассмотрим пример. Вы создаете виртуальную машину и группу NSG и связываете их. Обмен данными между этой виртуальной машиной и другими виртуальными машинами в виртуальной сети регулируется правилом «РАЗРЕШИТЬ ВХОДЯЩИЙ ТРАФИК ВИРТУАЛЬНОЙ СЕТИ». Кроме того, правило «РАЗРЕШИТЬ ИСХОДЯЩИЙ ИНТЕРНЕТ-ТРАФИК» разрешает виртуальной машине устанавливать исходящее подключение к Интернету. Затем вы создаете конечную точку на порте 80, чтобы разрешить входящий трафик к веб-сайту, который запущен на виртуальной машине. Пакеты, отправляемые из Интернета на порт 80 общедоступного виртуального IP-адреса, не будут пропускаться на виртуальную машину, пока вы не создадите в группе NSG примерно такое правило:

| Имя | Приоритет | Исходный IP-адрес | Исходный порт | Конечный IP-адрес | Конечный порт | Протокол | Access |
|------|----------|-----------|-------------|----------------|------------------|----------|--------|
| ВЕБ | 100 | ИНТЕРНЕТ | * | * | 80 | TCP | РАЗРЕШИТЬ |


## Подготовка к использованию групп NSG

Ниже описаны основные этапы рабочих процессов для групп NSG.

### Создание и связывание группы NSG

1. Создайте группу NSG.

1. Добавьте правила сетевой безопасности, если правила по умолчанию не удовлетворяют все ваши потребности.

1. Свяжите группу NSG с виртуальной машиной.

1. Обновите виртуальную машину.

1. Правила группы NSG вступят в силу сразу.

### Обновление существующей группы NSG

1. Добавьте, удалите или измените правило в имеющейся группе NSG.

1. Все виртуальные машины, связанные с группой NSG, получат изменения в течение нескольких минут. Обновление виртуальной машины не требуется, если правило группы NSG уже связано с виртуальной машиной.

### Изменение связи с группой NSG

1. Свяжите новую группу NSG с виртуальной машиной, которая уже связана с другой группой NSG.

1. Обновите виртуальную машину.

1. Правила новой группы NSG вступят в силу в течение нескольких минут.

## Группы безопасности сети: создание, настройка и управление

Сейчас группы NSG можно настраивать и изменять только с помощью командлетов PowerShell и интерфейсов REST API. Настраивать группы NSG с помощью портала управления нельзя. С помощью приведенных ниже командлетов PowerShell вы сможете создавать и настраивать группы NSG, а также управлять ими.

**Создание группы безопасности сети**

	New-AzureNetworkSecurityGroup -Name "MyVNetSG" -Location uswest `
		-Label "Security group for my Vnet in West US"

**Добавление или изменение правила**

	Get-AzureNetworkSecurityGroup -Name "MyVNetSG" `
	| Set-AzureNetworkSecurityRule -Name WEB -Type Inbound -Priority 100 `
		-Action Allow -SourceAddressPrefix 'INTERNET'  -SourcePortRange '*' `
		-DestinationAddressPrefix '*' -DestinationPortRange '*' -Protocol TCP


**Удаление правила из группы NSG**

	Get-AzureNetworkSecurityGroup -Name "MyVNetSG" `
	| Remove-AzureNetworkSecurityRule -Name WEB

**Связывание группы NSG из виртуальной машиной**

	Get-AzureVM -ServiceName "MyWebsite" -Name "Instance1" `
	| Set-AzureNetworkSecurityGroupConfig -NetworkSecurityGroupName "MyVNetSG" `
	| Update-AzureVM

**Удаление группы NSG с виртуальной машины**

	Get-AzureVM -ServiceName "MyWebsite" -Name "Instance1" `
	| Remove-AzureNetworkSecurityGroupConfig -NetworkSecurityGroupName "MyVNetSG" `
	| Update-AzureVM

**Связывание группы NSG с подсетью**

	Get-AzureNetworkSecurityGroup -Name "MyVNetSG" `
	| Set-AzureNetworkSecurityGroupToSubnet -VirtualNetworkName 'VNetUSWest' `
		-SubnetName 'FrontEndSubnet'

**Удаление группы NSG из подсети**

	Get-AzureNetworkSecurityGroup -Name "MyVNetSG" `
	| Remove-AzureNetworkSecurityGroupFromSubnet -VirtualNetworkName 'VNetUSWest' `
		-SubnetName 'FrontEndSubnet'

**Удаление группы NSG**

	Remove-AzureNetworkSecurityGroup -Name "MyVNetSG"

**Получение сведений о группе NSG и ее правилах**

	Get-AzureNetworkSecurityGroup -Name "MyVNetSG" -Detailed
 

<!---HONumber=62-->