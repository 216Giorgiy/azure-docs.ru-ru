---
title: "Служба архивации Azure: согласованное с приложениями резервное копирование виртуальных машин Azure Linux | Документация Майкрософт"
description: "Согласованное с приложениями резервное копирование виртуальных машин Azure Linux"
services: backup
documentationcenter: dev-center-name
author: anuragm
manager: shivamg
keywords: "согласованное с приложениями резервное копирование; согласованное с приложениями резервное копирование виртуальных машин Azure; резервное копирование виртуальных машин Linux; служба архивации Azure"
ms.assetid: bbb99cf2-d8c7-4b3d-8b29-eadc0fed3bef
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 3/20/2017
ms.author: anuragm;markgal
translationtype: Human Translation
ms.sourcegitcommit: 424d8654a047a28ef6e32b73952cf98d28547f4f
ms.openlocfilehash: 044b5d3834518b44209485d1c1a68f2ac0f8a455
ms.lasthandoff: 03/22/2017


---
# <a name="application-consistent-backup-of-azure-linux-vms-preview"></a>Согласованное с приложениями резервное копирование виртуальных машин Azure Linux (предварительная версия)

В этой статье описана платформа Linux с поддержкой скриптов предварительного и последующего выполнения. Также рассмотрены способы ее использования при согласованном с приложениями резервном копировании виртуальных машин Azure Linux.

> [!Note]
> Платформа с поддержкой скриптов предварительного и последующего выполнения используется только с виртуальными машинами Linux, развернутыми в помощью Resource Manager (ее нельзя использовать с классическими виртуальными машинами или виртуальными машинами Windows).
>

## <a name="how-the-framework-works"></a>Принцип работы платформы

Эта платформа позволяет запускать пользовательские скрипты предварительного и последующего выполнения во время создания моментального снимка виртуальной машины. Скрипт предварительного выполнения запускается непосредственно перед созданием снимка виртуальной машины, а скрипт последующего выполнения — сразу после создания. Это позволяет пользователям гибко управлять своими приложением и средой во время резервного копирования виртуальной машины.

При использовании этой платформы важно обеспечить согласованное с приложениями резервное копирование виртуальной машины. Скрипт предварительного выполнения может вызывать собственные API-интерфейсы, чтобы приостановить работу ОС и скопировать содержимое памяти на диск. Это обеспечивает согласованность моментального снимка с приложениями, сохраняя состояние приложения для загружаемой после восстановления виртуальной машины. Скрипт последующего выполнения можно использовать для запуска ОС с помощью собственных API-интерфейсов, чтобы приложение могло возобновить нормальную работу после создания снимка виртуальной машины.

## <a name="steps-to-configure-pre-script-and-post-script"></a>Действия по настройке скриптов предварительного и последующего выполнения

1. Войдите на копируемую виртуальную машину Linux как привилегированный пользователь.

2. Скачайте файл VMSnapshotPluginConfig.json на [GitHub](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) и скопируйте его в каталог /etc/azure на всех копируемых виртуальных машинах. Если такого каталога нет, создайте его.

3. Скопируйте скрипты предварительного и последующего выполнения для приложения на все копируемые виртуальные машины. Это можно сделать в любом расположении на виртуальной машине. Нужно только обновить полный путь к файлам скриптов в файле VMSnapshotPluginConfig.json.

4. Обеспечьте следующие разрешения для файлов.

   - VMSnapshotPluginConfig.json: разрешение "600" (только у привилегированных пользователей есть разрешения на чтение и запись этого файла; разрешений на выполнение нет ни у кого).
   - Скрипт предварительного выполнения: разрешение "700" (только у привилегированных пользователей есть разрешения на чтение, запись и выполнение этого файла).
   - Скрипт последующего выполнения: разрешение "700" (только у привилегированных пользователей есть разрешения на чтение, запись и выполнение этого файла).
   
   > [!Note]
   > Платформа предоставляет широкие возможности для пользователей, поэтому крайне важно полностью обезопасить работу, предоставив разрешения на доступ к ключевым файлам JSON и скриптов только привилегированным пользователям.
   > Если перечисленные выше требования не будут выполнены, скрипт не запустится и будет создана резервная копия, согласованная с состоянием файловой системы на момент сбоя.
   >
   
5. Настройка файла VMSnapshotPluginConfig.json
    - **pluginName** — оставьте значение по умолчанию. Иначе скрипты могут выполняться неправильно.
    - **preScriptLocation** — укажите полный путь к скрипту предварительного выполнения на копируемой виртуальной машине.
    - **postScriptLocation** — укажите полный путь к скрипту последующего выполнения на копируемой виртуальной машине.
    - **preScriptParams** — любой необязательный параметр, который необходимо передать скрипту предварительного выполнения. Все параметры следует заключить в кавычки и (если используется несколько параметров) разделить запятыми.
    - **postScriptParams** — любой необязательный параметр, который необходимо передать скрипту последующего выполнения. Все параметры следует заключить в кавычки и (если используется несколько параметров) разделить запятыми.
    - **preScriptNoOfRetries** — число попыток запуска, совершаемых скриптом предварительного выполнения в случае сбоя перед завершением работы. "0" означает один запуск без повторных попыток в случае сбоя.
    - **postScriptNoOfRetries** — число попыток запуска, совершаемых скриптом последующего выполнения в случае сбоя перед завершением работы. "0" означает один запуск без повторных попыток в случае сбоя.
    - **timeoutInSeconds** — значения времени ожидания (разные) для скриптов предварительного и последующего выполнения.
    - **continueBackupOnFailure** — присвойте значение true, чтобы при сбое скриптов предварительного и последующего выполнения служба архивации Azure выполнила резервное копирование, согласованное с файловой системой и сбоем. Если присвоить значение false, при сбое скриптов резервное копирование также завершится сбоем (только если не используется виртуальная машина с одним диском, для которой резервное копирование состояния системы на момент сбоя будет выполнено независимо от этого параметра).
    - **fsFreezeEnabled** — указывает, будет ли во время создания моментального снимка виртуальной машины Linux вызываться fsfreeze для обеспечения согласованности с файловой системой. Рекомендуется присвоить значение true, если отключение fsfreeze может повлиять на состояние приложения.
    
6. Вы настроили платформу с поддержкой скриптов. Если для резервного копирования виртуальных машин также все готово, при следующем запуске этой операции будут вызваны скрипты, которые, в свою очередь, активируют согласованное с приложениями резервное копирование. В противном случае выполните настройку в соответствии с инструкциями для [резервного копирования виртуальных машин Azure в хранилища служб восстановления.](https://docs.microsoft.com/azure/backup/backup-azure-vms-first-look-arm)

## <a name="troubleshooting"></a>Устранение неполадок

Убедитесь, что при записи скриптов предварительного и последующего выполнения вы включили ведение соответствующих журналов. Так вы сможете просматривать и исправлять возможные ошибки, связанные с запуском скриптов. Если скрипты по-прежнему не удается запустить, см. таблицу ниже.

| Ошибка | Сообщение об ошибке | Рекомендуемое действие |
| ------------------------ | -------------- | ------------------ |
| Pre-ScriptExecutionFailed |Скрипт предварительного выполнения вернул ошибку, и резервная копия может быть несогласованной с приложениями.    | Чтобы устранить проблему, проверьте соответствующие журналы ошибок.|  
|    Post-ScriptExecutionFailed |    Скрипт последующего выполнения вернул ошибку, которая может влиять на состояние приложения. |    Чтобы устранить проблему, проверьте соответствующие журналы ошибок и состояние приложений. |
| Pre-ScriptNotFound |    Скрипт предварительного выполнения не найден в расположении, указанном в файле конфигурации VMSnapshotPluginConfig.json. |    Чтобы обеспечить согласованное с приложениями резервное копирование приложений, убедитесь, что скрипт предварительного выполнения находится в расположении, указанном в файле конфигурации.|
| Post-ScriptNotFound |    Скрипт последующего выполнения не найден в расположении, указанном в файле конфигурации VMSnapshotPluginConfig.json. |    Чтобы обеспечить согласованное с приложениями резервное копирование приложений, убедитесь, что скрипт последующего выполнения находится в расположении, указанном в файле конфигурации.|
| IncorrectPluginhostFile |    Файл Pluginhost, который поставляется вместе с расширением VmSnapshotLinux, поврежден, поэтому скрипты предварительного и последующего выполнения не могут быть запущены, а резервная копия будет несогласованной с приложениями.    | Чтобы устранить проблему, удалите модуль VmSnapshotLinux. Он будет автоматически переустановлен при следующем резервном копировании. |
| IncorrectJSONConfigFile | Файл VMSnapshotPluginConfig.json является недопустимым, поэтому скрипты предварительного и последующего выполнения невозможно запустить, и резервная копия будет несогласованной с приложениями. | Скачайте копию файла на [GitHub](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) и выполните повторную настройку. |
| InsufficientPermissionforPre-Script | Чтобы запускать скрипты, привилегированный пользователь (root) должен быть владельцем файла, а сам файл должен иметь разрешения "700" (т. е. только владелец имеет разрешения на его чтение, запись и выполнение). | Убедитесь, что владельцем файла скрипта является привилегированный пользователь (root) и что только владелец имеет разрешения на его чтение, запись и выполнение. |
| InsufficientPermissionforPost-Script | Чтобы запускать скрипты, привилегированный пользователь (root) должен быть владельцем файла, а сам файл должен иметь разрешения "700" (т. е. только владелец имеет разрешения на его чтение, запись и выполнение). | Убедитесь, что владельцем файла скрипта является привилегированный пользователь (root) и что только владелец имеет разрешения на его чтение, запись и выполнение. |
| Pre-ScriptTimeout | Истекло время запуска скрипта предварительного выполнения для согласованного с приложениями резервного копирования. | В файле VMSnapshotPluginConfig.json (расположен в каталоге /etc/azure) проверьте скрипт и увеличьте время ожидания. |
| Post-ScriptTimeout | Истекло время запуска скрипта последующего выполнения для согласованного с приложениями резервного копирования. | В файле VMSnapshotPluginConfig.json (расположен в каталоге /etc/azure) проверьте скрипт и увеличьте время ожидания. |

## <a name="next-steps"></a>Дальнейшие действия
[Архивация виртуальных машин Azure в хранилище служб восстановления](https://docs.microsoft.com/azure/backup/backup-azure-arm-vms)

