---
title: Восстановление баз данных SQL Server на виртуальной машине Azure, резервное копирование которых выполнено с помощью Azure Backup | Документация Майкрософт
description: В этой статье описывается восстановление запущенных на виртуальной машине Azure баз данных SQL Server, резервное копирование которых было выполнено с помощью Azure Backup.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/19/2018
ms.author: raynew
ms.openlocfilehash: 9b741f8562ae2e81d297357afd3b0e0e3976a248
ms.sourcegitcommit: 6cab3c44aaccbcc86ed5a2011761fa52aa5ee5fa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2019
ms.locfileid: "56445446"
---
# <a name="restore-sql-server-databases-on-azure-vms"></a>Восстановление баз данных SQL Server на виртуальных машинах Azure 


В этой статье описано, как восстановить запущенную на виртуальной машине Azure базу данных SQL Server, резервная копия которой была создана в хранилище Служб восстановления Azure Backup с помощью службы [Azure Backup](backup-overview.md).


> [!NOTE]
> Резервное копирование баз данных SQL Server, запущенных на виртуальной машине Azure, с помощью Azure Backup в настоящее время находится в общедоступной предварительной версии.


В этой статье описывается восстановление баз данных SQL Server. Если вы еще не настроили резервное копирование баз данных, следуйте инструкциям, содержащимся в [этой статье](backup-azure-sql-database.md).



## <a name="about-restoring-databases"></a>Сведения о восстановлении баз данных

В Azure Backup можно выполнить восстановление баз данных SQL Server, запущенных на виртуальных машинах Azure, следующим образом:

- Восстановите базы данных в состоянии на определенную дату или время (до секунд) с помощью резервных копий журналов транзакций. На основе выбранного времени Azure Backup автоматически определяет соответствующее полное разностное резервное копирование и цепочку резервных копий журналов, необходимых для восстановления.
- Восстановление конкретной полной или разностной резервной копии до определенной точки восстановления, а не на определенный момент времени.


### <a name="prerequisites"></a>Предварительные требования

Перед восстановлением базы данных обратите внимание на следующее:

- Можно восстановить базу данных на экземпляре SQL Server, расположенном в том же регионе Azure.
- Целевой сервер должен быть зарегистрирован в том же хранилище, что и исходный сервер.
- Чтобы восстановить базу данных, зашифрованную с помощью технологии TDE, в другом экземпляре SQL Server, сначала [восстановите сертификат на целевом сервере](https://docs.microsoft.com/sql/relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server?view=sql-server-2017).
- До активации восстановления базы данных master запустите экземпляр SQL Server в однопользовательском режиме с помощью параметра запуска **-m AzureWorkloadBackup**.
    - Значение для **-m** — имя клиента.
    - Только клиент с указанным именем может открыть подключение.
- Остановите службу агента SQL для всех системных баз данных (model, master, msdb), прежде чем активировать восстановление.
- Закройте все приложения, которые могут попытаться перехватить подключение к любой из этих баз данных.

## <a name="restore-a-database"></a>Восстановление базы данных

Для выполнения восстановления вам потребуются следующие разрешения:

* Разрешения **оператора резервного копирования** в хранилище, где выполняется восстановление.
* Доступ **участника (с правами на запись)** к исходной виртуальной машине, резервное копирование которой выполняется.
* Доступ **участника (с правами на запись)** к целевой виртуальной машине:
    - если вы выполняете восстановление на той же виртуальной машине, это исходная виртуальная машина;
    - если вы выполняете восстановление в альтернативное расположение, это будет новая целевая виртуальная машина. 

Восстановление состоит из следующих шагов.
1. Откройте хранилище, в котором зарегистрирована виртуальная машина SQL Server.
2. На панели мониторинга хранилища в разделе **Использование** выберите **Элементы архивации**.

    ![Открытие меню "Архивные элементы"](./media/backup-azure-sql-database/restore-sql-vault-dashboard.png).

3. В меню **Элементы архивации** в разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure).

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

4. Выберите базу данных для восстановления.

    ![Выбор базы данных для восстановления](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

5. Просмотрите меню базы данных. Оно предоставляет сведения о резервном копировании базы данных, включая: 

    * самые старые и самые новые точки восстановления;
    * состояние резервного копирования журналов за последние 24 часа (для баз данных в режиме восстановления с полным и неполным протоколированием, если настроено резервное копирование журналов транзакций).

6. Щелкните **Восстановить базу данных**. 

    ![Выбор "Восстановить базу данных"](./media/backup-azure-sql-database/restore-db-button.png)

7. В области **Конфигурация восстановления** укажите расположение для восстановления данных:
    - **Альтернативное расположение**. Восстановление базы данных в альтернативное расположение и сохранение исходной базы данных-источника.
    - **Перезаписать базу данных**. Восстановление данных в том же экземпляре SQL Server, где находится исходный источник. При этом перезаписывается исходная база данных.

    > [!Important]
    > Если выбранная база данных принадлежит к группе доступности Always On, SQL Server не позволит перезаписать базу данных. Доступно только значение **Альтернативное расположение**.
    >

    ![Меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-restore-configuration-menu.png)

### <a name="restore-to-an-alternate-location"></a>Восстановление в альтернативном расположении

1. В меню **Конфигурация восстановления** в разделе **Выбор места для восстановления** выберите **Альтернативное расположение**.
2. Выберите имя сервера SQL Server и экземпляр, в котором нужно восстановить базу данных.
3. В поле **Имя восстановленной базы данных** введите имя целевой базы данных.
4. Если это применимо, выберите параметр **Overwrite if the DB with the same name already exists on selected SQL instance** (Перезаписать, если база данных с тем же именем уже существует в выбранном экземпляре SQL).
5. Последовательно выберите **ОК**.

    ![Указание значений в меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration-menu.png)

2. В меню **Select restore point** (Выбор точки восстановления) выберите тип восстановления: [до определенной точки во времени](#restore-to-a-specific-point-in-time) или [до определенной точки восстановления](#restore-to-a-specific-restore-point).

    > [!NOTE]
    > Восстановление до точки во времени доступно только для резервных копий журналов для баз данных, использующих режим восстановления с полным и неполным протоколированием. 


### <a name="restore-and-overwrite"></a>Восстановление и перезапись

1. В меню **Конфигурация восстановления** в разделе **Выбор места для восстановления** выберите **Перезаписать базу данных** > **ОК**.

    ![Выбор "Перезаписать базу данных"](./media/backup-azure-sql-database/restore-configuration-overwrite-db.png)

2. В меню **Выбор точки восстановления** выберите **Logs (Point in Time) (Журналы (восстановление до точки во времени)) для [восстановления до определенной точки во времени](#restore-to-a-specific-point-in-time) или **Full & Differential** (Полная и разностная) для восстановления до [определенной точки восстановления](#restore-to-a-specific-restore-point).

    > [!NOTE]
    > Восстановление до точки во времени доступно только для резервных копий журналов для баз данных, использующих с модель восстановления с полным и неполным протоколированием. 




    
### <a name="restore-to-a-specific-point-in-time"></a>Восстановление данных до определенной точки во времени

Если вы выбрали **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) как тип восстановления, выполните следующие действия:

1.  В разделе **Дата и время восстановления** выберите мини-календарь. Даты, выделенные в **календаре** жирным шрифтом, содержат точки восстановления. Текущая дата выделена.
2. Выберите дату с точками восстановления. Даты без точек восстановления выбрать невозможно.

    ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

3. После выбора даты временная шкала отображает доступные точки восстановления в непрерывном диапазоне.
4. Укажите время для восстановления с помощью временной шкалы или выберите время. Нажмите кнопку **ОК**.

    ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-graph.png)

 
4. В меню **Расширенная конфигурация**, если вы хотите сохранить базу данных в нерабочем состоянии после восстановления, включите параметр **Restore with NORECOVERY** (Восстановление с NORECOVERY).
5. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь.
6. Последовательно выберите **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)


7. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
8. Отслеживать ход восстановления можно в области **Уведомления**. Вы можете также выбрать **Restore jobs** (Задания восстановления) в меню базы данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)



### <a name="restore-to-a-specific-restore-point"></a>Восстановление данных до определенной точки восстановления

Если вы выбрали **Full & Differential** (Полная и разностная) как тип восстановления, выполните следующие действия:


1. Чтобы завершить процедуру, из списка точек восстановления выберите точку восстановления и щелкните **ОК**.

    ![Выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)
        
2. В меню **Расширенная конфигурация**, если вы хотите сохранить базу данных в нерабочем состоянии после восстановления, включите параметр **Restore with NORECOVERY** (Восстановление с NORECOVERY).
3. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь. 
4. Последовательно выберите **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

7. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
8. Отслеживать ход восстановления можно в области **Уведомления**. Вы можете также выбрать **Restore jobs** (Задания восстановления) в меню базы данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

## <a name="next-steps"></a>Дополнительная информация

[Выполняйте мониторинг](manage-monitor-sql-database-backup.md) баз данных SQL Server, резервное копирование которых выполняется с помощью Azure Backup, и управление ими.
