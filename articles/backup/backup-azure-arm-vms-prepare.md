---
title: Резервное копирование виртуальных машин Azure в хранилище Служб восстановления с помощью Azure Backup
description: Описание резервного копирования виртуальных машин Azure в хранилище Служб восстановления с помощью Azure Backup
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 03/13/2019
ms.author: raynew
ms.openlocfilehash: 2cc5384fe039e757b33802075d0e550b369477f3
ms.sourcegitcommit: 5839af386c5a2ad46aaaeb90a13065ef94e61e74
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2019
ms.locfileid: "57874972"
---
# <a name="back-up-azure-vms-in-a-recovery-services-vault"></a>Резервное копирование виртуальных машин Azure в хранилище Служб восстановления

В этой статье описывается, как создать резервную копию виртуальной машины Azure с помощью [Azure Backup](backup-overview.md), развернув и включив резервное копирование в хранилище Служб восстановления.

В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Проверка поддерживаемых сценариев и необходимых компонентов.
> * Подготовка виртуальных машин Azure. Установка агента виртуальной машины Azure (при необходимости) и проверка исходящего доступа для виртуальных машин.
> * создание хранилища;
> * Настройка типа хранилища.
> * Выполните обнаружение виртуальных машин, настройте политику и параметры архивации.
> * Включение резервного копирования для виртуальных машин Azure.


> [!NOTE]
   > В этой статье описывается резервное копирование виртуальных машин Azure путем настройки хранилища и выбора виртуальных машин для архивации. Этот способ удобен, если вы хотите создать резервные копии нескольких виртуальных машин. Кроме того, вы можете [создать резервную копию виртуальной машины Azure](backup-azure-vms-first-look-arm.md) непосредственно из ее параметров.

## <a name="before-you-start"></a>Перед началом работы

Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure.

1. [Ознакомьтесь](backup-architecture.md#architecture-direct-backup-of-azure-vms) с архитектурой резервного копирования виртуальной машины Azure.
[Узнайте о](backup-azure-vms-introduction.md) резервном копировании виртуальных машин Azure и расширении резервного копирования.
2. [Ознакомьтесь с матрицей поддержки](backup-support-matrix-iaas.md) для резервного копирования виртуальной машины Azure.
3. Подготовка виртуальных машин Azure. Установите агент виртуальной машины, если он не установлен, и проверьте исходящий доступ для виртуальных машин, для которых нужно выполнить резервное копирование.


## <a name="prepare-azure-vms"></a>Подготовка виртуальных машин Azure

При необходимости установите агент виртуальной машины и проверьте исходящий доступ для виртуальных машин.

### <a name="install-the-vm-agent"></a>Установка агента виртуальной машины
При необходимости установите агент следующим образом.

**Виртуальная машина** | **Дополнительные сведения**
--- | ---
**Виртуальные машины Windows** | [Скачайте и установите](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) MSI-файл агента. Требуется установка с разрешениями администратора на компьютере.<br/><br/> Чтобы проверить установку, в папке *C:\WindowsAzure\Packages* на виртуальной машине щелкните правой кнопкой мыши файл WaAppAgent.exe и выберите пункт **Свойства** > **Сведения**. В поле **Версия продукта** должно отображаться значение 2.6.1198.718 или выше.<br/><br/> Если вам нужно обновить агент, убедитесь, что операции резервного копирования не выполняются, и [переустановите агент](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).
**Виртуальные машины Linux** | Установка с помощью пакета RPM или DEB из репозитория пакета дистрибутива является предпочтительным способом установки и обновления агента Linux для Azure. Все [поставщики поддерживаемых дистрибутивов](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros) встраивают пакет агента Linux для Azure в свои образы и репозитории. Агент можно найти в [GitHub](https://github.com/Azure/WALinuxAgent), но мы не рекомендуем устанавливать его оттуда.<br/><br/> Если вам нужно обновить агент, убедитесь, что операции резервного копирования не выполняются, и обновите двоичные файлы.


### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Расширение резервного копирования, выполняемое на виртуальной машине, должно иметь исходящий доступ к общедоступным IP-адресам Azure.

- Для взаимодействия виртуальной машины Azure со службой Azure Backup не требуется явный исходящий сетевой доступ.
- Тем не менее при попытке подключения некоторых старых виртуальных машин могут возникнуть проблемы и произойти завершение с ошибкой **ExtensionSnapshotFailedNoNetwork**. В этом случае используйте один из следующих вариантов, чтобы расширение резервного копирования могло обмениваться данными с общедоступными IP-адресами Azure для трафика резервного копирования.

   **Параметр** | **Действие** | **Преимущества** | **Недостатки**
   --- | --- | --- | ---
   **Настройка правил NSG** | Разрешите [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653).<br/><br/>  Вы можете добавить правило, которое разрешает доступ к службе Azure Backup с помощью [тега службы](backup-azure-arm-vms-prepare.md#set-up-an-nsg-rule-to-allow-outbound-access-to-azure), вместо того чтобы по отдельности разрешать каждый диапазон адресов и управлять им. [Дополнительные сведения](../virtual-network/security-overview.md#service-tags) о тегах служб. | Нет дополнительных затрат. Простота управления с помощью тегов служб.
   **Развертывание прокси-сервера** | Разверните прокси-сервер HTTP для маршрутизации трафика. | Доступ ко всей службе Azure, а не только к хранилищу. Точное управление URL-адресами хранилища.<br/><br/> Единая точка доступа к виртуальным машинам через Интернет.<br/><br/> Дополнительные затраты на прокси-сервер.<br/><br/>
   **Настройка Брандмауэра Azure** | Разрешите трафик через брандмауэр Azure на виртуальной машине, используя тег полного доменного имени для службы Azure Backup.|  Проста в использовании при наличии брандмауэра Azure в подсети виртуальной сети. | Нельзя создать собственные теги полного доменного имени или изменить полное доменное имя в теге.<br/><br/> Если вы используете "Управляемые диски Azure", может потребоваться открыть в брандмауэрах дополнительный порт (8443).

#### <a name="set-up-an-nsg-rule-to-allow-outbound-access-to-azure"></a>Настройка правила NSG для разрешения исходящего доступа к Azure

Если доступом к виртуальной машине Azure управляет группа безопасности сети, разрешите исходящий доступ для хранилища резервных копий к необходимым диапазонам адресов и портов.

1. На виртуальной машине перейдите в раздел **Сети** и щелкните **Добавить правило исходящего порта**.
2. В разделе **Добавление правила безопасности для исходящего трафика** нажмите кнопку **Дополнительно**.
3. В поле **Источник** выберите **VirtualNetwork**.
4. В поле **Диапазоны исходных портов** введите звездочку (*), чтобы разрешить исходящий доступ из любого порта.
5. В поле **Назначение** выберите **Тег службы**. В списке выберите **хранилище.регион**. Регион — это регион, в котором находятся хранилище и архивируемые виртуальные машины.
6. В поле **Диапазоны портов назначения** выберите порт.
    - Неуправляемая виртуальная машина с незашифрованной учетной записью хранения: 80
    - Неуправляемая виртуальная машина с зашифрованной учетной записью хранения: 443 (значение по умолчанию)
    - Управляемая виртуальная машина: 8443
7. В поле **Протокол** выберите **TCP**.
8. В поле **Приоритет** укажите значение приоритета меньше, чем у любых вышестоящих запрещающих правил. Если у вас есть правило, запрещающее доступ, новое разрешающее правило должно иметь более высокий приоритет. Например, если у вас есть набор правил **Deny_All** с приоритетом 1000, новое правило должно иметь значение меньше 1000.
9. Укажите имя и описание правила и нажмите кнопку **ОК**.

Правило группы безопасности сети можно применить к нескольким виртуальным машинам, чтобы разрешить исходящий доступ.

В этом видео рассматривается вся процедура.

>[!VIDEO https://www.youtube.com/embed/1EjLQtbKm1M]


#### <a name="route-backup-traffic-through-a-proxy"></a>Маршрутизация трафика резервного копирования через прокси-сервер

Трафик резервного копирования можно перенаправить через прокси-сервер, а затем предоставить прокси-серверу доступ к нужным диапазонам Azure.
Необходимо настроить виртуальную машину прокси-сервера, чтобы разрешить следующее.

- Виртуальная машина Azure направляет весь HTTP-трафик для общего доступа в Интернете через прокси-сервер.
- Прокси-сервер должен разрешать входящий трафик с виртуальных машин в соответствующую виртуальную сеть.
- Для группы безопасности сети **NSF-lockdown** требуется правило, которое разрешает передачу интернет-трафика с виртуальной машины прокси-сервера.

##### <a name="set-up-the-proxy"></a>Настройка прокси-сервера
Если у вас нет прокси-сервера системной учетной записи, настройте его следующим образом.

1. Скачайте [PsExec](https://technet.microsoft.com/sysinternals/bb897553).

2. Запустите **PsExec.exe -i -s cmd.exe** для запуска командной строки от имени учетной записи системы.
3. Запустите браузер в контексте системы. Например, **%PROGRAMFILES%\Internet Explorer\iexplore.exe** для Internet Explorer.  
4. Задайте параметры прокси-сервера.
   - На компьютерах Linux
     - Добавьте следующую строку в файл **/etc/environment**.
       - **http_proxy=<http://proxy> IP address:proxy port**
     - Добавьте следующие строки в файл **/etc/waagent.conf**.
         - **HttpProxy.Host=proxy IP address**
         - **HttpProxy.Port=proxy port**
   - На компьютерах Windows в настройках браузера укажите, что должен использоваться прокси-сервер. Если вы уже используете прокси-сервер для учетной записи пользователя, чтобы применить настройки на уровне учетной записи системы, можете использовать этот сценарий.
       ```powershell
      $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
      $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver

       ```

##### <a name="allow-incoming-connections-on-the-proxy"></a>Разрешение входящих подключений к прокси-серверу

Разрешите входящие подключения в параметрах прокси-сервера.

- Например, откройте **брандмауэр Windows в режиме повышенной безопасности**.
    - Щелкните правой кнопкой мыши **Правила для входящих подключений**  >  **Новое правило**.
    - В поле **Тип правила** выберите **Другое**  >  **Далее**.
    - В области **Программы** выберите **Все программы**  >  **Далее**.
    - В поле **Протоколы и порты** задайте тип **TCP**, в поле **Локальные порты** — значение **Определенные порты** и в поле **Удаленный порт** — **Все порты**.
    - Завершите работу мастера и укажите имя для правила.

##### <a name="add-an-exception-rule-to-the-nsg-for-the-proxy"></a>Добавление правила исключения к группе NSG для прокси-сервера

В правиле NSG **NSF-lockdown** разрешите трафик с любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS).

- Ниже приведен пример сценария PowerShell для разрешения трафика.
- Вместо того чтобы разрешать исходящий трафик на все общедоступные IP-адреса, можно указать диапазон IP-адресов (-DestinationPortRange) или использовать тег службы storage.region.   

    ```powershell
    Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
    Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
    ```

### <a name="allow-firewall-access-with-fqdn-tag"></a>Разрешение доступа брандмауэра с помощью тега FQDN

В брандмауэре Azure можно настроить разрешение исходящего доступа для сетевого трафика к службе Azure Backup.

- [Дополнительные сведения](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal) о развертывании брандмауэра Azure.
- [Сведения](https://docs.microsoft.com/azure/firewall/fqdn-tags) о тегах полных доменных имен.

## <a name="set-up-storage-replication"></a>Настройка репликации хранилища

По умолчанию это [геоизбыточное хранилище (GRS)](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs). Мы рекомендуем геоизбыточные хранилища для основных резервных копий, но вы можете использовать и более экономичный вариант — [локально избыточное хранилище](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

Служба архивации Azure автоматически обрабатывает хранилища для хранилища. Необходимо указать способ репликации этого хранилища.
Измените репликацию хранилища следующим образом.

1. В колонке **Хранилища служб восстановления** щелкните новое хранилище. В разделе **параметры** щелкните **свойства**.
2. В **свойства**в разделе **резервная конфигурация**, нажмите кнопку **обновления**.

3. Выберите тип репликации хранилища и нажмите кнопку **Сохранить**.

      ![Настройка конфигурации для нового хранилища](./media/backup-try-azure-backup-in-10-mins/full-blade.png)


## <a name="configure-a-backup-policy"></a>Настройка политики резервного копирования

Выполните обнаружение виртуальных машин в подписке и настройте резервное копирование.

1. В хранилище выберите **Обзор**, нажмите кнопку **+ Архивация**.

   ![Кнопка "Архивация"](./media/backup-azure-arm-vms-prepare/backup-button.png)

   Откроются области **Архивация** и **Цель резервного копирования**.

2. В разделе **Цель резервного копирования** >  **Где выполняется рабочая нагрузка?** выберите **Azure**. В раскрывающемся списке **Что необходимо архивировать?** выберите **Виртуальная машина**  >   **ОК**. При этом расширение виртуальной машины зарегистрируется в хранилище.

   ![Области "Архивация" и "Цель резервного копирования"](./media/backup-azure-arm-vms-prepare/select-backup-goal-1.png)

   При этом расширение виртуальной машины зарегистрируется в хранилище. После этого область **Цель резервного копирования** закроется и откроется область **Политика архивации**.

3. В области **Политика архивации** выберите политику, которую вы хотите связать с хранилищем. Нажмите кнопку **ОК**.
    - Подробные сведения о политике по умолчанию указаны в раскрывающемся меню.
    - Чтобы создать политику, щелкните **Создать**. [Подробнее](backup-azure-arm-vms-prepare.md#configure-a-backup-policy) об определении политики.

      ![Области "Архивация" и "Политика архивации"](./media/backup-azure-arm-vms-prepare/select-backup-goal-2.png)

4. В области **Выбор виртуальных машин** выберите виртуальные машины, которые будут использовать указанную политику резервного копирования и нажмите кнопку **ОК**.

   - Выбранные виртуальные машины проверяются.
   - Виртуальные машины можно выбрать только в том же регионе, что и хранилище. Архивация виртуальных машин может выполняться только в одном хранилище.

     ![Область "Выбор виртуальных машин"](./media/backup-azure-arm-vms-prepare/select-vms-to-backup.png)

5. В разделе **Архивация** выберите **Включить резервное копирование**.

   - При этом в хранилище и на виртуальных машинах развертывается политика и устанавливается расширение архивации на агенте ВМ на виртуальной машине Azure.
   - На этом шаге не создается начальная точка восстановления для виртуальной машины.

     ![Кнопка "Включить резервное копирование"](./media/backup-azure-arm-vms-prepare/vm-validated-click-enable.png)

После включения резервного копирования

- Начальное резервное копирование запускается в соответствии с расписанием резервного копирования.
- Расширение резервного копирования устанавливается службой Azure Backup независимо от того, запущена ли виртуальная машина.
    - На запущенной виртуальной машине проще получить точку восстановления, согласованную с приложениями.
    -  Тем не менее резервное копирование виртуальной машины выполняется даже в том случае, если она выключена и нельзя установить расширение. Это называется *автономной виртуальной машиной*. В этом случае точка восстановления будет *отказоустойчивой*.
    Обратите внимание, что Azure Backup не поддерживает настройку автоматического перехода на летнее время для резервных копий виртуальных машин Azure. Измените политики резервного копирования вручную при необходимости.

## <a name="run-the-initial-backup"></a>Выполнение начального резервного копирования

Начальное резервное копирование будет выполняться в соответствии с расписанием, если вы не запустите его немедленно вручную. Запустите его вручную следующим образом:

1. В меню хранилища щелкните **Элементы архивации**.
2. На плитке **Элементы архивации** щелкните **Виртуальная машина Azure**.
3. В списке **Элементы архивации** щелкните многоточие **...**.
4. Щелкните **Создать резервную копию**.
5. В окне **Создать резервную копию** используйте элементы управления "Календарь", чтобы выбрать последний день, до которого точка восстановления должна храниться, а затем щелкните **ОК**.
6. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения задания на панели мониторинга хранилища в разделе **Задания резервного копирования** > **Выполняется**. В зависимости от размера виртуальной машины создание начального архива может занять некоторое время.



## <a name="next-steps"></a>Дальнейшие действия

- Поиск и устранение неполадок, возникающих с [агентами виртуальных машин Azure](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md) или [резервным копированием виртуальных машин Azure](backup-azure-vms-troubleshoot.md).
- [Резервное копирование виртуальных машин Azure](backup-azure-vms-first-look-arm.md)
