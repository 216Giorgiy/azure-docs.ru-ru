---
title: Резервное копирование виртуальных машин Azure в хранилище Служб восстановления с помощью Azure Backup
description: Описание резервного копирования виртуальных машин Azure в хранилище Служб восстановления с помощью Azure Backup
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 03/22/2019
ms.author: raynew
ms.openlocfilehash: 3133f22a4d9ecd8a0ee4bff9f8b0be9c1f4eb705
ms.sourcegitcommit: 81fa781f907405c215073c4e0441f9952fe80fe5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/25/2019
ms.locfileid: "58403669"
---
# <a name="back-up-azure-vms-in-a-recovery-services-vault"></a>Резервное копирование виртуальных машин Azure в хранилище Служб восстановления

В этой статье описывается резервное копирование виртуальных машин Azure в хранилищах служб восстановления с [Azure Backup](backup-overview.md) службы. 

В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Проверка поддержки и предварительные требования для резервного копирования.
> * Подготовка виртуальных машин Azure. Установка агента виртуальной машины Azure (при необходимости) и проверка исходящего доступа для виртуальных машин.
> * создание хранилища;
> * Обнаружение виртуальных машин и настройте политику резервного копирования.
> * Включите резервное копирование для виртуальных машин Azure.


> [!NOTE]
   > В этой статье описывается настройка хранилища и выберите виртуальные машины для резервного копирования. Этот способ удобен, если вы хотите создать резервные копии нескольких виртуальных машин. Вы также можете [резервное копирование одной виртуальной Машине Azure](backup-azure-vms-first-look-arm.md) в настройках виртуальной Машины.

## <a name="before-you-start"></a>Перед началом работы


- [Ознакомьтесь](backup-architecture.md#architecture-direct-backup-of-azure-vms) с архитектурой резервного копирования виртуальной машины Azure.
- [Узнайте о](backup-azure-vms-introduction.md) резервном копировании виртуальных машин Azure и расширении резервного копирования.
- [Ознакомьтесь с матрицей поддержки](backup-support-matrix-iaas.md) для резервного копирования виртуальной машины Azure.


## <a name="prepare-azure-vms"></a>Подготовка виртуальных машин Azure

В некоторых случаях может потребоваться настроить агент виртуальной Машины Azure на виртуальных машинах Azure, либо явным образом разрешить исходящий доступ на виртуальной Машине.

### <a name="install-the-vm-agent"></a>Установка агента виртуальной машины 

Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure. Если виртуальная машина создана из образа Azure marketplace, агент будет установлен и запущен. Если создать настраиваемую виртуальную Машину, или перенести на локальном компьютере, может потребоваться установить агент вручную, как описано в таблице.

**Виртуальная машина** | **Дополнительные сведения**
--- | ---
**Виртуальные машины Windows** | 1. [Скачайте и установите](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) MSI-файл агента.<br/><br/> 2. Требуется установка с разрешениями администратора на компьютере.<br/><br/> 3. Проверьте установку. В *C:\WindowsAzure\Packages* на виртуальной Машине, щелкните правой кнопкой мыши WaAppAgent.exe > **свойства**, > **сведения** вкладки. В поле **Версия продукта** должно отображаться значение 2.6.1198.718 или выше.<br/><br/> Если вам нужно обновить агент, убедитесь, что операции резервного копирования не выполняются, и [переустановите агент](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).
**Виртуальные машины Linux** | Установка с помощью пакета RPM или DEB из репозитория пакета дистрибутива. Это предпочтительный метод для установки и обновления агента Linux для Azure. Все [поставщики поддерживаемых дистрибутивов](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros) встраивают пакет агента Linux для Azure в свои образы и репозитории. Агент можно найти в [GitHub](https://github.com/Azure/WALinuxAgent), но мы не рекомендуем устанавливать его оттуда.<br/><br/> Если вы обновляете агент, убедитесь, что операции резервного копирования, не работает и обновляет двоичные файлы.


### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для расширения резервного копирования, на виртуальной Машине требуется исходящий доступ к Azure общедоступных IP-адресов.

- Обычно не требуется явным образом разрешить исходящий сетевой доступ для виртуальной Машины Azure для его для взаимодействия со службой Azure Backup.
- Если возникли трудности с виртуальными машинами подключение, и в том случае, если появится сообщение об ошибке **ExtensionSnapshotFailedNoNetwork** при попытках установить соединение, следует явным образом разрешить доступ, чтобы расширение резервного копирования может обмениваться данными с Azure public IP-адреса для трафика резервного копирования.


#### <a name="explicitly-allow-outbound-access"></a>Явным образом разрешить исходящий доступ

Если ваша виртуальная машина не удается подключиться к службе архивации, явным образом разрешите исходящий доступ, используя один из методов, представленных в таблице.

**Параметр** | **Действие** | **Дополнительные сведения** 
--- | --- | --- 
**Настройка правил NSG** | Разрешите [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653). | Вместо разрешения и управление каждый диапазон адресов, можно добавить правило, которое разрешает доступ к службе архивации Azure с помощью [тег службы](backup-azure-arm-vms-prepare.md#set-up-an-nsg-rule-to-allow-outbound-access-to-azure). [Узнайте больше](../virtual-network/security-overview.md#service-tags).<br/><br/> Нет дополнительных затрат.<br/><br/> Простое управление с помощью тегов службы.
**Развертывание прокси-сервера** | Разверните прокси-сервер HTTP для маршрутизации трафика. | Доступ ко всей службе Azure, а не только к хранилищу.<br/><br/> Точное управление URL-адресами хранилища.<br/><br/> Единая точка доступа к виртуальным машинам через Интернет.<br/><br/> Дополнительные затраты на прокси-сервер.
**Настройка Брандмауэра Azure** | Разрешите трафик через брандмауэр Azure на виртуальной машине, используя тег полного доменного имени для службы Azure Backup. |  Проста в использовании при наличии брандмауэра Azure в подсети виртуальной сети.<br/><br/> Невозможно создать собственные теги полное доменное имя или измените полные доменные имена в теге.<br/><br/> Если вы используете "Управляемые диски Azure", может потребоваться открыть в брандмауэрах дополнительный порт (8443).

##### <a name="set-up-an-nsg-rule-to-allow-outbound-access-to-azure"></a>Настройка правила NSG для разрешения исходящего доступа к Azure

Если доступ к виртуальной Машине управляется с помощью группы безопасности сети, разрешите исходящий доступ для хранения резервных копий, необходимых диапазонов адресов и портов.

1. В свойствах виртуальной Машины > **сети**, нажмите кнопку **добавить правило исходящего порта**.
2. В разделе **Добавление правила безопасности для исходящего трафика** нажмите кнопку **Дополнительно**.
3. В поле **Источник** выберите **VirtualNetwork**.
4. В поле **Диапазоны исходных портов** введите звездочку (*), чтобы разрешить исходящий доступ из любого порта.
5. В поле **Назначение** выберите **Тег службы**. В списке выберите **хранилище.регион**. Регион — это регион, в котором находятся хранилище и архивируемые виртуальные машины.
6. В поле **Диапазоны портов назначения** выберите порт.
    - Неуправляемая виртуальная машина с незашифрованной учетной записью хранения: 80
    - Неуправляемая виртуальная машина с зашифрованной учетной записью хранения: 443 (значение по умолчанию)
    - Управляемая виртуальная машина: 8443
7. В поле **Протокол** выберите **TCP**.
8. В поле **Приоритет** укажите значение приоритета меньше, чем у любых вышестоящих запрещающих правил.
   - Если у вас есть правило, запрещающее доступ, новое разрешающее правило должно иметь более высокий приоритет.
   - Например, если у вас есть набор правил **Deny_All** с приоритетом 1000, новое правило должно иметь значение меньше 1000.
9. Укажите имя и описание правила и нажмите кнопку **ОК**.

Правило группы безопасности сети можно применить к нескольким виртуальным машинам, чтобы разрешить исходящий доступ. В этом видео рассматривается вся процедура.

>[!VIDEO https://www.youtube.com/embed/1EjLQtbKm1M]


##### <a name="route-backup-traffic-through-a-proxy"></a>Маршрутизация трафика резервного копирования через прокси-сервер

Трафик резервного копирования можно перенаправить через прокси-сервер, а затем предоставить прокси-серверу доступ к нужным диапазонам Azure. Настройка прокси-сервера виртуальной Машины, чтобы разрешить следующие:

- Виртуальная машина Azure направляет весь HTTP-трафик для общего доступа в Интернете через прокси-сервер.
- Прокси-сервер должен разрешать входящий трафик с виртуальных машин в соответствующую виртуальную сеть.
- Для группы безопасности сети **NSF-lockdown** требуется правило, которое разрешает передачу интернет-трафика с виртуальной машины прокси-сервера.

###### <a name="set-up-the-proxy"></a>Настройка прокси-сервера

Если у вас нет прокси-сервера системной учетной записи, настройте его следующим образом.

1. Скачайте [PsExec](https://technet.microsoft.com/sysinternals/bb897553).
2. Запустите **PsExec.exe -i -s cmd.exe** для запуска командной строки от имени учетной записи системы.
3. Запустите браузер в контексте системы. Например, **%PROGRAMFILES%\Internet Explorer\iexplore.exe** для Internet Explorer.  
4. Задайте параметры прокси-сервера.
   - На компьютерах Linux
     - Добавьте следующую строку в файл **/etc/environment**.
       - **http_proxy=http:\//proxy IP address:proxy port**
     - Добавьте следующие строки в файл **/etc/waagent.conf**.
         - **HttpProxy.Host=proxy IP address**
         - **HttpProxy.Port=proxy port**
   - На компьютерах Windows в настройках браузера укажите, что должен использоваться прокси-сервер. Если вы уже используете прокси-сервер для учетной записи пользователя, чтобы применить настройки на уровне учетной записи системы, можете использовать этот сценарий.
       ```powershell
      $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
      $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
      Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver

       ```

###### <a name="allow-incoming-connections-on-the-proxy"></a>Разрешение входящих подключений к прокси-серверу

Разрешите входящие подключения в параметрах прокси-сервера.

1, в брандмауэре Windows откройте **брандмауэр Windows в режиме повышенной безопасности**.
2. Щелкните правой кнопкой мыши **Правила для входящих подключений**  >  **Новое правило**.
3. В поле **Тип правила** выберите **Другое**  >  **Далее**.
4. В области **Программы** выберите **Все программы**  >  **Далее**.
5. В **протоколы и порты**:
   - Задайте тип **TCP**
   - Задайте **локальные порты** для **отдельных портов**
   - Задайте **удаленный порт** для **все порты**.
  
6. Завершите работу мастера и укажите имя для правила.

###### <a name="add-an-exception-rule-to-the-nsg-for-the-proxy"></a>Добавление правила исключения к группе NSG для прокси-сервера

В правиле NSG **NSF-lockdown** разрешите трафик с любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS).

- Ниже приведен пример сценария PowerShell для разрешения трафика.
- Вместо того чтобы разрешать исходящий трафик на все общедоступные IP-адреса, можно указать диапазон IP-адресов (-DestinationPortRange) или использовать тег службы storage.region.   

    ```powershell
    Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
    Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
    ```

### <a name="allow-firewall-access-with-fqdn-tag"></a>Разрешение доступа брандмауэра с помощью тега FQDN

В брандмауэре Azure можно настроить разрешение исходящего доступа для сетевого трафика к службе Azure Backup.

- [Дополнительные сведения](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal) о развертывании брандмауэра Azure.
- [Сведения](https://docs.microsoft.com/azure/firewall/fqdn-tags) о тегах полных доменных имен.

## <a name="modify-storage-replication-settings"></a>Изменение параметров репликации хранилища

По умолчанию это [геоизбыточное хранилище (GRS)](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs).

- Мы рекомендуем использовать GRS для резервная копия является основной.
- Можно использовать [локально избыточное хранилище (LRS)](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs?toc=%2fazure%2fstorage%2fblobs%2ftoc.json) дешевле параметра.

Измените тип репликации хранилища следующим образом:

1. На портале щелкните новое хранилище. В разделе **параметры** щелкните **свойства**.
2. В **свойства**в разделе **резервная конфигурация**, нажмите кнопку **обновления**.
3. Выберите тип репликации хранилища и нажмите кнопку **Сохранить**.

      ![Настройка конфигурации для нового хранилища](./media/backup-try-azure-backup-in-10-mins/full-blade.png)


## <a name="configure-a-backup-policy"></a>Настройка политики резервного копирования

Выполните обнаружение виртуальных машин в подписке и настройте резервное копирование.

1. В хранилище выберите **Обзор**, нажмите кнопку **+ Архивация**.

   ![Кнопка "Архивация"](./media/backup-azure-arm-vms-prepare/backup-button.png)

   Откроются области **Архивация** и **Цель резервного копирования**.

2. В разделе **Цель резервного копирования** >  **Где выполняется рабочая нагрузка?** выберите **Azure**. В раскрывающемся списке **Что необходимо архивировать?** выберите **Виртуальная машина**  >   **ОК**. При этом расширение виртуальной машины зарегистрируется в хранилище.

   ![Области "Архивация" и "Цель резервного копирования"](./media/backup-azure-arm-vms-prepare/select-backup-goal-1.png)

   При этом расширение виртуальной машины зарегистрируется в хранилище. После этого область **Цель резервного копирования** закроется и откроется область **Политика архивации**.

3. В области **Политика архивации** выберите политику, которую вы хотите связать с хранилищем. Нажмите кнопку **ОК**.
    - Подробные сведения о политике по умолчанию указаны в раскрывающемся меню.
    - Чтобы создать политику, щелкните **Создать**. [Подробнее](backup-azure-arm-vms-prepare.md#configure-a-backup-policy) об определении политики.

      ![Области "Архивация" и "Политика архивации"](./media/backup-azure-arm-vms-prepare/select-backup-goal-2.png)

4. В области **Выбор виртуальных машин** выберите виртуальные машины, которые будут использовать указанную политику резервного копирования и нажмите кнопку **ОК**.

   - Выбранные виртуальные машины проверяются.
   - Виртуальные машины можно выбрать только в том же регионе, что и хранилище. Архивация виртуальных машин может выполняться только в одном хранилище.

     ![Область "Выбор виртуальных машин"](./media/backup-azure-arm-vms-prepare/select-vms-to-backup.png)

5. В разделе **Архивация** выберите **Включить резервное копирование**.

   - При этом в хранилище и на виртуальных машинах развертывается политика и устанавливается расширение архивации на агенте ВМ на виртуальной машине Azure.
   - На этом шаге не создается начальная точка восстановления для виртуальной машины.

     ![Кнопка "Включить резервное копирование"](./media/backup-azure-arm-vms-prepare/vm-validated-click-enable.png)

После включения резервного копирования

- Начальное резервное копирование запускается в соответствии с расписанием резервного копирования.
- Расширение резервного копирования устанавливается службой Azure Backup независимо от того, запущена ли виртуальная машина.
    - На запущенной виртуальной машине проще получить точку восстановления, согласованную с приложениями.
    -  Тем не менее резервное копирование виртуальной машины выполняется даже в том случае, если она выключена и нельзя установить расширение. Он называется автономной виртуальной Машиной. В этом случае будет отказоустойчивой точки восстановления. [Дополнительные сведения]() Обратите внимание, что Azure Backup не поддерживает часов автоматической коррекции для летнего изменения для архивации виртуальных Машин Azure. Измените политики резервного копирования вручную при необходимости.

## <a name="run-the-initial-backup"></a>Выполнение начального резервного копирования

Начальное резервное копирование будет выполняться в соответствии с расписанием, если вы не запустите его немедленно вручную. Запустите его вручную следующим образом:

1. В меню хранилища щелкните **Элементы архивации**.
2. На плитке **Элементы архивации** щелкните **Виртуальная машина Azure**.
3. В списке **Элементы архивации** щелкните многоточие **...**.
4. Щелкните **Создать резервную копию**.
5. В окне **Создать резервную копию** используйте элементы управления "Календарь", чтобы выбрать последний день, до которого точка восстановления должна храниться, а затем щелкните **ОК**.
6. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения задания на панели мониторинга хранилища в разделе **Задания резервного копирования** > **Выполняется**. В зависимости от размера виртуальной машины создание начального архива может занять некоторое время.



## <a name="next-steps"></a>Дальнейшие действия

- Устраните все проблемы с [агентов виртуальных Машин Azure](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md) или [резервного копирования виртуальных Машин Azure](backup-azure-vms-troubleshoot.md).
- [Восстановление](backup-azure-arm-restore-vms.md) виртуальные машины Azure.

