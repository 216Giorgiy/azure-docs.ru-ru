<properties
	pageTitle="Резервное копирование виртуальной машины Azure — резервное копирование | Microsoft Azure"
	description="Узнайте, как создать резервную копию виртуальной машины Azure после регистрации"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags ms.service="backup" ms.workload="storage-backup-recovery" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="hero-article" ms.date="07/30/2015" ms.author="aashishr"; "jimpark"/>


# Резервное копирование виртуальных машин Azure
Эта статья представляет собой базовое руководство по резервному копированию виртуальных машин Azure. Перед тем как продолжить, убедитесь в выполнении всех [необходимых условий](backup-azure-vms-introduction.md#prerequisites).

Резервное копирование виртуальных машин Azure состоит из трех основных шагов.

![Три шага для резервного копирования виртуальной машины Azure](./media/backup-azure-vms/3-steps-for-backup.png)

## 1\. Обнаружение виртуальных машин Azure
В ходе процесса обнаружения в Azure запрашивается список виртуальных машин в подписке, а также дополнительные сведения, например, имя облачной службы и регион.

> [AZURE.NOTE]Процесс обнаружения всегда должен выполняться на первом шаге. Это гарантирует идентификацию всех новых виртуальных машин, добавленных в подписку.

### Запуск процесса обнаружения

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.

2. В раскрывающемся меню для типа рабочей нагрузки выберите значение **Виртуальная машина Azure** и нажмите кнопку **Выбрать**.

    ![выбор рабочей нагрузки](./media/backup-azure-vms/discovery-select-workload.png)

3. Нажмите кнопку **ОБНАРУЖИТЬ** в нижней части страницы. ![кнопка обнаружения](./media/backup-azure-vms/discover-button-only.png)

4. Процесс обнаружения может занять несколько минут, в это время виртуальные машины будут заноситься в таблицу. Во время процесса обнаружения в нижней части экрана отображается всплывающее уведомление.

    ![обнаружение виртуальных машин](./media/backup-azure-vms/discovering-vms.png)

5. После завершения процесса обнаружения появляется всплывающее уведомление.

    ![обнаружение выполнено](./media/backup-azure-vms/discovery-complete.png)

##  2\. Регистрация виртуальных машин Azure
Чтобы защитить виртуальную машину, ее необходимо предварительно зарегистрировать в службе архивации Azure. Процесс регистрации преследует две главные цели:

1. подключение расширения резервного копирования к агенту ВМ в виртуальной машине;

2. Связывание виртуальной машины со службой архивации Azure.

Регистрация обычно выполняется однократно. Служба резервного копирования Azure легко обрабатывает обновления и исправления расширения резервного копирования без необходимости трудоемкого вмешательства пользователя. Это освобождает пользователя от расходов по управлению агентом, которые обыкновенно сопровождают продукты для резервного копирования.

### Регистрация виртуальных машин

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.

2. В раскрывающемся меню для типа рабочей нагрузки выберите значение **Виртуальная машина Azure** и нажмите кнопку «Выбрать».

    ![выбор рабочей нагрузки](./media/backup-azure-vms/discovery-select-workload.png)

3. Нажмите кнопку **ЗАРЕГИСТРИРОВАТЬ** в нижней части страницы. ![кнопка регистрации](./media/backup-azure-vms/register-button-only.png)

4. Во всплывающем окне **Регистрация элементов** выберите виртуальные машины, которые необходимо зарегистрировать. При наличии двух или нескольких виртуальных машин с одинаковым именем используйте облачную службу, чтобы их различать.

    Операция **регистрации** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно сокращает однократные усилия, которые затрачиваются на подготовку виртуальных машин для резервного копирования.

    >[AZURE.NOTE]Будут отображаться только незарегистрированные виртуальные машины, которые находятся в одном регионе с хранилищем службы архивации.

5. Задание создается для каждой виртуальной машины, которую необходимо зарегистрировать. Всплывающее уведомление отображает состояние этого действия. Щелкните **Просмотр задания**, чтобы перейти на страницу **Задания**.

    ![задание регистрации](./media/backup-azure-vms/register-create-job.png)

6. Виртуальная машина появляется также в списке зарегистрированных элементов, и отображается состояние операции регистрации.

    ![Состояние регистрации 1](./media/backup-azure-vms/register-status01.png)

7. После завершения операции состояние на портале изменяется, чтобы отразить зарегистрированное состояние.

    ![Состояние регистрации 2](./media/backup-azure-vms/register-status02.png)

## 3\. Защита: резервное копирование виртуальных машин Azure
Этот шаг включает в себя настройку политики резервного копирования и хранения для виртуальной машины. Чтобы защитить виртуальную машину, выполните следующие действия.

### Резервное копирование виртуальных машин Azure
1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.
2. В раскрывающемся меню для типа рабочей нагрузки выберите значение **Виртуальная машина Azure** и нажмите кнопку **Выбрать**.

    ![Выберите рабочую нагрузку на портале](./media/backup-azure-vms/select-workload.png)

3. Нажмите кнопку **ЗАЩИТИТЬ** в нижней части страницы.

4. Появится мастер **защиты элементов**, где можно выбрать виртуальные машины, которые необходимо защитить. При наличии двух или нескольких виртуальных машин с одинаковым именем используйте облачную службу, чтобы их различать.

    Операция **защиты** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно уменьшает усилия, затраченные на защиту виртуальных машин.

    >[AZURE.NOTE]Здесь будут отображаться только виртуальные машины, которые были правильно зарегистрированы в службе резервного копирования Azure и находятся в одном регионе с резервным хранилищем.

5. На втором экране мастера **защиты элементов** выберите политику резервного копирования и хранения для резервного копирования выбранных виртуальных машин. Выберите политику из существующего набора или создайте новую.

    >[AZURE.NOTE]В предварительной версии поддерживается хранение в течение 30 дней и максимум одно резервное копирование в день.

    В каждом резервном хранилище можно иметь несколько политик резервного копирования. Политики отражают сведения о том, как должно планироваться выполнение резервных копий и обеспечиваться их сохранение. Например, одна политика резервного копирования может использоваться для ежедневного резервного копирования в 10:00 вечера, в то время как другая политика может обеспечивать еженедельное резервное копирование в 6:00 утра. Несколько политик резервного копирования обеспечивают гибкость при планировании создания резервных копий для инфраструктуры виртуальных машин.

    Каждая политика резервного копирования может иметь несколько связанных с ней виртуальных машин. В каждый данный момент времени виртуальная машина может быть связана только с одной политикой.

6. Чтобы настроить политику защиты и связать виртуальные машины с этой политикой, для каждой виртуальной машины создается задание. Щелкните вкладку **Задания** и выберите необходимый фильтр для просмотра списка заданий типа **Настройка защиты**.

    ![Настройка задания защиты](./media/backup-azure-vms/protect-configureprotection.png)

7. После завершения операции виртуальные машины защищены с помощью политики и должны ожидать запланированное время резервного копирования для создания начальной резервной копии. Виртуальная машина теперь появится в списке на вкладке **Защищенные элементы** и будет иметь состояние защиты со значением *защищена* (ожидание начальной резервной копии).
    >[AZURE.NOTE]Параметр запуска начального резервного копирования сразу после настройки защиты в настоящее время недоступен.

8. В запланированное время служба резервного копирования Azure создает задание резервного копирования для каждой виртуальной машины, для которой необходимо создать резервную копию. Щелкните вкладку **Задания**, чтобы просмотреть список заданий **резервного копирования**. В качестве части операции резервного копирования служба резервного копирования Azure выдает команду расширению резервного копирования в каждой виртуальной машине, которая сохраняет на диск все данные операций записи и делает согласованный моментальный снимок.

    ![Выполняется резервное копирование](./media/backup-azure-vms/protect-inprogress.png)

9. После завершения операции состояние защиты виртуальной машины на вкладке **Защищенные элементы** отображается как *Защищена*.

    ![Резервное копирование виртуальной машины с точкой восстановления](./media/backup-azure-vms/protect-backedupvm.png)

## Просмотр состояния резервного копирования и подробностей
После обеспечения защиты число виртуальных машин также увеличивается на странице сводки **Панели мониторинга**. Кроме того, на странице панели мониторинга отображается количество успешных, завершившихся сбоем и все еще выполняемых заданий за последние 24 часа. Щелчок любой из категорий позволяет получить детальные сведения о ней на странице **Задания**.

![Состояние резервного копирования на странице панели мониторинга](./media/backup-azure-vms/dashboard-protectedvms.png)

## Устранение ошибок
Для устранения ошибок, обнаруженных в ходе применения службы архивации Azure, можно использовать информацию из следующей таблицы.

| Операция резервного копирования | Сведения об ошибке | Возможное решение |
| -------- | -------- | -------|
| Обнаружение | Не удалось обнаружить новые элементы — в службе резервного копирования Microsoft Azure произошла внутренняя ошибка. Подождите несколько минут и повторите попытку. | Повторите процесс обнаружения через 15 минут.
| Обнаружение | Не удалось обнаружить новые элементы — уже выполняется другая операция обнаружения. Дождитесь завершения текущей операции обнаружения. | None |
| Зарегистрировать | Роль ВМ Azure не находится в состоянии для установки расширения — убедитесь, что виртуальная машина находится в состоянии выполнения. Расширение служб восстановления Azure требует, чтобы виртуальная машина работала. | Запустите виртуальную машину и после ее перехода в состояние выполнения повторите попытку регистрации.|
| Зарегистрировать | Количество дисков с данными, подключенных к виртуальной машине, превышает поддерживаемый лимит. Отключите некоторые диски с данными и повторите операцию. Служба архивации Azure поддерживает до 5 дисков с данными, подключенных к виртуальной машине Azure для архивации. | None |
| Зарегистрировать | Произошла внутренняя ошибка службы архивации Microsoft Azure. Подождите несколько минут и снова запустите операцию. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. | Эта ошибка может происходить, если применяется одна из следующих неподдерживаемых конфигураций: <ol><li>Локально-избыточное хранилище класса Premium. <li>Несколько сетевых карт. <li>Подсистема балансировки нагрузки. </ol> |
| Зарегистрировать | Не удалось найти сертификат гостевого агента виртуальной машины | Для устранения этой ошибки выполните следующие действия: <ol><li>Скачайте последнюю версию агента виртуальной машины [отсюда](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Убедитесь, что версия скачанного агента — 2.6.1198.718 или выше. <li>Установите агент ВМ на виртуальной машине.</ol> [Подробнее](#validating-vm-agent-installation) о проверке версии агента ВМ. |
| Зарегистрировать | Не удалось выполнить регистрацию из-за истечения времени ожидания для операции установки агента | Проверьте, поддерживается ли версия ОС виртуальной машины. |
| Зарегистрировать | Не удалось выполнить команду. С этим элементом выполняется другая операция, дождитесь ее завершения. Дождитесь завершения предыдущей операции. | None |
| Архивация | Время ожидания копирования виртуальных жестких дисков из архивного хранилища истекло. Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. | Это происходит, если имеется слишком много данных для копирования. Убедитесь, что у вас меньше 6 дисков данных. |
| Архивация | Истекло время ожидания подзадачи моментального снимка виртуальной машины. Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт | Данная ошибка возникает, если существует проблема с агентом виртуальной машины, или каким-то образом заблокирован сетевой доступ к инфраструктуре Azure. <ul><li>Дополнительные сведения об [устранении проблем с агентом виртуальной машины](#Troubleshooting-vm-agent-related-issues) <li>Дополнительные сведения об [устранении сетевых проблем](#troubleshooting-networking-issues) </ul> |
| Архивация | Произошла внутренняя ошибка архивации. Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт | Эта ошибка может возникнуть по двум причинам: <ol><li> Имеется слишком много данных для копирования. Убедитесь, что у вас меньше 6 дисков данных. <li>Исходная виртуальная машина удалена, поэтому, резервное копирование не может быть выполнено. Чтобы сохранить данные резервных копий для удаленной виртуальной машины, но прекратить появление ошибок при резервном копировании, снимите защиту с виртуальной машины и выберите вариант, при котором данные сохраняются. В результате резервное копирование будет остановлено, и перестанут появляться сообщения об ошибках. |
| Архивация | Не удалось установить расширение служб восстановления Azure для выбранного элемента. Необходимым условием для расширения служб восстановления Azure является наличие агента виртуальной машины. Установите агент виртуальной машины Azure и перезапустите операцию регистрации. | <ol> <li>Убедитесь, что агент виртуальной машины установлен правильно. <li>Убедитесь, что флаг в конфигурации виртуальной машины имеет правильное значение.</ol> [Дополнительные сведения](#validating-vm-agent-installation) об установке агента виртуальной машины и проверке установки агента виртуальной машины. |
| Архивация | Не удалось выполнить команду. С этим элементом выполняется другая операция. Дождитесь завершения предыдущей операции и повторите попытку. | Выполняется текущее задание резервного копирования или восстановления для виртуальной машины. В это время запуск нового задания невозможен. <br><br>Если вы хотите иметь возможность отмены текущего задания, добавьте свой голос на [форуме отзывов по Azure](http://feedback.azure.com/forums/258995-azure-backup-and-scdpm/suggestions/7941501-add-feature-to-allow-cancellation-of-backup-restor). |

### Устранение проблем, связанных с агентом виртуальной машины

#### Настройка агента виртуальной машины
Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом. Подробности об [установке агента ВМ на существующей виртуальной машине](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).

Для виртуальных машин Windows:

- Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
- [Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен.


#### Обновление агента виртуальной машины
Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Тем не менее, необходимо убедиться, что во время обновления агента виртуальной машины никакие операции резервного копирования не выполняются.


#### Проверка установки агента виртуальной машины
Для проверки версии агента ВМ на виртуальных машинах Windows выполните следующие действия:

1. Войдите в виртуальную машину Azure и перейдите в папку *C:\\WindowsAzure\\Packages*. В ней должен находиться файл WaAppAgent.exe.
2. Щелкните правой кнопкой мыши этот файл, откройте **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше.

### Устранение сетевых проблем
Как и в случае со всеми другими расширениями, для нормальной работы расширению резервного копирования требуется доступ к общедоступному Интернету. Отсутствие доступа к общедоступному Интернету может приводить к различным проблемам:

- Операция установки расширения может завершаться с ошибкой.
- Операции резервного копирования (например, создание моментального снимка диска) могут завершаться с ошибкой.
- Операция отображения состояния процесса резервного копирования может завершаться с ошибкой.

Потребность в разрешении общедоступных IP-адресов более подробно разъяснена [здесь](http://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). Вам будет нужно проверить конфигурации DNS для виртуальной сети и убедиться, что URL-адреса Azure можно разрешить.

После правильного разрешения имен также требуется предоставить доступ к IP-адресам Azure. Чтобы разблокировать доступ к инфраструктуре Azure, выполните следующие действия.

1. Получите список [IP-адресов центра обработки данных Azure ](https://msdn.microsoft.com/library/azure/dn175718.aspx) для добавления в разрешенный список.
2. Разблокируйте IP-адреса с помощью командлета [New-NetRoute](https://technet.microsoft.com/library/hh826148.aspx). Запустите этот командлет на ВМ Azure в окне PowerShell с повышенными привилегиями (запустите от имени администратора).


## Целостность данных в точках восстановления
При работе с данными резервных копий клиентов беспокоит поведение виртуальной машины после ее восстановления. Ниже приведены типичные вопросы, которые задают клиенты.

- Будет ли виртуальная машина загружаться?
- Будут ли данные доступны на диске? Какие-либо данные потеряны?
- Сможет ли приложение считывать данные? Какие-либо данные повреждены?
- Будут ли данные иметь смысл для приложения? Будут ли данные являться согласованными при чтении их приложением?

В следующей таблице описываются типы целостности и согласованности данных, встречающиеся во время резервного копирования и восстановления ВМ Azure:

| Целостность | На базе службы VSS | Подробное объяснение |
|-------------|-----------|---------|
| Целостность на уровне приложения | Да | Это идеальное место для рабочих нагрузок Майкрософт, которое гарантирует следующее:<ol><li> ВМ *загружается*; <li>нет *повреждений данных*; <li>нет *потери данных*; <li> данные являются согласованными с приложением, которое их использует, за счет привлечения приложения к выполнению резервного копирования — использование VSS.</ol> Служба снимков тома (VSS) обеспечивает правильную запись данных в хранилище. Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных. Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных.<br><br> Для резервного копирования виртуальных машин Azure получение точки восстановления с согласованными данными означает, что расширение резервного копирования имело возможность вызвать рабочий процесс VSS и *корректно* завершить его до выполнения моментального снимка ВМ. Естественно, это означает, что модули записи VSS всех приложений на виртуальной машине Azure были также вызваны.<br><br>Познакомьтесь с [основами службы VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx), подробно изучите [принцип ее работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx). |
| Целостность на уровне файловой системы | Да, для компьютеров Windows | Существует два сценария, в которых целостность данных в точке восстановления может зависеть от файловой системы.<ul><li>Резервное копирование виртуальных машин Linux в Azure, поскольку Linux не имеет аналогичной платформы для VSS.<li>Сбой службы VSS во время резервного копирования для виртуальных машин Windows в Azure.</li></ul> В обоих этих случаях лучшее, что можно сделать, — это обеспечить следующее: <ol><li> ВМ *загружается*; <li>нет *повреждений данных*; <li>нет *потери данных*.</ol> Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных.|
| Отказоустойчивость | Нет | Такая ситуация аналогична сбою компьютера (приводит к программной или аппаратной перезагрузке). Обычно это происходит при выключении виртуальной машины Azure во время резервного копирования. Для резервного копирования виртуальной машины Azure получение точки восстановления на момент аварийного завершения означает, что служба архивации Azure не дает никаких гарантий в отношении согласованности данных на носителе (даже с позиции операционной системы или с позиции приложения). Во время резервного копирования выполняется архивация только тех данных, которые уже существуют на диске. <br/> <br/> Несмотря на отсутствие гарантий, в большинстве случаев операционная система загружается нормально. Обычно загрузка сопровождается процедурой проверки диска (например chkdsk), предназначенной для устранения ошибок, связанных с его повреждением. Будут потеряны все данные, которые не были записаны на диск. В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки. В контексте резервного копирования виртуальной машины Azure отказоустойчивая точка восстановления означает, что служба резервного копирования Azure не предоставляет никаких гарантий в отношении целостности и согласованности данных в хранилище — ни с точки зрения операционной системы, ни с точки зрения приложения. Обычно это происходит при завершении работы виртуальной машины Azure во время резервного копирования.<br><br>Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до согласованных данных. При работе с данными, которые распределены между несколькими виртуальными дисками (например, составные тома), отказоустойчивые точки восстановления не гарантируют правильность данных.|

## Дальнейшие действия
Дополнительные сведения о начале работы с резервным копированием Azure см. в разделе:

- [Восстановление виртуальных машин](backup-azure-restore-vms.md)
- [Управление виртуальными машинами](backup-azure-manage-vms.md)

<!---HONumber=August15_HO6-->