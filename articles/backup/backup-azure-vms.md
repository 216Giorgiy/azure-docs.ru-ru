<properties
	pageTitle="Резервное копирование виртуальной машины Azure — резервное копирование | Microsoft Azure"
	description="Узнайте, как создать резервную копию виртуальной машины Azure после регистрации"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags ms.service="backup" ms.workload="storage-backup-recovery" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="hero-article" ms.date="09/09/2015" ms.author="aashishr"; "jimpark"/>


# Резервное копирование виртуальных машин Azure
Эта статья представляет собой базовое руководство по резервному копированию виртуальных машин Azure. Перед тем как продолжить, убедитесь в выполнении всех [необходимых условий](backup-azure-vms-introduction.md#prerequisites).

Резервное копирование виртуальных машин Azure состоит из трех основных шагов.

![Три шага для резервного копирования виртуальной машины Azure](./media/backup-azure-vms/3-steps-for-backup.png)

>[AZURE.NOTE]Резервное копирование виртуальных машин выполняется локально. В хранилище службы архивации из указанного региона Azure нельзя добавлять резервные копии виртуальных машин из другого региона Azure. Таким образом, для каждого региона Azure с виртуальными машинами, для которых требуется резервное копирование, необходимо создать как минимум одно хранилище службы архивации в этом регионе.

## 1\. Обнаружение виртуальных машин Azure
В ходе процесса обнаружения в Azure запрашивается список виртуальных машин в подписке, а также дополнительные сведения, например, имя облачной службы и регион. Процесс обнаружения всегда должен выполняться на первом шаге. Это гарантирует идентификацию всех новых виртуальных машин, добавленных в подписку.

### Запуск процесса обнаружения

1. Перейдите в хранилище архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.

2. В раскрывающемся меню для типа рабочей нагрузки выберите значение **Виртуальная машина Azure** и нажмите кнопку **Выбрать**.

    ![выбор рабочей нагрузки](./media/backup-azure-vms/discovery-select-workload.png)

3. Нажмите кнопку **ОБНАРУЖИТЬ** в нижней части страницы. ![кнопка обнаружения](./media/backup-azure-vms/discover-button-only.png)

4. Процесс обнаружения может занять несколько минут, в это время виртуальные машины будут заноситься в таблицу. Во время процесса обнаружения в нижней части экрана отображается всплывающее уведомление.

    ![обнаружение виртуальных машин](./media/backup-azure-vms/discovering-vms.png)

5. После завершения процесса обнаружения появляется всплывающее уведомление.

    ![обнаружение выполнено](./media/backup-azure-vms/discovery-complete.png)

##  2\. Регистрация виртуальных машин Azure
Чтобы защитить виртуальную машину, ее необходимо предварительно зарегистрировать в службе архивации Azure. Основная цель процесса регистрации — связать виртуальную машину со службой архивации Azure. Регистрация обычно выполняется однократно.

>[AZURE.NOTE]Расширение для резервного копирования не устанавливается на этапе регистрации. Установка и обновление агента резервного копирования теперь является частью запланированного задания резервного копирования.

### Регистрация виртуальных машин

1. Перейдите в хранилище службы архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.

2. В раскрывающемся меню для типа рабочей нагрузки выберите значение **Виртуальная машина Azure** и нажмите кнопку «Выбрать».

    ![выбор рабочей нагрузки](./media/backup-azure-vms/discovery-select-workload.png)

3. Нажмите кнопку **ЗАРЕГИСТРИРОВАТЬ** в нижней части страницы.

    ![кнопка регистрации](./media/backup-azure-vms/register-button-only.png)

4. В контекстном меню **Регистрация элементов** выберите виртуальные машины, которые нужно зарегистрировать. При наличии двух или нескольких виртуальных машин с одинаковым именем используйте облачную службу, чтобы их различать.

    Операция **регистрации** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно сокращает однократные усилия, которые затрачиваются на подготовку виртуальных машин для резервного копирования.

5. Задание создается для каждой виртуальной машины, которую необходимо зарегистрировать. Всплывающее уведомление отображает состояние этого действия. Щелкните **Просмотреть задание**, чтобы перейти на страницу **Задания**.

    ![задание регистрации](./media/backup-azure-vms/register-create-job.png)

6. Виртуальная машина появляется также в списке зарегистрированных элементов, и отображается состояние операции регистрации.

    ![Состояние регистрации 1](./media/backup-azure-vms/register-status01.png)

7. После завершения операции состояние на портале изменяется, чтобы отразить зарегистрированное состояние.

    ![Состояние регистрации 2](./media/backup-azure-vms/register-status02.png)

## 3\. Защита: резервное копирование виртуальных машин Azure
Этот шаг включает в себя настройку политики резервного копирования и хранения для виртуальной машины. Несколько виртуальных машин можно защитить на требуемом уровне с помощью одного действия защиты.

>[AZURE.NOTE]У хранилищ службы архивации Azure, созданных после мая 2015 г., есть встроенная политика по умолчанию. Эта политика задает стандартный срок хранения на 30 дней и расписание ежедневного резервного копирования.

Чтобы защитить виртуальную машину, выполните следующие действия.

1. Перейдите в хранилище службы архивации, которое можно найти в разделе **Службы восстановления** на портале Azure, а затем откройте вкладку **Зарегистрированные элементы**.
2. В раскрывающемся меню с типами рабочей нагрузки выберите значение **Виртуальная машина Azure** и нажмите кнопку **Выбрать**.

    ![Выберите рабочую нагрузку на портале](./media/backup-azure-vms/select-workload.png)

3. В нижней части страницы щелкните **ЗАЩИТИТЬ**. Откроется мастер **защиты элементов**. В этом мастере перечислены только те виртуальные машины, которые зарегистрированы и не защищены.

4. В мастере **защиты элементов** можно выбирать виртуальные машины, которые необходимо защитить. При наличии двух или нескольких виртуальных машин с одинаковым именем используйте облачную службу, чтобы их различать.

    Операция **защиты** может быть выполнена массово, что позволяет одновременно выбрать несколько виртуальных машин для регистрации. Это существенно уменьшает усилия, затраченные на защиту виртуальных машин.

    ![Настройка защиты нужного уровня](./media/backup-azure-vms/protect-at-scale.png)

5. На втором экране мастера **защиты элементов** выберите расписание резервного копирования для выбранных виртуальных машин. Выберите политику из существующего набора или создайте новую.

    В каждом резервном хранилище можно иметь несколько политик резервного копирования. Политики отражают сведения о том, как должно планироваться выполнение резервных копий и обеспечиваться их сохранение. Например, одна политика резервного копирования может использоваться для ежедневного резервного копирования в 22:00, а другая — для еженедельного резервного копирования каждую субботу в 06:00. Несколько политик резервного копирования обеспечивают гибкость при планировании создания резервных копий для инфраструктуры виртуальных машин.

    Каждая политика резервного копирования может иметь несколько связанных с ней виртуальных машин. В каждый данный момент времени виртуальная машина может быть связана только с одной политикой.

    ![Защита с помощью новой политики](./media/backup-azure-vms/policy-schedule.png)

6. На третьем экране мастера **защиты элементов** выберите диапазон хранения для созданных резервных копий. Этот экран поддерживает трехуровневую схему хранения GFS, являющуюся отраслевым стандартом. Дополнительные сведения о [долгосрочном хранении](backup-azure-vms-introduction.md#Long term retention).

    Политика резервного копирования также включает схему хранения плановых резервных копий. Если на предыдущем экране выбрана существующая политика резервного копирования, изменить схему хранения будет невозможно. Будет использоваться политика хранения резервных копий, определенная в политике резервного копирования.

    ![Защита с помощью гибких возможностей хранения](./media/backup-azure-vms/policy-retention.png)

7. Чтобы настроить политику защиты и связать виртуальные машины с этой политикой, для каждой виртуальной машины создается задание. Щелкните вкладку **Задания** и выберите нужный фильтр, чтобы просмотреть список заданий **Настройка защиты**.

    ![Настройка задания защиты](./media/backup-azure-vms/protect-configureprotection.png)


## Действия после настройки защиты

### Установка расширения резервного копирования
Служба резервного копирования Azure легко обрабатывает обновления и исправления расширения резервного копирования без необходимости трудоемкого вмешательства пользователя. Это избавляет пользователя от необходимости управлять агентом, что является обычной практикой при работе с продуктами для резервного копирования.

#### Автономные виртуальные машины
Расширение резервного копирования устанавливается, если виртуальная машина запущена. Кроме того, на запущенной виртуальной машине проще всего получить точку восстановления, согласованную с приложениями. Тем не менее служба архивации Azure будет продолжать резервное копирование виртуальной машины, даже если она выключена и установить расширение невозможно (автономная виртуальная машина). От этого зависит согласованность — в этом случае точка восстановления будет *отказоустойчивой*.

### Начальное резервное копирование
Виртуальная машина, защищенная политикой, появится на вкладке **Защищенные элементы** со статусом *Защищено (в ожидании начального резервного копирования)*. По умолчанию начальным резервным копированием является первое запланированное резервное копирование. Чтобы запустить начальное резервное копирование сразу после настройки защиты, нажмите кнопку **Создать резервную копию** внизу страницы **Защищенные элементы**.

Служба архивации Azure создаст задание резервного копирования для операции начального резервного копирования. Чтобы просмотреть список заданий, щелкните вкладку **Задания**. В ходе резервного копирования служба архивации Azure дает команду расширению для резервного копирования на каждой виртуальной машине сохранять на диск все данные операций записи и делать согласованный моментальный снимок.

![Выполняется резервное копирование](./media/backup-azure-vms/protect-inprogress.png)

Когда начальное резервное копирование будет завершено, для параметра *Состояние защиты виртуальной машины* на вкладке **Защищенные элементы** отобразится значение *Защищено*.

![Резервное копирование виртуальной машины с точкой восстановления](./media/backup-azure-vms/protect-backedupvm.png)

### Просмотр состояния резервного копирования и подробностей
После обеспечения защиты число виртуальных машин также увеличивается на странице сводки **Панели мониторинга**. Кроме того, на странице **панели мониторинга** отображается количество успешных, завершившихся сбоем и все еще выполняющихся заданий за последние 24 часа. Щелкнув любую из категорий, можно получить подробные сведения о ней на странице **Задания**.

![Состояние резервного копирования на странице панели мониторинга](./media/backup-azure-vms/dashboard-protectedvms.png)

### Долгосрочное хранение
Политика хранения определяет время, в течение которого должна храниться резервная копия. Вместо одной политики хранения для всех точек резервного копирования пользователи могут настроить разные политики хранения в зависимости от времени создания резервной копии. Например, для точки резервного копирования, которая создается в конце каждого квартала, может потребоваться более длительный срок хранения с целью проведения аудита, а точку резервного копирования, создаваемую ежедневно (для оперативного восстановления), необходимо хранить 90 дней.

1. **Политика хранения ежедневных резервных копий**. Резервные копии, создаваемые ежедневно, хранятся в течение 30 дней.
2. **Политика хранения еженедельных резервных копий**. Резервные копии, создаваемые каждое воскресенье, хранятся в течение 104 недель.
3. **Политика хранения ежемесячных резервных копий**. Резервные копии, создаваемые в последнее воскресенье каждого месяца, хранятся в течение 120 месяцев.
4. **Политика хранения ежегодных резервных копий**. Резервные копии, создаваемые каждый год в первое воскресенье января, хранятся в течение 99 лет.

## Целостность данных в точках восстановления
При работе с данными резервных копий клиентов беспокоит поведение виртуальной машины после ее восстановления. Ниже приведены типичные вопросы, которые задают клиенты.

- Будет ли виртуальная машина загружаться?
- Будут ли данные доступны на диске? Какие-либо данные потеряны?
- Сможет ли приложение считывать данные? Какие-либо данные повреждены?
- Будут ли данные иметь смысл для приложения? Будут ли данные являться согласованными при чтении их приложением?

В следующей таблице описываются типы целостности и согласованности данных, встречающиеся во время резервного копирования и восстановления виртуальной машины Azure:

| Целостность | На основе VSS | Подробное объяснение |
|-------------|-----------|---------|
| Целостность на уровне приложения | Да | Идеально подходит для рабочих нагрузок Майкрософт, так как гарантирует следующее:<ol><li> Виртуальная машина *загружается*. <li>Нет *поврежденных данных*. <li>Нет *потерянных данных*.<li> Данные согласованы с приложением, которое их использует, за счет привлечения приложения во время резервного копирования (с помощью VSS).</ol> Служба снимков тома (VSS) обеспечивает правильную запись данных в хранилище. Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных. Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных.<br><br> Для резервного копирования виртуальных машин Azure получение точки восстановления с согласованными данными означает, что расширение резервного копирования имело возможность вызвать рабочий процесс VSS и *корректно* завершить его до выполнения моментального снимка ВМ. Естественно, это означает, что модули записи VSS всех приложений на виртуальной машине Azure были также вызваны.<br><br>Познакомьтесь с [основами службы VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx), подробно изучите [принцип ее работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx). |
| Целостность на уровне файловой системы | Да, для компьютеров Windows | Существует два сценария, в которых целостность данных в точке восстановления может зависеть от файловой системы.<ul><li>Резервное копирование виртуальных машин Linux в Azure, поскольку Linux не имеет аналогичной платформы для VSS.<li>Сбой службы VSS во время резервного копирования для виртуальных машин Windows в Azure.</li></ul> В обоих этих случаях лучшее, что можно сделать, — обеспечить следующее: <ol><li> Виртуальная машина *загружается*. <li>Нет *поврежденных данных*.<li>Нет *потерянных данных*.</ol> Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных.|
| Отказоустойчивость | Нет | Такая ситуация аналогична сбою компьютера (приводит к программной или аппаратной перезагрузке). Обычно это происходит при выключении виртуальной машины Azure во время резервного копирования. Для резервного копирования виртуальной машины Azure получение точки восстановления на момент аварийного завершения означает, что служба архивации Azure не дает никаких гарантий в отношении согласованности данных на носителе (даже с позиции операционной системы или с позиции приложения). Во время резервного копирования выполняется архивация только тех данных, которые уже существуют на диске. <br/> <br/> Даже при отсутствии гарантий в большинстве случаев операционная система загружается нормально. Обычно загрузка сопровождается процедурой проверки диска (например chkdsk), предназначенной для устранения ошибок, связанных с его повреждением. Будут потеряны все данные, которые не были записаны на диск. В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки. В контексте резервного копирования виртуальной машины Azure отказоустойчивая точка восстановления означает, что служба резервного копирования Azure не предоставляет никаких гарантий в отношении целостности и согласованности данных в хранилище — ни с точки зрения операционной системы, ни с точки зрения приложения. Обычно это происходит при завершении работы виртуальной машины Azure во время резервного копирования.<br><br>Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до точки согласования данных. При работе с данными, которые распределены между несколькими виртуальными дисками (например, составные тома), отказоустойчивые точки восстановления не гарантируют правильность данных.|


## Производительность и использование ресурсов
Подобно ПО для резервного копирования, развертываемому локально, резервное копирование виртуальных машин в Azure также необходимо запланировать для использования емкости и ресурсов. [Ограничения службы хранилища Azure](azure-subscription-service-limits.md#storage-limits) определяют структуру развертывания виртуальных машин, обеспечивая максимальную производительность и минимальное влияние на выполнение операций. Существует два основных ограничения хранилища Azure, влияющих на производительность резервного копирования.

- Максимальный объем исходящих данных на учетную запись хранения.
- Общая частота запросов на учетную запись хранения.

При копировании резервных данных из пользовательской учетной записи хранения учитывается число операций ввода-вывода в секунду и метрики исходящих данных (пропускная способность хранилища) учетной записи хранения. В то же время виртуальные машины также работают, используя операции ввода-вывода и пропускную способность. Цель заключается в том, чтобы общий объем трафика (резервного копирования и виртуальной машины) не превышал ограничения учетной записи хранения.

Резервная копия использует максимально возможное количество ресурсов для максимально быстрого завершения резервного копирования. Тем не менее все операции ввода-вывода ограничены *целевой пропускной способностью для одного большого двоичного объекта*, предельное значение которой составляет *60 МБ в секунду*. Чтобы ускорить процесс резервного копирования, выполняется попытка *параллельного* резервного копирования каждого диска виртуальной машины. Например, если у виртуальной машины 4 жестких диска, служба архивации Azure будет пытаться создать резервную копию всех 4 дисков параллельно. Таким образом, единственным важным фактором, определяющим трафик резервного копирования, исходящий из пользовательской учетной записи хранения, является **количество дисков**, для которых в учетной записи хранения создаются резервные копии.

Дополнительный фактор, который влияет на производительность, — **расписание резервного копирования**. Если настроить одновременное резервное копирование всех виртуальных машин, количество дисков, копируемых *параллельно*, увеличится, так как служба архивации Azure будет пытаться выполнить резервное копирование максимально возможного количества дисков. Поэтому, чтобы уменьшить трафик резервного копирования из учетной записи хранения, рекомендуем запланировать резервное копирование разных виртуальных машин в разное время дня, а не параллельно.

### Планирование загрузки
Если сложить все эти факторы, становится очевидно, что использование учетной записи хранения необходимо планировать должным образом. Загрузите [лист Excel по планированию емкости хранилища при резервном копировании виртуальных машин](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33), чтобы оценить влияние выбранного количества дисков и расписания резервного копирования.

### Пропускная способность при резервном копировании
Для каждого диска, для которого создается резервная копия, служба архивации Azure считывает блоки на диске и сохраняет только измененные данные (добавочное резервное копирование). В таблице ниже показаны ожидаемые средние значения пропускной способности службы архивации Azure:

| Операция резервного копирования | Пропускная способность в лучшем случае |
| ---------------- | ---------- |
| Начальное резервное копирование | 160 Мбит/с |
| Добавочное резервное копирование (аварийное восстановление) | 640 Мбит/с <br><br> Эта пропускная способность может существенно снизиться, если на диске много разрозненных данных, которые необходимо включить в резервную копию. |

С помощью этой таблицы вы можете рассчитать время, необходимое для резервного копирования диска заданного размера.

### Общее время резервного копирования виртуальной машины
Хотя большую часть времени занимают чтение и копирование данных, существуют и другие операции, которые влияют на общее время, необходимое для резервного копирования виртуальной машины.

1. Время, затраченное на [установку или обновление расширения для резервного копирования](backup-azure-vms.md#offline-vms).
2. Время ожидания в очереди. Поскольку служба обрабатывает резервные копии от нескольких пользователей, резервное копирование может начаться не сразу. Среднее время ожидания для виртуальной машины — 15–30 минут.

## Устранение ошибок
Исчерпывающий перечень способов устранения ошибок, возникающих во время резервного копирования виртуальных машин, см. в статье:

- [Устранение неполадок во время резервного копирования виртуальных машин](backup-azure-vms-troubleshoot.md).

## Дальнейшие действия
Дополнительные сведения о начале работы с резервным копированием Azure см. в разделе:

- [Восстановление виртуальных машин](backup-azure-restore-vms.md)
- [Управление виртуальными машинами](backup-azure-manage-vms.md)

<!---HONumber=Sept15_HO2-->