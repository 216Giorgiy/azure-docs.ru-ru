<properties
	pageTitle="Резервное копирование баз данных SQL в Azure с помощью Data Protection Manager (DPM) | Microsoft Azure"
	description="Общие сведения о резервном копировании баз данных SQL с помощью службы архивации Azure"
	services="backup"
	documentationCenter=""
	authors="giridharreddy"
	manager="shreeshd"
	editor=""/>

<tags ms.service="backup" ms.workload="storage-backup-recovery" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="09/09/2015" ms.author="giridham"; "jimpark"/>


# Резервное копирование баз данных SQL в Azure с помощью Data Protection Manager (DPM)

В этой статье мы расскажем, как настроить резервное копирование базы данных SQL с помощью службы архивации Azure. Чтобы создать резервную копию базы данных SQL в Azure, необходима учетная запись Azure. Если ее нет, можно создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в разделе [Бесплатная пробная версия Azure](https://azure.microsoft.com/pricing/free-trial/).

Управление резервным копированием и восстановлением базы данных SQL в Azure состоит из трех этапов.

1. Создание политики резервного копирования для защиты баз данных SQL Server в Azure.
2. Создание резервных копий в Azure по запросу.
3. Восстановление базы данных из Azure.

## Перед началом работы
Перед началом работы выполните все [предварительные требования](../backup-azure-dpm-introduction/#prerequisites) по использованию службы архивации Microsoft Azure для защиты баз данных. Предварительные требования включают такие задачи, как создание хранилища службы архивации, загрузка учетных данных хранилища, установка агента службы архивации Azure и регистрация сервера в хранилище.

## Создание политики резервного копирования баз данных SQL в Azure

1. На сервере DPM настройте новую политику резервного копирования для баз данных SQL, создав новую **группу защиты**. Щелкните рабочую область **Защита**.

2. Щелкните **Создать**, чтобы создать новую группу защиты.

    ![Создание группы защиты](./media/backup-azure-backup-sql/protection-group.png)

3. Появится начальный экран DPM с рекомендациями по созданию **группы защиты**. Нажмите кнопку **Далее**.

4. Выберите **Серверы**.

    ![Выбор типа для группы защиты — «Серверы»](./media/backup-azure-backup-sql/pg-servers.png)

5. Разверните сервер SQL Server с базами данных SQL, для которых будут создаваться резервные копии. В окне DPM отобразятся различные источники данных, для которых на этом сервере можно создать резервные копии. Разверните пункт **Все общие ресурсы SQL** и выберите базы данных SQL для резервного копирования (в данном случае мы выбрали ReportServer$MSDPM2012 и ReportServer$MSDPM2012TempDB). Нажмите кнопку **Далее**.

    Вы увидите примерно вот такой экран:

    ![Выбор базы данных SQL](./media/backup-azure-backup-sql/pg-databases.png)

6. Введите имя создаваемой группы защиты. Обязательно установите флажок «**Мне нужна оперативная защита**».

    ![Метод защиты данных — краткосрочная на диске и оперативная в Azure](./media/backup-azure-backup-sql/pg-name.png)

7. На экране **Выбор краткосрочных целей** введите необходимые данные, чтобы создать точки резервного копирования на диске.

    Здесь мы видим, что для параметра **Диапазон хранения** выбрано значение *5 дней*, а для параметра **Частота синхронизации** — *Каждые 15 минут* (это периодичность, с которой создаются резервные копии). Для параметра **Быстрая полная архивация** задано значение *20:00*.

    ![Краткосрочные цели](./media/backup-azure-backup-sql/pg-shortterm.png)

    >[AZURE.NOTE]Каждый день в 20:00 (в соответствии с данными на экране) создается точка резервного копирования, то есть передаются данные, которые были изменены с момента предыдущего резервного копирования в 20:00. Этот процесс называется **быстрой полной архивацией**. Журналы транзакций SQL синхронизируются каждые 15 минут. Если базу данных нужно восстановить в 21:00, точка создается путем воспроизведения журналов из последней точки быстрой полной архивации (в данном случае 20:00).

8. Нажмите кнопку **Далее**.

    В DPM отобразится общий доступный объем памяти и сведения о потенциальном использовании дискового пространства.

    ![Выделение места на диске](./media/backup-azure-backup-sql/pg-storage.png)

    >[AZURE.NOTE]DPM создает один том на источник данных (база данных SQL) для создания начальной резервной копии. При таком подходе диспетчер логических дисков (LDM) ограничивает DPM, обеспечивая защиту максимум для 300 источников данных (баз данных SQL). Во избежание этого в DPM был внедрен другой подход, при котором один том используется для нескольких источников данных. Эту функцию можно включить с помощью флажка **Выравнивать данные в пуле носителей DPM**. При таком подходе DPM обеспечивает защиту для 2000 баз данных SQL.

    Если установлен флажок **Автоматически увеличивать размер томов**, DPM может увеличивать размер томов с резервными копиями по мере увеличения объема рабочих данных. Если флажок **Автоматически увеличивать размер томов** снят, объем хранилища резервных копий, используемого для резервного копирования источников данных в группе защиты, будет ограничен.

9. Администраторы могут передать начальную резервную копию либо вне сети (чтобы не перегружать полосу пропускания), либо по сети. Также они могут настроить время для передачи начальной резервной копии. Нажмите кнопку **Далее**.

    ![Метод начальной репликации](./media/backup-azure-backup-sql/pg-manual.png)

    >[AZURE.NOTE]Для создания начальной резервной копии необходимо полностью перенести источник данных (базу данных SQL) с производственного сервера (SQL Server) на сервер DPM. Объем этих данных в некоторых случаях может быть очень большим, и при их передаче по сети возможно превышение пропускной способности. Поэтому администраторам предоставляются на выбор два варианта передачи этой начальной резервной копии: **Вручную** (во избежание превышения пропускной способности) и **Автоматически по сети**. Кроме того, параметр **Автоматически по сети** позволяет выбрать, когда следует создать начальную резервную копию: **Сейчас** или **Позже** (в указанное время).

    После создания начальной резервной копии поверх нее будет выполняться добавочное резервное копирование. Обычно это копии очень маленького размера, которые передаются по сети.

10. Выберите время для выполнения проверки согласованности и нажмите кнопку **Далее**.

    ![Проверка согласованности](./media/backup-azure-backup-sql/pg-consistent.png)

    >[AZURE.NOTE]DPM может проверять целостность точки резервного копирования (проверка согласованности). Для этого вычисляется контрольная сумма файла резервной копии на рабочем сервере (в этом сценарии используется SQL Server) и резервной копии данных для этого файла в DPM. В случае конфликта предполагается, что резервная копия файла в DPM повреждена. DPM исправляет резервные копии данных, отправляя блоки, соответствующие расхождению в контрольной сумме. Поскольку проверка согласованности является ресурсоемкой операцией, администраторам предоставляется возможность запланировать ее на определенное время или настроить ее автоматическое выполнение.

11. Чтобы настроить оперативную защиту источников данных, выберите базы данных для копирования в Azure и нажмите кнопку **Далее**.

    ![Выбор источников данных](./media/backup-azure-backup-sql/pg-sqldatabases.png)

12. Администраторы могут выбирать расписания резервного копирования и политики хранения в соответствии с политиками своей организации.

    ![Планирование и хранение](./media/backup-azure-backup-sql/pg-schedule.png)

    В этом примере резервные копии создаются дважды в день — в 12:00 и в 20:00 (в нижней части экрана).

    >[AZURE.NOTE]Чтобы обеспечить быстрое восстановление, рекомендуется создать на диске несколько точек восстановления для кратковременного использования. Это называется оперативным восстановлением. Azure — это удобное внешнее расположение с более высоким уровнем обслуживания и гарантированной доступностью. К первому полугодию 2015 г. в DPM и службе архивации Azure появится возможность указывать несколько «поколений» (или схем GFS) резервных копий.

    **Рекомендация**. После завершения резервного копирования локального диска с помощью DPM создайте расписание резервного копирования в Azure. Таким образом в Azure будет передаваться последняя резервная копия диска.

13. Выберите расписание для политики хранения. Дополнительные сведения о том, как работает политика хранения, см. в статье [Использование службы архивации Azure для замены ленточной инфраструктуры](backup-azure-backup-cloud-as-tape.md).

    ![Политика хранения](./media/backup-azure-backup-sql/pg-retentionschedule.png)

    В данном примере:

    - Резервные копии создаются дважды в день, в 12:00 и в 20:00 (в нижней части экрана), и хранятся в течение 180 дней.
    - Резервная копия, созданная в субботу в 12:00, хранится в течение 104 недель.
    - Резервная копия, созданная в последнюю субботу месяца в 12:00, хранится в течение 60 месяцев.
    - Резервная копия, созданная в последнюю субботу марта в 12:00, хранится в течение 10 лет.

14. Щелкните **Далее** и выберите нужный параметр для передачи начальной резервной копии в Azure: **Автоматически по сети** или **Автономная архивация**.

    - Если выбрать параметр **Автоматически по сети**, резервные копии данных будут передаваться в Azure по выбранному расписанию резервного копирования.
    - Принцип выполнения **автономной архивации** описан в статье [Автономное резервное копирование в службе архивации Azure](backup-azure-backup-import-export.md).

    Выберите способ передачи начальной резервной копии в Azure и нажмите кнопку **Далее**.

15. Просмотрев сведения о политике в окне **Сводка**, нажмите кнопку **Создать группу**, чтобы завершить процесс. После нажатия кнопки **Закрыть** вы сможете отслеживать ход выполнения задания в рабочей области «Наблюдение».

    ![Создание группы защиты: ход выполнения](./media/backup-azure-backup-sql/pg-summary.png)

## Резервное копирование базы данных SQL по запросу
С помощью описанных выше шагов мы создали политику резервного копирования, однако «точка восстановления» создается только при первом резервном копировании. Можно не ждать создания точки восстановления с помощью планировщика, а создать ее вручную, выполнив описанные ниже действия.

1. Прежде чем создавать точку восстановления, подождите, пока в группе защиты для базы данных отобразится состояние **ОК**.

    ![Члены группы защиты](./media/backup-azure-backup-sql/sqlbackup-recoverypoint.png)

2. Щелкните базу данных правой кнопкой мыши и выберите пункт **Создать точку восстановления**.

    ![Создание точки оперативного восстановления](./media/backup-azure-backup-sql/sqlbackup-createrp.png)

3. Выберите в раскрывающемся списке пункт **Оперативная защита** и нажмите кнопку **ОК**. После этого начнется создание точки восстановления в Azure.

    ![Создание точки восстановления](./media/backup-azure-backup-sql/sqlbackup-azure.png)

4. Ход выполнения задания можно просматривать в рабочей области **Наблюдение**, где вы увидите выполняющееся задание, как на рисунке ниже.

    ![Консоль наблюдения](./media/backup-azure-backup-sql/sqlbackup-monitoring.png)

## Восстановление базы данных SQL из Azure
Чтобы восстановить защищенный объект (базу данных SQL) из Azure, необходимо выполнить следующие шаги.

1. Откройте консоль управления сервером DPM. Перейдите в рабочую область **Восстановление**, где вы увидите серверы, для которых созданы резервные копии с помощью DPM. Найдите нужную базу данных (в данном случае ReportServer$MSDPM2012). Для параметра **Восстановить из** выберите значение времени, заканчивающееся словом **оперативный**.

    ![Выбор точки восстановления](./media/backup-azure-backup-sql/sqlbackup-restorepoint.png)

2. Щелкните имя базы данных правой кнопкой мыши и выберите пункт **Восстановить**.

    ![Восстановление из Azure](./media/backup-azure-backup-sql/sqlbackup-recover.png)

3. DPM отобразит сведения о точке восстановления. Нажмите кнопку **Далее**. Выберите тип восстановления **Восстановить в исходном экземпляре SQL Server**. В этом случае база данных будет перезаписана. Нажмите кнопку **Далее**.

    ![Восстановление в исходном расположении](./media/backup-azure-backup-sql/sqlbackup-recoveroriginal.png)

    В этом примере DPM позволяет восстановить базу данных в другом экземпляре SQL Server или в отдельной сетевой папке.

4. В окне **Указание параметров восстановления** можно выбрать параметр «Регулирование использования полосы пропускания сети», чтобы регулировать полосу пропускания, используемую при восстановлении. Нажмите кнопку **Далее**.

5. В окне **Сводка** вы увидите все конфигурации восстановления, доступные на данный момент. Щелкните **Восстановить**.

    В окне отобразится состояние восстановления, показывающее, что выполняется восстановление базы данных. Вы можете закрыть мастер кнопкой **Закрыть** и отслеживать ход выполнения в рабочей области **Мониторинг**.

    ![Запуск процесса восстановления](./media/backup-azure-backup-sql/sqlbackup-recoverying.png)

    По завершении процесса восстановленная копия базы данных будет согласована с приложением.

### Дальнейшие действия

[Часто задаваемые вопросы о службе архивации Azure](backup-azure-backup-faq.md)

<!---HONumber=Oct15_HO3-->