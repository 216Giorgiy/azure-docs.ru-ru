---
title: Резервное копирование виртуальных машин Azure
description: Сведения и некоторые рекомендации, посвященные резервному копированию виртуальных машин Azure.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 01/08/2019
ms.author: raynew
ms.openlocfilehash: cac219414418277ace09ba3a0b442f3bf74e6025
ms.sourcegitcommit: 30d23a9d270e10bb87b6bfc13e789b9de300dc6b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2019
ms.locfileid: "54107435"
---
# <a name="about-azure-vm-backup"></a>Резервное копирование виртуальных машин Azure

В этой статье описывается резервное копирование виртуальных машин Azure с помощью службы [Azure Backup](backup-introduction-to-azure-backup.md).

## <a name="backup-process"></a>Процесс резервного копирования

Далее описывается процесс резервного копирования виртуальных машин Azure с помощью службы Azure Backup.

1. В отношении выбранных для резервного копирования виртуальных машин Azure служба Azure Backup запускает задание резервного копирования в соответствии с установленным вами расписанием.
2. Служба активирует расширение резервного копирования.
    - Виртуальные машины Windows используют расширение _VMSnapshot_.
    - Виртуальные машины Linux используют расширение _VMSnapshotLinux_.
    - Расширение устанавливается во время первого резервного копирования виртуальной машины.
    - Для установки расширения виртуальная машина должна быть запущена.
    - Если виртуальная машина не запущена, служба резервного копирования создает моментальный снимок базового хранилища (так как операции записи в приложении не выполняются, пока виртуальная машина остановлена).
4. Расширение резервного копирования создает моментальный снимок уровня хранилища (отказоустойчивый или согласованный на уровне файлов).
5. После создания моментального снимка данные передаются в хранилище. Для повышения эффективности служба анализирует блоки данных и передает только те из них, которые были изменены с момента предыдущего резервного копирования (разностное резервное копирование).
5. После передачи данных служба удаляет моментальный снимок и создает точку восстановления.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="data-encryption"></a>Шифрование данных

Служба Azure Backup не шифрует данные в процессе резервного копирования. Служба Azure Backup поддерживает резервное копирование виртуальных машин Azure, зашифрованных с помощью технологии шифрования дисков Azure.

- Поддерживается резервное копирование управляемых и неуправляемых виртуальных машин Azure, зашифрованных только с помощью ключа шифрования Bitlocker (BEK), либо с использованием одновременно BEK и ключа шифрования Key (KEK).
- Копируемые BEK (секреты) и KEK (ключи) зашифрованы, благодаря чему они могут считываться и использоваться только в случае их восстановления в хранилище ключей авторизованными пользователями.
- Поскольку ключ BEK также копируется, в сценариях, связанных с утратой ключа BEK, пользователи могут восстановить его в хранилище ключей и восстановить зашифрованную виртуальную машину. Ключи и секреты зашифрованных виртуальных машин копируются в зашифрованной форме, поэтому их не могут прочитать ни пользователи, у которых нет на это полномочий, ни система Azure. Таким образом, выполнять резервное копирование зашифрованных виртуальных машин, ключей и секретов, а также восстанавливать их могут только пользователи с соответствующими разрешениями.

## <a name="snapshot-consistency"></a>Согласованность моментального снимка

Служба Azure Backup создает согласованные моментальные снимки во время работы приложений.

- **Для виртуальных машин Windows**: Для виртуальных машин Windows служба резервного копирования координируется со службой теневого копирования томов (VSS), что позволяет создать согласованный моментальный снимок дисков виртуальной машины.
    - По умолчанию служба Azure Backup создает полные резервные копии VSS. [Узнайте больше](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx).
    - Чтобы изменить этот параметр и настроить службу Azure Backup для резервного копирования копий VSS, задайте следующий раздел реестра.
        ```
        [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
        ""USEVSSCOPYBACKUP"="TRUE"
        ```
- **Для виртуальных машин Linux**: Чтобы обеспечить согласованность с приложениями виртуальных машин Linux при создании моментального снимка с помощью службы Azure Backup, можно использовать платформу сценариев предварительной и последующей обработки. Вы можете написать собственный скрипт для обеспечения согласованности при создании моментального снимка виртуальной машины.
    -  Служба Azure Backup вызывает только созданные вами скрипты, выполняемые до и после резервного копирования.
    - Если предварительный и последующий скрипты будут успешно выполнены, служба Azure Backup пометит точку восстановления как согласованную с приложениями. Однако при использовании пользовательских скриптов ответственность за согласованность с приложениями в конечном итоге несете вы.
    - [Дополнительные сведения](backup-azure-linux-app-consistent.md) о настройке скриптов.


#### <a name="consistency-types"></a>Виды согласованности

В следующей таблице описываются различные виды согласованности.

**Моментальный снимок** | **На основе VSS** | **Дополнительные сведения** | **Восстановление**
--- | --- | --- | ---
**Согласованность с приложениями** | Да (только Windows) | Согласованные с приложениями резервные копии включают содержимое памяти и ожидающие операции ввода-вывода. Для согласованных с приложениями моментальных снимков используется модуль записи VSS (либо предварительный или последующий скрипт в Linux), который обеспечивает согласованность данных приложения перед началом резервного копирования. | При восстановлении с использованием согласованного с приложениями моментального снимка выполняется загрузка виртуальной машины. В этом случае не происходит потери или повреждения данных. Приложение запускается в согласованном состоянии.
**Согласованность с файловой системой** | Да (только Windows) |  Согласованные с файловой системой резервные копии позволяют получить согласованные копии файлов на диске за счет создания моментального снимка одновременно всех файлов.<br/><br/> Точки восстановления службы Azure Backup согласуются с файловой системой для следующих компонентов.<br/><br/> — Резервные копии виртуальных машины Linux, для которых отсутствуют предварительные или последующие скрипты либо выполнение скрипта для которых завершилось сбоем.<br/><br/> — Резервные копии виртуальных машин Windows, для которых работа службы VSS завершилась сбоем. | При восстановлении с использованием согласованного с файловой системой моментального снимка выполняется загрузка виртуальной машины. В этом случае не происходит потери или повреждения данных. Чтобы гарантировать согласованность восстановленных данных, в приложениях необходимо реализовать собственный механизм исправления.
**Отказоустойчивость** | Нет  | Отказоустойчивость применяется в тех случаях, когда во время резервного копирования завершается работа виртуальной машины Azure.  Во время архивации создается резервная копия только тех данных, которые уже существуют на диске.<br/><br/> Наличие отказоустойчивой точки восстановления не гарантирует согласованности данных для операционной системы или приложения. | Несмотря на это, как правило, виртуальная машина загружается и выполняет проверку диска для исправления ошибок, связанных с повреждением данных. Любые находившиеся в памяти данные, которые не были перенесены на диск, утрачиваются. В приложениях должна быть реализована собственная проверка данных. Например, если журнал транзакций для приложения базы данных содержит записи, которых нет в самой базе, программное обеспечение базы данных выполняет откат до согласованного состояния данных.


## <a name="service-and-subscription-limits"></a>Ограничения службы и подписки

Служба Azure Backup имеет ряд ограничений, связанных с подписками и хранилищами.

[!INCLUDE [azure-backup-limits](../../includes/azure-backup-limits.md)]


## <a name="backup-performance"></a>Производительность резервного копирования

### <a name="disk-considerations"></a>Рекомендации относительно дисков

Операция резервного копирования оптимизируется за счет архивации каждого диска виртуальной машины в параллельном режиме. Например, если у виртуальной машины четыре диска, то служба попытается выполнить резервное копирование всех четырех дисков одновременно. Для каждого диска, для которого создается резервная копия, служба архивации Azure считывает блоки на диске и сохраняет только измененные данные (добавочное резервное копирование).


### <a name="scheduling-considerations"></a>Рекомендации относительно планирования

На производительность влияет расписание резервного копирования.

- Если вы настраиваете политики таким образом, что резервное копирование всех виртуальных машин выполняется одновременно, у вас возникнет перегрузка по трафику, так как процесс резервного копирования будет обрабатывать все диски параллельно.
- Чтобы уменьшить трафик резервного копирования, резервное копирование разных виртуальных машин следует полностью разнести во времени.


### <a name="time-considerations"></a>Рекомендации относительно времени

Больше всего времени занимают операции чтения и копирования данных, но есть и другие операции, которые влияют на общее время, необходимое для резервного копирования виртуальной машины.

- **Установка расширения резервного копирования**. Время на установку или обновление расширения резервного копирования.
- **Запуск создания моментального снимка**. Время, необходимое для запуска создания моментального снимка. Моментальные снимки активируются при приближении времени запланированной архивации.
- **Время ожидания в очереди**. Поскольку служба резервного копирования обрабатывает задания от нескольких клиентских учетных записей хранения одновременно, данные моментального снимка не могут быть немедленно скопированы в хранилище служб восстановления. В период пиковой нагрузки для обработки резервных копий может потребоваться до восьми часов. Тем не менее общее время архивации виртуальной машины не превышает 24 часов для политик ежедневной архивации.
- **Начальное резервное копирование**. Хотя для добавочных резервных копий общая продолжительность резервного копирования составляет менее 24 часов, на создание первой резервной копии может затрачиваться больше времени. Затрачиваемое время зависит от объема данных и момента создания резервной копии.
- **Время переноса данных**. Время, необходимое службе резервного копирования для вычисления добавочных изменений из предыдущей резервной копии и переноса этих изменений в хранилище.

### <a name="factors-affecting-backup-time"></a>Факторы, влияющие на время резервного копирования

Резервное копирование состоит из двух этапов: создание моментальных снимков и перенос этих снимков в хранилище. Служба архивации выполняет оптимизацию для хранилища.

- При передаче данных моментальных снимков в хранилище служба передает только добавочные изменения к предыдущему снимку.
- Чтобы определить добавочные изменения, служба вычисляет контрольную сумму блоков.
    - Если блок изменился, то он определяется как блок, который необходимо отправить в хранилище.
    - Служба глубже анализирует каждый из этих блоков и ищет возможности дальнейшего сокращения объема переносимых данных.
    - После оценки всех измененных блоков служба объединяет изменения и отправляет их в хранилище.

Ниже описываются ситуации, в которых время резервного копирования может увеличиваться.

- **Начальное резервное копирование нового диска, добавляемого к уже защищенной виртуальной машине**. Если при выполнении добавочного резервного копирования виртуальной машины на нее добавляется новый диск, тогда продолжительность архивации может превысить 24 часа, так как только что созданный диск должен пройти начальную репликацию, а также разносную репликацию существующих дисков.
- **Фрагментация**. Резервная копия продукта проверяет наличие добавочных изменений между двумя операциями резервного копирования. Операции резервного копирования выполняются быстрее, когда изменения на диске выровнены, по сравнению с изменениями, распространяющимися по всему диску. 
- **Обновление**. Ежедневное обновление (добавочная репликация) для диска размером свыше 200 ГБ может занять более 8 часов. Если у виртуальной машины есть несколько дисков и резервное копирование одного из этих дисков занимает больше времени, тогда это может повлиять на общую операцию резервного копирования (или может вызвать сбой). 
- **Режим сравнения контрольных сумм.** Этот режим сравнительно медленнее оптимизированного режима, используемого функцией Instant RP. Если вы уже используете функцию Instant RP и удалили моментальные снимки уровня 1, тогда резервная копия переключается в режим сравнения контрольных сумм, в результате чего время выполнения операции резервного копирования превышает 24 часа (или происходит сбой).

## <a name="restore-considerations"></a>Рекомендации относительно восстановления

Операция восстановления состоит из двух основных задач: копирование данных из хранилища в выбранную учетную запись хранения и создание виртуальной машины. Время, необходимое для копирования данных из хранилища, зависит от места хранения резервных копий в Azure и местоположения учетной записи хранения. Время, необходимое для копирования данных, зависит от следующих факторов:

- **Время ожидания в очереди**. Так как служба обрабатывает задания восстановления от нескольких учетных записей хранения одновременно, запросы на восстановление помещаются в очередь.
- **Время копирования данных**. Данные копируются из хранилища в учетную запись хранения. Время восстановления зависит от скорости ввода-вывода и пропускной способности, которую служба Azure Backup использует для выбранной учетной записи хранения. Чтобы сократить время копирования в процессе восстановления, выберите учетную запись хранения, которая не загружена другими операциями чтения и записи приложений.

## <a name="best-practices"></a>Рекомендации

Ниже приведены рекомендации, которые следует учитывать при настройке резервного копирования виртуальных машин.

- Настройте для хранилищ использование Instant RP. Ознакомьтесь со следующими [преимуществами](backup-upgrade-to-vm-backup-stack-v2.md), [рекомендациями](backup-upgrade-to-vm-backup-stack-v2.md#considerations-before-upgrade), а затем перейдите к обновлению, выполнив следующие [инструкции](backup-upgrade-to-vm-backup-stack-v2.md#upgrade).  
- Попробуйте изменить стандартное время политики (например, если это время — 12:00, рассмотрите возможность увеличения поминутно), когда создаются моментальные снимки данных, чтобы обеспечить оптимальное использование ресурсов.
- Для виртуальной машины категории "Премиум" без функции Instant RP выделяется около 50 % от общего объема хранилища учетной записи хранения. Службе резервного копирования требуется этот объем для копирования моментального снимка в ту же учетную запись хранения и для его передачи в хранилище.
- Для восстановления виртуальных машин из одного хранилища настоятельно рекомендуется использовать различные [учетные записи хранения версии 2,](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade) чтобы целевая учетная запись хранения не регулировалась. Например, у каждой виртуальной машины должны быть различные учетные записи хранения (если восстанавливается 10 виртуальных машин, используйте 10 учетных записей хранения).
- Восстановление из слоя хранилища уровня 1 (моментальный снимок) будет выполнено за считаные минуты (так как это та же учетная запись хранения) в отличие от слоя хранилища уровня 2 (хранилище), которое может занять несколько часов. Мы рекомендуем использовать функцию [Instant RP](backup-upgrade-to-vm-backup-stack-v2.md) для более быстрого восстановления в случае, если данные доступны на уровне 1 (если данные необходимо восстановить из хранилища, это займет время).
- Ограничение на количество дисков в учетной записи хранения зависит от того, как часто к дискам обращаются приложения, работающие на виртуальной машине IaaS. Проверьте, размещается ли в одной учетной записи хранения несколько дисков. В общем случае, если в одной учетной записи хранения есть от 5 до 10 дисков, сбалансируйте нагрузку, переместив некоторые диски в отдельные учетные записи хранения.

## <a name="backup-costs"></a>Оплата резервного копирования

В отношении виртуальных машин Azure, резервное копирование которых выполняется с помощью службы Azure Backup, действует [прейскурант на использование службы Azure Backup](https://azure.microsoft.com/pricing/details/backup/).

- Оплачиваемый период начинается только после завершения первой успешной архивации. На этом этапе начинается выставление счетов за службу хранилища и защищенные экземпляры.
- Оплачиваемый период длится, пока в хранилище есть резервные копии данных для виртуальной машины. Остановка защиты для виртуальной машины не останавливает выставление счетов, если резервная копия данных остается в хранилище.
- Выставление счетов для определенной виртуальной машины прекращается, только если останавливается защита и удаляются все данные резервных копий.
- Когда защита останавливается и нет активных заданий резервного копирования, размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе которого выставляется ежемесячный счет.
- Вычисление защищенных экземпляров основано на *фактическом* размере виртуальной машины, который представляет собой сумму всех данных на виртуальной машине за исключением временного хранилища.
- Она основана на фактических данных, хранящихся на диске данных.
- Стоимость резервного копирования виртуальных машин не зависит от максимальных размеров всех дисков данных, которые подключены к виртуальной машине.
- Аналогичным образом счет за хранилище службы архивации основан на объеме данных, хранящихся в службе архивации Azure, который представляет собой сумму фактических данных в каждой точке восстановления.

Например, возьмем виртуальную машину A2 стандартного размера с двумя дополнительными дисками максимальным объемом 4 ТБ каждый. В следующей таблице приводятся фактические данные, хранящиеся на каждом из этих дисков:

| Тип диска | Максимальный размер | Фактические данные |
| --------- | -------- | ----------- |
| Диск операционной системы |4095 ГБ |17 ГБ |
| Локальный диск или временный диск |135 ГБ |5 ГБ (не учитывается для архивации) |
| Диск данных 1 |4095 ГБ |30 ГБ |
| Диск данных 2 |4095 ГБ |0 ГБ |

- Фактический размер виртуальной машины в этом случае составляет 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ.
- Этот размер защищенного экземпляра (47 ГБ) служит основой для ежемесячного счета.
- Если объем данных на виртуальной машине увеличивается, соответствующим образом изменяется размер защищенного экземпляра, используемый для тарификации услуг.


## <a name="next-steps"></a>Дополнительная информация

После ознакомления с процессом резервного копирования и рекомендациями относительно производительности выполните следующие действия.

- Ознакомьтесь с [дополнительными сведениями](../virtual-machines/windows/premium-storage-performance.md) о настройке приложений для обеспечения оптимальной производительности при работе со службой хранилища Azure. Эта статья написана для хранилищ класса Premium, однако ее содержимое также относится к стандартным дискам хранилища.
- [Начните работу](backup-azure-arm-vms-prepare.md) со службой резервного копирования, ознакомившись со сведениями о поддержке и ограничениях для виртуальных машин, создании хранилища, а также подготовке виртуальных машин к резервному копированию.
