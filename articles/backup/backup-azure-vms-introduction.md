---
title: Резервное копирование виртуальных машин Azure
description: Сведения и некоторые рекомендации, посвященные резервному копированию виртуальных машин Azure.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/17/2019
ms.author: raynew
ms.openlocfilehash: c38c457bbf428d7252cf57168685201a2ca227ba
ms.sourcegitcommit: 6cab3c44aaccbcc86ed5a2011761fa52aa5ee5fa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2019
ms.locfileid: "56446806"
---
# <a name="about-azure-vm-backup"></a>Резервное копирование виртуальных машин Azure

В этой статье описывается резервное копирование виртуальных машин Azure с помощью службы [Azure Backup](backup-introduction-to-azure-backup.md).

## <a name="backup-process"></a>Процесс резервного копирования

Далее описывается процесс резервного копирования виртуальных машин Azure с помощью службы Azure Backup.

1. В отношении выбранных для резервного копирования виртуальных машин Azure служба Azure Backup запускает задание резервного копирования в соответствии с установленным вами расписанием.
2. Расширение резервного копирования устанавливается на виртуальной машине при запросе первой резервной копии, если она запущена.
    - Для виртуальных машин Windows устанавливается расширение _VMSnapshot_.
    - Для виртуальных машин Linux устанавливается расширение _VMSnapshotLinux_.
3. Для запущенных виртуальных машин Windows служба Backup координируется со службой VSS, чтобы сделать снимок виртуальной машины с согласованием приложений.
    - По умолчанию служба Backup создает полные резервные копии VSS.
    - Если службе Backup не удалось сделать моментальный снимок с согласованием приложений, тогда она делает моментальный снимок с согласованием файлов базового хранилища (так как во время пребывания виртуальной машины в остановленном состоянии операции записи приложения не происходят).
4. Для резервного копирования виртуальных машин Linux служба Backup выполняет резервную копию с согласованием файлов. Для моментальных снимков с согласованием приложений необходимо вручную настроить такие сценарии.
5. После создания моментального снимка данные передаются в хранилище. 
    - Служба Backup оптимизируется за счет резервного копирования каждого диска виртуальной машины в параллельном режиме.
    - Служба Azure Backup считывает блоки на каждом диске, для которого выполняется резервное копирование, а затем идентифицирует и передает только те блоки данных, которые изменились со времени предыдущего резервного копирования (разностные данные).
    - После создания моментального снимка данные передаются в хранилище.
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. Это может занять несколько часов при высокой нагрузке. Общее время резервного копирования виртуальной машины составит менее 24 часов для политик ежедневного резервного копирования.

6. После передачи данных служба удаляет моментальный снимок и создает точку восстановления.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encrypting-azure-vm-backups"></a>Шифрование резервных копий виртуальных машин Azure

При создании резервных копий виртуальных машин Azure с помощью Azure Backup виртуальные машины шифруются в неактивном состоянии с использованием Шифрования службы хранилища. Кроме того, служба Azure Backup поддерживает резервное копирование виртуальных машин Azure, зашифрованных с помощью технологии шифрования дисков Azure (ADE).


**Шифрование** | **Дополнительные сведения** | **Поддержка**
--- | --- | ---
**ADE** | ADE шифрует диски ОС и диски данных для виртуальных машин Azure.<br/><br/> ADE интегрируется с ключами шифрования BitLocker (BEK), которые хранятся в хранилище ключей в качестве секретов, или с ключами шифрования ключей (KEK), содержащимися в Azure Key Vault. | Azure Backup поддерживает резервное копирование управляемых и неуправляемых виртуальных машин Azure, зашифрованных только с использованием ключа BEK или ключей и BEK, и KEK.<br/><br/> Оба ключа шифруются, и для них выполняется резервное копирование.<br/><br/> Так как создаются резервные копии KEK и BEK, если необходимо, пользователи с разрешениями могут восстанавливать ключи и секреты обратно в хранилище ключей, а также восстанавливать зашифрованные виртуальные машины.<br/><br/> Зашифрованные ключи и секреты недоступны для чтения неавторизованными пользователями или Azure.
**SSE** | Благодаря SSE служба хранилища Azure обеспечивает шифрование неактивных данных, автоматически шифруя данные перед сохранением и расшифровывая их перед извлечением. | Azure Backup использует SSE для шифрования неактивных данных виртуальных машин Azure.

- Поддерживается резервное копирование управляемых и неуправляемых виртуальных машин Azure, зашифрованных только с помощью ключа шифрования BitLocker (BEK) либо с использованием одновременно BEK и ключа шифрования ключей (KEK).
- Резервные копии BEK (секреты) и KEK (ключи) шифруются. Их можно будет считать и использовать только после того, как они будут восстановлены обратно в хранилище ключей полномочными пользователями. Неполномочные пользователи и Azure не могут читать или использовать резервные копии ключей и секретов.
- Так как ключ BEK также копируется, в случаях, связанных с утратой ключа BEK, пользователи могут восстановить его в хранилище ключей и восстановить зашифрованную виртуальную машину. 
- Таким образом, выполнять резервное копирование зашифрованных виртуальных машин, ключей и секретов, а также восстанавливать их могут только пользователи с соответствующими разрешениями.



## <a name="taking-snapshots"></a>Создание моментальных снимков

Моментальные снимки Azure Backup создаются в соответствии с расписанием резервного копирования. 

- **Для виртуальных машин Windows**: Для виртуальных машин Windows служба резервного копирования координируется со службой теневого копирования томов (VSS), что позволяет создать моментальный снимок дисков виртуальной машины с согласованием приложений.
    - По умолчанию служба Azure Backup создает полные резервные копии VSS. [Узнайте больше](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx).
    - Чтобы изменить этот параметр и настроить службу Azure Backup для резервного копирования копий VSS, задайте следующий раздел реестра из командной строки: **REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgent" /v USEVSSCOPYBACKUP /t REG_SZ /d TRUE /f**.
- **Для виртуальных машин Linux**: Если вы хотите создать моментальные снимки виртуальной машины Linux с согласованием приложений, используйте платформу для предварительного и последующего выполнения сценариев, чтобы писать собственные сценарии для обеспечения согласованности.
    -  Служба Azure Backup вызывает только созданные вами сценарии, выполняемые до и после резервного копирования.
    - Если предварительный и последующий скрипты будут успешно выполнены, служба Azure Backup пометит точку восстановления как согласованную с приложениями. Однако при использовании пользовательских скриптов ответственность за согласованность с приложениями в конечном итоге несете вы.
    - [Дополнительные сведения](backup-azure-linux-app-consistent.md) о настройке скриптов.


### <a name="snapshot-consistency"></a>Согласованность моментального снимка

В следующей таблице описываются различные виды согласованности.

**Моментальный снимок** | **Дополнительные сведения** | **Восстановление** | **Рассмотрение**
--- | --- | --- | ---
**Согласованность с приложениями** | Согласованные с приложениями резервные копии включают содержимое памяти и ожидающие операции ввода-вывода. Для согласованных с приложениями моментальных снимков используется модуль записи VSS (либо предварительный или последующий скрипт в Linux), который обеспечивает согласованность данных приложения перед началом резервного копирования. | При восстановлении с использованием согласованного с приложениями моментального снимка выполняется загрузка виртуальной машины. В этом случае не происходит потери или повреждения данных. Приложение запускается в согласованном состоянии. | Windows: Все модули записи VSS выполнены успешно<br/><br/> Linux: Предварительные и последующие сценарии настроены и выполнены успешно
**Согласованность с файловой системой** | Согласованные с файловой системой резервные копии позволяют получить согласованные копии файлов на диске за счет создания моментального снимка одновременно всех файлов.<br/><br/> | При восстановлении с использованием согласованного с файловой системой моментального снимка выполняется загрузка виртуальной машины. В этом случае не происходит потери или повреждения данных. Чтобы гарантировать согласованность восстановленных данных, в приложениях необходимо реализовать собственный механизм исправления. | Windows: Некоторые модули записи VSS завершились сбоем <br/><br/> Linux: По умолчанию (если такие сценарии не настроены или завершились ошибкой)
**Отказоустойчивость** | Отказоустойчивость применяется в тех случаях, когда во время резервного копирования завершается работа виртуальной машины Azure.  Во время архивации создается резервная копия только тех данных, которые уже существуют на диске.<br/><br/> Наличие отказоустойчивой точки восстановления не гарантирует согласованности данных для операционной системы или приложения. | Несмотря на это, как правило, виртуальная машина загружается и выполняет проверку диска для исправления ошибок, связанных с повреждением данных. Любые находившиеся в памяти данные, которые не были перенесены на диск, утрачиваются. В приложениях должна быть реализована собственная проверка данных. Например, если журнал транзакций для приложения базы данных содержит записи, которых нет в самой базе, программное обеспечение базы данных выполняет откат до согласованного состояния данных. | Виртуальная машина находится в состоянии завершения работы


## <a name="restore-considerations"></a>Рекомендации относительно восстановления 



**Рассмотрение** | **Дополнительные сведения**
--- | ---
**Диск** | Создание резервной копии диска виртуальной машины выполняется параллельно. Например, если у виртуальной машины четыре диска, то служба попытается выполнить резервное копирование всех четырех дисков одновременно. Резервное копирование является добавочным (только измененные данные).
**Планирование** |  Чтобы уменьшить трафик резервного копирования, резервное копирование разных виртуальных машин следует полностью разнести во времени. Резервное копирование виртуальных машин в одно и то же время создает перегрузку.
**Подготовка резервных копий** | Учитывайте время подготовки резервного копирования, которое включает установку или обновление расширения резервного копирования, а также запуск моментального снимка в соответствии с расписанием резервного копирования.
**Передача данных в службы Azure и обратно** | Время, необходимое службе резервного копирования для вычисления добавочных изменений из предыдущей резервной копии.<br/><br/> Чтобы определить добавочные изменения, служба вычисляет контрольную сумму блоков. Если блок изменился, он помечается для отправки в хранилище. Служба глубже анализирует идентифицированные блоки, чтобы сократить объем передаваемых данных. После оценки всех измененных блоков изменения передаются в хранилище.<br/><br/> Возможна небольшая задержка между созданием моментального снимка и его копированием в хранилище.<br/><br/> В часы пик обработка резервных копий может занять до восьми часов. Общее время резервного копирования виртуальной машины составляет менее 24 часов для ежедневного резервного копирования.
**Начальное резервное копирование** | Хотя для добавочных резервных копий общая продолжительность резервного копирования составляет менее 24 часов, на создание первой резервной копии может затрачиваться больше времени. Затрачиваемое время зависит от объема данных и момента создания резервной копии.
**Очередь восстановления** | Azure Backup обрабатывает задания восстановления от нескольких учетных записей хранения одновременно, и запросы на восстановление помещаются в очередь.
**Копирование при восстановлении** | Во время восстановления данные копируются из хранилища в учетную запись хранения.<br/><br/> Время восстановления зависит от операций ввода-вывода в секунду и пропускной способности учетной записи хранения.<br/><br/> Чтобы сократить время копирования, выберите учетную запись хранения, которая не загружена другими операциями чтения и записи приложений.


### <a name="backup-performance"></a>Производительность резервного копирования

На время резервного копирования могут повлиять следующие распространенные сценарии:

- Добавьте новый диск на защищенную виртуальную машину Azure. Если на виртуальной машине выполняется добавочное резервное копирование и добавляется новый диск, резервное копирование может длиться более 24 часов из-за первоначальной репликации нового диска вместе с разностной репликацией существующих дисков.
- Фрагментированные диски. Операции резервного копирования выполняются быстрее, когда изменения на диске размещены совместно. Если изменения распределены по всему диску, резервное копирование будет выполняться медленнее. 
- Скорость обработки диска. Если защищенные диски, для которых выполняется добавочное резервное копирование, обрабатывают более 200 ГБ в день, резервное копирование может занять много времени (более восьми часов). 
- Версии службы Backup. Последняя версия Backup (известная как мгновенное восстановление) использует более оптимизированный процесс вычисления контрольных сумм для сравнения изменений. Если вы используете последнюю версию и удалили моментальный снимок резервной копии, резервное копирование переключится на сравнение контрольных сумм, а время выполнения операции резервного копирования превысит 24 часа (или завершится со сбоем).

## <a name="best-practices"></a>Рекомендации 
Ниже приведены рекомендации, которые следует учитывать при настройке резервного копирования виртуальных машин.

- Рассмотрите возможность изменения запланированного времени по умолчанию в политике. Например, если время по умолчанию в политике — 12:00, рассмотрите возможность увеличения поминутно, чтобы обеспечить оптимальное использование ресурсов.
- Для виртуальной машины категории "Премиум" без функции Instant RP выделяется около 50 % от общего объема хранилища учетной записи хранения. Службе резервного копирования требуется этот объем для копирования моментального снимка в ту же учетную запись хранения и для его передачи в хранилище.
- Для восстановления виртуальных машин из одного хранилища настоятельно рекомендуется использовать различные [учетные записи хранения версии 2](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade), чтобы целевая учетная запись хранения не регулировалась. Например, у каждой виртуальной машины должны быть различные учетные записи хранения (если восстанавливается 10 виртуальных машин, используйте 10 учетных записей хранения).
- Восстановление из слоя хранилища уровня 1 (моментальный снимок) будет выполнено за считаные минуты (так как это та же учетная запись хранения) в отличие от слоя хранилища уровня 2 (хранилище), которое может занять несколько часов. Мы рекомендуем использовать функцию [Instant Restore](backup-instant-restore-capability.md) (Мнгновенное восстановление) для более быстрого восстановления в случае, если данные доступны на уровне 1 (если данные необходимо восстановить из хранилища, это займет время).
- Ограничение на количество дисков в учетной записи хранения зависит от того, как часто к дискам обращаются приложения, работающие на виртуальной машине IaaS. Проверьте, размещается ли в одной учетной записи хранения несколько дисков. В общем случае, если в одной учетной записи хранения есть от 5 до 10 дисков, сбалансируйте нагрузку, переместив некоторые диски в отдельные учетные записи хранения.

## <a name="backup-costs"></a>Оплата резервного копирования

В отношении виртуальных машин Azure, резервное копирование которых выполняется с помощью службы Azure Backup, действует [прейскурант на использование службы Azure Backup](https://azure.microsoft.com/pricing/details/backup/).

- Оплачиваемый период начинается только после завершения первого успешного резервного копирования. На этом этапе начинается выставление счетов за службу хранилища и защищенные виртуальные машины.
- Оплачиваемый период длится, пока в хранилище есть резервные копии данных для виртуальной машины. Если вы остановите защиту виртуальной машины, но данные резервного копирования виртуальной машины остаются в хранилище, выставление счетов продолжится.
- Выставление счетов для определенной виртуальной машины прекращается, только если останавливается защита и удаляются все данные резервных копий.
- Когда защита останавливается и нет активных заданий резервного копирования, размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе которого выставляется ежемесячный счет.
- Вычисление защищенных экземпляров основано на *фактическом* размере виртуальной машины, который представляет собой сумму всех данных на виртуальной машине, за исключением временного хранилища.
- Она основана на фактических данных, хранящихся на диске данных.
- Стоимость резервного копирования виртуальных машин не зависит от максимальных размеров всех дисков данных, которые подключены к виртуальной машине.
- Аналогичным образом счет за хранилище службы архивации основан на объеме данных, хранящихся в службе архивации Azure, который представляет собой сумму фактических данных в каждой точке восстановления.

Например, возьмем виртуальную машину A2 стандартного размера с двумя дополнительными дисками максимальным объемом 4 ТБ каждый. В следующей таблице приводятся фактические данные, хранящиеся на каждом из этих дисков:

**Диск** | **Максимальный размер** | **Присутствующие фактические данные**
--- | --- | ---
Диск ОС | 4095 ГБ | 17 ГБ 
Локальный или временный диск | 135 ГБ | 5 ГБ (не учитывается для архивации) 
Диск данных 1 | 4095 ГБ | 30 ГБ 
Диск данных 2 | 4095 ГБ | 0 ГБ 

- Фактический размер виртуальной машины в этом случае составляет 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ.
- Этот размер защищенного экземпляра (47 ГБ) служит основой для ежемесячного счета.
- Если объем данных на виртуальной машине увеличивается, соответствующим образом изменяется размер защищенного экземпляра, используемый для тарификации услуг.


## <a name="next-steps"></a>Дополнительная информация

Теперь [подготовьтесь](backup-azure-arm-vms-prepare.md) к резервному копированию виртуальной машины Azure.
