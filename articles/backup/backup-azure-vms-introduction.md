<properties
	pageTitle="Планирование инфраструктуры резервного копирования виртуальных машин | Microsoft Azure"
	description="Важные аспекты планирования инфраструктуры резервного копирования виртуальных машин в Azure."
	services="backup"
	documentationCenter=""
	authors="Jim-Parker"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="10/29/2015"
	ms.author="trinadhk; aashishr; jimpark; markgal"/>

# Планирование инфраструктуры резервного копирования виртуальных машин в Azure
Эта статья описывает ключевые факторы, которые вам следует учесть при планировании инфраструктуры резервного копирования виртуальных машин. Если вы уже [подготовили среду](backup-azure-vms-prepare.md), этот шаг позволит начать [резервное копирование виртуальных машин](backup-azure-vms.md). Дополнительные сведения о виртуальных машинах Azure содержатся в [документации по виртуальным машинам](https://azure.microsoft.com/documentation/services/virtual-machines/).

## Как Azure выполняет резервное копирование виртуальных машин
Служба архивации Azure по установленному расписанию запускает задание резервного копирования. При этом модуль резервного копирования создает снимок текущего состояния. Этот процесс координируется со службой теневого копирования тома (VSS), что позволяет создать согласованный снимок дисков виртуальной машины без остановки ее работы.

После создания моментального снимка данные передаются в хранилище службы архивации Azure. Служба анализирует блоки данных и передает только те блоки, которые были изменены с момента предыдущего резервного копирования. Это позволяет повысить эффективность процесса резервного копирования.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

После передачи данных служба удаляет моментальный снимок и создает точку восстановления.

### Согласованность данных
Резервное копирование и восстановление критически важных данных осложняются тем, что копирование должно выполняться без остановки приложений, которые создают эти данные. Для решения этой проблемы служба резервного копирования Azure обеспечивает целостность на уровне приложений во время резервного копирования рабочих нагрузок Windows. Она использует службу моментального снимка тома (VSS), чтобы обеспечить правильную запись данных в хранилище.

>[AZURE.NOTE]Для виртуальных машин Linux резервное копирование возможно только при целостности файлов, так как на Linux не существует аналога платформы VSS.

Следующая таблица содержит типы целостности информации, их описания и условия соблюдения при резервном копировании и восстановлении виртуальных машин Azure.

| Целостность | На основе VSS | Подробное объяснение |
|-------------|-----------|---------|
| Целостность на уровне приложения | Да | Идеально подходит для рабочих нагрузок Майкрософт, так как гарантирует следующее:<ol><li> Виртуальная машина *загружается*. <li>*Нет повреждений данных*. <li>*Нет потерь данных*.<li> Во время резервного копирования служба VSS взаимодействует с приложениями, что обеспечивает целостность данных для использующих их приложений.</ol> Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных. Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных.<br><br> Для резервного копирования виртуальных машин Azure получение точки восстановления с согласованными данными означает, что расширение резервного копирования имело возможность вызвать рабочий процесс VSS и *корректно* завершить его до выполнения моментального снимка ВМ. Естественно, это означает, что модули записи VSS всех приложений на виртуальной машине Azure были также вызваны.<br><br>Познакомьтесь с [основами службы VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx), подробно изучите [принцип ее работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx). |
| Целостность на уровне файловой системы | Да, для компьютеров Windows | Существует два сценария, обеспечивающих в точке восстановления целостность данных только *на уровне файловой системы*.<ul><li>Резервное копирование виртуальных машин Linux в Azure, так как Linux не имеет аналога платформы VSS.<li>Сбой службы VSS во время резервного копирования виртуальных машин Windows в Azure.</li></ul> В обоих случаях система прилагает все возможные усилия, чтобы обеспечить следующее: <ol><li>Виртуальная машина *загружается*. <li>*Нет повреждений данных*.<li>*Нет потерь данных*.</ol> Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных.|
| Отказоустойчивость | Нет | Такая ситуация аналогична сбою компьютера (приводит к программной или аппаратной перезагрузке). Обычно это происходит при выключении виртуальной машины Azure во время резервного копирования. Если при резервном копировании виртуальной машины Azure будет получена точка восстановления с аварийной целостностью, это означает, что служба архивации Azure не гарантирует согласованности сохраненных данных на уровне операционной системы или на уровне приложения. Сохраняются и копируются только те данные, которые были записаны на диск на момент создания резервной копии. <br/> <br/>В большинстве случаев операционная система будет загружаться нормально, хотя это не гарантируется. Обычно загрузка сопровождается процедурой проверки диска (например chkdsk), предназначенной для устранения ошибок, связанных с его повреждением. Будут потеряны все данные, которые не были записаны на диск. В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки. Если во время резервного копирования виртуальной машины Azure будет получена точка восстановления с аварийной целостностью, это означает, что служба архивации Azure не гарантирует согласованности сохраненных данных на уровне операционной системы или на уровне приложения. Обычно это происходит при завершении работы виртуальной машины Azure во время резервного копирования.<br><br>Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до точки, в которой данные являются целостными. При работе с данными, которые распределены между несколькими виртуальными дисками (например, составные тома), отказоустойчивые точки восстановления не гарантируют правильность данных.|


## Производительность и использование ресурсов
Резервное копирование виртуальных машин в Azure, как и любую локальную систему резервного копирования, следует планировать с учетом ограничений производительности и использования ресурсов. [Ограничения службы хранилища Azure](azure-subscription-service-limits.md#storage-limits) определяют структуру развертывания виртуальных машин, обеспечивающую максимальную производительность и минимальное влияние на рабочие нагрузки.

Существует два основных ограничения хранилища Azure, влияющих на производительность резервного копирования.

- Максимальный объем исходящих данных на учетную запись хранения.
- Общая частота запросов на учетную запись хранения.

### Ограничения учетной записи хранения
При копировании резервных данных из пользовательской учетной записи хранения учитывается число операций ввода-вывода в секунду и метрики исходящих данных (пропускная способность хранилища) учетной записи хранения. При этом виртуальные машины продолжают работу, выполняют операции ввода-вывода и используют пропускную способность. Цель заключается в том, чтобы общий объем трафика (резервного копирования и виртуальной машины) не превышал ограничения учетной записи хранения.

### Количество дисков
Процесс резервного копирования использует максимально возможное количество ресурсов для максимально быстрого завершения резервного копирования. Тем не менее все операции ввода-вывода ограничены *целевой пропускной способностью для одного большого двоичного объекта*. Предельное значение пропускной способности составляет *60 МБ в секунду*. Чтобы ускорить процесс резервного копирования, выполняется попытка *параллельного* резервного копирования каждого диска виртуальной машины. Например, если у виртуальной машины 4 жестких диска, служба архивации Azure будет пытаться создать резервную копию всех 4 дисков одновременно. По этой причине **количество дисков**, для которых создаются резервные копии из учетной записи хранения, является основным фактором, определяющим объем трафика резервного копирования для этой учетной записи хранения.

### Расписание резервного копирования
На производительность влияет также **расписание резервного копирования**. Если вы настроите одновременное резервное копирование всех виртуальных машин, увеличится количество *параллельно* копируемых дисков. Как вы помните, служба архивации Azure старается выполнить одновременное копирование максимально возможного количества дисков. Поэтому, чтобы уменьшить трафик резервного копирования из учетной записи хранения, рекомендуем запланировать резервное копирование разных виртуальных машин в разное время дня, а не параллельно.

## Планирование загрузки
Если сложить все эти факторы, становится очевидно, что использование учетной записи хранения необходимо планировать должным образом. Загрузите [лист Excel по планированию производительности резервного копирования виртуальных машин](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33), который позволит оценить влияние выбранного количества дисков и расписания резервного копирования.

### Пропускная способность при резервном копировании
Для каждого диска, для которого создается резервная копия, служба архивации Azure считывает блоки на диске и сохраняет только измененные данные (добавочное резервное копирование). Эта таблица содержит средние значения пропускной способности, которые следует ожидать от службы резервного копирования Azure. Используя эти значения, вы можете рассчитать время резервного копирования для диска заданного размера.

| Операция резервного копирования | Пропускная способность в лучшем случае |
| ---------------- | ---------- |
| Первичная резервная копия | 160 Мбит/с |
| Добавочное резервное копирование (аварийное восстановление) | 640 Мбит/с <br><br> Пропускная способность может быть существенно ниже указанной, если нужно выполнить резервное копирование большого количества разрозненных данных. |

### Общее время резервного копирования виртуальной машины
Больше всего времени занимают операции чтения и копирования данных, но есть и другие операции, которые влияют на общее время резервного копирования виртуальной машины.

- Время на [установку или обновление расширения резервного копирования](backup-azure-vms.md#offline-vms).
- Время создания моментального снимка — время, необходимое для активации моментального снимка. Моментальные снимки активируются при приближении времени запланированного резервного копирования.
- Время ожидания в очереди. Так как служба архивации обрабатывает резервные копии от нескольких пользователей, копирование данных резервной копии из моментального снимка в хранилище резервных копий Azure может начаться не сразу. В часы пиковой нагрузки время ожидания может достигать 8 часов из-за количества обрабатываемых резервных копий. Но даже при ежедневном резервном копировании общее время резервного копирования виртуальной машины не будет превышать 24 часов.

## Как вычисляются защищенные экземпляры
Оплата резервного копирования виртуальных машин с помощью службы архивации Azure выполняется в соответствии с [ценами на службу архивации Azure](http://azure.microsoft.com/pricing/details/backup/). Вычисление защищенных экземпляров основано на *фактическом* размере виртуальной машины, который представляет собой сумму всех данных на виртуальной машине за исключением "диска ресурсов". Оплата зависит *не* от максимальных размеров всех дисков с данными, которые подключены к виртуальной машине, а от фактических данных, хранящихся на диске с данными. Аналогичным образом счет за хранилище службы архивации основан на объеме данных, хранящихся в службе архивации Azure, который представляет собой сумму фактических данных в каждой точке восстановления.

Например, возьмем виртуальную машину стандартного размера A2 с двумя дополнительными дисками максимальным объемом 1 ТБ каждый. В таблице ниже приводятся фактические данные, хранящиеся на каждом из этих дисков.

|Тип диска|Максимальный размер|Фактические данные|
|---------|--------|------|
| Диск ОС | 1023 ГБ | 17 ГБ |
| Локальный диск или диск ресурсов | 135 ГБ | 5 ГБ (не включен для резервного копирования) |
| Диск данных 1 |	1023 ГБ | 30 ГБ |
| Диск данных 2 | 1023 ГБ | 0 ГБ |

*Фактический* размер виртуальной машины в данном случае равен 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ. Этот показатель равен размеру защищенного экземпляра, на котором основывается ежемесячный счет. Если объем данных на виртуальной машине увеличивается, соответствующим образом изменяется размер защищенного экземпляра, используемый для тарификации услуг.

Оплачиваемый период начинается только после завершения первого успешного резервного копирования. На этом этапе начнется выставление счетов за хранение и защищенные экземпляры. Оплачиваемый период длится до тех пор, пока *служба архивации Azure хранит резервные копии данных* для виртуальной машины. Остановка защиты не останавливает выставление счетов, если резервная копия данных продолжает храниться. Выставление счетов для определенной виртуальной машины будет остановлено, только если остановить защиту *и* удалить все резервные копии данных. Когда нет активных заданий резервного копирования (при остановке защиты), размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе чего выставляется ежемесячный счет.

## Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-то функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## Дальнейшие действия

- [Резервное копирование виртуальных машин](backup-azure-vms.md)
- [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)
- [Восстановление виртуальных машин](backup-azure-restore-vms.md)
- [Устранение проблем с резервным копированием виртуальных машин](backup-azure-vms-troubleshoot.md)

<!---HONumber=Nov15_HO3-->