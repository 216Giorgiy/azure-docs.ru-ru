---
title: "Планирование инфраструктуры архивации виртуальных машин | Документация Майкрософт"
description: "Важные вопросы при планировании резервного копирования виртуальных машин в Azure"
services: backup
documentationcenter: 
author: markgalioto
manager: carmonm
editor: 
keywords: "архивация ВМ, архивация виртуальных машин"
ms.assetid: 19d2cf82-1f60-43e1-b089-9238042887a9
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/08/2016
ms.author: markgal;trinadhk
translationtype: Human Translation
ms.sourcegitcommit: a4045fc0fc6e2c263da06ed31a590714e80fb4d4
ms.openlocfilehash: ac13b82c885720fa6d3d127b8e8dbbace5b09ef5


---
# <a name="plan-your-vm-backup-infrastructure-in-azure"></a>Планирование инфраструктуры резервного копирования виртуальных машин в Azure
Эта статья содержит рекомендации по производительности и ресурсам, которые помогут спроектировать инфраструктуру резервного копирования виртуальных машин. Также здесь приводятся ключевые определения службы резервного копирования; эти аспекты могут быть критически важными при определении архитектуры, планировании и распределении мощностей. Если вы уже [подготовили среду](backup-azure-vms-prepare.md), этот шаг позволит начать [архивацию виртуальных машин](backup-azure-vms.md). Дополнительные сведения о виртуальных машинах Azure содержатся в [документации по виртуальным машинам](https://azure.microsoft.com/documentation/services/virtual-machines/).

## <a name="how-does-azure-back-up-virtual-machines"></a>Как Azure выполняет резервное копирование виртуальных машин
Служба архивации Azure по установленному расписанию запускает задание резервного копирования. При этом модуль резервного копирования создает снимок текущего состояния. Этот процесс координируется со службой теневого копирования томов (VSS), что позволяет создать согласованный снимок дисков виртуальной машины без остановки ее работы.

После создания моментального снимка данные передаются в хранилище службы архивации Azure. Служба анализирует блоки данных и передает только те блоки, которые были изменены с момента предыдущего резервного копирования. Это позволяет повысить эффективность процесса резервного копирования.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

После передачи данных служба удаляет моментальный снимок и создает точку восстановления.

### <a name="data-consistency"></a>Согласованность данных
Резервное копирование и восстановление критически важных для бизнеса данных осложняются тем, что копирование этих данных должно выполняться во время работы приложений, которые создают эти данные. Для решения этой проблемы служба архивации Azure обеспечивает целостность на уровне приложений во время архивации рабочих нагрузок Майкрософт. Она использует службу VSS, чтобы обеспечить правильную запись данных в хранилище.

> [!NOTE]
> Для виртуальных машин Linux архивация возможна только при целостности файлов, так как на Linux не существует аналогичной платформы для службы VSS.
>
>

Служба архивации Azure принимает полные резервные копии VSS на виртуальных машинах Windows (дополнительные сведения см. в записи блога о [полном резервном копировании VSS](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)). Чтобы включить копирующую архивацию VSS, для виртуальной машины необходимо задать приведенный ниже раздел реестра.

```
[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
"USEVSSCOPYBACKUP"="TRUE"
```


Следующая таблица содержит типы целостности информации, их описания и условия соблюдения при архивации и восстановлении виртуальных машин Azure.

| Целостность | На основе VSS | Подробное объяснение |
| --- | --- | --- |
| Целостность на уровне приложения |Да |Идеально подходит для рабочих нагрузок Майкрософт, так как гарантирует следующее:<ol><li> Виртуальная машина *загружается*. <li>*Нет повреждений данных*. <li>*Нет потерь данных*.<li> Данные согласованы с приложением, которое их использует, за счет привлечения приложения во время резервного копирования (с помощью VSS).</ol> Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных. Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных.<br><br> Для архивации виртуальных машин Azure получение точки восстановления с согласованными данными означает, что расширение архивации имело возможность вызвать рабочий процесс VSS и *корректно* завершить его до выполнения моментального снимка ВМ. Естественно, это означает, что модули записи VSS всех приложений на виртуальной машине Azure были также вызваны.<br><br>(Ознакомьтесь с [основными сведениями о службе VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx) и подробными сведениями о [принципах ее работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)). |
| Согласованность файловой системы |Да — для компьютеров под управлением Windows |Существует два сценария, где точка восстановления может быть *согласованной с файловой системой*:<ul><li>резервное копирование виртуальных машин Linux в Azure, так как в Linux нет аналогичной платформы для VSS;<li>сбой VSS во время резервного копирования виртуальных машин Windows в Azure.</li></ul> В обоих случаях система делает все возможное, чтобы обеспечить следующее. <ol><li> Виртуальная машина *загружается*. <li>*Нет повреждений данных*.<li>*Нет потерь данных*.</ol> Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных. |
| Отказоустойчивость |Нет |Такая ситуация аналогична сбою виртуальной машины (приводит к программной или аппаратной перезагрузке). Обычно это происходит при выключении виртуальной машины Azure во время резервного копирования. Для архивации виртуальной машины Azure получение точки восстановления на момент аварийного завершения означает, что служба архивации Azure не дает никаких гарантий в отношении согласованности данных на носителе (даже с позиции операционной системы или с позиции приложения). Во время резервного копирования выполняется архивация только тех данных, которые уже существуют на диске. <br/> <br/> В большинстве случаев операционная система будет загружаться нормально, хотя это не гарантируется. Обычно загрузка сопровождается процедурой проверки диска (например chkdsk), предназначенной для устранения ошибок, связанных с его повреждением. Будут потеряны все данные, которые не были записаны на диск. В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки. <br><br>Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до согласованных данных. Если данные распределены между несколькими виртуальными дисками (например составные тома), отказоустойчивые точки восстановления не гарантируют правильность данных. |

## <a name="performance-and-resource-utilization"></a>Производительность и использование ресурсов
Как и при локальном резервном копировании, при резервном копировании виртуальных машин в Azure важно учитывать ограничения по производительности и использованию ресурсов. [Ограничения службы хранилища Azure](../azure-subscription-service-limits.md#storage-limits) определяют структуру развертывания виртуальных машин, обеспечивающую максимальную производительность и минимальное влияние на рабочие нагрузки.

При планировании производительности резервного копирования обратите внимание на следующие ограничения службы хранилища Azure.

* Максимальный объем исходящих данных на учетную запись хранения.
* Общая частота запросов на учетную запись хранения.

### <a name="storage-account-limits"></a>Ограничения учетной записи хранения
Данные резервного копирования, которые копируются из учетной записи хранения, учитываются в метриках числа операций ввода-вывода в секунду и исходящего трафика (пропускной способности хранилища) для этой учетной записи хранения. При этом виртуальные машины продолжают работу, выполняют операции ввода-вывода и используют пропускную способность. Важно, чтобы общий объем трафика (для резервного копирования и работы виртуальной машины) не превышал ограничений для учетной записи хранения.

### <a name="number-of-disks"></a>Количество дисков
Операция резервного копирования пытается выполнить соответствующее задание как можно быстрее. Поэтому она потребляет все доступные ресурсы. Тем не менее все операции ввода-вывода ограничены *целевой пропускной способностью для одного большого двоичного объекта*. Предельное значение пропускной способности составляет 60 МБ в секунду. Чтобы максимально ускорить процесс, операция резервного копирования пытается *параллельно* создавать резервные копии всех дисков виртуальной машины. Например, если у виртуальной машины четыре жестких диска, служба архивации Azure попробует создать резервные копии всех четырех дисков одновременно. Поэтому **количество дисков**, для которых создаются резервные копии из учетной записи хранения, — это основной фактор, определяющий объем трафика резервного копирования для этой учетной записи хранения.

### <a name="backup-schedule"></a>Расписание резервного копирования
На производительность влияет также **расписание архивации**. Если вы настроите политики так, чтобы резервное копирование всех виртуальных машин выполнялось в одно и то же время, это приведет к перегрузке. Операция резервного копирования будет пытаться одновременно создать резервные копии всех дисков сразу. Чтобы уменьшить трафик резервного копирования в рамках учетной записи хранения, резервное копирование для разных виртуальных машин следует полностью разнести во времени.

## <a name="capacity-planning"></a>Планирование загрузки
Если сложить все эти факторы, становится очевидно, что использование учетной записи хранения необходимо планировать должным образом. Скачайте [лист Excel по планированию производительности архивации виртуальных машин](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) , который позволит оценить влияние выбранного количества дисков и расписания архивации.

### <a name="backup-throughput"></a>Пропускная способность при резервном копировании
Для каждого диска, для которого создается резервная копия, служба архивации Azure считывает блоки на диске и сохраняет только измененные данные (добавочное резервное копирование). Эта таблица содержит средние значения пропускной способности, которые следует ожидать от службы архивации Azure. Используя эти значения, вы можете рассчитать время резервного копирования для диска заданного размера.

| Операция резервного копирования | Пропускная способность в лучшем случае |
| --- | --- |
| Начальное резервное копирование |160 Мбит/с |
| Добавочное резервное копирование (аварийное восстановление) |640 Мбит/с  <br><br> Пропускная способность может быть существенно ниже указанной, если нужно выполнить архивацию большого количества разрозненных данных. |

## <a name="total-vm-backup-time"></a>Общее время резервного копирования виртуальной машины
Больше всего времени занимают операции чтения и копирования данных, но есть и другие операции, которые влияют на общее время архивации виртуальной машины.

* Время на [установку или обновление расширения архивации](backup-azure-vms.md).
* Время создания моментального снимка, то есть время, необходимое для активации моментального снимка. Моментальные снимки активируются при приближении времени запланированной архивации.
* Время ожидания в очереди. Так как служба архивации обрабатывает резервные копии от нескольких пользователей, копирование резервных данных из моментального снимка в службу архивации или службу восстановления может начаться не сразу. В часы пиковой нагрузки время ожидания может достигать восьми часов из-за большого количества обрабатываемых резервных копий. Тем не менее общее время резервного копирования виртуальной машины будет менее 24 часов для политик ежедневного резервного копирования.

## <a name="total-restore-time"></a>Общее время восстановления
Операция восстановления состоит из двух основных подзадач: копирования данных из хранилища в выбранную пользовательскую учетную запись хранения и создания виртуальной машины. Копирование данных из хранилища зависит от места хранения резервных копий в Azure и пользовательской учетной записи хранения. Время, необходимое для копирования данных, зависит от следующих факторов:
* Время ожидания в очереди. Так как служба обрабатывает операции восстановления нескольких клиентов одновременно, запросы на восстановление помещаются в очередь.
* Время копирования данных. Как и при первой архивации, данные копируются из хранилища в пользовательскую учетную запись хранения. Если пользовательская учетная запись хранения, в которую службе архивации требуется записать данные из хранилища, загружена, время копирования может увеличиться. Таким образом, для оптимизации времени копирования выберите учетную запись, которая не загружена другими операциями чтения и записи приложения во время восстановления.

## <a name="best-practices"></a>Рекомендации
Ниже приведены рекомендации, которые следует учитывать при настройке резервного копирования виртуальных машин.

* Не планируйте одновременную архивацию более 10 классических виртуальных машин из одной облачной службы. Если необходимо настроить резервное копирование большего количества виртуальных машин из одной облачной службы, рекомендуем запускать такие задания с промежутком в один час.
* Не планируйте одновременную архивацию более 40 виртуальных машин.
* Планируйте резервное копирование виртуальных машин на периоды низкой нагрузки. Таким образом служба архивации выполнит достаточное количество операций ввода-вывода в секунду для передачи данных из учетной записи хранения клиента в хранилище службы архивации.
* Убедитесь, что политика применяется к виртуальным машинам, распределенным по нескольким учетным записям хранения. Мы рекомендуем не включать в одно расписание архивации более 20 дисков из одной учетной записи хранения. Если в вашей учетной записи хранения больше 20 дисков, разделите эти виртуальные машины между несколькими политиками. Так вы обеспечите достаточное количество операций ввода-вывода для этапа передачи данных при резервном копировании.
* Не выполняйте восстановление виртуальных машин, запущенных в хранилище класса Premium, в эту же учетную запись хранения. Если процесс восстановления совпадет по времени с операцией резервного копирования, это снизит количество операций ввода-вывода, доступных для резервного копирования.
* Мы рекомендуем запускать каждую виртуальную машину Premium на отдельной учетной записи хранения в хранилище класса Premium. Это позволит добиться оптимальной производительности резервного копирования.

## <a name="data-encryption"></a>Шифрование данных
Служба архивации Azure не шифрует данные при архивации. Однако вы можете шифровать данные в виртуальной машине и легко архивировать защищенные данные (узнайте больше об [архивации зашифрованных данных](backup-azure-vms-encryption.md)).

## <a name="how-are-protected-instances-calculated"></a>Как вычисляются защищенные экземпляры
Оплата архивации виртуальных машин с помощью службы архивации Azure выполняется в соответствии с [ценами на службу архивации Azure](https://azure.microsoft.com/pricing/details/backup/). Вычисление защищенных экземпляров основано на *фактическом* размере виртуальной машины, который представляет собой сумму всех данных на виртуальной машине за исключением "диска ресурсов".

Оплата зависит *не* от максимальных размеров всех дисков с данными, которые подключены к виртуальной машине, а от фактических данных, хранящихся на диске с данными. Аналогичным образом счет за хранилище службы архивации основан на объеме данных, хранящихся в службе архивации Azure, который представляет собой сумму фактических данных в каждой точке восстановления.

Например, возьмем виртуальную машину стандартного размера A2 с двумя дополнительными дисками максимальным объемом 1 ТБ каждый. В таблице ниже приводятся фактические данные, хранящиеся на каждом из этих дисков.

| Тип диска | Максимальный размер | Фактические данные |
| --- | --- | --- |
| Диск операционной системы |1023 ГБ |17 ГБ |
| Локальный диск или диск ресурсов |135 ГБ |5 ГБ (не учитывается для архивации) |
| Диск данных 1 |1023 ГБ |30 ГБ |
| Диск данных 2 |1023 ГБ |0 ГБ |

*Фактический* размер виртуальной машины в данном случае равен 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ. Этот показатель равен размеру защищенного экземпляра, на котором основывается ежемесячный счет. Если объем данных на виртуальной машине увеличивается, соответствующим образом изменяется размер защищенного экземпляра, используемый для тарификации услуг.

Оплачиваемый период начинается только после завершения первого успешного резервного копирования. На этом этапе начнется выставление счетов за хранение и защищенные экземпляры. Оплачиваемый период длится до тех пор, пока *служба архивации Azure хранит резервные копии данных* для виртуальной машины. Остановка защиты не останавливает выставление счетов, если резервная копия данных продолжает храниться.

Выставление счетов для определенной виртуальной машины будет остановлено, только если остановить защиту *и* удалить все резервные копии данных. Когда нет активных заданий резервного копирования (при остановке защиты), размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе чего выставляется ежемесячный счет.

## <a name="questions"></a>Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## <a name="next-steps"></a>Дальнейшие действия
* [Настройка виртуальных машин](backup-azure-vms.md)
* [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)
* [Восстановление виртуальных машин](backup-azure-restore-vms.md)
* [Устранение проблем с резервным копированием виртуальных машин](backup-azure-vms-troubleshoot.md)



<!--HONumber=Feb17_HO3-->


