---
title: "Резервное копирование и восстановление зашифрованных виртуальных машин с помощью службы архивации Azure"
description: "В этой статье приведены сведения о резервном копировании и восстановлении виртуальных машин, зашифрованных с помощью шифрования дисков Azure."
services: backup
documentationcenter: 
author: JPallavi
manager: vijayts
editor: 
ms.assetid: 8387f186-7d7b-400a-8fc3-88a85403ea63
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 09/18/2017
ms.author: pajosh;markgal;trinadhk
ms.custom: H1Hack27Feb2017
ms.translationtype: HT
ms.sourcegitcommit: 8f9234fe1f33625685b66e1d0e0024469f54f95c
ms.openlocfilehash: 3c0c13aebbf325bc1f03a39a456c8eef1551c64a
ms.contentlocale: ru-ru
ms.lasthandoff: 09/20/2017

---
# <a name="how-to-back-up-and-restore-encrypted-virtual-machines-with-azure-backup"></a>Архивация и восстановление зашифрованных виртуальных машин с помощью службы архивации Azure
В этой статье рассматриваются действия по резервному копированию и восстановлению виртуальных машин с помощью службы архивации Azure. Кроме того, здесь приведены поддерживаемые сценарии, предварительные требования и сведения об устранении неполадок при возникновении ошибок.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии использования.

 * Резервное копирование и восстановление зашифрованных виртуальных машин поддерживается только для виртуальных машин, развернутых с использованием Resource Manager. Этот сценарий не поддерживается для виртуальных машин, развернутых с помощью классической модели. <br>
 * Он поддерживается для виртуальных машин Windows и Linux, использующих шифрование дисков Azure, на которых для шифрования дисков применяются стандартные для отрасли функции: BitLocker в Windows или DM-Crypt в Linux. <br>
 * В приведенной ниже таблице приведены поддерживаемые сценарии для виртуальных машин, зашифрованных только с помощью ключа шифрования BitLocker (BEK) или ключа шифрования ключей (KEK).
 
 
   |  | Виртуальные машины BEK + KEK | Виртуальные машины, использующие только BEK |
   | --- | --- | --- |
   | **Неуправляемые виртуальные машины**  | Да | Да  |
   | **Управляемые виртуальные машины**  | Да | Нет  |

## <a name="prerequisites"></a>Предварительные требования
1. Виртуальная машина должна быть зашифрована с помощью [шифрования дисков Azure](../security/azure-security-disk-encryption.md). 
2. Создайте хранилище служб восстановления и настройте репликацию хранилища, следуя инструкциям в статье [Подготовка среды к архивации виртуальных машин, развернутых с помощью Resource Manager](backup-azure-arm-vms-prepare.md).
3. Службе архивации Azure предоставлены [разрешения на доступ к хранилищу ключей](#provide-permissions-to-azure-backup), содержащему ключи b секреты для зашифрованных виртуальных машин.

## <a name="backup-encrypted-vm"></a>Резервное копирование зашифрованных виртуальных машин
Выполните приведенные ниже действия, чтобы выбрать цель резервного копирования, определить политику, настроить элементы и активировать резервное копирование.

### <a name="configure-backup"></a>Настройка резервного копирования
1. Если хранилище служб восстановления уже открыто, перейдите к следующему шагу. Если хранилище служб восстановления не открыто, на портале Azure в главном меню щелкните **Обзор**.

   * В списке ресурсов введите **Службы восстановления**.
   * Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Когда появится пункт **Хранилища служб восстановления**, щелкните его.

      ![Создание хранилища служб восстановления — шаг 1](./media/backup-azure-vms-encryption/browse-to-rs-vaults.png) <br/>

     После этого отобразится список хранилищ служб восстановления, в котором нужно выбрать хранилище.

     Затем откроется панель мониторинга выбранного хранилища.
2. В открывшемся списке элементов хранилища щелкните **Резервное копирование**, чтобы начать резервное копирование зашифрованной виртуальной машины.

      ![Открытие колонки резервного копирования](./media/backup-azure-vms-encryption/select-backup.png)
3. Начните с выбора цели резервного копирования в разделе **Backup goal** (Цель резервного копирования).

      ![Открытие колонки сценария](./media/backup-azure-vms-encryption/select-backup-goal-one.png)
4. На первом шаге в этом разделе для параметра **Where is your workload running?** (Где выполняется рабочая нагрузка?) установите значение Azure, а для параметра **What do you want to backup,** (Что требуется архивировать?) — значение "Виртуальная машина", а затем нажмите кнопку **ОК**.

   Затем вы перейдете к следующему шагу выбора политики резервного копирования.

   ![Открытие колонки сценария](./media/backup-azure-vms-encryption/select-backup-goal-two.png)
5. На втором шаге выбора политики выберите политику резервного копирования, которую вы хотите применить к хранилищу, и нажмите кнопку **OK**.

      ![Выбор политики резервного копирования](./media/backup-azure-vms-encryption/setting-rs-backup-policy-new.png)

    Подробные сведения о политике по умолчанию указаны в области сведений. Если вы хотите создать политику, в раскрывающемся меню выберите **Создать**. Как только вы нажмете кнопку **ОК**, политика резервного копирования будет связана с хранилищем.

    Теперь нужно выбрать виртуальные машины, которые нужно связать с хранилищем.
6. Выберите зашифрованные виртуальные машины, чтобы связать их с указанной политикой, и нажмите кнопку **OК**.

      ![Выбор зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/selected-encrypted-vms.png)
7. На этой странице приведены сведения о хранилище ключей, связанном с выбранными зашифрованными виртуальными машинами. Для службы архивации требуется доступ только для чтения к ключам и секретам в хранилище ключей. Она использует эти разрешения, чтобы создать резервную копию ключа и секрета, а также связанных виртуальных машин. **Необходимо предоставить службе архивации разрешения для доступа к хранилищу ключей (для выполнения архивации)**. Это можно сделать, выполнив [действия, описанные в разделе ниже](#provide-permissions-to-azure-backup).

      ![Сообщение для зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/encrypted-vm-warning-message.png)

      Теперь, когда все параметры для хранилища заданы, в нижней части страницы нажмите кнопку "Включить резервное копирование". После этого для хранилища и виртуальных машин будет развернута политика.
8. На следующем шаге подготовки нужно установить агент виртуальной машины или убедиться, что он установлен. Для этого используйте действия, описанные в статье [Подготовка среды к архивации виртуальных машин, развернутых с помощью Resource Manager](backup-azure-arm-vms-prepare.md).

### <a name="triggering-backup-job"></a>Активация задания резервного копирования
Чтобы активировать задание резервного копирования, выполните действия, описанные в статье [Резервное копирование виртуальных машин Azure в хранилище служб восстановления](backup-azure-arm-vms.md).

### <a name="continue-backups-of-already-backed-up-vms-with-encryption-enabled"></a>Продолжение архивации уже архивированных виртуальных машин с включенным шифрованием  
Если у вас есть виртуальные машины, которые уже архивируются в хранилище служб восстановления и разрешены для дальнейшего шифрования, нужно предоставить службе архивации разрешения на доступ к хранилищу ключей, чтобы архивация продолжилась. Вы можете предоставить такие разрешения, выполнив [действия, описанные в разделе ниже](#provide-permissions-to-azure-backup), или в PowerShell с помощью действий, описанных в инструкциях по **включению архивации** в [документации по PowerShell](backup-azure-vms-automation.md). 

## <a name="provide-permissions-to-azure-backup"></a>Предоставление разрешений для Azure Backup
Чтобы предоставить Azure Backup соответствующие разрешения для доступа к хранилищу ключей и архивации зашифрованных виртуальных машин, выполните следующие действия:
1. Выберите **Больше служб** и найдите **хранилища ключей**.

    ![Поиск хранилища ключей](./media/backup-azure-vms-encryption/search-key-vault.png)
    
2. В списке хранилищ ключей выберите хранилище ключей, связанное с зашифрованной виртуальной машиной, которую требуется архивировать.

     ![Выбор хранилище ключей](./media/backup-azure-vms-encryption/select-key-vault.png)
     
3. Щелкните **Политики доступа** и **Добавить**.

    ![Добавление политики доступа](./media/backup-azure-vms-encryption/select-key-vault-access-policy.png)
    
4. Щелкните **Выбор субъекта** и в поле поиска введите **служба управления архивацией**. 

    ![Поиск службы архивации](./media/backup-azure-vms-encryption/search-backup-service.png)
    
5. Выберите **службу управления архивацией** и нажмите кнопку "Выбрать".

    ![Выбор службы архивации](./media/backup-azure-vms-encryption/select-backup-service.png)
    
6. В раскрывающемся списке Configure from template (Настроить на основе шаблона) Выберите **Служба архивации Azure**. После этого предварительно указываются необходимые разрешения в раскрывающихся списках "Разрешения ключей" и "Разрешения секретов". Если виртуальная машина зашифрована с использованием **только BEK**, необходимо отменить выбор разрешений для ключей, так как разрешения требуются только для секретов.

    ![Выбор службы Azure Backup](./media/backup-azure-vms-encryption/select-backup-template.png)
    
7. Нажмите кнопку **ОК**. Обратите внимание, что в колонке "Политики доступа" добавлена служба управления архивацией. 

    ![Служба архивации в колонке "Политики доступа"](./media/backup-azure-vms-encryption/backup-service-access-policy.png)
    
8. Щелкните **Сохранить**. Таким образом Azure Backup получит необходимые разрешения.

    ![Служба архивации в колонке "Политики доступа"](./media/backup-azure-vms-encryption/save-access-policy.png)

После предоставления разрешений можно приступить к включению архивации для зашифрованных виртуальных машин.

## <a name="restore-encrypted-vm"></a>Восстановление зашифрованных виртуальных машин
Чтобы восстановить зашифрованную виртуальную машину, сначала восстановите диски, выполнив инструкции по **восстановлению заархивированных дисков** в разделе [Выбор конфигурации восстановления для виртуальной машины](backup-azure-arm-restore-vms.md#choosing-a-vm-restore-configuration). После этого можно выбрать один из следующих вариантов:
* Выполните команды PowerShell, описанные в разделе [Создание виртуальной машины с восстановленного диска](backup-azure-vms-automation.md#create-a-vm-from-restored-disks), чтобы создать полную виртуальную машину из восстановленных дисков.
* ИЛИ [используйте шаблон, создаваемый в рамках восстановления дисков](backup-azure-arm-restore-vms.md#use-templates-to-customize-restore-vm), чтобы создать виртуальные машины из восстановленных дисков. Шаблоны можно использовать только для точек восстановления, созданных после 26 апреля 2017 г.

## <a name="troubleshooting-errors"></a>Устранение ошибок
| Операция | Сведения об ошибке | Способы устранения: |
| --- | --- | --- |
|Резервное копирование | У службы Azure Backup недостаточно прав для Key Vault, чтобы архивировать зашифрованные виртуальные машины. | При этом виртуальная машина должна быть зашифрована с помощью как ключа шифрования BitLocker, так и ключа шифрования ключей. После этого резервное копирование должно выполняться.  Для выполнения [действий из раздела выше](#provide-permissions-to-azure-backup) или действий из раздела о **включении защиты** в документации по PowerShell при работе со статьей [Архивация виртуальных машин с помощью командлетов AzureRM.RecoveryServices.Backup](backup-azure-vms-automation.md#back-up-azure-vms) нужно предоставить службе архивации подобные разрешения в PowerShell. |  
| Резервное копирование |Проверка не пройдена, так как виртуальная машина зашифрована только с помощью BEK. Резервное копирование поддерживается только для виртуальных машин, зашифрованных с использованием BEK и KEK. |Виртуальная машина должна быть зашифрована с помощью BEK и KEK. Сначала расшифруйте виртуальную машину и зашифруйте ее с помощью ключа массового шифрования и ключа шифрования ключей. После этого включите архивацию. Дополнительные сведения см. в статье [Дисковое шифрование Azure для виртуальных машин Iaas под управлением Windows и Linux](../security/azure-security-disk-encryption.md)  |
| Восстановление |Вы не можете восстановить эту виртуальную машину, так как с ней не связано хранилище ключей. |Создайте хранилище ключей с помощью действий, описанных в статье [Приступая к работе с хранилищем ключей Azure](../key-vault/key-vault-get-started.md). Дополнительные сведения о восстановлении ключа и секрета см. в статье [Restore key vault key and secret using Azure Backup](backup-azure-restore-key-secret.md) (Восстановление ключа и секрета хранилища ключей с помощью службы архивации Azure). |
| Восстановление |Вы не можете восстановить виртуальную машину, так как с ней не связаны ключ и секрет. |Дополнительные сведения о восстановлении ключа и секрета см. в статье [Restore key vault key and secret using Azure Backup](backup-azure-restore-key-secret.md) (Восстановление ключа и секрета хранилища ключей с помощью службы архивации Azure). |
| восстановление; |У службы архивации нет разрешения на доступ к ресурсам в вашей подписке. |Как было сказано выше, сначала восстановите диски, выполнив инструкции по **восстановлению заархивированных дисков** в разделе [Выбор конфигурации восстановления для виртуальной машины](backup-azure-arm-restore-vms.md#choosing-a-vm-restore-configuration). После этого с помощью PowerShell [создайте виртуальную машину из восстановленного диска](backup-azure-vms-automation.md#create-a-vm-from-restored-disks). |


