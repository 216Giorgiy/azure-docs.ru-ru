---
title: Резервное копирование баз данных SQL Server в Azure | Документация Майкрософт
description: Узнайте, как выполнить резервное копирование SQL Server в Azure. Здесь также описывается восстановление SQL Server.
services: backup
documentationcenter: ''
author: markgalioto
manager: carmonm
editor: ''
keywords: ''
ms.assetid: ''
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 7/19/2018
ms.author: markgal;anuragm
ms.custom: ''
ms.openlocfilehash: 3d19b42e339e9776d0fdbbf7cfcfba07d69549ad
ms.sourcegitcommit: 156364c3363f651509a17d1d61cf8480aaf72d1a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/25/2018
ms.locfileid: "39249086"
---
# <a name="back-up-sql-server-databases-to-azure"></a>Резервное копирование баз данных SQL Server в Azure

Базы данных SQL Server являются критическими рабочими нагрузками, требующими низкой целевой точки восстановления (RPO) и долгосрочного хранения. Azure Backup предоставляет решение резервного копирования SQL Server, требующее нулевой инфраструктуры. Это означает отсутствие управления сложным сервером резервного копирования, агентом управления или хранилищем резервных копий. Azure Backup обеспечивает централизованное управление резервными копиями на всех серверах, на которых выполняется SQL Server или даже разные рабочие нагрузки.

В этой статье раскрываются следующие темы.

> [!div class="checklist"]
> * Предварительные требования для резервного копирования экземпляра SQL Server в Azure.
> * Создание и использование хранилища служб восстановления.
> * Настройка резервного копирования базы данных SQL Server.
> * Установка политики резервного копирования (или хранения) для точек восстановления.
> * Восстановление базы данных.

Для выполнения процедур из этой статьи необходим сервер SQL Server, работающий в Azure. [Используйте виртуальные машины SQL в marketplace, чтобы быстро создать экземпляр SQL Server](../sql-database/sql-database-get-started-portal.md).

## <a name="public-preview-limitations"></a>Ограничения общедоступной предварительной версии

Следующие пункты являются известными ограничениями для общедоступной предварительной версии.

- Виртуальной машине SQL требуется подключение к Интернету для доступа к общедоступным IP-адресам Azure. Дополнительные сведения см. в разделе [Установка сетевого подключения](backup-azure-sql-database.md#establish-network-connectivity).
- В одном хранилище служб восстановления можно защитить до 2000 баз данных SQL. Дополнительные базы данных SQL должны храниться в отдельном хранилище служб восстановления.
- [Резервное копирование распределенных групп доступности](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/distributed-availability-groups?view=sql-server-2017) имеет ограничения.
- Экземпляры отказоустойчивого кластера SQL Server Always On не поддерживаются.
- Чтобы настроить Azure Backup для защиты баз данных SQL Server, используйте портал Azure. Azure PowerShell, Azure CLI и интерфейсы REST API сейчас не поддерживаются.

## <a name="support-for-azure-geos"></a>Поддержка геообъектов Azure

Azure Backup поддерживается для следующих геообъектов:

- Юго-Восточная Австралия (ASE). 
- Южная Бразилия (BRS).
- Центральная Канада (CNC).
- Восточная Канада (CE).
- Центральная часть США (CUS).
- Восточная Азия (EA).
- Восточная Австралия (AE). 
- Восточная часть США (EUS).
- Восточная часть США 2 (EUS2).
- Центральная Индия (INC). 
- Южная Индия (INS);
- Восточная Япония (JPE);
- Западная Япония (JPW);
- Республика Корея, центральный регион (KRC)
- Южная Корея (KRS);
- Северо-центральный регион США (NCUS). 
- Северная Европа (NE). 
- Юго-центральный регион США (SCUS). 
- Юго-Восточная Азия (SEA).
- Южная часть Соединенного Королевства (UKS). 
- Западная часть Соединенного Королевства (UKW). 
- Западно-центральная часть США (WCUS).
- Западная Европа (WE). 
- Западная часть США (WUS).
- Западная часть США 2 (WUS 2). 

## <a name="support-for-operating-systems-and-sql-server-versions"></a>Поддержка операционных систем и версий SQL Server

В этом разделе описывается поддержка операционных систем и версий SQL Server в Azure Backup. Поддерживаются виртуальные машины SQL из Azure Marketplace и виртуальные машины не из marketplace (с установленным вручную сервером SQL Server).

### <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

- Windows Server 2012
- Windows Server 2012 R2
- Windows Server 2016

Linux в настоящее время не поддерживается.

### <a name="supported-sql-server-versions-and-editions"></a>Поддерживаемые версии и выпуски SQL Server

- SQL Server 2012 Enterprise, SQL Server 2012 Standard, SQL Server 2012 Web, SQL Server 2012 Developer, SQL Server 2012 Express.
- SQL Server 2014 Enterprise, SQL Server 2014 Standard, SQL Server 2014 Web, SQL Server 2014 Developer, SQL Server 2014 Express.
- SQL Server 2016 Enterprise, SQL Server 2016 Standard, SQL Server 2016 Web, SQL Server 2016 Developer, SQL Server 2016 Express.
- SQL Server 2017 Enterprise, SQL Server 2017 Standard, SQL Server 2017 Web, SQL Server 2017 Developer, SQL Server 2017 Express.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем создавать резервную копию базы данных SQL Server, проверьте следующие условия.

- Определите или [создайте хранилище служб восстановления](backup-azure-sql-database.md#create-a-recovery-services-vault), выбрав тот же регион или языковый стандарт, что и у экземпляра SQL Server.
- [Проверьте разрешения на виртуальную машину](backup-azure-sql-database.md#set-permissions-for-non-marketplace-sql-vms), необходимые для создания резервных копий баз данных SQL.
- Проверьте, [имеет ли виртуальная машина SQL сетевое подключение](backup-azure-sql-database.md#establish-network-connectivity).

> [!NOTE]
> Для резервного копирования баз данных SQL Server одновременно может использоваться только одно решение резервного копирования. Отключите все другие операции резервного копирования SQL, прежде чем использовать эту функцию. В противном случае операции резервного копирования помешают друг другу и произойдет сбой. Без конфликтов можно включить Azure Backup для виртуальной машины IaaS с резервным копированием SQL.
>

Если эти условия в вашей среде выполнены, перейдите к [настройке резервного копирования баз данных SQL Server](backup-azure-sql-database.md#configure-backup-for-sql-server-databases). Если какие-либо предварительные условий не выполнены, продолжайте читать этот раздел.


## <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций виртуальной машине SQL требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины SQL (такие как обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения к общедоступным IP-адресам. Используйте один из следующих параметров для обеспечения свободного пути для трафика резервного копирования.

- Список разрешенных диапазонов IP-адресов центра обработки данных Azure. Для добавления диапазонов IP-адресов центра обработки данных Azure в список разрешений, используйте [страницу Центра загрузки для получения подробной информации о диапазонах IP-адресов и инструкций](https://www.microsoft.com/download/details.aspx?id=41653). 
- Развертывание прокси-сервера HTTP для маршрутизации трафика. Когда выполняется резервное копирование базы данных SQL на виртуальной машине, расширение резервного копирования на виртуальной машине использует программный интерфейс HTTPS для отправки команд управления к Azure Backup, а данных — в службу хранилища Azure. Расширение резервного копирования также использует Azure Active Directory (Azure AD) для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширение — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Возможны следующие варианты для компромисса: управляемость, высокий уровень контроля и затраты.

> [!NOTE]
> Теги служб для Azure Backup должны быть доступны по общей доступности.
>

| Параметр | Преимущества | Недостатки |
| ------ | ---------- | ------------- |
| Разрешенные диапазоны IP-адресов | Нет дополнительных затрат. <br/> Открыть доступ в NSG можно с помощью командлета **Set-AzureNetworkSecurityRule**. | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются. <br/>Доступ ко всей службе Azure, а не только к службе хранилища Azure.|
| Использование прокси-сервера HTTP   | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере. <br/>Единая точка доступа к виртуальным машинам через Интернет. <br/> Не подвергается влиянию изменений IP-адресов Azure. | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера. |

## <a name="set-permissions-for-non-marketplace-sql-vms"></a>Установка разрешений для виртуальных машин SQL не из marketplace

Azure Backup требуется установка расширения **AzureBackupWindowsWorkload** для резервного копирования виртуальной машины. Если используются виртуальные машины Azure Marketplace, перейдите к разделу [Обнаружение базы данных SQL Server](backup-azure-sql-database.md#discover-sql-server-databases). Если виртуальная машина, на которой размещены базы данных SQL, не была создана посредством Azure Marketplace, выполните приведенную ниже процедуру, чтобы установить расширение и задать соответствующие разрешения. В дополнение к расширению **AzureBackupWindowsWorkload** для Azure Backup требуются разрешения sysadmin SQL для защиты баз данных SQL. При обнаружении баз данных на виртуальной машине Azure Backup создает учетную запись **NT Service\AzureWLBackupPluginSvc**. Чтобы служба Azure Backup обнаруживала базы данных SQL, учетная запись **NT Service\AzureWLBackupPluginSvc** должна иметь разрешения SQL и sysadmin SQL. Следующая процедура объясняет, как предоставить эти разрешения.

Настройка разрешений

1. На [портале Azure](https://portal.azure.com) откройте хранилище служб восстановления, которое используется для защиты баз данных SQL.

2. На панели мониторинга **Хранилища служб восстановления** выберите **Архивация**. Откроется меню **Цель резервного копирования	**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В меню **Цель резервного копирования** для параметра **Where is your workload running** (Где выполняется рабочая нагрузка) задайте значение **Azure**.

4. Разверните раскрывающийся список **What do you want to backup** (Для чего требуется создать резервную копию) и выберите **SQL Server in Azure VM** (SQL Server на виртуальной машине Azure).

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

    В меню **Цель резервного копирования** отображаются два шага: **Discover DBs in VMs** (Обнаружить базы данных на виртуальных машинах) и **Настройка архивации**. Шаг **Discover DBs in VMs** (Обнаружить базы данных на виртуальных машинах) позволяет запустить поиск виртуальных машин Azure.

    ![Просмотр двух шагов в меню "Цель резервного копирования"](./media/backup-azure-sql-database/backup-goal-menu-step-one.png)

5. Для поиска незащищенных виртуальных машин в подписке в разделе **Discover DBs in VMs** (Обнаружить базы данных на виртуальных машинах) выберите **Начать обнаружение**. Для поиска всех виртуальных машин может потребоваться некоторое время. Время поиска зависит от числа незащищенных виртуальных машин в подписке.

    ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)
 
    Как только незащищенная виртуальная машина будет обнаружена, она появится в списке. Незащищенные виртуальные машины перечислены по именах и группах ресурсов. Возможно, что некоторые виртуальные машины имеют одно и то же имя. Однако виртуальные машины с одинаковыми именами относятся к различным группам ресурсов. Если ожидаемая виртуальная машина не отображается в списке, возможно, она уже защищена в хранилище.

6. Из списка виртуальных машин выберите виртуальную машину, содержащую базу данных SQL, для которой необходимо создать резервную копию, и щелкните **Обнаружить базы данных**. 

    Процесс обнаружения устанавливает на виртуальной машине расширение **AzureBackupWindowsWorkload**. Расширение позволяет службе Azure Backup взаимодействовать с виртуальной машиной, чтобы она могла создавать резервные копии баз данных SQL. После установки расширения Azure Backup создаст на виртуальной машине учетную запись виртуальной службы Windows — **NT Service\AzureWLBackupPluginSvc**. Для учетной записи виртуальной службы требуется разрешение sysadmin SQL. Если во время установки учетной записи виртуальной службы появилось сообщение об ошибке `UserErrorSQLNoSysadminMembership`, ознакомьтесь с разделом [Исправление разрешений sysadmin SQL](backup-azure-sql-database.md#fix-sql-sysadmin-permissions).

    В области **Уведомления** отображается ход обнаружения баз данных. Выполнение этого задания может занять некоторое время. Время выполнения задания зависит от того, сколько баз данных размещено на виртуальной машине. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

После связывания базы данных с хранилищем служб восстановления следующим шагом является [настройка задания резервного копирования](backup-azure-sql-database.md#configure-backup-for-sql-server-databases).

### <a name="fix-sql-sysadmin-permissions"></a>Исправление разрешений sysadmin SQL

При возникновении ошибки во время процесса установки `UserErrorSQLNoSysadminMembership` войдите в SQL Server Management Studio (SSMS) с учетной записью, имеющей разрешение sysadmin SQL Server. Если вам не требуются специальные разрешения, можно использовать проверку подлинности Windows.

1. На сервере SQL Server последовательно откройте папку "Безопасность/Имена для входа".

    ![Открытие папки "Безопасность/Имена для входа" для просмотра учетных записей](./media/backup-azure-sql-database/security-login-list.png)

2. Щелкните правой кнопкой мыши папку "Имена для входа" и выберите **Создать имя для входа**. В диалоговом окне **Login - New** (Создание имени для входа) выберите **Найти**.

    ![Выбор "Найти" в диалоговом окне "Login - New" (Создание имени для входа)](./media/backup-azure-sql-database/new-login-search.png)

3. Учетная запись виртуальной службы Windows **NT Service\AzureWLBackupPluginSvc** была создана во время регистрации виртуальной машины и обнаружения баз данных SQL. Введите имя учетной записи, как показано в поле **Enter the object name to select** (Введите имя выбираемого объекта). Выберите **Проверить имена**, чтобы разрешить имя. 

    ![Выбор "Проверить имена" для разрешения имени неизвестной службы](./media/backup-azure-sql-database/check-name.png)

4. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.

5. В диалоговом окне **Роли сервера** убедитесь, что выбрана роль **sysadmin**. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.

    ![Убедитесь, что для сервера выбрана роль sysadmin.](./media/backup-azure-sql-database/sysadmin-server-role.png)

    Теперь должны существовать необходимые разрешения.

6. Хотя ошибка разрешений устранена, по-прежнему необходимо связать базу данных с хранилищем служб восстановления. В списке **Защищенные серверы** на портале Azure щелкните правой кнопкой мыши сервер, на котором произошла ошибка, и выберите **Повторно обнаружить базы данных**.

    ![Проверка наличия у сервера соответствующих разрешений](./media/backup-azure-sql-database/check-erroneous-server.png)

    В области **Уведомления** отображается ход обнаружения баз данных. Выполнение этого задания может занять некоторое время. Время выполнения задания зависит от того, сколько баз данных размещено на виртуальной машине. Когда выбранные базы данных будут найдены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

После связывания базы данных с хранилищем служб восстановления следующим шагом является [настройка задания резервного копирования](backup-azure-sql-database.md#configure-backup-for-sql-server-databases).

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Azure Backup обнаруживает все базы данных на экземпляре SQL Server. Вы можете защитить базы данных в соответствии с требованиями к резервному копированию. Используйте следующую процедуру для определения виртуальной машины, на которой размещены базы данных SQL. После определения этой виртуальной машины Azure Backup установит упрощенное расширение для обнаружения баз данных SQL Server.

1. Войдите в подписку на [портале Azure](https://portal.azure.com/).

2. В меню слева выберите **Все службы**.

    ![Выбор "Все службы"](./media/backup-azure-sql-database/click-all-services.png) <br/>

3. В диалоговом окне **Все службы** введите **Службы восстановления**. По мере ввода фильтруется список ресурсов. Выберите **Хранилища служб восстановления** из списка.

    ![Ввод и выбор "Хранилища служб восстановления"](./media/backup-azure-sql-database/all-services.png) <br/>

    После этого отобразится список хранилищ служб восстановления в подписке. 

4. Из списка хранилищ служб восстановления выберите хранилище, которое необходимо использовать для защиты баз данных SQL.

5. На панели мониторинга **Хранилища служб восстановления** выберите **Архивация**. Откроется меню **Цель резервного копирования	**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

6. В меню **Цель резервного копирования** для параметра **Where is your workload running** (Где выполняется рабочая нагрузка) задайте значение **Azure**.

7. Разверните раскрывающийся список **What do you want to backup** (Для чего требуется создать резервную копию) и выберите **SQL Server in Azure VM** (SQL Server на виртуальной машине Azure).

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

    В меню **Цель резервного копирования** отображаются два шага: **Discover DBs in VMs** (Обнаружить базы данных на виртуальных машинах) и **Настройка архивации**.
    
    ![Просмотр двух шагов в меню "Цель резервного копирования"](./media/backup-azure-sql-database/backup-goal-menu-step-one.png)

8. Для поиска незащищенных виртуальных машин в подписке в разделе **Discover DBs in VMs** (Обнаружить базы данных на виртуальных машинах) выберите **Начать обнаружение**. Для поиска всех виртуальных машин может потребоваться некоторое время. Время поиска зависит от числа незащищенных виртуальных машин в подписке.

    ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)
 
    Как только незащищенная виртуальная машина будет обнаружена, она появится в списке. Некоторые виртуальные машины могут иметь одно и то же имя. Однако виртуальные машины с одинаковыми именами относятся к различным группам ресурсов. Незащищенные виртуальные машины перечислены по именах и группах ресурсов. Если ожидаемая виртуальная машина не отображается в списке, возможно, она уже защищена в хранилище.

9. Из списка виртуальных машин выберите виртуальную машину, содержащую базу данных SQL, для которой необходимо создать резервную копию, и щелкните **Обнаружить базы данных**.

    Azure Backup обнаруживает все базы данных SQL на виртуальной машине. Сведения о том, что происходит на этапе обнаружения баз данных, см. в разделе [Фоновые операции](backup-azure-sql-database.md#background-operations). После обнаружения баз данных SQL можно приступать к [настройке задания резервного копирования](backup-azure-sql-database.md#configure-backup-for-sql-server-databases).

### <a name="background-operations"></a>Фоновые операции

При использовании средства **Обнаружить базы данных** Azure Backup выполняет следующие операции в фоновом режиме.

- Регистрирует виртуальную машину в хранилище служб восстановления для резервного копирования рабочей нагрузки. Все базы данных на зарегистрированной виртуальной машине могут использовать только это хранилище служб восстановления для резервного копирования. 

- Устанавливает на виртуальной машине расширение **AzureBackupWindowsWorkload**. Для резервного копирования базы данных SQL не используется агент. Расширение устанавливается на виртуальной машине, а в базе данных SQL не устанавливается какой-либо агент.

- Создает на виртуальной машине учетную запись службы **NT Service\AzureWLBackupPluginSvc**. Все операции резервного копирования и восстановления используют учетную запись службы. Учетной записи **NT Service\AzureWLBackupPluginSvc** необходимы разрешения sysadmin SQL. Все виртуальные машины SQL из marketplace поставляются с установленным расширением **SqlIaaSExtension**. Расширение **AzureBackupWindowsWorkload** использует **SQLIaaSExtension** для автоматического получения необходимых разрешений. Если на виртуальной машине не установлено расширение **SqlIaaSExtension**, операция обнаружения баз данных завершится сбоем и появится сообщение об ошибке `UserErrorSQLNoSysAdminMembership`. Чтобы добавить разрешение sysadmin для резервного копирования, следуйте инструкциям из раздела [Установка разрешений для виртуальных машин SQL не из marketplace](backup-azure-sql-database.md#set-permissions-for-non-marketplace-sql-vms).

    ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup-for-sql-server-databases"></a>Настройка резервного копирования для баз данных SQL Server 

Azure Backup предоставляет службы управления для защиты баз данных SQL Server и управления заданиями резервного копирования. Функции управления и мониторинга зависят от хранилища служб восстановления. 

> [!NOTE]
> Для резервного копирования баз данных SQL Server одновременно может использоваться только одно решение резервного копирования. Отключите все другие операции резервного копирования SQL, прежде чем использовать эту функцию. В противном случае операции резервного копирования помешают друг другу и произойдет сбой. Без конфликтов можно включить Azure Backup для виртуальной машины IaaS с резервным копированием SQL.
>

Чтобы настроить защиту для базы данных SQL, выполните следующие действия.

1. Откройте хранилище служб восстановления, в котором зарегистрирована виртуальная машина SQL.

2. На панели мониторинга **Хранилища служб восстановления** выберите **Архивация**. Откроется меню **Цель резервного копирования	**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В меню **Цель резервного копирования** для параметра **Where is your workload running** (Где выполняется рабочая нагрузка) задайте значение **Azure**.

4. Разверните раскрывающийся список **What do you want to backup** (Для чего требуется создать резервную копию) и выберите **SQL Server in Azure VM** (SQL Server на виртуальной машине Azure).

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

    В меню **Цель резервного копирования** отображаются два шага: **Discover DBs in VMs** (Обнаружить базы данных на виртуальных машинах) и **Настройка архивации**.
    
    Если вы выполнили действия в этой статье по порядку, то уже обнаружили незащищенные виртуальные машины и это хранилище, в котором зарегистрирована виртуальная машина. Теперь все готово, чтобы настроить защиту для баз данных SQL.
    
5. В меню **Цель резервного копирования** выберите **Настройка архивации**.

    ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

    Служба Azure Backup отображает все экземпляры SQL с изолированными базами данных, а также группы доступности SQL Always On. Чтобы просмотреть изолированные базы данных в экземпляре SQL Server, щелкните значок шеврона слева от имени этого экземпляра. На следующих рисунках показаны примеры изолированного экземпляра и группы доступности Always On.

    > [!NOTE]
    > Для группы доступности SQL Always On используются параметры резервного копирования SQL. Но в связи с ограничениями платформы SQL полные и разностные резервные копии создаются с основного узла. Ведение журнала резервного копирования выполняется с соответствии с установленными параметрами. Из-за этого ограничения для групп доступности всегда должен быть зарегистрирован основной узел.
    >

    ![Список баз данных в экземпляре SQL](./media/backup-azure-sql-database/discovered-databases.png)

    Щелкните значок шеврона слева от группы доступности AlwaysOn, чтобы просмотреть список баз данных.

    ![Список баз данных в группе доступности Always On](./media/backup-azure-sql-database/discovered-database-availability-group.png)

6. Из списка баз данных выберите все базы данных, которые нужно защитить, а затем нажмите кнопку **ОК**.

    ![Выбор нескольких баз данных для защиты](./media/backup-azure-sql-database/select-multiple-database-protection.png)

    За один раз можно выбрать до 50 баз данных. Если необходимо защитить более 50 баз данных, сделайте это в несколько этапов. После защиты первых 50 баз данных повторите этот шаг для защиты следующего набора баз данных.

    > [!Note] 
    > Для оптимизации нагрузки резервных копий Azure Backup разбивает большие задания резервного копирования на несколько пакетов. Максимальное количество баз данных в одном задании резервного копирования — 50.
    >
    >

7. Чтобы создать или выбрать политику резервного копирования, в меню **Архивация** выберите **Политика архивации**. Откроется меню **Политика архивации**.

    ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

8. Из раскрывающегося меню **Выберите политику архивации** выберите политику резервного копирования и нажмите кнопку **ОК**. Сведения о том, как создать политику резервного копирования, см. в разделе [Определение политики резервного копирования](backup-azure-sql-database.md#define-a-backup-policy).

    ![Выбор политики резервного копирования из списка](./media/backup-azure-sql-database/select-backup-policy-steptwo.png)

    В меню **Политика архивации** из раскрывающегося списка **Выберите политику архивации** можно: 
    - выбрать политику по умолчанию: **HourlyLogBackup**;
    - выбрать существующую политику резервного копирования, созданную ранее для SQL;
    - [определить новую политику](backup-azure-sql-database.md#define-a-backup-policy) на основе целевой точки восстановления (RPO) и периода хранения. 

    > [!Note]
    > Azure Backup поддерживает долгосрочное хранение, основанное на схеме резервного копирования "дед-отец-сын". Эта схема оптимизирует потребление ресурсов внутреннего хранилища при соблюдении требований к соответствию.
    >

9. После выбора политики резервного копирования в меню **Архивация** выберите **Включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

    В области **Уведомления** портала можно отслеживать ход настройки.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)


### <a name="define-a-backup-policy"></a>Определение политики резервного копирования

Политика резервного копирования определяет матрицу условий для выполнения резервного копирования и длительности хранения резервных копий. Azure Backup можно использовать для планирования трех типов резервного копирования баз данных SQL.

* Полная резервная копия. При этом типе резервного копирования создается резервная копия всей базы данных. Полная резервная копия содержит все данные в определенной базе данных или набор файлов или файловых групп и журнала для восстановления этих данных. Максимально в день можно активировать одну полную резервную копию. Для создания полной резервной копии можно выбрать ежедневный или еженедельный интервал. 
* Разностная резервная копия. Разностная резервная копия основывается на последней предшествующей полной резервной копии данных. Разностная резервная копия содержит только данные, которые были изменены с момента создания полной резервной копии. Максимально в день можно активировать одну разностную резервную копию. Невозможно настроить создание полной и разностной резервных копий в один день.
* Резервная копия журнала транзакций. Резервная копия журнала дает возможность восстановления на определенный момент времени с точностью до секунды. Максимально каждые 15 минут можно настраивать резервные копии журналов транзакций.

Политика создается на уровне хранилища служб восстановления. Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу. При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование. Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование. Следующая процедура объясняет, как создать политику резервного копирования для экземпляра SQL Server на виртуальной машине Azure.

Чтобы создать политику резервного копирования, выполните следующее.

1. В меню **Политика архивации** из раскрывающегося списка **Выберите политику архивации** выберите **Создать**.

   ![Создание политики резервного копирования](./media/backup-azure-sql-database/create-new-backup-policy.png)

    В меню **Политика архивации** отображаются поля, необходимые для новой политики резервного копирования SQL Server.

   ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/blank-new-policy.png)

2. В поле **Имя политики** введите имя.

3. Полное резервное копирование является обязательным. Для выбора полного резервного копирования можно принять значения по умолчанию или нажать кнопку **Полная резервная копия**, чтобы изменить политику.

    ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)

    В меню **Full Backup policy** (Политика полного резервного копирования) для параметра **Частота архивации** выберите **Ежедневно** или **Еженедельно**. Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования. При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.

   ![Параметр интервала "Ежедневно"](./media/backup-azure-sql-database/daily-interval.png)

    Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.

   ![Параметр интервала "Еженедельно"](./media/backup-azure-sql-database/weekly-interval.png)

4. По умолчанию выбраны все параметры **Диапазон хранения** ("Ежедневно", "Еженедельно", "Ежемесячно" и "Ежегодно"). Отмените выбор ограничений диапазона, которые не требуются. Установите соответствующие интервалы. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.

   ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

    Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии. Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром недельного хранения. Месячный и годовой диапазоны хранения действуют аналогичным образом.

5. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**. Откроется меню **Differential Backup policy** (Политика разностного резервного копирования). 

   ![Открытие меню "Differential Backup policy" (Политика разностного резервного копирования)](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

    В меню **Differential Backup policy** (Политика разностного резервного копирования) выберите **Включить**, чтобы открыть элементы управления периодичность и хранением. Максимально в день можно активировать одну разностную резервную копию.
    
    > [!Important] 
    > Максимальный срок хранения разностных резервных копий составляет 180 дней. Если требуется более длительное хранение, необходимо использовать полные резервные копии.
    >

   ![Изменение политики разностного резервного копирования](./media/backup-azure-sql-database/enable-differential-backup-policy.png)

    Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

6. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**. Откроется меню **Резервное копирование журналов**.

    В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервное копирование журналов может происходить с частотой не чаще каждые 15 минут и храниться до 35 дней. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

   ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

7. В меню **Политика архивации** выберите, следует ли включить параметр **Сжатие резервной копии SQL**. По умолчанию сжатие отключено.

    В серверной части Azure Backup использует собственное сжатие резервных копий SQL.

8. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**. 

   ![Принятие новой политики резервного копирования](./media/backup-azure-sql-database/backup-policy-click-ok.png)

## <a name="restore-a-sql-database"></a>Восстановление базы данных SQL

Используя резервные копии журналов транзакций, Azure Backup предоставляет функциональные возможности для восстановления отдельных баз данных на определенную дату или время (с точностью до секунды). На основе времени восстановления Azure Backup автоматически определяет соответствующую полную или разностную резервную копию и цепочку резервных копий журнала, необходимых для восстановления данных.

Кроме того, можно выбрать конкретную полную или разностную резервную копию для восстановления с помощью определенной точки восстановления, а не восстановления на определенный момент времени.
 > [!Note]
 > До активации восстановления базы данных master запустите экземпляр SQL Server в однопользовательском режиме с помощью параметра запуска `-m AzureWorkloadBackup`. Аргумент параметра `-m` — это имя клиента. Только этот клиент может открыть подключение. Остановите службу агента SQL для всех системных баз данных (model, master, msdb), прежде чем активировать восстановление. Закройте все приложения, которые могут попытаться перехватить подключение к любой из этих баз данных.
>

Процедура восстановления базы данных

1. Откройте хранилище служб восстановления, в котором зарегистрирована виртуальная машина SQL.

2. На панели мониторинга **Хранилище служб восстановления** в разделе **Использование** выберите **Архивные элементы**, чтобы открыть меню **Архивные элементы**.

    ![Открытие меню "Архивные элементы"](./media/backup-azure-sql-database/restore-sql-vault-dashboard.png).

3. В меню **Архивные элементы** в разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure). 

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

    В меню **Архивные элементы** отображается список баз данных SQL. 

4. Из списка баз данных SQL выберите базу данных, которую необходимо восстановить.

    ![Выбор базы данных для восстановления](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

    При выборе базы данных откроется соответствующее меню. Это меню содержит сведения о резервном копировании базы данных, в том числе:

    * самые старые и самые новые точки восстановления;
    * состояние резервного копирования журналов за последние 24 часа (для базы данных моделей восстановления с полным и неполным протоколированием, если настроено резервное копирование журнала транзакций).

5. В меню для выбранной базы данных выберите **Восстановить базу данных**. Откроется меню **Восстановление**.

    ![Выбор "Восстановить базу данных"](./media/backup-azure-sql-database/restore-db-button.png)

    Когда откроется меню **Восстановление**, также откроется меню **Конфигурация восстановления**. Меню **Конфигурация восстановления** является первым шагом настройки восстановления. В этом меню можно выбрать расположение для восстановления данных. Доступны следующие параметры.
    - **Альтернативное расположение**: восстановление базы данных в альтернативное расположение и сохранения исходной базы данных-источника.
    - **Перезаписать базу данных**: восстановление данных в том же экземпляре SQL Server, где находится исходный источник. При этом перезаписывается исходная база данных.

    > [!Important]
    > Если выбранная база данных принадлежит к группе доступности Always On, SQL Server не позволит перезаписать базу данных. В этом случае включен только параметр **Альтернативное расположение**.
    >

    ![Меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-restore-configuration-menu.png)

### <a name="restore-to-an-alternate-location"></a>Восстановление в альтернативном расположении

Эта процедура описывает процесс восстановления данных в альтернативном расположении. Чтобы перезаписать базу данных во время восстановления, перейдите к разделу [Восстановление и перезапись базы данных](backup-azure-sql-database.md#restore-and-overwrite-the-database). На этом этапе хранилище служб восстановления открыто и отображается меню **Конфигурация восстановления**. Если вы находитесь не на этом этапе, начните с [восстановления базы данных SQL](backup-azure-sql-database.md#restore-a-sql-database).

> [!NOTE]
> Можно восстановить базу данных на экземпляре SQL Server, расположенном в том же регионе Azure. Целевой сервер должен быть зарегистрирован в хранилище служб восстановления. 
>

В меню **Конфигурация восстановления** в раскрывающемся списке **Сервер** отображаются только экземпляры SQL Server, зарегистрированные в хранилище служб восстановления. Если нужный сервер не находится в этом списке, ознакомьтесь с разделом [Обнаружение базы данных SQL Server](backup-azure-sql-database.md#discover-sql-server-databases), чтобы найти этот сервер. В процессе обнаружения новые серверы будут зарегистрированы в хранилище служб восстановления.

1. В меню **Конфигурация восстановления** выполните следующие действия.

    * В разделе **Where to Restore** (Куда восстановить) выберите **Альтернативное расположение**.
    * Откройте раскрывающийся список **Сервер** и выберите экземпляр SQL Server для восстановления базы данных.
    * Откройте раскрывающийся список **Экземпляр** и выберите экземпляр SQL Server.
    * В поле **Имя восстановленной базы данных** введите имя целевой базы данных.
    * Если это применимо, выберите параметр **Overwrite if the DB with the same name already exists on selected SQL instance** (Перезаписать, если база данных с тем же именем уже существует в выбранном экземпляре SQL).
    * Нажмите кнопку **ОК**, чтобы завершить настройку назначения и перейти к выбору точки восстановления.

    ![Указание значений в меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration-menu.png)

2. В меню **Выбор точки восстановления** выберите параметр **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) или **Full & Differential** (Полная и разностная точки восстановления) для точки восстановления. Если необходимо восстановить данные с помощью журнала до точки во времени, продолжайте выполнять этот шаг. Чтобы восстановить полную и разностную точку восстановления, переходите к шагу 3.

    ![Меню "Выбор точки восстановления"](./media/backup-azure-sql-database/recovery-point-menu.png)

    Восстановление до точки во времени доступно только для резервных копий журналов для баз данных, использующих с модель восстановления с полным и неполным протоколированием. Чтобы восстановить данные до определенной точки во времени, сделайте следующее.

    1. Выберите тип точки восстановления **Logs (Point in Time)** (Журналы (восстановление до точки во времени)).

        ![Выбор типа точки восстановления](./media/backup-azure-sql-database/recovery-point-logs.png)

    2. Чтобы открыть **календарь**, в разделе **Дата и время восстановления** щелкните миникалендарь. Даты, выделенные в **календаре** жирным шрифтом, содержат точки восстановления. Текущая дата выделена. Выберите дату с точками восстановления. Даты без точек восстановления выбрать невозможно.

        ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

        После выбора даты временная шкала отображает доступные точки восстановления в непрерывном диапазоне.

    3. Используйте временную шкалу или диалоговое окно **Время**, чтобы указать определенное время точки восстановления. Нажмите кнопку **ОК**, чтобы завершить выбор точки восстановления.
    
       ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-graph.png)

        Меню **Выбор точки восстановления** закроется, и откроется меню **Расширенная конфигурация**.

       ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    4. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы оставить базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Цель**.
        * Нажмите кнопку **ОК**, чтобы подтвердить настройки. Закройте меню **Расширенная конфигурация**.

    5. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**. Отслеживать ход восстановления можно в области **Уведомления**. Можно также выбрать **Restore jobs** (Задания восстановления) в меню базы данных.

       ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

3. В меню **Выбор точки восстановления** выберите параметр **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) или **Full & Differential** (Полная и разностная точки восстановления) для точки восстановления. Чтобы восстановить журнал до точки во времени, вернитесь к шагу 2. Данный шаг позволяет восстановить определенную полную или разностную точку восстановления. Можно просмотреть все полные и разностные точки восстановления за последние 30 дней. Чтобы увидеть точки восстановления старше 30 дней, нажмите кнопку **Фильтр**, чтобы открыть меню **Фильтрация точек восстановления**. При выборе разностной точки восстановления Azure Backup сначала восстанавливает соответствующие полные точки восстановления, а затем выполняет восстановление разностной точки восстановления.

    ![Меню "Выбор точки восстановления"](./media/backup-azure-sql-database/recovery-point-menu.png)

    1. В меню **Выбор точки восстановления** выберите **Full & Differential** (Полная и разностная).

       ![Выбор полной и разностной точек восстановления](./media/backup-azure-sql-database/recovery-point-logs-fd.png)

        В меню отображается список доступных точек восстановления.

    2. Чтобы завершить процедуру, из списка точек восстановления выберите точку восстановления и нажмите кнопку **ОК**. 

        ![Выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)

        Меню **Точка восстановления** закроется, и откроется меню **Расширенная конфигурация**.

        ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    3. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы оставить базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**. Параметр **Restore with NORECOVERY** (Восстановление с NORECOVERY) отключен по умолчанию.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Цель**.
        * Нажмите кнопку **ОК**, чтобы подтвердить настройки. Закройте меню **Расширенная конфигурация**.

    4. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**. Отслеживать ход восстановления можно в области **Уведомления**. Можно также выбрать **Restore jobs** (Задания восстановления) в меню базы данных.

       ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-and-overwrite-the-database"></a>Восстановление и перезапись базы данных

Эта процедура описывает восстановление данных и перезапись базы данных. Если необходимо восстановить данные в альтернативное расположение, перейдите к разделу [Восстановление в альтернативном расположении](backup-azure-sql-database.md#restore-to-an-alternate-location). На этом этапе хранилище служб восстановления открыто и отображается меню **Конфигурация восстановления** (см. рисунок ниже). Если вы находитесь не на этом этапе, начните с [восстановления базы данных SQL](backup-azure-sql-database.md#restore-a-sql-database).

![Меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-overwrite-db.png)

В меню **Конфигурация восстановления** в раскрывающемся списке **Сервер** отображаются только экземпляры SQL Server, зарегистрированные в хранилище служб восстановления. Если нужный сервер не находится в этом списке, ознакомьтесь с разделом [Обнаружение базы данных SQL Server](backup-azure-sql-database.md#discover-sql-server-databases), чтобы найти этот сервер. В процессе обнаружения новые серверы будут зарегистрированы в хранилище служб восстановления.

1. Чтобы завершить настройку назначения, в меню **Конфигурация восстановления** выберите **Перезаписать базу данных** и нажмите кнопку **ОК**. 

   ![Выбор "Перезаписать базу данных"](./media/backup-azure-sql-database/restore-configuration-overwrite-db.png)

    Параметры **Сервер**, **Экземпляр** и **Имя восстановленной базы данных** не являются обязательными.

2. В меню **Выбор точки восстановления** выберите параметр **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) или **Full & Differential** (Полная и разностная точки восстановления) для точки восстановления. Если необходимо восстановить данные с помощью журнала до точки во времени, продолжайте выполнять этот шаг. Чтобы восстановить полную и разностную точку восстановления, переходите к шагу 3.

    ![выбор точки восстановления](./media/backup-azure-sql-database/recovery-point-menu.png)

    Восстановление до точки во времени доступно только для резервных копий журналов для баз данных, использующих с модель восстановления с полным и неполным протоколированием. Чтобы восстановить данные до определенной секунды, выполните следующее.

    1. Выберите тип точки восстановления **Logs (Point in Time)** (Журналы (восстановление до точки во времени)).

        ![Выбор типа точки восстановления](./media/backup-azure-sql-database/recovery-point-logs.png)

    2. Чтобы открыть **календарь**, в разделе **Дата и время восстановления** щелкните миникалендарь. Даты, выделенные в **календаре** жирным шрифтом, содержат точки восстановления. Текущая дата выделена. Выберите дату с точками восстановления. Даты без точек восстановления выбрать невозможно.

        ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

        После выбора даты временная шкала отображает доступные точки восстановления.

    3. Используйте временную шкалу или диалоговое окно **Время**, чтобы указать определенное время точки восстановления. Нажмите кнопку **ОК**, чтобы завершить выбор точки восстановления.
    
       ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-graph.png)

        Меню **Выбор точки восстановления** закроется, и откроется меню **Расширенная конфигурация**.

       ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    4. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы оставить базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Цель**.
        * Нажмите кнопку **ОК**, чтобы подтвердить настройки. Закройте меню **Расширенная конфигурация**.

    5. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**. Отслеживать ход восстановления можно в области **Уведомления**. Можно также выбрать **Restore jobs** (Задания восстановления) в меню базы данных.

       ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

3. В меню **Выбор точки восстановления** выберите параметр **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) или **Full & Differential** (Полная и разностная точки восстановления) для точки восстановления. Чтобы восстановить журнал до точки во времени, вернитесь к шагу 2. Данный шаг позволяет восстановить определенную полную или разностную точку восстановления. Можно просмотреть все полные и разностные точки восстановления за последние 30 дней. Чтобы увидеть точки восстановления старше 30 дней, нажмите кнопку **Фильтр**, чтобы открыть меню **Фильтрация точек восстановления**. При выборе разностной точки восстановления Azure Backup сначала восстанавливает соответствующие полные точки восстановления, а затем выполняет восстановление разностной точки восстановления.

    ![Меню "Выбор точки восстановления"](./media/backup-azure-sql-database/recovery-point-menu.png)

    1. В меню **Выбор точки восстановления** выберите **Full & Differential** (Полная и разностная).

       ![Выбор полной и разностной точек восстановления](./media/backup-azure-sql-database/recovery-point-logs-fd.png)

        В меню отображается список доступных точек восстановления.

    2. Чтобы завершить процедуру, из списка точек восстановления выберите точку восстановления и нажмите кнопку **ОК**. 

        ![Выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)

        Меню **Точка восстановления** закроется, и откроется меню **Расширенная конфигурация**.

        ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    3. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы оставить базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**. Параметр **Restore with NORECOVERY** (Восстановление с NORECOVERY) отключен по умолчанию.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Цель**.
        * Нажмите кнопку **ОК**, чтобы подтвердить настройки. Закройте меню **Расширенная конфигурация**.

    4. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**. Отслеживать ход восстановления можно в области **Уведомления**. Можно также выбрать **Restore jobs** (Задания восстановления) в меню базы данных.

       ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

## <a name="manage-azure-backup-operations-for-sql-on-azure-vms"></a>Управление операциями резервного копирования Azure для SQL на виртуальных машинах Azure

В этом разделе представлена информация о различных операциях управления Azure Backup, доступных для SQL на виртуальных машинах Azure. Существуют следующие операции высокого уровня:

* Мониторинг заданий
* Оповещения, связанные с архивацией
* отключение защиты базы данных SQL;
* возобновление защиты базы данных SQL;
* активация задания нерегламентированного резервного копирования;
* отмена регистрации сервера, на котором выполняется SQL Server.

### <a name="monitor-backup-jobs"></a>Мониторинг заданий резервного копирования
Служба Azure Backup является решением корпоративного класса, поэтому она предоставляет расширенные оповещения и уведомления о резервном копировании на случай сбоя. (См. раздел [Просмотр оповещений о резервном копировании](backup-azure-sql-database.md#view-backup-alerts).) Для отслеживания определенных заданий можно использовать любой из приведенных ниже вариантов в соответствии с потребностями.

#### <a name="use-the-azure-portal-for-adhoc-operations"></a>Использование портала Azure для всех нерегламентированных операций
Azure Backup отображает все запущенные вручную, или нерегламентированные, задания на портале **заданий резервного копирования**. На портале **заданий резервного копирования** отображаются следующие задания:
- все операции настройки резервного копирования;
- активированные вручную операции резервного копирования;
- операции восстановления;
- операции регистрации и обнаружения баз данных;
- остановка операций резервного копирования. 

![Портал заданий резервного копирования](./media/backup-azure-sql-database/jobs-list.png)

> [!NOTE]
> Все запланированные задания резервного копирования, включая полное резервное копирование, разностное резервное копирование и резервное копирование журналов, не отображаются на портале **заданий резервного копирования**. Используйте SQL Server Management Studio для отслеживания запланированных заданий резервного копирования, как описано в следующем разделе.
>

#### <a name="use-sql-server-management-studio-for-backup-jobs"></a>Использование SQL Server Management Studio для заданий резервного копирования
Служба Azure Backup использует встроенные API SQL для всех операций резервного копирования. С помощью собственных интерфейсов API вы можете получить всю информацию о задании из [таблицы backupset](https://docs.microsoft.com/sql/relational-databases/system-tables/backupset-transact-sql?view=sql-server-2017) в базе данных SQL msdb.

В примере ниже показан запрос для получения всех заданий резервного копирования для базы данных с именем **DB1**. Настройте запрос для расширенного мониторинга.

```
select CAST (
Case type
                when 'D' 
                                 then 'Full'
                when  'I'
                               then 'Differential' 
                ELSE 'Log'
                END         
                AS varchar ) AS 'BackupType',
database_name, 
server_name,
machine_name,
backup_start_date,
backup_finish_date,
DATEDIFF(SECOND, backup_start_date, backup_finish_date) AS TimeTakenByBackupInSeconds,
backup_size AS BackupSizeInBytes
  from msdb.dbo.backupset where user_name = 'NT SERVICE\AzureWLBackupPluginSvc' AND database_name =  <DB1>  
 
```

### <a name="view-backup-alerts"></a>Просмотр оповещений о резервном копировании

Так как резервные копии журналов создаются каждые 15 минут, мониторинг заданий резервного копирования иногда может быть утомительным. Azure Backup поможет вам в этой ситуации. В случае каких-либо сбоев резервного копирования отправляются оповещения по электронной почте. Оповещения объединяются на уровне базы данных по коду ошибки. Оповещение по электронной почте отправляется только для первого сбоя резервного копирования базы данных. Войдите на портал Azure, чтобы отслеживать все сбои для базы данных. 

Чтобы отслеживать оповещения резервного копирования, выполните следующие действия.

1. Войдите в подписку Azure на [портале Azure](https://portal.azure.com).

2. Откройте хранилище служб восстановления, в котором зарегистрирована виртуальная машина SQL.

3. На панели мониторинга **Хранилище служб восстановления** выберите **Alerts and Events** (Оповещения и события). 

   ![Выбор "Alerts and Events" (Оповещения и события)](./media/backup-azure-sql-database/vault-menu-alerts-events.png)

4. Чтобы просмотреть список оповещений, в меню **Alerts and Events** (Оповещения и события) выберите **Оповещения, связанные с архивацией**.

   ![Выбор "Оповещения, связанные с архивацией"](./media/backup-azure-sql-database/backup-alerts-dashboard.png)

### <a name="stop-protection-for-a-sql-server-database"></a>Остановка защиты базы данных SQL Server

При остановке защиты базы данных SQL Server служба Azure Backup спросит, следует ли сохранять точки восстановления. Существуют два способа остановки защиты базы данных SQL:

* можно остановить все будущие задания резервного копирования и удалить все точки восстановления;
* можно остановить все будущие задания резервного копирования, но сохранить точки восстановления.

За хранение точек восстановления взимается плата. Точки восстановления для SQL оплачиваются как защищенный экземпляр SQL, а также используют ресурсы хранилища. Для получения дополнительных сведений о ценообразовании Azure Backup для SQL см. раздел [Страница расценок Azure Backup](https://azure.microsoft.com/pricing/details/backup/). 

Чтобы остановить защиту базы данных, выполните следующие действия.

1. Откройте хранилище служб восстановления, в котором зарегистрирована виртуальная машина SQL.

2. На панели мониторинга **Хранилище служб восстановления** в разделе **Использование** выберите **Архивные элементы**, чтобы открыть меню **Архивные элементы**.

    ![Открытие меню "Архивные элементы"](./media/backup-azure-sql-database/restore-sql-vault-dashboard.png).

3. В меню **Архивные элементы** в разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure). 

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

    В меню **Архивные элементы** отображается список баз данных SQL. 

4. Из списка баз данных SQL выберите базу данных, защиту которой необходимо остановить.

    ![Выбор базы данных для остановки защиты](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

    При выборе базы данных откроется соответствующее меню.

5. В меню для выбранной базы данных выберите **Остановить архивацию**. 

    ![Выбор "Остановить архивацию"](./media/backup-azure-sql-database/stop-db-button.png)

    Откроется меню **Остановить архивацию**.

6. В меню **Остановить архивацию** выберите **Сохранить данные архивации** или **Удалить данные архивации**. При необходимости можно указать причину остановки защиты и добавить комментарий.

    ![Меню "Остановить архивацию"](./media/backup-azure-sql-database/stop-backup-button.png)

7. Чтобы остановить защиту базы данных, выберите **Остановить архивацию**. 

### <a name="resume-protection-for-a-sql-database"></a>возобновление защиты базы данных SQL;

Если при остановке защиты базы данных SQL был выбран параметр **Сохранить данные архивации**, защиту можно возобновить. Если данные резервных копий не были сохранены, защиту невозможно возобновить. 

1. Чтобы возобновить защиту базы данных SQL, откройте элемент резервного копирования и выберите **Возобновить резервное копирование**.

    ![Выбор "Возобновить резервное копирование" для возобновления защиты базы данных](./media/backup-azure-sql-database/resume-backup-button.png)

   Откроется меню **Политика архивации**.

2. В меню **Политика архивации** выберите политику и нажмите кнопку **Сохранить**.

### <a name="trigger-an-adhoc-backup"></a>Активация задания нерегламентированного резервного копирования

Активируйте нерегламентированное резервное копирование при необходимости. Существуют четыре типа нерегламентированного резервного копирования.

* Полная резервная копия
* полная резервная копия (только копирование);
* разностная резервная копия;
* Резервное копирование журналов

Подробные сведения о каждом типе см. в статье [Типы резервного копирования SQL](https://docs.microsoft.com/sql/relational-databases/backup-restore/backup-overview-sql-server?view=sql-server-2017#types-of-backups).

### <a name="unregister-a-sql-server-instance"></a>Отмена регистрации экземпляра SQL Server

Чтобы отменить регистрацию экземпляра SQL Server после удаления защиты, но перед удалением хранилища сделайте следующее.

1. Откройте хранилище служб восстановления, в котором зарегистрирована виртуальная машина SQL.

2. На панели мониторинга **Хранилище служб восстановления** в разделе **Управление** выберите **Инфраструктура резервного копирования**.  

   ![Выбор "Инфраструктура резервного копирования"](./media/backup-azure-sql-database/backup-infrastructure-button.png)

3. В разделе **Серверы управления** выберите **Защищенные серверы**.

   ![Выбор "Защищенные серверы"](./media/backup-azure-sql-database/protected-servers.png)

    Откроется меню **Защищенные серверы**. 

4. В меню **Защищенные серверы** выберите сервер, для которого необходимо отменить регистрацию. Чтобы удалить хранилище, необходимо отменить регистрацию всех серверов.

5. В меню **Защищенные серверы** щелкните правой кнопкой мыши защищенный сервер и выберите **Удалить**. 

   ![Выбор "Удалить"](./media/backup-azure-sql-database/delete-protected-server.png)

## <a name="faq"></a>Часто задаваемые вопросы

В разделе ниже приведены дополнительные сведения о резервном копировании базы данных SQL.

### <a name="can-i-throttle-the-speed-of-the-sql-server-backup-policy"></a>Можно ли регулировать частоту политики резервного копирования SQL Server?

Да. Вы можете регулировать частоту, с которой выполняется политика резервного копирования, чтобы свести к минимуму влияние на экземпляр SQL Server.

Чтобы изменить этот параметр:

1. На экземпляре SQL Server в папке C:\Program Files\Azure Workload Backup\bin откройте файл **TaskThrottlerSettings.json**.

2. В файле TaskThrottlerSettings.json измените параметр **DefaultBackupTasksThreshold**, указав меньшее значение (например, 5).

3. Сохраните изменения. Закройте файл.

4. На экземпляре SQL Server откройте **диспетчер задач**. Перезапустите службу **Azure Backup Workload Coordinator Service**.

### <a name="can-i-run-a-full-backup-from-a-secondary-replica"></a>Можно ли запустить полное резервное копирование из вторичной реплики?

Нет. Эта возможность не поддерживается.

### <a name="do-successful-backup-jobs-create-alerts"></a>Отправляются ли оповещения об успешно выполненных заданиях резервного копирования?

Нет. Для успешно выполненных заданий резервного копирования не создаются оповещения. Оповещения отправляются только в случае сбоя.

### <a name="can-i-see-details-for-scheduled-backup-jobs-in-the-jobs-menu"></a>Можно ли просмотреть сведения о запланированных заданиях резервного копирования в меню "Задания"?

Нет. В меню **Задания архивации** отображаются сведения о нерегламентированных, но не о запланированных заданиях резервного копирования. В случае сбоя запланированного задания резервного копирования все сведения содержатся в оповещениях о сбое задания. Все запланированные и нерегламентированные задания резервного копирования можно отслеживать в [SQL Server Management Studio](backup-azure-sql-database.md#use-sql-server-management-studio-for-backup-jobs).

### <a name="when-i-select-a-sql-server-instance-are-future-databases-automatically-added"></a>Если я выберу экземпляр SQL Server, будут ли будущие базы данных добавляться автоматически?

Нет. Если настройке защиты для экземпляра SQL Server выбран параметр уровня сервера, то добавляются все базы данных. Если вы добавите базы данных в экземпляр SQL Server после настройки защиты, вам придется добавить их вручную, чтобы обеспечить защиту. Базы данных не включаются в настроенную защиту автоматически.

### <a name="if-i-change-the-recovery-model-how-do-i-restart-protection"></a>Если изменить модель восстановления, как затем перезапустить защиту?

Активируйте полное резервное копирование. Создание резервных копий журналов начнется должным образом.

### <a name="can-i-protect-sql-always-on-availability-groups-where-the-primary-replica-is-on-premises"></a>Как защитить группы доступности SQL Always On, где первичная реплика находится в локальной среде?

Нет. Azure Backup обеспечивает защиту серверов SQL Server, работающих в Azure. Если группа доступности распределена между Azure и локальными компьютерами, ее можно защитить только в том случае, если первичная реплика работает в Azure. Кроме того, Azure Backup защищает только узлы, работающие в том же регионе Azure, что и хранилище служб восстановления.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о службе Azure Backup приведены в примере Azure PowerShell для резервного копирования зашифрованных виртуальных машин.

> [!div class="nextstepaction"]
> [Резервное копирование зашифрованной виртуальной машины](./scripts/backup-powershell-sample-backup-encrypted-vm.md)
