---
title: Резервное копирование базы данных SQL Server в Azure | Документация Майкрософт
description: В этом руководстве описано резервное копирование SQL Server в Azure. Здесь также описывается восстановление SQL Server.
services: backup
documentationcenter: ''
author: markgalioto
manager: carmonm
editor: ''
keywords: ''
ms.assetid: ''
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 6/1/2018
ms.author: markgal;anuragm
ms.custom: ''
ms.openlocfilehash: 4ae64fefb58840214104a4e1cb338ec404fac1a8
ms.sourcegitcommit: 4e36ef0edff463c1edc51bce7832e75760248f82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/08/2018
ms.locfileid: "35235419"
---
# <a name="back-up-sql-server-database-in-azure"></a>Резервное копирование базы данных SQL Server в Azure

Базы данных SQL Server являются критическими рабочими нагрузками, требующими низкой целевой точки восстановления (RPO) и долгосрочного хранения. Azure Backup предоставляет решение SQL Serverbackup, требующее нулевой инфраструктуры, то есть отсутствие управления сложным резервным сервером, агентом управления или хранилищем резервных копий. Azure Backup обеспечивает централизованное управление резервными копиями на всех SQL-серверах или даже разными рабочими нагрузками.

 В этой статье раскрываются следующие темы.

> [!div class="checklist"]
> * Предварительные требования для резервного копирования SQL Server в Azure
> * Создание и использование хранилища служб восстановления
> * Настройка резервного копирования базы данных SQL Server
> * Установка политики резервного копирования (или хранения) для точек восстановления
> * Восстановление базы данных

Перед запуском процедур из этой статьи необходимо иметь SQL Server, работающий в Azure. [Создание базы данных SQL Azure на портале Azure](../sql-database/sql-database-get-started-portal.md).

## <a name="public-preview-limitations"></a>Ограничения общедоступной предварительной версии

Следующие пункты являются известными ограничениями для общедоступной предварительной версии.

- Виртуальной машине SQL требуется подключение к Интернету для доступа к общедоступным IP-адресам Azure. Дополнительные сведения см. в разделе [Установка сетевого подключения](backup-azure-sql-database.md#establish-network-connectivity).
- В одном хранилище служб восстановления можно защитить до 2000 баз данных SQL. Дополнительные базы данных SQL должны храниться в отдельном хранилище служб восстановления.
- [Резервное копирование распределенных групп доступности имеет ограничения](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/distributed-availability-groups?view=sql-server-2017).
- Не поддерживаются экземпляры отказоустойчивого кластера SQL (FCI).
- Чтобы настроить Azure Backup для защиты баз данных SQL Server, используйте портал Azure. В настоящее время недоступна поддержка для Azure PowerShell, CLI и API-интерфейс REST.

## <a name="supported-azure-geos"></a>Поддерживаемые геообъекты Azure

- Юго-Восточная Австралия (ASE). 
- Южная Бразилия (BRS).
- Центральная Канада (CNC).
- Восточная Канада (CE).
- Центральная часть США (CUS).
- Восточная Азия (EA).
- Восточная Австралия (AE). 
- Восточная часть США (EUS).
- Восточная часть США 2 (EUS2).
- Восточная Япония (JPE);
- Западная Япония (JPW);
- Центральная Индия (INC). 
- Южная Индия (INS);
- Республика Корея, центральный регион (KRC)
- Южная Корея (KRS);
- Северо-центральный регион США (NCUS). 
- Северная Европа (NE). 
- Юго-центральный регион США (SCUS). 
- Юго-Восточная Азия (SEA).
- Южная часть Соединенного Королевства (UKS). 
- Западная часть Соединенного Королевства (UKW). 
- Западная Европа (WE). 
- Западная часть США (WUS).
- Западно-центральная часть США (WCUS).
- Западная часть США 2 (WUS 2). 

## <a name="supported-operating-systems-and-versions-of-sql-server"></a>Поддерживаемые операционные системы и версии SQL server

Следующие поддерживаемые операционные системы и версии SQL Server применяются к виртуальным машинам Azure SQL marketplace и к виртуальным машинам, не поддерживающим marketplace, (с установленным вручную SQL Server).

### <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

- Windows Server 2012
- Windows Server 2012 R2
- Windows Server 2016

Linux в настоящее время не поддерживается.

### <a name="supported-versionseditions-of-sql-server"></a>Поддерживаемые версии и выпуски SQL Server

- SQL 2012 Enterprise, Standard, Web, Developer, Express
- SQL 2014 Enterprise, Standard, Web, Developer, Express
- SQL 2016 Enterprise, Standard, Web, Developer, Express
- SQL 2017 Enterprise, Standard, Web, Developer, Express


## <a name="prerequisites-for-using-azure-backup-to-protect-sql-server"></a>Предварительные требования для использования Azure Backup для защиты SQL Server 

Прежде чем создавать резервную копию базы данных SQL Server, проверьте следующие условия. :

- Определите или [создайте хранилище служб восстановления](backup-azure-sql-database.md#create-a-recovery-services-vault) в том же регионе или месте, что и размещение виртуальной машины SQL Server.
- [Проверьте разрешения на виртуальную машину](backup-azure-sql-database.md#set-permissions-for-non-marketplace-sql-vms), необходимые для создания резервных копий баз данных SQL.
- [Имеет ли виртуальная машина SQL сетевое подключение](backup-azure-sql-database.md#establish-network-connectivity).

> [!NOTE]
> Для резервного копирования баз данных SQL Server одновременно может быть только одно решение резервного копирования. Отключите любые другие резервные копии SQL перед использованием этой функции, иначе резервные копии будут конфликтовать и выходить из строя. Без конфликтов можно включить Azure Backup для виртуальной машины IaaS вместе с резервной копией SQL. 
>

Если эти условия в вашей среде выполняются, перейдите к разделу [Создание хранилища служб восстановления](backup-azure-sql-database.md#configure-your-vault-to-protect-a-sql-database). Если каких-либо предварительных условий не существует, продолжайте читать этот раздел.


## <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций виртуальной машине SQL требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины SQL (такие как обнаружение базы данных, настройка резервного копирования, запланированные резервные копии, восстановление точек восстановления и т. д.) терпят неудачу без подключения к общедоступным IP-адресам. Используйте один из следующих параметров для обеспечения свободного пути для трафика резервного копирования.

- Белый список диапазонов IP-адресов центра обработки данных Azure. Для добавления диапазонов IP-адресов центра обработки данных Azure в список разрешений, используйте [страницу центра загрузки для получения подробной информации о диапазонах IP-адресов и инструкций](https://www.microsoft.com/download/details.aspx?id=41653). 
- Развертывание прокси-сервера HTTP для маршрутизации трафика. Когда выполняется резервное копирование базы данных SQL на виртуальной машине, расширение резервного копирования на виртуальной машине использует программный интерфейс HTTPS для отправки команд управления к Azure Backup, а данные — в службу хранилища Azure. Расширение резервного копирования также использует Azure Active Directory (AAD) для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP, потому что это единственный компонент, который настроен для общего доступа в Интернете.

Возможны следующие варианты для компромисса: управляемость, высокий уровень контроля и затраты.

> [!NOTE]
>Теги служб для Azure Backup должны быть доступны по общей доступности.
>

| Параметр | Преимущества | Недостатки |
| ------ | ---------- | ------------- |
| Разрешенные диапазоны IP-адресов | Нет дополнительных затрат. <br/> Открыть доступ в NSG можно с помощью командлета **Set-AzureNetworkSecurityRule**. | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются. <br/>Доступ ко всей службе Azure, а не только к хранилищу.|
| Использование прокси-сервера HTTP   | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере. <br/>Единая точка доступа к виртуальным машинам через Интернет. <br/> Не подвергается влиянию изменений IP-адресов Azure. | Дополнительные затраты для работы виртуальной машины с программным обеспечением прокси-сервера. |

## <a name="set-permissions-for-non-marketplace-sql-vms"></a>Установка разрешений для виртуальных машин SQL, не поддерживающих marketplace

Azure Backup требуется установка расширения **AzureBackupWindowsWorkload** для резервного копирования виртуальной машины. Если используются виртуальные машины Azure marketplace, перейдите к разделу [Обнаружение базы данных SQL Server](backup-azure-sql-database.md#discover-sql-server-databases). Если виртуальная машина, на которой размещены базы данных SQL, не была создана из Azure marketplace, выполните указания следующего раздела, чтобы установить расширение и определить соответствующие разрешения. В дополнение к расширению **AzureBackupWindowsWorkload** для Azure Backup требуются разрешения sysadmin SQL для защиты баз данных SQL. При обнаружении баз данных на виртуальной машине Azure Backup создает учетную запись NT Service\AzureWLBackupPluginSvc. Чтобы служба Azure Backup обнаруживала базы данных SQL, учетная запись NT Service\AzureWLBackupPluginSvc должна иметь журнал SQL и разрешения sysadmin SQL. Следующая процедура объясняет, как предоставить эти разрешения.

Настройка разрешений

1. В [портале Azure](https://portal.azure.com) откройте хранилище служб восстановления, которое используется для защиты баз данных SQL.
2. В меню панели мониторинга хранилища щелкните **Архивация**, чтобы открыть меню **Цель резервного копирования**.

   ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/open-backup-menu.png)

3. В меню **Цель резервного копирования** меню **Where is your workload running?** (Где выполняется рабочая нагрузка?) оставьте по умолчанию **Azure**.

4. В меню **What do you want to backup** (Что требуется архивировать) последовательно разверните раскрывающееся меню и выберите **SQL Server in Azure VM** (SQL Server в виртуальной машине Azure).

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

    В меню **Цель резервного копирования** отображаются два новых шага: **Обнаружить базы данных в виртуальных машинах** и **Настройка службы Backup**. Шаг **Обнаружить базы данных в виртуальных машинах** запускает поиск виртуальных машин Azure.

    ![Демонстрация новых шагов меню "Цель резервного копирования"](./media/backup-azure-sql-database/backup-goal-menu-step-one.png)

5. Для поиска незащищенных виртуальных машин в подписке нажмите **Запуск обнаружения**. В зависимости от количества незащищенных виртуальных машин в подписке может понадобиться некоторое время, чтобы пройти все виртуальные машины.

    ![Статус "В ожидании резервного копирования"](./media/backup-azure-sql-database/discovering-sql-databases.png)
 
    Как только незащищенная виртуальная машина будет обнаружена, она появится в списке. Незащищенные виртуальные машины перечислены по именах и группах ресурсов. Возможно, что некоторые виртуальные машины имеют одно и то же имя. Однако виртуальные машины с одинаковыми именами относятся к различным группам ресурсов. Если ожидаемая виртуальная машина не отображается в списке, может она уже защищена хранилищем.

6. В списке виртуальных машин выберите виртуальную машину, содержащую базу данных SQL, которой необходимо создать резервную копию, и нажмите кнопку **Обнаружить базы данных**. 

    Процесс обнаружения устанавливает на виртуальной машине расширение **AzureBackupWindowsWorkload**. Расширение позволяет службе Azure Backup взаимодействовать с виртуальной машиной, чтобы она могла создавать резервные копии баз данных SQL. После установки расширения Azure Backup создает на виртуальной машине учетную запись виртуальной службы Windows — **NT Service\AzureWLBackupPluginSvc**. Для учетной записи виртуальной службы требуется разрешение sysadmin SQL. Если во время процесса установки учетной записи виртуальной службы возникает ошибка **UserErrorSQLNoSysadminMembership**, см. раздел [Исправление разрешений sysadmin SQL](backup-azure-sql-database.md#fixing-sql-sysadmin-permissions).

    В области уведомлений отображается ход обнаружения баз данных. В зависимости от количества баз данных на виртуальной машине, выполнение задания может занять некоторое время. Когда выбранные базы данных будут обнаружены, появляется сообщение о его успешном завершении.

    ![сообщение уведомления об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

После связывания базы данных с хранилищем служб восстановления следующим шагом является [настройка резервного копирования](backup-azure-sql-database.md#configure-your-vault-to-protect-a-sql-database).

### <a name="fixing-sql-sysadmin-permissions"></a>Исправление разрешений sysadmin SQL

При возникновении ошибки во время процесса установки **UserErrorSQLNoSysadminMembership** войдите в SQL Server Management Studio (SSMS) с учетной записью, имеющей разрешение sysadmin SQL. Если не требуются специальные разрешения, для распознавания учетной записи необходимо иметь возможность использовать проверку подлинности Windows.

1. На сервере SQL Server последовательно откройте папки **Security (Безопасность) и Logins (Имена входа)**.

    ![Открытие на SQL Server папок "Security" (Безопасность) и "Logins" (Имена входа) для просмотра учетных записей](./media/backup-azure-sql-database/security-login-list.png)

2. В папке "Logins" (Имена входа) щелкните правой кнопкой мыши и выберите **новое имя входа**, и в диалоговом окне "Login - New"(Создание имени входа) нажмите кнопку **Поиск**

    ![Открытие окна "Поиск" в диалоговом окне "Login - New"(Создание имени входа)](./media/backup-azure-sql-database/new-login-search.png)

3. Начнем с учетной записи виртуальной службы Windows **NT Service\AzureWLBackupPluginSvc**, которая была создана во время фазы регистрации виртуальной машины и обнаружения SQL. Введите имя учетной записи так, как оно отображается в диалоговом окне **Enter the object name to select** (Введите имя объекта для выбора). Нажмите **Проверить имена**, чтобы разрешить выбор имени. 

    ![Нажатие кнопки "Проверить имена", чтобы разрешить выбор имени неизвестной службы](./media/backup-azure-sql-database/check-name.png)

4. Нажмите **ОК**, чтобы закрыть диалоговое окно "Выберите пользователя или группу".

5. В диалоговом окне **Роли сервера** (Server Roles) убедитесь, что выбрана роль **sysadmin**. Нажмите кнопку **ОК**, чтобы закрыть окно **Login - New** (Создание имени входа).

    ![Убедитесь, что для сервера выбрана роль sysadmin.](./media/backup-azure-sql-database/sysadmin-server-role.png)

    Теперь должны существовать необходимые разрешения.

6. Хотя ошибка разрешений устранена, по-прежнему необходимо связать базу данных с хранилищем служб восстановления. В списке **Защищенные серверы** на портале Azure щелкните правой кнопкой мыши сервер с ошибкой и выберите **Повторно обнаружить базы данных**.

    ![Убедитесь, что сервер имеет соответствующие разрешения](./media/backup-azure-sql-database/check-erroneous-server.png)

    В области уведомлений отображается ход обнаружения баз данных. В зависимости от количества баз данных на виртуальной машине, выполнение задания может занять некоторое время. После обнаружения выбранных баз данных в области уведомлений появится сообщение об успешном выполнении.

    ![сообщение уведомления об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

После связывания базы данных с хранилищем служб восстановления следующим шагом является [настройка резервного копирования](backup-azure-sql-database.md#configure-your-vault-to-protect-a-sql-database).

[!INCLUDE [Section explaining how to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Azure Backup может обнаружить все базы данных на экземпляре SQL Server, чтобы иметь возможность защитить их в соответствии с требованиями к резервному копированию. Используйте следующую процедуру для идентификации виртуальной машины, на которой размещаются базы данных SQL. После идентификации виртуальной машины Azure Backup устанавливает упрощенное расширение для обнаружения баз данных SQL server.

1. Войдите в подписку на [портале Azure](https://portal.azure.com/).
2. В меню слева выберите **Все службы**.

    ![Выбор параметра "Все службы" в главном меню](./media/backup-azure-sql-database/click-all-services.png) <br/>

3. В диалоговом окне "Все службы" введите *Службы восстановления*. По мере ввода данных фильтруется список ресурсов. Когда отобразится запись **Хранилища служб восстановления**, выберите ее.

    ![Ввод фразы "Службы восстановления" в диалоговом окне "Все службы"](./media/backup-azure-sql-database/all-services.png) <br/>

    После этого отобразится список хранилищ служб восстановления в подписке. 

4. В списке хранилищ служб восстановления выберите хранилище, которое необходимо использовать для защиты баз данных SQL.

5. В меню панели мониторинга хранилища щелкните **Архивация**, чтобы открыть меню **Цель резервного копирования**.

   ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/open-backup-menu.png)

6. В меню **Цель резервного копирования** меню **Where is your workload running?** (Где выполняется рабочая нагрузка?) оставьте по умолчанию **Azure**.

7. В меню **What do you want to backup** (Что требуется архивировать) последовательно разверните раскрывающееся меню и выберите **SQL Server in Azure VM** (SQL Server в виртуальной машине Azure).

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

    После выбора в меню **Цель резервного копирования** отображаются два новых шага: "Обнаружить базы данных в виртуальных машинах" и "Настройка службы Backup". 

    ![Демонстрация новых шагов меню "Цель резервного копирования"](./media/backup-azure-sql-database/backup-goal-menu-step-one.png)

8. Для поиска незащищенных виртуальных машин в подписке нажмите **Запуск обнаружения**. В зависимости от количества незащищенных виртуальных машин в подписке может понадобиться некоторое время, чтобы пройти все виртуальные машины.

    ![Статус "В ожидании резервного копирования"](./media/backup-azure-sql-database/discovering-sql-databases.png)
 
    Как только незащищенная виртуальная машина будет обнаружена, она появится в списке. Некоторые виртуальные машины могут иметь одно и то же имя. Однако некоторые виртуальные машины с одинаковыми именами относятся к различным группам ресурсов. Незащищенные виртуальные машины перечислены по именах и группах ресурсов. Если ожидаемая виртуальная машина не отображается в списке, может она уже защищена хранилищем.

9. В списке виртуальных машин установите флажок для виртуальной машины, содержащей базы данных SQL, которые необходимо защитить, и нажмите кнопку **Обнаружить базы данных**.

    Azure Backup обнаруживает все базы данных SQL на виртуальной машине. Сведения о том, что происходит во время фазы обнаружения базы данных, см. в следующем разделе [Внутренние операции при обнаружении баз данных SQL](backup-azure-sql-database.md#backend-operations-when-discovering-sql-databases). После обнаружения баз данных SQL можно приступать к [настройке задания резервного копирования](backup-azure-sql-database.md#configure-your-vault-to-protect-a-sql-database).

### <a name="backend-operations-when-discovering-sql-databases"></a>Внутренние операции при обнаружении баз данных SQL

При использовании средства **Обнаружить базы данных** Azure Backup выполняет следующие операции в фоновом режиме.

- Регистрирует виртуальную машину с помощью хранилища служб восстановления для резервного копирования рабочей нагрузки. Все базы данных на зарегистрированной виртуальной машине могут быть скопированы только в хранилище служб восстановления. 

- Устанавливает на виртуальной машине расширение **AzureBackupWindowsWorkload**. Резервное копирование базы данных SQL является безагентным решением, то есть с расширением, установленным на виртуальной машине, без установленного агента в базе данных SQL.

- Создает на виртуальной машине учетную запись службы **NT Service\AzureWLBackupPluginSvc**. Все операции резервного копирования и восстановления используют учетную запись службы. Учетной записи **NT Server\AzureWLBackupPluginSvc** необходимы разрешения sysadmin SQL. Все виртуальные машины SQL Marketplace поставляются с установленным расширением SqlIaaSExtension, а AzureBackupWindowsWorkload использует это расширение, чтобы автоматически получать необходимые разрешения. Если виртуальная машина не имеет установленного расширения SqlIaaSExtension, операция обнаружения баз данных завершается неудачей и появляется сообщение об ошибке **UserErrorSQLNoSysAdminMembership**. Чтобы добавить разрешение sysadmin для резервного копирования, следуйте инструкциям из раздела [Установка разрешений для виртуальных машин SQL, не поддерживающих marketplace](backup-azure-sql-database.md#set-permissions-for-non--marketplace-sql-vms).

    ![выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup-for-sql-server-database"></a>Настройка резервного копирования для базы данных SQL Server

Azure Backup предоставляет службы управления для защиты баз данных SQL Server и управления заданиями резервного копирования. Возможности управления и мониторинга зависят от хранилища служб восстановления. 

> [!NOTE]
> Для резервного копирования баз данных SQL Server одновременно может быть только одно решение резервного копирования. Отключите любые другие резервные копии SQL перед использованием этой функции, иначе резервные копии будут конфликтовать и выходить из строя. Без конфликтов можно включить Azure Backup для виртуальной машины IaaS вместе с резервной копией SQL. 
>

Чтобы настроить защиту для базы данных SQL, выполните следующие действия.

1. Откройте хранилище служб восстановления, зарегистрированное на виртуальной машине SQL.

2. В меню панели мониторинга хранилища щелкните **Архивация**, чтобы открыть меню **Цель резервного копирования**.

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/open-backup-menu.png)

3. В меню **Цель резервного копирования** меню **Where is your workload running?** (Где выполняется рабочая нагрузка?) оставьте по умолчанию **Azure**.

4. В меню **What do you want to backup** (Что требуется архивировать) последовательно разверните раскрывающееся меню и выберите **SQL Server in Azure VM** (SQL Server в виртуальной машине Azure).

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

    После выбора в меню **Цель резервного копирования** отображаются два новых шага: "Обнаружить базы данных в виртуальных машинах" и "Настройка службы Backup". Если вы прочитали эту статью по порядку, то уже обнаружили незащищенные виртуальные машины и это хранилище, зарегистрированное на виртуальной машине. Теперь вы готовы настроить защиту для баз данных SQL.

5. В меню "Цель резервного копирования", нажмите кнопку **Настройка службы Backup**.

    ![Демонстрация новых шагов меню "Цель резервного копирования"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

    Служба Azure Backup отображает все экземпляры SQL с изолированными базами данных, а также группы доступности SQL AlwaysOn. Чтобы просмотреть автономные базы данных в экземпляре SQL, нажмите значок шеврона рядом с именем экземпляра, в котором необходимо просмотреть базы данных. На следующих рисунках показаны примеры изолированного экземпляра и группы доступности Always On.

    > [!NOTE]
    > Полные и разностные резервные копии происходят от основного узла, так как платформа SQL имеет это ограничение. Резервное копирование журналов может происходить на основе параметров резервного копирования. Из-за этого ограничения первичный узел должен быть зарегистрирован.
    >

    ![Список баз данных в экземпляре SQL](./media/backup-azure-sql-database/discovered-databases.png)

    Щелкните значок шеврона рядом с группами доступности AlwaysOn, чтобы просмотреть список баз данных.

    ![Список баз данных в группе доступности AlwaysOn](./media/backup-azure-sql-database/discovered-database-availability-group.png)

6. В списке баз данных выберите те, которые необходимо защитить, и нажмите кнопку **ОК**.

    ![выбор нескольких баз данных для защиты](./media/backup-azure-sql-database/select-multiple-database-protection.png)

    За один раз можно выбрать до 50 баз данных. Если необходимо защитить более 50 баз данных, сделайте несколько проходов. После защиты первых 50 баз данных повторите этот шаг для защиты следующего набора баз данных.
    > [!Note] 
    > Для оптимизации нагрузки резервных копий Azure Backup разбивает большие задания резервного копирования на несколько пакетов. Максимальное количество баз данных в одном задании резервного копирования — 50.
    >
    >

7. Чтобы создать или выбрать политику резервного копирования, в меню **Архивация** для открытия меню выберите **Политика архивации**.

    ![выбор параметра политики архивации](./media/backup-azure-sql-database/select-backup-policy.png)

8. Из раскрывающегося меню **Выберите политику архивации** выберите политику архивации и нажмите кнопку **ОК**. Дополнительные сведения о создании политики архивации см. в разделе [Определение политики архивации](backup-azure-sql-database.md#define-a-backup-policy).

    ![выбор политики архивации из раскрывающегося меню](./media/backup-azure-sql-database/select-backup-policy-steptwo.png)

    В меню "Политика архивации" из раскрывающегося меню **Выберите политику архивации** можно выбрать: 
    - по умолчанию политику HourlyLogBackup; 
    - существующую политику архивации, ранее созданную для SQL;
    - для [определения новой политики](backup-azure-sql-database.md#define-a-backup-policy) на основе целевой точки восстановления (RPO) и диапазона хранения. 

    > [!Note]
    > Azure Backup поддерживает долгосрочное хранение на основе схемы архивации "дед-отец-сын" для оптимизации использования внутреннего хранилища при удовлетворении нормативных требований.
    >

9. После выбора политики архивации в меню **Архивация** нажмите **Включить резервное копирование**.

    ![включение выбранной политики архивации](./media/backup-azure-sql-database/enable-backup-button.png)

    В области уведомлений портала можно отслеживать ход настройки.

    ![просмотр области уведомлений](./media/backup-azure-sql-database/notifications-area.png)


### <a name="define-a-backup-policy"></a>Определение политики архивации.

Политика резервного копирования определяет матрицу когда выполнять архивацию и как долго хранить резервные копии. Azure Backup можно использовать для планирования трех типов резервного копирования для баз данных SQL.

* Полная резервная копия. Полная резервная копия базы данных создает резервную копию всей базы данных. Полная резервная копия содержит все данные в определенной базе данных или набор файлов или файловых групп и журнала для восстановления этих данных. Максимально в день можно активировать одну полную резервную копию. Для создания полной резервной копии можно выбрать ежедневный или еженедельный интервал. 
* Разностная резервная копия. Разностная резервная копия базируется на последней предшествующей полной резервной копии данных. Разностная резервная копия сохраняет только данные, которые были изменены с момента создания полной резервной копии. Максимально в день можно активировать одну разностную резервную копию. В тот же день невозможно активировать полную резервную копию и дифференциальную резервную копию.
* Резервная копия журнала транзакций. Резервная копия журнала дает возможность восстановления на момент времени с точностью до секунды. Максимально каждые 15 минут можно настраивать резервные копии журналов транзакций.

Политика создается на уровне хранилища служб восстановления. Если имеется несколько хранилищ, то хранилища могут использовать ту же политику резервного копирования, но тогда необходимо применить политику резервного копирования к каждому хранилищу. При создании политики резервного копирования значением по умолчанию является ежедневное полное резервное копирование. Можно добавить разностное резервное копирование, но только при переключении параметра полного резервного копирования на "Еженедельно". Следующая процедура объясняет, как создать политику резервного копирования для SQL server на виртуальной машине Azure.

Создание политики архивации

1. В меню политики архивации из раскрывающегося меню **Choose backup policy** (Выбор политики архивации) выберите **Создать**.

   ![создание новой политики архивации](./media/backup-azure-sql-database/create-new-backup-policy.png)

    Меню "Политика архивации" переключается для предоставления полей, необходимых для любой новой политики архивации SQL-сервера.

   ![новые поля политики архивации](./media/backup-azure-sql-database/blank-new-policy.png)

2. В поле **Имя политики** введите имя. 

3. Полное резервное копирование является обязательным. Для выбора полного резервного копирования можно принять значения по умолчанию или нажать кнопку **Полная резервная копия** для редактирования политики.

    ![новые поля политики архивации](./media/backup-azure-sql-database/full-backup-policy.png)

    В рамках политики полной резервной копии выберите периодичность "Ежедневно" или "Еженедельно". При выборе параметра "Ежедневно" выберите час и часовой пояс начала запуска задания резервного копирования. При выборе параметра "Ежедневно" для полного резервного копирования невозможно создать разностные резервные копии.

   ![параметр интервала "Ежедневно"](./media/backup-azure-sql-database/daily-interval.png)

    При выборе "Еженедельно", выберите день недели, час и часовой пояс перед началом запуска задания резервного копирования.

   ![параметр интервала "Еженедельно"](./media/backup-azure-sql-database/weekly-interval.png)

4. По умолчанию выбраны все параметры диапазона хранения (ежедневно, еженедельно, ежемесячно и ежегодно). Снимите флажки ограничений диапазона хранения, которые не требуются, и установите необходимые интервалы. В меню "Политика полной архивации" выберите **ОК** для подтверждения параметров.

   ![параметр интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

    Точки восстановления отмечены для хранения, исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день запускается создание только одной полной резервной копии. Если выбран параметр "Еженедельно", то резервная копия определенного дня помечается и хранится на основе еженедельного диапазона хранения. При выборе месячного и годового хранения все происходит аналогичным образом.

5. Чтобы добавить политику разностного резервного копирования, для открытия соответствующего меню нажмите кнопку **Разностная резервная копия**. 

   ![открытие разностной политики](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

    В меню "Политика разностной резервной копии" выберите **Включить** для открытия элементов управления периодичности и хранения. Максимально в день можно активировать одну разностную резервную копию.
    > [!Important] 
    > Максимально разностные резервные копии могут храниться до 180 дней. Если требуется более длительное хранение, необходимо использовать полные резервные копии. В этом случае использовать разностные резервные копии невозможно.
    >

   ![изменение разностной политики](./media/backup-azure-sql-database/enable-differential-backup-policy.png)

    Для сохранения политики и возврата к главному меню политики архивации нажмите кнопку **ОК**.

6. Чтобы добавить транзакционную политику резервного копирования журнала, для открытия соответствующего меню нажмите **Резервная копия журналов**. В меню "Резервная копия журнала" выберите **Включить** для открытия элементов управления периодичности и хранения. Резервное копирование журналов может происходить с частотой не чаще каждые 15 минут и храниться до 35 дней. Для сохранения политики и возврата к главному меню политики архивации нажмите кнопку **ОК**.

   ![изменение политики архивации журнала](./media/backup-azure-sql-database/log-backup-policy-editor.png)

7. Выберите, следует ли включить сжатие резервной копии SQL. По умолчанию сжатие отключено.

    На внутреннем сервере Azure Backup использует сжатие резервной копии собственной SQL.

8. После внесения всех изменений в политику архивации нажмите кнопку **ОК**. 

   ![разностный диапазон хранения](./media/backup-azure-sql-database/differential-backup-policy.png)

## <a name="restore-a-sql-database"></a>Восстановление базы данных SQL

Используя резервные копии журнала транзакций, Azure Backup предоставляет функциональные возможности для восстановления отдельных баз данных на определенную дату или время вплоть до определенной секунды. На основе предоставленного времени восстановления Azure Backup автоматически определяет соответствующую полную или разностную архивацию и цепочку резервных копий журнала, необходимых для восстановления данных.

Кроме того, можно выбрать конкретную полную или разностную резервную копию для восстановления определенной точки восстановления, а не конкретный момент времени.

Процедура восстановления базы данных

1. Откройте хранилище служб восстановления, зарегистрированное на виртуальной машине SQL.

2. На панели мониторинга хранилища выберите **Использование** архивных элементов, чтобы открыть меню "Архивные элементы".

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/restore-sql-vault-dashboard.png).

3. В меню **Элементы архивации** выберите тип управления резервными копиями **SQL в виртуальной машине Azure**. 

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/sql-restore-backup-items.png)

    Список "Элементы архивации" настраивается для отображения списка баз данных SQL. 

4. В списке баз данных SQL выберите базу данных, которую необходимо восстановить.

    ![выбор SQL из списка виртуальной машины Azure](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

    При выборе базы данных откроется соответствующее меню. Это меню содержит сведения об архивации для базы данных, в том числе:

    * самые старые и самые новые точки восстановления,
    * состояние журнала резервного копирования за последние 24 часа (для базы данных моделей восстановления с полным и неполным протоколированием, если модель настроена для архивирования журнала транзакций).

5. Для открытия меню "Восстановление" в меню выбранной базы данных щелкните **Восстановить базу данных**.

    ![выбор восстановления базы данных](./media/backup-azure-sql-database/restore-db-button.png)

    Откроется меню **Восстановление**, а также меню **Конфигурация восстановления**. Меню **Конфигурация восстановления** является первым шагом настройки восстановления. В этом меню выберите место, где требуется восстановить данные. Доступны следующие параметры.
    * Альтернативное расположение. Используйте этот параметр, если необходимо восстановить базу данных в другом месте, сохраняя при этом исходный источник базы данных.
    * Перезаписать базу данных. Восстанавливает данные в том же экземпляре SQL Server, где находится исходный источник. Суть в том, что перезаписывается исходная база данных.

    > [!Important]
    > Если выбранная база данных принадлежит к группе доступности AlwaysOn, SQL не позволит перезаписать базу данных. В этом случае включен только параметр **Альтернативное расположение**.
    >

    ![нажмите кнопку "Настроить", чтобы открыть меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-restore-configuration-menu.png)

### <a name="restore-to-an-alternate-location"></a>Восстановление в альтернативном расположении

Эта процедура описывает процесс восстановления данных в альтернативном расположении. Если необходимо перезаписать базу данных при восстановлении, перейдите в раздел [Восстановление и перезапись базы данных](backup-azure-sql-database.md#restore-and-overwrite-the-database). В этой процедуре предполагается, что хранилище служб восстановления открыто и находится в меню "Конфигурация восстановления". Если это не сделано, начните с раздела [Восстановление базы данных SQL](backup-azure-sql-database.md#restore-a-sql-database).

В раскрывающемся меню **Сервер** отображаются только SQL-серверы, зарегистрированные в хранилище служб восстановления. Чтобы найти сервер, если нужный сервер не находится в списке **Сервер**, см. раздел [Обнаружение базы данных SQL Server](backup-azure-sql-database.md#discover-sql-server-databases). В процессе обнаружения базы данных новые серверы будут зарегистрированы в хранилище служб восстановления.

1. В меню **Конфигурация восстановления** выполните следующие действия.

    * Выберите **Альтернативное расположение**.
    * В поле **Сервер** выберите SQL server, в котором необходимо восстановить базу данных.
    * В раскрывающееся меню **Экземпляр** выберите экземпляр SQL.
    * В диалоговом окне **Имя восстановленной базы данных** введите имя объекта.
    * Если это применимо, выберите параметр **Overwrite if the DB with the same name already exists on selected SQL instance** (Перезаписать, если база данных с тем же именем уже существует в выбранном экземпляре SQL).
    * Чтобы завершить настройку назначения и перейти к выбору точки восстановления, нажмите **OK**.

    ![выбор альтернативного расположения, экземпляра и имени в меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration-menu.png)

2. В меню **Выбор точки восстановления** можно выбрать либо журналы на момент времени, либо точку полного и разностного восстановления. Если необходимо восстановить определенный журнал на момент времени, продолжайте этот шаг. Если необходимо восстановить полную или разностную точку восстановления, перейдите к шагу 3.

    ![выбор точки восстановления](./media/backup-azure-sql-database/recovery-point-menu.png)

    Восстановление состояния системы на момент времени доступно только для резервных копий журналов для баз данных модели восстановления с полным протоколированием. Чтобы восстановить систему на определенный момент времени, выполните следующие действия.

    1. Выберите параметр восстановления **Logs (Point in Time)** (Журналы момента времени).

        ![выбор типа точки восстановления](./media/backup-azure-sql-database/recovery-point-logs.png)

    2. Чтобы открыть календарь, в разделе **Дата и время восстановления** щелкните значок календаря. Даты, выделенные жирным шрифтом, содержат точки восстановления, а текущая дата подсвечивается. Выберите в календаре дату с точками восстановления. Даты без точек восстановления выбрать невозможно.

        ![открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

        После выбора даты временная шкала отображает доступные точки восстановления в непрерывном диапазоне.

    3. С помощью графа временной шкалы или диалогового окна "Время" для точки восстановления укажите определенное время и нажмите кнопку **ОК**, чтобы выполнить шаг точки восстановления.
    
       ![открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-graph.png)

        Меню **Выбор точки восстановления** закроется, и откроется меню **Расширенная конфигурация**.

       ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    4. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы держать базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Целевой объект**.
        * Чтобы подтвердить параметры, нажмите кнопку **ОК** и закройте меню **Расширенная конфигурация**.

    5. Чтобы запустить задание восстановления, в меню **Восстановление** нажмите **Восстановить**. В области уведомлений можно отслеживать ход выполнения восстановления. Также можно отслеживать ход выполнения в заданиях восстановления базы данных.

       ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-job-notification.png)

3. В меню **Выбор точки восстановления** выберите точку восстановления. Выбрать можно либо "Logs (Point in Time)" (журналы на момент времени), либо "Full & Differential" (Полная и разностная). Если вы хотите восстановить журнал на момент времени, вернитесь к шагу 2. Этот шаг восстанавливает определенную полную или разностную точку восстановления. С помощью этого параметра можно увидеть все полные и разностные точки восстановления за последние 30 дней. Если необходимо увидеть точки восстановления старше 30 дней, нажмите кнопку **Фильтр**, чтобы открыть меню **Фильтрация точек восстановления**. При выборе разностной точки восстановления Azure Backup сначала восстанавливает соответствующие полные точки восстановления, а затем выполняет восстановление разностной точки восстановления.

    ![выбор точки восстановления](./media/backup-azure-sql-database/recovery-point-menu.png)

    1. В меню **Выбор точки восстановления** выберите **Full & Differential** (Полная и разностная).

       ![выбор точки восстановления](./media/backup-azure-sql-database/recovery-point-logs-fd.png)

        Появится список доступных точек восстановления.

    2. Чтобы завершить процедуру точки восстановления, в списке точек восстановления выберите точку восстановления и нажмите **ОК**. 

        ![выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)

        Меню **Точка восстановления** закроется, и откроется меню **Расширенная конфигурация**.

        ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    3. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы держать базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**. Параметр **Restore with NORECOVERY** (Восстановление с NORECOVERY) отключен по умолчанию.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Целевой объект**.
        * Чтобы подтвердить параметры, нажмите кнопку **ОК** и закройте меню **Расширенная конфигурация**.

    4. Чтобы запустить задание восстановления, в меню **Восстановление** нажмите **Восстановить**. В области уведомлений можно отслеживать ход выполнения восстановления. Также можно отслеживать ход выполнения в заданиях восстановления базы данных.

       ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-and-overwrite-the-database"></a>Восстановление и перезапись базы данных

Эта процедура описывает восстановление данных и перезапись базы данных. Если необходимо восстановить альтернативное расположение, перейдите в раздел [Восстановление в альтернативном расположении](backup-azure-sql-database.md#restore-to-an-alternate-location). В этой процедуре предполагается, что хранилище служб восстановления открыто и находится в меню **Конфигурация восстановления** (см. следующий рисунок). Если это не сделано, начните с раздела [Восстановление базы данных SQL](backup-azure-sql-database.md#restore-a-sql-database).

![нажмите кнопку "Настроить", чтобы открыть меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-overwrite-db.png)

В раскрывающемся меню **Сервер** отображаются только SQL-серверы, зарегистрированные в хранилище служб восстановления. Чтобы найти сервер, если нужный сервер не находится в списке **Сервер**, см. раздел [Обнаружение базы данных SQL Server](backup-azure-sql-database.md#discover-sql-server-databases). В процессе обнаружения базы данных новые серверы будут зарегистрированы в хранилище служб восстановления.

1. Чтобы завершить настройку назначения, в меню **Конфигурация восстановления** выберите пункт **Перезаписать базу данных** и нажмите кнопку **ОК**. 

   ![нажмите кнопку "Перезаписать базу данных"](./media/backup-azure-sql-database/restore-configuration-overwrite-db.png)

    Диалоговые окна **Сервер**, **Экземпляр** и **Имя восстановленной базы данных** являются необязательными.

2. В меню **Выбор точки восстановления** можно выбрать либо журналы на момент времени, либо точку полного и разностного восстановления. Если необходимо восстановить журнал на момент времени, продолжайте далее. Если необходимо восстановить полную и разностную точку восстановления, перейдите к шагу 3.

    ![выбор точки восстановления](./media/backup-azure-sql-database/recovery-point-menu.png)

    Восстановление состояния системы на момент времени доступно только для резервных копий журналов для баз данных модели восстановления с полным протоколированием. Чтобы выбрать момент времени восстановления до определенной секунды, выполните следующие действия.

    1. Выберите параметр восстановления **Logs (Point in Time)** (Журналы момента времени).

        ![выбор типа точки восстановления](./media/backup-azure-sql-database/recovery-point-logs.png)

    2. Чтобы открыть календарь, в разделе **Дата и время восстановления** щелкните значок календаря. Даты, выделенные жирным шрифтом, содержат точки восстановления, а текущая дата подсвечивается. Выберите в календаре дату с точками восстановления. Даты без точек восстановления выбрать невозможно.

        ![открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

        После выбора даты временная шкала отображает доступные точки восстановления.

    3. С помощью графа временной шкалы или диалогового окна "Время" для точки восстановления укажите определенное время и нажмите кнопку **ОК**, чтобы выполнить шаг точки восстановления.
    
       ![открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-graph.png)

        Меню **Выбор точки восстановления** закроется, и откроется меню **Расширенная конфигурация**.

       ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    4. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы держать базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Целевой объект**.
        * Чтобы подтвердить параметры, нажмите кнопку **ОК** и закройте меню **Расширенная конфигурация**.

    5. Чтобы запустить задание восстановления, в меню **Восстановление** нажмите **Восстановить**. В области уведомлений можно отслеживать ход выполнения восстановления. Также можно отслеживать ход выполнения в заданиях восстановления базы данных.

       ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-job-notification.png)

3. В меню **Выбор точки восстановления** выберите точку восстановления. Выбрать можно либо "Logs (Point in Time)" (журналы на момент времени), либо "Full & Differential" (Полная и разностная). Если вы хотите восстановить журнал на момент времени, вернитесь к шагу 2. Этот шаг восстанавливает определенную полную или разностную точку восстановления. С помощью этого параметра можно увидеть все полные и разностные точки восстановления за последние 30 дней. Если необходимо увидеть точки восстановления старше 30 дней, нажмите кнопку **Фильтр**, чтобы открыть меню **Фильтрация точек восстановления**. При выборе разностной точки восстановления Azure Backup сначала восстанавливает соответствующие полные точки восстановления, а затем выполняет восстановление разностной точки восстановления.

    ![выбор точки восстановления](./media/backup-azure-sql-database/recovery-point-menu.png)

    1. В меню **Выбор точки восстановления** выберите **Full & Differential** (Полная и разностная).

       ![выбор точки восстановления](./media/backup-azure-sql-database/recovery-point-logs-fd.png)

        Появится список доступных точек восстановления.

    2. Чтобы завершить процедуру точки восстановления, в списке точек восстановления выберите точку восстановления и нажмите **ОК**. 

        ![выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)

        Меню **Точка восстановления** закроется, и откроется меню **Расширенная конфигурация**.

        ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

    3. В меню **Расширенная конфигурация** выполните следующие действия.

        * Чтобы держать базу данных после восстановления в нерабочем состоянии, в меню **Restore with NORECOVERY** (Восстановление с NORECOVERY) выберите **Включено**. Параметр **Restore with NORECOVERY** (Восстановление с NORECOVERY) отключен по умолчанию.
        * Если необходимо изменить расположение восстановления на целевом сервере, укажите новый путь в столбце **Целевой объект**.
        * Чтобы подтвердить параметры, нажмите кнопку **ОК** и закройте меню **Расширенная конфигурация**.

    4. Чтобы запустить задание восстановления, в меню **Восстановление** нажмите **Восстановить**. В области уведомлений можно отслеживать ход выполнения восстановления. Также можно отслеживать ход выполнения в заданиях восстановления базы данных.

       ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-job-notification.png)


## <a name="manage-azure-backup-operations-for-sql-on-azure-vms"></a>Управление операциями резервного копирования Azure для SQL на виртуальных машинах Azure

В этом разделе представлена информация о различных операциях управления Azure Backup, доступных для SQL на виртуальных машинах Azure. Существуют следующие операции высокого уровня:

* мониторинг заданий;
* оповещения, связанные с архивацией;
* отключение защиты базы данных SQL;
* возобновление защиты базы данных SQL;
* запуск задания нерегламентированного резервного копирования;
* отмена регистрации сервера SQL.

### <a name="monitor-jobs"></a>Мониторинг заданий

Служба Azure Backup использует встроенные API SQL для всех операций резервного копирования. Используя собственные API, в базе данных msdb можно получить всю информацию о задании из таблицы [SQL backupset](https://docs.microsoft.com/sql/relational-databases/system-tables/backupset-transact-sql?view=sql-server-2017). Кроме того, Azure Backup отображает все запущенные вручную или нерегламентированные задания на портале заданий резервного копирования. Задания, доступные на портале, включают все операции резервного копирования, операции восстановления, операции регистрации и обнаружения баз данных и прекращение операций резервного копирования. Все запланированные задания также можно отслеживать с помощью аналитики журнала OMS. Использование аналитики журналов удаляет помехи заданий и обеспечивает высокую гибкость мониторинга или фильтрации определенных заданий.

![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/jobs-list.png)

### <a name="backup-alerts"></a>оповещения, связанные с архивацией;

При резервных копиях журналов, создающихсях каждые 15 минут, мониторинг заданий резервного копирования иногда может быть утомительным. Azure Backup запланировала эту потенциально утомительную ситуацию, предоставив оповещения по электронной почте, которые вызываются сбоем резервного копирования. Оповещения объединяются на уровне базы данных по коду ошибки. Например, если в базе данных имеется несколько сбоев резервного копирования, вместо получения предупреждения о каждом сбое, вы получаете электронное письмо о первом сбое. Затем можно войти на портал Azure для наблюдения за последующими ошибками для этой базы данных. 

Чтобы отслеживать оповещения резервного копирования, выполните следующие действия.

1. Войдите в подписку Azure на [портале Azure](https://portal.azure.com).

2. Откройте хранилище служб восстановления, зарегистрированное на виртуальной машине SQL.

3. В меню хранилища служб восстановления выберите **Alerts and Events** (Оповещения и события). 

   ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/vault-menu-alerts-events.png)

4. Чтобы просмотреть список предупреждений, в меню **Alerts and Events** (Оповещения и события) выберите **Оповещения, связанные с архивацией**.

   ![меню "Расширенная конфигурация"](./media/backup-azure-sql-database/backup-alerts-dashboard.png)

### <a name="stop-protection-on-a-sql-server-database"></a>Отключите защиту базы данных SQL Server

При отключении защиты базы данных SQL Server служба Azure Backup запросит, следует ли сохранять точки восстановления. Существует два способа отключения защиты базы данных SQL:

* остановить все будущие задания резервного копирования и удалить все точки восстановления;
* остановить все будущие задания резервного копирования, но сохранить точки восстановления. 

Оставление точек восстановления связано с определенными затратами, так как точки восстановления для SQL оплачиваются как защищенный экземпляр SQL, а также занимают объем хранилища. Для получения дополнительных сведений о ценообразовании Azure Backup для SQL см. раздел [Страница расценок Azure Backup](https://azure.microsoft.com/pricing/details/backup/). Чтобы остановить защиту базы данных, выполните следующие действия.

1. Откройте хранилище служб восстановления, зарегистрированное на виртуальной машине SQL.

2. На панели мониторинга хранилища выберите **Использование** архивных элементов, чтобы открыть меню "Архивные элементы".

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/restore-sql-vault-dashboard.png).

3. В меню **Элементы архивации** выберите тип управления резервными копиями **SQL в виртуальной машине Azure**. 

    ![Нажмите кнопку "Архивация", чтобы открыть меню "Цель резервного копирования".](./media/backup-azure-sql-database/sql-restore-backup-items.png)

    Список "Элементы архивации" настраивается для отображения списка баз данных SQL. 

4. В списке баз данных SQL выберите базу данных, для которой необходимо остановить защиту.

    ![выбор SQL из списка виртуальной машины Azure](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

    При выборе базы данных откроется соответствующее меню. 

5. Чтобы остановить защиту базы данных, в меню выбранной базы данных щелкните **Остановить архивацию**.

    ![выбор восстановления базы данных](./media/backup-azure-sql-database/stop-db-button.png)

    Откроется меню **Остановить архивацию**.

6. В меню **Остановить архивацию** выберите "Сохранить данные архивации" или "Удалить данные архивации". При необходимости можно указать причину остановки защиты и прокомментировать.

    ![выбор восстановления базы данных](./media/backup-azure-sql-database/stop-backup-button.png)

7. Чтобы отключить защиту базы данных, нажмите кнопку **Остановить архивацию**. 

### <a name="resume-protection-for-a-sql-database"></a>возобновление защиты базы данных SQL;

Если при остановке защиты базы данных SQL была выбрана опция **Сохранить данные архивации**, защиту можно возобновить. Если резервные данные не были сохранены, защиту невозможно возобновить. 

1. Чтобы возобновить защиту базы данных SQL, откройте элемент резервного копирования и выберите **Возобновить резервное копирование**.

    ![возобновление защиты базы данных](./media/backup-azure-sql-database/resume-backup-button.png)

   Откроется меню "Политика резервного копирования".

2. В меню **Политика резервного копирования** выберите политику и нажмите кнопку **Сохранить**.

### <a name="trigger-an-adhoc-backup"></a>Активация задания нерегламентированного резервного копирования

Активировать нерегламентированное резервное копирование можно в любой момент. Существует четыре типа нерегламентированного резервного копирования. Подробные сведения о каждом типе см. в статье [Типы резервного копирования SQL](https://docs.microsoft.com/sql/relational-databases/backup-restore/backup-overview-sql-server?view=sql-server-2017#types-of-backups).

* Полная резервная копия
* Копировать только полные резервные копии
* Разностная резервная копия
* Резервное копирование журналов

### <a name="unregister-a-sql-server"></a>Отмена регистрации сервера SQL

Чтобы отменить регистрацию SQL server после удаления защиты, но прежде чем удалить хранилище, выполните следующие действия.

1. Откройте хранилище служб восстановления, зарегистрированное на виртуальной машине SQL.

2. В разделе **Управление** в меню хранилища щелкните **Резервное копирование инфраструктуры**.  

   ![возобновление защиты базы данных](./media/backup-azure-sql-database/backup-infrastructure-button.png)

3. В разделе **Серверы управления** выберите элемент **Защищенные серверы**.

   ![возобновление защиты базы данных](./media/backup-azure-sql-database/protected-servers.png)

    Откроется меню "Защищенные серверы". 

4. В меню **Защищенные серверы** выберите сервер, на котором необходимо отменить регистрацию. Если вы хотите удалить хранилище, необходимо отменить регистрацию всех серверов.

5. В меню "Защищенные серверы" щелкните правой кнопкой мыши защищенный сервер и выберите команду **Удалить**. 

   ![возобновление защиты базы данных](./media/backup-azure-sql-database/delete-protected-server.png)

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о службе Azure Backup см. в образце PowerShell для архивации зашифрованных виртуальных машин.

> [!div class="nextstepaction"]
> [Back up an encrypted Azure virtual machine with PowerShell](./scripts/backup-powershell-sample-backup-encrypted-vm.md) (Архивация зашифрованных виртуальных машин Azure с помощью PowerShell)
