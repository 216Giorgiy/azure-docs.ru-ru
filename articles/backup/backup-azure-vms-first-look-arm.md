<properties
	pageTitle="Защита виртуальных машин ARM с помощью службы архивации Azure | Microsoft Azure"
	description="Защита виртуальных машин ARM с помощью службы архивации Azure. Использование резервных копий виртуальных машин ARM и виртуальных машин хранилища класса Premium для защиты данных. Создание и регистрация хранилища служб восстановления. Регистрация виртуальных машин, создание политики и защита виртуальных машин в Azure."
	services="backup"
	documentationCenter=""
	authors="markgalioto"
	manager="jwhit"
	editor=""
	keyword="backups; vm backup"/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="03/31/2016"
	ms.author="markgal; jimpark"/>


# Общие сведения о резервном копировании виртуальных машин ARM в хранилище служб восстановления

> [AZURE.SELECTOR]
- [Резервное копирование виртуальных машин ARM](backup-azure-vms-first-look-arm.md)
- [Резервное копирование виртуальных машин — классическая модель](backup-azure-vms-first-look.md)

В этом руководстве подробно описано, как создать хранилище служб восстановления и выполнить резервное копирование виртуальной машины Azure. Хранилища служб восстановления защищают следующие ресурсы:

- виртуальные машины диспетчера ресурсов Azure (ARM);
- классические виртуальные машины;
- виртуальные машины стандартного хранилища;
- виртуальные машины хранилища класса Premium.

Дополнительные сведения о защите ВМ хранилища класса Premium см. в статье [Что такое служба архивации Azure?](backup-introduction-to-azure-backup.md#back-up-and-restore-premium-storage-vms)

>[AZURE.NOTE] В этом руководстве предполагается, что в вашей подписке Azure уже есть виртуальная машина. Кроме того, вам нужно предоставить службе архивации доступ к виртуальной машине. В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Resource Manager и классическая модель](../resource-manager-deployment-model.md). Эта статья предназначена для использования с виртуальными машинами на базе Resource Manager и ARM.

Процесс будет включать следующие основные этапы.

1. Создание хранилища служб восстановления для виртуальных машин.
2. Выбор сценария, установка политики и указание объектов, которые нужно защитить, на портале Azure.
3. Выполнение начального резервного копирования.



## Шаг 1. Создание хранилища служб восстановления для виртуальных машин

Хранилище служб восстановления — это сущность, в которой хранятся созданные резервные копии и точки восстановления. В нем также содержится политика резервного копирования, которая применяется к защищенным виртуальным машинам.

>[AZURE.NOTE] Резервное копирование виртуальных машин выполняется локально. Нельзя создавать резервные копии виртуальных машин, которые находятся в одном расположении, в хранилище служб восстановления в другом расположении. Таким образом, в каждом расположении Azure, в котором находятся виртуальные машины, требующие резервного копирования, должно быть по крайней мере одно хранилище служб восстановления.


Чтобы создать хранилище служб восстановления, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com/).

2. В главном меню щелкните **Обзор**, а затем в списке ресурсов введите **Службы восстановления**. Как только вы начнете вводить, список отфильтруется соответствующим образом. Щелкните **Хранилище служб восстановления**.

    ![Создание хранилища служб восстановления — шаг 1](./media/backup-azure-vms-first-look-arm/browse-to-rs-vaults.png) <br/>

    После этого отобразится список хранилищ служб восстановления.

3. В меню **Хранилища служб восстановления** щелкните **Добавить**.

    ![Создание хранилища служб восстановления — шаг 2](./media/backup-azure-vms-first-look-arm/rs-vault-menu.png)

    Откроется колонка хранилища служб восстановления, в которой нужно указать **имя**, **подписку**, **группу ресурсов** и **расположение**.

    ![Создание хранилища служб восстановления — шаг 5](./media/backup-azure-vms-first-look-arm/rs-vault-attributes.png)

4. В поле **Имя** введите понятное имя хранилища. Имя должно быть уникальным в пределах подписки Azure. Введите имя длиной от 2 до 50 знаков. Имя должно начинаться с буквы, оно может содержать только буквы, цифры и дефисы.

5. Щелкните **Подписка**, чтобы просмотреть список доступных подписок. Если неизвестно, какую подписку нужно использовать, оставьте подписку по умолчанию (или предлагаемую подписку). Вариантов будет несколько только в том случае, если учетная запись вашей организации связана с несколькими подписками Azure.

6. Щелкните **Группа ресурсов**, чтобы просмотреть список доступных групп ресурсов, или создайте группу ресурсов, щелкнув **Создать**. Дополнительные сведения о группах ресурсов см. в статье [Развертывание ресурсов Azure и управление ими с помощью портала Azure](../azure-portal/resource-group-portal.md).

7. В поле **Расположение** выберите географический регион, в котором будет находиться хранилище. Хранилище **должно** находиться в том же регионе, что и виртуальные машины, которые вы намерены защитить.

    >[AZURE.IMPORTANT] Если вы не уверены, в каком расположении находится ваша виртуальная машина, закройте диалоговое окно создания хранилища и перейдите к списку виртуальных машин на портале. Если у вас есть виртуальные машины в нескольких регионах, вам необходимо создать хранилище служб восстановления в каждом из них. Прежде чем переходить к следующему расположению, необходимо создать хранилище в первом расположении. Указывать учетные записи хранения для данных резервных копий не требуется: хранилище служб восстановления и служба архивации Azure сделают это автоматически.

8. Щелкните **Создать**. Для создания хранилища служб восстановления может потребоваться некоторое время. Следите за уведомлениями о состоянии на портале в верхней правой области. Сразу после создания хранилище откроется на портале.

9. В хранилище щелкните **Все параметры** > **Настройка резервного копирования**. Отобразится элемент **Тип репликации хранилища**. Выберите тип репликации для хранилища.

    ![Список хранилищ службы архивации](./media/backup-azure-vms-first-look-arm/choose-storage-configuration.png)

    По умолчанию это геоизбыточное хранилище. Если вы используете Azure в качестве конечной точки основного хранилища службы архивации, рекомендуем продолжать использовать геоизбыточное хранилище. Если Azure используется как конечная точка дополнительного хранилища архивации, можно попробовать использовать локально избыточное хранилище. Это позволит вам снизить затраты на хранение данных в Azure. Дополнительные сведения о [геоизбыточном](../storage/storage-redundancy.md#geo-redundant-storage) и [локально избыточном](../storage/storage-redundancy.md#locally-redundant-storage) хранилищах см. в этом [обзоре](../storage/storage-redundancy.md).

    Выбрав параметры хранилища, вы можете приступать к связыванию виртуальной машины с хранилищем. Перед началом связывания нужно обнаружить и зарегистрировать виртуальные машины Azure.

## Шаг 2. Выбор политики сценария и определение объектов для защиты
Прежде чем регистрировать виртуальную машину в хранилище, нужно запустить процесс обнаружения, чтобы определить все недавно добавленные в подписку виртуальные машины. В ходе этого процесса в Azure отправляется запрос о предоставлении списка виртуальных машин в подписке и дополнительных сведений, в том числе имени и региона облачной службы.

1. Если хранилище служб восстановления уже открыто, перейдите к шагу 2. Если хранилище служб восстановления не открыто, на портале Azure в главном меню щелкните **Обзор**.

    - В списке ресурсов введите **Службы восстановления**.
    - Как только вы начнете вводить, список отфильтруется соответствующим образом. Когда появится пункт **Хранилища служб восстановления**, щелкните его.

    ![Создание хранилища служб восстановления — шаг 1](./media/backup-azure-vms-first-look-arm/browse-to-rs-vaults.png) <br/>

    После этого отобразится список хранилищ служб восстановления,

    - в котором нужно выбрать хранилище.

    Затем откроется панель мониторинга выбранного хранилища.

    ![Открытие колонки хранилища](./media/backup-azure-vms-first-look-arm/vault-settings.png)

2. В меню панели мониторинга хранилища щелкните **Резервное копирование**, чтобы открыть соответствующую колонку.

    ![Открытие колонки резервного копирования](./media/backup-azure-vms-first-look-arm/backup-button.png)

    Когда колонка откроется, служба архивации начнет поиск новых виртуальных машин в подписке.

    ![Обнаружение виртуальных машин](./media/backup-azure-vms-first-look-arm/discovering-new-vms.png)

3. В колонке резервного копирования щелкните **Сценарий**, чтобы открыть колонку сценария.

    ![Открытие колонки сценария](./media/backup-azure-vms-first-look-arm/select-backup-scenario-one.png)

4. В колонке "Сценарий" меню **Тип резервного копирования** выберите пункт **Резервное копирование виртуальной машины Azure** и нажмите кнопку **ОК**.

    ![Открытие колонки сценария](./media/backup-azure-vms-first-look-arm/select-rs-backup-scenario-two.png)

    После этого колонка сценария закроется, и откроется колонка политики резервного копирования.

5. В колонке "Резервное копирование" выберите политику резервного копирования для своего хранилища и нажмите кнопку **ОК**.

    ![Выбор политики резервного копирования](./media/backup-azure-vms-first-look-arm/setting-rs-backup-policy.png)

    Политика по умолчанию указана в области сведений. Если вы хотите создать новую политику, щелкните **Создать**. Инструкции по определению политики резервного копирования см. в разделе [Определение политики резервного копирования](backup-azure-vms-first-look-arm.md#defining-a-backup-policy). Как только вы нажмете кнопку "ОК", политика резервного копирования будет связана с хранилищем. Теперь нужно выбрать виртуальные машины, которые нужно связать с хранилищем.

6. Выберите виртуальные машины, чтобы связать их с указанной политикой, и нажмите кнопку **Выбрать**.

    ![Выбор рабочей нагрузки](./media/backup-azure-vms-first-look-arm/select-vms-to-backup.png)

    Если нужной виртуальной машины нет в списке, щелкните **Обновить**. Если эта виртуальная машина так и не появится, проверьте, относится ли она к тому же расположению Azure, что и хранилище служб восстановления.

7. Теперь, когда все параметры для хранилища заданы, в колонке резервного копирования в нижней части страницы нажмите кнопку **Включить резервное копирование**. В результате выполнения этой команды для хранилища и виртуальных машин будет развернута политика.

    ![Включить резервное копирование](./media/backup-azure-vms-first-look-arm/enable-backup-settings.png)


## Шаг 3. Начальное резервное копирование

Если политика резервного копирования развернута на виртуальной машине, это не означает, что резервное копирование данных уже выполнено. По умолчанию начальным резервным копированием является первое запланированное резервное копирование (заданное в политике резервного копирования). Пока начальное резервное копирование не будет выполнено, для последнего задания резервного копирования в колонке **Задания резервного копирования** будет отображаться состояние **Предупреждение (в ожидании начального резервного копирования)**.

![Статус "В ожидании резервного копирования"](./media/backup-azure-vms-first-look-arm/initial-backup-not-run.png)

Если плановое начальное резервное копирование должно начаться не скоро, мы советуем выполнить **моментальное резервное копирование**.

Чтобы выполнить **моментальное резервное копирование**, выполните следующие действия.

1. На панели мониторинга хранилища на плитке **Резервное копирование** щелкните **Виртуальные машины Azure**. <br/> ![Значок "Параметры"](./media/backup-azure-vms-first-look-arm/rs-vault-in-dashboard-backup-vms.png)

    Откроется колонка **Объекты резервного копирования**.

2. В колонке **Объекты резервного копирования** щелкните правой кнопкой мыши хранилище, резервную копию которого хотите создать, и выберите пункт **Моментальное резервное копирование**.

    ![Значок "Параметры"](./media/backup-azure-vms-first-look-arm/back-up-now.png)

    Будет запущено задание резервного копирования. <br/>

    ![Задание резервного копирования активировано](./media/backup-azure-vms-first-look-arm/backup-triggered.png)

3. Чтобы просмотреть, закончилось ли начальное резервное копирование, на панели мониторинга хранилища под элементом **Задания резервного копирования** щелкните **Виртуальные машины Azure**.

    ![Элемент "Задания резервного копирования"](./media/backup-azure-vms-first-look-arm/open-backup-jobs.png)

    После этого откроется колонка "Задания резервного копирования".

4. В колонке "Задания резервного копирования" можно просмотреть состояние всех заданий.

    ![Элемент "Задания резервного копирования"](./media/backup-azure-vms-first-look-arm/backup-jobs-in-jobs-view.png)

    >[AZURE.NOTE] В ходе резервного копирования служба архивации Azure дает команду расширению для резервного копирования на каждой виртуальной машине сохранять на диск все данные операций записи и делать согласованный моментальный снимок.

    После завершения задания резервного копирования состояние изменится на *Завершено*.

## Добавление политики резервного копирования

Политика резервного копирования определяет расписание создания моментальных снимков и период их хранения. В параметрах политики резервного копирования виртуальной машины можно задать *ежедневное* выполнение задания резервного копирования. Созданная политика применяется к хранилищу. Интерфейс политики резервного копирования выглядит следующим образом:

![Политика резервного копирования](./media/backup-azure-vms-first-look-arm/backup-policy-daily-raw.png)

Чтобы создать политику, сделайте следующее:

1. В поле **Имя политики** укажите имя политики.

2. Моментальные снимки данных можно создавать ежедневно или еженедельно. Этот интервал можно выбрать с помощью раскрывающегося списка **Частота резервного копирования**.

    - При выборе ежедневного интервала используйте выделенный элемент управления, чтобы выбрать время создания моментального снимка. Чтобы изменить время, отмените выбор установленного времени и задайте новое.

    ![Политика выполнения резервного копирования ежедневно](./media/backup-azure-vms-first-look-arm/backup-policy-daily.png) <br/>

    - При выборе еженедельного интервала используйте выделенные элементы управления, чтобы выбрать день и время создания моментального снимка. В раскрывающемся списке дней выберите один или несколько дней. В раскрывающемся списке времени выберите время. Чтобы изменить время, отмените выбор установленного времени и задайте новое.

    ![Политика выполнения резервного копирования еженедельно](./media/backup-azure-vms-first-look-arm/backup-policy-weekly.png)

3. По умолчанию для параметра **Диапазон хранения** выбраны все значения. Если вам нужно оставить лишь определенные значения, оставьте флажки напротив соответствующих значений.

    >[AZURE.NOTE] В рамках защиты виртуальной машины задание резервного копирования выполняется раз в день. Время запуска резервного копирования одинаковое независимо от диапазона хранения.

    Укажите необходимые интервалы, используя соответствующие элементы управления. С помощью параметров ежемесячного и ежегодного хранения можно задать период хранения моментальных снимков по мере добавления новых снимков каждый день или каждый месяц.

4. После настройки всех параметров политики нажмите кнопку **ОК** в нижней части колонки.

    Новая политика будет применена к хранилищу сразу после завершения настройки хранилища служб восстановления. Вернитесь к шагу 6 раздела [Выбор политики сценария и определение объектов для защиты](backup-azure-vms-first-look-arm.md#step-2---select-scenario-set-policy-and-define-items-to-protect).

## Установка агента ВМ на виртуальной машине

Эта информация приведена на случай необходимости. Агент VM Azure необходимо установить на виртуальной машине Azure, чтобы обеспечить работоспособность модуля резервного копирования. Однако если виртуальная машина создана из коллекции Azure, в ней уже установлен агент. На виртуальных машинах, которые переносятся из локальных центров обработки данных, агент отсутствует. Для таких виртуальных машин агент необходимо установить. Если у вас возникли сложности с резервным копированием виртуальной машины Azure, убедитесь, что на ней правильно установлен агент ВМ Azure (см. таблицу ниже). При создании пользовательской виртуальной машины [обязательно установите флажок **Установить агент ВМ** до начала подготовки ВМ](../virtual-machines/virtual-machines-windows-classic-agents-and-extensions.md).

См. дополнительные сведения об [агенте виртуальной машины](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) и [ее установке](../virtual-machines/virtual-machines-windows-classic-manage-extensions.md).

В таблице ниже приведены дополнительные сведения об агенте для виртуальных машин Windows и Linux.

| **Операция** | **Windows** | **Linux** |
| --- | --- | --- |
| Установка агента VM | <li>Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора. <li>[Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. | <li> Установите последнюю версию [агента Linux](https://github.com/Azure/WALinuxAgent) с сайта GitHub. Чтобы выполнить установку, необходимо иметь права администратора. <li> [Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. |
| Обновление агента виртуальной машины | Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). <br>Убедитесь, что во время обновления агента ВМ не выполняются задания резервного копирования. | Следуйте инструкциям по [обновлению агента ВМ Linux](../virtual-machines-linux-update-agent.md). <br>Убедитесь, что во время обновления агента ВМ не выполняются задания резервного копирования. |
| Проверка установки агента VM | <li>На виртуальной машине Azure перейдите в папку *C:\\WindowsAzure\\Packages*. <li>В ней должен находиться файл WaAppAgent.exe.<li> Щелкните этот файл правой кнопкой мыши, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше. | Недоступно |


### Расширение резервного копирования

Когда агент будет установлен на виртуальной машине, служба архивации Azure установит для агента модуль резервного копирования. Служба резервного копирования Azure легко обновляет и применяет исправления к расширению резервного копирования без дополнительного вмешательства пользователя.

Модуль резервного копирования устанавливается службой архивации независимо от того, запущена ли виртуальная машина. На запущенной виртуальной машине проще получить точку восстановления, согласованную с приложениями. При этом служба архивации Azure будет продолжать архивацию виртуальной машины, даже если она выключена, а установить модуль невозможно (автономная виртуальная машина). В этом случае точка восстановления будет *аварийно согласованной*.

## Сведения об устранении неполадок
Если у вас возникли проблемы при выполнении задач, описанных в этой статье, изучите статью [Устранение неполадок при архивации виртуальных машин Azure](backup-azure-vms-troubleshoot.md).


## Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

<!---HONumber=AcomDC_0420_2016-->