.<properties
	pageTitle="Устранение неполадок при резервном копировании виртуальных машин Azure | Microsoft Azure"
	description="Устранение неполадок при резервном копировании и восстановлении виртуальных машин Azure"
	services="backup"
	documentationCenter=""
	authors="trinadhk"
	manager="shreeshd"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/26/2016"
	ms.author="trinadhk;jimpark;"/>


# Устранение неполадок при архивации виртуальных машин Azure

> [AZURE.SELECTOR]
- [Хранилище служб восстановления](backup-azure-vms-troubleshoot.md)
- [Хранилище службы архивации](backup-azure-vms-troubleshoot-classic.md)

Для устранения ошибок, обнаруженных в ходе применения службы архивации Azure, можно использовать информацию из следующей таблицы.

## Архивация

| Операция резервного копирования | Сведения об ошибке | Возможное решение |
| -------- | -------- | -------|
|Архивация|	Не удалось выполнить операцию, так как виртуальная машина больше не существует. Остановите защиту виртуальной машины, не удаляя данные резервных копий. См. дополнительные сведения по адресу http://go.microsoft.com/fwlink/?LinkId=808124 |Это происходит, когда основная виртуальная машина удаляется, но политика резервного копирования продолжает поиск виртуальной машины, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, сделайте следующее. <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов [имя облачной службы]. <br> </li><li> Остановите защиту этой виртуальной машины, удаляя или не удаляя данные резервных копий. [Дополнительные сведения](http://go.microsoft.com/fwlink/?LinkId=808124)</li></ol>|
|Архивация|Не удалось запросить состояние моментального снимка в агенте виртуальной машины. Убедитесь, что у виртуальной машины есть доступ к Интернету. Кроме того, обновите агент виртуальной машины, как указано в руководстве по устранению неполадок на странице http://go.microsoft.com/fwlink/?LinkId=800034 |Данная ошибка возникает, если существует проблема с агентом виртуальной машины, или каким-то образом заблокирован сетевой доступ к инфраструктуре Azure. Узнайте больше об отладке проблем с моментальными снимками виртуальной машины.<br> Если агент виртуальной машины не вызывает проблем, перезапустите виртуальную машину. Иногда проблемы возникают из-за неправильного состояния виртуальной машины. Его можно сбросить, перезапустив виртуальную машину.|
|Архивация|	Не удалось выполнить операцию расширения служб восстановления. Убедитесь, что на виртуальной машине установлена последняя версия агента виртуальной машины и что служба агента запущена. Повторите операцию резервного копирования. В случае сбоя обратитесь в службу поддержки Майкрософт.|	Эта ошибка возникает, если версия агента виртуальной машины устаревшая. См. раздел "Обновление агента виртуальной машины" ниже.|
|Архивация |Виртуальная машина не существует. Убедитесь, что виртуальная машина существует, или выберите другую виртуальную машину. | Это происходит, когда основная виртуальная машина удаляется, но политика резервного копирования продолжает поиск виртуальной машины, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, сделайте следующее. <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов [имя облачной службы]. <br> <br></li><li>Остановите защиту этой виртуальной машины, не удаляя данные резервных копий. [Дополнительные сведения](http://go.microsoft.com/fwlink/?LinkId=808124)</li></ol>|
|Архивация |Не удалось выполнить команду. С этим элементом выполняется другая операция. Дождитесь завершения предыдущей операции и повторите попытку. |Выполняется текущее задание резервного копирования или восстановления для виртуальной машины. В это время запуск нового задания невозможен.|
| Архивация | Время ожидания копирования виртуальных жестких дисков из архивного хранилища истекло. Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. | Это происходит, если имеется слишком много данных для копирования. Убедитесь, что у вас меньше 16 дисков данных. |
| Архивация | Произошла внутренняя ошибка архивации. Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт | Эта ошибка может возникнуть по двум причинам. <ol><li> Существует временная проблема с доступом к хранилищу виртуальной машины. Проверьте [состояние Azure](https://azure.microsoft.com/ru-RU/status/), чтобы определить, есть ли в настоящее время проблемы, связанные с вычислительными, сетевыми ресурсами или ресурсами хранения в регионе. Повторите попытку, чтобы проверить, что проблема архивации устранена. <li>Исходная виртуальная машина удалена, поэтому, резервное копирование не может быть выполнено. Чтобы сохранить данные архивации удаленной виртуальной машины, но прекратить появление ошибок при резервном копировании, снимите защиту с виртуальной машины и выберите вариант, при котором данные сохраняются. В результате резервное копирование будет остановлено, и перестанут появляться сообщения об ошибках. |
| Архивация | Не удалось установить расширение служб восстановления Azure для выбранного элемента. Необходимым условием для расширения служб восстановления Azure является наличие агента виртуальной машины. Установите агент виртуальной машины Azure и перезапустите операцию регистрации. | <ol> <li>Убедитесь, что агент виртуальной машины установлен правильно. <li>Убедитесь, что флаг в конфигурации виртуальной машины имеет правильное значение.</ol> [Дополнительные сведения](#validating-vm-agent-installation) об установке агента виртуальной машины и проверке установки агента виртуальной машины. |
| Архивация | Во время установки расширения произошла ошибка «Отсутствует связь COM+ с координатором распределенных транзакций». | Обычно это означает, что служба COM+ не запущена. Чтобы устранить эту проблему, обратитесь в службу поддержки Майкрософт. |
| Архивация | Во время операции создания снимка возникла ошибка операции VSS «Этот диск заблокирован программой шифрования диска BitLocker. Вернитесь к панели управления, чтобы разблокировать диск». | Отключите BitLocker для всех дисков на виртуальной машине и проверьте, устранена ли проблема с VSS. |
| Архивация | Виртуальные машины с виртуальными жесткими дисками, хранящимися в хранилище класса Premium, не поддерживаются при резервном копировании. | None |
| Архивация | Виртуальная машина Azure не найдена. | Это происходит, когда основная виртуальная машина удаляется, но политика резервного копирования продолжает поиск виртуальной машины, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, сделайте следующее. <ol><li>Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов [имя облачной службы]. <br>(ИЛИ) <li>Отключите защиту этой виртуальной машины, чтобы задания резервного копирования не создавались. </ol> |
| Архивация | На виртуальной машине отсутствует агент виртуальной машины. Установите необходимые компоненты, агент виртуальной машины и перезапустите операцию. | [Дополнительные сведения](#vm-agent) об установке агента виртуальной машины и проверке установки агента виртуальной машины. |

## Задания

| Операция | Сведения об ошибке | Возможное решение |
| -------- | -------- | -------|
| Отмена задания | Для этого типа задания отмена не поддерживается. Дождитесь завершения задания. | None |
| Отмена задания | Состояние задания не позволяет его отменить. Дождитесь завершения задания. <br>ИЛИ<br> Состояние выбранного задания не позволяет его отменить. Дождитесь завершения задания.| Скорее всего, задание почти выполнено. Дождитесь завершения задания. |
| Отмена задания | Нельзя отменить задание, так как оно не выполняется. Задания можно отменять только в процессе выполнения. Попытайтесь отменить выполняющееся задание. | Это происходит из-за переходного состояния. Подождите минуту и повторите отмену. |
| Отмена задания | Не удалось отменить задание. Дождитесь завершения задания. | None |


## Восстановление
| Операция | Сведения об ошибке | Возможное решение |
| -------- | -------- | -------|
| Восстановление | Сбой восстановления из-за внутренней ошибки облака | <ol><li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроены параметры DNS. Проверьте параметр <br>$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production" Get-AzureDns -DnsSettings $deployment.DnsSettings<br>Если настроен адрес, это означает, что настроены параметры DNS.<br> <li>Для облачной службы, в которую вы пытаетесь восстановить данные, настроен зарезервированный IP-адрес, и существующие виртуальные машины в облачной службе находятся в остановленном состоянии.<br>Можно проверить, есть ли у облачной службы зарезервированный IP-адрес, используя следующие командлеты PowerShell:<br>$deployment = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName <br><li>Вы пытаетесь восстановить виртуальную машину со следующими специальными конфигурациями сети в ту же облачную службу.<br> Виртуальные машины в конфигурации балансировщика нагрузки (внутреннего и внешнего).<br> Виртуальные машины с несколькими зарезервированными IP-адресами.<br> Виртуальные машины с несколькими сетевыми картами.<br>Выберите новую облачную службу в пользовательском интерфейсе или ознакомьтесь с [рекомендациями по восстановлению](./backup-azure-arm-restore-vms.md/#restoring-vms-with-special-network-configurations) для виртуальных машин со специальными конфигурациями сети.</ol> |
| Восстановление | Выбранное DNS-имя уже занято. Укажите другое DNS-имя и повторите попытку. | Указанное здесь DNS-имя ссылается на имя облачной службы (обычно с расширением CLOUDAPP.NET). Это имя должно быть уникальным. Если возникает эта ошибка, во время восстановления необходимо выбрать другое имя виртуальной машины. <br><br> Обратите внимание, что эта ошибка отображается только для пользователей портала Azure. Восстановление с помощью PowerShell будет выполнено успешно, так как восстанавливаются только диски, а виртуальная машина не создается. Ошибка возникнет, если вы явно создадите виртуальную машину после восстановления дисков. |
| Восстановление | Указана неправильная конфигурация виртуальной сети. Укажите другую конфигурацию виртуальной сети и повторите попытку. | None |
| Восстановление | Указанная облачная служба использует зарезервированный IP-адрес, который не совпадает с конфигурацией восстанавливаемой виртуальной машины. Укажите другую облачную службу, которая не использует зарезервированный IP-адрес, или выберите другую точку восстановления. | None |
| Восстановление | Облачная служба достигла ограничения на количество входных конечных точек. Повторите операцию, указав другую облачную службу или используя существующую конечную точку. | None |
| Восстановление | Хранилище службы архивации и целевая учетная запись хранения находятся в двух разных регионах. Убедитесь, что учетная запись хранения, указанная в операции восстановления, находится в том же регионе Azure, что и хранилище службы архивации. | None |
| Восстановление | Учетная запись хранения, указанная для операции восстановления, не поддерживается. Поддерживаются только базовые или стандартные учетные записи хранения с локально избыточными или геоизбыточными параметрами репликации. Выберите поддерживаемую учетную запись хранения. | None |
| Восстановление | Тип учетной записи хранения, указанной для операции восстановления, не подключен к сети. Убедитесь, что учетная запись хранения, указанная в операции восстановления, подключена к сети. | Это может произойти из-за временных ошибок в службе хранилища Azure или из-за сбоя. Выберите другую учетную запись хранения. |
| Восстановление | Достигнута квота группы ресурсов. Удалите некоторые группы ресурсов с портала Azure или обратитесь в службу поддержки Azure, чтобы увеличить пределы. | None |
| Восстановление | Выбранная подсеть не существует. Выберите существующую подсеть. | None |


## Политика
| Операция | Сведения об ошибке | Возможное решение |
| -------- | -------- | -------|
| Создание политики | Не удалось создать политику. Сократите количество вариантов хранения, чтобы продолжить настройку политики. | None |


## Агент виртуальной машины

### Настройка агента виртуальной машины
Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом. Подробности об [установке агента ВМ на существующей виртуальной машине](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).

Для виртуальных машин Windows:

- Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
- [Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен.

Для виртуальных машин Linux:

- Установите последнюю версию [агента Linux](https://github.com/Azure/WALinuxAgent) с сайта GitHub.
- [Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен.


### Обновление агента виртуальной машины
Для виртуальных машин Windows:

- Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Тем не менее, необходимо убедиться, что во время обновления агента виртуальной машины никакие операции резервного копирования не выполняются.

Для виртуальных машин Linux:

- Следуйте инструкциям по [обновлению агента виртуальной машины Linux](../virtual-machines/virtual-machines-linux-update-agent.md).


### Проверка установки агента виртуальной машины
Для проверки версии агента ВМ на виртуальных машинах Windows выполните следующие действия:

1. Войдите в систему виртуальной машины Azure и перейдите в папку *C:\\WindowsAzure\\Packages*. В ней должен находиться файл WaAppAgent.exe.
2. Щелкните правой кнопкой мыши этот файл, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше.

## Решение проблем со снимками виртуальных машин
Резервное копирование виртуальных машин зависит от команды моментального снимка в базовом хранилище. Отсутствие доступа к хранилищу или задержка в выполнении задачи создания моментального снимка может привести к неудачному завершению резервного копирования. Неудачное завершение задачи создания снимка может быть вызвано следующими факторами.

1. Сетевой доступ к хранилищу блокируется при помощи групп NSG.<br> Узнайте о том, как [включить сетевой доступ](backup-azure-vms-prepare.md#2-network-connectivity) к хранилищу с помощью списка разрешенных IP-адресов или прокси-сервера.
2.  Виртуальные машины с настроенной архивацией SQL Server могут вызвать задержку задачи создания моментальных снимков. <br> По умолчанию при архивации виртуальной машины выполняется полная архивация VSS на виртуальных машинах Windows. На виртуальных машинах, на которых запускается SQL Server и настроено резервное копирование SQL Server, это может привести к задержке в выполнении моментального снимка. При возникновении ошибок резервного копирования из-за проблем моментальных снимков, пожалуйста, установите следующий ключ реестра.

	```
	[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
	"USEVSSCOPYBACKUP"="TRUE"
	```
3.  Состояние виртуальной машины отображается неправильно из-за того, что работа виртуальной машины была завершена в сеансе удаленного рабочего стола. <br> При завершении работы виртуальной машины в сеансе RDP проверьте, правильно ли отображается на портале состояние виртуальной машины. Если это не так, завершите работу виртуальной машины на портале с помощью команды "Завершение работы" в панели мониторинга виртуальной машины.
4.  Если больше четырех виртуальных машин используют одну облачную службу, настройте несколько политик архивации, задав время архивации таким образом, чтобы выполнялась архивация не более четырех виртуальных машин одновременно. Задайте время начала архивации в разных политиках так, чтобы между ними был один час разницы.
5.  Виртуальная машина использует много ресурсов ЦП или памяти.<br> Если виртуальная машина работает при большой загрузке процессора (более 90 %) или памяти, задача создания моментального снимка помещается в очередь, задерживается, и в конце концов время ожидания истекает. В таких ситуациях попробуйте резервное копирование по требованию.

<br>

## Сеть
Как и в случае со всеми другими расширениями, для нормальной работы расширению резервного копирования требуется доступ к общедоступному Интернету. Отсутствие доступа к общедоступному Интернету может приводить к различным проблемам.

- Операция установки расширения может завершаться с ошибкой.
- Операции резервного копирования (например, создание моментального снимка диска) могут завершаться с ошибкой.
- Операция отображения состояния процесса резервного копирования может завершаться с ошибкой.

Потребность в разрешении общедоступных IP-адресов более подробно разъяснена [здесь](http://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). Вам будет нужно проверить конфигурации DNS для виртуальной сети и убедиться, что URL-адреса Azure можно разрешить.

После правильного разрешения имен также требуется предоставить доступ к IP-адресам Azure. Чтобы разблокировать доступ к инфраструктуре Azure, выполните одно из следующих действий.

1. Добавьте в список разрешений диапазоны IP-адресов центра обработки данных Azure.
    - Получите список [IP-адресов центра обработки данных Azure ](https://www.microsoft.com/download/details.aspx?id=41653) для добавления в разрешенный список.
    - Разблокируйте IP-адреса с помощью командлета [New-NetRoute](https://technet.microsoft.com/library/hh826148.aspx). Запустите этот командлет на виртуальной машине Azure в окне PowerShell с повышенными привилегиями (запустите от имени администратора).
    - Добавьте правила в группу безопасности сети (если она настроена) для доступа к IP-адресам.
2. Создание пути для прохождения трафика HTTP
    - При наличии каких-либо ограничений сети (например, группы безопасности сети) разверните прокси-сервер HTTP для перенаправления трафика. Описание развертывания прокси-сервера HTTP можно найти [здесь](backup-azure-vms-prepare.md#2-network-connectivity).
    - Добавьте правила в группу безопасности сети (если она настроена), чтобы разрешить доступ к Интернету из прокси-сервера HTTP.

>[AZURE.NOTE] Для работы резервного копирования службы архивации на виртуальной машине IaaS DHCP должна быть включена для учетной записи гостя. Если вам нужен статический частный IP-адрес, следует настроить его через платформу. DHCP для виртуальной машины следует оставить включенным. См. дополнительные сведения о [настройке статического внутреннего частного IP-адреса](../virtual-network/virtual-networks-reserved-private-ip.md).

<!---HONumber=AcomDC_0831_2016-->