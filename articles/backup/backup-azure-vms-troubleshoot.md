---
title: Устранение неполадок при резервном копировании виртуальных машин Azure
description: Устранение неполадок при резервном копировании и восстановлении виртуальных машин Azure
services: backup
author: srinathv
manager: vijayts
ms.service: backup
ms.topic: conceptual
ms.date: 03/04/2019
ms.author: srinathv
ms.openlocfilehash: b8d1152856935c239a59eb9133aaf48d26a5a8b6
ms.sourcegitcommit: 62d3a040280e83946d1a9548f352da83ef852085
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2019
ms.locfileid: "59259955"
---
# <a name="troubleshoot-azure-virtual-machine-backup"></a>Устранение неполадок при архивации виртуальных машин Azure
Для устранения неполадок, обнаруженных в ходе использования Azure Backup, можно использовать информацию в таблице, приведенной ниже.

| Сведения об ошибке | Возможное решение |
| ------ | --- |
| Резервное копирование не выполнено, так как виртуальная машина больше не существует. <br>Отключите защиту виртуальной машины, не удаляя данные резервного копирования. Дополнительные сведения см. в разделе [Отключение защиты виртуальных машин](https://go.microsoft.com/fwlink/?LinkId=808124). |Эта ошибка возникает, когда основная виртуальная машина удалена, но политика резервного копирования продолжает ее поиск, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, выполните следующие действия. <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов **имя облачной службы**,<br>**или**</li><li> Отключите защиту виртуальной машины, удаляя или не удаляя данные резервного копирования. Дополнительные сведения см. в разделе [Отключение защиты виртуальных машин](https://go.microsoft.com/fwlink/?LinkId=808124).</li></ol> |
| Агенту виртуальной машины Azure не удается установить связь со службой Azure Backup. <br>Убедитесь, что виртуальная машина подключена к сети, а также запущен агент виртуальной машины последней версии. Дополнительные сведения см. в статье [Устранение неполадок службы Azure Backup. Проблемы с агентом или расширением](https://go.microsoft.com/fwlink/?LinkId=800034). |Данная ошибка возникает, если существует проблема с агентом виртуальной машины, или каким-то образом заблокирован сетевой доступ к инфраструктуре Azure. Узнайте больше об [отладке проблем с моментальными снимками виртуальной машины](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#UserErrorGuestAgentStatusUnavailable-vm-agent-unable-to-communicate-with-azure-backup). <br><br>Если агент виртуальной машины не вызывает проблем, перезапустите виртуальную машину. Иногда проблемы возникают из-за неправильного состояния виртуальной машины. Его можно сбросить, перезапустив виртуальную машину. |
| Виртуальная машина находится в состоянии сбоя подготовки. <br>Перезапустите виртуальную машину и убедитесь, что она находится в запущенном или остановленном состоянии. | Эта ошибка возникает, когда неполадка расширения приводит к тому, что виртуальная машина переходит в состояние сбоя подготовки. Перейдите к списку расширений и проверьте, нет ли сбоев в работе расширений. Удалите соответствующее расширение и попробуйте перезапустить виртуальную машину. Если все расширения находятся в рабочем состоянии, проверьте, запущена ли служба агента виртуальной машины. Если нет, то перезапустите службу агента виртуальной машины. |
| При резервном копировании не удалось скопировать моментальный снимок виртуальной машины из-за нехватки свободного места в учетной записи хранения. <br>Убедитесь, что в учетной записи хранения хватает места для данных на дисках хранилища уровня "Премиум", подключенных к виртуальной машине. | Для резервного копирования виртуальных машин уровня "Премиум" в стеке резервных копий виртуальных машин версии 1 мы копируем моментальный снимок в учетную запись хранения. Это гарантирует, что трафик управления резервным копированием, который возникает при работе с моментальным снимком, не ограничивает число операций ввода-вывода, доступных для приложения, использующего диски уровня "Премиум". <br><br>Корпорация Майкрософт рекомендует выделять только 50 %, 17,5 ТБ, от общего объема хранилища учетной записи хранения. Затем служба Azure Backup может скопировать моментальный снимок в учетную запись хранения и перенести данные из этого скопированного расположения в учетной записи хранения в хранилище. |
| Резервное копирование не может выполнить операцию, так как агент виртуальной машины не отвечает. |Данная ошибка возникает, если существует проблема с агентом виртуальной машины, или каким-то образом заблокирован сетевой доступ к инфраструктуре Azure. На виртуальных машинах Windows проверьте состояние агента виртуальной машины в службах и укажите, отображается ли агент в программах на панели управления. <br><br>Попробуйте удалить программу с панели управления и установить агент еще раз, как это описано в разделе[Агент виртуальной машины](#vm-agent). После повторной установки агента активируйте нерегламентированное резервное копирование для проверки. |
| Не удалось выполнить операцию с расширением служб восстановления. <br>Убедитесь, что на виртуальной машине установлена последняя версия агента виртуальной машины и что служба агента виртуальной машины запущена. Повторите резервное копирование. В случае сбоя обратитесь в службу поддержки Майкрософт. |Эта ошибка возникает, если версия агента виртуальной машины устаревшая. Чтобы обновить агент виртуальной машины, см. статью "Устранение неполадок при архивации виртуальных машин Azure". |
| Виртуальная машина не существует. <br>Убедитесь, что виртуальная машина существует, или выберите другую виртуальную машину. |Эта ошибка возникает, когда основная виртуальная машина удалена, но политика резервного копирования продолжает ее поиск, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, выполните следующие действия. <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов **имя облачной службы**,<br>**или**<br></li><li>Отключите защиту виртуальной машины, не удаляя данные архивации. Дополнительные сведения см. в разделе [Отключение защиты виртуальных машин](https://go.microsoft.com/fwlink/?LinkId=808124).</li></ol> |
| Не удалось выполнить команду: <br>С этим элементом выполняется другая операция. Дождитесь завершения предыдущей операции. Затем повторите операцию. |Выполняется текущее задание архивации. В это время запуск нового задания невозможен. |
| Время ожидания копирования виртуальных жестких дисков из хранилища Служб восстановления истекло. <br>Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. | Эта ошибка возникает, если на стороне хранилища произошла временная ошибка, или службе Backup недостаточно получаемых в рамках учетной записи хранения операций ввода-вывода в секунду для передачи данных в хранилище в течение времени ожидания. Убедитесь, что вы [следовали рекомендациям при настройке виртуальных машин](backup-azure-vms-introduction.md#best-practices). Переместите виртуальную машину в другую учетную запись хранения, которая не так нагружена, и повторите попытку резервного копирования.|
| Резервное копирование произошла внутренняя ошибка: <br>Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. |Эта ошибка может возникнуть по двум причинам. <ul><li> При доступе к хранилищу виртуальной машины возникает временная проблема. Проверьте [страницу состояния Azure](https://azure.microsoft.com/status/), чтобы определить, имеются ли в регионе проблемы, связанные с вычислительными, сетевыми ресурсами или ресурсами хранения. После устранения неполадки повторите задание резервного копирования. <li> Исходная виртуальная машина удалена, поэтому точка восстановления не может быть создана. Чтобы сохранить данные резервного копирования удаленной виртуальной машины и прекратить появление ошибок при резервном копировании, снимите защиту с виртуальной машины и выберите вариант, при котором данные сохраняются. После этого запланированное задание архивации перестанет выполняться, а повторяющиеся сообщения об ошибках не будут появляться. |
| Резервное копирование не удалось установить расширение служб восстановления Azure для выбранного элемента: <br>Необходимым условием для расширения служб восстановления Azure является наличие агента виртуальной машины. Установите агент виртуальной машины Azure и перезапустите операцию регистрации. |<ol> <li>Убедитесь, что агент виртуальной машины установлен правильно. <li>Убедитесь, что флажок в конфигурации виртуальной машины установлен на правильное значение.</ol> Ознакомьтесь со сведениями об установке агента виртуальной машины и проверке правильности ее выполнения. |
| Во время установки расширения произошла ошибка **Отсутствует связь COM+ с координатором распределенных транзакций (Майкрософт)**. |Эта ошибка обычно означает, что служба COM+ не запущена. Чтобы устранить эту проблему, обратитесь в службу поддержки Майкрософт. |
| Сбой операции создания снимка службы теневого копирования томов (VSS) **Этот диск заблокирован программой шифрования диска BitLocker. Вернитесь к панели управления, чтобы разблокировать диск.** |Отключите BitLocker для всех дисков на виртуальной машине и проверьте, устранена ли проблема с VSS. |
| Виртуальная машина не находится в состоянии, которое позволяет выполнить резервное копирование. |<ul><li>Если виртуальная машина находится в состоянии перехода из **рабочего** в состояние **завершения работы**, дождитесь изменения состояния. Затем запустите задание резервного копирования. <li> Если виртуальная машина представляет собой виртуальную Машину Linux и использует модуль ядра Linux с улучшенной безопасностью, исключить путь агента Linux для Azure **/var/lib/waagent** из политики безопасности и убедитесь, что установлено расширение Azure Backup.  |
| Виртуальная машина Azure не найдена. |Эта ошибка возникает, когда основная виртуальная машина удалена, но политика резервного копирования продолжает ее поиск. Чтобы исправить эту проблему, выполните следующие действия. <ol><li>Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов **имя облачной службы**, <br>**или** <li> Отключите защиту этой виртуальной машины, чтобы задания резервного копирования не создавались. </ol> |
| На виртуальной машине отсутствует агент виртуальной машины. <br>Установите необходимые компоненты и агент виртуальной машины. Затем перезапустите операцию. |Дополнительные сведения об [установке агента виртуальной машины и проверке установки агента виртуальной машины](#vm-agent). |
| Сбой операции создания моментального снимка из-за неисправного состояния модулей записи VSS. |Перезапустите модули записи VSS, которые находятся в неисправном состоянии. В командной строке с повышенными привилегиями выполните команду ```vssadmin list writers```. В выходных данных содержатся все модули записи VSS и их состояние. Перезапустите каждый модуль записи VSS, состояние которого отличается от **[1] Стабильный**, выполнив следующие команды из командной строки с повышенными привилегиями. <ol><li>```net stop serviceName``` <li> ```net start serviceName```</ol>|
| Сбой операции создания моментального снимка из-за сбоя анализа конфигурации. |Эта ошибка возникает из-за изменения разрешений в каталоге **MachineKeys**: **%systemdrive%\programdata\microsoft\crypto\rsa\machinekeys**. <br> Выполните следующую команду и убедитесь, что для каталога **MachineKeys** назначены разрешения по умолчанию.<br>**icacls %systemdrive%\programdata\microsoft\crypto\rsa\machinekeys**. <br><br>Разрешения по умолчанию: <ul><li>все: (R,W) <li>BUILTIN\Administrators: (F)</ul> Если для каталога **MachineKeys** назначены другие разрешения, выполните следующие действия, чтобы изменить разрешения, удалить сертификат и активировать архивацию. <ol><li>Исправьте разрешения для каталога **MachineKeys**. С помощью свойств безопасности обозревателя и дополнительных параметров безопасности в каталоге сбросьте разрешения к значениям по умолчанию. Удалите дополнительные пользовательские объекты, отличные от объектов по умолчанию, из каталога и убедитесь, что у **всех** есть доступ к таким операциям: <ul><li>– вывод списка папок, чтение данных; <li>– чтение атрибутов; <li>– чтение дополнительных атрибутов; <li>– создание файлов, запись данных; <li>– создание папок, добавление данных;<li>– запись атрибутов;<li>– запись дополнительных атрибутов;<li>– разрешения на чтение. </ul><li>Удалите все сертификаты с полем **Получатель сертификата**, имеющим значение классической модели развертывания или **Windows Azure CRP Certificate Generator**.<ol><li>[Практическое руководство. Просмотр сертификатов с помощью оснастки консоли MMC](https://msdn.microsoft.com/library/ms788967(v=vs.110).aspx).<li>В разделе **Личное** > **Сертификаты** удалите все сертификаты с полем **Получатель сертификата**, имеющим значение **Windows Azure CRP Certificate Generator**.</ol> <li>Активируйте задание архивации виртуальной машины. </ol>|
| У службы Azure Backup недостаточно прав для Azure Key Vault, чтобы архивировать зашифрованные виртуальные машины. |Предоставьте службе резервного копирования эти разрешения в PowerShell, выполнив шаги из статьи [Использование PowerShell для резервного копирования и восстановления виртуальных машин](backup-azure-vms-automation.md). |
|Во время установки расширения моментальных снимков произошла ошибка **компоненту COM+ не удалось связаться с координатором распределенных транзакций (Майкрософт)**. | В командной строке с повышенными привилегиями запустите службу Windows **Системное приложение COM+**. Например, **net start COMSysApp**. Если служба не запускается, выполните следующие действия.<ol><li> Убедитесь, что учетной записью входа службы **Координатор распределенных транзакций** является **Сетевая служба**. Если это не так, измените ее на **Сетевая служба** и перезапустите эту службу. Затем попытайтесь запустить службу **Системное приложение COM+**.<li>Если **Системное приложение COM+** не запускается, удалите, а затем установите службу **Координатор распределенных транзакций** следующим образом. <ol><li>Остановите службу MSDTC. <li>Откройте окно командной строки **cmd**. <li>Выполните команду ```msdtc -uninstall```. <li>Выполните команду ```msdtc -install```. <li>Запустите службу MSDTC. </ol> <li>Запустите службу Windows **Системное приложение COM+**. После запуска службы **Системное приложение COM+** активируйте задание резервного копирования на портале Azure.</ol> |
|  Сбой операции создания моментального снимка из-за ошибки COM+. | Рекомендуется перезапустить службу Windows **Системное приложение COM+** в командной строке с повышенными привилегиями, выполните команду **net start COMSysApp**. Если проблема повторится, перезапустите виртуальную машину. Если перезапуск виртуальной машины не помог, то попробуйте [удалить расширение VMSnapshot](https://docs.microsoft.com/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout) и активировать резервное копирование вручную. |
| При резервном копировании не удалось закрепить одну или несколько точек подключения виртуальной машины для создания моментального снимка, согласованного с файловой системой. | Выполните следующие действия. <ul><li>Проверьте состояние файловой системы на всех подключенных устройствах с помощью команды **tune2fs**. Например, **tune2fs -l/dev/sdb1 \\** .\| grep **состоянием файловой системы**. <li>Отключите устройства с некорректным состоянием файловой системы с помощью команды **umount**. <li> Проверьте целостность файловой системы на этих устройствах с помощью команды **fsck**. <li> Повторно подключите эти устройства и повторите попытку архивации.</ol> |
| Сбой операции создания моментального снимка из-за ошибки при создании защищенного канала связи. | <ol><li> Откройте редактор реестра, запустив файл **regedit.exe** в режиме с повышенными правами. <li> Определите все версии платформы .NET Framework, установленные в системе. Они находятся в иерархии раздела реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft**. <li> Для каждой платформы .NET Framework в этом разделе реестра добавьте следующий раздел: <br> **SchUseStrongCrypto"=dword:00000001**. </ol>|
| Сбой операции создания моментального снимка из-за ошибки при установке распространяемого компонента Visual C++ для Visual Studio 2012. | Перейдите в папку C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot\agentVersion и установите компонент vcredist2012_x64. Убедитесь, что установлено правильное значение раздела реестра, разрешающее установку этой службы. То есть значение раздела реестра **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Msiserver** установлено на **3**, а не на **4**. <br><br>Если проблемы с установкой не исчезли, перезапустите службу установки, последовательно выполнив команды **MSIEXEC /UNREGISTER** и **MSIEXEC /REGISTER** в командной строке с повышенными привилегиями.  |


## <a name="jobs"></a>Задания

| Сведения об ошибке | Возможное решение |
| --- | --- |
| Отмена не поддерживается в этом типе задания. <br>Дождитесь завершения задания. |Нет |
| Задание не находится в состоянии отмены. <br>Дождитесь завершения задания. <br>**или**<br> Выбранное задание не находится в состоянии отмены. <br>Дождитесь остановки задания. |Скорее всего, задание почти выполнено. Дождитесь завершения задания.|
| Резервное копирование не может отменить задание, так как оно не выполняется. <br>Отмена поддерживается только для выполняющихся заданий. Попытайтесь отменить выполняющееся задание. |Эта ошибка возникает из-за переходного состояния. Подождите минуту и повторите отмену. |
| При резервном копировании не удалось отменить задание. <br>Дождитесь завершения задания. |Нет |

## <a name="restore"></a>восстановление;

| Сведения об ошибке | Возможное решение |
| --- | --- |
| Сбой восстановления из-за внутренней ошибки облака. |<ol><li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроены параметры DNS. Проверьте параметр <br>**$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production"     Get-AzureDns -DnsSettings $deployment.DnsSettings**.<br>Если настроен **адрес**, это означает, что настроены и параметры DNS.<br> <li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроен параметр **ReservedIP**, а существующие в ней виртуальные машины находятся в остановленном состоянии. Вы можете проверить, что облачная служба зарезервировала IP-адрес, используя следующие командлеты PowerShell: **$deploy = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName**. <br><li>Вы пытаетесь восстановить виртуальную машину в ту же облачную службу со следующими специальными конфигурациями сети: <ul><li>– виртуальные машины во внутренней и внешней конфигурации балансировщика нагрузки;<li>– виртуальные машины с несколькими зарезервированными IP-адресами; <li>– виртуальные машины с несколькими сетевыми адаптерами. </ul><li>Выберите новую облачную службу в пользовательском интерфейсе или просмотрите [рекомендации по восстановлению](backup-azure-arm-restore-vms.md#restore-vms-with-special-configurations) для виртуальных машин со специальными конфигурациями сети.</ol> |
| Выбранное DNS-имя уже занято. <br>Укажите другое DNS-имя и повторите попытку. |Указанное здесь DNS-имя ссылается на имя облачной службы обычно с расширением **.cloudapp.net**. Это имя должно быть уникальным. Если возникает эта ошибка, во время восстановления необходимо выбрать другое имя виртуальной машины. <br><br>  Эта ошибка отображается только для пользователей портала Azure. Восстановление с помощью PowerShell выполняется успешно, так как восстанавливаются только диски, а виртуальная машина не создается. Ошибка возникнет, если вы явно создадите виртуальную машину после восстановления дисков. |
| Указана неправильная конфигурация виртуальной сети. <br>Укажите другую конфигурацию виртуальной сети и повторите попытку. |Нет |
| Указанная облачная служба использует зарезервированный IP-адрес, который не соответствует конфигурации восстанавливаемой виртуальной машины. <br>Укажите другую облачную службу, которая не использует зарезервированный IP-адрес. Или выберите другую точку восстановления. |Нет |
| Облачная служба достигла ограничения на количество входных конечных точек. <br>Повторите операцию, указав другую облачную службу или используя существующую конечную точку. |Нет |
| Хранилище Служб восстановления и целевая учетная запись хранения находятся в двух разных регионах. <br>Убедитесь, что указанная в операции восстановления учетная запись хранения находится в том же регионе Azure, что и хранилище Служб восстановления. |Нет |
| Учетная запись хранения, указанная для операции восстановления, не поддерживается. <br>Поддерживаются только базовые или стандартные учетные записи хранения с локально избыточными или геоизбыточными параметрами репликации. Выберите поддерживаемую учетную запись хранения. |Нет |
| Тип учетной записи хранения, указанной для операции восстановления, не подключен к сети. <br>Убедитесь, что учетная записи хранения, указанная в операции восстановления, подключена к сети. |Эта ошибка может возникать из-за временной ошибки в службе хранилища Azure или из-за сбоя. Выберите другую учетную запись хранения. |
| Достигнут предел квоты группы ресурсов. <br>Удалите некоторые группы ресурсов с портала Azure или обратитесь в службу поддержки Azure, чтобы увеличить границы. |Нет |
| Выбранная подсеть не существует. <br>Выберите подсеть для проверки. |Нет |
| У службы Backup нет разрешения на доступ к ресурсам в вашей подписке. |Чтобы устранить эту ошибку, сначала восстановите диски, выполнив шаги, описанные в разделе [Восстановление резервных копий дисков](backup-azure-arm-restore-vms.md#restore-disks). Затем выполните команды PowerShell, описанные в разделе [Создание виртуальной машины с восстановленного диска](backup-azure-vms-automation.md#restore-an-azure-vm). |

## <a name="backup-or-restore-takes-time"></a>Резервное копирование или восстановление занимает время
Если резервное копирование у вас выполняется дольше 12 часов или на восстановление данных требуется больше 6 часов, ознакомьтесь с [лучшими методиками](backup-azure-vms-introduction.md#best-practices) и [рекомендациями по производительности](backup-azure-vms-introduction.md#backup-performance).

## <a name="vm-agent"></a>Агент виртуальной машины
### <a name="set-up-the-vm-agent"></a>Настройка агента виртуальной машины
Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Но на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом.

#### <a name="windows-vms"></a>Виртуальные машины Windows

* Скачайте и установите [MSI-файл агента](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
* Для виртуальных машин, созданных с использованием классической модели развертывания, [обновите свойство классических виртуальных машин](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. Этот шаг является необязательным для виртуальных машин Azure Resource Manager.

#### <a name="linux-vms"></a>Виртуальные машины Linux

* Установите последнюю версию агента из репозитория дистрибутива. Сведения об имени пакета см. в [репозитории агента Linux](https://github.com/Azure/WALinuxAgent).
* Для виртуальных машин, созданных с использованием классической модели развертывания, [используйте этот блог](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы обновить свойство виртуальных машин и указать, что агент установлен. Этот шаг не является обязательным для виртуальных машин Resource Manager.

### <a name="update-the-vm-agent"></a>Обновление агента виртуальной машины
#### <a name="windows-vms"></a>Виртуальные машины Windows

* Чтобы обновить агент виртуальной машины, переустановите [его двоичные файлы](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Прежде чем обновлять агент, убедитесь, что не выполняются никакие операции резервного копирования.

#### <a name="linux-vms"></a>Виртуальные машины Linux

* Чтобы обновить агент виртуальной машины Linux, следуйте инструкциям в статье [Как обновить агент Azure Linux на виртуальной машине](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

    > [!NOTE]
    > Рекомендуется обновлять агент только через репозиторий дистрибутива.

    Не рекомендуется скачивать код агента с портала GitHub. Если последняя версия агента не доступна для дистрибутива, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по получению последней версии агента. Последние сведения об [агенте Windows Azure Linux](https://github.com/Azure/WALinuxAgent/releases) см. в репозитории GitHub.

### <a name="validate-vm-agent-installation"></a>Проверка установки агента виртуальной машины

Для проверки версии агента виртуальной машины на виртуальных машинах Windows выполните следующие действия.

1. Войдите в систему виртуальной машины Azure и перейдите в папку **C:\WindowsAzure\Packages**. В ней должен находиться файл **WaAppAgent.exe**.
2. Щелкните правой кнопкой мыши файл и выберите **Свойства**. Затем выберите вкладку **Сведения**. В поле **Версия продукта** должно отображаться значение 2.6.1198.718 или выше.

## <a name="troubleshoot-vm-snapshot-issues"></a>Решение проблем со снимками виртуальных машин
Архивация виртуальных машин зависит от команды моментального снимка в базовом хранилище. Отсутствие доступа к хранилищу или задержка в выполнении задачи создания моментального снимка может привести к неудачному завершению задания резервного копирования. Сбой задачи создания снимка может быть вызван следующими условиями.

- **Сетевой доступ к хранилищу блокируется при помощи групп NSG**. Узнайте о том, как [включить сетевой доступ](backup-azure-arm-vms-prepare.md#establish-network-connectivity) к хранилищу с помощью списка разрешенных IP-адресов или прокси-сервера.
- **Виртуальные машины с настроенной архивацией SQL Server могут вызвать задержку задачи создания моментальных снимков**. По умолчанию при архивации виртуальной машины создается полная резервная копия VSS на виртуальных машинах Windows. На виртуальных машинах, где выполняется SQL Server и настроена архивация SQL Server, это может привести к задержке создания моментального снимка. Если эти задержки приводят к ошибкам резервного копирования, установите следующий ключ реестра.

   ```
   [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
   "USEVSSCOPYBACKUP"="TRUE"
   ```

- **Состояние виртуальной машины отображается неправильно из-за того, что работа виртуальной машины была завершена в сеансе удаленного рабочего стола**. При использовании удаленного рабочего стола для завершении работы виртуальной машины проверьте, правильно ли отображается на портале состояние виртуальной машины. Если это не так, завершите работу виртуальной машины на портале с помощью команды **Завершение работы** на панели мониторинга виртуальной машины.
- **Если больше четырех виртуальных машин используют одну облачную службу, настройте несколько политик резервного копирования**. Задайте время резервного копирования таким образом, чтобы оно выполнялось не более, чем на четырех виртуальных машинах одновременно. Задайте время начала архивации в разных политиках так, чтобы между ними был один час разницы.
- **Виртуальная машина использует большие ресурсы процессора или памяти**. Если виртуальная машина работает при большой загрузке памяти или процессора (более 90 %), задача создания моментального снимка помещается в очередь, задерживается. В конце концов, время ожидания истекает. В таких ситуациях попробуйте использовать архивацию по запросу.

## <a name="troubleshoot-backup-of-encrypted-vms"></a>Устранение неполадок при архивации зашифрованных виртуальных машин

### <a name="azure-backup-doesnt-have-permissions-for-key-vault-access"></a>Служба Azure Backup не имеет разрешений для доступа к Key Vault
- **Код ошибки** UserErrorKeyVaultPermissionsNotConfigured
- **Сообщение об ошибке** У службы архивации Azure недостаточно прав для Key Vault, чтобы архивировать зашифрованные виртуальные машины.
- **Решение**. Назначение разрешений Azure Backup для хранилища ключей в [портала](backup-azure-vms-encryption.md#provide-permissions), или с [PowerShell](backup-azure-vms-automation.md#enable-protection)

### <a name="the-vm-cant-be-restored-because-the-associated-key-vault-doesnt-exist"></a>Восстановление виртуальной Машины невозможно, поскольку не существует связанного хранилища ключей
- **Решение**. Убедитесь, что [создали Key Vault](../key-vault/quick-create-portal.md#create-a-vault).
- **Решение**. Выполните [эти инструкции](backup-azure-restore-key-secret.md) для восстановления ключа и секрета, даже если они не существуют в хранилище ключей.

### <a name="the-vm-cant-be-restored-because-the-associated-key-doesnt-exist"></a>Восстановление виртуальной Машины невозможно, поскольку связанный раздел не существует
- **Код ошибки** UserErrorKeyVaultKeyDoesNotExist
- **Сообщение об ошибке** Вы не можете восстановить эту зашифрованную виртуальную машину, так как с ней не связан ключ.
- **Решение**. Выполните [эти инструкции](backup-azure-restore-key-secret.md) для восстановления ключа и секрета, даже если они не существуют в хранилище ключей.

### <a name="the-vm-cant-be-restored-because-azure-backup-doesnt-have-authorization"></a>Виртуальную Машину нельзя восстановить, так как Azure Backup не прошли проверку подлинности
- **Код ошибки** ProviderAuthorizationFailed/UserErrorProviderAuthorizationFailed
- **Сообщение об ошибке** У службы архивации нет разрешения на доступ к ресурсам в вашей подписке.
- **Решение**. Восстановление дисков, согласно рекомендациям. [Узнайте больше](backup-azure-vms-encryption.md#restore-an-encrypted-vm). 


## <a name="networking"></a>Сеть
Как и все расширения для расширения Azure Backup требуется доступ к общедоступному Интернету для работы. Отсутствие доступа к общедоступному Интернету может приводить к различным проблемам:

* Операция установки расширения может завершаться с ошибкой.
* Операции резервного копирования (например, создание моментального снимка диска) могут завершаться с ошибкой.
* Операция отображения состояния процесса резервного копирования может завершаться с ошибкой.

Необходимость разрешения общедоступных IP-адресов обсуждается в [этом блоге службы поддержки Azure](https://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). Проверьте конфигурации DNS для виртуальной сети и убедитесь, что URI Azure можно разрешить.

После правильного разрешения имен также требуется предоставить доступ к IP-адресам Azure. Чтобы разблокировать доступ к инфраструктуре Azure, выполните одно из следующих действий.

- Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений.
   1. Получите список [IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653) для добавления в разрешенный список.
   1. Разблокируйте IP-адреса с помощью командлета [New-NetRoute](https://docs.microsoft.com/powershell/module/nettcpip/new-netroute). Запустите этот командлет на виртуальной машине Azure в окне PowerShell с повышенными привилегиями. Запустите от имени администратора.
   1. Добавьте правила в группу безопасности сети, если она настроена, для доступа к IP-адресам.
- Создание пути для прохождения трафика HTTP
   1. При наличии каких-либо ограничений сети разверните прокси-сервер HTTP для перенаправления трафика. Например, группа безопасности сети. Инструкции по развертыванию прокси-сервера HTTP см. в разделе [Установка сетевого подключения](backup-azure-arm-vms-prepare.md#establish-network-connectivity).
   1. Добавьте правила в группу безопасности сети, если она настроена, чтобы разрешить доступ к Интернету из прокси-сервера HTTP.

> [!NOTE]
> Для работы резервного копирования службы архивации на виртуальной машине IaaS DHCP должна быть включена для учетной записи гостя. Если вам нужен статический частный IP-адрес, настройте его с помощью портала Azure или PowerShell. Убедитесь, что параметр DHCP для виртуальной машины включен.
> Дополнительные сведения о том, как настроить статический IP-адрес с помощью PowerShell см. раздели:
> - [Добавление статического внутреннего IP-адреса для существующей виртуальной машины](../virtual-network/virtual-networks-reserved-private-ip.md#how-to-add-a-static-internal-ip-to-an-existing-vm)
> - [Изменение метода распределения для частного IP-адреса, назначенного сетевому интерфейсу](../virtual-network/virtual-networks-static-private-ip-arm-ps.md#change-the-allocation-method-for-a-private-ip-address-assigned-to-a-network-interface)
>
>
