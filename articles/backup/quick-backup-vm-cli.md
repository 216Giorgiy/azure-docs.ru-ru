---
title: "Краткое руководство по Azure. Резервное копирование виртуальной машины с помощью Azure CLI | Документация Майкрософт"
description: "Узнайте, как создавать резервные копии виртуальных машин с помощью Azure CLI"
services: virtual-machines-linux, azure-backup
documentationcenter: virtual-machines
author: iainfoulds
manager: jeconnoc
editor: 
tags: azure-resource-manager, virtual-machine-backup
ms.assetid: 
ms.service: virtual-machines-linux, azure-backup
ms.devlang: azurecli
ms.topic: hero-article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/18/2017
ms.author: iainfou
ms.custom: mvc
ms.translationtype: HT
ms.sourcegitcommit: 44e9d992de3126bf989e69e39c343de50d592792
ms.openlocfilehash: b01916516d15ffee46f135e175ee4136f79acbe5
ms.contentlocale: ru-ru
ms.lasthandoff: 09/25/2017

---

# <a name="back-up-a-virtual-machine-in-azure-with-the-cli"></a>Резервное копирование виртуальной машины в Azure с помощью интерфейса командной строки
Azure CLI используется для создания ресурсов Azure и управления ими из командной строки или с помощью скриптов. Для защиты данных можно создавать архивы с регулярным интервалом. Служба Azure Backup создает точки восстановления, которые могут храниться в геоизбыточных хранилищах служб восстановления. В этой статье объясняется, как создать резервную копию виртуальной машины в Azure с помощью Azure CLI. Эти действия также можно выполнить с помощью [Azure PowerShell](quick-backup-vm-powershell.md) или [портала Azure](quick-backup-vm-portal.md).

В этом руководстве объясняется, как включить резервное копирование существующей виртуальной машины Azure. Если вам необходимо создать виртуальную машину, см. статью [о создании виртуальной машины с помощью Azure CLI](../virtual-machines/linux/quick-create-cli.md).

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать CLI локально, для выполнения инструкций из этого руководства вам потребуется Azure CLI 2.0.18 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0](/cli/azure/install-azure-cli). 


## <a name="register-the-azure-backup-resource-provider"></a>Регистрация поставщика ресурсов Azure Backup
При первом использовании Azure Backup необходимо зарегистрировать поставщик служб восстановления Azure в своей подписке с помощью команды [az provider register](/cli/azure/provider?view=azure-cli-latest#az_provider_register).

```azurecli-interactive
az provider register --namespace Microsoft.RecoveryServices
```


## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
Хранилище служб восстановления — это логический контейнер, в котором хранятся данные резервного копирования для каждого защищенного ресурса, например виртуальных машин Azure. Когда выполняется задание резервного копирования для защищенного ресурса, в хранилище служб восстановления создается точка восстановления. Позже вы сможете использовать одну из этих точек восстановления, чтобы восстановить данные до определенной точки во времени.

Создайте хранилище служб восстановления с помощью команды **az backup vault create**. Укажите те же группу ресурсов и расположение, что и для виртуальной машины, которую необходимо защитить. Если вы создали виртуальную машину по [этому краткому руководству](../virtual-machines/linux/quick-create-cli.md), укажите для группы ресурсов имя *myResourceGroup*, для виртуальной машины — *myVM*, а для расположения ресурсов — *eastus*.

```azurecli-interactive 
az backup vault create --resource-group myResourceGroup \
    --name myRecoveryServicesVault \
    --location eastus
```

По умолчанию в качестве хранилища задано геоизбыточное хранилище. Для дополнительной защиты данных этот уровень избыточности хранилища гарантирует, что данные резервного копирования реплицируются в дополнительный регион Azure, который находится в сотнях километров от основного.


## <a name="enable-backup-for-an-azure-vm"></a>Включение резервного копирования для виртуальной машины Azure
Создавая и используя политики, вы можете определить, когда выполнять задание резервного копирования и как долго хранить точку восстановления. Согласно политике защиты по умолчанию задание резервного копирования выполняется каждый день, а точки восстановления хранятся в течение 30 дней. Вы можете использовать значения политики по умолчанию, чтобы быстро защитить виртуальную машину. Чтобы включить резервное копирование для виртуальной машины, используйте команду **az backup protection enable—for-vm**. Укажите группу ресурсов и виртуальную машину, которые нужно защитить, и выберите необходимую политику:

```azurecli-interactive 
az backup protection enable-for-vm \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --vm myVM \
    --policy-name DefaultPolicy
```


## <a name="start-a-backup-job"></a>Запуск задания резервного копирования
Чтобы начать резервное копирование сейчас, а не ждать задания, которое запустится в запланированное время согласно политике по умолчанию, используйте команду **az backup protection backup-now**. В ходе первого задания резервного копирования создается точка полного восстановления. Во всех заданиях после начального резервного копирования создаются добавочные точки восстановления. Добавочные точки восстановления требуют мало места и времени, так как они позволяют передать только изменения, внесенные с момента последнего резервного копирования.

Для резервного копирования виртуальной машины используются следующие параметры:

- `--container-name` — имя виртуальной машины;
- `--item-name` — имя виртуальной машины;
- `--retain-until` — задайте в качестве значения последнюю доступную дату в формате времени UTC (**дд-мм-гггг**), до которой должна храниться точка восстановления.

В следующем примере создается резервная копия виртуальной машины *myVM* и в качестве даты окончания срока действия для точки восстановления задается 18 октября 2017 г.

```azurecli-interactive 
az backup protection backup-now \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --container-name myVM \
    --item-name myVM \
    --retain-until 18-10-2017
```

Так как в ходе первого задания резервного копирования создается точка полного восстановления, процесс может занять до 20 минут.


## <a name="monitor-the-backup-job"></a>Мониторинг задания резервного копирования
Чтобы отслеживать состояние заданий резервного копирования, используйте команду **az backup job list**:

```azurecli-interactive 
az backup job list \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --output table
```

В результате вы получите приблизительно следующие выходные данные. Они указывают на то, что задание резервного копирования выполняется (*InProgress*):

```
Name      Operation        Status      Item Name    Start Time UTC       Duration
--------  ---------------  ----------  -----------  -------------------  --------------
a0a8e5e6  Backup           InProgress  myvm         2017-09-19T03:09:21  0:00:48.718366
fe5d0414  ConfigureBackup  Completed   myvm         2017-09-19T03:03:57  0:00:31.191807
```

Если в столбце *Status* (Состояние) задания резервного копирования отображается значение *Completed* (Выполнено), это означает, что виртуальная машина защищена с помощью служб восстановления и для нее сохранена точка полного восстановления.


## <a name="clean-up-deployment"></a>Очистка развертывания
Если защита больше не нужна, вы можете отключить ее на виртуальной машине, удалить точки восстановления и хранилище служб восстановления, а затем удалить группу ресурсов и связанные ресурсы виртуальной машины. Если вы использовали существующую виртуальную машину, можете пропустить последнюю команду [az group delete](/cli/azure/group?view=azure-cli-latest#az_group_delete), чтобы оставить группу ресурсов и виртуальную машину.

Если вы планируете ознакомиться с руководством по службе Backup, в котором объясняется, как восстанавливать данные виртуальной машины, пропустите шаги в этом разделе и перейдите к [дальнейшим действиям](#next-steps). 

```azurecli-interactive 
az backup protection disable \
    --resource-group myResourceGroup \
    --vault-name myRecoveryServicesVault \
    --container-name myVM \
    --item-name myVM \
    --delete-backup-data true
az backup vault delete \
    --resource-group myResourceGroup \
    --name myRecoveryServicesVault \
az group delete --name myResourceGroup
```


## <a name="next-steps"></a>Дальнейшие действия
В этом кратком руководстве вы создали хранилище служб восстановления, включили защиту на виртуальной машине и создали начальную точку восстановления. Дополнительные сведения о службе Azure Backup и службах восстановления см. в соответствующих руководствах.

> [!div class="nextstepaction"]
> [Резервное копирование нескольких виртуальных машин Azure](./tutorial-backup-vm-at-scale.md)

