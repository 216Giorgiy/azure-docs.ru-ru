
<properties
	pageTitle="Управление резервными копиями виртуальных машин Azure и их мониторинг | Microsoft Azure"
	description="Узнайте, как управлять резервными копиями виртуальных машин Azure и осуществлять и мониторинг"
	services="backup"
	documentationCenter=""
	authors="trinadhk"
	manager="shreeshd"
	editor=""/>

<tags ms.service="backup" ms.workload="storage-backup-recovery" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="10/29/2015" ms.author="aashishr"; "jimpark"; "trinadhk"/>

# Управление резервными копиями виртуальных машин Azure и их мониторинг

## Управление защищенными виртуальными машинами

Для управления защищенными виртуальными машинами сделайте вот что:

1. Для просмотра параметров резервного копирования виртуальной машины и управления ими перейдите на вкладку **Защищенные элементы**.

2. Щелкните имя защищенного элемента, чтобы открыть вкладку **Сведения об архивации**. Здесь отображается информация о последней резервной копии.

    ![Резервное копирование виртуальной машины](./media/backup-azure-manage-vms/backup-vmdetails.png)

3. Для просмотра параметров политики резервного копирования виртуальной машины и управления ими перейдите на вкладку **Политики**.

    ![Политика резервного копирования виртуальных машин](./media/backup-azure-manage-vms/manage-policy-settings.png)

    На вкладке **Политики резервного копирования** отображается существующая политика. Ее параметры можно изменить при необходимости. Если необходимо создать новую политику, на странице **Политики** щелкните **Создать**. Обратите внимание, что если вы хотите удалить политику, с ней не должна быть связана ни одна виртуальная машина.

    ![Политика резервного копирования виртуальных машин](./media/backup-azure-manage-vms/backup-vmpolicy.png)

4. Дополнительные сведения о действиях и состоянии виртуальной машины можно найти на странице **Задания**. Щелкните задание в списке, чтобы получить дополнительные сведения или отфильтровать задания для конкретной виртуальной машины.

    ![Задания](./media/backup-azure-manage-vms/backup-job.png)

## Резервное копирование виртуальной машины по запросу
Резервное копирование виртуальной машины по запросу можно выполнять, когда для нее настроена защита. Если процесс первоначального резервного копирования находится в состоянии ожидания для виртуальной машины, то процесс резервного копирования по запросу создаст полную копию виртуальной машины в хранилище службы архивации Azure. Если процесс первого резервного копирования завершен, процесс резервного копирования по запросу будет только отправлять изменения, произошедшие со времени предыдущего резервного копирования, в хранилище службы архивации Azure.

Чтобы выполнить резервное копирование виртуальной машины по запросу, выполните следующие действия:

1. Перейдите на страницу **Защищенные элементы**, выберите в поле **Тип** значение **Виртуальная машина Azure** (если оно еще не выбрано) и нажмите кнопку **Выбрать**.

    ![Тип виртуальной машины](./media/backup-azure-manage-vms/vm-type.png)

2. Выберите виртуальную машину, для которой требуется выполнить резервное копирование по запросу, и нажмите кнопку **Создать резервную копию** в нижней части страницы.

    ![Создать резервную копию](./media/backup-azure-manage-vms/backup-now.png)

    В результате для выбранной виртуальной машины будет создано задание на резервное копирование. Период хранения точки восстановления, созданной с помощью этого задания, будет таким же, как и период времени, указанный в политике, связанной с виртуальной машиной.

    ![Создание задания резервного копирования](./media/backup-azure-manage-vms/creating-job.png)

    >[AZURE.NOTE]Чтобы просмотреть политику, связанную с виртуальной машиной, выберите виртуальную машину на странице **Защищенные элементы** и перейдите на вкладку политики резервного копирования.

3. После создания задания можно нажать кнопку **Просмотреть задание** на всплывающей панели для просмотра соответствующего задания на странице "Задания".

    ![Задание резервного копирования создано](./media/backup-azure-manage-vms/created-job.png)

4. После успешного завершения задания будет создана точка восстановления, которую можно использовать для восстановления виртуальной машины. При этом на странице **Защищенные элементы** также будет увеличено на 1 значение в столбце точки восстановления.

## Отключение защиты виртуальных машин
Для останова будущих процессов резервного копирования виртуальной машины можно использовать следующие варианты:

- Сохранить резервную копию данных, связанную с виртуальной машиной, в хранилище службы архивации Azure.
- Удалить резервную копию данных, связанную с виртуальной машиной.

Если вы решили сохранить резервные копии виртуальной машиной, эти данные можно использовать для ее восстановления. Для получения дополнительных сведений о ценах для таких виртуальных машин щелкните [здесь](http://azure.microsoft.com/pricing/details/backup/).

Чтобы остановить защиту для виртуальной машины, выполните следующие действия:

1. Перейдите на страницу **Защищенные элементы**, выберите тип фильтра **Виртуальная машина Azure** (если он еще не выбран) и нажмите кнопку **Выбрать**.

    ![Тип виртуальной машины](./media/backup-azure-manage-vms/vm-type.png)

2. Выберите виртуальную машину и нажмите кнопку **Остановить защиту** в нижней части страницы.

    ![Остановить защиту](./media/backup-azure-manage-vms/stop-protection.png)

3. По умолчанию служба архивации Azure не удаляет данные резервных копий, связанные с виртуальной машиной.

    ![Подтверждение остановки защиты](./media/backup-azure-manage-vms/confirm-stop-protection.png)

    Если вы хотите удалить данные резервных копий, установите флажок.

    ![Флажок](./media/backup-azure-manage-vms/checkbox.png)

    Выберите причину остановки процесса резервного копирования. Хотя это и необязательно, указание причины остановки поможет рабочей группе службы архивации Azure понять причину остановки и определять приоритеты для сценариев клиентов.

4. Нажмите кнопку **Отправить** для отправки задания **Остановить защиту**. Щелкните **Просмотреть задание** для просмотра соответствующего задания на странице **Задания**.

    ![Остановить защиту](./media/backup-azure-manage-vms/stop-protect-success.png)

    Если вы не выбрали вариант **Удалить связанные данные резервных копий** в мастере **Остановка защиты**, то после завершения задания состояние защиты изменится на **Защита остановлена**. Данные остаются в службе архивации Azure, пока не будут явно удалены. Данные всегда можно удалить, выбрав виртуальную машину на странице **Защищенные элементы** и нажав кнопку **Удалить**.

    ![Защита остановлена](./media/backup-azure-manage-vms/protection-stopped-status.png)

    Если выбран вариант **Удаление связанных архивируемых данных**, виртуальная машина не будет отображаться на странице **Защищенные элементы**.

## Повторное включение защиты для виртуальной машины
Если вариант **Удалить связанные данные резервных копий** в мастере **Остановка защиты** не выбран, виртуальную машину можно защитить повторно путем выполнения процедуры, похожей на процедуру резервного копирования зарегистрированных виртуальных машин. После включения защиты для этой виртуальной машины сохранятся данные резервных копий, созданных до остановки защиты, и точек восстановления, созданных после повторной защиты.

После повторной защиты состояние защиты виртуальной машины изменится на **Защищено** при наличии точек восстановления до **остановки защиты**.

  ![Виртуальная машина защищена повторно](./media/backup-azure-manage-vms/reprotected-status.png)

>[AZURE.NOTE]При повторной защите виртуальной машины можно выбрать другую политику, отличную от политики, с помощью которой виртуальная машина была защищена изначально.

## Отмена регистрации виртуальных машин

Чтобы удалить виртуальную машину из хранилища службы архивации, выполните следующие действия.

1. Нажмите в нижней части страницы кнопку **ОТМЕНИТЬ РЕГИСТРАЦИЮ**.

    ![Отключение защиты](./media/backup-azure-manage-vms/unregister-button.png)

    В нижней части экрана отобразится всплывающее уведомление с запросом на подтверждение. Чтобы продолжить, щелкните **ДА**.

    ![Отключение защиты](./media/backup-azure-manage-vms/confirm-unregister.png)

## Удаление данных резервных копий
Резервные копии виртуальной машины можно удалить одним из двух способов:

- либо во время выполнения задания остановки защиты,
- либо по окончании данного задания на виртуальной машине.

Чтобы удалить резервные копии на виртуальной машине, которая находится в состоянии *Защита остановлена* после успешного завершения задания **Прекратить резервное копирование**:

1. Перейдите на страницу **Защищенные элементы**, выберите в поле *Тип* значение **Виртуальная машина Azure** и нажмите кнопку **Выбрать**.

    ![Тип виртуальной машины](./media/backup-azure-manage-vms/vm-type.png)

2. Выберите виртуальную машину. Виртуальная машина будет находиться в состоянии **Защита остановлена** .

    ![Защита остановлена](./media/backup-azure-manage-vms/protection-stopped-b.png)

3. Нажмите кнопку **УДАЛИТЬ** в нижней части страницы.

    ![Удаление резервных копий](./media/backup-azure-manage-vms/delete-backup.png)

4. В мастере **удаления данных архивации** укажите причину удаления резервных копий (настоятельно рекомендуем) и нажмите кнопку **Отправить**.

    ![Удаление данных резервных копий](./media/backup-azure-manage-vms/delete-backup-data.png)

5. При этом будет создано задание для удаления данных резервных копий для выбранной виртуальной машины. Нажмите **Просмотреть задание**, чтобы просмотреть соответствующее задание на странице "Задания".

    ![Удаление данных выполнено](./media/backup-azure-manage-vms/delete-data-success.png)

    После завершения задания запись, соответствующая виртуальной машине, будет удалена со страницы **Защищенные элементы**.

## Панель мониторинга
На странице **Панель мониторинга** можно просмотреть сведения о виртуальных машинах Azure, их хранилище и заданиях, которые с ними связаны (за последние 24 часа). Здесь также можно просмотреть состояние резервного копирования и все связанные с ним ошибки.

![Панель мониторинга](./media/backup-azure-manage-vms/dashboard-protectedvms.png)

>[AZURE.NOTE]Значения на панели мониторинга обновляются каждые 24 часа.

## Аудит операций
В службе архивации Azure можно просматривать журналы операций резервного копирования, запущенных пользователем. В них можно увидеть, какие именно операции управления выполнялись в хранилище службы архивации. Журналы операций позволяет проводить эффективный анализ и аудит операций резервного копирования.

В журналы операций записываются следующие операции:

- регистрация;
- отмена регистрации;
- настройка защиты;
- резервное копирование (как запланированное, так и запущенное по запросу с помощью кнопки «Моментальная архивация»);
- восстановление;
- остановка защиты;
- удаление резервных копий;
- добавление политики;
- удаление политики;
- изменение политики;
- отмена задания.

Чтобы просмотреть журналы операций в соответствующем хранилище службы архивации, сделайте вот что:

1. На портале Azure перейдите в раздел **Службы управления** и откройте вкладку **Журналы операций**.

    ![Журналы операций](./media/backup-azure-manage-vms/ops-logs.png)

2. В фильтрах в поле *Тип* выберите значение **Резервное копирование**, в поле *Имя службы* укажите имя хранилища службы архивации и нажмите кнопку **Отправить**.

    ![Фильтр журналов операций](./media/backup-azure-manage-vms/ops-logs-filter.png)

3. В журналах операций выберите любую операцию и нажмите **Сведения**, чтобы просмотреть соответствующую информацию.

    ![Сведения о выборке из журналов операций](./media/backup-azure-manage-vms/ops-logs-details.png)

    Мастер **Сведения** содержит информацию о запущенной операции, коде задания, ресурсе, на котором была запущена операция, и времени начала операции.

    ![Сведения об операции](./media/backup-azure-manage-vms/ops-logs-details-window.png)

## Оповещения
Вы можете получать настраиваемые оповещения о заданиях на портале. Для этого в PowerShell нужно определить правила оповещений для событий журналов операций.

Оповещения о событиях работают в режиме диспетчера ресурсов Azure. Чтобы перейти в этот режим, выполните следующий командлет в командной строке с повышенными привилегиями:

```
PS C:\> Switch-AzureMode AzureResourceManager
```

Чтобы настроить пользовательское оповещение об ошибках резервного копирования, используйте команду такого типа:

```
PS C:\> Add-AlertRule -Operator GreaterThanOrEqual -Threshold 1 -ResourceId '/subscriptions/86eeac34-eth9a-4de3-84db-7a27d121967e/resourceGroups/RecoveryServices-DP2RCXUGWS3MLJF4LKPI3A3OMJ2DI4SRJK6HIJH22HFIHZVVELRQ-East-US/providers/microsoft.backupbvtd2/BackupVault/trinadhVault' -EventName Backup  -EventSource Administrative -Level Error -OperationName 'Microsoft.Backup/backupVault/Backup' -ResourceProvider Microsoft.Backup -Status Failed  -SubStatus Failed -RuleType Event -Location eastus -ResourceGroup RecoveryServices-DP2RCXUGWS3MLJF4LKPI3A3OMJ2DI4SRJK6HIJH22HFIHZVVELRQ-East-US -Name Backup-Failed -Description 'Backup failed for one of the VMs in vault trinadhkVault' -CustomEmails 'contoso@microsoft.com' -SendToServiceOwners
```

**ResourceId**. Этот параметр можно получить во всплывающем окне "Журналы операций", как описано в разделе выше. ResourceUri во всплывающем окне сведений об операции — это и есть параметр ResourceId, который нужно указать для этого командлета.

**EventName**. Для оповещений о резервном копировании виртуальных машин IaaS поддерживаются такие значения: Register,Unregister,ConfigureProtection,Backup,Restore,StopProtection,DeleteBackupData,CreateProtectionPolicy,DeleteProtectionPolicy,UpdateProtectionPolicy.

**Level**. Поддерживаемые значения: Informational, Error. Для оповещений о неудачных операциях используйте значение Error, для оповещений о выполненных заданиях — Informational.

**OperationName**. Этот параметр будет иметь формат Microsoft.Backup/backupvault/<EventName>, где EventName соответствует описанному выше.

**Status**. Поддерживаемые значения: Started, Succeeded и Failed. Рекомендуется оставить значение Informational как уровень для состояния Succeeded.

**SubStatus**. Совпадает с состоянием операций резервного копирования.

**RuleType**. Оставьте значение *Event*, так как оповещения о резервном копировании основаны на событиях.

**ResourceGroup**. Группа ресурсов, к которой принадлежит ресурс, где запущена операция. Это значение можно получить из значения ResourceId. Значение между полями */resourceGroups/* и */providers/* в значении ResourceId — это значение для параметра ResourceGroup.

**Name**. Имя правила оповещения.

**Description**. Описание правила оповещения.

**CustomEmails**. Укажите адрес электронной почты для отправки оповещений.

**SendToServiceOwners**. Этот параметр отправляет оповещения всем администраторам и соадминистраторам подписки.

Ниже приведен пример оповещения по почте.

Пример заголовка:

![Заголовок оповещения](./media/backup-azure-manage-vms/alert-header.png)

Пример текста оповещения:

![Текст оповещения](./media/backup-azure-manage-vms/alert-body.png)

### Связанные с оповещениями ограничения
К оповещениям на основе событий применяются такие ограничения:

1. Оповещения активируются на всех виртуальных машинах в хранилище службы архивации. Оповещения нельзя настроить для определенного набора виртуальных машин в хранилище службы архивации.
2. Оповещения разрешаются автоматически, если в течение действия следующего оповещения не инициируется событие, соответствующее оповещению. Чтобы задать период действия оповещения, используйте параметр *WindowSize* в командлете Add-AlertRule.

## Дальнейшие действия

- [Восстановление виртуальных машин Azure](backup-azure-restore-vms.md)

<!---HONumber=Nov15_HO2-->