<properties
	pageTitle="Защита фермы SharePoint с помощью DPM в Azure | Microsoft Azure"
	description="В данной статье описывается защита фермы SharePoint с помощью DPM в Azure"
	services="backup"
	documentationCenter=""
	authors="SamirMehta"
	manager="shreeshd"
	editor=""/>

<tags ms.service="backup" ms.workload="storage-backup-recovery" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="07/14/2015" ms.author="sammehta"; "jimpark"/>


# Резервное копирование фермы SharePoint в Azure
Резервное копирование фермы SharePoint Azure с помощью System Center Data Protection Manager (DPM) во многом напоминает резервное копирование других источников данных. Azure позволяет гибко планировать архивацию, задавая ежедневные, еженедельные, ежемесячные или ежегодные точки резервного копирования и меняя политику хранения для любой из этих точек. DPM дает возможность сохранять копии локальных дисков, сокращая, таким образом, время восстановления (RTO) и расходы на использование службы архивации Azure.

## Поддерживаемые версии SharePoint и соответствующие сценарии защиты
Служба архивации Azure для DPM поддерживает следующие сценарии.

| Рабочая нагрузка | Версия | Развертывание SharePoint | Тип развертывания DPM | DPM – System Center 2012 R2 | Защита и восстановление |
| -------- | ------- | --------------------- | ------------------- | --------------------------- | ----------------------- |
| SharePoint | SharePoint 2013, SharePoint 2010, SharePoint 2007, SharePoint 3.0 | SharePoint разворачивается как физический сервер или виртуальная машина Hyper-V/VmWare <br> -------------- <br> SQL AlwaysOn | Физический сервер или локальная виртуальная машина Hyper-V | Поддерживает резервное копирование в Azure, начиная с накопительного пакета обновления 5 | Восстановление фермы SharePoint: фермы, базы данных, файла или элемента списка с диска, а также восстановление фермы и базы данных из Azure |

## Перед началом работы
Перед резервным копированием фермы SharePoint в Azure необходимо выполнить некоторые действия.

### Предварительные требования
Прежде чем продолжить, выполните все [предварительные требования](backup-azure-dpm-introduction.md#prerequisites) по использованию службы архивации Azure для защиты рабочей нагрузки. Предварительные требования включают такие задачи, как создание хранилища архивации, загрузка учетных данных хранилища, установка агента службы архивации Azure и регистрация сервера в хранилище.

### Агент DPM
Агент DPM необходимо установить на сервер SharePoint, серверы SQL Server и другие серверы, составляющие ферму SharePoint. Дополнительные сведения о настройке агента защиты см. в статье [Настройка агента защиты](https://technet.microsoft.com/library/hh758039.aspx). Единственное исключение состоит в том, что агент устанавливается только на один интерфейсный веб-сервер. DPM требует установки агента только на один интерфейсный веб-сервер, который будет служить точкой входа для защиты.

### Ферма SharePoint
На каждые 10 млн элементов в ферме требуется не меньше 2 ГБ памяти в томе, где находится папка DPM. Эта память нужна для создания каталога. Для восстановления конкретных элементов (коллекций веб-сайтов, сайтов, списков, библиотек документов, папок, отдельных документов и элементов списков) через DPM операция создания каталога формирует список URL-адресов, содержащихся в каждой базе данных содержимого. Список URL-адресов можно просмотреть в консоли администратора DPM, открыв панель восстанавливаемых элементов в области задач восстановления.

### SQL Server
DPM выполняется как локальная система и для создания резервной копии SQL Server требует наличия прав системного администратора в учетной записи SQL Server. Установите для параметра NT AUTHORITY\SYSTEM значение *sysadmin* в SQL Server, для которого нужно создать резервную копию.

При наличии баз данных SQL Server, настроенных с псевдонимами SQL Server, в ферме SharePoint установите клиентские компоненты SQL Server на интерфейсный веб-сервер, который DPM будет защищать.

### SharePoint Server
Производительность системы зависит от многих факторов, включая размер фермы SharePoint. Обычно для защиты фермы SharePoint объемом 25 ТБ используется один сервер DPM.

### Накопительный пакет обновления DPM 5
Прежде чем начать защиту фермы SharePoint в Azure, необходимо установить накопительный пакет обновления DPM 5 или более поздней версии. Накопительный пакет обновления 5 позволяет защитить ферму SharePoint (настроенную с помощью SQL AlwaysOn) в Azure. Дополнительные сведения см. в статье [Установка накопительного пакета обновления DPM 5](http://blogs.technet.com/b/dpm/archive/2015/02/11/update-rollup-5-for-system-center-2012-r2-data-protection-manager-is-now-available.aspx)

### Что не поддерживается
1. Защита фермы SharePoint не охватывает индексы поиска или базы данных службы приложений. Защиту этих баз данных необходимо настраивать отдельно.
2. DPM не поддерживает архивацию баз данных SQL SharePoint, размещенных в общих хранилищах на масштабируемом файловом сервере.

## Настройка защиты SharePoint
Перед развертыванием защиты SharePoint с помощью DPM необходимо настроить службу модуля записи VSS SharePoint (службу модуля записи WSS) с помощью файла **ConfigureSharePoint.exe**.

Файл **ConfigureSharePoint.exe** находится в папке [путь установки DPM]\bin на интерфейсном веб-сервере. Он позволяет установить агент защиты с учетными данными для фермы SharePoint. Файл нужно распаковать на одном интерфейсном веб-сервере. Если у вас таких серверов несколько, выберите один из них для настройки группы защиты.

### Настройка службы модуля записи VSS SharePoint
1. На интерфейсном веб-сервере перейдите через командную строку в папку [путь установки DPM]\bin\.
2. Запустите ConfigureSharePoint - EnableSharePointProtection.
3. Введите учетные данные администратора фермы. Эта учетная запись должна быть членом локальной группы администраторов на интерфейсном веб-сервере. Если администратор фермы не является локальным администратором, предоставьте на интерфейсном веб-сервере следующие разрешения:
  - Предоставьте группе WSS_Admin_WPG полный доступ к папке DPM (%Program Files%\Microsoft Data Protection Manager\DPM).
  - Предоставьте группе WSS_Admin_WPG право чтения реестра DPM (HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Data Protection Manager).

>[AZURE.NOTE]После каждого изменения в учетных данных администратора фермы SharePoint файл ConfigureSharePoint.exe необходимо перезапускать.

## Резервное копирование фермы SharePoint с помощью DPM
Настроив DPM и фермы SharePoint согласно приведенным выше инструкциям, можно развернуть защиту SharePoint с помощью DPM.

### Защита фермы SharePoint
1. На вкладке **Защита** консоли администратора DPM нажмите кнопку **Создать**.![Вкладка создания защиты](./media/backup-azure-backup-sharepoint/dpm-new-protection-tab.png)

2. На экране **Выберите тип группы защиты** мастера **Создание новой группы защиты** выберите вариант **Серверы** и нажмите кнопку **Далее**.

    ![Выберите тип группы защиты](./media/backup-azure-backup-sharepoint/select-protection-group-type.png)

3. На экране **Выберите членов группы** установите флажок для сервера SharePoint, который нужно защитить, и нажмите кнопку **Далее**.

    ![Выберите членов группы](./media/backup-azure-backup-sharepoint/select-group-members2.png)

    >[AZURE.NOTE]Если агент DPM установлен, сервер отображается в мастере. DPM демонстрирует также его структуру. Поскольку файл ConfigureSharePoint.exe был запущен, DPM обменивается данными с модулем записи VSS SharePoint и его соответствующими базами данных SQL и распознает структуру фермы SharePoint (связанные базы данных содержимого и все соответствующие элементы).

4. На экране **Выберите метод защиты данных** введите имя *группы защиты* и выберите желаемый *метод защиты*. Нажмите кнопку **Далее**.

    ![Выберите метод защиты данных](./media/backup-azure-backup-sharepoint/select-data-protection-method1.png)

    >[AZURE.NOTE]Выбор метода защиты диска помогает сократить время восстановления. Azure — гораздо более экономичное средство долгосрочной защиты, чем магнитные ленты. Дополнительные сведения см. в [этой статье](https://azure.microsoft.com/documentation/articles/backup-azure-backup-cloud-as-tape/).

5. На экране **Выберите краткосрочные цели** выберите желаемый *диапазон хранения* и укажите время создания резервных копий.

    ![Выберите краткосрочные цели](./media/backup-azure-backup-sharepoint/specify-short-term-goals2.png)

    >[AZURE.NOTE]Поскольку восстановления обычно требуют данные менее чем за пять последних дней, в данном примере мы выбрали пятидневный диапазон хранения на диске и назначили архивацию на нерабочее время.

6. Проверьте, какой объем дисковой памяти выделен для группы защиты, и нажмите кнопку **Далее**.

7. Для каждой группы защиты DPM выделяет дисковую память для хранения и администрирования реплик. На этом этапе DPM должен создать копию выбранных данных. Выберите способ и время создания реплики и нажмите кнопку **Далее**.

    ![Выберите метод создания реплики](./media/backup-azure-backup-sharepoint/choose-replica-creation-method.png)

    >[AZURE.NOTE]Чтобы не мешать сетевому трафику, выбирайте нерабочее время.

8. DPM обеспечивает целостность данных за счет проверки реплик на согласованность. Доступны два параметра. Можно установить расписание проверок согласованности или разрешить DPM выполнять такие проверки в реплике автоматически, как только она становится несогласованной. Выберите желаемый параметр и нажмите кнопку **Далее**.

    ![Проверка согласованности](./media/backup-azure-backup-sharepoint/consistency-check.png)

9. На экране **Укажите данные для онлайн-защиты** выберите ферму SharePoint, которую нужно защитить, и нажмите кнопку **Далее**.

    ![DPM SharePoint Protection1](./media/backup-azure-backup-sharepoint/select-online-protection1.png)

10. На экране **Укажите расписание онлайн-архивации** выберите желаемое расписание и нажмите кнопку **Далее**.

    ![Online_backup_schedule](./media/backup-azure-backup-sharepoint/specify-online-backup-schedule.png)

    >[AZURE.NOTE]DPM допускает создание двух резервных копий в Azure в разное время дня.

11. В зависимости от выбранного расписания архивации на экране **Укажите политику онлайн-хранения** выберите политику хранения для ежедневных, еженедельных, ежемесячных и ежегодных точек резервного копирования.

    ![Online_retention_policy](./media/backup-azure-backup-sharepoint/specify-online-retention.png)

    >[AZURE.NOTE]DPM использует трехуровневую схему хранения, позволяющую выбирать разную политику хранения для разных точек резервного копирования.

12. Как и диск, реплика начальной контрольной точки должна быть создана в Azure. Выберите желаемый параметр для создания начальной резервной копии в Azure и нажмите кнопку **Далее**.

    ![Online_replica](./media/backup-azure-backup-sharepoint/online-replication.png)

13. Просмотрите выбранные параметры на странице **Сводка** и нажмите кнопку **Создать группу**. После создания группы защиты появится сообщение об успешном выполнении операции.

    ![Сводка](./media/backup-azure-backup-sharepoint/summary.png)

## Восстановление элемента SharePoint с диска с помощью DPM
В приведенном ниже примере *элемент восстановления SharePoint* был случайно удален и должен быть восстановлен.![DPM SharePoint Protection4](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection5.png)

1. Откройте **консоль администратора DPM**. На вкладке "Защита" отображаются все фермы SharePoint, защищаемые DPM.

    ![DPM SharePoint Protection3](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection4.png)

2. Чтобы начать восстановление элемента, откройте вкладку **Восстановление**.

    ![DPM SharePoint Protection5](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection6.png)

3. Чтобы найти *элемент восстановления SharePoint*, можно использовать поиск на основе подстановки в пределах диапазона точек восстановления.

    ![DPM SharePoint Protection6](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection7.png)

4. Найдите в результатах поиска нужную точку восстановления, щелкните ее правой кнопкой мыши и выберите параметр **Восстановить**.

5. Можно просмотреть разные точки восстановления и выбрать базу данных или элементы для восстановления. Выберите **дату и время восстановления**, а затем **базу данных > ферму SharePoint > точку восстановления > элемент**.

    ![DPM SharePoint Protection7](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection8.png)

6. Щелкните элемент правой кнопкой мыши и выберите параметр **Восстановить**, чтобы открыть **мастер восстановления**. Нажмите кнопку **Далее**.

    ![Просмотр выбранных параметров восстановления](./media/backup-azure-backup-sharepoint/review-recovery-selection.png)

7. Выберите тип восстановления и нажмите кнопку **Далее**.

    ![Тип восстановления](./media/backup-azure-backup-sharepoint/select-recovery-type.png)

    >[AZURE.NOTE]В приведенном выше примере показан элемент восстановления до исходного сайта SharePoint.

8. Выберите желаемый **процесс восстановления**.
    - Если ферма SharePoint не изменилась и находится в том же состоянии, что и в указанной точке восстановления, выберите вариант **Восстановление без использования фермы восстановления**.
    - Если с момента создания точки восстановления ферма SharePoint изменилась, выберите вариант **Восстановление с использованием фермы восстановления**.

    ![Процесс восстановления](./media/backup-azure-backup-sharepoint/recovery-process.png)

9. Укажите размещение экземпляра SQL для временного восстановления базы данных и промежуточного общую папку на серверах DPM и SharePoint для восстановления элемента.

    ![Расположение промежуточного хранения 1](./media/backup-azure-backup-sharepoint/staging-location1.png)

    DPM присоединяет базу данных содержимого, в которой размещается элемент SharePoint, к временному экземпляру SQL Server. Сервер DPM восстанавливает элемент из базы данных содержимого и помещает его в промежуточную общую папку на сервере DPM. Теперь элемент, восстановленный в папке промежуточного хранения на сервере DPM, нужно экспортировать в папку промежуточного хранения на ферме SharePoint.

    ![Расположение промежуточного хранения 2](./media/backup-azure-backup-sharepoint/staging-location2.png)

10. Откройте экран **Укажите параметры восстановления** и примените параметры безопасности к ферме SharePoint или к точке восстановления. Нажмите кнопку **Далее**.

    ![Варианты восстановления](./media/backup-azure-backup-sharepoint/recovery-options.png)

    >[AZURE.NOTE]Здесь же можно отрегулировать использование пропускной способности сети. Это позволит сократить нежелательную нагрузку на сервер в рабочие часы.

11. Просмотрите сводные данные и нажмите кнопку **Восстановить**, чтобы начать восстановление файла.

    ![Сводка параметров восстановления](./media/backup-azure-backup-sharepoint/recovery-summary.png)

12. Теперь откройте вкладку **Мониторинг** в **консоли администратора DPM** и проверьте *состояние* восстановления.

    ![Состояние восстановления](./media/backup-azure-backup-sharepoint/recovery-monitoring.png)

    >[AZURE.NOTE]Файл восстановлен. Обновите сайт SharePoint, чтобы проверить восстановленный файл.

## Восстановление базы данных SharePoint из Azure с помощью DPM

1. Чтобы восстановить базу данных содержимого SharePoint, просмотрите различные точки восстановления (как было показано выше) и выберите желаемую точку восстановления.

    ![DPM SharePoint Protection8](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection9.png)

2. Дважды щелкните точку восстановления SharePoint, чтобы отобразить доступные регистрационные сведения SharePoint.

    > [AZURE.NOTE]Поскольку для фермы SharePoint предусмотрен длительный срок хранения в Azure, на сервере DPM доступных регистрационных сведений (метаданных) здесь нет. В результате каждый раз, когда базу данных содержимого SharePoint требуется вернуть в состояние на определенный момент, необходимо каталогизировать ферму SharePoint заново.

3. Нажмите кнопку **Каталогизировать заново**.

    ![DPM SharePoint Protection10](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection12.png)

    Откроется окно состояния **Повторная каталогизация облака**.

    ![DPM SharePoint Protection11](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection13.png)

    После завершения каталогизации состояние измените на *Успешно*. Нажмите кнопку **Закрыть**

    ![DPM SharePoint Protection12](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection14.png)

4. Щелкните объект SharePoint на вкладке **Восстановление** DPM, чтобы получить структуру базы данных содержимого. Щелкните правую кнопку мыши и выберите параметр **Восстановить**.

    ![DPM SharePoint Protection13](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection15.png)

5. Выполните [описанную выше процедуру восстановления](#restore-a-sharepoint-item-from-disk-using-dpm), чтобы восстановить базу данных содержимого SharePoint с диска.

## Часто задаваемые вопросы
В. Какие версии DPM поддерживают SQL 2014 и SQL 2012 (SP2)?<br> О. Их поддерживает DPM 2012 R2 с накопительным пакетом обновления 4.

В. Можно ли восстановить элемент SharePoint в исходное расположение, если SharePoint был настроен с использованием SQL AlwaysOn (с защитой на диске)?<br> О. Да, элемент можно восстановить на исходный сайт SharePoint.

В. Можно ли восстановить базу данных SharePoint в исходное расположение, если SharePoint был настроен с использованием SQL AlwaysOn?<br> О. Поскольку базы данных SharePoint настраиваются в SQL AlwaysOn, их нельзя изменить, не удалив группу доступности (AG). В связи с этим DPM не может восстанавливать базы данных в исходное расположение. Базу данных SQL можно восстановить в другой экземпляр SQL.

## Дальнейшие действия
- Для получения дополнительных сведений о защите SharePoint с помощью DPM см. [видеоматериалы о защите SharePoint с помощью DPM](http://channel9.msdn.com/Series/Azure-Backup/Microsoft-SCDPM-Protection-of-SharePoint-1-of-2-How-to-create-a-SharePoint-Protection-Group)
- См. [Заметки о выпуске System Center 2012 — Data Protection Manager](https://technet.microsoft.com/library/jj860415.aspx)
- См. [Заметки о выпуске Data Protection Manager в System Center 2012 SP1](https://technet.microsoft.com/library/jj860394.aspx)

<!---HONumber=July15_HO4-->