<properties
	pageTitle="Подготовка среды для резервного копирования виртуальных машин Azure | Microsoft Azure"
	description="Убедитесь, что ваша среда подготовлена для резервного копирования виртуальных машин в Azure."
	services="backup"
	documentationCenter=""
	authors="Jim-Parker"
	manager="jwhit"
	editor=""
	keywords="резервные копии; резервное копирование;"/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="01/22/2016"
	ms.author="trinadhk; jimpark; markgal;"/>


# Подготовка среды для резервного копирования виртуальных машин Azure

Перед копированием виртуальной машины Azure необходимо выполнить эти обязательные требования. Если вы уже подготовили среду для резервного копирования, вы можете запустить [резервное копирование виртуальных машин](backup-azure-vms.md). В противном случае выполните инструкции ниже, чтобы подготовить свою среду.

## 1\. Хранилище службы архивации

![Хранилище службы архивации](./media/backup-azure-vms-prepare/step1.png)

Чтобы начать резервное копирование виртуальных машин Azure, необходимо создать хранилище службы архивации. Хранилище — это объект, в котором хранятся созданные резервные копии и точки восстановления. Хранилище также содержит политики резервного копирования, которые будут применяться к виртуальным машинам, для которых настроено резервное копирование.

На рисунке ниже показаны связи между разными сущностями службы архивации Azure. ![Сущности и связи службы архивации Azure](./media/backup-azure-vms-prepare/vault-policy-vm.png)

Создание хранилища службы архивации

1. Войдите на [портал Azure](http://manage.windowsazure.com/).

2. Последовательно щелкните **Создать** > **Службы данных** > **Службы восстановления** > **Хранилище архивации** > **Быстрое создание**. Если с учетной записью вашей организации связано несколько подписок, выберите ту, которую следует связать с хранилищем службы архивации. В каждой подписке Azure может быть несколько хранилищ службы архивации для организации защищаемых виртуальных машин.

3. В поле **Имя** введите понятное имя для идентификации хранилища. Это имя должно быть уникальным для каждой подписки.

4. В поле **Область** выберите географический регион для хранилища архивации. Хранилище должно находиться в том же регионе, что и виртуальные машины, которые необходимо защитить. При наличии виртуальных машин в разных регионах создайте хранилище в каждом из них. Нет необходимости указывать учетные записи хранения для хранения данных архивации: хранилище и служба архивации Azure делают это автоматически.

    ![Создание хранилища службы архивации](./media/backup-azure-vms-prepare/backup_vaultcreate.png)

5. Щелкните **Создать хранилище**. Для создания резервного хранилища может потребоваться некоторое время. Уведомления о состоянии процесса см. в нижней части портала.

    ![Всплывающее уведомление о создании хранилища](./media/backup-azure-vms-prepare/creating-vault.png)

6. Успешное создание хранилища подтверждается сообщением. На странице **служб восстановления** оно будет иметь состояние **Активно**. Сразу после создания хранилища выберите соответствующее значение избыточности хранилища. См. дополнительные сведения о [настройке избыточности хранилища в хранилище службы архивации](backup-configure-vault.md#azure-backup---storage-redundancy-options).

    ![Список хранилищ службы архивации](./media/backup-azure-vms-prepare/backup_vaultslist.png)

7. Щелкните резервное хранилище, чтобы перейти на страницу **Быстрый запуск**, где отображаются инструкции по резервному копированию виртуальных машин Azure.

    ![Инструкции для архивации виртуальной машины на странице панели мониторинга](./media/backup-azure-vms-prepare/vmbackup-instructions.png)



## 2\. Сетевое подключение

![Сетевое подключение](./media/backup-azure-vms-prepare/step2.png)

Для правильной работы расширения архивации требуется подключение к общедоступным IP-адресам Azure, так как расширение отправляет команды в конечную точку хранилища Azure (URL-адрес в формате HTTP) для управления снимками виртуальной машины. Без правильного подключения к Интернету время ожидания таких HTTP-запросов от виртуальной машины будет истекать, а операция архивации завершится сбоем.

### Сетевые ограничения с помощью групп безопасности сети (NSG)

Развертывание может иметь ограничения доступа (например, через группу безопасности сети). В таком случае нужно выполнить дополнительные шаги для проверки того, что это не влияет на трафик архивации в резервное хранилище.

Путь для трафика резервного копирования можно указать двумя способами.

1. Добавить в список разрешений [диапазоны IP-адресов центра обработки данных Azure](http://www.microsoft.com/ru-RU/download/details.aspx?id=41653).
2. Развернуть прокси-сервер HTTP для маршрутизации трафика.

Компромисс заключается в балансе управляемости, точности управления и затрат.

|Параметр|Преимущества|Недостатки|
|------|----------|-------------|
|ВАРИАНТ 1. Разрешенные диапазоны IP-адресов| Нет дополнительных затрат.<br><br>Открыть доступ в NSG можно с помощью командлета <i>Set-AzureNetworkSecurityRule</i>. | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются.<br>Доступ ко всей службе Azure, а не только к хранилищу.|
|ВАРИАНТ 2. Прокси-сервер HTTP| Точное управление разрешенными URL-адресами хранилища в прокси-сервере.<br>Одна точка Интернет-доступа к виртуальным машинам.<br>Не подвергается влиянию изменений IP-адресов Azure.| Дополнительные затраты для работы виртуальной машины с программным обеспечением прокси-сервера.|

### Использование прокси-сервера HTTP для архивации виртуальных машин
Во время резервного копирования виртуальных машин команды управления моментальными снимками отправляются из расширения резервного копирования в службу хранилища Azure с помощью API HTTPS. Этот трафик должен перенаправляться из расширения через прокси-сервер, так как только на прокси-сервере будет настроен доступ к Интернету.

>[AZURE.NOTE] Особых требований к программному обеспечению нет. Убедитесь, что прокси-сервер подходит для выполнения описанных ниже настроек.

В приведенном ниже примере виртуальную машину приложения нужно настроить для использования виртуальной машины прокси-сервера, через который проходит весь трафик HTTP из Интернета. Виртуальную машину прокси-сервера необходимо настроить для разрешения входящего трафика из виртуальных машин в виртуальной сети. И наконец, для NSG (с именем *NSG-lockdown*) требуется новое правило безопасности, разрешающее интернет-трафик, исходящий из виртуальной машины прокси-сервера.

![Диаграмма развертывания NSG с прокси-сервером HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

**а) Разрешите исходящие сетевые соединения.**

1. На компьютерах под управлением ОС Windows в командной строке с повышенными привилегиями выполните следующую команду:

	```
	netsh winhttp set proxy http://<proxy IP>:<proxy port>
	```

	В результате для компьютера будет настроен прокси-сервер, который будет использоваться для любого исходящего трафика HTTP или HTTPS.

2. На компьютерах под управлением ОС Linux добавьте в файл ```/etc/environment``` следующую строку:

 	```
 	http_proxy=http://<proxy IP>:<proxy port>
 	```

	Добавьте следующие строки в файл ```/etc/waagent.conf```:

	```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

**б) Разрешите входящие соединения на прокси-сервере.**

1. Откройте брандмауэр Windows на прокси-сервере. Щелкните правой кнопкой мыши **Правила для входящих подключений** и выберите **Новое правило**.

	![Открытие брандмауэра](./media/backup-azure-vms-prepare/firewall-01.png)

	![Создание нового правила](./media/backup-azure-vms-prepare/firewall-02.png)
2. В **мастере создания правила для нового входящего подключения** выберите значение **Настраиваемое** для параметра **Тип правила** и нажмите кнопку **Далее**. Чтобы выбрать **программу**, щелкните элемент **Все программы** и нажмите кнопку **Далее**.

3. На экране **Протокол и порты** введите данные из таблицы ниже и нажмите кнопку **Далее**.

	![Создание нового правила](./media/backup-azure-vms-prepare/firewall-03.png)

| Поле ввода | Значение |
| --- | --- |
| Тип протокола | TCP |
| Локальный порт | В раскрывающемся списке выберите **Определенные порты**. В текстовом поле введите настроенный ```<Proxy Port>```. |
| Удаленный порт | В раскрывающемся списке выберите **Все порты**. |

Выполните все инструкции мастера и укажите имя правила.

**в) Добавьте правило исключения NSG.**

Откройте окно командной строки Azure PowerShell и выполните следующую команду:

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

Эта команда добавляет исключение NSG, которое разрешает TCP-трафик из любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS). Если вам необходимо получить доступ к какому-либо порту в Интернете, добавьте его в ```-DestinationPortRange```.

*Не забудьте заменить имена из примера данными, соответствующими вашему развертыванию.*

## 3\. Агент виртуальной машины

![Агент виртуальной машины](./media/backup-azure-vms-prepare/step3.png)

Перед началом архивации виртуальной машины Azure убедитесь, что на ней правильно установлен агент виртуальной машины. Так как агент виртуальной машины является необязательным компонентом при создании виртуальной машины, убедитесь, что флажок агента виртуальной машины установлен до ее подготовки.

### Ручная установка и обновление

Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агент виртуальной машины отсутствует. Для таких виртуальных машин агент VM необходимо установить явным образом. Подробности об [установке агента ВМ на существующей виртуальной машине](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).

| **Операция** | **Windows** | **Linux** |
| --- | --- | --- |
| Установка агента виртуальной машины | <li>Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора. <li>[Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. | <li> Установите последнюю версию [агента Linux](https://github.com/Azure/WALinuxAgent) с сайта GitHub. Чтобы выполнить установку, необходимо иметь права администратора. <li> [Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. |
| Обновление агента виртуальной машины | Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). <br><br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции архивации. | Следуйте указаниям по [обновлению агента виртуальной машины Linux](../virtual-machines-linux-update-agent.md). <br><br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции архивации. |
| Проверка установки агента виртуальной машины | <li>На виртуальной машине Azure перейдите в папку *C:\\WindowsAzure\\Packages*. <li>В ней должен находиться файл WaAppAgent.exe.<li> Щелкните этот файл правой кнопкой мыши, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше. | - |


См. дополнительные сведения об [агенте виртуальной машины](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) и [его установке](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).

### Расширение резервного копирования

Чтобы выполнить архивацию виртуальной машины, служба архивации Azure устанавливает расширение для агента виртуальной машины. Служба резервного копирования Azure легко обновляет и применяет исправления к расширению резервного копирования без дополнительного вмешательства пользователя.

Расширение резервного копирования устанавливается, если виртуальная машина запущена. Кроме того, на запущенной виртуальной машине проще всего получить точку восстановления, согласованную с приложениями. Тем не менее, служба архивации Azure будет продолжать архивацию виртуальной машины, даже если она выключена и установить расширение невозможно (автономная виртуальная машина). В этом случае точка восстановления будет *отказоустойчивой*, как обсуждалось выше.


## Ограничения

- Архивация виртуальных машин на основе диспетчера ресурсов Azure (IaaS V2) не поддерживается.
- Архивация виртуальных машин, к которым подключено более 16 дисков данных, не поддерживается.
- Архивация виртуальных машин с использованием хранилища класса Premium не поддерживается.
- Архивация виртуальных машин с зарезервированным IP-адресом и без заданной конечной точки не поддерживается.
- Замена существующей виртуальной машины во время восстановления не поддерживается. Сначала необходимо удалить существующую виртуальную машину и все связанные диски, а затем восстановить данные из резервной копии.
- Резервное копирования и восстановление между регионами не поддерживается.
- Архивация виртуальных машин с помощью службы архивации Azure поддерживается во всех областях, общих для Azure (см. [контрольный список](https://azure.microsoft.com/regions/#services) поддерживаемых регионов). Если искомый регион в настоящее время не поддерживается, он будет отсутствовать в раскрывающемся списке при создании хранилища.
- Архивация виртуальных машин с помощью службы архивации Azure поддерживается только в определенных версиях операционных систем:
  - **Linux**: см. [список дистрибутивов, одобренных Azure](../virtual-machines/virtual-machines-linux-endorsed-distributions.md). Другие собственные дистрибутивы Linux должны также работать, если агент виртуальной машины доступен на виртуальной машине.
  - **Windows Server**: версии до Windows Server 2008 R2 не поддерживаются.
- Восстановление контроллера домена виртуальной машины, которая входит в конфигурацию с несколькими контроллерами домена, поддерживается только с помощью PowerShell. Дополнительные сведения о [восстановлении контроллера домена в конфигурации с несколькими контроллерами домена](backup-azure-restore-vms.md#restoring-domain-controller-vms).
- Восстановление виртуальных машин с описанными ниже особыми конфигурациями сети поддерживается только в PowerShell. Когда процедура восстановления будет завершена, виртуальные машины, созданные в пользовательском интерфейсе с помощью рабочего процесса восстановления, не будут включать эти конфигурации сети. Дополнительные сведения см. в статье [Восстановление виртуальных машин с помощью специальных конфигураций сети](backup-azure-restore-vms.md#restoring-vms-with-special-netwrok-configurations).
	- Виртуальные машины в конфигурации балансировщика нагрузки (внутренняя и внешняя)
	- Виртуальные машины с несколькими зарезервированными IP-адресами
	- Виртуальные машины с несколькими сетевыми адаптерами

## Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## Дальнейшие действия

- [Планирование инфраструктуры резервного копирования виртуальных машин в Azure](backup-azure-vms-introduction.md)
- [Настройка виртуальных машин](backup-azure-vms.md)
- [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)

<!---HONumber=AcomDC_0128_2016-->