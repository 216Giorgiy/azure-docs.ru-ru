<properties
	pageTitle="Подготовка среды для резервного копирования виртуальных машин Azure | Microsoft Azure"
	description="Убедитесь, что ваша среда подготовлена для резервного копирования виртуальных машин в Azure."
	services="backup"
	documentationCenter=""
	authors="markgalioto"
	manager="cfreeman"
	editor=""
	keywords="резервные копии; резервное копирование;"/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/26/2016"
	ms.author="trinadhk; jimpark; markgal;"/>


# Подготовка среды для резервного копирования виртуальных машин Azure

> [AZURE.SELECTOR]
- [Модель Resource Manager](backup-azure-arm-vms-prepare.md)
- [Классическая модель](backup-azure-vms-prepare.md)

Прежде чем можно будет выполнять резервное копирование виртуальной машины Azure, необходимо обеспечить выполнение трех условий:

- Создайте хранилище архивации или найдите имеющееся хранилище архивации *в том же регионе, что и виртуальная машина*.
- Установить сетевое подключение между общедоступными IP-адресами Azure и конечными точками хранилища Azure.
- Установить агент виртуальной машины.

Если вы знаете, что эти условия в вашей среде уже выполнены, переходите к статье [Резервное копирование виртуальных машин](backup-azure-vms.md). Если это не так, подготовьте среду к резервному копированию виртуальной машины Azure, как описано в этой статье.


## Ограничения при резервном копировании и восстановлении виртуальной машины

>[AZURE.NOTE] В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Resource Manager и классическая модель](../resource-manager-deployment-model.md). При развертывании по классической модели действуют следующие ограничения.

- Архивация виртуальных машин, к которым подключено более 16 дисков данных, не поддерживается.
- Архивация виртуальных машин с зарезервированным IP-адресом и без заданной конечной точки не поддерживается.
- Данные архивации не содержат установленные в сети диски, подключенные к виртуальной машине.
- Замена существующей виртуальной машины во время восстановления не поддерживается. Сначала необходимо удалить существующую виртуальную машину и все связанные диски, а затем восстановить данные из резервной копии.
- Резервное копирования и восстановление между регионами не поддерживается.
- Архивация виртуальных машин с помощью службы архивации Azure поддерживается во всех областях, общих для Azure (см. [контрольный список](https://azure.microsoft.com/regions/#services) поддерживаемых регионов). Если искомый регион в настоящее время не поддерживается, он будет отсутствовать в раскрывающемся списке при создании хранилища.
- Архивация виртуальных машин с помощью службы архивации Azure поддерживается только в определенных версиях операционных систем:
  - **Linux**: служба архивации Azure поддерживает весь [список дистрибутивов, рекомендуемых для использования в Azure](../virtual-machines/virtual-machines-linux-endorsed-distros.md), за исключением CoreOS Linux. Другие собственные дистрибутивы Linux также должны работать, если агент виртуальной машины доступен на виртуальной машине и есть поддержка Python.
  - **Windows Server**: версии до Windows Server 2008 R2 не поддерживаются.
- Восстановление контроллера домена виртуальной машины, которая входит в конфигурацию с несколькими контроллерами домена, поддерживается только с помощью PowerShell. Дополнительные сведения о [восстановлении контроллера домена в конфигурации с несколькими контроллерами домена](backup-azure-restore-vms.md#restoring-domain-controller-vms).
- Восстановление виртуальных машин с описанными ниже особыми конфигурациями сети поддерживается только в PowerShell. Когда процедура восстановления будет завершена, виртуальные машины, созданные в пользовательском интерфейсе с помощью рабочего процесса восстановления, не будут включать эти конфигурации сети. Дополнительные сведения см. в статье [Восстановление виртуальных машин с помощью специальных конфигураций сети](backup-azure-restore-vms.md#restoring-vms-with-special-netwrok-configurations).
    - Виртуальные машины в конфигурации балансировщика нагрузки (внутренняя и внешняя)
    - Виртуальные машины с несколькими зарезервированными IP-адресами
    - Виртуальные машины с несколькими сетевыми адаптерами

## Создание хранилища архивации для виртуальной машины

Хранилище архивации — это сущность, в которой хранятся созданные резервные копии и точки восстановления. Хранилище архивации также содержит политики резервного копирования, применяемые к виртуальным машинам, для которых настроена архивация.

На рисунке ниже показаны связи между разными сущностями службы архивации Azure. ![Сущности и связи службы архивации Azure](./media/backup-azure-vms-prepare/vault-policy-vm.png)

Создание хранилища службы архивации

1. Выполните вход на [портал Azure](http://manage.windowsazure.com/).

2. На портале Azure последовательно щелкните **Создать** > **Гибридная интеграция** > **Резервное копирование**. При нажатии кнопки **Резервное копирование** выполняется автоматический переход на классический портал (см. информацию после примечания).

    ![Портал Ibiza](./media/backup-azure-vms-prepare/Ibiza-portal-backup01.png)

    >[AZURE.NOTE] Если в последний раз ваша подписка использовалась на классическом портале, она может открыться там же. В этом случае для создания хранилища архивации щелкните **Создать** > **Службы данных** > **Службы восстановления** > **Хранилище архивации** > **Быстрое создание** (см. изображение ниже).

    ![Создание хранилища службы архивации](./media/backup-azure-vms-prepare/backup_vaultcreate.png)

3. В поле **Имя** введите понятное имя хранилища. Имя должно быть уникальным в пределах подписки Azure. Введите имя длиной от 2 до 50 знаков. Имя должно начинаться с буквы, оно может содержать только буквы, цифры и дефисы.

4. В поле **Область** выберите географический регион для хранилища архивации. Хранилище должно находиться в том же регионе, что и виртуальные машины, которые необходимо защитить. Если у вас есть виртуальные машины в нескольких регионах, создайте хранилище архивации в каждом из этих регионов. Нет необходимости указывать учетные записи хранения для хранения данных архивации: хранилище и служба архивации Azure делают это автоматически.

5. В поле **Подписка** выберите подписку, которую нужно связать с хранилищем архивации. Вариантов будет несколько только в том случае, если учетная запись вашей организации связана с несколькими подписками Azure.

6. Щелкните **Создать хранилище**. Для создания резервного хранилища может потребоваться некоторое время. Уведомления о состоянии процесса см. в нижней части портала.

    ![Всплывающее уведомление о создании хранилища](./media/backup-azure-vms-prepare/creating-vault.png)

7. Успешное создание хранилища подтверждается сообщением. На странице **служб восстановления** состояние хранилища будет иметь состояние **Активно**. Сразу после создания хранилища выберите соответствующее значение избыточности хранилища. См. дополнительные сведения о [настройке избыточности хранилища в хранилище службы архивации](backup-configure-vault.md#azure-backup---storage-redundancy-options).

    ![Список хранилищ службы архивации](./media/backup-azure-vms-prepare/backup_vaultslist.png)

8. Щелкните резервное хранилище, чтобы перейти на страницу **Быстрый запуск**, где отображаются инструкции по резервному копированию виртуальных машин Azure.

    ![Инструкции для архивации виртуальной машины на странице панели мониторинга](./media/backup-azure-vms-prepare/vmbackup-instructions.png)


## Сетевое подключение

Чтобы управлять моментальными снимками виртуальной машины, для расширения архивации требуется подключение к общедоступным IP-адресам Azure. Без правильного подключения к Интернету время ожидания HTTP-запросов от виртуальной машины истекает, а архивация завершается сбоем. Если для развертывания установлены ограничения доступа на месте, например, через группу безопасности сети (NSG), выберите один из следующих вариантов, чтобы открыть путь для трафика архивации:

- [Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений](http://www.microsoft.com/ru-RU/download/details.aspx?id=41653). В статье вы найдете указания по добавлению IP-адресов в список разрешений.
- Разверните прокси-сервер HTTP для маршрутизации трафика.

Решая, какой вариант использовать, обратите внимание на соотношение управляемости, детального управления и затрат.

|Параметр|Преимущества|Недостатки|
|------|----------|-------------|
|Разрешенные диапазоны IP-адресов| Нет дополнительных затрат.<br><br>Открыть доступ в NSG можно с помощью командлета <i>Set-AzureNetworkSecurityRule</i>. | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются.<br><br>Доступ ко всей службе Azure, а не только к хранилищу.|
|Прокси-сервер HTTP| Точное управление разрешенными URL-адресами хранилища в прокси-сервере.<br>Одна точка Интернет-доступа к виртуальным машинам.<br>Не подвергается влиянию изменений IP-адресов Azure.| Дополнительные затраты для работы виртуальной машины с программным обеспечением прокси-сервера.|

### Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений.

Чтобы добавить диапазоны IP-адресов центра обработки данных Azure в список разрешений, ознакомьтесь с дополнительными сведениями о диапазонах IP-адресов и указаниями на [веб-сайте Azure](http://www.microsoft.com/ru-RU/download/details.aspx?id=41653).

### Использование прокси-сервера HTTP для архивации виртуальных машин
Во время архивации виртуальных машин команды управления моментальными снимками отправляются из расширения архивации в службу хранилища Azure с помощью API HTTPS. Направьте трафик расширения архивации через прокси-сервер HTTP, потому что это единственный компонент, который настроен для общего доступа в Интернете.

>[AZURE.NOTE] Особых требований к программному обеспечению нет. Убедитесь, что прокси-сервер подходит для выполнения описанных ниже настроек.

На приведенном ниже изображении показан пример трех этапов настройки, которые необходимо выполнить, чтобы использовать прокси-сервер HTTP:

- Виртуальная машина приложения направляет весь HTTP-трафик для общего доступа в Интернете через виртуальную машину прокси-сервера.
- В виртуальной машине прокси-сервера разрешен входящий трафик от виртуальных машин в виртуальной сети.
- Для группы безопасности сети с именем NSF-lockdown требуется правило безопасности, которое разрешает передачу интернет-трафика из виртуальной машины прокси-сервера.

![Диаграмма развертывания NSG с прокси-сервером HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

Чтобы использовать прокси-сервер HTTP для обмена данными для общего доступа в Интернете, выполните следующие действия.

#### Шаг 1. Настройка исходящих сетевых подключений
###### Для компьютеров Windows
Следующая процедура позволяет настроить конфигурацию прокси-сервера для учетной записи Local System.

1. Скачайте программу [PsExec](https://technet.microsoft.com/sysinternals/bb897553).
2. Выполните следующую команду из командной строки с повышенными привилегиями:

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     Откроется окно Internet Explorer.
3. Последовательно выберите "Сервис -> Свойства обозревателя -> Подключения -> Настройка сети".
4. Проверьте параметры прокси-сервера для системной учетной записи. Задайте IP-адрес прокси-сервера и порт.
5. Закройте Internet Explorer.

В результате для компьютера будет настроен прокси-сервер, который будет использоваться для любого исходящего трафика HTTP или HTTPS.

Если вы настроили прокси-сервер из текущей учетной записи пользователя, а не учетной записи Local System, используйте следующий сценарий для применения к SYSTEMACCOUNT:

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

>[AZURE.NOTE] Если в журнале прокси-сервера отобразится сообщение "407 — Требуется проверка подлинности прокси", проверьте правильность настройки проверки подлинности.

######Для компьютеров Linux

Добавьте следующую строку в файл ```/etc/environment```:

```
http_proxy=http://<proxy IP>:<proxy port>
```

Добавьте следующие строки в файл ```/etc/waagent.conf```:

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### Шаг 2. Разрешение входящих подключений на прокси-сервере

1. Откройте брандмауэр Windows на прокси-сервере. Самый простой способ доступа к брандмауэру — это поиск брандмауэра Windows в режиме повышенной безопасности.

    ![Открытие брандмауэра](./media/backup-azure-vms-prepare/firewall-01.png)

2. В диалоговом окне брандмауэра Windows щелкните правой кнопкой мыши **Правила для входящих подключений** и выберите **Создать правило**.

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-02.png)

3. В **мастере создания правила для нового входящего подключения** выберите значение **Настраиваемое** для параметра **Тип правила** и нажмите кнопку **Далее**.

4. Чтобы выбрать **программу**, щелкните элемент **Все программы** и нажмите кнопку **Далее**.

5. На странице **Протокол и порты** введите следующие сведения и нажмите кнопку **Далее**:

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-03.png)

    - Для параметра *Тип протокола* выберите *TCP*.
    - В поле *Локальный порт* выберите *Определенные порты*, а в поле под ним укажите уже настроенный порт ```<Proxy Port>```.
    - В поле *Удаленный порт* выберите *Все порты*.

    Выполните все инструкции мастера и укажите имя правила.

#### Шаг 3. Добавление правила исключения к группе NSG

Введите следующую команду в командной строке Azure PowerShell:

Она добавляет исключение к группе NSG. Это исключение разрешает TCP-трафик из любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS). Если вам необходимо разрешить общий доступ из Интернета к какому-либо порту, добавьте этот порт в параметр ```-DestinationPortRange```.

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

*Не забудьте заменить имена из примера данными, соответствующими вашему развертыванию.*


## Агент виртуальной машины

Перед началом архивации виртуальной машины Azure убедитесь, что на ней правильно установлен агент виртуальной машины. Так как агент виртуальной машины является необязательным компонентом при создании виртуальной машины, убедитесь, что флажок агента виртуальной машины установлен до ее подготовки.

### Ручная установка и обновление

Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агент виртуальной машины отсутствует. Для таких виртуальных машин агент VM необходимо установить явным образом. Подробности об [установке агента ВМ на существующей виртуальной машине](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).

| **Операция** | **Windows** | **Linux** |
| --- | --- | --- |
| Установка агента виртуальной машины | <li>Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора. <li>[Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. | <li> Установите последнюю версию [агента Linux](https://github.com/Azure/WALinuxAgent) с сайта GitHub. Чтобы выполнить установку, необходимо иметь права администратора. <li> [Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. |
| Обновление агента виртуальной машины | Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). <br><br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции архивации. | Следуйте указаниям по [обновлению агента виртуальной машины Linux](../virtual-machines-linux-update-agent.md). <br><br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции архивации. |
| Проверка установки агента виртуальной машины | <li>На виртуальной машине Azure перейдите в папку *C:\\WindowsAzure\\Packages*. <li>В ней должен находиться файл WaAppAgent.exe.<li> Щелкните этот файл правой кнопкой мыши, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше. | Недоступно |


См. дополнительные сведения об [агенте виртуальной машины](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) и [его установке](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).

### Расширение резервного копирования

Чтобы выполнить архивацию виртуальной машины, служба архивации Azure устанавливает расширение для агента виртуальной машины. Служба резервного копирования Azure легко обновляет и применяет исправления к расширению резервного копирования без дополнительного вмешательства пользователя.

Расширение резервного копирования устанавливается, если виртуальная машина запущена. Кроме того, на запущенной виртуальной машине проще всего получить точку восстановления, согласованную с приложениями. Тем не менее, служба архивации Azure будет продолжать архивацию виртуальной машины, даже если она выключена и установить расширение невозможно (автономная виртуальная машина). В этом случае точка восстановления будет *отказоустойчивой*, как обсуждалось выше.


## Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## Дальнейшие действия
Следующий шаг после подготовки среды для резервного копирования виртуальной машины — это создание резервной копии. Более подробные сведения о резервном копировании виртуальных машин см. в статье по планированию.

- [Настройка виртуальных машин](backup-azure-vms.md)
- [Планирование инфраструктуры резервного копирования виртуальных машин в Azure](backup-azure-vms-introduction.md)
- [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)

<!---HONumber=AcomDC_0831_2016-->