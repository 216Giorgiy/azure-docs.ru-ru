<properties
	pageTitle="Подготовка среды для резервного копирования виртуальных машин Azure | Microsoft Azure"
	description="Убедитесь, что ваша среда подготовлена для резервного копирования виртуальных машин Azure."
	services="backup"
	documentationCenter=""
	authors="Jim-Parker"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="11/02/2015"
	ms.author="trinadhk; aashishr; jimpark; markgal"/>

# Подготовка среды для резервного копирования виртуальных машин Azure
Перед копированием виртуальной машины Azure необходимо выполнить эти обязательные требования, чтобы подготовить среду. Если это уже сделано, можно приступать к [резервному копированию виртуальных машин](backup-azure-vms.md). В противном случае выполните инструкции ниже, чтобы подготовить свою среду.


## 1\. Хранилище службы архивации

![Хранилище службы архивации](./media/backup-azure-vms-prepare/step1.png)

Чтобы начать резервное копирование виртуальных машин Azure, необходимо создать хранилище службы архивации. Хранилище — это объект, в котором хранятся созданные резервные копии и точки восстановления. Хранилище также содержит политики резервного копирования, которые будут применяться к виртуальным машинам, для которых настроено резервное копирование.

На рисунке ниже показаны связи между разными сущностями службы архивации Azure. ![Объекты и связи службы архивации Azure](./media/backup-azure-vms-prepare/vault-policy-vm.png)

Создание хранилища службы архивации

1. Выполните вход на [Портал управления](http://manage.windowsazure.com/).

2. Последовательно щелкните **Создать** > **Службы данных** > **Службы восстановления** > **Хранилище архивации** > **Быстрое создание**. Если с учетной записью вашей организации связано несколько подписок, выберите ту, которую следует связать с хранилищем службы архивации. В каждой подписке Azure может быть несколько хранилищ службы архивации для организации защищаемых виртуальных машин.

3. В поле **Имя** введите понятное имя для идентификации хранилища. Это имя должно быть уникальным для каждой подписки.

4. В поле **Область** выберите географический регион для хранилища архивации. Хранилище должно быть в том же регионе, что и виртуальные машины, которые необходимо защитить. При наличии виртуальных машин в разных регионах создайте хранилище в каждом из них. Нет необходимости указывать учетные записи хранения для хранения данных резервного копирования: хранилище и служба архивации Azure делают это автоматически.

    ![Создание хранилища службы архивации](./media/backup-azure-vms-prepare/backup_vaultcreate.png)

5. Щелкните **Создать хранилище**. Для создания резервного хранилища может потребоваться некоторое время. Уведомления о состоянии процесса см. в нижней части портала.

    ![Всплывающее уведомление о создании хранилища](./media/backup-azure-vms-prepare/creating-vault.png)

6. Отобразится сообщение об успешном создании хранилища, а на странице служб восстановления хранилище будет иметь активное состояние. Сразу после создания хранилища убедитесь, что выбрано соответствующее значение избыточности хранилища. См. дополнительные сведения о [настройке избыточности хранилища в хранилище службы архивации](backup-configure-vault.md#azure-backup---storage-redundancy-options).

    ![Список хранилищ службы архивации](./media/backup-azure-vms-prepare/backup_vaultslist.png)

7. Щелкните резервное хранилище, чтобы перейти на страницу **Быстрый запуск**, где отображаются инструкции по резервному копированию виртуальных машин Azure.

    ![Инструкции для резервного копирования виртуальной машины на странице панели мониторинга](./media/backup-azure-vms-prepare/vmbackup-instructions.png)



## 2\. Сетевое подключение

![Сетевое подключение](./media/backup-azure-vms-prepare/step2.png)

Для правильной работы расширения резервного копирования требуется подключение к общедоступным IP-адресам Azure, так как расширение отправляет команды в конечную точку хранилища Azure (URL-адрес в формате HTTP) для управления снимками виртуальной машины. Без правильного подключения к Интернету время ожидания таких HTTP-запросов от виртуальной машины будет истекать, а операция резервного копирования завершится сбоем.

### Сетевые ограничения с помощью групп безопасности сети (NSG)

Развертывание может иметь ограничения доступа (например, через группу безопасности сети). В таком случае нужно выполнить дополнительные шаги для проверки того, что это не влияет на трафик резервного копирования в резервное хранилище Azure.

Путь для трафика резервного копирования можно указать двумя способами.

1. Добавить в список разрешений [диапазоны IP-адресов центра обработки данных Azure](http://www.microsoft.com/ru-RU/download/details.aspx?id=41653).
2. Развернуть прокси-сервер HTTP для маршрутизации трафика.

Компромисс заключается в балансе управляемости, точности управления и затрат.

|Параметр|Преимущества|Недостатки|
|------|----------|-------------|
|ВАРИАНТ 1. Разрешенные диапазоны IP-адресов| Нет дополнительных затрат.<br><br>Открыть доступ в NSG можно с помощью командлета <i>Set-AzureNetworkSecurityRule</i>. | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются.<br>Доступ ко всей службе Azure, а не только к хранилищу.|
|ВАРИАНТ 2. Прокси-сервер HTTP| Точное управление разрешенными URL-адресами хранилища в прокси-сервере.<br>Одна точка Интернет-доступа к виртуальным машинам.<br>Не подлежат изменениям IP-адресов Azure.| Дополнительные затраты для работы виртуальной машины с программным обеспечением прокси-сервера.|

### Использование прокси-сервера HTTP для резервного копирования виртуальных машин
Во время резервного копирования виртуальных машин команды управления моментальными снимками отправляются из расширения резервного копирования в службу хранилища Azure с помощью API HTTPS. Этот трафик должен перенаправляться из расширения через прокси-сервер, так как только на прокси-сервере будет настроен доступ к Интернету.

>[AZURE.NOTE]Особых требований к программному обеспечению нет. Убедитесь, что прокси-сервер подходит для выполнения описанных ниже настроек.

В приведенном ниже примере виртуальную машину приложения нужно настроить для использования виртуальной машины прокси-сервера, через который проходит весь трафик HTTP из Интернета. Виртуальную машину прокси-сервера необходимо настроить для разрешения входящего трафика из виртуальных машин в виртуальной сети. И наконец, для NSG (с именем *блокировка NSG*) требуется новое правило безопасности, разрешающее Интернет-трафик, исходящий из виртуальной машины прокси-сервера.

![Диаграмма развертывания NSG с прокси-сервером HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

**а) Разрешите исходящие сетевые соединения.**

1. На компьютерах под управлением ОС Windows в командной строке с повышенными привилегиями выполните следующую команду:

	```
	netsh winhttp set proxy http://<proxy IP>:<proxy port>
	```

	В результате для компьютера будет настроен прокси-сервер, который будет использоваться для любого исходящего трафика HTTP или HTTPS.

2. На компьютерах под управлением ОС Linux добавьте в файл ```/etc/environment``` следующую строку:

 	```
 	http_proxy=http://<proxy IP>:<proxy port>
 	```

	Добавьте следующие строки в файл ```/etc/waagent.conf```:

	```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

**б) Разрешите входящие соединения на прокси-сервере.**

1. Откройте на прокси-сервере брандмауэр Windows. Щелкните правой кнопкой мыши *правила для входящих подключений* и выберите команду **Создать правило...**.

	![Открытие брандмауэра](./media/backup-azure-vms-prepare/firewall-01.png)

	![Создание нового правила](./media/backup-azure-vms-prepare/firewall-02.png)
2. В *мастере создания правила для нового входящего подключения* выберите значение **Настраиваемое** для параметра *Тип правила* и нажмите кнопку «Далее». Чтобы выбрать *программу*, откройте **Все программы** и нажмите кнопку «Далее».

3. На экране *Протокол и порты* введите данные из таблицы ниже и нажмите кнопку «Далее».

	![Создание нового правила](./media/backup-azure-vms-prepare/firewall-03.png)

| Поле ввода | Значение |
| --- | --- |
| Тип протокола | TCP |
| Локальный порт | В раскрывающемся списке выберите *Определенные порты* и введите в текстовое поле настроенный порт ```<Proxy Port>```. |
| Удаленный порт | В раскрывающемся списке выберите *Все порты*. |

Выполните все инструкции мастера и укажите имя правила.

**в) Добавьте правило исключения NSG.**

Откройте окно командной строки Azure PowerShell и выполните следующую команду:

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

Эта команда добавляет исключение NSG, которое разрешает TCP-трафик из любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS). Если вам необходимо получить доступ к какому-либо порту в Интернете, добавьте его в ```-DestinationPortRange```.

*Не забудьте заменить имена из примера данными, соответствующими вашему развертыванию.*

## 3\. Агент виртуальной машины

![Агент виртуальной машины](./media/backup-azure-vms-prepare/step3.png)

Перед началом резервного копирования виртуальной машины Azure убедитесь, что на ней правильно установлен агент виртуальной машины. Так как агент виртуальной машины является необязательным компонентом при создании виртуальной машины, убедитесь, что установлен флажок агента виртуальной машины до ее подготовки.

### Ручная установка и обновление

Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом. Подробности об [установке агента ВМ на существующей виртуальной машине](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).

| **Операция** | **Windows** | **Linux** |
| --- | --- | --- |
| Установка агента виртуальной машины | <li>Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора. <li>[Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), указывающее на установку агента. | <li> Установите последнюю версию [агента Linux](https://github.com/Azure/WALinuxAgent) с сайта GitHub. Чтобы выполнить установку, необходимо иметь права администратора. <li> [Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), указывающее на установку агента. |
| Обновление агента виртуальной машины | Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). <br><br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции резервного копирования. | Следуйте указаниям по [обновлению агента виртуальной машины Linux](../virtual-machines-linux-update-agent.md). <br><br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции резервного копирования. |
| Проверка установки агента виртуальной машины | <li>На виртуальной машине Azure перейдите в папку *C:\\WindowsAzure\\Packages*. <li>В ней должен находиться файл WaAppAgent.exe.<li> Щелкните этот файл правой кнопкой мыши, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле «Версия продукта» должно отображаться значение 2.6.1198.718 или выше | - |


См. дополнительные сведения об [агенте виртуальной машины](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) и [ее установке](http://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).

### Расширение резервного копирования

Чтобы выполнить резервное копирование виртуальной машины, служба архивации Azure устанавливает расширение для агента виртуальной машины. Служба резервного копирования Azure легко обновляет и применяет исправления к расширению резервного копирования без дополнительного вмешательства пользователя.

Расширение резервного копирования устанавливается, если виртуальная машина запущена. Кроме того, на запущенной виртуальной машине проще всего получить точку восстановления, согласованную с приложениями. Тем не менее служба архивации Azure будет продолжать резервное копирование виртуальной машины, даже если она выключена и установить расширение невозможно (автономная виртуальная машина). В этом случае точка восстановления будет *отказоустойчивой*, как обсуждалось выше.


## Ограничения

- Резервное копирование виртуальных машин на основе диспетчера ресурсов Azure (IaaS V2) не поддерживается.
- Резервное копирование виртуальных машин, к которым подключено более 16 дисков, не поддерживается.
- Резервное копирование виртуальных машин с использованием хранилища класса Premium не поддерживается.
- Резервное копирование виртуальных машин с несколькими зарезервированными IP-адресами не поддерживается.
- Резервное копирование виртуальных машин с зарезервированным IP-адресом и без заданной конечной точки не поддерживается.
- Резервное копирование виртуальных машин, использующих несколько сетевых карт, не поддерживается.
- Резервное копирование виртуальных машин в конфигурации с балансировкой нагрузки (внутренней и для Интернета) не поддерживается.
- Замена существующей виртуальной машины во время восстановления не поддерживается. Сначала необходимо удалить существующую виртуальную машину и все связанные диски, а затем восстановить данные из резервной копии.
- Резервное копирования и восстановление между регионами не поддерживается.
- Резервное копирование виртуальных машин с помощью службы архивации Azure поддерживается во всех общедоступных регионах Azure. См. [список](http://azure.microsoft.com/regions/#services) поддерживаемых регионов. Если искомый регион в настоящее время не поддерживается, он не будет отображаться в раскрывающемся списке при создании хранилища.
- Резервное копирование виртуальных машин с помощью службы архивации Azure поддерживается только в определенных версиях операционных систем:
  - **Linux**: список дистрибутивов, одобренных Azure, доступен [здесь](../virtual-machines-linux-endorsed-distributions.md). Другие собственные дистрибутивы Linux должны также работать, если агент виртуальной машины доступен на виртуальной машине.
  - **Windows Server**: версии до Windows Server 2008 R2 не поддерживаются.
- Восстановление контроллера домена виртуальной машины, которая входит в конфигурацию с несколькими контроллерами домена, поддерживается только с помощью PowerShell. Дополнительная информация о [восстановлении контроллера домена в конфигурации с несколькими контроллерами домена](backup-azure-restore-vms.md#restoring-domain-controller-vms).

## Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## Дальнейшие действия

- [Планирование инфраструктуры резервного копирования виртуальных машин в Azure](backup-azure-vms-introduction.md)
- [Настройка виртуальных машин](backup-azure-vms.md)
- [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)

<!---HONumber=Nov15_HO2-->