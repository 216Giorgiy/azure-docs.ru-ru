<properties
   pageTitle="Оптимизация производительности резервного копирования в службе архивации Azure | Microsoft Azure"
   description="В этой статье представлены инструкции по устранению неполадок, которые помогут вам диагностировать и устранить причины возникновения проблем с производительностью в службе архивации Azure."
   services="backup"
   documentationCenter=""
   authors="genlin"
   manager="markgal"
   editor=""/>

<tags
    ms.service="backup"
    ms.workload="storage-backup-recovery"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="07/20/2016"
    ms.author="genli"/>

# Оптимизация производительности резервного копирования в службе архивации Azure

В этой статье представлены инструкции по устранению неполадок, которые помогут вам диагностировать и устранить причины возникновения проблем с производительностью в службе архивации Azure. Если резервное копирование файлов выполняется с помощью агента службы архивации Azure, этот процесс может занять больше времени, чем ожидалось. Ниже приведены причины возникновения проблем с производительностью.

-	[Наличие узких мест производительности на компьютере, для которого выполняется архивация](#cause1).
-	[На производительность службы архивации Azure влияет другой процесс или антивирусная программа](#cause2).
-	[Агент службы архивации запущен на виртуальной машине Azure](#cause3).
-	[Выполняется резервное копирование большого количества файлов (нескольких миллионов)](#cause4).

В следующем разделе описаны шаги, которые помогут вам определить причину снижения производительности.

Прежде чем приступить к устранению неполадок, рекомендуется скачать и установить [последнюю версию агента службы архивации Azure](http://aka.ms/azurebackup_agent). Мы периодически обновляем агент службы архивации, чтобы устранить различные проблемы, добавить новые возможности и улучшить производительность.

Кроме того, настоятельно рекомендуется изучить статью [Служба архивации Azure: часто задаваемые вопросы](backup-azure-backup-faq.md), чтобы убедиться, что проблемы c производительностью не вызваны общими ошибками конфигурации.

## Действия по устранению неполадок
<a id="cause1"></a>
## Причина 1. Низкая производительность резервного копирования связана с наличием узких мест на компьютере, для которого выполняется этот процесс

### Решение

На компьютере, для которого выполняется резервное копирование, могут возникать узкие места, которые могут вызывать задержки. Эти задержки влияют, например, на операции чтения с диска или записи на него, а также пропускную способность, доступную для отправки данных по сети, и т. д.

Windows предоставляет встроенное средство, которое позволяет обнаруживать эти узкие места производительности. Это [системный монитор](https://technet.microsoft.com/magazine/2008.08.pulse.aspx) (Perfmon). В таблице ниже представлен список счетчиков производительности и приведены значения, при которых сохраняется оптимальная производительность резервного копирования.

Ниже приведены некоторые счетчики производительности и диапазоны, которые могут понадобиться при обнаружении узких мест производительности.

| Счетчик | Состояние |
|---|---|
|Логический диск (физический диск) — % времени простоя | • 100–50 % — работоспособное состояние</br>• 49–20 % — состояние предупреждения или монитора</br>• 19–0 % — критическое или неактивное состояние|
| Логический диск (физический диск) — среднее время выполнения операции чтения или записи на диске | • 0,001–0,015 мс — работоспособное состояние</br>• 0,015–0,025 мс — состояние предупреждения или монитора</br>• 0,026 мс и более — критическое или неактивное состояние|
| Логический диск (физический диск) — текущая длина очереди диска (для всех экземпляров) | 80 запросов в течение более 6 минут |
| Память — байт в невыгружаемом пуле|• Потребление менее 60 % ресурсов пула — работоспособное состояние<br>• 61–80 % — состояние предупреждения или монитора</br>• Более 80 % — критическое или неактивное состояние|
| Память — байт в выгружаемом пуле |• Потребление менее 60 % ресурсов пула — работоспособное состояние</br>• 61–80 % — состояние предупреждения или монитора</br>• Более 80 % — критическое или неактивное состояние|
| Доступная память (МБ)| • 50 % и более — работоспособное состояние</br>• 25 % — состояние монитора</br>• 10 % — состояние предупреждения</br>• Менее 100 МБ или 5 % доступной памяти — критическое или неактивное состояние|
|Процессор — % загруженности процессора (все экземпляры)|• Менее 60 % — работоспособное состояние</br>• 61–90 % — состояние предупреждения или монитора</br>• 91–100 % — критическое состояние|


> [AZURE.NOTE] Если проблемы производительности вызваны тем, что инфраструктура изолирована, рекомендуется регулярно выполнять дефрагментацию защищенных дисков.

<a id="cause2"></a>
## Причина 2. Низкая производительность службы архивации Azure вызвана другим процессом или антивирусным программным обеспечением

Мы уже сталкивались с несколькими случаями, когда на производительность агента службы архивации Azure отрицательно влияли другие процессы, запущенные в системе Windows. Например, если для резервного копирования данных используется как агент службы архивации Azure, так и другая программа или если выполняется резервное копирование файлов, заблокированных антивирусной программой. В таких ситуациях резервное копирование может завершиться сбоем или занять больше времени, чем ожидалось.

### Решение

Для решения этой проблемы рекомендуется отключить другие программы архивации и отследить время резервного копирования, выполняемого с помощью агента службы архивации Azure. Как правило, чтобы предотвратить эти конфликтные ситуации, рекомендуется выполнять задания резервного копирования поочередно.

Для антивирусных программ необходимо исключить следующие файлы и расположения:

- процесс в расположении C:\\Program Files\\Microsoft Azure Recovery Services Agent\\bin\\cbengine.exe;
- папки C:\\Program Files\\Microsoft Azure Recovery Services Agent\\;
- вспомогательное расположение (если не используется стандартное расположение выше).

<a id="cause3"></a>
## Причина 3. Агент службы архивации запущен на виртуальной машине Azure

### Решение

Если агент службы архивации запущен на виртуальной машине Azure, а не на физическом компьютере, это может привести к снижению производительности. Это ожидаемое поведение, так как максимальное количество операций ввода-вывода ограничено. Чтобы оптимизировать производительность, рекомендуется переместить данные, для которых выполняется резервное копирование, в хранилище класса Premium. Мы работаем над устранением этой проблемы, и она будет решена в следующей версии.

<a id="cause4"></a>
## Причина 4. Резервное копирование большого количества файлов (нескольких миллионов)

### Решение

Перемещение большого объема данных занимает довольно длительное время. В некоторых случаях на время выполнения резервного копирования влияет не только объем данных, но и количество файлов и папок, особенно при резервном копировании нескольких миллионов маленьких файлов (от нескольких байтов до нескольких килобайтов).

Это связано с тем, что одновременно с выполнением резервного копирования и переносом данных в Azure происходит каталогизация файлов, а в некоторых случаях этот процесс занимает более длительное время.

Ознакомьтесь со сведениями ниже, чтобы подробнее узнать об узких местах производительности, и примите соответствующие меры.

а. **В пользовательском интерфейсе отображаются сведения о ходе выполнения передачи данных** — в этом случае передача данных все еще выполняется, но из-за пропускной способности сети или объема данных возникают задержки.

b. **В пользовательском интерфейсе не отображаются сведения о ходе выполнения передачи данных** — в этом случае необходимо открыть файлы журналов в расположении C:\\Microsoft Azure Recovery Services Agent\\Temp и проверить запись FileProvider::EndData. Наличие этой записи означает, что передача данных завершена, и выполняется операция каталогизации. Не отменяйте задания резервного копирования. Дождитесь завершения операции каталогизации. Если проблема не исчезнет, обратитесь в [службу поддержки Azure](https://portal.azure.com/#create/Microsoft.Support).

<!---HONumber=AcomDC_0720_2016-->