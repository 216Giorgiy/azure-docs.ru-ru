---
title: Архитектура службы Azure Backup
description: Обзор архитектуры, компонентов и процессов, используемых службой Azure Backup.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 01/15/2019
ms.author: raynew
ms.openlocfilehash: d3e6a17ba9d0712d921d8e0a1d0bcbcd68ce5cfb
ms.sourcegitcommit: a408b0e5551893e485fa78cd7aa91956197b5018
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2019
ms.locfileid: "54360554"
---
# <a name="azure-backup-architecture"></a>Архитектура службы Azure Backup

[Служба Azure Backup](backup-overview.md) позволяет создавать резервные копии данных в облаке Microsoft Azure. В этой статье описаны архитектура, компоненты и процессы Azure Backup. 


## <a name="what-does-azure-backup-do"></a>Что такое Azure Backup

Служба Azure Backup позволяет создавать резервные копии данных, состояния компьютера и рабочих нагрузок, выполняющихся на локальных компьютерах и виртуальных машинах Azure. Есть несколько сценариев Azure Backup:

- **Резервное копирование локальных компьютеров**:
    - Можно выполнять резервное копирование локальных компьютеров напрямую в Azure с помощью службы Azure Backup.
    - Вы можете защитить локальные компьютеры с помощью System Center Data Protection Manager (DPM) или Microsoft Azure Backup Server (MABS), а затем выполнить резервное копирование защищенных данных с DPM или MABS в Azure с помощью службы Azure Backup.
- **Резервное копирование виртуальных машин Azure**:
    - Можно создавать резервные копии виртуальных машин Azure непосредственно с помощью Azure Backup.
    - Можно защитить виртуальные машины Azure с помощью DPM или MABS, работающих в Azure, а затем выполнить резервное копирование защищенных данных для данных DPM или MABS с помощью службы Azure Backup.

Узнайте больше о [резервном копировании](backup-overview.md) и [поддерживаемых сценариях](backup-support-matrix.md).


## <a name="where-is-data-backed-up"></a>Куда выполняется резервное копирование данных

В Azure Backup резервные копии данных хранятся хранилище Служб восстановления. Это интернет-хранилище в Azure, предназначенное для хранения таких данных, как резервные копии, точки восстановления и политики резервного копирования.

- Хранилища служб восстановления упрощают организацию данных архивации и одновременно снижают затраты на управление.
- В рамках одной подписки Azure можно создать до 500 хранилищ Служб восстановления. 
- В хранилище можно отслеживать элементы, для которых выполнено резервное копирование, включая виртуальные машины Azure и локальные компьютеры.
- Можно управлять доступом к хранилищу с помощью [управления доступом на основе ролей Azure (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal).
- Нужно указать способ репликации данных в хранилище для обеспечения избыточности:
    - **LRS.** Локально избыточное хранилище (LRS) можно использовать для защиты от сбоев в центре обработки данных. LRS реплицирует данные в единицу масштабирования хранилища. [Узнайте больше](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs).
    - **GRS.** Можно использовать геоизбыточное хранилище (GRS) для следующего: защиты от сбоя в масштабе региона, а также репликации данных в дополнительный регион. [Узнайте больше](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs). 
    - По умолчанию в качестве хранилища Служб восстановления для Backup используется GRS. 



## <a name="how-does-azure-backup-work"></a>Как работает Azure Backup

В Azure Backup выполняются задания резервного копирования на основе настраиваемой политики резервного копирования или политики по умолчанию. Способ резервного копирования в Azure Backup зависит от сценария.

**Сценарий** | **Дополнительные сведения** 
--- | ---
**Прямое резервное копирование локальных компьютеров** | Для прямого резервного копирования локальных компьютеров Azure Backup использует агент Служб восстановления Microsoft Azure (MARS). Агент устанавливается на каждом компьютере, для которого нужно создать резервную копию. <br/><br/> Этот тип резервного копирования недоступен для локальных компьютеров Linux. 
**Прямое резервное копирование виртуальных машин Azure** | Если выбрано прямое резервное копирование виртуальных машин Azure, при первом его запуске на виртуальной машине устанавливается расширение виртуальной машины Azure. 
**Резервное копирование компьютеров и приложений, защищенных DPM или MABS** | В этом сценарии резервная копия компьютера или приложения сначала создается в локальном хранилище DPM или MABS. Затем данные в DPM или MABS копируются в хранилище службы Azure Backup. Локальные компьютеры можно защитить с помощью локального решения DPM или MABS. Виртуальные машины Azure можно защитить, запустив DPM или MABS в Azure.

[Ознакомьтесь с общими сведениями](backup-overview.md) и узнайте, [какие возможности поддерживаются](backup-support-matrix.md) для каждого сценария.


### <a name="backup-agents"></a>Агенты Backup

Для различных типов резервного копирования в Azure Backup предусмотрены разные агенты.

**Агент** | **Дополнительные сведения** 
--- | --- 
**Агент служб восстановления Microsoft Azure (MARS)** | Этот агент запускается на отдельных локальных серверах Windows, чтобы выполнить резервное копирование файлов, папок и состояния системы.<br/><br/> Агент запускается на серверах DPM или MABS для резервного копирования локального диска DPM или MABS. Компьютеры и приложения копируются локально на этот диск DPM или MABS.
**Расширение виртуальной машины Azure** | Для резервного копирования виртуальных машин Azure в агент виртуальной машины Azure добавляется расширение резервных копий. 


## <a name="backup-types"></a>Типы резервных копий

**Тип резервного копирования** | **Дополнительные сведения** | **Использование**
--- | --- | ---
**Полное** | Резервная копия содержит весь источник данных.<br/><br/> Полное резервное копирование занимает больше пропускной способности сети. | Используется для начального резервного копирования.
**Разностное** |  Хранение блоков, измененных с момента начального полного резервного копирования. Используется меньший объем сети и хранилища. Избыточные копии данных без изменений не сохраняются.<br/><br/> Неэффективно, так как передаются и сохраняются блоки данных без изменений между последующими операциями резервного копирования. | Не используется службой Azure Backup.
**Добавочное** | Высокая эффективность хранилища и сети. Хранение только блоков данных, которые изменены с момента предыдущего резервного копирования. <br/><br/> При использовании добавочного резервного копирования нет необходимости создавать полные резервные копии. | Используется для резервного копирования на диск DPM или MABS и во всех резервных копиях в Azure.

### <a name="comparison"></a>Сравнение

Использование хранилища, целевое время восстановления (RTO) и использование ресурсов сети различаются для каждого типа резервного копирования. На приведенном ниже рисунке для сравнения показаны типы резервных копий.
- Источник данных A состоит из 10 блоков хранилища A1–A10, резервное копирование которых выполняется ежемесячно.
- Блоки A2, A3, A4 и A9 были изменены в первом месяце, а блок A5 — следующем месяце.
- Если применяется разностное резервное копирование, во втором месяце создаются резервные копии измененных блоков A2, A3, A4 и A9. В третьем месяце эти блоки архивируются повторно, как и измененный блок A5. Измененные блоки будут архивироваться, пока не будет создана следующая полная резервная копия.
- Если применяется добавочное резервное копирование, после создания полной резервной копии в первом месяце блоки A2, A3, A4 и A9 помечаются как измененные и передаются в резервную копию во втором месяце. В третьем месяце помечается и передается только измененный блок A5. 

![Рисунок, демонстрирующий сравнение методов архивации](./media/backup-architecture/backup-method-comparison.png)

## <a name="backup-features"></a>Функции службы Backup

В приведенной ниже таблице перечислены возможности для различных типов резервных копий.

**Компонент** | **Локальные компьютеры Windows (прямое)** | **Виртуальные машины Azure** | **Компьютеры и приложения с DPM или MABS**
--- | --- | --- | ---
Резервное копирование в хранилище | ![Yes][green] | ![Да][green] | ![Yes][green] 
Резервное копирование на диск DPM или MABS, а затем в Azure | | | ![Yes][green] 
Сжатие данных, отправляемых для резервного копирования | ![Yes][green] | При передаче данных сжатие не происходит. Хранилище немного увеличивается, но восстановление выполняется быстрее.  | ![Yes][green] 
Добавочное резервное копирование |![Yes][green] |![Да][green] |![Yes][green] 
Резервное копирование дедуплицированных дисков | | | ![Частично][yellow]<br/><br/> Только для серверов DPM или MABS, развернутых локально. 

![ключ таблицы](./media/backup-architecture/table-key.png)


## <a name="architecture-direct-backup-of-on-premises-windows-machines"></a>Архитектура. Прямое резервное копирование локальных компьютеров Windows

1. Чтобы настроить сценарий, загрузите и установите агент Служб восстановления Microsoft Azure (MARS) на компьютер, выберите данные для резервного копирования, время выполнения резервного копирования и срок хранения этих данных в Azure.
2. Начальное резервное копирование запускается в соответствии с настройками резервного копирования.
3. Агент MARS использует службу теневого копирования томов Windows (VSS), чтобы сделать моментальный снимок томов, выбранных для резервного копирования в определенный момент времени.
    - Чтобы сделать моментальный снимок, агент MARS использует только Windows System Write.
    - Он не использует какие-либо модули записи VSS, поэтому согласование приложений при создании моментальных снимков не обеспечивается.
3. После создания моментального снимка с помощью службы VSS агент MARS создает виртуальный жесткий диск в папке кэша, указанной при настройке резервного копирования, и сохраняет контрольные суммы для каждого блока данных. 
4. Операции добавочного резервного копирования выполняются в соответствии с указанным расписанием, если только не было запущено внеочередное резервное копирование.
5. При добавочном резервном копировании идентифицируются измененные файлы и создается новый виртуальный жесткий диск, который затем сжимается, зашифровывается и отправляется в хранилище.
6. По окончании добавочного резервного копирования новый виртуальный жесткий диск объединяется с виртуальным жестким диском, созданным после начальной репликации. Таким образом предоставляется самое актуальное состояние, которое используется для сравнения при текущем резервном копировании. 

![Резервное копировоние локального сервера Windows с агентом MARS](./media/backup-architecture/architecture-on-premises-mars.png)


## <a name="architecture-direct-backup-of-azure-vms"></a>Архитектура. Прямое резервное копирование виртуальных машин Azure

1. При включении резервного копирования для виртуальной машины Azure резервная копия выполняется в соответствии с указанным расписанием.
2. Расширение резервного копирования устанавливается на виртуальной машине при запросе первой резервной копии, если она запущена.
    - Для виртуальных машин Windows устанавливается расширение VMSnapshot.
    - Для виртуальных машин Linux устанавливается расширение VMSnapshot Linux.
3. Расширение создает моментальный снимок уровня хранилища. 
    - Для запущенных виртуальных машин Windows служба Backup координируется со службой VSS, чтобы сделать снимок виртуальной машины с согласованием приложений. По умолчанию служба Backup создает полные резервные копии VSS. Если не удалось сделать моментальный снимок с согласованием приложений, служба делает моментальный снимок с согласованием файлов.
    - Для резервного копирования виртуальных машин Linux служба Backup выполняет резервную копию с согласованием файлов. Для моментальных снимков с согласованием приложений необходимо вручную настроить такие сценарии.
    - Служба Backup оптимизируется за счет резервного копирования каждого диска виртуальной машины в параллельном режиме. Для каждого диска, для которого создается резервная копия, служба Azure Backup считывает блоки на диске и сохраняет только измененные данные. 
4. После создания моментального снимка данные передаются в хранилище. 
    - Копируются только блоки данных, которые были изменены с момента последнего резервного копирования.
    - Данные не шифруются. Служба Azure Backup поддерживает резервное копирование виртуальных машин Azure, зашифрованных с помощью технологии шифрования дисков Azure (ADE).
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. Это может занять несколько часов при высокой нагрузке. Общее время резервного копирования виртуальной машины составит менее 24 часов для политик ежедневного резервного копирования.
5. После передачи данных в хранилище моментальный снимок удаляется и создается точка восстановления.


![Резервное копирование виртуальных машин Azure](./media/backup-architecture/architecture-azure-vm.png)


## <a name="architecture-back-up-to-dpmmabs"></a>Архитектура. Резервное копирование в DPM и MABS

1. Установите агент защиты DPM или MABS на компьютерах, которые нужно защитить, и добавьте эти компьютеры в группу защиты DPM.
    - Чтобы защитить локальные компьютеры, сервер DPM или MABS должен располагаться локально.
    - Чтобы защитить виртуальные машины Azure, сервер DPM или MABS должен находиться в Azure и запущен в качестве виртуальной машины Azure.
    - С помощью DPM или MABS можно защитить резервное копирование томов, общих папок, файлов и папки. Можно защитить состояние систем компьютеров и компьютеры без операционной системы, а также конкретные приложения с помощью параметров резервного копирования в приложении.
2. При настройке защиты для компьютера или приложения в DPM выберите резервное копирование на локальном диске DPM для кратковременного хранения и в Azure (оперативная защита). Кроме того, можно указать время выполнения резервного копирования в локальное хранилище DPM или MABS и время запуска оперативного резервного копирования в Azure.
3. Диск с защищенной рабочей нагрузкой копируется на локальные диски DPM и в Azure по указанному расписанию.
4. Оперативным резервным копированием в хранилище управляет агент MARS, запущенный на сервере DPM или MABS.

![Резервное копирование компьютеров и рабочих нагрузок, защищенных DPM или MABS](./media/backup-architecture/architecture-dpm-mabs.png)







## <a name="azure-vm-storage"></a>Хранилище виртуальной машины Azure

- Виртуальные машины Azure используют диски для хранения операционной системы, приложений и данных.
- Применяются как минимум два диска: диск для операционной системы и временный диск. Также у них могут быть диски данных для данных приложения. Диски хранятся как виртуальные жесткие диски.
- Виртуальные жесткие диски хранятся в виде страничных BLOB-объектов в учетных записях хранения ценовой категории "Стандартный" или хранилища класса Premium в Azure.
    - Служба хранилища (цен. категория "Стандартный"). Надежная и недорогая поддержка дисков для рабочих нагрузок виртуальных машин, которые нечувствительны к задержке. Служба хранилища ценовой категории "Стандартный" может использовать диски SSD или HDD ценовой категории "Стандартный".
    - Хранилище класса Premium. Поддержка высокопроизводительных дисков. Используются диски SSD ценовой категории "Премиум".
- Есть разные уровни производительности дисков:
    - Диски HDD ценовой категории "Стандартный". Копирование на жесткие диски, используются для экономичного хранилища.
    - Диски SSD ценовой категории "Стандартный". Сочетают в себе элемент дисков SSD ценовой категории "Премиум" и дисков HDD ценовой категории "Стандартный". Обеспечивают более стабильную производительность и надежность, чем диски HDD, но остаются экономичным решением.
    - Диски SSD ценовой категории "Премиум". Копирование на диски SSD обеспечивают высокую производительность и низкую задержку для виртуальных машин рабочих нагрузок с большим количеством операций ввода-вывода.
- Диски могут быть управляемыми или неуправляемыми:
    - Неуправляемые диски. Традиционные типы дисков, используемых виртуальными машинами. Вы можете создать собственную учетную запись хранения и указать ее во время создания такого диска. Вам нужно определить, как максимально эффективно использовать ресурсы хранилища для виртуальных машин.
    - Управляемые диски. Azure отвечает за создание учетных записей хранения и управление ими за вас. Нужно указать размер диска и уровень производительности, а Azure создает диски и управляет ими за вас. Azure обрабатывает хранилища по мере добавления дисков и масштабирования виртуальных машин.

Подробнее:

- Дополнительные сведения о хранилище дисков для виртуальных машин [Windows](../virtual-machines/windows/about-disks-and-vhds.md) и [Linux](../virtual-machines/linux/about-disks-and-vhds.md).
- Дополнительные сведения о [Службе хранилища ценовой категории "Стандартный"](../virtual-machines/windows/standard-storage.md) и [хранилище класса Premium](../virtual-machines/windows/premium-storage.md).


### <a name="backing-up-and-restoring-azure-vms-with-premium-storage"></a>Резервное копирование и восстановление виртуальных машин Azure с использованием хранилища класса Premium 

Резервное копирование виртуальных машин Azure можно выполнить с помощью Azure Backup в хранилище класса Premium:

- Когда служба Backup выполняет резервное копирование виртуальных машин хранилища класса Premium, она создает в учетной записи хранения расположение временного промежуточного хранения, называемое "AzureBackup-". Размер этого расположения соответствует размеру моментального снимка точки восстановления.
- Убедитесь, что в учетной записи хранения класса Premium достаточно свободного места для расположения временного промежуточного хранения. [Узнайте больше](../virtual-machines/windows/premium-storage.md#scalability-and-performance-targets). Не следует изменять расположение временного промежуточного хранения.
- По завершении задания резервного копирования расположение промежуточного хранения удаляется.
- Плата за использование расположения промежуточного хранения взимается в соответствии с [тарифами на использование хранилища класса Premium](../virtual-machines/windows/premium-storage.md#pricing-and-billing).

При восстановлении виртуальных машин Azure с помощью хранилища класса Premium их можно восстановить для хранилища класса Premium или Службы хранилища ценовой категории "Стандартный". Обычно происходит восстановление для класса Premium. Но также можно выполнить восстановление для Службы хранилища ценовой категории "Стандартный", если требуется только подмножество файлов из виртуальной машины. Возможно, это будет более рентабельно.

### <a name="backing-up-and-restoring-managed-disks"></a>Резервное копирование и восстановление управляемых дисков

Можно выполнять резервное копирование виртуальных машин Azure с управляемыми дисками.
- Резервное копирование виртуальных машин с управляемыми дисками выполняется так же, как и любых других виртуальных машин Azure. Резервное копирование виртуальной машины можно выполнить непосредственно в настройках виртуальной машины. Кроме того, вы можете включить резервное копирование виртуальных машин в хранилище Служб восстановления.
- Виртуальные машины, использующие управляемые диски, можно архивировать с помощью наборов точек восстановления, созданных на основе управляемых дисков.
- Служба Azure Backup также поддерживает резервное копирование использующих управляемые диски виртуальных машин, зашифрованных с помощью шифрования дисков Azure (ADE).

Виртуальную машину с управляемыми дисками можно восстановить в полную виртуальную машину с управляемыми дисками или в учетную запись хранения.
- Azure обрабатывает управляемые диски в процессе восстановления, а с помощью параметра учетной записи хранения можно управлять учетной записью хранения, которая создается во время восстановления.
- При восстановлении зашифрованной управляемой виртуальной машины нужно вывести ключи и секреты виртуальной машины из хранилища ключей перед началом восстановления.




## <a name="next-steps"></a>Дополнительная информация

- [Просмотрите](backup-support-matrix.md) таблицу поддержки, чтобы узнать дополнительные сведения о поддерживаемых возможностях и ограничениях в сценариях резервного копирования.
- Настройте резервное копирование для одного из сценариев:
    - [Резервное копирование виртуальных машин Azure](backup-azure-arm-vms-prepare.md)
    - [Прямое резервное копирование компьютеров Windows](tutorial-backup-windows-server-to-azure.md) без сервера резервного копирования.
    - [Настройка MABS](backup-azure-microsoft-azure-backup.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в MABS.
    - [Настройка DPM](backup-azure-dpm-introduction.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в DPM.


[green]: ./media/backup-architecture/green.png
[yellow]: ./media/backup-architecture/yellow.png
[red]: ./media/backup-architecture/red.png

