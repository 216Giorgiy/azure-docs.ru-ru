---
title: Архитектура службы Azure Backup
description: Обзор архитектуры, компонентов и процессов, используемых службой Azure Backup.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/19/2019
ms.author: raynew
ms.openlocfilehash: 4be483994bd7bc5bd97b1e59df230f66e9b4e24e
ms.sourcegitcommit: 9aa9552c4ae8635e97bdec78fccbb989b1587548
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2019
ms.locfileid: "56430352"
---
# <a name="azure-backup-architecture"></a>Архитектура службы Azure Backup

[Служба Azure Backup](backup-overview.md) позволяет создавать резервные копии данных в облаке Microsoft Azure. В этой статье описаны архитектура, компоненты и процессы Azure Backup. 


## <a name="what-does-azure-backup-do"></a>Что такое Azure Backup

Служба Azure Backup позволяет создавать резервные копии данных, состояния компьютера и рабочих нагрузок, выполняющихся на локальных компьютерах и виртуальных машинах Azure. Есть несколько сценариев Azure Backup:

## <a name="how-does-azure-backup-work"></a>Как работает Azure Backup

Для создания резервных копий компьютеров и данных можно использовать нескольких методов.

- **Резервное копирование локальных компьютеров**:
    - Для резервного копирования локальных компьютеров Windows напрямую в Azure можно использовать агент Служб восстановления Microsoft Azure (MARS) службы Azure Backup. Компьютеры Linux не поддерживаются.
    - Резервную копию локальных компьютеров можно создать на сервере резервного копирования (System Center Data Protection Manager (DPM) или Microsoft Azure Backup Server (MABS)), а затем выполнить резервное копирование этого сервера в хранилище Служб восстановления Azure Backup в Azure.
- **Резервное копирование виртуальных машин Azure**:
    - Вы можете напрямую создавать резервные копии виртуальных машин Azure. Для этого Azure Backup устанавливает расширение резервного копирования на агент виртуальной машины Azure, который выполняется на этой виртуальной машине. В этом случае резервное копирование будет выполняться для всей виртуальной машины.
    - Вы можете создавать резервные копии отдельных файлов и папок с виртуальной машины Azure с помощью агента MARS.
    - Вы можете передать резервную копию виртуальных машин Azure на сервер MABS, а затем создать резервную копию MABS в хранилище.

Узнайте больше о [резервном копировании](backup-overview.md) и [поддерживаемых сценариях](backup-support-matrix.md).


## <a name="where-is-data-backed-up"></a>Куда выполняется резервное копирование данных

В Azure Backup резервные копии данных хранятся хранилище Служб восстановления. Это интернет-хранилище в Azure, предназначенное для хранения таких данных, как резервные копии, точки восстановления и политики резервного копирования.

- Эти хранилища упрощают организацию данных резервного копирования и одновременно снижают затраты на управление.
- В рамках одной подписки Azure можно создать до 500 хранилищ.
- В хранилище можно отслеживать элементы, для которых выполнено резервное копирование, включая виртуальные машины Azure и локальные компьютеры.
- Можно управлять доступом к хранилищу с помощью [управления доступом на основе ролей Azure (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal).
- Нужно указать способ репликации данных в хранилище для обеспечения избыточности:
    - **LRS.** Локально избыточное хранилище (LRS) можно использовать для защиты от сбоев в центре обработки данных. LRS реплицирует данные в единицу масштабирования хранилища. [Узнайте больше](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs).
    - **GRS.** Можно использовать геоизбыточное хранилище (GRS) для следующего: защиты от сбоя в масштабе региона, а также репликации данных в дополнительный регион. [Узнайте больше](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs). 
    - По умолчанию в качестве хранилища Служб восстановления для Backup используется GRS. 




### <a name="backup-agents"></a>Агенты Backup

Для различных типов резервного копирования в Azure Backup предусмотрены разные агенты.

**Агент** | **Дополнительные сведения** 
--- | --- 
**Агент служб восстановления Microsoft Azure (MARS)** | 1) Запускается на отдельных локальных серверах Windows, чтобы выполнить резервное копирование файлов, папок и состояния системы.<br/><br/> 2) Выполняется на виртуальных машинах Azure для создания резервных копий файлов, папок и состояния систем.<br/><br/>  3) Выполняется на серверах DPM или MABS для резервного копирования в Azure локального диска DPM или MABS. 
**Расширение виртуальной машины Azure** | Выполняется на виртуальных машинах Azure для создания их резервных копий в хранилище.


## <a name="backup-types"></a>Типы резервных копий

**Тип резервного копирования** | **Дополнительные сведения** | **Использование**
--- | --- | ---
**Полное** | Резервная копия содержит весь источник данных. Полное резервное копирование занимает больше пропускной способности сети. | Используется для начального резервного копирования.
**Разностное** |  Хранение блоков, измененных с момента начального полного резервного копирования. Используется меньший объем сети и хранилища. Избыточные копии данных без изменений не сохраняются.<br/><br/> Неэффективно, так как передаются и сохраняются блоки данных без изменений между последующими операциями резервного копирования. | Не используется службой Azure Backup.
**Добавочное** | Высокая эффективность хранилища и сети. Хранение только блоков данных, которые изменены с момента предыдущего резервного копирования. <br/><br/> При использовании добавочного резервного копирования нет необходимости создавать полные резервные копии. | Используется для резервного копирования на диск DPM или MABS и во всех резервных копиях в Azure.

## <a name="sql-server-backup-types"></a>Типы резервного копирования SQL Server

**Тип резервного копирования** | **Дополнительные сведения** | **Использование**
--- | --- | ---
**Полная резервная копия** | При этом типе резервного копирования создается резервная копия всей базы данных. Она содержит все данные в определенной базе данных либо набор файлов или файловых групп и журналы для восстановления этих данных. | Максимально в день можно активировать одну полную резервную копию.<br/><br/> Для создания полной резервной копии можно выбрать ежедневный или еженедельный интервал.
**Разностная резервная копия** | Разностная резервная копия основывается на последней предшествующей полной резервной копии.<br/><br/> Она содержит только данные, которые были изменены с момента создания полной резервной копии. |  Максимально в день можно активировать одну разностную резервную копию.<br/><br/> Невозможно настроить создание полной и разностной резервных копий в один день.
**Резервная копия журналов транзакций** | Резервная копия журналов транзакций дает возможность восстановления на определенный момент времени с точностью до секунды. | Максимально каждые 15 минут можно настраивать резервные копии журналов транзакций.


### <a name="comparison"></a>Сравнение

Использование хранилища, целевое время восстановления (RTO) и использование ресурсов сети различаются для каждого типа резервного копирования. На приведенном ниже рисунке для сравнения показаны типы резервных копий.
- Источник данных A состоит из 10 блоков хранилища A1–A10, резервное копирование которых выполняется ежемесячно.
- Блоки A2, A3, A4 и A9 были изменены в первом месяце, а блок A5 — следующем месяце.
- Если применяется разностное резервное копирование, во втором месяце создаются резервные копии измененных блоков A2, A3, A4 и A9. В третьем месяце эти блоки архивируются повторно, как и измененный блок A5. Измененные блоки будут архивироваться, пока не будет создана следующая полная резервная копия.
- Если применяется добавочное резервное копирование, после создания полной резервной копии в первом месяце блоки A2, A3, A4 и A9 помечаются как измененные и передаются в резервную копию во втором месяце. В третьем месяце помечается и передается только измененный блок A5. 

![Рисунок, демонстрирующий сравнение методов архивации](./media/backup-architecture/backup-method-comparison.png)

## <a name="backup-features"></a>Функции службы Backup

В приведенной ниже таблице перечислены возможности для различных типов резервных копий.

**Компонент** | **Локальные компьютеры Windows (прямое)** | **Виртуальные машины Azure** | **Компьютеры и приложения с DPM или MABS**
--- | --- | --- | ---
Резервное копирование в хранилище | ![Yes][green] | ![Да][green] | ![Yes][green] 
Резервное копирование на диск DPM или MABS, а затем в Azure | | | ![Yes][green] 
Сжатие данных, отправляемых для резервного копирования | ![Yes][green] | При передаче данных сжатие не происходит. Хранилище немного увеличивается, но восстановление выполняется быстрее.  | ![Yes][green] 
Добавочное резервное копирование |![Yes][green] |![Да][green] |![Yes][green] 
Резервное копирование дедуплицированных дисков | | | ![Частично][yellow]<br/><br/> Только для серверов DPM или MABS, развернутых локально. 

![ключ таблицы](./media/backup-architecture/table-key.png)





## <a name="architecture-direct-backup-of-azure-vms"></a>Архитектура. Прямое резервное копирование виртуальных машин Azure

1. При включении резервного копирования для виртуальной машины Azure резервная копия выполняется в соответствии с указанным расписанием.
2. Расширение резервного копирования устанавливается на виртуальной машине при запросе первой резервной копии, если она запущена.
    - Для виртуальных машин Windows устанавливается расширение VMSnapshot.
    - Для виртуальных машин Linux устанавливается расширение VMSnapshot Linux.
3. Расширение создает моментальный снимок уровня хранилища. 
    - Для запущенных виртуальных машин Windows служба Backup координируется со службой VSS, чтобы сделать снимок виртуальной машины с согласованием приложений. По умолчанию служба Backup создает полные резервные копии VSS. Если не удалось сделать моментальный снимок с согласованием приложений, служба делает моментальный снимок с согласованием файлов.
    - Для резервного копирования виртуальных машин Linux служба Backup выполняет резервную копию с согласованием файлов. Для моментальных снимков с согласованием приложений необходимо вручную настроить такие сценарии.
    - Служба Backup оптимизируется за счет резервного копирования каждого диска виртуальной машины в параллельном режиме. Для каждого диска, для которого создается резервная копия, служба Azure Backup считывает блоки на диске и сохраняет только измененные данные. 
4. После создания моментального снимка данные передаются в хранилище. 
    - Копируются только блоки данных, которые были изменены с момента последнего резервного копирования.
    - Данные не шифруются. Служба Azure Backup поддерживает резервное копирование виртуальных машин Azure, зашифрованных с помощью технологии шифрования дисков Azure (ADE).
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. Это может занять несколько часов при высокой нагрузке. Общее время резервного копирования виртуальной машины составит менее 24 часов для политик ежедневного резервного копирования.
5. После передачи данных в хранилище моментальный снимок удаляется и создается точка восстановления.

Обратите внимание на то, что виртуальной машине Azure нужен доступ к Интернету для выполнения команд управления. Если вы создаете резервные копии рабочих нагрузок на виртуальной машине (например, резервное копирование SQL Server), для этих данных также нужен доступ к Интернету. 

![Резервное копирование виртуальных машин Azure](./media/backup-architecture/architecture-azure-vm.png)

## <a name="architecture-direct-backup-of-on-premises-windows-machinesazure-vm-filesfolders"></a>Архитектура. Прямое резервное копирование локальных компьютеров Windows, файлов или папок виртуальных машин Azure

1. Чтобы настроить сценарий, загрузите и установите агент Служб восстановления Microsoft Azure (MARS) на компьютер, выберите данные для резервного копирования, время выполнения резервного копирования и срок хранения этих данных в Azure.
2. Начальное резервное копирование запускается в соответствии с настройками резервного копирования.
3. Агент MARS использует службу теневого копирования томов Windows (VSS), чтобы сделать моментальный снимок томов, выбранных для резервного копирования в определенный момент времени.
    - Чтобы сделать моментальный снимок, агент MARS использует только Windows System Write.
    - Он не использует какие-либо модули записи VSS, поэтому согласование приложений при создании моментальных снимков не обеспечивается.
3. После создания моментального снимка с помощью службы VSS агент MARS создает виртуальный жесткий диск в папке кэша, указанной при настройке резервного копирования, и сохраняет контрольные суммы для каждого блока данных. 
4. Операции добавочного резервного копирования выполняются в соответствии с указанным расписанием, если только не было запущено внеочередное резервное копирование.
5. При добавочном резервном копировании идентифицируются измененные файлы и создается новый виртуальный жесткий диск, который затем сжимается, зашифровывается и отправляется в хранилище.
6. По окончании добавочного резервного копирования новый виртуальный жесткий диск объединяется с виртуальным жестким диском, созданным после начальной репликации. Таким образом предоставляется самое актуальное состояние, которое используется для сравнения при текущем резервном копировании. 

![Резервное копировоние локального сервера Windows с агентом MARS](./media/backup-architecture/architecture-on-premises-mars.png)

## <a name="architecture-back-up-to-dpmmabs"></a>Архитектура. Резервное копирование в DPM и MABS

1. Установите агент защиты DPM или MABS на компьютерах, которые нужно защитить, и добавьте эти компьютеры в группу защиты DPM.
    - Чтобы защитить локальные компьютеры, сервер DPM или MABS должен располагаться локально.
    - Для защиты виртуальных машин Azure сервер MABS должен находиться в Azure и быть запущен в качестве виртуальной машины Azure.
    - С помощью DPM или MABS можно защитить резервное копирование томов, общих папок, файлов и папки. Можно защитить состояние систем компьютеров и компьютеры без операционной системы, а также конкретные приложения с помощью параметров резервного копирования в приложении.
2. При настройке защиты для компьютера или приложения в DPM или MABS следует выбрать резервное копирование на локальный диск DPM или MABS для кратковременного хранения и в Azure (оперативная защита). Кроме того, можно указать время выполнения резервного копирования в локальное хранилище DPM или MABS и время запуска оперативного резервного копирования в Azure.
3. Диск с защищенной рабочей нагрузкой копируется на локальные диски DPM или MABS в соответствии с указанным расписанием.
4. Диски DPM или MABS копируются в хранилище агентом MARS, который выполняется на сервере DPM или MABS.

![Резервное копирование компьютеров и рабочих нагрузок, защищенных DPM или MABS](./media/backup-architecture/architecture-dpm-mabs.png)







## <a name="azure-vm-storage"></a>Хранилище виртуальной машины Azure

- Виртуальные машины Azure используют диски для хранения операционной системы, приложений и данных.
- Применяются как минимум два диска: диск для операционной системы и временный диск. Также у них могут быть диски данных для данных приложения. Диски хранятся как виртуальные жесткие диски.
- Виртуальные жесткие диски хранятся в виде страничных BLOB-объектов в учетных записях хранения ценовой категории "Стандартный" или хранилища класса Premium в Azure.
    - Служба хранилища (цен. категория "Стандартный"). Надежная и недорогая поддержка дисков для рабочих нагрузок виртуальных машин, которые нечувствительны к задержке. Служба хранилища ценовой категории "Стандартный" может использовать диски SSD или HDD ценовой категории "Стандартный".
    - Хранилище класса Premium. Поддержка высокопроизводительных дисков. Используются диски SSD ценовой категории "Премиум".
- Есть разные уровни производительности дисков:
    - Диски HDD ценовой категории "Стандартный". Копирование на жесткие диски, используются для экономичного хранилища.
    - Диски SSD ценовой категории "Стандартный". Сочетают в себе элемент дисков SSD ценовой категории "Премиум" и дисков HDD ценовой категории "Стандартный". Обеспечивают более стабильную производительность и надежность, чем диски HDD, но остаются экономичным решением.
    - Диски SSD ценовой категории "Премиум". Копирование на диски SSD обеспечивают высокую производительность и низкую задержку для виртуальных машин рабочих нагрузок с большим количеством операций ввода-вывода.
- Диски могут быть управляемыми или неуправляемыми:
    - Неуправляемые диски. Традиционные типы дисков, используемых виртуальными машинами. Вы можете создать собственную учетную запись хранения и указать ее во время создания такого диска. Вам нужно определить, как максимально эффективно использовать ресурсы хранилища для виртуальных машин.
    - Управляемые диски. Azure отвечает за создание учетных записей хранения и управление ими за вас. Нужно указать размер диска и уровень производительности, а Azure создает диски и управляет ими за вас. Azure обрабатывает хранилища по мере добавления дисков и масштабирования виртуальных машин.

Подробнее:

- Дополнительные сведения о хранилище дисков для виртуальных машин [Windows](../virtual-machines/windows/managed-disks-overview.md) и [Linux](../virtual-machines/linux/managed-disks-overview.md).
- Изучите дополнительные сведения о доступных [типах дисков](../virtual-machines/windows/disks-types.md), таких как "Стандартный" и "Премиум".


### <a name="backing-up-and-restoring-azure-vms-with-premium-storage"></a>Резервное копирование и восстановление виртуальных машин Azure с использованием хранилища класса Premium 

Резервное копирование виртуальных машин Azure можно выполнить с помощью Azure Backup в хранилище класса Premium:

- Когда служба Backup выполняет резервное копирование виртуальных машин хранилища класса Premium, она создает в учетной записи хранения расположение временного промежуточного хранения, называемое "AzureBackup-". Размер этого расположения соответствует размеру моментального снимка точки восстановления.
- Убедитесь, что в учетной записи хранения класса Premium достаточно свободного места для расположения временного промежуточного хранения. [Узнайте больше](../storage/common/storage-scalability-targets.md#premium-storage-account-scale-limits). Не следует изменять расположение временного промежуточного хранения.
- По завершении задания резервного копирования расположение промежуточного хранения удаляется.
- Плата за использование расположения промежуточного хранения взимается в соответствии с [тарифами на использование хранилища класса Premium](../virtual-machines/windows/disks-types.md#billing).

При восстановлении виртуальных машин Azure с помощью хранилища класса Premium их можно восстановить для хранилища класса Premium или Службы хранилища ценовой категории "Стандартный". Обычно происходит восстановление для класса Premium. Но также можно выполнить восстановление для Службы хранилища ценовой категории "Стандартный", если требуется только подмножество файлов из виртуальной машины. Возможно, это будет более рентабельно.

### <a name="backing-up-and-restoring-managed-disks"></a>Резервное копирование и восстановление управляемых дисков

Можно выполнять резервное копирование виртуальных машин Azure с управляемыми дисками.
- Резервное копирование виртуальных машин с управляемыми дисками выполняется так же, как и любых других виртуальных машин Azure. Резервное копирование виртуальной машины можно выполнить непосредственно в настройках виртуальной машины. Кроме того, вы можете включить резервное копирование виртуальных машин в хранилище Служб восстановления.
- Виртуальные машины, использующие управляемые диски, можно архивировать с помощью наборов точек восстановления, созданных на основе управляемых дисков.
- Служба Azure Backup также поддерживает резервное копирование использующих управляемые диски виртуальных машин, зашифрованных с помощью шифрования дисков Azure (ADE).

Виртуальную машину с управляемыми дисками можно восстановить в полную виртуальную машину с управляемыми дисками или в учетную запись хранения.
- Azure обрабатывает управляемые диски в процессе восстановления, а с помощью параметра учетной записи хранения можно управлять учетной записью хранения, которая создается во время восстановления.
- При восстановлении зашифрованной управляемой виртуальной машины нужно вывести ключи и секреты виртуальной машины из хранилища ключей перед началом восстановления.




## <a name="next-steps"></a>Дополнительная информация

- [Просмотрите](backup-support-matrix.md) таблицу поддержки, чтобы узнать дополнительные сведения о поддерживаемых возможностях и ограничениях в сценариях резервного копирования.
- Настройте резервное копирование для одного из сценариев:
    - [Резервное копирование виртуальных машин Azure](backup-azure-arm-vms-prepare.md)
    - [Прямое резервное копирование компьютеров Windows](tutorial-backup-windows-server-to-azure.md) без сервера резервного копирования.
    - [Настройка MABS](backup-azure-microsoft-azure-backup.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в MABS.
    - [Настройка DPM](backup-azure-dpm-introduction.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в DPM.


[green]: ./media/backup-architecture/green.png
[yellow]: ./media/backup-architecture/yellow.png
[red]: ./media/backup-architecture/red.png

