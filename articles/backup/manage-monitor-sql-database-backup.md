---
title: Мониторинг баз данных SQL Server, резервное копирование которых выполнено с помощью Azure Backup, и управление ими на виртуальной машине Azure | Документация Майкрософт
description: В этой статье описывается восстановление запущенных на виртуальной машине Azure баз данных SQL Server, резервное копирование которых было выполнено с помощью Azure Backup.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/19/2018
ms.author: raynew
ms.openlocfilehash: 1c2ce0ba42f0bc3efd1dcc951113b05ab6941b98
ms.sourcegitcommit: 9aa9552c4ae8635e97bdec78fccbb989b1587548
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2019
ms.locfileid: "56430958"
---
# <a name="manage-and-monitor-backed-up-sql-server-databases"></a>Мониторинг резервных копий баз данных SQL Server и управление ими 


В этой статье описаны распространенные задачи для мониторинга баз данных SQL Server, резервное копирование которых выполнено в хранилище Служб восстановления Azure Backup с помощью службы [Azure Backup](backup-overview.md), и управления ими на виртуальной машине Azure. В частности, такие задачи, как мониторинг заданий и оповещений, остановка и возобновление защиты баз данных, запуск заданий резервного копирования и отмена регистрации виртуальной машины из резервной копии.


> [!NOTE]
> Резервное копирование баз данных SQL Server, запущенных на виртуальной машине Azure, с помощью Azure Backup в настоящее время находится в общедоступной предварительной версии.


Если вы еще не настроили резервное копирование баз данных SQL Server, следуйте инструкциям, приведенным в [этой статье](backup-azure-sql-database.md).

## <a name="monitor-backup-jobs"></a>Мониторинг заданий резервного копирования

###  <a name="monitor-ad-hoc-jobs-in-the-portal"></a>Мониторинг специальных заданий на портале

В Azure Backup отображаются все задания, запускаемые вручную на портале **Задания резервного копирования**, включая обнаружение и регистрацию баз данных и операции резервного копирования и восстановления.

![Портал заданий резервного копирования](./media/backup-azure-sql-database/jobs-list.png)

> [!NOTE]
> Запланированные задания резервного копирования не отображаются на портале **Задания резервного копирования**. Используйте SQL Server Management Studio для отслеживания запланированных заданий резервного копирования, как описано в следующем разделе.
>

### <a name="monitor-backup-jobs-with-sql-server-management-studio"></a>Мониторинг заданий резервного копирования с помощью SQL Server Management Studio 

Служба Azure Backup использует встроенные API SQL для всех операций резервного копирования.

С помощью собственных интерфейсов API вы можете получить всю информацию о задании из [таблицы backupset](https://docs.microsoft.com/sql/relational-databases/system-tables/backupset-transact-sql?view=sql-server-2017) в базе данных SQL msdb.

В примере ниже показан запрос для получения всех заданий резервного копирования для базы данных с именем **DB1**. Настройте запрос для расширенного мониторинга.

```
select CAST (
Case type
                when 'D' 
                                 then 'Full'
                when  'I'
                               then 'Differential' 
                ELSE 'Log'
                END         
                AS varchar ) AS 'BackupType',
database_name, 
server_name,
machine_name,
backup_start_date,
backup_finish_date,
DATEDIFF(SECOND, backup_start_date, backup_finish_date) AS TimeTakenByBackupInSeconds,
backup_size AS BackupSizeInBytes
  from msdb.dbo.backupset where user_name = 'NT SERVICE\AzureWLBackupPluginSvc' AND database_name =  <DB1>  

```

## <a name="view-backup-alerts"></a>Просмотр оповещений о резервном копировании

Так как резервные копии журналов создаются каждые 15 минут, мониторинг заданий резервного копирования может быть утомительным. Azure Backup упрощает мониторинг с помощью оповещений по электронной почте.

- Оповещения отправляются в случае любых сбоев резервного копирования.
- Оповещения объединяются на уровне базы данных по коду ошибки.
- Оповещение по электронной почте отправляется только для первого сбоя резервного копирования базы данных. 

Чтобы отслеживать оповещения резервного копирования, выполните следующие действия.

1. Войдите в подписку Azure на [портале Azure](https://portal.azure.com) для мониторинга оповещений базы данных.

2. На панели мониторинга хранилища выберите **Предупреждения и события**.

   ![Выбор "Alerts and Events" (Оповещения и события)](./media/backup-azure-sql-database/vault-menu-alerts-events.png)

4. В области **Предупреждения и события** выберите **Оповещения, связанные с архивацией**.

   ![Выбор "Оповещения, связанные с архивацией"](./media/backup-azure-sql-database/backup-alerts-dashboard.png)

## <a name="stop-protection-for-a-sql-server-database"></a>Остановка защиты базы данных SQL Server

Вы можете остановить создание резервных копий базы данных SQL Server двумя способами:

* остановить все будущие задания резервного копирования и удалить все точки восстановления;
* остановить все будущие задания резервного копирования, но сохранить точки восстановления без изменений.

Обратите внимание на следующее.

Если вы оставите точки восстановления, они будут очищены в соответствии с политикой резервного копирования. Пока все точки восстановления не будут удалены, с вас будет взиматься плата за защищенный экземпляр и использованный объем хранилища. [Дополнительные сведения](https://azure.microsoft.com/pricing/details/backup/) о ценах.
- Если вы оставляете точки восстановления без изменений, несмотря на то что срок их действия истекает в соответствии с политикой хранения, Azure Backup всегда сохраняет одну последнюю точку восстановления, пока не будут явно удалены данные резервного копирования.
- Если вы удалите источник данных без остановки резервного копирования, новые резервные копии будут завершаться сбоем. Опять же, срок хранения старых точек восстановления истечет в соответствии с политикой, но одна из последних точек восстановления всегда будет сохраняться до остановки резервного копирования и удаления данных.
- Нельзя остановить резервное копирование для базы данных с включенной автоматической защитой, пока эта защита не будет отключена.

Чтобы остановить защиту базы данных, выполните следующие действия.

1. На панели мониторинга хранилища в разделе **Использование** выберите **Элементы архивации**.

    ![Открытие меню "Архивные элементы"](./media/backup-azure-sql-database/restore-sql-vault-dashboard.png).

2. В разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure).

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)


3. Выберите базу данных, для которой нужно остановить защиту.

    ![Выбор базы данных для остановки защиты](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)


5. В меню базы данных выберите **Остановить архивацию**.

    ![Выбор "Остановить архивацию"](./media/backup-azure-sql-database/stop-db-button.png)


6. В меню **Остановить архивацию** выберите, следует ли сохранить или удалить данные. При желании можно указать причину или комментарий.

    ![Меню "Остановить архивацию"](./media/backup-azure-sql-database/stop-backup-button.png)

7. Щелкните **Остановить архивацию**.

  

### <a name="resume-protection-for-a-sql-database"></a>возобновление защиты базы данных SQL;

Если при остановке защиты базы данных SQL был выбран параметр **Сохранить данные архивации**, защиту можно возобновить. Если данные резервных копий не были сохранены, защиту невозможно возобновить.

1. Чтобы возобновить защиту базы данных SQL, откройте элемент резервного копирования и выберите **Возобновить резервное копирование**.

    ![Выбор "Возобновить резервное копирование" для возобновления защиты базы данных](./media/backup-azure-sql-database/resume-backup-button.png)

2. В меню **Политика архивации** выберите политику и нажмите кнопку **Сохранить**.

## <a name="run-an-on-demand-backup"></a>Выполнение резервного копирования по требованию

Вы можете выполнить различные типы резервного копирования по требованию:

* Полная резервная копия
* полная резервная копия (только копирование);
* разностная резервная копия;
* Резервное копирование журналов

[Дополнительные сведения](backup-architecture.md#sql-server-backup-types) о типах резервного копирования SQL Server.

## <a name="unregister-a-sql-server-instance"></a>Отмена регистрации экземпляра SQL Server

Отмените регистрацию экземпляра SQL Server после отключения защиты, но перед удалением хранилища сделайте следующее.

1. На панели мониторинга хранилища в разделе **Управление** выберите **Инфраструктура резервного копирования**.  

   ![Выбор "Инфраструктура резервного копирования"](./media/backup-azure-sql-database/backup-infrastructure-button.png)

2. В разделе **Серверы управления** выберите **Защищенные серверы**.

   ![Выбор "Защищенные серверы"](./media/backup-azure-sql-database/protected-servers.png)


3. В меню **Защищенные серверы** выберите сервер, для которого необходимо отменить регистрацию. Чтобы удалить хранилище, необходимо отменить регистрацию всех серверов.

4. Щелкните правой кнопкой мыши защищенный сервер и выберите **Удалить**.

   ![Выбор "Удалить"](./media/backup-azure-sql-database/delete-protected-server.png)


## <a name="next-steps"></a>Дополнительная информация

[Просмотрите](backup-sql-server-azure-troubleshoot.md) информацию по устранению неполадок с резервным копированием баз данных SQL Server.
