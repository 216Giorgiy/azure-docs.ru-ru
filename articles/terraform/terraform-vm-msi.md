---
title: Использование образа Azure Marketplace для создания виртуальной машины Terraform Linux с управляемым удостоверением службы
description: Используйте образ Marketplace для создания виртуальной машины Terraform Linux с управляемым удостоверением службы и управлением удаленным состоянием, чтобы легко развернуть ресурсы в Azure.
keywords: terraform, devops, MSI, виртуальная машина, удаленное состояние, azure
author: VaijanathB
manager: rloutlaw
ms.author: tarcher
ms.date: 3/12/2018
ms.topic: article
ms.openlocfilehash: ce8a3e8b813bf4224a1fd77d60ec30f2f8e080a7
ms.sourcegitcommit: 8aab1aab0135fad24987a311b42a1c25a839e9f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2018
---
# <a name="use-an-azure-marketplace-image-to-create-a-terraform-linux-virtual-machine-with-managed-service-identity"></a>Использование образа Azure Marketplace для создания виртуальной машины Terraform Linux с управляемым удостоверением службы

В этой статье показано, как использовать [образ Terraform Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/azure-oss.terraform?tab=Overview) для создания `Ubuntu Linux VM (16.04 LTS)` с последней версией [Terraform](https://www.terraform.io/intro/index.html), установленной и настроенной с [управляемым удостоверением службы (MSI)](https://docs.microsoft.com/azure/active-directory/managed-service-identity/overview). Этот образ также настраивает удаленный сервер, чтобы включить управление [удаленным состоянием](https://www.terraform.io/docs/state/remote.html) с помощью Terraform. С помощью образа Terraform Marketplace можно быстро приступить к работе с Terraform в Azure без необходимости устанавливать Terraform и вручную настраивать аутентификацию. 

Плата за программное обеспечение для образа виртуальной машины Terraform не взимается. Вы платите только за оборудование Azure в зависимости от размера виртуальной машины, которая подготавливается. Дополнительные сведения об оплате см. на странице [Цены на виртуальные машины Linux](https://azure.microsoft.com/pricing/details/virtual-machines/linux/).

## <a name="prerequisites"></a>предварительным требованиям
Перед созданием виртуальной машины Linux Terraform необходимо убедиться в наличии подписки Azure. Если у вас ее нет, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/).  

## <a name="create-your-terraform-virtual-machine"></a>Создание виртуальной машины Terraform 

Ниже приведены шаги по созданию экземпляра виртуальной машины Linux Terraform. 

1. Перейдите к списку [Создать ресурс](https://ms.portal.azure.com/#create/hub) на портале Azure.
2. В строке поиска `Search the Marketplace` введите `Terraform`. Выберите шаблон `Terraform`. На вкладке сведений Terraform снизу справа нажмите кнопку **Создать**.
![замещающий текст](media\terraformmsi.png)
3. В следующих разделах приведены входные данные для всех шагов мастера (**номера см. справа**) по созданию виртуальной машины Terraform Linux.  Ниже приведено описание входных данных, необходимых для настройки на каждом из шагов.

## <a name="details-in-create-terraform-tab"></a>Сведения на вкладке создания Terraform

Ниже приведены сведения, которые необходимо указать на вкладке создания Terraform.

a. **Основы**
    
* **Имя** — имя виртуальной машины Terraform.
* **Имя пользователя**— идентификатор для входа первой учетной записи.
* **Пароль**— пароль первой учетной записи (вместо пароля можно использовать открытый ключ SSH).
* **Подписка**— при наличии нескольких подписок выберите ту, в которой будет создана виртуальная машина и для которой будет взиматься плата. Вам необходимо иметь права на создание ресурсов для этой подписки.
* **Группа ресурсов** — вы можете создать новую группу или использовать имеющуюся.
* **Расположение**— выберите наиболее подходящий центр обработки данных. Обычно это центр обработки данных, в котором размещена большая часть ваших данных, или ближайший к вашему физическому расположению центр для наиболее быстрого доступа к сети.

Б. **Дополнительные параметры**

* "Размер" — размер виртуальной машины.
* "Тип диска виртуальной машины" — выберите SSD или HDD.

c. **Сводка по Terraform**

* Проверьте, все ли сведения введены правильно. 

d. **Купить**

* Чтобы начать подготовку, щелкните "Купить". Отобразится ссылка на условия транзакции. За использование виртуальной машины не взимается дополнительная плата, кроме платы за размер сервера, выбранный на шаге "Размер".

Образ виртуальной машины Terraform выполняет следующие шаги:

* Создает виртуальную машину с присвоенным системой идентификатором на основе образа Ubuntu 16.04 LTS.
* Устанавливает на виртуальной машине расширение MSI, чтобы разрешить выдавать токены OAuth для ресурсов Azure.
* Назначает управляемому удостоверению разрешения RBAC, которые предоставляют права владельца группы ресурсов.
* Создает папку шаблона Terraform (tfTemplate).
* Предварительно настраивает удаленное состояние Terraform с сервером Azure.

## <a name="how-to-access-and-configure-linux-terraform-virtual-machine"></a>Получение доступа и настройка виртуальной машины Linux Terraform

После создания виртуальной машины вы можете войти в нее с помощью протокола SSH. Для входа с помощью интерфейса текстовой оболочки используйте учетную запись, созданную в разделе "Основные сведения" на шаге 3. В Windows можно скачать клиент SSH, например [Putty](http://www.putty.org/).

После подключения к виртуальной машине с помощью `SSH` необходимо предоставить управляемому удостоверению службы права участника на всю подписку. Таким образом с помощью MSI на виртуальной машине можно создавать ресурсы вне группы ресурсов этой машины, используя Terraform. Это можно сделать, выполнив скрипт один раз. Ниже приведена необходимая команда.

`. ~/tfEnv.sh`

В предыдущем скрипте для аутентификации в Azure и назначения управляемому удостоверению службы виртуальной машины прав участника на всю подписку используется механизм [интерактивного входа с помощью Azure CLI 2.0](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest#interactive-log-in). 

 В виртуальной машине создан сервер удаленного состояния Terraform. Чтобы включить его в развертывание Terraform, скопируйте файл remoteState.tf из каталога tfTemplate в корень скриптов Terraform.  

 `cp  ~/tfTemplate/remoteState.tf .`

 Дополнительные сведения об управлении удаленным состоянием см. в [этой статье](https://www.terraform.io/docs/state/remote.html). В этом файле содержится ключ доступа к хранилищу. Его необходимо записать в систему управления версиями.  

## <a name="next-steps"></a>Дальнейшие действия
В этой статье вы узнали, как настроить виртуальную машину Terraform Linux в Azure. Ниже приведены ресурсы, содержащие дополнительные сведения о Terraform в Azure. 

 [Terraform в документации по Azure](https://docs.microsoft.com/azure/terraform/)  
 [Azure Provider](http://aka.ms/terraform) (Поставщик Azure)  
 [AzureRM Terraform Provider](http://aka.ms/tfgit) (Поставщик Terraform AzureRM)  
 [Модули Terraform Azure](http://aka.ms/tfmodules)
 

















