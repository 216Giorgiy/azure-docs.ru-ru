<properties urlDisplayName="" pageTitle="" metaKeywords="" description="" metaCanonical="" services="" documentationCenter="" title="Web Single Sign-On with .NET and Azure Active Directory" authors="terrylan" solutions="" manager="terrylan" editor="" />

<tags ms.service="active-directory" ms.workload="identity" ms.tgt_pltfrm="na" ms.devlang="dotnet" ms.topic="article" ms.date="01/01/1900" ms.author="terrylan" />

# Единый вход с использованием .NET и Azure Active Directory

## <a name="introduction"></a> Введение

В этом учебнике показано, как использовать Azure Active Directory, чтобы включить единый вход для пользователей Office 365. Вы научитесь:

-   выполнять подготовку веб-приложения в клиенте заказчика;
-   защищать приложения с помощью WS-Federation.

### Предварительные требования

Для данного пошагового руководства необходимы следующие компоненты среды разработки:

-   Visual Studio 2010 с пакетом обновления 1 (SP1)
-   Microsoft .NET Framework 4.0
-   [ASP.NET MVC 3][ASP.NET MVC 3]
-   [Среда выполнения Windows Identity Foundation 1.0][Среда выполнения Windows Identity Foundation 1.0]
-   [Пакет SDK для Windows Identity Foundation 3.5][Пакет SDK для Windows Identity Foundation 3.5]
-   Службы IIS 7.5 с поддержкой SSL
-   Windows PowerShell
-   [Командлеты PowerShell для Office 365][Командлеты PowerShell для Office 365]

### Оглавление

-   [Введение][Введение]
-   [Шаг 1: Создание приложения ASP.NET MVC][Шаг 1: Создание приложения ASP.NET MVC]
-   [Шаг 2: Подготовка приложения в клиенте каталога компании][Шаг 2: Подготовка приложения в клиенте каталога компании]
-   [Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников][Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников]
-   [Сводка][Сводка]

## <a name="createapp"></a>Шаг 1: Создание приложения ASP.NET MVC

На этом шаге рассказывается, как создать простое приложение ASP.NET MVC 3, которое будет представлять защищенный ресурс. Доступ к этому ресурсу будет предоставляться через федеративную проверку подлинности под управлением службы STS компании; этот вопрос будет рассмотрен подробно далее в этом же модуле.

1.  Откройте Visual Studio как администратор.
2.  В меню **Файл** выберите **Новый проект**.
3.  В расположенном слева меню шаблонов выберите **Интернет** и нажмите **Веб-приложение ASP.NET MVC 3**. Присвойте проекту имя *OrgIdFederationSample*.
4.  В диалоговом окне **Новый проект ASP.NET MVC 3** выберите шаблон **Пустой** и нажмите кнопку **OK**.
5.  После создания нового проекта в Visual Studio щелкните правой кнопкой мыши по папке **Контроллеры** в **обозревателе решений**, выберите пункт **Добавить** и затем **Контроллер**.
6.  В диалоговом окне **Добавление контроллера** присвойте новому контроллеру имя *HomeController.cs* и нажмите кнопку **Добавить**.
7.  Будет создан и открыт файл **HomeController.cs**. В файле кода щелкните правой кнопкой мыши метод ***Index()*** и выберите **Добавить представление...**.
8.  В диалоговом окне **Добавление представления** нажмите кнопку **OK**. Создается файл **Index.cshtml** в новой папке с именем **Home**.
9.  Нажмите правой кнопкой мыши проект **OrgIdFederationSample** в **обозревателе решений** и выберите **Свойства**.
10. В окне свойств в расположенном слева меню нажмите **Интернет** и выберите **Использовать локальный веб-сервер IIS**. Если появится диалоговое окно с предложением создать виртуальный каталог для проекта, нажмите кнопку **Да**.
11. Создайте и запустите приложение. Появится страница Index вашего контроллера Home.

## <a name="provisionapp"></a>Шаг 2: Подготовка приложения в клиенте каталога компании

На этом шаге рассказывается, как администратор заказчика Azure Active Directory выполняет подготовку приложения MVC в клиенте заказчика и настраивает единый вход. После выполнения этого шага сотрудники компании могут проходить проверку подлинности в веб-приложении, используя свои учетные записи Office 365.

Процесс подготовки начинается с создания нового субъекта-службы для приложения. Azure Active Directory использует субъекты-службы для регистрации и проверки подлинности приложений в каталоге.

1.  Загрузите и установите командлеты PowerShell для Office 365, если это еще не сделано.
2.  В меню **Пуск** запустите **модуль Microsoft Online Services для консоли Windows PowerShell**. Эта консоль предоставляет среду командной строки для настройки атрибутов клиента Office 365, например для создания и изменения субъектов-служб.
3.  Чтобы импортировать необходимый модуль **MSOnlineExtended**, введите следующую команду и нажмите клавишу ВВОД:

        Import-Module MSOnlineExtended -Force

4.  Чтобы подключиться к каталогу Office 365, необходимо предоставить учетные данные администратора компании. Введите следующую команду и нажмите клавишу ВВОД, а затем введите свои учетные данные в командной строке:

        Connect-MsolService

5.  Теперь необходимо создать новый субъект-службу для приложения. Введите следующую команду и нажмите клавишу ВВОД:

        New-MsolServicePrincipal -ServicePrincipalNames @("OrgIdFederationSample/localhost") -DisplayName "Federation Sample Website" -Type Symmetric -Usage Verify -StartDate "12/01/2012" -EndDate "12/01/2013" 

    На этом шаге выводится информация следующего вида:

        The following symmetric key was created as one was not supplied qY+Drf20Zz+A4t2w e3PebCopoCugO76My+JMVsqNBFc=
        DisplayName           : Federation Sample Website
        ServicePrincipalNames : {OrgIdFederationSample/localhost}
        ObjectId              : 59cab09a-3f5d-4e86-999c-2e69f682d90d
        AppPrincipalId        : 7829c758-2bef-43df-a685-717089474505
        TrustedForDelegation  : False
        AccountEnabled        : True
        KeyType               : Symmetric
        KeyId                 : f1735cbe-aa46-421b-8a1c-03b8f9bb3565
        StartDate             : 12/01/2012 08:00:00 a.m.
        EndDate               : 12/01/2013 08:00:00 a.m.
        Usage                 : Verify 

    <div class="dev-callout">

    **Примечание.**
    Следует сохранить эти выходные данные, особенно сгенерированный симметричный ключ. Этот ключ отображается только во время создания субъекта-службы, в дальнейшем вы его получить не сможете. Другие значения необходимы, чтобы с помощью Graph API считывать данные из каталога и записывать данные в каталог.

    </div>

6.  На последнем шаге задается URL-адрес ответа для приложения. На URL-адрес ответа отправляются ответы после попыток проверки подлинности. Введите следующие команды и нажмите клавишу ВВОД:

        $replyUrl = New-MsolServicePrincipalAddresses -Address "https://localhost/OrgIdFederationSample" 

        Set-MsolServicePrincipal -AppPrincipalId "7829c758-2bef-43df-a685-717089474505" -Addresses $replyUrl 

Теперь веб-приложение в каталоге подготовлено, и сотрудники компании могут его использовать для единого входа.

## <a name="protectapp"></a>Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников

На этом шаге показано, как добавить поддержку федеративного входа с помощью Windows Identity Foundation (WIF). Вы также научитесь добавлять страницу входа и настраивать отношения доверия между приложением и клиентом каталога.

1.  В Visual Studio нажмите правой кнопкой мыши проект **OrgIdFederationSample** и выберите **Добавить ссылку STS...**. Этот пункт контекстного меню был добавлен после установки пакета SDK для WIF.
2.  В диалоговом окне **Программа федерации** в разделе **URI приложения** необходимо указать URI в следующем формате:

        spn:<Your AppPrincipalId>@<Your Directory Domain>

    **spn** указывает, что URI является именем субъекта-службы, **Your AppPrincpalId** — значение GUID **AppPrincipalId**, сгенерированное при создании субъекта-службы, а **Your Directory Domain** — домен \*.onmicrosoft.com для клиента каталога. Для этого примера приложения полное значение URI приложения указывается следующим образом:

        spn:7829c758-2bef-43df-a685-717089474505@awesomecomputers.onmicrosoft.com

    После ввода URI приложения нажмите кнопку **Далее**.

3.  Откроется диалоговое окно со следующим предупреждением: "Приложение не размещено на безопасном https-соединении". Это происходит из-за того, что программа федерации не распознает формат **spn:** , однако приложение все равно будет использовать безопасное https-соединение. Чтобы продолжить, щелкните **Да**.

4.  На следующей странице служебной программы федерации выберите **Использовать существующую STS**, затем в разделе **Расположение документа метаданных STS WS-Federation** введите URL-адрес документа метаданных WS-Federation. Этот URL-адрес указывается в следующем формате:

        https://accounts.accesscontrol.windows.net/<Domain Name or Tenant ID>/FederationMetadata/2007-06/FederationMetadata.xml 

    Для данного приложения расположение метаданных WS-Federation указывается следующим образом:

        https://accounts.accesscontrol.windows.net/fabrikam.onmicrosoft.com/FederationMetadata/2007-06/FederationMetadata.xml 

    После ввода расположения метаданных нажмите кнопку **Далее**.

5.  На следующей странице служебной программы федерации выберите **Отключить проверку цепочки сертификатов** и нажмите кнопку **Далее**.

6.  На следующей странице служебной программы федерации выберите **Без шифрования** и нажмите кнопку **Далее**.

7.  На следующей странице служебной программы федерации отображаются утверждения, предоставляемые службой STS. Просмотрите утверждения, затем нажмите кнопку **Далее**.

8.  Теперь выполните настройку служб IIS для поддержки SSL в среде разработки. Чтобы открыть диспетчер служб IIS, можно ввести команду *inetmgr* в командной строке **Выполнить**.

9.  В диспетчере IIS в расположенном слева меню разверните папку **Сайты**, затем нажмите **Главная страница веб-сайта по умолчанию**. В расположенном справа меню **Действия** щелкните **Привязки...**.

10. В диалоговом окне **Привязки сайта** нажмите кнопку **Добавить**. В диалоговом окне **Добавление привязки сайта** выберите в раскрывающемся списке **Тип** вариант ***https***, затем в разделе **SSL-сертификат** выберите **Сертификат разработки IIS Express**. Нажмите кнопку **ОК**.

11. В диспетчере IIS в расположенном слева меню нажмите **Пулы приложений**, затем выберите в списке запись **ASP.NET v4.0** и нажмите **Расширенные настройки** в расположенном справа меню **Действия**.

12. В диалоговом окне **Расширенные настройки** задайте для свойства **Загрузить профиль пользователя** значение **true**. Нажмите кнопку **ОК**.

13. В Visual Studio откройте файл **Web.config** из **обозревателя решений** в корневой папке проекта.

14. В файле **Web.config** найдите раздел **wsFederation** и добавьте атрибут **reply** с тем же значением, что и у переменной **$replyUrl**, заданной при создании субъекта-службы. Например:

        <wsFederation passiveRedirectEnabled="true" issuer="https://accounts.accesscontrol.windows.net/v2/wsfederation" realm="spn: 7829c758-2bef-43df-a685-717089474505" requireHttps="false" reply="https://localhost/OrgIdFederationSample" /> 

15. Добавьте узел **httpRuntime** в разделе **system.web** и задайте для атрибута **requestValidationMode** значение **2.0**. Например:

        <system.web>
            <httpRuntime requestValidationMode="2.0" /> 
            ...

    Сохраните файл **Web.config**.

16. Теперь, когда для веб-приложения включена проверка подлинности, необходимо изменить страницу **Index**, указав утверждения пользователя, прошедшего проверку подлинности. Откройте файл **Index.cshtml**, расположенный во вложенной папке **Home** папки **Представления**.

17. Добавьте в файл **Index.cshtml** следующий фрагмент кода и сохраните его:

        <p>
            @if (User.Identity.IsAuthenticated)
            {
            <ul>
                @foreach (string claim in ((Microsoft.IdentityModel.Claims.IClaimsIdentity)this.User.Identity).Claims.Select(c => c.ClaimType + " : " + c.Value))
                {
                    <li>@claim</li>
                }
            </ul>
            }
        </p> 

18. После сохранения изменений в файле **Index.cshtml** нажмите клавишу **F5** для запуска приложения. Вы будете перенаправлены на страницу поставщика удостоверений Office 365, на которой можете выполнить вход, используя ваши учетные данные клиента каталога. Например, [\*иван.иванов@отличныекомпьютеры.наmicrosoft.com\*][\*иван.иванов@отличныекомпьютеры.наmicrosoft.com\*].

19. После входа с использованием учетных данных вы будете перенаправлены на страницу Index контроллера Home с данными учетной записи. Это демонстрация успешного прохождения проверки подлинности в приложении с использованием возможностей единого входа, предоставляемых службой Azure Active Directory.

## <a name="summary"></a>Сводка

В этом учебнике показано, как создать и настроить приложение для одного клиента, использующее возможности единого входа Azure Active Directory. Также можно создавать приложения для Azure Active Directory, поддерживающие нескольких клиентов, как описано в учебнике [Разработка многопользовательских облачных приложений с помощью Azure Active Directory][Разработка многопользовательских облачных приложений с помощью Azure Active Directory].

  [ASP.NET MVC 3]: http://www.microsoft.com/ru-ru/download/details.aspx?id=4211
  [Среда выполнения Windows Identity Foundation 1.0]: http://www.microsoft.com/ru-ru/download/details.aspx?id=17331
  [Пакет SDK для Windows Identity Foundation 3.5]: http://www.microsoft.com/ru-ru/download/details.aspx?id=4451
  [Командлеты PowerShell для Office 365]: http://onlinehelp.microsoft.com/ru-ru/office365-enterprises/ff652560.aspx
  [Введение]: #introduction
  [Шаг 1: Создание приложения ASP.NET MVC]: #createapp
  [Шаг 2: Подготовка приложения в клиенте каталога компании]: #provisionapp
  [Шаг 3: Защита приложения с использованием WS-Federation для входа сотрудников]: #protectapp
  [Сводка]: #summary
  [\*иван.иванов@отличныекомпьютеры.наmicrosoft.com\*]: mailto:*john.doe@awesomecomputers.onmicrosoft.com*
  [Разработка многопользовательских облачных приложений с помощью Azure Active Directory]: http://g.microsoftonline.com/0AX00en/121
