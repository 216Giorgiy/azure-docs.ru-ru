---
title: 'Azure AD Connect выполняет следующие функции: Переход с федеративной аутентификации на синхронизацию хэша паролей для Azure AD | Документация Майкрософт'
description: Сведения о переводе среды гибридных удостоверений с федеративной аутентификации на синхронизацию хэша паролей.
services: active-directory
author: billmath
manager: mtillman
ms.reviewer: martincoetzer
ms.service: active-directory
ms.workload: identity
ms.topic: article
ms.date: 12/13/2018
ms.component: hybrid
ms.author: billmath
ms.openlocfilehash: a14e630c23af3e0228bf4806851f29cfab199215
ms.sourcegitcommit: 30d23a9d270e10bb87b6bfc13e789b9de300dc6b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2019
ms.locfileid: "54103984"
---
# <a name="migrate-from-federation-to-password-hash-synchronization-for-azure-ad"></a>Переход с федеративной аутентификации на синхронизацию хэша паролей для Azure AD
В следующем документе приведены инструкции по переходу с AD FS на синхронизацию хэша паролей.

>[!NOTE]
>Скачать копию этого документа можно [отсюда](https://aka.ms/ADFSTOPHSDPDownload).


## <a name="prerequisites-for-the-migration"></a>Предварительные требования для миграции 
Ниже перечислены требования, которые необходимо выполнить перед миграцией.
### <a name="update-azure-ad-connect"></a>Обновление Azure AD Connect

Как минимум для успешного перехода на сквозную аутентификацию требуется [Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594) 1.1.819.0. Эта версия содержит значительные изменения в способе преобразования процессов входа, что может сократить общее время перехода с федеративной на облачную аутентификацию с часов до минут.

> [!IMPORTANT]
> В устаревшей документации, инструментах и блогах указывается, что преобразование пользователей — это обязательный шаг при преобразовании федеративных доменов в управляемые. Обратите внимание на то, что преобразование пользователей больше не требуется, и корпорация Майкрософт работает над обновлением соответствующей документации и инструментов, чтобы отразить это изменение.

Чтобы обновить Azure AD Connect до последней версии, следуйте этим [инструкциям по обновлению](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version).

### <a name="password-hash-synchronization-required-permissions"></a>Необходимые разрешения для синхронизации хэша паролей

Azure AD Connect можно настроить с помощью стандартных параметров или выборочной установки. Если вы использовали выборочную установку, то [необходимые разрешения](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-accounts-permissions) для синхронизации хэша паролей могут отсутствовать.

Учетной записи службы AD DS в Azure AD Connect требуются приведенные ниже разрешения, чтобы использовать синхронизацию хэша паролей.

* Репликация изменений каталога

* Репликация всех изменений каталога

Самое время проверить наличие этих разрешений для всех доменов в лесу.

### <a name="plan-migration-method"></a>Планирование метода миграции

Существуют два способа перехода с федеративной аутентификации на синхронизацию хэша паролей и простой единый вход. Применяемый метод зависит от того, как ваши службы федерации Active Directory были настроены изначально. 



- **Вариант А. Использование Azure AD Connect**. Если службы AD FS были изначально настроены с помощью Azure AD Connect, то переход на синхронизацию хэша паролей в качестве метода входа пользователей должен быть выполнен с помощью мастера Azure AD Connect.   
Если используется Azure AD Connect, то при изменении метода входа пользователей автоматически выполняется командлет Set-MsolDomainAuthentication, и, так как вы не можете им управлять, этот командлет отменяет федерацию всех проверенных федеративных доменов в вашем клиенте Azure AD.

> [!NOTE]
> В настоящее время невозможно избежать отмены федерации всех доменов в клиенте при переходе на синхронизацию хэша паролей, если изначально для настройки AD FS вы использовали AAD Connect.  



- **Вариант Б. Использование Azure AD Connect и PowerShell**. Этот метод может использоваться только в том случае, если службы AD FS не были изначально настроены с помощью Azure AD Connect. Вам все равно потребуется изменить метод входа пользователей с помощью мастера Azure AD Connect. Однако основное различие состоит в том, что он не запустит командлет Set-MsolDomainAuthentication автоматически, так как ему не известно о вашей ферме AD FS, и поэтому вы можете самостоятельно решить, какие домены будут преобразованы и в каком порядке.

Чтобы понять, какой метод следует использовать, выполните действия в следующем разделе.

#### <a name="verify-current-user-sign-in-settings"></a>Проверка текущих параметров входа пользователей

Проверьте текущие параметры входа пользователей, войдя на портал Azure AD [https://aad.portal.azure.com](https://aad.portal.azure.com/) с учетной записью глобального администратора.

В разделе User Sign In (Вход пользователей) убедитесь, что параметр Федерация включен, а параметры Простой единый вход и  Сквозная проверка подлинности отключены. Кроме того, проверьте состояние синхронизации паролей. Она должна быть отключена, если только вы не включили ее ранее.

![Рисунок 5](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image1.png)

#### <a name="verify-azure-ad-connect-configuration"></a>Проверка конфигурации Azure AD Connect

   1. Перейдите на сервер Azure AD Connect и запустите Azure AD Connect, а затем выберите "Настройка". 
   2. На экране "Дополнительные задачи" выберите "Просмотр текущей конфигурации", а затем выберите "Далее".</br>
   ![Рисунок 31](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image2.png)</br>
   
   3. На экране "Ознакомьтесь с решением" запишите состояние синхронизации паролей.</br> 

   Если синхронизация хэша паролей в настоящее время отключена, необходимо будет выполните действия, описанные в этом руководстве, чтобы включить ее. Если синхронизация хэша паролей включена, то можно пропустить раздел [Шаг 1. Включение синхронизации хэша паролей](#step-1--enable-password-hash-synchronization) данного руководства.
   4. Прокрутите экран "Ознакомьтесь с решением" вниз до раздела "Службы федерации Active Directory (AD FS)".</br>
 
   Если вы видите, что конфигурация AD FS указана в этом разделе, то можно с уверенностью предположить, что службы AD FS были изначально настроены с помощью Azure AD Connect. Поэтому преобразовать ваши федеративные домены в управляемые можно с помощью параметра "Смена имени пользователя для входа" в Azure AD Connect. Этот процесс подробно описан в разделе **Вариант А. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect**.
   5. Если вы не видите службы федерации Active Directory в текущих параметрах, то необходимо будет вручную преобразовать федеративные домены в управляемые с помощью PowerShell. Этот процесс подробно описан в разделе **Вариант Б. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell**.

### <a name="document-current-federation-settings"></a>Документирование текущих параметров федерации

Текущее значение параметра федерации можно получить с помощью командлета Get-MsolDomainFederationSettings.

Для этого используется следующая команда.

``` PowerShell
Get-MsolDomainFederationSettings -DomainName YourDomain.extention | fl *
```

Например: 

``` PowerShell
Get-MsolDomainFederationSettings -DomainName Contoso.com | fl *
```
Проверьте все параметры, которые могли быть настроены в соответствии с документацией по проектированию и развертыванию федерации, в частности PreferredAuthenticationProtocol, SupportsMfa и PromptLoginBehavior.

Дополнительные сведения о назначении этих параметров можно найти далее в этой статье.

[Поддержка параметра prompt=login в службах федерации Active Directory (AD FS)](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-prompt-login)  
‎[Set-MsolDomainAuthentication](https://docs.microsoft.com/powershell/module/msonline/set-msoldomainauthentication?view=azureadps-1.0)

> [!NOTE]
> Если параметр SupportsMfa в настоящее время имеет значение True, это означает, что в качестве второго фактора в потоке аутентификации используется локальное решение MFA. Это уже не подойдет для сценариев с аутентификацией Azure AD. Вместо этого необходимо будет использовать службу Azure MFA (на основе облака) для выполнения той же функции. Внимательно проанализируйте требования MFA, прежде чем действовать дальше. Убедитесь, что вы понимаете принципы работы Azure MFA, особенности лицензирования и процесс регистрации пользователей, прежде чем преобразовывать домены. Наше руководство по развертыванию для Azure MFA, которое содержит более подробные сведения, можно найти здесь: [https://aka.ms/deploymentplans](https://aka.ms/deploymentplans).

#### <a name="backup-federation-settings"></a>Резервное копирование параметров федерации

Хотя в ходе данного процесса другие проверяющие стороны на ферме AD FS не подвергаются изменениям, рекомендуется создать актуальную резервную копию фермы AD FS, которая обеспечивает возможность восстановления. Это можно сделать с помощью бесплатного инструмента [AD FS Rapid Restore Tool](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-rapid-restore-tool) от корпорации Майкрософт. С его помощью можно выполнять резервное копирование и восстановление AD FS в существующую или новую ферму.

Если вы решили не использовать AD FS Rapid Restore Tool, то как минимум следует экспортировать отношения доверия проверяющей стороны "Платформа удостоверений Microsoft Office 365" и все связанные с ними настраиваемые правила утверждений, которые вы могли добавить. Для этого можно выполнить следующий пример PowerShell.

``` PowerShell
(Get-AdfsRelyingPartyTrust -Name "Microsoft Office 365 Identity Platform") | Export-CliXML "C:\temp\O365-RelyingPartyTrust.xml"
```

## <a name="deployment-considerations-and-ad-fs-usage"></a>Рекомендации по развертыванию и использовании AD FS

### <a name="validate-your-current-ad-fs-usage"></a>Проверка текущего использования AD FS

Перед преобразованием федеративных доменов в управляемые следует внимательно изучить текущее использование служб AD FS для Azure AD, Office 365 и других приложений (отношения доверия проверяющих сторон). В частности, рекомендуется рассмотреть следующую таблицу.

| Если| То |
|-|-|
| Вы собираетесь сохранить AD FS для других приложений.| Вы будете использовать AD FS и Azure AD, и в результате необходимо будет учесть взаимодействие с пользователем. В некоторых случаях пользователям может потребоваться дважды пройти аутентификацию: один раз — для входа в Azure AD (после чего они смогут использовать единый вход в другие приложения, такие как Office 365), а второй раз — для входа в какое-либо приложение, которое по-прежнему привязано к AD FS в рамках отношения доверия проверяющей стороны. |
| Служба AD FS в значительной степени настраиваемая и зависит от конкретных настроек в файле onload.js, который не может дублироваться в Azure AD (например, вы могли изменить параметры входа в систему, чтобы пользователи могли ввести имя пользователя только в формате SamAccountName, а не в формате имени участника-пользователя; или вы могли значительно изменить фирменную символику на странице входа).| Необходимо будет проверить соблюдение требований текущей конфигурации в Azure AD, прежде чем продолжить. Обратитесь к разделам о фирменной символике AD FS и настройке параметров AD FS, чтобы получить дополнительные сведения и рекомендации.|
| Вы блокируете устаревшие клиенты аутентификации, используя AD FS.| Рассмотрите возможность замены элементов управления блокировки клиентов аутентификации, в настоящее время используемых в AD FS, с помощью сочетания [элементов управления условным доступом для устаревших методов аутентификации](https://docs.microsoft.com/azure/active-directory/conditional-access/conditions) и [правил клиентского доступа Exchange Online](https://aka.ms/EXOCAR).|
| Пользователям необходимо проходить Многофакторную идентификацию на локальном сервере MFA при аутентификации в AD FS.| У вас не будет возможности внедрить запрос MFA, выполняемый через локальное решение MFA, в поток аутентификации для управляемого домена, однако вы сможете использовать для этого службу Azure MFA после преобразования домена. Если в настоящее время пользователи не используют Azure MFA, им потребуется выполнить одноразовую регистрацию. Этот дополнительный шаг нужно будет подготовить, после чего сообщить о нем пользователям.|
| Вы применяете политики управления доступом (правила AuthZ) в AD FS для управления доступом к Office 365.| Рассмотрите возможность их замены эквивалентными [политиками условного доступа](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-azure-portal) в Azure AD и [правилами клиентского доступа Exchange Online](https://aka.ms/EXOCAR).|

### <a name="considerations-for-common-ad-fs-customizations"></a>Рекомендации для распространенных пользовательских настроек AD FS

#### <a name="inside-corporate-network-claim"></a>Утверждение InsideCorporateNetwork

Службы AD FS выдают утверждение InsideCorporateNetwork при аутентификации пользователя, размещенного в корпоративной сети. Это утверждение может быть передано в Azure AD для обхода Многофакторной идентификации на основе расположения в сети для пользователя. В разделе [Для федеративных пользователей](https://docs.microsoft.com/azure/multi-factor-authentication/multi-factor-authentication-get-started-adfs-cloud) можно узнать, как определить, включена ли сейчас эта функция в AD FS.

Утверждение InsideCorporateNetwork не будет доступно после преобразования доменов для использования синхронизации хэша паролей. [Именованные расположения в Azure AD](https://docs.microsoft.com/azure/active-directory/active-directory-named-locations) позволяют заменить эту функцию.

После настройки именованных расположений все политики условного доступа будут настроены для включения или исключения сетевых расположений. Необходимо будет обновить параметры "Все надежные расположения" или "Надежные IP-адреса MFA" с учетом только что созданных именованных расположений.

Дополнительные сведения об условии расположения в политике условного доступа см. в статье [Каковы условия расположения в условном доступе Azure Active Directory?](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-locations)

#### <a name="hybrid-azure-ad-joined-devices"></a>Устройства, использующие гибридное присоединение к Azure AD

Присоединение устройства к Azure AD позволяет создавать правила условного доступа, которые задают для устройств стандарты доступа, обеспечивающие безопасность и соответствие. Это позволяет пользователям выполнять вход на устройство с помощью рабочей или учебной учетной записи организации вместо личной учетной записи. Использование гибридного присоединения к Azure AD позволяет присоединять к Azure AD устройства, которые присоединены к домену AD. Эта функция может быть настроена в вашей федеративной среде.

Чтобы гибридное присоединение использовалось для всех новых устройств, присоединяемых к домену после того, как вы преобразуете домены для использования синхронизации хэша паролей, необходимо настроить Azure AD Connect для синхронизации учетных записей компьютеров Active Directory для клиентов Windows 10 с Azure AD. Для учетных записей компьютеров Windows 7 и Windows 8 гибридное присоединение будет использовать простой единый вход для регистрации компьютера в Azure AD. Вам не потребуется синхронизировать их, как в случае устройств Windows 10. Тем не менее необходимо будет развернуть обновленный файл workplacejoin.exe (с помощью MSI-файла) для этих клиентов нижнего уровня, чтобы они могли зарегистрироваться с помощью простого единого входа. [Скачайте этот MSI-файл](https://www.microsoft.com/download/details.aspx?id=53554). 

Дополнительные сведения см. в статье [Настройка гибридных устройств, присоединенных к Azure Active Directory](https://docs.microsoft.com/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup).

#### <a name="branding"></a>Фирменная символика

Ваша организация может использовать [настроенные страницы входа служб федерации Active Directory](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-user-sign-in-customization) для отображения сведений, присущих вашей организации. Если это так, постарайтесь аналогичным образом [настроить страницы входа Azure AD](https://docs.microsoft.com/azure/active-directory/customize-branding).

Хотя доступны аналогичные настройки, следует ожидать некоторых изменений в оформлении. Вы можете сообщить об ожидаемых изменениях пользователям.

> [!NOTE]
> Фирменная символика компании доступна только после приобретения лицензий Premium или Basic для службы Azure AD, а также обладателям лицензий Office 365.

## <a name="planning-deployment-and-support"></a>Планирование развертывания и поддержки

### <a name="plan-the-maintenance-window"></a>Планирование периода обслуживания

Хотя сам процесс преобразования доменов относительно быстрый, Azure AD может отправлять запросы на аутентификацию на серверы AD FS еще в течение 4 часов после завершения преобразования. В течение этих четырех часов ввиду различных данных в кэше на стороне служб эти запросы на аутентификацию могут не приниматься службой Azure AD, и пользователи будут получать сообщение об ошибке. При этом они по-прежнему смогут успешно проходить аутентификацию в AD FS, но Azure AD больше не будет принимать выданный пользователем маркер, так как отношения доверия федерации уже удалены.

> [!NOTE]
> Это затронет только пользователей, обращающихся к службам через браузер в течение этого периода после преобразования, пока не будет очищен кэш на стороне службы. Устаревшие клиенты (Exchange ActiveSync, Outlook 2010, Outlook 2013) не должны быть затронуты, так как Exchange Online сохраняет кэш учетных данных в течение определенного периода времени, что позволяет автоматически повторить аутентификацию пользователя без необходимости возвращения в AD FS. Учетные данные, хранящиеся на устройстве для этих клиентов, позволяют повторно пройти аутентификацию автоматически после очистки кэша, поэтому пользователи не должны получать какие-либо запросы на ввод пароля после преобразования доменов. И наоборот, в современных клиентах аутентификации (Office 2013, Office 2016, приложения IOS и Android) используется действительный маркер обновления для получения новых маркеров доступа, обеспечивающих непрерывный доступ к ресурсам без перехода к службам AD FS. Поэтому им не грозит появление запросов на ввод пароля после преобразования доменов, и они будут продолжать работать без каких-либо дополнительных настроек.

> [!IMPORTANT]
> Не завершайте работу среды AD FS и не удаляйте отношение доверия проверяющей стороны Office 365, пока не удостоверитесь, что все пользователи успешно проходят аутентификацию в облаке.

### <a name="plan-for-rollback"></a>План отката

Если обнаружена серьезная проблема, которая не может быть быстро устранена, можно выполнить откат решения к федерации. Очень важно спланировать действия на случай, если развертывание не выполняется по плану. Если во время развертывания произошел сбой преобразования доменов или пользователей либо возникла необходимость выполнить откат к федерации, необходимо понять, как сократить простой и уменьшить неудобства для пользователей.

#### <a name="rolling-back"></a>Выполнение отката

Обратитесь к документации по проектированию и развертыванию федерации, чтобы получить сведения о своем развертывании. Процесс должен включать в себя следующие этапы.

* Преобразование управляемых доменов в федеративные с помощью командлета Convert-MSOLDomainToFederated. 

* При необходимости — настройка дополнительных правил утверждений.

### <a name="plan-change-communications"></a>Планирование информирования об изменениях

Важной частью планирования развертывания и поддержки является своевременное информирование пользователей об изменениях, возможных ситуациях и необходимых действиях. 

После развертывания синхронизации хэша паролей и простого единого входа изменится процедура входа пользователя при доступе к Office 365 и другим связанным ресурсам, использующим аутентификацию в Azure AD. Теперь внешние по отношению к сети пользователи будут видеть только страницу входа Azure AD, а не будут перенаправляться на страницу на основе форм, предоставляемую интерфейсными прокси-серверами веб-приложения.

При планировании стратегии информирования следует учесть несколько элементов. в частности такие:

* Уведомление пользователей о планируемых и выпущенных функциональных возможностях с помощью:
  * электронной почты и других внутренних каналов связи;
  * наглядных пособий, например афиш;
  * видеосообщения руководителя или других средств информирования.
* Определение лиц, ответственных за настройку и отправку сообщений, а также расписания отправки сообщений.

## <a name="implementing-your-solution"></a>Внедрение решения

Теперь, когда вы запланировали внедрение решения, можно приступить к его реализации. Реализация включает в себя следующие этапы.

1. Включение синхронизации хэшей паролей

2. Подготовка к внедрению простого единого входа.

3. Изменение метода входа на синхронизацию хэша паролей и включение простого единого входа

### <a name="step-1--enable-password-hash-synchronization"></a>Шаг 1. Включение синхронизации хэша паролей

Первым шагом для реализации этого решения является включение синхронизации хэша паролей в мастере Azure AD Connect. Синхронизация хэша паролей — это дополнительная функция, которую можно включить для сред, использующих федерацию, не изменяя поток процесс проверки подлинности. В этом случае Azure AD Connect начнет синхронизацию хэша паролей без нарушения процедуры входа пользователей, использующих федерацию.

По этой причине рекомендуется выполнять этот подготовительный шаг задолго до изменения способа входа в домены. Это даст вам достаточно времени для проверки работы синхронизации хэша паролей.

Чтобы включить синхронизацию хэша паролей, сделайте следующее.

   1. На сервере Azure AD Connect откройте мастер и выберите "Настройка".
   2. Выберите "Настроить параметры синхронизации" и щелкните "Далее".
   3. На экране "Подключение к Azure" введите имя пользователя и пароль глобального администратора.
   4. На экране "Подключить каталоги" щелкните "Далее".
   5. На экране "Фильтрация доменов и подразделений" щелкните "Далее".
   6. На экране "Дополнительные возможности" выберите "Синхронизация паролей" и щелкните "Далее".
   ![Рисунок 21](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image6.png)</br>
   7. Щелкните "Далее" на всех остальных экранах. На последнем экране щелкните "Настроить".
   8. Azure AD Connect начнет синхронизацию хэша паролей во время следующей синхронизации.

После включения синхронизации хэша паролей будет выполнено повторное вычисление и запись в Azure AD хэша паролей всех пользователей, для которых настроена синхронизация Azure AD Connect. В зависимости от количества пользователей эта операция может занять от пары минут до нескольких часов.

В целях планирования следует учесть, что для обработки порядка 20 000 пользователей потребуется 1 час.

Чтобы проверить, правильно ли работает синхронизация хэша паролей, используйте задачу устранения неполадок в мастере Azure AD Connect.

   1. Откройте новый сеанс Windows PowerShell на сервере Azure AD Connect и запустите его от имени администратора.
   2. Выполните командлет Set-ExecutionPolicy RemoteSigned или Set-ExecutionPolicy Unrestricted.
   3. Откройте мастер Azure AD Connect.
   4. Перейдите к странице "Дополнительные задачи", выберите "Устранение неполадок" и щелкните "Далее".
   5. На странице "Устранение неполадок" щелкните "Запуск", чтобы открыть меню устранения неполадок в PowerShell.
   6. В главном меню выберите "Устранение неполадок при синхронизации хэшей паролей".
   7. В подменю выберите "Password hash synchronization does not work at all" (Синхронизация хэша паролей не выполняется).

Если вы обнаружили проблемы, используйте информацию [в этой статье](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-troubleshoot-password-hash-synchronization) для их устранения.

### <a name="step-2--prepare-for-seamless-sso"></a>Шаг 2. Подготовка к внедрению простого единого входа

Чтобы устройства использовали простой единый вход, необходимо добавить URL-адрес Azure AD в параметры зоны интрасети пользователей с помощью групповой политики Active Directory.

По умолчанию браузер автоматически вычисляет соответствующую зону (Интернета или интрасети) по конкретному URL-адресу. Например, http://contoso/ сопоставляется с зоной интрасети, а http://intranet.contoso.com/ — с зоной Интернета (так как этот URL-адрес содержит точку). Браузеры не будут отправлять билеты Kerberos в облачную конечную точку (как URL-адрес Azure AD), если только ее URL-адрес не добавлен явным образом в зону интрасети в браузере.

Выполните [соответствующие действия, чтобы развернуть](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-sso-quick-start) необходимые изменения на устройствах.

> [!IMPORTANT]
> Эти изменения не повлияют на способ входа пользователей в Azure AD. Тем не менее очень важно, чтобы эта конфигурация была применена ко всем устройствам перед переходом к шагу 3. Обратите внимание, что при входе пользователям устройств, не получивших эту конфигурацию, просто нужно будет ввести имя пользователя и пароль для входа в Azure AD.

### <a name="step-3--change-sign-in-method-to-phs-and-enable-seamless-sso"></a>Шаг 3. Изменение метода входа на синхронизацию хэша паролей и включение простого единого входа

#### <a name="option-a---switch-from-federation-to-phs-by-using-azure-ad-connect"></a>Вариант А. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect

Используйте этот метод, только если среда AD FS была изначально настроена с помощью Azure AD Connect. В противном случае этот метод вам не подходит. Сначала **измените метод входа пользователей**.

   1. На сервере Azure AD Connect откройте мастер.
   2. Выберите "Change User Sign in" (Изменить метод входа пользователей), а затем выберите "Далее".
   ![Рисунок 27](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image7.png)</br>
   3. На экране **Подключение к Azure** введите имя пользователя и пароль **глобального администратора**.
   4. На экране **Вход пользователей** переведите переключатель из положения "Федерация с AD FS" в положение "Синхронизация хэша паролей". Обязательно установите флажок "Не преобразовывать учетные записи пользователей", так как этот шаг является устаревшим и будет удален в будущей версии AAD Connect. Выберите "Включить единый вход" и щелкните **Далее**.
   ![Рисунок 29](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image8.png)</br>
   
   > [!NOTE]
   > Начиная с Azure AD Connect версии 1.1.880.0 флажок "Эффективный единый вход" установлен по умолчанию.
   
   > [!IMPORTANT]
   > Можно спокойно игнорировать предупреждения о том, что преобразование пользователей и полная синхронизация хэша паролей обязательны для перехода с федеративной аутентификации на облачную. Обратите внимание на то, что эти действия больше не являются обязательными. В будущих версиях Azure AD Connect не будет параметра для преобразования пользователей. Если вы по-прежнему видите эти предупреждения, убедитесь, что выполняется последняя версия Azure AD Connect и вы следуете последней версии данного руководства. Дополнительные сведения см. в разделе [Обновление Azure AD Connect](#_Update_Azure_AD).
   
   5. На экране "Включить единый вход" введите учетные данные администратора домена и щелкните "Далее".
   ![Рисунок 35](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image9.png)</br>
   
   > [!NOTE]
   > Эти учетные данные нужны для включения простого единого входа, так как для этого необходимо выполнить приведенные ниже действия, требующие повышенных привилегий. Учетные данные администратора домена не хранятся в Azure AD Connect или в Azure AD. Они используются только для того, чтобы включить эту функцию, и отменяются после ее успешного включения.
   >  * В локальной службе Active Directory (AD) создается учетная запись компьютера с именем AZUREADSSOACC (представляет Azure AD).
   >  * С помощью Azure AD безопасным образом предоставляется ключ расшифровки Kerberos учетной записи компьютера.
   >  * Кроме того, создаются два имени субъектов-служб (SPN) Kerberos, представляющие URL-адреса, используемые при входе в Azure AD.
   >  * Учетные данные администратора домена не хранятся в Azure AD Connect или в Azure AD. Они используются только для того, чтобы включить эту функцию, и отменяются после ее успешного включения.
   
   6. На экране "Готово к настройке" убедитесь, что установлен флажок "Start Synchronization process when configuration completes" (Начать синхронизацию после настройки). Затем выберите "Настроить".
   ![Рисунок 36](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image10.png)</br>
   
   > [!IMPORTANT]
   > На этом этапе все федеративные домены будут переведены на управляемую аутентификацию. Теперь в качестве метода аутентификации будет использоваться синхронизация хэша паролей.
       
   7. Откройте портал Azure AD, выберите "Azure Active Directory", а затем выберите "Azure AD Connect".
   8. Убедитесь, что федерация отключена, а простой единый вход и синхронизация хэша паролей включены.  
  ![Рисунок 37](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image11.png)</br>
   9. Перейдите к разделу [Тестирование и дальнейшие действия](#testing-and-next-steps).
   
   > [!IMPORTANT]
   > Пропустите раздел "Шаг Б. Переход с федеративной на сквозную аутентификацию с помощью Azure AD Connect и PowerShell", так как действия из этого раздела не применяются.  

#### <a name="option-b---switch-from-federation-to-phs-using-azure-ad-connect-and-powershell"></a>Вариант Б. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell

Используйте этот параметр, если федерация не была изначально настроена с помощью Azure AD Connect.

В рамках этого процесса вы включите простой единый вход и преобразуете свои федеративные домены в управляемые.

   1. На сервере Azure AD Connect откройте мастер.
   2. Выберите "Change User Sign in" (Изменить метод входа пользователей), а затем выберите "Далее". 
   3. На экране "Подключение к Azure" введите имя пользователя и пароль глобального администратора.
   4. На экране "Вход пользователей" переведите переключатель из положения "Не настраивать" в положение "Синхронизация хэша паролей", выберите "Включить единый вход" и щелкните "Далее".
   
   Перед изменением: ![Рисунок 20](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image12.png)</br>

   После изменения:  
   ![Рисунок 22](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image13.png)</br>
   
   > [!NOTE]
   > Начиная с Azure AD Connect версии 1.1.880.0 флажок "Эффективный единый вход" установлен по умолчанию.
   
   5. На экране "Включить единый вход" введите учетные данные администратора домена и щелкните "Далее".
   
   > [!NOTE]
   > Эти учетные данные нужны для включения простого единого входа, так как для этого необходимо выполнить приведенные ниже действия, требующие повышенных привилегий. Учетные данные администратора домена не хранятся в Azure AD Connect или в Azure AD. Они используются только для того, чтобы включить эту функцию, и отменяются после ее успешного включения.
   > * В локальной службе Active Directory (AD) создается учетная запись компьютера с именем AZUREADSSOACC (представляет Azure AD).
   > * С помощью Azure AD безопасным образом предоставляется ключ расшифровки Kerberos учетной записи компьютера.
   > * Кроме того, создаются два имени субъектов-служб (SPN) Kerberos, представляющие URL-адреса, используемые при входе в Azure AD.
   
   6. На экране "Готово к настройке" убедитесь, что установлен флажок "Start Synchronization process when configuration completes" (Начать синхронизацию после настройки). Затем выберите "Настроить".
   ![Рисунок 41](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image15.png)</br>
   После щелчка "Настроить" будет настроен простой единый вход согласно параметрам на этапе предварительного просмотра. Конфигурация синхронизации хэша паролей не будет изменена, так как она была включена ранее.
   
   > [!IMPORTANT]
   > На данном этапе процесс входа пользователей никак не изменится.  
   
   7. На портале Azure AD убедитесь в том, что федерация по-прежнему включена и что простой единый вход также включен.
   ![Рисунок 42](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image16.png)

#### <a name="convert-domains-from-federated-to-managed"></a>Преобразование федеративных доменов в управляемые

На этом этапе федерация для ваших доменов по-прежнему включена и работает. Чтобы продолжить развертывание, необходимо преобразовать все федеративные домены в управляемые, чтобы применить аутентификацию пользователей посредством синхронизации хэша паролей.

> [!IMPORTANT]
> Не все домены должны быть преобразованы одновременно. Вы можете начать с тестового домена на рабочем клиенте или домена с наименьшим числом пользователей.

Преобразование выполняется с помощью модуля PowerShell для Azure AD.

   1. Откройте PowerShell и войдите в Azure AD с помощью учетной записи глобального администратора.  
   2. Для преобразования первого домена выполните приведенную ниже команду.  
   
   ``` PowerShell
   Set-MsolDomainAuthentication -Authentication Managed -DomainName <domainname>
   ```
   
   3. Откройте портал Azure AD, выберите "Azure Active Directory", а затем выберите "Azure AD Connect".
   4. Убедитесь, что домен преобразован в управляемый домен, выполнив следующую команду.
   
   ``` PowerShell
   Get-MsolDomain -DomainName <domainname>
   ```

## <a name="testing-and-next-steps"></a>Тестирование и дальнейшие действия

### <a name="test-authentication-with-phs"></a>Тестирование аутентификации посредством синхронизации хэша паролей

Если клиент использовал федерацию, пользователи перенаправлялись со страницы входа Azure AD в среду AD FS. Теперь, когда клиент настроен для использования синхронизации хэша паролей вместо федерации, пользователи не перенаправляются в AD FS. Вместо этого они будут выполнять вход непосредственно на странице входа Azure AD.

Откройте Internet Explorer в режиме InPrivate, чтобы служба простого единого входа не выполнила вход автоматически, и перейдите на страницу входа Office 365 ([https://portal.office.com](https://portal.office.com/)). Введите имя участника-пользователя для пользователя и нажмите кнопку "Далее". Обязательно введите имя участника-пользователя для гибридного пользователя, который был синхронизирован с локальной службой Active Directory и ранее использовал федерацию. Этот пользователь увидит экран для ввода имени пользователя и пароля.

![Рисунок 9](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image18.png)

![Рисунок 12](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image19.png)

После ввода пароля вы должны автоматически перейти на портал Office 365.

![Рисунок 17](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image20.png)

### <a name="test-seamless-single-sign-on"></a>Тестирование простого единого входа

Войдите на компьютер, присоединенный к домену, который подключен к корпоративной сети. Откройте Internet Explorer и перейдите по одному из следующих URL-адресов:  
  
[https://myapps.microsoft.com/contoso.com](https://myapps.microsoft.com/contoso.com) [https://myapps.microsoft.com/contoso.onmicrosoft.com](https://myapps.microsoft.com/contoso.onmicrosoft.com) (замените Contoso именем своего клиента).

Пользователь будет быстро перенаправлен на страницу входа Azure AD и увидит сообщение "Trying to sign you in" (Выполняется попытка входа), и ему не будет предложено ввести имя пользователя или пароль.

![Рисунок 24](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image21.png)

Затем пользователь будет перенаправлен на панель доступа успешно войдет в нее.

> [!NOTE]
> Простой единый вход работает в службах Office 365, которые поддерживают указание домена (например, myapps.microsoft.com/contoso.com). На портале Office 365 (portal.office.com) в настоящее время не поддерживается указание домена, поэтому пользователи должны вводить свое имя участника-пользователя. После ввода имени участника-пользователя служба простого единого входа может получить билет Kerberos от имени пользователя и выполнить его вход без ввода пароля. 

> [!TIP]
> Рассмотрите возможность развертывания [службы гибридного присоединения к Azure AD в Windows 10](https://docs.microsoft.com/azure/active-directory/device-management-introduction), чтобы расширить возможности единого входа.

### <a name="removal-of-the-relying-party-trust"></a>Удаление отношений доверия проверяющей стороны

Убедившись в том, что все клиенты и пользователи успешно проходят аутентификацию с помощью Azure AD, можно без опаски удалить отношения доверия проверяющей стороны Office 365.

Если AD FS не используется для других целей (не настроены другие отношения доверия проверяющей стороны), теперь можно безопасно списать AD FS.

### <a name="rollback"></a>Откат

Если обнаружена серьезная проблема, которая не может быть быстро устранена, можно выполнить откат решения к федерации.

Обратитесь к документации по проектированию и развертыванию федерации, чтобы получить сведения о своем развертывании. Процесс должен включать в себя следующие этапы.

* Преобразование управляемых доменов в федеративные с помощью командлета Convert-MSOLDomainToFederated.

* При необходимости — настройка дополнительных правил утверждений.

### <a name="enable-synchronization-of-userprincipalname-updates"></a>Включение синхронизации обновлений userPrincipalName

Обновления атрибута userPrincipalName с помощью службы синхронизации из локальной среды блокируются за исключением тех случаев, когда выполняются два следующих условия:

* пользователь является управляемым (нефедеративным);

* пользователю не назначена лицензия.

Инструкции о том, как проверить или включить эту функцию, приведены в следующей статье:

[Синхронизация обновлений атрибута userPrincipalName](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsyncservice-features)

### <a name="troubleshooting"></a>Устранение неполадок

Ваша группа поддержки должна знать, как устранить любые неполадки аутентификации, возникающие во время или после перехода с федеративных доменов на управляемые. Предоставьте приведенную документацию по устранению неполадок своей группе поддержки, чтобы она ознакомилась с общими инструкциями по устранению неполадок и соответствующими действиями, которые могут помочь выявить и устранить проблему.

[Устранение неполадок синхронизации хэшированных паролей в службе синхронизации Azure AD Connectirectory](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-troubleshoot-password-hash-synchronization)

[Устранение неполадок с простым единым входом Azure Active Directory](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-troubleshoot-sso)  

## <a name="roll-over-the-seamless-sso-kerberos-decryption"></a>Смена ключа расшифровки Kerberos для простого единого входа

Очень важно часто сменять ключ расшифровки Kerberos учетной записи компьютера AZUREADSSOACC (представляющей Azure AD) в локальном лесу AD. Мы настоятельно рекомендуем сменять ключ расшифровки Kerberos по крайней мере каждые 30 дней, чтобы это соответствовало периоду изменения паролей членами домена Active Directory. Так как к объекту учетной записи компьютера AZUREADSSOACC не подключено связанное устройство, смену необходимо выполнить вручную.

Выполните следующие действия на локальном сервере, на котором выполняется Azure AD Connect, чтобы инициировать смену ключа расшифровки Kerberos.

[Как можно сменить ключ расшифровки Kerberos учетной записи компьютера AZUREADSSOACC](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-sso-faq)?

## <a name="next-steps"></a>Дополнительная информация

- [Принципы проектирования Azure AD Connect](plan-connect-design-concepts.md)
- [Выбор правильного метода проверки подлинности](https://docs.microsoft.com/azure/security/azure-ad-choose-authn)
- [Поддерживаемые топологии](plan-connect-design-concepts.md)
