---
title: 'Azure AD Connect выполняет следующие функции: Переход с федеративной аутентификации на синхронизацию хэша паролей для Azure AD | Документация Майкрософт'
description: В этой статье представлены сведения о переводе среды гибридных удостоверений с федеративной аутентификации на синхронизацию хэша паролей.
services: active-directory
author: billmath
manager: daveba
ms.reviewer: martincoetzer
ms.service: active-directory
ms.workload: identity
ms.topic: article
ms.date: 12/13/2018
ms.component: hybrid
ms.author: billmath
ms.openlocfilehash: c6c13d0e27edd5563f10df59ce7af585a345bfab
ms.sourcegitcommit: cf88cf2cbe94293b0542714a98833be001471c08
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54463343"
---
# <a name="migrate-from-federation-to-password-hash-synchronization-for-azure-active-directory"></a>Переход с федеративной аутентификации на синхронизацию хэша паролей для Azure Active Directory

В этой статье описывается перевод доменов организации с использования служб федерации Active Directory (AD FS) на синхронизацию хэша паролей.

Вы можете [скачать эту статью](https://aka.ms/ADFSTOPHSDPDownload).

## <a name="prerequisites-for-migrating-to-password-hash-synchronization"></a>Предварительные требования для перехода на синхронизацию хэша паролей

Ниже описаны предварительные требования, необходимые для перехода с использования AD FS на синхронизацию хэша паролей.

### <a name="update-azure-ad-connect"></a>Обновление Azure AD Connect

Для успешного перехода на синхронизацию хэша паролей требуется [Azure Active Directory Connect](https://www.microsoft.com/download/details.aspx?id=47594) (Azure AD Connect) версии 1.1.819.0 или более поздней. В этой версии значительно изменен способ преобразования процессов входа. Общее время перехода с AD FS на облачную аутентификацию сокращено с часов до минут.

> [!IMPORTANT]
> В устаревшей документации, инструментах и блогах может быть указано, что преобразование пользователей обязательно при преобразовании федеративных удостоверений в управляемые. *Преобразование пользователей* больше не требуется. Корпорация Майкрософт работает над обновлением документации и инструментов, чтобы отразить это изменение.

Чтобы обновить Azure AD Connect, выполните шаги, описанные в статье [Azure AD Connect: обновление до последней версии](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version).

### <a name="password-hash-synchronization-required-permissions"></a>Необходимые разрешения для синхронизации хэша паролей

Вы можете настроить Azure AD Connect с помощью стандартных параметров или выборочной установки. Если вы использовали выборочную установку, то [необходимые разрешения](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-accounts-permissions) для синхронизации хэша паролей могут отсутствовать.

Учетной записи доменных служб Active Directory (AD DS) в Azure AD Connect требуются приведенные ниже разрешения, чтобы использовать синхронизацию хэша паролей:

* Репликация изменений каталога
* Репликация всех изменений каталога

Самое время проверить наличие этих разрешений для всех доменов в лесу.

### <a name="plan-the-migration-method"></a>Планирование метода переноса

Вы можете выбрать один из двух методов перехода с управления федеративными удостоверениями на синхронизацию хэша паролей и простой единый вход. Применяемый метод зависит от того, как ваш экземпляр AD FS был настроен изначально.

* **Azure AD Connect**. Если вы изначально настроили AD FS с помощью Azure AD Connect, вам *необходимо* перейти на синхронизацию хэша паролей с помощью мастера Azure AD Connect.

   ‎При изменении метода входа пользователей Azure AD Connect автоматически запускает командлет **Set-MsolDomainAuthentication**. Azure AD Connect автоматически отменяет федерацию всех проверенных федеративных доменов в вашем клиенте Azure AD.

   > [!NOTE]
   > В настоящее время невозможно избежать отмены федерации всех доменов в клиенте при переходе на синхронизацию хэша паролей, если изначально для настройки AD FS вы использовали Azure AD Connect. ‎
* **Azure AD Connect и PowerShell**. Этот метод может использоваться только в том случае, если службы AD FS не были изначально настроены с помощью Azure AD Connect. Вам все равно потребуется изменить метод входа пользователей с помощью мастера Azure AD Connect. Основное отличие этого варианта заключается в том, что мастер не запускает командлет **Set-MsolDomainAuthentication** автоматически. При использовании этого варианта вы сможете самостоятельно решать, какие домены будут преобразованы и в каком порядке.

Чтобы понять, какой метод следует использовать, выполните действия в следующих разделах.

#### <a name="verify-current-user-sign-in-settings"></a>Проверка текущих параметров входа пользователей

Проверьте текущие параметры входа пользователей, выполнив следующие действия:

1. Войдите на [портал Azure Active Directory](https://aad.portal.azure.com/), используя учетную запись глобального администратора.
2. В разделе **Вход пользователей** проверьте следующее:
   * Для параметра **Федерация** установлено значение **Включено**.
   * Для параметра **Эффективный единый вход** установлено значение **Отключено**.
   * Для параметра **Сквозная проверка подлинности** установлено значение **Отключено**.

   ![Снимок экрана параметров в разделе "Вход пользователей" в Azure AD Connect](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image1.png)

#### <a name="verify-the-azure-ad-connect-configuration"></a>Проверка конфигурации Azure AD Connect

1. На сервере Azure AD Connect откройте Azure AD Connect. Нажмите кнопку **Настроить**.
2. На странице **Дополнительные задачи** выберите **Просмотр текущей конфигурации**, а затем щелкните **Далее**.<br />

   ![Снимок экрана с выбранным параметром "Просмотр текущей конфигурации" на странице "Дополнительные задачи"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image2.png)<br />
3. На странице **Ознакомьтесь с решением** обратите внимание на состояние **синхронизации хэша паролей**.<br /> 

   * Если для **синхронизации хэша паролей** установлено значение **Отключено**, включите ее, выполнив действия, описанные в этой статье.
   * Если **синхронизация хэша паролей** **включена**, вы можете пропустить раздел **Шаг 1. Включение синхронизации хэшированных паролей** в этой статье.
4. Прокрутите страницу **Ознакомьтесь с решением** до раздела **Службы федерации Active Directory (AD FS)**.<br />

   * ‎Если конфигурация AD FS указана в этом разделе, можно с уверенностью предположить, что службы AD FS были изначально настроены с помощью Azure AD Connect. Вы можете перевести домены с федеративных удостоверений на управляемые с помощью параметра **Смена имени пользователя для входа** в Azure AD Connect. Этот процесс подробно описан в разделе **Вариант A. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect**.
   * Если службы федерации Active Directory не указаны в текущих параметрах, необходимо вручную перевести домены с федеративных удостоверений на управляемые с помощью PowerShell. Дополнительные сведения об этом процессе см. в разделе **Вариант B. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell**.

### <a name="document-current-federation-settings"></a>Документирование текущих параметров федерации

Чтобы найти текущее значение параметра федерации, выполните командлет **Get-MsolDomainFederationSettings**:

``` PowerShell
Get-MsolDomainFederationSettings -DomainName YourDomain.extention | fl *
```

Пример:

``` PowerShell
Get-MsolDomainFederationSettings -DomainName Contoso.com | fl *
```

Проверьте все параметры, которые могли быть настроены в соответствии с документацией по проектированию и развертыванию федерации, в частности **PreferredAuthenticationProtocol**, **SupportsMfa** и **PromptLoginBehavior**.

Дополнительные сведения вы найдете в следующих статьях:

* [Active Directory Federation Services prompt=login parameter support](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-prompt-login) (Поддержка параметра prompt=login в службах федерации Active Directory (AD FS))
* [Set-MsolDomainAuthentication](https://docs.microsoft.com/powershell/module/msonline/set-msoldomainauthentication?view=azureadps-1.0)

> [!NOTE]
> Если параметр **SupportsMfa** имеет значение **True**, в качестве второго фактора в потоке аутентификации пользователя используется локальное решение многофакторной проверки подлинности. Эта конфигурация уже не подойдет для сценариев с аутентификацией Azure Active Directory. 
>
> Вместо нее необходимо будет использовать облачную службу "Многофакторная идентификация Azure" для выполнения той же функции. Внимательно проанализируйте требования многофакторной проверки подлинности, прежде чем действовать дальше. Убедитесь, что вы понимаете принципы работы Многофакторной идентификации Azure, особенности лицензирования и процесс регистрации пользователей, прежде чем преобразовывать домены.

#### <a name="back-up-federation-settings"></a>Резервное копирование параметров федерации

Хотя в ходе процесса, описанного в этой статье, другие проверяющие стороны на ферме AD FS не подвергаются изменениям, мы советуем создать актуальную резервную копию фермы AD FS, которая обеспечивает возможность восстановления. Это можно сделать с помощью бесплатного инструмента [AD FS Rapid Restore Tool](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-rapid-restore-tool) от корпорации Майкрософт. Вы можете выполнить резервное копирование AD FS и восстановление существующей фермы с помощью этого инструмента или же создать новую ферму.

Если вы решили не использовать AD FS Rapid Restore Tool, то как минимум следует экспортировать отношения доверия проверяющей стороны "Платформа удостоверений Microsoft Office 365" и все добавленные связанные с ними настраиваемые правила утверждений. Это можно сделать с помощью следующего примера PowerShell:

``` PowerShell
(Get-AdfsRelyingPartyTrust -Name "Microsoft Office 365 Identity Platform") | Export-CliXML "C:\temp\O365-RelyingPartyTrust.xml"
```

## <a name="deployment-considerations-and-using-ad-fs"></a>Рекомендации по развертыванию и использованию AD FS

В этом разделе описываются рекомендации по развертыванию и сведения об использовании AD FS.

### <a name="current-ad-fs-use"></a>Текущее использование AD FS

Перед преобразованием федеративных удостоверений в управляемые внимательно изучите текущее использование служб AD FS для Azure AD, Office 365 и других приложений (отношения доверия с проверяющей стороной). В частности, рассмотрите сценарии, описанные в следующей таблице:

| Если | То |
|-|-|
| Вы планируете продолжить использование AD FS с другими приложениями (кроме Azure Active Directory и Office 365). | После преобразования доменов вы будете использовать AD FS и Azure Active Directory. Необходимо учитывать взаимодействие с пользователем. В некоторых случаях пользователям может потребоваться дважды пройти аутентификацию: один раз — для входа в Azure Active Directory (после чего они смогут использовать единый вход в другие приложения, такие как Office 365), а второй раз — для входа в какое-либо приложение, которое по-прежнему привязано к AD FS в рамках отношения доверия с проверяющей стороной. |
| Ваш экземпляр AD FS в значительной степени настраиваемый и зависит от конкретных настроек в файле onload.js (например, вы изменили параметры входа в систему, чтобы пользователи могли ввести имя пользователя только в формате **SamAccountName**, а не в формате имени участника-пользователя, или же ваша организация значительно изменила фирменную символику на странице входа). Файл onload.js невозможно дублировать в Azure Active Directory. | Прежде чем продолжить, необходимо будет проверить, соответствует ли Azure AD требованиям вашей текущей конфигурации. Дополнительные сведения и рекомендации см. в разделах о фирменной символике AD FS и настройке параметров AD FS.|
| Вы блокируете более ранние версии клиентов аутентификации, используя AD FS.| Рассмотрите возможность замены элементов управления, которые блокируют ранние версии клиентов аутентификации AD FS, с помощью сочетания [элементов управления условным доступом](https://docs.microsoft.com/azure/active-directory/conditional-access/conditions) и [правил клиентского доступа Exchange Online](http://aka.ms/EXOCAR). |
| Пользователям необходимо проходить многофакторную проверку подлинности на локальном сервере MFA при выполнении аутентификации в AD FS.| У вас не будет возможности внедрить запрос MFA, выполняемый через локальное решение MFA, в поток аутентификации для домена с управляемыми удостоверениями. Однако вы сможете использовать службу Azure MFA для многофакторной проверки подлинности после преобразования домена.<br /><br /> Если в настоящее время пользователи не используют Azure MFA, им потребуется выполнить одноразовую регистрацию. Этот дополнительный шаг нужно будет подготовить, после чего сообщить о нем пользователям. |
| Вы применяете политики управления доступом (правила AuthZ) в AD FS для управления доступом к Office 365.| Рассмотрите возможность их замены эквивалентными [политиками условного доступа](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-azure-portal) в Azure Active Directory и [правилами клиентского доступа Exchange Online](http://aka.ms/EXOCAR).|

### <a name="common-ad-fs-customizations"></a>Распространенные пользовательские настройки AD FS

В этом разделе описываются распространенные пользовательские настройки AD FS.

#### <a name="insidecorporatenetwork-claim"></a>Утверждение InsideCorporateNetwork

Службы AD FS выдают утверждение **InsideCorporateNetwork** при аутентификации пользователя, размещенного в корпоративной сети. Затем это утверждение может передаться в Azure Active Directory. Оно используется для обхода многофакторной проверки подлинности на основе расположения в сети пользователя. Сведения о том, как определить, включена ли сейчас эта функция в AD FS, см. в статье [Защита облачных ресурсов с помощью Многофакторной идентификации Azure и AD FS](https://docs.microsoft.com/azure/multi-factor-authentication/multi-factor-authentication-get-started-adfs-cloud).

Утверждение **InsideCorporateNetwork** недоступно после преобразования доменов для использования синхронизации хэша паролей. Вместо этой функции вы можете использовать [именованные расположения в Azure AD](https://docs.microsoft.com/azure/active-directory/active-directory-named-locations).

После настройки именованных расположений вам необходимо обновить все политики условного доступа, настроенные для включения или исключения сетевых расположений. Параметры **Все надежные расположения** или **Надежные IP-адреса MFA** нужно обновлять с учетом новых именованных расположений.

Дополнительные сведения об условии **расположения** в политике условного доступа см. в статье [Каковы условия расположения в условном доступе Azure Active Directory?](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-locations).

#### <a name="hybrid-azure-ad-joined-devices"></a>Устройства, использующие гибридное присоединение к Azure Active Directory

После присоединения устройства к Azure Active Directory вы можете создавать правила условного доступа, которые обеспечивают доступ с устройств в соответствии с вашими стандартами безопасности и нормативными требованиями. Кроме того, пользователи могут входить на устройство с помощью рабочей или учебной учетной записи организации вместо личной. Использование гибридного присоединения к Azure AD позволяет присоединять к Azure Active Directory устройства, которые присоединены к домену Azure AD. Эта функция могла быть настроена в старой федеративной среде.

Чтобы гибридное присоединение использовалось для всех устройств, присоединяемых к домену после перевода доменов на синхронизацию хэша паролей, для клиентов Windows 10 необходимо использовать Azure AD Connect для синхронизации учетных записей компьютеров Active Directory с Azure AD. 

Для учетных записей компьютеров Windows 7 и Windows 8 гибридное присоединение использует простой единый вход для регистрации компьютера в Azure AD. Вам не потребуется синхронизировать их, как в случае с устройствами Windows 10. Тем не менее необходимо развернуть обновленный файл workplacejoin.exe (с помощью MSI-файла) на клиентах Windows 8 и Windows 7, чтобы они могли зарегистрироваться с помощью простого единого входа. [Скачайте этот MSI-файл](https://www.microsoft.com/download/details.aspx?id=53554).

Дополнительные сведения см. в статье [Практическое руководство. Планирование реализации гибридного присоединения к Azure Active Directory](https://docs.microsoft.com/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup).

#### <a name="branding"></a>Фирменная символика

Если ваша организация [настроила страницы входа AD FS](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-user-sign-in-customization) для отображения присущих ей сведений, постарайтесь аналогичным образом [настроить страницы входа Azure AD](https://docs.microsoft.com/azure/active-directory/customize-branding).

Хотя доступны аналогичные настройки, следует ожидать некоторых изменений в оформлении страниц входа после преобразования. Вы можете сообщить об ожидаемых изменениях пользователям.

> [!NOTE]
> Фирменная символика организации доступна только после приобретения лицензий Premium или Basic для службы Azure Active Directory, а также обладателям лицензий Office 365.

## <a name="plan-deployment-and-support"></a>Планирование развертывания и поддержки

Выполните задачи, описанные в этом разделе, чтобы спланировать развертывание и поддержку.

### <a name="plan-the-maintenance-window"></a>Планирование периода обслуживания

Хотя процесс преобразования доменов относительно быстрый, Azure AD может отправлять запросы на аутентификацию на серверы AD FS еще в течение четырех часов после завершения преобразования. В течение этого времени ввиду различных данных в кэше на стороне служб эти запросы на аутентификацию могут не приниматься службой Azure AD. Пользователи могут получить сообщение об ошибке. Пользователь по-прежнему сможет успешно проходить аутентификацию в AD FS, но Azure AD больше не будет принимать выданный пользователем маркер, так как отношения доверия федерации уже удалены.

Это затронет только пользователей, обращающихся к службам через веб-браузер в течение этого периода после преобразования, пока не будет очищен кэш на стороне службы. Устаревшие клиенты (Exchange ActiveSync, Outlook 2010, Outlook 2013) не должны быть затронуты, так как Exchange Online сохраняет кэш учетных данных в течение определенного периода времени. Кэш позволяет автоматически повторить аутентификацию пользователя. без необходимости возвращения в AD FS. Учетные данные, хранящиеся на устройстве для этих клиентов, позволяют повторно пройти аутентификацию автоматически после очистки кэша. Пользователи не должны получать какие-либо запросы на ввод пароля после преобразования доменов. 

В современных клиентах аутентификации (Office 2016 и Office 2013, приложения IOS и Android) используется действительный маркер обновления для получения новых маркеров доступа, обеспечивающих непрерывный доступ к ресурсам без перехода к службам AD FS. Этим клиентам не грозит появление запросов на ввод пароля после преобразования доменов. Они будут продолжать работать без дополнительных настроек.

> [!IMPORTANT]
> Не завершайте работу среды AD FS и не удаляйте отношение доверия проверяющей стороны Office 365, пока не удостоверитесь, что все пользователи могут успешно пройти аутентификацию в облаке.

### <a name="plan-for-rollback"></a>План отката

Если возникла серьезная проблема, которую невозможно быстро устранить, можно выполнить откат решения к федерации. Очень важно спланировать действия на случай, если развертывание не выполняется должным образом. Если во время развертывания произошел сбой преобразования доменов или пользователей либо возникла необходимость выполнить откат к федерации, необходимо понять, как сократить простой и уменьшить неудобства для пользователей.

#### <a name="to-roll-back"></a>Выполнение отката

Чтобы спланировать откат, ознакомьтесь с документацией по проектированию и развертыванию федерации, в которой указаны сведения о конкретном развертывании. Процесс должен включать в себя следующие этапы:

* Переход управляемых доменов на федеративную аутентификацию с помощью командлета **Convert-MSOLDomainToFederated**.
* При необходимости — настройка дополнительных правил утверждений.

### <a name="plan-communications"></a>Планирование информирования

Важной частью планирования развертывания и поддержки является своевременное информирование пользователей о предстоящих изменениях. Пользователи должны заранее знать о возможных ситуациях и необходимых действиях. 

После развертывания синхронизации хэша паролей и простого единого входа изменится процедура входа пользователей при доступе к Office 365 и другим ресурсам, использующим аутентификацию в Azure AD. Пользователи за пределами вашей сети будут видеть только страницу входа в Azure AD. Они не будут перенаправляться на страницу на основе форм, предоставляемую интерфейсными прокси-серверами веб-приложения.

В стратегию информирования следует включить следующие элементы:

* Уведомление пользователей о планируемых и выпущенных функциональных возможностях с помощью:
   * электронной почты и других внутренних каналов связи;
   * наглядных пособий, например афиш;
   * видеосообщения руководителя или других средств информирования.
* Определение лиц, ответственных за настройку и отправку сообщений, а также расписания отправки сообщений.

## <a name="implement-your-solution"></a>Внедрение решения

Вы уже запланировали решение. Теперь можно приступить к его внедрению. Внедрение включает в себя следующие этапы:

* Включение синхронизации хэша паролей.
* Подготовка к внедрению простого единого входа.
* Изменение метода входа на синхронизацию хэша паролей и включение простого единого входа.

### <a name="step-1-enable-password-hash-synchronization"></a>Шаг 1. Включение синхронизации хэшированных паролей

Первым шагом для внедрения этого решения является включение синхронизации хэша паролей с помощью мастера Azure AD Connect. Синхронизация хэша паролей — это дополнительная функция, которую можно включить для сред, использующих федерацию. Это никак не повлияет на поток процесса аутентификации. В этом случае Azure AD Connect начнет синхронизацию хэша паролей без нарушения процедуры входа пользователей, использующих федерацию.

По этой причине рекомендуется выполнять этот подготовительный шаг задолго до изменения способа входа в домены. У вас будет достаточно времени для проверки работы синхронизации хэша паролей.

Чтобы включить синхронизацию хэша паролей, сделайте следующее.

1. На сервере Azure AD Connect откройте мастер Azure AD Connect и выберите **Настройка**.
2. Выберите **Настроить параметры синхронизации** и щелкните **Далее**.
3. На странице **Подключение к Azure AD** введите имя пользователя и пароль глобального администратора.
4. На странице **Подключить каталоги** щелкните **Далее**.
5. На странице **Фильтрация доменов и подразделений** нажмите кнопку **Далее**.
6. На странице **Дополнительные возможности** выберите **Синхронизация паролей** и щелкните **Далее**.
 
   ![Снимок экрана с выбранным параметром "Синхронизация паролей" на странице дополнительных возможностей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image6.png)<br />
7. Щелкните **Далее** на всех остальных страницах. На последней странице нажмите кнопку **Настроить**.
8. Azure AD Connect начнет синхронизацию хэша паролей во время следующей синхронизации.

После включения синхронизации хэша паролей будет выполнено повторное вычисление и запись в Azure AD хэша паролей всех пользователей, для которых настроена синхронизация Azure AD Connect. В зависимости от количества пользователей эта операция может занять от пары минут до нескольких часов.

В целях планирования следует учесть, что для обработки порядка 20 000 пользователей потребуется 1 час.

Чтобы проверить, правильно ли работает синхронизация хэша паролей, выполните задачу **устранения неполадок** в мастере Azure AD Connect:

1. Откройте новый сеанс Windows PowerShell на сервере Azure AD Connect и запустите его от имени администратора.
2. Запустите `Set-ExecutionPolicy RemoteSigned` или `Set-ExecutionPolicy Unrestricted`.
3. Откройте мастер Azure AD Connect.
4. Перейдите к странице **Дополнительные задачи**, выберите **Устранение неполадок** и щелкните **Далее**.
5. На странице **Устранение неполадок** выберите **Запуск**, чтобы открыть меню устранения неполадок в PowerShell.
6. В главном меню выберите **Устранение неполадок при синхронизации хэшей паролей**.
7. В подменю выберите **Password hash synchronization does not work at all** (Синхронизация хэша паролей не выполняется).

Дополнительные сведения см. в статье [Устранение неполадок синхронизации хэшированных паролей в службе синхронизации Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-troubleshoot-password-hash-synchronization).

### <a name="step-2-prepare-for-seamless-sso"></a>Шаг 2. Подготовка к внедрению простого единого входа

Чтобы устройства использовали простой единый вход, необходимо добавить URL-адрес Azure AD в параметры зоны интрасети пользователей с помощью групповой политики Active Directory.

По умолчанию веб-браузеры автоматически вычисляют соответствующую зону (Интернета или интрасети) по URL-адресу. Например, **http:\/\/contoso/** сопоставляется с зоной интрасети, а **http:\/\/intranet.contoso.com** — с зоной Интернета (так как этот URL-адрес содержит точку). Браузеры отправляют билеты Kerberos в облачную конечную точку (например, URL-адрес Azure AD), если только ее URL-адрес добавлен явным образом в зону интрасети в браузере.

Выполните соответствующие действия, чтобы [развернуть](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-sso-quick-start) необходимые изменения на устройствах.

> [!IMPORTANT]
> Эти изменения не повлияют на способ входа пользователей в Azure AD. Тем не менее очень важно применить эту конфигурацию ко всем устройствам, прежде чем продолжать работу. При входе с устройств, не получивших эту конфигурацию, пользователям просто придется вводить имя пользователя и пароль для входа в Azure AD.

### <a name="step-3-change-the-sign-in-method-to-password-hash-synchronization-and-enable-seamless-sso"></a>Шаг 3. Изменение метода входа на синхронизацию хэша паролей и включение простого единого входа

Доступны два варианта изменения метода входа на синхронизацию хэша паролей и включения простого единого входа.

#### <a name="option-a-switch-from-federation-to-password-hash-synchronization-by-using-azure-ad-connect"></a>Вариант А. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect

Используйте этот метод, только если среда AD FS была изначально настроена с помощью Azure AD Connect. Этот метод не может использоваться в случае, если среда AD FS *не была* изначально настроена с помощью Azure AD Connect.

Сначала измените метод входа:

1. На сервере Azure AD Connect откройте мастер Azure AD Connect.
2. Выберите **Смена имени пользователя для входа**, а затем выберите **Далее**. 

   ![Снимок экрана с параметром "Смена имени пользователя для входа" на странице дополнительных задач](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image7.png)<br />
3. На странице **Подключение к Azure AD** введите имя пользователя и пароль глобального администратора.
4. На странице **входа пользователей** нажмите кнопку **Синхронизация хэша паролей**. Обязательно установите флажок **Не преобразовывать учетные записи пользователей**. Этот параметр является устаревшим. Выберите **Включить единый вход** и щелкните **Далее**.

   ![Снимок экрана со страницей "Включить единый вход"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image8.png)<br />

   > [!NOTE]
   > Начиная с Azure AD Connect версии 1.1.880.0 флажок **Эффективный единый вход** установлен по умолчанию.

   > [!IMPORTANT]
   > Можно спокойно игнорировать предупреждения о том, что преобразование пользователей и полная синхронизация хэша паролей обязательны для перехода с федеративной аутентификации на облачную. Обратите внимание, что эти действия больше не являются обязательными. Если вы по-прежнему видите эти предупреждения, убедитесь, что используется последняя версия Azure AD Connect и вы следуете последней версии данного руководства. Дополнительные сведения см. в разделе [Обновление Azure AD Connect](#update-azure-ad-connect).

5. На странице **Включить единый вход** введите учетные данные администратора домена и щелкните **Далее**.

   ![Снимок экрана со страницей "Включить единый вход"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image9.png)<br />

   > [!NOTE]
   > Учетные данные администратора домена нужны для включения простого единого входа. Во время этого процесса выполняются приведенные ниже действия, для которых требуются повышенные привилегии. Учетные данные администратора домена не хранятся в Azure AD Connect или в Azure AD. Они используются только для того, чтобы включить эту функцию, и отменяются после успешного выполнения процесса.
   >
   > 1. В локальном экземпляре Active Directory создается учетная запись компьютера с именем AZUREADSSOACC (представляет Azure AD).
   > 2. С помощью Azure AD безопасным образом предоставляется ключ расшифровки Kerberos учетной записи компьютера.
   > 3. Создаются два имени субъектов-служб (SPN) Kerberos, представляющие URL-адреса, используемые при входе в Azure AD.

6. Убедитесь, что на странице **Готово к настройке** установлен флажок **Start the synchronization process when configuration completes** (Начать синхронизацию после настройки). Затем выберите **Настроить**.

      ![Снимок экрана со страницей "Готово к настройке"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image10.png)<br />

   > [!IMPORTANT]
   > На этом этапе все федеративные домены будут переведены на управляемую аутентификацию. В качестве метода аутентификации будет использоваться синхронизация хэша паролей.

7. Откройте портал Azure AD и выберите **Azure Active Directory** > **Azure AD Connect**.
8. Проверьте настройку параметров.
   * Для параметра **Федерация** установите значение **Отключено**.
   * Для параметра **Эффективный единый вход** установите значение **Включено**.
   * Для параметра **Синхронизация паролей** установите значение **Включено**.<br /> 

   ![Снимок экрана с параметрами в разделе входа пользователей ](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image11.png)<br />

Перейдите к разделу [Тестирование и дальнейшие действия](#testing-and-next-steps).

   > [!IMPORTANT]
   > Пропустите раздел **Вариант Б. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell**. Если вы выбрали вариант A для изменения метода входа на синхронизацию хэша паролей и включения простого единого входа, действия из этого раздела не применяются.

#### <a name="option-b-switch-from-federation-to-password-hash-synchronization-using-azure-ad-connect-and-powershell"></a>Вариант 2. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell.

Используйте этот вариант, если федеративные домены не были изначально настроены с помощью Azure AD Connect. В рамках этого процесса вы включаете простой единый вход и преобразовываете свои федеративные домены в управляемые.

1. На сервере Azure AD Connect откройте мастер Azure AD Connect.
2. Выберите **Смена имени пользователя для входа**, а затем выберите **Далее**.
3. На странице **Подключение к Azure AD** введите имя пользователя и пароль глобального администратора.
4. На странице **входа пользователей** нажмите кнопку **Синхронизация хэша паролей**. Выберите **Включить единый вход** и щелкните **Далее**.

   Перед включением синхронизации хэша паролей сделайте следующее: ![Снимок экрана с параметром "Не настраивать" на странице входа пользователей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image12.png)<br />

   После включения синхронизации хэша паролей сделайте следующее: ![Снимок экрана с новыми параметрами на странице входа пользователей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image13.png)<br />
   
   > [!NOTE]
   > Начиная с Azure AD Connect версии 1.1.880.0 флажок **Эффективный единый вход** установлен по умолчанию.

5. На странице **Включить единый вход** введите учетные данные администратора домена и щелкните **Далее**.

   > [!NOTE]
   > Учетные данные администратора домена нужны для включения простого единого входа. Во время этого процесса выполняются приведенные ниже действия, для которых требуются повышенные привилегии. Учетные данные администратора домена не хранятся в Azure AD Connect или в Azure AD. Они используются только для того, чтобы включить эту функцию, и отменяются после успешного выполнения процесса.
   >
   > 1. В локальном экземпляре Active Directory создается учетная запись компьютера с именем AZUREADSSOACC (представляет Azure AD).
   > 2. С помощью Azure AD безопасным образом предоставляется ключ расшифровки Kerberos учетной записи компьютера.
   > 3. Создаются два имени субъектов-служб (SPN) Kerberos, представляющие URL-адреса, используемые при входе в Azure AD.

6. Убедитесь, что на странице **Готово к настройке** установлен флажок **Start the synchronization process when configuration completes** (Начать синхронизацию после настройки). Затем выберите **Настроить**.

   ![Снимок экрана с кнопкой "Настроить" на странице "Готово к настройке"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image15.png)<br />
   После того как вы нажмете кнопку **Настроить**, будет настроен простой единый вход согласно параметрам, указанным на предыдущем шаге. Конфигурация синхронизации хэша паролей не будет изменена, так как она была включена ранее.

   > [!IMPORTANT]
   > На данном этапе процесс входа пользователей никак не изменен.

7. На портале Azure AD проверьте следующее:
   * Для параметра **Федерация** установлено значение **Включено**.
   * Для параметра **Эффективный единый вход** установите значение **Включено**.
   * Для параметра **Синхронизация паролей** установите значение **Включено**.

   ![Снимок экрана с параметрами в разделе входа пользователей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image16.png)

#### <a name="convert-domains-from-federated-to-managed"></a>Преобразование федеративных доменов в управляемые

На этом этапе федерация для ваших доменов по-прежнему включена и работает. Чтобы продолжить развертывание, необходимо преобразовать все федеративные домены в управляемые, чтобы применить аутентификацию пользователей посредством синхронизации хэша паролей.

> [!IMPORTANT]
> Не все домены должны быть преобразованы одновременно. Вы можете начать с тестового домена на рабочем клиенте или домена с наименьшим числом пользователей.

Выполните преобразование с помощью модуля Azure AD PowerShell:

1. Войдите на портал Azure Active Directory в PowerShell, используя учетную запись глобального администратора.
2. Для преобразования первого домена выполните приведенную ниже команду.

   ``` PowerShell
   Set-MsolDomainAuthentication -Authentication Managed -DomainName <domain name>
   ```

3. Откройте портал Azure AD и выберите **Azure Active Directory** > **Azure AD Connect**.
4. Убедитесь, что домен преобразован в управляемый, выполнив следующую команду:

   ``` PowerShell
   Get-MsolDomain -DomainName <domain name>
   ```

## <a name="testing-and-next-steps"></a>Тестирование и дальнейшие действия

Выполните следующие задачи, чтобы проверить синхронизацию хэша паролей и завершить процесс преобразования.

### <a name="test-authentication-by-using-password-hash-synchronization"></a>Тестирование аутентификации с помощью синхронизации хэша паролей 

Когда в клиенте использовалось федеративное удостоверение, пользователи перенаправлялись со страницы входа Azure AD в среду AD FS. Теперь, когда клиент настроен на использование синхронизации хэша паролей вместо федеративной аутентификации, пользователи не перенаправляются в AD FS. Вместо этого они будут выполнять вход непосредственно на странице входа в Azure AD.

Чтобы протестировать синхронизацию хэша паролей:

1. Откройте Internet Explorer в режиме InPrivate, чтобы служба простого единого входа не выполнила вход автоматически.
2. Перейдите на страницу входа Office 365 ([http://portal.office.com](http://portal.office.com/)).
3. Введите имя участника-пользователя и щелкните **Далее**. Обязательно введите имя участника-пользователя для гибридного пользователя, который был синхронизирован из локального экземпляра Active Directory и ранее использовал федеративную аутентификацию. Откроется страница для ввода имени пользователя и пароля:

   ![Снимок экрана со страницей входа для ввода имени пользователя](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image18.png)

   ![Снимок экрана со страницей входа для ввода пароля](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image19.png)

4. После ввода пароля и нажатия кнопки **Войти** вы будете перенаправлены на портал Office 365.

   ![Снимок экрана с порталом Office 365](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image20.png)


### <a name="test-seamless-sso"></a>Тестирование простого единого входа

1. Войдите на компьютер, присоединенный к домену, который подключен к корпоративной сети.
2. Откройте Internet Explorer или Chrome и перейдите по одному из следующих URL-адресов, заменив contoso именем своего клиента:

   * https:\/\/myapps.microsoft.com/contoso.com;
   * https:\/\/myapps.microsoft.com/contoso.onmicrosoft.com.

   Пользователь будет быстро перенаправлен на страницу входа в Azure AD и увидит сообщение "Выполняется попытка входа". Ему не будет предложено ввести имя пользователя или пароль.<br />

   ![Снимок экрана со страницей входа в Azure AD и сообщением](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image21.png)<br />
3. Затем пользователь будет перенаправлен на панель доступа и успешно войдет в нее:

   > [!NOTE]
   > Простой единый вход работает в службах Office 365, которые поддерживают указание домена (например, myapps.microsoft.com/contoso.com). Сейчас на портале Office 365 (portal.office.com) не поддерживаются указания домена. Пользователи должны вводить свое имя участника-пользователя. После ввода имени участника-пользователя служба простого единого входа получает билет Kerberos от имени пользователя. Пользователь выполняет вход без ввода пароля.

   > [!TIP]
   > Рассмотрите возможность развертывания [службы гибридного присоединения к Azure AD в Windows 10](https://docs.microsoft.com/azure/active-directory/device-management-introduction), чтобы расширить возможности единого входа.

### <a name="remove-the-relying-party-trust"></a>Удаление отношений доверия с проверяющей стороной

Убедившись в том, что все клиенты и пользователи успешно проходят аутентификацию с помощью Azure AD, можно удалить отношения доверия с проверяющей стороной Office 365.

Если AD FS не используется для других целей (других отношений доверия с проверяющей стороной), можно безопасно списать AD FS.

### <a name="rollback"></a>Откат

Если обнаружена серьезная проблема, которая не может быть быстро устранена, можно выполнить откат решения к федерации.

Ознакомьтесь с документацией по проектированию и развертыванию федерации, в которой указаны сведения о конкретном развертывании. Процесс должен включать в себя следующие этапы:

* Переход управляемых доменов на федеративную аутентификацию с помощью командлета **Convert-MSOLDomainToFederated**.
* При необходимости — настройка дополнительных правил утверждений.

### <a name="sync-userprincipalname-updates"></a>Синхронизация обновлений атрибута userPrincipalName

Обновления атрибута **userPrincipalName**, использующего службу синхронизации из локальной среды, блокируются, за исключением тех случаев, когда выполняются два следующих условия:

* пользователь находится в управляемом домене (не федеративном);
* пользователю не назначена лицензия.

Инструкции о том, как проверить или включить эту функцию, см. в статье [Функции службы синхронизации Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsyncservice-features).

### <a name="troubleshooting"></a>Устранение неполадок

Ваша группа поддержки должна знать, как устранить любые неполадки аутентификации, возникающие во время или после перехода с федеративных доменов на управляемые. Предоставьте приведенную документацию по устранению неполадок своей группе поддержки, чтобы она ознакомилась с общими инструкциями по устранению неполадок и соответствующими действиями, которые могут помочь выявить и устранить проблему.

[Устранение неполадок синхронизации хэшированных паролей в службе синхронизации Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-troubleshoot-password-hash-synchronization)

[Устранение неполадок с простым единым входом Azure Active Directory](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-troubleshoot-sso)

## <a name="roll-over-the-seamless-sso-kerberos-decryption-key"></a>Смена ключа расшифровки Kerberos для простого единого входа

Очень важно часто сменять ключ расшифровки Kerberos учетной записи компьютера AZUREADSSOACC (представляющей Azure AD). Учетная запись компьютера AZUREADSSOACC создается в локальном лесу Active Directory. Мы настоятельно рекомендуем сменять ключ расшифровки Kerberos по крайней мере каждые 30 дней, чтобы это соответствовало периоду изменения паролей членами домена Active Directory. К объекту учетной записи компьютера AZUREADSSOACC не подключено связанное устройство, поэтому смену необходимо выполнить вручную.

Инициируйте смену ключа расшифровки Kerberos простого единого входа на локальном сервере, на котором выполняется Azure AD Connect.

Дополнительные сведения см. в статье [Простой единый вход Azure Active Directory: часто задаваемые вопросы](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-sso-faq).

## <a name="next-steps"></a>Дополнительная информация

* [Azure AD Connect: принципы проектирования](plan-connect-design-concepts.md).
* [Выбор правильного метода аутентификации для гибридного решения для идентификации Azure Active Directory](https://docs.microsoft.com/azure/security/azure-ad-choose-authn).
* Ознакомьтесь со сведениями о [поддерживаемых топологиях](plan-connect-design-concepts.md).
