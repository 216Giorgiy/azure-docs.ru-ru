---
title: Инструкции по настройке приложения OpenID или OAuth из коллекции приложений Azure AD | Документация Майкрософт
description: Инструкции по настройке приложения OpenID или OAuth из коллекции приложений Azure AD.
services: active-directory
documentationCenter: na
author: jeevansd
manager: femila
ms.assetid: eedebb76-e78c-428f-9cf0-5891852e79fb
ms.service: active-directory
ms.component: saas-app-tutorial
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/25/2018
ms.author: jeedes
ms.openlocfilehash: 176af41197810059a17daf5ab09d29e0169e9640
ms.sourcegitcommit: 16ddc345abd6e10a7a3714f12780958f60d339b6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2018
ms.locfileid: "36225013"
---
# <a name="steps-to-configure-an-openidoauth-application-from-azure-ad-app-gallery"></a>Инструкции по настройке приложения OpenID или OAuth из коллекции приложений Azure AD

## <a name="process-of-open-id-application-addition-from-gallery"></a>Процесс добавления приложения OpenID из коллекции

1. На **[портале Azure](https://portal.azure.com)** в области навигации слева щелкните значок **Azure Active Directory**. 

    ![Кнопка "Azure Active Directory"](./media/openidoauth-tutorial/tutorial_general_01.png)

2. Перейдите к разделу **Корпоративные приложения**. Затем выберите **Все приложения**.

    ![Колонка "Корпоративные приложения"](./media/openidoauth-tutorial/tutorial_general_02.png)

3. Чтобы добавить новое приложение, в верхней части диалогового окна нажмите кнопку **Создать приложение**.

    ![Кнопка "Новое приложение"](./media/openidoauth-tutorial/tutorial_general_03.png)

4. В поле поиска введите **имя приложения**, выберите **требуемое приложение** на панели результатов и выполните его регистрацию.

    ![Добавление приложения](./media/openidoauth-tutorial/addfromgallery.png)

    > [!NOTE]
    > Для приложений OpenID Connect и OAuth кнопка "Добавить" отключена по умолчанию. Администратор клиента должен нажать кнопку **"Регистрация"** и дать согласие на регистрацию приложения. Таким образом приложение будет добавлено в клиент пользователя без необходимости напрямую добавлять и настраивать его.

    ![Кнопка "Добавить"](./media/openidoauth-tutorial/addbutton.png)

5. После щелчка ссылки "Регистрация" вы будете перенаправлены на страницу Azure AD для ввода учетных данных для входа.

6. После успешного выполнения аутентификации пользователь должен дать согласие на соответствующей странице, после чего отобразится домашняя страница приложения.

    > [!NOTE]
    > Пользователи могут добавить только один экземпляр приложения. Если вы уже добавили экземпляр приложения и пытаетесь еще раз дать согласие, экземпляр не будет повторно добавлен в клиент. Поэтому пользователи могут использовать только один экземпляр приложения в клиенте.

## <a name="authentication-flow-using-openid-connect"></a>Поток проверки подлинности при использовании OpenID Connect

Наиболее простой процесс входа содержит следующие этапы. Каждый из них подробно описан ниже.

![Поток проверки подлинности при использовании OpenID Connect](./media/openidoauth-tutorial/authenticationflow.png)

* **Мультитенантное приложение** — такое приложение (для нескольких клиентов) предназначено для использования в нескольких организациях. Как правило, это приложения категории "программное обеспечение как услуга" (SaaS), которые создают независимые поставщики программных продуктов (ISV). Мультитенантные приложения необходимо подготавливать в каждом каталоге, где они будут использоваться. Следовательно, для их регистрации требуется предоставление разрешений пользователем или администратором. Процесс предоставление разрешений начинается, когда приложение регистрируется в каталоге и получает доступ к API-интерфейсу Graph или, возможно, к другому веб-интерфейсу API. Когда пользователь или администратор из другой организации регистрируется для использования приложения, появляется диалоговое окно, в котором отображаются разрешения, необходимые для приложения. Пользователь или администратор может предоставить приложению требуемые разрешения, что дает приложению доступ к необходимым данным и регистрирует приложение в их каталоге.

    > [!NOTE]
    > Если вы делаете свое приложение доступным для пользователей в нескольких каталогах, требуется механизм, чтобы определять, членами какого клиента они являются. Однотенантное приложение должно присутствовать только в собственном каталоге для данного пользователя, тогда как мультитенантное приложение должно идентифицировать конкретного пользователя из любого каталога в Azure AD. Для выполнения этой задачи система Azure AD предоставляет общую конечную точку проверки подлинности, в которую мультитенантное приложение может направлять запросы на вход, вместо конечной точки для конкретного клиента. Для всех каталогов в Azure AD эта конечная точка — [https://login.microsoftonline.com/common](https://login.microsoftonline.com/common), тогда как конечной точкой для конкретного клиента может быть [https://login.microsoftonline.com/contoso.onmicrosoft.com](https://login.microsoftonline.com/contoso.onmicrosoft.com). Общую конечную точку особенно важно учитывать при разработке своего приложения, так как вам будет нужна специальная логика для обработки нескольких клиентов во время входа, выхода и проверки маркеров.

Команда разработчиков Azure AD по умолчанию повышает уровень мультитенантного приложения, чтобы оно было легко доступно в разных организациях и удобно в использовании после предоставления согласия.

## <a name="what-is-consent-framework"></a>Что такое платформа согласия?

Платформа согласия Azure AD позволяет легко разрабатывать мультитенантные веб-приложения и собственные клиентские приложения. Эти приложения позволяют входить в учетные записи пользователей с клиентов Azure AD, отличных от того, где было зарегистрировано приложение. Им также может потребоваться доступ к веб-API, таким как API Microsoft Graph (для доступа к Azure Active Directory, Intune и службам Office 365), и другие API-интерфейсы служб Майкрософт. Эта платформа использует согласие пользователя или администратора на регистрацию приложения в своем каталоге, что может включать в себя доступ к данным каталога. После предоставления такого согласия клиентское приложение сможет вызывать API Microsoft Graph от имени этого пользователя и пользоваться сведениями по мере необходимости.

[API Microsoft Graph](https://graph.microsoft.io/) предоставляет доступ к данным в Office 365 (календарям и сообщениям Exchange, сайтам и спискам SharePoint, документам в OneDrive, записным книжкам в OneNote, задачам планировщика, книгам Excel и т. д.), а также к пользователям и группам Azure AD и другим объектам данных других облачных служб Майкрософт.

Ниже показаны особенности работы процедуры согласия для разработчика приложений и пользователя.

1. Предположим, у вас есть приложение веб-клиента, которому необходимо запросить конкретные разрешения для получения доступа к ресурсу или API. Портал Azure используется для объявления запросов на разрешения во время настройки. Как и другие параметры конфигурации, они становятся частью регистрации Azure AD приложения:

    ![API Graph](./media/openidoauth-tutorial/graphapi.png)

2. Представим себе, что разрешения вашего приложения были обновлены, само приложение запущено, а пользователь собирается воспользоваться им в первый раз. Сначала приложение должно получить код авторизации из конечной точки /authorize Azure AD. Код авторизации можно использовать для получения новых маркеров доступа или обновления.

3. Если пользователь еще не выполнил аутентификацию, конечная точка /authorize Azure AD запросит данные для входа.

    ![Authentication](./media/openidoauth-tutorial/authentication.png)

4. После входа Azure AD определяет, требуется ли отобразить этому пользователю страницу согласия. Принятие этого решения основано на том, дал ли этот пользователь (или администратор его организации) свое согласие для приложения. Если согласие еще не было дано, Azure AD запрашивает у пользователя согласие и отображает необходимые для этого разрешения. В диалоговом окне согласия отображается тот же набор разрешений, который совпадает с набором разрешений "Делегированные разрешения" на портале Azure.

    ![Страница предоставления согласия](./media/openidoauth-tutorial/consentpage.png)

Некоторые разрешения могут быть приняты обычным пользователем, а для других требуется согласие администратора клиента.

## <a name="whats-the-difference-between-admin-consent-and-user-consent"></a>Чем отличаются согласие администратора и согласие пользователя?

Обладая правами администратора, вы можете также согласиться использовать делегированные разрешения приложения от имени всех пользователей в клиенте. Согласие администратора предотвращает появление диалогового окна согласия для каждого пользователя в клиенте и может предоставляться на портале Azure пользователям, которым назначена роль администратора. На странице "Параметры" приложения щелкните "Необходимые разрешения" и "Предоставить разрешения".

![Предоставление разрешения](./media/openidoauth-tutorial/grantpermission.png)

> [!NOTE]
> Для одностраничных приложений (SPA), использующих ADAL.js, в данный момент требуется предоставление явного разрешения с помощью кнопки "Предоставить разрешения". В противном случае происходит сбой приложения при запросе маркера доступа.

Для разрешений "только для приложения" всегда требуется согласие администратора клиента. Если приложение запрашивает разрешение "только для приложения" и пользователь пытается войти в приложение, появится сообщение об ошибке. Это сообщение говорит о том, что пользователь не может принять это разрешение.

Если приложение использует разрешения, требующие согласия администратора, то в приложении должен быть элемент, такой как кнопка или ссылка, с помощью которого администратор может инициировать действие. Запрос, отправляемый приложением для этого действия, является обычным запросом авторизации OAuth2 или OpenID Connect, но он также включает в себя параметр строки запроса prompt=admin_consent. После того как администратор предоставит свое согласие, а в клиенте пользователя будет создан субъект-служба, в последующих запросах входа не нужно будет указывать параметр prompt=admin_consent. После того как администратор решил, что запрошенные разрешения являются приемлемыми, у других пользователей клиента согласие запрашиваться не будет. Администратор клиента может отключить возможность обычным пользователям предоставлять согласие для приложений. Если эта возможность отключена, то для использования приложения в клиенте всегда требуется согласие администратора. Чтобы протестировать приложение, в котором отключена возможность предоставления согласия для конечных пользователей, найдите соответствующий параметр на [портале Azure](https://portal.azure.com/), открыв раздел **Корпоративные приложения** и выбрав ["Параметры пользователя"](https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/UserSettings/menuId/)

Параметр prompt=admin_consent может использоваться приложениями, запрашивающими разрешения, которые не требуют согласия администратора. Это делается, например, в тех случаях, когда приложению требуется возможность одноразовой регистрации администратора клиента, после которой у других пользователей согласие не запрашивается.

Если приложению требуется согласие администратора и администратор выполняет вход, но параметр prompt=admin_consent не передается, администратор предоставит приложению согласие только для своей учетной записи пользователя. Обычные пользователи по-прежнему не смогут выполнять вход и давать свое согласие приложению. Это удобно в тех случаях, когда администратору клиента нужно просмотреть приложение, прежде чем предоставлять доступ к приложению другим пользователям.