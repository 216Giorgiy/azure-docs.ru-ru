---
title: "Работа с имеющимися локальными прокси-серверами в Azure AD | Документация Майкрософт"
description: "В этой статье описывается, как работать с имеющимися локальными прокси-серверами."
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/12/2017
ms.author: kgremban
translationtype: Human Translation
ms.sourcegitcommit: 2fab64ef8bf07532c4fd2fff4f4af68dc0b44b45
ms.openlocfilehash: 659edc19c9f043d6a388f1bb293c72e379fa6e4a


---

# <a name="work-with-existing-on-premises-proxy-servers"></a>Работа с имеющимися локальными прокси-серверами

В этой статье описывается, как настроить соединитель прокси приложения для работы с исходящими прокси-серверами. Она предназначена для клиентов, использующих сетевые среды с имеющимися прокси.

Рассмотрим основные сценарии развертывания:
* Настройка соединителей для обхода локальных исходящих прокси-серверов.
* Настройка соединителей исходящего прокси-сервера для доступа к прокси приложения Azure AD.

Дополнительные сведения о работе соединителей см. в статье [Как обеспечить безопасный удаленный доступ к локальным приложениям](https://docs.microsoft.com/en-us/azure/active-directory/active-directory-application-proxy-get-started).

## <a name="configure-your-connectors"></a>Настройка соединителей

Основная служба соединителя использует служебную шину Azure для обработки базовых операций связи со службой прокси приложения Azure AD. Использование служебной шины сопровождается дополнительными требованиями к конфигурации.

Сведения о способах устранения неисправностей с подключением к Azure AD см. в [этой записи блога](https://blogs.technet.microsoft.com/applicationproxyblog/2015/03/24/how-to-troubleshoot-azure-ad-application-proxy-connectivity-problems). 

## <a name="configure-the-outbound-proxy"></a>Настройка исходящего прокси-сервера

Если в вашей среде имеется исходящий прокси-сервер, убедитесь, что учетная запись, с использованием которой выполняется установка, настроена соответствующим образом для работы с ним. Так как программа установки выполняется, когда пользователь выполняет установку, это можно сделать с помощью браузера Microsoft Edge или другого интернет-браузера. 

Чтобы настроить параметры прокси-сервера с помощью Microsoft Edge, перейдите в меню "Параметры > Просмотреть дополнительные параметры > Открыть параметры прокси-сервера > Настройка прокси вручную". Включите параметр "Использовать прокси-сервер", установите флажок Don’t use the proxy server for local intranet addresses (Не использовать прокси-сервер для локальных интрасетевых адресов), а затем измените адрес и порт в соответствии с параметрами локального прокси-сервера.

Укажите необходимые параметры прокси-сервера, как показано в окне параметров ниже.

 ![Обход локальных адресов Azure AD](./media/application-proxy-working-with-proxy-servers/proxy-bypass-local-addresses.png)
 
## <a name="bypass-outbound-proxies"></a>Обход исходящих прокси-серверов

По умолчанию соединитель использует базовые компоненты ОС, чтобы исходящие запросы могли автоматически находить прокси-серверы в сети с использованием автообнаружения веб-прокси, если эта функция включена в среде.

Обычно при этом выполняется поиск wpad.domainsuffix в DNS. Если эта операция разрешается в DNS, будет выполнен HTTP-запрос на поиск файла wpad.dat к IP-адресу. Этот файл будет скриптом конфигурации прокси в вашей среде. Затем соединитель использует его, чтобы выбрать исходящий прокси-сервер. Тем не менее, трафик соединителя может по-прежнему не приниматься из-за дополнительных параметров конфигурации, необходимых для прокси-сервера. 

В следующем разделе мы рассмотрим, что нужно сделать, чтобы настроить исходящий прокси-сервер для передачи трафика. Но сначала рассмотрим, как можно настроить соединитель, чтобы обойти локальный прокси-сервер и убедиться, что он подключается к службам Azure напрямую. Мы рекомендуем использовать этот способ (пока это допускает политика сети), так как он позволяет сократить количество конфигураций.

Чтобы отключить использование исходящего прокси-сервера для соединителя, измените файл C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe.config и добавьте раздел [system.net], как показано в следующем примере кода:

```xml
 <?xml version="1.0" encoding="utf-8" ?>
<configuration>
<system.net>
<defaultProxy enabled="false"></defaultProxy>
</system.net>
 <runtime>
<gcServer enabled="true"/>
  </runtime>
  <appSettings>
<add key="TraceFilename" value="AadAppProxyConnector.log" />
  </appSettings>
</configuration>
```
Чтобы убедиться, что служба средства обновления соединителей также обходит прокси-сервер, аналогичным образом измените файл ApplicationProxyConnectorUpdaterService.exe.config, расположенный по пути C:\Program Files\Microsoft AAD App Proxy Connector Updater\ApplicationProxyConnectorUpdaterService.exe.config.

Обязательно сделайте копии исходных файлов, если потребуется восстановить файлы конфигурации по умолчанию. 

## <a name="use-the-outbound-proxy-server"></a>Использование исходящего прокси-сервера

Как упоминалось выше, в некоторых средах клиентов есть требование, чтобы абсолютно весь исходящий трафик передавался через исходящий прокси-сервер без исключений. В результате этого невозможно будет выполнить обход прокси-сервера.

Вы можете настроить передачу трафика соединителя через прокси-сервер, как показано ниже.

 ![Обход локальных адресов Azure AD](./media/application-proxy-working-with-proxy-servers/configure-proxy-settings.png)

При наличии только исходящего трафика не нужно устанавливать балансировку нагрузки между соединителями или настраивать доступ входящего трафика через брандмауэры.

В любом случае потребуется сделать следующее:
1. Настроить использование исходящего прокси-сервера для соединителя и службы средства обновления.
2. Настроить параметры прокси-сервера, чтобы разрешить подключение к службе прокси приложения Azure AD.

### <a name="step-1-configure-the-connector-and-related-services-to-go-through-the-outbound-proxy"></a>Шаг 1. Настройка использования исходящего прокси-сервера для соединителя и службы средства обновления

Как упоминалось выше, если автообнаружение веб-прокси включено в среде и настроено должным образом, соединитель обнаружит исходящий прокси-сервер автоматически и попытается его использовать. Тем не менее можно явным образом настроить использование исходящего прокси-сервера для соединителя. 

Для этого измените файл C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe.config и добавьте раздел [system.net], как показано в следующем примере кода:

```xml
 <?xml version="1.0" encoding="utf-8" ?>
<configuration>
<system.net>  
    <defaultProxy>   
      <proxy proxyaddress="http://proxyserver:8080" bypassonlocal="True" usesystemdefault="True"/>   
    </defaultProxy>  
</system.net>
  <runtime>
     <gcServer enabled="true"/>
  </runtime>
  <appSettings>
    <add key="TraceFilename" value="AadAppProxyConnector.log" />
  </appSettings>
</configuration>
```

>[!NOTE]
>Измените _proxyserver:8080_ в соответствии с именем или IP-адресом локального прокси-сервера или прослушиваемого им порта.
>

Затем необходимо настроить службу средства обновления соединителей для использования прокси-сервера, аналогичным образом изменив файл, расположенный по пути C:\Program Files\Microsoft AAD App Proxy Connector Updater\ApplicationProxyConnectorUpdaterService.exe.config.

###<a name="step-2-configure-the-proxy-to-allow-traffic-from-the-connector-and-related-services-to-flow-through"></a>Шаг 2. Настройка прокси-сервера для разрешения передачи трафика соединителя и связанных служб

Следует учитывать 4 аспекта исходящего прокси-сервера:
* правила для исходящих подключений прокси-сервера;
* проверка подлинности прокси-сервера;
* порты прокси-сервера;
* проверка SSL.

#### <a name="2a-proxy-outbound-rules"></a>2A. Правила для исходящих подключений прокси-сервера
Разрешите доступ к следующих конечным точкам, чтобы получить доступ к службе соединителя:

* *.msappproxy.net; 
* *.servicebus.microsoft.net. 

Для первоначальной регистрации разрешите доступ к следующим конечным точкам:

* login.windows.net 
* login.microsoftonline.com. 

Базовые каналы управления служебной шины, используемые службой соединителя, требуют дополнительного подключения по конкретным IP-адресам. Обратите внимание, что мы работаем совместно со службой поддержки служебной шины, чтобы в будущем использовать полное доменное имя. Однако на данный момент существует два варианта: 
 
* разрешить соединителю получать исходящий доступ ко всем местам назначения;
* разрешить соединителю получать исходящий доступ по диапазону IP-адресов центра данных Azure, указанных на сайте по адресу https://www.microsoft.com/en-gb/download/details.aspx?id=41653.

>[!NOTE]
>Проблема использования списка диапазонов IP-адресов центра данных Azure состоит в том, что каждую неделю он обновляется, поэтому вам необходимо реализовать механизм обновления правил соответствующим образом.
>

#### <a name="2b-proxy-authentication"></a>2Б. Проверка подлинности прокси-сервера

Проверка подлинности прокси в настоящее время не поддерживается. Сейчас мы рекомендуем разрешить соединителю получать анонимный доступ к определенному сайту Интернета.

#### <a name="2c-proxy-ports"></a>2В. Порты прокси-сервера

Соединитель устанавливает исходящие SSL-подключения, используя метод CONNECT. По сути он настраивает туннель через исходящий прокси-сервер. По умолчанию некоторые прокси-серверы разрешают только исходящее туннелирование к стандартным портам SSL, например 443. Если это так, необходимо настроить прокси-сервер, чтобы разрешить туннелирование к дополнительным портам.

Настройте прокси-сервер, чтобы разрешить туннелирование к нестандартным портам SSL 8080, 9090, 9091 и 10100–10120.

>[!NOTE]
>При запуске служебной шины по протоколу HTTPS используется порт 443. Тем не менее по умолчанию служебная шина попытается использовать прямые TCP-подключения и вернется к протоколу HTTPS только при сбое прямого подключения. 
> 

Чтобы проверить, отправляется ли трафик служебной шины через исходящий прокси-сервер, убедитесь, что соединитель не может напрямую подключиться к службам Azure для портов 9350, 9352 и 5671.

#### <a name="2d-ssl-inspection"></a>2Г. Проверка SSL
Для трафика соединителя не стоит использовать проверку SSL, так как это вызовет проблемы. 

Вот и все. Теперь весь трафик должен проходить через прокси-сервер. Если возникли проблемы, выполните следующие действия по устранению неполадок.

### <a name="troubleshoot-connector-proxy-problems-and-service-connectivity-issues"></a>Устранение неполадок соединителя прокси-сервера и проблем с подключением к службе

Лучший способ определения и устранения проблем с подключением соединителя — это выполнить сбор данных о сети в службе соединителя во время ее запуска. Это может оказаться непростой задачей, так что давайте рассмотрим советы по сбору и фильтрации данных трассировки сети.

Вы можете использовать выбранное средство мониторинга. В рамках этой статьи мы использовали Microsoft Network Monitor 3.4, который можно скачать по адресу https://www.microsoft.com/en-us/download/details.aspx?id=4865.

Примеры и фильтры, которые использовались ниже, относятся к сетевому монитору, однако принципы работы можно применять к любому инструменту анализа.

### <a name="take-a-capture-using-microsoft-network-monitor"></a>Сбор данных с помощью Microsoft Network Monitor

Чтобы начать сбор данных, откройте сетевой монитор и щелкните New Capture (Новая запись). Затем нажмите кнопку "Пуск", чтобы начать.

 ![Сетевой монитор Azure AD](./media/application-proxy-working-with-proxy-servers/network-capture.png)

По завершении сбора данных нажмите кнопку "Стоп", чтобы завершить сбор.

### <a name="take-a-capture-of-connector-traffic"></a>Сбор трафика соединителя

Для первоначального устранения неполадок сделайте следующее: 

1. В services.msc остановите работу службы соединителя прокси приложения Microsoft AAD (как показано ниже).
2. Запустите сбор данных о сети.
3. Запустите службу соединителя прокси приложения Microsoft AAD.
4. Остановите запись данных о сети.

 ![Сетевой монитор Azure AD](./media/application-proxy-working-with-proxy-servers/services-local.png)

### <a name="look-at-the-connector-to-proxy-server-requests"></a>Просмотр запросов соединителей к прокси-серверу

Теперь, когда у вас есть данные о сети, вы можете отфильтровать их. Основным моментом в трассировке является умение фильтровать собранные данные.

Для этого используется следующий фильтр (где 8080 — это порт службы прокси-сервера): 

(http.Request или http.Response) и tcp.port==8080

Если ввести этот фильтр в окне Display Filter (Отобразить фильтр) и щелкнуть "Применить", он отфильтрует собранный трафик соответствующим образом.

При фильтрации с использованием фильтра, указанного выше, отобразятся только HTTP-запросы и ответы для порта прокси-сервера и его ответы. Для запуска соединителя, настроенного для использования прокси-сервера, фильтрация будет выглядеть примерно следующим образом:

 ![Сетевой монитор Azure AD](./media/application-proxy-working-with-proxy-servers/http-requests.png)

Теперь нужно найти запросы CONNECT, в которых видно, что мы обращаемся к прокси-серверу. В случае успеха вы получите ответ OK с HTTP-кодом&200;.

Если отобразятся другие коды ответов, например 407 или 502, это означает, что прокси-сервер требует проверки подлинности или не разрешает передачу трафика по другой причине. На этом этапе следует обратиться в службу поддержки прокси-сервера.

### <a name="identify-failed-tcp-connection-attempts"></a>Выявление неудачных попыток подключения TCP

Другой распространенный сценарий, который может вас заинтересовать, это когда соединитель не может подключиться напрямую. 

Ниже представлен еще один пример фильтра сетевого монитора, который позволяет легко определить такую проблему.

property.TCPSynRetransmit

Пакет SYN — это первый пакет, отправленный для установления подключения TCP. Если при этом ответ не возвращается, пакет SYN отправляется еще раз. Фильтр, указанный ранее, позволяет увидеть все повторно передаваемые пакеты SYN. Затем можно узнать, соответствуют ли они трафику соединителя. 

В следующем примере показана ошибка при попытке подключения к порту 9352 служебной шины:

 ![Сетевой монитор Azure AD](./media/application-proxy-working-with-proxy-servers/failed-connection-attempt.png)

Если вы видите ответ, аналогичный указанному выше, это означает, что соединитель пытается взаимодействовать со службой служебной шины Azure напрямую. Если соединитель должен подключаться к службам Azure напрямую, сразу становится понятно, что возникла проблема в сети или брандмауэре.

>[!NOTE]
>Если вы используете прокси-сервер, следует помнить, что служебная шина может использовать прямое подключение TCP, прежде чем перейти к подключению по протоколу HTTPS.
>

Анализ трассировки сети — не идеальное решение. Однако он может быть чрезвычайно ценным средством, позволяющим быстро получить сведения о том, что происходило с вашей сетью. 

Если проблема с подключением соединителя не исчезла, отправьте запрос в службу технической поддержки. Мы с радостью поможем вам устранить неполадки.

Сведения об устранении ошибок соединителя прокси приложения см. в [этой статье](https://azure.microsoft.com/en-us/documentation/articles/active-directory-application-proxy-troubleshoot).

## <a name="next-steps"></a>Дальнейшие действия

[Сведения о соединителях прокси приложения Azure AD](application-proxy-understand-connectors.md)<br>
[Автоматическая установка соединителя прокси приложения Azure AD](active-directory-application-proxy-silent-installation.md)







<!--HONumber=Feb17_HO1-->


