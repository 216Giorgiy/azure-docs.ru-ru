<properties
	pageTitle="Обработка ошибок в OAuth 2.0 | Microsoft Azure"
	description="В этой статье описываются распространенные классы ошибок при авторизации OAuth 2.0 с помощью Azure Active Directory и рекомендации по их обработке."
	services="active-directory"
	documentationCenter=".net"
	authors="priyamohanram"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/31/2016"
	ms.author="priyamo"/>

# Обработка ошибок в OAuth 2.0

[AZURE.INCLUDE [active-directory-protocols](../../includes/active-directory-protocols.md)]

В этой статье мы рассмотрим некоторые рекомендации по обработке распространенных классов ошибок, которые могут возникнуть при авторизации приложения с помощью Azure Active Directory (Azure AD). Дополнительные сведения о конечной точке авторизации и конечной точке выдачи маркера см. в статье [Authentication flow for an application in Azure AD](active-directory-protocols-oauth-code.md) (Поток проверки подлинности для приложения в Azure AD).

## Ошибки конечной точки авторизации

На первом этапе авторизации клиентское приложение отправляет запрос в конечную точку `/authorize` Azure AD со списком необходимых для него разрешений пользователя.

Ошибки конечной точки авторизации происходят в конечной точке `/authorize`. Эти ошибки возвращаются либо как ошибки HTTP 200 на веб-странице, либо с использованием кода перенаправления HTTP 302, когда клиентское приложение доступно для обработки ошибки.

Ниже приведен пример ответа с кодом ошибки HTTP 302 из конечной точки авторизации Azure AD, когда в запросе отсутствует обязательный параметр `response_type`.

```
GET  HTTP/1.1 302 Found
Location: http://localhost/myapp/?error=invalid_request&error_description=AADSTS90014%3a+The+request+body+must+contain+the+following+parameter%3a+%27response_type%27.%0d%0aTrace+ID%3a+57f5cb47-2278-4802-a018-d05d9145daad%0d%0aCorrelation+ID%3a+570a9ed3-bf1d-40d1-81ae-63465cc25488%0d%0aTimestamp%3a+2013-12-31+05%3a51%3a35Z&state=D79E5777-702E-4260-9A62-37F75FF22CCE
```

| Параметр | Описание |
|-----------|-------------|
| error | Значение кода ошибки, определенное в разделе 5.2 документации по [OAuth 2.0 Authorization Framework](http://tools.ietf.org/html/rfc6749). В следующей таблице описаны коды ошибок, которые возвращает Azure AD. |
| error\_description | Более подробное описание ошибки. Это сообщение не должно быть понятным для пользователей. |
| state | Значение состояния — это случайно сгенерированное значение без возможности повторного использования. Оно отправляется в запросе и возвращается в ответе для предотвращения атак с подделкой межсайтовых запросов. |

### Коды ошибок конечной точки авторизации

В следующей таблице описаны различные коды ошибок, которые могут быть возвращены в параметре `error` ответа с ошибкой.

| Код ошибки | Описание | Действие клиента |
|------------|-------------|---------------|
| invalid\_request | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая, как правило, обнаруживается во время первоначального тестирования.|
| unauthorized\_client | Клиентскому приложению не разрешено запрашивать код авторизации. | Как правило, это происходит, если клиентское приложение не зарегистрировано в Azure AD или не добавлено в клиент Azure AD пользователя. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| access\_denied | Владелец ресурса отказал в использовании | Клиентское приложение может уведомить пользователя, что не может продолжить работу без согласия пользователя. |
| unsupported\_response\_type | Сервер авторизации не поддерживает тип ответа в запросе. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая, как правило, обнаруживается во время первоначального тестирования.|
|server\_error | Сервер обнаружил непредвиденную ошибку. | Повторите запрос. Эти ошибки могут возникать в связи с временными условиями. Клиентское приложение может отобразить для пользователя сообщение о том, что его ответ задерживается из-за временной ошибки. |
| temporarily\_unavailable | Сервер временно занят и не может обработать запрос. | Повторите запрос. Клиентское приложение может отобразить для пользователя сообщение о том, что его ответ задерживается из-за временных условий. |
| invalid\_resource |Целевой ресурс недопустим, так как он не существует. Azure AD не удается найти ресурс, или он настроен неправильно.| Это означает, что ресурс, если он существует, не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |

## Ошибки конечной точки выдачи маркера

После получения кода авторизации из конечной точки `/authorize` приложение передает его в конечную точку `/token`, чтобы получить маркер доступа для указанного ресурса.

Ошибки конечной точки выдачи маркера происходят в конечной точке `/token`. Это коды ошибок HTTP, так как клиент вызывает конечную точку выдачи маркера напрямую. В дополнение к коду состояния HTTP конечная точка выдачи маркера Azure AD также возвращает документ JSON с объектами, описывающими ошибку.

Например, если в запросе параметр `client_id` недопустим, ошибка может выглядеть следующим образом:

```
HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=utf-8

{"error":"invalid_request","error_description":"AADSTS90011: Request is ambiguous, multiple application identifiers found. Application identifiers: '197451ec-ade4-40e4-b403-02105abd9049, 597451ec-ade4-40e4-b403-02105abd9049'.\r\nTrace ID: 4457d068-2a03-42b2-97f2-d55325289d86\r\nCorrelation ID: 6b3474d8-233e-463f-b0a3-86433d8ba889\r\nTimestamp: 2013-12-31 06:31:41Z","error_codes":[90011],"timestamp":"2013-12-31 06:31:41Z","trace_id":"4457d068-2a03-42b2-97f2-d55325289d86","correlation_id":"6b3474d8-233e-463f-b0a3-86433d8ba889"}
```
### Коды состояния HTTP

В следующей таблице представлены коды состояния HTTP, которые возвращает конечная точка выдачи маркера. В некоторых случаях кода ошибки достаточно для описания ответа, но в случае получения ошибки необходимо проанализировать соответствующий документ JSON и изучить его код ошибки.

| Код HTTP | Описание |
|-----------|-------------|
| 400 | Код HTTP по умолчанию. Используется в большинстве случаев, и, как правило, его получают из-за неправильного формата запроса. Исправьте запрос и отправьте его повторно. |
| 401 | Сбой проверки подлинности. Например, в запросе отсутствует параметр client\_secret.|
| 403 | Ошибка авторизации. К примеру, у пользователя нет разрешения на доступ к ресурсу. |
| 500 | Произошла внутренняя ошибка в службе. Повторите запрос. |

### Объекты документа JSON в ответе с ошибкой

| Объект JSON | Описание |
|-------------|-------------|
| error | Значение кода ошибки, определенное в разделе 5.2 документации по [OAuth 2.0 Authorization Framework](http://tools.ietf.org/html/rfc6749). В следующей таблице описаны коды ошибок, которые возвращает Azure AD. |
| error\_description | Более подробное описание ошибки. Это сообщение не должно быть понятным для пользователей. |
| Timestamp | Дата и время, когда произошла ошибка, в формате UTC. |
| trace\_id | Идентификатор, по которому определяется трассировка ошибок. |
| correlation\_id | 	Значение, которое создает клиент. Этот идентификатор добавляется в документ JSON об ошибке, если в запросе к конечной точке выдачи маркера это значение добавлено в заголовок `client-request-id`. Этот идентификатор может использоваться для других вызовов в одном и том же сеансе. |
| error\_codes | Содержит список кодов ошибок, которые соответствуют различным условиям работы. Не используйте эти коды в логике приложения. Тем не менее их можно использовать для диагностики проблемы и поиска информации в Интернете по коду ошибки. |

### Значения кодов ошибок в документе JSON

| Код ошибки | Описание | Действие клиента |
|------------|-------------|---------------|
| invalid\_request | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно. |
| invalid\_grant | Предоставление авторизации (его параметры) или маркер обновления недействительны, просрочены либо отозваны. | Исправьте запрос и отправьте его повторно. |
| unauthorized\_client | У клиента, прошедшего проверку подлинности, нет прав на использование этого типа предоставления авторизации. | Как правило, это происходит, если клиентское приложение не зарегистрировано в Azure AD или не добавлено в клиент Azure AD пользователя. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| invalid\_client | Сбой проверки подлинности клиента. | Недопустимые учетные данные клиента. Чтобы устранить проблему, администратору приложения необходимо обновить учетные данные. |
| unsupported\_grant\_type | Сервер авторизации не поддерживает тип предоставления авторизации. | Измените тип предоставления в запросе. Ошибка этого типа должна происходить только во время разработки, и ее должны обнаружить при первоначальном тестировании. |
| invalid\_resource | Целевой ресурс недопустим, так как он не существует. Azure AD не удается найти ресурс, или он настроен неправильно. | Это означает, что ресурс, если он существует, не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| interaction\_required | Для запроса требуется взаимодействие с пользователем. К примеру, требуется дополнительный шаг проверки подлинности. | Выполните запрос снова, используя тот же ресурс. |
| temporarily\_unavailable | Сервер временно занят и не может обработать запрос. | Повторите запрос. Клиентское приложение может отобразить для пользователя сообщение о том, что его ответ задерживается из-за временных условий.|

## Ошибки из защищенных ресурсов

Возникли ошибки, которые может вернуть защищенный ресурс, например веб-API, если он реализует спецификацию [RFC 6750](http://tools.ietf.org/html/rfc6750) OAuth 2.0 Authorization Framework.

Защищенные ресурсы, которые реализуют спецификацию RFC 6750, выдают коды состояния HTTP. Если запрос не содержит учетные данные проверки подлинности или маркер, в ответе будет содержаться заголовок `WWW-Authenticate`. Если запрос завершился сбоем, сервер ресурсов отправит ответ с кодом состояния HTTP и кодом ошибки.

Ниже приведен пример неудачного ответа, когда клиентский запрос не содержит токен носителя:

```
HTTP/1.1 401 Unauthorized
WWW-Authenticate: Bearer authorization_uri="https://login.window.net/contoso.com/oauth2/authorize",  error="invalid_token",  error_description="The access token is missing.",
```

## Параметры ошибок

| Параметр | Описание |
|-----------|-------------|
| authorization\_uri | Универсальный код ресурса (URI) (физическая конечная точка) сервера авторизации. Это значение также используется в качестве ключа поиска для получения дополнительных сведений о сервере из конечной точки обнаружения. <p><p> Клиент должен проверить, является ли сервер авторизации доверенным. Если ресурс защищен с помощью Azure AD, достаточно убедиться, что URL-адрес начинается с https://login.windows.net или другого имени узла, поддерживаемого Azure AD. Клиентский ресурс всегда должен возвращать URI авторизации определенного клиента. |
| error | Значение кода ошибки, определенное в разделе 5.2 документации по [OAuth 2.0 Authorization Framework](http://tools.ietf.org/html/rfc6749).|
| error\_description | Более подробное описание ошибки. Это сообщение не должно быть понятным для пользователей.|
| resource\_id | Возвращает уникальный идентификатор ресурса. Клиентское приложение может использовать этот идентификатор в качестве значения параметра `resource`, запрашивая маркер для ресурса. <p><p> Очень важно, чтобы клиентское приложение проверяло это значение, в противном случае вредоносная служба сможет использовать атаку **повышения привилегий**. <p><p> Для предотвращения атак рекомендуется, чтобы значение `resource_id` соответствовало базовому URL-адресу веб-API, к которому выполняется доступ. Например, при доступе к https://service.contoso.com/data параметр `resource_id` может иметь значение htttps://service.contoso.com/. Клиентское приложение должно отклонять `resource_id`, если это значение не начинается с базового URL-адреса и у вас нет возможности проверить идентификатор другим способом. |

## Коды ошибок схемы носителя

В спецификации RFC 6750 определены следующие ошибки для ресурсов, использующих в ответе заголовок WWW-Authenticate и схему носителя.

| Код состояния HTTP | Код ошибки | Описание | Действие клиента |
|------------------|------------|-------------|---------------|
| 400 | invalid\_request | У запроса неправильный формат. Например, в нем может отсутствовать параметр или один и тот же параметр может использоваться дважды. | Исправьте ошибку и повторите запрос. Ошибка этого типа должна происходить только во время разработки, и ее должны обнаружить при первоначальном тестировании. |
| 401 | invalid\_token | Маркер доступа отсутствует, недопустим или отменен. Значение параметра error\_description содержит дополнительные сведения. | Запросите новый маркер из сервера авторизации. Если произойдет сбой нового маркера, это значит, что произошла непредвиденная ошибка. Отправьте пользователю сообщение об ошибке и повторите попытку через произвольные промежутки времени. |
| 403 | insufficient\_scope | Маркер доступа не содержит разрешения на олицетворение, необходимые для доступа к ресурсу. | Отправьте новый запрос авторизации в конечную точку авторизации. Если в ответе содержится параметр области, используйте значение области в запросе к ресурсу. |
| 403 | insufficient\_access | У субъекта маркера нет разрешений, необходимых для доступа к ресурсу. | Предложите пользователю использовать другую учетную запись или запросите разрешения для указанного ресурса. |

<!---HONumber=AcomDC_0608_2016-->