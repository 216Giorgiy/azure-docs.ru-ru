
<properties
	pageTitle="Настройка локального условного доступа с помощью регистрации устройств в Azure Active Directory | Microsoft Azure"
	description="Пошаговое руководство по включению условного доступа к локальным приложениям с помощью служб федерации Active Directory (AD FS) в Windows Server 2012 R2."
	services="active-directory"
	documentationCenter=""
	authors="femila"
	manager="stevenpo"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/19/2015"
	ms.author="femila"/>

# Настройка локального условного доступа с помощью регистрации устройств в Azure Active Directory

Личные устройства пользователей можно помечать как известные организации. Для этого они должны ввести свои устройства в рабочую область в службе регистрации устройств Azure Active Directory. Ниже приведено пошаговое руководство по включению условного доступа к локальным приложениям с помощью служб федерации Active Directory (AD FS) в Windows Server 2012 R2.

> [AZURE.NOTE]При использовании устройств, зарегистрированных в политиках условного доступа службы регистрации устройств Azure Active Directory, требуется лицензия Office 365 или Azure AD Premium. Сюда относятся политики, применяемые службами федерации Active Directory к локальным ресурсам.

Узнать больше о сценариях условного доступа к локальной среде можно в разделе [Подключение к рабочему месту с любого устройства для реализации единого входа и эффективная двухфакторная аутентификация в приложениях компании](https://technet.microsoft.com/library/dn280945.aspx).

Эти возможности доступны клиентам, купившим лицензию Azure Active Directory Premium.

Поддерживаемые устройства
-------------------------------------------------------------------------
* Присоединенные к домену устройства Windows 7.
* Персональные и присоединенные к домену устройства Windows 8.1.
* iOS 6 или более поздней версии для браузера Safari
* Устройства Android 4.0 или более поздней версии, телефоны Samsung GS3 или более поздней версии, планшеты Samsung Note2 или более поздней версии.


Предварительные условия (и необходимые компоненты) для сценария
------------------------------------------------------------------------
* Подписка на Office 365 или Azure Active Directory Premium.
* Клиент Azure Active Directory.
* Windows Server Active Directory (Windows Server 2008 или более поздней версии).
* Обновленная схема в Windows Server 2012 R2.
* Подписка на Azure Active Directory Premium.
* Службы федерации Windows Server 2012 R2, настроенные для единого входа в Azure AD.
* Прокси-сервер веб-приложений Windows Server 2012 R2 с Microsoft Azure Active Directory Connect (Azure AD Connect). [Azure AD Connect можно загрузить здесь](http://www.microsoft.com/ru-RU/download/details.aspx?id=47594).
* Проверенный домен. 

Известные проблемы в этом выпуске
-------------------------------------------------------------------------------
* Для политик условного доступа на основе устройств требуется обратная запись объектов устройств в Active Directory из Azure Active Directory. Обратная запись объектов устройств в Active Directory может занять до 3 часов.
* Устройства iOS7 всегда помогут пользователю выбрать сертификат во время аутентификации сертификата клиента. 
* Некоторые версии iOS8 до iOS 8.3 не работают. 

## Принятые в сценарии допущения
Данный сценарий предполагает, что у вас есть гибридная среда, состоящая из клиента Azure AD и локальной службы Active Directory. Эти клиенты должны быть подключены с использованием Azure AD Connect, а также проверенного домена и AD FS для единого входа. Приведенный ниже контрольный список поможет вам настроить среду для описанного выше этапа.

Контрольный список: предварительные условия для сценария условного доступа
--------------------------------------------------------------
Подключите клиент Azure AD к локальной службе Active Directory.

## Настройка службы регистрации устройств Azure Active Directory
Используйте это руководство для развертывания и настройки службы регистрации устройств Azure Active Directory для своей организации.

В этом руководстве предполагается, что вы уже настроили Windows Server Active Directory и получили подписку на Microsoft Azure Active Directory. См. предварительные требования выше.

Чтобы развернуть службу регистрации устройств Azure Active Directory со своим именем клиента Azure Active Directory, по порядку выполните задачи из приведенного ниже контрольного списка. Если ссылка приведет вас на концептуальную статью, вернитесь к этому контрольному списку после ее просмотра, чтобы вы могли продолжить выполнять оставшиеся задачи контрольного списка. В некоторые задачи входит проверка сценария, которая поможет подтвердить успешность выполнения шага.

## Часть 1. Включение регистрации устройств в Azure Active Directory

Чтобы включить и настроить службу регистрации устройств Azure Active Directory, следуйте приведенному ниже контрольному списку.

| Задача | Справочные материалы |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
| Чтобы позволить устройствам присоединяться к рабочей области, включите регистрацию устройств в своем клиенте Azure Active Directory. По умолчанию многофакторная проверка подлинности для службы не включена. Однако ее рекомендуется использовать при регистрации устройства. Перед включением многофакторной проверки подлинности в ADRS убедитесь в том, что для служб федерации Active Directory настроен поставщик Multi-Factor Authentication. | [Включение регистрации устройств в Azure Active Directory](active-directory-conditional-access-device-registration-overview.md) |
| Устройства будут обнаруживать вашу службу регистрации устройств в Azure Active Directory, просматривая хорошо известные записи DNS. Вы должны настроить DNS своей организации таким образом, чтобы устройства могли обнаруживать вашу службу регистрации устройств Azure Active Directory. | [Настройка обнаружения службы регистрации устройств Azure Active Directory](active-directory-conditional-access-device-registration-overview.md) |

##Часть 2. Развертывание и настройка служб федерации Windows Server 2012 R2 Active Directory и настройка отношений федерации с Azure Active Direct


| Задача | Справочные материалы |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
| Разверните домен доменных служб Active Directory с помощью расширений схемы Windows Server 2012 R2. Обновлять контроллеры домена до Windows Server 2012 R2 не требуется. Единственное требование — это обновление схемы. | [Обновление схемы доменных служб Active Directory] (#Обновление схемы доменных служб Active Directory) |
| Устройства будут обнаруживать вашу службу регистрации устройств в Azure Active Directory, просматривая хорошо известные записи DNS. Вы должны настроить DNS своей организации таким образом, чтобы устройства могли обнаруживать вашу службу регистрации устройств Azure Active Directory. | [Подготовка Active Directory к поддержке устройств] (#Подготовка Active Directory к поддержке устройств) |


##Часть 3. Включение обратной записи устройств в Azure AD

| Задача | Справочные материалы |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|
| Выполните часть 2 включения обратной записи устройств в службе Azure AD Connect. Закончив, вернитесь к данному руководству. | [Включение обратной записи устройств в Azure AD Connect] (#Обновление схемы доменных служб Active Directory) |
	 

##[Необязательно] Часть 4. Включение многофакторной проверки подлинности

Настоятельно рекомендуется настроить один из нескольких вариантов многофакторной проверки подлинности. Инструкции по включению многофакторной проверки подлинности см. в статье [Выбор решения многофакторной безопасности](multi-factor-authentication-get-started.md). Она содержит описание каждого решения, а также ссылки, которые помогут вам настроить выбранное решение.

## Часть 5. Проверка

Развертывание завершено. Теперь можно опробовать некоторые сценарии. Воспользуйтесь приведенными ниже ссылками, чтобы поэкспериментировать со службой и ознакомиться с ее функциональными возможностями.


| Задача | Справочные материалы |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------|
| Присоединение нескольких устройств к рабочей области путем их регистрации в Active Directory Azure. Присоединять можно устройства iOS, Windows и Android. | [Присоединение устройств к рабочей области путем их регистрации в Azure Active Directory] (#Присоединение устройств к рабочей области путем их регистрации в Azure Active Directory) |
| Просматривать, а также включать и отключать зарегистрированные устройства можно с помощью портала администрирования. В этой задаче вы просмотрите несколько зарегистрированных устройств на портале администрирования. | [Общие сведения о регистрации устройств Azure Active Directory](active-directory-conditional-access-device-registration-overview.md) |
| Убедитесь, что объекты-устройства подвергаются обратной записи из Azure Active Directory в Windows Server Active Directory. | [Проверка обратной записи зарегистрированных устройств в Active Directory] (#Проверка обратной записи зарегистрированных устройств в Active Directory) |
| Теперь, когда у пользователей появилась возможность регистрировать устройства, можно создать политики доступа к приложениям в AD FS, позволяющие использовать только зарегистрированные устройства. В этой задаче вы создадите правило доступа к приложениям и пользовательское сообщение об отказе в доступе. | [Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе] (#Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе) |



## Интеграция Azure Active Directory с локальной службой Active Directory
Данный раздел поможет вам интегрировать клиент Azure AD с локальной службой Active Directory, используя Azure AD Connect. Несмотря на то что описанные действия можно выполнить на портале Azure, обратите внимание на особые указания.

1.	Войдите на портал Azure как администратор.
2.	На панели слева выберите **Active Directory**.
3.	На вкладке **Каталог** выберите требуемый каталог.
4.	Выберите вкладку **Интеграция каталогов**.
5.	В разделе **Развертывание и управление** повторите шаги с 1 по 3, чтобы интегрировать Azure Active Directory с локальным каталогом.
  1.	Добавьте домены.
  2.	Установите и запустите Azure AD Connect. Для установки Azure AD Connect выполните следующие инструкции: [Выборочная установка Azure AD Connect](active-directory-aadconnect-get-started-custom.md).
  3. Выполните проверку и управление синхронизацией каталогов. Инструкции по единому входу будут представлены на следующем этапе. >[AZURE.NOTE]Настройте федерацию с AD FS, как описано в документе по указанной выше ссылке. >[AZURE.NOTE]Функции предварительного просмотра настраивать не нужно.
  
   


## Обновление схемы доменных служб Active Directory
> [AZURE.NOTE]Обновление схемы Active Directory нельзя будет отменить. Рекомендуется сначала выполнить это действие в тестовой среде.

1. Войдите на свой контроллер домена, используя учетную запись, которая имеет права и администратора предприятия, и администратора схемы.
2. Скопируйте каталог **[среда]\\support\\adprep** вместе с подкаталогами в один из контроллеров домена Active Directory. 
3. Здесь [среда] — это путь к установочному носителю Windows Server 2012 R2.
4. Из командной строки перейдите в каталог adprep и выполните команду **adprep.exe /forestprep**. Следуйте указаниям на экране, чтобы завершить обновление схемы.

## Подготовка Active Directory к поддержке устройств
>[AZURE.NOTE]Это — одноразовая операция, которую следует провести, чтобы подготовить лес Active Directory к поддержке устройств. Чтобы выполнить эту процедуру, вы должны войти в систему с правами администратора предприятия, и ваш лес Active Directory должен иметь схему Windows Server 2012 R2.


##Подготовка леса Active Directory к поддержке устройств

> [AZURE.NOTE]Это — одноразовая операция, которую следует провести, чтобы подготовить лес Active Directory к поддержке устройств. Чтобы выполнить эту процедуру, вы должны войти в систему с правами администратора предприятия, и ваш лес Active Directory должен иметь схему Windows Server 2012 R2.

### Подготовка леса Active Directory

1.	На своем сервере федерации откройте командное окно Windows PowerShell и введите следующую команду: Initialize-ADDeviceRegistration
2.	После появления запроса на **ServiceAccountName** (имя учетной записи службы) введите имя учетной записи службы, которую вы выбрали в качестве учетной записи службы для AD FS. Если это групповая управляемая учетная запись службы (gMSA), введите учетную запись в формате **домен\\имя\_учетной\_записи$**. Для доменной учетной записи используйте формат **домен\\имя\_учетной\_записи**.



### Включение аутентификации устройств в AD FS

1. На своем сервере федерации откройте консоль управления AD FS и последовательно выберите пункты **AD FS** > **Политики проверки подлинности**.
2. Выберите пункт **Редактировать глобальную основную проверку подлинности…** на панели **Действия**.
3. Установите флажок **Включить проверку подлинности устройств** и нажмите кнопку **ОК**.
4. По умолчанию AD FS будет периодически удалять неиспользуемые устройства из Active Directory. Вы должны отключить эту задачу во время использования службы регистрации устройств Azure Active Directory, чтобы устройствами можно было управлять в Azure.


### Отключение удаления неиспользуемых устройств
1. На своем сервере федерации откройте командное окно Windows PowerShell и введите следующую команду: Set-AdfsDeviceRegistration -MaximumInactiveDays 0

### Подготовка Azure AD Connect к обратной записи устройства

1.	Выполните часть 1 "Подготовка AAD Connect". 


## Присоединение устройств к рабочей области с помощью регистрации устройств в Active Directory Azure

### Присоединение устройства iOS с помощью регистрации устройств в Active Directory Azure

Для устройств iOS служба регистрации устройств Azure Active Directory использует беспроводную регистрацию. Этот процесс начинается, когда пользователь подключается по URL-адресу регистрации профиля с помощью веб-браузера Safari. Используется следующий формат URL-адреса:

    https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/"yourdomainname"

где `yourdomainname` — это доменное имя, которое вы настроили в Azure Active Directory. Например, если ваше доменное имя — contoso.com, URL-адрес будет следующим:

    https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/contoso.com

Есть много различных способов сообщить этот URL-адрес своим пользователям. Один из рекомендуемых способов — опубликовать этот URL-адрес в пользовательском сообщении об отказе в доступе в AD FS. Об этом говорится в следующем разделе: [Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе] (#Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе).

###Присоединение устройства Windows 8.1 с помощью регистрации устройств в Active Directory Azure

1. На устройстве Windows 8.1 последовательно выберите пункты **Параметры компьютера** > **Сеть** > **Рабочая область**.
2. Введите свое имя пользователя в формате имени участника-пользователя. Пример: dan@contoso.com..
3. Выберите **Присоединиться**.
4. При появлении запроса введите свои учетные данные и выполните вход. Теперь устройство присоединено.

### Присоединение устройства Android с помощью регистрации устройств в Active Directory Azure

В разделе [Azure Authenticator для Android](active-directory-conditional-access-azure-authenticator-app.md) приведены указания по установке приложения Azure Authenticator на устройство Android и добавлению рабочей учетной записи. После успешного создания рабочей учетной записи на устройстве Android оно присоединяется к рабочей области организации.

## Проверка обратной записи зарегистрированных устройств в Active Directory
Просмотреть и убедиться, что объекты устройств были записаны в Active Directory посредством обратной записи, можно с помощью LDP.exe и ADSI Edit. Оба приложения доступны в инструментах для администратора Active Directory.

По умолчанию объекты устройств, которые были записаны из Azure Active Directory посредством обратной записи, будут размещаться том же домене, что и ваша ферма AD FS.

    CN=RegisteredDevices,defaultNamingContext

## Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе
Рассмотрим следующий сценарий. Вы создаете в AD FS отношение доверия с проверяющей стороной для приложения и настраиваете правило авторизации выпуска, которое будет разрешать доступ только для зарегистрированных устройств. Теперь только зарегистрированные устройства могут иметь доступ к приложению. Чтобы облегчить пользователям доступ к приложению, настройте пользовательское сообщения об отказе в доступе, которое содержит указания по присоединению устройства. Теперь у ваших пользователей есть удобный способ зарегистрировать свои устройства, чтобы получить доступ к приложению.

Следующие действия демонстрируют, как реализовать такой сценарий.
>[AZURE.NOTE]В этом разделе предполагается, что вы уже настроили отношение доверия с проверяющей стороной для приложения в AD FS.

1. Откройте инструмент MMC в AD FS и перейдите к «AD FS» > «Отношения доверия» > «Отношения доверия с проверяющей стороной».
2. Найдите приложение, к которому будет применяться это новое правило доступа. Щелкните правой кнопкой мыши приложение и выберите «Изменить правила утверждения…».
3. Выберите вкладку **Правила авторизации выпуска**, а затем **Добавить правило…**.
4. Из раскрывающегося списка шаблонов **Правило для утверждений** выберите **Разрешать или запрещать доступ пользователям в зависимости от входящего утверждения**. Нажмите кнопку **Далее**.
5. В поле "Имя правила для утверждений:" введите **Разрешить доступ с зарегистрированных устройств**.
6. В раскрывающемся списке "Тип входящего утверждения:" выберите **Зарегистрированный пользователь**.
7. В поле "Тип входящего утверждения:" введите **true**.
8. Установите переключатель **Разрешить доступ пользователям с этим входящим утверждением**.
9. Нажмите кнопку **Готово**, а затем **Применить**.
10. Удалите все правила, которые разрешают больше, чем правило, которое было создано только что. Например, удалите правило по умолчанию **Разрешить доступ всем пользователям**.

Ваше приложение сейчас настроено разрешать доступ, только если пользователь заходит с устройства, которое зарегистрировано и присоединено к рабочей области. Информацию о более сложных политиках доступа см. в статье [Управление риском с помощью многофакторного контроля доступа](https://technet.microsoft.com/ru-RU/library/dn280949.aspx).

Далее, вы настроите пользовательское сообщение об ошибке для своего приложения. Сообщение об ошибке даст пользователям понять, что они должны присоединить свое устройство к рабочей области, прежде чем получат доступ к приложению. Вы можете создать пользовательское сообщение об отказе в доступе с помощью пользовательского кода HTML и Windows PowerShell.

На своем сервере федерации откройте командное окно Windows PowerShell и введите следующую команду. Замените части команды элементами, относящимися к вашей системе.

    Set-AdfsRelyingPartyWebContent -Name "relying party trust name" -ErrorPageAuthorizationErrorMessage
Для доступа к этому приложению необходимо зарегистрировать устройство.

**Если вы используете устройство iOS, выберите эту ссылку для присоединения устройства**:

    a href='https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/yourdomain.com

Присоединить это устройство iOS к рабочей области.


**Если вы используете устройство Windows 8.1**, то можете присоединить устройство, выбрав **Параметры компьютера** > **Сеть** > **Рабочая область**.


Где **relying party trust name** — это имя объекта отношений доверия с проверяющей стороной вашего приложения в AD FS. А **yourdomain.com** — это доменное имя, которое вы настроили в Azure Active Directory. Например, contoso.com. Удостоверьтесь, что удалили все разрывы строк (если они были) из содержимого HTML, которое передаете в командлет **Set-AdfsRelyingPartyWebContent**.


Теперь, обратившись к приложению с устройства, не зарегистрированного в службе регистрации устройств Azure Active Directory, пользователи будут попадать на страницу следующего вида:

![Снимок экрана с ошибкой, возникающей, если пользователь еще не зарегистрировал свое устройство в Azure AD](./media/active-directory-conditional-access/error-azureDRS-device-not-registered.gif)

<!---HONumber=Sept15_HO3-->