---
title: "Управляемое удостоверение службы (MSI) для Azure Active Directory"
description: "Обзор применения управляемого удостоверения службы (MSI) для ресурсов Azure."
services: active-directory
documentationcenter: 
author: daveba
manager: mtillman
editor: 
ms.service: active-directory
ms.devlang: 
ms.topic: article
ms.tgt_pltfrm: 
ms.workload: identity
ms.date: 12/15/2017
ms.author: daveba
ms.reviewer: skwan
ROBOTS: NOINDEX,NOFOLLOW
ms.openlocfilehash: 95980c082b09ad959ab8bbaae0250b40ac08d2c8
ms.sourcegitcommit: eeb5daebf10564ec110a4e83874db0fb9f9f8061
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2018
---
#  <a name="managed-service-identity-msi-for-azure-resources"></a>Управляемое удостоверение службы (MSI) для ресурсов Azure

[!INCLUDE[preview-notice](~/includes/active-directory-msi-preview-notice-ua.md)]

Распространенная проблема при создании облачных приложений — управление учетными данными, которые необходимы в коде для аутентификации в облачных службах. Обеспечение безопасности этих учетных данных является важной задачей. В идеальном случае они никогда не передаются на рабочие станции разработчиков и не записываются после изменения в систему управления версиями. Azure Key Vault позволяет обеспечить безопасное хранение учетных данных, а также других ключей и секретов, но для их получения код должен выполнять аутентификацию в Key Vault. Управляемое удостоверение службы (MSI) упрощает решение этой задачи, предоставляя службам Azure автоматически управляемое удостоверение в Azure Active Directory (Azure AD). Это удостоверение можно использовать для аутентификации в любой службе, которая поддерживает аутентификацию Azure AD, включая Key Vault, не храня какие-либо учетные данные в коде.

## <a name="how-does-it-work"></a>Как это работает?

Когда используется удостоверение MSI в экземпляре службы Azure, Azure создает удостоверение в клиенте Azure AD, связанном с вашей подпиской Azure. Кроме того, Azure подготавливает учетные данные для удостоверения в экземпляре службы. Таким образом, ваш код может отправить локальный запрос на получение маркеров доступа для служб, которые поддерживают аутентификацию Azure AD. Одновременно с этим Azure выполняет развертывание учетных данных, используемых экземпляром службы.

## <a name="how-do-i-enable-my-resources-to-use-a-managed-service-identity"></a>Как включить использование удостоверения MSI для моих ресурсов?

Существует два типа удостоверений MSI: *назначаемые системой* и *назначаемые пользователем*.

- **Назначаемое системой** MSI включается непосредственно в экземпляре службы Azure. При этом Azure создает удостоверение для экземпляра службы в клиенте Azure AD и подготавливает учетные данные для удостоверения в экземпляре службы. Жизненный цикл назначенного системой удостоверения MSI напрямую связан с экземпляром службы Azure, в которой оно включено. При удалении экземпляра службы Azure автоматически очищает учетные данные и удостоверение в Azure AD.

- **Назначаемое пользователем** удостоверение MSI *(закрытая предварительная версия)* создается как отдельный ресурс Azure. При этом Azure создает удостоверение в клиенте Azure AD. После создания удостоверение можно назначить одному или нескольким экземплярам служб Azure. Так как назначаемое пользователем удостоверение MSI могут использовать несколько экземпляров служб Azure, его жизненный цикл управляется отдельно.

Ниже приведен пример работы назначаемого системой удостоверения MSI с виртуальными машинами Azure.

![Пример MSI виртуальной машины](~/articles/active-directory/media/msi-vm-example.png)

1. Azure Resource Manager получает сообщение, предписывающее включить назначенное системой MSI в виртуальной машине.
2. Azure Resource Manager создает субъект-службу в Azure AD, представляющий удостоверение виртуальной машины. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.
3. Azure Resource Manager настраивает данные субъекта-службы в расширении виртуальной машины для MSI на виртуальной машине. Этот этап включает в себя настройку идентификатора клиента и сертификата, используемых расширением для получения маркеров доступа из Azure AD.
4. Теперь, когда известно удостоверение субъекта-службы виртуальной машины, ей может быть предоставлен доступ к ресурсам Azure. Например, если ваш код должен вызывать Azure Resource Manager, то следует назначить субъекту-службе виртуальной машины соответствующую роль с помощью управления доступом на основе ролей (RBAC) в Azure AD.  Если код должен отправить вызов к Key Vault, то ему следует предоставить доступ к определенному секрету или ключу в Key Vault.
5. Ваш код, запущенный на виртуальной машине, запрашивает маркер из локальной конечной точки, размещенной расширением MSI для виртуальной машины: http://localhost:50342/oauth2/token. Параметр ресурса указывает службу, в которую отправляется маркер. Например, если требуется аутентифицировать код в Azure Resource Manager, используйте параметр resource=https://management.azure.com.
6. Расширение виртуальной машины для MSI использует настроенный для него идентификатор клиента и сертификат для запроса маркера доступа из Azure AD.  Azure AD возвращает маркер доступа JSON Web Token (JWT).
7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.

В этой же схеме ниже показано, как назначаемое пользователем удостоверение MSI работает с виртуальными машинами Azure.

![Пример MSI виртуальной машины](~/articles/active-directory/media/msi-vm-example.png)

1. Azure Resource Manager получает сообщение, предписывающее создать назначаемое пользователем удостоверение MSI.
2. Azure Resource Manager создает субъект-службу в Azure AD, представляющий удостоверение MSI. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.
3. Azure Resource Manager получает сообщение, предписывающее указать в конфигурации данные субъекта-службы в расширении MSI для виртуальной машины на виртуальной машине. Этот этап включает в себя настройку идентификатора клиента и сертификата, используемых расширением для получения маркеров доступа из Azure AD.
4. Теперь, когда известно удостоверение субъекта-службы MSI, можно предоставить ему доступ к ресурсам Azure. Например, если ваш код должен вызывать Azure Resource Manager, следует назначить субъекту-службе MSI соответствующую роль с помощью управления доступом на основе ролей (RBAC) в Azure AD. Если код должен отправить вызов к Key Vault, то ему следует предоставить доступ к определенному секрету или ключу в Key Vault. Примечание. Шаг 3 не является обязательным для выполнения шага 4. Если удостоверение MSI существует, ему можно предоставить доступ к ресурсам независимо от того, настроен ли он на виртуальной машине.
5. Ваш код, запущенный на виртуальной машине, запрашивает маркер из локальной конечной точки, размещенной расширением виртуальной машины для MSI: http://localhost:50342/oauth2/token. Параметр идентификатора клиента указывает имя удостоверения MSI, которое следует использовать. Кроме того, параметр ресурса указывает службу, в которую отправляется маркер. Например, если требуется аутентифицировать код в Azure Resource Manager, используйте параметр resource=https://management.azure.com.
6. Расширение MSI для виртуальной машины проверяет, настроен ли сертификат для запрошенного идентификатора клиента, и запрашивает маркер доступа из Azure AD. Azure AD возвращает маркер доступа JSON Web Token (JWT).
7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.

Каждая служба Azure, которая поддерживает управляемое удостоверение службы, применяет собственный метод получения маркера доступа для вашего кода. Ознакомьтесь с руководствами для каждой из служб, чтобы узнать, какие методы получения маркера они используют.

## <a name="try-managed-service-identity"></a>Использование управляемого удостоверения службы

Чтобы ознакомиться с комплексными сценариями для доступа к различным ресурсам Azure, используйте руководство по управляемому удостоверению службы:
<br><br>
| Из ресурса, поддерживающего MSI | Сценарий для ознакомления |
| ------- | -------- |
| Виртуальная машина Azure (Linux)   | [Получение доступа к Azure Resource Manager с помощью управляемого удостоверения службы виртуальной машины Linux](msi-tutorial-linux-vm-access-arm.md) |
|                    | [Получение доступа к службе хранилища Azure с ключом доступа при помощи управляемого удостоверения службы виртуальной машины Linux](msi-tutorial-linux-vm-access-storage.md) |

## <a name="which-azure-services-support-managed-service-identity"></a>Какие службы Azure поддерживают управляемое удостоверение службы?

Службы Azure, которые поддерживают управляемое удостоверение службы, могут использовать MSI для аутентификации в службах, поддерживающих аутентификацию Azure AD.  Мы работаем над интеграцией MSI и аутентификации Azure AD на платформе Azure.  Почаще проверяйте наличие обновлений.

### <a name="azure-services-that-support-managed-service-identity"></a>Службы Azure, поддерживающие управляемое удостоверение службы

Ниже приведены службы Azure, которые поддерживают управляемое удостоверение службы.

| Service | Status | Дата | Настройка | Получение маркера |
| ------- | ------ | ---- | --------- | ----------- |
| Виртуальные машины Azure | Предварительный просмотр | Сентябрь 2017 г. | [интерфейс командной строки Azure](msi-qs-configure-cli-windows-vm.md)<br>[Шаблоны диспетчера ресурсов Azure](msi-qs-configure-template-windows-vm.md) | [Bash/Curl](msi-how-to-use-vm-msi-token.md#get-a-token-using-curl)<br>[HTTP/REST](msi-how-to-use-vm-msi-token.md#get-a-token-using-http) |

### <a name="azure-services-that-support-azure-ad-authentication"></a>Службы Azure, поддерживающие аутентификацию Azure AD

Ниже приведены службы, поддерживающие аутентификацию Azure AD, которые были проверены с помощью служб клиента, использующих управляемое удостоверение службы.

| Service | Идентификатор ресурса | Status | Дата | Назначение доступа |
| ------- | ----------- | ------ | ---- | ------------- |
| Диспетчер ресурсов Azure | https://management.azure.com/ | Доступна | Сентябрь 2017 г. | [интерфейс командной строки Azure](msi-howto-assign-access-CLI.md) |
| Хранилище ключей Azure | https://vault.azure.net/ | Доступна | Сентябрь 2017 г. | |
| Azure Data Lake; | https://datalake.azure.net/ | Доступна | Сентябрь 2017 г. | |
| Azure SQL | https://database.windows.net/ | Доступна | Октябрь 2017 г. | |

## <a name="how-much-does-managed-service-identity-cost"></a>Сколько стоит использование управляемого удостоверения службы?

Управляемое удостоверение службы поставляется с лицензией Azure Active Directory Free, используемой по умолчанию для подписок Azure.  За использование возможностей управляемого удостоверения службы не взимается дополнительная плата.

## <a name="support-and-feedback"></a>Поддержка и обратная связь

Мы будем рады узнать ваше мнение!

* Задавайте практические вопросы на сайте Stack Overflow, пометив их тегом [azure-msi](http://stackoverflow.com/questions/tagged/azure-msi).
* Запросите новые функции или отправьте отзыв на [форуме обратной связи по Azure AD для разработчиков](https://feedback.azure.com/forums/169401-azure-active-directory/category/164757-developer-experiences).






