<properties
    pageTitle="Служба синхронизации Azure AD Connect: общие сведения о конфигурации по умолчанию | Microsoft Azure"
    description="Эта статья содержит информацию о конфигурации по умолчанию для службы синхронизации Azure AD Connect."
    services="active-directory"
    documentationCenter=""
    authors="andkjell"
    manager="stevenpo"
    editor=""/>
<tags
    ms.service="active-directory"
    ms.workload="identity"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
	ms.topic="article"
    ms.date="06/27/2016"
    ms.author="andkjell"/>

# Службы синхронизации Azure AD Connect: рекомендации по изменению конфигурации по умолчанию

В этой статье описываются стандартные правила конфигурации и то, как они влияют на конфигурацию. В статье описывается также стандартная конфигурация службы синхронизации Azure AD Connect Sync. Статья на реальном примере познакомит читателя с тем, как работает модель конфигурации, именуемая "декларативной подготовкой". Для работы с этой статьей нужно установить и настроить службу Azure AD Connect Sync с помощью мастера установки.

## Стандартные правила, используемые локально и передаваемые в Azure AD

Приведенные ниже выражения доступны в стандартной конфигурации.

Правила выражаются как в виде правил, которые должны соблюдаться, так и в виде объекта, который должен быть отфильтрован (если правило соблюдено, **не** выполняйте синхронизацию).

### Стандартные правила: объект-пользователь

Эти правила также применяются к типу объекта iNetOrgPerson.

Для синхронизации объект-пользователь должен соответствовать следующим условиям:

- Должен присутствовать атрибут sourceAnchor.
- После создания объекта в Azure AD атрибут sourceAnchor изменить нельзя. Если значение sourceAnchor изменено локально, синхронизация объекта будет остановлена, пока это значение не будет изменено на предыдущее.
- Атрибут accountEnabled (userAccountControl) должен быть заполнен. Для локальной службы Active Directory этот атрибут всегда присутствует и является заполненным.

Следующие объекты-пользователи **не** синхронизируются с Azure AD:

- `IsPresent([isCriticalSystemObject])`. Многие стандартные объекты в Active Directory (например, встроенная учетная запись администратора) не должны синхронизироваться.
- `IsPresent([sAMAccountName]) = False`. Объекты-пользователи без атрибута sAMAccountName не должны синхронизироваться. На практике это может произойти только в домене, обновленном с уровня NT4.
- `Left([sAMAccountName], 4) = "AAD_"`, `Left([sAMAccountName], 5) = "MSOL_"`. Не синхронизируйте учетную запись службы, используемую службой Azure AD Connect Sync и ее предыдущими версиями.
- Не синхронизируйте учетные записи Exchange, которые не будут работать в Exchange Online.
    - `[sAMAccountName] = "SUPPORT_388945a0"`
    - `Left([mailNickname], 14) = "SystemMailbox{"`
    - `(Left([mailNickname], 4) = "CAS_" && (InStr([mailNickname], "}") > 0))`
    - `(Left([sAMAccountName], 4) = "CAS_" && (InStr([sAMAccountName], "}")> 0))`
- Не синхронизируйте объекты, которые не будут работать в Exchange Online. `CBool(IIF(IsPresent([msExchRecipientTypeDetails]),BitAnd([msExchRecipientTypeDetails],&H21C07000) > 0,NULL))` Эта битовая маска (&H21C07000) будет отфильтровывать следующие объекты:
    - общедоступную папку с поддержкой электронной почты;
    - почтовый ящик системного помощника;
    - почтовый ящик базы данных почтовых ящиков (системный почтовый ящик);
    - универсальную группу безопасности (не применяется для пользователя, но доступно для прежних версий);
    - неуниверсальную группу (не применяется для пользователя, но доступно для прежних версий);
    - план почтового ящика;
    - почтовый ящик найденных сообщений.
- `CBool(InStr(DNComponent(CRef([dn]),1),"\\0ACNF:")>0)`. Не синхронизируйте объекты, являющиеся жертвами репликации.

Применяются следующие правила атрибутов:

- `sourceAnchor <- IIF([msExchRecipientTypeDetails]=2,NULL,..)`. Атрибут sourceAnchor не предоставляется из связанного почтового ящика. Предполагается, что при обнаружении связанного почтового ящика фактическая учетная запись будет присоединена позже.
- Связанные с Exchange атрибуты синхронизируются, только если у атрибута **mailNickName** есть значение.
- При наличии нескольких лесов атрибуты будут использоваться в следующем порядке:
    - Атрибуты, связанные с входом (например, userPrincipalName), будут предоставлены из леса с действующей учетной записью.
    - Атрибуты, которые можно обнаружить в глобальном списке адресов (GAL), будут предоставлены из леса с почтовым ящиком Exchange.
    - Если почтовый ящик не найден, эти атрибуты могут поступать из любого леса.
    - Атрибуты, связанные с Exchange, предоставляются из леса, где `mailNickname ISNOTNULL`.
    - Если есть несколько лесов, соответствующих одному из этих правил, то для определения леса, который будет предоставлять атрибуты, будет использоваться порядок создания (дата и время) соединителей (лесов).

### Стандартные правила: объект-контакт

Для синхронизации объект-контакт должен соответствовать следующим условиям:

- Контакт должен поддерживать электронную почту. Проверка выполняется в соответствии со следующими правилами:
    - `IsPresent([proxyAddresses]) = True)`. Атрибут proxyAddresses должен быть заполнен.
    - Основной адрес электронной почты можно найти в атрибуте proxyAddresses или в атрибуте mail. Приоритет символа @ используется для подтверждения того, что содержимое является адресом электронной почты. Один из этих двух атрибутов должен иметь значение True.
        - `(Contains([proxyAddresses], "SMTP:") > 0) && (InStr(Item([proxyAddresses], Contains([proxyAddresses], "SMTP:")), "@") > 0))`. Есть ли запись с "SMTP:"? Если да, есть ли в строке символ @?
        - `(IsPresent([mail]) = True && (InStr([mail], "@") > 0)`. Заполнен ли атрибут mail? Если да, есть ли в строке символ @?

Следующие объекты-контакты **не** синхронизируются с Azure AD:

- `IsPresent([isCriticalSystemObject])`. Объекты-контакты, отмеченные как критические, не должны синхронизироваться. Не допускаются объекты с конфигурацией по умолчанию.
- `((InStr([displayName], "(MSOL)") > 0) && (CBool([msExchHideFromAddressLists])))`.
- `(Left([mailNickname], 4) = "CAS_" && (InStr([mailNickname], "}") > 0))`. Эти объекты не будут работать в Exchange Online.
- `CBool(InStr(DNComponent(CRef([dn]),1),"\\0ACNF:")>0)`. Не синхронизируйте объекты, являющиеся жертвами репликации.

### Стандартные правила: объект-группа

Для синхронизации объект-группа должен соответствовать следующим условиям:

- Должен включать менее 50 000 членов. Это число равно количеству членов локальной группы.
    - Если группа включает большее количество членов перед первым запуском синхронизации, такая группа не будет синхронизирована.
    - Если после создания количество членов увеличилось и затем достигло 50 000, синхронизация будет остановлена, пока количество членов снова не станет меньше 50 000.
    - Примечание. Ограничение в 50 000 членов устанавливается также в Azure AD. Вы не сможете синхронизировать группы с превышающим это значение количеством членов, даже если измените или удалите это правило.
- Если группа является **группой рассылки**, для нее должна быть включена также поддержка почты. Сведения о принудительном применении этого правила см. разделе [Стандартные правила: объект-контакт](#contact-out-of-box-rules).

Следующие объекты-группы **не** синхронизируются с Azure AD:

- `IsPresent([isCriticalSystemObject])`. Многие стандартные объекты в Active Directory (например, встроенная группа администраторов) не должны синхронизироваться.
- `[sAMAccountName] = "MSOL_AD_Sync_RichCoexistence"`. Устаревшие группы, используемые DirSync.
- `BitAnd([msExchRecipientTypeDetails],&amp;H40000000)`. Группа ролей.
- `CBool(InStr(DNComponent(CRef([dn]),1),"\\0ACNF:")>0)`. Не синхронизируйте объекты, являющиеся жертвами репликации.

### Стандартные правила: ForeignSecurityPrincipal

Внешние субъекты безопасности присоединяются к любому (*) объекту в метавселенной. В действительности это происходит только для пользователей и групп безопасности. Этим гарантируется, что членство между лесами будет разрешено и правильно представлено в Azure AD.

### Стандартные правила: объект-компьютер

Для синхронизации объект-компьютер должен соответствовать следующим условиям:

- `userCertificate ISNOTNULL`. Этот атрибут будут заполнять только объекты-компьютеры под управлением Windows 10. Синхронизируются все объекты-компьютеры со значением для этого атрибута.

## Основные сведения об использовании стандартных правил

В этом примере мы используем развертывание с одним лесом учетных записей (A), одним лесом ресурсов (R) и одним каталогом Azure AD.

![сценарий](./media/active-directory-aadconnectsync-understanding-default-configuration/scenario.png)

Мы ожидаем, что в этой конфигурации будет одна активная учетная запись в лесу учетных записей и одна отключенная учетная запись в лесу ресурсов, к которому привязан почтовый ящик.

Наша цель при использовании конфигурации по умолчанию:

- Информация об атрибутах, связанных с именем входа, синхронизируется из леса с активной учетной записью.
- Атрибуты, которые есть в глобальном списке адресов (GAL), синхронизируются из леса с почтовым ящиком. Если нет ни одного почтового ящика, используется любой другой лес.
- Если найден связанный почтовый ящик, должна присутствовать и связанная активная учетная запись: только тогда объекта экспортируется в Azure AD.

### Редактор правил синхронизации

Просмотр и изменение конфигурации выполняются с помощью редактора правил синхронизации, ярлык для которого есть в меню "Пуск".

![Редактор правил синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/sre.png)

Этот редактор входит в набор ресурсов и устанавливается вместе со службой синхронизации Azure AD Connect. Права на его запуск есть у членов группы ADSyncAdmins. При запуске редактора вы увидите примерно следующее:

![Входящие правила синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/syncrulesinbound.png)

Эта панель содержит все правила синхронизации, которые есть в вашей конфигурации. Каждая строка в таблице представляет одно правило синхронизации. Слева в списке типов правил указаны два разных типа: входящие и исходящие. Входящие правила взяты из представления метавселенной. В этом обзоре мы рассмотрим преимущественно правила для входящих подключений. Реальный список правил синхронизации будет зависеть от схемы, которая будет обнаружена в AD. На рисунке выше лес учетных записей (fabrikamonline.com) не имеет служб, например Exchange или Lync, и для этих служб не созданы правила синхронизации. Однако правила синхронизации для этих служб есть в лесу ресурсов (res.fabrikamonline.com). Содержание правил будет различным в зависимости от обнаруженной версии. Например, в развертывании с Exchange 2013 будет создано больше правил для потоков атрибутов, чем в развертывании с Exchange 2010 или Exchange 2007.

### Правило синхронизации

Правило синхронизации является объектом конфигурации с набором атрибутов, передаваемых при удовлетворении условия. Кроме того, оно позволяет описать, как объект в пространстве соединителя связан с объектом в метавселенной, называемым **соединением** или **совпадением**. Для правил синхронизации заданы значения приоритета, которые обозначают порядок их использования. Правило синхронизации с меньшим числовым значением приоритета имеет более высокий приоритет. В случае конфликта потоков атрибутов выполняется правило с более высоким приоритетом.

В качестве примера рассмотрим правило синхронизации **In from AD — User AccountEnabled**. Отметьте эту строку в редакторе правил синхронизации и нажмите **Изменить**.

Так как это правило входит в стандартный набор, при его открытии вы увидите предупреждение. Не следует без необходимости вносить [изменения в стандартные правила](active-directory-aadconnectsync-best-practices-changing-default-configuration.md), поэтому редактор уточняет ваши намерения. Сейчас мы будем только просматривать правило, поэтому выберите вариант **Нет**.

![Входящие правила синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/warningeditrule.png)

Правило синхронизации имеет четыре раздела конфигурации: описание, преобразование, правила объединения и фильтр области действия.

#### Описание

Первый раздел содержит основные сведения, такие как имя и описание.

![Изменить входящее правило синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/syncruledescription.png)

Также здесь находятся сведения о том, к какой подключенной системе это правило относится, к какому типу объекта в подключенной системе оно применяется, а также о типе объекта метавселенной. Тип объекта метавселенной всегда является лицом, независимо от того, является ли исходный тип объекта пользователем, iNetOrgPerson или контактом. Тип объекта метавселенной никогда не должен изменяться, поэтому он создается как универсальный тип. Тип связи можно задать как Join, StickyJoin или Provision. Эта настройка работает совместно с разделом "Правила соединения", и мы рассмотрим это позднее.

Кроме того, вы видите, что это правило синхронизации используется для синхронизации паролей. Если пользователь находится в области действия этого правила, его пароль будет в рамках синхронизации передан из локального каталога в облако (разумеется, если вы активировали функцию синхронизации паролей).

#### Фильтр области действия

Раздел "Фильтр области действия" позволяет настроить, когда следует применять правило синхронизации. Имя правила синхронизации напоминает нам, что оно должно применяться только для включенных пользователей. Поэтому в настройках области действия уберите бит 2 для атрибута AD **userAccountControl**. Это правило будет действовать для всех обнаруженных пользователей в AD, у которых атрибут **userAccountControl** имеет десятичное значение 512 (включенный обычный пользователь), но не будет действовать для пользователей, у которых атрибут **userAccountControl** имеет значение 514 (отключенный обычный пользователь).

![Изменить входящее правило синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/syncrulescopingfilter.png)

Фильтр области действия содержит группы и предложения, которые могут быть вложенными. Для применения правила синхронизации должны удовлетворяться все предложения в группе. При определении нескольких групп для применения правила должна удовлетворяться по крайней мере одна группа. Т. е. между группами вычисляется логическое ИЛИ, а внутри группы — логическое И. Пример этого можно найти в исходящем правиле синхронизации **Отправка в AAD — объединение групп**, которое показано ниже. Существуют несколько групп фильтров синхронизации, например для групп безопасности (securityEnabled EQUAL True) и для групп рассылки (securityEnabled EQUAL False).

![Изменить исходящее правило синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/syncrulescopingfilterout.png)

Это правило используется для определения групп, которые должны быть подготовлены в AAD. Для синхронизации групп распространения с AAD для них должна быть включена функция почты, но для групп безопасности это не является обязательным. Как можно видеть, также вычисляется множество дополнительных атрибутов.

#### Правила объединения

Третий раздел позволяет настроить, как объекты в пространстве соединителя относятся к объектам в метавселенной. Правило, которое мы рассматривали ранее, не содержит настроек для правил объединения, поэтому теперь мы рассмотрим правило **In from AD — User Join**.

![Изменить входящее правило синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/syncrulejoinrules.png)

Содержимое правил объединения будет зависеть от параметра совпадения, выбранного в мастере установки. Для входящего правила вычисление начинается с объекта в исходном пространстве соединителя, а затем последовательно вычисляется каждая группа в правилах объединения. Если вычисленный исходный объект совпадает в точности с одним объектом в метавселенной при использовании одного из правил объединения, объекты объединяются. Если вычислены все правила и совпадений нет, то используется тип связи на странице описания. Если этот параметр установлен как Provision, создается новый объект в целевом пространстве (метавселенной). Подготовка нового объекта в метавселенной также называется проекцией объекта в метавселенную.

Правила объединения вычисляются только один раз. Когда объект пространства соединителя и объект метавселенной объединяются друг с другом, они останутся объединенными, пока область действия правила синхронизации будет продолжать выполняться.

При вычислении правил синхронизации в области действия должно находиться только одно правило синхронизации с определенными правилами объединения. Если для одного объекта найдено несколько правил синхронизации с правилами объединения, выдается ошибка. По этой причине рекомендуется определить только одно правило синхронизации с объединением, если в области действия для объекта имеется несколько правил синхронизации. В стандартной конфигурации службы Azure Active Directory Sync эти правила можно найти по слову Join в конце имени. Правило синхронизации без определенных правил объединения будет применять потоки атрибутов, если другое правило синхронизации объединило объекты друг с другом или подготовило новый объект в целевом пространстве.

На приведенном выше рисунке вы видите, что правило пытается объединить **objectSID** с **msExchMasterAccountSid** (Exchange) или **msRTCSIP-OriginatorSid** (Lync). Это логичное действие в рамках топологии, в которой есть леса учетных записей и ресурсов. Такое же правило мы найдем в каждом из лесов, т. е. предполагается, что каждый лес может быть лесом ресурсов или лесом учетных записей. Этот подход будет работать даже для учетных записей, которые существуют в одном лесу и не должны объединяться.

#### Преобразования

В разделе преобразований определяются все потоки атрибутов, которые будут применены к целевому объекту после объединения объектов и при удовлетворении фильтра области действия. Вернувшись к нашему правилу синхронизации **In from AD — User AccountEnabled**, мы найдем следующие преобразования:

![Изменить входящее правило синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/syncruletransformations.png)

В общем контексте, при развертывании леса Account-Resource мы ожидаем найти включенную учетную запись в лесу учетных записей и отключенную учетную запись в лесу ресурсов с параметрами Exchange и Lync. Рассматриваемое нами правило синхронизации содержит атрибуты, необходимые для входа, и нам требуется передать их из леса, где мы нашли включенную учетную запись. Эти потоки атрибутов вместе помещаются в одно правило синхронизации.

Преобразования могут быть разных типов: константа, прямое или выражение.

- Поток-константа (Constant) будет всегда передавать определенное значение, в приведенном выше случае мы всегда устанавливаем значение True в атрибуте метавселенной с именем accountEnabled.
- Прямой поток (Direct) будет передавать значение атрибута из источника в целевой атрибут.
- Третий тип потока — выражение (Expression). Он дает возможность создавать более сложные конфигурации.

Языком выражений является VBA (Visual Basic for Applications), поэтому пользователь, обладающий опытом работы с Microsoft Office или VBScript, распознает этот формат. Атрибуты заключаются в квадратные скобки: [attributeName]. В именах атрибутов и функций учитывается регистр, но редактор правил синхронизации будет проверять выражения и предупреждать, если выражение является недопустимым. Все выражения выражаются в одной строке с вложенными функциями. Для демонстрации возможностей языка конфигурации ниже приведен поток для pwdLastSet, в который вставлены дополнительные комментарии.

```
// If-then-else
IIF(
// (The evaluation for IIF) Is the attribute pwdLastSet present in AD?
IsPresent([pwdLastSet]),
// (The True part of IIF) If it is, then from right to left, convert the AD time format to a .Net datetime, change it to the time format used by AAD, and finally convert it to a string.
CStr(FormatDateTime(DateFromNum([pwdLastSet]),"yyyyMMddHHmmss.0Z")),
// (The False part of IIF) Nothing to contribute
NULL
)
```

Информации о преобразовании очень много, и она включает в себя информацию о большом количестве настраиваемых конфигураций, которые возможны для службы синхронизации Azure AD Connect. Дополнительную информацию можно найти в других статьях о службе синхронизации Azure AD Connect.

### Приоритет

Мы рассмотрели несколько правил синхронизации по отдельности, но в конфигурации они работают совместно. В некоторых случаях несколько правил синхронизации влияют на значение одного целевого атрибута. В таких случаях атрибут выбирается на основании приоритета атрибутов. В качестве примера давайте рассмотрим атрибут sourceAnchor. Этот атрибут важен для входа в Azure AD. Потоки для этого атрибута есть в двух различных правилах синхронизации: **In from AD — User AccountEnabled** и **In from AD — User Common**. Приоритет правил синхронизации таков, что атрибут sourceAnchor будет заполняться в первую очередь из леса с действующей учетной записью, если к объекту метавселенной присоединяются несколько объектов. Если нет включенных учетных записей, мы будем использовать универсальное правило синхронизации **In from AD — User Common**. Это гарантирует, мы получим атрибут sourceAnchor даже для отключенных учетных записей.

![Входящие правила синхронизации](./media/active-directory-aadconnectsync-understanding-default-configuration/syncrulesinbound.png)

Мастер установки определяет приоритет для групп правил синхронизации. Группой правил синхронизации считаются несколько правил с одинаковыми именами, которые подключены к разным подключенным каталогам. Мастер установки установит наивысший приоритет правилу **Поступление из AD — объединение пользователей** для всех подключенных каталогов AD. Затем он перейдет к следующей группе правил в предопределенном порядке. Внутри группы правила добавляются в том порядке, в котором добавлены соединители в мастере. Если добавить новый соединитель с использованием мастера, он изменит порядок правил синхронизации, при этом правила нового соединителя будут последними в каждой группе.

### Сборка

Теперь мы знаем достаточно о правилах синхронизации, чтобы понимать работу конфигураций с различными правилами синхронизации. Правила в отношении пользователя и атрибутов, добавляемых в метавселенную, применяются в следующем порядке:

| Имя | Комментарий |
| :------------- | :------------- |
| Поступление из AD — объединение пользователей | Правило для присоединения к метавселенной объектов из пространства соединителя. |
| Поступление из AD — учетная запись включена | Атрибуты, необходимые для входа в Azure AD и Office 365. Эти атрибуты нужно перенести из включенной учетной записи. |
| Поступление из AD — все пользователи с сервера Exchange | Атрибуты из глобального списка адресов. Мы предполагаем, что качество этих данных выше в том лесу, где у пользователя есть почтовый ящик. |
| Поступление из AD — все пользователи | Атрибуты из глобального списка адресов. Если мы не нашли почтовый ящик, значение атрибута может предоставить любой присоединенный объект. |
| Поступление из AD — пользователь Exchange | Правило существует, только если обнаружена платформа Exchange. Передает все атрибуты инфраструктуры Exchange. |
| Поступление из AD — пользователь Lync | Правило существует, только если обнаружено решение Lync. Передает все атрибуты инфраструктуры Lync. |

## Дополнительные ресурсы

* [Azure AD Connect Sync: настройка параметров синхронизации](active-directory-aadconnectsync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md)

<!---HONumber=AcomDC_0629_2016-->