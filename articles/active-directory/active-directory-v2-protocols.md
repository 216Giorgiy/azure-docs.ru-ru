<properties
	pageTitle="Модель приложений версии 2.0: протоколы | Microsoft Azure"
	description="Протоколы, поддерживаемые в общедоступной предварительной версии модели приложений 2.0 Azure AD."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/12/2015"
	ms.author="dastrock"/>

# Предварительная версия модели приложений 2.0: протоколы — OAuth 2.0 и OpenID Connect

Модель приложений 2.0 предоставляет "удостоверение как услугу" для приложений за счет поддержки стандартных отраслевых протоколов, OpenID Connect и OAuth 2.0. Несмотря на то что эта служба соответствует стандартам, между любыми двумя реализациями этих протоколов могут быть незначительные различия. Сведения в этой статье могу оказаться полезными, если вы планируете писать код путем прямой отправки и обработки HTTP-запросов, а не использовать одну из наших библиотек с открытым исходным кодом.<!-- TODO: Need link to libraries above -->

> [AZURE.NOTE]Эти сведения относятся к общедоступной предварительной версии модели приложений 2.0. Инструкции по интеграции с общедоступной службой Azure AD см. в статье [Руководство разработчика по Azure Active Directory](active-directory-developers-guide.md).

## Маркеры
В реализации OAuth 2.0 и OpenID Connect через модель приложений 2.0 широко используются маркеры носителя, включая маркеры носителя в виде JWT. Маркер носителя — это упрощенный маркер безопасности, предоставляющий его носителя (предъявителю) доступ к защищенному ресурсу. В этом смысле предъявителем является любая сторона, которая может предъявить маркер. Несмотря на то, что для получения токена носителя сторона должны сначала пройти проверку подлинности в Azure AD, если действия, необходимые для защиты маркера при его передаче и хранении не выполняются, его может перехватить и использовать несанкционированная сторона. Хотя в некоторых маркерах безопасности для предотвращения несанкционированного использования применяется специальный встроенный механизм, в токенах носителя такого механизма нет, и они должны передаваться по защищенному каналу, например с использованием стандарта безопасности транспортного уровня (HTTPS). Если токен носителя передается в незашифрованном виде, злоумышленник может использовать атаку "злоумышленник в середине", чтобы получить токен и использовать его для несанкционированного доступа к защищенному ресурсу. Те же принципы безопасности применяются при сохранении или кэшировании токенов носителя для последующего использования. Необходимо всегда проверять, что приложение передает и сохраняет токены носителя безопасным образом. Дополнительные сведения о безопасности в случае применения маркеров носителя см. в [RFC 6750, раздел 5](http://tools.ietf.org/html/rfc6750).

Дополнительные сведения о различных типах маркеров, используемых в модели приложений 2.0 можно найти в [справочных материалах по маркерам в модели приложений 2.0](active-directory-v2-tokens.md).

## Основы
Каждое приложение, использующее модель приложений 2.0, необходимо зарегистрировать на сайте [apps.dev.microsoft.com](https://apps.dev.microsoft.com). В процессе регистрации для приложения будет собрано и назначено несколько значений:

- **Идентификатор приложения**, определяющий конкретное приложение.
- **Универсальный код ресурса (URI) перенаправления** или **Идентификатор пакета**, которые можно использовать для возврата ответов к приложению.
- Несколько других зависящих от сценария значений. Вы можете подробнее узнать о процедуре [регистрации приложения](active-directory-v2-app-registration.md).

После регистрации приложение подключается к Azure AD путем отправки приложений на конечную точку версии 2.0:

```
https://login.microsoftonline.com/common/oauth2/v2.0/authorize
https://login.microsoftonline.com/common/oauth2/v2.0/token
```

Почти во всех потоках обмена данными в OAuth и OpenID Connect участвуют четыре стороны:

![Роли OAuth 2.0](../media/active-directory-v2-flows/protocols_roles.png)

- **Сервер авторизации** — это конечная точка версии 2.0. Он отвечает за удостоверение пользователя, предоставление и блокировку доступа к ресурсам, а также предоставление маркеров. Кроме того, этот сервер выполняет роль поставщика удостоверений: он безопасным способом обрабатывает любые данные, связанные со сведениями о пользователе, его доступом и отношениями доверия между участниками потока.
- **Владелец ресурса** — это, как правило, конечный пользователь. Это сторона, владеющая данными, которая может предоставлять третьим сторонам доступ к этим данным или ресурсу.
- **Клиент OAuth** — это ваше приложение, определяемое идентификатором приложения. Обычно именно с этой стороной взаимодействует конечный пользователь. Она также запрашивает маркеры у сервера авторизации. Владелец ресурса должен предоставить клиенту разрешение на доступ к ресурсу.
- **Сервер ресурсов** — место размещения ресурса или данных. Он позволяет серверу авторизации выполнять безопасную проверку подлинности и авторизацию клиента OAuth и использует маркеры доступа носителя для обеспечения возможности предоставления доступа к ресурсу.

## Поток кода авторизации OAuth2
Описание потока кода авторизации OAuth 2.0 можно найти в [разделе 4.1 спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749). Он используется для проверки подлинности и авторизации большинства типов приложений, включая [веб-приложения](active-directory-v2-flows.md#web-apps) и [изначально установленные приложения](active-directory-v2-flows.md#mobile-and-native-apps). Он позволяет приложениям безопасно получать маркеры доступа, с помощью которых можно получить доступ к ресурсам, защищенным с использованием модели приложений 2.0.

Ниже показан весь поток для собственного приложения. Каждый запрос подробно описан в следующих разделах: ![Поток кода проверки подлинности OAuth](../media/active-directory-v2-flows/convergence_scenarios_native.png)

#### Запрос кода авторизации
Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize`. В этом запросе клиент указывает разрешения, которые ему требуется получить от пользователя:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=											   // See table below for scope parameter details.
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345						 				 // Any value provided by your app
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | ----------------------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен содержать `code` для потока кода авторизации. |
| redirect\_uri | обязательно | URI перенаправления приложения, на который можно отправлять ответы, чтобы приложение получало их. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами. Одно значение области указывает для конечной точки версии 2.0 как сам ресурс, так и разрешения, запрашиваемые для этого ресурса. Области имеют вид `<app identifier URI>/<scope value>`. В приведенном выше примере используется идентификатор приложения для API Graph Azure AD, `https://graph.windows.net`, а также запрашиваются два разрешения: `directory.read` и `directory.write`. Более подробное описание областей можно найти в c. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment".
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| prompt | необязательный | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственное допустимое значение — "login", при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope`. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](active-directory-v2-scopes.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET https://localhost/myapp/?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq... 	// the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  							// the value provided in the request
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| Код | Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал и обычно истекает по прошествии порядка 10 минут. |
| session\_state | Уникальное значение, указывающее текущий сеанс пользователя. Это значение представляет собой GUID, но его следует расценивать как непрозрачное значение, передаваемое без рассмотрения. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

#### Запрос маркера доступа
После получения кода авторизации и разрешения от пользователя вы можете использовать `code` для получения `access_token` к требуемому ресурсу путем отправки запроса `POST` на конечную точку `/token`:

```
POST common/v2.0/oauth2/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "authorization_code",
	"client_id": "2d4d11a2-f814-46a7-890a-274a72a7309e",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
	"client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| grant\_type | обязательно | Должен быть `authorization_code` для потока кода авторизации. |
| scope | обязательно | Список областей с разделителями-пробелами. Области, запрашиваемые на этом участке, должны быть эквивалентны областям, запрашиваемым на первом участке, или являться их подмножеством. Если области, указанные в этом запросе, охватывают несколько серверов ресурсов, конечная точка версии 2.0 вернет маркер для ресурса, указанного в первой области. Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](active-directory-v2-scopes.md). |
| Код | обязательно | Код авторизации, полученный на первом участке потока. |
| client\_secret | необходим для веб-приложений | Секрет приложения, созданный на портале регистрации для приложения. Его не следует использовать в собственном приложении, поскольку невозможно обеспечить полную безопасность секретов клиентов при их хранении на устройствах. Этот секрет требуется для веб-приложений и веб-API с возможностью безопасного хранения секрета клиента на сервере. |

Успешный ответ маркера выглядит следующим образом:

```
{
	"access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"token_type": "Bearer",
	"expires_in": "3600",
	"expires_on": "1388444763",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```
| Параметр | Описание |
| ----------------------- | ------------------------------- |
| access\_token | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для проверки подлинности на защищенном ресурсе, таком как веб-API. |
| token\_type | Указывает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| expires\_in | Срок действия маркера доступа (в секундах). |
| expires\_on | Время истечения срока действия маркера доступа. Дата представлена в виде количества секунд со времени эпохи. |
| scope | Области, для которых действителен маркер доступа. |
| refresh\_token | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров доступа после истечения срока действия текущего маркера доступа. Маркеры обновления действуют в течение долгого времени. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения можно найти в [справочном материале по маркерам версии 2.0](active-directory-v2-tokens.md). |
| id\_token | Неподписанный веб-маркер JSON (JWT). Приложение может base64Url декодировать сегменты этого маркера, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. Дополнительные сведения о маркерах "id\_token" можно найти в [справочном материале о маркерах в модели приложений 2.0](active-directory-v2-tokens.md). |

Сообщения об ошибках выглядят следующим образом:

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

#### Использование маркера доступа
Успешно получив `access_token`, вы можете использовать маркер в запросах в веб-API путем включения его в заголовок `Authorization`:

```
GET /contoso.onmicrosoft.com/users
Host: https://graph.windows.net
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

#### Обновление маркера доступа
Срок действия маркеров доступа весьма ограничен, поэтому их нужно обновлять после его истечения, чтобы продолжить пользоваться запросами. Для этого можно отправить еще один запрос `POST` на конечную точку `/authorize`, используя `refresh_token` вместо `code`:

```
POST common/v2.0/oauth2/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "refresh_token",
	"client_id": "2d4d11a2-f814-46a7-890a-274a72a7309e",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...",
	"client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | -------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| grant\_type | обязательно | Должен быть `refresh_token` для этого участка потока кода авторизации. |
| scope | обязательно | Список областей с разделителями-пробелами. Области, запрашиваемые на этом участке, должны быть эквивалентны областям, запрашиваемым на исходном участке запроса кода авторизации, или являться их подмножеством. Если области, указанные в этом запросе, охватывают несколько серверов ресурсов, конечная точка версии 2.0 вернет маркер для ресурса, указанного в первой области. Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](active-directory-v2-scopes.md). |
| refresh\_token | обязательно | Маркер обновления, полученный на втором участке потока. |
| client\_secret | необходим для веб-приложений | Секрет приложения, созданный на портале регистрации для приложения. Его не следует использовать в собственном приложении, поскольку невозможно обеспечить полную безопасность секретов клиентов при их хранении на устройствах. Этот секрет требуется для веб-приложений и веб-API с возможностью безопасного хранения секрета клиента на сервере. |

Успешный ответ маркера выглядит следующим образом:

```
{
	"access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
	"token_type": "Bearer",
	"expires_in": "3600",
	"expires_on": "1388444763",
	"scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
	"refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
	"id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```
| Параметр | Описание |
| ----------------------- | ------------------------------- |
| access\_token | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для проверки подлинности на защищенном ресурсе, таком как веб-API. |
| token\_type | Указывает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| expires\_in | Срок действия маркера доступа (в секундах). |
| expires\_on | Время истечения срока действия маркера доступа. Дата представлена в виде количества секунд со времени эпохи. |
| scope | Области, для которых действителен маркер доступа. |
| refresh\_token | Новый маркер обновления OAuth 2.0. Вам следует заменить старый маркер обновления вновь полученным, чтобы обеспечить максимальный срок действия маркеров обновления. |
| id\_token | Неподписанный веб-маркер JSON (JWT). Приложение может base64Url декодировать сегменты этого маркера, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. Дополнительные сведения о маркерах "id\_token" можно найти в [справочном материале о маркерах в модели приложений 2.0](active-directory-v2-tokens.md). |

Сообщения об ошибках выглядят следующим образом:

```
{
	"error": "access_denied",
	"error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |






## Поток входа в OpenID Connect
[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) расширяет возможности протокола *авторизации* OAuth 2.0 и позволяет использовать его в качестве протокола *проверки подлинности*, благодаря чему вы можете выполнять единый вход с помощью OAuth. Он вводит концепцию `id_token`, представляющего собой маркер безопасности, который позволяет клиенту проверять удостоверение пользователя и получать основные сведения о профиле пользователя.

OpenID Connect для модели приложений 2.0 — рекомендуемый способ реализации входа для [веб-приложения](active-directory-v2-flows.md#web-apps). Простейший поток входа включает следующие этапы:

![Дорожки OpenID Connect](../media/active-directory-v2-flows/convergence_scenarios_webapp.png)

#### Отправка запроса на вход
Если веб-приложению требуется проверить подлинность пользователя, оно может направить его к конечной точке `/authorize`. Этот запрос похож на первый участок [потока кода авторизации OAuth 2.0](#oauth2-authorization-code-flow), но обладает несколькими существенными отличиями: запрос должен содержать область `openid` в параметре `scope`; параметр `response_type` должен содержать `id_token`; запрос должен содержать параметр `nonce`

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=openid										 // Translates to the 'Read your profile' permission
&state=12345						 				 // Any value, provided by your app
&nonce=678910										 // Any value, provided by your app
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен включать `id_token` для входа в OpenID Connect. Он также может содержать другие типы ответов, как описано в разделе [Поток OpenID Connect с кодом OAuth](#OpenID-Connect-with-OAuth-Code-Flow). |
| redirect\_uri | обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами. При использовании OpenID Connect он должен включать область `openid`, преобразующуюся в разрешение "Вход в профиль и его просмотр" в пользовательском интерфейсе предоставления разрешений. Вы также можете включить в этот запрос другие области для запроса разрешений, как описано в разделе [Поток OpenID Connect с кодом OAuth](#OpenID-Connect-with-OAuth-Code-Flow). |
| nonce | обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного маркера "id\_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения маркера. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment".  
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| prompt | необязательный | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственное допустимое значение — "login", при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope`. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](active-directory-v2-scopes.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the id_token, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request

```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id\_token | Маркер "id\_token", запрошенный приложением. Вы можете использовать маркер "id\_token" для проверки удостоверения пользователя и запуска сеанса с пользователем. Дополнительные сведения о маркерах "id\_token" и их содержимом можно найти в [справочном материале по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md). |
| session\_state | Уникальное значение, указывающее текущий сеанс пользователя. Это значение представляет собой GUID, но его следует расценивать как непрозрачное значение, передаваемое без рассмотрения. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

#### Проверка маркера "id\_token"
Для проверки подлинности пользователя недостаточно просто получить маркер "id\_token". Вам также потребуется проверить подпись маркера "id\_token" и утверждения в нем в соответствии с требованиями приложения. В конечной точке версии 2.0 для подписи маркеров и проверки их правильности используются [веб-маркеры JSON (JWTs)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Модель приложений 2.0 содержит конечную точку метаданных OpenID Connect, позволяющую приложению получать сведения о модели приложений 2.0 в среде выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Конечная точка метаданных содержит документ JSON, расположенный по ссылке:

`https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`

Одно из свойств этого документа конфигурации — `jwks_uri`, имеющее следующее значение для модели приложений 2.0:

`https://login.microsoftonline.com/common/discovery/v2.0/keys`.

Вы можете использовать открытые ключи RSA256, расположенные на этой конечной точке, для проверки подписи маркера "id\_token". В любой момент времени на этой конечной точке числятся несколько ключей, каждый из которых определяется `kid`. Заголовок маркера "id\_token" также содержит утверждение `kid`, указывающее на ключ, который был использован для подписи маркера "id\_token".

Дополнительные сведения можно найти в [справочном материале по маркерам в модели приложений 2.0](active-directory-v2-tokens.md), включая подразделы [Проверка маркеров](active-directory-v2-tokens.md#validating-tokens) и [Важные сведения о смене ключей подписи](active-directory-v2-tokens.md#validating-tokens). <!--TODO: Improve the information on this-->

После проверки подписи маркера "id\_token" вам потребуется проверить несколько утверждений:

- Проверьте утверждение `nonce` во избежание атак с использованием воспроизведения маркера. Его значение должно совпадать с указанным вами в запросе на вход.
- Проверьте утверждение `aud` и убедитесь, что маркер "id\_token" был выдан для вашего приложения. Его значением должен быть идентификатор `client_id` приложения.
- Проверьте утверждения `iat` и `exp` и убедитесь, что срок действия маркера "id\_token" не истек.

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

- Обеспечение регистрации пользователя или организации в приложении.
- Предоставление пользователю необходимого уровня авторизации и привилегий.
- Обеспечение определенного уровня проверки подлинности, например многофакторной проверки подлинности.

Дополнительные сведения об утверждениях в маркере "id\_token" можно найти в [справочном материале о маркерах в модели приложений 2.0](active-directory-v2-tokens.md).

После полной проверки маркера "id\_token" вы можете начать сеанс с пользователем и использовать утверждения в маркере "id\_token" для получения сведений о пользователе в приложении. Эти сведения можно использовать для отображения, записей, авторизации и т. д.

#### Отправка запроса на выход

На текущий момент предварительная версия модели приложений 2.0 не поддерживает `end_session_endpoint` OpenID Connect. Это значит, что приложение не может отправлять запросы на конечную точку версии 2.0 для прекращения сеанса пользователя и очистки файлов cookie, установленных конечной точкой версии 2.0. Для выполнения выхода пользователя приложение может просто завершить собственный сеанс с пользователем, не затрагивая сеанс пользователя с конечной точкой версии 2.0. При следующей попытке входа пользователь увидит страницу выбора учетной записи с перечнем учетных записей, в которые выполнен вход. На этой странице пользователь может выйти из любой учетной записи, тем самым завершая сеанс с конечной точкой версии 2.0.

<!--

When you wish to sign the user out of the  app, it is not sufficient to clear your app's cookies or otherwise end the session with the user.  You must also redirect the user to the v2.0 endpoint for sign out.  If you fail to do so, the user will be able to re-authenticate to your app without entering their credentials again, because they will have a valid single sign-on session with the v2.0 endpoint.

You can simply redirect the user to the `end_session_endpoint` listed in the OpenID Connect metadata document:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/logout?
post_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
```

| Parameter | | Description |
| ----------------------- | ------------------------------- | ------------ |
| post_logout_redirect_uri | recommended | The URL which the user should be redirected to after successful logout.  If not included, the user will be shown a generic message by the v2.0 endpoint.  |

-->

## Поток OpenID Connect с кодом OAuth
Многим веб-приложениям требуется выполнить вход пользователя, а затем получить доступ к веб-службе от лица этого пользователя с помощью OAuth. Этот сценарий совмещает два предыдущих раздела: в нем используется OpenID Connect для проверки подлинности пользователя и одновременно получается код авторизации, который можно использовать для получения маркеров доступа с помощью потока кода авторизации OAuth:

![Дорожки OpenID Connect](../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)

Этот поток отличается от предыдущих разделов лишь способом отправки запроса на вход.

#### Отправка запроса на вход
Если веб-приложению требуется проверить подлинность пользователя и получить разрешения, необходимые для доступа к ресурсам, оно может направить пользователя к конечной точке `/authorize`. В этом случае приложению потребуется запросить и `id_token`, и `code` в ответе:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=id_token+code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=openid%20										 // Include both 'openid' and scopes your app needs  
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345						 				 // Any value, provided by your app
&nonce=678910										 // Any value, provided by your app
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | ----------------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен включать `id_token` и `code` для этого сценария. |
| redirect\_uri | обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами. При использовании OpenID Connect он должен включать область `openid`, преобразующуюся в разрешение "Вход в профиль и его просмотр" в пользовательском интерфейсе предоставления разрешений. Вам также потребуется включить области для ресурсов, доступ к которым необходим приложению. Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](active-directory-v2-scopes.md). |
| nonce | обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного маркера "id\_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения маркера. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment".  
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| prompt | необязательный | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственное допустимое значение — "login", при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope`. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](active-directory-v2-scopes.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the id_token, truncated
&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq... 	// the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request

```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id\_token | Маркер "id\_token", запрошенный приложением. Вы можете использовать маркер "id\_token" для проверки удостоверения пользователя и запуска сеанса с пользователем. Дополнительные сведения о маркерах "id\_token" и их содержимом можно найти в [справочном материале по маркерам в модели приложений 2.0](active-directory-v2-tokens.md). |
| Код | Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал и обычно истекает по прошествии порядка 10 минут. |
| session\_state | Уникальное значение, указывающее текущий сеанс пользователя. Это значение представляет собой GUID, но его следует расценивать как непрозрачное значение, передаваемое без рассмотрения. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

#### Проверка маркера "id\_token"
Этот процесс полностью идентичен описанному ранее в подразделе [Поток входа в OpenID Connect](#OpenID-Connect-Sign-In-Flow).

#### Отправка запроса на выход
Этот процесс полностью идентичен описанному ранее в подразделе [Поток входа в OpenID Connect](#OpenID-Connect-Sign-In-Flow).

#### Запрос маркера доступа
Этот процесс полностью идентичен описанному ранее в подразделе [Поток кода авторизации OAuth 2.0](#oauth2-authorization-code-flow).

#### Использование маркера доступа
Этот процесс полностью идентичен описанному ранее в подразделе [Поток кода авторизации OAuth 2.0](#oauth2-authorization-code-flow).

#### Обновление маркера доступа
Этот процесс полностью идентичен описанному ранее в подразделе [Поток кода авторизации OAuth 2.0](#oauth2-authorization-code-flow).





## Поток предоставления учетных данных клиента OAuth2
Предоставление учетных данных клиента OAuth 2.0 описано в [спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-4.4). Это может пригодиться для длительных процессов и других межсерверных сценариев, когда приложение может пройти проверку подлинности ресурса с помощью собственного "удостоверения приложения", а не делегированного удостоверения пользователя.

На текущий момент предварительная версия модели приложений 2.0 не поддерживает этот поток. Увидеть, как он работает в общедоступной службе Azure AD, можно в [этом примере кода Azure AD](https://github/com/AzureADSamples/Daemon-DotNet).

## Неявный поток OAuth2
Неявный поток OAuth 2.0 описан в [спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-4.2). Он часто используется для одностраничных приложений и приложений JavaScript, выполняемых в браузере.

На текущий момент предварительная версия модели приложений 2.0 не поддерживает этот поток. Увидеть, как он работает в общедоступной службе Azure AD, можно в [этом примере кода Azure AD](active-directory-devquickstarts-angular.md).

## Предоставление учетных данных владельца ресурса OAuth2
Предоставление учетных данных владельца ресурса OAuth 2.0 описано в [спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-4.3). Это позволяет приложению получать маркеры доступа путем включения имени и пароля пользователя в запрос маркера.

На текущий момент предварительная версия модели приложений 2.0 не поддерживает этот поток. Увидеть, как он работает в общедоступной службе Azure AD, можно в [этом примере кода Azure AD](https://github.com/AzureADSamples/NativeClient-Headless-DotNet).

## Поток предоставления от лица OAuth2
Поток предоставления от лица или предоставление учетных данных носителя JWT описан в этом [черновике по предоставлению расширения OAuth 2.0](https://tools.ietf.org/html/draft-ietf-oauth-jwt-bearer-12). Это позволяет веб-API, получающему маркер доступа, использовать его в качестве учетных данных для получения маркеров доступа к другим ресурсам. За счет этого веб-API может безопасно вызывать другой подчиненный веб-API.

На текущий момент предварительная версия модели приложений 2.0 не поддерживает этот поток. Увидеть, как он работает в общедоступной службе Azure AD, можно в [этом примере кода Azure AD](https://github.com/AzureADSamples/WebAPI-OnBehalfOf-DotNet).

<!---HONumber=Sept15_HO4-->