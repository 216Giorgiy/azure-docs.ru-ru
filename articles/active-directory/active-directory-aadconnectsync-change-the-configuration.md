<properties
	pageTitle="Службы синхронизации Azure AD Connect: изменение конфигурации по умолчанию | Microsoft Azure"
	description="Узнайте, как изменить конфигурацию службы синхронизации Azure AD Connect."
	services="active-directory"
	documentationCenter=""
	authors="andkjell"
	manager="stevenpo"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/23/2016"
	ms.author="andkjell"/>


# Службы синхронизации Azure AD Connect: изменение конфигурации по умолчанию
В этой статье предоставлены сведения об изменении конфигурации по умолчанию в службах синхронизации Azure AD Connect. Здесь также описываются действия для некоторых стандартных сценариев. Ознакомившись с этими сведениями, вы сможете вносить изменения в конфигурацию в соответствии с собственными бизнес-правилами.

## Редактор правил синхронизации
Редактор правил синхронизации используется для просмотра и изменения конфигурации по умолчанию. Его можно найти в меню "Пуск" в группе **Azure AD Connect**. ![Редактор правил синхронизации в меню "Пуск"](./media/active-directory-aadconnectsync-change-the-configuration/startmenu2.png)

При открытии в нем отображаются стандартные правила по умолчанию.

![Редактор правил синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/sre2.png)

### Перемещение в редакторе
Чтобы быстро найти определенное правило, можно воспользоваться раскрывающимися списками, расположенными в верхней части редактора. Например, чтобы просмотреть правила, содержащие атрибут proxyAddresses, необходимо выбрать в раскрывающихся списках следующее: ![Фильтрация в редакторе правил синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/filtering.png) Чтобы сбросить параметры фильтрации и загрузить новую конфигурацию, нажмите клавишу **F5**.

В верхнем правом углу расположена кнопка **Добавить новое правило**. Она используется для создания собственного настраиваемого правила.

Внизу находятся кнопки, позволяющие выполнять определенные действия с выбранным правилом синхронизации. Кнопки **Изменить** и **Удалить** используются для удаления и изменения правил. Кнопка **Экспортировать** позволяет создать сценарий PowerShell для повторного создания правила синхронизации. При этом правило синхронизации перемещается с одного сервера на другой.

## Создание настраиваемого правила
Чаще всего изменяются потоки атрибутов. Данные в исходном каталоге могут отображаться не так, как нужно, чтобы они отображались в Azure AD. В примере, рассматриваемом в этом разделе, необходимо убедиться, что имя пользователя всегда задано в **правильном регистре**.

### Отключение планировщика
По умолчанию [планировщик](active-directory-aadconnectsync-feature-scheduler.md) запускается каждые 30 минут. В некоторых случаях, чтобы внести изменения и устранить неполадки, связанные с новыми правилами, может потребоваться отключить его. Чтобы временно отключить планировщик, запустите PowerShell и выполните команду `Set-ADSyncScheduler -SyncCycleEnabled $false`.

![Отключение планировщика](./media/active-directory-aadconnectsync-change-the-configuration/schedulerdisable.png)

### Создание правила

1. Щелкните **Добавить новое правило**.
2. На странице **Описание** заполните следующие поля. ![Фильтрация входящего правила синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/description2.png)
	- "Имя". Введите описательное имя правила.
	- "Описание". Информация, позволяющая другим пользователям определить предназначение правила.
	- Connected system (Подключенная система). Система, в которой находится объект. В этом случае выберите соединитель Active Directory.
	- Connected System Type (Тип подключенной системы) и Metaverse Object Type (Тип объекта метавселенной). Выберите **Пользователь** и **Человек** соответственно.
	- "Тип связи". Задайте для этого параметра значение **Присоединение**.
	- "Приоритет". Укажите уникальное в системе значение. Более низкие значения имеют более высокий приоритет.
	- "Тег". Оставьте это поле пустым. Его нужно заполнять только при использовании стандартных правил Майкрософт.
3. На странице **Scoping filter** (Фильтр области действия) введите **givenName и ISNOTNULL**. ![Фильтр области входящего правила](./media/active-directory-aadconnectsync-change-the-configuration/scopingfilter.png) Это позволит определить, к каким объектам должно применяться правило. Если оставить эти поля пустыми, правило будет применяться ко всем объектам пользователя, в том числе к конференц-залам, учетным записям службы и другим неодушевленным объектам.
4. Оставьте страницу **Join rules** (Правила присоединения) пустой.
5. На странице **Преобразования** для параметра FlowType (Тип потока) задайте значение **Выражение**. Выберите для параметра "Целевой атрибут" значение **giveName**, а в поле "Источник" введите `PCase([givenName])`. ![Преобразования входящего правила](./media/active-directory-aadconnectsync-change-the-configuration/transformations.png) Для модуля синхронизации имя функции и имя атрибута необходимо указать с учетом регистра. Если не учесть регистр, при добавлении правила отобразится предупреждение. В редакторе можно сохранить правило и продолжить с ним работу позже. Таким образом, вы сможете повторно открыть правило и внести в него изменения.
6. Щелкните **Добавить**, чтобы сохранить правило.

Новое настраиваемое правило отобразится в системе вместе с другими правилами синхронизации.

### Проверка изменений
После внесения изменений в правило его можно проверить на наличие ошибок. В зависимости от количества объектов это можно сделать двумя разными способами:

1. Выполнить полную синхронизацию всех объектов.
2. Выполнить предварительный просмотр и полную синхронизацию одного объекта.

Запустите **Synchronization Service** из меню "Пуск". Все действия, описанные в этом разделе, выполняются в этом средстве.

1. **Полная синхронизация всех объектов**. В верхней части страницы выберите **Соединители**. Определите соединитель, измененный в предыдущем разделе (в этом примере "Доменные службы Active Directory"), и выберите его. Выберите **Запустить** в колонке "Действия". После этого выберите **Полная синхронизация** и нажмите кнопку **ОК**. ![Полная синхронизация](./media/active-directory-aadconnectsync-change-the-configuration/fullsync.png) Теперь объекты в метавселенной обновлены, и их можно просмотреть.

2. **Предварительный просмотр и полная синхронизация одного объекта**. В верхней части страницы выберите **Соединители**. Определите соединитель, измененный в предыдущем разделе (в этом примере "Доменные службы Active Directory"), и выберите его. Выберите **Search Connector Space** (Поиск пространства соединителя). Используйте область поиска, чтобы найти необходимый объект для проверки изменений. Выберите объект и щелкните **Предварительный просмотр**. В открывшемся окне выберите **Просмотр перед фиксацией**. ![Просмотр перед фиксацией](./media/active-directory-aadconnectsync-change-the-configuration/commitpreview.png) Теперь изменение зафиксировано в метавселенной.

**Просмотр объектов в метавселенной** В этом разделе мы выберем несколько образцов объектов и убедимся, что для них задано правильное значение и применено необходимое правило. В верхней части экрана выберите **Metaverse Search** (Поиск в метавселенной). Добавьте любой фильтр, чтобы найти соответствующие объекты. Откройте объект, выбрав его в результатах поиска. Просмотрите значения атрибута, а также проверьте применение правила в столбце **Правила синхронизации**. ![Поиск в метавселенной](./media/active-directory-aadconnectsync-change-the-configuration/mvsearch.png)
### Включение планировщика
Если все параметры заданы правильно, планировщик можно включить снова. В PowerShell выполните команду `Set-ADSyncScheduler -SyncCycleEnabled $true`.

## Другие основные изменения потоков атрибутов
В предыдущем разделе описан процесс изменения потока атрибута. В этом разделе приведены дополнительные примеры. Действия по созданию правила синхронизации упомянуты лишь в общих чертах. Полное описание можно просмотреть в предыдущем разделе.

### Использование атрибута не по умолчанию
В компании Fabrikam есть лес, в котором для указания имени, фамилии и отображаемого имени используются локальные алфавиты. Представления этих атрибутов хранятся в атрибутах расширения, отображенные символами латиницы. При формировании глобального списка адресов в Azure AD и Office 365 организации требуется использовать эти атрибуты.

В конфигурации по умолчанию объект из локального леса выглядит следующим образом. ![Поток атрибутов 1](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp1.png)

Чтобы создать правило с другими потоками атрибутов, выполните следующие действия.

- В меню "Пуск" запустите **редактор правил синхронизации**.
- Не снимая флажок **Входящие** слева, нажмите кнопку **Добавить новое правило**.
- Присвойте правилу имя и описание. Выберите локальный каталог Active Directory и соответствующие типы объектов. В поле **Тип связи** выберите **Join** (Присоединение). Для задания приоритета выберите число, которое не используется другим правилом. Приоритет стандартных правил начинается со 100, поэтому в этом примере используется значение 50. ![Поток атрибутов 2](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp2.png)
- Оставьте значение области пустым (это означает, что правило должно применяться для всех объектов-пользователей в лесу).
- Оставьте поле Join rules (Правила присоединения) пустым (это означает, что стандартные правила могут обрабатывать любые присоединения).
- В разделе "Преобразования" создайте следующие потоки. ![Поток атрибутов 3](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp3.png)
- Щелкните **Добавить**, чтобы сохранить правило.
- Откройте **Synchronization Service Manager**. В разделе **Соединители** выберите соединитель, в который мы добавили правило. Выберите **Запустить**, а затем — **Полная синхронизация**. Функция полной синхронизации повторно вычисляет все объекты, используя текущие правила.

Это результат для того же объекта с применением данного настраиваемого правила. ![Поток атрибутов 4](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp4.png)

### Длина атрибутов
Строковые атрибуты по умолчанию являются индексируемыми. Их длина не может превышать 448 знаков. При работе с атрибутами, которые могут содержать больше знаков, необходимо включить в поток атрибутов следующее значение: `attributeName` <- `Left([attributeName],448)`.

### Изменение атрибута userPrincipalSuffix
Атрибут userPrincipalName в Active Directory не всегда известен пользователям. Также он может не подходить в качестве идентификатора для входа. Мастер установки службы синхронизации Azure AD Connect позволяет выбрать другой атрибут, например mail. Но в некоторых случаях этот атрибут должен вычисляться. Например, у компании Contoso есть два каталога Azure AD: один для рабочей среды, а другой для тестовой. Пользователи в тестовом клиенте должны просто изменить суффикс в идентификаторе входа. `userPrincipalName` <- `Word([userPrincipalName],1,"@") & "@contosotest.com"`

В этом выражении берется вся часть слева от первого знака @ (Word) и сцепляется с фиксированной строкой.

### Преобразование атрибута с несколькими значениями в атрибут с одним
Некоторые атрибуты в Active Directory имеют несколько значений в схеме, даже если в средстве администрирования «Пользователи и компьютеры Active Directory» они выглядят как атрибуты с одним значением. Пример — атрибут Description. `description` <- `IIF(IsNullOrEmpty([description]),NULL,Left(Trim(Item([description],1)),448))`

В этом выражении в случае, если атрибут имеет значение, берется первый элемент (Item) в атрибуте, удаляются начальные и конечные пробелы (Trim), а затем сохраняются первые 448 знаков (Left) в строке.

### Отключение потока для атрибута
Общие сведения о сценарии в этом разделе см. в разделе [Управление потоком атрибута](#control-the-attribute-flow-process).

Существует два способа отключения потока для атрибута. Первый доступен в мастере установки и позволяет [удалить выбранные атрибуты](active-directory-aadconnect-get-started-custom.md#azure-ad-app-and-attribute-filtering). Им можно воспользоваться, если атрибут никогда не синхронизировался. Однако если вы начали синхронизацию этого атрибута и позже удалили его с помощью этой функции, то модуль синхронизации прекратит управление атрибутом и в Azure AD будут оставлены имеющиеся значения.

Если вы хотите удалить значение атрибута и гарантировать, что в будущем для него не будет включен поток, нужно создать настраиваемое правило.

В компании Fabrikam мы обнаружили, что некоторые атрибуты, синхронизируемые с облаком, лишние. Мы хотим удалить эти атрибуты из Azure AD. ![Неправильные атрибуты расширения](./media/active-directory-aadconnectsync-change-the-configuration/badextensionattribute.png)

- Создайте новое входящее правило синхронизации и укажите описание ![Описания](./media/active-directory-aadconnectsync-change-the-configuration/syncruledescription.png).
- Создайте потоки атрибута типа **Выражение** с источником **AuthoritativeNull**. Литеральный тип **AuthoritativeNull** указывает, что значение должно быть пустым в MV, даже если правило синхронизации с более низким приоритетом пытается заполнить значение. ![Преобразование атрибутов расширения](./media/active-directory-aadconnectsync-change-the-configuration/syncruletransformations.png)
- Сохраните правило синхронизации. Запустите **службу синхронизации**, найдите соединитель, выберите **Запустить** и **Полная синхронизация**. Это приведет к пересчету всех потоков атрибутов.
- Убедитесь, что требуемые изменения будут экспортированы, с помощью поиска в пространстве соединителя. ![Промежуточное удаление](./media/active-directory-aadconnectsync-change-the-configuration/deletetobeexported.png)

## Расширенная концепция

### Управление потоком атрибута
Если для передачи одного и того же атрибута метавселенной настроено несколько входящих правил синхронизации, главное из них определяется по приоритету. Для передачи значения используется правило синхронизации с наивысшим приоритетом (с самым низким числовым значением). То же самое происходит и с исходящими правилами. Для передачи значения в подключенный каталог используется правило синхронизации с наивысшим приоритетом.

В некоторых случаях правило синхронизации определяет поведение других правил, а не используется для передачи значения. В этом случае используются специальные литералы.

Для входящих правил синхронизации можно использовать литерал **NULL**. Он указывает, что в потоке нет значения для передачи. Значение может передать другое правило с более низким приоритетом. Если никакое правило не передает значение, атрибут метавселенной удаляется. Что касается исходящего правила, если после обработки всех правил синхронизации конечным значением будет **NULL**, то значение будет удалено из каталога.

Литералы **AuthoritativeNull** и **NULL** аналогичны. Разница между ними заключается в том, что при использовании литерала AuthoritativeNull правила с более низким приоритетом не могут передавать значение.

В потоке атрибута также может использоваться литерал **IgnoreThisFlow**. Он, так же как и литерал NULL, указывает, что в потоке нет значения для передачи. Разница между ними заключается в том, что при использовании литерала IgnoreThisFlow имеющееся значение в каталоге не удаляется. Это выглядит так, как будто там никогда не было потока.

Пример:

В правиле синхронизации *Out to AD – User Exchange hybrid* (Поступление в AD — пользователи гибридной среды Exchange) доступен следующий поток: `IIF([cloudSOAExchMailbox] = True,[cloudMSExchSafeSendersHash],IgnoreThisFlow)`. Это выражение читается так: если почтовый ящик пользователя расположен в Azure AD, то атрибут поступает из Azure AD в AD. Если нет, атрибуты в Active Directory не возвращаются. В этом случае в AD будет сохранено имеющееся значение.

### Функция ImportedValue
Функция ImportedValue отличается от всех других функций, поэтому имя ее атрибута должно заключаться в кавычки, а не в квадратные скобки: `ImportedValue("proxyAddresses")`.

Обычно во время синхронизации атрибут будет использовать ожидаемое значение, даже если оно еще не экспортировано или если во время экспорта произошла ошибка ("верхняя часть башни"). Во время входящей синхронизации предполагается, что атрибут, который еще не достиг связанного каталога, обязательно достигнет его. В некоторых случаях важно синхронизировать только значение, подтвержденное подключенным каталогом ("голограмма и башня импорта разницы").

Пример этого использования можно найти в стандартном правиле синхронизации *In from AD – User Common from Exchange* (Поступление из AD — все пользователи с сервера Exchange). Согласно этому правилу в гибридной среде Exchange значение, добавленное Exchange Online, должно синхронизироваться только в том случае, если был подтвержден успешный экспорт этого значения. `proxyAddresses` <- `RemoveDuplicates(Trim(ImportedValue("proxyAddresses")))`

## Дальнейшие действия

Узнайте больше о [выражениях декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning-expressions.md), используемых для потоков атрибутов.

Узнайте больше о настройке [службы синхронизации Azure AD Connect](active-directory-aadconnectsync-whatis.md).

Узнайте больше об [интеграции локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md).

<!---HONumber=AcomDC_0824_2016-->