<properties
	pageTitle="Включение единого входа в нескольких приложениях в iOS с помощью ADAL | Microsoft Azure"
	description="Использование функций ADAL SDK для включения единого входа в приложениях."
	services="active-directory"
	documentationCenter=""
	authors="brandwe"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="ios"
	ms.devlang="objective-c"
	ms.topic="article"
	ms.date="03/17/2015"
	ms.author="brandwe"/>


# Включение единого входа в нескольких приложениях iOS с помощью ADAL


Современные клиенты ожидают предоставления возможности единого входа, которая позволяет пользователям ввести учетные данные только один раз, после чего они смогут автоматически входить в разные приложения. Сложность ввода имени пользователя и пароля на маленьком экране, часто с дополнительной проверкой подлинности, например посредством звонка по телефону или кода в SMS, приводит к неудовлетворенности пользователя, если ему приходится это делать больше одного раза.

Кроме того, если вы используете платформу удостоверений, которую могут использовать другие приложения, например учетные записи Майкрософт или рабочая учетная запись из Office365, клиенты ожидают, что эти учетные данные будут доступны в приложениях независимо от поставщика.

Платформа Microsoft Identity, а также пакет SDK для Microsoft Identity делают всю сложную работу за вас и позволяют предоставить клиентам возможность единого входа в собственном наборе приложений или, как с брокером и приложениями проверки подлинности, на всем устройстве.

В этом пошаговом руководстве показано, как настроить пакет SDK в приложении для предоставления этого преимущества клиентам.

В руководстве рассматриваются следующие темы:

* Azure Active Directory
* Azure Active Directory B2C
* Azure Active Directory B2B


Обратите внимание, что в документе ниже предполагается, что вы знаете о том, как [подготовить приложения на устаревшем портале для Azure Active Directory](active-directory-how-to-integrate.md), а также что вы интегрировали приложение в [Microsoft Identity iOS SDK](https://github.com/AzureAD/azure-activedirectory-library-for-objc).

## Концепции единого входа на платформе Microsoft Identity

### Брокеры Microsoft Identity

Майкрософт предоставляет приложения для каждой мобильной платформы, которая позволяет привязывать учетные данные к приложениям от разных поставщиков, а также разрешает использовать специальные улучшенные функции, требующие единого безопасного места, из которого выполняется проверка учетных данных. Они называются **брокеры**. На iOS и Android они предоставляются в скачиваемых приложениях, которые клиенты устанавливают самостоятельно или которые компания, управляющая частью или всем устройством, передает на устройство сотрудника. Эти брокеры поддерживают управление безопасностью только для некоторых приложений или для всего устройства, в зависимости от требований ИТ-администраторов. В Windows эта функция предоставляется средством выбора учетной записи, встроенным в операционную систему (технически — брокером веб-проверки подлинности).

Чтобы узнать, как мы используем эти брокеры и как клиенты могут просмотреть их в потоке входа для платформы Microsoft Identity, ознакомьтесь с дополнительными сведениями.

### Шаблоны для входа на мобильные устройства

Доступ к учетным данным на устройствах осуществляется в соответствии с двумя основными шаблонами платформы Microsoft Identity:

* вход без помощи брокера;
* вход с помощью брокера.

#### Вход без помощи брокера

Вход без помощи брокера — это вход внутри приложения, который использует для этого приложения локальное хранилище на устройстве. К этому хранилищу может быть предоставлен доступ в других приложениях, но учетные данные строго привязаны к приложению или набору приложений, использующему эти учетные данные. Этот способ используется во многих мобильных приложениях, где имя пользователя и пароль вводятся непосредственно в приложении.

Такие имена для входа содержат следующие преимущества.

-  Пользовательский интерфейс полностью существует в приложении.
-  Учетные данные можно передавать в приложениях, которые подписаны одним сертификатом, предоставив возможность единого входа в набор приложений. 
-  Управление именем для входа предоставляется до и после входа.

Эти имена для входа имеют следующие недостатки.

- Пользователь не может выполнить единый вход во всех приложениях, использующими Microsoft Identity только в тех удостоверениях Майкрософт, которыми ваше приложение владеет и которые настроило.
- Ваше приложение невозможно использовать с более расширенными бизнес-функциями, такими как условный доступ или набор продуктов InTune.
- Ваше приложение не может поддерживать проверку подлинности бизнес-пользователей на основе сертификатов.

Ниже показано, как пакет SDK Microsoft Identity работает с общим хранилищем приложений для включения единого входа.

```
+------------+ +------------+  +-------------+
|            | |            |  |             |
|   App 1    | |   App 2    |  |   App 3     |
|            | |            |  |             |
|            | |            |  |             |
+------------+ +------------+  +-------------+
| Azure SDK  | | Azure SDK  |  | Azure SDK   |
+------------+-+------------+--+-------------+
|                                            |
|            App Shared Storage              |
+--------------------------------------------+
```

#### Вход с помощью брокера

Вход с помощью брокера — это вход, выполняемый в приложении брокера, который использует возможности хранилища и безопасности брокера для предоставления учетных данных в приложениях на устройстве, применяющем платформу Microsoft Identity. Это означает, что ваши приложения используют брокер для входа пользователей в систему. На iOS и Android они предоставляются в скачиваемых приложениях, которые клиенты устанавливают самостоятельно или которые компания передает на устройство пользователя. Пример этого типа приложений — приложение Azure Authenticator в iOS. В Windows эта функция предоставляется средством выбора учетной записи, встроенным в операционную систему (технически — брокером веб-проверки подлинности). Взаимодействие зависит от платформы и может иногда прерываться при неправильном управлении. Возможно, вы знакомы с этим шаблоном, если у вас установлено приложение Facebook и вы входите в другое приложение через Facebook. Платформа Microsoft Identity использует тот же шаблон.

Для iOS это приводит к анимации "перехода", при которой приложение отправляется в фоновом режиме, тогда как приложения Azure Authenticator отображаются на переднем плане, чтобы пользователь мог выбрать, с помощью какой учетной записи войти.

Для Android и Windows средство выбора учетной записи отображается вверху приложения, что удобнее для пользователя.

#### Способы вызова брокера

При установке совместимого брокера на устройство, например приложения Azure Authenticator, пакеты SDK Microsoft Identity автоматически будут выполнять вызов брокера, когда пользователь укажет, что хочет войти с помощью любой учетной записи платформы Microsoft Identity. Это может быть персональной учетной записью Майкрософт, рабочей или учебной учетной записью либо учетной записью, предоставленной и размещенной в Azure с использованием продуктов B2C и B2B. Надежные алгоритмы защиты и шифрование гарантируют, что учетные данные запрашиваются и возвращаются безопасным способом. Точные технические сведения об этих механизмах не публикуются, но их совместной разработкой занимались Apple и Google.

**Разработчик может выбрать, будет ли SDK Microsoft Identity вызывать брокера или использовать поток без помощи брокера.** Однако если разработчик не будет использовать поток с помощью брокера, он потеряет преимущество ввода учетных данных для единого входа, которое пользователь уже добавил на устройство, а также предотвратит использование приложения бизнес-функциями, которые Майкрософт предоставляет клиентам, такими как условный доступ, возможности управления Intune и проверка подлинности на основе сертификатов.

Такие имена для входа содержат следующие преимущества.

-  Пользователь использует единый вход во всех приложениях, независимо от поставщика.
-  Приложение может использовать более расширенные бизнес-функции, такие как условный доступ или набор продуктов InTune.
-  Ваше приложение может поддерживать проверку подлинности бизнес-пользователей на основе сертификатов.
- Гораздо более безопасный вход, так как удостоверение приложения и пользователь проверяются приложением брокера с дополнительными алгоритмами безопасности и шифрованием.

Эти имена для входа имеют следующие недостатки.

- В iOS пользователь выходит из приложения во время выбора учетных данных.
- Невозможность управления входом для клиентов в приложении.



Ниже показано, как пакеты SDK Microsoft Identity работают с приложениями брокера для обеспечения единого входа.

```
+------------+ +------------+   +-------------+
|            | |            |   |             |
|   App 1    | |   App 2    |   |   Someone   |
|            | |            |   |    Else's   |
|            | |            |   |     App     |
+------------+ +------------+   +-------------+
| Azure SDK  | | Azure SDK  |   | Azure SDK   |
+-----+------+-+-----+------+-  +-------+-----+
      |              |                  |
      |       +------v------+           |
      |       |             |           |
      |       | Microsoft   |           |
      +-------> Broker      |^----------+
              | Application
              |             |
              +-------------+
              |             |
              |   Broker    |
              |   Storage   |
              |             |
              +-------------+
```
              
Зная эти общие сведения, вы сможете лучше понять принцип работы единого входа и реализовать его в приложении с помощью платформы и пакетов SDK Microsoft Identity.


## Включение единого входа в нескольких приложениях с помощью ADAL

Здесь SDK ADAL iOS будет использоваться в следующих целях:

- включение единого входа без помощи брокера для набора приложений;
- включение поддержки для единого входа с помощью брокера.

### Включение единого входа без помощи брокера

При едином входе без помощи брокера в приложениях пакеты SDK Microsoft Identity управляют большинством сложных процессов единого входа. Сюда входит поиск нужного пользователя в кэше и обслуживание списка выполнивших вход пользователей для вашего запроса.

Чтобы включить единый вход в своих приложениях, необходимо сделать следующее.

1. Убедитесь, что все приложения используют один идентификатор клиента или приложения. 
* Убедитесь, что все приложения имеют один и тот же самозаверяющий сертификат от Apple для общего доступа к цепочкам ключей.
* Запросите одинаковое назначение цепочки ключей для каждого из приложений.
* Сообщите SDK Microsoft Identity об общей цепочке ключей, которую вы хотите использовать.

#### Использование одного идентификатора клиента или приложения для всех приложений в наборе

Чтобы платформа Microsoft Identity получила разрешение на использование общих токенов в приложениях, каждому из приложений потребуется предоставить один идентификатор клиента или приложения. Это уникальный идентификатор, предоставленный вам при регистрации первого приложения на портале.

Возможно, вы не знаете, как идентифицировать разные приложения в службе Microsoft Identity, если она использует тот же идентификатор приложения. Все дело в **URI перенаправления**. Каждое приложение может иметь несколько URI перенаправления, зарегистрированных на портале регистрации. Каждое приложение в наборе получит уникальный URI перенаправления. Пример того, как это выглядит, см. ниже:

URI перенаправления App1: `x-msauth-mytestiosapp://com.myapp.mytestapp`

URI перенаправления App2: `x-msauth-mytestiosapp://com.myapp.mytestapp2`

URI перенаправления App3: `x-msauth-mytestiosapp://com.myapp.mytestapp3`

....

Они вложены в один идентификатор клиента или приложения и ищутся на основе URI перенаправления, возвращаемого в конфигурацию SDK.

```
+-------------------+
|                   |
|  Client ID        |
+---------+---------+
          |
          |           +-----------------------------------+
          |           |  App 1 Redirect URI               |
          +----------^+                                   |
          |           +-----------------------------------+
          |
          |           +-----------------------------------+
          +----------^+  App 2 Redirect URI               |
          |           |                                   |
          |           +-----------------------------------+
          |
          +----------^+-----------------------------------+
                      |  App 3 Redirect URI               |
                      |                                   |
                      +-----------------------------------+

```


*Обратите внимание, что формат URI перенаправления представлен ниже. Вы можете использовать любой URI перенаправления, если не хотите поддерживать брокера: в этом случае он будет выглядеть, как показано выше*



#### Создание общей цепочки ключей между приложениями

Включение общей цепочки ключей находится за пределами области этого документа и охватывается Apple в документе [Добавление возможностей](https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/AddingCapabilities/AddingCapabilities.html). Важно, что именно вы решаете, как следует назвать цепочку ключей, и добавляете эту возможность во всех приложениях.

Если у вас правильно настроены назначения, в каталоге проекта появится файл `entitlements.plist`, содержимое которого аналогично следующему:

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>keychain-access-groups</key>
	<array>
		<string>$(AppIdentifierPrefix)com.myapp.mytestapp</string>
		<string>$(AppIdentifierPrefix)com.myapp.mycache</string>
	</array>
</dict>
</plist>
```

После включения назначения цепочки ключей в каждом из приложений, если вы готовы использовать единый вход, используйте цепочку ключей в пакете SDK Microsoft Identity в `ADAuthenticationSettings` с помощью следующего параметра:

```
defaultKeychainSharingGroup=@"com.myapp.mycache";
```

> [AZURE.WARNING] 
При предоставлении цепочки ключей в приложениях любое приложение может удалить пользователей или даже все токены в приложении. Это особенно катастрофично, если фоновая работа некоторых приложений зависит от токенов. Общий доступ к цепочке ключей означает, что вы должны быть очень аккуратны при операциях удаления, выполняемых через SDK Microsoft Identity.

Вот и все! Теперь пакет SDK для Microsoft Identity предоставит учетные данные во все приложения. Кроме того, во все экземпляры приложений будет отправлен список пользователей.

### Включение единого входа с помощью брокера

Возможность использовать любого брокера, который установлен на устройстве, **по умолчанию выключена** в приложении. Чтобы использовать приложение с брокером, необходимо выполнить дополнительную настройку и добавить код в приложение.

Шаги для выполнения:

1. Включите режим брокера в вызове MS SDK кода приложения.
2. Установите новый URI перенаправления и предоставьте его приложению и для регистрации приложения.
3. Регистрация схемы URL-адреса.
4. Поддержка iOS9: добавление разрешения в файл info.plist.


#### Шаг 1. Включение режима брокера в приложении
Возможность для приложения использовать брокера включена при создании "контекста" и первоначальной настройке объекта проверки подлинности. Она выполняется путем настройки типа учетных данных в коде.

```
/*! See the ADCredentialsType enumeration definition for details */
@propertyADCredentialsType credentialsType;
```
Настройка `AD_CREDENTIALS_AUTO` позволит пакету SDK Microsoft Identity попробовать вызвать брокера, `AD_CREDENTIALS_EMBEDDED` предотвратит вызов брокера из SDK Microsoft Identity.

#### Шаг 2. Регистрация схемы URL-адреса
Платформа Microsoft Identity использует URL-адреса для вызова брокера, а затем возвращает элемент управления в приложение. Чтобы завершить этот цикл, требуется схема URL-адреса, зарегистрированная для приложения, о котором платформа Microsoft Identity узнает. Она может быть дополнением к другим схемам безопасности, которые вы зарегистрировали в приложении.

> [AZURE.WARNING] 
Рекомендуется сделать схему URL-адреса уникальной, чтобы свести к минимуму вероятность использования той же схемы URL-адреса другим приложением. Apple не обеспечивает уникальность схем URL-адреса, зарегистрированных в магазине приложений.

Ниже представлен пример того, как это показано в конфигурации проекта. Также это можно сделать в XCode:

```
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLName</key>
        <string>com.myapp.mytestapp</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>x-msauth-mytestiosapp</string>
        </array>
    </dict>
</array>
```

#### Шаг 3. Установка нового URI перенаправления в схеме URL-адреса

Чтобы обеспечить обязательный возврат токенов учетных данных в нужное приложение, необходимо убедиться, что мы выполняем обратный вызов в приложение таким способом, который операционная система iOS может проверить. Операционная система iOS передает идентификатор набора вызывающего приложения в приложения брокера Майкрософт. Стороннее приложение не может подделать его. Следовательно, он будет использоваться с URI приложения брокера для обеспечения возврата токенов в нужное приложение. Этот уникальный URI перенаправления необходимо установить в приложении и задать в качестве URI перенаправления на портале разработчиков.

URI перенаправления должен быть указан в правильной форме:

`<app-scheme>://<your.bundle.id>`

Пример: *x-msauth-mytestiosapp://com.myapp.mytestapp*

Этот URI перенаправления должен быть указан при регистрации приложения на [классическом портале Azure](https://manage.windowsazure.com/). Дополнительные сведения о регистрации приложения Azure AD см. в статье [Интеграция в Azure Active Directory](active-directory-how-to-integrate.md).


##### Шаг 3а. Добавление URI перенаправления в приложение и на портал разработчика для поддержки проверки подлинности на основе сертификатов

Чтобы поддержать проверку подлинности на основе сертификатов, необходимо зарегистрировать второй "msauth" в приложении и на [классическом портале Azure](https://manage.windowsazure.com/) для обработки проверки подлинности сертификатов, если вы хотите добавить эту поддержку в приложение.

`msauth://code/<broker-redirect-uri-in-url-encoded-form>`

Пример: * *msauth://code/x-msauth-mytestiosapp%3A%2F%2Fcom.myapp.mytestapp*


#### Шаг 4. iOS9: добавление параметра конфигурации в приложение

ADAL использует –canOpenURL для проверки того, установлен ли брокер на устройстве. В iOS 9 Apple заблокированы схемы, которые может запрашивать приложение. Вам потребуется вручную добавить "msauth" в раздел LSApplicationQueriesSchemes `info.plist file`.

<key>LSApplicationQueriesSchemes</key> <array> <string>msauth</string> </array>

### Вы настроили единый вход!

Теперь пакет SDK для Microsoft Identity будет автоматически предоставлять учетные данные в приложения и вызывать брокера, если он есть на устройстве.

<!---HONumber=AcomDC_0323_2016-->