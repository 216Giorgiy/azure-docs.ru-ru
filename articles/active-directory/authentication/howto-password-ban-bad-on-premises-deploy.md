---
title: Развертывание защиты паролем Azure AD (предварительная версия)
description: Развертывание предварительной версии защиты паролем Azure AD для запрета неправильных паролей в локальной среде
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: article
ms.date: 02/01/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: jsimmons
ms.openlocfilehash: 824bedf782d6d227f2fa3adcf52492bb5a3eb478
ms.sourcegitcommit: a65b424bdfa019a42f36f1ce7eee9844e493f293
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/04/2019
ms.locfileid: "55696869"
---
# <a name="preview-deploy-azure-ad-password-protection"></a>Предварительный просмотр: Развертывание защиты паролем Azure AD

|     |
| --- |
| Защита паролем Azure AD — это общедоступная предварительная версия функции Azure Active Directory. См. дополнительные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

Теперь, когда у вас есть представление о том [, как обеспечить защиту паролем Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md), следующим шагом будет планирование и выполнение развертывания.

## <a name="deployment-strategy"></a>Стратегия развертывания

Корпорация Майкрософт предполагает, что любое развертывание начинается в режиме аудита. Режим аудита — это начальная настройка по умолчанию, где можно настроить пароли и создать записи в журнале событий о всех блокируемых паролях. После того как прокси-серверы и агенты контроллеров доменов полностью развернуты в режиме аудита, следует выполнять регулярное отслеживание, чтобы определить, как принудительное применение политики паролей будет влиять на пользователей и среду, если политика будет применена.

На этапе аудита многие организации обнаруживают следующее:

* Необходимо улучшить имеющиеся операционные процессы, чтобы использовать более безопасные пароли.
* Пользователи привыкли регулярно выбирать незащищенные пароли.
* Нужно информировать пользователей о предстоящих изменениях в обеспечении безопасности, о том, какое влияние они могут оказать на них, и помочь им лучше понять, как они могут выбирать более безопасные пароли.

После того как функция была запущена в режиме аудита в разумные сроки, конфигурацию принудительного выполнения можно сменить с **Аудит** на **Принудительно**, тем самым требуя более безопасные пароли. Детальный мониторинг в это время — хорошая идея.

## <a name="deployment-requirements"></a>Требования к развертыванию

* Все контроллеры домена, на которые будет установлена служба агента контроллера домена защиты паролем Azure AD, должны работать под управлением Windows Server 2012 или более поздней версии.
* Все компьютеры, на которые будет установлена прокси-служба защиты паролем Azure AD, должны работать под управлением Windows Server 2012 R2 или более поздней версии.
* На всех компьютерах с установленными компонентами защиты паролем Azure AD, включая контроллеры домена, должна быть установлена универсальная среда выполнения C.
Лучше всего это выполнить, установив все исправления на компьютеры с помощью Центра обновления Windows. В противном случае может быть установлен соответствующий пакет обновления для установленной операционной системы. Дополнительные сведения см. в разделе [Обновление для универсальной среды выполнения C в Windows](https://support.microsoft.com/help/2999226/update-for-universal-c-runtime-in-windows).
* Необходимо настроить сетевое подключение минимум между одним контроллером домена в каждом домене и одним сервером, на котором установлена ​​прокси-служба защиты паролем Azure AD. Это подключение должно обеспечить доступ контроллера домена к порту сопоставителя конечных точек RPC (135) и порту сервера RPC в прокси-службе. Порт сервера RPC по умолчанию является динамическим портом RPC, но может быть настроено и использование статического порта (см. ниже).
* Всем компьютерам, на которых размещена служба прокси-сервера для защиты паролем Azure AD, требуется сетевой доступ к следующим конечным точкам:

    |Конечная точка |Назначение|
    | --- | --- |
    |`https://login.microsoftonline.com`|Запросы на аутентификацию|
    |`https://enterpriseregistration.windows.net`|Функция защиты паролем Azure AD|

* Нужна учетная запись глобального администратора для регистрации леса и прокси-службы защиты паролем Azure AD в Azure AD.
* Нужна учетная запись с привилегиями администратора домена Active Directory в корневом домене леса, чтобы зарегистрировать лес Windows Server Active Directory в Azure AD.
* Все домены Active Directory, на которых работает программное обеспечение службы агента контроллера домена, должны использовать DFSR для репликации sysvol.

## <a name="single-forest-deployment"></a>Развертывание одного леса

На следующей схеме показано, как основные компоненты защиты паролем Azure AD работают вместе в локальной среде Active Directory.  

![Взаимодействие компонентов защиты паролем Azure AD](./media/concept-password-ban-bad-on-premises/azure-ad-password-protection.png)

### <a name="download-the-software"></a>Скачивание ПО

Для защиты паролем Azure AD имеется два обязательных установщика, которые можно скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=57071).

### <a name="install-and-configure-the-azure-ad-password-protection-proxy-service"></a>Установка и настройка службы прокси-сервера защиты паролем Azure AD

1. Выберите один или несколько серверов для размещения службы прокси-сервера защиты паролем Azure AD.
   * Каждая такая служба может предоставлять только политики паролей для одного леса, а хост-компьютер должен быть присоединен к домену (поддерживаются корневые и дочерние) в этом лесу. Для работы службы прокси-сервера защиты паролем Azure AD необходимо наличие сетевого соединения между по меньшей мере одним контроллером домена в каждом домене леса и компьютером прокси-сервера защиты паролем Azure AD.
   * Поддерживается установка и запуск службы прокси-сервера защиты паролем Azure AD на контроллере домена для тестирования. Недостатком является то, что контроллеру домена требуется подключение к Интернету, что может представлять угрозу безопасности. Корпорация Майкрософт рекомендует использовать эту конфигурацию только для тестирования.
   * В целях избыточности рекомендуется использовать не менее двух прокси-серверов. Ознакомьтесь с разделом [Высокая доступность](howto-password-ban-bad-on-premises-deploy.md#high-availability).

2. Установите службу прокси-сервера защиты паролем Azure AD с помощью пакета MSI AzureADPasswordProtectionProxySetup.msi.
   * Для этого не требуется перезагрузка. Установку программного обеспечения можно автоматизировать с использованием стандартных процедур MSI, например: `msiexec.exe /i AzureADPasswordProtectionProxySetup.msi /quiet /qn`

      > [!NOTE]
      > Служба брандмауэра Windows должна быть запущена перед установкой пакета MSI AzureADPasswordProtectionProxySetup.msi, иначе произойдет ошибка установки. Если брандмауэр Windows настроен так, что он не запускается, временное решение заключается в том, чтобы временно включить и запустить службу брандмауэра Windows во время процесса установки. Программное обеспечение прокси-сервера не зависит от программного обеспечения брандмауэра Windows после установки. Если вы используете сторонний брандмауэр, он все равно должен соответствовать требованиям к развертыванию (разрешить входящий доступ к порту 135 и порту прокси-сервера RPC, будь то динамический или статический). См. раздел [Требования к развертыванию](howto-password-ban-bad-on-premises-deploy.md#deployment-requirements).

3. Откройте окно PowerShell от имени администратора.
   * ПО прокси-сервера защиты паролем Azure AD содержит новый модуль PowerShell с именем AzureADPasswordProtection. Следующие шаги основаны на запуске различных командлетов из этого модуля PowerShell и предполагают, что вы открыли новое окно PowerShell и импортировали новый модуль следующим образом:

      ```PowerShell
      Import-Module AzureADPasswordProtection
      ```

   * Убедитесь, что служба выполняется с помощью следующей команды PowerShell: `Get-Service AzureADPasswordProtectionProxy | fl`.
     Результат должен иметь **состояние** "Выполняется".

4. Зарегистрируйте прокси-сервер.
   * После того как шаг 3 был завершен, служба прокси-сервера защиты паролем Azure AD выполняется на компьютере, но еще не имеет необходимых учетных данных для связи с Azure AD. Для активации этой возможности с помощью командлета PowerShell `Register-AzureADPasswordProtectionProxy` требуется регистрация с использованием Azure AD. Командлет требует учетные данные глобального администратора для вашего клиента Azure, а также права локального администратора домена Active Directory в корневом домене леса. После успешного выполнения для данной службы прокси-сервера дополнительные вызовы `Register-AzureADPasswordProtectionProxy` продолжают выполняться, но они не нужны.

      Командлет Register-AzureADPasswordProtectionProxy поддерживает три различных режима проверки подлинности.

      * Интерактивный режим проверки подлинности.

         ```PowerShell
         Register-AzureADPasswordProtectionProxy -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com'
         ```
         > [!NOTE]
         > Этот режим не будет работать в операционных системах Server Core. Вместо этого используйте один из альтернативных режимов проверки подлинности, как описано ниже.

         > [!NOTE]
         > Этот режим может завершиться сбоем, если включена конфигурация усиленной безопасности Internet Explorer (IESC). Чтобы обойти эту проблему, можно отключить IESC, зарегистрировать прокси-сервер, а затем повторно включить IESC.

      * Режим проверки подлинности по коду устройства.

         ```PowerShell
         Register-AzureADPasswordProtectionProxy -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com' -AuthenticateUsingDeviceMode
         To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code XYZABC123 to authenticate.
         ```

         Затем можно завершить проверку подлинности, следуя инструкциям, отображаемым на другом устройстве.

      * Режим автоматической проверки подлинности (на основе пароля).

         ```PowerShell
         $globalAdminCredentials = Get-Credential
         Register-AzureADPasswordProtectionForest -AzureCredential $globalAdminCredentials
         ```

         > [!NOTE]
         > Этот режим завершится сбоем, если по какой-либо причине для проверки подлинности требуется MFA. В этом случае используйте один из двух предыдущих режимов для выполнения проверки подлинности на основе MFA.

      В настоящее время не требуется указывать параметр -ForestCredential, зарезервированный для будущих функций.

   > [!NOTE]
   > Ожидается, что регистрация службы прокси-сервера защиты паролем Azure AD будет одноразовым действием на время существования службы. С этого момента служба прокси-сервера будет автоматически выполнять любые требуемые операции. После успешного выполнения для данного прокси-сервера дополнительные вызовы Register-AzureADPasswordProtectionProxy продолжают выполняться, но они не нужны.

   > [!TIP]
   > При первом запуске этого командлета для данного клиента Azure он может завершиться со значительной задержкой. Если не сообщается об ошибке, эта задержка вполне нормальна.

5. Зарегистрируйте лес.
   * Локальный лес Active Directory следует инициализировать с необходимыми учетными данными для связи с Azure с помощью командлета `Register-AzureADPasswordProtectionForest` PowerShell. Командлет требует учетные данные глобального администратора для вашего клиента Azure, а также права локального администратора домена Active Directory в корневом домене леса. Этот шаг выполняется один раз в каждом лесу.

      Командлет Register-AzureADPasswordProtectionForest поддерживает три различных режима проверки подлинности.

      * Интерактивный режим проверки подлинности.

         ```PowerShell
         Register-AzureADPasswordProtectionForest -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com'
         ```
         > [!NOTE]
         > Этот режим не будет работать в операционных системах Server Core. Вместо этого используйте один из альтернативных режимов проверки подлинности, как описано ниже.

         > [!NOTE]
         > Этот режим может завершиться сбоем, если включена конфигурация усиленной безопасности Internet Explorer (IESC). Чтобы обойти эту проблему, можно отключить IESC, зарегистрировать прокси-сервер, а затем повторно включить IESC.  

      * Режим проверки подлинности по коду устройства.

         ```PowerShell
         Register-AzureADPasswordProtectionForest -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com' -AuthenticateUsingDeviceMode
         To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code XYZABC123 to authenticate.
         ```

         Затем можно завершить проверку подлинности, следуя инструкциям, отображаемым на другом устройстве.

      * Режим автоматической проверки подлинности (на основе пароля).
         ```PowerShell
         $globalAdminCredentials = Get-Credential
         Register-AzureADPasswordProtectionForest -AzureCredential $globalAdminCredentials
         ```

         > [!NOTE]
         > Этот режим завершится сбоем, если для проверки подлинности требуется MFA. В этом случае используйте один из двух предыдущих режимов для выполнения проверки подлинности на основе MFA.

      Пример работает, только если текущий зарегистрированный пользователь также является администратором домена Active Directory для корневого домена. Если это не так, можно указать альтернативные учетные данные домена с помощью параметра -ForestCredential.

   > [!NOTE]
   > Если в вашей среде установлено несколько прокси-серверов, неважно, какой прокси-сервер используется для регистрации леса.

   > [!TIP]
   > При первом запуске этого командлета для данного клиента Azure он может завершиться со значительной задержкой. Если не сообщается об ошибке, эта задержка вполне нормальна.

   > [!NOTE]
   > Ожидается, что регистрация леса Active Directory будет одноразовым действием на время существования леса. С этого момента агенты контроллера домена в лесу будут автоматически выполнять любые требуемые операции. После успешного выполнения для данного леса дополнительные вызовы `Register-AzureADPasswordProtectionForest` продолжают выполняться, но они не нужны.

   > [!NOTE]
   > Для успешного выполнения `Register-AzureADPasswordProtectionForest` хотя бы один контроллер домена Windows Server 2012 или более поздней версии должен быть доступен в домене прокси-сервера. Но до этого шага установленное программное обеспечение агента контроллера домена не требуется на контроллерах домена.

6. Настройка службы прокси-сервера защиты паролем Azure AD для взаимодействия через прокси-сервер HTTP

   Если в вашей среде для связи с Azure требуется использовать определенный прокси-сервер HTTP, это можно сделать следующим образом.

   Создайте файл с именем `proxyservice.exe.config` в папке `%ProgramFiles%\Azure AD Password Protection Proxy\Service` со следующим содержимым:

      ```xml
      <configuration>
        <system.net>
          <defaultProxy enabled="true">
           <proxy bypassonlocal="true"
               proxyaddress="http://yourhttpproxy.com:8080" />
          </defaultProxy>
        </system.net>
      </configuration>
      ```

   Если прокси-сервер HTTP требует проверку подлинности, добавьте тег useDefaultCredentials следующим образом.

      ```xml
      <configuration>
        <system.net>
          <defaultProxy enabled="true" useDefaultCredentials="true">
           <proxy bypassonlocal="true"
               proxyaddress="http://yourhttpproxy.com:8080" />
          </defaultProxy>
        </system.net>
      </configuration>
      ```

   В обоих случаях вы замените `http://yourhttpproxy.com:8080` адресом и портом определенного прокси-сервера HTTP.

   Если на прокси-сервере HTTP настроена политика авторизации, доступ должен быть предоставлен учетной записи компьютера Active Directory, на виртуальной машине которого размещена служба прокси-сервера защиты паролем Azure AD.

   Остановите и перезапустите службу прокси-сервера защиты паролем Azure AD после создания или обновления файла `proxyservice.exe.config`.

   Служба прокси защиты паролем Azure AD не поддерживает использование определенных учетных данных для подключения к прокси-серверу HTTP.

7. Необязательно: Настройте службу прокси-сервера защиты паролем Azure AD для ожидания передачи данных на определенном порту.
   * RPC через TCP используется программным обеспечением агента контроллера домена защиты паролем Azure AD на контроллерах домена для связи со службой прокси-сервера защиты паролем Azure AD. По умолчанию служба прокси-сервера защиты паролем Azure AD ожидает передачи данных на любой доступной динамической конечной точке RPC. При необходимости из-за требований к топологии сети или брандмауэра службу можно настроить для ожидания передачи данных на определенном TCP-порту.
      * Чтобы настроить службу для запуска на статическом порту, используйте командлет `Set-AzureADPasswordProtectionProxyConfiguration`.
         ```PowerShell
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort <portnumber>
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

      * Чтобы настроить службу для запуска на динамическом порту, используйте ту же процедуру, но сбросьте значение StaticPort до нуля, например:
         ```PowerShell
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort 0
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

   > [!NOTE]
   > Служба прокси-сервера защиты паролем Azure AD требует ручного перезапуска после любого изменения конфигурации порта. Не нужно перезапускать программное обеспечение службы агента контроллера домена, запущенное на контроллерах домена, после внесения таких изменений конфигурации.

   * Текущую конфигурацию службы можно запросить с помощью командлета `Get-AzureADPasswordProtectionProxyConfiguration`, как показано в следующем примере:

      ```PowerShell
      Get-AzureADPasswordProtectionProxyConfiguration | fl

      ServiceName : AzureADPasswordProtectionProxy
      DisplayName : Azure AD password protection Proxy
      StaticPort  : 0
      ```

### <a name="install-the-azure-ad-password-protection-dc-agent-service"></a>Установка службы агента контроллера домена защиты паролем Azure AD

   Установка программного обеспечения службы агента контроллера домена защиты паролем Azure AD с помощью пакета MSI `AzureADPasswordProtectionDCAgent.msi`

   При установке или удалении программного обеспечения требуется перезагрузка из-за требования операционной системы выгружать и загружать DLL-файлы только при перезагрузке.

   Поддерживается установка службы агента контроллера домена на компьютере, который еще не является контроллером домена. В этом случае служба запустится и будет выполняться, но в противном случае будет неактивна, пока уровень компьютера не будет повышен до контроллера домена.

   Установку программного обеспечения можно автоматизировать с использованием стандартных процедур MSI, например:

   `msiexec.exe /i AzureADPasswordProtectionDCAgent.msi /quiet /qn`

   > [!WARNING]
   > Пример выполнения команды msiexec приведет к немедленной перезагрузке. Этого можно избежать, установив флажок `/norestart`.

После установки на контроллере домена и перезагрузки установка программного обеспечения агента контроллера домена защиты паролем Azure AD будет завершена. Дальнейшая настройка не требуется.

## <a name="multiple-forest-deployments"></a>Развертывание в нескольких лесах

Дополнительные требования для развертывания защиты паролем Azure AD в нескольких лесах отсутствуют. Каждый лес настраивается независимо, как описано в разделе развертывания единого леса. Каждая служба прокси-сервера защиты паролем Azure AD поддерживает только контроллеры домена из леса, к которому она присоединена. Программное обеспечение защиты паролей Azure AD в данном лесу не знает о программном обеспечении защиты паролем Azure AD, развернутом в другом лесу, независимо от конфигураций доверия Active Directory.

## <a name="read-only-domain-controllers"></a>Контроллеры домена только для чтения

Изменения или настройка паролей никогда не обрабатываются и не сохраняются на контроллерах домена только для чтения (RODC). Вместо этого они перенаправляются на контроллеры домена с возможностью записи. Поэтому нет необходимости устанавливать программное обеспечение агента контроллера домена на контроллерах домена только для чтения.

## <a name="high-availability"></a>высокую доступность;

Основной проблемой обеспечения высокой доступности защиты паролем Azure AD является наличие прокси-серверов, когда контроллеры домена в лесу пытаются загрузить новые политики или другие данные от Azure. Каждый агент контроллера домена использует простой циклический алгоритм при выборе того, какой прокси-сервер должен вызываться, и пропускает прокси-серверы, которые не отвечают. Для большинства полностью подключенных развертываний Active Directory с работоспособной репликацией (как каталога, так и состояния sysvol) должно быть достаточно двух (2) прокси-серверов, чтобы обеспечить доступность и своевременную загрузку новых политик и других данных. Дополнительные прокси-серверы могут быть развернуты по желанию.

Обычные проблемы, связанные с высокой доступностью, сокращаются благодаря структуре программного обеспечения агента контроллера домена. Агент контроллера домена поддерживает локальный кэш последней скачанной политики паролей. Даже если все зарегистрированные прокси-серверы по какой-либо причине становятся недоступными, агенты контроллера домена продолжают применять свою политику кэширования паролей. Разумная частота обновления политик паролей при большом развертывании обычно составляет несколько дней, а не часов или меньше. Поэтому краткие отключения прокси-серверов не оказывают существенного влияния на работу функции защиты паролем Azure AD или ее преимуществ обеспечения безопасности.

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда вы установили службы, необходимые для защиты паролем Azure AD на локальных серверах, выполните [конфигурацию после установки и получите сведения о событиях ](howto-password-ban-bad-on-premises-operations.md), чтобы завершить развертывание.

[Предварительная версия. Применение защиты паролем Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md)
