---
title: Развертывание предварительной версии защиты паролем Azure AD
description: Развертывание предварительной версии защиты паролем Azure AD для запрета неправильных паролей в локальной среде
services: active-directory
ms.service: active-directory
ms.component: authentication
ms.topic: article
ms.date: 10/30/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: jsimmons
ms.openlocfilehash: c74cd5c8a8cfd00d61006c7ebbc4ced299b68e40
ms.sourcegitcommit: 9999fe6e2400cf734f79e2edd6f96a8adf118d92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2019
ms.locfileid: "54422259"
---
# <a name="preview-deploy-azure-ad-password-protection"></a>Предварительный просмотр: Развертывание защиты паролем Azure AD

|     |
| --- |
| Защита паролем Azure AD — это общедоступная предварительная версия функции Azure Active Directory. См. дополнительные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

Теперь, когда у вас есть представление о том [, как обеспечить защиту паролем Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md), следующим шагом будет планирование и выполнение развертывания.

## <a name="deployment-strategy"></a>Стратегия развертывания

Корпорация Майкрософт предполагает, что любое развертывание начинается в режиме аудита. Режим аудита — это начальная настройка по умолчанию, где можно настроить пароли и создать записи в журнале событий о всех блокируемых паролях. После того как прокси-серверы и агенты контроллеров доменов полностью развернуты в режиме аудита, следует выполнять регулярное отслеживание, чтобы определить, как принудительное применение политики паролей будет влиять на пользователей и среду, если политика будет применена.

На этапе аудита многие организации обнаруживают следующее:

* Необходимо улучшить имеющиеся операционные процессы, чтобы использовать более безопасные пароли.
* Пользователи привыкли регулярно выбирать незащищенные пароли.
* Нужно информировать пользователей о предстоящих изменениях в обеспечении безопасности, о том, какое влияние они могут оказать на них, и помочь им лучше понять, как они могут выбирать более безопасные пароли.

После того как функция была запущена в режиме аудита в разумные сроки, конфигурацию принудительного выполнения можно сменить с **Аудит** на **Принудительно**, тем самым требуя более безопасные пароли. Детальный мониторинг в это время — хорошая идея.

## <a name="deployment-requirements"></a>Требования к развертыванию

* Все контроллеры домена, на которые будет установлена служба агента контроллера домена защиты паролем Azure AD, должны работать под управлением Windows Server 2012 или более поздней версии.

   > [!NOTE]
   > Операционные системы на базе основных серверных компонентов в настоящее время не поддерживаются. Эта поддержка запланирована в общедоступной версии.

* Все компьютеры, на которые будет установлена прокси-служба защиты паролем Azure AD, должны работать под управлением Windows Server 2012 R2 или более поздней версии.

   > [!NOTE]
   > Операционные системы на базе основных серверных компонентов в настоящее время не поддерживаются. Эта поддержка запланирована в общедоступной версии.

* На всех компьютерах с установленными компонентами защиты паролем Azure AD, включая контроллеры домена, должна быть установлена универсальная среда выполнения C.
Лучше всего это выполнить, установив все исправления на компьютеры с помощью Центра обновления Windows. В противном случае может быть установлен соответствующий пакет обновления для установленной операционной системы. Дополнительные сведения см. в разделе [Обновление для универсальной среды выполнения C в Windows](https://support.microsoft.com/help/2999226/update-for-universal-c-runtime-in-windows).
* Необходимо настроить сетевое подключение минимум между одним контроллером домена в каждом домене и одним сервером, на котором установлена ​​прокси-служба защиты паролем Azure AD. Это подключение должно обеспечить доступ контроллера домена к порту сопоставителя конечных точек RPC (135) и порту сервера RPC в прокси-службе.  Порт сервера RPC по умолчанию является динамическим портом RPC, но может быть настроено и использование статического порта (см. ниже).
* Все компьютеры, на которых размещена служба прокси-сервера для защиты паролем Azure AD, должны иметь сетевой доступ к следующим конечным точкам:

    |Конечная точка |Назначение|
    | --- | --- |
    |`https://login.microsoftonline.com`|Запросы на аутентификацию|
    |`https://enterpriseregistration.windows.net`|Функция защиты паролем Azure AD|

* Нужна учетная запись глобального администратора для регистрации леса и прокси-службы защиты паролем Azure AD в Azure AD.
* Нужна учетная запись с привилегиями администратора домена Active Directory в корневом домене леса, чтобы зарегистрировать лес Windows Server Active Directory в Azure AD.
* Все домены Active Directory, на которых работает программное обеспечение службы агента контроллера домена, должны использовать DFSR для репликации sysvol.

## <a name="single-forest-deployment"></a>Развертывание одного леса

Предварительная версия защиты паролем Azure AD развертывается с помощью службы прокси-сервера на двух серверах, а службу агента контроллера домена можно постепенно развернуть на всех контроллерах домена в лесу Active Directory.

![Взаимодействие компонентов защиты паролем Azure AD](./media/concept-password-ban-bad-on-premises/azure-ad-password-protection.png)

### <a name="download-the-software"></a>Скачивание ПО

Для защиты паролем Azure AD имеется два обязательных установщика, которые можно скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=57071).

### <a name="install-and-configure-the-azure-ad-password-protection-proxy-service"></a>Установка и настройка службы прокси-сервера защиты паролем Azure AD

1. Выберите один или несколько серверов для размещения службы прокси-сервера защиты паролем Azure AD.
   * Каждая такая служба может предоставлять только политики паролей для одного леса, а хост-компьютер должен быть присоединен к домену (поддерживаются корневые и дочерние) в этом лесу. Для работы службы прокси-сервера защиты паролем Azure AD необходимо наличие сетевого соединения между по меньшей мере одним контроллером домена в каждом домене леса и хост-компьютером прокси-сервера защиты паролем Azure AD.
   * Поддерживается установка и запуск службы прокси-сервера защиты паролем Azure AD на контроллере домена для тестирования, но затем для него требуется подключение к Интернету.

   > [!NOTE]
   > Общедоступная предварительная версия поддерживает не более двух (2) прокси-серверов на один лес.

2. Установите программное обеспечение службы прокси-сервера политики паролей, используя пакет MSI AzureADPasswordProtectionProxy.msi.
   * Для этого не требуется перезагрузка. Установку программного обеспечения можно автоматизировать с использованием стандартных процедур MSI, например: `msiexec.exe /i AzureADPasswordProtectionProxy.msi /quiet /qn`

      > [!NOTE]
      > Служба брандмауэра Windows должна быть запущена перед установкой пакета MSI AzureADPasswordProtectionProxy.msi, иначе произойдет ошибка установки. Если брандмауэр Windows настроен так, что он не запускается, временное решение заключается в том, чтобы временно включить и запустить службу брандмауэра Windows во время процесса установки. Обеспечение прокси-сервера не имеет конкретной зависимости от программного обеспечения брандмауэра Windows после установки. Если вы используете сторонний брандмауэр, он все равно должен соответствовать требованиям к развертыванию (разрешить входящий доступ к порту 135 и порту прокси-сервера RPC, будь то динамический или статический). См. раздел [Требования к развертыванию](howto-password-ban-bad-on-premises-deploy.md#deployment-requirements).

3. Откройте окно PowerShell от имени администратора.
   * ПО прокси-сервера защиты паролем Azure AD содержит новый модуль PowerShell с именем AzureADPasswordProtection. Следующие шаги основаны на запуске различных командлетов из этого модуля PowerShell и предполагают, что вы открыли новое окно PowerShell и импортировали новый модуль следующим образом:
      * `Import-Module AzureADPasswordProtection`

      > [!NOTE]
      > Программное обеспечение для установки изменяет переменную среды PSModulePath хост-компьютера. Чтобы это изменение вступило в силу и можно было импортировать и использовать модуль PowerShell AzureADPasswordProtection, вам может потребоваться открыть новое окно консоли PowerShell.

   * Убедитесь, что служба выполняется с помощью следующей команды PowerShell: `Get-Service AzureADPasswordProtectionProxy | fl`.
      * Результат должен иметь **состояние** "Выполняется".

4. Зарегистрируйте прокси-сервер.
   * После того как шаг 3 был завершен, служба прокси-сервера защиты паролем Azure AD выполняется на компьютере, но еще не имеет необходимых учетных данных для связи с Azure AD. Для активации этой возможности с помощью командлета PowerShell `Register-AzureADPasswordProtectionProxy` требуется регистрация с использованием Azure AD. Командлет требует учетные данные глобального администратора для вашего клиента Azure, а также права локального администратора домена Active Directory в корневом домене леса. После успешного выполнения для данной службы прокси-сервера дополнительные вызовы `Register-AzureADPasswordProtectionProxy` продолжают выполняться, но они не нужны.
      * Командлет может запускаться следующим образом:

         ```
         $tenantAdminCreds = Get-Credential
         Register-AzureADPasswordProtectionProxy -AzureCredential $tenantAdminCreds
         ```

         Пример работает, только если текущий зарегистрированный пользователь также является администратором домена Active Directory для корневого домена. Кроме того, можно предоставить необходимые учетные данные домена с помощью параметра `-ForestCredential`.

   > [!NOTE]
   > Эта операция может завершиться сбоем, если включена конфигурация усиленной безопасности Internet Explorer (IESC). Чтобы обойти эту проблему, можно отключить IESC, зарегистрировать прокси-сервер, а затем повторно включить IESC.

   > [!NOTE]
   > Ожидается, что регистрация службы прокси-сервера защиты паролем Azure AD будет одноразовым действием на время существования службы. Служба прокси-сервера автоматически будет выполнять любые требуемые операции с этого момента. После успешного выполнения для данного леса дополнительные вызовы Register-AzureADPasswordProtectionProxy продолжают выполняться, но они не нужны.

   > [!TIP]
   > При первом запуске этого командлета для данного клиента Azure он может завершиться со значительной задержкой. Если не сообщается об ошибке, эта задержка вполне нормальна.

5. Зарегистрируйте лес.
   * Локальный лес Active Directory следует инициализировать с необходимыми учетными данными для связи с Azure с помощью командлета `Register-AzureADPasswordProtectionForest` Powershell. Командлет требует учетные данные глобального администратора для вашего клиента Azure, а также права локального администратора домена Active Directory в корневом домене леса. Этот шаг выполняется один раз в каждом лесу.
      * Командлет может запускаться следующим образом:

         ```
         $tenantAdminCreds = Get-Credential
         Register-AzureADPasswordProtectionForest -AzureCredential $tenantAdminCreds
         ```

         Пример работает, только если текущий зарегистрированный пользователь также является администратором домена Active Directory для корневого домена. Кроме того, можно предоставить необходимые учетные данные домена с помощью параметра -ForestCredential.

         > [!NOTE]
         > Эта операция может завершиться сбоем, если включена конфигурация усиленной безопасности Internet Explorer (IESC). Чтобы обойти эту проблему, можно отключить IESC, зарегистрировать прокси-сервер, а затем повторно включить IESC.

         > [!NOTE]
         > Если в вашей среде установлено несколько прокси-серверов, неважно, какой конкретный прокси-сервер указан в процедуре.

         > [!TIP]
         > При первом запуске этого командлета для данного клиента Azure он может завершиться со значительной задержкой. Если не сообщается об ошибке, эта задержка вполне нормальна.

   > [!NOTE]
   > Ожидается, что регистрация леса Active Directory будет одноразовым действием на время существования леса. С этого момента агенты контроллера домена в лесу будут автоматически выполнять любые требуемые операции. После успешного выполнения для данного леса дополнительные вызовы `Register-AzureADPasswordProtectionForest` продолжают выполняться, но они не нужны.

   > [!NOTE]
   > Для успешного выполнения `Register-AzureADPasswordProtectionForest` хотя бы один контроллер домена Windows Server 2012 или более поздней версии должен быть доступен в домене прокси-сервера. Но до этого шага установленное программное обеспечение агента контроллера домена не требуется на контроллерах домена.

6. Необязательно: настройте службу прокси-сервера защиты паролем Azure AD для ожидания передачи данных на определенном порту.
   * RPC через TCP используется программным обеспечением агента контроллера домена защиты паролем Azure AD на контроллерах домена для связи со службой прокси-сервера защиты паролем Azure AD. По умолчанию служба прокси-сервера политики паролей защиты паролем Azure AD ожидает передачи данных на любой доступной динамической конечной точке RPC. При необходимости из-за требований к топологии сети или брандмауэра службу можно настроить для ожидания передачи данных на определенном TCP-порту.
      * Чтобы настроить службу для запуска на статическом порту, используйте командлет `Set-AzureADPasswordProtectionProxyConfiguration`.
         ```
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort <portnumber>
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

      * Чтобы настроить службу для запуска на динамическом порту, используйте ту же процедуру, но сбросьте значение StaticPort до нуля, например:
         ```
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort 0
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

   > [!NOTE]
   > Служба прокси-сервера защиты паролем Azure AD требует ручного перезапуска после любого изменения конфигурации порта. Не нужно перезапускать программное обеспечение службы агента контроллера домена, запущенное на контроллерах домена, после внесения таких изменений конфигурации.

   * Текущую конфигурацию службы можно запросить с помощью командлета `Get-AzureADPasswordProtectionProxyConfiguration`, как показано в следующем примере:

      ```
      Get-AzureADPasswordProtectionProxyConfiguration | fl

      ServiceName : AzureADPasswordProtectionProxy
      DisplayName : Azure AD password protection Proxy
      StaticPort  : 0 
      ```

### <a name="install-the-azure-ad-password-protection-dc-agent-service"></a>Установка службы агента контроллера домена защиты паролем Azure AD

* Установите программное обеспечение службы агента контроллера домена защиты паролем Azure AD с помощью пакета MSI `AzureADPasswordProtectionDCAgent.msi`:
   * При установке или удалении программного обеспечения требуется перезагрузка из-за требования операционной системы выгружать и загружать DLL-файлы только при перезагрузке.
   * Поддерживается установка службы агента контроллера домена на компьютере, который еще не является контроллером домена. В этом случае служба запустится и будет выполняться, но в противном случае будет неактивна, пока уровень компьютера не будет повышен до контроллера домена.

   Установку программного обеспечения можно автоматизировать с использованием стандартных процедур MSI, например: `msiexec.exe /i AzureADPasswordProtectionDCAgent.msi /quiet /qn`

   > [!WARNING]
   > Пример выполнения команды msiexec приведет к немедленной перезагрузке. Этого можно избежать, установив флажок `/norestart`.

После установки на контроллере домена и перезагрузки установка программного обеспечения агента контроллера домена защиты паролем Azure AD будет завершена. Дальнейшая настройка не требуется.

## <a name="multiple-forest-deployments"></a>Развертывание в нескольких лесах

Дополнительные требования для развертывания защиты паролем Azure AD в нескольких лесах отсутствуют. Каждый лес настраивается независимо, как описано в разделе развертывания единого леса. Каждая служба прокси-сервера защиты паролем Azure AD поддерживает только контроллеры домена из леса, к которому она присоединена. Программное обеспечение защиты паролей Azure AD в данном лесу не знает о программном обеспечении защиты паролем Azure AD, развернутом в другом лесу, независимо от конфигураций доверия Active Directory.

## <a name="read-only-domain-controllers"></a>Контроллеры домена только для чтения

Изменения или настройка паролей никогда не обрабатываются и не сохраняются на контроллерах домена только для чтения (RODC). Вместо этого они перенаправляются на контроллеры домена с возможностью записи. Поэтому нет необходимости устанавливать программное обеспечение агента контроллера домена на контроллерах домена только для чтения.

## <a name="high-availability"></a>высокую доступность;

Основной проблемой обеспечения высокой доступности защиты паролем Azure AD является наличие прокси-серверов, когда контроллеры домена в лесу пытаются загрузить новые политики или другие данные от Azure. Общедоступная предварительная версия поддерживает не более двух прокси-серверов на один лес. Каждый агент контроллера домена использует простой циклический алгоритм при выборе того, какой прокси-сервер должен вызываться, и пропускает прокси-серверы, которые не отвечают.
Обычные проблемы, связанные с высокой доступностью, сокращаются благодаря структуре программного обеспечения агента контроллера домена. Агент контроллера домена поддерживает локальный кэш последней скачанной политики паролей. Даже если все зарегистрированные прокси-серверы по какой-либо причине становятся недоступными, агенты контроллера домена продолжают применять свою политику кэширования паролей. Разумная частота обновления политик паролей при большом развертывании обычно составляет несколько дней, а не часов или меньше.   Поэтому краткие отключения прокси-серверов не оказывают существенного влияния на работу функции защиты паролем Azure AD или ее преимуществ обеспечения безопасности.

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда вы установили службы, необходимые для защиты паролем Azure AD на локальных серверах, выполните [конфигурацию после установки и получите сведения о событиях ](howto-password-ban-bad-on-premises-operations.md), чтобы завершить развертывание.

[Предварительная версия. Применение защиты паролем Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md)
