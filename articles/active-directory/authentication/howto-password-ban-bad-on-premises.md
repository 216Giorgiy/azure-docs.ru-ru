---
title: Развертывание предварительной версии защиты паролем Azure AD
description: Развертывание предварительной версии защиты паролем Azure AD для запрета неправильных паролей в локальной среде
services: active-directory
ms.service: active-directory
ms.component: authentication
ms.topic: article
ms.date: 06/11/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.reviewer: jsimmons
ms.openlocfilehash: 5065399f161bcaee2f9518236a28f0f5faa0ea5b
ms.sourcegitcommit: d551ddf8d6c0fd3a884c9852bc4443c1a1485899
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2018
ms.locfileid: "37902033"
---
# <a name="preview-deploy-azure-ad-password-protection"></a>Развертывание предварительной версии защиты паролем Azure AD

|     |
| --- |
| Защита паролем Azure AD и пользовательский список заблокированных паролей — это функции Azure Active Directory, которые предоставляются в режиме общедоступной предварительной версии. См. дополнительные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

Теперь, когда у вас есть представление о том [, как обеспечить защиту паролем Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md), следующим шагом будет планирование и выполнение развертывания.

## <a name="deployment-strategy"></a>Стратегия развертывания

Корпорация Майкрософт предполагает, что любое развертывание начинается в режиме аудита. Режим аудита — это начальная настройка по умолчанию, где можно настроить пароли и создать записи в журнале событий о всех блокируемых паролях. После того как прокси-серверы и агенты контроллеров доменов полностью развернуты в режиме аудита, следует выполнять регулярное отслеживание, чтобы определить, как принудительное применение политики паролей будет влиять на пользователей и среду, если политика будет применена.

На этапе аудита многие организации обнаруживают следующее:

* Необходимо улучшить имеющиеся операционные процессы, чтобы использовать более безопасные пароли.
* Пользователи привыкли регулярно выбирать незащищенные пароли.
* Нужно информировать пользователей о предстоящих изменениях в обеспечении безопасности, о том, какое влияние они могут оказать на них, и помочь им лучше понять, как они могут выбирать более безопасные пароли.

После того как функция была запущена в режиме аудита в разумные сроки, конфигурацию принудительного выполнения можно сменить с **Аудит** на **Принудительно**, тем самым требуя более безопасные пароли. Детальный мониторинг в это время — хорошая идея.

## <a name="known-limitation"></a>Известные ограничения

Существует известное ограничение в предварительной версии прокси-сервера защиты паролем Azure AD. Использование учетных записей администратора клиента, для которых требуется MFA, не поддерживается. Будущее обновление прокси-сервера защиты паролем Azure AD будет поддерживать регистрацию прокси-сервера с учетными записями администратора, для которых требуется MFA.

## <a name="single-forest-deployment"></a>Развертывание одного леса

Предварительная версия защиты паролем Azure AD развертывается с помощью службы прокси-сервера на двух серверах, а службу агента контроллера домена можно постепенно развернуть на всех контроллерах домена в лесу Active Directory.

![Взаимодействие компонентов защиты паролем Azure AD](./media/concept-password-ban-bad-on-premises/azure-ad-password-protection.png)

### <a name="download-the-software"></a>Скачивание ПО

Для защиты паролем Azure AD имеется два обязательных установщика, которые можно скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=57071).

### <a name="install-and-configure-the-azure-ad-password-protection-proxy-service"></a>Установка и настройка службы прокси-сервера защиты паролем Azure AD

1. Выберите один или несколько серверов для размещения службы прокси-сервера защиты паролем Azure AD.
   * Каждая такая служба может предоставлять только политики паролей для одного леса, а хост-компьютер должен быть присоединен к домену (поддерживаются корневые и дочерние) в этом лесу. Для работы службы прокси-сервера защиты паролем Azure AD необходимо наличие сетевого соединения между по меньшей мере одним контроллером домена в каждом домене леса и хост-компьютером прокси-сервера защиты паролем Azure AD.
   * Поддерживается установка и запуск службы прокси-сервера защиты паролем Azure AD на контроллере домена для тестирования, но затем требуется подключение к Интернету.

   > [!NOTE]
   > Общедоступная предварительная версия поддерживает не более двух (2) прокси-серверов на один лес.

2. Установите программное обеспечение службы прокси-сервера политики паролей, используя пакет MSI AzureADPasswordProtectionProxy.msi.
   * Для этого не требуется перезагрузка. Установку программного обеспечения можно автоматизировать с использованием стандартных процедур MSI, например: `msiexec.exe /i AzureADPasswordProtectionProxy.msi /quiet /qn`

3. Откройте окно PowerShell от имени администратора.
   * ПО прокси-сервера защиты паролем Azure AD содержит новый модуль PowerShell с именем AzureADPasswordProtection. Следующие шаги основаны на запуске различных командлетов из этого модуля PowerShell и предполагают, что вы открыли новое окно PowerShell и импортировали новый модуль следующим образом:
      * `Import-Module AzureADPasswordProtection`

      > [!NOTE]
      > Программное обеспечение для установки изменяет переменную среды PSModulePath хост-компьютера. Чтобы это изменение вступило в силу и можно было импортировать и использовать модуль PowerShell AzureADPasswordProtection, вам может потребоваться открыть новое окно консоли PowerShell.

   * Убедитесь, что служба выполняется с помощью следующей команды PowerShell: `Get-Service AzureADPasswordProtectionProxy | fl`.
      * Результат должен иметь **состояние** "Выполняется".

4. Зарегистрируйте прокси-сервер.
   * После того как шаг 3 был завершен, служба прокси-сервера защиты паролем Azure AD выполняется на компьютере, но еще не имеет необходимых учетных данных для связи с Azure AD. Для активации этой возможности с помощью командлета PowerShell `Register-AzureADPasswordProtectionProxy` требуется регистрация с использованием Azure AD. Командлет требует учетные данные глобального администратора для вашего клиента Azure, а также права локального администратора домена Active Directory в корневом домене леса. После успешного выполнения для данной службы прокси-сервера дополнительные вызовы `Register-AzureADPasswordProtectionProxy` продолжают выполняться, но они не нужны.
      * Командлет может запускаться следующим образом:

         ```
         $tenantAdminCreds = Get-Credential
         Register-AzureADPasswordProtectionProxy -AzureCredential $tenantAdminCreds
         ```

         Пример работает, только если текущий зарегистрированный пользователь также является администратором домена Active Directory для корневого домена. Кроме того, можно предоставить необходимые учетные данные домена с помощью параметра `-ForestCredential`.

   > [!TIP]
   > При первом запуске этого командлета для данного клиента Azure он может завершиться со значительной задержкой. Если не сообщается об ошибке, эта задержка вполне нормальна.

   > [!NOTE]
   > Ожидается, что регистрация службы прокси-сервера защиты паролем Azure AD будет одноразовым действием на время существования службы. Служба прокси-сервера автоматически будет выполнять любые требуемые операции с этого момента. После успешного выполнения для данного леса дополнительные вызовы Register-AzureADPasswordProtectionProxy продолжают выполняться, но они не нужны.

5. Зарегистрируйте лес.
   * Локальный лес Active Directory следует инициализировать с необходимыми учетными данными для связи с Azure с помощью командлета `Register-AzureADPasswordProtectionForest` Powershell. Командлет требует учетные данные глобального администратора для вашего клиента Azure, а также права локального администратора домена Active Directory в корневом домене леса. Этот шаг выполняется один раз в каждом лесу.
      * Командлет может запускаться следующим образом:

         ```
         $tenantAdminCreds = Get-Credential
         Register-AzureADPasswordProtectionForest -AzureCredential $tenantAdminCreds
         ```

         Пример работает, только если текущий зарегистрированный пользователь также является администратором домена Active Directory для корневого домена. Кроме того, можно предоставить необходимые учетные данные домена с помощью параметра -ForestCredential.

         > [!NOTE]
         > Если в вашей среде установлено несколько прокси-серверов, неважно, какой конкретный прокси-сервер указан в процедуре.

         > [!TIP]
         > При первом запуске этого командлета для данного клиента Azure он может завершиться со значительной задержкой. Если не сообщается об ошибке, эта задержка вполне нормальна.

   > [!NOTE]
   > Ожидается, что регистрация леса Active Directory будет одноразовым действием на время существования леса. С этого момента агенты контроллера домена в лесу будут автоматически выполнять любые требуемые операции. После успешного выполнения для данного леса дополнительные вызовы `Register-AzureADPasswordProtectionForest` продолжают выполняться, но они не нужны.

6. (Необязательно.) Настройте службу прокси-сервера защиты паролем Azure AD для ожидания передачи данных на определенном порту.
   * RPC через TCP используется программным обеспечением агента контроллера домена защиты паролем Azure AD на контроллерах домена для связи со службой прокси-сервера защиты паролем Azure AD. По умолчанию служба прокси-сервера политики паролей защиты паролем Azure AD ожидает передачи данных на любой доступной динамической конечной точке RPC. При необходимости из-за требований к топологии сети или брандмауэра службу можно настроить для ожидания передачи данных на определенном TCP-порту.
      * Чтобы настроить службу для запуска на статическом порту, используйте командлет `Set-AzureADPasswordProtectionProxyConfiguration`.
         ```
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort <portnumber>
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

      * Чтобы настроить службу для запуска на динамическом порту, используйте ту же процедуру, но сбросьте значение StaticPort до нуля, например:
         ```
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort 0
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

   > [!NOTE]
   > Служба прокси-сервера защиты паролем Azure AD требует ручного перезапуска после любого изменения конфигурации порта. Не нужно перезапускать программное обеспечение службы агента контроллера домена, запущенное на контроллерах домена, после внесения таких изменений конфигурации.

   * Текущую конфигурацию службы можно запросить с помощью командлета `Get-AzureADPasswordProtectionProxyConfiguration`, как показано в следующем примере:

      ```
      Get-AzureADPasswordProtectionProxyConfiguration | fl

      ServiceName : AzureADPasswordProtectionProxy
      DisplayName : Azure AD password protection Proxy
      StaticPort  : 0 
      ```

### <a name="install-the-azure-ad-password-protection-dc-agent-service"></a>Установка службы агента контроллера домена защиты паролем Azure AD

* Установите программное обеспечение службы агента контроллера домена защиты паролем Azure AD с помощью пакета MSI `AzureADPasswordProtectionDCAgent.msi`:
   * При установке или удалении программного обеспечения требуется перезагрузка из-за требования операционной системы выгружать и загружать DLL-файлы только при перезагрузке.
   * Поддерживается установка службы агента контроллера домена на компьютере, который еще не является контроллером домена. В этом случае служба запустится и будет выполняться, но в противном случае будет неактивна, пока уровень компьютера не будет повышен до контроллера домена.

   Установку программного обеспечения можно автоматизировать с использованием стандартных процедур MSI, например: `msiexec.exe /i AzureADPasswordProtectionDCAgent.msi /quiet /qn`

   > [!WARNING]
   > Пример выполнения команды msiexec приведет к немедленной перезагрузке. Этого можно избежать, установив флажок `/norestart`.

После установки на контроллере домена и перезагрузки установка программного обеспечения агента контроллера домена защиты паролем Azure AD будет завершена. Дальнейшая настройка не требуется.

## <a name="multiple-forest-deployments"></a>Развертывание в нескольких лесах

Дополнительные требования для развертывания защиты паролем Azure AD в нескольких лесах отсутствуют. Каждый лес настраивается независимо, как описано в разделе развертывания единого леса. Каждая служба прокси-сервера защиты паролем Azure AD поддерживает только контроллеры домена из леса, к которому она присоединена. Программное обеспечение защиты паролей Azure AD в данном лесу не знает о программном обеспечении защиты паролем Azure AD, развернутом в другом лесу, независимо от конфигураций доверия Active Directory.

## <a name="read-only-domain-controllers"></a>Контроллеры домена только для чтения

Изменения или настройка паролей никогда не обрабатываются и не сохраняются на контроллерах домена только для чтения (RODC). Вместо этого они перенаправляются на контроллеры домена с возможностью записи. Поэтому нет необходимости устанавливать программное обеспечение агента контроллера домена на контроллерах домена только для чтения.

## <a name="high-availability"></a>высокую доступность;

Основной проблемой обеспечения высокой доступности защиты паролем Azure AD является наличие прокси-серверов, когда контроллеры домена в лесу пытаются загрузить новые политики или другие данные от Azure. Общедоступная предварительная версия поддерживает не более двух прокси-серверов на один лес. Каждый агент контроллера домена использует простой циклический алгоритм при выборе того, какой прокси-сервер должен вызываться, и пропускает прокси-серверы, которые не отвечают.
Обычные проблемы, связанные с высокой доступностью, сокращаются благодаря структуре программного обеспечения агента контроллера домена. Агент контроллера домена поддерживает локальный кэш последней скачанной политики паролей. Даже если все зарегистрированные прокси-серверы по какой-либо причине становятся недоступными, агенты контроллера домена продолжают применять свою политику кэширования паролей. Разумная частота обновления политик паролей при большом развертывании обычно составляет несколько дней, а не часов или меньше.   Поэтому краткие отключения прокси-серверов не оказывают существенного влияния на работу функции защиты паролем Azure AD или ее преимуществ обеспечения безопасности.

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда вы установили службы, необходимые для защиты паролем Azure AD на локальных серверах, выполните [конфигурацию после установки и получите сведения о событиях ](howto-password-ban-bad-on-premises-operations.md), чтобы завершить развертывание.

[Предварительная версия. Применение защиты паролем Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md)
