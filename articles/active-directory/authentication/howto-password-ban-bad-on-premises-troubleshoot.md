---
title: Устранение неполадок и ведение журнала в предварительной версии защиты паролем Azure AD
description: Общие сведения об устранении неполадок и ведении журнала в предварительной версии защиты паролем Azure AD
services: active-directory
ms.service: active-directory
ms.component: authentication
ms.topic: conceptual
ms.date: 11/02/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.reviewer: jsimmons
ms.openlocfilehash: d9f3ba642a5d00594aa6bdef597d5db43c2fc121
ms.sourcegitcommit: 63b996e9dc7cade181e83e13046a5006b275638d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/10/2019
ms.locfileid: "54188986"
---
# <a name="preview-azure-ad-password-protection-monitoring-reporting-and-troubleshooting"></a>Предварительный просмотр: мониторинг, отчетность и устранение неполадок защиты паролем Azure AD

|     |
| --- |
| Защита паролем Azure AD — это общедоступная предварительная версия функции Azure Active Directory. См. дополнительные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

После развертывания защиты паролем Azure AD мониторинг и отчетность являются важными задачами. В этой статье мы подробно рассмотрим, где каждая служба регистрирует сведения и создает отчеты об использовании защиты паролем Azure AD.

## <a name="on-premises-logs-and-events"></a>Локальные журналы и события

### <a name="dc-agent-admin-log"></a>Журнал администратора агента контроллера домена

На каждом контроллере домена программное обеспечение службы агента контроллера домена записывает результаты проверки паролей (и другие состояния) в локальный журнал событий:

`\Applications and Services Logs\Microsoft\AzureADPasswordProtection\DCAgent\Admin`

События регистрируются различными компонентами агента контроллера домена с использованием следующих диапазонов:

|Компонент |Диапазон идентификаторов событий|
| --- | --- |
|Библиотека DLL фильтрации паролей агента контроллера домена| 10000–19999|
|Процесс размещения службы агента контроллера домена| 20000–29999|
|Логика проверки политики службы агента контроллера домена| 30000–39999|

Обычно для успешной операции проверки пароля из библиотеки DLL фильтрации паролей агента контроллера домена регистрируется одно событие, а в случае неудачной проверки пароля — два: одно из службы агента контроллера домена и одно из библиотеки DLL фильтрации паролей агента контроллера домена.

Дискретные события для фиксации этих ситуаций регистрируются на основе следующих факторов:

* Будет ли настроен или изменен заданный пароль.
* Была ли пройдена проверка данного пароля.
* Произошла ли ошибка проверки из-за глобальной политики Майкрософт или из-за политики организации.
* Включен или выключен в данный момент режим "Только аудит" для текущей политики паролей.

Ключевыми событиями, связанными с проверкой паролей, являются следующие:

|   |Изменение пароля |Настройка пароля|
| --- | :---: | :---: |
|Pass; |10014 |10015|
|Ошибка (не прошел проверку политики паролей клиента)| 10016, 30002| 10017, 30003|
|Ошибка (не прошел проверку политики паролей Майкрософт)| 10016, 30004| 10017, 30005|
|Прошел проверку "Только аудит" (могла возникнуть ошибка проверки политики паролей клиента)| 10024, 30008| 10025, 30007|
|Прошел проверку "Только аудит" (могла возникнуть ошибка проверки политики паролей Майкрософт)| 10024, 30010| 10025, 30009|

> [!TIP]
> Входящие пароли сначала проверяются в соответствии со списком глобальных паролей Майкрософт. Если это не удается, дальнейшая обработка не выполняется. Это то же поведение, что и при изменении пароля в Azure.

#### <a name="sample-event-log-message-for-event-id-10014-successful-password-set"></a>Пример сообщения журнала событий для идентификатора события 10014 (успешная настройка пароля)

```
The changed password for the specified user was validated as compliant with the current Azure password policy.

 UserName: BPL_02885102771
 FullName:
```

#### <a name="sample-event-log-message-for-event-id-10017-and-30003-failed-password-set"></a>Пример сообщения журнала событий для идентификатора события 10017 и 30003 (не удалось выполнить настройку пароля)

10017:

```
The reset password for the specified user was rejected because it did not comply with the current Azure password policy. Please see the correlated event log message for more details.

 UserName: BPL_03283841185
 FullName:
```

30003:

```
The reset password for the specified user was rejected because it matched at least one of the tokens present in the per-tenant banned password list of the current Azure password policy.

 UserName: BPL_03283841185
 FullName:
```

#### <a name="sample-event-log-message-for-event-id-30001-password-accepted-due-to-no-policy-available"></a>Пример сообщения журнала событий для идентификатора события 30001 (пароль принят из-за отсутствия политики)

```
The password for the specified user was accepted because an Azure password policy is not available yet

UserName: SomeUser
FullName: Some User

This condition may be caused by one or more of the following reasons:%n

1. The forest has not yet been registered with Azure.

   Resolution steps: an administrator must register the forest using the Register-AzureADPasswordProtectionForest cmdlet.

2. An Azure AD password protection Proxy is not yet available on at least one machine in the current forest.

   Resolution steps: an administrator must install and register a proxy using the Register-AzureADPasswordProtectionProxy cmdlet.

3. This DC does not have network connectivity to any Azure AD password protection Proxy instances.

   Resolution steps: ensure network connectivity exists to at least one Azure AD password protection Proxy instance.

4. This DC does not have connectivity to other domain controllers in the domain.

   Resolution steps: ensure network connectivity exists to the domain.
```

#### <a name="sample-event-log-message-for-event-id-30006-new-policy-being-enforced"></a>Пример сообщения журнала событий для идентификатора события 30006 (применяется новая политика)

```
The service is now enforcing the following Azure password policy.

 Enabled: 1
 AuditOnly: 1
 Global policy date: ‎2018‎-‎05‎-‎15T00:00:00.000000000Z
 Tenant policy date: ‎2018‎-‎06‎-‎10T20:15:24.432457600Z
 Enforce tenant policy: 1
```

#### <a name="dc-agent-operational-log"></a>Операционный журнал агента контроллера домена

Служба агента контроллера домена также будет регистрировать события, связанные с операциями, в следующий журнал:

`\Applications and Services Logs\Microsoft\AzureADPasswordProtection\DCAgent\Operational`

#### <a name="dc-agent-trace-log"></a>Журнал трассировки агента контроллера домена

Служба агента контроллера домена также может регистрировать подробные события трассировки на уровне отладки в следующий журнал:

`\Applications and Services Logs\Microsoft\AzureADPasswordProtection\DCAgent\Trace`

Ведение журнала трассировки отключено по умолчанию.

> [!WARNING]
>  Когда этот параметр включен, журнал трассировки получает большой объем событий и может влиять на производительность контроллера домена. Поэтому этот расширенный журнал следует включать, только когда проблема требует более глубокого изучения и только на минимальное время.

#### <a name="dc-agent-text-logging"></a>Ведение текстового журнала агента контроллера домена

Службу агента контроллера домена можно настроить для записи в текстовый журнал, задав следующее значение реестра:

HKLM\System\CurrentControlSet\Services\AzureADPasswordProtectionDCAgent\Parameters!EnableTextLogging = 1 (REG_DWORD value)

Ведение текстового журнала отключено по умолчанию. Чтобы изменения этого значения вступили в силу, необходимо перезапустить службу агента контроллера домена. После перезапуска служба агента контроллера домена будет вести запись в файл журнала, расположенный в папке:

`%ProgramFiles%\Azure AD Password Protection DC Agent\Logs`

> [!TIP]
> Текстовый журнал получает те же записи на уровне отладки, которые могут быть зарегистрированы в журнале трассировки, но, как правило, в более удобном для просмотра и анализа формате.

> [!WARNING]
> Когда этот параметр включен, этот журнал получает большой объем событий и может влиять на производительность контроллера домена. Поэтому этот расширенный журнал следует включать, только когда проблема требует более глубокого изучения и только на минимальное время.

### <a name="azure-ad-password-protection-proxy-service"></a>Служба прокси-сервера защиты паролем Azure AD

#### <a name="proxy-service-event-logs"></a>Журналы событий службы прокси-сервера

Служба прокси-сервера выводит минимальный набор событий в следующие журналы событий:

`\Applications and Services Logs\Microsoft\AzureADPasswordProtection\ProxyService\Admin`

`\Applications and Services Logs\Microsoft\AzureADPasswordProtection\ProxyService\Operational`

Служба прокси-сервера также может регистрировать подробные события трассировки на уровне отладки в следующий журнал:

`\Applications and Services Logs\Microsoft\AzureADPasswordProtection\ProxyService\Trace`

Ведение журнала трассировки отключено по умолчанию.

> [!WARNING]
> Когда этот параметр включен, журнал трассировки получает большой объем событий, и это может повлиять на производительность прокси-узла. Поэтому этот журнал следует включать, только когда проблема требует более глубокого изучения и только на минимальное время.

#### <a name="proxy-service-text-logging"></a>Ведение текстового журнала службы прокси-сервера

Службу прокси-сервера можно настроить для ведения текстового журнала, задав следующее значение реестра:

HKLM\System\CurrentControlSet\Services\AzureADPasswordProtectionProxy\Parameters!EnableTextLogging = 1 (REG_DWORD value)

Ведение текстового журнала отключено по умолчанию. Чтобы изменения этого значения вступили в силу, необходимо перезапустить службу прокси-сервера. После перезапуска служба прокси-сервера будет вести записи в файл журнала, который расположен в папке:

`%ProgramFiles%\Azure AD Password Protection Proxy\Logs`

> [!TIP]
> Текстовый журнал получает те же записи на уровне отладки, которые могут быть зарегистрированы в журнале трассировки, но, как правило, в более удобном для просмотра и анализа формате.

> [!WARNING]
> Когда этот параметр включен, этот журнал получает большой объем событий и может влиять на производительность контроллера домена. Поэтому этот расширенный журнал следует включать, только когда проблема требует более глубокого изучения и только на минимальное время.

#### <a name="powershell-cmdlet-logging"></a>Ведение журнала командлетов Powershell

Большая часть командлетов Powershell защиты паролем Azure AD будут вести записи в текстовом журнале, который расположен в папке:

`%ProgramFiles%\Azure AD Password Protection Proxy\Logs`

Если возникает ошибка в командлете и ее причина и решение не очевидны, можно также обратиться к этим текстовым журналам.

### <a name="emergency-remediation"></a>Аварийное исправление

Если служба агента контроллера домена вызывает проблемы, ее можно немедленно отключить. Библиотека DLL фильтрации паролей агента контроллера домена по-прежнему пытается вызвать нерабочую службу и регистрирует события предупреждения (10012, 10013), но все входящие пароли принимаются в течение этого времени. Затем служба агента контроллера домена также может быть настроена с помощью диспетчера управления службами Windows с типом запуска "Отключено" при необходимости.

### <a name="performance-monitoring"></a>Мониторинг производительности

Программное обеспечение службы агента контроллера домена устанавливает объект счетчика производительности с именем **Azure AD Password Protection**. В настоящее время доступны следующие счетчики производительности:

|Имя счетчика производительности | ОПИСАНИЕ|
| --- | --- |
|Обработано паролей |Этот счетчик отображает общее количество обработанных паролей (принятых или отклоненных) с момента последнего перезапуска.|
|Принято паролей |Этот счетчик отображает общее количество принятых паролей с момента последнего перезапуска.|
|Отклонено паролей |Этот счетчик отображает общее количество отклоненных паролей с момента последнего перезапуска.|
|Выполняется запросов фильтрации паролей |Этот счетчик отображает количество запросов на фильтрацию паролей, которые в настоящее время выполняются.|
|Пиковое число запросов фильтрации паролей |Этот счетчик отображает максимальное количество одновременных запросов фильтрации паролей с момента последнего перезапуска.|
|Ошибки запросов фильтрации паролей |Этот счетчик отображает общее количество неудачных запросов фильтрации паролей из-за ошибки с момента последнего перезапуска. Ошибки могут возникнуть, если служба агента контроллера домена защиты паролем Azure AD не запущена.|
|Запросы фильтрации паролей/сек |Этот счетчик отображает скорость обработки паролей.|
|Время обработки запроса фильтрации паролей |Этот счетчик отображает среднее время, необходимое для обработки запроса фильтрации паролей.|
|Пиковое количество времени обработки запроса фильтрации паролей |Этот счетчик отображает пиковое количество времени обработки запросов фильтрации паролей с момента последнего перезапуска.|
|Пароли, принятые из-за режима аудита |Этот счетчик отображает общее количество паролей, которые обычно отклоняются, но были приняты, потому что политика паролей была настроена так, чтобы быть в режиме аудита (с момента последнего перезапуска).|

## <a name="directory-services-repair-mode"></a>Режим восстановления служб каталогов

Если контроллер домена загружен в режим восстановления служб каталогов, служба агента контроллера домена обнаруживает это, что приводит к отключению всех проверок паролей или принудительных действий независимо от текущей активной конфигурации политик.

## <a name="domain-controller-demotion"></a>Понижение контроллера домена

Поддерживается понижение контроллера домена, который все еще запускает программное обеспечение агента контроллера. Однако администраторы должны знать, что программное обеспечение агента контроллера домена продолжает работать и применять текущую политику паролей во время процедуры понижения. Новый пароль учетной записи локального администратора (указанный как часть операции понижения) проверяется, как и любой другой пароль. В ходе процедуры понижения контроллера домена корпорация Майкрософт рекомендует выбирать безопасные пароли для локальных учетных записей администратора. Однако проверка нового пароля учетной записи локального администратора с помощью программного обеспечения агента контроллера домена может мешать ранее созданным процедурам понижения.

После успешного понижения роли контроллера домена и перезагрузки и повторного запуска в качестве обычного рядового сервера программное обеспечение агента контроллера домена возвращается к работе в пассивном режиме. Затем его можно удалить в любое время.

## <a name="removal"></a>Удаление

Если было принято решение удалить общедоступную предварительную версию программного обеспечения и очистить все связанные состояния из доменов и леса, эту задачу можно выполнить, сделав следующее:

> [!IMPORTANT]
> Важно выполнить эти шаги по порядку. Если какой-либо экземпляр службы прокси-сервера остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint. Если какой-либо экземпляр службы агента контроллера домена остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint и состояние sysvol.

1. Удалите программное обеспечение защиты паролем со всех компьютеров. Для этого шага **не** требуется перезагрузка компьютера.
2. Удалите программное обеспечение агента контроллера домена со всех контроллеров. Для этого шага **требуется** перезагрузка компьютера.
3. Вручную удалите все точки подключения службы прокси-сервера в каждом контексте именования домена. Местоположение этих объектов можно обнаружить с помощью следующей команды Active Directory Powershell:

   ```Powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{ebefb703-6113-413d-9167-9f8dd4d24468}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Не опускайте звездочку (*) в конце значения переменной $keywords.

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную. 

4. Вручную удалите все точки подключения агента контроллера домена в каждом контексте именования домена. В лесу может быть по одному такому объекту на контроллер домена, в зависимости от того, насколько широко развернута предварительная версия программного обеспечения. Местоположение этого объекта можно обнаружить с помощью следующей команды Active Directory Powershell:

   ```Powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{2bac71e6-a293-4d5b-ba3b-50b995237946}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

5. Вручную удалите состояние конфигурации уровня леса. Состояние конфигурации леса поддерживается в контейнере в контексте именования конфигурации Active Directory. Его можно обнаружить и удалить следующим образом:

   ```Powershell
   $passwordProtectonConfigContainer = "CN=Azure AD Password Protection,CN=Services," + (Get-ADRootDSE).configurationNamingContext
   Remove-ADObject -Recursive $passwordProtectonConfigContainer
   ```

6. Вручную удалите все сведения о состоянии sysvol, удалив следующую папку и все ее содержимое:

   `\\<domain>\sysvol\<domain fqdn>\Policies\{4A9AB66B-4365-4C2A-996C-58ED9927332D}`

   При необходимости к этому пути также можно получить доступ локально на данном контроллере домена. Расположение по умолчанию будет выглядеть следующим образом:

   `%windir%\sysvol\domain\Policies\{4A9AB66B-4365-4C2A-996C-58ED9927332D}`

   Этот путь будет другим, если общий ресурс sysvol настроен в нестандартном местоположении.

## <a name="next-steps"></a>Дополнительная информация

Для получения дополнительной информации о глобальном и пользовательском запрещенных списках паролей см. статью [Запрет неверных паролей в организации](concept-password-ban-bad.md).
