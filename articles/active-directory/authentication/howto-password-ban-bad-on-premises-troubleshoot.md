---
title: Устранение неполадок в предварительной версии функции защиты паролей Azure AD
description: Общие сведения об устранении неполадок в предварительной версии функции защиты паролей Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 02/01/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: 5727965373752d40e3ce508c1bc79046c2b3b70b
ms.sourcegitcommit: 301128ea7d883d432720c64238b0d28ebe9aed59
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2019
ms.locfileid: "56177757"
---
# <a name="preview-azure-ad-password-protection-troubleshooting"></a>Предварительный просмотр: Устранение неполадок с функцией защиты паролей Azure AD

|     |
| --- |
| Защита паролей Azure AD — это общедоступная предварительная версия функции Azure Active Directory. См. дополнительные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

После развертывания функции защиты паролей Azure AD может потребоваться устранить неполадки. В этой статье подробно рассматриваются некоторые общие шаги по устранению неполадок.

## <a name="weak-passwords-are-not-getting-rejected-as-expected"></a>Слабые пароли не отклоняются

Это может произойти по следующим причинам.

1. Ваши агенты контроллера домена еще не скачали политику. Признаком этого является наличие событий 30001 в журнале событий администратора агента контроллера домена.

    Возможные причины этой проблемы:

    1. лес еще не зарегистрирован;
    2. прокси-сервер еще не зарегистрирован;
    3. проблемы с сетевым подключением не позволяют службе прокси-сервера обмениваться данными с Azure (проверьте требования прокси-сервера HTTP).

2. Режим принудительного применения политики паролей по-прежнему имеет значение "Аудит". В этом случае установите для него значение "Принудительно применить" на портале функции защиты паролей Azure AD. Ознакомьтесь с разделом [Включение защиты паролей](howto-password-ban-bad-on-premises-operations.md#enable-password-protection).

3. Политика паролей отключена. Включите ее с помощью портала функции защиты паролей Azure AD. Ознакомьтесь с разделом [Включение защиты паролей](howto-password-ban-bad-on-premises-operations.md#enable-password-protection).

4. Алгоритм проверки паролей может работать должным образом. Ознакомьтесь с разделом [Оценка паролей](concept-password-ban-bad.md#how-are-passwords-evaluated).

## <a name="directory-services-repair-mode"></a>Режим восстановления служб каталогов

Если контроллер домена загружен в режиме восстановления служб каталогов, служба агента контроллера домена обнаружит это и отключит все проверки паролей или принудительные действия, независимо от текущей активной конфигурации политик.

## <a name="emergency-remediation"></a>Аварийное исправление

Если служба агента контроллера домена вызывает проблемы, ее можно немедленно отключить. Библиотека DLL фильтрации паролей агента контроллера домена по-прежнему пытается вызвать нерабочую службу и регистрирует события предупреждения (10012, 10013), но все входящие пароли принимаются в течение этого времени. Затем служба агента контроллера домена также может быть настроена с помощью диспетчера управления службами Windows с типом запуска "Отключено" при необходимости.

Еще один способ устранения неполадки — установить для режима включения значение "Нет" на портале функции защиты паролей Azure AD. Как только обновленная политика будет скачана, каждая служба агента контроллера домена перейдет в режим бездействия, в котором все пароли принимаются как есть. Дополнительные сведения см. в разделе [Режим принудительного применения](howto-password-ban-bad-on-premises-operations.md#enforce-mode).

## <a name="domain-controller-demotion"></a>Понижение контроллера домена

Поддерживается понижение контроллера домена, который все еще запускает программное обеспечение агента контроллера. Администраторы должны знать, что программное обеспечение агента контроллера домена продолжает применять текущую политику паролей во время процедуры понижения. Новый пароль учетной записи локального администратора (указанный как часть операции понижения) проверяется, как и любой другой пароль. В ходе процедуры понижения контроллера домена корпорация Майкрософт рекомендует выбирать безопасные пароли для локальных учетных записей администратора. Однако проверка нового пароля учетной записи локального администратора с помощью программного обеспечения агента контроллера домена может мешать ранее созданным процедурам понижения.

После успешного понижения роли контроллера домена и перезагрузки и повторного запуска в качестве обычного рядового сервера программное обеспечение агента контроллера домена возвращается к работе в пассивном режиме. Затем его можно удалить в любое время.

## <a name="removal"></a>Удаление

Если было принято решение удалить общедоступную предварительную версию программного обеспечения и очистить все связанные состояния из доменов и леса, эту задачу можно выполнить, сделав следующее:

> [!IMPORTANT]
> Важно выполнить эти шаги по порядку. Если какой-либо экземпляр службы прокси-сервера остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint. Если какой-либо экземпляр службы агента контроллера домена остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint и состояние sysvol.

1. Удалите программное обеспечение прокси-сервера со всех компьютеров. Для этого шага **не** требуется перезагрузка компьютера.
2. Удалите программное обеспечение агента контроллера домена со всех контроллеров. Для этого шага **требуется** перезагрузка компьютера.
3. Вручную удалите все точки подключения службы прокси-сервера в каждом контексте именования домена. Расположение этих объектов можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```PowerShell
   $scp = "serviceConnectionPoint"
   $keywords = "{ebefb703-6113-413d-9167-9f8dd4d24468}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Не опускайте звездочку (*) в конце значения переменной $keywords.

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную. 

4. Вручную удалите все точки подключения агента контроллера домена в каждом контексте именования домена. В лесу может быть по одному такому объекту на контроллер домена, в зависимости от того, насколько широко развернута предварительная версия программного обеспечения. Расположение этого объекта можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```PowerShell
   $scp = "serviceConnectionPoint"
   $keywords = "{2bac71e6-a293-4d5b-ba3b-50b995237946}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

   Не опускайте звездочку (*) в конце значения переменной $keywords.

5. Вручную удалите состояние конфигурации уровня леса. Состояние конфигурации леса поддерживается в контейнере в контексте именования конфигурации Active Directory. Его можно обнаружить и удалить следующим образом:

   ```PowerShell
   $passwordProtectionConfigContainer = "CN=Azure AD Password Protection,CN=Services," + (Get-ADRootDSE).configurationNamingContext
   Remove-ADObject -Recursive $passwordProtectionConfigContainer
   ```

6. Вручную удалите все сведения о состоянии sysvol, удалив следующую папку и все ее содержимое:

   `\\<domain>\sysvol\<domain fqdn>\AzureADPasswordProtection`

   При необходимости к этому пути также можно получить доступ локально на данном контроллере домена. Расположение по умолчанию будет выглядеть следующим образом:

   `%windir%\sysvol\domain\Policies\AzureADPasswordProtection`

   Этот путь будет другим, если общий ресурс sysvol настроен в нестандартном местоположении.

## <a name="next-steps"></a>Дополнительная информация

[Часто задаваемые вопросы о функции защиты паролей Azure AD](howto-password-ban-bad-on-premises-faq.md)

Для получения дополнительной информации о глобальном и пользовательском запрещенных списках паролей см. статью [Запрет неверных паролей в организации](concept-password-ban-bad.md).
