<properties
	pageTitle="Руководство по обновлению сертификатов для пользователей Office 365 и Azure AD | Microsoft Azure"
	description="В этой статье рассматриваются способы устранения проблем с сообщениями электронной почты, уведомляющими пользователей Office 365 о необходимости обновления сертификата."
	services="active-directory"
	documentationCenter=""
	authors="billmath"
	manager="stevenpo"
	editor="curtand"/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="06/16/2016"
	ms.author="billmath"/>


# Обновление сертификатов федерации для Office 365 и Azure AD

##Обзор

Для успешной федерации между Azure AD и AD FS сертификаты, используемые службами AD FS для подписывания маркеров безопасности в Azure AD, должны соответствовать параметрам, настроенным в Azure AD. Расхождение может привести к нарушению отношений доверия между AD FS и AAD. Azure AD гарантирует, что эта информация синхронизируется при развертывании AD FS и прокси веб-приложения (для доступа к экстрасети).

В этой статье представлены дополнительные сведения об управлении сертификатами для подписи маркеров и их синхронизации с Azure AD в следующих случаях.

* Вы не развертываете прокси веб-приложения, поэтому метаданные федерации недоступны в экстрасети.
* Вы не используете стандартную конфигурацию AD FS для сертификатов для подписи маркеров.
* Вы используете сторонний поставщик удостоверений.

## Стандартная конфигурация AD FS для сертификатов для подписи маркеров

Сертификаты для подписи маркеров и расшифровки токенов обычно представляют собой самозаверяющие сертификаты сроком годности один год. Стандартная конфигурация AD FS для сертификатов для подписи маркеров и расшифровки токенов включает процесс автоматического возобновления действия, который называется **AutoCertificateRollover**. Если вы используете AD FS 2.0 или более поздней версии, службы Office 365 и Azure AD будут автоматически обновлять ваш сертификат до окончания срока его действия.

### Уведомления о возобновлении действия — уведомления на портале Office 365 и по электронной почте

>[AZURE.NOTE] Если вы получите через портал или по электронной почте уведомление о том, что необходимо возобновить действие сертификата для Office, выполните шаги, описанные ниже в разделе об [управлении изменениями в сертификатах для подписи маркеров](#managecerts). Так вы сможете узнать, нужно ли предпринимать какие-либо действия. Корпорации Майкрософт известно о потенциальной проблеме, в результате которой пользователь может получать уведомления о возобновлении действия сертификата, даже если никаких действий не требуется.

Azure AD пытается отслеживать метаданные федерации и обновлять сертификаты для подписи маркеров, как указано в метаданных федерации. За 30 дней до истечения срока действия сертификатов для подписи маркеров Azure AD проверит, доступны ли новые сертификаты, путем опроса метаданных федерации.

* Если метаданные федерации успешно опрошены и получены новые сертификаты, пользователь не будет получать предупреждения по электронной почте или через портал Office 365.
* Если новые сертификаты для подписи маркеров не удалось получить, потому что метаданные федерации недоступны или автоматическая смена сертификатов не включена, по электронной почте будет отправлено соответствующее уведомление, а на портале Office 365 появится предупреждение.

![Уведомление на портале Office 365](./media/active-directory-aadconnect-o365-certs/notification.png)

>[AZURE.IMPORTANT] Чтобы обеспечить непрерывность бизнес-процессов при использовании AD FS, проверьте, установлены ли на ваших серверах следующие обновления, предотвращающие ошибки проверки подлинности при известных проблемах. Это позволит устранить известные проблемы с прокси-сервером AD FS при текущем и последующем возобновлении действия сертификатов.
>
>Server 2012 R2 — [May 2014 update rollup for Windows RT 8.1, Windows 8.1, and Windows Server 2012 R2](http://support.microsoft.com/kb/2955164) (Накопительный пакет обновления за май 2014 г. для Windows RT 8.1, Windows 8.1 и Windows Server 2012 R2).
>
>Server 2008 R2 и 2012 — [Authentication through proxy fails in Windows Server 2012 or Windows Server 2008 R2 SP1](http://support.microsoft.com/kb/3094446) (Сбой проверки подлинности через прокси-сервер в Windows Server 2008 R2 с пакетом обновления 1 (SP1) или Windows Server 2012).

## Проверка необходимости в обновлении сертификатов<a name="managecerts"></a>

### Шаг 1. Проверьте состояние свойства AutoCertificateRollover

На сервере AD FS откройте Microsoft PowerShell. Убедитесь, что для AutoCertRollover задано значение TRUE.

	Get-Adfsproperties

![AutoCertificateRollover](./media/active-directory-aadconnect-o365-certs/autocertrollover.png)

[AZURE.NOTE] При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.

### Шаг 2. Убедитесь, что службы AD FS и Azure AD синхронизированы

На сервере AD FS откройте командную строку Azure AD PowerShell и подключитесь к Azure AD.

>[AZURE.NOTE] Если у вас еще не установлена среда Azure AD PowerShell, ее можно скачать [здесь](https://technet.microsoft.com/library/jj151815.aspx).

	Connect-MsolService

Проверьте сертификаты, настроенные в AD FS, и свойства доверия Azure AD для указанного домена.

	Get-MsolFederationProperty -DomainName <domain.name> | FL Source, TokenSigningCertificate

![Get-MsolFederationProperty](./media/active-directory-aadconnect-o365-certs/certsync.png)

Если отпечатки в обоих наборах выходных данных совпадают, это подтверждает то, что сертификаты синхронизированы с Azure AD.

### Шаг 3. Проверьте, не истекает ли срок действия сертификата

В выходных данных Get-MsolFederationProperty или Get-AdfsCertificate проверьте дату после строки "Not after". Если эта дата наступает менее чем через 30 дней, необходимо принять меры.

### Дальнейшее действие

| AutoCertificateRollover | Сертификаты синхронизированы с Azure AD | Метаданные федерации общедоступны | Срок действия | Действие |
|:-----------------------:|:-----------------------:|:-----------------------:|:-----------------------:|:-----------------------:|
| Да | Да | Да | - | Никакие действия не требуются. См. раздел [Автоматическое возобновление действия сертификата для подписи маркера](#autorenew) | | Да | Нет | - | Менее 15 дней | Обновите немедленно. См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew) | | Нет | - | - | Менее 30 дней | Обновите немедленно. См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew) |

[-] — не имеет значения

## Автоматическое возобновление действия сертификата для подписи маркера (рекомендуется) <a name="autorenew"></a>

Если вы развернули прокси веб-приложения, который обеспечит доступ к метаданным федерации из экстрасети, и используете стандартную конфигурацию AD FS (т. е. свойство AutoCertificateRollover включено), **вам не нужно выполнять никаких действий вручную**. Проверьте следующие пункты, чтобы убедиться, что автоматическое обновление сертификата может выполняться.

**1. Для свойства AutoCertificateRollover служб AD FS должно быть задано значение True.**

Это указывает на то, что службы AD FS будут автоматически создавать новые сертификаты для подписи маркеров и расшифровки токенов до окончания срока действия старых.

**2. Метаданные федерации AD FS общедоступны.**

Убедитесь, что метаданные федерации доступны для общего пользования через Интернет (за пределами корпоративной сети), перейдя со своего компьютера по следующему URL-адресу.


https://(your_FS_name)/federationmetadata/2007-06/federationmetadata.xml

где `(your_FS_name) ` заменяется именем узла службы федерации, которое используется в вашей организации (например, fs.contoso.com). Если проверка двух этих параметров оказалась успешной, вам больше не нужно ничего делать.

Пример: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml

## Возобновление действия сертификата для подписи маркера вручную <a name="manualrenew"></a>

Сертификаты для подписи маркеров можно обновить вручную. Это может потребоваться в следующих распространенных ситуациях.
* Сертификаты для подписи маркеров не являются самозаверяющими. Вероятнее всего, это происходит потому, что ваша организация использует сертификаты AD FS, зарегистрированные в центре сертификации организации. 
* В системе безопасности сети запрещен общий доступ к метаданным федерации.

В этих ситуациях при каждом обновлении сертификатов для подписи маркеров также необходимо обновить домен Office 365 с помощью команды PowerShell Update-MsolFederatedDomain.

### Процедура возобновления действия сертификата для подписи маркера и обновления доверия федерации Office 365

**Шаг 1. Убедитесь, что в службах AD FS используются новые сертификаты для подписи маркеров**

### Нестандартная конфигурация
Если применяется нестандартная конфигурация AD FS, где значение свойства **AutoCertificateRollover** равно **False**, вероятно, вы используете настраиваемые (не самозаверяющие) сертификаты. Ознакомьтесь с разделом [Рекомендации для клиентов, не использующих самозаверяющие сертификаты AD FS](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert), в котором содержится подробное руководство по обновлению сертификатов для подписи маркеров AD FS.

### Метаданные федерации не являются общедоступными
С другой стороны, если значение свойства **AutoCertificateRollover** равно **True**, но метаданные федерации не являются общедоступными, сначала убедитесь, что новый сертификат для подписи маркеров создан службами AD FS. Выполните следующие действия, чтобы убедиться, что у вас есть новые сертификаты для подписи маркеров.

1. Убедитесь, что вы вошли на основной сервер AD FS.
2. Проверьте текущие сертификаты подписи в AD FS, открыв командное окно PowerShell и выполнив следующую команду.

	PS C:\>Get-ADFSCertificate –CertificateType token-signing

	>[AZURE.NOTE] При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.

3. Просмотрите данные, которые будут выведены для всех сертификатов в списке. Если служба AD FS создала новый сертификат, вы увидите два сертификата в выходных данных: один, для которого значение IsPrimary равно «Истина», а дата NotAfter равна 5 дней; второй, для которого значение IsPrimary равно «Ложь», а дата NotAfter равна приблизительно году.

4. Если вы видите только один сертификат, а дата NotAfter равна 5 дням, необходимо создать новый сертификат, выполнив следующие действия.

5. Чтобы создать сертификат, в командной строке PowerShell выполните такую команду: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.

6. Проверьте обновление, запустив следующую команду еще раз: PS C: > Get-ADFSCertificate –CertificateType token-signing.

Теперь должны появиться два сертификата, один из которых имеет дату NotAfter, равную приблизительно году, и у которого значение параметра IsPrimary равно «Ложь».

**Шаг 2. Добавление новых сертификатов для подписи маркеров для использования в отношениях доверия Office 365**

Выполните описанные ниже действия, чтобы добавить в Office 365 новые сертификаты для подписи маркеров, которые будут использоваться в отношениях доверия.

1.	Откройте модуль Microsoft Azure Active Directory для Windows PowerShell.
2.	Запустите $cred=Get-Credential. Если этот командлет запрашивает учетные данные, введите данные учетной записи администратора облачных служб.
3.	Запустите Connect-MsolService –Credential $cred. Этот командлет подключит вас к облачной службе. Перед выполнением любых дополнительных командлетов, установленных с помощью средства, необходимо создать контекст, который подключит вас к облачной службе.
4.	Если эти команды выполняются на компьютере, который не является основным сервером федерации AD FS, выполните команду Set-MSOLAdfscontext -Computer <AD FS primary server>, где <AD FS primary server> — внутреннее полное доменное имея основного сервера AD FS. Этот командлет создает контекст, подключающий вас к AD FS.
5.	Выполните команду Update-MSOLFederatedDomain -DomainName <domain>. Этот командлет обновляет параметры AD FS в облачной службе и настраивает отношения доверия между ними.


>[AZURE.NOTE] Если требуется поддержка нескольких доменов верхнего уровня, например contoso.com и fabrikam.com, необходимо использовать параметр SupportMultipleDomain с любыми командлетами. Дополнительные сведения см. в статье, описывающей [поддержку нескольких доменов верхнего уровня](active-directory-aadconnect-multiple-domains.md).

## Восстановление доверия Azure AD с помощью AAD Connect <a name="connectrenew"></a>

Если вы установили и настроили ферму AD FS или доверие Azure AD, используя Azure AD Connect, то с помощью Azure AD Connect можно определить, нужно ли выполнять какие-либо действия с сертификатами для подписи маркеров. Если требуется обновить сертификаты, с помощью Azure AD Connect необходимые действия можно выполнить за несколько щелчков.

Дополнительные сведения см. в разделе [Восстановление доверия](./active-directory-aadconnect-federation-management.md#repairing-the-trust).

<!---HONumber=AcomDC_0622_2016-->