<properties
	pageTitle="Руководство по обновлению сертификатов для пользователей Office 365 и Azure AD | Microsoft Azure"
	description="В этой статье рассматриваются способы устранения проблем с сообщениями электронной почты, уведомляющими пользователей Office 365 о необходимости обновления сертификата."
	services="active-directory"
	documentationCenter=""
	authors="billmath"
	manager="stevenpo"
	editor="curtand"/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/03/2016"
	ms.author="billmath"/>


# Обновление сертификатов федерации для Office 365 и Azure AD

Если вы получили сообщение электронной почты или уведомление портала с запросом на обновление сертификата для Office 365, эта статья поможет вам не только устранить проблему, но и предотвратить ее появление в будущем. В этой статье предполагается, что вы используете AD FS в качестве сервера федерации.

>[AZURE.IMPORTANT] Учтите, что проверка подлинности через прокси-сервер может завершиться ошибкой в Windows Server 2012 или Windows Server 2008 R2 после выполнения одного из следующих действий:
>
- Прокси-сервер обновляет свой маркер доверия после смены сертификатов в AD FS.
- Вы вручную заменили сертификаты AD FS.
>
Для устранения этой проблемы доступно исправление. См. статью [Сбой проверки подлинности через прокси-сервер в Windows Server 2012 или Windows 2008 R2 с пакетом обновления 1 (SP1)](http://support.microsoft.com/kb/3094446).

## Ознакомьтесь с ней, чтобы знать, нужно ли вам что-то делать.

Если вы используете AD FS 2.0 или более поздней версии, службы Office 365 и Azure AD будут автоматически обновлять ваш сертификат до окончания срока его действия. Вам необязательно выполнять какие-либо действия вручную или запускать скрипт в качестве запланированной задачи. Но для этого должны быть включены оба описанных ниже параметра конфигурации AD FS, заданных по умолчанию.

- Свойству AD FS AutoCertificateRollover должно быть присвоено значение «Истина», указывающее на то, что AD FS будет автоматически создавать новые сертификаты для подписи и расшифровки маркера до окончания срока действия старых.
	- Если значение равно «Ложь», это значит, что используются пользовательские параметры сертификатов. Подробное руководство см. [здесь](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).
- Метаданные федерации должны быть доступны для общего пользования через Интернет.

	Вот как это можно проверить.

	- Убедитесь, что при установке AD FS используется автоматическая смена сертификатов. Для этого в командном окне на основном сервере федерации выполните следующую команду PowerShell.

	`PS C:\> Get-ADFSProperties`

(Обратите внимание: при использовании AD FS 2.0 необходимо сначала выполнить Add-Pssnapin Microsoft.Adfs.Powershell).

В полученных результатах проверьте следующее.
	
	AutoCertificateRollover :True

Убедитесь, что метаданные федерации доступны для общего пользования через Интернет (за пределами корпоративной сети), перейдя со своего компьютера по следующему URL-адресу.


https://(your_FS_name)/federationmetadata/2007-06/federationmetadata.xml

где `(your_FS_name) ` заменяется именем узла службы федерации, которое используется в вашей организации (например, fs.contoso.com). Если проверка двух этих параметров оказалась успешной, вам больше не нужно ничего делать.

Пример: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml

## Если вы решили обновить сертификат вручную
При обновлении сертификатов AD FS вручную необходимо обновить домен Office 365 с помощью команды PowerShell Update-MsolFederatedDomain, как показано в инструкции из раздела об обновлении вручную свойств доверия федерации Office 365, который приведен [здесь](#if-your-metadata-is-not-publicly-accessible).

## Если свойство AutoCertificateRollover имеет значение «Ложь»

Если свойство AutoCertificateRollover имеет значение «Ложь», это значит, что используются параметры сертификата AD FS, заданные не по умолчанию. Вероятнее всего, это происходит потому, что ваша организация использует сертификаты AD FS, зарегистрированные в центре сертификации организации. В таком случае вам необходимо обновить и продлить сертификаты самостоятельно. Руководство см. [здесь](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).

## Если метаданные не являются общедоступными
Если параметр AutocertificateRollover имеет значение «Истина», но метаданные федерации не являются общедоступными, настройте обновление сертификатов локально и в облаке следующим образом.

### Убедитесь, что система AD FS создала новый сертификат.

- Убедитесь, что вы вошли на основной сервер AD FS.
- Проверьте текущие сертификаты подписи в AD FS, открыв командное окно PowerShell и выполнив следующую команду.

`PS C:\>Get-ADFSCertificate –CertificateType token-signing.`

(Обратите внимание: при использовании AD FS 2.0 необходимо сначала выполнить Add-Pssnapin Microsoft.Adfs.Powershell).


- Просмотрите данные, которые будут выведены для всех сертификатов в списке. Если служба AD FS создала новый сертификат, вы увидите два сертификата в выходных данных: один, для которого значение IsPrimary равно «Истина», а дата NotAfter равна 5 дней; второй, для которого значение IsPrimary равно «Ложь», а дата NotAfter равна приблизительно году.

- Если вы видите только один сертификат, а дата NotAfter равна 5 дням, необходимо создать новый сертификат, выполнив следующие действия.

- Чтобы создать сертификат, в командной строке PowerShell выполните такую команду: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.

- Проверьте обновление, запустив следующую команду еще раз: PS C: > Get-ADFSCertificate –CertificateType token-signing.
	- Теперь должны появиться два сертификата, один из которых имеет дату NotAfter, равную приблизительно году, и у которого значение параметра IsPrimary равно «Ложь».

- Затем, чтобы вручную обновить свойства доверия федерации Office 365, выполните следующие действия.




### Обновите свойства доверия федерации Office 365 вручную, выполнив следующие действия.

1.	Откройте модуль Microsoft Azure Active Directory для Windows PowerShell.
2.	Запустите $cred=Get-Credential. Если этот командлет запрашивает учетные данные, введите данные учетной записи администратора облачных служб.
3.	Запустите Connect-MsolService –Credential $cred. Этот командлет подключит вас к облачной службе. Перед выполнением любых дополнительных командлетов, установленных с помощью средства, необходимо создать контекст, который подключит вас к облачной службе.
4.	Если эти команды выполняются на компьютере, который не является основным сервером федерации AD FS, выполните команду Set-MSOLAdfscontext -Computer <AD FS primary server>, где <AD FS primary server> — внутреннее полное доменное имея основного сервера AD FS. Этот командлет создает контекст, подключающий вас к AD FS.
5.	Выполните команду Update-MSOLFederatedDomain -DomainName <domain>. Этот командлет обновляет параметры AD FS в облачной службе и настраивает отношения доверия между ними.

>[AZURE.NOTE] Если требуется поддержка нескольких доменов верхнего уровня, например contoso.com и fabrikam.com, необходимо использовать параметр SupportMultipleDomain с любыми командлетами. Дополнительные сведения см. в статье, описывающей [поддержку нескольких доменов верхнего уровня](active-directory-aadconnect-multiple-domains.md). Наконец, убедитесь, что на всех серверах с прокси-службой веб-приложения установлен накопительный пакет обновления для [Windows Server за май 2014 г.](http://support.microsoft.com/kb/2955164). Иначе прокси-серверы могут не обновиться с помощью нового сертификата, что приведет к простою в работе.

<!---HONumber=AcomDC_0504_2016-->