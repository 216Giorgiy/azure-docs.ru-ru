<properties
	pageTitle="Неявный поток данных модели приложений 2.0 | Microsoft Azure"
	description="Построение веб-приложений с помощью реализации неявного потока данных в одностраничных приложениях Azure AD."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="msmbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="11/19/2015"
	ms.author="dastrock"/>

# Предварительная версия модели приложений 2.0. Протоколы: неявный поток данных
В версии 2.0 модели приложений Azure AD пользователи могут входить в одностраничные приложения с личных и рабочих или учебных учетных записей Майкрософт. Во время проверки подлинности одностраничные и другие приложения JavaScript, которые запускаются в основном в браузере, сталкиваются с некоторыми проблемами.

- Характеристики безопасности этих приложений значительно отличаются от традиционных серверных веб-приложений.
- Многие серверы авторизации и поставщики удостоверений не поддерживают запросы CORS по задокументированным соображениям безопасности.
- Полностраничный браузер перенаправляет пользователя из приложения, взаимодействие с которым становится особенно агрессивным.

Для этих приложений (а именно AngularJS, Ember.js, React.js и т. д.) Azure AD поддерживает поток OAuth 2.0 Implicit Grant. Подробное описание неявного потока данных см. в [Спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-4.2). Его основное преимущество заключается в том, что приложение получает маркеры из Azure AD без предоставления учетных данных внутреннему серверу. Так, приложение может авторизовать пользователей, поддерживать сеансы и получать маркеры для других веб-API — и все это из клиентского кода JavaScript. Во время использования неявного потока данных необходимо обращать внимание на некоторые важные вопросы безопасности, касающиеся, в частности, [клиента](http://tools.ietf.org/html/rfc6749#section-10.3) и [маскировки под другого пользователя](http://tools.ietf.org/html/rfc6749#section-10.3).

Если для добавления проверки подлинности в приложение JavaScript вы хотите использовать неявный поток данных и Azure AD, рекомендуем использовать библиотеку открытого исходного кода JavaScript [adal.js](https://github.com/AzureAD/azure-activedirectory-library-for-js). [Здесь](active-directory-appmodel-v2-overview.md#getting-started) можно найти несколько учебников по AngularJS, которые помогут приступить к работе.

Тем не менее, в одностраничном приложении можно обойтись без использования библиотеки. Отправлять сообщения протокола в таком случае нужно самостоятельно. Для этого выполните следующие шаги.

> [AZURE.NOTE]Эти сведения относятся к общедоступной предварительной версии модели приложений 2.0. Инструкции по интеграции с общедоступной службой Azure AD см. в статье [Руководство разработчика Azure Active Directory](active-directory-developers-guide.md).

## Отправка запроса на вход

Для первого входа пользователя в приложение можно отправить запрос на авторизацию [OpenID Connect](active-directory-v2-protocols-oidc.md) и получить `id_token` из конечной точки версии 2.0:

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=fragment
&scope=openid%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
&state=12345
&nonce=678910
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен включать `id_token` для входа в OpenID Connect. Параметр также может содержать другие типы response\_types, например `code`. |
| redirect\_uri | обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами. При использовании OpenID Connect он должен включать область `openid`, которая преобразуется в разрешение «Вход в профиль и его просмотр» в пользовательском интерфейсе предоставления разрешений. Для предоставления разрешений этот запрос может также включать другие области. |
| nonce | обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного маркера id\_token в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения маркера. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment".  
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| prompt | необязательный | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — «login», «none» и «consent». Если указано значение `prompt=login`, пользователю придется вводить учетные данные по запросу. Единый вход не сработает. Значение `prompt=none` является противоположным — оно гарантирует, что интерактивные запросы не будут выводиться ни при каких обстоятельствах. Если запрос не удастся завершить автоматически через единый вход, конечная точка версии 2.0 вернет ошибку. После входа пользователя `prompt=consent` откроет диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| login\_hint | необязательный | Можно использовать для предварительного заполнения поля имени пользователя или электронного адреса на странице входа пользователя. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope`. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии и мультитенантных приложениях можно найти здесь](active-directory-v2-scopes.md).

После прохождения пользователем проверки подлинности и предоставления разрешения конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, заданного в параметре `response_mode`.

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```
GET https://localhost/myapp/#
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the id_token, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request
&id_token_expires_in=3600

```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id\_token | Маркер "id\_token", запрошенный приложением. Вы можете использовать маркер "id\_token" для проверки удостоверения пользователя и запуска сеанса с пользователем. Дополнительные сведения о маркерах id\_token и их содержимом можно найти в [Справочнике по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md). |
| session\_state | Уникальное значение, указывающее текущий сеанс пользователя. Это значение представляет собой GUID, но его следует расценивать как непрозрачное значение, передаваемое без рассмотрения. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |
| id\_token\_expires\_in | Срок действия маркера идентификации (в секундах). |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение правильно обрабатывало их.

```
GET https://localhost/myapp/#
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## Проверка маркера "id\_token"
Для проверки подлинности пользователя недостаточно просто получить маркер "id\_token". Вам также потребуется проверить подпись маркера "id\_token" и утверждения в нем в соответствии с требованиями приложения. В конечной точке версии 2.0 для подписи маркеров и проверки их правильности используются [веб-маркеры JSON (JWTs)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Модель приложений 2.0 содержит конечную точку метаданных OpenID Connect, позволяющую приложению получать сведения о модели приложений 2.0 в среде выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Конечная точка метаданных содержит документ JSON, расположенный по ссылке:

`https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`

Одно из свойств этого документа конфигурации — `jwks_uri`. Для модели приложений 2.0 его значение будет следующим:

`https://login.microsoftonline.com/common/discovery/v2.0/keys`.

Вы можете использовать открытые ключи RSA256, расположенные на этой конечной точке, для проверки подписи маркера "id\_token". В любой момент времени на этой конечной точке числятся несколько ключей, каждый из которых определяется `kid`. Заголовок маркера id\_token также содержит утверждение `kid`, указывающее на ключ, который использовался для подписи маркера id\_token.

Дополнительные сведения можно найти в [Справочнике по маркерам в модели приложений 2.0](active-directory-v2-tokens.md), включая подразделы [Проверка маркеров](active-directory-v2-tokens.md#validating-tokens) и [Важные сведения о смене ключей подписи](active-directory-v2-tokens.md#validating-tokens). <!--TODO: Improve the information on this-->

Вы можете проверить `id_token` в клиентском коде, но обычно `id_token` отправляется на проверку внутреннему серверу. Существует множество библиотек для анализа и проверки маркеров JWT. После проверки подписи маркера "id\_token" вам потребуется проверить несколько утверждений:

- Проверьте утверждение `nonce` во избежание атак с использованием воспроизведения маркера. Его значение должно совпадать с указанным вами в запросе на вход.
- Проверьте утверждение `aud` и убедитесь, что маркер id\_token выдан для вашего приложения. Его значением должен быть идентификатор `client_id` приложения.
- Проверьте утверждения `iat` и `exp` и убедитесь, что срок действия маркера id\_token не истек.

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

- Обеспечение регистрации пользователя или организации в приложении.
- Предоставление пользователю необходимого уровня авторизации и привилегий.
- Обеспечение определенного уровня проверки подлинности, например многофакторной проверки подлинности.

Дополнительные сведения об утверждениях в маркере id\_token можно найти в [Справочнике по маркерам в модели приложений 2.0](active-directory-v2-tokens.md).

После полной проверки маркера "id\_token" вы можете начать сеанс с пользователем и использовать утверждения в маркере "id\_token" для получения сведений о пользователе в приложении. Эти сведения можно использовать для отображения, записей, авторизации и т. д.

## Получение маркеров доступа

Теперь, когда пользователь вошел в одностраничное приложение, можно получить маркеры доступа для вызова веб-API, защищенных с помощью Azure AD, например [Microsoft Graph](https://graph.microsoft.io). В обычных потоках OpenID Connect и OAuth маркеры можно получить, отправив запрос к конечной точке версии 2.0 `/token`. Однако конечная точка версии 2.0 не поддерживает запросы CORS. Поэтому получать и обновлять маркеры с помощью вызовов AJAX невозможно. Вместо этого для получения новых маркеров для других веб-API можно использовать неявный поток данных в скрытом iframe.

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=fragment
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read  // The space separated scope(s) you want an access token for
&state=12345
&prompt=none
&login_hint=joe.user@outlook.com
&domain_hint=consumers
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен иметь значение `token` для неявного потока. |
| redirect\_uri | обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Разделенный пробелами список областей, необходимых в маркере доступа. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment".  
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| prompt | обязательно | Здесь мы используем `prompt=none`, чтобы обозначить, что Azure AD не должен содержать элементы пользовательского интерфейса. Этот запрос выполняется в скрытом iframe. Поэтому если маркер нельзя получить без вмешательства пользователя, убедитесь, что вместо запроса на вход служба Azure AD возвращает ошибку. |
| login\_hint | обязательно | Требуется для автоматической проверки подлинности. Если у пользователя открыты сеансы сразу для нескольких учетных записей, эта подсказка помогает Azure AD различать их. Это может быть в точности то значение, которое появляется в утверждении `preferred_uesrname` в id\_token. |
| domain\_hint | обязательно | Требуется для автоматической проверки подлинности. В этом потоке domain\_hint может принимать одно из двух значений: `consumers` или `organizations`. Если полученное значение утверждения `tid` в `id_token` — «9188040d-6c67-4c5b-b112-36a304b66dad», укажите для domain\_hint значение `consumers`. Или используйте `organizations`. |

Благодаря параметру `prompt=none` этот запрос успешно выполнится или немедленно завершится с ошибкой, и вы вернетесь к своему приложению. Успешный ответ будет отправлен в ваше приложение на указанный `redirect_uri` с помощью метода, заданного в параметре `response_mode`.

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the access_token, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request
&expires_in=3600
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read

```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| access\_token | Маркер, запрошенный приложением. |
| session\_state | Уникальное значение, указывающее текущий сеанс пользователя. Это значение представляет собой GUID, но его следует расценивать как непрозрачное значение, передаваемое без рассмотрения. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |
| expires\_in | Срок действия маркера доступа (в секундах). |
| scope | Области, для которых действителен маркер доступа. |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение правильно обрабатывало их. Если вы используете `prompt=none`, отобразится следующая ошибка.

```
GET https://localhost/myapp/#
error=user_authentication_required
&error_description=the+request+could+not+be+completed+silently
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

После появления этой ошибки в запросе iframe пользователю необходимо войти еще раз в интерактивном режиме для получения нового маркера. Этот случай можно обрабатывать любым способом, который лучше всего подходит для вашего приложения.

## Маркеры обновления

Срок действия маркеров `id_token` и `access_token` очень короткий, поэтому приложение должно быть готово периодически обновлять их. Чтобы обновить маркер любого типа, выполните тот же скрытый запрос iframe, приведенный выше, используя параметр `prompt=none` для управления поведением Azure AD. Чтобы получить новый `id_token`, обязательно используйте `response_type=id_token` и `scope=openid`, а также параметр `nonce`.


## Отправка запроса на выход

На текущий момент предварительная версия модели приложений 2.0 не поддерживает `end_session_endpoint` OpenID Connect. Это значит, что приложение не может отправлять запросы на конечную точку версии 2.0 для прекращения сеанса пользователя и очистки файлов cookie, установленных конечной точкой версии 2.0. Для выполнения выхода пользователя приложение может просто завершить собственный сеанс с пользователем, не затрагивая сеанс пользователя с конечной точкой версии 2.0. При следующей попытке входа пользователь увидит страницу выбора учетной записи с перечнем учетных записей, в которые выполнен вход. На этой странице пользователь может выйти из любой учетной записи, тем самым завершая сеанс с конечной точкой версии 2.0.

<!--

When you wish to sign the user out of the  app, it is not sufficient to clear your app's cookies or otherwise end the session with the user.  You must also redirect the user to the v2.0 endpoint for sign out.  If you fail to do so, the user will be able to re-authenticate to your app without entering their credentials again, because they will have a valid single sign-on session with the v2.0 endpoint.

You can simply redirect the user to the `end_session_endpoint` listed in the OpenID Connect metadata document:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/logout?
post_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
```

| Parameter | | Description |
| ----------------------- | ------------------------------- | ------------ |
| post_logout_redirect_uri | recommended | The URL which the user should be redirected to after successful logout.  If not included, the user will be shown a generic message by the v2.0 endpoint.  |

-->

<!---HONumber=AcomDC_1125_2015-->