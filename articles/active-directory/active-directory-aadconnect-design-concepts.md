<properties
   pageTitle="Принципы проектирования Azure AD Connect | Microsoft Azure"
   description="В этой статье описываются факторы, которые необходимо учитывать при проектировании реализации"
   services="active-directory"
   documentationCenter=""
   authors="AndKjell"
   manager="stevenpo"
   editor=""/>

<tags
   ms.service="active-directory"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="Identity"
   ms.date="04/20/2016"
   ms.author="andkjell"/>

# Azure AD Connect: принципы проектирования
В этой статье приведено описание факторов, которые должны учитываться при проектировании реализации Azure AD Connect. Здесь подробно рассмотрены некоторые вопросы, которые кратко описывались в других статьях.

## sourceAnchor
Атрибут sourceAnchor определяется как *атрибут, который остается неизменным на протяжении всего времени существования объекта*. Он однозначно определяет объект независимо от того, является ли он локальным или находится в Azure AD. Этот атрибут также называется **immutableId**. Оба этих имени взаимозаменяемы.

Слово «неизменяемый» (immutable) является ключевым. Оно означает, что значение атрибута не может быть изменено. Поскольку значение этого атрибута неизменно после его задания, важно выработать механизм, поддерживающий ваш сценарий.

Данный атрибут используется в следующих случаях.

- При построении нового сервера синхронизации или повторном построении после аварийного восстановления. В этом случае данный атрибут свяжет существующие объекты в Azure AD и локальные объекты.
- При перемещении из исключительно облачного удостоверения в модель синхронизированных удостоверений. В этом случае данный атрибут позволит жестко связывать существующие объекты в Azure AD с локальными объектами.
- Если вы используете федерации, этот атрибут в сочетании с **userPrincipalName** используется в утверждении для уникальной идентификации пользователя.

В этой статье речь пойдет только об атрибуте sourceAnchor в контексте его отношений с пользователями. Аналогичные правила действуют для всех типов объектов, но проблемы обычно возникают именно у пользователей.

### Выбор значений атрибута sourceAnchor.
Значение атрибута должно соответствовать следующим правилам:

- его длина должна быть меньше 60 символов;
    - символы, отличные от a–z, A–Z или 0–9, будут закодированы и каждый из них будет считаться за три;
- оно не должно содержать специальные символы: &#92; ! # $ % & * + / = ? ^ &#96; { } | ~ < > ( ) ' ; : , [ ] " @ \_
- оно должно быть глобально уникальным;
- оно должно иметь строковый, целочисленный или двоичный тип;
- не должно быть основано на имени пользователя;
- не должно учитывать регистр и не содержать значения, которые могут изменяться по регистру;
- должно назначаться при создании объекта.

Если значение sourceAnchor не является строковым, то в качестве типа Azure AD Connect будет использовать Base64Encode. Это исключит появление специальных символов. Если вы используете сервер федерации, отличный от ADFS, убедитесь что на сервере можно использовать кодировку Base64 для атрибута.

Атрибут sourceAnchor чувствителен к регистру. «JohnDoe» и «johndoe» — это разные значения.

При наличии одного локального леса следует использовать атрибут **objectGUID**. Этот атрибут используется, если вы применяете стандартные параметры Azure AD Connect. Он также используется в DirSync.

Если у вас есть несколько лесов и вы не перемещаете пользователей между лесами или доменами одного леса, рекомендуется использовать атрибут **objectGUID**.

В случае перемещения пользователей между лесами или доменами вам потребуется найти такой атрибут, который никогда не изменяется или может перемещаться с пользователями. Рекомендуется использовать синтетический атрибут. Для этого подойдет атрибут, который будет выглядеть, как идентификатор GUID. При создании объекта пользователю присваивается новый идентификатор GUID. Настраиваемое правило может быть создано на сервере подсистемы синхронизации для формирования этого значения на основе **objectGUID** и обновления выбранного атрибута в ADDS. При перемещении объекта убедитесь, что это значение также копируется.

Кроме того, можно выбрать существующий атрибут, который точно не изменится. Зачастую можно использовать атрибут **employeeID**. Если значение вашего атрибута будет содержать буквы, вам потребуется исключить вероятность изменения регистра (на верхний или нижний) в значении атрибута. Не следует использовать атрибуты, содержащие имя пользователя. В случае женитьбы или развода имя может измениться, что недопустимо для этого атрибута. Это одна из причин того, почему мастер установки Azure AD Connect не позволяет выбирать такие атрибуты, как **userPrincipalName**, **mail** и **targetAddress**. Эти атрибуты также содержат символ @, что недопустимо для sourceAnchor.

### Изменение атрибута sourceAnchor.
Значение атрибута sourceAnchor нельзя изменить после создания объекта в Azure AD и синхронизации удостоверения.

По этой причине в Azure AD Connect действуют следующие ограничения.

- Атрибут sourceAnchor можно задать только при первоначальной установке. При повторном запуске мастера установки этот параметр доступен только для чтения. Для изменения атрибута потребуется удалить и переустановить программу.
- При установке другого сервера Azure AD Connect необходимо выбрать уже используемый атрибут sourceAnchor. Если вы ранее использовали DirSync и переходите на Azure AD Connect, вам потребуется использовать **objectGUID**, так как этот атрибут использовался в DirSync.
- Если после экспорта объекта в Azure AD значение sourceAnchor будет изменено, синхронизация Azure AD Connect выдаст ошибку. После этого вы не сможете вносить изменения в объект до устранения проблемы и возврата sourceAnchor в исходный каталог.

## Вход в Azure AD

При интеграции локального каталога с Azure AD важно понять, как параметры синхронизации могут повлиять на способ проверки подлинности, используемый пользователем. Для проверки подлинности пользователя Azure AD использует userPrincipalName или имя участника-пользователя (UPN). Однако при синхронизации пользователей необходимо тщательно выбирать атрибут, который используется в качестве значения userPrincipalName.

### Выбор атрибута для userPrincipalName

При выборе атрибута, который будет использоваться в Azure в качестве значения UPN (имени участника-пользователя), следует убедиться в следующем.

* Значения атрибута соответствует синтаксису имени участника-пользователя (RFC 822), т. е. оно должно иметь формат username@domain.
* Суффикс в значениях соответствует одному из проверенных пользовательских доменов в Azure AD.

В стандартных параметрах предполагается, что для атрибута выбрано значение userPrincipalName. Однако, если вы считаете, что атрибут userprincipalname не содержит значение, которое пользователи могли бы использовать для входа в Azure, то следует выбрать параметр **Выборочная установка** и указать соответствующий атрибут.

### Состояние и имя участника-пользователя пользовательского домена
Важно убедиться, что для суффикса имени участника-пользователя используется проверенный домен.

Джон (John) является пользователем в contoso.com. Вы хотите, чтобы Джон использовал локальное имя участника-пользователя john@contoso.com для входа в Azure после синхронизации пользователей с каталогом Azure AD azurecontoso.onmicrosoft.com. Чтобы это сделать, необходимо добавить и проверить contoso.com как пользовательский домен в Azure AD перед началом синхронизации пользователей. Если суффикс имени участника-пользователя Джона, т. е. contoso.com, не соответствует проверенному домену в Azure AD, то Azure AD заменит суффикс имени участника-пользователя на azurecontoso.onmicrosoft.com и Джону для входа в Azure необходимо будет использовать john@azurecontoso.onmicrosoft.com.

### Не поддерживающие маршрутизацию локальные домены и имена участников-пользователей для Azure AD
В некоторых организациях используются домены, не поддерживающие маршрутизацию, такие как contoso.local, или простые одноуровневые домены, как contoso. В Azure AD нельзя проверить не поддерживающий маршрутизацию домен. Служба Azure AD Connect может синхронизироваться только с проверенным доменом в Azure AD. При создании каталога Azure AD она создает маршрутизируемый домен, который становится для Azure AD доменом по умолчанию, например contoso.onmicrosoft.com. Поэтому в данном сценарии возникает необходимость проверить любой другой маршрутизируемый домен в случае, если вы не хотите синхронизироваться с доменом .onmicrosoft.com по умолчанию.

Дополнительные сведения о том, как добавлять и проверять домены, см. в разделе [Добавление имени личного домена в Azure Active Directory](active-directory-add-domain.md).

Azure AD Connect определяет, когда используется не поддерживающая маршрутизацию доменная среда и соответствующим образом предупреждает, чтобы вы не продолжали, не изменив стандартные параметры. При работе в не поддерживающем маршрутизацию домене имена участников-пользователей тоже, скорее всего, будут иметь не поддерживающий маршрутизацию суффикс. Например, если вы работаете в домене contoso.local, служба Azure AD Connect предложит вместо стандартных параметров использовать настраиваемые . С помощью настраиваемых параметров можно указать атрибут, который следует использовать в качестве имени участника-пользователя для входа в Azure после выполнения синхронизации пользователей с Azure AD. Дополнительные сведения см. ниже в разделе **Выбор атрибута для имени участника-пользователя в Azure AD**.

## Дальнейшие действия
Узнайте больше об [интеграции локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md).

<!---HONumber=AcomDC_0518_2016-->