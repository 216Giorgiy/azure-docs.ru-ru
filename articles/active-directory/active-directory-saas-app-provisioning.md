---
title: Автоматическая подготовка пользователей для приложения SaaS в Azure AD | Документы Майкрософт
description: Общие сведения об использовании Azure AD для автоматической подготовки, отзыва и постоянного обновления учетных записей пользователей в нескольких приложениях SaaS сторонних разработчиков.
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
ms.service: active-directory
ms.component: app-mgmt
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 07/30/2018
ms.author: barbkess
ms.reviewer: asmalser
ms.openlocfilehash: 0d6f345a35275328212d6a245242083b809943b7
ms.sourcegitcommit: a1140e6b839ad79e454186ee95b01376233a1d1f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2018
ms.locfileid: "43144090"
---
# <a name="automate-user-provisioning-and-deprovisioning-to-saas-applications-with-azure-active-directory"></a>Автоматическая подготовка пользователей и ее отзыв для приложений SaaS в Azure Active Directory
## <a name="what-is-automated-user-provisioning-for-saas-apps"></a>Что такое автоматическая подготовка пользователей для приложений SaaS
Служба Azure Active Directory (Azure AD) предоставляет возможность автоматизировать процесс создания, обслуживания и удаления удостоверений пользователей в облачных приложениях ([SaaS](https://azure.microsoft.com/overview/what-is-saas/)), таких как Dropbox, Salesforce, ServiceNow и другие.

> [!VIDEO https://www.youtube.com/embed/_ZjARPpI6NI]

**Ниже приведены некоторые примеры возможностей, которые предоставляет эта функция.**

* Автоматическое создание новых учетных записей в соответствующих системах для новых членов вашей команды или организации.
* Автоматическая деактивация учетных записей в соответствующих системах, когда люди покидают команду или организацию.
* Постоянное обновление удостоверений в ваших приложениях и системах при внесении изменений в каталог или в систему управления персоналом.
* Подготовка не созданных пользователями объектов, таких как группы, в приложениях, которые их поддерживают.

**Автоматическая подготовка пользователей также предусматривает такие возможности:**

* Сопоставление существующих удостоверений в исходных и целевых системах.
* Настраиваемые сопоставления атрибутов, которые определяют, какие данные пользователя должны поступать из исходной системы в целевую систему.
* Необязательная отправка сообщения с оповещением об ошибке при подготовке.
* Составление отчетов и журналов действий для упрощения отслеживания и устранения неполадок.

## <a name="why-use-automated-provisioning"></a>Для чего нужна автоматическая подготовка
Вот несколько основных причин, по которым стоит использовать эту функцию:

* Исключение затрат, неэффективности и ошибок, связанных с человеческим фактором, которые могут возникать в ходе выполнения подготовки вручную.
* Исключение затрат, связанных с размещением и поддержкой специально разработанных решений и сценариев для подготовки.
* Возможность обезопасить свою организацию, мгновенно удаляя из ключевых приложений SaaS удостоверения пользователей, которые покидают вашу организацию.
* Максимальное упрощение импорта большого количества пользователей в конкретное приложение SaaS или систему.
* Удобство применения единого набора политик, определяющих подготавливаемых пользователей и возможность входа в приложение.

## <a name="how-does-automatic-provisioning-work"></a>Как работает автоматическая подготовка
    
**Служба подготовки Azure AD** подготавливает пользователей для приложений SaaS и других систем путем подключения к конечным точкам API управления пользователями, предоставляемыми каждым поставщиком приложений. Эти конечные точки API управления пользователями позволяют Azure AD создавать, обновлять и удалять пользователей путем программирования. Для выбранных приложений служба подготовки может также создавать, обновлять и удалять дополнительные объекты, связанные с удостоверениями, такие как группы и роли. 

![Подготовка](./media/active-directory-saas-app-provisioning/provisioning0.PNG)
*Рис. 1. Служба подготовки Azure AD*

![Исходящая подготовка](./media/active-directory-saas-app-provisioning/provisioning1.PNG)
*Рис. 2. "Исходящий" рабочий процесс подготовки пользователей из Azure AD в популярные приложения SaaS*

![Входящая подготовка](./media/active-directory-saas-app-provisioning/provisioning2.PNG)
*Рис. 3."Входящий" рабочий процесс подготовки пользователей из популярных приложений управления кадрами (HCM) в Azure Active Directory и Windows Server Active Directory*


## <a name="what-applications-and-systems-can-i-use-with-azure-ad-automatic-user-provisioning"></a>Какие приложения и системы можно использовать с автоматической подготовкой пользователей Azure AD

Azure AD предлагает предварительно интегрированную поддержку множества популярных приложений SaaS и систем управления кадрами, а также универсальную поддержку приложений, которые реализуют определенные части стандарта SCIM 2.0.

### <a name="pre-integrated-applications"></a>Предварительно интегрированные приложения
Перечень всех приложений, для которых Azure AD поддерживает предварительно интегрированный соединитель подготовки, приведен в [списке руководств по приложениям для подготовки пользователей](saas-apps/tutorial-list.md).

Для того чтобы связаться с командой инженеров Azure AD для обеспечения подготовки в других приложениях, отправьте сообщение через [форум отзывов Azure Active Directory](https://feedback.azure.com/forums/374982-azure-active-directory-application-requests/filters/new?category_id=172035).

> [!NOTE]
> Чтобы приложение поддерживало автоматическую подготовку пользователей, сначала оно должно предоставить необходимые API управления пользователями, которые позволят внешним программам автоматизировать создание, обслуживание и удаление пользователей. Таким образом не все приложения SaaS совместимы с этой функцией. Для приложений, поддерживающих интерфейсы API для управления пользователями, команда инженеров Azure AD сможет собрать соединитель подготовки для этих приложений. Приоритет для этой работы устанавливается в соответствии с требованиями текущих и потенциальных заказчиков. 

### <a name="connecting-applications-that-support-scim-20"></a>Подключение приложений с поддержкой SCIM 2.0
Общие инструкции по подключению приложений, которые реализуют API управления пользователями на основе SCIM 2.0, см. в статье [Использование SCIM для автоматической подготовки пользователей и групп Azure Active Directory для приложений](manage-apps/use-scim-to-provision-users-and-groups.md).

    
## <a name="how-do-i-set-up-automatic-provisioning-to-an-application"></a>Как настроить автоматический вход в приложение

> [!VIDEO https://www.youtube.com/embed/pKzyts6kfrw]

Настройка службы подготовки Azure AD для выбранного приложения начинается на **[портале Azure](https://portal.azure.com)**. В разделе **Azure Active Directory > Корпоративные приложения** выберите **Добавить**, а затем **Все** и добавьте одно из следующих в зависимости от вашего сценария:

* Все приложения в разделе **Популярные приложения** поддерживают автоматическую подготовку. Дополнительные приложения см. в [списке руководств по приложениям для подготовки пользователей](saas-apps/tutorial-list.md).

* Используйте параметр "Приложение не из коллекции" для специально разработанных интеграций SCIM.

![Коллекция](./media/active-directory-saas-app-provisioning/gallery.png)

На экране управления приложениями настройка выполняется на вкладке **Подготовка**.

![Параметры](./media/active-directory-saas-app-provisioning/provisioning_settings0.PNG)


* **Учетные данные администратора** нужно указать в службе подготовки Azure AD, которая позволит подключаться к API управления пользователями, предоставляемому приложением. В этом разделе также описывается включение уведомлений по электронной почте, отправляемых в случае ошибки учетных данных или перемещения задания подготовки в [карантин](#quarantine).

* Можно настроить**сопоставления атрибутов**, которые определяют, какие поля в исходной системе (например, Azure AD) будут синхронизированы с соответствующими полями в целевой системе (например, ServiceNow). Если целевое приложение поддерживает его, этот раздел позволит дополнительно настроить подготовку групп в дополнение к учетным записям пользователей. "Сопоставление свойств" позволяет выбрать, какие поля используются для сопоставления учетных записей между этими системами. [Выражения](active-directory-saas-writing-expressions-for-attribute-mappings.md) позволяют изменять и преобразовывать значения, полученные из исходной системы, до того как они будут записаны в целевую систему. Дополнительные сведения см. в статье [Настройка сопоставлений атрибутов для подготовки пользователей для приложений SaaS в Azure Active Directory](active-directory-saas-customizing-attribute-mappings.md).

![Параметры](./media/active-directory-saas-app-provisioning/provisioning_settings1.PNG)

* **Фильтры области** сообщают службе подготовки, какие пользователи и группы в исходной системе должны быть подготовлены и/или отозваны в целевой системе. Есть два аспекта для фильтров области, которые оцениваются вместе и определяют, кто находится в области для подготовки:

    * **Filter on attribute values** (Фильтровать по значениям атрибутов) — меню "Область исходного объекта" в сопоставлениях атрибутов позволяет фильтровать определенные значения атрибутов. Например, вы можете указать, что в области подготовки должны быть только пользователи с атрибутом отдела "Продажи". Дополнительные сведения см. в разделе [Подготовка приложений на основе атрибутов с использованием фильтров области](active-directory-saas-scoping-filters.md).

    * **Filter on assignments** (Фильтровать по назначениям) — меню "Область" в разделе "Подготовка > Параметры" портала позволяет указать, должны ли быть подготовлены только "назначенные" пользователи и группы или все пользователи в каталоге Azure AD. Дополнительные сведения см. в статье [Назначение пользователя или группы корпоративному приложению в Azure Active Directory](manage-apps/assign-user-or-group-access-portal.md).
    
* **Параметры** управляют работой службы подготовки приложений, в том числе запущенных.

* **Журналы аудита** предоставляют записи каждой операции, выполненной службой подготовки Azure AD. Дополнительные сведения см. в статье [Руководство по отчетам об автоматической подготовке учетных записей пользователей](active-directory-saas-provisioning-reporting.md).

![Параметры](./media/active-directory-saas-app-provisioning/audit_logs.PNG)

> [!NOTE]
> Для настройки службы подготовки пользователей Azure AD и управления ею можно также использовать [API Microsoft Graph](https://developer.microsoft.com/graph/docs/api-reference/beta/resources/synchronization-overview).


## <a name="what-happens-during-provisioning"></a>Что происходит при подготовке

Когда исходной системой является Azure AD, служба подготовки использует [функцию разностных запросов API Graph Azure AD](https://msdn.microsoft.com/Library/Azure/Ad/Graph/howto/azure-ad-graph-api-differential-query) для отслеживания пользователей и групп. Служба подготовки выполняет начальную синхронизацию исходной и целевой систем, после чего осуществляет периодическую добавочную синхронизацию. 

### <a name="initial-sync"></a>начальная синхронизация
При запуске служба подготовки выполняет самую первую синхронизацию и осуществляет следующие действия:

1. Запрашивает всех пользователей и все группы из исходной системы, получая все атрибуты, определенные в [сопоставлениях атрибутов](active-directory-saas-customizing-attribute-mappings.md).
2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](manage-apps/assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](active-directory-saas-scoping-filters.md).
3. При обнаружении пользователя для назначения или пользователя в области для подготовки служба запрашивает у целевой системы соответствующего пользователя с помощью указанных [совпадающих атрибутов](active-directory-saas-customizing-attribute-mappings.md#understanding-attribute-mapping-properties). Пример. Если имя userPrincipal в исходной системе является совпадающим атрибутом и соответствует атрибуту userName в целевой системе, то служба подготовки запрашивает у целевой системы атрибуты userName, которые соответствуют значениям имени userPrincipal в исходной системе.
4. Если соответствующий пользователь в целевой системе не найден, он создается с использованием атрибутов, возвращенных из исходной системы.
5. Если соответствующий пользователь найден, он обновляется с помощью атрибутов, предоставляемых исходной системой.
6. Если сопоставления атрибутов содержат "ссылочные" атрибуты, то служба выполняет дополнительные обновления в целевой системе, чтобы создать и привязать указанные в ссылках объекты. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.
7. Сохраняет водяной знак в конце начальной синхронизации, который обеспечивает начальную точку для последующих добавочных синхронизаций.

Некоторые приложения, такие как ServiceNow, Google Apps и Box, подготавливают не только пользователей, но и группы и их участников. В таких случаях, если подготовка групп включена в [сопоставления](active-directory-saas-customizing-attribute-mappings.md), то служба подготовки синхронизирует пользователей и группы, а затем синхронизирует членство в группах. 

### <a name="incremental-syncs"></a>Добавочная синхронизация
Каждая последующая операция синхронизации, осуществляемая после начальной синхронизации, выполняет следующие действия.

1. Запрашивает у исходной системы всех пользователей и все группы, которые были обновлены с момента сохранения последнего водяного знака.
2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](manage-apps/assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](active-directory-saas-scoping-filters.md).
3. При обнаружении пользователя для назначения или пользователя в области для подготовки служба запрашивает у целевой системы соответствующего пользователя с помощью указанных [совпадающих атрибутов](active-directory-saas-customizing-attribute-mappings.md#understanding-attribute-mapping-properties).
4. Если соответствующий пользователь в целевой системе не найден, он создается с использованием атрибутов, возвращенных из исходной системы.
5. Если соответствующий пользователь найден, он обновляется с помощью атрибутов, предоставляемых исходной системой.
6. Если сопоставления атрибутов содержат "ссылочные" атрибуты, то служба выполняет дополнительные обновления в целевой системе, чтобы создать и привязать указанные в ссылках объекты. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.
7. Если пользователь, который ранее был в области для подготовки, удаляется из нее (включая отмену назначения), то служба отключает этого пользователя в целевой системе при обновлении.
8. Если пользователь, который ранее был в области для подготовки, отключается или обратимо удаляется в исходной системе, то служба отключает этого пользователя в целевой системе при обновлении.
9. Если пользователь, который ранее был в области для подготовки, необратимо удаляется в исходной системе, то служба удаляет этого пользователя в целевой системе. В Azure AD пользователи необратимо удаляются через 30 дней после обратимого удаления.
10. Сохраняет новый водяной знак в конце добавочной синхронизации, который обеспечивает начальную точку для последующих добавочных синхронизаций.

>[!NOTE]
> Можно также отключить операции создания, обновления или удаления с помощью флажков **Действия с целевыми объектами** в разделе [Сопоставления атрибутов](active-directory-saas-customizing-attribute-mappings.md). Логикой отключения пользователей во время обновления также управляет сопоставление атрибутов из поля, например accountEnabled.

Служба подготовки будет выполнять полную добавочную синхронизацию неопределенно долгое время через интервалы, определенные в [отдельном руководстве по каждому приложению](saas-apps/tutorial-list.md), пока не произойдет одно из следующих событий.

* Служба останавливается вручную с помощью портала Azure или соответствующей команды API Graph. 
* Активируется новая начальная синхронизации с помощью параметра **Clear state and restart** (Очистить состояние и перезапустить) на портале Azure или с помощью соответствующей команды API Graph. При этом удаляются все сохраненные водяные знаки, а все исходные объекты должны быть оценены повторно.
* Из-за изменений сопоставлений атрибутов или фильтров области активируется новая начальная синхронизация. При этом также удаляются все сохраненные водяные знаки, а все исходные объекты должны быть оценены повторно.
* Процесс подготовки переходит в карантин (см. ниже) из-за высокой частоты ошибок и остается в карантине более четырех недель. В этом случае служба будет автоматически отключена.

### <a name="errors-and-retries"></a>Ошибки и повторные попытки 
Если отдельного пользователя в целевой системе не удается добавить, обновить или удалить из-за ошибки в этой системе, то данная операция будет повторена при следующем цикле синхронизации. Если операция с пользователем продолжает завершаться сбоем, то повторные попытки будут выполняться с меньшей частотой вплоть до одной попытки в день. Чтобы устранить ошибку, администраторы должны будут проверить [журналы аудита](active-directory-saas-provisioning-reporting.md) на наличие событий "дополнительной обработки", чтобы определить первопричину и предпринять соответствующие действия. Ниже перечислены распространенные ошибки.

* Не заполнен атрибут пользователей в исходной системе, требуемый в целевой системе.
* У пользователей в исходной системе имеется значение атрибута, для которого в целевой системе установлено уникальное ограничение, и это же значение присутствует в другой записи пользователя.

Эти ошибки можно устранить, настроив значения атрибутов для затронутого пользователя в исходной системе или настроив сопоставления атрибутов таким образом, чтобы не возникали конфликты.   

### <a name="quarantine"></a>Карантин
Если большинство или все вызовы к целевой системе последовательно завершаются сбоем из-за ошибки (например, в случае недопустимых учетных данных администратора), то задание подготовки переходит в "карантин". Об этом сообщается в [сводном отчете о подготовке](active-directory-saas-provisioning-reporting.md) и по электронной почте, если на портале Azure были настроены уведомления по электронной почте. 

После перехода в карантин частота добавочной синхронизации постепенно уменьшается до одного раза в день. 

Задание подготовки будет удалено из карантина после исправления всех связанных с помещением в карантин ошибок, после чего начнется следующий цикл синхронизации. Если задания подготовки остается в карантине более четырех недель, оно отключается.


## <a name="how-long-will-it-take-to-provision-users"></a>Сколько времени занимает подготовка пользователей?

Производительность зависит от того, выполняет ли задание подготовки начальную или добавочную синхронизацию, как описано в предыдущем разделе.

Для **начальной синхронизации** длительность выполнения задания зависит от многих факторов, включая количество пользователей и групп, которые будут подготавливаться, и общее количество пользователей и групп в исходной системе. Полный список факторов, влияющих на производительность начальной синхронизации, кратко описан далее в этом разделе.

Для **добавочной синхронизации** длительность задания зависит от количества изменений, обнаруженных в данном цикле синхронизации. Если обнаружено менее 5000 изменений пользователей или членства в группах, задание может завершиться в течение одного цикла добавочной синхронизации. 

В следующей таблице перечислены данные о времени синхронизации, необходимом для общих сценариев подготовки. В этих сценариях исходной системой является Azure AD, а целевой — приложение SaaS. Указанное время основано на статистическом анализе заданий синхронизации для приложений SaaS ServiceNow, Workplace, Salesforce и Google Apps.


| Конфигурация области | Пользователи, группы и участники в области | Длительность начальной синхронизации | Длительность добавочной синхронизации |
| -------- | -------- | -------- | -------- |
| Синхронизация только назначенных пользователей и групп |  < 1000 |  < 30 минут | < 30 минут |
| Синхронизация только назначенных пользователей и групп |  1000–10 000 | 142–708 минут | < 30 минут |
| Синхронизация только назначенных пользователей и групп |   10 000–100 000 | 1170–2,340 минут | < 30 минут |
| Синхронизация всех пользователей и групп в Azure AD |  < 1000 | < 30 минут  | < 30 минут |
| Синхронизация всех пользователей и групп в Azure AD |  1000–10 000 | 30–120 минут | < 30 минут |
| Синхронизация всех пользователей и групп в Azure AD |  10 000–100 000  | 713–1425 минут | < 30 минут |
| Синхронизация всех пользователей в Azure AD|  < 1000  | < 30 минут | < 30 минут |
| Синхронизация всех пользователей в Azure AD | 1000–10 000  | 43–86 минут | < 30 минут |


Для конфигурации **синхронизации только назначенных пользователей и групп** можно использовать следующие формулы, чтобы определить приблизительную минимальную и максимальную длительность **начальной синхронизации**:

    Minimum minutes =  0.01 x [Number of assigned users, groups, and group members]
    Maximum minutes = 0.08 x [Number of assigned users, groups, and group members] 
    
Сведения о факторах, влияющих на время, необходимое для завершения **начальной синхронизации**:

* Общее количество пользователей и групп, которые будут подготовлены.

* Общее количество пользователей, групп и участников группы, находящихся в исходной системе (Azure AD).

* Тот фактор, сопоставлены ли пользователи в области для подготовки с имеющимися пользователями в целевом приложении или их необходимо создать. Задания синхронизации, для которых все пользователи создаются в первый раз, выполняются *в два раза дольше*, чем те, в которых все пользователи сопоставлены с имеющимися пользователями.

* Количество ошибок в [журналах аудита](active-directory-saas-provisioning-reporting.md). Производительность также снижается, если возникает большое количество ошибок и служба подготовки перешла в состояние карантина.   

* Ограничения частоты и регулирования запросов, реализованные целевой системой. Некоторые целевые системы реализуют ограничения частоты и регулирования запросов. Они могут повлиять на производительность во время больших операций синхронизации. В этих условиях приложение, получающее слишком много запросов за короткий промежуток времени, может снизить частоту реагирования или закрыть подключение. Чтобы повысить производительность, соединитель необходимо настроить таким образом, чтобы количество отправляемых запросов соответствовало количеству запросов, которые может обработать приложение. Соединители подготовки, созданные корпорацией Майкрософт, позволяют внести эту корректировку. 

* Количество и размеры назначенных групп. Синхронизация назначенных групп длится дольше, чем синхронизация пользователей. Число и размер назначенных групп оказывают влияние на производительность. Если в приложении [включена функция сопоставления для синхронизации объектов группы](active-directory-saas-customizing-attribute-mappings.md#editing-group-attribute-mappings), свойства группы (например, названия групп и членства) синхронизируются в дополнение к пользователям. Эти дополнительные синхронизации занимают больше времени, чем синхронизация только объектов пользователей.


##<a name="how-can-i-tell-if-users-are-being-provisioned-properly"></a>Как узнать, правильно ли подготовлены пользователи?

Все операции, которые выполняет служба подготовки пользователей, записываются в журналы аудита Azure AD. Это касается всех операций чтения и записи, которые выполняются в исходной и целевой системах, а также сведений о том, какие данные пользователей считаны или записаны во время каждой из этих операций.

Сведения о чтении журналов аудита на портале Azure см. в [руководстве по отчетам об автоматической подготовке учетных записей пользователей](active-directory-saas-provisioning-reporting.md).


##<a name="how-do-i-troubleshoot-issues-with-user-provisioning"></a>Как устранить неполадки, связанные с подготовкой пользователей?

Руководство по устранению неполадок при автоматической подготовке пользователей со сценариями доступно в разделе [Проблемы при настройке и подготовке пользователей для приложения](active-directory-application-provisioning-content-map.md).


##<a name="what-are-the-best-practices-for-rolling-out-automatic-user-provisioning"></a>Каковы рекомендации по развертыванию автоматической подготовки пользователей?

> [!VIDEO https://www.youtube.com/embed/MAy8s5WSe3A]

Пример поэтапного плана развертывания "исходящей" подготовки пользователей в приложении см. в документе [Outbound User Provisioning Deployment Plan](https://aka.ms/userprovisioningdeploymentplan) (План развертывания "исходящей" подготовки пользователей).


## <a name="related-articles"></a>Связанные статьи
* [Список учебников по интеграции приложений SaaS](saas-apps/tutorial-list.md)
* [Настройка сопоставления атрибутов для подготовки пользователей](active-directory-saas-customizing-attribute-mappings.md)
* [Запись выражений для сопоставления атрибутов](active-directory-saas-writing-expressions-for-attribute-mappings.md)
* [Фильтры области для подготовки пользователей](active-directory-saas-scoping-filters.md)
* [Автоматическая подготовка пользователей и групп из Azure Active Directory в приложениях с использованием SCIM](manage-apps/use-scim-to-provision-users-and-groups.md)
* [Общие сведения об API синхронизации Azure AD](https://developer.microsoft.com/graph/docs/api-reference/beta/resources/synchronization-overview)
