---
title: Синхронизация учетных записей гостевых пользователей, использующих электронную почту для входа в Azure | Документация Майкрософт
description: В этой статье описаны способы синхронизации учетных записей гостевых пользователей, использующих альтернативный идентификатор для входа в приложения.
services: active-directory
author: billmath
manager: mtillman
ms.service: active-directory
ms.workload: identity
ms.topic: article
ms.date: 04/19/2018
ms.author: billmath
ms.openlocfilehash: 4e6cf3bb4a691380a5fe22f5afdf749b40f15ef3
ms.sourcegitcommit: 96089449d17548263691d40e4f1e8f9557561197
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/17/2018
---
# <a name="synchronizing-guest-user-accounts-that-use-email-for-sign-in-preview"></a>Синхронизация учетных записей гостевых пользователей, использующих электронную почту для входа в систему (предварительная версия)

>[!NOTE]
> Эта функция сейчас доступна в виде общедоступной предварительной версии.

В следующем сценарии рассматривается ситуация, в которой в вашей локальной среде AD могут быть внешние пользователи, например партнеры, использующие альтернативный метод входа.

В приведенном выше примере Нина Морин работает для компании Fabrikam, и у нее следующий адрес электронной почты: nmorin@fabrikam.com. Нина — партнер Contoso, и ей необходим доступ к определенным приложениям, которые есть у этой компании. Компания Contoso создала учетную запись для Нины и дала ей указание использовать свой адрес электронной почты для входа в приложения.

Для локальных приложений этот сценарий работает отлично. Но теперь Contoso перемещает эти приложения в облако и хочет, чтобы партнеры сделали то же самое.

В этом сценарии показано решение для данной ситуации.


## <a name="pre-requisites-and-assumptions"></a>Предварительные требования и предположения
Этот раздел содержит список предварительных требований и предположений, которые необходимо учесть, прежде чем настраивать этот сценарий.

### <a name="pre-requisites"></a>Предварительные требования
- Учетные данные глобального администратора для настройки Azure AD Connect, проверки доменов и настройки параметров федерации доменов.
- Azure AD Connect версии 1.1.524.0 или более поздней.
- Проверенный домен для настройки облачного имени участника-пользователя внешних пользователей (например, bmcontoso.com).
- Служба федерации для проверки подлинности внешних пользователей. Если вы используете службы федерации Active Directory, их версия должна быть 2012 R2 или более поздняя.
- MSOL PowerShell версии 1.1 должен быть установлен на компьютере, чтобы проверить параметры федерации. Дополнительные сведения см. в статье [Azure ActiveDirectory (MSOnline)](https://docs.microsoft.com/powershell/azure/active-directory/overview?view=azureadps-1.0).


### <a name="assumptions"></a>Предположения 
- Azure AD Connect уже настроен и успешно установлен. Сведения о том, как установить Azure AD Connect, см. в статье [Azure AD Connect и федерация](active-directory-aadconnectfed-whatis.md).
Для работы с этим документом предполагается следующее:
- служба федерации настроена и успешно выполняет проверку подлинности пользователей;
- внешние пользователи могут проходить проверку подлинности с использованием своего внешнего адреса электронной почты.
- - Должен быть настроен метод использования альтернативного идентификатора для входа в систему. Пользователи могут проходить проверку подлинности с использованием их альтернативного идентификатора. Дополнительные сведения о настройке альтернативного идентификатора с AD FS см. в [этой статье](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/configuring-alternate-login-id).

## <a name="task-1--prepare-the-environment"></a>Задача 1. Подготовка среды
Следующая задача подразумевает ввод сведений. Выполнив ее, вы сможете начать синхронизацию внешних учетных записей, чтобы они выполняли вход с использованием альтернативного идентификатора, такого как атрибут mail.

Определите элементы в таблице ниже, прежде чем перейти ко второй задаче.

![Архитектура](media/active-directory-aadconnect-guest-sync/guest2.png)

|Аспект окружения|Для чего он используется?|Реализация в вашей среде|
|-----|-----|-----|
|Атрибут облачного имени участника-пользователя|Атрибут, который заполняет имя участника-пользователя внешних объектов пользователей в облаке. Суффикс имени участника-пользователя для внешних учетных записей должен совпадать с определенным в предварительных требованиях. Это проверенный домен.|* Например, UserPrincipalName (nmorin@bmcontoso.com)|
|Адрес для входа|Атрибут, который внешние пользователи будут вводить при входе в систему. Этот атрибут должен иметь формат адреса электронной почты, и в большинстве случаев он совпадает с фактическим адресом электронной почты внешнего пользователя.|* Например, mail (nmorin@fabrikam.com)|
|Фильтр Azure AD Connect с определенной областью|Фильтр, который позволяет найти внешние удостоверения для определения области действия правил синхронизации, указанных далее в этом руководстве. Обычные способы ограничения включают в себя: предварительно определенные подразделения в организации, определенные соглашения об именовании, определенный домен и т. д.|* Например, подразделение содержит слово "Внешние"|
|Клиент Azure AD|Имя клиента Azure AD, как оно отображается в Azure AD Connect.|Например, contoso.onmicrosoft.com.|

На следующем снимке экрана выделено три строки.
- Подразделение со словом **Внешние**, которое используется в фильтре Azure AD Connect с заданной областью и является расположением внешних пользователей.
- Атрибут **mail**, который используется внешними пользователями для входа в систему.
- Атрибут **userPrincipalName**, который является проверенным доменом, включенным в федерацию вместе с локальной средой.

![Пользователь](media/active-directory-aadconnect-guest-sync/guest1.png)

## <a name="task-2--configure-azure-ad-connect"></a>Задача 2. Настройка Azure AD Connect
Если приведенные выше сведения определены, можно перейти к настройке правил синхронизации Azure AD Connect. Чтобы задать правила, используйте редактор правил синхронизации Azure AD Connect. Дополнительные сведения о редакторе см. в статье [Служба синхронизации Azure AD Connect: общие сведения о декларативной подготовке](active-directory-aadconnectsync-understanding-declarative-provisioning.md).

### <a name="how-to-configure-the-synchronization-rule"></a>Настройка правила синхронизации
Ниже описаны действия по настройке Azure AD Connect.

1. Откройте редактор правил синхронизации Azure AD Connect, щелкнув **Пуск — Azure AD Connect — Synchronization rules editor (Редактор правил синхронизации)**.
2. На экране **Synchronization rules editor** (Редактор правил синхронизации) убедитесь, что установлено направление **входящее** и в правой части щелкните **Добавить новое правило**.
3. На странице **Описание** задайте следующие параметры и нажмите кнопку **Далее**.
    - **Имя** — введите имя правила. 
    - **Connected System** (Подключенная система) — локальная среда AD.
    - **Connected System Object Type** (Тип объекта подключенной системы) — пользователь.
    - **Metaverse Object Type** (Тип объекта метавселенной) — человек.
    - **Link Type** (Тип связи) — объединение.
    - **Приоритет** — 90.
    - 
![](media/active-directory-aadconnect-guest-sync/guest3.png)

4. На экране **Scoping Filter** (Фильтр области действия) щелкните **Добавить группу**.
5. Используйте раскрывающиеся списки для настройки фильтра. Введите следующую команду и нажмите кнопку **Далее**. В результате этого будет создан фильтр, который применяется только к объектам, находящимся во внешнем подразделении.
    - **атрибут** — dn;
    - **оператор** — CONTAINS;
    - **значение** — внешние.
 
 ![Фильтр](media/active-directory-aadconnect-guest-sync/guest4.png)

6. На экране **Join Rules** (Правила объединения) нажмите кнопку **Далее**.
7. На экране **Преобразования** щелкните **Add Transformation** (Добавить преобразование). Введите следующие сведения:
    - **FlowType** — константа;
    - **целевой атрибут** — userType;
    - **источник** — гость.
8. На экране **Преобразования** щелкните **Add Transformation** (Добавить преобразование). Введите следующие сведения:
    - **тип потока** — прямой;
    - **целевой атрибут** — onPremisesUserPrincipalName;
    - **источник** — почта.
9. На экране **Преобразования** щелкните **Add Transformation** (Добавить преобразование). Введите следующие сведения:
    - **тип потока** — прямой;
    - **целевой атрибут** — userPrincipalName;
    - **источник** — userPrincipalName. ![Преобразование](media/active-directory-aadconnect-guest-sync/guest5.png)
10. Щелкните **Добавить**. 
11. На экране **Synchronization rules editor** (Редактор правил синхронизации) убедитесь, что установлено направление **исходящее** и в правой части щелкните **Добавить новое правило**.
12. На странице **Описание** настройте следующие параметры и нажмите кнопку **Далее**.
    - **Имя** — введите имя правила. 
    - **Connected System** (Подключенная система) — клиент Azure AD.
    - **Connected System Object Type** (Тип объекта подключенной системы) — пользователь.
    - **Metaverse Object Type** (Тип объекта метавселенной) — человек.
    - **Link Type** (Тип связи) — объединение.
    - **Приоритет** — 90.
    - 
![правило;](media/active-directory-aadconnect-guest-sync/guest6.png)

13. На экране **Scoping Filter** (Фильтр области действия) нажмите кнопку **Далее**.
14. На экране **Join Rules** (Правила объединения) нажмите кнопку **Далее**.
15. На экране **Преобразования** щелкните **Add Transformation** (Добавить преобразование).  Введите следующие сведения:
    - **тип потока** — прямой;
    - **целевой атрибут** — userType;
    - **источник** — userType.
9. На экране **Преобразования** щелкните **Add Transformation** (Добавить преобразование). Введите следующие сведения:
    - **тип потока** — прямой;
    - **целевой атрибут** — onPremisesUserPrincipalName;
    - **источник** — onPremisesUserPrincipalName ![Преобразование](media/active-directory-aadconnect-guest-sync/guest7.png)
10. Щелкните **Добавить**. 
11. После настройки этих правил необходимо выполнить полную синхронизацию. Запустите полную синхронизацию с помощью PowerShell. После завершения синхронизации можно перейти к следующему шагу.

``` powershell
    Start-ADSyncSyncCycle -PolicyType Initial
```

## <a name="task-3--federation"></a>Задание 3. Федерация
Следующая задача подразумевает ввод некоторых сведений, необходимых для работы сценария.

Проверить параметры федерации с Azure можно с помощью Azure AD PowerShell. В этом документе используется MSOL PowerShell версии 1.1. Вы можете установить эту версию [здесь](https://docs.microsoft.com/powershell/azure/active-directory/overview?view=azureadps-1.0).

### <a name="verify-the-federation-settings"></a>Проверка параметров федерации
Ниже описана процедура проверки параметров федерации.
1. Откройте Windows PowerShell и подключитесь к Azure AD, выполнив следующую команду:
``` powershell
      Connect-MSOLservice
```
2.  Введите учетные данные глобального администратора.
3.  Введите следующую команду:
  ``` powershell
      Get-MSOLDomainFederationSettings
  ```
4.   Обратите внимание, что сведения о федерации должны возвратиться. Обратите внимание, что **ActiveLogonUri** — это URL-адрес сервера федерации.

  ![Федерация](media/active-directory-aadconnect-guest-sync/guest8.png)

### <a name="verify-alternate-login-id"></a>Проверка альтернативного идентификатора входа
В этом документе в качестве поставщика удостоверений используется AD FS. При использовании другого поставщика удостоверений эти действия могут отличаться.

1. Откройте Windows PowerShell и введите следующую команду:
   ```powershell
    Get-ADFSClaimsProviderTrust
   ```
2. Должны появиться сведения об AD FS.  Обратите внимание на значения полей **AlternateLoginID** и **LookupForests**.

![ADFS](media/active-directory-aadconnect-guest-sync/guest9.png)

## <a name="task-4--testing"></a>Задача 4. Тестирование
Чтобы проверить, что это работает правильно, необходимо войти в конечную точку, настроенную для проверки подлинности с использованием поставщика удостоверений. Чтобы проверить это, мы развернули веб-сайт в Azure и используем следующий URL-адрес: contososampapp.azurewebsites.net.

### <a name="verify-that-you-can-sign-in-with-the-alternate-id"></a>Проверьте, можете ли вы войти в систему, используя альтернативный идентификатор.
1. Войдите в конечную точку.</br>
![Конечная точка](media/active-directory-aadconnect-guest-sync/guest10.png)
1. Введите свое имя пользователя, и вы снова попадете на страницу входа в службу федерации.
![Федерация](media/active-directory-aadconnect-guest-sync/guest11.png)
1. Введите свои учетные данные.
2. Теперь вы должны без проблем войти в систему.
![Success](media/active-directory-aadconnect-guest-sync/guest12.png)

## <a name="next-steps"></a>Дополнительная информация
- [Основные свойства пользователя службы совместной работы Azure AD B2B](../../active-directory/b2b/user-properties.md#key-properties-of-the-azure-ad-b2b-collaboration-user)
- [Configuring Alternate Login ID](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/configuring-alternate-login-id) (Настройка альтернативного идентификатора входа)
- [Azure AD Connect. История выпусков версий](active-directory-aadconnect-version-history.md)
