---
title: "Реализация синхронизации паролей с помощью синхронизации Azure AD Connect | Документация Майкрософт"
description: "В этой статье объясняется, как работает синхронизация паролей и как ее включить."
services: active-directory
documentationcenter: 
author: MarkusVi
manager: femila
editor: 
ms.assetid: 05f16c3e-9d23-45dc-afca-3d0fa9dbf501
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/21/2017
ms.author: markvi
translationtype: Human Translation
ms.sourcegitcommit: 424d8654a047a28ef6e32b73952cf98d28547f4f
ms.openlocfilehash: 946f135e832667ad6e32743be2b07b4f86cd1cae
ms.lasthandoff: 03/22/2017


---
# <a name="implementing-password-synchronization-with-azure-ad-connect-sync"></a>Реализация синхронизации паролей с помощью службы Azure AD Connect Sync
В этой статье содержатся сведения о том, как синхронизировать пароли пользователей локальной службы Active Directory (AD) и облачной службы Azure Active Directory (Azure AD).

## <a name="what-is-password-synchronization"></a>Что такое синхронизация паролей
Вероятность того, что сделанная работа может быть заблокирована из-за забытого пароля, связана с количеством разных паролей, которые необходимо помнить. Чем больше паролей необходимо помнить, тем выше вероятность забыть один из них. Вопросы и звонки о восстановлении паролей и прочие проблемы, связанные с паролями, забирают больше всего ресурсов службы технической поддержки.

Синхронизация паролей — это функция для синхронизации паролей пользователей локальной службы Active Directory и облачной службы Azure Active Directory (Azure AD).
Эта функция позволяет входить в службы Azure Active Directory (например, Office 365, Microsoft Intune, CRM Online и доменные службы Azure AD) с помощью пароля, используемого для входа в локальную службу Active Directory.

![Что такое Azure AD Connect?](./media/active-directory-aadconnectsync-implement-password-synchronization/arch1.png)

За счет сокращения числа паролей, которые должны помнить пользователи, до одного единственного, синхронизация паролей дает следующие преимущества:

* Повышение производительности пользователей
* Снижение затрат, связанных со службой технической поддержки  

Если выбран параметр [**Федерация с AD FS**](https://channel9.msdn.com/Series/Azure-Active-Directory-Videos-Demos/Configuring-AD-FS-for-user-sign-in-with-Azure-AD-Connect), можно также включить синхронизацию паролей на случай сбоя в инфраструктуре AD FS.

Синхронизация паролей — это расширение функции синхронизации каталогов, реализованное при помощи служб синхронизации Azure AD Connect. Для использования синхронизации паролей в определенной среде необходимо выполнение следующих действий.

* Установка Azure AD Connect  
* Настройка синхронизации служб каталогов между локальной службой AD и Azure Active Directory
* Включение синхронизации паролей

Дополнительные сведения см. в статье [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md).

> [!NOTE]
> Дополнительную информацию о доменных службах Active Directory, настроенных для использования FIPS и синхронизации паролей, см. в разделе [Синхронизация паролей и FIPS](#password-synchronization-and-fips).
>
>

## <a name="how-password-synchronization-works"></a>Как работает синхронизация паролей
Доменная служба Active Directory хранит пароли в виде хэш-значений, которые представляют фактические пароли пользователей. Хэш-значение — это результат односторонней математической функции (*алгоритма хэширования*). Не существует метода для возврата результата односторонней функции в обычную текстовую версию пароля. Хэш пароля не может использоваться для входа в локальную сеть.

Чтобы синхронизировать пароль, Azure AD Connect Sync извлекает хэш пароля из локального каталога Active Directory. Перед синхронизацией в службу проверки подлинности Azure Active Directory хэш пароля дополнительно обрабатывается системой безопасности. Пароли синхронизируются для каждого пользователя отдельно и в хронологическом порядке.

Фактический поток данных в процессе синхронизации паролей аналогичен синхронизации данных пользователей, таких как отображаемые имена или адреса электронной почты. Но синхронизация паролей происходит чаще, чем это обычно делается для других атрибутов. Процесс синхронизации паролей выполняется каждые 2 минуты. Нельзя изменять частоту выполнения этого процесса. При синхронизации пароль перезаписывает существующий в облачной службе.

При первом включении функции синхронизации паролей она выполняет первоначальную синхронизацию паролей всех пользователей в области. Нельзя явно определить подмножество паролей пользователей, которые требуется синхронизировать.

При изменении локального пароля новый пароль, как правило, синхронизируется в течение нескольких минут.
Если синхронизация паролей завершается сбоем, автоматически осуществляется новая попытка. Ошибки, возникающие во время синхронизации паролей, записываются в журнал событий.

Синхронизация пароля не влияет на пользователей, находящихся в системе в момент ее выполнения.
Если изменение пароля синхронизируется во время вашего пребывания в облачной службе, оно не применяется в сеансе облачной службы немедленно. Однако, когда снова возникнет необходимость в проверке подлинности в облачной службе, потребуется указать новый пароль.

Одна из причин заключается в том, что пользователь должен ввести свои корпоративные учетные данные еще раз для аутентификации в Azure AD независимо от того, выполнен ли вход в корпоративную сеть. Однако эту тенденцию можно свести к минимуму, если пользователь установит флажок "Оставаться в системе" при входе в систему. При этом задается файл cookie сеанса, который на некоторое время позволяет обходить аутентификацию. Функции флажка "Оставаться в системе" может включить и отключить администратор Azure Active Directory.

> [!NOTE]
> Синхронизация паролей поддерживается только для типа объектов user в Active Directory. Она не поддерживается для типа объектов iNetOrgPerson.

### <a name="detailed-description-of-how-password-synchronization-works"></a>Подробное описание принципа действия синхронизации паролей
Ниже подробно описан принцип действия синхронизации паролей Active Directory и Azure Active Directory.

![Подробная схема использования паролей](./media/active-directory-aadconnectsync-implement-password-synchronization/arch3.png)


1. Каждые две минуты агент синхронизации паролей на сервере AD Connect запрашивает хэш сохраненных паролей (атрибут unicodePwd) у контроллера домена по стандартному протоколу репликации [MS-DRSR](https://msdn.microsoft.com/library/cc228086.aspx), используемому для синхронизации данных контроллеров доменов. Для получения хэша паролей учетной записи службы требуются разрешения AD "Репликация изменений каталога" и "Репликация всех изменений каталога" (предоставляется по умолчанию при установке).
2. Перед отправкой контроллер домена шифрует хэш пароля MD4 с помощью ключа, который является хэшем [MD5](http://www.rfc-editor.org/rfc/rfc1321.txt) ключа сеанса RPC, и случайных данных. После этого он отправляет результат агенту синхронизации паролей по протоколу RPC. Контроллер домена также передает агенту синхронизации случайные данные по протоколу репликации контроллера домена, чтобы агент смог расшифровать конверт.
3.    Когда агент синхронизации паролей получает зашифрованный конверт, он создает ключ для расшифровки полученных данных в исходный формат MD4 с использованием [MD5CryptoServiceProvider](https://msdn.microsoft.com/library/System.Security.Cryptography.MD5CryptoServiceProvider.aspx) и случайных данных. Агенту синхронизации паролей недоступен пароль в виде открытого текста. Он использует MD5 исключительно для обеспечения совместимости протокола репликации с контроллером домена и только на локальном компьютере между контроллером домена и агентом синхронизации паролей.
4.    Агент синхронизации паролей увеличивает 16-байтовый двоичный хэш пароля до 64 байтов. Сначала он преобразует хэш в 32-байтовую шестнадцатеричную строку, а затем преобразует ее обратно в двоичный файл с кодировкой UTF-16.
5.    Агент синхронизации паролей добавляет 10-байтовые случайные данные к 64-байтовому двоичному файлу, чтобы обеспечить дополнительную защиту исходного хэша.
6.    Затем он объединяет хэш MD4 и случайные данные и вводит то, что получилось, в функцию [PBKDF2](https://www.ietf.org/rfc/rfc2898.txt), используя 1000 итераций хэш-алгоритма с ключом [HMAC-SHA256](https://msdn.microsoft.com/library/system.security.cryptography.hmacsha256.aspx).
Azure AD 
7.    Агент синхронизации паролей принимает полученный 32-байтовый хэш, объединяет случайные данные и SHA256 с определенным числом итераций (для использования Azure AD), а затем передает строку из AD Connect в Azure AD по протоколу SSL.</br> 
8.    Когда пользователь пытается войти в Azure AD и вводит пароль, пароль обрабатывается точно так же (MD4, случайные данные, PBKDF2 и HMAC-SHA256). Если полученный хэш совпадает с хэшем, хранящимся в Azure AD, это означает, что пользователь ввел правильный пароль и он проходит аутентификацию. 

>[!Note] 
>Исходный хэш MD4 не передается в Azure AD. Вместо этого передается хэш SHA256 исходного хэша MD4. В результате при получении хэша, хранимого в Azure AD, его невозможно использовать в локальной атаке Pass-the-Hash.

### <a name="how-password-synchronization-works-with-azure-ad-domain-services"></a>Как синхронизация паролей работает с доменными службами Azure AD
Функцию синхронизации паролей также можно использовать для синхронизации локальных паролей с [доменными службами Azure AD](../../active-directory-domain-services/active-directory-ds-overview.md). Данный сценарий позволяет доменным службам Azure AD проверять подлинность пользователей в облаке, применяя все методы, доступные в локальной службе AD. Действия в этом сценарии аналогичны использованию инструмента миграции Active Directory Migration Tool (ADMT) в локальной среде.

### <a name="security-considerations"></a>Вопросы безопасности
При синхронизации пароли в текстовом формате не передаются в службу синхронизации паролей, Azure AD или какие-либо другие связанные службы.

Пользователь проходит аутентификацию в Azure AD, а не в корпоративной среде Active Directory. Если в вашей организации строго относятся к передаче данных о пароле за ее пределы в любой форме, учтите, что данные пароля SHA256, хранимые в Azure AD (хэш исходного хэша MD4) значительно безопаснее, чем то, что хранится в Active Directory. Кроме того, так как хэш SHA256 невозможно расшифровать, его невозможно вернуть в корпоративную среду Active Directory и представить в качестве действительного пароля пользователя в ходе атаки Pass-the-Hash.





### <a name="password-policy-considerations"></a>Рекомендации по политикам паролей
Есть два типа политик паролей, которые затрагивает синхронизация паролей:

1. Политика сложности паролей.
2. Политика срока действия паролей.

**Password complexity policy**  
При включении синхронизации паролей политики сложности паролей, настроенные в локальном каталоге Active Directory, переопределяют политики сложности, настроенные в облаке для синхронизированных пользователей. Все допустимые пароли из локального Active Directory можно использовать для доступа к службам Azure AD.

> [!NOTE]
> Пароли пользователей, созданные непосредственно в облаке, и впредь регулируются политиками паролей, которые настроены в облаке.

**Password expiration policy**  
Если пароль пользователя синхронизируется, для пароля облачной учетной записи устанавливается*неограниченный срок действия*.

Синхронизированный пароль, срок действия которого в локальной среде истек, можно использовать для входа в облачные службы. Пароль для облачной учетной записи изменяется, когда вы изменяете пароль в локальной среде.

**Срок действия учетной записи.** Если в вашей организация атрибут accountExpires используется для управления учетными записями пользователей, помните, что этот атрибут не синхронизируется с Azure AD. В результате учетная запись AD, срок действия которой истек, в среде, настроенной для синхронизации паролей, будет по-прежнему активной в Azure AD. Если срок действия учетной записи истек, мы рекомендуем внедрить рабочий процесс, который будет активировать сценарий PowerShell, который, в свою очередь, отключает учетную запись пользователя Azure AD. И наоборот, при включении учетной записи должен включаться и Azure AD.

### <a name="overwriting-synchronized-passwords"></a>Перезапись синхронизированных паролей
Администратор может вручную сбросить пароль с помощью Windows PowerShell.

В таком случае новый пароль перезапишет синхронизированный пароль, и к новому паролю будут применены все политики паролей, настроенные в облаке.

Если вы снова измените локальный пароль, новый пароль синхронизируется в облако и перезапишет пароль, измененный вручную.

Синхронизация пароля не влияет на пользователей Azure, находящихся в системе в момент ее выполнения. Если изменение пароля синхронизируется во время вашего пребывания в облачной службе, оно не применяется в сеансе облачной службы немедленно. Благодаря возможности, позволяющей оставаться в системе, эта разница будет заметна и дальше. Когда снова возникнет необходимость в аутентификации в облачной службе, потребуется указать новый пароль.

### <a name="additional-advantages"></a>Дополнительные преимущества

- Как правило, синхронизацию паролей реализовать проще, чем службу федерации. Она не требует дополнительных серверов и устраняет зависимость от высокодоступной службы федерации для аутентификации пользователей. 
- Синхронизацию паролей также можно включить в дополнение к федерации, поэтому ее можно использовать в качестве запасного варианта при сбое службы федерации.












## <a name="enabling-password-synchronization"></a>Включение синхронизации паролей
Если во время установки Azure AD Connect используются **стандартные параметры**, синхронизация паролей включается по умолчанию. Дополнительные сведения см. в статье [Приступая к работе с Azure AD Connect с использованием стандартных параметров](active-directory-aadconnect-get-started-express.md).

Если во время установки Azure AD Connect используются пользовательские параметры, вам нужно включить синхронизацию паролей на странице входа в систему. Дополнительные сведения см. в статье [Выборочная установка Azure AD Connect](active-directory-aadconnect-get-started-custom.md).

![Включение синхронизации паролей](./media/active-directory-aadconnectsync-implement-password-synchronization/usersignin.png)

### <a name="password-synchronization-and-fips"></a>Синхронизация паролей и FIPS
Если сервер заблокирован в соответствии с федеральным стандартом обработки информации (FIPS), схема MD5 отключена.

**Чтобы включить MD5 для синхронизации паролей выполните следующие действия.**

1. Перейдите к папке **%programfiles%\Azure AD Sync\Bin**.
2. Откройте файл **miiserver.exe.config**.
3. Перейдите на узел **конфигурации или среды выполнения** (в конце файла конфигурации).
4. Добавьте следующий узел: `<enforceFIPSPolicy enabled="false"/>`
5. Сохраните изменения.

Этот фрагмент должен выглядеть следующим образом.

```
    <configuration>
        <runtime>
            <enforceFIPSPolicy enabled="false"/>
        </runtime>
    </configuration>
```

Дополнительные сведения о безопасности и FIPS см. в записи блога [AAD Password Sync, Encryption and FIPS compliance](https://blogs.technet.microsoft.com/enterprisemobility/2014/06/28/aad-password-sync-encryption-and-fips-compliance/) (Синхронизация паролей, шифрование и соответствие FIPS в AAD).

## <a name="troubleshooting-password-synchronization"></a>Устранение неполадок синхронизации паролей
При возникновении проблем с синхронизацией паролей см. статью [Устранение неполадок синхронизации паролей с помощью службы синхронизации Azure AD Connect](active-directory-aadconnectsync-troubleshoot-password-synchronization.md).

## <a name="next-steps"></a>Дальнейшие действия
* [Azure AD Connect Sync: настройка параметров синхронизации](active-directory-aadconnectsync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md)

