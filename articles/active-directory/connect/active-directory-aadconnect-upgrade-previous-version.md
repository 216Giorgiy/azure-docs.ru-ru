---
title: "Azure AD Connect: обновление до последней версии | Документация Майкрософт"
description: "В этой статье описаны различные способы обновления Azure Active Directory Connect до последней версии, включая обновление на месте и обновление со сменой сервера."
services: active-directory
documentationcenter: 
author: AndKjell
manager: femila
editor: 
ms.assetid: 31f084d8-2b89-478c-9079-76cf92e6618f
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: Identity
ms.date: 02/08/2017
ms.author: billmath
translationtype: Human Translation
ms.sourcegitcommit: b6ec60f9e15e459f70127448eb7d9c03e4b118e8
ms.openlocfilehash: 3bd1ca8e0bb9f17b76dda68a6cb2f9f64a5d05dd
ms.lasthandoff: 02/23/2017


---
# <a name="azure-ad-connect-upgrade-from-a-previous-version-to-the-latest"></a>Azure AD Connect: обновление до последней версии
В этой статье описываются различные варианты обновления установленного экземпляра Azure Active Directory (Azure AD) Connect до последней версии. Мы рекомендуем устанавливать все новые выпуски Azure AD Connect. Действия, описанные в разделе [Обновление со сменой сервера](#swing-migration), можно также использовать при значительных изменениях конфигурации.

Инструкции по обновлению DirSync см. в статье [Azure AD Connect: обновление DirSync](active-directory-aadconnect-dirsync-upgrade-get-started.md).

Существует несколько различных стратегий обновления Azure AD Connect.

| Метод | Описание |
| --- | --- |
| [Автоматическое обновление](active-directory-aadconnect-feature-automatic-upgrade.md) |Самый простой вариант — для клиентов с экспресс-установкой. |
| [Обновление «на месте»](#in-place-upgrade) |Если у вас один сервер, то установку можно обновить "на месте". |
| [Обновление со сменой сервера](#swing-migration) |Если серверов два, то можно установить новый выпуск или конфигурацию на один из них, а затем сменить активный сервер. |

Сведения о разрешениях см. в разделе [Azure AD Connect: учетные записи и разрешения](active-directory-aadconnect-accounts-permissions.md#upgrade).

> [!NOTE]
> После включения нового сервера Azure AD Connect для запуска синхронизации изменений в Azure AD откат к использованию DirSync или Azure AD Sync уже невозможен. Обратный переход с Azure AD Connect к устаревшим клиентам, включая DirSync и Azure AD Sync, не поддерживается и может привести к таким проблемам, как потеря данных в Azure AD.

## <a name="in-place-upgrade"></a>Обновление «на месте»
Обновление на месте подходит для обновления Azure AD Sync или Azure AD Connect. Оно не подойдет для перехода с DirSync или для решения на основе Forefront Identity Manager (FIM) и соединителя Azure AD.

Мы советуем использовать этот вариант, если у вас есть один сервер и меньше 100 000 объектов. Если в стандартных правилах синхронизации есть какие-либо изменения, после обновления выполняется полный импорт и полная синхронизация. Это гарантирует, что новая конфигурация будет применена ко всем существующим в системе объектам. Импорт и синхронизация могут занять несколько часов в зависимости от числа объектов в области действия модуля синхронизации. Обычная синхронизация изменений, по умолчанию выполняемая каждые 30 минут, приостанавливается, но синхронизация паролей продолжает выполняться. Обновление "на месте" лучше всего проводить в выходные дни. Если в новом выпуске Azure AD Connect не изменены стандартные правила синхронизации, то начнется обычная процедура импорта или синхронизации изменений.  
![Обновление «на месте»](./media/active-directory-aadconnect-upgrade-previous-version/inplaceupgrade.png)

Если вы внесли изменения в стандартные правила синхронизации, при обновлении они будут возвращены к конфигурации по умолчанию. Чтобы после обновления конфигурация сохранялась, внесите изменения, как указано в статье [Службы синхронизации Azure AD Connect: рекомендации по изменению конфигурации по умолчанию](active-directory-aadconnectsync-best-practices-changing-default-configuration.md).

## <a name="swing-migration"></a>Обновление со сменой сервера
При наличии сложного развертывания или большого числа объектов обновление системы "на месте" будет нецелесообразно. У некоторых клиентов оно может занять несколько дней, в течение которых никакие изменения синхронизироваться не будут. Этот метод также можно использовать, если планируется значительно изменить конфигурацию и нужно проверить ее перед отправкой в облако.

В подобных случаях мы рекомендуем обновление со сменой сервера. Вам потребуется по крайней мере два сервера — активный и промежуточный. Активный сервер (обозначен сплошными синими линиями на приведенном ниже рисунке) отвечает за активные рабочие нагрузки. Промежуточный сервер (обозначен пунктирными фиолетовыми линиями) подготавливается с использованием нового выпуска или конфигурации. После завершения подготовки к использованию он становится активным сервером. Сервер, который раньше был активным и на котором теперь установлена старая версия или конфигурация, становится промежуточным и обновляется.

На двух серверах могут использоваться разные версии. Например, активный сервер, который вы планируете перестать использовать, может использовать Azure AD Sync, а новый промежуточный сервер — Azure AD Connect. Если для развертывания новой конфигурации используется обновление со сменой сервера, мы рекомендуем устанавливать одинаковые версии на двух серверах.  
![Промежуточный сервер.](./media/active-directory-aadconnect-upgrade-previous-version/stagingserver1.png)

> [!NOTE]
> Некоторые клиенты предпочитают использовать для этого сценария три или четыре сервера. Когда промежуточный сервер обновляется, он не может служить резервным сервером для [аварийного восстановления](active-directory-aadconnectsync-operations.md#disaster-recovery). При наличии трех или четырех серверов можно установить новую версию на одной паре основного и резервного серверов. Это обеспечит постоянную доступность промежуточного сервера.

Эти действия подходят также для обновления Azure AD Sync или решения на основе FIM и соединителя Azure AD. Они не подходят для DirSync. Метод обновления со сменой сервера (также называемый параллельным развертыванием) для DirSync описывается в статье [Azure AD Connect: обновление DirSync](active-directory-aadconnect-dirsync-upgrade-get-started.md).

### <a name="use-a-swing-migration-to-upgrade"></a>Использование обновления со сменой сервера
1. Если вы используете Azure AD Connect на обоих серверах и хотите только изменить конфигурацию, убедитесь, что на активном и промежуточном серверах установлена одна и та же версия. Это упростит сравнение различий позже. При обновлении Azure AD Sync эти серверы имеют разные версии. При обновлении более ранней версии Azure AD Connect удобно использовать одинаковую версию на обоих серверах, но это необязательно.
2. Если вы внесли изменения в конфигурацию на активном сервере, а на промежуточном они отсутствуют, выполните инструкции в разделе [Перенос пользовательской конфигурации с активного на промежуточный сервер](#move-custom-configuration-from-active-to-staging-server).
3. При обновлении более ранней версии Azure AD Connect обновите промежуточный сервер до последней версии. При перемещении из Azure AD Sync установите Azure AD Connect на промежуточном сервере.
4. Разрешите модулю синхронизации выполнить полный импорт и полную синхронизацию на промежуточном сервере.
5. Убедитесь, что новая конфигурация не вызывает непредвиденных изменений, выполнив инструкции из раздела "Проверка" в статье [Проверка конфигурации сервера](active-directory-aadconnectsync-operations.md#verify-the-configuration-of-a-server). Если что-то пошло не так, как ожидалось, внесите необходимые исправления, выполните импорт и синхронизацию, после чего проверьте, исправлены ли данные, выполнив приведенные ниже действия.
6. Сделайте промежуточный сервер активным. Это действие соответствует последнему шагу, "Переключение активного сервера", в статье [Проверка конфигурации сервера](active-directory-aadconnectsync-operations.md#verify-the-configuration-of-a-server).
7. При обновлении Azure AD Connect обновите сервер, находящийся в промежуточном режиме, до последней версии. Обновите данные и конфигурацию, как описано выше. При обновлении Azure AD Sync на этом этапе можно отключить и списать старый сервер.

### <a name="move-a-custom-configuration-from-the-active-server-to-the-staging-server"></a>Перемещение пользовательской конфигурации с активного сервера на промежуточный сервер
Если вы внесли изменения в конфигурацию на активном сервере, их нужно применить и к промежуточному серверу.

Можно переместить созданные вами пользовательские правила синхронизации с помощью PowerShell. Другие изменения необходимо применить одинаковым способом в обеих системах, и их нельзя перенести.

На обоих серверах необходимо одинаково настроить следующее:

* Подключение к одним и тем же лесам.
* Фильтрацию доменов и подразделений.
* Одни и те же дополнительные компоненты, например синхронизацию и обратную запись паролей.

**Перемещение пользовательских правил синхронизации**  
Для перемещения пользовательских правил синхронизации выполните следующее.

1. Откройте **редактор правил синхронизации** на активном сервере.
2. Выберите пользовательское правило. Щелкните **Экспорт**. Откроется окно Блокнота. Сохраните временный файл с расширением PS1 — он станет скриптом PowerShell. Скопируйте PS1-файл на промежуточный сервер.  
   ![Экспорт правил синхронизации](./media/active-directory-aadconnect-upgrade-previous-version/exportrule.png)
3. На промежуточном сервере используется другой GUID соединителя, и его нужно изменить. Чтобы получить GUID, запустите **редактор правил синхронизации**, выберите одно из стандартных правил, представляющих ту же подключенную систему, и щелкните **Экспорт**. Замените GUID в файл PS1 на GUID для промежуточного сервера.
4. Запустите файл PS1 из командной строки PowerShell. На промежуточном сервере будет создано пользовательское правило синхронизации.
5. Повторите эти действия для всех пользовательских правил.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения об интеграции локальных удостоверений см. в статье [Подключение Active Directory к Azure Active Directory](active-directory-aadconnect.md).

