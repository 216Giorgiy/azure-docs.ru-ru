---
title: "Синхронизация Azure AD Connect. Настройка предпочтительного расположения данных для поддержки нескольких регионов в Office 365 | Документация Майкрософт"
description: "Из этой статьи вы узнаете, как разместить ресурсы Office 365 в удобном для пользователей расположении при помощи синхронизации Azure AD Connect."
services: active-directory
documentationcenter: 
author: billmath
manager: mtillman
editor: 
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/30/2018
ms.author: billmath
ms.openlocfilehash: 8a36fc45334a2f1d12e6eabbfb16731ccc9998bf
ms.sourcegitcommit: 9d317dabf4a5cca13308c50a10349af0e72e1b7e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2018
---
# <a name="azure-ad-connect-sync-configure-preferred-data-location-for-office-365-resources"></a>Синхронизация Azure AD Connect. Настройка предпочтительного расположения данных для ресурсов Office 365
В этой статье предоставлены сведения о настройке PreferredDataLocation в службах синхронизации Azure AD Connect. Когда клиент использует поддержку нескольких регионов в Office 365, этот атрибут применяется для обозначения географического расположения данных пользователя в Office 365.

> [!IMPORTANT]
> Поддержка нескольких регионов сейчас доступна в предварительной версии. Чтобы воспользоваться программой предварительной версии, обратитесь к представителю корпорации Майкрософт.
>
>

## <a name="enable-synchronization-of-preferreddatalocation"></a>Включение синхронизации PreferredDataLocation
По умолчанию ресурсы Office 365 для пользователей находятся в том же регионе, что и ваш клиент Azure AD. Например, если клиент находится в Северной Америке, то почтовые ящики Exchange пользователей также расположены в Северной Америке. Для международной организации это может быть не самым оптимальным решением. Установив атрибут preferredDataLocation, можно задать регион пользователя.

Установив этот атрибут, вы сможете работать с ресурсами пользователя Office 365, например с почтовым ящиком и OneDrive, в том же регионе, что и пользователь. При этом для всей организации по-прежнему применяется один клиент.

> [!IMPORTANT]
> Для использования поддержки нескольких регионов требуется не менее 5000 рабочих мест в подписке Office 365.
>
>

Доступные регионы для поддержки нескольких регионов в Office 365:

| Регион | ОПИСАНИЕ |
| --- | --- |
| NAM | Северная Америка |
| EUR | Европа |
| APC | Азиатско-Тихоокеанский регион |
| JPN | Япония |
| AUS | Австралия |
| CAN | Канада |
| GBR | Великобритания |
| LAM | Латинская Америка |

Не все рабочие нагрузки Office 365 поддерживают задание региона пользователя.

Azure AD Connect поддерживает синхронизацию атрибута **PreferredDataLocation** для объектов **User** в версии 1.1.524.0 и более поздних версиях. В частности, были введены следующие изменения.

* Схема типа объекта **User** в соединителе Azure AD расширена для включения атрибута PreferredDataLocation, который является строкой с одним значением.
* Схема типа объекта **Person** в метавселенной расширена для включения атрибута PreferredDataLocation, который имеет строковый тип и является однозначным.

По умолчанию атрибут PreferredDataLocation не включен для синхронизации. Эта функция предназначена для крупных организаций. Использовать ее не всегда целесообразно. Кроме того, необходимо определить атрибут для фиксации региона Office 365 для пользователей, так как PreferredDataLocation отсутствует в локальной службе Active Directory. Этот атрибут будет индивидуальным для каждой организации.

> [!IMPORTANT]
> В настоящее время Azure AD позволяет непосредственно настроить атрибут PreferredDataLocation для синхронизированных объектов User и облачных объектов User с помощью Azure AD PowerShell. После включения синхронизации атрибута PreferredDataLocation необходимо перестать использовать Azure AD PowerShell для настройки этого атрибута для **синхронизированных объектов User**, так как Azure AD Connect переопределит их атрибуты на основе значений исходных атрибутов в локальном каталоге Active Directory.

> [!IMPORTANT]
> С 1 сентября 2017 года возможность непосредственно настроить атрибут PreferredDataLocation для **синхронизированных объектов User** в Azure AD с помощью Azure AD PowerShell отсутствует. Чтобы настроить атрибут PreferredLocation для синхронизированных объектов User, необходимо использовать Azure AD Connect.

Перед включением синхронизации атрибута PreferredDataLocation необходимо выполнить следующее.

* Сначала определите, какой атрибут локального каталога Active Directory следует использовать в качестве исходного атрибута. Он должен быть **строкой с одним значением**. В инструкциях ниже используется один из атрибутов extensionAttribute.
* Если ранее с помощью Azure AD PowerShell в Azure AD вы настроили атрибут PreferredDataLocation для существующих синхронизированных объектов User, необходимо **бэкпортировать** значения атрибутов для соответствующих объектов User в локальном каталоге Active Directory.

    > [!IMPORTANT]
    > В противном случае после включения синхронизации атрибута PreferredDataLocation Azure AD Connect удалит существующие значения атрибутов в Azure AD.

* Рекомендуется настроить исходный атрибут по крайней мере для двух локальных объектов User в Active Directory, которые позже могут быть использованы для проверки.

Включение синхронизации атрибута PreferredDataLocation можно вкратце описать следующим образом.

1. Отключите планировщик синхронизации и убедитесь, что синхронизация не выполняется
2. Добавьте исходный атрибут в схему локального соединителя AD DS.
3. Добавьте PreferredDataLocation в схему соединителя Azure AD.
4. Создайте правило входящей синхронизации для передачи значения атрибута из локального каталога Active Directory.
5. Создайте правило исходящей синхронизации для передачи значения атрибута в Azure AD.
6. Запустите полный цикл синхронизации.
7. Включите планировщик синхронизации.
8. Проверьте результат.

> [!NOTE]
> Эти шаги подробно описываются в остальной части данного раздела. Они описаны в контексте развертывания Azure AD в топологии с отдельным лесом и без пользовательских правил синхронизации. Если используется топология с несколькими лесами, которые настроены при помощи пользовательских правил синхронизации или промежуточного сервера, необходимо соответствующим образом изменить действия.

## <a name="step-1-disable-sync-scheduler-and-verify-there-is-no-synchronization-in-progress"></a>Шаг 1. Отключение планировщика синхронизации и остановка синхронизации
Изменяя правила синхронизации, убедитесь, что синхронизация не выполняется, во избежание экспорта непреднамеренных изменений в Azure AD. Чтобы отключить встроенный планировщик синхронизации, сделайте следующее:

1. Запустите сеанс PowerShell на сервере Azure AD Connect.
2. Отключите плановую синхронизацию, выполнив командлет `Set-ADSyncScheduler -SyncCycleEnabled $false`.
3. Запустите **Synchronization Service Manager**, выбрав **Пуск** > **Служба синхронизации**.
4. Перейдите на вкладку **Операции** и убедитесь, что на ней не отображаются операции в состоянии *Выполняется*.

![Synchronization Service Manager: проверка наличия выполняющихся операций](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step1.png)

## <a name="step-2-add-the-source-attribute-to-the-on-premises-adds-connector-schema"></a>Шаг 2. Добавление исходного атрибута в схему локального соединителя AD DS
Не все атрибуты AD импортируются в пространство локального соединителя AD. Если вы решили использовать атрибут, не синхронизируемый по умолчанию, то его необходимо импортировать. Чтобы добавить исходный атрибут в список импортируемых атрибутов, сделайте следующее.

1. Откройте вкладку **Connectors** (Соединители) в Synchronization Service Manager.
2. Щелкните правой кнопкой мыши **локальный соединитель AD** и выберите **Properties** (Свойства).
3. Во всплывающем диалоговом окне перейдите на вкладку **Select Attributes** (Выбор атрибутов).
4. Убедитесь, что нужный исходный атрибут выбран из списка атрибутов. Если атрибут не отображается, щелкните флажок Show All (Показать все).
5. Нажмите кнопку **OK**, чтобы сохранить изменения.

![Добавление исходного атрибута в схему локального соединителя AD](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step2.png)

## <a name="step-3-add-preferreddatalocation-to-the-azure-ad-connector-schema"></a>Шаг 3. Добавление PreferredDataLocation в схему соединителя Azure AD
По умолчанию атрибут PreferredDataLocation не импортируется в пространство Azure AD Connect. Вот как можно добавить атрибут PreferredDataLocation в список импортируемых атрибутов.

1. Откройте вкладку **Connectors** (Соединители) в Synchronization Service Manager.
2. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Properties** (Свойства).
3. Во всплывающем диалоговом окне перейдите на вкладку **Select Attributes** (Выбор атрибутов).
4. Выберите атрибут PreferredDataLocation в списке атрибутов.
5. Нажмите кнопку **OK**, чтобы сохранить изменения.

![Добавление исходного атрибута в схему соединителя Azure AD](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step3.png)

## <a name="step-4-create-an-inbound-synchronization-rule-to-flow-the-attribute-value-from-on-premises-active-directory"></a>Шаг 4. Создание правила входящей синхронизации для передачи значения атрибута из локального каталога Active Directory
Правило входящей синхронизации позволяет передавать значение исходного атрибута из локального каталога Active Directory в метавселенную.

1. Запустите **редактор правил синхронизации**, выбрав **Пуск** > **Synchronization Rules Editor** (Редактор правил синхронизации).
2. В фильтре поиска для параметра **Направление** задайте значение **Входящие**.
3. Нажмите кнопку **Добавить правило**, чтобы создать правило входящей синхронизации.
4. На вкладке **Описание** укажите следующую конфигурацию.

    | Атрибут | Значение | Сведения |
    | --- | --- | --- |
    | ИМЯ | *Укажите имя* | Например, *In from AD – User PreferredDataLocation*. |
    | ОПИСАНИЕ | *Введите пользовательское описание* |  |
    | Подключенная система | *Выберите локальный соединитель AD*. |  |
    | Тип объекта подключенной системы | **User** |  |
    | Тип объекта метавселенной | **Person** |  |
    | Тип связи | **Join** |  |
    | Приоритет | *Выберите число от 1 до 99*. | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Оставьте значение **фильтра области** пустым, чтобы включить все объекты. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.
6. Перейдите на вкладку **Преобразование** и реализуйте приведенное ниже правило преобразования.

    | Тип потока | Целевой атрибут | Источник | Применить однократно | "Merge Type" (Тип объединения) |
    | --- | --- | --- | --- | --- |
    |Напрямую | PreferredDataLocation | Выберите исходный атрибут. | Флажок снят. | Блокировка изменений |

7. Щелкните **Добавить**, чтобы создать правило входящей синхронизации.

![Создание правила входящей синхронизации](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step4.png)

## <a name="step-5-create-an-outbound-synchronization-rule-to-flow-the-attribute-value-to-azure-ad"></a>Шаг 5. Создание правила исходящей синхронизации для передачи значения атрибута в Azure AD
Правило исходящей синхронизации позволяет передать значение атрибута из метавселенной в атрибут PreferredDataLocation в Azure AD.

1. Перейдите в редактор **правил синхронизации**.
2. В фильтре поиска для параметра **Направление** задайте значение **Исходящие**.
3. Нажмите кнопку **Добавить правило**.
4. На вкладке **Описание** укажите следующую конфигурацию.

    | Атрибут | Значение | Сведения |
    | ----- | ------ | --- |
    | ИМЯ | *Укажите имя* | Например, "Out to AAD – User PreferredDataLocation". |
    | ОПИСАНИЕ | *Укажите описание* ||
    | Подключенная система | *Выберите соединитель AAD* ||
    | Тип объекта подключенной системы | Пользователь ||
    | Тип объекта метавселенной | **Person** ||
    | Тип связи | **Join** ||
    | Приоритет | *Выберите число от 1 до 99*. | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Перейдите на вкладку **Scoping filter** (Фильтр области) и добавьте **отдельную группу фильтра области с двумя приведенными ниже предложениями**.

    | Атрибут | Оператор | Значение |
    | --- | --- | --- |
    | sourceObjectType | EQUAL | Пользователь |
    | cloudMastered | NOTEQUAL | Истина |

    Фильтр области определяет объекты Azure AD, к которым применяется данное правило исходящей синхронизации. В этом примере мы используем фильтр области из правила синхронизации OOB "Out to AD – User Identity". Он предотвращает применение правила синхронизации к объектам User в локальном каталоге Active Directory, которые не синхронизируются. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.

6. Перейдите на вкладку **Преобразование** и реализуйте приведенное ниже правило преобразования.

    | Тип потока | Целевой атрибут | Источник | Применить однократно | "Merge Type" (Тип объединения) |
    | --- | --- | --- | --- | --- |
    | Напрямую | PreferredDataLocation | PreferredDataLocation | Флажок снят. | Блокировка изменений |

7. Щелкните **Добавить**, чтобы создать правило исходящей синхронизации.

![Создание правила исходящей синхронизации](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step5.png)

## <a name="step-6-run-full-synchronization-cycle"></a>Шаг 6. Запуск полного цикла синхронизации
Как правило, полный цикл синхронизации обязателен, так как мы добавили новые атрибуты в схемы AD и соединителя Azure AD, а также ввели пользовательские правила синхронизации. Рекомендуется проверить изменения перед их экспортом в Azure AD. Можно следовать приведенным ниже инструкциям, чтобы проверить изменения во время ручного выполнения действий, составляющих полный цикл синхронизации.

1. Выполните шаг **полного импорта** для **локального соединителя AD**.

   1. Откройте вкладку **Operations** (Операции) в Synchronization Service Manager.
   2. Щелкните правой кнопкой мыши **локальный соединитель AD** и выберите **Run** (Выполнить).
   3. Во всплывающем диалоговом окне выберите **Full Import** (Полный импорт) и нажмите кнопку **ОК**.
   4. Дождитесь завершения операции.

    > [!NOTE]
    > Можно пропустить полный импорт локального соединителя AD, если исходный атрибут уже включен в список импортируемых атрибутов. Другими словами, можно было не вносить изменения во время шага 2 [Добавление исходного атрибута в схему локального соединителя AD](#step-2-add-the-source-attribute-to-the-on-premises-adds-connector-schema).

2. Выполните шаг **полного импорта** для **соединителя Azure AD**.

   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите команду **Run** (Выполнить).
   2. Во всплывающем диалоговом окне выберите **Full Import** (Полный импорт) и нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

3. Проверьте изменения правила синхронизации на существующем объекте User.

Исходный атрибут из локального каталога Active Directory и атрибут PreferredDataLocation из Azure AD были импортированы в соответствующее пространство соединителя. Перед выполнением шага полной синхронизации рекомендуется выполнить **предварительный просмотр** существующего объекта User в пространстве локального соединителя AD. У выбранного объекта должен быть заполнен исходный атрибут. Если при **предварительном просмотре** атрибут PreferredDataLocation успешно заполнен, то это хороший показатель того, что вы верно настроили правила синхронизацию. Сведения о том, как выполнить **предварительный просмотр**, см. в разделе [Проверка изменений](active-directory-aadconnectsync-change-the-configuration.md#verify-the-change).

4. Выполните шаг **полной синхронизации** для **локального соединителя AD**.

   1. Щелкните правой кнопкой мыши **локальный соединитель AD** и выберите **Run** (Выполнить).
   2. Во всплывающем диалоговом окне выберите **Full Synchronization** (Полная синхронизация) и нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

5. Проверьте **ожидающие операции экспорта** в Azure AD.

   1. Щелкните правой кнопкой мыши соединитель **Azure AD** и выберите **Search Connector Space** (Поиск пространства соединителя).
   2. Во всплывающем диалоговом окне "Search Connector Space" (Поиск пространства соединителя) сделайте следующее.

      1. Для параметра **Scope** (Область) укажите значение **Pending Export** (Ожидающая операция экспорта).
      2. Установите все 3 флажка: **"Добавить", "Изменить" и "Удалить"**.
      3. Нажмите кнопку **Найти**, чтобы получить список объектов с изменениями для экспорта. Чтобы проверить изменения указанного объекта, дважды щелкните его.
      4. Убедитесь, что изменения являются ожидаемыми.

6. Выполните шаг **экспорта** для **соединителя Azure AD**.

   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Run** (Выполнить).
   2. Во всплывающем диалоговом окне "Run Connector" (Запуск соединителя) выберите **Экспорт** и нажмите кнопку **ОК**.
   3. Дождитесь завершения экспорта в Azure AD.

> [!NOTE]
> Вы можете заметить, что инструкции для соединителя Azure AD не содержат шаг полной синхронизации для соединителя Azure AD и шаг экспорта для соединителя AD. Они и не требуются, так как значения атрибутов передаются только из локального каталога Active Directory в Azure AD.

## <a name="step-7-re-enable-sync-scheduler"></a>Шаг 7. Повторное включение планировщика синхронизации
Повторно включите встроенный планировщик синхронизации.

1. Запустите сеанс PowerShell.
2. Повторно включите плановую синхронизацию, выполнив командлет: `Set-ADSyncScheduler -SyncCycleEnabled $true`

## <a name="step-8-verify-the-result"></a>Шаг 8. Проверка результата
Теперь можно проверить конфигурацию и активировать ее для пользователей.

1. Добавьте регион в выбранный атрибут для пользователя. Список доступных регионов можно найти в [этой таблице](#enable-synchronization-of-preferreddatalocation).  
![Атрибут AD, добавленный для пользователя](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-adattribute.png)
2. Дождитесь, пока атрибут будет синхронизирован с Azure AD.
3. При помощи Exchange Online PowerShell проверьте, правильно ли установлен регион почтового ящика.  
![Регион почтового ящика, установленный для пользователя в Exchange Online](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-mailboxregion.png)  
Учитывая, что клиент отмечен для использования этой функции, почтовый ящик перемещен в правильный регион. В этом можно убедиться, просмотрев имя сервера, на котором размещен почтовый ящик.
4. Чтобы проверить, работает ли этот параметр для нескольких почтовых ящиков, используйте скрипт из [коллекции Technet](https://gallery.technet.microsoft.com/office/PowerShell-Script-to-a6bbfc2e). Этот скрипт также содержит список всех префиксов серверов в центрах обработки данных Office 365 с указанием регионов, в которых размещены серверы. С его помощью можно проверить расположение почтового ящика на предыдущем шаге.

## <a name="next-steps"></a>Дополнительная информация

**Дополнительные сведения о поддержке нескольких регионов в Office 365:**

* сеансы Ignite, посвященные поддержке нескольких регионов: https://aka.ms/MultiGeoIgnite;
* поддержка нескольких регионов в OneDrive: https://aka.ms/OneDriveMultiGeo;
* поддержка нескольких регионов в SharePoint Online: https://aka.ms/SharePointMultiGeo.

**Дополнительные сведения о модели конфигурации в модуле синхронизации:**

* Дополнительные сведения о модели конфигурации, см. в статье о [принципах декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning.md).
* Дополнительные сведения о языке выражений см. в статье [Служба синхронизации Azure AD Connect: общие сведения о выражениях декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning-expressions.md).

**Обзорные статьи**

* [Службы синхронизации Azure AD Connect: общие сведений о синхронизации и ее настройка](active-directory-aadconnectsync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md)
