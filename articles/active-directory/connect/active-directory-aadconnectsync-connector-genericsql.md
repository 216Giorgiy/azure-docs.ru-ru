---
title: "Универсальный соединитель SQL | Документация Майкрософт"
description: "В этой статье описана настройка универсального соединителя SQL от корпорации Майкрософт."
services: active-directory
documentationcenter: 
author: AndKjell
manager: femila
editor: 
ms.assetid: fd8ccef3-6605-47ba-9219-e0c74ffc0ec9
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/12/2017
ms.author: billmath
ms.translationtype: Human Translation
ms.sourcegitcommit: fc4172b27b93a49c613eb915252895e845b96892
ms.openlocfilehash: b7e99f8a4d7bc1cd30c71ce08ad38c13203f8b69
ms.contentlocale: ru-ru
ms.lasthandoff: 05/12/2017

---
<a id="generic-sql-connector-technical-reference" class="xliff"></a>

# Технический справочник по универсальному соединителю SQL
В этой статье описывается универсальный соединитель SQL. Статья относится к следующим продуктам:

* Microsoft Identity Manager 2016 (MIM2016);
* Forefront Identity Manager 2010 R2 (FIM2010R2).
  * Необходимо установить исправление 4.1.3671.0 или более позднюю версию ( [KB3092178](https://support.microsoft.com/kb/3092178)).

Для MIM2016 и FIM2010R2 соединитель можно скачать из [Центра загрузки Майкрософт](http://go.microsoft.com/fwlink/?LinkId=717495).

Чтобы увидеть, как работает этот соединитель, см. раздел [Универсальный соединитель SQL: пошаговое руководство](active-directory-aadconnectsync-connector-genericsql-step-by-step.md).

<a id="overview-of-the-generic-sql-connector" class="xliff"></a>

## Общие сведения об универсальном соединителе SQL
Универсальный соединитель SQL позволяет интегрировать службу синхронизации с системой базы данных, предоставляющей подключение ODBC.  

На системном уровне текущий выпуск соединителя поддерживает следующие функции.

| Функция | Поддержка |
| --- | --- |
| Подключенный источник данных |Все 64-разрядные драйверы ODBC поддерживают этот соединитель. Этот соединитель протестирован со следующими базами данных:  <li>Microsoft SQL Server и SQL Azure</li><li>IBM DB2 10.x</li><li>IBM DB2 9.x</li><li>Oracle 10 и 11g</li><li>MySQL 5.x</li> |
| Сценарии |<li>Управление жизненным циклом объекта</li><li>Управление паролями</li> |
| Операции |<li>Полный импорт и импорт изменений, экспорт</li><li>Для экспорта: добавление, удаление, обновление и замена</li><li>Установка пароля, изменение пароля</li> |
| Схема |<li>Динамическое обнаружение объектов и атрибутов</li> |

<a id="prerequisites" class="xliff"></a>

### Предварительные требования
Прежде чем использовать соединитель, установите на сервере синхронизации такие компоненты:

* Microsoft .NET Framework, начиная с версии 4.5.2.
* 64-разрядные клиентские драйверы ODBC.

<a id="permissions-in-connected-data-source" class="xliff"></a>

### Разрешения в подключенном источнике данных
Для создания или выполнения всех задач, поддерживаемых универсальным соединителем SQL, необходимо следующее:

* db_datareader;
* db_datawriter.

<a id="ports-and-protocols" class="xliff"></a>

### Порты и протоколы
Сведения о портах, необходимых для работы драйвера ODBC, см. в документации поставщика базы данных.

<a id="create-a-new-connector" class="xliff"></a>

## Создание нового соединителя
Чтобы создать универсальный соединитель SQL, в **службе синхронизации** последовательно выберите элементы **Агент управления** и **Создать**. Выберите **Универсальный соединитель SQL (Microsoft)** .

![Создание соединителя](./media/active-directory-aadconnectsync-connector-genericsql/createconnector.png)

<a id="connectivity" class="xliff"></a>

### Соединение
Для подключения соединитель использует DSN-файл ODBC. Создайте DSN-файл, последовательно выбрав в меню «Пуск» пункты **Администрирование** и **Источники данных ODBC**. С помощью средства администрирования создайте **DSN-файл** , который будет использован соединителем.

![Создание соединителя](./media/active-directory-aadconnectsync-connector-genericsql/connectivity.png)

При создании универсального соединителя SQL первым экраном будет экран настройки подключения. Вам потребуется указать следующие сведения:

* Путь к DSN-файлу
* Аутентификация
  * Имя пользователя
  * Пароль

База данных должна поддерживать один из перечисленных ниже методов проверки подлинности.

* **Проверка подлинности Windows**. Для проверки подлинности пользователя в базе данных используются учетные данные Windows. Указанные имя пользователя и пароль используются для проверки подлинности в базе данных. Этой учетной записи потребуются разрешения для доступа к базе данных.
* **Проверка подлинности SQL**. Для подключения к базе данных используются имя пользователя и пароль, указанные на экране настройки подключения к базе данных. Если имя пользователя и пароль хранятся в DSN-файле, приоритет имеют учетные данные, указанные на экране настройки подключения.
* **Проверка подлинности базы данных SQL Azure**. Дополнительные сведения см. в статье о [подключении к базе данных SQL с использованием проверки подлинности Azure Active Directory](../../sql-database/sql-database-aad-authentication.md).

**Различаемое имя служит привязкой**. Если выбрать этот параметр, различаемое имя будет также использоваться в качестве атрибута привязки. Этот подход можно использовать для простой реализации, но он имеет следующие ограничения:

* Соединитель поддерживает только один тип объекта. Поэтому все ссылочные атрибуты смогут указывать только на тот же тип объекта.

**Тип экспорта: замена объектов**. Экспорт объекта выполняется целиком, с заменой имеющегося объекта, даже если были изменены только некоторые атрибуты.

<a id="schema-1-detect-object-types" class="xliff"></a>

### Схема 1 (определение типов объектов)
На этой странице настраивается способ определения соединителем различных типов объектов в базе данных.

Каждый тип объектов представляется в виде раздела и может быть настроен впоследствии на странице **Configure Partitions and Hierarchies**(Настройка разделов и иерархий).

![schema1a](./media/active-directory-aadconnectsync-connector-genericsql/schema1a.png)

**Метод обнаружения типа объекта**. Соединитель поддерживает следующие методы определения типа объектов.

* **Фиксированное значение**. Объекты указываются в виде списка, разделенного запятыми. Например, `User,Group,Department`.  
  ![schema1b](./media/active-directory-aadconnectsync-connector-genericsql/schema1b.png)
* **Таблица, представление или хранимая процедура**. Указывается имя таблицы, представления или хранимой процедуры, а затем имя столбца, в котором содержится список типов объектов. Если вы используете хранимую процедуру, нужно будет указать ее параметры в следующем формате: **[имя]:[направление]:[значение]**. Все параметры указываются в отдельных строках (чтобы создать новую строку, нажмите CTRL+ВВОД).  
  ![schema1c](./media/active-directory-aadconnectsync-connector-genericsql/schema1c.png)
* **SQL-запрос**. Этот параметр позволяет указать SQL-запрос, который возвращает один столбец с типами объектов. Например, `SELECT [Column Name] FROM TABLENAME`. Возвращаемый столбец должен иметь строковый тип (varchar).

<a id="schema-2-detect-attribute-types" class="xliff"></a>

### Схема 2 (определение типов атрибутов)
На этой странице настраивается способ определения имен и типов атрибутов. Для всех типов объектов, указанных на предыдущей странице, указываются параметры конфигурации.

![schema2a](./media/active-directory-aadconnectsync-connector-genericsql/schema2a.png)

**Метод обнаружения типа атрибута**. Соединитель поддерживает следующие методы обнаружения типов атрибутов для всех типов объектов, определенных на экране «Схема 1».

* **Таблица, представление или хранимая процедура**. Укажите имя таблицы, представления или хранимой процедуры, используемой для поиска имен атрибутов. Если вы используете хранимую процедуру, нужно будет указать ее параметры в следующем формате: **[имя]:[направление]:[значение]**. Все параметры указываются в отдельных строках (чтобы создать новую строку, нажмите CTRL+ВВОД). Чтобы определить имена атрибутов в многозначном атрибуте, укажите список таблиц или представлений, разделенных запятой. Многозначные атрибуты не поддерживаются, если имена столбцов в родительской и дочерней таблицах совпадают.
* **SQL-запрос**. Этот параметр позволяет указать SQL-запрос, который возвращает один столбец с именами атрибутов. Например, `SELECT [Column Name] FROM TABLENAME`. Возвращаемый столбец должен иметь строковый тип (varchar).

<a id="schema-3-define-anchor-and-dn" class="xliff"></a>

### Схема 3 (определение привязки и различаемого имени)
На этой странице для каждого определенного типа объекта можно настроить привязку и атрибут различаемого имени. Можно выбрать несколько атрибутов, чтобы сделать привязку уникальной.

![schema3a](./media/active-directory-aadconnectsync-connector-genericsql/schema3a.png)

* Многозначные и логические атрибуты в список не включаются.
* Один атрибут нельзя одновременно использовать для различаемого имени и привязки, если только на странице настройки подключения не выбран параметр **Различаемое имя служит привязкой** .
* Если на странице настройки подключения выбран параметр **Различаемое имя служит привязкой** , то на этой странице потребуется указать только атрибут различаемого имени. Этот атрибут также будет использоваться в качестве атрибута привязки.

  ![schema3b](./media/active-directory-aadconnectsync-connector-genericsql/schema3b.png)

<a id="schema-4-define-attribute-type-reference-and-direction" class="xliff"></a>

### Схема 4 (определение типа атрибута, ссылки и направления)
На этой странице можно настроить тип (целое число, двоичное значение или логическое значение) и направление для каждого атрибута. Здесь приводятся все атрибуты со страницы **Схема 2** , включая многозначные атрибуты.

![schema4a](./media/active-directory-aadconnectsync-connector-genericsql/schema4a.png)

* **DataType**. Используется для сопоставления типа атрибута с типом, известным для модуля синхронизации. По умолчанию используется тот же тип, который определен в схеме SQL, но типы DateTime и Reference не определяются автоматически. Для этих типов необходимо указать **DateTime** или **Reference**.
* **Направление**. В качестве направления атрибута можно выбрать Import, Export или ImportExport. Значением по умолчанию является ImportExport.

![schema4b](./media/active-directory-aadconnectsync-connector-genericsql/schema4b.png)

Примечания:

* Если соединителю не удалось определить тип атрибута, будет использоваться тип данных String.
* **Вложенные таблицы** можно считать таблицами с одним столбцом. В Oracle строки вложенной таблицы хранятся в произвольном порядке. Тем не менее при извлечении вложенной таблицы в переменную PL/SQL строкам последовательно присваиваются подстрочные знаки (начиная с 1). В результате строками можно оперировать как массивом.
* **VARRYS** не поддерживаются в этом соединителе.

<a id="schema-5-define-partition-for-reference-attributes" class="xliff"></a>

### Схема 5 (определение разделов для ссылочных атрибутов)
На этой странице для всех ссылочных атрибутов указываются разделы (типы объектов), на которые ссылается атрибут.

![schema5](./media/active-directory-aadconnectsync-connector-genericsql/schema5.png)

Если выбран параметр **DN is anchor**(Различаемое имя служит привязкой), то нужно использовать тип объекта, используемого как источник ссылки. Ссылаться на объект другого типа нельзя.

>[!NOTE]
Обновление за март 2017 г. : теперь вы можете использовать * для импорта всех возможных типов участников.

![globalparameters3](./media/active-directory-aadconnectsync-connector-genericsql/any-option.png)

>[!IMPORTANT]
 Начиная с мая 2017 г. компонент "*" (или **любой параметр** изменен для поддержки потока импорта и экспорта. Если вы хотите использовать этот параметр, таблица или представление с несколькими значениями должны иметь атрибут, содержащий тип объекта.

![](./media/active-directory-aadconnectsync-connector-genericsql/any-02.png)

 </br> Если выбран компонент "*", также необходимо указать имя столбца с типом объекта.</br> ![](./media/active-directory-aadconnectsync-connector-genericsql/any-03.png)

После импорта вы увидите нечто похожее:

  ![globalparameters3](./media/active-directory-aadconnectsync-connector-genericsql/after-import.png)



<a id="global-parameters" class="xliff"></a>

### Глобальные параметры
Страница «Глобальные параметры» используется для настройки импорта изменений, формата даты и времени и метода проверки пароля.

![globalparameters1](./media/active-directory-aadconnectsync-connector-genericsql/globalparameters1.png)



Универсальный соединитель SQL поддерживает следующие способы импорта изменений.

* **Триггер**. См. статью [Generating Delta Views Using Triggers](https://technet.microsoft.com/library/cc708665.aspx) (Создание представлений изменений с помощью триггеров).
* **Водяной знак**. Это общий подход, который может использоваться с любой базой данных. Запрос водяного знака предварительно заполнен и зависит от поставщика базы данных. В каждой используемой таблице или представлении должен присутствовать столбец для водяного знака. Он нужен для отслеживания операций вставки и изменения в таблице, а также в зависимых (многозначных или дочерних) таблицах. Требуется синхронизация времени между службой синхронизации и сервером базы данных. В противном случае некоторые записи при импорте изменений могут быть опущены.  
  Ограничение:
  * Функция водяных знаков не поддерживает удаленные объекты.
* **Моментальный снимок** (работает только с Microsoft SQL Server). См. статью о [создании представлений изменений с использованием моментальных снимков](https://technet.microsoft.com/library/cc720640.aspx).
* **Отслеживание изменений** (работает только с Microsoft SQL Server). См. статью [Об отслеживании изменений (SQL Server)](https://msdn.microsoft.com/library/bb933875.aspx).  
  Ограничения:
  * Атрибуты привязки и различаемого имени должны быть частью первичного ключа для выбранного объекта в таблице.
  * Во время импорта и экспорта данных с использованием функции отслеживания изменений SQL-запросы не поддерживаются.

**Дополнительные параметры**. Указывается часовой пояс сервера базы данных, определяющий расположение сервера. Это значение используется для поддержки различных атрибутов формата даты и времени.

Соединитель всегда хранит значения даты и времени в формате UTC. Чтобы операции преобразования даты и времени работали правильно, необходимо указать часовой пояс и формат сервера базы данных. Следует использовать формат .NET.

Во время экспорта все атрибуты времени и даты, передаваемые соединителю, указываются в формате времени UTC.

![globalparameters2](./media/active-directory-aadconnectsync-connector-genericsql/globalparameters2.png)

**Конфигурация паролей**. Соединитель предоставляет возможности синхронизации паролей и поддерживает установку и изменение паролей.

Для синхронизации паролей в соединителе имеется два метода.

* **Хранимая процедура**. Для установки и изменения пароля требуются две соответствующие хранимые процедуры. В полях **Set Password SP** (Параметры хранимой процедуры установки пароля) и **Change Password SP** (Параметры хранимой процедуры изменения пароля) укажите параметры, как в следующем примере.
  ![globalparameters3](./media/active-directory-aadconnectsync-connector-genericsql/globalparameters3.png)
* **Расширение пароля**. Для этого метода требуется библиотека DLL расширения паролей (необходимо указать имя библиотеки DLL расширения, которая реализует интерфейс [IMAExtensible2Password](https://msdn.microsoft.com/library/microsoft.metadirectoryservices.imaextensible2password.aspx)). Сборка с расширением паролей должна быть помещена в папку с расширениями, чтобы соединитель мог загрузить библиотеку DLL в среде выполнения.
  ![globalparameters4](./media/active-directory-aadconnectsync-connector-genericsql/globalparameters4.png)

Также на странице **Настройка расширений** потребуется включить управление паролями.
![globalparameters5](./media/active-directory-aadconnectsync-connector-genericsql/globalparameters5.png)

<a id="configure-partitions-and-hierarchies" class="xliff"></a>

### Configure Partitions and Hierarchies
На странице разделов и иерархий выберите все типы объектов. Каждый тип помещается в отдельный раздел.

![partitions1](./media/active-directory-aadconnectsync-connector-genericsql/partitions1.png)

Здесь также можно переопределить значения, указанные на страницах **Подключение** или **Глобальные параметры**.

![partitions2](./media/active-directory-aadconnectsync-connector-genericsql/partitions2.png)

<a id="configure-anchors" class="xliff"></a>

### Настройка привязок
Эта страница доступна только для чтения, так как привязки к этому моменту уже определены. К выбранному атрибуту привязки всегда добавляется тип объекта, что обеспечивает его уникальность для различных типов объектов.

![Привязки](./media/active-directory-aadconnectsync-connector-genericsql/anchors.png)

<a id="configure-run-step-parameter" class="xliff"></a>

## Настройка параметров шагов выполнения
Шаги настраиваются в профилях выполнения соединителя. Эти настройки относятся к фактическим операциям импорта и экспорта данных.

<a id="full-and-delta-import" class="xliff"></a>

### Полный импорт и импорт изменений
Универсальный соединитель SQL поддерживает следующие методы полного импорта и импорта изменений.

* Таблица
* Просмотр
* Хранимая процедура
* Запросы SQL

![runstep1](./media/active-directory-aadconnectsync-connector-genericsql/runstep1.png)

**Таблица или представление**  
Для импорта многозначных атрибутов объекта в поле **Имя многозначных таблиц или представлений** потребуется указать список таблиц или представлений, разделенных запятыми. Соответствующие условия объединения с родительской таблицей указываются в поле **Условие объединения**.

Пример. Нужно импортировать объект Employee и его многозначные атрибуты. Существует две таблицы: Employee (главная таблица) и Department (многозначная таблица).
Выполните следующее:

* В поле **Таблица/представление/хранимая процедура** введите **Employee**.
* В поле **Имена многозначных таблиц или представлений**введите Department.
* Введите условие объединения сотрудников и отделов в поле **Условие объединения**. Например, `Employee.DEPTID=Department.DepartmentID`.
  ![runstep2](./media/active-directory-aadconnectsync-connector-genericsql/runstep2.png)

**Хранимые процедуры**  
![runstep3](./media/active-directory-aadconnectsync-connector-genericsql/runstep3.png)

* Для больших объемов данных рекомендуется реализовать разбиение на страницы с помощью хранимых процедур.
* Чтобы хранимые процедуры поддерживали разбиение на страницы, потребуется указать начальный и конечный индексы. См. статью [Efficiently Paging Through Large Amounts of Data](https://msdn.microsoft.com/library/bb445504.aspx) (Эффективное разбиение больших объемов данных).
* @StartIndex и @EndIndex во время выполнения заменяются соответствующими значениями размера страницы, которые настраиваются на странице **Configure Step** (Настройка шага). Например, если соединитель получает первую страницу, а размер страницы равен 500, то @StartIndex примет значение 1, а @EndIndex — 500. При получении соединителем следующих страниц и изменении @StartIndex и @EndIndex эти значения будут соответствующим образом увеличиваться.
* Для выполнения параметризованной хранимой процедуры укажите параметры в формате `[Name]:[Direction]:[Value]` . Все параметры указываются в отдельных строках (чтобы создать новую строку, нажмите CTRL+ВВОД).
* Универсальный соединитель SQL также поддерживает операции импорта из связанных серверов на сервере Microsoft SQL Server. Если сведения следует получить из таблицы на связанном сервере, то имя таблицы должно быть указано в формате `[ServerName].[Database].[Schema].[TableName]`
* Универсальный соединитель SQL поддерживает только те объекты, структура (имя псевдонима и тип данных) которых в шагах выполнения и в схеме совпадает. Если структура объекта, полученная из схемы и указанная в сведениях о шагах выполнения, отличается, такой объект не будет обработан соединителем SQL.

**Запросы SQL**  
![runstep4](./media/active-directory-aadconnectsync-connector-genericsql/runstep4.png)

![runstep5](./media/active-directory-aadconnectsync-connector-genericsql/runstep5.png)

* Запросы с несколькими результирующими наборами не поддерживаются.
* Запрос SQL поддерживает разбиение на страницы и имеет переменные для определения начального и конечного индексов.

<a id="delta-import" class="xliff"></a>

### импорт изменений;
![runstep6](./media/active-directory-aadconnectsync-connector-genericsql/runstep6.png)

Для конфигурации импорта изменений требуются некоторые дополнительные настройки по сравнению с полным импортом.

* Если для отслеживания изменений выбран метод "Триггер" или "Моментальный снимок", то в поле **History Table or Snapshot database name** (Таблица журнала или имя базы данных моментальных снимков) вы сможете указать таблицу журнала или базу данных моментальных снимков.
* Нужно также указать условие объединения таблицы журнала и родительской таблицы. Например, `Employee.ID=History.EmployeeID`.
* Чтобы отслеживать транзакции в родительской таблице с помощью таблицы журнала, нужно указать имя столбца со сведениями об операциях (добавление, обновление и удаление).
* Если для отслеживания изменений выбран метод "Водяной знак", в поле **Water Mark Column Name**(Имя столбца водяного знака) необходимо указать имя столбца со сведениями об операциях.
* Столбец **Изменить атрибут типа** нужен для изменения типа. Этот столбец позволяет сопоставить изменение в основной или многозначной таблице с типом изменения в представлении изменений. В этом столбце может быть указан тип изменений Modify_Attribute для изменений на уровне атрибута, либо Add, Modify или Delete для изменений на уровне объекта. Если значение отличается от значения по умолчанию (добавление, изменение или удаление), то новые значения можно определить с помощью этого параметра.

<a id="export" class="xliff"></a>

### экспорт.
![runstep7](./media/active-directory-aadconnectsync-connector-genericsql/runstep7.png)

Универсальный соединитель SQL поддерживает четыре метода экспорта.

* Таблица
* Просмотр
* Хранимая процедура
* Запросы SQL

**Таблица или представление**  
Если выбрать параметр "Таблица или представление", то соединитель создает соответствующие запросы на экспорт.

**Хранимые процедуры**  
![runstep8](./media/active-directory-aadconnectsync-connector-genericsql/runstep8.png)

Если выбрать параметр "Хранимые процедуры", то для экспорта потребуется три разных хранимых процедуры, чтобы выполнить операции вставки, обновления или удаления.

* **Add SP Name** (Имя хранимой процедуры добавления). Эта хранимая процедура выполняется при поступлении объекта в соединитель для вставки в соответствующую таблицу.
* **Update SP Name** (Имя хранимой процедуры обновления). Эта хранимая процедура выполняется при поступлении объекта в соединитель для обновления в соответствующей таблице.
* **Delete SP Name** (Имя хранимой процедуры удаления). Эта хранимая процедура выполняется при поступлении объекта в соединитель для удаления из соответствующей таблицы.
* В качестве параметра для хранимой процедуры используется атрибут, выбранный из схемы. Например, `EmployeeName: INPUT: @EmployeeName`. EmployeeName выбирается в схеме соединителя, и соединитель заменяет соответствующее значение при выполнении экспорта.
* Для выполнения параметризованной хранимой процедуры укажите параметры в формате `[Name]:[Direction]:[Value]`. Все параметры указываются в отдельных строках (чтобы создать новую строку, нажмите CTRL+ВВОД).

**SQL query**  
![runstep9](./media/active-directory-aadconnectsync-connector-genericsql/runstep9.png)

Если выбрать параметр "SQL-запрос", то для экспорта потребуется три разных запроса для выполнения операций вставки, обновления или удаления.

* **Insert Query** (Запрос на вставку). Этот запрос выполняется при поступлении объекта в соединитель для вставки в соответствующую таблицу.
* **Update Query** (Запрос на обновление). Этот запрос выполняется при поступлении объекта в соединитель для обновления в соответствующей таблице.
* **Delete Query** (Запрос на удаление). Этот запрос выполняется при поступлении объекта в соединитель для удаления из соответствующей таблицы.
* В качестве значения параметра для запроса используется атрибут, выбранный из схемы. Например, `Insert into Employee (ID, Name) Values (@ID, @EmployeeName)`.

<a id="troubleshooting" class="xliff"></a>

## Устранение неполадок
* Сведения о том, как включить ведение журнала для устранения неполадок соединителя, см. в статье [How to Enable ETW Tracing for Connectors](http://go.microsoft.com/fwlink/?LinkId=335731) (Включение трассировки событий Windows для соединителей).

