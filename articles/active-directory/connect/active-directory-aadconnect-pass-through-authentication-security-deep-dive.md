---
title: "Руководство по безопасности сквозной аутентификации Azure Active Directory | Документация Майкрософт"
description: "В этой статье описано, как сквозная аутентификация Azure Active Directory (Azure AD) позволяет защитить локальные учетные записи от атак методом подбора пароля в облаке."
services: active-directory
keywords: "сквозная проверка подлинности azure ad connect, установка active directory, необходимые компоненты для azure ad, единый вход"
documentationcenter: 
author: swkrish
manager: femila
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/12/2017
ms.author: billmath
ms.openlocfilehash: a5feadd851b166d0a9a77bd1d124cdd599d5d701
ms.sourcegitcommit: c5eeb0c950a0ba35d0b0953f5d88d3be57960180
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/24/2017
---
# <a name="azure-active-directory-pass-through-authentication-security-deep-dive"></a>Руководство по безопасности сквозной аутентификации Azure Active Directory

В этой статье более подробно описывается, как работает сквозная аутентификация. Она посвящена аспектам безопасности данного компонента. Этот раздел будет представлять интерес для администраторов безопасности и администраторов ИТ, начальника отдела соответствия и сотрудников службы безопасности, а также других ИТ-специалистов, ответственных за безопасность ИТ-инфраструктуры и ее соответствие требованиям в малых и средних организациях или крупных предприятиях.

Раздел содержит следующее:
- Подробные технические сведения об установке и регистрации агентов аутентификации.
- Подробные технические сведения о шифровании паролей при входе пользователя.
- Безопасность каналов между локальными агентам аутентификации и Azure Active Directory (Azure AD).
- Подробные технические сведения об обеспечении операционной безопасности агентов аутентификации.
- Другие темы, связанные с безопасностью.

## <a name="key-security-capabilities"></a>Основные возможности защиты

Ниже приведены основные аспекты безопасности данного компонента.
- Он был основан на безопасной мультитенантной архитектуре, обеспечивающий изоляцию запросов на вход в между клиентами.
- Локальные пароли ни в каком виде не хранятся в облаке.
- Локальные агенты аутентификации, которые ожидают передачи данных и отвечают на запросы на проверку пароля, устанавливают только исходящие подключения в пределах вашей сети. Нет необходимости устанавливать эти агенты аутентификации в сети периметра.
- Для исходящего трафика агентов аутентификации, передаваемого в Azure AD, используются только стандартные порты (80 и 443). В брандмауэре не нужно открывать какие-либо входящие порты. 
  - Для всего прошедшего аутентификацию исходящего трафика используется порт 443.
  - Порт 80 используется только для скачивания списков отзыва сертификатов (CRL). Это позволяет гарантировать, что ни один из сертификатов, используемых функцией, не окажется отозванным.
  - [Здесь](active-directory-aadconnect-pass-through-authentication-quick-start.md#step-1-check-prerequisites) приведен полный перечень требований к сети.
- Пароли, введенные пользователем во время входа, шифруются в облаке перед приемом локальными агентами аутентификации для проверки в Active Directory.
- Канал HTTPS между Azure AD и локальным агентом аутентификации защищен взаимной аутентификацией.
- Она тесно интегрирована с возможностями защиты облака Azure AD, такими как политики условного доступа (включая Многофакторную идентификацию), защита удостоверений и смарт-блокировка.

## <a name="components-involved"></a>Участвующие компоненты

Общие сведения о защите операций, служб и данных Azure AD см. в разделе [Центр управления безопасностью](https://azure.microsoft.com/support/trust-center/). При использовании сквозной аутентификации для входа пользователей в систему участвуют следующие компоненты.
- **Azure AD STS**. Служба токенов безопасности без учета состояния (STS), которая обрабатывает запросы на вход и выдает маркеры безопасности для браузеров, клиентов и служб пользователей.
- **Служебная шина Azure**. Обеспечивает обмен данными через облако с корпоративными службами обмена сообщениями и ретрансляции. Такая конфигурация позволяет подключаться к локальным решениям с помощью облака.
- **Агент аутентификации Azure AD Connect (агент аутентификации)**. Локальный компонент, который ожидает передачи данных и отвечает на запросы на проверку пароля.
- **База данных SQL Azure**. Содержит сведения об агентах аутентификации клиента, включая его метаданные и ключи шифрования.
- **Active Directory (AD)**. Локальная среда Active Directory, в которой хранятся учетные записи пользователей (и их пароли).

## <a name="installation-and-registration-of-authentication-agents"></a>Установка и регистрация агентов аутентификации

Агенты аутентификации устанавливаются и регистрируются в Azure AD при [включении сквозной аутентификации с помощью Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-pass-through-authentication-quick-start#step-2-enable-the-feature) или при [добавлении дополнительных агентов аутентификации для обеспечения высокого уровня доступности запросов на вход](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-pass-through-authentication-quick-start#step-4-ensure-high-availability). Подготовка агента аутентификации к работе делится на три основных этапа:

- установка агента аутентификации;
- регистрация агента аутентификации;
- инициализация агента аутентификации.

В следующих разделах каждый этап рассматривается более подробно.

### <a name="authentication-agent-installation"></a>Установка агента аутентификации

Только глобальные администраторы могут установить агент аутентификации (с использованием Azure AD Connect или в виде изолированного развертывания) на локальном сервере. Установка добавляет в список **Панель управления > Программы > Программы и компоненты** следующие две записи:
- Приложение агента аутентификации. Оно выполняется с привилегиями [сетевой службы](https://msdn.microsoft.com/library/windows/desktop/ms684272.aspx).
- Приложение Updater, используемое для автоматического обновления агента аутентификации. Оно выполняется с правами [локальной системы](https://msdn.microsoft.com/library/windows/desktop/ms684190.aspx).


### <a name="authentication-agent-registration"></a>Регистрация агента аутентификации

После установки агента аутентификации его необходимо зарегистрировать в Azure AD. Для этого Azure AD назначает каждому агенту аутентификации уникальный цифровой сертификат удостоверения, который он может использовать для безопасной связи с Azure AD.

Процедура регистрации также привязывает агент аутентификации к вашему клиенту, чтобы службе Azure AD было известно, что только этому агенту аутентификации разрешено обрабатывать запросы на проверку паролей для вашего клиента. Эта процедура повторяется для каждого нового агента аутентификации, которого вы регистрируете.

Ниже описывается, как агент аутентификации регистрируется в Azure AD.

![Регистрация агента](./media/active-directory-aadconnect-pass-through-authentication-security-deep-dive/pta1.png)

1. Сначала Azure AD запрашивает вход глобального администратора в Azure AD с помощью своих учетных данных. Во время входа агент аутентификации получает маркер доступа, который он может использовать от имени глобального администратора.
2. Затем агент аутентификации создает пару ключей — открытый ключ и закрытый ключ.
    - Эта пара ключей создается с использованием стандартного **2048-разрядного шифрования RSA**.
    - Закрытый ключ никогда не покидает локальный сервер, на котором установлен агент аутентификации.
3.  Агент аутентификации выполняет запрос на регистрацию к Azure AD по протоколу HTTPS. Этот запрос содержит следующие компоненты:
    - маркер доступа, полученный на шаге 1;
    - открытый ключ, созданный на шаге 2;
    - **запрос на подписывание сертификата** (CSR или запрос на сертификат). Это необходимо, чтобы запросить цифровой сертификат удостоверения, центром сертификации которого является Azure AD.
4. Azure AD проверяет маркер доступа в запросе на регистрацию и удостоверяется, что запрос поступил от глобального администратора.
5. Затем Azure AD подписывает и выдает цифровой сертификат удостоверения агенту аутентификации.
    - Сертификат подписывается с помощью **корневого центра сертификации (ЦС) Azure AD**. Обратите внимание на то, что этот ЦС _не_ расположен в хранилище **доверенных корневых центров сертификации** Windows.
    - Этот центр сертификации используется только функцией сквозной проверки подлинности. Он используется только для подписания представителями отдела обслуживания клиентов во время регистрации агента проверки подлинности.
    - Этот центр сертификации не используется другими службами в Azure AD.
    - Субъект сертификата (**различающееся имя**) имеет значение вашего **идентификатора клиента**. Это уникальный GUID, идентифицирующий ваш клиент. Он позволяет указать, что сертификат используется только для вашего клиента.
6. Azure AD хранит открытый ключ агента аутентификации в базе данных Azure SQL, к которой имеет доступ только Azure AD.
7. Сертификат (выданный на шаге 5) хранится на локальном сервере в **хранилище сертификатов Windows** (а именно в расположении **[CERT_SYSTEM_STORE_LOCAL_MACHINE](https://msdn.microsoft.com/library/windows/desktop/aa388136.aspx#CERT_SYSTEM_STORE_LOCAL_MACHINE)**) и используется приложениями агента аутентификации и Updater.

### <a name="authentication-agent-initialization"></a>Инициализация агента аутентификации

При запуске агенту аутентификации (в первый раз после регистрации или после перезапуска сервера) нужен способ, позволяющий безопасно взаимодействовать со службой Azure AD и начать принимать запросы на проверку пароля.

![Инициализация агента](./media/active-directory-aadconnect-pass-through-authentication-security-deep-dive/pta2.png)

Ниже описывается, как инициализируется агент аутентификации.



1. Сначала агент аутентификации создает исходящий запрос на начальную загрузку к Azure AD. 
    - Этот запрос на начальную загрузку передается через порт 443 и канал HTTPS с взаимной аутентификацией (с использованием сертификата, выданного во время регистрации агента аутентификации).
2. Azure AD отвечает на запрос на начальную загрузку, передавая в очередь служебной шины Azure **ключ доступа**, который является уникальным для вашего клиента (он определяется идентификатором клиента).
3. Агент аутентификации создает постоянное исходящее HTTPS-подключение (через порт 443) к очереди. 
    - Теперь все готово к получению и обработке запросов на проверку пароля.

Если в клиенте зарегистрировано несколько агентов аутентификации, то процедура инициализации гарантирует, что каждый из них подключается к одной и той же очереди служебной шины Azure. 

## <a name="processing-sign-in-requests"></a>Обработка запросов на вход 

На приведенной ниже схеме показано, как обрабатываются запросы на вход пользователей при сквозной аутентификации.

![Обработка операций входа](./media/active-directory-aadconnect-pass-through-authentication-security-deep-dive/pta3.png)

Служба сквозной аутентификации обрабатывает запрос вход пользователя следующим образом. 

1. Пользователь пытается получить доступ к приложению (например, Outlook Web App — [https://outlook.office365.com/owa](https://outlook.office365.com/owa)).
2. Если пользователь еще не выполнил вход, приложение перенаправляет браузер на страницу входа Azure AD.
3. Служба токенов безопасности Azure AD отвечает, предоставляя пользователю страницу входа в систему.
4. Пользователь вводит имя пользователя и пароль на странице входа в Azure AD и нажимает кнопку "Вход".
5. Имя пользователя и пароль отправляются в службу токенов безопасности Azure AD в HTTPS-запросе POST.
6. Служба токенов безопасности Azure AD извлекает открытые ключи для всех агентов аутентификации, зарегистрированных в вашем клиенте, из базы данных Azure SQL и с их помощью шифрует пароль. 
    - Она создает N значений зашифрованного пароля для N агентов аутентификации, зарегистрированных в клиенте.
7. Служба токенов безопасности Azure AD помещает запрос на проверку пароля (имя пользователя и зашифрованные значения пароля) в очередь служебной шины Azure для вашего клиента.
8. Так как инициализированные агенты аутентификации постоянно подключены к очереди служебной шины Azure, один из доступных агентов аутентификации получает запрос на проверку пароля.
9. Он находит зашифрованное значение пароля, относящиеся к его открытому ключу (с помощью идентификатора), и расшифровывает его с помощью своего закрытого ключа.
10. Агент аутентификации пытается проверить имя пользователя и пароль в локальной среде Active Directory с помощью **[Win32 LogonUser API](https://msdn.microsoft.com/library/windows/desktop/aa378184.aspx)** (при этом для параметра **dwLogonType** задано значение **LOGON32_LOGON_NETWORK**). 
    - Этот же API используется службами федерации Active Directory (AD FS) для выполнения входа пользователей в сценарии федеративного входа в систему.
    - Поиск контроллера домена выполняется в рамках от стандартного процесса разрешения в Windows Server.
11. Агент аутентификации получает результат от службы Active Directory (проверка прошла успешно, неправильное имя пользователя или пароль, срок действия пароля истек, пользователь заблокирован и так далее).
12. Агент аутентификации пересылает результат обратно в службу токенов безопасности Azure AD через исходящий канал HTTPS с взаимной аутентификацией, используя порт 443. Для взаимной аутентификации используется сертификат, который был выдан этому агенту аутентификации ранее, во время регистрации.
13. Служба токенов безопасности Azure AD проверяет, соответствует ли этот результат конкретному запросу на вход в клиент.
14. Служба токенов безопасности Azure AD продолжает процедуру входа в соответствии с настройками. Например, при успешной проверке пароля пользователь может перейти к прохождению Многофакторной идентификации или может быть перенаправлен к приложению.

## <a name="operational-security-of-authentication-agents"></a>Безопасность операций агентов аутентификации

Для обеспечения операционной безопасности сквозной аутентификации Azure AD периодически обновляет свои сертификаты. Эти обновления активируются Azure AD и не управляются агентами аутентификации.

![Операционная безопасность](./media/active-directory-aadconnect-pass-through-authentication-security-deep-dive/pta4.png)

Ниже описывается, как агент аутентификации обновляет отношение доверия с Azure AD.

1. Агент аутентификации периодически проверяет связь с Azure AD (каждые несколько часов), чтобы узнать, не пришло ли время обновить сертификат. 
    - Эта проверка выполняется через канал HTTPS со взаимной аутентификацией (с помощью сертификата, выданного во время регистрации).
2. Если служба указывает, что пора выполнить обновления, агент аутентификации создает новую пару открытого и закрытого ключей.
    - Эти ключи создаются с использованием стандартного **2048-разрядного шифрования RSA**.
    - Закрытый ключ никогда не покидает локальный сервер.
3. Затем агент аутентификации выполняет запрос на обновление сертификата к Azure AD по протоколу HTTPS. Этот запрос содержит следующие компоненты:
    - Существующий сертификат (извлеченный из расположения **CERT_SYSTEM_STORE_LOCAL_MACHINE** в хранилище сертификатов Windows). В этой процедуре не участвует глобальный администратор, следовательно, для нее не требуется маркер доступа от имени глобального администратора.
    - Открытый ключ, созданный на шаге 2;
    - **Запрос на подписывание сертификата** (CSR или запрос на сертификат). Это необходимо, чтобы запросить новый цифровой сертификат удостоверения, центром сертификации которого является Azure AD.
4. Azure AD проверяет существующий сертификат в запросе на обновление сертификата. Затем он определяет, поступил ли запрос от агента аутентификации, зарегистрированного в клиенте.
5. Если существующий сертификат все еще действителен, то Azure AD подписывает новый цифровой сертификат удостоверения и выдает его агенту аутентификации. 
6. Если срок действия существующего сертификата истек, Azure AD удаляет агент аутентификации из списка зарегистрированных агентов аутентификации клиента. После этого глобальный администратор должен вручную установить и зарегистрировать новый агент аутентификации.
    - Сертификат подписывается с помощью **корневого центра сертификации (ЦС) Azure AD**.
    - Субъект сертификата (**различающееся имя**) имеет значение вашего **идентификатора клиента**. Это глобальный уникальный идентификатор (GUID), который однозначно идентифицирует ваш клиент. То есть сертификат предназначен только для вашего клиента.
6. Служба Azure AD сохраняет новый открытый ключ агента аутентификации в базе данных Azure SQL, к которой имеет доступ только она. Затем она проверяет старый открытый ключ, связанный с агентом аутентификации.
7. Новый сертификат (который был выдан на шаге 5) сохраняется на сервере в **хранилище сертификатов Windows** (в расположении **[CERT_SYSTEM_STORE_CURRENT_USER](https://msdn.microsoft.com/library/windows/desktop/aa388136.aspx#CERT_SYSTEM_STORE_CURRENT_USER)**).
    - Так как процедура обновления отношения доверия выполняется не в интерактивном режиме (без участия глобального администратора), агент аутентификации больше не имеет доступа для обновления существующего сертификата в расположении **CERT_SYSTEM_STORE_LOCAL_MACHINE**. Обратите внимание на то, что сам сертификат в расположении **CERT_SYSTEM_STORE_LOCAL_MACHINE** при выполнении этой процедуры не удаляется.
8. С этого момента для аутентификации используется новый сертификат. При каждом последующем обновлении сертификат в расположении **CERT_SYSTEM_STORE_LOCAL_MACHINE** заменяется новым.

## <a name="auto-update-of-authentication-agents"></a>Автоматическое обновление агентов аутентификации

Приложение Updater автоматически обновляет агент аутентификации при выпуске новой версии. Это приложение не обрабатывает запросы на проверку пароля для вашего клиента. 

Azure AD размещает новую версию программного обеспечения как подписанный **пакет установщика Windows (MSI-файл)**. MSI-файл подписывается с помощью [Microsoft Authenticode](https://msdn.microsoft.com/library/ms537359.aspx) с использованием алгоритма хэш-кода **SHA256**. 

![Автоматическое обновление](./media/active-directory-aadconnect-pass-through-authentication-security-deep-dive/pta5.png)

Ниже описывается, как происходит автоматическое обновление агента аутентификации.

1. Приложение Updater периодически проверяет связь с Azure AD (каждый час), чтобы узнать, не выпущена ли новая версия агента аутентификации. 
    - Эта проверка выполняется через канал HTTPS со взаимной аутентификацией (с помощью сертификата, выданного во время регистрации). Агент аутентификации и Updater совместно используют сертификат, хранимый на сервере.
2. Если доступна новая версия, Azure AD возвращает Updater подписанный MSI-файл.
3. Приложение Updater проверяет, подписан ли этот MSI-файл корпорацией Майкрософт.
4. Затем Updater выполняет данный MSI-файл. При этом выполняются следующие действия (обратите внимание на то, что Updater выполняется привилегиями [локальной системы](https://msdn.microsoft.com/library/windows/desktop/ms684190.aspx)):
    - Останавливается служба агента аутентификации.
    - На сервер устанавливается новая версия агента аутентификации.
    - Служба агента аутентификации перезапускается.

>[!NOTE]
>Если в клиенте зарегистрировано несколько агентов аутентификации, то Azure AD не выполняет одновременное обновление этих агентов или их сертификатов. Вместо этого Azure AD выполняет обновление постепенно, чтобы обеспечить высокий уровень доступности запросов на вход.


## <a name="next-steps"></a>Дальнейшие действия
- [**Текущие ограничения**](active-directory-aadconnect-pass-through-authentication-current-limitations.md). Сведения о том, какие сценарии поддерживаются, а какие нет.
- [**Краткое руководство по сквозной проверке подлинности Azure Active Directory**](active-directory-aadconnect-pass-through-authentication-quick-start.md). Настройка и подготовка к работе сквозной проверки подлинности Azure Active Directory.
- [**Интеллектуальная блокировка**](active-directory-aadconnect-pass-through-authentication-smart-lockout.md). Настройте возможность интеллектуальной блокировки на клиенте для защиты учетных записей пользователей.
- [**Принцип работы**](active-directory-aadconnect-pass-through-authentication-how-it-works.md). Изучите основные принципы работы сквозной аутентификации Azure AD.
- [**Часто задаваемые вопросы**](active-directory-aadconnect-pass-through-authentication-faq.md). Ответы на часто задаваемые вопросы.
- [**Устранение неполадок**](active-directory-aadconnect-troubleshoot-pass-through-authentication.md). Узнайте, как устранить самые распространенные проблемы с этой функцией.
- [**Простой единый вход Azure Active Directory**](active-directory-aadconnect-sso.md). Дополнительные сведения об этой дополнительной функции.

