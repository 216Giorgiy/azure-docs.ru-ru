---
title: "Функция единого входа Azure AD Connect | Документация Майкрософт"
description: "В этой статье содержатся сведения о возможностях единого входа из локальной службы Active Directory (AD) в облачную службу Azure Active Directory (Azure AD) и подключенные службы."
services: active-directory
keywords: "что такое Azure AD Connect, установка Active Directory, необходимые компоненты для Azure AD, единый вход"
documentationcenter: 
author: billmath
manager: femila
ms.assetid: 9f994aca-6088-40f5-b2cc-c753a4f41da7
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/15/2017
ms.author: billmath
translationtype: Human Translation
ms.sourcegitcommit: e208b2bf861d698901b287458a3969e833540e44
ms.openlocfilehash: f8f67af3cb6adb333924714bd758609b950845af
ms.lasthandoff: 02/17/2017

---

# <a name="what-is-single-sign-on-sso-preview"></a>Общие сведения о функции единого входа (предварительная версия)
Единый вход — это функция в Azure Active Directory Connect, реализующаяся совместно с [синхронизацией паролей](active-directory-aadconnectsync-implement-password-synchronization.md) или [сквозной проверкой подлинности](active-directory-aadconnect-pass-through-authentication.md). Если эта функция включена, то при входе в Azure Active Directory (Azure AD) или другие облачные службы с корпоративных или подключенных к корпоративной сети компьютеров пользователи должны только ввести свои имена пользователей и не должны вводить пароли.

![Единый вход](./media/active-directory-aadconnect-sso/sso1.png)

Поддержка функции единого входа обеспечивает более удобный доступ пользователей к облачным службам, а также предоставляет возможность легко и безопасно входить в корпоративную среду, не используя какие-либо дополнительные локальные компоненты.

Функцию единого входа можно включить в Azure AD Connect. Она работает с локальной службой Active Directory и поддерживает синхронизацию паролей и сквозную проверку подлинности. Чтобы реализовать единый вход в своей среде, убедитесь в следующем:

- конечные пользователи работают на компьютерах, присоединенных к домену;
- они имеют прямое подключение к контроллеру домена (например, в корпоративной проводной (беспроводной) сети или через подключение удаленного доступа, например VPN-подключение);
- вы определили конечные точки Kerberos в облаке как часть зоны интрасети браузера.

Если любое из этих требований не выполнено (например, если компьютер находится вне корпоративной сети), то при входе в систему пользователю просто предлагается ввести пароль. Это означает, что единый вход отключен.

## <a name="supported-clients"></a>Поддерживаемые клиенты
Функция единого входа доступна в клиентах на основе веб-браузера и клиентах Office, поддерживающих [современные методы аутентификации](https://aka.ms/modernauthga) на компьютерах с поддержкой проверки подлинности Kerberos, например компьютерах Windows. В таблице ниже приведены сведения о клиентах на основе веб-браузера в разных операционных системах.

| Операционная система и браузер |Internet Explorer|Chrome|Firefox|Edge
| --- | --- |--- | --- | --- |
|Windows 10|Да|Да|Да*|Нет
|Windows 8.1|Да|Да|Да*|Недоступно
|Windows 8|Да|Да|Да*|Недоступно
|Windows 7|Да|Да|Да*|Недоступно
|Mac|Недоступно|Недоступно|Недоступно|Недоступно

\*Требуется отдельная настройка.

>[!NOTE]
>Чтобы упростить доступ к Azure AD, мы рекомендуем использовать на клиентах с Windows 10 функцию [присоединения к Azure AD](../active-directory-azureadjoin-overview.md).

## <a name="how-single-sign-on-works"></a>Принцип работы единого входа

При включении единого входа в Azure AD Connect в локальной службе Active Directory создается учетная запись компьютера с именем AZUREADSSOACCT. Затем этой службе предоставляется ключ расшифровки Kerberos. Кроме того, создается два имени субъектов-служб (SPN) Kerberos, представляющих URL-адреса, используемые при проверке подлинности между клиентом и Azure AD.

После настройки процедура проверки подлинности ничем не отличается от такой же процедуры в любом другом приложении со встроенной проверкой подлинности Windows (IWA). Если вы знакомы с принципами работы встроенной проверки подлинности Windows (IWA), то вы уже знаете, как работает единый вход в Azure AD. Если не знакомы — этот процесс выглядит следующим образом.

![Единый вход](./media/active-directory-aadconnect-sso/sso2.png)

Сначала пользователь пытается получить доступ к ресурсу, который доверяет маркерам, выданным из Azure AD, например SharePoint Online. SharePoint Online перенаправляет пользователя для прохождения аутентификации в Azure AD. Затем пользователь предоставляет свое имя пользователя, чтобы служба Azure AD могла установить, включен ли единый вход для организации. Если в организации включен единый вход, то происходит следующее.

1.    Azure AD запрашивает от клиента билет Kerberos (возвращается ответ 401, "Нет доступа").
2.    Клиент запрашивает билет от Active Directory для Azure AD.
3.    Active Directory находит учетную запись компьютера, созданную Azure AD Connect, и возвращает клиенту билет Kerberos, зашифрованный с использованием секрета учетной записи компьютера. Этот билет содержит идентификатор пользователя, выполнившего вход в систему компьютера.
4.    Клиент отправляет билет Kerberos, полученный от Active Directory, в Azure AD.
5.    Azure AD расшифровывает билет Kerberos с использованием полученного ранее ключа. Затем либо возвращает маркер пользователю, либо запрашивает дополнительные удостоверения, например Многофакторную идентификацию, согласно требованиям ресурса.

Единый вход — ситуативно-обусловленная функция. Это значит, что если в ней происходит сбой, то пользователь, как обычно, должен просто ввести пароль на странице входа.

## <a name="single-sign-on-sso-prerequisites"></a>Предварительные требования для единого входа (SSO)
Если вы включаете функцию единого входа со сквозной аутентификацией и все предварительные требования для сквозной аутентификации выполнены, то больше ничего не требуется.

Если вы включаете функцию единого входа с синхронизацией паролей, и между Azure AD Connect и Azure AD есть брандмауэр, то убедитесь в следующем:
- Сервер Azure AD Connect может взаимодействовать с *.msappproxy.net.
- Azure AD Connect может выполнять HTTPS-запросы к Azure AD через перечисленные ниже порты.

|Протокол|Номер порта|Описание
| --- | --- | ---
|HTTPS|9090|    Включение регистрации SSO (требуется только для процесса регистрации SSO).

## <a name="enabling-sso-with-pass-through-authentication-or-password-sync"></a>Включение единого входа с возможностями синхронизации паролей или сквозной проверки подлинности
Процесс включения единого входа с возможностями синхронизации паролей или сквозной проверки подлинности в Azure AD Connect очень простой. Необходимы права администратора домена для доступа к одному из доменов в каждом синхронизируемом лесу. Это позволит включить настройку имен субъектов-служб Kerberos в учетной записи компьютера. Имя пользователя и пароль не нужно сохранять в Azure AD Connect и Azure AD. Эти учетные данные используются только для этой операции.

При установке Azure AD Connect выберите выборочную установку, чтобы выбрать способ единого входа на странице входа в систему. Дополнительные сведения см. в статье [Выборочная установка Azure AD Connect](active-directory-aadconnect-get-started-custom.md).

![Единый вход](./media/active-directory-aadconnect-sso/sso3.png)

После включения единого входа выполните остальные указания мастера установки, пока не откроется страница единого входа.

![Единый вход](./media/active-directory-aadconnect-sso/sso4.png)

Для каждого указанного леса предоставьте соответствующие сведения об учетной записи. После этого единый вход для каталога Azure будет включен.

>[!NOTE]
>Служба Azure AD Connect должна иметь возможность взаимодействовать с \*.msappproxy.net через порт 9090 (TCP) для настройки единого входа. Открытие этого порта требуется только во время настройки и не используется во время аутентификации, выполняемой конечными пользователями.

## <a name="ensuring-clients-sign-in-automatically"></a>Проверка единого входа клиентов
По умолчанию браузеры не отправляют учетные данные на веб-серверы, если URL-адрес не находится в зоне интрасети. Как правило, браузер может вычислить необходимую зону по URL-адресу. Например, в случае с URL-адресом http://intranet/ браузер автоматически отправляет учетные данные, так как он сопоставляется с URL-адресом в зоне интрасети. Однако, если URL-адрес содержит точку, например http://intranet.contoso.com/, то компьютер не отправляет учетные данные автоматически и обрабатывает его как URL-адрес веб-сайта.

Так как URL-адреса, используемые для единого входа в Azure AD, содержат точку, то их нужно явным образом добавить в зону интрасети компьютера. В результате чего после входа пользователя в систему браузер автоматически отправляет в Azure AD его учетные данные в виде билета Kerberos. Самый простой способ добавить необходимые URL-адреса в зону интрасети — создать групповую политику в Active Directory.

1.    Откройте средства управления групповыми политиками.
2.    Измените групповую политику, которая применяется ко всем пользователям, например **политику домена по умолчанию**.
3.    Перейдите в раздел **Конфигурация пользователя\Административные шаблоны\Компоненты Windows\Internet Explorer\Панель управления браузером\Вкладка безопасности** и выберите **Список назначений зоны для веб-сайтов**.
![Единый вход](./media/active-directory-aadconnect-sso/sso6.png)  
4.    Включите политику и введите следующие значения и данные в диалоговом окне.  

        Значение: https://autologon.microsoftazuread-sso.com  
        Data 1  
        Значение: https://aadg.windows.net.nsatc.net  
        Data 1  
5.    Это должно выглядеть следующим образом:  
![Единый вход](./media/active-directory-aadconnect-sso/sso7.png)

6.    Нажмите кнопку **ОК**, затем нажмите кнопку **ОК** еще раз.

Теперь единый вход для пользователей настроен.

>[!NOTE]
>По умолчанию Chrome и Internet Explorer используют одинаковый набор доверенных URL-адресов сайтов. Если вы настроили для Chrome другие параметры, то эти сайты необходимо обновить отдельно.

## <a name="troubleshooting-single-sign-on-issues"></a>Устранение неполадок единого входа
Важно, чтобы клиент был должным образом настроен для единого входа. Для этого необходимо убедиться в следующем:

1.    И https://autologon.microsoftazuread-sso.com, и https://aadg.windows.net.nsatc.net определены в зоне интрасети.
2.    Рабочая станция присоединена к домену.
3.    Пользователь вошел в систему, используя учетную запись домена.
4.    Компьютер подключен к корпоративной сети.
5.    Время на компьютере синхронизировано с временем в Active Directory, и разница между правильным временем и временем контроллеров домена не превышает 5 минут.
6.    Очистите существующие билеты Kerberos клиентов, например выполнив из командной строки команду **klist purge**.

Выполнив указанные выше требования, просмотрите дополнительные сведения в журналах консоли браузера. Они находятся в средствах разработчика. Эти журналы помогают определить потенциальную проблему.

## <a name="event-log-entries"></a>Записи журнала событий
Если включен аудит неудач, то при каждом входе пользователя в систему с помощью единого входа в журнал событий контроллера домена добавляется запись. Эти события можно найти в журналах событий. Для этого выполните поиск событий безопасности 4769, связанных с учетной записью компьютера **AzureADSSOAcc$**. Чтобы найти все события безопасности, связанные с учетной записью компьютера, используйте следующий фильтр:

```
    <QueryList>
      <Query Id="0" Path="Security">
    <Select Path="Security">*[EventData[Data[@Name='ServiceName'] and (Data='AZUREADSSOACC$')]]</Select>
      </Query>
    </QueryList>
```

