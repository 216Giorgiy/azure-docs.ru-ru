---
title: "Azure AD Connect: сквозная аутентификация | Документация Майкрософт"
description: "В этой статье описывается сквозная аутентификация Azure Active Directory (Azure AD) и ее применение для входа в Azure AD путем проверки паролей пользователей в локальном каталоге Active Directory."
services: active-directory
keywords: "Что такое сквозная аутентификация Azure AD Connect, установка Active Directory, необходимые компоненты для Azure AD, единый вход"
documentationcenter: 
author: swkrish
manager: femila
ms.assetid: 9f994aca-6088-40f5-b2cc-c753a4f41da7
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/21/2017
ms.author: billmath
translationtype: Human Translation
ms.sourcegitcommit: 9eafbc2ffc3319cbca9d8933235f87964a98f588
ms.openlocfilehash: 0f54fb7d2d8cf010baf79409bc6a528d34982500
ms.lasthandoff: 04/22/2017

---

# <a name="configure-user-sign-in-with-azure-active-directory-pass-through-authentication"></a>Настройка входа пользователей с помощью сквозной аутентификации Azure Active Directory

## <a name="what-is-azure-active-directory-azure-ad-pass-through-authentication"></a>Что такое сквозная аутентификация Azure Active Directory (Azure AD)?

Для пользователей и организации удобно, когда пользователи могут использовать одни и те же учетные данные (пароли) для доступа к локальным ресурсам и облачным службам. Пользователям можно будет помнить на один пароль меньше. Это повышает удобство работы и снижает вероятность того, что пользователи забудут, как выполнять вход. А это, в свою очередь, уменьшает затраты на службу технической поддержки, так как проблемы, связанные с паролем, обычно отнимают больше всего ресурсов службы поддержки.

Многие организации используют [синхронизацию паролей Azure AD](active-directory-aadconnectsync-implement-password-synchronization.md). Это функция [Azure AD Connect](active-directory-aadconnect.md), позволяющая синхронизировать пароли пользователей в локальном каталоге Active Directory с Azure AD, чтобы обеспечить пользователям одинаковые учетные данные для локальных ресурсов и облачных служб. Однако другие организации требуют, чтобы пароли, даже в хэшированном виде, не покидали внутренних границ организации.

Сквозная аутентификация Azure AD обеспечивает простое решение для этих организаций. При входе пользователей в Azure AD она обеспечивает проверку паролей пользователей непосредственно в локальном каталоге Active Directory. Эта функция также обеспечивает следующие преимущества.

- Простота в использовании
  - Проверка паролей выполняется без необходимости в сложных локальных развертываниях или сетевой конфигурации.
  - Для нее используется только упрощенный локальный соединитель, который ожидает передачи данных и отвечает на запросы на проверку пароля.
  - Его можно настроить вместе с [Azure AD Connect](active-directory-aadconnect.md). Упрощенный локальный соединитель устанавливается на том же сервере, что и Azure AD Connect.
- Безопасность
  - Локальные пароли ни в каком виде не хранятся в облаке.
  - Упрощенный локальный соединитель устанавливает только исходящие подключения из вашей сети. Поэтому нет необходимости устанавливать соединитель в сети периметра.
  - Сквозная аутентификация интегрируется с Многофакторной идентификацией Azure.
- Надежность и масштабируемость
  - Дополнительные упрощенные локальные соединители можно установить на нескольких серверах, чтобы достичь высокого уровня доступности запросов на вход.

![Сквозная аутентификация Azure AD](./media/active-directory-aadconnect-pass-through-authentication/pta1.png)

Сочетая сквозную аутентификацию с функцией [простого единого входа](active-directory-aadconnect-sso.md), пользователи могут даже не вводить пароль для входа в Azure AD, когда они работают на компьютерах организации в корпоративной сети. Это настоящие возможности интеграции.

## <a name="whats-available-during-preview"></a>Что доступно на этапе предварительной версии?

>[!NOTE]
>Сквозная аутентификация Azure AD находится на этапе предварительной серии. Это бесплатный компонент, и для его использования не требуются платные выпуски Azure AD. 

На этапе предварительной версии полностью поддерживаются следующие сценарии.

- Все браузерные приложения.
- Клиентские приложения Office 365, поддерживающие [современную аутентификацию](https://aka.ms/modernauthga).

На этапе предварительной версии НЕ поддерживаются следующие сценарии.

- Клиентские приложения Office прежних версий и Exchange ActiveSync (т. е. собственные почтовые приложения на мобильных устройствах).
  - Организациям рекомендуется перейти на современные способы аутентификации, если это возможно. Это обеспечит поддержку сквозной аутентификации, но также поможет защитить удостоверения с помощью функций [условного доступа](../active-directory-conditional-access.md), таких как Многофакторная идентификация.
- Присоединение устройств Windows 10 к Azure AD.

>[!IMPORTANT]
>В качестве временного решения для сценариев, не поддерживаемых на данный момент для сквозной аутентификации (клиентских приложений Office прежних версий, Exchange ActiveSync и присоединения устройств Windows 10 к Azure AD), по умолчанию при включении сквозной аутентификации также включается синхронизация паролей. Синхронизация паролей выступает в качестве запасного варианта только для этих конкретных сценариев. Если она вам не требуется, можно отключить синхронизацию паролей на странице [Дополнительные возможности](active-directory-aadconnect-get-started-custom.md#optional-features) в Azure AD Connect.

## <a name="how-to-enable-azure-ad-pass-through-authentication"></a>Как включить сквозную аутентификацию Azure AD?

### <a name="pre-requisites"></a>Предварительные требования

Прежде чем включить сквозную аутентификацию Azure AD, необходимо установить определенные компоненты и выполнить требования, приведенные ниже:

- Клиент Azure AD, глобальным администратором которого являетесь вы.

>[!NOTE]
>Рекомендуется использовать облачную учетную запись глобального администратора, которая позволяет управлять конфигурацией клиента в случае сбоя или отсутствия доступа к локальным службам. Можно добавить облачную учетную запись глобального администратора, как показано [здесь](../active-directory-users-create-azure-portal.md).

- Azure AD Connect версии 1.1.484.0 или более поздней версии. Рекомендуется использовать [последнюю версию Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594).
- Сервер под управлением Windows Server 2012 R2 или более поздней версии для запуска Azure AD Connect.
  - Этот сервер должен быть членом того же леса AD, что и пользователи, пароли которых требуется проверять.
  - Обратите внимание на то, что соединитель устанавливается на том же сервере, что и Azure AD Connect.

>[!NOTE]
>Среды с несколькими лесами поддерживаются, если между лесами существуют отношения доверия и правильно настроена маршрутизация по суффиксу имени.

- Если требуется обеспечить высокий уровень доступности, потребуются дополнительные серверы под управлением Windows Server 2012 R2 или более поздней версии, чтобы установить изолированные соединители.
- Если между каким-либо соединителем и Azure AD настроен брандмауэр, выполните следующие действия.
    - Если включена фильтрация URL-адресов, убедитесь, что соединитель может взаимодействовать со следующими URL-адресами:
        -  \*.msappproxy.net;
        -  \*.servicebus.windows.net.
    - Кроме того, соединители устанавливают прямые IP-подключения к [диапазонам IP-адресов центра обработки данных Azure](https://www.microsoft.com/en-us/download/details.aspx?id=41653).
    - Убедитесь, что брандмауэр не выполняет проверку SSL, так как соединители используют сертификаты клиентов для взаимодействия с Azure AD.
    - Убедитесь, что соединители могут выполнять HTTPS-запросы (TCP) к Azure AD через порты 80 и 443.
      - Если брандмауэр применяет правила в соответствии с отправляющими трафик пользователями, откройте эти порты для трафика, поступающего от служб Windows, которые работают как сетевая служба.

>[!NOTE]
>Недавно мы внесли улучшения, уменьшающие количество портов, необходимых соединителям для взаимодействия с нашей службой. Если вы запускаете предыдущие версии Azure AD Connect и (или) изолированных соединителей, то следует держать открытыми следующие дополнительные порты: 5671, 8080, 9090, 9091, 9350, 9352, 10100 10120.

### <a name="enabling-azure-ad-pass-through-authentication"></a>Включение сквозной аутентификации Azure AD

Сквозную аутентификацию Azure AD можно включить в Azure AD Connect.

В случае выполнения новой установки Azure AD Connect выберите [пользовательский путь установки](active-directory-aadconnect-get-started-custom.md). На странице "Вход пользователя" выберите "Сквозная проверка подлинности". После успешного завершения на том же сервере, где находится Azure AD Connect, будет установлен соединитель сквозной аутентификации. Кроме того, будет включена функция сквозной аутентификации на клиенте.

![Azure AD Connect: страница "Вход пользователя"](./media/active-directory-aadconnect-sso/sso3.png)

Если уже имеется установленный экземпляр Azure AD Connect, воспользуйтесь функцией [экспресс-установки](active-directory-aadconnect-get-started-express.md) или укажите [настраиваемый путь установки](active-directory-aadconnect-get-started-custom.md) в программе установки, выберите страницу "Смена имени пользователя для входа" в Azure AD Connect и нажмите кнопку "Далее". Выберите "Сквозная проверка подлинности", чтобы установить соединитель сквозной аутентификации на том же сервере, где установлен экземпляр Azure AD Connect, и включить эту функцию на клиенте.

![Azure AD Connect: страница "Смена имени пользователя для входа"](./media/active-directory-aadconnect-user-signin/changeusersignin.png)

>[!IMPORTANT]
>Сквозная аутентификация Azure AD — функция уровня клиента. Она влияет на вход пользователей во всех управляемых доменах в клиенте. Тем не менее пользователи из федеративных доменов будут по-прежнему входить с помощью служб федерации Active Directory (ADFS) или любого другого поставщика служб федерации, настроенного ранее. При преобразовании федеративного домена в управляемый домен все пользователи в этом домене автоматически начинают использовать вход с помощью сквозной аутентификации. Сквозная аутентификация не затрагивает облачных пользователей.

### <a name="ensuring-high-availability"></a>Обеспечение высокого уровня доступности

Если вы планируете использовать сквозную аутентификацию в рабочем развертывании, настоятельно рекомендуется установить на отдельном сервере (отличном от сервера, на котором выполняется Azure AD Connect и первый соединитель) второй соединитель для обеспечения высокого уровня доступности запросов на вход. Можно установить столько дополнительных соединителей, сколько необходимо. Их число должно соответствовать пиковому и среднему количествам запросов на вход, обрабатываемых вашим клиентом.

Чтобы развернуть изолированный соединитель, выполните приведенные ниже инструкции.

#### <a name="step-1-download-and-install-the-connector"></a>Шаг 1. Скачивание и установка соединителя

На этом шаге следует скачать и установить программное обеспечение соединителя на сервере.

1.    [Скачайте](https://go.microsoft.com/fwlink/?linkid=837580) последнюю версию соединителя.
2.    Запустите командную строку от имени администратора.
3.    Выполните следующую команду (/q означает, что установка осуществляется в автоматическом режиме и вам не предлагается принять лицензионное соглашение).

`
AADApplicationProxyConnectorInstaller.exe REGISTERCONNECTOR="false" /q
`
>[!NOTE]
>Можно установить только один соединитель на сервер.

#### <a name="step-2-register-the-connector-with-azure-ad-for-pass-through-authentication"></a>Шаг 2. Регистрация соединителя в Azure AD для сквозной аутентификации

На этом шаге следует зарегистрировать установленный соединитель на сервере в нашей службе и разрешить ему получать запросы на вход.

1.    Откройте окно PowerShell от имени администратора.
2.    Перейдите к папке **C:\Program Files\Microsoft AAD App Proxy Connector** и запустите сценарий, как показано ниже. `.\RegisterConnector.ps1 -modulePath "C:\Program Files\Microsoft AAD App Proxy Connector\Modules\" -moduleName "AppProxyPSModule" -Feature PassthroughAuthentication`
3.    При появлении запроса введите учетные данные глобального администратора клиента Azure AD.

## <a name="how-does-azure-ad-pass-through-authentication-work"></a>Как работает сквозная аутентификация Azure AD?

Когда пользователь пытается войти в Azure AD (если в клиенте включена сквозная аутентификация), происходит следующее.

1. Пользователь вводит имя пользователя и пароль на странице входа в Azure AD. Наша служба помещает имя пользователя и пароль (зашифрованные с помощью открытого ключа) в очередь для проверки.
2. Один из доступных локальных соединителей выполняет исходящий вызов к очереди и получает имя пользователя и пароль.
3. Затем соединитель проверяет имя пользователя и пароль в Active Directory, используя стандартные интерфейсы API Windows (аналогичный механизм используют службы AD FS). Обратите внимание, что именем пользователя может быть локальное имя пользователя по умолчанию (обычно это userPrincipalName) или другой атрибут (известный как альтернативный идентификатор) в Azure AD Connect.
4. После этого локальный контроллер домена оценивает запрос и возвращает соединителю ответ об успешной или неудачной проверке.
5. Соединитель, в свою очередь, возвращает этот ответ в Azure AD.
6. Azure AD оценивает этот ответ и соответствующим образом отвечает пользователю. Например, выдает маркер приложению или запрашивает Многофакторную идентификацию.

Различные действия показаны на схеме ниже. Обратите внимание, что все запросы и ответы выполняются через канал HTTPS.

![Сквозная проверка подлинности](./media/active-directory-aadconnect-pass-through-authentication/pta2.png)

### <a name="note-about-password-writeback"></a>Примечание об обратной записи паролей

В случае, если вы настроили [обратную запись паролей](../active-directory-passwords-getting-started.md#enable-users-to-reset-or-change-their-ad-passwords) на клиенте и для конкретного пользователя, то когда пользователь будет выполнять вход с использованием сквозной аутентификации, он сможет изменить или сбросить пароль, как и раньше. Пароли будут записаны обратно в локальный каталог Active Directory, как ожидается.

Однако, если одно из этих условий не выполняется (обратная запись паролей не настроена на клиенте или пользователю не назначена действительная лицензия Azure AD), то пользователь не сможет обновить свой пароль в облаке, даже если срок действия пароля истек. Пользователь увидит сообщение: "Ваша организация запрещает обновлять пароль на этом сайте. Обновите пароль рекомендованным организацией способом или обратитесь за помощью к администратору".

## <a name="troubleshooting-pass-through-authentication"></a>Устранение неполадок сквозной проверки подлинности

Этот раздел поможет найти сведения об устранении некоторых распространенных проблем во время установки, регистрации или удаления соединителей сквозной аутентификации, устанавливаемых с помощью Azure AD Connect, или изолированных соединителей. А также проблем, возникающих во время включения и работы компонента на клиенте.

### <a name="issues-during-installation-of-connectors-either-via-azure-ad-connect-or-standalone"></a>Проблемы при установке соединителей, устанавливаемых с помощью Azure AD Connect, или изолированных соединителей

#### <a name="an-azure-ad-application-proxy-connector-already-exists"></a>Соединитель прокси приложения Azure AD уже установлен

Соединитель сквозной аутентификации невозможно установить на том же сервере, что соединитель [прокси приложения Azure AD](../../active-directory/active-directory-application-proxy-get-started.md). Потребуется установить соединитель сквозной аутентификации на отдельном сервере.

#### <a name="an-unexpected-error-occured"></a>Произошла непредвиденная ошибка

[Соберите журналы соединителя](#how-to-collect-pass-through-authentication-connector-logs?) на сервере и обратитесь в службу поддержки Майкрософт с этой проблемой.

### <a name="issues-during-registration-of-connectors"></a>Проблемы во время регистрации соединителей

#### <a name="registration-of-the-connecter-failed-due-to-blocked-ports"></a>Зарегистрировать соединитель не удалось из-за заблокированных портов

Убедитесь, что сервер, на котором установлен соединитель, может взаимодействовать с URL-адресами и портами нашей службы, перечисленными [здесь](#pre-requisites).

#### <a name="an-unexpected-error-occurred"></a>Произошла непредвиденная ошибка

[Соберите журналы соединителя](#how-to-collect-pass-through-authentication-connector-logs?) на сервере и обратитесь в службу поддержки Майкрософт с этой проблемой.

### <a name="issues-during-un-installation-of-connectors"></a>Проблемы во время удаления соединителей

#### <a name="warning-message-when-un-installing-azure-ad-connect"></a>Предупреждение при удалении Azure AD Connect

Если вы включили сквозную аутентификацию на клиенте и пытаетесь удалить Azure AD Connect, появится следующее предупреждение: "Users will not be able to sign-in to Azure AD unless you have other pass-through authentication agents installed on other servers" (Пользователи не смогут войти в Azure AD, если на других серверах не установлены другие агенты сквозной аутентификации).

Необходимо установить [высокодоступную](#ensuring-high-availability) конфигурацию, прежде чем удалять Azure AD Connect, чтобы избежать нарушения входа пользователей.

### <a name="issues-with-enabling-the-pass-through-authentication-feature"></a>Проблемы при включении функции сквозной аутентификации

#### <a name="the-enabling-of-the-feature-failed-because-there-were-no-connectors-available"></a>Не удалось включить функцию из-за отсутствия доступных соединителей

Необходим хотя бы один активный сервер соединителя, чтобы включить сквозную аутентификацию на клиенте. Соединитель можно установить вместе с Azure AD Connect или как изолированный соединитель.

#### <a name="the-enabling-of-the-feature-failed-due-to-blocked-ports"></a>Не удалось включить функцию из-за заблокированных портов

Убедитесь, что сервер, на котором установлена служба Azure AD Connect, может взаимодействовать с URL-адресами и портами нашей службы, перечисленными [здесь](#pre-requisites).

### <a name="issues-while-operating-the-pass-through-authentication-feature"></a>Проблемы в работе функции сквозной аутентификации

#### <a name="user-facing-sign-in-errors"></a>Ошибки при входе пользователей

Функция выводит на экран входа в Azure AD следующие ошибки пользователей. Они подробно описаны ниже, как и соответствующие действия по устранению.

|Ошибка|Description (Описание)|Способы устранения:
| --- | --- | ---
|AADSTS80001|Не удалось подключиться к Active Directory|Убедитесь, что серверы соединителей являются членами того же леса, что и пользователи, чьи пароли должны быть проверены, и могут подключиться к Active Directory.  
|AADSTS8002|Истекло время ожидания подключения к Active Directory|Убедитесь, что служба Active Directory доступна и отвечает на запросы соединителей.
|AADSTS80004|Соединителю передано недопустимое имя пользователя|Убедитесь, что пользователь пытается войти в систему с правильным именем пользователя.
|AADSTS80005|При проверке было обнаружено непредсказуемое исключение WebException|Скорее всего, это временная ошибка. Повторите запрос. Если проблема не исчезла, обратитесь в службу поддержки Майкрософт.
|AADSTS80007|Произошла ошибка при взаимодействии с Active Directory|Проверьте журналы соединителя для получения дополнительных сведений и убедитесь, что Active Directory работает, как ожидалось.

### <a name="how-to-collect-pass-through-authentication-connector-logs"></a>Как собрать журналы соединителя сквозной аутентификации?

В зависимости от типа возникшей проблемы необходимо будет искать журналы соединителя сквозной аутентификации в разных расположениях.

#### <a name="connector-event-logs"></a>Журналы событий соединителя

Ошибки, связанные с соединителем, можно просмотреть в приложении "Просмотр событий" на сервере. Они находятся в папке **Application and Service Logs\Microsoft\AadApplicationProxy\Connector\Admin**.

Чтобы получить подробные журналы анализа и отладки, можно включить журнал "Сеанс". Не включайте этот журнал во время обычной работы соединителя. Используйте его только для устранения неполадок. Обратите внимание, что содержимое этого журнала отображаются только после его отключения.

#### <a name="detailed-trace-logs"></a>Подробные журналы трассировки

Чтобы устранить неполадки при входе пользователей, найдите журналы трассировки в папке **C:\Programdata\Microsoft\Microsoft AAD Application Proxy Connector\Trace**. В этих журналах содержатся причины сбоев, возникших при входе пользователей с помощью сквозной аутентификации. Ниже приведен пример записи журнала.

```
    ApplicationProxyConnectorService.exe Error: 0 : Passthrough Authentication request failed. RequestId: 'df63f4a4-68b9-44ae-8d81-6ad2d844d84e'. Reason: '1328'.
        ThreadId=5
        DateTime=xxxx-xx-xxTxx:xx:xx.xxxxxxZ
```

Описание ошибки (1328 в приведенном выше примере) можно получить, открыв окно командной строки и выполнив следующую команду. Примечание. Необходимо будет заменить число 1328 номером ошибки, который отображается в ваших журналах.

`Net helpmsg 1328`

Результат должен иметь следующий вид.

![Сквозная проверка подлинности](./media/active-directory-aadconnect-pass-through-authentication/pta3.png)

#### <a name="domain-controller-logs"></a>Журналы контроллеров домена

Если включено ведение журнала аудита, то дополнительные сведения можно найти в журналах безопасности контроллеров домена. Ниже показан простой способ извлечения запросов на вход, отправленных соединителями сквозной аутентификации.

```
    <QueryList>
    <Query Id="0" Path="Security">
    <Select Path="Security">*[EventData[Data[@Name='ProcessName'] and (Data='C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe')]]</Select>
    </Query>
    </QueryList>
```

## <a name="feedback"></a>Отзыв

Ваши отзывы очень важны для нас. Вы можете отправить нам сообщение на электронный адрес [aadopauthfeedback@microsoft.com](mailto:aadopauthfeedback@microsoft.com). Если вам требуются новые функции, напишите об этом на [форуме UserVoice форум](https://feedback.azure.com/forums/169401-azure-active-directory/category/160611-directory-synchronization-aad-connect). Мы открыты к предложениям.

