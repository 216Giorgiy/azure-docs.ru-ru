---
title: "Сквозная проверка подлинности в Azure AD Connect | Документация Майкрософт"
description: "В этой статье содержатся сведения о том, как сквозная проверка подлинности AD работает в локальной службе Active Directory (AD) для предоставления доступа к Azure Active Directory (Azure AD) и подключенным службам."
services: active-directory
keywords: "что такое Azure AD Connect, установка Active Directory, необходимые компоненты для Azure AD, единый вход"
documentationcenter: 
author: billmath
manager: femila
ms.assetid: 9f994aca-6088-40f5-b2cc-c753a4f41da7
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/08/2017
ms.author: billmath
translationtype: Human Translation
ms.sourcegitcommit: 67b832253619afe789a4dfdb95893e8c0ae62bee
ms.openlocfilehash: 17890fddf948ddc0e89a9107ac5fe65223cd05e1

---

# <a name="what-is-azure-ad-pass-through-authentication"></a>Сквозная проверка подлинности Azure AD
Благодаря использованию одинаковых учетных данных (имени пользователя и пароля) для доступа к корпоративным ресурсам и облачным службам пользователям не нужно запоминать различные учетные данные. Это снижает вероятность того, что они забудут, как выполнить вход. Кроме того, это уменьшает частоту обращений в службу технической поддержки для сброса пароля.

Хотя многим организациям удобно использовать [синхронизацию паролей](active-directory-aadconnectsync-implement-password-synchronization.md) Azure AD, чтобы предоставлять пользователям один набор учетных данных для доступа к локальным и облачным службам, некоторым компаниям нужно, чтобы пароли, даже в хэшированном виде, не использовались за пределами организации.

Сквозная проверка подлинности Azure AD обеспечивает простое решение для этих клиентов. Это гарантирует выполнение проверки паролей для служб Azure AD в локальной службе Active Directory. При этом не требуется сложная сетевая инфраструктура, а локальные пароли не нужно хранить в облаке в каком-либо виде.

В сочетании с параметром [Единый вход](active-directory-aadconnect-sso.md) пользователи не должны вводить пароль для входа в Azure AD или другие облачные службы. Благодаря этой функции клиенты имеют на своих корпоративных компьютерах по-настоящему интегрированный интерфейс.

![Сквозная проверка подлинности](./media/active-directory-aadconnect-pass-through-authentication/pta1.png)

Сквозную проверку подлинности можно настроить с помощью службы Azure AD Connect. Она работает с использованием простого локального агента, который прослушивает запросы на проверку пароля. Этот агент можно легко развернуть на нескольких компьютерах, чтобы обеспечить высокий уровень доступности и балансировку нагрузки. Так как весь обмен данными только исходящий, необходимость в настройке сети периметра и установке в ней соединителя отпадает. Компьютер для соединителя должен соответствовать следующим требованиям:

- на нем установлена Windows Server 2012 R2 или более поздней версии;
- он присоединен к домену в лесу, в котором проверяются пользователи.

>[!NOTE]
>Среда с несколькими лесами может поддерживаться, если между лесами существуют отношения доверия и маршрутизация суффикса имени правильно настроена.

## <a name="supported-clients-in-the-preview"></a>Поддерживаемые клиенты в предварительной версии
Сквозная проверка подлинности доступна в клиентах на основе веб-браузера и клиентах Office, поддерживающих [современные методы аутентификации](https://aka.ms/modernauthga). При использовании клиентов, которые не поддерживаются, таких как устаревшие клиенты Office и Exchange Active Sync (т. е. встроенные почтовые клиенты на мобильных устройствах), пользователям необходимо применять современные методы аутентификации. Эти пользователи могут применять не только сквозную проверку подлинности, но и условный доступ, например Многофакторную идентификацию.

Для клиентов, использующих Windows 10 и присоединенных к Azure AD, сквозная проверка подлинности в настоящее время не поддерживается. Для Windows 10 можно использовать синхронизацию паролей в качестве автоматического переключения, как и для устаревших клиентов.

>[!NOTE]
>В период действия предварительной версии синхронизация паролей включена по умолчанию, если в качестве режима входа в Azure AD Connect выбрана сквозная проверка подлинности. Эту настройку можно отключить на странице параметров Azure AD Connect.

## <a name="how-azure-ad-pass-through-authentication-works"></a>Принцип работы сквозной проверки подлинности Azure AD
Когда пользователь вводит свои имя пользователя и пароль на странице входа в Azure AD, учетные данные попадают в соответствующую очередь локального соединителя для проверки. Затем один из доступных локальных соединителей получает имя пользователя и пароль для проверки в Active Directory. Проверка осуществляется через стандартные API Windows так же, как проверка пароля в службах федерации Active Directory.

Затем локальный контроллер домена оценивает запрос и возвращает ответ соединителю, который в свою очередь передает его в Azure AD. После этого Azure AD оценивает ответ и взаимодействует с пользователем соответствующим образом, например выдает маркер или запрашивает многофакторную идентификацию. Различные шаги показаны на этой схеме:

![Сквозная проверка подлинности](./media/active-directory-aadconnect-pass-through-authentication/pta2.png)

## <a name="azure-ad-pass-through-prerequisites"></a>Предварительные требования для сквозной проверки подлинности AD Azure
Прежде чем включить и использовать сквозную проверку подлинности Azure AD, необходимо установить некоторые компоненты и выполнить требования, приведенные ниже.

- Azure AD Connect
- Клиент Azure AD, глобальным администратором которого являетесь вы.

>[!NOTE]
>Рекомендуется использовать облачную учетную запись администратора. Это позволит управлять конфигурацией клиента в случае сбоя или отсутствия доступа к локальным службам.

- Сервер под управлением Windows Server 2012 R2 или более поздней версии для запуска Azure AD Connect. Этот компьютер должен быть участником того же леса, что и пользователи, которые прошли проверку.
- Если у вас есть несколько лесов, содержащих пользователей, проверенных с помощью Azure AD, то между этими лесами должны быть установлены доверительные отношения.
- Локальное имя UserPrincipalName должно использоваться как имя пользователя Azure AD.
- Второй сервер под управлением Windows Server 2012 R2 или более поздней версии, на котором будет выполняться второй соединитель для обеспечения высокой доступности и балансировки нагрузки. Ниже приведены инструкции по развертыванию этого соединителя.
- Если между соединителем и Azure AD есть брандмауэр, выполните следующие действия.
    - Если включена фильтрация URL-адресов, убедитесь, что соединитель может взаимодействовать со следующими URL-адресами:
        -  \*.msappproxy.net;
        -  \*.servicebus.windows.net;  
        -  соединитель также устанавливает соединение при прямых IP-подключениях к диапазонам [IP-адресов центра обработки данных Azure](https://www.microsoft.com/en-us/download/details.aspx?id=41653).
    - Убедитесь, что брандмауэр не выполняет проверку SSL, так как соединитель использует сертификаты клиентов для взаимодействия с Azure AD.
    - Убедитесь, что соединитель может выполнять запросы HTTPS (TCP) к Azure AD через перечисленные ниже порты.

|Номер порта|Описание
| --- | ---
|80|Разрешение исходящего трафика HTTP для проверки безопасности, например списки отзыва сертификатов SSL.
|443|    Включение проверки подлинности пользователей в Azure AD.
|8080/443|    Включение последовательности начальной загрузки соединителя и автоматического обновления соединителя.
|9090|    Регистрация соединителя (требуется только для процесса регистрации соединителя).
|9091|    Включение автоматического обновления сертификатов доверия соединителя.
|9352, 5671|    Включение связи между соединителем и службой Azure AD для входящих запросов.
|9350|    (Необязательно.) Повышение производительности для входящих запросов.
|10100–10120|    Разрешение отправки ответов от соединителя в Azure AD.

Если брандмауэр инициирует трафик в соответствии с отправляющими его пользователями, откройте эти порты для трафика, поступающего от служб Windows, которые работают как сетевая служба. Кроме того, не забудьте включить порт 8080 для NT AUTHORITY\SYSTEM.

## <a name="enabling-pass-through-authentication"></a>Включение сквозной проверки подлинности
Сквозная проверка подлинности Azure AD включается в Azure AD Connect. Включение сквозной проверки подлинности приводит к развертыванию первого соединителя на том же сервере, где находится Azure AD Connect. При установке Azure AD Connect выберите выборочную установку и сквозную проверку подлинности на странице параметров входа. Дополнительные сведения см. в статье [Выборочная установка Azure AD Connect](active-directory-aadconnect-get-started-custom.md).

![Единый вход](./media/active-directory-aadconnect-sso/sso3.png)

По умолчанию первый соединитель сквозной проверки подлинности устанавливается на сервере Azure AD Connect. Второй соединитель следует развернуть на другом компьютере, чтобы обеспечить высокий уровень доступности и балансировку нагрузки для запросов проверки подлинности.

Чтобы развернуть второй соединитель, выполните приведенные ниже инструкции.

### <a name="step-1-install-the-connector-without-registration"></a>Шаг 1. Установка соединителя без регистрации

1.    Скачайте последнюю версию [соединителя](https://go.microsoft.com/fwlink/?linkid=837580).
2.    Запустите командную строку от имени администратора.
3.    Выполните следующую команду, в которой /q означает, что установка осуществляется в автоматическом режиме и не предлагает принять лицензионное соглашение.

```
AADApplicationProxyConnectorInstaller.exe REGISTERCONNECTOR="false" /q
```

### <a name="step-2-register-the-connector-with-azure-ad-for-pass-through-authentication"></a>Шаг 2. Регистрация соединителя с помощью Azure AD для сквозной проверки подлинности

1.    Запустите окно PowerShell с правами администратора.
2.    Перейдите к папке **C:\Program Files\Microsoft AAD App Proxy Connector** и запустите сценарий.  
`.\RegisterConnector.ps1 -modulePath "C:\Program Files\Microsoft AAD App Proxy Connector\Modules\" -moduleName "AppProxyPSModule" -Feature PassthroughAuthentication`
3.    При появлении запроса введите учетные данные учетной записи администратора клиента Azure AD.

## <a name="troubleshooting-pass-through-authentication"></a>Устранение неполадок сквозной проверки подлинности
Есть несколько категорий проблем, которые могут возникнуть при устранении неполадок проверки подлинности. В зависимости от типа проблемы может потребоваться искать в нескольких местах.

Ошибки, связанные с соединителем, можно просмотреть в журнале событий компьютера с соединителем в папке **Application and Service Logs\Microsoft\AadApplicationProxy\Connector\Admin**. При необходимости доступны более подробные журналы. Можно просмотреть журналы аналитики и отладки, а также включить журнал сеансов соединителя. Обратите внимание, что не рекомендуется выполнять запуск с включенным журналом по умолчанию и содержимое отображается только после отключения журнала.

Дополнительные сведения можно также найти в журналах трассировки соединителя в папке **C:\Programdata\Microsoft\Microsoft AAD Application Proxy Connector\Trace**. В этих журналах также можно найти причину сбоя сквозной проверки подлинности для отдельного пользователя, как в следующей записи, которая содержит код ошибки 1328:

```
    ApplicationProxyConnectorService.exe Error: 0 : Passthrough Authentication request failed. RequestId: 'df63f4a4-68b9-44ae-8d81-6ad2d844d84e'. Reason: '1328'.
        ThreadId=5
        DateTime=xxxx-xx-xxTxx:xx:xx.xxxxxxZ
```

Сведения об ошибке можно получить, запустив командную строку и выполнив следующую команду (замените&1328; на номер ошибки в запросе):

`Net helpmsg 1328`

Результат выглядит примерно так:

![Сквозная проверка подлинности](./media/active-directory-aadconnect-pass-through-authentication/pta3.png)

Если включено ведение журнала аудита, то дополнительные сведения также можно найти в журналах безопасности контроллеров домена. Простой запрос для запросов проверки подлинности с помощью соединителя выглядит следующим образом:

```
    <QueryList>
    <Query Id="0" Path="Security">
    <Select Path="Security">*[EventData[Data[@Name='ProcessName'] and (Data='C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe')]]</Select>
    </Query>
    </QueryList>
```

Ниже приведены другие ошибки, которые появляются на экране входа Azure AD, а также соответствующие инструкции по их устранению.

|Ошибка|Description (Описание)|Способы устранения:
| --- | --- | ---
|AADSTS80001|Не удалось подключиться к Active Directory|Убедитесь, что компьютеры соединителя присоединены к домену и могут подключаться к Active Directory.  
|AADSTS8002|Истекло время ожидания подключения к Active Directory|Убедитесь, что Active Directory доступен и отвечает на запросы соединителя.
|AADSTS80004|Соединителю передано недопустимое имя пользователя|Убедитесь, что пользователь пытается войти в систему с правильным именем пользователя.
|AADSTS80005|При проверке было обнаружено непредсказуемое исключение WebException|Эта ошибка связана с временным сбоем. Повторите запрос. Если проблема не будет устранена, обратитесь в службу технической поддержки Майкрософт.
|AADSTS80007|Произошла ошибка при взаимодействии с Active Directory|Проверьте журналы соединителя для получения дополнительных сведений и убедитесь, что Active Directory работает, как ожидалось.



<!--HONumber=Jan17_HO5-->


