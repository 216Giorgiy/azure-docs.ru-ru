---
title: "Сквозная проверка подлинности в Azure AD Connect | Документация Майкрософт"
description: "В этой статье описывается сквозная аутентификация Azure Active Directory (Azure AD) и ее применение для входа в Azure AD c помощью проверки пользовательских паролей в локальном каталоге Active Directory."
services: active-directory
keywords: "Что такое сквозная аутентификация Azure AD Connect, установка Active Directory, необходимые компоненты для Azure AD, единый вход"
documentationcenter: 
author: swkrish
manager: femila
ms.assetid: 9f994aca-6088-40f5-b2cc-c753a4f41da7
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/09/2017
ms.author: billmath
ms.translationtype: Human Translation
ms.sourcegitcommit: fc4172b27b93a49c613eb915252895e845b96892
ms.openlocfilehash: 4fc3c822e657ce1a66a59e15c1a7d636a9f699e6
ms.contentlocale: ru-ru
ms.lasthandoff: 05/12/2017

---

# <a name="configure-user-sign-in-with-azure-active-directory-pass-through-authentication"></a>Настройка входа пользователей с помощью сквозной аутентификации Azure Active Directory

## <a name="what-is-azure-active-directory-pass-through-authentication"></a>Что такое сквозная аутентификация Azure Active Directory?

Предоставляя корпоративным пользователям возможность использования одних и тех же учетных данных (паролей) для доступа к локальным ресурсам и облачным службам, вы существенно облегчаете им работу. Ведь теперь пользователям не только не нужно будет запоминать на один пароль больше, но и держать в голове особенности процедуры входа. Кроме того, проблемы, связанные с использованием паролей, обычно отнимают больше всего ресурсов службы поддержки, и таким образом вы сможете сократить расходы на поддержку.

Многие организации используют [синхронизацию паролей Azure AD](active-directory-aadconnectsync-implement-password-synchronization.md). Это функция [Azure AD Connect](active-directory-aadconnect.md), которая позволяет синхронизировать хэши пользовательских паролей в локальном каталоге Azure Active Directory (Azure AD), что позволяет обеспечить пользователям одинаковые учетные данные для локальных ресурсов и облачных служб. Однако другие организации требуют, чтобы пароли, даже в хэшированном виде, не покидали внутренних границ организации.

Сквозная аутентификация Azure AD — это простое решение для таких организаций. При входе пользователей в Azure AD эта функция позволяет выполнять проверку паролей пользователей непосредственно в локальном каталоге Active Directory. Эта функция также обеспечивает следующие преимущества.

- Простота в использовании
  - Проверка паролей выполняется без необходимости в сложных локальных развертываниях или сетевой конфигурации.
  - Использование облегченного локального соединителя, который прослушивает запросы на проверку пароля и отвечает на них.
  - Локальный соединитель автоматически получает улучшения функций и исправления ошибок.
  - Его можно настроить вместе с [Azure AD Connect](active-directory-aadconnect.md). Упрощенный локальный соединитель устанавливается на том же сервере, что и Azure AD Connect.
- Безопасность
  - Локальные пароли ни в каком виде не хранятся в облаке.
  - Облегченный локальный соединитель устанавливает только исходящие подключения из вашей сети. Таким образом вам не нужно устанавливать соединитель в сети периметра.
  - Сквозная аутентификация интегрируется с Многофакторной идентификацией Azure.
- Надежность и масштабируемость
  - Дополнительные упрощенные локальные соединители можно установить на нескольких серверах, чтобы достичь высокого уровня доступности запросов на вход.

![Сквозная аутентификация Azure AD](./media/active-directory-aadconnect-pass-through-authentication/pta1.png)

Вы можете использовать сквозную проверку подлинности вместе с функцией [простого единого входа](active-directory-aadconnect-sso.md). Таким образом, когда пользователи работают на корпоративных компьютерах, входящих в корпоративную сеть, им даже не нужно вводить пароль для входа в Azure AD. Это и есть настоящая интеграция.

## <a name="whats-available-during-preview"></a>Что доступно на этапе предварительной версии?

>[!NOTE]
>Сквозная аутентификация Azure AD находится на этапе предварительной серии. Это бесплатная функция, и для ее использования не требуются платные выпуски Azure AD.

На этапе предварительной версии полностью поддерживаются следующие сценарии.

- Все браузерные приложения
- Клиентские приложения Office 365, поддерживающие [современные способы аутентификации](https://aka.ms/modernauthga).

На этапе предварительной версии _не_ поддерживаются следующие сценарии.

- Клиентские приложения Office прежних версий и Exchange ActiveSync (т. е. собственные почтовые приложения на мобильных устройствах). <br>Организациям рекомендуется перейти на современные способы аутентификации, если это возможно. Это обеспечит поддержку сквозной аутентификации, а также поможет защитить удостоверения с помощью таких функций [условного доступа](../active-directory-conditional-access.md), как многофакторная идентификация.
- Присоединение устройств Windows 10 к Azure AD.

>[!IMPORTANT]
>В качестве решения для сценариев, которые сейчас не поддерживаются функцией сквозной аутентификации (клиентские приложения Office прежних версий, Exchange ActiveSync и присоединение устройств Windows 10 к Azure AD), при включении сквозной аутентификации также по умолчанию включается синхронизация паролей. Синхронизация паролей используется в качестве запасного варианта только для указанных сценариев. Если эта функция вам не нужна, ее можно отключить на странице [дополнительных возможностей](active-directory-aadconnect-get-started-custom.md#optional-features) в мастере Azure AD Connect.

### <a name="prerequisites"></a>Предварительные требования

Прежде чем включить сквозную аутентификацию Azure AD, необходимо установить определенные компоненты и выполнить следующие требования:

- Клиент Azure AD, глобальным администратором которого являетесь вы.

  >[!NOTE]
  >Настоятельно рекомендуется, чтобы учетная запись глобального администратора была облачной. Таким образом, вы сможете управлять конфигурацией клиента, если работа локальных служб завершится сбоем или они станут недоступными. См. дополнительные сведения о [добавлении облачной учетной записи глобального администратора](../active-directory-users-create-azure-portal.md).

- Azure AD Connect версии не ниже 1.1.486.0. Рекомендуется использовать [последнюю версию Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594).
- Сервер под управлением Windows Server 2012 R2 или более поздней версии для запуска Azure AD Connect.
  - Этот сервер должен быть членом того же леса AD, что и пользователи, пароли которых требуется проверять.
  - Обратите внимание, что соединитель сквозной проверки подлинности устанавливается на том же сервере, что и Azure AD Connect. Версия соединителя должна быть не ниже 1.5.58.0.

    >[!NOTE]
    >Среды с несколькими лесами поддерживаются, если между лесами существуют отношения доверия и правильно настроена маршрутизация по суффиксу имени.

- Чтобы обеспечить высокий уровень доступности, вам понадобятся дополнительные серверы под управлением Windows Server 2012 R2 или более поздней версии, чтобы установить изолированные соединители. (Версия соединителя должна быть не ниже 1.5.58.0.)
- Если между любым соединителем и Azure AD настроен брандмауэр, сделайте следующее.
    - Если включена фильтрация URL-адресов, убедитесь, что соединитель может взаимодействовать со следующими URL-адресами:
        -  \*.msappproxy.net;
        -  \*.servicebus.windows.net.
    - Кроме того, соединители должны устанавливать прямые IP-подключения к [диапазонам IP-адресов центра обработки данных Azure](https://www.microsoft.com/en-us/download/details.aspx?id=41653).
    - Брандмауэр не должен выполнять проверку SSL, так как соединители используют сертификаты клиентов для взаимодействия с Azure AD.
    - Соединители должны выполнять исходящие запросы в Azure AD через порты 80 и 443.
      - Если брандмауэр применяет правила в соответствии с отправляющими трафик пользователями, откройте эти порты для трафика, поступающего от служб Windows, которые работают как сетевая служба.
      - HTTP-запросы, выполняемые соединителями через порт 80, требуются для скачивания списков отзыва SSL-сертификатов. Они также требуются для правильной работы автоматического обновления.
      - HTTP-запросы, выполняемые соединителями через порт 443, требуются для выполнения всех других операций, например включения и отключения функций, регистрации соединителей, скачивания обновлений соединителя и обработки всех запросов пользователя на вход.

     >[!NOTE]
     >Недавно мы внесли улучшения, уменьшающие количество портов, необходимых соединителям для взаимодействия с нашей службой. Если вы запускаете предыдущие версии Azure AD Connect и (или) изолированных соединителей, следует держать открытыми следующие дополнительные порты: 5671, 8080, 9090, 9091, 9350, 9352, 10100 10120.

### <a name="enable-azure-ad-pass-through-authentication"></a>Включение сквозной аутентификации Azure AD

Сквозную аутентификацию Azure AD можно включить в Azure AD Connect.

В случае выполнения новой установки Azure AD Connect выберите [пользовательский путь установки](active-directory-aadconnect-get-started-custom.md). На странице **Вход пользователя** выберите **Сквозная аутентификация**. После успешного завершения на том же сервере, где находится Azure AD Connect, будет установлен соединитель сквозной аутентификации. Кроме того, будет включена функция сквозной аутентификации на клиенте.

![Azure AD Connect: страница "Вход пользователя"](./media/active-directory-aadconnect-sso/sso3.png)

Если вы уже установили экземпляр Azure AD Connect, воспользуйтесь функцией [экспресс-установки](active-directory-aadconnect-get-started-express.md). Также можно указать [настраиваемый путь установки](active-directory-aadconnect-get-started-custom.md) в программе установки, выбрав страницу **Смена имени пользователя для входа** в Azure AD Connect и нажав кнопку **Далее**. Выберите **Сквозная аутентификация**, чтобы установить соединитель сквозной аутентификации на том же сервере, где установлен экземпляр Azure AD Connect, и включить эту функцию на клиенте.

![Azure AD Connect: страница "Смена имени пользователя для входа"](./media/active-directory-aadconnect-user-signin/changeusersignin.png)

>[!IMPORTANT]
>Сквозная аутентификация Azure AD — функция уровня клиента. Она влияет на вход пользователей во всех управляемых доменах в клиенте. Тем не менее пользователи из федеративных доменов будут по-прежнему входить с помощью служб федерации Active Directory (ADFS) или любого другого поставщика служб федерации, настроенного ранее. При преобразовании федеративного домена в управляемый домен все пользователи в этом домене автоматически начнут использовать вход с помощью сквозной аутентификации. Сквозная аутентификация не затрагивает облачных пользователей.

Если вы планируете использовать сквозную аутентификацию в рабочем развертывании, настоятельно рекомендуется установить второй соединитель на отдельном сервере (отличном от сервера, на котором выполняется Azure AD Connect и первый соединитель). Так вы сможете обеспечить высокую доступность запросов на вход. Можно установить столько дополнительных соединителей, сколько необходимо. Их число должно соответствовать пиковому и среднему числу запросов на вход, обрабатываемых вашим клиентом.

Чтобы развернуть изолированный соединитель, выполните следующие инструкции.

#### <a name="step-1-download-and-install-the-connector"></a>Шаг 1. Скачивание и установка соединителя

На этом шаге следует скачать и установить программное обеспечение соединителя на сервере.

1.    [Скачайте](https://go.microsoft.com/fwlink/?linkid=837580) последнюю версию соединителя. Версия соединителя должна быть не ниже 1.5.58.0.
2.    Запустите командную строку от имени администратора.
3.    Выполните следующую команду: Параметр **/q** означает, что установка осуществляется в автоматическом режиме, и вам не нужно принимать лицензионное соглашение: `
AADApplicationProxyConnectorInstaller.exe REGISTERCONNECTOR="false" /q
`.

>[!NOTE]
>Можно установить только один соединитель на сервер.

#### <a name="step-2-register-the-connector-with-azure-ad-for-pass-through-authentication"></a>Шаг 2. Регистрация соединителя в Azure AD для сквозной аутентификации

На этом шаге следует зарегистрировать установленный соединитель на сервере в нашей службе и разрешить ему получать запросы на вход.

1.    Откройте окно PowerShell от имени администратора.
2.    Перейдите к папке **C:\Program Files\Microsoft AAD App Proxy Connector** и запустите сценарий, как показано ниже. `.\RegisterConnector.ps1 -modulePath "C:\Program Files\Microsoft AAD App Proxy Connector\Modules\" -moduleName "AppProxyPSModule" -Feature PassthroughAuthentication`
3.    При появлении запроса введите учетные данные глобального администратора клиента Azure AD.

## <a name="how-does-azure-ad-pass-through-authentication-work"></a>Как работает сквозная аутентификация Azure AD?

Когда в клиенте включена сквозная аутентификация и пользователь пытается войти в Azure AD, происходит следующее.

1. Пользователь вводит имя пользователя и пароль на странице входа в Azure AD. Наша служба помещает имя пользователя и пароль (зашифрованные с помощью открытого ключа) в очередь для проверки.
2. Один из доступных локальных соединителей выполняет исходящий вызов к очереди и получает имя пользователя и пароль.
3. Затем соединитель проверяет имя пользователя и пароль в Active Directory, используя стандартные API-интерфейсы Windows (механизм, похожий на используемый службами AD FS). Обратите внимание, что именем пользователя может быть либо локальное имя пользователя по умолчанию (обычно это `userPrincipalName`), либо другой атрибут (известный как `Alternate ID`) в Azure AD Connect.
4. После этого локальный контроллер домена оценивает запрос и возвращает соединителю ответ об успешном или неудачном результате проверки.
5. Соединитель, в свою очередь, возвращает этот ответ в Azure AD.
6. Azure AD оценивает этот ответ и соответствующим образом отвечает пользователю. Например, выдает маркер приложению или запрашивает многофакторную идентификацию.

Шаги приведены на схеме ниже. Все запросы и ответы выполняются через канал HTTPS.

![Сквозная аутентификация](./media/active-directory-aadconnect-pass-through-authentication/pta2.png)

### <a name="password-writeback"></a>Обратная запись паролей

Если вы настроили [обратную запись паролей](../active-directory-passwords-update-your-own-password.md) на клиенте и для конкретного пользователя, выполняя вход с использованием сквозной аутентификации, пользователь сможет изменить или сбросить пароль, как и раньше. Пароли будут записаны обратно в локальный каталог Active Directory, как ожидается.

Но если одно из этих условий не выполняется (обратная запись паролей не настроена на клиенте или пользователю не назначена действительная лицензия Azure AD), пользователь не сможет обновить свой пароль в облаке, даже если срок действия пароля истек. Это актуально, даже если истек срок действия пароля. Пользователь увидит следующее сообщение: "Ваша организация запрещает обновлять пароль на этом сайте. Обновите пароль рекомендованным организацией способом или обратитесь за помощью к администратору".

## <a name="next-steps"></a>Дальнейшие действия
- См. инструкции по включению функции [простого единого входа Azure AD](active-directory-aadconnect-sso.md) на клиенте.
- Дополнительные сведения об устранении распространенных неполадок со сквозной аутентификацией Azure AD см. в [этом руководстве](active-directory-aadconnect-troubleshoot-pass-through-authentication.md).

## <a name="feedback"></a>Отзыв
Ваши отзывы очень важны для нас. Если у вас есть вопросы, задайте их в разделе комментариев. Новые функции можно запросить на [форуме UserVoice](https://feedback.azure.com/forums/169401-azure-active-directory/category/160611-directory-synchronization-aad-connect).


