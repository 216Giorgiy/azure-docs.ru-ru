<properties
	pageTitle="Устранение неполадок прокси-сервера приложений | Microsoft Azure"
	description="Способы устранения ошибок в прокси-сервере приложений Azure AD."
	services="active-directory"
	documentationCenter=""
	authors="kgremban"
	manager="femila"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/19/2016"
	ms.author="kgremban"/>



# Устранение неполадок прокси-сервера приложений

Если во время доступа к опубликованному приложению или публикации приложений возникают ошибки, проверьте следующие параметры, чтобы выяснить, правильно ли работает прокси-сервер приложений Microsoft Azure AD.

- Откройте консоль служб Windows и убедитесь, что служба **Соединитель прокси-сервера приложения Microsoft AAD** включена и работает. Вы также можете проверить страницу свойств службы прокси-сервера приложения, как показано на следующем рисунке: ![Снимок экрана свойств соединителя прокси-сервера приложений Microsoft AAD](./media/active-directory-application-proxy-troubleshoot/connectorproperties.png)

- Откройте средство просмотра событий и найдите события для соединителя прокси приложения в узле **Журналы приложений и служб** > **Microsoft** > **AadApplicationProxy** > **Соединитель** > **Администратор**.
- При необходимости доступны более подробные журналы, если включить журналы аналитики и отладки, а также журнал сеансов соединителя прокси-сервера приложения.

## Страница не отображается правильно

Даже если вы не получаете сообщения о конкретных ошибках, все равно возможны проблемы с отображением или работой приложения. Это может произойти если вы опубликовали путь к статье, но приложение требует содержимое, которое находится за пределами этого пути.

Например, если опубликован путь https://yourapp/app, но приложение вызывает изображения с адреса https://yourapp/media, они не будут отображены. Чтобы включить все соответствующее содержимое, обязательно публикуйте приложение, используя путь самого высокого уровня. В этом примере путь должен быть таким: http://yourapp/.

Если вы изменили путь, чтобы включить содержимое, на которое указывает ссылка, но при этом хотите перенаправлять пользователей по внутренней ссылке пути, см. инструкции в записи блога [Setting the right link for Application Proxy applications in the Azure AD access panel and Office 365 app launcher](https://blogs.technet.microsoft.com/applicationproxyblog/2016/04/06/setting-the-right-link-for-application-proxy-applications-in-the-azure-ad-access-panel-and-office-365-app-launcher/) (Настройка правильной ссылки на приложения прокси приложений на панели доступа Azure AD и в средстве запуска приложений Office 365).

## Общие ошибки

Ошибка | Description (Описание) | Способы устранения:
--- | --- | ---
К этому корпоративному приложению нет доступа. Вы не авторизованы для доступа к этому приложению. Ошибка авторизации. Не забудьте назначить пользователю доступ к этому приложению. | Возможно, вы не назначили пользователя для этого приложения. | Перейдите на вкладку **Приложение** и в разделе **Пользователи и группы** назначьте данного пользователя или группу пользователей для этого приложения.
К этому корпоративному приложению нет доступа. Вы не авторизованы для доступа к этому приложению. Ошибка авторизации. Убедитесь, что у пользователя есть лицензия на Azure Active Directory Premium или Basic. | Пользователь может получить такую ошибку при попытке доступа к опубликованному вами приложению, если администратор подписчика не назначил явно такому пользователю лицензию уровня "Премиум" или "Базовый". | Откройте вкладку **Лицензии** службы Active Directory подписчика и убедитесь, что этому пользователю или группе пользователей назначена лицензия Премиум или Базовая.


## Устранение неполадок соединителя
Если при установке мастера создания соединителя произойдет сбой регистрации, его причину можно проверить двумя способами. Вы можете просмотреть записи в журнале событий в разделе **Applications and Services Logs\\Microsoft\\AadApplicationProxy\\Connector\\Admin** или выполнить следующую команду Windows PowerShell.

    Get-EventLog application –source “Microsoft AAD Application Proxy Connector” –EntryType “Error” –Newest 1

| Ошибка | Описание | Способы устранения: |
| --- | --- | --- |
| Не удалось зарегистрировать соединитель: убедитесь, что включен прокси-сервер приложений на портале управления Azure и что имя пользователя и пароль Active Directory введены правильно. Ошибка: "Произошла одна или несколько ошибок". | Вы закрыли окно регистрации без выполнения входа в Azure AD. | Снова запустите мастер соединителя и зарегистрируйте соединитель. |
| Не удалось зарегистрировать соединитель: убедитесь, что включен прокси-сервер приложений на портале управления Azure и что имя пользователя и пароль Active Directory введены правильно. Ошибка: «AADSTS50001: ресурс `https://proxy.cloudwebappproxy.net /registerapp` отключен». | Прокси-сервер приложений отключен. | Не забудьте включить прокси-сервер приложений на классическом портале Azure, прежде чем пытаться зарегистрировать соединитель. Дополнительные сведения о включении прокси-сервера приложений см. в статье [Включение служб прокси-сервера приложений](active-directory-application-proxy-enable.md). |
| Не удалось зарегистрировать соединитель: убедитесь, что включен прокси-сервер приложений на портале управления Azure и что имя пользователя и пароль Active Directory введены правильно. Ошибка: "Произошла одна или несколько ошибок". | Если окно регистрации открывается, а затем немедленно закрывается, не позволяя выполнить вход, возможно, возникнет эта ошибка. Эта ошибка возникает при ошибках сетевого подключения в системе. | Убедитесь, что из браузера можно подключаться к общедоступному веб-сайту и что открыты порты, указанные в разделе [Предварительные требования к прокси-серверу приложений](active-directory-application-proxy-enable.md). |
| Не удалось зарегистрировать соединитель: убедитесь, что компьютер подключен к Интернету. Ошибка: «Прослушивание на `https://connector.msappproxy.net :9090/register/RegisterConnector` не выполняла ни одна конечная точка, которая могла бы принять сообщение». Среди прочих причин это могло быть вызвано неправильным адресом или действием SOAP. Дополнительные сведения см. в описании InnerException (если есть)". | Если при входе с использованием имени пользователя и пароля Azure AD вы видите эту ошибку, возможно, заблокированы все порты с номерами выше 8081. | Убедитесь, что необходимые порты открыты. Дополнительные сведения см. в разделе [Необходимые условия для прокси приложения](active-directory-application-proxy-enable.md). |
| В окне регистрации отображается чистая ошибка. Продолжить невозможно — можно только закрыть окно | Введено неправильное имя пользователя или пароль. | Повторите попытку. |
| Не удалось зарегистрировать соединитель: убедитесь, что включен прокси-сервер приложений на портале управления Azure и что имя пользователя и пароль Active Directory введены правильно. Ошибка: "AADSTS50059: не найдены идентификационные сведения о клиенте в запросе или в предоставленных учетных данных, а поиск URI субъекта-службы завершился ошибкой. | Вы пытаетесь выполнить вход с помощью учетной записи Майкрософт, а не домена, который является частью идентификатора организации в каталоге, к которому вы пытаетесь получить доступ. | Убедитесь, что администратор является частью того же имени домена, что и домен клиента, например, если домен Azure AD — contoso.com, администратором должен быть admin@contoso.com. |
| Не удалось получить текущую политику выполнения для запуска сценариев PowerShell | В случае сбоя установки соединителя проверьте, не отключена ли политика выполнения PowerShell. | Откройте редактор групповой политики. Последовательно выберите **Конфигурация компьютера** > **Административные шаблоны** > **Компоненты Windows** > **Windows PowerShell** и дважды щелкните пункт **Включить выполнение сценариев**. Возможные значения для этого параметра: **Не настроено** и **Включено**. Если установлено значение **Включено**, убедитесь, что в разделе "Параметры" для политики выполнения установлено значение **Разрешать локальные сценарии и удаленные подписанные сценарии** или **Разрешать все сценарии**. |
| Соединителю не удалось загрузить конфигурацию. | Истек срок действия сертификата клиента соединителя, который используется для проверки подлинности. Это также может произойти, если соединитель установлен за прокси-сервером. В этом случае у соединителя нет доступа к Интернету и он не может предоставлять приложения удаленным пользователям. | Обновите отношение доверия вручную с помощью командлета `Register-AppProxyConnector` в Windows PowerShell. Если соединитель находится за прокси-сервером, необходимо предоставить доступ к Интернету учетным записям соединителя (сетевые службы и локальная система). Для этого предоставьте им доступ к прокси-серверу или настройте их на обход прокси-сервера. |
| Не удалось зарегистрировать соединитель: чтобы зарегистрировать соединитель, вы должны быть глобальным администратором своей службы Active Directory. Ошибка: "Запрос на регистрацию отклонен". | Псевдоним, с помощью которого вы пытаетесь войти в систему, не является администратором в этом домене. Соединитель всегда устанавливается для каталога, которому принадлежит домен пользователя. | Убедитесь, что администратор, в качестве которого вы пытаетесь войти в систему, обладает глобальными разрешениями для клиента Azure AD.|


## Ошибки Kerberos

| Ошибка | Описание | Способы устранения: |
| --- | --- | --- |
| Не удалось получить текущую политику выполнения для запуска сценариев PowerShell | В случае сбоя установки соединителя проверьте, не отключена ли политика выполнения PowerShell. | Откройте редактор групповой политики. Последовательно выберите **Конфигурация компьютера** > **Административные шаблоны** > **Компоненты Windows** > **Windows PowerShell** и дважды щелкните пункт **Включить выполнение сценариев**. Возможные значения для этого параметра: **Не настроено** и **Включено**. Если установлено значение **Включено**, убедитесь, что в разделе "Параметры" для политики выполнения установлено значение **Разрешать локальные сценарии и удаленные подписанные сценарии** или **Разрешать все сценарии**. |
| 12008 — для Azure AD превышено максимальное количество попыток проверки подлинности Kerberos на внутреннем сервере. | Это событие может означать неправильную конфигурацию между Azure AD и внутренним сервером приложений или проблему в конфигурации даты и времени на обоих компьютерах. | Внутренний сервер отклонил билет Kerberos, созданный службой Azure AD. Проверьте правильность конфигурации Azure AD и сервера внутренних приложений. Убедитесь, что конфигурация даты и времени в Azure AD и на внутреннем сервере приложений синхронизирована. |
| 13016 — службе Azure AD не удается получить билет Kerberos от имени пользователя из-за отсутствия UPN в граничном маркере или файле cookie доступа. | Существует проблема с конфигурацией службы маркеров безопасности. | Исправьте конфигурацию утверждения UPN в службе маркеров безопасности. |
| 13019 — службе Azure AD не удается получить билет Kerberos от имени пользователя из-за следующей общей ошибки API. | Это событие может означать неправильную конфигурацию между Azure AD и сервером контроллера домена или проблему в конфигурации даты и времени на обоих компьютерах. | Контроллер домена отклонил билет Kerberos, созданный службой Azure AD. Проверьте правильность конфигурации Azure AD и сервера внутренних приложений, особенно конфигурацию имени субъекта-службы. Убедитесь, что служба Azure AD присоединена к тому же домену, что и контроллер домена, чтобы контроллер домена мог установить отношения доверия с Azure AD. Убедитесь, что конфигурация даты и времени в Azure AD и на контроллере домена синхронизирована. |
| 13020 — службе Azure AD не удается получить билет Kerberos от имени пользователя, так как имя субъекта-службы для внутреннего сервера не определено. | Это событие может означать неправильную конфигурацию между Azure AD и сервером контроллера домена или проблему в конфигурации даты и времени на обоих компьютерах. | Контроллер домена отклонил билет Kerberos, созданный службой Azure AD. Проверьте правильность конфигурации Azure AD и сервера внутренних приложений, особенно конфигурацию имени субъекта-службы. Убедитесь, что служба Azure AD присоединена к тому же домену, что и контроллер домена, чтобы контроллер домена мог установить отношения доверия с Azure AD. Убедитесь, что конфигурация даты и времени в Azure AD и на контроллере домена синхронизирована. |
| 13022 — службе Azure AD не удается проверить подлинность пользователя, так как внутренний сервер отвечает на попытки проверки подлинности Kerberos ошибкой HTTP 401. | Это событие может означать неправильную конфигурацию между Azure AD и внутренним сервером приложений или проблему в конфигурации даты и времени на обоих компьютерах. | Внутренний сервер отклонил билет Kerberos, созданный службой Azure AD. Проверьте правильность конфигурации Azure AD и сервера внутренних приложений. Убедитесь, что конфигурация даты и времени в Azure AD и на внутреннем сервере приложений синхронизирована. |
| Веб-сайт не может отобразить страницу. | Пользователь может увидеть эту ошибку при попытке доступа к опубликованному вами приложению, если оно является приложением IWA. Возможно, для этого приложения определено неправильное имя субъекта-службы. | Для приложений IWA: убедитесь, что для приложения настроено правильное имя субъекта-службы (SPN). |
| Веб-сайт не может отобразить страницу. | Пользователь может получить эту ошибку при попытке доступа к опубликованному вами приложению, если оно является приложением OWA. Возможные причины ошибок. <br> — Для этого приложения определено неправильное имя субъекта-службы. <br> — Пользователь, который попытался получить доступ к приложению, использует для входа учетную запись Майкрософт или гостевую учетную запись, а не правильную корпоративную учетную запись. <br> — Пользователь, который пытался получить доступ к приложению, не определен должным образом для этого приложения в локальной системе. | Способы устранения ошибок. <br> — Убедитесь в правильности имени субъекта-службы, настроенного для этого приложения. <br> — Убедитесь, что пользователь выполняет вход с помощью корпоративной учетной записи, которая соответствует имени домена опубликованного приложения. Пользователи учетных записей Майкрософт и гости не могут получить доступ к приложениям IWA. <br> — Убедитесь, что этот пользователь имеет соответствующие разрешения, определенные для этого внутреннего приложения на локальном компьютере. |
| К этому корпоративному приложению нет доступа. Вы не авторизованы для доступа к этому приложению. Ошибка авторизации. Не забудьте назначить пользователю доступ к этому приложению. | Пользователи могут получать такую ошибку при попытке доступа к опубликованному приложению, если они используют для входа учетные записи Майкрософт вместо своей корпоративной учетной записи. Также эта ошибка возникает при входе с помощью гостевой учетной записи. | Пользователи учетных записей Майкрософт и гости не могут получить доступ к приложениям IWA. Убедитесь, что пользователь выполняет вход с помощью корпоративной учетной записи, которая соответствует имени домена опубликованного приложения. |
| Доступ к этому корпоративному приложению невозможно получить прямо сейчас. Повторите попытку позже. Истекло время ожидания для соединителя. | Пользователь может получить эту ошибку при попытке доступа к опубликованному вами приложению, если этот пользователь не определен надлежащим образом для этого приложения на локальном компьютере. | Убедитесь, что такой пользователь имеет соответствующие разрешения, определенные для этого внутреннего приложения на локальном компьютере. |


## Дополнительные материалы

- [Включение прокси приложения Azure AD](active-directory-application-proxy-enable.md)
- [Опубликуйте приложения с помощью прокси-сервера приложений.](active-directory-application-proxy-publish.md)
- [Доступ с единым входом](active-directory-application-proxy-sso-using-kcd.md)
- [Включение условного доступа](active-directory-application-proxy-conditional-access.md)

Последние новости и обновления см. в блоге, посвященном [прокси приложений](http://blogs.technet.com/b/applicationproxyblog/).


<!--Image references-->
[1]: ./media/active-directory-application-proxy-troubleshoot/connectorproperties.png
[2]: ./media/active-directory-application-proxy-troubleshoot/sessionlog.png

<!---HONumber=AcomDC_0824_2016-->