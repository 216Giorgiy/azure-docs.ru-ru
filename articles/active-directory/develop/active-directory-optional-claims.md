---
title: Узнайте, как предоставлять дополнительные утверждения для приложения Azure AD | Документация Майкрософт
description: Руководство по добавлению пользовательских или дополнительных утверждений в токены SAML 2.0 и JSON Web Token (JWT), выдаваемых службой Azure Active Directory.
documentationcenter: na
author: hpsin
services: active-directory
manager: mtillman
editor: ''
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 03/15/2018
ms.author: hirsin
ms.custom: aaddev
ms.openlocfilehash: 76e7be62caae7e33caefc3f90a5e57c5f71a31d3
ms.sourcegitcommit: c3d53d8901622f93efcd13a31863161019325216
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2018
---
# <a name="optional-claims-in-azure-ad-preview"></a>Необязательные утверждения в Azure AD (предварительная версия)

Эта возможность используется разработчиками приложения, чтобы указать утверждения, которые нужно поместить в токены, отправляемые в приложение. Необязательные утверждения можно использовать, чтобы:
-   выбрать дополнительные утверждения для включения в токены для приложения;
-   изменить поведение определенных утверждений в токенах, возвращаемых Azure AD;
-   добавлять пользовательские утверждения для приложения и обращаться к ним. 

> [!Note]
> Эта функция сейчас предоставляется в режиме общедоступной предварительной версии. Вы должны быть готовы отменить или удалить все изменения. На этапе общедоступной предварительной версии эта функция доступна во всех подписках Azure AD. Однако, когда функция станет общедоступной, для некоторых аспектов компонента может потребоваться подписка Azure AD Premium.

Дополнительные сведения о стандартных утверждениях и их использовании в токенах см. в статье [Справочник по токенам в Azure AD](active-directory-token-and-claims.md). 

Одна из целей [конечной точки Azure AD версии 2.0](active-directory-appmodel-v2-overview.md) — уменьшение размеров токенов для обеспечения оптимальной производительности для клиентов.  В результате нескольких утверждений, ранее включенных в маркеры доступа и идентификаторов, больше нет в токенах версии 2.0 и их нужно запрашивать специально для каждого приложения.  

**Таблица 1. Применимость**

| Тип учетной записи | Конечная точка версии 1.0                      | Конечная точка версии 2.0  |
|--------------|------------------------------------|----------------|
| MSA          | Недоступно. Вместо них используются запросы RPS | Поддержка будет реализована в ближайшее время |
| AAD          | Поддерживаются                          | Поддерживаются      |

## <a name="standard-optional-claims-set"></a>Набор стандартных необязательных утверждений
Набор необязательных утверждений доступен по умолчанию для использования приложениями, перечисленными ниже.  Чтобы добавить настраиваемые необязательные утверждения для приложения, ознакомьтесь с разделом [Расширения каталога](active-directory-optional-claims.md#Configuring-custom-claims-via-directory-extensions) ниже. 

> [!Note]
>Большую часть этих утверждений можно включить в JWT, кроме токенов SAML, за исключением оговоренных в столбце типов токенов.  Кроме того, в текущее время необязательные утверждения поддерживаются только для пользователей AAD, поддержка MSA будет добавлена.  Когда в MSA появится поддержка необязательных утверждений в конечной точке версии 2.0, в столбце типа пользователя будет указано, доступно ли утверждение для пользователя AAD или MSA.  

**Таблица 2. Набор стандартных необязательных утверждений**

| ИМЯ                     | ОПИСАНИЕ                                                                                                                                                                                     | Тип маркера | Тип пользователя | Заметки                                                                                                                                                                                                                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `auth_time`                | Время, когда пользователь последний раз проходил аутентификацию.  Ознакомьтесь со спецификацией OpenID Connect.                                                                                                                                | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `tenant_region_scope`      | Регион клиента ресурса                                                                                                                                                                   | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `signin_state`             | Утверждение состояния входа                                                                                                                                                                             | JWT        |           | 6 возвращаемых значений в качестве флагов:<br> "dvc_mngd": управляемое устройство;<br> "dvc_cmp": устройство совместимо;<br> "dvc_dmjd": устройство присоединено к домену;<br> "dvc_mngd_app": устройство управляется с помощью MDM;<br> "inknownntwk": устройство находится в известной сети;<br> "kmsi": используется возможность оставаться в системе. <br> |
| `controls`                 | Многозначное утверждение, содержащее элементы управления сеансом, применяемые политиками условного доступа.                                                                                                       | JWT        |           | 3 значения:<br> "app_res": приложению необходимо применять более детальные ограничения; <br> "ca_enf": применение условного доступа было отложено, но по прежнему требуется; <br> "no_cookie": этого токена недостаточно для обмена на файл cookie в браузере. <br>                              |
| `home_oid`                 | Для гостевых пользователей идентификатор объекта пользователя — это домашний клиент пользователя.                                                                                                                           | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `sid`                      | Идентификатор сеанса, используемый для выхода пользователя из каждого сеанса.                                                                                                                                                  | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `platf`                    | Платформа устройства                                                                                                                                                                                 | JWT        |           | Только для управляемых устройств, которые могут проверить тип устройства.                                                                                                                                                                                                                              |
| `verified_primary_email`   | Источник: PrimaryAuthoritativeEmail пользователя                                                                                                                                               | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `verified_secondary_email` | Источник: SecondaryAuthoritativeEmail пользователя                                                                                                                                             | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `enfpolids`                | Идентификаторы применяемой политики. Список идентификаторов политик, оцененных для текущего пользователя.                                                                                                         | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `vnet`                     | Сведения об описателе виртуальной сети.                                                                                                                                                                     | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `fwd`                      | IP-адрес.  Добавляет исходный IPv4-адрес запрашивающего клиента (при использовании внутри виртуальной сети)                                                                                                       | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `ctry`                     | Страна пользователя                                                                                                                                                                                  | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `tenant_ctry`              | Страна ресурса клиента                                                                                                                                                                       | JWT        |           |                                                                                                                                                                                                                                                                                         |
| `is_device_known`          | Обозначает, подключено ли устройство к рабочему месту. Связанно с политикой условного доступа                                                                                                                 | SAML       |           | Для JWT, объединенных в signin_state                                                                                                                                                                                                                                                   |
| `is_device_managed`        | Указывает, имеет ли устройство установленное MDM. Связанно с политикой условного доступа.                                                                                                                  | SAML       |           | Для JWT, объединенных в signin_state                                                                                                                                                                                                                                                   |
| `is_device_compliant`      | Обозначает то, что MDM определило, что устройство соответствует политикам безопасности устройств в организации.                                                                                  | SAML       |           | Для JWT, объединенных в signin_state                                                                                                                                                                                                                                                   |
| `kmsi`                     | Обозначает, выбрал ли пользователь параметр "Оставаться в системе".                                                                                                                                    | SAML       |           | Для JWT, объединенных в signin_state                                                                                                                                                                                                                                                   |
| `upn`                      | Утверждение UserPrincipalName.  Несмотря на то, что это утверждение автоматически включается, можно указать его в качестве необязательного утверждения для присоединения дополнительных свойств, чтобы изменить его поведение в варианте использования гостевым пользователем. | JWT, SAML  |           | Дополнительные свойства: <br> `include_externally_authenticated_upn` <br> `include_externally_authenticated_upn_without_hash`                                                                                                                                                                 |
### <a name="v20-optional-claims"></a>Необязательные утверждения версии 2.0
Эти утверждения всегда включаются в токены версии 1.0, но удаляются из токенов версии 2.0, если они не запрошены.  Эти утверждения применяются только для JWT (токены идентификации и маркер доступа).  

**Таблица 3. Необязательные утверждения, предназначенные только для версии 2.0**

| Утверждение JWT     | ИМЯ                            | ОПИСАНИЕ                                                                                                                    | Заметки |
|---------------|---------------------------------|--------------------------------------------------------------------------------------------------------------------------------|-------|
| `ipaddr`      | IP-адрес                      | IP-адрес, с которого клиент вошел в систему.                                                                                      |       |
| `onprem_sid`  | Локальный идентификатор безопасности |                                                                                                                                |       |
| `pwd_exp`     | Срок действия пароля        | Дата и время истечения срока действия пароля.                                                                                    |       |
| `pwd_url`     | Изменить URL-адрес пароля             | URL-адрес, перейдя по которому пользователь может изменить свой пароль.                                                                        |       |
| `in_corp`     | В корпоративной сети        | Посылает сигнал, если клиент входит в корпоративную сеть. В противном случае утверждение не включается.                     |       |
| `nickname`    | Псевдоним                        | Дополнительное имя для пользователя, отдельное от имени или фамилии.                                                             |       |                                                                                                                |       |
| `family_name` | Фамилия                       | Указывает фамилию пользователя в соответствии с определением в объекте пользователя Azure AD. <br>"family_name":"Miller" |       |
| `given_name`  | Имя                      | Указывает на имя или заданное имя пользователя, которое задали в объекте пользователя Azure AD.<br>"given_name": "Frank"                   |       |

### <a name="additional-properties-of-optional-claims"></a>Дополнительные свойства необязательных утверждений

Некоторые необязательные утверждения можно настроить так, чтобы изменить способ возврата утверждения.  Эти дополнительные свойства используются в основном для переноса локальных приложений с различными требованиями к данным (например, `include_externally_authenticated_upn_without_hash` полезно применять с клиентами, которые не обрабатывают метки хэширования (`#`) в имени участника-пользователя).

**Таблица 4. Значения для настройки стандартных необязательных утверждений**

| Имя свойства                                     | Имя дополнительного свойства                                                                                                             | ОПИСАНИЕ |
|---------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------|-------------|
| `upn`                                                 |                                                                                                                                      |             |
| | `include_externally_authenticated_upn`              | Включает гостевое имя участника-пользователя, сохраненное в клиенте ресурса.  Например, `foo_hometenant.com#EXT#@resourcetenant.com`                            |             
| | `include_externally_authenticated_upn_without_hash` | Аналогично предыдущему примеру, за исключением того, что метки хэширования (`#`) будут заменены символами нижнего подчеркивания (`_`), например `foo_hometenant.com_EXT_@resourcetenant.com` |             

> [!Note]
>Указание необязательного утверждения имени участника-пользователя без дополнительного свойства не изменяет поведение. Чтобы увидеть новое утверждение, выданное в токене, необходимо добавить хотя бы одно из дополнительных свойств. 


#### <a name="additional-properties-example"></a>Пример дополнительных свойств:

```json
 "optionalClaims": 
   {
       "idToken": [ 
             { 
                "name": "upn", 
            "essential": false,
                "additionalProperties": [ "include_externally_authenticated_upn"]  
              }
        ]
}
```

Этот объект OptionalClaims вызывает маркер идентификатора, возвращаемый клиенту, для включения другого имени участника-пользователя с дополнительными сведениями о домашнем клиенте и клиенте ресурса.  

## <a name="configuring-optional-claims"></a>Настройка необязательных утверждений

С помощью изменения манифеста приложения можно настроить необязательные утверждения (см. пример ниже). Дополнительные сведения см. в статье [Манифест приложения Azure Active Directory](active-directory-application-manifest.md).

**Пример схемы:**

```json
"optionalClaims":  
   {
       "idToken": [
             { 
                   "name": "upn", 
                   "essential": false, 
                   "additionalProperties": [ "include_externally_authenticated_upn"]  
              }
        ],
 "accessToken": [ 
             {
                    "name": "auth_time", 
                    "essential": false
              }
        ],
"saml2Token": [ 
              { 
                    "name": "upn", 
                    "essential": true
               },
               { 
                    "name": "extension_ab603c56068041afb2f6832e2a17e237_skypeId",
                    "source": "user", 
                    "essential": true
               }
       ]
   }
```

### <a name="optionalclaims-type"></a>Тип OptionalClaims

Объявляет необязательные утверждения, запрошенные приложением. В приложении можно настроить необязательные утверждения, которые должны возвращаться в каждый из трех типов токенов (токен идентификации, маркер доступа, токен SAML 2), которые оно может получить из службы токенов безопасности. Приложение может настроить различные наборы необязательных утверждений, которые будут возвращаться в каждый тип токена. Свойство optionalClaims сущности приложения — это объект optionalClaims.

**Таблица 5. Свойства типа OptionalClaims**

| ИМЯ        | type                       | ОПИСАНИЕ                                           |
|-------------|----------------------------|-------------------------------------------------------|
| `idToken`     | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в токен идентификации JWT.     |
| `accessToken` | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в маркер доступа JWT. |
| `saml2Token`  | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в токен SAML.       |


### <a name="optionalclaim-type"></a>Тип OptionalClaim

Содержит необязательное утверждение, связанное с приложением или субъект-службой. Свойства idToken, accessToken и saml2Token типа [OptionalClaims](https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#optionalclaims-type) являются коллекцией OptionalClaim.
С помощью поля AdditionalProperties можно изменить поведение OptionalClaim, если это поддерживается определенным утверждением.

**Таблица 6. Свойства типа OptionalClaims**

| ИМЯ                 | type                    | ОПИСАНИЕ                                                                                                                                                                                                                                                                                                   |
|----------------------|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `name`                 | Edm.String              | Имя необязательного утверждения.                                                                                                                                                                                                                                                                               |
| `source`               | Edm.String              | Источник утверждения (объект каталога). Существуют стандартные утверждения и определяемые пользователем утверждения из свойств расширения. Если исходное значение равно null, утверждение будет являться предопределенным необязательным утверждением. Если исходное значение — user, значение в имени свойства будет свойством расширения из объекта пользователя. |
| `essential`            | Edm.Boolean             | Если значение равно true, утверждение, указанное клиентом, необходимо для обеспечения плавной авторизации конкретной задачи, запрашиваемой пользователем. По умолчанию для этого параметра используется значение false.                                                                                                                 |
| `additionalProperties` | Коллекция (Edm.String) | Дополнительные свойства утверждений. Если свойство существует в коллекции, оно изменяет поведение дополнительного утверждения, указанного в свойстве имени.                                                                                                                                                   |

## <a name="configuring-custom-claims-via-directory-extensions"></a>Настройка пользовательских утверждений через расширения каталогов

Помимо набора стандартных необязательных утверждений токены можно также настроить для включения расширений схемы каталогов. Дополнительные сведения см. в статье [Directory schema extensions | Graph API concepts](https://msdn.microsoft.com/Library/Azure/Ad/Graph/howto/azure-ad-graph-api-directory-schema-extensions) (Расширения схемы каталога | Основные понятия API Graph).  Эта возможность полезна при присоединении дополнительных сведений о пользователях, которые может использовать приложение, например, дополнительный идентификатор или важный параметр конфигурации, заданный пользователем. 

> [!Note]
> Расширения схемы каталога — это возможность, предназначенная только для AAD, поэтому если ваш манифест приложения запрашивает пользовательское расширение, а пользователь MSA регистрируется в вашем приложении, эти расширения не будут возвращены. 

### <a name="values-for-configuring-additional-optional-claims"></a>Значения для настройки дополнительных необязательных утверждений 

Для атрибутов расширения используйте полное имя расширения (в формате: `extension_<appid>_<attributename>`) в манифесте приложения. `<appid>` должен совпадать с идентификатором приложения, запрашивающего утверждение. 

В рамках JWT эти утверждения будут передаваться с помощью следующего формата имени: `extn.<attributename>`.

В рамках токенов SAML эти утверждения будут передаваться с помощью следующего формата URI: `http://schemas.microsoft.com/identity/claims/extn.<attributename>`

## <a name="optional-claims-example"></a>Пример необязательного утверждения

В этом разделе можно пошагово выполнить сценарий, чтобы узнать, как можно использовать возможность необязательных утверждений для приложения.
Есть несколько доступных вариантов обновления свойств в конфигурации удостоверения приложения, позволяющих включить и настроить необязательные утверждения:
-   Вы можете изменить манифест приложения. В приведенном ниже примере этот метод будет использован для выполнения настройки. Ознакомьтесь со статьей [Манифест приложения Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-application-manifest), чтобы получить общие сведения о манифесте.
-   Вы также можете написать приложение, в котором для обновления используется [API Graph](https://docs.microsoft.com/azure/active-directory/develop/active-directory-graph-api). [Справочник по сущностям и сложным типам](https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#optionalclaims-type) в справочнике по API Graph может помочь вам с конфигурацией необязательных утверждений.

**Пример.** В приведенном ниже примере манифест приложения изменяется, чтобы добавить утверждения в маркеры доступа, идентификации и SAML, предназначенные для приложения.
1.  Войдите на [портале Azure](https://portal.azure.com).
2.  Пройдя аутентификацию, выберите клиент Azure AD, щелкнув его в правом верхнем углу страницы.
3.  Выберите расширение **Azure AD** на левой навигационной панели и щелкните **Регистрация приложений**.
4.  Найдите в списке приложение, для которого нужно настроить необязательные утверждения, и щелкните его.
5.  Щелкните **Манифест** на странице приложения, чтобы открыть встроенный редактор манифеста. 
6.  Можно напрямую изменить манифест с помощью этого редактора. Манифест соответствует схеме для [сущности приложения](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#application-entity) и автоматически форматирует манифест после сохранения. В свойство `OptionalClaims` будут добавлены новые элементы.

      ```json
      "optionalClaims": 
      {
            "idToken": [ 
                  { 
                        "name": "upn", 
                        "essential": false, 
                        "additionalProperties": [ "include_externally_authenticated_upn"]  
                  }
            ],
      "accessToken": [ 
                  {
                        "name": "auth_time", 
                        "essential": false
                  }
            ],
      "saml2Token": [ 
                  { 
                        "name": "extension_ab603c56068041afb2f6832e2a17e237_skypeId",
                        "source": "user", 
                        "essential": true
                  }
            ]
      }
      ```
      В этом случае различные необязательные утверждения будут добавлены к каждому типу токена, который может получить приложение. Теперь токены идентификации содержат имена участников-пользователей федеративных пользователей в полной форме (`<upn>_<homedomain>#EXT#@<resourcedomain>`). Маркеры доступа получат утверждение auth_time. Токен SAML будет содержать расширение схемы каталога skypeId (в этом примере идентификатор этого приложения — ab603c56068041afb2f6832e2a17e237).  Токен SAML представит идентификатор Skype как `extension_skypeId`.

7.  Завершив изменение манифеста, нажмите кнопку **Сохранить**, чтобы сохранить его.


## <a name="related-content"></a>Связанная информация
* Дополнительные сведения о стандартных утверждениях, предоставляемых Azure AD, см. в статье [Справочник по токенам в Azure AD](active-directory-token-and-claims.md). 
