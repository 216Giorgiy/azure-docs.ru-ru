---
title: Использование Azure AD версии 2.0 для входа пользователей на устройствах без браузера | Документация Майкрософт
description: Создание внедренного потока проверки подлинности и потока проверки подлинности без браузера с использованием предоставления кода устройства.
services: active-directory
documentationcenter: ''
author: CelesteDG
manager: mtillman
editor: ''
ms.assetid: 780eec4d-7ee1-48b7-b29f-cd0b8cb41ed3
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/02/2018
ms.author: celested
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: f1f34796a98acb3ed4241edff57e506990479d1a
ms.sourcegitcommit: 7e772d8802f1bc9b5eb20860ae2df96d31908a32
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2019
ms.locfileid: "57443273"
---
# <a name="azure-active-directory-v20-and-the-oauth-20-device-code-flow"></a>Azure Active Directory версии 2.0 и поток кода устройства OAuth 2.0

[!INCLUDE [active-directory-develop-applies-v2](../../../includes/active-directory-develop-applies-v2.md)]

Azure AD поддерживает [предоставление кода устройства](https://tools.ietf.org/html/draft-ietf-oauth-device-flow-12), которое позволяет пользователям входить на устройства с ограничениями ввода, например устройство типа Smart TV, устройство Интернета вещей или принтер.  Чтобы включить этот поток на устройстве, пользователь должен выполнить вход, посетив веб-страницу в браузере на другом устройстве.  Когда пользователь выполнит вход, устройство сможет получить необходимые маркеры доступа и маркеры обновления.  

> [!Important] 
> Сейчас конечная точка версии 2.0 поддерживает поток устройства только для клиентов Azure AD, но не личных учетных записей.  Это означает, что необходимо использовать конечную точку как клиент или организаций конечной точки.  
>
> Личные учетные записи, приглашенные в клиент Azure AD, будут иметь возможность использовать предоставление потока устройства, но только в контексте клиента.

> [!NOTE]
> Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, стоит ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).
>

## <a name="protocol-diagram"></a>Схема протокола

Весь поток кода устройства аналогичен приведенному на следующей схеме. Описание каждого шага приведено далее в этой статье.

![Поток кода устройства](media/v2-oauth2-device-flow/v2-oauth-device-flow.png)

## <a name="device-authorization-request"></a>Запрос авторизации устройства

Сначала на сервере проверки подлинности клиент должен проверить код устройства и пользователя, используемый для запуска проверки подлинности.  Клиент собирает этот запрос из конечной точки `/devicecode`. В этом запросе клиент также должен добавить разрешения, которые ему требуется получить от пользователя.  С момента отправки запроса у пользователя есть только 15 минут для входа (обычное значение для `expires_in`), поэтому выполняйте этот запрос, только когда пользователь указал, что готов выполнить вход.

```
// Line breaks are for legibility only.

POST https://login.microsoftonline.com/{tenant}/devicecode
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
scope=user.read%20openid%20profile

```

| Параметр | Условие | ОПИСАНИЕ |
| --- | --- | --- |
| tenant |Обязательно для заполнения |Клиент каталога, из которого необходимо запросить разрешение. Его можно указать в виде GUID или понятного имени.  |
| client_id |Обязательно для заполнения |Идентификатор приложения, присвоенный приложению на [портале регистрации приложений](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList). |
| scope | Рекомендуется | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , для которого необходимо согласие пользователя.  |

### <a name="device-authorization-response"></a>Ответ авторизации устройства

При успешном ответе возвращается объект JSON, содержащий необходимые сведения, чтобы разрешить пользователю войти в систему.  

| Параметр | Формат | ОПИСАНИЕ |
| ---              | --- | --- |
|`device_code`     |Строка| Длинная строка, используемая для проверки сеанса между клиентом и сервером авторизации.  Используется клиентом для запроса маркера доступа с сервера авторизации. |
|`user_code`       |Строка| Короткая строка, показываемая пользователю и используемая для идентификации сеанса на дополнительном устройстве.|
|`verification_uri`|URI| URI, по которому пользователь должен перейти с помощью `user_code` для входа. |
|`verification_uri_complete`|URI| URI, объединяющий `user_code` и `verification_uri`, используется для нетекстовой передачи пользователю (например, с помощью Bluetooth на устройство или через QR-код).  |
|`expires_in`      |int| Количество секунд до окончания срока действия `device_code` и `user_code`. |
|`interval`        |int| Число секунд ожидания клиентом между опрашивающими запросами. |
| `message`        |Строка| Понятная пользователю строка с инструкциями.  Ее можно локализовать, включив **параметр запроса** в запросе формы `?mkt=xx-XX`, заменив соответствующий код языка и региональных параметров. |

## <a name="authenticating-the-user"></a>Проверка подлинности пользователя

После получения `user_code` и `verification_uri` клиент отображает их для пользователя, предоставляя инструкции по выполнению входа с помощью браузера мобильного телефона или ПК.  Кроме того, клиент может использовать QR-код или похожий механизм, чтобы отобразить `verfication_uri_complete`, при этом пользователю понадобится ввести `user_code`.

Хотя пользователь проходит проверку подлинности в `verification_uri`, клиент должен опросить конечную точку `/token` на наличие запрошенного токена с помощью `device_code`.

``` 
POST https://login.microsoftonline.com/tenant/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

grant_type: urn:ietf:params:oauth:grant-type:device_code
client_id: 6731de76-14a6-49ae-97bc-6eba6914391e
device_code: GMMhmHCXhWEzkobqIHGG_EnNYYsAkukHspeYUk9E8
```

|Параметр | Обязательно для заполнения | ОПИСАНИЕ|
| -------- | -------- | ---------- |
|`grant_type` | Обязательно для заполнения| Должен содержать значение `urn:ietf:params:oauth:grant-type:device_code`.|
|`client_id`  | Обязательно для заполнения| Должен соответствовать `client_id`, используемому в первоначальном запросе. |
|`device_code`| Обязательно для заполнения| `device_code`, возвращаемый в запросе авторизации устройства.  |

### <a name="expected-errors"></a>Ожидаемые ошибки

Так как поток кода устройства является протоколом опроса, клиент должен ожидать ошибки до завершения проверки подлинности пользователя.  

| Ошибка | ОПИСАНИЕ | Действие клиента |
|------ | ----------- | -------------|
| `authorization_pending` |  Пользователь еще не завершил проверку подлинности, но не отменил поток. | Повторите запрос не менее чем через `interval` с. |
| `authorization_declined`|  Пользователь отклонил запрос авторизации.| Остановка опроса и возврат в состояние без проверки подлинности.  |
| `bad_verification_code`|`device_code`, отправленный в конечную точку `/token`, не распознан. | Убедитесь, что клиент отправляет правильный `device_code` в запросе. |
| `expired_token`|  Прошло не менее `expires_in` секунд, и проверка подлинности больше невозможна с помощью этого `device_code`. | Остановка опроса и возврат в состояние без проверки подлинности. |


### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

Успешный ответ маркера выглядит следующим образом:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | ОПИСАНИЕ |
| --------- | ------ | ----------- |
|`token_type` | Строка| Всегда "Bearer". |
|`scope` | Строки, разделенные пробелами | Если маркер доступа возвращен, этот параметр приводит список областей, в которых маркер доступа является допустимым. |
|`expires_in`| int | Количество секунд, в течение которых маркер доступа является допустимым. |
|`access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md).  |
|`id_token`   | JWT | Выдается, если исходный параметр `scope` содержит область `openid`.  |
|`refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`.  |

Маркер обновления может использоваться для получения новых маркеров доступа и маркеров обновления с помощью одного и того же потока, описанного в [документации по потоку кода OAuth](v2-oauth2-auth-code-flow.md#refresh-the-access-token).  
