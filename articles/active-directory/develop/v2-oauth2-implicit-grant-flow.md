---
title: Защита одностраничных приложений с помощью неявной последовательности Azure AD версии 2.0 | Документация Майкрософт
description: Узнайте, как создавать веб-приложения с помощью реализации неявной последовательности в одностраничных приложениях Azure AD версии 2.0.
services: active-directory
documentationcenter: ''
author: CelesteDG
manager: mtillman
editor: ''
ms.assetid: 3605931f-dc24-4910-bb50-5375defec6a8
ms.service: active-directory
ms.component: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/02/2018
ms.author: celested
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: ce54ad77893557b595f9777dfc82939aacf41608
ms.sourcegitcommit: 3ba9bb78e35c3c3c3c8991b64282f5001fd0a67b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/15/2019
ms.locfileid: "54321523"
---
# <a name="v20-protocols---spas-using-the-implicit-flow"></a>Протоколы приложений версии 2.0. Одностраничные приложения с использованием неявного потока

[!INCLUDE [active-directory-develop-applies-v2](../../../includes/active-directory-develop-applies-v2.md)]

Благодаря конечной точке версии 2.0 пользователи могут входить в одностраничные приложения, используя личные и рабочие учетные записи Майкрософт. Во время проверки подлинности одностраничные и другие приложения JavaScript, которые запускаются в основном в браузере, сталкиваются с некоторыми проблемами.

* Характеристики безопасности этих приложений значительно отличаются от традиционных серверных веб-приложений.
* Многие серверы авторизации и поставщики удостоверений не поддерживают запросы CORS.
* Полностраничный браузер перенаправляет пользователя из приложения, взаимодействие с которым становится особенно агрессивным.

Для этих приложений (AngularJS, Ember.js, React.js и т. д.) Azure Active Directory (Azure AD) поддерживает поток OAuth 2.0 Implicit Grant. Подробное описание неявного потока данных см. в [спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-4.2). Его основное преимущество заключается в том, что приложение получает маркеры из Azure AD без предоставления учетных данных внутреннему серверу. Так, приложение может авторизовать пользователей, поддерживать сеансы и получать маркеры для других веб-API — и все это из клиентского кода JavaScript. Во время использования неявного потока данных необходимо обращать внимание на некоторые важные вопросы безопасности, касающиеся [клиента](https://tools.ietf.org/html/rfc6749#section-10.3) и [маскировки под другого пользователя](https://tools.ietf.org/html/rfc6749#section-10.3).

Если для добавления проверки подлинности в приложение JavaScript вы хотите использовать неявный поток данных и Azure AD, рекомендуем использовать библиотеку открытого исходного кода JavaScript [msal.js](https://github.com/AzureAD/microsoft-authentication-library-for-js).

Но в одностраничном приложении можно обойтись без использования библиотеки. Отправлять сообщения протокола в таком случае нужно самостоятельно. Для этого выполните следующие шаги.

> [!NOTE]
> Не все сценарии и компоненты Azure AD поддерживаются конечной точкой версии 2.0. Чтобы определить, следует ли вам использовать конечную точку 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).

## <a name="protocol-diagram"></a>Схема протокола

На следующей схеме показано, как выглядит весь неявный входной поток. В последующих разделах каждый шаг описывается более подробно.

![Дорожки OpenID Connect](./media/v2-oauth2-implicit-grant-flow/convergence_scenarios_implicit.png)

## <a name="send-the-sign-in-request"></a>Отправка запроса на вход

Для первого входа пользователя в приложение можно отправить запрос на авторизацию [OpenID Connect](v2-protocols-oidc.md) и получить `id_token` из конечной точки версии 2.0.

> [!IMPORTANT]
> Чтобы успешно запросить маркер идентификатора, в регистрации приложения на [портале регистрации](https://apps.dev.microsoft.com) для веб-клиента должен быть включен параметр **Разрешить неявный поток**. Если его не включить, будет возвращена следующая ошибка `unsupported_response`: **The provided value for the input parameter 'response_type' is not allowed for this client. Expected value is 'code'** (Указанное значение параметра response_type запрещено для данного клиента. Ожидаемое значение: code).

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=openid
&response_mode=fragment
&state=12345
&nonce=678910
```

> [!TIP]
> Чтобы проверить вход с помощью неявного потока, щелкните <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=openid&response_mode=fragment&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a> После входа браузер будет перенаправлен по адресу `https://localhost/myapp/`, при этом в адресной строке будет `id_token`.
>

| Параметр |  | ОПИСАНИЕ |
| --- | --- | --- |
| `tenant` | обязательно |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `client_id` | обязательно |Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList)). |
| `response_type` | обязательно |Должен включать `id_token` для входа в OpenID Connect. Этот параметр также может содержать значение `token` параметра response_type (тип ответа). Использование `token` здесь позволяет приложению получать токен доступа непосредственно от конечной точки авторизации, при этом отправлять новый запрос на вход в эту конечную точку не требуется. При использовании типа ответа `token` параметр `scope` должен содержать область, определяющую ресурсы, для которых необходимо выдавать токен. |
| `redirect_uri` | рекомендуется |URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| `scope` | обязательно |Список областей с разделителями-пробелами. При использовании протокола OpenID Connect он должен содержать область `openid`, что преобразуется в разрешение "Вход" в пользовательском интерфейсе предоставления согласия. Если требуется доступ к дополнительным данным пользователя, можно также указать [области](v2-permissions-and-consent.md) `email` или `profile`. Этот запрос может также включать другие области в зависимости от ресурсов, к которым требуется получить доступ. |
| `response_mode` | необязательный |Указывает метод, с помощью которого результирующий маркер будет отправлен приложению. По умолчанию для маркера доступа используется метод query, но если запрос включает маркер id_token, значением по умолчанию является fragment. |
| `state` | рекомендуется |Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, для [предотвращения подделки межсайтовых запросов](https://tools.ietf.org/html/rfc6749#section-10.12)используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| `nonce` | обязательно |Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения токена. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. Требуется только при запросе id_token. |
| `prompt` | необязательный |Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — login, none, select_account и consent. При значении `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает. Значение `prompt=none` является противоположным — оно гарантирует, что интерактивные запросы не будут выводиться ни при каких обстоятельствах. Если запрос не удастся завершить автоматически с использованием единого входа, то конечная точка версии 2.0 вернет ошибку. `prompt=select_account` отправляет пользователя в средство выбора учетных записей, где будут отображаться все учетные записи, запомненные в сеансе. Если установить значение `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| `login_hint`  |необязательный |Можно применять для предварительного заполнения поля имени пользователя или электронного адреса на странице входа пользователя (если имя пользователя известно заранее). Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`.|
| `domain_hint` | необязательный |Может использоваться значение `consumers` или `organizations`. Если используется этот параметр, процесс обнаружения на основе электронной почты, который проходит пользователь на странице входа в приложение версии 2.0, пропускается, что существенно оптимизирует работу. Обычно этот параметр используется в приложениях при повторной проверке подлинности. Для этого значение утверждения `tid` извлекается из параметра id_token. Если значением утверждения `tid` является `9188040d-6c67-4c5b-b112-36a304b66dad` (клиента объекта-получателя учетной записи Майкрософт), то следует использовать `domain_hint=consumers`. В противном случае можно использовать `domain_hint=organizations` при повторной проверке подлинности. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope` . Если пользователь **не предоставил** какие-либо из этих разрешений, конечная точка запросит их у пользователя. Дополнительные сведения см. в статье [Разрешения и предоставление согласия в конечной точке Azure Active Directory версии 2.0](v2-permissions-and-consent.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием `response_mode=fragment` и `response_type=id_token+token` выглядит следующим образом (разрывы строк — для удобства чтения):

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&token_type=Bearer
&expires_in=3599
&scope=https%3a%2f%2fgraph.microsoft.com%2fmail.read 
&id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Это маркер доступа, запрошенный приложением. В данном случае для Microsoft Graph. Этот маркер не следует расшифровывать или каким-либо иным образом проверять. Его можно рассматривать как непрозрачную строку. |
| `token_type` |Указывается, если параметр `response_type` содержит значение `token`. Всегда будет использоваться значение `Bearer`. |
| `expires_in`|Указывается, если параметр `response_type` содержит значение `token`. Указывает количество секунд, в течение которых маркер остается допустимым (для кэширования). |
| `scope` |Указывается, если параметр `response_type` содержит значение `token`. Указывает области, для которых будет допустимым access_token. Может не включать все запрошенные области, если они не были применимы к пользователю (только в случае областей AAD, которые запрашиваются, когда для входа используется личная учетная запись). |
| `id_token` | Подписанный JSON Web Token (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. См. дополнительные сведения о маркерах id_token: [`id_token reference`](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |
| `state` |Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/#
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## <a name="validate-the-idtoken"></a>Проверка токена "id_token"

Для проверки подлинности пользователя недостаточно просто получить токен "id_token". Вам также потребуется проверить подпись токена "id_token" и утверждения в нем в соответствии с требованиями приложения. В конечной точке версии 2.0 для подписи маркеров и проверки их правильности используются [веб-маркеры JSON Web Token (JWT)](https://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Вы можете выбрать проверку `id_token` в клиентском коде, но обычно `id_token` отправляется на проверку внутреннему серверу. После проверки подписи токена id_token вам потребуется проверить несколько утверждений. См. [справочник по `id_token`](id-tokens.md) и дополнительные сведения о [проверке маркеров](id-tokens.md#validating-an-idtoken) и [смене ключей подписывания](active-directory-signing-key-rollover.md). Советуем использовать библиотеку для синтаксического анализа и проверки токенов. Для большинства языков и платформ доступна по крайней мере одна такая библиотека.

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

* Обеспечение регистрации пользователя или организации в приложении.
* Предоставление пользователю необходимого уровня авторизации и привилегий.
* Обеспечение определенного уровня проверки подлинности, например Многофакторной Идентификации.

После полной проверки токена "id_token" вы можете начать сеанс с пользователем и использовать утверждения в токене "id_token" для получения сведений о пользователе в приложении. Эти сведения можно использовать для отображения, регистрации, персонализации и т. д.

## <a name="get-access-tokens"></a>Получение маркеров доступа

Теперь, когда пользователь вошел в одностраничное приложение, можно получить маркеры доступа для вызова веб-API, защищенные с помощью Azure AD, например [Microsoft Graph](https://developer.microsoft.com/graph). Даже если вы уже получили токен с использованием параметра response_type со значением `token`, этот метод можно использовать для получения токенов к дополнительным ресурсам. При наличии этих токенов пользователям не нужно повторно выполнять вход.

В обычных потоках OpenID Connect и OAuth маркеры можно получить, отправив запрос к конечной точке версии 2.0 `/token`. Однако конечная точка версии 2.0 не поддерживает запросы CORS. Поэтому получать и обновлять маркеры с помощью вызовов AJAX невозможно. Вместо этого для получения новых маркеров для других веб-API можно использовать неявный поток данных в скрытом iframe. 

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&response_mode=fragment
&state=12345&nonce=678910
&prompt=none
&domain_hint=organizations
&login_hint=myuser@mycompany.com
```

Дополнительные сведения о параметрах запроса в URL-адресе см. в разделе [Отправка запроса на вход](#send-the-sign-in-request).

> [!TIP]
> Попробуйте скопировать и вставить запрос, показанный ниже, на вкладку браузера. (Не забудьте заменить значения `domain_hint` и `login_hint` на правильные значения для вашего пользователя.)
>
>`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&response_mode=fragment&state=12345&nonce=678910&prompt=none&domain_hint=consumers-or-organizations&login_hint=your-username`
>

Благодаря параметру `prompt=none` этот запрос успешно выполнится или немедленно завершится с ошибкой, и вы вернетесь к своему приложению. Успешный ответ будет отправлен в ваше приложение на указанный `redirect_uri` с помощью метода, заданного в параметре `response_mode`.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
&token_type=Bearer
&expires_in=3599
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Это маркер доступа, запрошенный приложением. В данном случае для Microsoft Graph. Этот маркер не следует расшифровывать или каким-либо иным образом проверять. Его можно рассматривать как непрозрачную строку. |
| `token_type` | Всегда будет использоваться значение `Bearer`. |
| `expires_in` | Указывает количество секунд, в течение которых маркер остается допустимым (для кэширования). |
| `scope` | Указывает области, для которых будет допустимым access_token. Может не включать все запрошенные области, если они не были применимы к пользователю (только в случае областей AAD, которые запрашиваются, когда для входа используется личная учетная запись). |
| `id_token` | Подписанный JSON Web Token (JWT). Указывается, если параметр `response_type` содержит значение `id_token`. Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. Дополнительные сведения о маркерах id_token см. в статье [`id_token`Маркеры идентификаторов](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |
| `state` |Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |


#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение правильно обрабатывало их. Если вы используете `prompt=none`, отобразится следующая ошибка.

```
GET https://localhost/myapp/#
error=user_authentication_required
&error_description=the+request+could+not+be+completed+silently
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

После появления этой ошибки в запросе iframe пользователю необходимо войти еще раз в интерактивном режиме для получения нового маркера. Этот случай можно обрабатывать любым способом, который лучше всего подходит для вашего приложения.

## <a name="validating-access-tokens"></a>Проверка маркеров доступа

При получении маркера доступа обязательно проверьте подпись маркера, а также указанные ниже утверждения. Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. 

* Утверждение **Audience**. Необходимо для подтверждения того, что маркер действительно должен был быть выдан вашему приложению.
* Утверждение **issuer**. Необходимо для подтверждения того, что маркер был выдан приложению конечной точкой версии 2.0.
* Утверждения **Not Before** и **Expiration Time**. Необходимы для подтверждения того, что срок действия маркера не истек.

См. дополнительные сведения об утверждениях, присутствующих в [маркерах доступа](access-tokens.md).

## <a name="refreshing-tokens"></a>Обновление маркеров

Неявное предоставление не обеспечивает маркеры обновления. Срок действия маркеров `id_token` и `access_token` очень короткий, поэтому приложение должно быть готово периодически обновлять их. Чтобы обновить маркер любого типа, выполните тот же скрытый запрос iframe, приведенный выше, используя параметр `prompt=none` для управления поведением Azure AD. Чтобы получить новый `id_token`, обязательно используйте `response_type=id_token` и `scope=openid`, а также параметр `nonce`.

## <a name="send-a-sign-out-request"></a>Отправка запроса на выход

OpenIdConnect `end_session_endpoint` позволяет приложению отправлять запросы на конечную точку версии 2.0 для прекращения сеанса пользователя и очистки файлов cookie, установленных конечной точкой версии 2.0. Чтобы пользователь полностью вышел из веб-приложения, приложение должно завершить свой сеанс пользователя (обычно с помощью очистки кэша маркеров или файлов cookie), а затем перенаправить браузер на:

```
https://login.microsoftonline.com/{tenant}/oauth2/v2.0/logout?post_logout_redirect_uri=https://localhost/myapp/
```

| Параметр |  | ОПИСАНИЕ |
| --- | --- | --- |
| `tenant` |обязательно |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `post_logout_redirect_uri` | рекомендуется | URL-адрес, на который следует возвратить пользователя после выхода. Это значение должно соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных для приложения. Если оно не указано, то пользователю будет показано универсальное сообщение конечной точки версии 2.0. |

## <a name="next-steps"></a>Дополнительная информация

* Перейдите на страницу [примеров MSAL JS](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki/Samples), чтобы приступить к созданию кода.
