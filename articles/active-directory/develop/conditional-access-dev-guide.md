---
title: Руководство для разработчиков по условному доступу в Azure Active Directory
description: Руководство для разработчиков и сценарии по условному доступу в Azure AD
services: active-directory
keywords: ''
author: CelesteDG
manager: mtillman
ms.author: celested
ms.reviewer: dadobali
ms.date: 09/24/2018
ms.service: active-directory
ms.component: develop
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.openlocfilehash: 9f0a4369d794eda047185844d5fafa49bc8a2e0d
ms.sourcegitcommit: edacc2024b78d9c7450aaf7c50095807acf25fb6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/13/2018
ms.locfileid: "53337926"
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a>Руководство для разработчиков по условному доступу в Azure Active Directory

Функция условного доступа в Azure Active Directory (Azure AD) предлагает один из нескольких способов, с помощью которых можно защитить свое приложение и службу. Условный доступ позволяет разработчикам и корпоративным клиентам защищать службы множеством способов, включая:

* Многофакторная Идентификация
* разрешение доступа к определенным службам только устройствам, зарегистрированным в Intune;
* ограничение расположения пользователей и диапазонов IP-адресов.

Дополнительные сведения обо всех возможностях условного доступа см. в статье об [условном доступе в Azure Active Directory](../active-directory-conditional-access-azure-portal.md).

Для разработчиков, создающих приложения для Azure AD, в этой статье показано, как можно использовать условный доступ, а также описано влияние доступа к ресурсам, которыми вы не управляете и к которым должны быть применены политики условного доступа. Здесь также рассматриваются последствия условного доступа в потоке On-Behalf-Of, веб-приложениях, доступе к Microsoft Graph и вызове API.

Предполагается знание [однотенантных](quickstart-v1-integrate-apps-with-azure-ad.md) и [мультитенантных](howto-convert-app-to-be-multi-tenant.md) приложений, а также [распространенных шаблонов аутентификации](authentication-scenarios.md).

## <a name="how-does-conditional-access-impact-an-app"></a>Как условный доступ влияет на приложения

### <a name="app-types-impacted"></a>Затронутые типы приложений

В самых распространенных случаях условный доступ не изменяет поведение приложения и не требует любых изменений от разработчика. Только в некоторых случаях, когда приложение опосредованно или автоматически запрашивает маркер для службы, приложение требует изменения кода для устранения проблем, возникающих при условном доступе. Это может быть так же просто, как выполнение запроса на интерактивный вход.

В частности, следующие сценарии требуют изменения в коде для устранения проблем, возникающих при условном доступе:

* приложения, обращающиеся к Microsoft Graph;
* приложения, выполняющие поток On-Behalf-Of;
* приложения, получающие доступ к нескольким службам или ресурсам;
* одностраничные приложения, использующие ADAL.js.
* веб-приложения, которые вызывают ресурс.

Политики условного доступа могут применяться к приложению, а также к веб-API, к которому получает доступ ваше приложение. Дополнительные сведения о том, как настроить политику условного доступа, см. в разделе [Краткое руководство. Требование Многофакторной идентификации для конкретных приложений с помощью условного доступа Azure Active Directory](../conditional-access/app-based-mfa.md).

В зависимости от сценария корпоративный клиент может в любое время применять и удалять политики условного доступа. Чтобы ваше приложение продолжало функционировать при применении новой политики, необходимо реализовать обработку запросов. В следующих примерах показана обработка запроса.

### <a name="conditional-access-examples"></a>Примеры условного доступа

Некоторые сценарии требуют изменений в коде для обработки условного доступа, тогда как другие работают без изменений. Ниже приведено несколько сценариев, в которых условный доступ используется для многофакторной проверки подлинности. По ним можно получить сведения о различиях.

* Создается однотенантное приложение iOS и применяется политика условного доступа. В приложении выполняется вход пользователя и оно не запрашивает доступ к API. При входе пользователя в систему политика автоматически вызывается и пользователю необходимо выполнить многофакторную проверку подлинности (MFA).
* Создается мультитенатное веб-приложение, которое использует Microsoft Graph для доступа к Exchange. Корпоративный клиент, использующий это приложение, устанавливает политику для Exchange. Если веб-приложение запрашивает маркер для Microsoft Graph, для такого приложения не будет выполняться запрос для обеспечения соответствия с политикой. Пользователь выполняет вход с использованием допустимых маркеров. Когда приложение пытается использовать этот маркер для Microsoft Graph, чтобы получить доступ к данным Exchange, запрос утверждения возвращается в веб-приложение в заголовке ```WWW-Authenticate```. Приложение затем может использовать ```claims``` в новом запросе, а пользователю будет предложено обеспечить соблюдение условий.
* Вы создаете собственное приложение, в котором используется служба среднего уровня для доступа к нисходящему API. Корпоративный клиент в организации, использующей это приложение, применяет политику к нисходящему API. Когда пользователь входит в систему, собственное приложение запрашивает доступ к среднему уровню и отправляет маркер. Средний уровень выполняет последовательность On-Behalf-Of для запроса доступа к нисходящему API. На этом этапе запрос утверждений передается на средний уровень. Средний уровень отправляет запрос обратно к собственному приложению, которое должно соответствовать политике условного доступа.

### <a name="complying-with-a-conditional-access-policy"></a>Соответствие политике условного доступа

Для нескольких различных топологий приложений политика условного доступа оценивается при установлении сеанса. Так как политика условного доступа работает с учетом степени детализации приложений и служб, точка, в которой она вызывается, в значительной степени зависит от сценария, который нужно выполнить.

Когда приложение пытается получить доступ к службе с помощью политики условного доступа, может возникнуть запрос условного доступа. Этот запрос кодируется в параметре `claims`, который поставляется в ответе Azure AD и Microsoft Graph. Ниже приведен пример этого параметра запроса:

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

Разработчики могут воспользоваться этим запросом и добавить его в новый запрос к Azure AD. При передаче этого состояния пользователю предлагается выполнить любое действие, необходимое для обеспечения соответствия политике условного доступа. В следующих сценариях описываются особенности ошибок и представлены сведения о том, как извлечь параметр.

## <a name="scenarios"></a>Сценарии

### <a name="prerequisites"></a>Предварительные требования

Условный доступ Azure AD — это функция, включенная в [Azure AD Premium](https://docs.microsoft.com/azure/active-directory/active-directory-whatis#choose-an-edition). Дополнительные сведения о требованиях к лицензиям см. в статье [Отчет о нелицензированном использовании](../active-directory-conditional-access-unlicensed-usage-report.md). Разработчики могут присоединиться к сети разработчиков [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), которая включает бесплатную подписку на Enterprise Mobility Suite, содержащую Azure AD Premium.

### <a name="considerations-for-specific-scenarios"></a>Рекомендации для конкретных сценариев

Следующая информация применима только в таких сценариях условного доступа:

* приложения, обращающиеся к Microsoft Graph;
* приложения, выполняющие поток On-Behalf-Of;
* приложения, получающие доступ к нескольким службам или ресурсам;
* одностраничные приложения, использующие ADAL.js.

В следующих разделах рассматриваются более сложные сценарии. Основным принципом работы являются политики условного доступа, которые оцениваются во время запроса маркера для службы, к которой применяется политика условного доступа, если только она не доступна через Microsoft Graph.

## <a name="scenario-app-accessing-microsoft-graph"></a>Сценарий: приложение, обращающееся к Microsoft Graph

В этом сценарии вы узнаете, как веб-приложение запрашивает доступ к Microsoft Graph. В этом случае политику условного доступа можно присвоить SharePoint, Exchange или другой службе, к которой осуществляется доступ как к рабочей нагрузке через Microsoft Graph. В этом примере предположим, что для Sharepoint Online имеется политика условного доступа.

![Схема приложения, получающего доступ к потоку Microsoft Graph](./media/conditional-access-dev-guide/app-accessing-microsoft-graph-scenario.png)

Сначала приложение запрашивает авторизацию для инструмента Microsoft Graph, которому требуется доступ к подчиненным рабочим нагрузкам без условного доступа. Запрос успешно завершается без вызова политики, а приложение получает маркеры для Microsoft Graph. На этом этапе приложение может использовать маркер доступа в запросе носителя для запрашиваемой конечной точки. Теперь приложению требуется доступ к конечной точке Sharepoint Online Microsoft Graph, например: `https://graph.microsoft.com/v1.0/me/mySite`.

Приложение уже имеет допустимый маркер Microsoft Graph, поэтому он может выполнить новый запрос без выдачи нового маркера. Этот запрос завершается сбоем, а вызовы утверждений выводятся в Microsoft Graph в виде ошибки HTTP 403 (запрещено) с запросом ```WWW-Authenticate```.

Ниже приведен пример ответа:

```
HTTP 403; Forbidden
error=insufficient_claims
www-authenticate="Bearer realm="", authorization_uri="https://login.windows.net/common/oauth2/authorize", client_id="<GUID>", error=insufficient_claims, claims={"access_token":{"polids":{"essential":true,"values":["<GUID>"]}}}"
```

Запрос утверждения находится внутри заголовка ```WWW-Authenticate```, который можно проанализировать для извлечения параметров утверждения для следующего запроса. Когда они добавлены к новому запросу, Azure AD оценивает политику условного доступа при входе пользователя. Теперь приложение соответствует политике условного доступа. Повторный запрос к конечной точке Sharepoint Online завершается успешно.

Заголовок ```WWW-Authenticate``` имеет уникальную структуру. Для него сложно выполнить синтаксический анализ для извлечения значений. Вот краткий вспомогательный метод.

```csharp
        /// <summary>
        /// This method extracts the claims value from the 403 error response from MS Graph.
        /// </summary>
        /// <param name="wwwAuthHeader"></param>
        /// <returns>Value of the claims entry. This should be considered an opaque string.
        /// Returns null if the wwwAuthheader does not contain the claims value. </returns>
        private String extractClaims(String wwwAuthHeader)
        {
            String ClaimsKey = "claims=";
            String ClaimsSubstring = "";
            if (wwwAuthHeader.Contains(ClaimsKey))
            {
                int Index = wwwAuthHeader.IndexOf(ClaimsKey);
                ClaimsSubstring = wwwAuthHeader.Substring(Index, wwwAuthHeader.Length - Index);
                string ClaimsChallenge;
                if (Regex.Match(ClaimsSubstring, @"}$").Success)
                {
                    ClaimsChallenge = ClaimsSubstring.Split('=')[1];
                }
                else
                {
                    ClaimsChallenge = ClaimsSubstring.Substring(0, ClaimsSubstring.IndexOf("},") + 1);
                }
                return ClaimsChallenge;
            }
            return null;
        }
```

Примеры кода, демонстрирующие способ обработки запросов утверждений для ADAL .NET, см. в [примерах кода On-Behalf-Of](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).

## <a name="scenario-app-performing-the-on-behalf-of-flow"></a>Сценарий: приложение, выполняющее поток On-Behalf-Of

В этом сценарии рассматривается вариант, при котором собственное приложение вызывает веб-службу или API. Эта служба, в свою очередь, выполняет последовательность On-Behalf-Of для вызова подчиненной службы. В нашем случае применяется политика условного доступа к подчиненной службе (веб-API 2) и используется собственное приложение, а не серверное приложение или управляющая программа.

![Схема приложения, выполняющего поток On-Behalf-Of](./media/conditional-access-dev-guide/app-performing-on-behalf-of-scenario.png)

В изначальном запросе маркера для веб-API 1 не отображается запрос на многофакторную проверку подлинности пользователя, так как веб-API 1 может не всегда получить доступ к подчиненному API. Когда веб-API 1 пытается запросить маркер от имени пользователя для веб-API 2, запрос завершается ошибкой, так как пользователь не выполнил вход и не прошел многофакторную проверку подлинности.

Azure AD возвращает ответ HTTP с некоторыми полезными данными:

> [!NOTE]
> В этом примере это описание ошибки многофакторной проверки подлинности, однако имеется широкий диапазон действий типа `interaction_required`, которые могут быть связаны с условным доступом.

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

В веб-API 1 перехватывается ошибка `error=interaction_required` и отправляется запрос `claims` в классическое приложение. На этом этапе классическое приложение может сделать новый вызов `acquireToken()` и добавить запрос `claims` в качестве дополнительного параметра строки запроса. Новый запрос требует от пользователя выполнить многофакторную проверку подлинности, отправить новый маркер в веб-API 1 и завершить поток On-Behalf-Of.

Чтобы опробовать этот сценарий, см. [пример кода .NET](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca). Он демонстрирует передачу запроса утверждений из веб-API 1 в собственное приложение и создание запроса в клиентском приложении.

## <a name="scenario-app-accessing-multiple-services"></a>Сценарий: приложение, обращающееся к нескольким службам

В этом сценарии рассматривается вариант, при котором веб-приложение получает доступ к двум службам, одной из которых присвоена политика условного доступа. В зависимости от логики приложения ему может не потребоваться доступ к обеим веб-службам. В этом сценарии порядок запроса маркера играет важную роль при взаимодействии с пользователем.

Предположим, что у нас есть веб-службы A и B. К веб-службе B применяется политика условного доступа. Хотя первоначальный интерактивный запрос на аутентификацию требует согласия для обеих служб, политика условного доступа не требуется постоянно. Если приложение запрашивает маркер для веб-службы B, тогда вызывается политика и последующие запросы к веб-службе A также выполняются следующим образом.

![Схема приложения, получающего доступ к нескольким службам](./media/conditional-access-dev-guide/app-accessing-multiple-services-scenario.png)

Кроме того, если приложение первоначально запрашивает маркер для веб-службы A, пользователь не вызывает политику условного доступа. Это позволяет разработчику приложения контролировать взаимодействие с пользователем и не вызывать политику условного доступа постоянно. Непростым случаем является последовательный запрос приложением маркера для веб-службы В. На этом шаге пользователю необходимо обеспечить соответствие политике условного доступа. Когда приложение пытается выполнить операцию `acquireToken`, может произойти следующая ошибка (как показано на схеме ниже):

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

![Приложение, получающее доступ к нескольким службам, запрашивающим новый маркер](./media/conditional-access-dev-guide/app-accessing-multiple-services-new-token.png)

Если приложение использует библиотеку ADAL, при сбое получения маркера всегда осуществляется повторная попытка в интерактивном режиме. Во время такого интерактивного запроса пользователь может выполнить условный доступ. Пользователь может так сделать, если запрос не является запросом `AcquireTokenSilentAsync` или `PromptBehavior.Never`. В этом случае приложение должно выполнить интерактивный запрос ```AcquireToken```, чтобы дать пользователю возможность обеспечить соответствие политике.

## <a name="scenario-single-page-app-spa-using-adaljs"></a>Сценарий: одностраничное приложение (SPA), использующее ADAL.js

В этом сценарии одностраничное приложение (SPA) использует ADAL.js для вызова веб-API, для которого применяется условный доступ. Это простая архитектура, однако она имеет некоторые особенности, которые необходимо учитывать при разработке с использованием условного доступа.

В ADAL.js есть несколько функций получения маркеров: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)` и `acquireTokenRedirect(…)`.

* `login()` получает маркер идентификатора через интерактивный запрос на вход, но не получает маркер доступа для любой службы (включая защищенный условным доступом веб-API).
* `acquireToken(…)` может использоваться для автоматического получения маркера доступа. Это означает, что он никогда не будет отображаться на пользовательском интерфейсе.
* `acquireTokenPopup(…)` и `acquireTokenRedirect(…)` используются для автоматического запроса маркера для ресурса. Это означает, что они всегда отображаются на пользовательском интерфейсе входа.

Если приложению требуется маркер доступа для вызова веб-API, оно попробует выполнить функцию `acquireToken(…)`. Если срок действия маркера истек или необходимо обеспечить соответствие политике условного доступа, функция *acquireToken* завершится сбоем и приложение будет использовать `acquireTokenPopup()` или `acquireTokenRedirect()`.

![Схема одностраничного приложения, использующего последовательность ADAL](./media/conditional-access-dev-guide/spa-using-adal-scenario.png)

Давайте подробно рассмотрим пример со сценарием условного доступа. Пользователь только что зашел на веб-сайт и не имеет сеанса. Мы выполним вызов `login()` и получим идентификатор маркера без многофакторной проверки подлинности. Затем пользователь нажимает кнопку, которая требует от приложения запросить данные из веб-API. Приложение пытается выполнить вызов `acquireToken()`, но попытка завершается неудачей, так как пользователь еще не прошел многофакторную проверку подлинности и должен обеспечить соответствие политике условного доступа.

Azure AD отправляет следующий ответ HTTP:

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
```

Приложению необходимо перехватить `error=interaction_required`. Приложение может использовать `acquireTokenPopup()` или `acquireTokenRedirect()` для того же ресурса. Пользователь вынужден пройти многофакторную проверку подлинности. После того как пользователь завершит многофакторную проверку подлинности, приложению выдается новый маркер доступа для запрашиваемого ресурса.

Чтобы проверить этот сценарий, см. [пример кода On-Behalf-Of JS SPA](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca). В этом примере кода для демонстрации этого сценария используется политика условного доступа и веб-API, зарегистрированный ранее с помощью JS SPA. По примеру можно узнать, как правильно обрабатывать запросы утверждений и получить маркер доступа, который может использоваться для веб-API. Кроме того ознакомьтесь с общим [примером кода Angular.js](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) для получения руководства по Angular SPA.


## <a name="see-also"></a>См. также

* Дополнительные сведения о возможностях условного доступа см. в статье об [условном доступе в Azure Active Directory](../active-directory-conditional-access-azure-portal.md).
* Дополнительные примеры кода Azure AD доступны в [репозитории примеров кода GitHub](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).
* Дополнительные сведения о пакете SDK ADAL и доступу к справочной документации см. в статье [Библиотеки проверки подлинности Azure Active Directory](active-directory-authentication-libraries.md).
* Дополнительные сведения о сценариях с несколькими клиентами см. в статье [Как реализовать вход любого пользователя Azure Active Directory (AD) с помощью шаблона мультитенантного приложения](howto-convert-app-to-be-multi-tenant.md).
