
<properties
    pageTitle="Поток учетных данных клиента OAuth версии 2.0 Azure AD | Microsoft Azure"
    description="Построение веб-приложений с помощью реализации протокола проверки подлинности OAuth 2.0 в Azure AD."
    services="active-directory"
    documentationCenter=""
    authors="dstrockis"
    manager="msmbaldwin"
    editor=""/>

<tags
    ms.service="active-directory"
    ms.workload="identity"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="09/26/2016"
    ms.author="dastrock"/>


# <a name="v2.0-protocols---oauth-2.0-client-credentials-flow"></a>Протоколы версии 2.0: поток учетных данных клиента OAuth 2.0

[Предоставление учетных данных клиента OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-4.4), которое иногда называют также "двусторонний OAuth", можно использовать для доступа к сетевым ресурсам с помощью удостоверения приложения.  Обычно этот процесс используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без участия конечного пользователя.  Такие типы приложений часто называют **управляющими программами** или **учетными записями служб**.

> [AZURE.NOTE]
    Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0.  Чтобы определить, следует ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).

В стандартном сценарии трехстороннего OAuth клиентскому приложению предоставляется разрешение на доступ к ресурсу от имени определенного пользователя.  Обычно разрешение **делегируется** от пользователя к приложению во время [предоставления разрешений](active-directory-v2-scopes.md) .  Однако в потоке клиентских учетных данных разрешения предоставляются **непосредственно** в приложение.  Когда приложение предоставляет маркер для ресурса, ресурс обеспечивает наличие прав на выполнение некоторых операций у приложения, а не у пользователя.

## <a name="protocol-diagram"></a>Схема протокола
Весь поток клиентских учетных данных выглядит примерно следующим образом (каждый этап подробно рассматривается ниже).

![Поток учетных данных клиента](../media/active-directory-v2-flows/convergence_scenarios_client_creds.png)

## <a name="get-direct-authorization"></a>Получение прямой авторизации 
Приложение, как правило, получает прямую авторизацию на доступ к ресурсу двумя способами: через список управления доступом в ресурсе или путем назначения разрешений приложению в Azure AD.  Существует еще несколько способов авторизации клиента ресурса. Каждый сервер ресурсов может выбрать самый оптимальный метод для приложения.  Эти два метода являются самыми распространенными в Azure AD, и их рекомендуется использовать для клиентов и ресурсов, которым требуется выполнить поток клиентских учетных данных.

### <a name="access-control-lists"></a>Доступ к спискам управления
Определенный поставщик ресурсов может принудительно применять проверку авторизации на основе списка известных идентификаторов приложений, а также предоставлять определенный уровень доступа.  Когда ресурс получает маркер из конечной точки версии 2.0, он может расшифровать этот маркер и извлечь идентификатор клиентского приложения из утверждений `appid` и `iss`.  Затем он может сравнить приложение в соответствии с некоторыми поддерживаемыми списками управления доступом.  Степень детализации и методы списка управления доступом отличаются для разных ресурсов.

Распространенный сценарий использования для таких списков управления доступом — инструмент выполнения тестов для веб-приложения или веб-API.  Веб-API может предоставить только несколько прав из полного набора для различных клиентов.  Однако для выполнения комплексных тестов в API создается тестовый клиент, получающий маркеры из конечной точки версии 2.0 и отправляющий их в API.  Затем API может проверить идентификатор приложения тестового клиента с помощью списка управления доступом для получения доступа ко всем возможностям API.  Обратите внимание, что при наличии такого списка в службе следует не только выполнять проверку `appid` вызывающего объекта, но и проверять уровень доверия `iss` маркера.

Этот тип авторизации часто используется в управляющих программах и учетных записях служб, которым требуется доступ к данным пользователей-клиентов с личной учетной записью Майкрософт.  Требуемую авторизацию для корпоративных данных рекомендуется получить через разрешения приложения.

### <a name="application-permissions"></a>Разрешения приложения
Вместо использования списков управления доступом интерфейсы API могут предоставлять набор **разрешений приложения** , которые могут быть предоставлены приложению.  Администратор организации предоставляет разрешения приложению, которые можно использовать только для получения доступа к данным, принадлежащим этой организации и ее сотрудникам.  Например, Microsoft Graph предоставляет разрешения приложений для разных типов действий:

- чтение почты во всех почтовых ящиках;
- чтение и написание почты во всех почтовых ящиках;
- отправка почты любым пользователем;
- чтение данных каталога;
- [и многое другое.](https://graph.microsoft.io)

Чтобы получить эти разрешения в приложении, можно выполнить следующие действия.

#### <a name="request-the-permissions-in-the-app-registration-portal"></a>Запрос разрешений на портале регистрации приложения

- Перейдите к приложению на сайте [apps.dev.microsoft.com](https://apps.dev.microsoft.com) или [создайте приложение](active-directory-v2-app-registration.md), если оно еще не создано.  Необходимо создать хотя бы один секретный ключ приложения.
- Найдите раздел **Непосредственные разрешения приложения** и добавьте разрешения, необходимые для приложения.
- **Сохраните** регистрацию приложения.

#### <a name="recommended:-sign-the-user-into-your-app"></a>Выполнение входа пользователя в приложение (рекомендуется)

Обычно при создании приложения, использующего разрешения, для него нужно настроить страницу или представление, в которых администратор может утвердить разрешения приложения.  Эта страница не может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения.  Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно определить организацию, к которой он принадлежит, перед запросом на утверждение разрешения на использование приложения.  Это не является обязательным действием. Однако таким образом можно обеспечить более интуитивно понятную среду для пользователей вашей организации.  Чтобы выполнить вход пользователя, следуйте нашим [указаниям в учебниках по протоколу версии 2.0](active-directory-v2-protocols.md).

#### <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у администратора компании, можно перенаправить пользователя в **конечную точку предоставления согласия администратора**версии 2.0.

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/{tenant}/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
```

```
// Pro Tip: Try pasting the below request in a browser!
```

```
https://login.microsoftonline.com/common/adminconsent?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&state=12345&redirect_uri=http://localhost/myapp/permissions
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| tenant | обязательно | Клиент каталога, из которого необходимо запросить разрешение.  Можно указать в виде GUID или понятного имени.  Если неизвестно, какому клиенту принадлежит пользователь, и нужно обеспечить его вход с помощью любого клиента, используйте `common`. |
| client_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| redirect_uri | обязательно | URI перенаправления, которому требуется направлять ответ для обработки в приложении.  Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. Он может содержать дополнительные сегменты пути. |
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе токена.  Это может быть строка любого контента.  Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |

На этом этапе Azure AD будет обеспечивать вход только администратора клиента для выполнения запроса.  Администратору будет предложено утвердить все непосредственные разрешения приложения, запрошенные для приложения на портале регистрации. 

##### <a name="successful-response"></a>Успешный ответ
Если администратор утверждает разрешения для приложения, успешный ответ будет выглядеть следующим образом:

```
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | Описание |
| ----------------------- | ------------------------------- | --------------- |
| tenant | Клиент каталога, предоставивший приложению запрошенные разрешения в виде GUID. |
| state | Значение, включенное в запрос, которое также возвращается в ответе токена.  Это может быть строка любого контента.  Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| admin_consent | Для этого параметра будет задано значение `True`. |


##### <a name="error-response"></a>Сообщение об ошибке
Если администратор не утверждает разрешения для приложения, сбой ответа будет выглядеть следующим образом:

```
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | Описание |
| ----------------------- | ------------------------------- | --------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки.  |

После получения успешного ответа от конечной точки подготовки приложения приложение получило запрошенные непосредственные разрешения.  Теперь можно перейти к запросу маркера для требуемого ресурса.

## <a name="get-a-token"></a>Получение маркера
Получив требуемую авторизацию для приложения, можно перейти к получению маркеров доступа для интерфейсов API.  Для получения маркера путем предоставления учетных данных клиента отправьте запрос POST конечной точке версии 2.0 `/token` :

```
POST /common/oauth2/v2.0/token HTTP/1.1
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=535fb089-9ff3-47b6-9bfb-4f1264799865&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default&client_secret=qWgdYAmab0YSkuL1qKv5bPX&grant_type=client_credentials
```

```
curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d 'client_id=535fb089-9ff3-47b6-9bfb-4f1264799865&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default&client_secret=qWgdYAmab0YSkuL1qKv5bPX&grant_type=client_credentials' 'https://login.microsoftonline.com/common/oauth2/v2.0/token'
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| client_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| scope | обязательно | Значение, передаваемое для параметра `scope` в этом запросе, должно быть идентификатором требуемого ресурса (URI идентификатора приложения) с суффиксом `.default`.  Поэтому в примере Microsoft Graph значение должно быть `https://graph.microsoft.com/.default`.  Это значение сообщает конечной точке версии 2.0, что среди всех непосредственных разрешений приложения, настроенных для приложения, она должна выдать маркер тех, которые относятся к нужному ресурсу. |
| client_secret | обязательно | Секретный ключ приложения, созданный на портале регистрации для приложения. |
| grant_type | обязательно | Этот параметр должен содержать значение `client_credentials`. | 

#### <a name="successful-response"></a>Успешный ответ
Успешный ответ будет иметь следующий вид:

```
{
  "token_type": "Bearer",
  "expires_in": 3599,
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBP..."
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| access_token | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API. |
| token_type | Указывает значение типа маркера. Единственный тип, поддерживаемый Azure AD — `Bearer`  |
| expires_in | Срок действия маркера доступа (в секундах). |

#### <a name="error-response"></a>Сообщение об ошибке
Сообщение об ошибке будет иметь следующий вид:

```
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/.default is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности.  |
| error_codes | Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике.  |
| Timestamp | Время возникновения ошибки. |
| trace_id | Уникальный идентификатор для запроса, который может помочь при диагностике.  |
| correlation_id | Уникальный идентификатор для запроса, который может помочь при диагностике нескольких компонентов. |

## <a name="use-a-token"></a>Использование маркера
После получения маркера его можно использовать для запросов к ресурсу.  По истечении срока действия маркера просто повторно отправьте запрос к конечной точке `/token` для получения нового маркера доступа.

```
GET /v1.0/me/messages
Host: https://graph.microsoft.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

```
// Pro Tip: Try the below command out! (but replace the token with your own)
```

```
curl -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q" 'https://graph.microsoft.com/v1.0/me/messages'
```

## <a name="code-sample"></a>Пример кода
Пример приложения, реализующего предоставление учетных данных пользователя с помощью конечной точки предоставления согласия администратора, см. в [примере кода управляющей программы версии 2.0](https://github.com/Azure-Samples/active-directory-dotnet-daemon-v2).


<!--HONumber=Oct16_HO2-->


