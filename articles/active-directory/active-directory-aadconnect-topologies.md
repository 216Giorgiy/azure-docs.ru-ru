<properties
   pageTitle="Топологии Azure AD Connect | Microsoft Azure"
	description="В этой статье подробно описываются поддерживаемые и неподдерживаемые топологии Azure AD Connect."
	services="active-directory"
	documentationCenter=""
	authors="AndKjell"
	manager="stevenpo"
	editor=""/>

<tags
   ms.service="active-directory"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="identity"
	ms.date="08/24/2015"
	ms.author="andkjell"/>

# Топологии Azure AD Connect.

В этой статье рассматриваются различные локальные топологии и топологии Azure AD, образующие единое решение интеграции в сочетании со службами синхронизации Azure AD Connect. Здесь описываются и поддерживаемые, и неподдерживаемые конфигурации.

Условные обозначения в статье:

| Описание | Значок |
|-----|-----|
| Локальный лес Active Directory | ![AD](./media/active-directory-aadconnect-topologies/LegendAD1.png)|
| Active Directory с фильтрацией импорта | ![AD](./media/active-directory-aadconnect-topologies/LegendAD2.png)|
| Сервер синхронизации Azure AD Connect | ![Sync](./media/active-directory-aadconnect-topologies/LegendSync1.png)|
| Промежуточный режим сервера синхронизации Azure AD Connect | ![Sync](./media/active-directory-aadconnect-topologies/LegendSync2.png)|
| GALSync с FIM2010 или MIM2016 | ![Sync](./media/active-directory-aadconnect-topologies/LegendSync3.png)|
| Сервер синхронизации Azure AD Connect, подробно |![Sync](./media/active-directory-aadconnect-topologies/LegendSync4.png)|
| Каталог Azure AD |![AAD](./media/active-directory-aadconnect-topologies/LegendAAD.png)|
| Неподдерживаемый сценарий | ![Не поддерживается](./media/active-directory-aadconnect-topologies/LegendUnsupported.png)



## Один лес, один каталог Azure AD
![SingleForestSingleDirectory](./media/active-directory-aadconnect-topologies/SingleForestSingleDirectory.png)

Наиболее стандартная топология, включающая один локальный лес с одним или несколькими доменами, и один каталог Azure AD (так называемый клиент). Проверка подлинности Azure AD осуществляется при помощи синхронизации паролей. Эта топология поддерживается экспресс-установкой Azure AD Connect.

![SingleForestFilteredUnsupported](./media/active-directory-aadconnect-topologies/SingleForestFilteredUnsupported.png)

Нельзя иметь несколько серверов синхронизации Azure AD Connect, подключенных к каталогу Azure AD, даже если они настроены на синхронизацию взаимоисключающего набора объектов (за исключением [промежуточного сервера](#staging-server)). Случай с промежуточным сервером допустим, так как один домен в лесу недоступен из общего расположения в сети или при попытке распределить нагрузку синхронизации между несколькими серверами.

## Несколько лесов, один каталог Azure AD
![MultiForestSingleDirectory](./media/active-directory-aadconnect-topologies/MultiForestSingleDirectory.png)

Во многих организациях есть среды, которые включают несколько локальных лесов Active Directory. Существуют разные причины для развертывания нескольких локальных лесов Active Directory. Типичными примерами являются проекты с лесами ресурсов учетных записей, лесами, связанными со слияниями и поглощениями, а также лесами, используемыми для передачи данных внешним исполнителям.

При наличии нескольких лесов каждый из них должен быть доступным для одного сервера синхронизации Azure AD Connect. Сервер не обязательно присоединяется к домену и может размещаться в зоне DMZ, если у него должна быть возможность доступа ко всем лесам.

Мастер Azure AD Connect предложит несколько вариантов объединения пользователей. Поэтому даже если один пользователь представлен несколько раз в разных лесах, в Azure AD он будет представлен только один раз. Далее приведено описание нескольких стандартных топологий. Чтобы указать свой тип топологии, в мастере установки вам нужно будет указать путь установки и выбрать соответствующий параметр на странице «Уникальная идентификация пользователей». Функция объединения работает только в отношении пользователей. При наличии дубликатов группы они не будут объединены, если используется конфигурация по умолчанию.

В следующем разделе описываются следующие стандартные топологии: [отдельные топологии](#multiple-forests-separate-topologies), [полная сетка](#multiple-forests-full-mesh-with-optional-galsync) и [топология ресурсов учетной записи](#multiple-forests-account-resource-forest).

В конфигурации Azure AD Connect Sync по умолчанию предполагается следующее. 1. У каждого пользователя есть только одна включенная учетная запись. Лес, в котором располагается эта учетная запись, используется для проверки подлинности пользователя. Это относится к синхронизации паролей и федерации. Из этого леса поступают значения userPrincipalName и sourceAnchor/immutableID. 2. У каждого пользователя есть только один почтовый ящик. 3. Лес, в котором размещаются почтовые ящики пользователей, характеризуется наилучшим качеством данных для атрибутов, отображаемых в глобальном списке адресов Exchange (GAL). Если у пользователя нет почтового ящика, для передачи значений этих атрибутов может использоваться любой лес. 4. Если у вас есть связанный почтовый ящик, то также должна быть и другая учетная запись в другом лесу, используемая для входа.

Если ваша среда не соответствует этим предположениям, происходит следующее. - Если у вас есть несколько активных учетных записей или несколько почтовых ящиков, модуль синхронизации выберет одну учетную запись или почтовый ящик и проигнорирует остальные. - Если вы связали почтовые ящики, но не связали учетную запись, эти учетные записи не будут экспортированы в Azure AD и пользователь не будет принадлежать к какой-либо группе. В DirSync связанный почтовый ящик будет представлен как обычный почтовый ящик. Такое отличие в поведении является намеренным и служит для поддержки различных сценариев леса.

![MultiForestMultiSyncUnsupported](./media/active-directory-aadconnect-topologies/MultiForestMultiSyncUnsupported.png)

Нельзя иметь более одного сервера синхронизации Azure AD Connect, подключенного к одному каталогу Azure AD (за исключением [промежуточного сервера](#staging-server)).

### Несколько лесов. Отдельные топологии.
«Во всех каталогах пользователи представлены только один раз».

![MultiForestUsersOnce](./media/active-directory-aadconnect-topologies/MultiForestUsersOnce.png)

![MultiForestSeperateTopologies](./media/active-directory-aadconnect-topologies/MultiForestSeperateTopologies.png)

В этой среде все локальные леса обрабатываются как отдельные сущности. Ни один пользователь не может присутствовать в каком-либо другом лесу. У каждого леса есть своя организация Exchange. Синхронизация GALSync между лесами отсутствует. Такая ситуация может возникать после слияний и поглощений, а также в организации, в которой все подразделения функционируют изолированно друг от друга. В Azure AD эти леса будут находиться в одной организации и отображаться в едином глобальном списке адресов. На этом рисунке каждый объект в каждом лесу будет представлен в метавселенной в единственном экземпляре с объединением в целевом каталоге Azure AD.

### Несколько лесов. Сопоставление пользователей.
Сходство всех сценариев с несколькими лесами, когда вы выбираете один из параметров в группе «Удостоверения пользователя существуют в нескольких каталогах», заключается в том, что во всех лесах есть свои группы рассылки и группы безопасности. Они состоят из различных пользователей, контактов и внешних участников безопасности (FSP).

Внешние участники безопасности используются в ADDS для представления элементов из других лесов в группе безопасности. Модуль синхронизации будет сопоставлять внешних участников безопасности с реальными пользователями и представлять группу безопасности в Azure AD. В этой группе все внешние участники безопасности будут сопоставлены с реальными объектами.

### Несколько лесов. Полная сетка с дополнительным решением GALSync.
«Удостоверения пользователя существуют в нескольких каталогах. Сопоставление с использованием атрибута mail».

![MultiForestUsersMail](./media/active-directory-aadconnect-topologies/MultiForestUsersMail.png)

![MultiForestFullMesh](./media/active-directory-aadconnect-topologies/MultiForestFullMesh.png)

Топология полной сетки позволяет размещать пользователей и ресурсы в любом лесу. Как правило, между такими лесами образуются двусторонние отношения доверия.

Если Exchange присутствует в нескольких лесах, может быть доступным дополнительное локальное решение GALSync. Это решение представляет пользователя из одного леса как контакт во всех остальных лесах. Решение GALSync зачастую реализуется с помощью Forefront Identity Manager 2010 или Microsoft Identity Manager 2016. Azure AD Connect нельзя использовать в локальном решении GALSync.

В этом сценарии объекты удостоверений соединяются с помощью атрибута mail. В результате пользователь с почтовым ящиком в одном лесу соединяется с контактами в других лесах.

### Несколько лесов. Лес ресурсов учетной записи.
«Удостоверения пользователя существуют в нескольких каталогах. Сопоставление с использованием атрибутов ObjectSID и msExchMasterAccountSID».

![MultiForestUsersObjectSID](./media/active-directory-aadconnect-topologies/MultiForestUsersObjectSID.png)

![MultiForestAccountResource](./media/active-directory-aadconnect-topologies/MultiForestAccountResource.png)

В топологии леса ресурсов учетных записей есть один или несколько лесов учетных записей с активными учетными записями пользователей.

В этом сценарии есть один лес с отношениями доверия со всеми лесами учетных записей. Обычно у такого леса расширенная схема AD с Exchange и Lync. Все службы Exchange и Lync, а также другие общие службы, находятся в этом лесу. У пользователей есть отключенные учетные записи в этом лесу. С лесом учетных записей связан почтовый ящик.

## Аспекты топологии в Office 365.
Некоторые рабочие нагрузки Office 365 налагают ряд ограничений на поддерживаемые топологии. Если вы планируете использовать одну из топологий, прочитайте соответствующую статью о топологиях, поддерживаемых рабочей нагрузкой.

| Рабочая нагрузка | |
| --------- | --------- |
| Exchange Online |	Если есть несколько локальных организаций Exchange (сервер Exchange развернут для нескольких лесов), необходимо использовать Exchange 2013 с пакетом обновления 1 или более поздней версии. Подробные сведения можно найти в статье [Гибридные развертывания с несколькими лесами Active Directory](https://technet.microsoft.com/ru-RU/library/jj873754.aspx). |
| Skype для бизнеса | При использовании нескольких локальных лесов единственной поддерживаемой топологией является лес ресурсов учетной записи. Сведения о поддерживаемых топологиях можно найти в статье [Требования к среде Skype для бизнеса Server 2015](https://technet.microsoft.com/ru-RU/library/dn933910.aspx). |

## Промежуточный сервер.
![StagingServer](./media/active-directory-aadconnect-topologies/MultiForestStaging.png)

Azure AD Connect поддерживает установку второго сервера в промежуточном режиме. В этом режиме сервер только считывает данные из всех подключенных каталогов, формируя актуальную копию учетных данных. В случае сбоя основного сервера можно легко вручную переключиться на второй сервер с помощью мастера Azure AD Connect. Желательно, чтобы второй сервер находился в другом центре обработки данных, так как он не делит инфраструктуру с основным сервером. Изменения конфигурации, внесенные на основном сервере, необходимо вручную скопировать на второй сервер.

Промежуточный сервер также можно использовать для тестирования новой конфигурации и ее воздействия на данные. Вы можете просмотреть внесенные изменения и выполнить более точную настройку. Когда новая конфигурация будет завершена, вы сможете сделать промежуточный сервер активным и перевести старый сервер в промежуточный режим.

Этот метод также можно использовать для замены сервера синхронизации и подготовки нового сервера перед отключением текущего.

Чтобы иметь несколько резервных копий в разных центрах обработки данных, можно использовать несколько промежуточных серверов.

## Множество каталогов Azure AD.
Корпорация Майкрософт рекомендует использовать один каталог в Azure AD для одной организации. Прежде чем приступать к планированию создания нескольких каталогов Azure AD, прочитайте следующие статьи. В них рассматриваются общие сценарии, которые позволяют использовать один каталог.

| Раздел | |
| --------- | --------- |
| Делегирование при помощи административных единиц | [Управление административными единицами в Azure AD](active-directory-administrative-units-management.md)

![MultiForestMultiDirectory](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectory.png)

Между сервером синхронизации Azure AD Connect и каталогом Azure AD устанавливается отношение 1:1. Для каждого каталога Azure AD потребуется установить отдельный сервер синхронизации Azure AD Connect. Экземпляры каталога Azure AD изначально изолированы, поэтому пользователи одного каталога не будут видеть пользователей другого каталога. Если так и должно быть, то такая конфигурация возможна. В противном случае следует использовать одну из описанных выше моделей с одним каталогом Azure AD.

![SingleForestFiltered](./media/active-directory-aadconnect-topologies/SingleForestFiltered.png)

В этой топологии один сервер синхронизации AAD Connect подключается к каждому каталогу Azure AD. На серверах синхронизации Azure AD Connect необходимо настроить правила фильтрации. Каждый сервер должен обрабатывать взаимоисключающие наборы объектов. Например, каждый сервер может обслуживать определенный домен. DNS-домен может быть зарегистрирован только в одном каталоге Azure AD. При этом UPN пользователей в локальном каталоге AD должны использовать отдельные пространства имен. Например, на рисунке выше в локальном каталоге AD регистрируется три суффикса UPN: contoso.com, fabrikam.com и wingtiptoys.com. Пользователи каждого локального домена AD используют различные пространства имен.

В этой топологии между экземплярами каталога Azure AD отсутствует GALsync, поэтому адресная книга в Exchange Online и Skype для бизнеса покажет только пользователей одного каталога.

В этой топологии вы можете включить гибридное развертывание Exchange с локальным каталогом Active Directory только для одного каталога Azure AD.

Требование к взаимоисключающим наборами объектов также применяется и в отношении обратной записи. В результате эта топология не будет поддерживать некоторые функции обратной записи, так как они предполагают наличие одной локальной конфигурации. К таким функциям относятся: - обратная запись групп с конфигурацией по умолчанию, - обратная запись устройств.

![SingleForestMultiDirectoryUnsupported](./media/active-directory-aadconnect-topologies/SingleForestMultiDirectoryUnsupported.png) ![SingleForestMultiConnectorsUnsupported](./media/active-directory-aadconnect-topologies/SingleForestMultiConnectorsUnsupported.png)

Синхронизация одного пользователя с несколькими каталогами Azure AD не поддерживается. Также нельзя изменить конфигурацию таким образом, чтобы пользователи одного каталога Azure AD отображались в другом каталоге Azure AD как контакты. Точно так же нельзя изменить настройки службы синхронизации Azure AD Connect для подключения к различным каталогам Azure AD.

![MultiForestMultiDirectoryGALSync1Unsupported](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectoryGALSync1Unsupported.png) ![MultiForestMultiDirectoryGALSync2Unsupported](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectoryGALSync2Unsupported.png)

Каталоги Azure AD являются изолированными по своей природе. Нельзя настроить службу синхронизации Azure AD Connect для чтения данных из другого каталога Azure AD, чтобы создать общий и единый глобальный список адресов между каталогами. Также служба синхронизации Azure AD не может экспортировать пользователей в виде контактов в другой локальный каталог AD.

![MultiForestMultiDirectoryGALSync](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectoryGALSync.png)

Для синхронизации пользователей между двумя организациями Exchange с помощью GALsync можно использовать FIM2010/MIM2016. Пользователи из одной организации будут отображаться как внешние пользователи/контакты из другой организации. Затем эти локальные каталоги AD можно синхронизировать с их собственными каталогами Azure AD.

## Дальнейшие действия
Сведения об установке Azure AD Connect при использовании этих сценариев см. в статье [Выборочная установка Azure AD Connect](active-directory-aadconnect-get-started-custom.md). Дополнительные сведения о конфигурации служб синхронизации Azure AD Connect см. в статье [Службы синхронизации Azure AD Connect](active-directory-aadconnectsync-whatis.md).

<!---HONumber=August15_HO9-->