<properties
    pageTitle="Azure AD Connect: поддерживаемые топологии | Microsoft Azure"
    description="В этой статье подробно описываются поддерживаемые и неподдерживаемые топологии Azure AD Connect."
    services="active-directory"
    documentationCenter=""
    authors="AndKjell"
    manager="femila"
    editor=""/>
<tags
    ms.service="active-directory"
    ms.devlang="na"
    ms.tgt_pltfrm="na"
    ms.workload="identity"
    ms.topic="article"
    ms.date="06/27/2016"
    ms.author="billmath"/>


# <a name="topologies-for-azure-ad-connect"></a>Топологии Azure AD Connect.

В этой статье рассматриваются различные локальные топологии и топологии Azure AD, образующие единое решение интеграции в сочетании со службами синхронизации Azure AD Connect. Здесь описываются и поддерживаемые, и неподдерживаемые конфигурации.

Условные обозначения в статье:

Описание | Значок
-----|-----
Локальный лес Active Directory| ![AD](./media/active-directory-aadconnect-topologies/LegendAD1.png)
Active Directory с фильтрацией импорта| ![AD](./media/active-directory-aadconnect-topologies/LegendAD2.png)
Сервер синхронизации Azure AD Connect| ![Sync](./media/active-directory-aadconnect-topologies/LegendSync1.png)
Промежуточный режим сервера синхронизации Azure AD Connect| ![Sync](./media/active-directory-aadconnect-topologies/LegendSync2.png)
GALSync с FIM2010 или MIM2016| ![Sync](./media/active-directory-aadconnect-topologies/LegendSync3.png)
Сервер синхронизации Azure AD Connect, подробно| ![Sync](./media/active-directory-aadconnect-topologies/LegendSync4.png)
Каталог Azure AD |![AAD](./media/active-directory-aadconnect-topologies/LegendAAD.png)
Неподдерживаемый сценарий | ![Не поддерживается](./media/active-directory-aadconnect-topologies/LegendUnsupported.png)


## <a name="single-forest,-single-azure-ad-directory"></a>Один лес, один каталог Azure AD
![Один лес, один каталог](./media/active-directory-aadconnect-topologies/SingleForestSingleDirectory.png)

Наиболее стандартная топология, включающая один локальный лес с одним или несколькими доменами, и один каталог Azure AD (так называемый клиент). Для проверки подлинности Azure AD используется синхронизация паролей. Экспресс-установка Azure AD Connect поддерживает только эту топологию.

### <a name="single-forest,-multiple-sync-servers-to-one-azure-ad-directory"></a>Один лес, несколько серверов синхронизации в одном каталоге Azure AD
![Один лес, фильтрация, не поддерживается](./media/active-directory-aadconnect-topologies/SingleForestFilteredUnsupported.png)

К одному каталогу Azure AD нельзя подключить несколько серверов синхронизации Azure AD Connect (за исключением [промежуточного сервера](#staging-server)). Такая схема не поддерживается, даже если они настроены для синхронизации взаимоисключающих наборов объектов. Возможно, вы рассматривали такой вариант, если у вас нет доступа ко всем доменам леса с одного сервера или если требуется распределить нагрузку на несколько серверов.

## <a name="multiple-forests,-single-azure-ad-directory"></a>Несколько лесов, один каталог Azure AD
![Несколько лесов, один каталог](./media/active-directory-aadconnect-topologies/MultiForestSingleDirectory.png)

Во многих организациях есть среды, которые включают несколько локальных лесов Active Directory. Есть разные причины существования нескольких локальных лесов Active Directory. Типичными примерами являются проекты с лесами ресурсов учетных записей и лесами, появившимися в результате слияния или поглощения.

Если у вас есть несколько лесов, все они должны быть доступными для одного сервера синхронизации Azure AD Connect. Присоединять этот сервер к домену не обязательно. Сервер можно разместить в сети периметра, если нужно обеспечить доступ ко всему лесу.

Мастер установки Azure AD Connect предлагает несколько вариантов консолидации пользователей, представленных в нескольких лесах. Каждый пользователь должен быть представлен в Azure AD только один раз. Есть несколько распространенных топологий, которые можно настроить в режиме выборочной установки в мастере установки. Выберите вариант, соответствующий вашей топологии, на странице **Уникальная идентификация пользователей**. Функция консолидации настроена только для пользователей. В конфигурации по умолчанию дубликаты групп не консолидируются.

В следующем разделе описываются такие стандартные топологии, как [отдельные топологии](#multiple-forests-separate-topologies), [полная сетка](#multiple-forests-full-mesh-with-optional-galsync) и [топология ресурсов учетной записи](#multiple-forests-account-resource-forest).

При стандартной конфигурации Azure AD Connect предполагается следующее.

1. У каждого пользователя есть только одна включенная учетная запись. Лес, в котором располагается эта учетная запись, используется для проверки подлинности пользователя. Это предположение относится как к синхронизации паролей, так и к федерации. Параметры UserPrincipalName и sourceAnchor/immutableID поступают из этого леса.
2. У каждого пользователя есть только один почтовый ящик.
3. Лес, в котором размещаются почтовые ящики пользователей, характеризуется наилучшим качеством данных для атрибутов, отображаемых в глобальном списке адресов Exchange (GAL). Если у пользователя нет почтового ящика, для передачи значений этих атрибутов может использоваться любой лес.
4. Если у вас есть связанный почтовый ящик, то также должна быть и другая учетная запись в другом лесу, используемая для входа.

Если среда не соответствует этим предположениям, произойдет следующее.

- Если у вас несколько активных учетных записей или несколько почтовых ящиков, модуль синхронизации выберет одну учетную запись или один почтовый ящик и проигнорирует остальные.
- Связанный почтовый ящик, для которого нет другой активной учетной записи, не будет экспортирован в Azure AD. Учетная запись пользователя не будет представлена как член какой-либо группы. В DirSync связанный почтовый ящик всегда будет представлен как обычный почтовый ящик. Такое отличие в поведении является намеренным и служит для поддержки различных сценариев леса.

Дополнительные сведения можно найти в [рекомендациях по изменению конфигурации по умолчанию для Azure AD Connect](active-directory-aadconnectsync-understanding-default-configuration.md).

### <a name="multiple-forests,-multiple-sync-servers-to-one-azure-ad-directory"></a>Несколько лесов, несколько серверов синхронизации в одном каталоге Azure AD
![Несколько лесов, синхронизация, не поддерживается](./media/active-directory-aadconnect-topologies/MultiForestMultiSyncUnsupported.png)

К одному каталогу Azure AD нельзя подключить более одного сервера синхронизации Azure AD Connect. В порядке исключения можно использовать [промежуточный сервер](#staging-server).

### <a name="multiple-forests-–-separate-topologies"></a>Несколько лесов. Отдельные топологии.
**Во всех каталогах каждый пользователь представлен только один раз.**

![Несколько лесов, уникальные пользователи](./media/active-directory-aadconnect-topologies/MultiForestUsersOnce.png)

![Несколько лесов, отдельные топологии](./media/active-directory-aadconnect-topologies/MultiForestSeperateTopologies.png)

В этой среде все локальные леса обрабатываются как отдельные сущности. Ни один пользователь не может присутствовать в каком-либо другом лесу.
У каждого леса есть своя организация Exchange. Синхронизация GALSync между лесами отсутствует. Такая топология может возникать в результате слияний и поглощений, а также в организации, в которой все подразделения функционируют изолированно друг от друга. В Azure AD эти леса будут находиться в одной организации и отображаться в едином глобальном списке адресов.
На этом рисунке каждый объект в каждом лесу представлен в метавселенной в единственном экземпляре с объединением в целевом каталоге Azure AD.

### <a name="multiple-forests-–-match-users"></a>Несколько лесов. Сопоставление пользователей.
**Удостоверения пользователя существуют в нескольких каталогах.**

Для всех сценариев этого рода характерно то, что группы рассылки и группы безопасности могут состоять из пользователей, контактов и внешних субъектов безопасности.

Внешние участники безопасности используются в ADDS для представления элементов из других лесов в группе безопасности. Все внешние субъекты безопасности разрешаются в реальный объект в Azure AD.

### <a name="multiple-forests-–-full-mesh-with-optional-galsync"></a>Несколько лесов. Полная сетка с дополнительным решением GALSync.
**Удостоверения пользователя существуют в нескольких каталогах. Сопоставление с использованием атрибута mail.**

![Несколько лесов, почта пользователей](./media/active-directory-aadconnect-topologies/MultiForestUsersMail.png)

![Несколько лесов, полная сетка](./media/active-directory-aadconnect-topologies/MultiForestFullMesh.png)

Топология полной сетки позволяет размещать пользователей и ресурсы в любом лесу. Как правило, между такими лесами образуются двусторонние отношения доверия.

Если Exchange присутствует в нескольких лесах, может быть доступным дополнительное локальное решение GALSync. Каждый пользователь будет представлен во всех остальных лесах как контакт. Решение GALSync зачастую реализуется с помощью Forefront Identity Manager 2010 или Microsoft Identity Manager 2016. Azure AD Connect нельзя использовать в локальном решении GALSync.

В этом сценарии объекты удостоверений соединяются с помощью атрибута mail. Пользователь с почтовым ящиком в одном лесу объединяется с контактами в других лесах.

### <a name="multiple-forests-–-account-resource-forest"></a>Несколько лесов. Лес ресурсов учетной записи.
**Удостоверения пользователя существуют в нескольких каталогах. Сопоставление с использованием атрибутов ObjectSID и msExchMasterAccountSID.**

![Несколько лесов, ObjectSID пользователей](./media/active-directory-aadconnect-topologies/MultiForestUsersObjectSID.png)

![Несколько лесов, AccountResource](./media/active-directory-aadconnect-topologies/MultiForestAccountResource.png)

В топологии леса ресурсов учетных записей есть один или несколько лесов учетных записей с активными учетными записями пользователей. Также может существовать один (или несколько) лес ресурсов с отключенными учетными записями.

В этом сценарии один (или несколько) **лес ресурсов** доверяет всем **лесам учетных записей**. Обычно в лесу ресурсов используется расширенная схема AD с Exchange и Lync. Все службы Exchange и Lync, а также другие общие службы, находятся в этом лесу. У пользователей есть отключенные учетные записи в этом лесу. С лесом учетных записей связан почтовый ящик.

## <a name="office-365-and-topology-considerations"></a>Аспекты топологии в Office 365.
Некоторые рабочие нагрузки Office 365 налагают ряд ограничений на поддерживаемые топологии. Если вы планируете использовать одну из них, изучите сведения о рабочей нагрузке в разделе с описанием поддерживаемых топологий.

Рабочая нагрузка |  
--------- | ---------
Exchange Online | Если есть несколько локальных организаций Exchange (сервер Exchange развернут для нескольких лесов), необходимо использовать Exchange 2013 с пакетом обновления 1 или более поздней версии. Больше можно узнать в статье [Гибридные развертывания в нескольких лесах Active Directory](https://technet.microsoft.com/library/jj873754.aspx)
Skype для бизнеса | При использовании нескольких локальных лесов единственной поддерживаемой топологией является лес ресурсов учетной записи. Больше о поддерживаемых топологиях можно узнать в статье [Требования к среде Skype для бизнеса Server 2015](https://technet.microsoft.com/library/dn933910.aspx)

## <a name="staging-server"></a>промежуточного сервера
![промежуточного сервера](./media/active-directory-aadconnect-topologies/MultiForestStaging.png)

Azure AD Connect поддерживает установку второго сервера в **промежуточном режиме**. Сервер в этом режиме считывает данные из всех подключенных каталогов, но не записывает ничего. Он использует обычный цикл синхронизации и поэтому содержит обновленную копию данных удостоверения. При отказе основного сервера можно переключиться на промежуточный сервер. Это можно сделать в мастере Azure AD Connect. Желательно, чтобы второй сервер находился в другом центре обработки данных, так как он не делит инфраструктуру с основным сервером. Любые изменения конфигурации основного сервера следует вручную копировать на второй сервер.

С помощью промежуточного сервера также можно проверить новую пользовательскую конфигурацию и узнать, как она повлияет на данные. Вы можете просмотреть внесенные изменения и выполнить более точную настройку. Когда новая конфигурация будет завершена, вы сможете сделать промежуточный сервер активным и перевести старый сервер в промежуточный режим.

Также этот метод можно использовать для замены активного сервера синхронизации. Подготовьте новый сервер и переведите его в промежуточный режим. Убедитесь, что он работает правильно, и отключите промежуточный режим (сервер станет активным). Завершите работу текущего сервера.

Чтобы иметь несколько резервных копий в разных центрах обработки данных, можно использовать несколько промежуточных серверов.

## <a name="multiple-azure-ad-directories"></a>Множество каталогов Azure AD.
Корпорация Майкрософт рекомендует использовать один каталог в Azure AD для всей организации.
Если вы намерены создать несколько каталогов Azure AD, сначала прочитайте следующие статьи. В них рассматриваются типичные сценарии, которые позволят использовать один каталог.

Раздел |  
--------- | ---------
Делегирование при помощи административных единиц | [Управление административными единицами в Azure AD ](active-directory-administrative-units-management.md)

![Несколько лесов, несколько каталогов](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectory.png)

Между сервером синхронизации Azure AD Connect и каталогом Azure AD устанавливается отношение 1:1. Для каждого каталога Azure AD потребуется установить отдельный сервер синхронизации Azure AD Connect. Экземпляры каталога Azure AD изначально изолированы, то есть пользователи одного каталога не будут видеть пользователей другого каталога. Если так и должно быть, то такая конфигурация поддерживается. В противном случае следует использовать модель с одним каталогом Azure AD.

### <a name="each-object-only-once-in-an-azure-ad-directory"></a>Каждый объект, повторяющийся только один раз в каталоге Azure AD
![Один лес с фильтрацией](./media/active-directory-aadconnect-topologies/SingleForestFiltered.png)

В этой топологии один сервер синхронизации Azure AD Connect подключается к каждому каталогу Azure AD. На серверах синхронизации Azure AD Connect необходимо настроить правила фильтрации, чтобы они обрабатывали взаимоисключающие наборы объектов. Например, каждый сервер может обслуживать определенный домен или подразделение. DNS-домен может быть зарегистрирован только в одном каталоге Azure AD. Кроме того, имена участников-пользователей для локальных пользователей AD должны располагаться в отдельных пространствах имен. Например, на рисунке выше в локальном каталоге AD регистрируется три суффикса UPN: contoso.com, fabrikam.com и wingtiptoys.com. Пользователи каждого локального домена AD используют различные пространства имен.

Между экземплярами каталогов Azure AD не применяется GALsync. В адресной книге в Exchange Online и Skype для бизнеса отображаются только пользователи из одного каталога.

Эта топология имеет следующие ограничения для сценариев, которые поддерживаются в других случаях:

- Гибридное развертывание Exchange с локальным каталогом Active Directory можно включить только для одного каталога Azure AD.
- Устройство под управлением Windows 10 можно связать только с одним каталогом Azure AD.

Требование относительно взаимоисключающих наборов объектов также применяется и к обратной записи. Эта топология не будет поддерживать некоторые функции обратной записи, так как они предполагают наличие одной локальной конфигурации.

-   групповая обратная запись в конфигурации по умолчанию
-   Обратная запись устройств

### <a name="each-object-multiple-times-in-an-azure-ad-directory"></a>Каждый объект, повторяющийся несколько раз в каталоге Azure AD
![Один лес, несколько каталогов, не поддерживается](./media/active-directory-aadconnect-topologies/SingleForestMultiDirectoryUnsupported.png) ![Один лес, несколько соединителей, не поддерживается](./media/active-directory-aadconnect-topologies/SingleForestMultiConnectorsUnsupported.png)

- Синхронизация одного пользователя с несколькими каталогами Azure AD не поддерживается.
- Нельзя изменить конфигурацию таким образом, чтобы пользователи одного каталога Azure AD отображались в другом каталоге Azure AD как контакты.
- Нельзя изменить настройки службы синхронизации Azure AD Connect для подключения к нескольким каталогам Azure AD.

### <a name="galsync-by-using-writeback"></a>Синхронизация GALsync с помощью обратной записи
![MultiForestMultiDirectoryGALSync1Unsupported](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectoryGALSync1Unsupported.png) ![MultiForestMultiDirectoryGALSync2Unsupported](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectoryGALSync2Unsupported.png)

Каталоги Azure AD являются изолированными по своей природе.

- Нельзя настроить службу синхронизации Azure AD Connect для чтения данных из другого каталога Azure AD.
- Служба синхронизации Azure AD не может экспортировать пользователей как контакты в другой локальный каталог AD.

### <a name="galsync-with-on-premises-sync-server"></a>Синхронизация GALsync с локальным сервером синхронизации
![MultiForestMultiDirectoryGALSync](./media/active-directory-aadconnect-topologies/MultiForestMultiDirectoryGALSync.png)

Для синхронизации пользователей между двумя организациями Exchange с помощью GALsync можно локально использовать FIM2010 или MIM2016. Пользователи из одной организации будут отображаться в другой организации как внешние пользователи или контакты. Затем эти локальные каталоги AD можно синхронизировать с их собственными каталогами Azure AD.

## <a name="next-steps"></a>Дальнейшие действия
Больше об установке Azure AD Connect для этих сценариев можно узнать в статье [Выборочная установка Azure AD Connect](./aad-connect/active-directory-aadconnect-get-started-custom.md).

Узнайте больше о настройке [службы синхронизации Azure AD Connect](active-directory-aadconnectsync-whatis.md) .

Узнайте больше об [интеграции локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md).



<!--HONumber=Oct16_HO2-->


