<properties
	pageTitle="Рекомендации по использованию OAuth 2.0 в Azure Active Directory | Microsoft Azure"
	description="В этой статье описаны рекомендации по разработке приложений, использующих OAuth 2.0 в Azure Active Directory."
	services="active-directory"
	documentationCenter=".net"
	authors="priyamohanram"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/31/2016"
	ms.author="priyamo"/>


# Рекомендации по использованию OAuth 2.0 в Azure Active Directory

[AZURE.INCLUDE [active-directory-protocols](../../includes/active-directory-protocols.md)]

## Использование параметра State

Параметр `state` — это случайным образом созданное и однократно используемое значение (обычно GUID), которое клиент отправляет в запросе. Хотя это необязательный параметр, настоятельно рекомендуется использовать его в запросах кода авторизации. Ответ будет содержать то же значение `state`. Прежде чем использовать этот ответ, приложение должно проверить, совпадают ли значения.

Параметр `state` позволяет обнаруживать CSRF-атаки на клиента (подделка межсайтовых запросов). Дополнительные сведения об атаках CSRF см. в разделе, посвященном [подделке межсайтовых запросов](https://tools.ietf.org/html/rfc6749#section-10.12) в документации по OAuth 2.0 Authorization Framework.

## Кэширование маркеров доступа

Чтобы снизить число сетевых вызовов из клиентского приложения и связанные с этим задержки, клиентскому приложению следует кэшировать маркеры доступа на время существования маркера, указанное в ответе OAuth 2.0. Чтобы определить время существования маркера, используйте значения параметра `expires_in` или `expires_on`.

Если ресурс API веб-узла возвращает код ошибки `invalid_token`, это может означать, что ресурс обнаружил завершение срока действия маркера. Если наблюдается расхождение во времени клиента и ресурса, ресурс может счесть маркер истекшим до того, как этот маркер будет удален из кэша клиента. В этом случае следует удалить маркер из кэша, даже если рассчитанное время его существования еще не истекло.

## Обработка маркеров обновления

Для маркеров обновления не устанавливается определенное время существования. Обычно у маркеров обновления относительно продолжительное время существования. Но в некоторых случаях маркер обновления оказывается устаревшим или отозванным или не имеет достаточных привилегий для требуемого действия. Клиентское приложение должно ожидать и правильно обрабатывать ошибки, возвращаемые конечной точкой выдачи маркера.

При получении ответа с ошибкой маркера обновления следует удалить используемый маркер обновления и запросить новый код авторизации или маркер доступа. В частности, если вы используете маркер обновления в потоке предоставления кода авторизации и получаете ответ с кодом ошибки `interaction_required` или `invalid_grant`, следует удалить такой маркер обновления и запросить новый код авторизации.

## Проверка параметра идентификатора ресурса

Клиентское приложение должно проверить значение параметра `resource_id`, полученное в ответе. В противном случае вредоносная служба сможет использовать атаку повышения привилегий.

 Для предотвращения таких атак рекомендуется, чтобы значение resource\_id соответствовало базовому URL-адресу веб-API, к которому выполняется доступ. Например, при доступе к https://service.contoso.com/data параметр `resource_id` может иметь значение https://service.contoso.com/. Клиентское приложение должно отклонять `resource_id`, если это значение не начинается с базового URL-адреса и у вас нет возможности проверить идентификатор другим способом.

## Рекомендации по выдаче маркеров и логике повторных попыток

Azure AD поддерживает несколько конечных точек выдачи маркеров, к которым могут обращаться клиенты. С помощью следующих рекомендаций вы сможете реализовать логику повторных попыток для этих конечных точек, чтобы правильно обрабатывать непредвиденные сбои в сети или на сервере.

Логика повторных попыток позволяет обойти такие сбои, которые возвращают ошибки HTTP с кодами 500-й серии в ответ на запросы к конечной точке Azure AD. В некоторых сценариях клиентом является приложение или служба, которые отправляют автоматические запросы к Azure AD. В других сценариях, например при использовании веб-федерации с протоколом WS-Federation, клиентом является веб-браузер, и тогда конечному пользователю нужно выполнять повторные попытки вручную.

### Реализация логики повторных попыток при получении ошибок HTTP с кодами 500-й серии

Мы настоятельно рекомендуем применять логику повторных попыток, когда служба контроля доступа (ACS) Active Directory возвращает ошибки HTTP с кодами 500-й серии. А именно:

- ошибка HTTP 500 — внутренняя ошибка сервера;
- ошибка HTTP 502 — недопустимый шлюз;
- ошибка HTTP 503 — служба недоступна;
- ошибка HTTP 504 — истекло время ожидания шлюза.

В логике повторных попыток можно явно указать отдельные коды ошибок HTTP, но в целом вполне достаточно использовать эту логику при любой ошибке HTTP с кодом 500-й серии.

Логику повторных попыток не рекомендуется использовать при получении кодов ошибок HTTP 400-й серии. Получение от службы контроля доступа любого ответа с кодом ошибки HTTP 400-й серии означает, что запрос является недопустимым и его следует исправить.

Применение логики повторных попыток должно определяться кодами ошибок HTTP (например, HTTP 504 — превышено время ожидания внешнего сервера, а также любая другая ошибка HTTP 500-й серии), а не кодами ошибок ACS, такими как ACS90005. Коды ошибок ACS носят информационный характер и могут изменяться.

### При повторных попытках должен использоваться таймер отсрочки для оптимального управления потоком.

Когда клиент получает ошибку HTTP 500-й серии, ему нужно подождать, прежде чем повторно выполнять запрос. Лучше всего, если период отсрочки увеличивается с каждой последующей повторной попыткой. Такой подход позволяет быстро устранить временные ошибки в работе сети или сервера, сохраняя при этом оптимальную частоту запросов при более длительных сбоях.

Например, вы можете использовать экспоненциальный таймер отсрочки, когда с каждым повтором задержка увеличивается в геометрической прогрессии: 1 секунда перед первым повтором, 2 секунды перед вторым повтором, 4 секунды перед третьим и т. д.

Количество повторных попыток и интервалы между ними можно менять в соответствии с требованиями пользователей. Мы рекомендуем применять до пяти повторных попыток в течение пяти минут. Устранение проблем, связанных с превышением времени ожидания, требует больше времени.

## Дальнейшие действия

[Библиотеки проверки подлинности Active Directory](active-directory-authentication-libraries.md)

<!---HONumber=AcomDC_0608_2016-->