
<properties
	pageTitle="Протокол OpenID Connect модели приложений версии 2.0 | Microsoft Azure"
	description="Построение веб-приложений с помощью реализации протокола проверки подлинности OpenID Connect в Azure AD."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="msmbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="11/19/2015"
	ms.author="dastrock"/>

# Предварительная версия модели приложений 2.0: протоколы — OpenID Connect
OpenID Connect — это протокол проверки подлинности на основе OAuth 2.0, который может использоваться для безопасного входа пользователей в веб-приложения. С помощью реализации OpenID Connect в модели приложений версии 2.0 можно добавить вход и доступ к API в веб-приложения. Это руководство покажет, как сделать это независимо от языка, и содержит описание отправки и получения сообщений HTTP без использования библиотек с открытым исходным кодом.

> [AZURE.NOTE]Эти сведения относятся к общедоступной предварительной версии модели приложений 2.0. Инструкции по интеграции с общедоступной службой Azure AD можно найти в статье [Руководство разработчика по Azure Active Directory](active-directory-developers-guide.md).

[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) расширяет возможности протокола *авторизации* OAuth 2.0 и позволяет использовать его в качестве протокола *проверки подлинности*, что позволяет вам выполнять единый вход с помощью OAuth. Этот протокол вводит понятие `id_token`, маркера безопасности, который позволяет клиенту выполнять идентификацию пользователя и получать основные сведения о профиле пользователя. Так как OpenID Connect представляет собой расширение OAuth 2.0, он также позволяет приложениям безопасно получать **токены доступа**, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](active-directory-v2-protocols.md#the-basics). Мы рекомендуем использовать OpenID Connect для [веб-приложений](active-directory-v2-flows.md#web-apps), которые размещаются на сервере и доступны через веб-браузер.

## Отправка запроса на вход
Если веб-приложению требуется проверить подлинность пользователя, оно может направить его к конечной точке `/authorize`. Этот запрос похож на первый этап [потока кода авторизации OAuth 2.0](active-directory-v2-protocols-oauth-code.md) с несколькими важными различиями:

- Запрос должен содержать область `openid` в параметре `scope`.
- Параметр `response_type` должен включать `id_token`
- Запрос должен содержать параметр `nonce`

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=openid										 // Translates to the 'Read your profile' permission
&state=12345						 				 // Any value, provided by your app
&nonce=678910										 // Any value, provided by your app
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response\_type | обязательно | Должен включать `id_token` для входа в OpenID Connect. Параметр также может содержать другие типы response\_types, например `code`. |
| redirect\_uri | обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами. При использовании OpenID Connect он должен включать область `openid`, преобразующуюся в разрешение "Вход в профиль и его просмотр" в пользовательском интерфейсе предоставления разрешений. Для предоставления разрешений этот запрос может также включать другие области. |
| nonce | обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id\_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения маркера. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| response\_mode | рекомендуется | Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению. Может принимать значение "query", "form\_post" или "fragment".  
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| prompt | необязательный | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — "login", "none" и "consent". При значении `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает. Значение `prompt=none` является противоположным — оно гарантирует, что интерактивные запросы не будут выводиться ни при каких обстоятельствах. Если запрос не удастся завершить автоматически через единый вход, конечная точка версии 2.0 вернет ошибку. После входа пользователя `prompt=consent` откроет диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| login\_hint | необязательный | Можно применять для предварительного заполнения поля имени пользователя или электронного адреса на странице входа пользователя. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope`. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](active-directory-v2-scopes.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the id_token, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request
&id_token_expires_in=3600

```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id\_token | Маркер "id\_token", запрошенный приложением. Вы можете использовать маркер "id\_token" для проверки удостоверения пользователя и запуска сеанса с пользователем. Дополнительные сведения о токенах "id\_token" и их содержимом можно найти в [справочном материале по токенам конечной точки версии 2.0](active-directory-v2-tokens.md). |
| session\_state | Уникальное значение, указывающее текущий сеанс пользователя. Это значение представляет собой GUID, но его следует расценивать как непрозрачное значение, передаваемое без рассмотрения. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |
| id\_token\_expires\_in | Срок действия токена идентификации (в секундах). |


Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## Проверка маркера "id\_token"
Для проверки подлинности пользователя недостаточно просто получить маркер "id\_token". Вам также потребуется проверить подпись маркера "id\_token" и утверждения в нем в соответствии с требованиями приложения. В конечной точке версии 2.0 для подписи токенов и проверки их правильности используются [веб-токены JSON (JWTs)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Модель приложений 2.0 содержит конечную точку метаданных OpenID Connect, позволяющую приложению получать сведения о модели приложений 2.0 в среде выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Конечная точка метаданных содержит документ JSON, расположенный по ссылке:

`https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`

Одно из свойств этого документа конфигурации — `jwks_uri`, имеющее следующее значение для модели приложений 2.0:

`https://login.microsoftonline.com/common/discovery/v2.0/keys`.

Вы можете использовать открытые ключи RSA256, расположенные на этой конечной точке, для проверки подписи маркера "id\_token". В любой момент времени на этой конечной точке числятся несколько ключей, каждый из которых определяется `kid`. Заголовок токена "id\_token" также содержит утверждение `kid`, указывающее на ключ, который был использован для подписи токена "id\_token".

Дополнительные сведения можно найти в [справочном материале по токенам в модели приложений 2.0](active-directory-v2-tokens.md), включая подразделы [Проверка токенов](active-directory-v2-tokens.md#validating-tokens) и [Важные сведения о смене ключей подписи](active-directory-v2-tokens.md#validating-tokens). <!--TODO: Improve the information on this-->

После проверки подписи маркера "id\_token" вам потребуется проверить несколько утверждений:

- Проверьте утверждение `nonce` во избежание атак с использованием воспроизведения токена. Его значение должно совпадать с указанным вами в запросе на вход.
- Проверьте утверждение `aud` и убедитесь, что токен "id\_token" был выдан для вашего приложения. Его значением должен быть идентификатор `client_id` приложения.
- Проверьте утверждения `iat` и `exp`; убедитесь, что срок действия токена "id\_token" не истек.

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

- Обеспечение регистрации пользователя или организации в приложении.
- Предоставление пользователю необходимого уровня авторизации и привилегий.
- Обеспечение определенного уровня проверки подлинности, например многофакторной проверки подлинности.

Дополнительные сведения об утверждениях в токене "id\_token" можно найти в [справочном материале о токенах в модели приложений 2.0](active-directory-v2-tokens.md).

После полной проверки маркера "id\_token" вы можете начать сеанс с пользователем и использовать утверждения в маркере "id\_token" для получения сведений о пользователе в приложении. Эти сведения можно использовать для отображения, записей, авторизации и т. д.

## Отправка запроса на выход

На текущий момент предварительная версия модели приложений 2.0 не поддерживает `end_session_endpoint` OpenID Connect. Это значит, что приложение не может отправлять запросы на конечную точку версии 2.0 для прекращения сеанса пользователя и очистки файлов cookie, установленных конечной точкой версии 2.0. Для выполнения выхода пользователя приложение может просто завершить собственный сеанс с пользователем, не затрагивая сеанс пользователя с конечной точкой версии 2.0. При следующей попытке входа пользователь увидит страницу выбора учетной записи с перечнем учетных записей, в которые выполнен вход. На этой странице пользователь может выйти из любой учетной записи, тем самым завершая сеанс с конечной точкой версии 2.0.

<!--

When you wish to sign the user out of the  app, it is not sufficient to clear your app's cookies or otherwise end the session with the user.  You must also redirect the user to the v2.0 endpoint for sign out.  If you fail to do so, the user will be able to re-authenticate to your app without entering their credentials again, because they will have a valid single sign-on session with the v2.0 endpoint.

You can simply redirect the user to the `end_session_endpoint` listed in the OpenID Connect metadata document:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/logout?
post_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
```

| Parameter | | Description |
| ----------------------- | ------------------------------- | ------------ |
| post_logout_redirect_uri | recommended | The URL which the user should be redirected to after successful logout.  If not included, the user will be shown a generic message by the v2.0 endpoint.  |

-->

## Сводная диаграмма входа
Простейший поток входа включает следующие этапы:

![Дорожки OpenID Connect](../media/active-directory-v2-flows/convergence_scenarios_webapp.png)

## Получение токенов доступа
Многим веб-приложениям требуется не только выполнить вход пользователя, но и получить доступ к веб-службе от лица этого пользователя с помощью OAuth. Этот сценарий совмещает OpenID Connect для проверки подлинности пользователя и одновременно получается код авторизации, который можно использовать для получения токенов доступа с помощью потока кода авторизации OAuth. Для получения токена доступа необходимо немного изменить запрос на вход выше:


```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e		// Your registered Application Id
&response_type=id_token+code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F 	  // Your registered Redirect Uri, url encoded
&response_mode=query							      // 'query', 'form_post', or 'fragment'
&scope=openid%20                                      // Include both 'openid' and scopes your app needs  
offline_access%20										 
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345						 				 // Any value, provided by your app
&nonce=678910										 // Any value, provided by your app
```

Включая области разрешений в запрос и используя `response_type=code+id_token`, конечная точка версии 2.0 гарантирует, что пользователь выразил свое согласие с разрешениями, перечисленными в параметре запроса `scope`, и возвратит приложению код авторизации в обмен на токен доступа.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q... 	// the id_token, truncated
&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq... 	// the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF			   // a value generated by the v2.0 endpoint
&state=12345												  	// the value provided in the request
&id_token_expires_in=3599

```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id\_token | Маркер "id\_token", запрошенный приложением. Вы можете использовать маркер "id\_token" для проверки удостоверения пользователя и запуска сеанса с пользователем. Дополнительные сведения о токенах "id\_token" и их содержимом можно найти в [справочном материале по токенам в модели приложений 2.0](active-directory-v2-tokens.md). |
| Код | Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал и обычно истекает по прошествии порядка 10 минут. |
| session\_state | Уникальное значение, указывающее текущий сеанс пользователя. Это значение представляет собой GUID, но его следует расценивать как непрозрачное значение, передаваемое без рассмотрения. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |
| id\_token\_expires\_in | Срок действия токена идентификации (в секундах). |

Сообщения об ошибках также можно отправлять на `redirect_uri`, чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

После получения авторизации `code` и `id_token` вы можете разрешить вход пользователя и получить токены доступа от его имени. Для входа пользователя необходимо проверить `id_token` точно так же, как описано [выше](#validating-the-id-token). Для получения токенов доступа необходимо выполнить действия, описанные в нашей [документации по протоколу OAuth](active-directory-v2-protocols-oidc.md#request-an-access-token).

## Сводная диаграмма получения токена

Для справки: полный поток входа OpenID Connect и получения токена выглядит примерно так:

![Дорожки OpenID Connect](../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)

<!---HONumber=AcomDC_1203_2015-->