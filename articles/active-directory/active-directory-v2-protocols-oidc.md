
<properties
    pageTitle="Протокол OpenID Connect Azure AD версии 2.0 | Microsoft Azure"
    description="Построение веб-приложений с помощью реализации протокола проверки подлинности OpenID Connect в Azure AD версии 2.0."
    services="active-directory"
    documentationCenter=""
    authors="dstrockis"
    manager="msmbaldwin"
    editor=""/>

<tags
    ms.service="active-directory"
    ms.workload="identity"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="09/30/2016"
    ms.author="dastrock"/>


# <a name="v2.0-protocols---openid-connect"></a>Протоколы 2.0 — OpenID Connect
OpenID Connect — это протокол проверки подлинности на основе OAuth 2.0, который может использоваться для безопасного входа пользователей в веб-приложения.  С помощью реализации OpenID Connect в конечной точке версии 2.0 можно добавить в веб-приложения функцию входа и доступ к API.  Это руководство покажет, как сделать это независимо от языка, и содержит описание отправки и получения сообщений HTTP без использования библиотек с открытым исходным кодом.

> [AZURE.NOTE]
    Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0.  Чтобы определить, следует ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).

[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) расширяет возможности протокола *авторизации* OAuth 2.0 и позволяет использовать его в качестве протокола *аутентификации*, что делает возможным единый вход с помощью OAuth.  Этот протокол вводит понятие `id_token`, токена безопасности, который позволяет клиенту выполнять идентификацию пользователя и получать основные сведения о профиле пользователя.  Так как OpenID Connect представляет собой расширение OAuth 2.0, он также позволяет приложениям безопасно получать **маркеры доступа**, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](active-directory-v2-protocols.md#the-basics).  Мы рекомендуем использовать OpenID Connect для [веб-приложений](active-directory-v2-flows.md#web-apps) , которые размещаются на сервере и доступны через веб-браузер.

## <a name="protocol-diagram---sign-in"></a>Схема протокола: вход
Наиболее простой процесс входа содержит следующие этапы. Каждый из них подробно описан ниже.

![Дорожки OpenID Connect](../media/active-directory-v2-flows/convergence_scenarios_webapp.png)

## <a name="fetch-the-openid-connect-metadata-document"></a>Получение документа метаданных OpenID Connect
OpenID Connect описывает документ метаданных, который содержит большинство сведений, необходимых приложению для выполнения входа.  Сюда входят такие сведения, как используемые URL-адреса, расположение открытых ключей подписывания службы и т. д.  Ниже указан документ метаданных OpenID Connect, который следует использовать для конечной точки версии 2.0.

```
https://login.microsoftonline.com/{tenant}/v2.0/.well-known/openid-configuration
```

Где `{tenant}` может принимать одно из четырех значений:

| Значение | Описание |
| ----------------------- | ------------------------------- |
| `common` | Позволяет пользователям с личными учетными записями Майкрософт и рабочими учетными записями Azure Active Directory выполнять вход в приложение. |
| `organizations` | Позволяет выполнять вход в приложение только пользователям с рабочими учетными записями Azure Active Directory. |
| `consumers` | Позволяет выполнять вход в приложение только пользователям с личными учетными записями Майкрософт. |
| `8eaef023-2b34-4da1-9baa-8bc8c9d6a490` или `contoso.onmicrosoft.com` | Позволяет выполнять вход в приложение только пользователям с рабочими учетными записями определенного клиента Azure Active Directory.  Можно использовать понятное доменное имя клиента Azure AD или идентификатор GUID клиента.  |

Метаданные — это простой документ JSON, фрагмент которого приведен ниже.  Его содержимое полностью описано в [спецификации OpenID Connect](https://openid.net).

```
{
  "authorization_endpoint": "https:\/\/login.microsoftonline.com\/common\/oauth2\/v2.0\/authorize",
  "token_endpoint": "https:\/\/login.microsoftonline.com\/common\/oauth2\/v2.0\/token",
  "token_endpoint_auth_methods_supported": [
    "client_secret_post",
    "private_key_jwt"
  ],
  "jwks_uri": "https:\/\/login.microsoftonline.com\/common\/discovery\/v2.0\/keys",
  
  ...
  
}
```

Как правило, этот документ метаданных используется для настройки библиотеки OpenID Connect или пакета SDK. Метаданные будут использоваться для работы библиотеки.  Тем не менее, если вы не используете предварительно собранную библиотеку OpenID Connect, то можете выполнить инструкции в оставшейся части этой статьи, чтобы выполнить вход в веб-приложение, использующее конечную точку версии 2.0. 

## <a name="send-the-sign-in-request"></a>Отправка запроса на вход
Если веб-приложению требуется проверить подлинность пользователя, оно может направить его к конечной точке `/authorize` .  Этот запрос похож на первый этап [потока кода авторизации OAuth 2.0](active-directory-v2-protocols-oauth-code.md)с несколькими важными различиями:

- Запрос должен содержать область `openid` в параметре `scope`.
- Параметр `response_type` должен включать `id_token`
- Запрос должен содержать параметр `nonce`

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=form_post
&scope=openid
&state=12345
&nonce=678910
```

> [AZURE.TIP] Чтобы выполнить этот запрос, щелкните ссылку ниже! После входа браузер будет перенаправлен по адресу `https://localhost/myapp/`, при этом в адресной строке будет `id_token`.  Обратите внимание, что в этом запросе используется `response_mode=query` (в учебных целях).  Мы рекомендуем использовать `response_mode=form_post`.
    <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=openid&response_mode=query&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| tenant | обязательно | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение.  Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента.  Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| client_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| response_type | обязательно | Должен включать `id_token` для входа в OpenID Connect.  Параметр также может содержать другие типы response_types, например `code`. |
| redirect_uri | рекомендуется | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением.  Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope | обязательно | Список областей с разделителями-пробелами.  При использовании протокола OpenID Connect он должен содержать область `openid`, что преобразуется в разрешение "Вход" в пользовательском интерфейсе предоставления согласия.  Для предоставления разрешений этот запрос может также включать другие области. |
| nonce | обязательно | Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id_token" в качестве утверждения.  Приложение может проверить это значение во избежание атак с использованием воспроизведения токена.  Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса.  |
| response_mode | рекомендуется | Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению.  Может принимать значение "query", "form_post" или "fragment".  Для веб-приложений рекомендуется использовать `response_mode=form_post`, чтобы обеспечить наиболее безопасную передачу токенов в приложение.  
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе токена.  Это может быть строка любого контента.  Как правило, для [предотвращения подделки межсайтовых запросов](http://tools.ietf.org/html/rfc6749#section-10.12)используется генерируемое случайным образом уникальное значение.  Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| prompt | необязательный | Указывает требуемый тип взаимодействия с пользователем.  На текущий момент единственные допустимые значения — login, none и consent.  При значении `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает.  Значение `prompt=none` является противоположным — оно гарантирует, что интерактивные запросы не будут выводиться ни при каких обстоятельствах.  Если запрос не удастся завершить автоматически с использованием единого входа, то конечная точка версии 2.0 вернет ошибку.  Если установить значение `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| login_hint | необязательный | Можно применять для предварительного заполнения поля имени пользователя или электронного адреса на странице входа пользователя (если имя пользователя известно заранее).  Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`. |
| domain_hint | необязательный | Может использоваться значение `consumers` или `organizations`.  Если используется этот параметр, процесс обнаружения на основе электронной почты, который проходит пользователь на странице входа в приложение версии 2.0, пропускается, что существенно оптимизирует работу.  Обычно этот параметр используется в приложениях при повторной проверке подлинности. Для этого значение утверждения `tid` извлекается из параметра id_token.  Если значение утверждения `tid` — `9188040d-6c67-4c5b-b112-36a304b66dad`, следует использовать `domain_hint=consumers`.  Или используйте `domain_hint=organizations`. |
На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности.  Конечная точка версии 2.0 также обеспечит согласие пользователя на предоставление разрешений, указанных в параметре запроса `scope` .  Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя.  Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](active-directory-v2-scopes.md).

После того как пользователь пройдет проверку подлинности и предоставит разрешения, конечная точка версии 2.0 вернет приложению ответ на указанный `redirect_uri` с помощью метода, указанного в параметре `response_mode`.

#### <a name="successful-response"></a>Успешный ответ
Успешный ответ с использованием метода `response_mode=form_post` выглядит следующим образом:

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNB...&state=12345
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id_token | Маркер id_token, запрошенный приложением. Вы можете использовать токен "id_token" для проверки удостоверения пользователя и запуска сеанса с пользователем.  Дополнительные сведения о маркерах id_token и их содержимом можно найти в [справочнике по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md).  |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра state в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке
Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

error=access_denied&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности.  |

#### <a name="error-codes-for-authorization-endpoint-errors"></a>Коды ошибок конечной точки авторизации

В таблице ниже описаны различные коды ошибок, которые могут возвращаться в параметре `error` ответа с ошибкой.

| Код ошибки | Описание | Действие клиента |
|------------|-------------|---------------|
| invalid_request | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая, как правило, обнаруживается во время первоначального тестирования.|
| unauthorized_client | Клиентскому приложению не разрешено запрашивать код авторизации. | Как правило, это происходит, если клиентское приложение не зарегистрировано в Azure AD или не добавлено в клиент Azure AD пользователя. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| access_denied | Владелец ресурса отказал в использовании | Клиентское приложение может уведомить пользователя, что не может продолжить работу без согласия пользователя. |
| unsupported_response_type | Сервер авторизации не поддерживает тип ответа в запросе. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая, как правило, обнаруживается во время первоначального тестирования.|
|server_error | Сервер обнаружил непредвиденную ошибку. | Повторите запрос. Эти ошибки могут возникать в связи с временными условиями. Клиентское приложение может отобразить для пользователя сообщение о том, что его ответ задерживается из-за временной ошибки. |
| temporarily_unavailable | Сервер временно занят и не может обработать запрос. | Повторите запрос. Клиентское приложение может отобразить для пользователя сообщение о том, что его ответ задерживается из-за временных условий. |
| invalid_resource |Целевой ресурс недопустим, так как он не существует. Azure AD не удается найти ресурс, или он настроен неправильно.| Это означает, что ресурс, если он существует, не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |

## <a name="validate-the-id_token"></a>Проверка токена "id_token"
Для проверки подлинности пользователя недостаточно просто получить токен "id_token". Вам также потребуется проверить подпись токена "id_token" и утверждения в нем в соответствии с требованиями приложения.  В конечной точке версии 2.0 для подписи маркеров и проверки их правильности используются [веб-маркеры JSON Web Token (JWT)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Вы можете выбрать проверку `id_token` в клиентском коде, но обычно `id_token` отправляется на проверку внутреннему серверу.  После проверки подписи токена id_token вам потребуется проверить несколько утверждений.  Дополнительные сведения, в том числе о [проверке маркеров](active-directory-v2-tokens.md) и [информацию о смене ключей подписывания](active-directory-v2-tokens.md#validating-tokens), см. в [справочнике по маркерам версии 2.0](active-directory-v2-tokens.md#validating-tokens).  Советуем использовать библиотеку для синтаксического анализа и проверки токенов. Для большинства языков и платформ доступна по крайней мере одна такая библиотека.
<!--TODO: Improve the information on this-->

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария.  Ниже приведены некоторые из стандартных проверок:

- Обеспечение регистрации пользователя или организации в приложении.
- Предоставление пользователю необходимого уровня авторизации и привилегий.
- Обеспечение определенного уровня проверки подлинности, например многофакторной проверки подлинности.

Дополнительные сведения об утверждениях в маркере id_token можно найти в [справочнике по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md).

После полной проверки токена "id_token" вы можете начать сеанс с пользователем и использовать утверждения в токене "id_token" для получения сведений о пользователе в приложении.  Эти сведения можно использовать для отображения, записей, авторизации и т. д.

## <a name="send-a-sign-out-request"></a>Отправка запроса на выход

Сейчас конечная точка версии 2.0 не поддерживает `end_session_endpoint` OpenID Connect. Это значит, что приложение не может отправлять запросы на конечную точку версии 2.0 для прекращения сеанса пользователя и очистки файлов cookie, установленных конечной точкой версии 2.0.
Для выполнения выхода пользователя приложение может просто завершить собственный сеанс с пользователем, не затрагивая сеанс пользователя с конечной точкой версии 2.0.  При следующей попытке входа пользователь увидит страницу выбора учетной записи с перечнем учетных записей, в которые выполнен вход.
На этой странице пользователь может выйти из любой учетной записи, тем самым завершая сеанс с конечной точкой версии 2.0.

<!--

When you wish to sign the user out of the app, it is not sufficient to clear your app's cookies or otherwise end the session with the user.  You must also redirect the user to the v2.0 endpoint for sign out.  If you fail to do so, the user will be able to re-authenticate to your app without entering their credentials again, because they will have a valid single sign-on session with the v2.0 endpoint.

You can simply redirect the user to the `end_session_endpoint` listed in the OpenID Connect metadata document:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/logout?
post_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
```

| Parameter | | Description |
| ----------------------- | ------------------------------- | ------------ |
| post_logout_redirect_uri | recommended | The URL which the user should be redirected to after successful logout.  If not included, the user will be shown a generic message by the v2.0 endpoint.  |

-->

## <a name="protocol-diagram---token-acquisition"></a>Схема протокола: получение токена
Многим веб-приложениям требуется не только выполнить вход пользователя, но и получить доступ к веб-службе от лица этого пользователя с помощью OAuth.  Этот сценарий совмещает OpenID Connect для проверки подлинности пользователя и одновременно получается код авторизации, который можно использовать для получения токенов доступа с помощью потока кода авторизации OAuth.

Полный процесс входа OpenID Connect и получения токена выглядит примерно так (каждый этап подробно описан ниже).

![Дорожки OpenID Connect](../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)

## <a name="get-access-tokens"></a>Получение маркеров доступа
Для получения токена доступа необходимо немного изменить запрос на вход выше:

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e      // Your registered Application Id
&response_type=id_token%20code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered Redirect Uri, url encoded
&response_mode=form_post                              // 'query', 'form_post', or 'fragment'
&scope=openid%20                                      // Include both 'openid' and scopes your app needs  
offline_access%20                                        
https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&state=12345                                         // Any value, provided by your app
&nonce=678910                                        // Any value, provided by your app
```

> [AZURE.TIP] Чтобы выполнить этот запрос, щелкните ссылку ниже! После входа браузер будет перенаправлен по адресу `https://localhost/myapp/`, при этом в адресной строке будет `id_token` и `code`.  Обратите внимание, что в этом запросе используется `response_mode=query` (в учебных целях).  Мы рекомендуем использовать `response_mode=form_post`.
    <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token%20code&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&response_mode=query&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>

Включая области разрешений в запрос и используя `response_type=id_token code`, конечная точка версии 2.0 гарантирует, что пользователь выразил свое согласие с разрешениями, перечисленными в параметре запроса `scope`, и возвратит приложению код авторизации в обмен на токен доступа.

#### <a name="successful-response"></a>Успешный ответ
Успешный ответ с использованием метода `response_mode=form_post` выглядит следующим образом:

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNB...&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&state=12345
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| id_token | Маркер id_token, запрошенный приложением. Вы можете использовать токен "id_token" для проверки удостоверения пользователя и запуска сеанса с пользователем.  Дополнительные сведения о маркерах id_token и их содержимом можно найти в [справочнике по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md).  |
| Код | Запрашиваемый приложением код authorization_code. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса.  Срок действия кодов авторизации крайне мал и обычно истекает по прошествии порядка 10 минут. |
| state | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра state в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке
Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

error=access_denied&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| ----------------------- | ------------------------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности.  |

Описания кодов ошибок и сведения о рекомендуемых действиях в клиенте см. в разделе [Коды ошибок конечной точки авторизации](#error-codes-for-authorization-endpoint-errors).

После получения авторизации `code` и `id_token` вы можете разрешить вход пользователя и получить токены доступа от его имени.  Для входа пользователя необходимо проверить `id_token` точно так же, как описано [выше](#validating-the-id-token).  Для получения токенов доступа необходимо выполнить действия, описанные в нашей [документации по протоколу OAuth](active-directory-v2-protocols-oauth-code.md#request-an-access-token).



<!--HONumber=Oct16_HO2-->


