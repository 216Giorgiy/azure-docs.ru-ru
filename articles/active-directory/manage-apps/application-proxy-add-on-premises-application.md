---
title: Добавление локального приложения — Application Proxy в Azure Active Directory | Документация Майкрософт
description: Azure Active Directory (Azure AD) содержит службу прокси приложения, которая позволяет пользователям получать доступ к локальным приложениям при входе с использованием своей учетной записи Azure AD. В этом руководстве показано, как подготовить среду для использования прокси приложения, а затем с его помощью через портал Azure добавить локальное приложение в свой клиент Azure AD.
services: active-directory
author: barbkess
manager: mtillman
ms.service: active-directory
ms.component: app-mgmt
ms.workload: identity
ms.topic: tutorial
ms.date: 12/07/2018
ms.author: barbkess
ms.reviewer: japere
ms.openlocfilehash: 926a339bc8214c989da4ef934ae41012eea58d1e
ms.sourcegitcommit: 818d3e89821d101406c3fe68e0e6efa8907072e7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/09/2019
ms.locfileid: "54120739"
---
# <a name="tutorial-add-an-on-premises-application-for-remote-access-through-application-proxy-in-azure-active-directory"></a>Руководство. Добавление локального приложения для удаленного доступа через Application Proxy в Azure Active Directory

Azure Active Directory (Azure AD) содержит службу прокси приложения, которая позволяет пользователям получать доступ к локальным приложениям при входе с использованием своей учетной записи Azure AD. В руководстве подготавливается среда для использования с прокси приложения. После подготовки среды вы будете использовать портал Azure для добавления локального приложения в свой клиент Azure AD.

В этом руководстве рассматривается:

> [!div class="checklist"]
> * Открытие портов для исходящего трафика и разрешения доступа к определенным URL-адресам.
> * Установка соединителя на сервере Windows и его регистрация с помощью прокси приложения.
> * Проверка правильности установки и регистрации соединителя.
> * Добавление локального приложения в клиент Azure AD.
> * Проверка возможности входа в приложение для тестового пользователя с помощью учетной записи Azure AD.

## <a name="before-you-begin"></a>Перед началом работы

Чтобы добавить приложение в клиент, потребуется:

* [подписка Microsoft Azure AD ценовой категории "Базовый" или "Премиум"](https://azure.microsoft.com/pricing/details/active-directory); 
* учетная запись администратора приложения.

### <a name="windows-server"></a>Windows Server
Чтобы использовать Application Proxy, вам потребуется сервер под управлением Windows Server 2012 R2 или более поздней версии. Соединитель Application Proxy устанавливается на сервер. Серверу соединителя нужна возможность подключаться к службам прокси приложения в Azure, а также к локальным приложениям, которые вы планируете публиковать.

Для обеспечения высокого уровня доступности рабочей среде рекомендуем использовать несколько серверов Windows. Для этого руководства достаточно и одного сервера Windows.

**Рекомендации для сервера соединителя**

1. Физически найдите сервер соединителя рядом с серверами приложения для оптимизации производительности между соединителем и приложением. Дополнительные сведения см. в статье [Аспекты топологии сети при использовании прокси приложения Azure Active Directory](application-proxy-network-topology.md).

2. Сервер соединителя и серверы веб-приложений должны принадлежать одному домену Active Directory. Наличие серверов в одном домене — требование для использования единого входа с помощью встроенной проверки подлинности Windows (IWA) и ограниченного делегирования Kerberos (KCD). Если сервер соединителя и серверы веб-приложения находятся в разных доменах Active Directory, для единого входа необходимо использовать делегирование на основе ресурсов. Дополнительные сведения см. в статье [Ограниченное делегирование Kerberos для поддержки единого входа в приложения с помощью прокси приложения](application-proxy-configure-single-sign-on-with-kcd.md).

**Требования к программному обеспечению**

Прежде чем установить этот соединитель, на сервере Windows Server нужно включить протокол TLS 1.2. Существующие соединители версий ниже 1.5.612.0 будут продолжать работать с предыдущими версиями TLS до последующего уведомления. 

Включение протокола TLS 1.2

1. Настройте следующие разделы реестра:
    
    ```
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2]
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client] "DisabledByDefault"=dword:00000000 "Enabled"=dword:00000001
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server] "DisabledByDefault"=dword:00000000 "Enabled"=dword:00000001
    [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v4.0.30319] "SchUseStrongCrypto"=dword:00000001
    ```

2. Перезапустите сервер.

  
## <a name="prepare-your-on-premises-environment"></a>Подготовка локальной среды
Для подготовки среды для прокси приложения Azure AD необходимо сначала установить связь с центрами обработки данных Azure. Если в сетевом пути используется брандмауэр, убедитесь, что он открыт для запросов HTTPS (TCP), поступающих из соединителя в прокси приложения.

### <a name="open-ports"></a>Открытие портов

Откройте следующие порты для **исходящего** трафика. 

   | Номер порта | Как он используется |
   | --- | --- |
   | 80 | Скачивание списков отзыва сертификатов при проверке SSL-сертификата |
   | 443 | Весь исходящий обмен данными со службой прокси приложения |

Если брандмауэр инициирует трафик в соответствии с отправляющими его пользователями, откройте порты 80 и 443 для трафика, поступающего от служб Windows, которые работают как сетевая служба.

Если вы уже используете прокси приложения, то возможно у вас установлена более старая версия соединителя.  Следуйте указаниям этого руководства, чтобы установить последнюю версию соединителя. Версиям более ранним, чем 1.5.132.0, также требуются следующие открытые порты: 5671, 8080, 9090-9091, 9350, 9352, 10100-10120. 

### <a name="allow-access-to-urls"></a>Разрешение доступа к URL-адресам

Разрешите доступ к следующим URL-адресам.

| URL-адрес | Как он используется |
| --- | --- |
| \*.msappproxy.net;<br>\*.servicebus.windows.net. | Связь между соединителем и облачной службой прокси приложения |
| mscrl.microsoft.com:80<br>crl.microsoft.com:80<br>ocsp.msocsp.com:80<br>www.microsoft.com:80 | Azure использует эти URL-адреса для проверки сертификатов |
| login.windows.net<br>login.microsoftonline.com | Соединитель использует эти URL-адреса во время регистрации. |

Если брандмауэр или прокси-сервер поддерживают внесение DNS в список разрешений, то можно добавить подключения к \*msappproxy.net и \*.servicebus.windows.net в список разрешений. Если нет, то необходимо разрешить доступ к [диапазонам IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653). Список диапазонов IP-адресов обновляется еженедельно.

## <a name="install-and-register-a-connector"></a>Установка и регистрация соединителя
Чтобы использовать прокси приложения, необходимо установить соединитель на каждом сервере Windows, который вы решили использовать со службой прокси приложения. Соединитель — это агент, который управляет исходящим подключением локальных серверов приложений к прокси приложения в Azure AD. Соединитель можно установить на серверах, на которых установлены также другие агенты проверки подлинности, например Azure AD Connect.

Для установки соединителя:

1. Войдите на [портал Azure](https://portal.azure.com/) как администратор приложения каталога, который использует прокси приложения. Например, если домен клиента contoso.com, администратором должен быть пользователь admin@contoso.com или другой псевдоним администратора в этом домене.
2. Текущий каталог отображается под вашим именем пользователя в правом верхнем углу. Убедитесь, что вы вошли в каталог, который использует прокси приложения. Чтобы изменить каталоги, щелкните этот значок.
3. В левой колонке выберите **Azure Active Directory**, затем — **Прокси приложения**.
4. Щелкните **Скачать службу соединителя**.
5. Ознакомьтесь с условиями предоставления услуг.  Когда вы будете готовы, нажмите кнопку **Принять условия и скачать**.
6. В нижней части окна вы увидите предложение скачать **AADApplicationProxyConnectorInstaller.exe**. Щелкните **Выполнить** для установки соединителя. Откроется мастер установки. 
7. Следуйте указаниям мастера установки. Когда будет предложено зарегистрировать соединитель с помощью прокси приложения для вашего клиента Azure AD, укажите учетные данные администратора приложения.
    - Если в Internet Explorer **включена** **конфигурация усиленной безопасности Internet Explorer**, возможно, экран регистрации не отобразится. Чтобы получить к нему доступ, выполните указания, приведенные в сообщении об ошибке. Убедитесь, что конфигурация усиленной безопасности Internet Explorer **отключена**.

### <a name="general-remarks"></a>Общие замечания

Если вы ранее установили соединитель, переустановите его, чтобы получить последнюю версию.

Если вы выбрали несколько серверов Windows для локальных приложений, необходимо установить и зарегистрировать соединитель на каждом сервере. Соединители можно упорядочить в группы. Дополнительные сведения см. в статье [Публикация приложений в отдельных сетях и расположениях с помощью групп соединителей](application-proxy-connector-groups.md). 

Если в вашей организации для подключения к Интернету используются прокси-серверы, необходимо настроить их для Application Proxy.  Дополнительные сведения см. в статье [Работа с имеющимися локальными прокси-серверами](application-proxy-configure-connectors-with-proxy-servers.md). 

Сведения о соединителях, поддержании их актуальности и планировании емкости см. в статье [Сведения о соединителях прокси приложения Azure AD](application-proxy-connectors.md). 

Если вы используете приложение Qlik Sense, всегда устанавливайте последнюю версию соединителя. Qlik Sense использует подключения WebSocket, которые поддерживаются соединителем версии 1.5.612.0 или более поздней.


## <a name="verify-the-connector-installed-and-registered-correctly"></a>Проверка правильности установки и регистрации соединителя

Используйте портал Azure или сервер Windows для подтверждения того, что новый соединитель установлен правильно.

### <a name="verify---azure-portal"></a>Проверка — портал Azure
Для подтверждения правильности установки и регистрации соединителя:

1. Войдите в свой каталог клиента на [портале Azure](https://portal.azure.com).
2. Выберите **Azure Active Directory**, затем — **Прокси приложения**. На этой странице отображаются все соединители и группы соединителей. 
3. Выберите соединитель, чтобы проверить сведения о нем. Активная зеленая метка указывает на то, что соединитель может подключиться к службе. Тем не менее, несмотря на то, что метка зеленая, проблема с сетью по-прежнему может помешать соединителю получать сообщения. 

    ![Соединители прокси приложения Azure AD](./media/application-proxy-connectors/app-proxy-connectors.png)

Для получения дополнительной информации по установке соединителя см. статью [Проблемы при установке соединителя агента прокси приложения](application-proxy-connector-installation-problem.md).

### <a name="verify---windows-server"></a>Проверка — сервер Windows
Для подтверждения правильности установки и регистрации соединителя:

1. Откройте диспетчер служб Windows, щелкнув клавишу **Windows** и введя *services.msc*.
2. Проверьте наличие состояния **Выполняется** для двух следующих служб.
   - **Соединитель прокси приложения Microsoft AAD** обеспечивает возможность подключения.
   - **Средство обновления соединителя прокси приложения Microsoft AAD** выполняет роль службы автоматического обновления. Средство обновления проверяет наличие новых версий соединителя и обновляет его по мере необходимости.

    ![Службы соединителей прокси приложения — снимок экрана](./media/application-proxy-enable/app_proxy_services.png)

3. Если состояние службы не **Выполняется**, щелкните правой кнопкой мыши каждую службу и выберите **Запустить**. 

## <a name="add-an-on-premises-app-to-azure-ad"></a>Добавление локального приложения в Azure AD

Теперь, когда вы подготовили среду и установили соединитель, вы готовы добавить локальные приложения в Azure AD.  

1. Войдите на [портал Azure](https://portal.azure.com/) с учетной записью администратора.
2. Выберите **Azure Active Directory** > **Корпоративные приложения** > **Новое приложение**.

    ![Добавление корпоративного приложения](./media/application-proxy-publish-azure-portal/add-app.png)

3. Выберите **Все** и щелкните **Локальное приложение**.  

    ![Добавление собственного приложения](./media/application-proxy-publish-azure-portal/add-your-own.png)

4. В колонке **Добавление локального приложения** укажите следующие сведения о приложении.

    ![Настройка приложения](./media/application-proxy-publish-azure-portal/configure-app.png)

    | Поле | ОПИСАНИЕ |
    | :---- | :---------- |
    | **Имя** | Имя приложения, которое будет отображаться на панели доступа и на портале Azure. |
    | **Внутренний URL-адрес** | URL-адрес для доступа к приложению в частной сети. Для публикации можно указать только конкретный адрес на внутреннем сервере; при этом другие адреса сервера не публикуются. Это позволяет публиковать на одном сервере разные сайты, назначая каждому из них отдельное имя и правила доступа.<br><br>Если вы публикуете путь, он должен включать в себя все необходимые изображения, скрипты и таблицы стилей для вашего приложения. Например, если приложение размещено по адресу https://yourapp/app и использует образы, размещенные по адресу https://yourapp/media, опубликуйте https://yourapp/ в качестве пути. Этот внутренний URL-адрес не должен отображаться на целевой странице, которую видят пользователи. Дополнительные сведения см. в разделе [Настройка пользовательской домашней страницы для опубликованных приложений с помощью прокси приложения Azure AD](application-proxy-configure-custom-home-page.md). |
    | **Внешний URL-адрес** | Адрес для пользователей, чтобы получить доступ к приложению за пределами вашей сети. Если вы не хотите использовать домен прокси приложения по умолчанию, прочитайте сведения о [личных доменах в прокси приложения Azure AD](application-proxy-configure-custom-domain.md).|
    | **Предварительная проверка подлинности** | Здесь указывается метод проверки пользователей, который использует прокси приложения, прежде чем предоставить доступ к приложению.<br><br>**Azure Active Directory** — прокси приложения перенаправляет пользователей на страницу входа в Azure AD, где будет выполняться проверка подлинности их разрешений для каталога и приложения. Рекомендуется оставить значение этого параметра по умолчанию, чтобы воспользоваться преимуществами функций безопасности Azure AD, например условным доступом и Многофакторной идентификацией. Служба **Azure Active Directory** необходима для мониторинга приложения с помощью Microsoft Cloud Application Security.<br><br>**Сквозной режим** — пользователям для доступа к приложению не нужно выполнять аутентификацию в Azure Active Directory. Вы по-прежнему можете настроить требования к аутентификации на серверной стороне. |
    | **Группа соединителей** | Соединители обрабатывают удаленный доступ к приложению, а группы соединителей позволяют упорядочивать соединители и приложения по регионам, сетям и назначению. Если вы еще не создали какие-либо группы соединителей, приложение назначается в группу **по умолчанию**.<br><br>Если ваше приложение использует WebSocket для подключения, все соединители в группе должны быть версии 1.5.612.0 или более поздней.|

5. При необходимости настройте **дополнительные параметры**. Для большинства приложений следует сохранить значения этих параметров по умолчанию. 

    | Поле | ОПИСАНИЕ |
    | :---- | :---------- |
    | **Время ожидания серверного приложения** | Задайте для этого параметра значение **Длинный**, только если приложение медленно выполняет проверку подлинности и подключение. |
    | **Use HTTP-Only Cookie** (Использовать файл cookie только HTTP-Only) | Задайте для этого параметра значение **Да**, чтобы файлы cookie прокси приложения содержали флаг HTTPOnly в заголовке ответа HTTP. Если используете службы удаленных рабочих столов, задайте значение **Нет**.|
    | **Использовать безопасный файл cookie**| Установите значение **Да**, чтобы файлы cookie передавались по защищенному каналу, как например зашифрованный HTTPS-запрос.
    | **Translate URLs in Headers** (Преобразование URL-адресов в заголовках) | Оставьте значением этого параметра **Да**, если только приложению не требуется исходный заголовок узла в запросе на аутентификацию. |
    | **Translate URLs in Application Body** (Преобразовывать URL-адреса в коде приложения) | Только если вы используете жестко закодированные ссылки HTML на другие локальные приложения и не используете личные домены, следует изменить значение этого параметра по умолчанию на **Нет**. Дополнительные сведения см. в статье [Перенаправление встроенных ссылок для приложений, опубликованных с помощью прокси приложения Azure AD](application-proxy-configure-hard-coded-link-translation.md).<br><br>Установите значение **Да**, если вы планируете осуществлять мониторинг этого приложения с помощью Microsoft Cloud App Security (MCAS). Дополнительные сведения см. в статье [Настройка мониторинга доступа к приложениям в режиме реального времени с помощью Microsoft Cloud App Security и Azure Active Directory](application-proxy-integrate-with-microsoft-cloud-application-security.md). |
   


6. Выберите **Добавить**.

## <a name="test-the-application"></a>Тестирование приложения

Все готово к тестированию правильности добавления приложения. На следующих этапах добавьте учетную запись пользователя в приложение и попробуйте войти.

### <a name="add-a-user-for-testing"></a>Добавление пользователя для тестирования
Прежде чем добавить пользователя к приложению, убедитесь, что у учетной записи есть разрешения на доступ к приложению из корпоративной сети.

Чтобы добавить тестового пользователя:

1. Вернитесь в колонку **быстрого запуска** и выберите **Назначить пользователя для тестирования**.

    ![Назначение пользователя для тестирования](./media/application-proxy-publish-azure-portal/assign-user.png)

2. В колонке **Пользователи и группы** выберите **Добавить пользователя**.

    ![Добавление пользователя или группы](./media/application-proxy-publish-azure-portal/add-user.png)

3. В колонке **Добавление назначения** выберите **Пользователи и группы**, а затем выберите учетную запись, которую хотите добавить. 
4. Выберите **Назначить**.

### <a name="test-the-sign-on"></a>Проверка единого входа

Для тестирования единого входа в приложение:

1. Откройте в браузере внешний URL-адрес, который вы указали на этапе публикации. 
2. Вы должны увидеть начальный экран.
3. Попробуйте выполнить вход от имени пользователя, созданного в предыдущем разделе.

    ![Тестирование опубликованного приложения](./media/application-proxy-publish-azure-portal/test-app.png)

Сведения об устранении неполадок вы найдете [здесь](application-proxy-troubleshoot.md).

## <a name="next-steps"></a>Дополнительная информация
В этом руководстве вы подготовили локальную среду для работы с прокси приложения, а затем установили и зарегистрировали соединитель прокси приложения. После этого вы добавили приложение в клиент Azure AD. Проверили возможность входа в приложение для тестового пользователя с помощью учетной записи Azure AD.

Вы выполнили такие действия:
> [!div class="checklist"]
> * Открыли порты для исходящего трафика и разрешили доступ к определенным URL-адресам.
> * Установили соединитель на сервере Windows и зарегистрировали его с помощью прокси приложения.
> * Проверили правильность установки и регистрации соединителя.
> * Добавили локальное приложение в клиент Azure AD.
> * Проверили возможность входа в приложение для тестового пользователя с помощью учетной записи Azure AD.

Все готово для настройки единого входа. Используйте следующую ссылку, чтобы выбрать способ единого входа и найти руководства по его настройке. 

> [!div class="nextstepaction"]
>[Настройка единого входа](what-is-single-sign-on.md#choosing-a-single-sign-on-method)





