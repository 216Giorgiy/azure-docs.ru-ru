<properties
	pageTitle="Azure AD Connect Sync: настройка фильтрации"
	description="В этой статье объясняется, как настроить фильтрацию в Azure AD Connect Sync."
	services="active-directory"
	documentationCenter=""
	authors="markusvi"
	manager="swadhwa"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/27/2015"
	ms.author="markusvi"/>


# Azure AD Connect Sync: настройка фильтрации

В службе Azure AD Connect Sync фильтрацию объектов синхронизации можно включить в любое время. Если вы сначала настроили синхронизацию каталогов с параметрами по умолчанию, а затем настроили фильтрацию, отфильтрованные объекты больше не будут синхронизироваться в Azure AD. В результате все объекты в Azure AD, которые ранее были синхронизированы, а затем отфильтрованы, будут удалены из Azure AD. Если объекты были случайно удалены в результате ошибки фильтрации, их можно воссоздать в Azure AD, удалив настройки фильтрации и снова синхронизировав каталоги.

> [AZURE.IMPORTANT]Мы поддерживаем изменение или использование службы Azure AD Connect Sync только в контексте официально задокументированных действий. Любые иные действия могут привести к несогласованному или неподдерживаемому состоянию Azure AD Connect Sync. Для таких развертываний мы не предоставляем техническую поддержку.
 
При установке Azure AD Connect или обновлении до новой версии сохраняются все существующие конфигурации, за исключением настроек исходящей фильтрации по атрибутам. Перед выполнением первого цикла синхронизации мы настоятельно рекомендуем убедиться, что ваша конфигурация не была случайно изменена после обновления до новой версии.


## Параметры фильтрации

> [AZURE.NOTE]В этой статье для обозначения соединителя службы домена Active Directory используется имя Source AD. При наличии нескольких лесов у вас будет один соединитель на лес. В этом случае настройка выполняется для каждого леса отдельно.
 
Для средства синхронизации каталогов доступны три типа настройки фильтрации:

- **По доменам**. Этот тип фильтрации можно использовать для управления свойствами соединителя SourceAD в Azure AD Connect Sync. Этот тип позволяет выбирать домены, которые можно синхронизировать в Azure AD.

- **Настройка фильтрации по подразделениям**. Этот тип фильтрации можно использовать для управления свойствами соединителя SourceAD в Azure AD Connect Sync. Этот тип позволяет выбирать подразделения, которые можно синхронизировать в Azure AD.

- **По атрибутам**. Этот метод фильтрации можно использовать для определения фильтров на основе атрибутов. Это дает возможность определять, какие объекты будут синхронизироваться в облако.

## Настройка фильтрации по доменам

В этом разделе описана процедура настройки фильтра доменов.


> [AZURE.NOTE]Если вы изменили фильтр доменов, необходимо также обновить профили выполнения.
 

**Настройка фильтра доменов**

1. Войдите на компьютер, на котором запущена служба Azure AD Connect Sync, используя учетную запись участника группы безопасности **ADSyncAdmins**.

2. На **начальном экране** щелкните значок **Служба синхронизации**. Откроется **диспетчер службы синхронизации**. <br>

3. Чтобы открыть представление соединителей, в меню **Средства** щелкните **Соединители**.

4. В списке **Соединители**выберите соединитель, для которого в качестве параметра **Тип** указано значение **Служба домена Active Directory**.

5. Чтобы открыть диалоговое окно **Свойства**, в меню **Действия** щелкните **Свойства**.

6. Щелкните **Настроить разделы каталога**.

7. В списке **Выберите разделы каталога** выберите только те разделы, которые должны синхронизироваться. <br> >[AZURE.Note]Чтобы исключить домен из процесса синхронизации, снимите флажок напротив имени соответствующего домена.

8. Чтобы закрыть диалоговое окно **Свойства**, нажмите кнопку **ОК**.


После изменения фильтра доменов нужно также изменить следующие профили выполнения:

- полный импорт;
- полная синхронизация;
- импорт изменений;
- синхронизация изменений;
- экспорт.


Если вы удалили из списка разделов каталога какой-то раздел, все шаги в профиле выполнения, которые ссылаются на этот раздел, также нужно удалить.

**Удаление шага в профиле выполнения**

1. В списке **Соединители**выберите соединитель, для которого в качестве параметра **Тип** указано значение **Служба домена Active Directory**.

2. Чтобы открыть диалоговое окно **Настройка профилей выполнения**, в меню **Действия** щелкните **Настроить профили выполнения**.

3. В списке **Профили выполнения соединителя** выберите профиль выполнения, который нужно настроить.

4. Для каждого шага в списке сведений о шаге выполните следующие действия:

     4\.1. Щелкните шаг, чтобы развернуть сведения о нем.

     4\.2. Если для атрибута **Раздел** в поле **Значение** указано GUID, щелкните «Удалить шаг».

5. Чтобы закрыть диалоговое окно **Настройка профилей выполнения**, нажмите кнопку **ОК**.

Если вы добавили в список разделов каталога еще один раздел, шаг профиля выполнения для этого раздела необходимо добавить в каждый профиль выполнения из списка выше.

**Добавление шага в профиль выполнения**

1. В списке **Соединители**выберите соединитель, для которого в качестве параметра **Тип** указано значение **Служба домена Active Directory**.

2. Чтобы открыть диалоговое окно **Настройка профилей выполнения**, в меню **Действия** щелкните **Настроить профили выполнения**.

3. В списке **Профили выполнения соединителя** выберите профиль выполнения, который нужно настроить.

4. Чтобы открыть диалоговое окно **Настройка профиля выполнения**, нажмите кнопку **Новый шаг**.

5. На странице **Настройка шага** в списке типов шагов выберите нужный тип и нажмите кнопку **Далее**.

6. На странице **Настройка соединителя** в списке **Раздел** выберите имя раздела, добавленного в фильтр доменов.

7. Чтобы закрыть диалоговое окно **Настройка профиля выполнения**, нажмите кнопку **Готово**.

8. Чтобы закрыть диалоговое окно **Настройка профилей выполнения**, нажмите кнопку **ОК**.

 

## Настройка фильтрации по подразделениям

**Настройка фильтрования по подразделениям**

1. Войдите на компьютер, на котором запущена служба Azure AD Connect Sync, используя учетную запись участника группы безопасности **ADSyncAdmins**.

2. На **начальном экране** щелкните значок **Служба синхронизации**. Откроется **диспетчер службы синхронизации**.<br>

3. В **диспетчере службы синхронизации** щелкните **Соединители**, а затем дважды щелкните **SourceAD**.

4. Щелкните **Настроить разделы каталога**, выберите домен, который нужно настроить, а затем щелкните **Контейнеры**.

5. При появлении запроса введите учетные данные домена для локального леса Active Directory.<br> >[AZURE.NOTE]В окне для ввода учетных данных будет показана учетная запись, используемая для импорта и экспорта в AD DS. Если вы не знаете пароль этой учетной записи, укажите другую учетную запись. Используемая учетная запись должна обладать правами на чтение в настраиваемом домене.

6. В диалоговом окне **Выбор контейнеров** удалите подразделения, которые не нужно синхронизировать с облачным каталогом, и нажмите кнопку **ОК**.

7. На странице **Свойства SourceAD** нажмите кнопку **ОК**.

8. Выполните полный импорт и синхронизацию изменений. Для этого:

     8\.1. В списке соединителей выберите **SourceAD**.

     8\.2. Чтобы открыть диалоговое окно **Запуск соединителя**, в меню **Действия** выберите команду **Выполнить**.

     8\.3. В списке **Профили выполнения** выберите **Полный импорт** и дождитесь окончания импорта.

     8\.4. Чтобы открыть диалоговое окно **Запуск соединителя**, в меню **Действия** выберите команду **Выполнить**.

     8\.5. В списке **Профили выполнения** выберите **Синхронизация изменений** и дождитесь окончания синхронизации.




## Настройка фильтрации по атрибутам

Существует несколько способов настроить фильтрацию по атрибутам. Рекомендуем использовать настройку на основе входящих объектов из AD, так как эти параметры будут сохранены даже после обновления до новой версии. Настройка на основе исходящих объектов в AAD поддерживается, но эти параметры не будут сохранены после обновления до новой версии. Их следует использовать, только если вам нужно просмотреть объединенный объект в метавселенной, чтобы определить способ фильтрации.

### Фильтрация входящих объектов

Для фильтрации по входящим объектам используется конфигурация по умолчанию: в объектах, передающихся в AAD, для атрибута метавселенной cloudFiltered не задано значение, а для атрибута метавселенной sourceObjectType указано значение User или Contact.

Если объект не нужно синхронизировать в Azure AD, атрибуту cloudFiltered должно быть присвоено значение True. В остальных случаях значение не нужно указывать. При использовании такого метода вы можете исключить из синхронизации некоторые объекты (отрицательная фильтрация).

В примере ниже мы отфильтруем всех пользователей, у которых атрибут extensionAttribute15 имеет значение NoSync.

1. Войдите на компьютер, на котором запущена служба Azure AD Connect Sync, используя учетную запись участника группы безопасности ADSyncAdmins.
2. В меню **Пуск** выберите **Редактор правил синхронизации**.
3. Выберите параметр **Входящие** и щелкните **Добавить новое правило**.
4. Задайте правилу описательное имя, например \*In from AD — User DoNotSyncFilter\*, выберите правильный лес, для параметра **Тип объекта CS** укажите значение **Пользователь**, а для параметра **Тип объекта MV** — **Человек**. В поле **Тип связи** выберите **Объединение**, а в поле «Тип приоритета» — значение, которое не используется в другом правиле синхронизации (например, 50). Нажмите кнопку **Далее**.
5. В элементе **Фильтр области** щелкните **Добавить группу** и **Добавить предложение**, а затем выберите атрибут **ExtensionAttribute15**. В качестве оператора выберите **EQUAL** и в поле **Значение** введите NoSync. Нажмите кнопку **Далее**.
6. Оставьте **правила объединения** пустыми и нажмите кнопку **Далее**.
7. Щелкните **Добавить преобразование**, для параметра **Тип потока** выберите значение **Постоянный**, для параметра «Целевой атрибут» — значение cloudFiltered, а затем в текстовое поле «Источник» введите значение True. Нажмите кнопку «Добавить», чтобы сохранить правило.
8. Выполните полную синхронизацию: на вкладке **Соединители** щелкните правой кнопкой мыши пункт **SourceAD**, последовательно выберите **Выполнить** и **Полная синхронизация**, а затем нажмите кнопку **ОК**. 


Атрибут **sourceObjectType** подготовит **пользователя** или **контакт** к Azure AD, если этот атрибут имеет значение **User** или **Contact** соответственно. Создав правило синхронизации с более высоким приоритетом, чем у стандартных правил, можно переопределить стандартное поведение. Этот метод также дает возможность создавать правила для положительной и отрицательной синхронизации.

В примере ниже мы синхронизируем только пользователей, у которых для атрибута «Подразделение» задано значение «Продажи» или пустое значение.

1. Войдите на компьютер, на котором запущена служба Azure AD Connect Sync, используя учетную запись участника группы безопасности ADSyncAdmins.
2. В меню **Пуск** выберите **Редактор правил синхронизации**.
3. Выберите параметр **Входящие** и щелкните **Добавить новое правило**.
4. Задайте правилу описательное имя (например, \*In from AD — User DoNotSyncFilter\*), выберите правильный лес, для параметра **Тип объекта CS** укажите значение **Пользователь**, а для параметра **Тип объекта MV** — **Человек**. В поле **Тип связи** выберите **Объединение**, а в поле **Тип приоритета** — значение, которое не используется в другом правиле синхронизации (например, 60). Нажмите кнопку **Далее**.
5. Оставьте поля **Фильтр области** и **Правила объединения** пустыми и дважды нажмите кнопку **Далее**.
6. Щелкните **Добавить преобразование**, для параметра **Тип потока** выберите значение **Постоянный**, а для параметра **Целевой атрибут** — значение **sourceObjectType**. В поле **Источник** введите следующее выражение:<br>`IIF(IsNullOrEmpty([department]),NULL,IIF([department]<>”Sales”,”DoNotSync”,NULL))`
7. Нажмите кнопку «Добавить», чтобы сохранить правило.
8. Выполните полную синхронизацию: на вкладке **Соединители** щелкните правой кнопкой мыши пункт **SourceAD**, последовательно выберите **Выполнить** и **Полная синхронизация**, а затем нажмите кнопку **ОК**. Результат будет выглядеть следующим образом:<br>

> [AZURE.NOTE]Обратите внимание, что для определения объектов, которые будут синхронизироваться в AAD, мы используем комбинацию атрибутов cloudFiltered и sourceObjectType.
 
Использование выражений обеспечивает обширные возможности фильтрации. Обратите внимание, что в выражении выше, если подразделение не указано или указано подразделение «Продажи», мы используем литерал NULL. Это означает, что данный атрибут не передает значение, поэтому стандартные правила будут обрабатываться. Это нужно для того, чтобы определить, что именно следует создать в Azure AD: **пользователя** или **контакт**.


## Фильтрация по исходящим объектам

В некоторых случаях фильтрацию необходимо выполнять только после объединения объектов в метавселенной. Например, определение объектов для синхронизации может выполняться на основе атрибута mail из леса ресурсов и атрибута userPrincipalName из леса учетных записей. В таких случаях нужно создать фильтр на основе исходящего правила.

> [AZURE.NOTE]Для этого метода нужно изменить стандартные правила синхронизации. Изменять область правила синхронизации можно, но изменения, возможно, не будут сохранены после обновления до новой версии Azure AD Connect. Если вы используете фильтрацию по исходящим объектам, запишите, какие изменения сделаны, и после обновления убедитесь, что фильтрация по-прежнему работает. При необходимости внесите изменения повторно.
 

В примере ниже мы изменим фильтрацию так, чтобы синхронизировались только пользователи, значения атрибутов mail и userPrincipalName которых заканчиваются на @contoso.com.

1. Войдите на компьютер, на котором запущена служба Azure AD Connect Sync, используя учетную запись участника группы безопасности ADSyncAdmins.
2. В меню «Пуск» выберите редактор правил синхронизации.
3. В разделе «Типы правил» выберите «Исходящие».
4. Найдите правило с именем Out to AAD – User Join. Нажмите кнопку «Изменить».
5. В области навигации слева щелкните «Фильтр области». Нажмите кнопку «Добавить предложение». В поле «Атрибут» выберите значение mail, в поле «Оператор» — ENDSWITH, а в поле «Тип значения» — @contoso.com. Нажмите кнопку «Добавить предложение». В поле «Атрибут» выберите значение userPrincipalName, в поле «Оператор» — ENDSWITH, а в поле «Тип значения» — @contoso.com.
6. Щелкните Сохранить.
7. Выполните полную синхронизацию: на вкладке «Соединители» щелкните правой кнопкой мыши пункт SourceAD, последовательно выберите «Выполнить» и «Полная синхронизация», а затем нажмите кнопку «ОК».



## Дополнительные ресурсы

* [Azure AD Connect Sync: настройка параметров синхронизации](active-directory-aadconnectsync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md)

 

<!---HONumber=July15_HO5-->