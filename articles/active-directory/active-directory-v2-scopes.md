<properties
	pageTitle="Области, разрешения и предоставление согласия для Azure AD версии 2.0 | Microsoft Azure"
	description="Описание авторизации в конечной точке Azure AD версии 2.0, включая области, разрешение и предоставление согласия."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/26/2016"
	ms.author="dastrock"/>

# Области, разрешения и предоставление согласия для конечной точки версии 2.0

Приложения, интегрируемые с Azure AD, придерживаются определенной модели авторизации, позволяющей пользователям контролировать способ получения приложением доступа к их данным. Реализация версии 2.0 этой модели авторизации была обновлена, в результате чего изменился механизм взаимодействия приложения с Azure AD. В этой статье рассматриваются основные аспекты этой модели авторизации, включая области, разрешения и согласие на их предоставление.

> [AZURE.NOTE]
	Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, следует ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).

## Области и разрешения

В Azure AD реализован протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md). Это метод, позволяющий сторонним приложениям получать доступ к размещенным в Интернете ресурсам от имени пользователя. Любой размещенный в Интернете ресурс, интегрируемый с Azure AD, получает идентификатор ресурса или **URI идентификатора приложения**. К примеру, ниже приведены некоторые из размещенных в Интернете ресурсов Майкрософт:

- Единый API почты Office 365: `https://outlook.office.com`
- API Graph Azure AD: `https://graph.windows.net`
- Microsoft Graph: `https://graph.microsoft.com`

Это касается любых сторонних ресурсов, интегрированных с Azure AD. Любой из этих ресурсов также может определять набор разрешений, с помощью которых можно разделять функции ресурса на меньшие блоки. Например, в Microsoft Graph определено несколько разрешений:

- чтение календаря пользователя;
- запись в календарь пользователя;
- отправка сообщений в качестве пользователя.
- [и пр.](https://graph.microsoft.io)

Определив эти разрешения, ресурс обеспечивает точный контроль данных и внешнего доступа к ним. Стороннее приложение может запрашивать эти разрешения у пользователя, который должен будет предоставить их, чтобы приложение могло действовать от его имени. Путем фрагментации функций ресурса на меньшие наборы разрешений сторонние приложения можно настроить таким образом, чтобы они запрашивали только определенные разрешения, необходимые им для выполнения своей задачи. Такой подход также позволяет пользователям точно знать, как приложение будет использовать их данные, давая им большую уверенность в отсутствии вредоносных целей в работе приложения.

В Azure AD и OAuth эти разрешения называются **области**. Иногда их также называют **разрешениями OAuth2**. В Azure AD область представляется как строковое значение. Продолжим рассмотрение примера для Microsoft Graph. Значение области для каждого разрешения следующее:

- чтение календаря пользователя: `Calendar.Read`;
- запись в календарь пользователя: `Mail.ReadWrite`;
- Отправка сообщений в качестве пользователя: `Mail.Send`.

Приложение может запросить эти разрешения, указав области в запросах к конечной точке версии 2.0, как описано ниже.

## Области OpenId Connect

Реализация OpenID Connect версии 2.0 содержит несколько четко определенных областей, которые не применяются к какому-либо конкретному ресурсу: `openid`, `email`, `profile` и `offline_access`.

#### OpenId

Если приложение выполняет вход с помощью [OpenID Connect](active-directory-v2-protocols.md#openid-connect-sign-in-flow), оно должно запросить область `openid`. В рабочей учетной записи область `openid` отобразится на экране предоставления разрешения в виде разрешения "Выполнение входа", а в личной ученой записи Майкрософт — в виде разрешения "Просмотр профиля и подключение к приложениям и службам с помощью учетной записи Майкрософт". Это разрешение позволяет приложению получать уникальный идентификатор для пользователя в виде утверждения `sub`. Оно также предоставляет приложению доступ к конечной точке сведений о пользователе. Область `openid` также можно использовать на конечной точке маркеров версии 2.0 для получения маркеров "id\_token", которые можно использовать для защиты HTTP-вызовов между разными компонентами приложения.

#### Email

Область `email` можно включать вместе с областью `openid` и любыми другими. Она предоставляет приложению доступ к основному электронному адресу пользователя в виде утверждения `email`. Утверждение `email` будет включено в маркеры, только если электронный адрес связан с учетной записью пользователя (а это не всегда так). При использовании области `email` приложение должно быть готово обрабатывать случаи, когда утверждение `email` отсутствует в маркере.

#### Профиль

Область `profile` можно включать вместе с областью `openid` и любыми другими. Она предоставляет приложению доступ к широкому набору сведений о пользователе. К ним, в частности, относятся имя и фамилия пользователя, предпочтительное имя пользователя, идентификатор объекта и т. д. Полный список утверждений профиля, доступных в маркерах id\_token для конкретного пользователя, см. в [справочнике по маркерам версии 2.0](active-directory-v2-tokens.md).

#### Offline\_Access

[Область `offline_access`](http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) позволяет приложению получать доступ к ресурсам от имени пользователя в течение длительного времени. На экране предоставления разрешения рабочей учетной записи эта область отображается в виде разрешения "Постоянный доступ к вашим данным". На экране предоставления разрешения личной учетной записи Майкрософт она отображается в виде разрешения "Постоянный доступ к вашим сведениям". Когда пользователь подтвердит область `offline_access`, приложение сможет получать маркеры обновления от конечной точки маркеров версии 2.0. Маркеры обновления действуют в течение долгого времени и позволяют приложению получать новые маркеры доступы по мере истечения срока действия старых.

Если приложение не запрашивает область `offline_access`, оно не получит маркеры обновления. Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md#oauth2-authorization-code-flow) вы получите только маркер доступа из конечной точки `/token`. Маркер доступа будет действительным короткое время (обычно один час), но в конечном итоге срок его действия истечет. В этот момент приложение будет необходимо перенаправить пользователя обратно в конечную точку `/authorize`, чтобы получить новый код авторизации. При этом пользователю может потребоваться повторно ввести учетные данные или повторно предоставить разрешения в зависимости от типа приложения.

Дополнительные сведения о том, как получать и использовать маркеры обновления, можно найти в [справочнике по протоколу версии 2.0](active-directory-v2-protocols.md).


## Запрос на получение согласия одного пользователя

В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`. Например, при входе пользователя в приложение оно отправит запрос следующего вида (разрывы строк — для удобства чтения):

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendar.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

Параметр `scope` — это запрашиваемый приложением список областей с разделителями-пробелами. Каждая отдельная область указывается путем добавления значения области к идентификатору ресурса (URI идентификатора приложения). Приведенный выше запрос указывает, что приложению требуется разрешение на чтение календаря пользователя и отправку сообщений от лица пользователя.

После того как пользователь введет учетные данные, конечная точка версии 2.0 проверит наличие соответствующей записи **согласия пользователя**. Если пользователь ранее не давал согласие на предоставление какого-либо из запрашиваемых разрешений, конечная точка версии 2.0 предложит пользователю сделать это.

![Снимок экрана предоставления разрешений рабочей учетной записи](../media/active-directory-v2-flows/work_account_consent.png)

После того как пользователь одобрит разрешение, факт согласия будет записан, чтобы пользователю не пришлось повторно давать его при входе в дальнейшем.

## Запрос на получение согласия для клиента

Часто, когда организация приобретает лицензию или подписку на приложение, планируется полностью подготовить ее для сотрудников. В ходе этого процесса администратор компании может предоставить этому приложению разрешение действовать от лица любого сотрудника. При предоставлении разрешения всему клиенту для сотрудников этой организации не будет отображаться экран предоставления разрешения для этого приложения.

Чтобы запросить разрешение для всех пользователей в клиенте, приложение может использовать **конечную точку предоставления согласия администратора**, описанную ниже.

## Области только для администраторов

Определенные привилегированные разрешения в экосистеме Майкрософт могут быть помечены как **предназначенные только для администраторов**. Ниже представлены примеры таких областей:

- чтение данных каталога организации: `Directory.Read`;
- запись данных в каталог организации: `Directory.ReadWrite`;
- чтение групп безопасности в каталоге организации: `Groups.Read.All`

Хотя пользователь-клиент и может предоставить приложению доступ к таким данным, корпоративным пользователям нельзя предоставлять доступ к таким же конфиденциальным данным компании. Если приложение запрашивает доступ к одному из этих разрешений у корпоративного пользователя, появится сообщение об ошибке со сведениями о том, что этот пользователь не может предоставить доступ к разрешениям приложения.

Если вашему приложению требуется доступ к этим областям только для администраторов для организаций, следует запросить их непосредственно у администратора организации, а также с помощью **конечной точки предоставления согласия администратора**, описанной ниже.

Когда администратор предоставит эти разрешения через конечную точку предоставления согласия администратора, согласие будет предоставлено для всех пользователей в клиенте, как описано выше.

## Использование конечной точки предоставления согласия администратора

Выполнив следующие действия, приложение получит возможность сбора разрешений для всех пользователей в указанном клиенте, включая области только для администраторов. Пример кода, реализующий указанные ниже действия, см. в [примере областей только для администраторов](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2).

#### Запрос разрешений на портале регистрации приложения

- Перейдите к приложению на сайте [apps.dev.microsoft.com](https://apps.dev.microsoft.com) или [создайте приложение](active-directory-v2-app-registration.md), если оно еще не создано.
- Найдите раздел **Microsoft Graph Permissions** (Разрешения Microsoft Graph) и добавьте разрешения, необходимые для приложения.
- **Сохраните** регистрацию приложения.

#### Выполнение входа пользователя в приложение (рекомендуется)

Обычно при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в которых администратор может утвердить разрешения приложения. Эта страница не может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно определить организацию, к которой принадлежит администратор, перед запросом на утверждение требуемых разрешений. Это не является обязательным действием. Однако таким образом можно обеспечить более интуитивно понятную среду для пользователей вашей организации. Чтобы выполнить вход для пользователя, следуйте нашим [указаниям в руководствах о протоколе версии 2.0](active-directory-v2-protocols.md).

#### Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у администратора компании, можно перенаправить пользователя в **конечную точку предоставления согласия администратора** версии 2.0.

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/{tenant}/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissons
```

```
// Pro Tip: Try pasting the below request in a browser!
```

```
https://login.microsoftonline.com/common/adminconsent?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&state=12345&redirect_uri=http://localhost/myapp/permissions
```

| Параметр | | Описание |
| ----------------------- | ------------------------------- | --------------- |
| tenant | обязательно | Клиент каталога, из которого необходимо запросить разрешение. Можно указать в виде GUID или понятного имени. |
| client\_id | обязательно | Идентификатор приложения, назначенный приложению порталом регистрации ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)). |
| redirect\_uri | обязательно | URI перенаправления, которому требуется направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале. |
| state | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе токена. Это может быть строка любого контента. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |

На этом этапе Azure AD будет обеспечивать вход только администратора клиента для выполнения запроса. Администратору будет предложено утвердить все разрешения, запрошенные для приложения на портале регистрации.

##### Успешный ответ
Если администратор утверждает разрешения для приложения, успешный ответ будет выглядеть следующим образом:

```
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | Описание |
| ----------------------- | ------------------------------- | --------------- |
| tenant | Клиент каталога, предоставивший приложению запрошенные разрешения в виде GUID. |
| state | Значение, включенное в запрос, которое также возвращается в ответе токена. Это может быть строка любого контента. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| admin\_consent | Для этого параметра будет задано значение `True`. |



##### Сообщение об ошибке
Если администратор не утверждает разрешения для приложения, сбой ответа будет выглядеть следующим образом:

```
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | Описание |
| ----------------------- | ------------------------------- | --------------- |
| error | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error\_description | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки. |

После получения успешного ответа от конечной точки предоставления согласия администратора, приложение получило запрошенные разрешения. Теперь можно перейти к запросу маркера для требуемого ресурса, как описано ниже.

## Использование разрешений

После того как пользователь предоставит разрешения для приложения, оно может получать маркеры доступа, представляющие разрешение приложения на определенный уровень доступа к ресурсу. Каждый маркер доступа можно использовать для одного ресурса, но в нем будет закодировано каждое разрешение, предоставленное приложению для этого ресурса. Чтобы получить маркер доступа, приложение может отправить запрос на конечную точку маркеров версии 2.0:

```
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "authorization_code",
	"client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
	"scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
	"code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
	"redirect_uri": "https://localhost/myapp",
	"client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу. Он гарантированно укажет ресурсу, что у приложения есть необходимое разрешение для выполнения определенной задачи.

Дополнительные сведения о протоколе OAuth 2.0 и способах получения маркеров доступа можно найти в [справочнике по протоколу конечной точки версии 2.0](active-directory-v2-protocols.md).

<!---HONumber=AcomDC_0928_2016-->