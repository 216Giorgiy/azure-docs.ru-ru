<properties
	pageTitle="Модель приложений версии 2.0: области, разрешения и согласие | Microsoft Azure"
	description="Описание авторизации в модели приложений версии 2.0 Azure AD, включая области, разрешение и согласие на их предоставление."
	services="active-directory"
	documentationCenter=""
	authors="dstrockis"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="12/09/2015"
	ms.author="dastrock"/>

# Предварительная версия модели приложений 2.0: области, разрешения и согласие на их предоставление

Приложения, интегрируемые с Azure AD, придерживаются определенной модели авторизации, позволяющей пользователям контролировать способ получения приложением доступа к их данным. В модели приложений 2.0 реализация этой модели авторизация была обновлена, в результате чего изменился принцип взаимодействия приложения с Azure AD. В этом разделе рассматриваются основные аспекты этой модели авторизации, включая области, разрешения и согласие на их предоставление.

> [AZURE.NOTE]
	Эти сведения относятся к общедоступной предварительной версии модели приложений 2.0. Инструкции по интеграции с общедоступной службой Azure AD можно найти в статье [Руководство разработчика по Azure Active Directory](active-directory-developers-guide.md).

## Области и разрешения

В модели приложений 2.0 внедрен протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md). Это метод, позволяющий сторонним приложениям получать доступ к размещенным в Интернете ресурсам от лица пользователя. Любой размещенный в Интернете ресурс, интегрируемый с Azure AD, получает идентификатор ресурса или **URI идентификатора приложения**. К примеру, ниже приведены некоторые из размещенных в Интернете ресурсов Майкрософт:

- Единый API почты Office 365: `https://outlook.office.com`
- API диспетчера ресурсов Azure: `https://management.azure.com`
- API Graph Azure AD: `https://graph.windows.net`

Это касается любых сторонних ресурсов, интегрированных с Azure AD. Любой из этих ресурсов также может определять набор разрешений, с помощью которых можно разделять функции ресурса на меньшие блоки. Например, единый API почты Office 365 определил следующие основные разрешения:

- чтение почтового ящика пользователя;
- отправка сообщений в почтовый ящик пользователя;
- отправка сообщений в качестве пользователя.

Определив эти разрешения, ресурс обеспечивает точный контроль данных и внешнего доступа к ним. Стороннее приложение может запрашивать эти разрешения у конечного пользователя, который должен будет предоставить их, чтобы приложение могло действовать от его лица. Путем фрагментации функций ресурса на меньшие наборы разрешений сторонние приложения можно настроить таким образом, чтобы они запрашивали только определенные разрешения, необходимые им для выполнения своей задачи. Такой подход также позволяет пользователям точно знать, как приложение будет использовать их данные, давая им большую уверенность в отсутствии вредоносных целей в работе приложения.

В Azure AD и OAuth эти разрешения называются **области**. Иногда их также называют **разрешениями OAuth2**. В Azure AD область представляется как строковое значение. Рассмотрим единый API почты Office 365 в качестве примера. Значение области для каждого разрешения следующее:

- Чтение почтового ящика пользователя: `Mail.Read`.
- Отправка сообщений в почтовый ящик пользователя: `Mail.ReadWrite`.
- Отправка сообщений в качестве пользователя: `Mail.Send`.

Приложение может запросить эти разрешения, указав области в запросах к конечной точке версии 2.0, как описано ниже.

## Согласие на предоставление разрешений

В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`. Например, при входе пользователя в приложение оно отправит запрос следующего вида (разрывы строк — для удобства чтения):

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Foutlook.office.com%2Fmail.read%20
https%3A%2F%2Foutlook.office.com%2Fmail.send
&state=12345
```

Параметр `scope` — это запрашиваемый приложением список областей с разделителями-пробелами. Каждая отдельная область указывается путем добавления значения области к идентификатору ресурса (URI идентификатора приложения). Приведенный выше запрос указывает, что приложению требуется разрешение на чтение почтового ящика пользователя и отправку сообщений от лица пользователя.

После того как пользователь введет учетные данные, конечная точка версии 2.0 проверит наличие соответствующей записи **согласия пользователя**. Если пользователь ранее не давал согласие на предоставление какого-либо из запрашиваемых разрешений, конечная точка версии 2.0 предложит пользователю сделать это.

![Снимок экрана предоставления разрешений рабочей учетной записи](../media/active-directory-v2-flows/work_account_consent.png)

После того как пользователь одобрит разрешение, факт согласия будет записан, чтобы пользователю не пришлось повторно давать его при входе в дальнейшем.

## Добавочное согласие

Приложению не требуется запрашивать каждое необходимое разрешение при первоначальном входе или регистрации пользователя. Поскольку области можно указывать в каждом запросе, приложение может выполнить "добавочное согласие" и выбрать наиболее подходящее время для запроса согласия пользователя. Существует несколько распространенных причин, по которым приложение может не запросить все разрешения сразу:

- Приложения, требующие множество разрешений. Если приложение получает доступ к множеству разных ресурсов и выполняет различные функции на каждом из них, список необходимых ему разрешений может стремительно вырасти. Опыт показывает, что из-за длинных списков разрешений многие пользователи отказываются регистрироваться в приложении и использовать его. Вместо того чтобы запрашивать все разрешения сразу, приложение может запросить лишь часть разрешений при первоначальном входе, а затем постепенно запрашивать дополнительные разрешения, по мере того как пользователь будет использовать расширенные функции.
- Приложения, развивающиеся с течением времени. Почти любое приложение начинает работу с небольшим набором функций, в который со временем добавляются новые. С помощью добавочного согласия вы легко можете вносить изменения в приложение и постепенно запрашивать новые разрешения у пользователя. Для этого вам нужно лишь обновить код для отправки дополнительных областей в запросах авторизации.
- Разрешения только для администратора. Некоторые ресурсы определяют разрешения, которые может предоставить **только** администратор организации. Например, API Graph Azure AD определяет разрешение `Directory.Write`, позволяющее приложению, помимо прочего, создавать, обновлять и удалять пользователей и группы. Вполне очевидно, почему для этого разрешение требуется одобрение администратора с высоким уровнем привилегий. С помощью добавочного согласия приложение может предоставить базовый набор функций, для использования которого любой пользователь может зарегистрироваться без одобрения администратора. Однако при попытке выполнения действия, требующего высокого уровня привилегий, вы можете запросить разрешение только для администратора и потребовать, чтобы сам администратор зарегистрировался перед использованием этого раздела приложения.

## Использование разрешений

После того как пользователь предоставит разрешения для приложения, оно может получать маркеры доступа, представляющие разрешение приложения на определенный уровень доступа к ресурсу. Каждый маркер доступа можно использовать для одного ресурса, но в нем будет закодировано каждое разрешение, предоставленное приложению для этого ресурса. Чтобы получить маркер доступа, приложение может отправить запрос на конечную точку маркеров версии 2.0:

```
POST common/v2.0/oauth2/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
	"grant_type": "authorization_code",
	"client_id": "2d4d11a2-f814-46a7-890a-274a72a7309e",
	"scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
	"code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
	"client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу. Он гарантированно укажет ресурсу, что у приложения есть необходимое разрешение для выполнения определенной задачи.

Дополнительные сведения о протоколе OAuth 2.0 и способах получения маркеров доступа можно найти в [справочнике по протоколу модели приложений 2.0](active-directory-v2-protocols.md).


## Области OpenId Connect

Реализация OpenID Connect версии 2.0 содержит несколько четко определенных областей, которые не применяются к какому-либо конкретному ресурсу: `openid`, `email`, `profile` и `offline_access`.

#### OpenId

Если приложение выполняет вход с помощью [OpenID Connect](active-directory-v2-protocols.md#openid-connect-sign-in-flow), оно должно запросить область `openid`. В рабочей учетной записи область `openid` отобразится на экране предоставления разрешения в виде разрешения "Выполнение входа", а в личной ученой записи Майкрософт — в виде разрешения "Просмотр профиля и подключение к приложениям и службам с помощью учетной записи Майкрософт". Это разрешение позволяет приложению получать уникальный идентификатор для пользователя в виде утверждения `sub`. Оно также предоставляет приложению доступ к конечной точке сведений о пользователе. Область `openid` также можно использовать на конечной точке маркеров версии 2.0 для получения маркеров "id\_token", которые можно использовать для защиты HTTP-вызовов между разными компонентами приложения.

#### Email

Область `email` можно включать вместе с областью `openid` и любыми другими. Она предоставляет приложению доступ к основному адресу электронной почты пользователя в виде утверждения `email`. Утверждение `email` будет включено в маркеры, только если адрес электронной почты связан с учетной записью пользователя (а это не всегда так). При использовании области `email` приложение должно быть готово обрабатывать случаи, когда утверждение `email` отсутствует в маркере.

#### Профиль

Область `profile` можно включать вместе с областью `openid` и любыми другими. Она предоставляет приложению доступ к широкому набору сведений о пользователе. К ним, в частности, относятся имя и фамилия пользователя, предпочтительное имя пользователя, идентификатор объекта и т. д. Полный список утверждений профиля, доступных в маркерах id\_token для конкретного пользователя, см. в статье [Предварительная версия модели приложений 2.0: справочный материал по маркерам](active-directory-v2-tokens.md).

#### Offline\_Access

[Область `offline_access`](http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) позволяет приложению получать доступ к ресурсам от лица пользователя в течение длительного времени. На экране предоставления разрешения рабочей учетной записи эта область отображается в виде разрешения "Постоянный доступ к вашим данным". На экране предоставления разрешения личной учетной записи Майкрософт она отображается в виде разрешения "Постоянный доступ к вашим сведениям". Когда пользователь подтвердит область `offline_access`, приложение сможет получать маркеры обновления от конечной точки маркеров версии 2.0. Маркеры обновления действуют в течение долгого времени и позволяют приложению получать новые маркеры доступы по мере истечения срока действия старых.

Если приложение не запрашивает область `offline_access`, оно не получит маркеры обновления. Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md#oauth2-authorization-code-flow) вы получите только маркер доступа из конечной точки `/token`. Маркер доступа будет действительным короткое время (обычно один час), но в конечном итоге срок его действия истечет. В этот момент приложение будет необходимо перенаправить пользователя обратно в конечную точку `/authorize`, чтобы получить новый код авторизации. При этом пользователю может потребоваться повторно ввести учетные данные или повторно предоставить разрешения в зависимости от типа приложения.

Дополнительные сведения о том, как получать и использовать маркеры обновления, можно найти в [справочнике по протоколу версии 2.0](active-directory-v2-protocols.md).

<!---HONumber=AcomDC_0128_2016-->