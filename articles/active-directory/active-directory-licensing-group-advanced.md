---

title: "Дополнительные сценарии лицензирования на основе группы в Azure Active Directory | Документация Майкрософт"
description: "Дополнительные сценарии лицензирования на основе группы в Azure Active Directory"
services: active-directory
keywords: "Лицензирование Azure AD"
documentationcenter: 
author: curtand
manager: femila
editor: 
ms.assetid: 
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 02/21/2017
ms.author: curtand
translationtype: Human Translation
ms.sourcegitcommit: dad9a176f5f60b9165c5a55628929460047e5fdd
ms.openlocfilehash: a1510240350d88ee140acb11b3f86fd7985b9427
ms.lasthandoff: 02/22/2017


---

# <a name="azure-active-directory-group-based-licensing-additional-scenarios"></a>Дополнительные сценарии лицензирования на основе группы в Azure Active Directory

## <a name="group-based-licensing-using-dynamic-groups"></a>Лицензирование на основе группы с использованием динамических групп

Лицензирование на основе группы можно использовать с любой группой безопасности, а это значит, что ее можно использовать с динамическими группами Azure AD. Динамические группы выполняют правила для атрибутов объекта пользователя, чтобы автоматически добавлять пользователей в группы и удалять их из них.

Например, можно создать несколько динамических групп, по одной для каждого набора продуктов, которые необходимо назначить пользователям. Каждая группа содержит правило, просматривающее определенный атрибут пользователя и описывающее набор лицензий, которые он должен получить. Атрибут можно назначить локально и синхронизировать с Azure AD либо управлять им непосредственно в облаке.

Если атрибут указан, пользователь будет добавлен в одну или несколько динамических групп лицензирования. Вскоре после этого лицензии будут назначены пользователю. При удалении атрибута пользователь покидает группу и лицензии удаляются.

### <a name="example"></a>Пример

В этом примере локальное решение по управлению удостоверениями определяет, какие пользователи должны иметь доступ к определенным службам Microsoft Online Services. Для хранения строкового значения, представляющего лицензии, которые должен иметь пользователь, используется атрибут extensionAttribute1. Azure AD Connect синхронизирует его с Azure AD. Необходимо распространить лицензии на Office 365 E5 и EMS для пользователей. В Azure AD создаются две динамические группы, по одной для каждого продукта, так как некоторым пользователям может понадобиться только один из продуктов. Для каждой группы указывается правило динамического членства и параметры лицензии. Вот как они выглядят:

#### <a name="o365-e5--base-services"></a>Office 365 E5 — базовые службы

![Базовые службы Office 365 E5](media/active-directory-licensing-group-advanced/o365-e5-base-services.png)

#### <a name="ems-e5--licensed-users"></a>EMS E5 — лицензированные пользователи

![Лицензированные пользователи Office 365 E5](media/active-directory-licensing-group-advanced/o365-e5-licensed-users.png)

Один пользователь изменяется локально, и его атрибуту extensionAttribute1 присваивается значение `EMS;E5_baseservices;`, так как необходимо, чтобы у него были обе лицензии. После синхронизации изменений с облаком пользователь автоматически добавляется в обе группы, а затем ему назначаются лицензии.

![Задание атрибута extensionAttribute1 пользователя](media/active-directory-licensing-group-advanced/user-set-extensionAttribute1.png)

### <a name="modifying-a-dynamic-group-membership-rule"></a>Изменение правила членства в динамической группе

При изменении правила членства в имеющейся группе следует соблюдать осторожность. При изменении правила все пользователи удаляются из группы, правило выполняется и пользователи добавляются в группу на основе новых условий.

Если группе назначены лицензии, в процессе они будут удалены для всех пользователей. Новые лицензии будут применены только после выполнения нового правила и добавления пользователей обратно в группу. Это означает, что у пользователей могут возникнуть проблемы в работе службы или в некоторых случаях потеря данных.

Мы рекомендуем не изменять правило членства в группе, используемой для назначения лицензии. Вместо этого создайте группу с новым правилом и укажите те же параметры лицензии, что и в исходной группе. Подождите, пока добавятся участники и лицензии будут применены ко всем пользователям. Только после этого можно удалить исходную группу. Этот подход обеспечивает безопасный, поэтапный переход к новому правилу членства без потери доступа или данных для пользователей.


## <a name="multiple-groups-and-multiple-licenses"></a>Несколько групп и несколько лицензий

Пользователь может быть участником нескольких групп с лицензиями. При этом нужно помнить о следующем:

1. При наличии нескольких лицензий на один продукт они могут перекрываться, что приведет к тому, что все включенные службы будут применены к пользователю. Например, мы создали две группы лицензирования: *E3 — базовые службы*, содержащую основные службы, которые сначала необходимо развернуть для всех пользователей, и *E3 — расширенные службы*, содержащую дополнительные службы (Sway и планировщик), которые планируется испытать с некоторыми пользователями, в то время как Yammer останется отключенным до развертывания в будущем. В этом примере пользователь добавлен в обе группы:

  ![просмотр включенных служб](media/active-directory-licensing-group-advanced/view-enabled-services.png)

  В результате этому пользователю доступно 7 служб из 12 в продукте при использовании только одной лицензии на этот продукт.

2. Если выбрать лицензию *E3*, отобразятся дополнительные сведения, включая данные о том, какие службы доступны пользователю при членстве в определенных группах.

  ![просмотр включенных служб по группам](media/active-directory-licensing-group-advanced/view-enabled-service-by-group.png)

## <a name="direct-licenses-coexisting-with-group-licenses"></a>Сосуществование прямых лицензий с лицензиями группы

Если пользователь наследует лицензию от группы, удалить или изменить назначение лицензий непосредственно в объекте пользователя невозможно. Вместо этого все изменения необходимо внести в группе, а затем распространить их для всех пользователей.

Тем не менее в дополнение к унаследованной лицензии пользователю можно присвоить лицензию SKU. Это может пригодиться, например, для включения дополнительных служб из SKU только для одного пользователя, не затрагивая остальных пользователей.

Непосредственно назначенные лицензии можно удалить, но это не повлияет на наследуемые лицензии. Рассмотрим следующий пример, в котором пользователь наследует лицензию на план *Office 365 корпоративный E3* от группы, в результате чего включаются несколько служб.

1. Изначально пользователь наследует лицензию только от группы *E3 — базовые службы*. В результате включаются 4 плана службы, перечисленные ниже.

  ![Включенные службы группы E3](media/active-directory-licensing-group-advanced/e3-group-enabled-services.png)

2. Нажав кнопку **Назначить**, можно напрямую назначить пользователю лицензию E3. В этом случае необходимо отключить все планы службы, кроме "Yammer корпоративный".

  ![назначение лицензии пользователю](media/active-directory-licensing-group-advanced/assign-license-to-user.png)

3. В результате пользователь по-прежнему использует только 1 лицензию на продукт E3, но при прямом назначении служба *Yammer корпоративный* активируется только для этого пользователя. В списке можно увидеть, какие службы активируются при членстве в группе и прямом назначении.

  ![унаследованное и прямое назначение](media/active-directory-licensing-group-advanced/direct-vs-inherited-assignment.png)

4. При использовании прямого назначения разрешены следующие операции:

  а. *Yammer корпоративный* можно отключить непосредственно в объекте пользователя. Обратите внимание, что в отличие от других переключателей службы переключатель "Вкл./Выкл." активирован, так как эта служба включена непосредственно для пользователя, и поэтому ее можно изменить.

  b. Можно также включить дополнительные службы как часть напрямую назначенной лицензии.

  c. Кнопку **Удалить** можно использовать для удаления прямой лицензии пользователя. Вы увидите, что после этого у пользователя будет только унаследованная лицензия группы и только исходные службы останутся включенными.

    ![удаление прямого назначения](media/active-directory-licensing-group-advanced/remove-direct-license.png)

## <a name="usage-location"></a>Расположение использования

Некоторые службы корпорации Майкрософт доступны не во всех расположениях. Чтобы лицензию можно было назначить пользователю, администратор должен указать для этого пользователя свойство "Место использования". Это можно сделать на [портале Azure](https://portal.azure.com) в разделе "Пользователь" &gt; "Профиль" &gt; "Параметры".

Если лицензии назначаются группам, все пользователи, для которых не указано расположение, наследуют расположение каталога. Если пользователи находятся в разных местах, это должно быть правильно обозначено в объектах пользователей до добавления пользователей в группы с лицензиями.

## <a name="use-powershell-to-see-who-has-inherited-and-direct-licenses"></a>Использование PowerShell для просмотра пользователей с унаследованными и прямыми лицензиями

При использовании общедоступной предварительной версии нельзя использовать PowerShell для полного управления назначениями лицензий группы. Тем не менее его можно использовать для получения основных сведений о состоянии пользователя, а также о том, какие у него лицензии: унаследованные от группы или назначенные напрямую. В примере кода ниже показано, как администратор может создать базовый отчет о назначении лицензий.

1. Запустите командлет `connect-msolservice`, чтобы выполнить проверку подлинности и подключиться к клиенту.

2. `Get-MsolAccountSku` можно использовать для обнаружения всех подготовленных лицензий SKU в клиенте.

  ![использование командлета Get-Msolaccountsku](media/active-directory-licensing-group-advanced/get-msolaccountsku-cmdlet.png)

3. В этом примере необходимо узнать, какие пользователи получили лицензию *EMS* напрямую, какие унаследовали от группы, а какие и то, и другое. Будет использоваться сценарий PowerShell, содержащий две функции, с помощью которых можно узнать ответ на этот вопрос для объекта пользователя и номера SKU.
  ```
  \# Returns TRUE if the user has the license assigned directly

  function UserHasLicenseAssignedDirectly
  {
      Param(\[Microsoft.Online.Administration.User\]\$user, \[string\]\$skuId)

      foreach(\$license in \$user.Licenses)
      {
          \# we look for the specific license SKU in all licenses assigned to the user
          if (\$license.AccountSkuId -ieq \$skuId)
          {
              \# GroupsAssigningLicense contains a collection of IDs of objects assigning the license
              \# This could be a group object or a user object (contrary to what the name suggests)
              \# If the collection is empty, this means the license is assigned directly - this is the case for users who have never been licensed via groups in the past

              if (\$license.GroupsAssigningLicense.Count -eq 0)
              {
                  return \$true
              }
              \# If the collection contains the ID of the user object, this means the license is assigned directly
              \# Note: the license may also be assigned through one or more groups in addition to being assigned directly
              foreach (\$assignmentSource in \$license.GroupsAssigningLicense)
              {
                  if (\$assignmentSource -ieq \$user.ObjectId)
                  {
                      return \$true
                  }

              }
              return \$false
          }
      }
      return \$false
  }
  \# Returns TRUE if the user is inheriting the license from a group
  function UserHasLicenseAssignedFromGroup
  {
      Param(\[Microsoft.Online.Administration.User\]\$user, \[string\]\$skuId)
      foreach(\$license in \$user.Licenses)
      {
          \# we look for the specific license SKU in all licenses assigned to the user
          if (\$license.AccountSkuId -ieq \$skuId)
          {
              \# GroupsAssigningLicense contains a collection of IDs of objects assigning the license
              \# This could be a group object or a user object (contrary to what the name suggests)
              foreach (\$assignmentSource in \$license.GroupsAssigningLicense)
              {
                  \# If the collection contains at least one ID not matching the user ID this means that the license is inherited from a group.
                  \# Note: the license may also be assigned directly in addition to being inherited
                  if (\$assignmentSource -ine \$user.ObjectId)
                  {
                      return \$true
                  }
              }
              return \$false
          }
      }
      return \$false
  }
  ```
4. Остальная часть сценария возвращает всех пользователей и выполняет следующие функции для каждого пользователя, а затем форматирует выходные данные в таблицу.

  ```
  \# the license SKU we are interested in
  \$skuId = "reseller-account:EMS"
  \# find all users that have the SKU license assigned
  Get-MsolUser -All | where {\$\_.isLicensed -eq \$true -and \$\_.Licenses.AccountSKUID -eq \$skuId} | select \`
      ObjectId, \`
      @{Name="SkuId";Expression={\$skuId}}, \`
      @{Name="AssignedDirectly";Expression={(UserHasLicenseAssignedDirectly \$\_ \$skuId)}}, \`
      @{Name="AssignedFromGroup";Expression={(UserHasLicenseAssignedFromGroup \$\_ \$skuId)}}
  ```

5. Выходные данные полного сценария выглядят следующим образом:

  ![Выходные данные сценария PowerShell](media/active-directory-licensing-group-advanced/powershell-script-output.png)

## <a name="limitations-and-known-issues"></a>Ограничения и известные проблемы

1. Лицензирование на основе группы сейчас не поддерживает "вложенные группы" (группы, содержащие другие группы). Если применить лицензию к вложенной группе, она будет применена только к участникам группы первого уровня.

2. Лицензирование на основе группы сейчас доступно только на [портале Azure](https://portal.azure.com). Использовать PowerShell для задания или изменения лицензий в группах сейчас невозможно.

3. [Портал администрирования Office 365](https://portal.office.com ) сейчас не поддерживает лицензирование на основе группы. Если пользователь наследует лицензию от группы, эта лицензия будет отображаться на портале администрирования Office 365 как обычная лицензия пользователя. При попытке изменить эту лицензию (например, чтобы отключить службу в лицензии или попытаться удалить лицензию) на портале появится сообщение об ошибке (так как наследуемые от группы лицензии невозможно изменить непосредственно для пользователя).

  `To assign a license that contains Azure Information Protection Plan 1, you must also assign one of the following service plans: Azure Rights Management.`

4. Если пользователь удаляется из группы и теряет лицензии, для планов службы этой лицензии (например, Exchange Online или SharePoint Online) устанавливается состояние "Приостановлено", в отличие от окончательного отключенного состояния. Это осуществляется в качестве меры предосторожности во избежание непреднамеренного удаления данных пользователя, если администратор совершит ошибку при управлении членством в группе.

  В ближайшем будущем мы реализуем рабочий процесс, в котором состояние этих планов службы будет в конечном счете полностью отключено для этих пользователей. Пока это не реализовано, некоторые службы могут продолжать работать для пользователей, которые были удалены из группы и у которых больше нет лицензии.

5. Если лицензии назначены или изменены для слишком большой группы пользователей (например, 100 000 пользователей), большое количество изменений, созданных службой автоматизации Azure AD, может отрицательно повлиять на производительность синхронизации каталогов между Azure AD и локальными системами. Это может привести к задержкам при синхронизации каталогов в вашей среде.

6. Служба автоматизации управления лицензиями не реагирует автоматически на все типы изменений в среде. Например, у вас может быть недостаточно лицензий и некоторые пользователи будут находиться в состоянии ошибки "Недостаточно лицензий". Вы можете удалить некоторые напрямую назначенные лицензии у других пользователей, чтобы освободить число доступных мест. Тем не менее система не будет автоматически реагировать на это изменение, и пользователи все еще будут находиться в этом состоянии ошибки.

  Чтобы обойти эту проблему, связанную с такого рода ограничениями, перейдите в колонку группы в Azure AD и нажмите кнопку **Повторная обработка**. После этого все пользователи в этой группе будут обработаны и состояние ошибки будет устранено, если это возможно.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о других сценариях управления лицензиями групп см. в следующих статьях:

* [Group-based licensing basics in Azure Active Directory](active-directory-licensing-whatis-azure-portal.md) (Основы группового лицензирования в Azure Active Directory)
* [Назначение лицензий группе в Azure Active Directory](active-directory-licensing-group-assignment-azure-portal.md)
* [Поиск и устранение проблем лицензирования группы в Azure Active Directory](active-directory-licensing-group-problem-resolution-azure-portal.md)
* [Как перевести отдельных лицензированных пользователей на групповое лицензирование в Azure Active Directory](active-directory-licensing-group-migration-azure-portal.md)

