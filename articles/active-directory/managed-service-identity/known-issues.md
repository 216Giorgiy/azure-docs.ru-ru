---
title: Вопросы и ответы, а также известные проблемы с управляемым удостоверением службы (MSI) для Azure Active Directory
description: Известные проблемы с управляемым удостоверением службы для Azure Active Directory.
services: active-directory
documentationcenter: ''
author: daveba
manager: mtillman
editor: ''
ms.assetid: 2097381a-a7ec-4e3b-b4ff-5d2fb17403b6
ms.service: active-directory
ms.component: msi
ms.devlang: ''
ms.topic: conceptual
ms.tgt_pltfrm: ''
ms.workload: identity
ms.date: 12/12/2017
ms.author: daveba
ms.openlocfilehash: 05096050dfc29aebd2859b298eef884dcd9a1111
ms.sourcegitcommit: d551ddf8d6c0fd3a884c9852bc4443c1a1485899
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2018
ms.locfileid: "37906220"
---
# <a name="faqs-and-known-issues-with-managed-service-identity-msi-for-azure-active-directory"></a>Вопросы и ответы, а также известные проблемы с управляемым удостоверением службы (MSI) для Azure Active Directory

[!INCLUDE[preview-notice](../../../includes/active-directory-msi-preview-notice.md)]

## <a name="frequently-asked-questions-faqs"></a>Часто задаваемые вопросы (FAQ)

### <a name="does-msi-work-with-azure-cloud-services"></a>Работает ли MSI с облачными службами Azure?

Нет. Мы не планируем поддерживать MSI в облачных службах Azure.

### <a name="does-msi-work-with-the-active-directory-authentication-library-adal-or-the-microsoft-authentication-library-msal"></a>Можно ли использовать MSI с библиотекой аутентификации Active Directory (ADAL) или библиотекой аутентификации Microsoft (MSAL)?

Нет, MSI не еще интегрирован с ADAL или MSAL. Дополнительные сведения о том, как получить маркер MSI с использованием конечной точки MSI REST, см. в статье [Использование управляемого удостоверения службы (MSI) виртуальной машины Azure для получения маркера](how-to-use-vm-token.md).

### <a name="what-is-the-security-boundary-of-a-managed-service-identity"></a>Что собой представляет периметр безопасности для управляемого удостоверения службы?

Периметром безопасности удостоверения является ресурс, к которому оно подключено. Например, периметром безопасности для MSI виртуальной машины является виртуальная машина. В любом коде, выполняемом на этой виртуальной машине, можно вызвать конечную точку и маркеры запроса MSI. Этот принцип применяется и к другим ресурсам, которые поддерживают MSI.

### <a name="should-i-use-the-msi-vm-imds-endpoint-or-the-msi-vm-extension-endpoint"></a>Что следует использовать: конечную точку IMDS ВМ MSI или конечную точку расширения ВМ MSI?

При использовании MSI с виртуальными машинами рекомендуется использовать конечную точку MSI IMDS. Служба метаданных экземпляров Azure является конечной точкой REST, доступной всем виртуальным машинам IaaS, созданным с помощью Azure Resource Manager. Ниже приведены некоторые преимущества использования MSI через IMDS.

1. Все операционные системы, поддерживаемые Azure IaaS, могут использовать MSI через IMDS. 
2. Для включения MSI больше не нужно устанавливать расширение на виртуальную машину. 
3. Сертификаты, используемые MSI, больше не хранятся на виртуальной машине. 
4. Конечная точка IMDS представляет собой известный IP-адрес без поддержки маршрутизации, к которому можно получить доступ только в пределах виртуальной машины. 

Расширение ВМ MSI по-прежнему можно использовать, однако в дальнейшем в качестве конечной точки по умолчанию будет использоваться IMDS. Расширение ВМ MSI вскоре будет внесено в план вывода из эксплуатации. 

Дополнительные сведения о службе метаданных экземпляров Azure см. в [документации по IMDS](https://docs.microsoft.com/azure/virtual-machines/windows/instance-metadata-service)

### <a name="what-are-the-supported-linux-distributions"></a>Какие дистрибутивы Linux поддерживаются?

Все дистрибутивы Linux, поддерживаемые IaaS Azure, могут использоваться с MSI через конечную точку IMDS. 

Примечание. Расширение ВМ MSI поддерживает только следующие дистрибутивы Linux:
- CoreOS Stable
- CentOS 7.1;
- Red Hat 7.2
- Ubuntu 15.04.
- Ubuntu 16.04.

Другие дистрибутивы Linux в настоящее время не поддерживаются, поэтому при их использовании установка расширения может завершиться ошибкой.

Расширение работает для CentOS 6.9. Однако из-за отсутствия поддержки системы версии 6.9 при сбое или завершении работы расширения, автоматического перезапуска не произойдет. Оно повторно запустится после перезапуска виртуальной машины. Чтобы перезапустить расширение вручную, см. сведения в разделе о [перезапуске расширения MSI](#how-do-you-restart-the-msi-extension).

### <a name="how-do-you-restart-the-msi-extension"></a>Как перезапустить расширение MSI?
При завершении работы расширения в Windows и некоторых версиях Linux вы можете перезапустить его вручную с помощью следующего командлета:

```powershell
Set-AzureRmVMExtension -Name <extension name>  -Type <extension Type>  -Location <location> -Publisher Microsoft.ManagedIdentity -VMName <vm name> -ResourceGroupName <resource group name> -ForceRerun <Any string different from any last value used>
```

Описание 
- Для Windows используется имя расширения и тип ManagedIdentityExtensionForWindows.
- Для Linux используется имя расширения и тип ManagedIdentityExtensionForLinux.

## <a name="known-issues"></a>Известные проблемы

### <a name="automation-script-fails-when-attempting-schema-export-for-msi-extension"></a>Использование функции "Скрипт автоматизации" завершается ошибкой при попытке экспорта схемы для расширения MSI.

Если на виртуальной машине включено расширение "Управляемое удостоверение службы", отображается следующая ошибка при попытке использовать функцию "Скрипт автоматизации" для виртуальной машины или ее группы ресурсов:

![Ошибка экспорта скрипта автоматизации MSI](../media/msi-known-issues/automation-script-export-error.png)

Расширение виртуальной машины "Управляемое удостоверение службы" в настоящее время не поддерживает возможность экспорта его схемы в шаблон группы ресурсов. Поэтому созданный шаблон не содержит параметры конфигурации для включения расширения "Управляемое удостоверение службы" в ресурсе. Эти разделы можно добавить вручную. Инструкции и примеры см. в статье [Настройка управляемого удостоверения службы (MSI) на виртуальной машине Azure с помощью шаблона](qs-configure-template-windows-vm.md).

Когда функция экспорта схемы станет доступной для расширения виртуальной машины "Управляемое удостоверение службы", оно будет добавлено в раздел [Поддерживаемые расширения виртуальной машины](../../virtual-machines/extensions/export-templates.md#supported-virtual-machine-extensions).

### <a name="configuration-blade-does-not-appear-in-the-azure-portal"></a>На портале Azure не отображается колонка "Конфигурация"

Если колонка "Конфигурация виртуальной машины" для виртуальной машины не отображается, значит, функция MSI еще не включена на портале в вашем регионе.  Повторите попытку позже.  Можно также включить MSI для виртуальной машины с помощью [PowerShell](qs-configure-powershell-windows-vm.md) или [Azure CLI](qs-configure-cli-windows-vm.md).

### <a name="cannot-assign-access-to-virtual-machines-in-the-access-control-iam-blade"></a>Не удается назначить доступ виртуальным машинам в колонке "Управление доступом (IAM)"

Если на портале Azure в списке **Назначение доступа к** на странице **Управление доступом (IAM)** > **Добавление разрешений** недоступен для выбора пункт **Виртуальная машина**, то функция управляемого удостоверения службы еще не включена на портале в вашем регионе. Повторите попытку позже.  Вы все равно можете выбрать управляемое удостоверение службы для назначения ролей, выполнив поиск субъекта-службы MSI.  Введите имя виртуальной машины в поле **Выбор**, и субъект-служба отобразится в результатах поиска.

### <a name="vm-fails-to-start-after-being-moved-from-resource-group-or-subscription"></a>Виртуальная машина не запускается после перемещения из группы ресурсов или подписки

Если перемещается запущенная виртуальная машина, то она продолжает работать во время перемещения. Однако если после перемещения виртуальная машина останавливается и перезапускается, то ее запуск завершается сбоем. Эта проблема возникает из-за того, что виртуальная машина не обновляет ссылку на удостоверение MSI и продолжает указывать на него в старой группе ресурсов.

**Возможное решение** 
 
Активируйте обновление на виртуальной машине, чтобы она могла получить правильные значения для MSI. Можно изменить свойства виртуальной машины, чтобы обновить ссылку на удостоверение MSI. Например, можно задать новое значение тега виртуальной машины с помощью следующей команды.

```azurecli-interactive
 az  vm update -n <VM Name> -g <Resource Group> --set tags.fixVM=1
```
 
Эта команда задает новый тег fixVM со значением 1 для виртуальной машины. 
 
После установки этого свойства виртуальная машина обновится и будет использовать правильный универсальный код ресурса (URI) MSI, и вы сможете запустить ее. 
 
После запуска виртуальной машины этот тег можно будет удалить, выполнив следующую команду.

```azurecli-interactive
az vm update -n <VM Name> -g <Resource Group> --remove tags.fixVM
```

## <a name="known-issues-with-user-assigned-identities"></a>Известные проблемы с пользовательскими удостоверениями

- Назначение пользовательских удостоверений доступно только для виртуальных машин и масштабируемых наборов виртуальных машин. Важно. Назначение пользовательских удостоверений будет изменено в ближайшие месяцы.
- Повторяющиеся пользовательские удостоверения в одной и той же виртуальной машине или масштабируемом наборе виртуальных машин приведут к сбою этой виртуальной машины или масштабируемого набора. Это относится и к удостоверениям, добавляемым в разном регистре. Например, MyUserAssignedIdentity и myuserassignedidentity. 
- Подготовка расширения для виртуальной машины может завершиться сбоем из-за ошибок при поиске DNS. Перезапустите виртуальную машину и повторите попытку. 
- Добавление несуществующего пользовательского удостоверения вызовет сбой виртуальной машины. 
- При создании пользовательского удостоверения не поддерживается использование специальных знаков (например, символа подчеркивания) в имени.
- В комплексном сценарии имена пользовательских удостоверений должны содержать не более 24 знаков. Назначение пользовательских удостоверений с именами, содержащими более 24 знаков, завершится сбоем.
- Если используется расширение виртуальной машины для управляемых удостоверений, то поддерживается до 32 назначенных пользователем управляемых удостоверений. Если расширение виртуальной машины для управляемых удостоверений отсутствует, то лимит составляет 512.  
- При добавлении второго пользовательского удостоверения clientID может оказаться недоступным для маркеров запросов для расширения виртуальной машины. Чтобы устранить эту проблему, перезапустите расширение MSI для виртуальной машины с помощью следующих двух команд Bash.
 - `sudo bash -c "/var/lib/waagent/Microsoft.ManagedIdentity.ManagedIdentityExtensionForLinux-1.0.0.8/msi-extension-handler disable"`
 - `sudo bash -c "/var/lib/waagent/Microsoft.ManagedIdentity.ManagedIdentityExtensionForLinux-1.0.0.8/msi-extension-handler enable"`
- Если на виртуальной машине есть пользовательское удостоверение, но отсутствует системное удостоверение, то в пользовательском интерфейсе портала будет отображаться информация, что удостоверение MSI отключено. Чтобы включить системное удостоверение, используйте шаблон Azure Resource Manager, Azure CLI или пакет SDK.
