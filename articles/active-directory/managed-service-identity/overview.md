---
title: Что такое Управляемое удостоверение службы для ресурсов Azure
description: Обзор применения управляемого удостоверения службы (MSI) для ресурсов Azure.
services: active-directory
documentationcenter: ''
author: daveba
manager: mtillman
editor: ''
ms.assetid: 0232041d-b8f5-4bd2-8d11-27999ad69370
ms.service: active-directory
ms.component: msi
ms.devlang: ''
ms.topic: overview
ms.custom: mvc
ms.date: 03/28/2018
ms.author: daveba
ms.openlocfilehash: 3d6df04df8ceac1f868e64f0e8fbc7eb0fa317e3
ms.sourcegitcommit: 0a84b090d4c2fb57af3876c26a1f97aac12015c5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2018
ms.locfileid: "38547979"
---
#  <a name="what-is-managed-service-identity-for-azure-resources"></a>Что такое Управляемое удостоверение службы для ресурсов Azure?

[!INCLUDE[preview-notice](../../../includes/active-directory-msi-preview-notice.md)]

Распространенная проблема при создании облачных приложений — управление учетными данными, которые необходимы в коде для аутентификации в облачных службах. Обеспечение безопасности этих учетных данных является важной задачей. В идеальном случае они никогда не передаются на рабочие станции разработчиков и не записываются после изменения в систему управления версиями. Azure Key Vault позволяет обеспечить безопасное хранение учетных данных, а также других ключей и секретов, но для их получения код должен выполнять аутентификацию в Key Vault. Управляемое удостоверение службы упрощает решение этой задачи, предоставляя службам Azure автоматически управляемое удостоверение в Azure Active Directory (Azure AD). Это удостоверение можно использовать для аутентификации в любой службе, которая поддерживает аутентификацию Azure AD, включая Key Vault, не храня какие-либо учетные данные в коде.

Управляемое удостоверение службы предоставляется бесплатно с лицензией Azure Active Directory во всех подписках Azure. За использование возможностей управляемого удостоверения службы не взимается дополнительная плата.

## <a name="how-does-it-work"></a>Как это работает?

Существует два типа удостоверений MSI: **назначаемые системой** и **назначаемые пользователем**.

- **Назначаемое системой удостоверение** включается непосредственно в экземпляре службы Azure. Если оно включено, Azure создает удостоверение для экземпляра службы в клиенте Azure AD, который является доверенным в подписке этого экземпляра. После создания удостоверения его учетные данные подготавливаются для передачи в экземпляр службы. Жизненный цикл назначенного системой удостоверения напрямую связан с экземпляром службы Azure, в которой оно включено. При удалении экземпляра службы Azure автоматически очищает учетные данные и удостоверение в Azure AD.
- **Назначаемое пользователем удостоверение** создается как изолированный ресурс Azure. При этом Azure создает удостоверение в доверенном клиенте Azure AD используемой подписки. После создания удостоверение можно назначить одному или нескольким экземплярам служб Azure. Управление жизненным циклом назначаемого пользователем удостоверения осуществляется отдельно от жизненного цикла экземпляров службы Azure, для которых он назначен.

В результате ваш код может использовать назначенное системой или пользователем удостоверение для выполнения запроса на получение маркеров доступа для служб, поддерживающих проверку подлинности Azure AD. Одновременно с этим Azure выполняет развертывание учетных данных, используемых экземпляром службы.

Ниже приведен пример работы назначаемых системой удостоверений с виртуальными машинами Azure.

![Пример управляемого удостоверения виртуальной машины](overview/msi-vm-vmextension-imds-example.png)

1. Azure Resource Manager получает запрос на включение назначенного системой удостоверения MSI в виртуальной машине.
2. Azure Resource Manager создает субъект-службу в Azure AD, представляющий удостоверение виртуальной машины. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.
3. Azure Resource Manager настраивает удостоверение на виртуальной машине;
    - обновляет конечную точку удостоверения службы метаданных экземпляров Azure с помощью идентификатора и сертификата клиента для субъекта-службы;
    - предоставляет расширение виртуальной машины и добавляет идентификатор клиента и сертификат для субъекта-службы (не рекомендуется).
4. Теперь когда виртуальной машине назначено удостоверение, для предоставления ей доступа к ресурсам Azure используются сведения о субъекте-службе. Например, если ваш код должен вызывать Azure Resource Manager, то следует назначить субъекту-службе виртуальной машины соответствующую роль с помощью управления доступом на основе ролей (RBAC) в Azure AD. Если код должен отправить вызов к Key Vault, то ему следует предоставить доступ к определенному секрету или ключу в Key Vault.
5. Ваш код, выполняющийся на виртуальной машине, может выполнить запрос на получение маркера из двух конечных точек, доступных только на виртуальной машине.

    - Конечная точка удостоверения службы метаданных экземпляров Azure (IMDS): http://169.254.169.254/metadata/identity/oauth2/token (рекомендуется).
        - Параметр ресурса указывает службу, в которую отправляется маркер. Например, если нужно выполнить аутентификацию кода в Azure Resource Manager, используйте параметр resource=https://management.azure.com/.
        - Параметр версии API указывает версию IMDS. Используйте api-version=2018-02-01 или более позднюю версию.
    - Конечная точка расширения виртуальной машины http://localhost:50342/oauth2/token (будет объявлена устаревшей).
        - Параметр ресурса указывает службу, в которую отправляется маркер. Например, если нужно выполнить аутентификацию кода в Azure Resource Manager, используйте параметр resource=https://management.azure.com/.

6. В Azure AD выполняется вызов для запроса маркера доступа (как показано в шаге 5) с использованием идентификатора клиента и сертификата, настроенных на шаге 3. Azure AD возвращает маркер доступа JSON Web Token (JWT).
7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.

В этой же схеме ниже показано, как назначаемое пользователем удостоверение работает с виртуальными машинами Azure.

1. Azure Resource Manager получает запрос на создание назначаемого пользователем удостоверения.
2. Azure Resource Manager создает субъект-службу в Azure AD, представляющий назначаемое пользователем удостоверение. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.
3. Azure Resource Manager получает запрос на настройку назначаемого пользователем удостоверения в виртуальной машине.
    - Обновляет конечную точку удостоверения службы метаданных экземпляров Azure с помощью клиентского идентификатора и сертификата субъекта-службы назначаемого пользователем удостоверения.
    - Выполняет подготовку расширения виртуальной машины и добавляет клиентский идентификатор и сертификат субъекта-службы назначаемого пользователем удостоверения (будет объявлено устаревшим).
4. После создания назначаемого пользователем удостоверения, чтобы предоставить ему доступ к ресурсам Azure, используются сведения о субъекте-службе. Например, если ваш код должен вызывать Azure Resource Manager, следует назначить субъекту-службе назначаемого пользователем удостоверения соответствующую роль с помощью управления доступом на основе ролей (RBAC) в Azure AD. Если код должен отправить вызов к Key Vault, то ему следует предоставить доступ к определенному секрету или ключу в Key Vault. Примечание. Это действие можно также выполнить перед шагом 3.
5. Ваш код, выполняющийся на виртуальной машине, может выполнить запрос на получение маркера из двух конечных точек, доступных только на виртуальной машине.

    - Конечная точка удостоверения службы метаданных экземпляров Azure (IMDS): http://169.254.169.254/metadata/identity/oauth2/token (рекомендуется).
        - Параметр ресурса указывает службу, в которую отправляется маркер. Например, если нужно выполнить аутентификацию кода в Azure Resource Manager, используйте параметр resource=https://management.azure.com/.
        - Параметр идентификатора клиента определяет удостоверение, для которого запрашивается маркер. Это необходимо для устранения неоднозначности в случае наличия более одного назначаемого пользователем удостоверения на одной виртуальной машине.
        - Параметр версии API указывает версию IMDS. Используйте api-version=2018-02-01 или более позднюю версию.

    - Конечная точка расширения виртуальной машины http://localhost:50342/oauth2/token (будет объявлена устаревшей).
        - Параметр ресурса указывает службу, в которую отправляется маркер. Например, если нужно выполнить аутентификацию кода в Azure Resource Manager, используйте параметр resource=https://management.azure.com/.
        - Параметр идентификатора клиента определяет удостоверение, для которого запрашивается маркер. Это необходимо для устранения неоднозначности в случае наличия более одного назначаемого пользователем удостоверения на одной виртуальной машине.
6. В Azure AD выполняется вызов для запроса маркера доступа (как показано в шаге 5) с использованием идентификатора клиента и сертификата, настроенных на шаге 3. Azure AD возвращает маркер доступа JSON Web Token (JWT).
7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.
     
## <a name="try-managed-service-identity"></a>Использование управляемого удостоверения службы

Чтобы ознакомиться с комплексными сценариями для доступа к различным ресурсам Azure, используйте руководство по управляемому удостоверению службы:
<br><br>
| Из ресурсов с поддержкой управляемых удостоверений | Сценарий для ознакомления |
| ------- | -------- |
| Виртуальная машина Azure (Windows) | [Получение доступа к Azure Data Lake Store с помощью управляемого удостоверения службы виртуальной машины Windows](tutorial-windows-vm-access-datalake.md) |
|                    | [Получение доступа к Azure Resource Manager с помощью управляемого удостоверения службы виртуальной машины Windows](tutorial-windows-vm-access-arm.md) |
|                    | [Получение доступа к Azure SQL с помощью управляемого удостоверения службы виртуальной машины Windows](tutorial-windows-vm-access-sql.md) |
|                    | [Получение доступа к службе хранилища Azure с ключом доступа при помощи управляемого удостоверения службы виртуальной машины Windows](tutorial-windows-vm-access-storage.md) |
|                    | [Получение доступа к службе хранилища Azure с SAS при помощи управляемого удостоверения службы виртуальной машины Windows](tutorial-windows-vm-access-storage-sas.md) |
|                    | [Получение доступа к ресурсу, размещенному не в Azure AD, с помощью управляемого удостоверения службы виртуальной машины Windows и Azure Key Vault](tutorial-windows-vm-access-nonaad.md) |
| Виртуальная машина Azure (Linux)   | [Получение доступа к Azure Data Lake Store с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-datalake.md) |
|                    | [Получение доступа к Azure Resource Manager с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-arm.md) |
|                    | [Получение доступа к службе хранилища Azure с ключом доступа при помощи управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-storage.md) |
|                    | [Получение доступа к службе хранилища Azure с SAS при помощи управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-storage-sas.md) |
|                    | [Получение доступа к ресурсу, размещенному не в Azure AD, с помощью управляемого удостоверения службы виртуальной машины Linux и Azure Key Vault](tutorial-linux-vm-access-nonaad.md) |
| Служба приложений Azure  | [Использование управляемого удостоверения службы со службой приложений Azure или службой "Функции Azure"](/azure/app-service/app-service-managed-service-identity) |
| Функции Azure    | [Использование управляемого удостоверения службы со службой приложений Azure или службой "Функции Azure"](/azure/app-service/app-service-managed-service-identity) |
| Azure Service Bus  | [Использование удостоверения управляемой службы со служебной шиной Azure](../../service-bus-messaging/service-bus-managed-service-identity.md) |
| Концентраторы событий Azure   | [Использование удостоверения управляемой службы с концентраторами событий Azure](../../event-hubs/event-hubs-managed-service-identity.md) |

## <a name="which-azure-services-support-managed-service-identity"></a>Какие службы Azure поддерживают управляемое удостоверение службы?

Управляемые удостоверения можно использовать для проверки подлинности служб, поддерживающих проверку подлинности Azure AD. Список служб Azure, поддерживающих управляемое удостоверение службы, см. в следующей статье:
- [Службы, поддерживающие управляемое удостоверение службы](services-support-msi.md)

## <a name="next-steps"></a>Дополнительная информация

Для начала работы с управляемым удостоверением службы Azure ознакомьтесь со следующими краткими руководствами.

* [Получение доступа к Resource Manager с помощью Управляемого удостоверения службы виртуальной машины Windows](tutorial-windows-vm-access-arm.md)
* [Получение доступа к Azure Resource Manager с помощью Управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-arm.md)
