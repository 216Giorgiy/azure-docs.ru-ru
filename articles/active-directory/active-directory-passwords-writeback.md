---
title: "Azure AD SSPR с компонентом обратной записи паролей | Документация Майкрософт"
description: "Используйте Azure AD и Azure AD Connect для обратной записи паролей в локальный каталог"
services: active-directory
keywords: "Управление паролями Active Directory, управление паролями, самостоятельный сброс пароля Azure AD"
documentationcenter: 
author: MicrosoftGuyJFlo
manager: femila
ms.reviewer: gahug
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/28/2017
ms.author: joflore
ms.custom: it-pro
ms.openlocfilehash: e460e734973622fb0d5745adfc4c1aa0178dd22e
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="password-writeback-overview"></a>Обзор обратной записи паролей

Компонент обратной записи паролей позволяет настроить в Azure AD запись паролей в локальный экземпляр Active Directory. Это устраняет необходимость в настройке и управлении комплексным локальным решением по сбросу паролей в режиме самообслуживания, а также предоставляет пользователям удобный облачный способ сброса локальных паролей из любого места. Компонент обратной записи паролей  — это компонент [Azure Active Directory Connect](./connect/active-directory-aadconnect.md), который могут включить и использовать текущие подписчики [Azure Active Directory](active-directory-editions.md) Premium.

Компонент обратной записи паролей предоставляет следующие возможности:

* **Обратная связь с нулевой задержкой.** Обратная запись паролей выполняется в синхронном режиме. Пользователи немедленно получают уведомление, если пароль не соответствует политике или если его не удалось сбросить или изменить по любой причине.
* **Поддержка сброса паролей для пользователей, использующих AD FS или другие технологии федерации.** С обратной записью паролей, при условии, что федеративные учетные записи пользователей синхронизируются в клиенте Azure AD, они смогут управлять локальными паролями AD из облака.
* **Поддержка сброса паролей для пользователей, применяющих [синхронизацию хэшей паролей.](./connect/active-directory-aadconnectsync-implement-password-synchronization.md)** Если служба сброса паролей обнаруживает, что для синхронизированной учетной записи пользователя включена синхронизация хэшей паролей, то локальный и облачный пароли для этой учетной записи сбрасываются одновременно.
* **Поддержка изменения паролей с панели доступа и Office 365.** При изменении просроченных или непросроченных паролей федеративными пользователями или пользователями с синхронизацией паролей эти пароли будут записываться обратно в локальную среду AD.
* **Поддержка обратной записи паролей при их сбросе администратором на портале Azure.** Каждый раз, когда администратор сбрасывает пароль пользователя на [портале Azure](https://portal.azure.com), если этот пользователь является федеративным или для него включена синхронизация паролей, выбранный администратором пароль также будет устанавливаться в локальной службе AD. В настоящее время это не поддерживается на портале администрирования Office.
* **Принудительное применение политики паролей локальной службы AD.** Когда пользователь сбрасывает свой пароль, перед его фиксацией в соответствующем каталоге выполняется проверка соблюдения политики локальной службы AD. Это включает журнал, сложность, срок пользования, фильтры паролей и любые другие ограничения паролей, заданные в локальной службе AD.
* **Отсутствие входящих правил брандмауэра.** Обратная запись паролей использует ретранслятор служебной шины Azure в качестве базового канала связи. Это означает, что для работы этой функции вам не нужно открывать какие-либо входящие порты в брандмауэре.
* **Отсутствие поддержки для учетных записей пользователей, существующих в защищенных группах в локальной службе Active Directory.** Дополнительные сведения о защищенных группах см. в статье [Приложение c. защищенных учетных записей и групп в Active Directory](https://technet.microsoft.com/library/dn535499.aspx).

## <a name="how-password-writeback-works"></a>Как работает обратная запись паролей

При сбросе или смене пароля в облаке федеративным пользователем или пользователем с синхронизацией хэшей происходит следующее:

1. Проверяется установленный у пользователя тип пароля.
    * Если мы видим, что паролем управляют локально:
        * Мы проверяем, работает ли служба обратной записи. Если она работает, мы разрешаем пользователю продолжить.
        * Если служба обратной записи не включена, пользователю сообщается о том, что сейчас невозможно сбросить пароль.
2. Затем пользователь проходит соответствующие шлюзы проверки подлинности и достигает экрана сброса пароля.
3. Пользователь выбирает новый пароль и подтверждает его.
4. После нажатия кнопки «Отправить» указанный в виде простого текста пароль шифруется с помощью симметричного ключа, который был создан в процессе установки обратной записи.
5. После шифрования пароля он включается в полезные данные, которые передаются по каналу HTTPS на ретранслятор служебной шины для определенного клиента (который был также настроен в процессе установки обратной записи). Этот ретранслятор защищается случайно генерируемым паролем, который известен только локальной установленной системе.
6. После того как сообщение достигает служебной шины, конечная точка сброса пароля автоматически активируется и обнаруживает ожидающий запрос на сброс.
7. Затем служба выполняет поиск нужного пользователя с помощью атрибута привязки облака. Для успешного поиска:

    * Объект пользователя должен существовать в пространстве соединителя AD.
    * Объект пользователя должен быть связан с соответствующим объектом MV.
    * Объект пользователя должен быть связан с соответствующим объектом соединителя AAD.
    * В ссылке из объекта соединителя AD на MV должно быть правило синхронизации `Microsoft.InfromADUserAccountEnabled.xxx`. <br> <br>
    При вызове из облака обработчик синхронизации использует атрибут cloudAnchor для поиска объекта пространства соединителя AAD, затем возвращается по ссылке к объекту MV, после чего возвращается по ссылке к объекту AD. Так как для одного и того же пользователя может быть несколько объектов AD (несколько лесов), обработчик синхронизации полагается на ссылку `Microsoft.InfromADUserAccountEnabled.xxx` для выбора нужного из них.

    > [!Note]
    > В результате этой логики Azure AD Connect должен иметь возможность связаться с эмулятором основного контроллера домена, чтобы компонент обратной записи паролей работал. Если необходимо включить эту возможность вручную, вы можете подключить Azure AD Connect к эмулятору основного контроллера домена. Для этого щелкните правой кнопкой мыши **Свойства** для соединителя синхронизации Active Directory, а затем выберите **Configure directory partitions** (Настройка разделов каталога). Здесь найдите раздел **Параметры подключения контроллера домена** и установите флажок **Использовать только предпочитаемые контроллеры домена**. Если предпочитаемый контроллер домена не является эмулятором основного контроллера домена, Azure AD Connect все равно попытается подключиться к основному контроллеру домена для обратной записи паролей.

8. После нахождения учетной записи пользователя предпринимается попытка сброса пароля непосредственно в соответствующем лесу AD.
9. Если операция установки пароля прошла успешно, пользователь уведомляется о том, что его пароль изменен.
    > [!NOTE]
    > Если пароль пользователя синхронизирован с Azure AD с помощью синхронизации паролей, есть вероятность, что локальная политика паролей не такая строгая, как облачная. В этом случае мы применяем локальную политику, используя синхронизацию хэша паролей. Благодаря этому ваша локальная политика применяется в облаке независимо от того, обеспечиваете ли вы единый вход с помощью синхронизации паролей или федерации.

10. В случае сбоя операции установки пароля пользователю возвращается ошибка и предлагается повторить попытку.
    * Сбой может произойти по следующим причинам:
        * Служба была недоступна.
        * Выбранный пароль не соответствует политикам организации.
        * Не удалось найти пользователя в локальной среде AD.

    Для многих из таких случаем имеется конкретное сообщение, позволяющее указать пользователю на возможности для устранения проблемы.

## <a name="configuring-password-writeback"></a>Настройка компонента обратной записи паролей

Мы советуем использовать функцию автоматического обновления [Azure AD Connect](./connect/active-directory-aadconnect-get-started-express.md), если вы хотите использовать компонент обратной записи паролей.

DirSync и Azure AD Sync больше не поддерживаются для включения компонента обратной записи паролей. Статья [Обновление Windows Azure Active Directory Sync и Azure Active Directory Sync](connect/active-directory-aadconnect-dirsync-deprecated.md) содержит дополнительные сведения, которые помогут при переходе.

В инструкциях ниже предполагается, что вы уже настроили Azure AD Connect в своей среде с помощью [экспресс](./connect/active-directory-aadconnect-get-started-express.md) или [пользовательских](./connect/active-directory-aadconnect-get-started-custom.md) параметров.

1. Чтобы настроить и включить компонент обратной записи паролей, войдите на сервер Azure AD Connect и запустите мастер настройки **Azure AD Connect**.
2. На экране приветствия щелкните **Настроить**.
3. На экране "Дополнительные задачи" щелкните **Настроить параметры синхронизации** и нажмите кнопку **Далее**.
4. На экране "Подключение к Azure AD" введите учетные данные глобального администратора и нажмите кнопку **Далее**.
5. На экранах "Подключить каталоги" и "Фильтрация доменов и подразделений" можно нажать кнопку **Далее**.
6. На экране "Дополнительные компоненты" установите флажок рядом с параметром **Обратная запись паролей** и нажмите кнопку **Далее**.
   ![Включение обратной записи паролей в Azure AD Connect][Writeback]
7. На экране "Готово к настройке" щелкните **Настроить** и дождитесь завершения процесса.
8. При появлении экрана "Конфигурация завершена" можно нажать кнопку **Выйти**.

## <a name="licensing-requirements-for-password-writeback"></a>Требования к лицензированию для обратной записи паролей

Сведения о лицензировании см. в разделе [Лицензии, необходимые для компонента обратной записи паролей](active-directory-passwords-licensing.md#licenses-required-for-password-writeback) или на следующих сайтах:

* [Сайт с ценами на Azure Active Directory](https://azure.microsoft.com/pricing/details/active-directory/).
* [Enterprise Mobility + Security](https://www.microsoft.com/cloud-platform/enterprise-mobility-security).
* [Secure Productive Enterprise](https://www.microsoft.com/secure-productive-enterprise/default.aspx).

### <a name="on-premises-authentication-modes-supported-for-password-writeback"></a>Локальные режимы проверки подлинности, поддерживаемые компонентом обратной записи паролей

Компонент обратной записи паролей работает со следующими типами паролей пользователей:

* **Пользователи облака.** В этом случае обратная запись паролей не применяется, так как локальный пароль отсутствует.
* **Пользователи с синхронизацией паролей.** Компонент обратной записи паролей поддерживается.
* **Федеративные пользователи.** Компонент обратной записи паролей поддерживается.
* **Пользователи со сквозной проверкой подлинности.** Компонент обратной записи паролей поддерживается.

### <a name="user-and-admin-operations-supported-for-password-writeback"></a>Операции администрирования и операции пользователя, поддерживаемые компонентом обратной записи паролей

Обратная запись паролей осуществляется во всех следующих ситуациях:

* **Поддерживаемые операции конечных пользователей:**
  * все самостоятельные добровольные операции изменения пароля конечного пользователя;
  * все самостоятельные принудительные операции изменения пароля конечного пользователя (например, из-за окончания срока действия пароля);
  * все самостоятельные операции сброса пароля конечного пользователя, выполняемые на [портале сброса паролей](https://passwordreset.microsoftonline.com).
* **Поддерживаемые операции администрирования:**
  * все самостоятельные добровольные операции изменения пароля администратора;
  * все самостоятельные принудительные операции изменения пароля администратора (например, из-за окончания срока действия пароля);
  * все самостоятельные операции сброса пароля администратора, выполняемые на [портале сброса паролей](https://passwordreset.microsoftonline.com);
  * все операции сброса пароля конечного пользователя, инициируемые администратором на [классическом портале Azure](https://manage.windowsazure.com);
  * все операции сброса пароля конечного пользователя, инициируемые администратором на [портале Azure](https://portal.azure.com).

### <a name="user-and-admin-operations-not-supported-for-password-writeback"></a>Операции администрирования и операции пользователя, не поддерживаемые компонентом обратной записи паролей

Обратная запись паролей **не осуществляется** во всех следующих ситуациях:

* **Неподдерживаемые операции конечных пользователей:**
  * Все операции сброса пароля конечного пользователя с помощью PowerShell V1 (V2) или API Graph Azure AD.
* **Неподдерживаемые операции администрирования:**
  * все операции сброса пароля конечного пользователя, инициируемые администратором на [портале управления Azure Office](https://portal.office.com);
  * все операции сброса пароля конечного пользователя, инициируемые администратором с помощью PowerShell V1 (V2) или API Graph Azure AD.

Хотя мы и работаем над устранением этих ограничений, но точное время пока указать не можем.

## <a name="password-writeback-security-model"></a>Модель безопасности обратной записи паролей

Обратная запись паролей — это служба с высоким уровнем безопасности.  Для защиты информации мы реализуем четырехуровневую модель безопасности, описанную ниже.

* **Ретранслятор служебной шины для определенного клиента**
  * При настройке службы настраивается ретранслятор служебной шины для определенного клиента, который защищается случайно генерируемым надежным паролем. У Майкрософт нет доступа к этому паролю.
* **Заблокированный криптографически надежный ключ шифрования пароля**
  * После создания ретранслятора служебной шины создается надежный симметричный ключ, который используется для шифрования пароля при передаче по сети. Этот ключ существует только в секретном хранилище компании, в облаке, которое тщательно блокируется и контролируется, подобно любому паролю в каталоге.
* **TLS отраслевого стандарта**
  1. При выполнении сброса или изменения пароля в облаке мы берем пароль в виде простого текста и шифруем его, используя ваш открытый ключ.
  2. Затем он вставляется в сообщение HTTPS, которое передается по зашифрованному каналу с использованием сертификатов SSL корпорации Майкрософт на ваш ретранслятор служебной шины.
  3. После поступления сообщения в служебную шину ваш локальный агент активируется и проходит проверку подлинности в служебной шине с использованием ранее созданного надежного пароля.
  4. Локальный агент забирает зашифрованное сообщение и расшифровывает его с помощью созданного закрытого ключа.
  5. Затем локальный агент пытается установить пароль через интерфейс AD DS SetPassword API.
     * Именно этот этап позволяет нам принудительно применять политику паролей вашей локальной службы AD (сложность, срок пользования, историю, фильтры и т. д.) в облаке.
* **Политики срока действия сообщений** 
  * Если по какой-либо причине сообщение задержится в служебной шине из-за неработающей локальной службы, срок его ожидания истечет и оно будет удалено через несколько минут для дополнительного повышения безопасности.

### <a name="password-writeback-encryption-details"></a>Сведения о шифровании компонента обратной записи паролей

Ниже описаны этапы шифрования, выполняемые после отправки запроса на сброс пароля перед его поступлением в локальную среду. Шифрование обеспечивает максимальную надежность и защиту службы.

* **Этап 1. Шифрование пароля с использованием 2048-разрядного ключа RSA.** Когда пользователь отправляет пароль для обратной записи в локальную среду, сначала этот пароль шифруется с использованием 2048-разрядного ключа RSA.
* **Этап 2. Шифрование на уровне пакета с использованием алгоритма AES-GCM.** Далее весь пакет (пароль и необходимые метаданные) шифруется с использованием алгоритма AES-GCM. За счет этого пользователи с прямым доступом к базовому каналу служебной шины не могут просматривать и изменять содержимое.
* **Этап 3. Взаимодействие через канал SSL/TLS.** Весь обмен данными со служебной шиной осуществляется через канал SSL/TLS. Это позволяет защитить содержимое от несанкционированного стороннего доступа.
* **Автоматическая смена ключей каждые 6 месяцев.** Автоматически каждые 6 месяцев или каждый раз после отключения и повторного включения компонента обратной записи паролей в Azure AD Connect мы выполняем смену этих ключей, чтобы обеспечить максимальную защиту службы.

### <a name="password-writeback-bandwidth-usage"></a>Использование пропускной способности компонента обратной записи паролей

Компонент обратной записи паролей — это служба с низкой пропускной способностью, которая отправляет запросы в локальный агент только при следующих условиях:

1. Два сообщения отправляются при включении или отключении компонента с помощью Azure AD Connect.
2. Одно сообщение отправляется каждые 5 минут как сигнал пульса службы, если служба запущена.
3. Два сообщения отправляются при каждой отправке нового пароля.
    * Первое сообщение отправляется как запрос на выполнение операции.
    * Второе сообщение содержит результат этой операции и отправляется в следующих случаях:
        * Во время каждой отправки нового пароля при самостоятельном сбросе пароля пользователем.
        * Во время каждой отправки нового пароля в ходе операции по смене пароля пользователя.
        * Во время каждой отправки нового пароля при сбросе пароля, инициированном администратором (только на портале администрирования Azure).

#### <a name="message-size-and-bandwidth-considerations"></a>Рекомендации по размеру сообщений и пропускной способности

Размер каждого сообщения обычно не превышает 1 КБ. Даже при экстремальных нагрузках служба обратной записи паролей будет потреблять несколько килобит в секунду. Каждое сообщение отправляется в режиме реального времени, только если этого требует операция обновления пароля. Размер сообщения настолько небольшой, что потребляемая компонентом обратной записи пропускная способность будет слишком незначительна, чтобы оказывать заметное влияние.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о сбросе пароля с помощью Azure AD см. в следующих источниках:

* [**Быстрое начало работы с самостоятельным сбросом пароля в Azure AD**](active-directory-passwords-getting-started.md). Запуск и выполнение службы самостоятельного управления паролями Azure AD. 
* [**Licensing requirements for Azure AD self-service password reset**](active-directory-passwords-licensing.md) (Требования к лицензированию самостоятельного сброса пароля в Azure AD). Сведения о настройке лицензирования Azure AD.
* [**Deploy password reset without requiring end-user registration**](active-directory-passwords-data.md) (Развертывание сброса пароля без регистрации пользователя). Сведения о необходимых данных и их использовании для управления паролями.
* [**Развертывание компонентов управления паролями и обучение пользователей их использованию**](active-directory-passwords-best-practices.md). Рекомендации по планированию и развертыванию SSPR для пользователей.
* [**Настройка компонентов управления паролями в соответствии с требованиями организации**](active-directory-passwords-customize.md). Сведения о настройке интерфейса и параметров использования SSPR для организации.
* [**Политики и ограничения для паролей в Azure Active Directory**](active-directory-passwords-policy.md). Общие сведения и информация об установке политик паролей Azure AD.
* [**Reporting options for Azure AD password management**](active-directory-passwords-reporting.md) (Параметры отчетов для управления паролями Azure AD). Определяйте, кто и когда использовал функцию SSPR.
* [**Как работает управление паролями в Azure Active Directory**](active-directory-passwords-how-it-works.md). Сведения о принципе работы управления паролями.
* [**Вопросы и ответы об управлении паролями**](active-directory-passwords-faq.md). Как? Почему? Что? Где? Кто? Когда? Здесь приведены ответы на интересующие вас вопросы.
* [**Устранение неполадок, связанных с управлением паролями**](active-directory-passwords-troubleshoot.md). Сведения об устранении распространенных проблем с SSPR.

[Writeback]: ./media/active-directory-passwords-writeback/enablepasswordwriteback.png "Включение обратной записи паролей в Azure AD Connect"
