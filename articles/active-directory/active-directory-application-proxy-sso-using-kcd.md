<properties
	pageTitle="Единый вход с помощью прокси приложения | Microsoft Azure"
	description="Описывает, как реализовать единый вход с помощью прокси приложения Azure AD."
	services="active-directory"
	documentationCenter=""
	authors="kgremban"
	manager="stevenpo"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="10/19/2015"
	ms.author="kgremban"/>



# Единый вход с помощью прокси приложения
Единый вход — это ключевой элемент прокси приложения Azure AD. Он обеспечивает оптимальную работу пользователей: пользователь выполняет вход в облако, где и выполняются все проверки безопасности (предварительная проверка подлинности), после чего при отправке запроса в локальное приложение соединитель прокси приложения олицетворяет этого пользователя, поэтому внутреннее приложение считает, что это обычный пользователь, который работает с устройства, присоединенного к домену. [](.media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_diagram.png) Прокси приложения Azure AD позволяет реализовать единый вход для пользователей. Для публикации приложений с помощью единого входа руководствуйтесь следующими инструкциями:


- Единый вход для локальных приложений IWA с использованием ограниченного делегирования Kerberos с прокси приложения
- Единый вход для приложений не на базе Windows
- Работа с единым входом при совпадении локальных и облачных удостоверений

## Единый вход для локальных приложений IWA с использованием ограниченного делегирования Kerberos с прокси приложения
Для приложений с использованием встроенной проверки подлинности Windows (IWA) можно активировать единый вход (SSO), разрешив соединителям прокси приложения олицетворять пользователей, а также отправлять и получать маркеры от их имени в Active Directory.

> [AZURE.IMPORTANT]Прокси приложения — это функция, которая доступна только после обновления до выпуска Premium или Basic службы Azure Active Directory. Дополнительные сведения см. в статье [Выпуски Azure Active Directory](active-directory-editions.md).


### Схема сети

![Схема проверки подлинности Microsoft Azure AD](./media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png)

На схеме показан процесс, когда пользователь пытается получить доступ к локальному приложению, использующему IWA. В общих чертах процесс выглядит так:

1. Пользователь вводит URL-адрес для доступа к локальному приложению через прокси приложения.
2. Прокси приложения перенаправляет запрос в службы проверки подлинности Azure AD, чтобы выполнить предварительную проверку подлинности. На этом этапе Azure AD применяет все применимые политики проверки подлинности и авторизации, например многофакторную проверку подлинности. Если пользователь проверен, Azure AD создает маркер и отправляет его пользователю.
3. Пользователь передает маркер в прокси приложения.
4. Прокси приложения проверяет маркер и извлекает из него имя участника-пользователя, затем отправляет запрос, имя участника-пользователя и имя субъекта-службы в соединитель через безопасный канал с двойной проверкой подлинности.
5. Соединитель выполняет согласование ограниченного делегирования Kerberos с локальной службой AD, олицетворяя пользователя, чтобы получить маркер Kerberos для приложения.
6. Active Directory отправляет маркер Kerberos для приложения соединителю.
7. Соединитель отправляет исходный запрос на сервер приложений, используя маркер Kerberos, полученный от AD.
8. Приложение отправляет соединителю ответ, который затем возвращается службе прокси приложения и, наконец, пользователю.

### Предварительные требования

1. Убедитесь, что для приложений, например веб-приложений SharePoint, настроено использование встроенной проверки подлинности Windows. Дополнительные сведения см. в статье [Включение поддержки проверки подлинности Kerberos](https://technet.microsoft.com/library/dd759186.aspx) или (для SharePoint) в статье [Планирование проверки подлинности Kerberos в SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).
2. Создайте имена субъектов-служб для своих приложений.
3. Убедитесь, что сервер, на котором работает соединитель, и сервер, на котором выполняется публикуемое приложение, присоединены к домену и являются частью одного и того же домена. Дополнительные сведения о присоединении к домену см. в разделе [Присоединение компьютера к домену](https://technet.microsoft.com/library/dd807102.aspx).


### Настройка в Active Directory

Действия по настройке в Active Directory зависят от того, находятся ли соединитель прокси приложения и опубликованный сервер в одном и том же домене.

#### Соединитель и опубликованный сервер в одном и том же домене



1. В Active Directory выберите **Средства** > **Пользователи и компьютеры**.
2. Выберите сервер, на котором работает соединитель.
3. Щелкните правой кнопкой мыши и выберите пункты **Свойства** > **Делегирование**.
4. Выберите **Доверять компьютеру делегирование указанных служб** и в разделе **Службы, с которыми эта учетная запись может использовать делегированные учетные данные** добавьте значение для идентификации имени субъекта-службы сервера приложений.
5. После этого соединитель прокси приложения будет олицетворять пользователей в AD при работе с приложениями, указанными в списке.

![Окно свойств соединителя SVR (снимок экрана)](./media/active-directory-application-proxy-sso-using-kcd/Properties.jpg)

#### Соединитель и опубликованный сервер в разных доменах

1. Список предварительных требований для работы с ограниченным делегированием Kerberos в разных доменах см. в статье [Ограниченное делегирование Kerberos в разных доменах](https://technet.microsoft.com/library/hh831477.aspx).
2. В Windows 2012 R2 используйте свойство `principalsallowedtodelegateto` сервера соединителя, чтобы включить делегирование прокси приложения для сервера соединителя, где `sharepointserviceaccount` — опубликованный сервер, а `connectormachineaccount` — делегирующий.

		$connector= Get-ADComputer -Identity connectormachineaccount -server dc.connectordomain.com

		Set-ADComputer -Identity sharepointserviceaccount -PrincipalsAllowedToDelegateToAccount $connector

		Get-ADComputer sharepointserviceaccount -Properties PrincipalsAllowedToDelegateToAccount


>[AZURE.NOTE]`sharepointserviceaccount` может быть учетной записью компьютера SPS или учетной записью службы, под которой выполняется пул приложений SPS.


### Настройка на портале Azure

1. Опубликуйте приложение в соответствии с инструкциями, описанными в статье [Публикация приложений с помощью прокси приложения](active-directory-application-proxy-publish.md). Обязательно выберите **Azure Active Directory** в качестве **метода предварительной проверки подлинности**.
2. Когда приложение появится в списке приложений, выберите его и нажмите кнопку **Настроить**.
3. В разделе **Свойства** в качестве **метода внутренней проверки подлинности** выберите **интегрированную проверку подлинности Windows**.<br>![Дополнительная настройка приложения](./media/active-directory-application-proxy-sso-using-kcd/cwap_auth2.png)

4. Введите **Внутреннее имя субъекта-службы приложения** сервера приложений. В этом примере таким именем для опубликованного приложения будет http/lob.contoso.com.

>[AZURE.IMPORTANT]Имена участников-пользователей в Azure Active Directory должны быть идентичны соответствующим именам в вашей локальной службе Active Directory. Это необходимо для предварительной проверки подлинности. Убедитесь, что служба Azure Active Directory синхронизирована с локальной службой Active Directory.

| | |
| --- | --- |
| Метод внутренней проверки подлинности | Если вы используете Azure AD для предварительной проверки подлинности, можно настроить метод внутренней проверки подлинности, чтобы предоставить пользователям преимущество единого входа в это приложение. <br><br> Выберите значение **Встроенная проверка подлинности Windows** (IWA), если ваше приложение использует этот метод, и настройте ограниченное делегирование Kerberos (KCD), чтобы включить единый вход для этого приложения. Приложения, использующие IWA, следует настроить с использованием ограниченного делегирования Kerberos. В противном случае прокси приложения не сможет опубликовать эти приложения. <br><br> Выберите **Нет**, если ваше приложение не использует IWA. |
| Внутреннее имя субъекта-службы приложения | Это имя субъекта-службы внутреннего приложения, настроенное в локальной службе Azure AD. При помощи имени субъекта-службы соединитель прокси приложения получает маркеры Kerberos для приложения, использующего ограниченное делегирование Kerberos. |

<!--Image references-->
[1]: ./media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png
[2]: ./media/active-directory-application-proxy-sso-using-kcd/Properties.jpg


## Единый вход для приложений не на базе Windows
Поток делегирования Kerberos в прокси приложения Azure AD запускается, когда Azure AD проверяет подлинность пользователя в облаке. После поступления запроса в локальную среду соединитель прокси приложения Azure AD выдает билет Kerberos от имени пользователя посредством взаимодействия с локальным Active Directory. Этот процесс называется ограниченным делегированием Kerberos (KCD). На следующем этапе запрос отправляется во внутреннее приложение с этим билетом Kerberos. Существует несколько протоколов, определяющих процедуру отправки таких запросов. Большинство серверов не на базе Windows ожидают механизм Negotiate/SPNego, который теперь поддерживается в прокси приложения Azure AD.<br>![](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_nonwindows_diagram.png)

### Частично делегированное удостоверение
Приложения не на базе Windows обычно получают удостоверение пользователя в форме имени пользователя или имени учетной записи SAM, а не в форме адреса электронной почты (username@domain). Это отличает их от большинства систем под управлением Windows, предпочитающих использовать имя участника-пользователя, которое более информативно и гарантирует отсутствие дубликатов в разных доменах. По этой причине прокси приложения позволяет выбрать удостоверение, отображаемое в билете Kerberos, отдельно для каждого приложения. Некоторые из этих параметров подходят для систем, не поддерживающих значения в формате адреса электронной почты.<br>![](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_upn.png) Если используется частичное удостоверение, которое может не быть уникальным для всех доменов или лесов в организации, может потребоваться опубликовать такие приложения дважды с использованием двух разных групп соединителей; поскольку каждое приложение имеет собственную аудиторию, его соединители можно присоединить к другому домену.


## Работа с единым входом при совпадении локальных и облачных удостоверений
Если в параметрах не указано иначе, прокси приложения предполагает, что пользователи имеют одно и то же удостоверение как в облаке, так и в локальной среде. Для каждого приложения можно настроить, какое именно удостоверение следует использовать при выполнении единого входа. Эта возможность позволяет многим организациям, имеющим различные локальные и облачные удостоверения, реализовать единый вход из облака в локальные приложения, не требующий от пользователей ввода различных имен пользователя и паролей. Сюда относятся следующие виды организаций:


- организации, имеющие несколько внутренних доменов (joe@us.contoso.com, joe@eu.contoso.com) и отдельный домен в облаке (joe@contoso.com));


- организации, у которых внутреннее доменное имя не поддерживает маршрутизацию (joe@contoso.usa), а допустимое доменное имя относится к облаку;


- организации, которые не используют внутренние доменные имена (joe);


- организации, использующие разные псевдонимы в локальной и облачной средах. Например, joe-johns@contoso.com и joej@contoso.com. Она также поможет организовать работу с приложениями, которые не принимают адреса в формате адреса электронной почты, что является очень распространенным сценарием для внутренних серверов не на базе Windows.
### Настройка единого входа для различных облачных и локальных удостоверений
1. Настройте параметры Azure AD Connect так, чтобы основным удостоверением был адрес электронной почты (почта). Это осуществляется во время процесса настройки путем изменения поля «Имя субъекта-пользователя» в параметрах синхронизации.<br>![](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_connect_settings.png) Примечание. Эти параметры также определяют, как именно пользователи входят в Office 365, на устройства Windows 10 и в другие приложения, использующие Azure AD в качестве хранилища их удостоверений.
2. В параметрах конфигурации приложения для приложения, которое вы хотите изменить, выберите нужное значение параметра **Делегированное удостоверение для входа**:


- Имя субъекта-пользователя: joe@contoso.com


- Альтернативное имя субъекта-пользователя: joed@contoso.local


- Компонент, содержащий имя пользователя, в имени субъекта-пользователя: joe


- Компонент, содержащий имя пользователя, в альтернативном имени субъекта-пользователя: joed


- Имя локальной учетной записи управления лицензиями: в зависимости от локальной конфигурации контроллера домена ![](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_upn.png)

### Устранение неполадок единого входа для различных удостоверений
При возникновении ошибки в процессе единого входа она заносится в журнал событий компьютера соединителя, как описано в разделе [Устранение неполадок](active-directory-application-proxy-troubleshoot.md). Однако в некоторых случаях запрос успешно отправляется внутреннему приложению, пока оно обрабатывает разные другие HTTP-ответы. Устранение подобных неполадок следует начать с проверки события с номером 24029 на компьютере соединителя в журнале событий сеанса прокси приложения. Удостоверение пользователя, которое использовалось для делегирования, будет отображаться в поле "пользователь" в сведениях о событии (в приведенном ниже примере это "joe@contoso55.com"). Чтобы включить журнал сеанса, выберите **Отобразить аналитический и отладочный журналы** в меню "Вид" средства просмотра событий.







## См. также
У прокси приложения гораздо больше возможностей:


- [Опубликуйте приложения с помощью прокси-сервера приложений.](active-directory-application-proxy-publish.md)
- [Публикация приложений с помощью доменного имени](active-directory-application-proxy-custom-domains.md)
- [Включение условного доступа](active-directory-application-proxy-conditional-access.md)
- [Работа с приложениями, поддерживающими утверждения](active-directory-application-proxy-claims-aware-apps.md)
- [Устранение неполадок с прокси приложения](active-directory-application-proxy-troubleshoot.md)

## Узнайте больше о прокси приложения
- [Просмотрите нашу справку в Интернете](active-directory-application-proxy-enable.md)
- [Ознакомьтесь с блогом о прокси приложения](http://blogs.technet.com/b/applicationproxyblog/)
- [Смотрите наши видео на Channel 9!](http://channel9.msdn.com/events/Ignite/2015/BRK3864)

<!---HONumber=AcomDC_1125_2015-->