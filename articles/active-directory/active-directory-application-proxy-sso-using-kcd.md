---
title: "Единый вход с помощью прокси приложения | Документация Майкрософт"
description: "Статья описывает, как реализовать единый вход с помощью прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
editor: 
ms.assetid: ded0d9c9-45f6-47d7-bd0f-3f7fd99ab621
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/10/2016
ms.author: kgremban
translationtype: Human Translation
ms.sourcegitcommit: 219dcbfdca145bedb570eb9ef747ee00cc0342eb
ms.openlocfilehash: 74c932301fdeb0956933dd23a331efa3d36a24a1


---
# <a name="single-sign-on-with-application-proxy"></a>Единый вход с помощью прокси приложения
Единый вход — это ключевой элемент прокси приложения Azure AD. Он предоставляет собой удобный пользовательский интерфейс с набором следующих действий.

1. Пользователь входит в облако.  
2. Все проверки безопасности происходят в облаке (предварительная проверка подлинности)  
3. Если запрос отправляется в приложение в локальной среде, соединитель прокси-службы приложения олицетворяет пользователя. Серверная часть приложения полагает, что это обычный пользователь, который вошел в приложение с устройства, присоединенного к домену.

![Схема доступа от конечного пользователя и корпоративной сети через прокси приложения](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_diagram.png)

Прокси приложения Azure AD позволяет реализовать единый вход для пользователей. Для публикации приложений с помощью единого входа руководствуйтесь следующими инструкциями:

## <a name="sso-for-on-prem-iwa-apps-using-kcd-with-application-proxy"></a>Единый вход для локальных приложений IWA с использованием ограниченного делегирования Kerberos с прокси приложения
Для приложений с использованием встроенной проверки подлинности Windows (IWA) можно активировать единый вход (SSO), разрешив соединителям прокси приложения олицетворять пользователей, а также отправлять и получать токены от их имени в Active Directory.

### <a name="network-diagram"></a>Схема сети
На схеме показан процесс, когда пользователь пытается получить доступ к локальному приложению, использующему IWA.

![Схема проверки подлинности Microsoft Azure AD](./media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png)

1. Пользователь вводит URL-адрес для доступа к локальному приложению через прокси приложения.
2. Прокси приложения перенаправляет запрос в службы проверки подлинности Azure AD, чтобы выполнить предварительную проверку подлинности. На этом этапе Azure AD применяет все применимые политики проверки подлинности и авторизации, например многофакторную проверку подлинности. Если пользователь проверен, Azure AD создает токен и отправляет его пользователю.
3. Пользователь передает токен в прокси приложения.
4. Прокси приложения проверяет токен и извлекает из него имя участника-пользователя, затем отправляет запрос, имя участника-пользователя и имя субъекта-службы в соединитель через безопасный канал с двойной проверкой подлинности.
5. Соединитель выполняет согласование ограниченного делегирования Kerberos с локальной службой AD, олицетворяя пользователя, чтобы получить токен Kerberos для приложения.
6. Active Directory отправляет токен Kerberos для приложения соединителю.
7. Соединитель отправляет исходный запрос на сервер приложений, используя токен Kerberos, полученный от AD.
8. Приложение отправляет соединителю ответ, который затем возвращается службе прокси приложения и, наконец, пользователю.

### <a name="prerequisites"></a>Предварительные требования
Прежде чем использовать единый вход для прокси приложений, подготовьте в своей среде следующие параметры и конфигурации.

* Настройте свои приложения, например веб-приложения SharePoint, на использование встроенной проверки подлинности Windows. Дополнительные сведения см. в статье [Включение поддержки проверки подлинности Kerberos](https://technet.microsoft.com/library/dd759186.aspx) или (для SharePoint) в статье [Планирование проверки подлинности Kerberos в SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).
* Все приложения должны иметь имена субъектов-служб.
* Сервер, на котором работает соединитель, и сервер, на котором работает приложение, должны быть присоединены к домену и должны быть частью одного и того же домена или доверенных доменов. Дополнительные сведения о присоединении к домену см. в разделе [Присоединение компьютера к домену](https://technet.microsoft.com/library/dd807102.aspx).
* Сервер, на котором работает соединитель, должен иметь доступ на чтение TokenGroupsGlobalAndUniversal для пользователей. Это стандартная настройка, которая может измениться в случае укрепления системы безопасности среды. Дополнительную информацию см. в статье базы знаний [KB2009157](https://support.microsoft.com/en-us/kb/2009157).

### <a name="active-directory-configuration"></a>Настройка в Active Directory
Действия по настройке в Active Directory зависят от того, находятся ли соединитель прокси приложения и опубликованный сервер в одном и том же домене.

#### <a name="connector-and-published-server-in-the-same-domain"></a>Соединитель и опубликованный сервер в одном и том же домене
1. В Active Directory выберите **Средства** > **Пользователи и компьютеры**.
2. Выберите сервер, на котором работает соединитель.
3. Щелкните его правой кнопкой мыши и выберите **Свойства** > **Делегирование**.
4. Выберите **Доверять компьютеру делегирование указанных служб**, затем в разделе **Службы, с которыми эта учетная запись может использовать делегированные учетные данные** добавьте значение для идентификации имени субъекта-службы сервера приложений.
5. После этого соединитель прокси приложения будет олицетворять пользователей в AD при работе с приложениями, указанными в списке.

![Окно свойств соединителя SVR (снимок экрана)](./media/active-directory-application-proxy-sso-using-kcd/Properties.jpg)

#### <a name="connector-and-published-server-in-different-domains"></a>Соединитель и опубликованный сервер в разных доменах
1. Список предварительных требований для работы с ограниченным делегированием Kerberos в разных доменах см. в статье [Ограниченное делегирование Kerberos в разных доменах](https://technet.microsoft.com/library/hh831477.aspx).
2. В Windows 2012 R2 используйте свойство `principalsallowedtodelegateto` сервера соединителя, чтобы включить делегирование прокси приложения для сервера соединителя, где опубликованным сервером является `sharepointserviceaccount`, а делегирующим сервером — `connectormachineaccount`.
   
        $connector= Get-ADComputer -Identity connectormachineaccount -server dc.connectordomain.com
   
        Set-ADComputer -Identity sharepointserviceaccount -PrincipalsAllowedToDelegateToAccount $connector
   
        Get-ADComputer sharepointserviceaccount -Properties PrincipalsAllowedToDelegateToAccount

> [!NOTE]
> `sharepointserviceaccount` может быть учетной записью компьютера SPS или учетной записью службы, под которой выполняется пул приложений SPS.
> 
> 

### <a name="azure-classic-portal-configuration"></a>Настройка на классическом портале Azure
1. Опубликуйте приложение в соответствии с инструкциями, описанными в статье [Публикация приложений с помощью прокси приложения](active-directory-application-proxy-publish.md). Обязательно выберите значение **Azure Active Directory** для параметра **Метод предварительной проверки подлинности**.
2. Когда приложение появится в списке приложений, выберите его и нажмите кнопку **Настроить**.
3. В разделе **Свойства** для параметра **Метод внутренней проверки подлинности** выберите значение **Интегрированная проверка подлинности Windows**.  
   ![Дополнительная настройка приложения](./media/active-directory-application-proxy-sso-using-kcd/cwap_auth2.png)  
4. Введите **Внутреннее имя субъекта-службы приложения** сервера приложений. В этом примере таким именем для опубликованного приложения будет http/lob.contoso.com.  

> [!IMPORTANT]
> Если ваш локальный UPN и UPN в Azure Active Directory не совпадают, необходимо настроить [делегированную идентификацию для входа](#delegated-login-identity) для правильной работы предварительной проверки подлинности.
> 
> 

|  |  |
| --- | --- |
| Метод внутренней проверки подлинности |Если вы используете Azure AD для предварительной проверки подлинности, можно настроить метод внутренней проверки подлинности, чтобы предоставить пользователям преимущество единого входа в это приложение. <br><br> Выберите значение **Интегрированная проверка подлинности Windows** (IWA), если ваше приложение использует этот метод, и настройте ограниченное делегирование Kerberos (KCD), чтобы включить единый вход для этого приложения. Приложения, использующие IWA, следует настроить с использованием ограниченного делегирования Kerberos. В противном случае прокси приложения не сможет опубликовать эти приложения. <br><br> Выберите **Нет**, если ваше приложение не использует IWA. |
| Внутреннее имя субъекта-службы приложения |Это имя субъекта-службы внутреннего приложения, настроенное в локальной службе Azure AD. При помощи имени субъекта-службы соединитель прокси приложения получает токены Kerberos для приложения, использующего ограниченное делегирование Kerberos. |

## <a name="sso-for-non-windows-apps"></a>Единый вход для приложений не на базе Windows
Поток делегирования Kerberos в прокси приложения Azure AD запускается, когда Azure AD проверяет подлинность пользователя в облаке. После поступления запроса в локальную среду соединитель прокси приложения Azure AD выдает билет Kerberos от имени пользователя посредством взаимодействия с локальным Active Directory. Этот процесс называется ограниченным делегированием Kerberos (KCD). На следующем этапе запрос отправляется во внутреннее приложение с этим билетом Kerberos. Существует несколько протоколов, определяющих процедуру отправки таких запросов. Большинство серверов не на базе Windows ожидают механизм Negotiate/SPNego, который теперь поддерживается в прокси приложения Azure AD.

![Схема единого входа (не Windows)](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_nonwindows_diagram.png)

### <a name="delegated-login-identity"></a>делегированную идентификацию для входа
Делегированная идентификация для входа позволяет обработать два сценария входа.

* Приложения не на базе Windows, которые обычно получают удостоверение пользователя в форме имени пользователя или имени учетной записи SAM, а не в форме адреса электронной почты (username@domain).
* Альтернативные конфигурации входа при различных UPN в Azure AD и UPN в локальной Active Directory.

С помощью прокси приложения можно выбрать удостоверение для получения билета Kerberos. Этот параметр устанавливается в каждом отдельном приложении. Некоторые из этих параметров подходят для систем, не поддерживающих значения в формате адреса электронной почты, другие предназначены для альтернативного входа в систему.

![Снимок экрана параметра "Делегированное удостоверение для входа"](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_upn.png)

При использовании делегированной идентификации для входа значение может не быть уникальным для всех доменов или лесов вашей организации. Этой проблемы можно избежать, опубликовав приложения дважды с использованием двух разных групп соединителей. Поскольку каждое приложение имеет собственную аудиторию, его соединители можно присоединить к другому домену.

## <a name="working-with-sso-when-on-premises-and-cloud-identities-are-not-identical"></a>Работа с единым входом при совпадении локальных и облачных удостоверений
Если в параметрах не указано иначе, прокси приложения предполагает, что пользователи имеют одно и то же удостоверение как в облаке, так и в локальной среде. Для каждого приложения можно настроить, какое именно удостоверение следует использовать при выполнении единого входа.  

Эта возможность позволяет многим организациям, имеющим различные локальные и облачные удостоверения, реализовать единый вход из облака в локальные приложения, не требующий от пользователей ввода различных имен пользователя и паролей. Сюда относятся следующие виды организаций:

* организации, имеющие несколько внутренних доменов ((joe@us.contoso.com,, joe@eu.contoso.com)) и отдельный домен в облаке ((joe@contoso.com).);
* организации, у которых внутреннее доменное имя не поддерживает маршрутизацию ((joe@contoso.usa)), а допустимое доменное имя относится к облаку;
* организации, которые не используют внутренние доменные имена (joe);
* организации, использующие разные псевдонимы в локальной и облачной средах. Например:  joe-johns@contoso.com и joej@contoso.com  

Она также поможет организовать работу с приложениями, которые не принимают адреса в формате адреса электронной почты, что является очень распространенным сценарием для внутренних серверов не на базе Windows.

### <a name="setting-sso-for-different-cloud-and-on-prem-identities"></a>Настройка единого входа для различных облачных и локальных удостоверений
1. Настройте параметры Azure AD Connect так, чтобы основным удостоверением был адрес электронной почты (почта). Это осуществляется во время процесса настройки путем изменения поля **Имя субъекта-пользователя** в параметрах синхронизации. Эти параметры также определяют, как именно пользователи входят в Office 365, на устройства Windows 10 и в другие приложения, использующие Azure AD в качестве хранилища своих удостоверений.  
   ![Снимок экрана "Идентификация пользователей": раскрывающееся меню "Имя участника-пользователя"](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_connect_settings.png)  
2. В параметрах конфигурации приложения для приложения, которое вы хотите изменить, выберите нужное значение параметра **Делегированное удостоверение для входа** :
   
   * Имя субъекта-пользователя: joe@contoso.com  
   * Альтернативное имя субъекта-пользователя: joed@contoso.local  
   * Компонент, содержащий имя пользователя, в имени субъекта-пользователя: joe  
   * Компонент, содержащий имя пользователя, в альтернативном имени субъекта-пользователя: joed  
   * Имя локальной учетной записи управления лицензиями: в зависимости от локальной конфигурации контроллера домена
   
   ![Снимок экрана с раскрывающимся меню "Делегированное удостоверение для входа"](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_upn.png)  

### <a name="troubleshooting-sso-for-different-identities"></a>Устранение неполадок единого входа для различных удостоверений
При возникновении ошибки в процессе единого входа она заносится в журнал событий компьютера соединителя, как описано в разделе [Устранение неполадок](active-directory-application-proxy-troubleshoot.md).
Однако в некоторых случаях запрос успешно отправляется внутреннему приложению, пока оно обрабатывает разные другие HTTP-ответы. Устранение подобных неполадок следует начать с проверки события с номером 24029 на компьютере соединителя в журнале событий сеанса прокси приложения. Удостоверение пользователя, которое использовалось для делегирования, будет отображаться в поле "пользователь" в сведениях о событии. Чтобы включить журнал сеанса, выберите пункт **Отобразить аналитический и отладочный журналы** в меню "Вид" средства просмотра событий.

## <a name="see-also"></a>Дополнительные материалы
* [Опубликуйте приложения с помощью прокси-сервера приложений.](active-directory-application-proxy-publish.md)
* [Устранение неполадок с прокси приложения](active-directory-application-proxy-troubleshoot.md)
* [Работа с приложениями, поддерживающими утверждения](active-directory-application-proxy-claims-aware-apps.md)
* [Включение условного доступа](active-directory-application-proxy-conditional-access.md)

Последние новости и обновления см. в [блоге, посвященном прокси приложения](http://blogs.technet.com/b/applicationproxyblog/).

<!--Image references-->
[1]: ./media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png
[2]: ./media/active-directory-application-proxy-sso-using-kcd/Properties.jpg



<!--HONumber=Nov16_HO3-->


