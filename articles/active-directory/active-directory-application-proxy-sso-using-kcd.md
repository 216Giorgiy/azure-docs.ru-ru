<properties
	pageTitle="Единый вход для локальных приложений IWA с использованием ограниченного делегирования Kerberos с прокси приложения"
	description="Описывается, как настроить и запустить прокси приложения Azure AD."
	services="active-directory"
	documentationCenter=""
	authors="rkarlin"
	manager="msStevenPo"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/09/2015"
	ms.author="rkarlin"/>



# Единый вход для локальных приложений IWA с использованием ограниченного делегирования Kerberos с прокси приложения


Для приложений с использованием встроенной проверки подлинности Windows (IWA) можно активировать единый вход (SSO), разрешив соединителям прокси приложения олицетворять пользователей, а также отправлять и получать маркеры от их имени в Active Directory.

> [AZURE.IMPORTANT]Прокси приложения — это функция, которая доступна только после обновления до выпуска Premium или Basic службы Azure Active Directory. Дополнительные сведения см. в статье [Выпуски Azure Active Directory](active-directory-editions.md).


## Схема сети

![Схема проверки подлинности Microsoft Azure AD](./media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png)

На схеме показан процесс, когда пользователь пытается получить доступ к локальному приложению, использующему IWA. В общих чертах процесс выглядит так:

1. Пользователь вводит URL-адрес для доступа к локальному приложению через прокси приложения.
2. Прокси приложения перенаправляет запрос в службы проверки подлинности Azure AD, чтобы выполнить предварительную проверку подлинности. На этом этапе Azure AD применяет все применимые политики проверки подлинности и авторизации, например многофакторную проверку подлинности. Если пользователь проверен, Azure AD создает маркер и отправляет его пользователю.
3. Пользователь передает маркер в прокси приложения.
4. Прокси приложения проверяет маркер и извлекает из него имя участника-пользователя, затем отправляет запрос, имя участника-пользователя и имя субъекта-службы в соединитель через безопасный канал с двойной проверкой подлинности.
5. Соединитель выполняет согласование ограниченного делегирования Kerberos с локальной службой AD, олицетворяя пользователя, чтобы получить маркер Kerberos для приложения.
6. Active Directory отправляет маркер Kerberos для приложения соединителю.
7. Соединитель отправляет исходный запрос на сервер приложений, используя маркер Kerberos, полученный от AD.
8. Приложение отправляет соединителю ответ, который затем возвращается службе прокси приложения и, наконец, пользователю.

### Предварительные требования

1. Убедитесь, что для приложений, например веб-приложений SharePoint, настроено использование встроенной проверки подлинности Windows. Дополнительные сведения см. в статье [Включение поддержки проверки подлинности Kerberos](https://technet.microsoft.com/library/dd759186.aspx) или (для SharePoint) в статье [Планирование проверки подлинности Kerberos в SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).
2. Создайте имена субъектов-служб для своих приложений.
3. Убедитесь, что сервер, на котором работает соединитель, и сервер, на котором выполняется публикуемое приложение, присоединены к домену и являются частью одного и того же домена. Дополнительные сведения о присоединении к домену см. в разделе [Присоединение компьютера к домену](https://technet.microsoft.com/library/dd807102.aspx).


## Настройка в Active Directory

Действия по настройке в Active Directory зависят от того, находятся ли соединитель прокси приложения и опубликованный сервер в одном и том же домене.

### Соединитель и опубликованный сервер в одном и том же домене



1. В Active Directory выберите **Средства** > **Пользователи и компьютеры**. 
2. Выберите сервер, на котором работает соединитель. 
3. Щелкните правой кнопкой мыши и выберите пункты **Свойства** > **Делегирование**. 
4. Выберите **Доверять компьютеру делегирование указанных служб** и в разделе **Службы, с которыми эта учетная запись может использовать делегированные учетные данные** добавьте значение для идентификации имени субъекта-службы сервера приложений. 
5. После этого соединитель прокси приложения будет олицетворять пользователей в AD при работе с приложениями, указанными в списке.

![Окно свойств соединителя SVR (снимок экрана)](./media/active-directory-application-proxy-sso-using-kcd/Properties.jpg)

### Соединитель и опубликованный сервер в разных доменах

1. Список предварительных требований для работы с ограниченным делегированием Kerberos в разных доменах см. в статье [Ограниченное делегирование Kerberos в разных доменах](https://technet.microsoft.com/library/hh831477.aspx).
2. В Windows 2012 R2 используйте свойство `principalsallowedtodelegateto` сервера соединителя, чтобы включить делегирование прокси приложения для сервера соединителя, где `sharepointserviceaccount` — опубликованный сервер, а `connectormachineaccount` — делегирующий.

		$connector= Get-ADComputer -Identity connectormachineaccount -server dc.connectordomain.com

		Set-ADComputer -Identity sharepointserviceaccount -PrincipalsAllowedToDelegateToAccount $connector

		Get-ADComputer sharepointserviceaccount -Properties PrincipalsAllowedToDelegateToAccount


>[AZURE.NOTE]`sharepointserviceaccount` может быть учетной записью компьютера SPS или учетной записью службы, под которой выполняется пул приложений SPS.


## Настройка на портале Azure

1. Опубликуйте приложение в соответствии с инструкциями, описанными в статье [Публикация приложений с помощью прокси-сервера приложения](active-directory-application-proxy-publish.md). Обязательно выберите **Azure Active Directory** в качестве **метода предварительной проверки подлинности**.
2. Когда приложение появится в списке приложений, выберите его и нажмите кнопку **Настроить**.
3. В разделе **Свойства** в качестве **метода внутренней проверки подлинности** выберите **интегрированную проверку подлинности Windows**.

![Дополнительная настройка приложения](./media/active-directory-application-proxy-sso-using-kcd/cwap_auth2.png)

4. Введите **Внутреннее имя субъекта-службы приложения** сервера приложений. В этом примере таким именем для опубликованного приложения будет http/lob.contoso.com.

>[AZURE.IMPORTANT]Имена участников-пользователей в Azure Active Directory должны быть идентичны соответствующим именам в вашей локальной службе Active Directory. Это необходимо для предварительной проверки подлинности. Убедитесь, что служба Azure Active Directory синхронизирована с локальной службой Active Directory.

| | |
| --- | --- |
| Метод внутренней проверки подлинности | Если вы используете Azure AD для предварительной проверки подлинности, можно настроить метод внутренней проверки подлинности, чтобы предоставить пользователям преимущество единого входа в это приложение. <br><br> Выберите значение **Встроенная проверка подлинности Windows** (IWA), если ваше приложение использует этот метод, и настройте ограниченное делегирование Kerberos (KCD), чтобы включить единый вход для этого приложения. Приложения, использующие IWA, следует настроить с использованием ограниченного делегирования Kerberos. В противном случае прокси приложения не сможет опубликовать эти приложения. <br><br> Выберите **Нет**, если ваше приложение не использует IWA. |
| Внутреннее имя субъекта-службы приложения | Это имя субъекта-службы внутреннего приложения, настроенное в локальной службе Azure AD. При помощи имени субъекта-службы соединитель прокси приложения получает маркеры Kerberos для приложения, использующего ограниченное делегирование Kerberos. |

<!--Image references-->
[1]: ./media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png
[2]: ./media/active-directory-application-proxy-sso-using-kcd/Properties.jpg

<!---HONumber=Sept15_HO3-->