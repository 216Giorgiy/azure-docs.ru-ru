---
title: "Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD | Документация Майкрософт"
description: "Основные сведения о соединителях прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/12/2017
ms.author: kgremban
translationtype: Human Translation
ms.sourcegitcommit: 8436238546515b66b58b31673d54586e4a20f50f
ms.openlocfilehash: 86f10c04368d1c382939b418c6909ca807b3bf5a


---

# <a name="enable-remote-access-to-sharepoint-with-azure-ad-app-proxy"></a>Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD

В этой статье описывается интеграция локального сервера SharePoint с прокси приложения Azure AD.

> [!NOTE]
> Прокси приложения — это функция, которая доступна только после обновления до выпуска Premium или Basic службы Azure Active Directory. Дополнительные сведения см. в разделе [Выпуски Azure Active Directory](active-directory-editions.md).
> 

##<a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что в вашей среде уже настроена и запущена SharePoint 2013 или более поздней версии. Кроме того, необходимо выполнить следующие предварительные требования.

* SharePoint имеет встроенную поддержку Kerberos. Поэтому можно предположить, что пользователи, которые получают удаленный доступ к внутренним сайтам через прокси приложения Azure AD, пользуются преимуществами простого единого входа.

* Вам понадобится внести некоторые изменения в конфигурацию на сервере SharePoint. Мы рекомендуем использовать промежуточную среду. Так вы сначала внесете изменения на промежуточном сервере, что упростит цикл тестирования при переходе на рабочую среду.

* Мы предполагаем, что вы уже настроили SSL для SharePoint, так как он требуется для опубликованного URL-адреса. Вам потребуется включить SSL на внутреннем сайте, чтобы обеспечить надлежащую отправку и сопоставление ссылок. Если вы еще не настроили SSL, см. инструкции по настройке SSL для SharePoint 2013 в [этой записи блога](https://blogs.msdn.microsoft.com/fabdulwahab/2013/01/20/configure-ssl-for-sharepoint-2013). Кроме того, убедитесь, что соединитель компьютера доверяет выдаваемому сертификату. (Это необязательно должен быть открыто выданный сертификат.)

##<a name="steps-to-set-up-sharepoint"></a>Действия по настройке SharePoint

Следуйте приведенным ниже шагам, чтобы настроить удаленный доступ к SharePoint с помощью прокси приложения Azure AD.

**Часть 1. Настройка единого входа**

  * Шаг А. Проверка того, что сервер SharePoint запущен с использованием учетной записи службы.
  * Шаг Б. Настройка SharePoint для Kerberos.
  * Шаг В. Задание имени субъекта-службы для учетной записи, назначенной SharePoint.
  * Этап Г. Настройка доверенного соединителя для делегирования для SharePoint.

**Часть 2. Настройка безопасного удаленного доступа**

 * Опубликуйте ферму SharePoint для прокси приложения Azure AD.

**Часть 3. Настройка сопоставлений, чтобы SharePoint знала о внешнем URL-адресе**

 * Задайте сопоставления альтернативного доступа в SharePoint.

### <a name="part-1-set-up-single-sign-on-sso-to-sharepoint"></a>Часть 1. Настройка единого входа для SharePoint

Наши клиенты хотят обеспечить простую процедуру единого входа для серверных приложений (в нашем случае для сервера SharePoint). В этом распространенном сценарии Azure AD пользователь будет проходить проверку подлинности только один раз. Последующих запросов на аутентификацию не будет.

Для локальных приложений, требующих или использующих проверку подлинности Windows, это можно обеспечить с помощью протокола проверки подлинности Kerberos и функции, называемой ограниченным делегированием Kerberos (KCD). Если эта функция настроена, она позволяет соединителю прокси приложения получить билет и маркер Windows для конкретного пользователя, даже если тот не выполнил вход в Windows напрямую. Дополнительные сведения об ограниченном делегировании Kerberos см. в [этой статье](https://technet.microsoft.com/en-us/library/jj553400.aspx).

Инструкции по настройке этой функции для сервера SharePoint приведены ниже.

**Шаг А. Проверка того, что сервер SharePoint запущен с использованием учетной записи службы, а не учетной записи локальной системы, локальной службы или сетевой службы**

В первую очередь следует убедиться в том, что SharePoint работает от имени определенной учетной записи службы. Это нужно сделать, чтобы мы могли присоединить имена субъектов-служб к действительной учетной записи. Kerberos идентифицирует различные службы по этим именам. Они также потребуются позже, чтобы настроить ограниченное делегирование Kerberos.

Чтобы убедиться, что сайты запущены с использованием определенной учетной записи службы, сделайте следующее:

1. Откройте сайт **центра администрирования SharePoint 2013**.
2. Щелкните **Безопасность** и выберите **Настройка учетных записей служб**.
3. Выберите **Пул веб-приложений — SharePoint — 80**. Параметры могут немного отличаться в зависимости от имени пула веб-приложений или при использовании SSL по умолчанию.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-service-web-application.png)

4. Если в разделе **Выберите учетную запись для этого компонента** выбран вариант **Локальная служба** или **Сетевая служба**, необходимо создать учетную запись. В противном случае все готово, и вы можете переходить к следующему шагу. 
5. Выберите **Регистрация новой управляемой учетной записи**. Как только учетная запись будет создана, прежде чем ее использовать, необходимо задать **пул веб-приложений**.

> [!NOTE]
Вам потребуется заранее создать учетную запись AD для службы. Мы рекомендуем настроить автоматическую смену паролей. Описание полной процедуры и сведения по устранению неполадок см. в статье [Настройка автоматической смены паролей в SharePoint 2013](https://technet.microsoft.com/EN-US/library/ff724280.aspx). 

**Шаг Б. Настройка SharePoint для Kerberos**

Мы используем ограниченное делегирование Kerberos для выполнения единого входа на сервер SharePoint. Это работает только с использованием Kerberos. 

Чтобы настроить сайт SharePoint для проверки подлинности Kerberos:

1. Откройте сайт **центра администрирования SharePoint 2013**.
2. Щелкните **Управление приложениями**, выберите **Управление веб-приложениями**, а затем — свой сайт SharePoint. В нашем примере выберите **SharePoint — 80**.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-manage-web-applications.png)
  
3. На панели инструментов щелкните **Поставщики проверки подлинности**.
4. В окне **Поставщики проверки подлинности** щелкните **Default Zone** (Зона по умолчанию), чтобы просмотреть параметры.
5. В окне **Изменение параметров проверки подлинности** прокрутите вниз до раздела **Типы проверки подлинности на основе утверждений** и установите флажки **Включить проверку подлинности Windows** и **Встроенная проверка подлинности Windows**. 
6. В раскрывающемся списке выберите **Согласование (Kerberos)**.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-service-edit-authentication.png)

7. В самом низу окна **Изменение параметров проверки подлинности** нажмите кнопку **Сохранить**.

**Шаг В. Задание имени субъекта-службы для учетной записи службы SharePoint**

Прежде чем настраивать ограниченное делегирование Kerberos, необходимо определить службу SharePoint, запущенную в качестве учетной записи службы, настроенной ранее. Для этого нужно задать имя субъекта-службы. Дополнительные сведения об именах субъектов-служб см. в [этом разделе](https://technet.microsoft.com/en-us/library/cc961723.aspx).

Имя субъекта-службы выглядит следующим образом:

```
<service class>/<host>:<port>
```

_service class_ — это уникальное имя службы. Для SharePoint используется HTTP.

_host_ — это полное доменное имя или NetBIOS-имя узла, на котором запущена служба. В случае с сайтом SharePoint это может быть URL-адрес сайта в зависимости от используемой версии IIS.

_port_ указывать необязательно. Полное доменное имя сервера SharePoint может выглядеть так:

```
sharepoint.demo.o365identity.us
```

В таком случае имя субъекта-службы будет иметь следующий вид: 

```
HTTP/ sharepoint.demo.o365identity.us demo
```

Кроме того, может потребоваться задать имена субъектов-служб для определенных сайтов на сервере. Дополнительные сведения см. в статье [Настройка проверки подлинности Kerberos (Office SharePoint Server)](https://technet.microsoft.com/en-us/library/cc263449(v=office.12).aspx). Уделите особое внимание разделу "Создание имен участников служб для веб-приложений, использующих проверку подлинности Kerberos". 

Самый простой способ сделать это — использовать имена субъектов-служб, которые уже существуют для вашего сайта. Скопируйте эти имена субъектов-служб для регистрации в учетной записи службы. Для этого:

1. Перейдите к сайту с другого компьютера, используя имя субъекта-службы. 
 При этом соответствующий набор билетов Kerberos кэшируется на этом компьютере. Эти билеты содержат имя субъекта-службы целевого сайта, на который вы перешли. Мы можем извлечь имя субъекта-службы этого сайта, используя средство [Klist](http://web.mit.edu/kerberos/krb5-devel/doc/user/user_commands/klist.html).
 
2. В командном окне, запущенном в том же контексте, что и пользователь, который перешел на сайт в браузере, выполните следующую команду: 
```
Klist
```
3. В результате будет возвращен набор имен субъектов-служб целевой службы. В этом примере выделено необходимое нам имя субъекта-службы.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-target-service.png)
  
4. Теперь, когда у вас есть имя субъекта-службы, его необходимо правильно настроить для учетной записи службы, заданной для веб-приложения ранее. Инструкции описаны ниже.

**Задание имени субъекта-службы**

Чтобы задать имя субъекта-службы, выполните указанную ниже команду из командной строки с правами администратора домена.

```
setspn -S http/sharepoint.demo.o365identity.us demo\sp_svc
```

Эта команда задает имя субъекта-службы для учетной записи службы SharePoint _demo\sp_svc_.

Обязательно замените _http/sharepoint.demo.o365identity.us_ именем субъекта-службы для сервера, а _demo\sp_svc_ — учетной записью службы в вашей среде. Команда setspn выполнит поиск имени субъекта-службы, прежде чем его добавить. В этом случае может появиться ошибка **повторяющегося значения имени субъекта-службы**. Если вы видите эту ошибку, убедитесь, что это значение связано с нужной учетной записью службы.

Чтобы убедиться, что имя субъекта-службы добавлено, выполните команду setspn с параметром -l. Дополнительные сведения о средстве Setspn см. в [этой статье](https://technet.microsoft.com/en-us/library/cc731241.aspx).

**Этап Г. Настройка доверенных соединителей для делегирования пользователей для SharePoint**

На этом шаге вы настроите ограниченное делегирование Kerberos, чтобы служба прокси приложения Azure AD могла делегировать удостоверения пользователей для службы SharePoint. Для этого мы настроим для соединителя прокси приложения возможность получать билеты Kerberos для пользователей, которые прошли проверку подлинности в Azure AD. Затем этот сервер передает контекст в целевое приложение (SharePoint в нашем случае). 

Чтобы настроить ограниченное делегирование Kerberos, выполните следующие действия для каждого компьютера соединителя:

1. Войдите в контроллер домена от имени администратора домена, а затем перейдите к **Active Directory Users and Computers** (Пользователи и компьютеры Active Directory).
2. Найдите компьютер, на котором запущен соединитель. В этом примере это тот же сервер SharePoint.
3. Дважды щелкните имя компьютера, а затем перейдите на вкладку **Delegation** (Делегирование).
4. Установите переключатель **Trust this computer for delegation to the specified services only** (Доверять этому компьютеру для делегирования только указанным службам), а затем — **Use any authentication protocol** (Использовать любой протокол проверки подлинности).

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-delegation-box.png)
  
5. Теперь необходимо добавить имя субъекта-службы, созданное ранее для учетной записи службы. Нажмите кнопку **Add** (Добавить), а затем — **Users or Computers** (Пользователи и компьютеры) и найдите учетную запись, созданную ранее.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-users-computers.png)

 Вы увидите список имен субъектов-служб. Необходимо добавить имя субъекта-службы, заданное ранее. 
6. Выберите его и нажмите кнопку **ОК**. Нажмите кнопку **ОК** еще раз, чтобы сохранить изменения.

### <a name="part-2-enable-remote-access-to-sharepoint"></a>Часть 2. Настройка удаленного доступа к SharePoint

Теперь, когда вы настроили SharePoint для Kerberos и функцию KCD, можно приступать к настройке единого входа для SharePoint. Затем из этого соединителя можно опубликовать SharePoint для удаленного доступа через прокси приложения Azure AD.

**Публикация SharePoint с помощью прокси приложения Azure AD**

Чтобы выполнить действия ниже, необходимо быть участником роли глобального администратора в рамках учетной записи Azure Active Directory вашей организации.

1. Войдите на портал управления Azure (https://manage.windowsazure.com) и найдите свой клиент Azure AD.
2. Щелкните **Приложения**, а затем — **Добавить**.
3. Выберите **Публикация приложения, которое будет доступно за пределами вашей сети**. Если этот параметр не отображается, убедитесь, что в этом клиенте используется Azure AD уровня "Базовый" или "Премиум".
4. В появившемся окне укажите следующие параметры. 
 * **Имя:** любое значение, например _SharePoint_.
 * **Внутренний URL-адрес:** это URL-адрес внутреннего сайта SharePoint, например https://SharePoint/. Обязательно используйте https.
 * **Pre-authentication Method** (Метод предварительной проверки подлинности): выберите _Azure Active Directory_.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-add-application.png)

5. После публикации приложения перейдите на вкладку **Настройка**.
6. Прокрутите к параметру **Перевод веб-страниц в заголовках**. Значение по умолчанию — _Да_. Установите значение _Нет_. 

 SharePoint использует значение _заголовка узла_ для поиска сайта, а также создает ссылки на его основе. Таким образом, любая ссылка, которую создает SharePoint, представляет собой опубликованный URL-адрес, правильно настроенный для использования внешнего URL-адреса. Если выбрать значение _Да_, соединитель будет перенаправлять запрос к серверному приложению. Однако, если выбрать значение _Нет_, соединитель не будет отправлять имя внутреннего узла и вместо этого будет отправлять заголовок узла в качестве опубликованного URL-адреса в серверное приложение.

 Кроме того, чтобы SharePoint принимал этот URL-адрес, необходимо выполнить еще одну настойку на сервере SharePoint. Она описана в следующем разделе.

7. Задайте для параметра **Метод внутренней проверки подлинности** значение _Встроенная проверка подлинности Windows_. Если клиент Azure AD использует различные имена участников-пользователей в облачной и локальной средах, обновите также параметр **Делегированная идентификация для входа**.
8. Задайте для параметра **Внутреннее имя субъекта-службы приложения** значение, заданное ранее. Например, _http/sharepoint.demo.o365identity.us_.
9. Теперь вы можете назначить приложение целевым пользователям.

Приложение должно выглядеть следующим образом:

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-internal-application-spn.png)

###<a name="part-3-ensure-sharepoint-knows-about-the-external-url"></a>Часть 3. Настройка сопоставлений, чтобы SharePoint знала о внешнем URL-адресе

Последний шаг — сделать так, чтобы SharePoint могла найти сайт по внешнему URL-адресу, а также могла обрабатывать ссылки на основе этого адреса. Для этого необходимо настроить сопоставления альтернативного доступа для SharePoint.

**Настройка альтернативного имени для сайта SharePoint**

1. Откройте сайт **центра администрирования SharePoint 2013**.
2. В разделе **Параметры системы** выберите **Настройка сопоставлений альтернативного доступа**. 

 Откроется окно **Сопоставления для альтернативного доступа**.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-alternate-access1.png)

3. В раскрывающемся списке рядом с надписью **Alternative Access Mapping Collections** (Коллекции сопоставлений альтернативного доступа) выберите **Change Alternative Access Mapping Collection** (Изменить коллекцию сопоставлений альтернативного доступа).
4. Выберите сайт, например **SharePoint — 80**.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-alternate-access2.png)

5. Вы можете добавить опубликованный URL-адрес как внутренний URL-адрес или общедоступный URL-адрес. В этом примере используется **общедоступный URL-адрес** в пределах экстрасети.
6. Щелкните **Изменить общедоступные URL-адреса** в пути **экстрасети**, а затем введите путь публикации приложения, как в предыдущем действии. Например, _https://sharepoint-iddemo.msappproxy.net_.

  ![Соединители прокси приложения Azure AD](./media/application-proxy-remote-sharepoint/remote-sharepoint-alternate-access3.png)

7. Щелкните **Сохранить**. 

 Теперь вы можете получать внешний доступ к сайту SharePoint через прокси приложения Azure AD.

##<a name="next-steps"></a>Дальнейшие действия

[Как обеспечить безопасный удаленный доступ к локальным приложениям](active-directory-application-proxy-get-started.md)<br>
[Сведения о соединителях прокси приложения Azure AD](application-proxy-understand-connectors.md)<br>
[Publishing SharePoint 2016 and Office Online Server with Azure AD Application Proxy](https://blogs.technet.microsoft.com/dawiese/2016/06/09/publishing-sharepoint-2016-and-office-online-server-with-azure-ad-application-proxy/) (Публикация SharePoint 2016 и Office Online Server с помощью прокси приложения Azure AD)









<!--HONumber=Feb17_HO1-->


