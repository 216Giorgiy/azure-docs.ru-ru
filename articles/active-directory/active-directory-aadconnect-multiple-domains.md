<properties
	pageTitle="Поддержка нескольких доменов в Azure AD Connect"
	description="В этом документе описываются процедуры установки и настройки нескольких доменов верхнего уровня в Office 365 и Azure AD."
	services="active-directory"
	documentationCenter=""
	authors="billmath"
	manager="stevenpo"
	editor="curtand"/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="12/02/2015"
	ms.author="billmath"/>

#Поддержка нескольких доменов

Многих пользователей интересует настройка нескольких доменов верхнего уровня и поддоменов в Office 365 или Azure AD с использованием федерации. Несмотря на то, что большая часть задач решается довольно простым и понятным способом в фоновом режиме, существует ряд советов и рекомендаций, которые полезно иметь в виду во избежание возникновения следующих проблем.

- Сообщения об ошибках при попытке настроить дополнительные домены для федерации.
- Пользователи в поддоменах не могут войти в систему после настройки нескольких доменов верхнего уровня для федерации.

## Несколько доменов верхнего уровня
Рассмотрим все это на примере настройки домена contoso.com в организации, где требуется дополнительный домен с именем fabrikam.com.

Предположим, что в локальной системе службы AD FS настроены с именем службы федерации fs.jenfield.com.

При регистрации для использования Office 365 или Azure AD было принято решение настроить contoso.com в качестве первого домена для входа. Это можно сделать в Azure AD Connect или Azure AD Powershell с помощью командлета New-MsolFederatedDomain.

После этого взглянем на значения по умолчанию для двух новых свойств конфигурации нового домена Azure AD (их можно запросить с помощью командлета Get-MsolDomainFederationSettings):

| Имя свойства | Значение | Описание|
| ----- | ----- | -----|
|IssuerURI | http://fs.jenfield.com/adfs/services/trust| Несмотря на внешнее сходство с URL-адресом, это свойство на самом деле является именем локальной системы проверки подлинности, поэтому не требуется разрешать путь во что-либо. По умолчанию Azure AD устанавливает для этого свойства значение идентификатора службы федерации в локальной конфигурации службы AD FS
|PassiveClientSignInUrl|https://fs.jenfield.com/adfs/ls/|This — это расположение, в которое будет отправлен запрос на пассивный вход. Оно разрешается в реальную систему AD FS. На самом деле существует несколько свойств "*URL", но мы просто рассмотрим один пример, чтобы увидеть разницу между этим свойством и URI, таким как IssuerURI.

Теперь представим, что добавляется второй домен fabrikam.com. Это можно сделать, запустив мастер Azure AD Connect еще раз или воспользовавшись PowerShell.

При попытке добавить второй домен в качестве федеративного с помощью Azure AD PowerShell возникнет ошибка.

Причина в том, что в Azure AD существует ограничение, при котором свойство IssuerURI не может иметь одно и то же значение для нескольких доменов. Чтобы преодолеть это ограничение, необходимо использовать другое значение свойства IssuerURI для нового домена. По сути, именно для этого используется параметр SupportMultipleDomain. При использовании с командлетами для настройки федерации (New-, Convert- и Update-MsolFederatedDomain) этот параметр позволяет Azure AD настраивать свойство IssuerURI на основе имени домена, которое должно быть уникальным среди клиентов в Azure AD, поэтому он сам должен быть уникальным. Кроме того, существует изменение в правилах утверждения, но о нем мы поговорим позднее.

Таким образом, если в Powershell добавить домен fabrikam.com с помощью параметра SupportMultipleDomain,

    PS C:\>New-MsolFederatedDomain -DomainName fabrikam.com –SupportMultipleDomain

в Azure AD будет доступна следующая конфигурация:

- DomainName: fabrikam.com
- IssuerURI: http://fabrikam.com/adfs/services/trust 
- PassiveClientSignInUrl: https://fs.jenfield.com/adfs/ls/ 

Обратите внимание, что хотя свойству IssuerURI было присвоено значение на основе домена, которое является уникальным, значения URL-адреса конечной точки по-прежнему настроены для указания на службу федерации в fs.jenfield.com так же, как и для исходного домена contoso.com. Поэтому все домены по-прежнему будет указывать на ту же систему AD FS.

Параметр SupportMultipleDomain используется и для решения другой задачи — он гарантирует, что система AD FS будет включать соответствующее значение элемента Issuer в маркеры, выпущенные для Azure AD. Для этого доменная часть UPN пользователей задается в качестве домена в свойстве issuerURI, т. е. https://{upnсуффикс}/служб и отношения доверия (suffix}/adfs/services/trust). Таким образом, во время проверки подлинности в Azure AD или Office 365 элемент Issuer в маркере пользователя используется для обнаружения домена в Azure AD. Если совпадение не найдено, проверка подлинности завершится ошибкой.

Например, если UPN пользователя имеет значение johndoe@fabrikam.com, элементу Issuer в маркере AD FS будет задано значение http://fabrikam.com/adfs/services/trust. Это будет соответствовать конфигурации Azure AD, и проверка подлинности пройдет успешно.

Ниже приведено настроенное правило утверждения, которое реализует эту логику.

    c:[Type == "http://schemas.xmlsoap.org/claims/UPN"] => issue(Type =   "http://schemas.microsoft.com/ws/2008/06/identity/claims/issuerid", Value = regexreplace(c.Value, ".+@(?<domain>.+)", "http://${domain}/adfs/services/trust/"));

В имеющейся настройке домен contoso.com сначала был зарегистрирован без параметра supportMultipleDomains и со значением по умолчанию свойства IssuerURI. При добавлении домена fabrikam.com необходимо убедиться, что домен contoso.com также настроен на использование параметра SupportMultipleDomain, так как обновление правила утверждения никогда больше не будет отправлять значение по умолчанию свойства IssuerURI и проверка подлинности будет завершаться ошибкой из-за несовпадения значений свойства IssuerURI. Однако не следует беспокоиться — мы предупредим вас об этом прежде, чем разрешим использовать параметр SupportMultipleDomain в другом домене.

Чтобы устранить эту проблему, необходимо также обновить конфигурацию домена contoso.com. Мастер Azure AD Connect является хорошим средством для определения необходимости выполнения упомянутых выше действий, а также для правильного добавления второго домена. Если на первом этапе вы уже открыли конфигурацию SupportMultipleDomain, она не будет перезаписана.

В PowerShell необходимо указать параметр SupportMultipleDomain вручную.

Ниже приведены подробные действия по переходу из одного домена в несколько доменов.

После этого мы получим конфигурацию для двух доменов в Azure AD:

- DomainName: contoso.com
- IssuerURI: http://contoso.com/adfs/services/trust 
- PassiveClientSignInUrl: https://fs.jenfield.com/adfs/ls/ 
- DomainName: fabrikam.com
- IssuerURI: http://fabrikam.com/adfs/services/trust 
- PassiveClientSignInUrl: https://fs.jenfield.com/adfs/ls/ 

Теперь для пользователей из доменов contoso.com и fabrikam.com будет работать федеративный вход. Осталась только одна проблема — вход для пользователей в поддоменах.

##Поддомены
Предположим, что подддомен sub.contoso.com добавляется в домен Azure AD. Из-за способа управления доменами в Azure AD этот поддомен унаследует параметры родительского домена. В данном случае это contoso.com. Это означает, что свойство IssuerURI для user@sub.contoso.com должно иметь значение http://contoso.com/adfs/services/trust. Однако реализованное выше стандартное правило для

Azure AD создаст маркер с издателем как http://sub.contoso.com/adfs/services/trust, что не соответствует требуемому значению домена, и проверка подлинности завершится ошибкой. К счастью, существует обходное решение этой проблемы, однако оно также не встроено в наши средства. Вам придется вручную обновить отношение доверия с проверяющей стороной AD FS для Microsoft Online.

Необходимо настроить пользовательское правило утверждения так, чтобы оно удаляло поддомены из суффикса UPN пользователя при создании настраиваемого значения элемента Issuer. Действия по выполнению этой задачи см. в приведенных ниже шагах.

Таким образом, у вас может быть несколько доменов с разными именами, а также поддоменов, объединенных в федерацию с одним сервером AD FS. Чтобы проверить правильность установки значений элемента Issuer для всех пользователей, потребуется выполнить лишь несколько дополнительных действий.

<!---HONumber=AcomDC_1203_2015-->