---
title: "Сведения о соединителях прокси приложения Azure AD | Документация Майкрософт"
description: "Основные сведения о соединителях прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/22/2017
ms.author: kgremban
translationtype: Human Translation
ms.sourcegitcommit: cea53acc33347b9e6178645f225770936788f807
ms.openlocfilehash: 41d6f678dba769cf7f949751da8cacf3df7f88c1
ms.lasthandoff: 03/03/2017


---

# <a name="understand-azure-ad-application-proxy-connectors"></a>Сведения о соединителях прокси приложения Azure AD

В этой статье обсуждаются соединители, являющиеся "секретным ингредиентом" прокси приложения Azure AD. Они просты в использовании, развертывании и обслуживании. К тому же они очень производительны.

> [!NOTE]
> Прокси приложения — это функция, которая доступна только после обновления до выпуска Premium или Basic службы Azure Active Directory. Дополнительные сведения см. в разделе [Выпуски Azure Active Directory](active-directory-editions.md).

## <a name="what-are-azure-ad-application-proxy-connectors"></a>Что собой представляют соединители прокси приложения Azure AD?
Для работы прокси приложения нужно установить в сети службу-соединитель Windows Server. Соединители можно устанавливать с учетом требований к высокому уровню доступности и масштабируемости. Сначала добавьте один соединитель и при необходимости добавляйте дополнительные. При установке соединитель добавляется в пул соединителей, обслуживающих клиент.

Мы не рекомендуем устанавливать соединители на серверах приложений, хотя это и возможно, особенно для небольших развертываний.

Не нужно удалять неиспользуемые соединители. Выполняясь, соединитель остается активным, так как подключается к службе. Неиспользуемые соединители помечаются как _неактивные_ и удаляются спустя 10 дней. 

Сведения о способах устранения неисправностей с подключением к Azure AD см. в [этой записи блога](https://blogs.technet.microsoft.com/applicationproxyblog/2015/03/24/how-to-troubleshoot-azure-ad-application-proxy-connectivity-problems). 

## <a name="what-are-the-cloud-rules-for-connectors"></a>Какие правила облака применяются к соединителям?
Соединители и служба отвечают за выполнение задач, связанных с высоким уровнем доступности. Их можно добавлять или удалять динамически. При поступлении новый запрос направляется одному из доступных соединителей. Если соединитель временно недоступен, он не будет реагировать на трафик.

Соединители не имеют состояний. На компьютере хранятся только такие данные конфигурации соединителей, как параметры подключения к службе и сертификат, на основе которого соединитель проходит проверку подлинности. При подключении к службе соединители извлекают все необходимые данные конфигурации и обновляют их каждые несколько минут.
Они также проводят опрос сервера, чтобы узнать, появилась ли более новая версия соединителя. Если такая версия будет найдена, соединители обновятся.

Соединители можно отслеживать с компьютера, на котором они выполняются (с помощью журнала событий и счетчиков производительности), или из облака (с помощью страницы состояния соединителя, как показано ниже).

 ![Соединители прокси приложения Azure AD](./media/application-proxy-understand-connectors/app-proxy-connectors.png)

## <a name="all-networking-is-outbound"></a>Все сетевые подключения исходящие
Соединители отправляют только исходящие запросы, поэтому подключение всегда инициируют соединители. Не нужно открывать входящие порты, так как после установления сеанса трафик будет передаваться в двустороннем режиме.

Исходящий трафик отправляется в службу прокси приложения и в опубликованные приложения. Трафик, отправляемый в службу, передается в центры данных Azure на несколько разных портов. Дополнительные сведения см. в статье [Включение прокси приложения на портале Azure](active-directory-application-proxy-enable.md).

При наличии только исходящего трафика не нужно устанавливать балансировку нагрузки между соединителями или настраивать доступ входящего трафика через брандмауэры.

Сведения о настройке правил исходящего трафика брандмауэра см. в статье [Работа с существующими локальными прокси-серверами](application-proxy-working-with-proxy-servers.md).

Воспользуйтесь [средством проверки портов соединителей прокси-службы приложения Azure AD](https://aadap-portcheck.connectorporttest.msappproxy.net/), чтобы проверить, сможет ли ваш соединитель подключиться к прокси-службе приложения. Как минимум следует убедиться, что для региона Central US (Центральная часть США) и ближайшего к вам региона отображаются все зеленые флажки. Учитывайте также, что большее число зеленых флажков означает большую устойчивость. 

## <a name="network-security"></a>Безопасность сети

Соединители можно устанавливать в любом месте в сети. Поэтому они могут отправлять запросы и к службе, и к внутренним приложениям. Они будут работать нормально, если установить их в корпоративной сети, в сети периметра или даже на виртуальной машине, работающей в облаке с доступом к приложениям.

Развертывание в сети периметра обычно выполняется сложнее. Одна из причин для развертывания соединителей в сети периметра — использование другой инфраструктуры, доступной для выполняющихся в ней компонентов, например подсистема балансировки нагрузки внутреннего приложения и/или средства управления безопасностью, такие как системы обнаружения атак.

## <a name="domain-joining"></a>Присоединение к домену

Соединители могут выполняться на компьютере, не присоединенном к домену. Тем не менее, если вы решили использовать функцию единого входа (SSO) для приложений, использующих встроенную проверку подлинности Windows (IWA), требуется компьютер, присоединенный к домену. 

В этом случае компьютеры соединителя должны быть присоединены к домену, который может выполнить ограниченное делегирование [Kerberos](https://web.mit.edu/kerberos) от имени соответствующих пользователей для опубликованных приложений.

Соединители можно также присоединить к доменам или лесам с частичным доверием или к контроллерам домена только для чтения.

## <a name="connectors-on-hardened-environments"></a>Соединители в средах с усиленной защитой

В большинстве случаев соединители можно очень легко развернуть и для этого не требуется дополнительная настройка. Однако следует учесть несколько уникальных условий:

* Организации, ограничивающие исходящий трафик, должны следовать приведенным здесь инструкциям, чтобы открыть необходимые порты.
* Для изменения конфигурации портов таким образом, чтобы служба соединителя, служба средства обновления соединителей и программа установки могли создать и сохранить сертификат на компьютере, понадобятся FIPS-совместимые компьютеры.
* Специалисты организаций, в которых среда блокируется на основе процессов, формирующих сетевые запросы, должны убедиться, что включены обе службы соединителей. Это нужно для доступа ко всем требуемым портам и IP-адресам.
* В некоторых случаях исходящие перенаправляющие прокси-серверы могут прервать двустороннюю проверку подлинности на основе сертификата и привести к сбою связи.

## <a name="all-connectors-are-created-almost-equal"></a>Все соединители создаются практически равными

Все соединители считаются идентичными. Каждый входящий запрос может поступить на любой из соединителей. Это означает, что все они должны быть подключены к одной сети и для всех них должны быть заданы одинаковые параметры [Kerberos](https://web.mit.edu/kerberos).

Безопасность обмена данными между соединителями и службой обеспечивает сертификат клиента, который выдается и устанавливается на компьютере соединителя. Дополнительные сведения об обновлении сертификатов соединителей см. в статье [Включение прокси приложения на портале Azure](active-directory-application-proxy-enable.md).

## <a name="connector-authentication"></a>Проверка подлинности соединителя

Чтобы предоставить безопасную службу, соединители должны пройти проверку подлинности в службе, а служба должна пройти проверку подлинности в соединителе. Такая проверка выполняется с использованием сертификатов клиента и службы, когда соединители инициируют подключение. Таким образом имя пользователя и пароль администратора не хранятся на компьютере соединителя.

Используемые сертификаты уникальны для службы прокси приложения. Они создаются во время первоначальной регистрации. Соединители автоматически обновляют их каждые несколько месяцев. 

Если соединитель несколько месяцев не подключается к службе, возможно, он содержит устаревшие сертификаты. В этом случае требуется регистрация. Поэтому нужно удалить и переустановить соединитель, чтобы активировать регистрацию. Вы можете выполнить следующие команды PowerShell:

```
* Import-module AppProxyPSModule
* Register-AppProxyConnector
```

## <a name="performance-and-scalability"></a>Производительность и масштабирование

Несмотря на то, что масштабирование веб-службы — прозрачный процесс, при работе с соединителями следует обратить на него внимание. Для обработки пикового трафика необходимо иметь достаточное количество соединителей. Так как соединители не имеют состояния, они не зависят от количества пользователей или сеансов. Зато они зависят от количества запросов и объема полезных данных в этих запросах. Стандартный компьютер обрабатывает несколько тысяч запросов стандартного веб-трафика в секунду. Этот показатель зависит от точных характеристик компьютера.

Производительность соединителя связана с ЦП и сетью. Производительность ЦП важна при SSL-шифровании и расшифровке, а сеть нужна, чтобы быстро подключаться к приложениям и веб-службе в Azure. Память, напротив, меньше всего важна для соединителей.

Мы стараемся максимально разгрузить соединители для службы соединителей. Интернет-служба занимается большинством операций обработки и отвечает за весь трафик, не прошедший проверку подлинности. Все, что можно сделать в облаке, осуществляется в облаке.

На производительность также влияет качество сетевого подключения между соединителями:

* _Веб-служба._ Медленное подключение или подключение с высокими задержками влияет на уровень обслуживания. Лучше всего в организации подключиться к Azure через Express Route. В противном случае убедитесь, что специалисты по обслуживанию сети обеспечивают самое эффективное подключение к Azure.

* _Внутренние приложения._ В некоторых случаях между соединителем и внутренним приложением установлены дополнительные прокси-серверы. Эту проблему очень просто устранить. Для этого на компьютере соединителя откройте браузер и получите доступ к этим приложениям. Если соединители запускаются в Azure, а приложения используются в локальной среде, условия работы пользователей могут отличаться от ожидаемых.
* _Контроллеры домена._ Если соединители выполняют ограниченное делегирование Kerberos с использованием единого входа, сначала они обращаются к контроллерам домена, а затем отправляют запрос к серверной части. Соединители содержат кэш билетов Kerberos, но в загруженных средах скорость реагирования контроллеров домена может замедлить процесс работы. Это более типично для соединителей, которые выполняются в Azure. При этом контроллеры домена находятся в локальной среде.

## <a name="automatic-updates-to-the-connector"></a>Автоматические обновление соединителей

Служба средства обновления соединителей позволяет выполнять обновление автоматически. Таким образом, вы можете постоянно использовать все новые функции, а также улучшения безопасности и производительности.

Azure AD поддерживает автоматические обновления всех развертываемых соединителей. Пока служба средства обновления соединителей прокси приложения работает, соединители будут обновляться автоматически без простоев и необходимости делать что-либо вручную. Если служба средства обновления соединителей не отображается на сервере, для получения обновлений необходимо переустановить соединитель. Дополнительные сведения об установке соединителей см. в [соответствующей документации](https://azure.microsoft.com/en-us/documentation/articles/active-directory-application-proxy-enable.md).

### <a name="updater-impact"></a>Влияние средства обновления

_Клиенты с одним соединителем._ Если установлен всего один соединитель, он будет обновляться в составе последней группы. Так как других соединителей для перенаправления трафика нет, служба будет недоступна во время обновления. Чтобы избежать этого простоя и обеспечить высокий уровень доступности гораздо проще, мы рекомендуем установить второй соединитель и создать группу соединителей. Дополнительные сведения об этом см. в [документации по группам соединителей](https://azure.microsoft.com/en-us/documentation/articlesactive-directory-application-proxy-connectors.md).

_Другие клиенты._ Во время обновления соединителя трафик перенаправляется на другие соединители, чтобы свести нарушение работы к минимуму. Тем не менее любые транзакции, выполняющиеся в момент начала обновления, могут быть прекращены. Браузер должен автоматически повторить выполнение операции, чтобы вы смогли увидеть такое возможное прекращение. В противном случае, чтобы обойти эту проблему, необходимо обновить страницу.

Мы знаем, что непросто выдержать даже минуту простоя. Однако эти обновления позволяют нам сделать соединители еще лучше и добавить многочисленные улучшения. Мы считаем, что это стоит того.

Дополнительные сведения об изменениях в последнем обновлении соединителя см. на странице [последнего обновления](https://azure.microsoft.com/en-us/updates/app-proxy-connector-12sept2016). Мы обновляем эту страницу с каждым обновлением.

## <a name="under-the-hood"></a>Как все устроено

В Azure представлено множество полезных инструментов. В частности соединители имеют много полезных функций. Так как соединители созданы на основе прокси-службы веб-приложения Windows Server, в них используются одни и те же средства управления, включая широкий набор журналов событий и счетчиков производительности Windows, как показано в службе "Просмотр событий":

 ![Служба "Просмотр событий" Azure AD](./media/application-proxy-understand-connectors/event-view-window.png)

И в мониторе производительности:

 ![Монитор производительности Azure AD](./media/application-proxy-understand-connectors/performance-monitor.png)

Для соединителей настроены журнал администратора и журнал сеансов. В журналах администратора регистрируются основные события и соответствующие ошибки. В журналах сеансов содержатся все транзакции и подробные сведения об их обработке. 

Чтобы увидеть их, необходимо задать параметр "Отобразить аналитический и отладочный журналы" в меню "Вид" службы "Просмотр событий". Затем необходимо включить их, чтобы начать сбор событий. Эти журналы не отображаются в прокси-службе веб-приложения в Windows Server 2012 R2, так как соединители созданы на основе более поздней версии.

 ![Сеанс службы "Просмотр событий" Azure AD](./media/application-proxy-understand-connectors/event-view-window-session.png)

Состояние службы можно проверить в окне "Служба". Соединитель состоит из двух служб Windows: одна из них — это фактический соединитель, а другая отвечает за обновление. Они должны постоянно работать.

 ![Окно "Службы (локальные)" Azure AD](./media/application-proxy-understand-connectors/aad-connector-services.png)

Сведения об устранении ошибок соединителя прокси приложения см. в [этой статье](https://azure.microsoft.com/en-us/documentation/articles/active-directory-application-proxy-troubleshoot).

## <a name="next-steps"></a>Дальнейшие действия
[Работа с имеющимися локальными прокси-серверами](application-proxy-working-with-proxy-servers.md)

[Автоматическая установка соединителя прокси приложения Azure AD](active-directory-application-proxy-silent-installation.md)


