---
title: Диагностика Azure Load Balancer уровня "Стандартный" | Документация Майкрософт
description: Использование доступных метрик и информации о работоспособности для диагностики Azure Load Balancer уровня "Стандартный"
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/21/2018
ms.author: Kumud
ms.openlocfilehash: 7d60925381abe617f6e2fac51176b8e30517c3ba
ms.sourcegitcommit: c3d53d8901622f93efcd13a31863161019325216
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2018
---
# <a name="metrics-and-health-diagnostics-for-standard-load-balancer"></a>Диагностика Load Balancer уровня "Стандартный" на основе метрик и сведений о работоспособности

Azure Load Balancer уровня "Стандартный" предоставляет следующие возможности диагностики для ресурсов.
* Многомерные метрики. Load Balancer уровня "Стандартный" предоставляет новые возможности многомерной диагностики конфигураций общедоступного и внутреннего Load Balancer. Они позволяют отслеживать ресурсы Load Balancer, управлять ими и устранять связанные с ними неполадки.

* Служба "Работоспособность ресурсов". На странице Load Balancer на портале Azure и странице службы работоспособности ресурсов Azure (в разделе "Мониторинг") отображаются сведения о состоянии работоспособности ресурсов Azure для конфигурации общедоступного Load Balancer уровня "Стандартный".

Эта статья содержит краткий обзор этих возможностей и способов их использования для Load Balancer уровня "Стандартный".

## <a name = "MultiDimensionalMetrics"></a>Многомерные метрики

Azure Load Balancer предоставляет новые многомерные метрики посредством решения "Метрики Azure" (предварительная версия) на портале и позволяет получить сведения для диагностики ресурсов Load Balancer в режиме реального времени. 

Для разных конфигураций Load Balancer уровня "Стандартный" сегодня доступны следующие метрики:

| Метрика | Тип ресурса | ОПИСАНИЕ | Рекомендуемая статистическая обработка |
| --- | --- | --- | --- |
| Доступность виртуального IP-адреса (доступность пути к данным) | Общедоступная подсистема балансировки нагрузки | Load Balancer уровня "Стандартный" непрерывно использует путь к данным из региона к внешнему интерфейсу Load Balancer, а затем в стек SDN, поддерживающий виртуальную машину. Пока остаются работоспособные экземпляры, измерение выполняется по тому же пути, что и трафик приложения с балансировкой нагрузки. Проверяется также путь к данным, который могут использовать ваши клиенты. Измерение является невидимым для приложения и не влияет на работоспособность других операций.| Средняя |
| Доступность выделенного IP-адреса (состояние пробы работоспособности) |  Общедоступная и внутренняя подсистема балансировки нагрузки | Load Balancer уровня "Стандартный" использует распределенную службу проверки работоспособности, которая контролирует состояние конечной точки приложения в соответствии с параметрами конфигурации. Эта метрика обеспечивает агрегированное или отфильтрованное представление для каждой отдельной конечной точки экземпляра в пуле Load Balancer.  Вы можете видеть, как Load Balancer просматривает работоспособность вашего приложения, как указано в конфигурации зонда работоспособности. |  Среднее |
| Пакеты SYN |  Общедоступная подсистема балансировки нагрузки | Load Balancer уровня "Стандартный" не прерывает TCP-подключения и не взаимодействует с потоками пакетов TCP и UDP. Потоки и их подтверждения всегда происходят между источником и экземпляром виртуальной машины. Чтобы оптимизировать устранение неполадок для всех сценариев протокола TCP, вы можете использовать счетчики пакетов SYN. С их помощью можно определить число попыток подключения TCP. Эта метрика указывает количество принятых пакетов TCP SYN.| Среднее |
| Подключения SNAT |  Общедоступная подсистема балансировки нагрузки |Load Balancer уровня "Стандартный" передает число замаскированных исходящих потоков на общедоступный интерфейсный IP-адрес. SNAT-порты являются ограниченным ресурсом. Эта метрика может дать представление о том, насколько сильно ваше приложение зависит от SNAT для исходящих потоков.  Выводятся данные счетчиков для успешного и неудачного выполнения исходящих потоков SNAT. Эти данные помогают устранять неполадки и определять работоспособность исходящих потоков.| Средняя |
| Счетчики байтов |  Общедоступная и внутренняя подсистема балансировки нагрузки | Load Balancer уровня "Стандартный" передает количество данных, обработанных каждым внешним интерфейсом.| Средняя |
| Счетчики пакетов |  Общедоступная и внутренняя подсистема балансировки нагрузки | Load Balancer уровня "Стандартный" передает количество пакетов, обработанных каждым внешним интерфейсом.| Средняя |

### <a name="view-load-balancer-metrics-in-the-portal"></a>Просмотр метрик Load Balancer на портале

Портал Azure предоставляет метрики подсистемы балансировки нагрузки на странице решения "Метрики" (предварительная версия), которая доступна на странице ресурсов Load Balancer для конкретного ресурса, а также на странице Azure Monitor. 

Чтобы просмотреть метрики ресурсов Load Balancer уровня "Стандартный", перейдите со страницы решения "Метрики" (предварительная версия) в одно из этих расположений, выберите (если на странице мониторинга, ресурс Load Balancer) тип метрики из раскрывающегося списка, установите соответствующий тип статистической обработки и при необходимости настройте нужную фильтрацию и группирование. После этого вы сможете просматривать историческое представление метрик в соответствии с условиями.

![Предварительная версия решения "Метрики" для Load Balancer уровня "Стандартный"](./media/load-balancer-standard-diagnostics/LBMetrics1.png)

*Рис. Метрики "Доступность выделенного IP-адреса" и "Состояние пробы работоспособности" Load Balancer*

### <a name="retrieve-multi-dimensional-metrics-programmatically-via-apis"></a>Получение многомерных метрик через API-интерфейсы программным образом

Руководство по получению определений многомерных метрик и значений через API см. в разделе [Получение определений метрик (многомерные API)](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-rest-api-walkthrough#retrieve-metric-definitions-multi-dimensional-api).

### <a name = "DiagnosticScenarios"></a>Распространенные сценарии диагностики и рекомендуемые представления

#### <a name="is-the-data-path-up-and-available-for-my-load-balancer-vip"></a>Доступен ли путь к данным для виртуального IP-адреса Load Balancer?

Метрика доступности виртуального IP-адреса описывает работоспособность пути к данным из региона к вычислительному узлу, где размещены виртуальные машины. Это отражение работоспособности инфраструктуры Azure. Эту метрику можно использовать, чтобы:
- отслеживать внешнюю доступность вашей службы;
- получить более подробную информацию о том, нормально ли функционирует платформа, на которой развернута служба, и узнать состояние работоспособности гостевой ОС или экземпляра приложения;
- определить, к чему относится событие: к службе или к базовой плоскости данных. Не путайте это с состоянием пробы работоспособности ("Доступность выделенного IP-адреса").

Чтобы получить метрику доступности виртуальных IP-адресов для ресурсов Load Balancer уровня "Стандартный", сделайте следующее.
- Убедитесь, что выбран правильный ресурс Load Balancer. 
- Выберите **VIP Availability** (Доступность виртуального IP-адреса) из раскрывающегося списка **Метрика**. 
- Выберите тип **Среднее** для варианта **статистической обработки**. 
- Кроме того, добавьте фильтр по виртуальному IP-адресу или порту виртуального IP-адреса в качестве измерения с необходимым внешним IP-адресом или портом и выполните группирование по измерению.

![Проверка виртуального IP-адреса](./media/load-balancer-standard-diagnostics/LBMetrics-VIPProbing.png)

*Рис. Сведения о проверке виртуального IP-адреса Load Balancer*

Метрика создается с помощью активного внутриполосного измерения. Служба проверки работоспособности в регионе создает трафик для этого измерения, активируется сразу после создания развертывания с общедоступным внешним интерфейсом и выполняется до тех пор, пока вы не удалите внешний интерфейс. 

>[!NOTE]
>Внутренние интерфейсы в настоящее время не поддерживаются. 

Периодически создается пакет, соответствующий внешнему интерфейсу и правилу развертывания. Он направляет трафик в регионе от источника к узлу, где расположена виртуальная машина в серверном пуле. Инфраструктура Load Balancer выполняет те же операции балансировки нагрузки и преобразования, что и для остального трафика. Эта проба находится в сети внутри конечной точки с балансировкой нагрузки. Когда проба поступает на узел вычислений, где находится работоспособная виртуальная машина в серверном пуле, узел вычислений генерирует ответ для службы проверки работоспособности. Ваша виртуальная машина не видит этот трафик.
Сбой доступности виртуального IP-адреса возникает по следующим причинам:
- в вашем развертывании нет исправных виртуальных машин, оставшихся в серверном пуле; 
- в работе инфраструктуры произошел перебой, который привел к сбою доступности виртуального IP-адреса.

Вы можете использовать [метрику доступности виртуального IP-адреса вместе с состоянием пробы работоспособности для диагностики](#vipavailabilityandhealthprobes).

Для большинства сценариев используйте тип статистического вычисления **Среднее**.

#### <a name="are-the-backend-instances-for-my-vip-responding-to-probes"></a>Отвечают ли на пробы серверные экземпляры для виртуального IP-адреса?

Метрика состояния пробы работоспособности описывает работоспособность развертывания приложения, настроенного при установке пробы работоспособности Load Balancer. Load Balancer использует состояние пробы работоспособности, чтобы определить, куда отправлять новые потоки. Пробы работоспособности исходят из адреса инфраструктуры Azure и видны в гостевой ОС виртуальной машины.

Чтобы получить сведения о доступности выделенного IP-адреса для ресурсов Load Balancer уровня "Стандартный", сделайте следующее.
- Выберите метрику **DIP Availability** (Доступность выделенного IP-адреса) с типом статической обработки **Среднее**. 
- Примените фильтр для необходимого виртуального IP-адреса или порта виртуального IP-адреса (или для обоих).

![Доступность выделенного IP-адреса (DIP)](./media/load-balancer-standard-diagnostics/LBMetrics-DIPAvailability.png)

*Рис. Доступность виртуального IP-адреса для Load Balancer*

Пробы работоспособности завершаются ошибками по следующим причинам:
- Вы настроили пробу работоспособности для порта, который не прослушивает, не отвечает или же имеет неправильный протокол. Если ваша служба использует правила DSR (плавающий IP-адрес), вам необходимо убедиться в том, что она прослушивает IP-адрес IP-конфигурации сети сетевого интерфейса, а не только интерфейс замыкания на себя, который настроен с внешним IP-адресом.
- Ваша проба не разрешена группой безопасности сети, брандмауэром гостевой ОС виртуальной машины или фильтрами прикладного уровня.

Для большинства сценариев используйте тип статистического вычисления **Среднее**.

#### <a name="how-do-i-check-my-outbound-connection-statistics"></a>Как проверить статистику исходящего подключения? 

Метрика подключений SNAT описывает число успешных и неудачных подключений (для [исходящих потоков](https://aka.ms/lboutbound)).

Число подключений со сбоями, превышающее нуль, указывает на нехватку портов SNAT. Вы должны продолжить исследование и определить, что может вызвать эти сбои. Нехватка портов SNAT обнаруживается как сбои, чтобы установить [исходящие потоки](https://aka.ms/lboutbound). Просмотрите статью об исходящих подключениях, чтобы понять сценарии, механизмы работы, а также узнать, как уменьшить риск и спроектировать так, чтобы избежать нехватки портов SNAT. 

Чтобы получить статистику по подключениям SNAT, сделайте следующее:
- выберите тип метрики **SNAT Connections** (Подключения SNAT) и тип статистической обработки **Сумма**; 
- сгруппируйте подключения SNAT по **состоянию** (успешные и неудачные), число которых будет представлено разными линиями. 

![Подключения SNAT](./media/load-balancer-standard-diagnostics/LBMetrics-SNATConnection.png)

*Рис. Количество подключений SNAT для Load Balancer*


#### <a name="how-do-i-check-inbound--outbound-connection-attempts-for-my-service"></a>Как проверить попытки входящих и исходящих подключений для службы?

Метрика пакетов SYN описывает число принятых или отправленных пакетов TCP SYN (для [исходящих потоков](https://aka.ms/lboutbound)), связанных с данным внешним интерфейсом. Эта метрика может использоваться для рассмотрения попыток подключения TCP к вашей службе.
Для большинства сценариев используйте тип статистической обработки "Всего".

![Подключение SYN](./media/load-balancer-standard-diagnostics/LBMetrics-SYNCount.png)

*Рис. Количество подключений SYN для Load Balancer*


#### <a name="how-do-i-check-my-network-bandwidth-consumption"></a>Как проверить потребление пропускной способности сети? 

Метрика счетчиков пакетов или байтов описывает число байтов и пакетов, отправленных или полученных вашей службой для каждого внешнего интерфейса.
Для большинства сценариев используйте тип статистической обработки **Всего**.

Чтобы получить статистику количества байтов или пакетов, сделайте следующее.
- Выберите тип метрики **Bytes Count** (Количество байтов) и (или) **Packet Count** (Количество пакетов), а также тип статистической обработки **Среднее**. 
- Примените фильтр по определенному внешнему IP-адресу или порту либо внутреннему IP-адресу или порту. 
- Или же получите общую статистику для ресурсов Load Balancer без какой-либо фильтрации.


Некоторые примеры представлений для метрик с различными конфигурациями.

![Количество байтов](./media/load-balancer-standard-diagnostics/LBMetrics-ByteCount.png)

*Рис. Количество байтов для Load Balancer*

#### <a name = "vipavailabilityandhealthprobes"></a>Как выполнить диагностику развертывания Load Balancer?

Сочетание метрик доступности виртуального IP-адреса и пробы работоспособности на одной диаграмме позволяет определить источник и решение проблемы. Благодаря этой информации вы можете удостовериться в том, что Azure работает правильно. Кроме того, с помощью этих сведений можно окончательно определить, что является первопричиной проблемы: конфигурация или приложение.

Вы можете использовать метрики пробы работоспособности, чтобы понять, как Azure рассматривает работоспособность вашего развертывания в соответствии с предоставленной вами конфигурацией. Просмотр проб работоспособности — отличный первый шаг при мониторинге или определении причины.

Вы можете сделать еще один шаг и использовать метрики доступности виртуального IP-адреса, чтобы получить представление о том, как Azure рассматривает работоспособность базовой плоскости данных, отвечающей за конкретное развертывание. Если вы объедините обе метрики, можно будет определить, где возникла ошибка, как показано в этом примере:

![Диагностика по метрике виртуального IP-адреса](./media/load-balancer-standard-diagnostics/LBMetrics-DIPnVIPAvailability.png)

*Рис. Объединение метрик доступности выделенного и виртуального IP-адресов*

На диаграмме представлены следующие сведения.
- Сама инфраструктура была работоспособной, инфраструктура, в которой размещались виртуальные машины, была доступна, и на сервере было размещено несколько виртуальных машин. Об этом свидетельствует синяя линия для доступности виртуального IP-адреса, которая отображается на показателе 100 %. 
- Однако состояние пробы работоспособности (доступность выделенного IP-адреса) соответствует 0 % в начале диаграммы, как показано оранжевой линией. Круг зеленого цвета отображает период, когда пробы работоспособности (доступности выделенного IP-адреса) стали успешными и в этот момент развертывание клиента смогло принять новые потоки.

Благодаря диаграмме клиент смог самостоятельно устранить проблему с развертыванием без необходимости запрашивать поддержку или угадывать, были ли другие проблемы. Служба клиента была недоступна по причине сбоев проб работоспособности из-за неправильной конфигурации или неисправного приложения.

### <a name = "Limitations"></a>Ограничения

- В настоящее время метрика доступности виртуального IP-адреса поддерживается только для общедоступных внешних интерфейсов.

## <a name = "ResourceHealth"></a>Состояние работоспособности ресурсов

Состояние работоспособности ресурсов Load Balancer уровня "Стандартный" можно узнать на странице **Работоспособность ресурсов** в разделе **Мониторинг > Работоспособность служб**.

>[!NOTE]
>Служба "Работоспособность ресурсов" в настоящее время доступна только для общедоступной конфигурации Load Balancer уровня "Стандартный". Ресурсы внутреннего Load Balancer или SKU уровня "Базовый" ресурсов Load Balancer не предоставляют работоспособность ресурсов.

Чтобы просмотреть работоспособность ресурсов общедоступного Load Balancer уровня "Стандартный", сделайте следующее.
 - Выберите **Мониторинг > Работоспособность служб**.

  ![Страница мониторинга](./media/load-balancer-standard-diagnostics/LBHealth1.png)

   *Рис. Работоспособность служб в Azure Monitor*

 - Выберите **Работоспособность ресурсов** и убедитесь, что выбран правильный **идентификатор подписки**, а **тип ресурса = Load Balancer**.

  ![Состояние работоспособности ресурсов](./media/load-balancer-standard-diagnostics/LBHealth3.png)

   *Рис. Выбор ресурса для представления работоспособности*

 - Щелкните ресурс Load Balancer в списке, чтобы просмотреть его состояние работоспособности.

    ![Состояние работоспособности Load Balancer](./media/load-balancer-standard-diagnostics/LBHealth4.png)

   *Рис. Представление работоспособности ресурса Load Balancer*
 
В следующей таблице перечислены различные состояния работоспособности ресурсов и их описания. 

| Состояние работоспособности ресурсов | ОПИСАНИЕ |
| --- | --- |
| Доступна | Ресурс общедоступного Load Balancer уровня "Стандартный" работоспособен и доступен. |
| Рекомендации недоступны | Ресурс общедоступного Load Balancer уровня "Стандартный" неработоспособен. Выполните диагностику работоспособности, выбрав "Azure Monitor > Метрики". (*Это также может означать, что ресурс не является общедоступным Load Balancer уровня "Стандартный"*) |
| Unknown | Работоспособность ресурсов для общедоступного Load Balancer уровня "Стандартный" еще не обновлена. (*Это также может означать, что ресурс не является общедоступным Load Balancer уровня "Стандартный"*)  |

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте больше об [Azure Load Balancer уровня "Стандартный"](load-balancer-standard-overview.md).
- Дополнительные сведения об исходящих подключениях Load Balancer см. в статье [Исходящие подключения в Azure](https://aka.ms/lboutbound).


