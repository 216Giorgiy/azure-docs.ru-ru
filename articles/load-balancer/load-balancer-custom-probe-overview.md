<properties 
   pageTitle="Пользовательские проверки балансировщика нагрузки и мониторинг состояния работоспособности | Microsoft Azure"
   description="Узнайте, как использовать пользовательские проверки для балансировщика нагрузки Azure для мониторинга экземпляров за балансировщиком нагрузки."
   services="load-balancer"
   documentationCenter="na"
   authors="joaoma"
   manager="carmonm"
   editor=""
   tags="azure-resource-manager"
/>
<tags  
   ms.service="load-balancer"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="01/21/2016"
   ms.author="joaoma" />


# Проверки балансировщика нагрузки 

Балансировщик нагрузки Azure позволяет отслеживать работоспособность различных экземпляров сервера с помощью проверок. Если проверка не отвечает, подсистема балансировки нагрузки Azure прекращает отправлять новые подключения неработоспособному экземпляру. Существующие подключения не затрагиваются, а новые подключения отправляются в работоспособные экземпляры.

При использовании виртуальных машин за балансировщиком нагрузки должны быть настроены пользовательские проверки TCP или HTTP. Роли облачной службы (рабочие роли и веб-роли) являются единственными экземплярами сервера с мониторингом проверки гостевого агента.
 
## Общие сведения о количестве проверок и времени ожидания

Поведение проверки зависит от числа успешных и неудачных проб, необходимых для отметки экземпляра как работоспособного или неработоспособного. Значение SuccessFailCount определяется путем деления времени ожидания на частоту. На портале в качестве значения времени ожидания задано удвоенное значение частоты (время ожидания = частота * 2).

Все экземпляры с балансировкой нагрузки для конечной точки (набор с балансировкой нагрузки) должны иметь одинаковую конфигурацию проверки. Это значит, что для определенного сочетания конечных точек не допускается использование разных конфигураций проверки (т. е. локального порта, времени ожидания и т. д.) для каждого экземпляра роли или виртуальной машины в одной размещенной службе.


>[AZURE.IMPORTANT] Проба балансировщика нагрузки работает с IP-адресом 168.63.129.16. Этот общедоступный IP-адрес используется для упрощения взаимодействия с ресурсами внутренней платформы в сценарии использования собственного виртуального IP-адреса. Общедоступный виртуальный IP-адрес 168.63.129.16 действует во всех регионах и не изменяется. Рекомендуется разрешить IP-адрес во всех локальных политиках брандмауэра. Он не должен считаться угрозой безопасности, так как источником сообщений с этого адреса может быть только внутренняя платформа Azure. В противном случае следует ожидать непредвиденного поведения в различных сценариях, например настройки того же IP-адреса 168.63.129.16 и наличия повторяющегося IP-адреса.


## Типы проверок

### Проверка гостевого агента

Только для облачных служб. Подсистема балансировки нагрузки Azure применяет гостевой агент в виртуальной машине, выполняет прослушивание и дает ответ HTTP 200 OK, только когда экземпляр находится в состоянии «Готов» (т. е. экземпляр не находится в состоянии «Занят», «Перезапуск», «Остановка» и т. д.).

Дополнительные сведения см. в статьях [Настройка файла определения службы (CSDED-файла) для проверки работоспособности](https://msdn.microsoft.com/library/azure/jj151530.asp) или [Начало работы по созданию балансировщика нагрузки, доступного в Интернете, для облачных служб](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).
 
### В каком случае проверка гостевого агента отметит экземпляр как неработоспособный?

Если гостевой агент не дает ответ HTTP 200 OK, подсистема балансировки нагрузки Azure отмечает экземпляр как не отвечающий и перестает отправлять ему трафик. Подсистема балансировки нагрузки Azure продолжает проверять связь с экземпляром, и, если гостевой агент передаст ответ с кодом HTTP 200, подсистема снова станет направлять трафик к этому экземпляру.

При использовании веб-роли код веб-сайта обычно выполняется в процессе w3wp.exe, который не находится под наблюдением структуры Azure или гостевого агента, а это значит, что ошибки в w3wp.exe (например ответы с кодом HTTP 500) не будут сообщены гостевому агенту и балансировщик нагрузки не будет знать, что нужно перестать использовать экземпляр.


### Пользовательская проверка HTTP

Пользовательская проверка балансировщика нагрузки HTTP переопределяет проверку гостевого агента по умолчанию и позволяет создать собственную пользовательскую логику для определения работоспособности экземпляра роли. Балансировщик нагрузки будет регулярно проверять конечную точку (по умолчанию каждые 15 секунд), и экземпляр будет рассматриваться как работоспособный в балансировщике нагрузки, если он дает ответ HTTP 200 за определенное время ожидания (по умолчанию 31 секунда). Это может оказаться удобным при реализации собственной логики остановки использования экземпляров для подсистемы балансировки нагрузки, например давать ответ, отличный от HTTP 200, если экземпляр потребляет более 90 % ресурсов ЦП. Для веб-ролей, использующих w3wp.exe, вы также получаете автоматический мониторинг веб-сайта, так как ошибки кода веб-сайта вернут при проверке состояние, отличное от HTTP 200.

>[AZURE.NOTE] Пользовательская проверка HTTP поддерживает относительные пути и только HTTP-протокол. HTTPS не поддерживается.


### В каком случае пользовательская проверка HTTP отметит экземпляр как неработоспособный? 

- Приложение HTTP возвращает код ответа HTTP, отличный от 200 (например 403, 404, 500 и т. д.). Это является положительным подтверждением необходимости немедленного прекращения использования экземпляра приложения.

-  HTTP-сервер вообще не отвечает по истечении времени ожидания. Обратите внимание, что в зависимости от заданного значения времени ожидания это может означать, что ряд запросов на проверку остается без ответа перед отметкой проверки как неудачной (т. е. отправляются проверки SuccessFailCount).
- 	Сервер закрывает подключение путем сброса TCP-соединения.

### Пользовательская проверка TCP

Проверки TCP инициализируют подключение, выполняя трехстороннее подтверждение на определенном порту.

### В каком случае пользовательская проверка TCP отметит экземпляр как неработоспособный?

- TCP-сервер вообще не отвечает по истечении времени ожидания. Это зависит от количества неудачных запросов на проверку, которые были настроены оставаться без ответа перед отметкой проверки как неудачной.
- 	Проверка получает сброс TCP-соединения из экземпляра роли.

Сведения о настройке проверки работоспособности HTTP или TCP см. в статье [Приступая к созданию балансировщика нагрузки, доступного в Интернете, для диспетчера ресурсов](load-balancer-get-started-internet-arm-ps.md#create-lb-rules-nat-rules-a-probe-and-a-load-balancer).

## Добавление работоспособных экземпляров обратно в балансировщик нагрузки

Проверки TCP и HTTP считаются допустимыми и отмечают экземпляр роли как работоспособный в следующих случаях:

- при первом запуске виртуальной машины и положительной проверке в балансировщике нагрузки;
- значение SuccessFailCount (см. выше) определяет количество успешных проверок, необходимых для отметки экземпляра роли как работоспособного. Если экземпляр роли был удален, SuccessFailCount указывается в строке успешных проверок, необходимых для отметки экземпляра роли как работоспособного.

>[AZURE.NOTE] Если состояние работоспособности экземпляра роли постоянно меняется, балансировщик нагрузки Azure будет больше времени находиться в режиме ожидания перед переводом экземпляра роли обратно в работоспособное состояние. Для этого используется политика, позволяющая защитить пользователей и инфраструктуру.

## Анализ журналов для балансировщика нагрузки

Для проверки состояния работоспособности проб и количества проб можно использовать [данные анализа журналов для балансировщика нагрузки](load-balancer-monitor-log.md). Функция ведения журналов в Power BI или Operation Insights позволяет получать статистические данные о состоянии работоспособности балансировщика нагрузки.
 

<!---HONumber=AcomDC_0302_2016-->