---
title: Руководство. Распределение нагрузки на виртуальных машинах в пределах зоны с помощью портала Azure | Документация Майкрософт
description: В этом руководство описано, как создать подсистему балансировки нагрузки уровня "Стандартный" с зональным внешним интерфейсом для распределения нагрузки на виртуальных машинах в пределах зоны доступности с помощью портала Azure
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
tags: azure-resource-manager
Customer intent: As an IT administrator, I want to create a load balancer that load balances incoming internet traffic to virtual machines within a specific zone in a region.
ms.assetid: ''
ms.service: load-balancer
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/17/2018
ms.author: kumud
ms.custom: mvc
ms.openlocfilehash: 52d0aeabab173caf4460827ca0d5984070688f0e
ms.sourcegitcommit: 688a394c4901590bbcf5351f9afdf9e8f0c89505
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/18/2018
ms.locfileid: "34304731"
---
# <a name="tutorialload-balance-vms-within-an-availability-zone-with-a-standard-load-balancer-using-the-azure-portal"></a>Руководство. Распределение нагрузки на виртуальных машинах в пределах зоны доступности с помощью подсистемы балансировки нагрузки уровня "Стандартный" и портала Azure

В этом руководстве описано, как создать общедоступную [подсистему балансировки нагрузки уровня "Стандартный"](https://aka.ms/azureloadbalancerstandard) с зональным внешним интерфейсом и общедоступным IP-адресом уровня "Стандартный" с помощью портала Azure. В этом сценарии нужно указать определенную зону для серверных и интерфейсных экземпляров, чтобы сопоставить ваш путь к данным и ресурсы с определенной зоной. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание подсистемы балансировки нагрузки с зональным внешним интерфейсом
> * Создание групп безопасности сети для определения правил входящего трафика
> * Создание зональных виртуальных машин и их присоединение к подсистеме балансировки нагрузки
> * Создание пробы работоспособности подсистемы балансировки нагрузки
> * создавать правила трафика подсистемы балансировки нагрузки;
> * создание простого сайта IIS;
> * Просмотр балансировщика нагрузки в действии

Дополнительные сведения о том, как работают зоны доступности с Load Balancer уровня "Стандартный", см. в статье [Azure Load Balancer уровня "Стандартный" и зоны доступности](load-balancer-standard-availability-zones.md).

При необходимости инструкции из этого руководства можно выполнить с помощью [Azure CLI](load-balancer-standard-public-zonal-cli.md).

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу [http://portal.azure.com](http://portal.azure.com).

## <a name="create-a-public-standard-load-balancer"></a>Создание общедоступного Load Balancer уровня "Стандартный"

Подсистема балансировки нагрузки уровня "Стандартный" поддерживает только стандартные общедоступные IP-адреса. При создании общедоступного IP-адреса во время создания подсистемы балансировки нагрузки он автоматически настраивается в качестве стандартной версии SKU и избыточной в пределах зоны.

1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Балансировщик нагрузки**.
2. На странице **Create a load balancer** (Создание подсистемы балансировки нагрузки) введите следующие значения для подсистемы балансировки нагрузки.
    - *myLoadBalancer* — для имени подсистемы балансировки нагрузки.
    - **Public** — для типа подсистемы балансировки нагрузки.
     - *myPublicIPZonal* — для нового общедоступного IP-адреса. Для этого щелкните **Выберите общедоступный IP-адрес**, а затем нажмите кнопку **Создать**. Введите имя *myPublicIP*, номер SKU "Стандартный" (выбран по умолчанию) и для параметра **Зона доступности** укажите номер зоны **1**.
    - *myResourceGroupZLB* — для имени создаваемой группы ресурсов.
    - **westeurope** — для расположения.
3. Щелкните **Создать**, чтобы создать подсистему балансировки нагрузки.
   
    ![Создание зональной подсистемы балансировки нагрузки уровня "Стандартный" с помощью портала Azure](./media/tutorial-load-balancer-standard-zonal-portal/create-load-balancer-zonal-frontend.png)


## <a name="create-backend-servers"></a>Создание внутренних серверов

В этом разделе вы создадите виртуальную сеть, две виртуальные машины в одной зоне (зона 1) для региона, которые будут добавлены во внутренний пул подсистемы балансировки нагрузки, а затем установите службу IIS на виртуальных машинах, чтобы протестировать подсистему балансировки нагрузки, избыточную в пределах зоны. В такой системе при сбое одной виртуальной машины срабатывает проверка работоспособности виртуальной машины в той же зоне, а другие виртуальные машины в этой зоне продолжают обрабатывать трафик.

### <a name="create-a-virtual-network"></a>Создать виртуальную сеть
1. В верхней левой части экрана щелкните **Создать ресурс** > **Сети** > **Виртуальная сеть**, а затем введите следующие значения для виртуальной сети:
    - *myVNet* — для имени виртуальной сети;
    - *myResourceGroupZLB* — для имени существующей группы ресурсов;
    - *myBackendSubnet* — для имени подсети.
2. Щелкните **Создать**, чтобы создать виртуальную сеть.

    ![Создать виртуальную сеть](./media/tutorial-load-balancer-standard-zonal-portal/create-virtual-network.png)

## <a name="create-a-network-security-group"></a>Создание группы безопасности сети

1. В верхней левой части экрана щелкните **Создать ресурс**, в поле поиска введите *Группа безопасности сети*, а на странице группы безопасности сети щелкните **Создать**.
2. На странице группы безопасности сети введите следующие значения:
    - *myNetworkSecurityGroup* — для имени группы безопасности сети;
    - *myResourceGroupLBAZ* — для имени имеющейся группы ресурсов.
   
    ![Создать виртуальную сеть](./media/tutorial-load-balancer-standard-zonal-portal/create-network-security-group.png)

### <a name="create-nsg-rules"></a>Создание правил NSG

В этом разделе вы создаете правила группы безопасности сети (NSG), чтобы разрешить входящие подключения по протоколу HTTP и протоколу удаленного рабочего стола (RDP) с помощью портала Azure.

1. На портале Azure в меню слева щелкните **Все ресурсы**, а затем найдите и щелкните группу **myNetworkSecurityGroup**, расположенную в группе ресурсов **myResourceGroupZLB**.
2. В разделе **Параметры** щелкните **Правила безопасности для входящего трафика**, а затем — **Добавить**.
3. Введите (выберите) следующие значения для правила безопасности для входящего трафика с именем *myHTTPRule*, чтобы разрешить входящие подключения HTTP через порт 80:
    - *Service Tag* — для **источника**;
    - *Internet* — для **тега службы источника**;
    - *80* — для **диапазонов портов назначения**;
    - *TCP* — для **протокола**;
    - *Разрешить* — для **действия**;
    - *100* — для значения **приоритета**;
    - *myHTTPRule* — для **имени**;
    - *Разрешить HTTP* — для параметра **Описание**.
4. Последовательно выберите **ОК**.
 
 ![Создать виртуальную сеть](./media/load-balancer-standard-public-availability-zones-portal/8-load-balancer-nsg-rules.png)

5. Еще раз выполните шаги 2–4, чтобы создать другое правило с именем *myRDPRule*, разрешающее входящее подключение по RDP через порт 3389. Введите (выберите) следующие значения:
    - *Service Tag* — для **источника**;
    - *Internet* — для **тега службы источника**;
    - *3389* — для **диапазонов портов назначения**;
    - *TCP* — для **протокола**;
    - *Разрешить* — для **действия**;
    - *200* — для значения **приоритета**;
    - *myRDPRule* — для имени;
    - *Разрешить RDP* — для описания.

    ![Создание правила для протокола RDP](./media/tutorial-load-balancer-standard-zonal-portal/create-rdp-rule.png)

### <a name="create-virtual-machines"></a>Создание виртуальных машин

1. В верхней части экрана слева щелкните **Создать ресурс** > **Вычисления** > **Windows Server 2016 Datacenter**, а затем введите следующие значения для виртуальной машины:
    - *myVM1* — для имени виртуальной машины;        
    - *azureuser* — для имени пользователя учетной записи администратора;    
    - *myResourceGroupZLB* — для **группы ресурсов**. Установите флажок **Использовать существующую** и выберите *myResourceGroupZLB*.
2. Последовательно выберите **ОК**.
3. Выберите значение **DS1_V2** в качестве размера виртуальной машины и нажмите кнопку **Выбрать**.
4. Введите следующие значения для параметров виртуальной машины.
    - *Зона 1* — для зоны доступности, в которой размещается виртуальная машина.
    -  В качестве виртуальной сети выберите *myVNet*.
    - *myVM1PIP* — для нового общедоступного IP-адреса уровня "Стандартный". Щелкните *Создать* и введите имя типа *myVM1PIP* и номер зоны **1**. Номер SKU для IP-адреса по умолчанию имеет значение "Стандартный".
    - В качестве подсети выберите *myBackendSubnet*.
    - *myNetworkSecurityGroup* — для имени существующей группы безопасности сети (брандмауэра).
5. Щелкните **Отключено**, чтобы отключить диагностику загрузки.
6. Нажмите кнопку **ОК**, просмотрите параметры на странице сводки и нажмите кнопку **Создать**.
7. Создайте вторую виртуальную машину с именем *myVM2* в зоне 1, указав для нее виртуальную сеть *myVnet*, общедоступный IP-адрес уровня "Стандартный" *myVM2PIP*, подсеть *myBackendSubnet* и группу безопасности сети **myNetworkSecurityGroup*, выполнив шаги 1–6.

    ![Создание правила для протокола RDP](./media/tutorial-load-balancer-standard-zonal-portal/create-virtual-machine.png) 

### <a name="install-iis-on-vms"></a>Установка служб IIS на виртуальные машины

1. В меню слева щелкните **Все ресурсы**, а затем выберите в списке ресурсов виртуальную машину **myVM1**, расположенную в группе ресурсов *myResourceGroupZLB*.
2. На странице **обзора** щелкните **Подключить**, чтобы подключиться по протоколу RDP к виртуальной машине.
3. Войдите на виртуальную машину, используя имя пользователя и пароль, которые вы указали при ее создании (возможно, для этого придется выбрать **Больше вариантов** и **Использовать другую учетную запись**). Введя данные, щелкните **ОК**. При входе в систему может появиться предупреждение о сертификате. Чтобы продолжить процесс подключения, выберите **Да**.
4. На рабочем столе сервера перейдите к **Средства администрирования Windows**>**Windows PowerShell**.
6. В окне PowerShell выполните следующие команды, чтобы установить сервер IIS, удалить файл по умолчанию iisstart.htm и добавить новый файл iisstart.htm с именем виртуальной машины:

   ```azurepowershell-interactive
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    # remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    # Add a new htm file that displays server name
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from" + $env:computername)
   ```
7. Закройте сеанс RDP для *myVM1*.
8. Повторите шаги 1–7, чтобы установить IIS на виртуальную машину *myVM2*.

## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

В этом разделе вы настраиваете параметры подсистемы балансировки нагрузки для внутреннего пула адресов и зонда работоспособности, а также указываете правила подсистемы балансировки нагрузки и NAT.


### <a name="create-a-backend-address-pool"></a>Создание внутреннего пула адресов

Для распределения трафика между виртуальными машинами внутренний пул адресов содержит IP-адреса виртуальных сетевых карт, подключенных к балансировщику нагрузки. Создайте внутренний пул адресов *myBackendPool*, куда будут входить виртуальные машины *VM1* и *VM2*.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer*.
2. В разделе **Параметры** выберите **Серверные пулы** и нажмите кнопку **Добавить**.
3. На странице **Add a backend pool** (Добавление серверного пула) сделайте следующее:
    - В поле имени внутреннего пула введите *myBackEndPool*.
    - В поле **Виртуальная сеть** в раскрывающемся меню щелкните *myVNet*.
    - В полях **Виртуальная машина** и **IP-адрес** укажите имена *myVM1*, *myVM2* и соответствующие общедоступные IP-адреса.
4. Щелкните **Добавить**.
5. Убедитесь, что в настройках внутреннего пула подсистемы балансировки нагрузки отображаются обе виртуальные машины (**myVM1** и **myVM2**).
 
    ![Создание внутреннего пула](./media/tutorial-load-balancer-standard-zonal-portal/create-backend-pool.png) 

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Чтобы балансировщик нагрузки мог следить за состоянием приложения, необходимо настроить пробу работоспособности. Проба работоспособности динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности. Создайте зонд работоспособности *myHealthProbe*, чтобы отслеживать работоспособность виртуальных машин.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** щелкните **Зонды работоспособности** и нажмите кнопку **Добавить**.
3. Для создания зонда работоспособности используйте следующие значения:
    - *myHealthProbe* — для имени зонда работоспособности;
    - **HTTP** — для типа протокола;
    - *80* — для номера порта;
    - *15* — для **интервала** между попытками выполнения зонда (в секундах);
    - *2* — для числа **порога состояния неработоспособности** или последовательных сбоев зонда, которые должны произойти, прежде чем виртуальная машина будет считаться неработоспособной.
4. Последовательно выберите **ОК**.

   ![Добавление пробы](./media/load-balancer-standard-public-availability-zones-portal/4-load-balancer-probes.png)

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило балансировщика нагрузки позволяет определить распределение трафика между виртуальными машинами. Вы определяете интерфейсную конфигурацию IP-адресов для входящего трафика и внутренний пул IP-адресов для приема трафика, а также требуемый порт источника и назначения. Создайте правило балансировки нагрузки *myLoadBalancerRuleWeb* для прослушивания порта 80 в интерфейсном сервере *FrontendLoadBalancer* и отправки сетевого трафика со сбалансированной нагрузкой во внутренний пул адресов *myBackEndPool*, также используя порт 80. 

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **Добавить**.
3. Для настройки правила балансировки нагрузки используйте следующие значения:
    - *myHTTPRule* — для имени правила балансировки нагрузки;
    - **TCP** — для типа протокола;
    - *80* — для номера порта;
    - *80* — для внутреннего порта;
    - *myBackendPool* — для имени серверного пула;
    - *myHealthProbe* — для имени зонда работоспособности.
4. Последовательно выберите **ОК**.
    
    ![Добавление правила балансировки нагрузки](./media/tutorial-load-balancer-standard-zonal-portal/load-balancing-rule.png)

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки
1. Найдите общедоступный IP-адрес для подсистемы балансировки нагрузки на экране **обзора**. Выберите **Все ресурсы**, а затем щелкните **myPublicIP**. 

2. Скопируйте общедоступный IP-адрес и вставьте его в адресную строку браузера. В браузере отображается страница по умолчанию, которая содержит имя веб-сервера.

      ![Веб-сервер IIS](./media/tutorial-load-balancer-standard-zonal-portal/load-balancer-test.png)
3. Чтобы проверить работу подсистемы балансировки нагрузки, принудительно остановите указанную на странице виртуальную машину, а затем обновите страницу в браузере, чтобы на ней отобразилось другое имя сервера.

## <a name="clean-up-resources"></a>Очистка ресурсов

Ставшие ненужными группу ресурсов, подсистему балансировки нагрузки и все связанные ресурсы можно удалить. Для этого выберите группу ресурсов, содержащую подсистему балансировки нагрузки, и щелкните **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

- Узнайте больше об [Azure Load Balancer уровня "Стандартный"](load-balancer-standard-overview.md).
- [Балансировка нагрузки виртуальных машин в пределах зон доступности](tutorial-load-balancer-standard-public-zone-redundant-portal.md)
