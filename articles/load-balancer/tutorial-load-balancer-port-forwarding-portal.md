---
title: Руководство. Настройка перенаправления портов в Load Balancer с помощью портала Azure | Документация Майкрософт
description: В этом руководстве описано, как настроить перенаправление портов с помощью Azure Load Balancer, чтобы создать подключение к виртуальным машинам в виртуальной сети Azure.
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
tags: azure-resource-manager
Customer intent: As an IT administrator, I want to configure port forwarding in Azure Load Balancer to remotely connect to VMs in an Azure virtual network.
ms.assetid: ''
ms.service: load-balancer
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/31/18
ms.author: kumud
ms.custom: mvc
ms.openlocfilehash: eac0636af1b46912897a4c93f86477c46299bc0f
ms.sourcegitcommit: 4f9fa86166b50e86cf089f31d85e16155b60559f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/04/2018
ms.locfileid: "34757736"
---
# <a name="tutorial-configure-port-fowarding-in-load-balancer-using-the-azure-portal"></a>Руководство. Настройка перенаправления портов в Load Balancer с помощью портала Azure

Перенаправление портов с помощью Azure Load Balancer позволяет удаленно подключаться к виртуальным машинам в виртуальной сети Azure, используя общедоступный IP-адрес Azure Load Balancer и настроенный номер порта. В этом руководстве описано, как настроить перенаправление портов в Azure Load Balancer и выполнить следующие операции:


> [!div class="checklist"]
> * Создание Azure Load Balancer
> * Создание пробы работоспособности балансировщика нагрузки
> * создавать правила трафика подсистемы балансировки нагрузки;
> * Создание виртуальных машин и установка сервера IIS
> * Присоединение виртуальной машины к подсистеме балансировки нагрузки
> * Создание правил NAT для входящего трафика в подсистеме балансировки нагрузки
> * Проверка работы перенаправления портов


Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу. 

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу [http://portal.azure.com](http://portal.azure.com).

## <a name="create-a-standard-load-balancer"></a>Создание подсистемы балансировки нагрузки уровня "Стандартный"

В этом разделе вы создадите общедоступную подсистему балансировки нагрузки, помогающую распределять нагрузку виртуальных машин. Подсистема балансировки нагрузки уровня "Стандартный" поддерживает только стандартные общедоступные IP-адреса. Вместе с подсистемой балансировки нагрузки категории "Стандартный" необходимо также создать новый стандартный общедоступный IP-адрес, настроенный в качестве интерфейсного (с именем *LoadBalancerFrontend* по умолчанию). 

1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Балансировщик нагрузки**.
2. На странице **Create a load balancer** (Создание подсистемы балансировки нагрузки) введите следующие значения для подсистемы балансировки нагрузки.
    - *myLoadBalancer* — для имени подсистемы балансировки нагрузки.
    - **Стандартный** — версия номера SKU для подсистемы балансировки нагрузки.
    - **Public** — для типа подсистемы балансировки нагрузки.
    - *myPublicIP* — для **нового** общедоступного IP-адреса.
    - *myResourceGroupSLB* — для имени **новой** создаваемой группы ресурсов.
    - **westeurope** — для расположения.
3. Щелкните **Создать**, чтобы создать подсистему балансировки нагрузки.

![Создание балансировщика нагрузки](./media/load-balancer-standard-public-portal/1a-load-balancer.png)
   
## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

В этом разделе описано, как настроить параметры подсистемы балансировки нагрузки для внутреннего пула адресов и пробы работоспособности, а также указать правила подсистемы балансировки нагрузки.

### <a name="create-a-backend-address-pool"></a>Создание внутреннего пула адресов

Для распределения трафика между виртуальными машинами пул внутренних адресов содержит IP-адреса виртуальных сетевых карт, подключенных к подсистеме балансировки нагрузки. Создайте внутренний пул адресов *myBackendPool*, куда будут входить виртуальные машины *VM1* и *VM2*.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** выберите **Серверные пулы** и нажмите кнопку **Добавить**.
3. На странице **Добавление внутреннего пула** введите имя *myBackEndPool* для внутреннего пула и нажмите кнопку **ОК**.

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Чтобы балансировщик нагрузки мог следить за состоянием приложения, необходимо настроить пробу работоспособности. Проба работоспособности динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности. Создайте зонд работоспособности *myHealthProbe*, чтобы отслеживать работоспособность виртуальных машин.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** щелкните **Зонды работоспособности** и нажмите кнопку **Добавить**.
3. Для создания зонда работоспособности используйте следующие значения:
    - *myHealthProbe* — для имени зонда работоспособности;
    - **HTTP** — для типа протокола;
    - *80* — для номера порта;
    - *15* — для **интервала** между попытками выполнения зонда (в секундах);
    - *2* — для числа **порога состояния неработоспособности** или последовательных сбоев зонда, которые должны произойти, прежде чем виртуальная машина будет считаться неработоспособной.
4. Последовательно выберите **ОК**.

   ![Добавление пробы](./media/load-balancer-standard-public-portal/4-load-balancer-probes.png)

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило балансировщика нагрузки позволяет определить распределение трафика между виртуальными машинами. Вы определяете конфигурацию внешнего IP-адреса для входящего трафика и пул внутренних IP-адресов для приема трафика, а также требуемый порт источника и назначения. Создайте правило балансировки нагрузки *myLoadBalancerRuleWeb* для прослушивания порта 80 в интерфейсном сервере *FrontendLoadBalancer* и отправки сетевого трафика со сбалансированной нагрузкой во внутренний пул адресов *myBackEndPool*, также используя порт 80. 

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **Добавить**.
3. Для настройки правила балансировки нагрузки используйте следующие значения:
    - *myHTTPRule* — для имени правила балансировки нагрузки;
    - **TCP** — для типа протокола;
    - *80* — для номера порта;
    - *80* — для внутреннего порта;
    - *myBackendPool* — для имени серверного пула;
    - *myHealthProbe* — для имени зонда работоспособности.
4. Последовательно выберите **ОК**.
    
## <a name="create-backend-servers"></a>Создание внутренних серверов

В этом разделе описано, как создать виртуальную сеть, две виртуальные машины серверного пула подсистемы балансировки нагрузки, а затем установить службы IIS на виртуальных машинах для проверки перенаправления потов через подсистему балансировки нагрузки.

### <a name="create-a-virtual-network"></a>Создать виртуальную сеть
1. В верхней левой части экрана щелкните **Создать** > **Сети** > **Виртуальная сеть**, а затем введите следующие значения для виртуальной сети:
    - *myVNet* — для имени виртуальной сети;
    - *myResourceGroupSLB* — в качестве имени имеющейся группы ресурсов;
    - *myBackendSubnet* — для имени подсети.
2. Щелкните **Создать**, чтобы создать виртуальную сеть.

    ![Создать виртуальную сеть](./media/load-balancer-standard-public-portal/2-load-balancer-virtual-network.png)

### <a name="create-virtual-machines"></a>Создание виртуальных машин

1. В верхней части экрана слева щелкните **Создать** > **Вычисления** > **Windows Server 2016 Datacenter**, а затем введите следующие значения для виртуальной машины:
    - *myVM1* — для имени виртуальной машины;        
    - *azureuser* — для имени пользователя учетной записи администратора;    
    - *myResourceGroupSLB* — для **группы ресурсов**. Установите флажок **Использовать существующую** и выберите *myResourceGroupSLB*.
2. Последовательно выберите **ОК**.
3. Выберите значение **DS1_V2** в качестве размера виртуальной машины и нажмите кнопку **Выбрать**.
4. Введите следующие значения для параметров виртуальной машины.
    -  В качестве виртуальной сети выберите *myVNet*.
    - В качестве подсети выберите *myBackendSubnet*.
    - *myNetworkSecurityGroup* — для имени новой группы безопасности сети (брандмауэра), которую необходимо создать.
5. Щелкните **Отключено**, чтобы отключить диагностику загрузки.
6. Нажмите кнопку **ОК**, просмотрите параметры на странице сводки и нажмите кнопку **Создать**.
7. Создайте вторую виртуальную машину с именем *VM2*, виртуальной сетью *myVnet*, подсетью *myBackendSubnet* и группой безопасности сети **myNetworkSecurityGroup*, выполнив шаги 1–6. 

### <a name="create-nsg-rules"></a>Создание правил NSG

В этом разделе вы создаете правила группы безопасности сети (NSG), чтобы разрешить входящие подключения по протоколу HTTP и протоколу удаленного рабочего стола (RDP).

1. В меню слева щелкните **Все ресурсы**, а затем в списке ресурсов выберите группу безопасности сети **myNetworkSecurityGroup**, расположенную в группе ресурсов **myResourceGroupSLB**.
2. В разделе **Параметры** щелкните **Правила безопасности для входящего трафика**, а затем — **Добавить**.
3. Введите (выберите) следующие значения для правила безопасности для входящего трафика с именем *myHTTPRule*, чтобы разрешить входящие подключения HTTP через порт 80:
    - *Service Tag* — для **источника**;
    - *Internet* — для **тега службы источника**;
    - *80* — для **диапазонов портов назначения**;
    - *TCP* — для **протокола**;
    - *Разрешить* — для **действия**;
    - *100* — для значения **приоритета**;
    - *myHTTPRule* — для имени;
    - *Разрешить HTTP* — для описания.
4. Последовательно выберите **ОК**.
 
 ![Создать виртуальную сеть](./media/load-balancer-standard-public-portal/8-load-balancer-nsg-rules.png)
5. Еще раз выполните шаги 2–4, чтобы создать другое правило с именем *myRDPRule*, разрешающее входящее подключение по RDP через порт 3389. Введите (выберите) следующие значения:
    - *Service Tag* — для **источника**;
    - *Internet* — для **тега службы источника**;
    - *3389* — для **диапазонов портов назначения**;
    - *TCP* — для **протокола**;
    - *Разрешить* — для **действия**;
    - *200* — для значения **приоритета**;
    - *myRDPRule* — для имени;
    - *Разрешить RDP* — для описания.

### <a name="install-iis-on-vms"></a>Установка служб IIS на виртуальные машины

1. В меню слева щелкните **Все ресурсы** и выберите в списке ресурсов виртуальную машину **myVM1**, расположенную в группе ресурсов *myResourceGroupSLB*.
2. На странице **обзора** щелкните **Подключить**, чтобы подключиться по протоколу RDP к виртуальной машине.
3. Войдите в виртуальную машину с именем пользователя *azureuser*.
4. На рабочем столе сервера перейдите к **Средства администрирования Windows**>**Windows PowerShell**.
5. В окне PowerShell выполните следующие команды, чтобы установить сервер IIS, удалить файл по умолчанию iisstart.htm и добавить новый файл iisstart.htm с именем виртуальной машины:

   ```azurepowershell-interactive
    
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    # Add a new htm file that displays server name
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from" + $env:computername)
   ```
6. Закройте сеанс RDP для *myVM1*.
7. Повторите шаги 1–6, чтобы установить IIS и разместить обновленный файл iisstart.htm на *myVM2*.

## <a name="add-vms-to-the-backend-address-pool"></a>Добавление виртуальных машин в серверный пул адресов

Чтобы направлять трафик на виртуальные машины, добавьте виртуальные машины *VM1* и *VM2* в ранее созданный серверный пул адресов *myBackendPool*. Этот пул содержит IP-адреса виртуальных сетевых адаптеров, подключенных к подсистеме балансировки нагрузки.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** щелкните **Серверные пулы**, затем выберите в списке серверных пулов элемент **myBackendPool**.
3. На странице **myBackendPool** сделайте следующее:
    - Щелкните **Добавить целевую IP-конфигурацию сети**, чтобы добавить созданные для серверного пула виртуальные машины (*myVM1* и *myVM2*).
    - Последовательно выберите **ОК**.
4. Убедитесь, что в настройках серверного пула подсистемы балансировки нагрузки отображаются все нужные виртуальные машины (**VM1** и **VM2**).

## <a name="create-inbound-nat-rules"></a>Создание правила NAT для входящего трафика
С помощью Load Balancer можно создать правило преобразования сетевых адресов (NAT) для входящих подключений, которое перенаправляет трафик с определенного порта IP-адреса внешнего интерфейса на определенный порт серверного экземпляра в виртуальной сети.

Создайте правило NAT для входящих подключений, чтобы направлять трафик от интерфейсных портов подсистемы балансировки нагрузки к порту 3389 виртуальных машин серверной части.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** щелкните **Правила преобразования сетевых адресов для входящих подключений**, затем выберите в списке серверных пулов **myBackendPool**.
3. На странице **Правила преобразования сетевых адресов для входящих подключений** введите следующие значения:
    - Введите для правила NAT имя *myNATRuleRDPVM1*
    - и порт *4221*.
    - В раскрывающемся списке **Целевая виртуальная машина** выберите *myVM1*.
    - В поле **Сопоставление портов**, выберите "Пользовательское", а для параметра **Целевой порт** укажите значение **3389**.
    - Последовательно выберите **ОК**.
4. Повторите шаги 2 и 3, чтобы создать правило NAT для входящего трафика с именем *myNATRuleRDPVM2* для виртуальной машины *myVM2* с использованием интерфейсного порта *4222*.

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки
1. Найдите общедоступный IP-адрес для подсистемы балансировки нагрузки на экране **обзора**. Выберите **Все ресурсы**, а затем щелкните **myPublicIP**.

2. Скопируйте общедоступный IP-адрес и вставьте его в адресную строку браузера. В браузере отобразится страница по умолчанию веб-сервера IIS.

      ![Веб-сервер IIS](./media/tutorial-load-balancer-standard-zonal-portal/load-balancer-test.png)

Чтобы проверить, как подсистема балансировки нагрузки распределяет трафик между тремя виртуальными машинами, на которых выполняется приложение, принудительно обновите страницу в браузере.

## <a name="test-port-forwarding"></a>Проверка перенаправления портов
Перенаправление портов позволяет создать подключение по протоколу удаленного рабочего стола к виртуальным машинам в серверном пуле адресов с использованием IP-адреса подсистемы балансировки нагрузки и номера интерфейсного порта, указанных на предыдущем шаге.

1. Найдите общедоступный IP-адрес для подсистемы балансировки нагрузки на экране **обзора**. Выберите **Все ресурсы**, а затем щелкните **myPublicIP**.
2. На локальном компьютере выполните следующую команду для создания сеанса удаленного рабочего стола с виртуальной машиной *myVM2*. Замените `<publicIpAddress>` IP-адресом, полученным на предыдущем шаге.

    ```
    mstsc /v:<publicIpAddress>:4222
    ```
  
3. Откройте загруженный RDP-файл. При появлении запроса выберите **Подключиться**.

4. Введите имя пользователя и пароль, которые вы указали при создании виртуальной машины (возможно, для этого придется выбрать **Дополнительные варианты** и **Использовать другую учетную запись**). Затем нажмите кнопку **ОК**. При входе в систему может появиться предупреждение о сертификате. Чтобы продолжить процесс подключения, выберите **Да**.
 
   RDP-подключение устанавливается с использованием правила NAT для входящего трафика *myNATRuleRDPVM2*, которое перенаправляет трафик от интерфейсного порта **4222** подсистемы балансировки нагрузки к порту 3389 виртуальной машины *myVM2*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Ставшие ненужными группу ресурсов, подсистему балансировки нагрузки и все связанные ресурсы можно удалить. Для этого выберите группу ресурсов, содержащую подсистему балансировки нагрузки, и щелкните **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве описано, как создать подсистему балансировки нагрузки в службе Azure Load Balancer (цен. категории "Стандартный"), подключить к ней виртуальные машины, настроить правило трафика подсистемы балансировки нагрузки, пробу работоспособности, а также протестировать подсистему балансировки нагрузки. Также здесь показано, как удалить виртуальную машину из набора балансировки нагрузки и добавить ее в серверный пул адресов. Чтобы узнать больше об Azure Load Balancer, ознакомьтесь с другими руководствами по этой службе.

> [!div class="nextstepaction"]
> [Руководства по Azure Load Balancer](tutorial-load-balancer-standard-public-zone-redundant-portal.md)
