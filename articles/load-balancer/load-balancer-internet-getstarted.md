
<properties
   pageTitle="Приступая к работе с подсистемой балансировки нагрузки, доступной в Интернете | Microsoft Azure"
   description="Начните использовать набор подсистем балансировки нагрузки, доступных в Интернете, для виртуальных машин или облачных служб."
   services="load-balancer"
   documentationCenter="na"
   authors="joaoma"
   manager="adinah"
   editor="tysonn" />
<tags
   ms.service="load-balancer"
   ms.devlang="na"
   ms.topic="hero-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="08/03/2015"
   ms.author="joaoma" />

# Приступая к настройке подсистемы балансировки нагрузки, доступной в Интернете

> [AZURE.SELECTOR]
- [Azure classic steps](load-balancer-internet-getstarted.md)
- [Resource Manager Powershell steps](load-balancer-arm-powershell.md)

Службы балансировки нагрузки в Microsoft Azure поддерживают клиентов всех типов (IaaS или PaaS) и ОС всех версий (Windows или любые ОС на основе Linux).


## Настройка подсистемы балансировки нагрузки, доступной в Интернете, для виртуальных машин

Чтобы распределить нагрузку сетевого трафика в Интернете между виртуальными машинами облачной службы, нужно создать набор балансировки нагрузки. В этой процедуре предполагается, что вы уже создали виртуальные машины и что все они находятся в одной облачной службе.

Выполните описанные ниже действия, чтобы настроить набор подсистемы балансировки нагрузки для виртуальных машин:

1. На портале управления Azure щелкните «Виртуальные машины», а затем выберите имя виртуальной машины в наборе балансировки нагрузки.
2.	Нажмите Конечные точки, а затем выберите Добавить.

4.	На странице Добавить конечную точку на виртуальную машину нажмите стрелку вправо.

4.	В разделе "Укажите подробные сведения" на странице конечной точки:
	- В поле «Имя» введите имя конечной точки или выберите имя в списке предварительно определенных конечных точек для распространенных протоколов.
	-  В поле «Протокол» выберите при необходимости протокол, необходимый для этого типа конечной точки (TCP или UDP).
 	-  В полях «Общий порт» и «Частный порт» введите при необходимости номера портов, которые требуется использовать для виртуальной машины. На виртуальной машине можно использовать частный порт и правила брандмауэра, чтобы перенаправить трафик способом, который подходит для вашего приложения. Частный порт может быть таким же, как общий порт. Например, для конечной точки для веб-трафика (HTTP) для общего и частного порта можно назначить порт 80.

5.	Выберите Создать набор балансировки нагрузки и нажмите стрелку вправо.

6.	На странице «Настроить набор балансировки нагрузки» введите имя для набора балансировки нагрузки, а затем присвойте значения для поведения зондов подсистемы балансировки нагрузки Azure. Подсистема балансировки нагрузки использует пробы для определения, доступны ли виртуальные машины в наборе балансировки нагрузки для приема входящего трафика.

7.	Чтобы создать конечную точку балансировки нагрузки, поставьте галочку. Вы увидите Да в столбце Имя набора балансировки нагрузки на странице Конечные точки виртуальной машины.

8.	На портале управления щелкните «Виртуальные машины», выберите имя дополнительной виртуальной машины в наборе балансировки нагрузки, а затем щелкните «Конечные точки» и выберите «Добавить».

9.	На странице виртуальной машины в разделе "Добавить конечную точку" нажмите Добавить конечную точку в существующий набор балансировки нагрузки, выберите имя набора балансировки нагрузки и нажмите стрелку вправо.

10.	На странице конечной точки в разделе "Укажите подробные сведения" введите имя конечной точки и щелкните флажок. Для дополнительных виртуальных машин в наборе балансировки нагрузки повторите шаги 8–10.

Конечные точки можно также настроить с помощью следующих командлетов Windows PowerShell:

- Add-AzureEndpoint

[Add-AzureEndpoint](https://msdn.microsoft.com/library/windowsazure/dn495300)

- Get-AzureEndpoint

[Get-AzureEndpoint](https://msdn.microsoft.com/library/windowsazure/dn495158)

- Remove-AzureEndpoint

[Remove-AzureEndpoint](https://msdn.microsoft.com/library/windowsazure/dn495161)


## Настройка подсистемы балансировки, доступной в Интернете, для облачных служб


Облачные службы автоматически настраиваются с помощью подсистемы балансировки нагрузки. Их также можно настроить, используя модель службы.

Вы можете обновить облачную службу с помощью пакета SDK для Azure для .NET 2.5. Настройки конечных точек для облачных служб создаются в CSDEF-файле [определения службы](https://msdn.microsoft.com/library/azure/gg557553.aspx).

В следующем примере показано, как настроить файл servicedefinition.csdef для облачного развертывания.

В фрагменте CSDEF-файла, созданного путем облачного развертывания, можно увидеть внешнюю конечную точку, настроенную для использования портов HTTP через порты 10000, 10001 и 10002.


	<ServiceDefinition name=“Tenant“>
   	<WorkerRole name=“FERole” vmsize=“Small“>
    <Endpoints>
        <InputEndpoint name=“FE_External_Http” protocol=“http” port=“10000“ />
        <InputEndpoint name=“FE_External_Tcp“  protocol=“tcp“  port=“10001“ />
        <InputEndpoint name=“FE_External_Udp“  protocol=“udp“  port=“10002“ />

        <InputEndpointname=“HTTP_Probe” protocol=“http” port=“80” loadBalancerProbe=“MyProbe“ />

        <InstanceInputEndpoint name=“InstanceEP” protocol=“tcp” localPort=“80“>
           <AllocatePublicPortFrom>
              <FixedPortRange min=“10110” max=“10120“  />
           </AllocatePublicPortFrom>
        </InstanceInputEndpoint>
        <InternalEndpoint name=“FE_InternalEP_Tcp” protocol=“tcp“ />
    </Endpoints>
  	</WorkerRole>
	</ServiceDefinition>




### Проверка состояния работоспособности подсистемы балансировки нагрузки для облачных служб


Пример зонда работоспособности:

	 	<LoadBalancerProbes>
    	<LoadBalancerProbe name=“MyProbe” protocol=“http” path=“Probe.aspx” intervalInSeconds=“5” timeoutInSeconds=“100“ />
 	 	</LoadBalancerProbes>

Подсистема балансировки нагрузки объединяет информацию о конечной точке и информацию о зонде для создания URL-адреса в виде http://{DIP ВМ}:80/Probe.aspx, который будет использоваться для запроса на проверку работоспособности службы.

Служба обнаруживает, если к ней периодически осуществляется доступ с одного IP-адреса. Это запрос зонда работоспособности, поступающий от узла, на котором запущена виртуальная машина. Служба должна отправить ответ с кодом состояния HTTP 200, что подтверждает для подсистемы балансировки нагрузки, что служба работоспособна. В случае получения любого другого кода состояния HTTP (например, 503) виртуальная машина перестает использоваться.

С помощью определения зонда можно контролировать частоту отправки зондов. В описанном выше случае подсистема балансировки нагрузки зондирует конечную точку каждые 5 секунд. Если в течение 10 секунд не приходит положительный ответ (два интервала зонда), предполагается, что зонд завершился сбоем, и виртуальная машина перестает использоваться. Аналогично, если получен положительный ответ для службы, которая не используется, сразу же выполняется ее автоматический запуск. Если состояние службы постоянно меняется (с рабочего на нерабочее и наоборот), подсистема балансировки нагрузки может отложить повторный запуск службы до получения определенного количества ответов, подтверждающих ее работоспособность.

Чтобы получить дополнительную информацию о [зонде работоспособности](https://msdn.microsoft.com/library/azure/jj151530.aspx), см. схему определения службы.

## Настройка балансировки нагрузки с помощью PowerShell

Создав виртуальную машину, можно добавить к ней подсистему балансировки нагрузки в пределах той же облачной службы, используя для этого командлеты PowerShell.

В следующем примере вы добавим подсистему балансировки нагрузки с именем webfarm в конечную точки облачной службы mycloudservice (или mycloudservice.cloudapp.net) и на виртуальную машину с именем myVM. Подсистема балансировки нагрузки будет принимать трафик через порт 80 и распределять сетевой трафик между виртуальными машинами через порт 8080 по протоколу HTTP.

	Get-AzureVM -ServiceName "mycloudservice" -Name "MyVM" | Add-AzureEndpoint -Name "HttpIn" -Protocol "tcp" -PublicPort 80 -LocalPort 8080 -LBSetName "WebFarm" -ProbePort 80 -ProbeProtocol "http" -ProbePath '/' | Update-AzureVM




## Дальнейшие действия

[Приступая к настройке внутренней подсистемы балансировки нагрузки](load-balancer-internal-getstarted.md)

[Настройка режима распределения подсистемы балансировки нагрузки](load-balancer-distribution-mode.md)

[Настройка параметров времени ожидания простоя TCP для подсистемы балансировки нагрузки](load-balancer-tcp-idle-timeout.md)
 

<!---HONumber=August15_HO6-->