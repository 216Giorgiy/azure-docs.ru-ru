---
title: Руководство. Балансировка интернет-трафика на виртуальных машинах на портале Azure
titlesuffix: Azure Load Balancer
description: Из этого руководства вы узнаете, как создать и администрировать Load Balancer ценовой категории "Стандартный" с помощью портала Azure.
services: load-balancer
documentationcenter: na
author: KumudD
manager: twooley
Customer intent: I want to create and Standard Load balancer so that I can load balance internet traffic to VMs and add and remove VMs from the load-balanced set.
ms.service: load-balancer
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/20/18
ms.author: kumud
ms.custom: seodec18
ms.openlocfilehash: c22f69764447ffd4f8b67e9162fd8b45b40b175b
ms.sourcegitcommit: a512360b601ce3d6f0e842a146d37890381893fc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2019
ms.locfileid: "54230039"
---
# <a name="tutorial-load-balance-internet-traffic-to-vms-using-the-azure-portal"></a>Руководство. Балансировка интернет-трафика на виртуальных машинах с помощью портала Azure

Балансировка нагрузки обеспечивает более высокий уровень доступности и масштабирования за счет распределения входящих запросов между несколькими виртуальными машинами. Из этого руководства вы узнаете о различных компонентах Azure Load Balancer ценовой категории "Стандартный", которые распределяют интернет-трафик на виртуальных машинах и обеспечивают высокий уровень доступности. Вы узнаете, как выполнять следующие задачи:


> [!div class="checklist"]
> * Создание Azure Load Balancer
> * создание виртуальных машин и установка сервера IIS;
> * Создание ресурсов подсистемы балансировки нагрузки
> * Просмотр балансировщика нагрузки в действии
> * добавлять и удалять виртуальные машины из подсистемы балансировки нагрузки.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу. 

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

Войдите на портал Azure по адресу [http://portal.azure.com](http://portal.azure.com).

## <a name="create-a-standard-load-balancer"></a>Создание подсистемы балансировки нагрузки уровня "Стандартный"

В этом разделе вы создадите общедоступную подсистему балансировки нагрузки, помогающую распределять нагрузку виртуальных машин. Подсистема балансировки нагрузки уровня "Стандартный" поддерживает только стандартные общедоступные IP-адреса. Вместе с подсистемой балансировки нагрузки категории "Стандартный" необходимо также создать новый стандартный общедоступный IP-адрес, настроенный в качестве интерфейсного (с именем *LoadBalancerFrontend* по умолчанию). 

1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Балансировщик нагрузки**.
2. На странице**Создание подсистемы балансировки нагрузки** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и нажмите кнопку **Создать**:
    
    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | ИМЯ                   | *myLoadBalancer*                                   |
    | type          | Общедоступные                                        |
    | SKU           | Стандартная                          |
    | Общедоступный IP-адрес | Выберите **Создать** и введите *myPublicIP* в текстовом поле. По умолчанию для общедоступного IP-адреса выбран SKU "Стандартный". В поле **Зона доступности** выберите **Избыточное между зонами**. |
    | Подписка               | Выберите свою подписку.    |
    |Группа ресурсов | Выберите **Создать**, а затем введите *myResourceGroupSLB*.    |
    | Расположение           | Выберите **Западная Европа**.                          |
    

![Создание балансировщика нагрузки](./media/load-balancer-standard-public-portal/create-load-balancer.png)
   
## <a name="create-backend-servers"></a>Создание внутренних серверов

В этом разделе описано, как создать виртуальную сеть, три виртуальные машины для внутреннего пула подсистемы балансировки нагрузки и установить службы IIS на виртуальных машинах для проверки подсистемы балансировки нагрузки.

### <a name="create-a-virtual-network"></a>Создать виртуальную сеть
1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Виртуальная сеть**, а затем введите следующие значения для виртуальной сети:
    |Параметр|Значение|
    |---|---|
    |ИМЯ|Введите *myVNet*.|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов| Щелкните **Использовать существующую**, а затем выберите *myResourceGroupSLB*.|
    |Имя подсети| Введите *myBackendSubnet*.|
    
2. Щелкните **Создать**, чтобы создать виртуальную сеть.

### <a name="create-virtual-machines"></a>Создание виртуальных машин

1. В верхней части портала Azure слева выберите **Создать ресурс** > **Вычисления** > **Windows Server 2016 Datacenter**, а затем введите следующие значения для виртуальной машины:
    1. Имя виртуальной машины: *myVM1*.        
    2. **Группа ресурсов**. Установите флажок **Использовать существующую** и выберите *myResourceGroupSLB*.
2. Последовательно выберите **ОК**.
3. Выберите значение **DS1_V2** в качестве размера виртуальной машины и нажмите кнопку **Выбрать**.
4. Введите следующие значения для параметров виртуальной машины.
    1. Убедитесь, что выбраны виртуальная сеть *myVNet* и подсеть *myBackendSubnet*.
    2. **Общедоступный IP-адрес**. В области **Создать общедоступный IP-адрес** выберите **Стандартный**, а затем нажмите кнопку **ОК**.
    3. **Группа безопасности сети**. Выберите **Дополнительно**, а затем сделайте следующее:
        1. Выберите *Группа безопасности сети (брандмауэр) и на странице **Выбрать группу безопасности сети** щелкните **Создать**. 
        2. На странице **Выбрать группу безопасности сети** в поле **Имя** введите *myNetworkSecurityGroup* в качестве имени новой группы безопасности сети, а затем нажмите кнопку **ОК**.
5. Щелкните **Отключено**, чтобы отключить диагностику загрузки.
6. Нажмите кнопку **ОК**, просмотрите параметры на странице сводки и нажмите кнопку **Создать**.
7. Создайте еще две виртуальные машины *VM2* и *VM3* с виртуальной сетью *myVnet* и *myBackendSubnet* в качестве подсети, и группой безопасности сети *myNetworkSecurityGroup*, выполнив шаги 1–6. 

### <a name="create-network-security-group-rule"></a>Создание правила группы безопасности сети

В этом разделе описано, как создать правила группы безопасности сети, чтобы разрешить входящие подключения по протоколу HTTP.

1. В меню слева щелкните **Все ресурсы**, а затем в списке ресурсов выберите группу безопасности сети **myNetworkSecurityGroup**, расположенную в группе ресурсов **myResourceGroupSLB**.
2. В разделе **Параметры** щелкните **Правила безопасности для входящего трафика**, а затем — **Добавить**.
3. Введите (выберите) следующие значения для правила безопасности для входящего трафика с именем *myHTTPRule*, чтобы разрешить входящие подключения HTTP через порт 80:
    - *Service Tag* — для **источника**;
    - *Internet* — для **тега службы источника**;
    - *80* — для **диапазонов портов назначения**;
    - *TCP* — для **протокола**;
    - *Разрешить* — для **действия**;
    - *100* — для значения **приоритета**;
    - *myHTTPRule* — для имени;
    - *Разрешить HTTP* — для описания.
4. Выберите **Добавить**.

### <a name="install-iis-on-vms"></a>Установка служб IIS на виртуальные машины

1. В меню слева щелкните **Все ресурсы** и выберите в списке ресурсов виртуальную машину **myVM1**, расположенную в группе ресурсов *myResourceGroupSLB*.
2. На странице **обзора** щелкните **Подключить**, чтобы подключиться по протоколу RDP к виртуальной машине.
3. Во всплывающем окне **Подключение к виртуальной машине** выберите **Скачать RDP-файл**, а затем откройте скачанный RDP-файл.
4. В окне **Remote Desktop Connection** (Подключение к удаленному рабочему столу) выберите **Подключиться**.
5. Войдите в виртуальную машину, используя учетные данные, указанные во время ее создания. Откроется сеанс удаленного рабочего стола с виртуальной машиной *myVM1*.
6. На рабочем столе сервера перейдите к **Средства администрирования Windows**>**Windows PowerShell**.
7. В окне PowerShell выполните следующие команды, чтобы установить сервер IIS, удалить файл по умолчанию iisstart.htm и добавить новый файл iisstart.htm с именем виртуальной машины:

   ```azurepowershell-interactive
    
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    # Add a new htm file that displays server name
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
   ```
6. Закройте сеанс RDP для *myVM1*.
7. Повторите шаги 1–6, чтобы установить IIS и добавить обновленный файл iisstart.htm на *myVM2* и *myVM3*.

## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

В этом разделе описано, как настроить параметры подсистемы балансировки нагрузки для внутреннего пула адресов, пробы работоспособности, а также указать правила балансировки нагрузки.

### <a name="create-a-backend-address-pool"></a>Создание внутреннего пула адресов

Для распределения трафика между виртуальными машинами пул внутренних адресов содержит IP-адреса виртуальных сетевых карт, подключенных к подсистеме балансировки нагрузки. Создайте внутренний пул адресов *myBackendPool*, куда будут входить виртуальные машины *VM1* и *VM2*.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** выберите **Серверные пулы** и нажмите кнопку **Добавить**.
3. На странице **Add a backend pool** (Добавление серверного пула) сделайте следующее:
   - В поле имени внутреннего пула введите *myBackEndPool*.
   - В качестве **виртуальной сети** выберите *myVNet*.
   - В разделе **Виртуальная машина** добавьте *myVM1*, *myVM2* и *my VM3*, а также соответствующие IP-адреса и выберите **Добавить**.
4. Убедитесь, что в настройках внутреннего пула подсистемы балансировки нагрузки отображаются все виртуальные машины (*myVM1*, *myVM2* и *myVM3*), а затем нажмите кнопку **ОК**.

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Чтобы балансировщик нагрузки мог следить за состоянием приложения, необходимо настроить пробу работоспособности. Проба работоспособности динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности. Создайте зонд работоспособности *myHealthProbe*, чтобы отслеживать работоспособность виртуальных машин.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** щелкните **Зонды работоспособности** и нажмите кнопку **Добавить**.
3. Для создания зонда работоспособности используйте следующие значения:
    - *myHealthProbe* — для имени зонда работоспособности;
    - **HTTP** — для типа протокола;
    - *80* — для номера порта;
    - *15* — для **интервала** между попытками выполнения зонда (в секундах);
    - *2* — для числа **порога состояния неработоспособности** или последовательных сбоев зонда, которые должны произойти, прежде чем виртуальная машина будет считаться неработоспособной.
4. Последовательно выберите **ОК**.

   ![Добавление пробы](./media/load-balancer-standard-public-portal/4-load-balancer-probes.png)

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило балансировщика нагрузки позволяет определить распределение трафика между виртуальными машинами. Вы определяете конфигурацию внешнего IP-адреса для входящего трафика и пул внутренних IP-адресов для приема трафика, а также требуемый порт источника и назначения. Создайте правило балансировки нагрузки *myLoadBalancerRuleWeb* для прослушивания порта 80 в интерфейсном сервере *FrontendLoadBalancer* и отправки сетевого трафика со сбалансированной нагрузкой во внутренний пул адресов *myBackEndPool*, также используя порт 80. 

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **Добавить**.
3. Для настройки правила балансировки нагрузки используйте следующие значения:
    - *myHTTPRule* — для имени правила балансировки нагрузки;
    - **TCP** — для типа протокола;
    - *80* — для номера порта;
    - *80* — для внутреннего порта;
    - *myBackendPool* — для имени серверного пула;
    - *myHealthProbe* — для имени зонда работоспособности;
4. Последовательно выберите **ОК**.

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки
1. Найдите общедоступный IP-адрес для подсистемы балансировки нагрузки на экране **обзора**. Выберите **Все ресурсы**, а затем щелкните **myPublicIP**.

2. Скопируйте общедоступный IP-адрес и вставьте его в адресную строку браузера. В браузере отобразится страница по умолчанию веб-сервера IIS.

      ![Веб-сервер IIS](./media/tutorial-load-balancer-standard-zonal-portal/load-balancer-test.png)

Чтобы проверить, как подсистема балансировки нагрузки распределяет трафик между тремя виртуальными машинами, на которых выполняется приложение, принудительно обновите страницу в браузере.

## <a name="remove-or-add-vms-from-the-backend-pool"></a>Добавление виртуальных машин в серверный пул и удаление их из него
На виртуальных машинах, выполняющих приложение, может потребоваться выполнить обслуживание, например установить обновления операционной системы. Для обработки большего объема трафика в приложении необходимо добавить дополнительные виртуальные машины. В этом разделе показано, как удалить или добавить виртуальную машину из балансировщика нагрузки.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** щелкните **Серверные пулы**, затем в списке серверных пулов выберите **myBackendPool**.
3. На странице **myBackendPool** в разделе **Целевые IP-конфигурации сети** щелкните значок удаления рядом с элементом **Виртуальная машина: myVM1**, чтобы удалить *VM1* из серверного пула.

Теперь *myVM1* не входит в серверный пул адресов, и вы можете выполнять для *myVM1* любые задачи обслуживания, например установить обновления программного обеспечения. На период отсутствия *VM1** вся нагрузка распределяется между *myVM2* и *myVM3*. 

Чтобы вернуть *myVM1* в серверный пул, выполните процедуру из раздела *Добавление виртуальных машин в серверный пул адресов* этой статьи.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов, подсистему балансировки нагрузки и все связанные с ними ресурсы, когда надобность в них отпадет. Для этого выберите группу ресурсов, содержащую подсистему балансировки нагрузки, и щелкните **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве описано, как создать подсистему балансировки нагрузки в службе Azure Load Balancer (цен. категории "Стандартный"), подключить к ней виртуальные машины, настроить правило трафика подсистемы балансировки нагрузки, пробу работоспособности, а также протестировать подсистему балансировки нагрузки. Также здесь показано, как удалить виртуальную машину из набора балансировки нагрузки и добавить ее во внутренний пул адресов. Чтобы узнать больше об Azure Load Balancer, ознакомьтесь с другими руководствами по этой службе.

> [!div class="nextstepaction"]
> [Руководства по Azure Load Balancer](tutorial-load-balancer-standard-public-zone-redundant-portal.md)
