---
title: "Общие сведения об исходящих подключениях в Azure | Документация Майкрософт"
description: "В этой статье рассказывается о том, как Azure обеспечивает взаимодействие виртуальных машин с общедоступными службами Интернета."
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: 
ms.assetid: 5f666f2a-3a63-405a-abcd-b2e34d40e001
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/05/2018
ms.author: kumud
ms.openlocfilehash: e1a2b4c281194ec4c70e4d9fe1bc97c5aa61436e
ms.sourcegitcommit: 059dae3d8a0e716adc95ad2296843a45745a415d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/09/2018
---
# <a name="understanding-outbound-connections-in-azure"></a>Общие сведения об исходящих подключениях в Azure

[!INCLUDE [load-balancer-basic-sku-include.md](../../includes/load-balancer-basic-sku-include.md)]


Azure предусматривает несколько различных механизмов установки исходящих подключений для клиентских развертываний.  В этой статье описаны соответствующие сценарии, а также то, когда их применять, как они работают и как ими управлять.

Развертывания в Azure могут взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов. Когда экземпляр инициирует исходящий поток к месту назначения в пространстве общедоступных IP-адресов, Azure динамически сопоставляет частный IP-адрес виртуальной машины с общедоступным IP-адресом.  После создания этого сопоставления обратный трафик исходящего потока можно также направлять по частному IP-адресу, с которого изначально отправлен поток.

Для этого Azure использует преобразование адресов исходной сети (SNAT).  Если несколько частных IP-адресов маскируются под одним общедоступным IP-адресом, Azure использует [преобразование адресов портов (PAT)](#pat), чтобы замаскировать частные IP-адреса.  Для PAT используются временные порты, которые [предварительно выделяются](#preallocatedports) в зависимости от размера пула.

Есть несколько [сценариев для исходящих подключений](#scenarios). При необходимости их можно объединять. Тщательно ознакомьтесь с этими сценариями, чтобы узнать о возможностях, ограничениях и шаблонах, применимых к вашей модели развертывания и сценарию приложения.  Просмотрите руководство по [управлению этими сценариями](#snatexhaust).

## <a name="scenarios"></a>Обзор сценариев

В Azure предусмотрены две основные модели развертывания: для Azure Resource Manager и классическая модель. При использовании [ресурсов Azure Resource Manager](#arm) подсистема балансировки нагрузки и связанные ресурсы определяются явно.  В классических развертываниях абстрагируется понятие подсистемы балансировки нагрузки, но аналогичная функция сохраняется путем определения конечных точек [облачной службы](#classic). Применимые [сценарии](#scenarios) развертывания зависят от используемой модели.

### <a name="arm"></a>Azure Resource Manager

Сейчас в Azure доступны три разных способа реализации исходящих подключений для ресурсов Azure Resource Manager.  Для [классических](#classic) развертываний предусмотрен набор соответствующих сценариев.

| Сценарий | Метод | ОПИСАНИЕ |
| --- | --- | --- |
| [1. Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с подсистемой балансировки нагрузки или без нее)](#ilpip) | SNAT, маскировка портов не используется |Azure использует общедоступный IP-адрес, назначенный IP-конфигурации сетевой карты в экземпляре.  Доступны все временные порты экземпляра. |
| [2. Общедоступная подсистема балансировки нагрузки, связанная с виртуальной машиной (без общедоступного IP-адреса уровня экземпляра на экземпляре)](#lb) | SNAT с маскировкой портов (PAT) с использованием подсистем балансировки нагрузки |Azure предоставляет общедоступные IP-адреса общедоступных подсистем балансировки нагрузки нескольким частным IP-адресам и использует временные порты этих подсистем для PAT. |
| [3. Автономная виртуальная машина (без подсистемы балансировки нагрузки, без общедоступного IP-адреса уровня экземпляра)](#defaultsnat) | SNAT с маскировкой портов (PAT) | Azure автоматически назначает общедоступный IP-адрес для SNAT, предоставляет его нескольким частным IP-адресам в группе доступности и использует временные порты общедоступного адреса.  Это резервный сценарий для первых двух. Не рекомендуется его использовать, если требуется контролировать использование адресов и управлять им. |

Если виртуальная машина не должна взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов, можно использовать группы безопасности сети (NSG), чтобы блокировать доступ.  Использование NSG подробно рассматривается в разделе [Запрет исходящих подключений](#preventoutbound).  Эта статья не охватывает рекомендации по проектированию или практические сведения о том, как создать архитектуру виртуальной сети и управлять ею без доступа ко внешней сети.

### <a name="classic"></a>Классические развертывания (облачных служб)

Сценарии для таких развертываний отвечают набору сценариев для [Azure Resource Manager](#arm) и Load Balancer (цен. категория "Базовый").

Для классической виртуальной машины доступны те же три основных сценария, что описаны для ресурсов Azure Resource Manager ([1](#ilpip), [2](#lb), [3](#defaultsnat)). В случае классической рабочей роли может быть только два сценария ([2](#lb), [3](#defaultsnat)).  Для [стратегий устранения рисков](#snatexhaust) характерны такие же отличия.

Алгоритм, используемый для [предварительного выделения временных портов](#ephemeralprots) при PAT в классических развертываниях, аналогичен для развертывания ресурсов Azure Resource Manager.  

### <a name="ilpip"></a>Сценарий 1. Виртуальная машина с общедоступным IP-адресом на уровне экземпляра

В этом случае виртуальной машине назначен общедоступный IP-адрес уровня экземпляра (ILPIP). Так как здесь рассматриваются исходящие подключения, балансировка нагрузки виртуальной машины не имеет значения.  Этот сценарий приоритетнее остальных. Виртуальная машина использует ILPIP-адрес для всех исходящих потоков.  

Маскировка портов (PAT) не используется, и виртуальная машина может использовать все временные порты.

Если приложение инициирует большое количество исходящих потоков и возникает нехватка портов для SNAT, можно назначить [ILPIP-адрес, чтобы устранить ограничения SNAT](#assignilpip). Все сведения о проблеме см. [здесь](#snatexhaust).

### <a name="lb"></a>Сценарий 2. Виртуальная машина с подсистемой балансировки нагрузки без общедоступного IP-адреса уровня экземпляра

В этом сценарии виртуальная машина — часть внутреннего пула Load Balancer.  Виртуальной машине не назначен общедоступный IP-адрес. Для ресурса Load Balancer необходимо настроить правило балансировки нагрузки для связывания общедоступного IP-адреса внешнего интерфейса с внутренним пулом. Если не выполнить эту настройку, поведение будет таким, как описано в сценарии для [автономной виртуальной машины без общедоступного IP-адреса уровня экземпляра](#defaultsnat).  Для правильной работы правила не обязательно, чтобы был прослушиватель во внутреннем пуле или зонд работоспособности.

Когда виртуальная машина с балансировкой нагрузки создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный IP-адрес интерфейса общедоступной подсистемы балансировки нагрузки. Azure использует SNAT, чтобы выполнять эту функцию, а [PAT](#pat) — чтобы выдать несколько частных IP-адресов за один общедоступный. Для определения отдельных потоков, исходящих от виртуальной машины, используются временные порты интерфейсного общедоступного IP-адреса подсистемы балансировки нагрузки. При создании исходящих потоков в ходе SNAT динамически используются [предварительно выделенные временные порты](#preallocatedports). В этом контексте временные порты, используемые для SNAT, называются портами SNAT.

Порты SNAT выделяются предварительно, как описано [здесь](#snat), и представляют собой ограниченный ресурс, который можно исчерпать. Важно понимать, как они [используются](#pat). Просмотрите раздел об [управлении при нехватке в ходе SNAT](#snatexhaust), чтобы понять, как спроектировать архитектуру и избежать этой проблемы.

Если [несколько (общедоступных) IP-адресов связаны с Load Balancer (цен. категория "Базовый")](load-balancer-multivip-overview.md), то любой из них, [но только один, можно использовать для исходящих потоков](#multivipsnat).  

Прочтите статью о [Log Analytics для Load Balancer](load-balancer-monitor-log.md) и ее разделы о [журналах оповещений о событиях для просмотра сообщений о нехватке портов при SNAT](load-balancer-monitor-log.md#alert-event-log), чтобы узнать, как отслеживать работоспособность исходящих подключений с помощью Load Balancer (цен. категория "Базовый").

### <a name="defaultsnat"></a>Сценарий 3. Автономная виртуальная машина без общедоступного IP-адреса уровня экземпляра

Виртуальная машина не является частью пула Azure Load Balancer, и ей не назначен общедоступный ILPIP-адрес. Когда виртуальная машина создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный исходный IP-адрес. Общедоступный IP-адрес, используемый для этого исходящего потока, настроить нельзя, и он не учитывается в ограничениях подписки на ресурсы общедоступного IP-адреса. Для выполнения этой функции Azure использует SNAT с маскировкой портов (для [PAT](#pat)). Эта ситуация аналогична [сценарию 2](#lb), кроме того, что нельзя управлять использованием IP-адреса.  Это резервный сценарий, на случай если не исполняются сценарии 1 и 2.  Этот сценарий не рекомендуется использовать, если необходим контроль над исходящими адресами.

Порты SNAT выделяются предварительно, как описано [здесь](#snat), и представляют собой ограниченный ресурс, который можно исчерпать. Важно понимать, как они [используются](#pat). Просмотрите раздел об [управлении при нехватке в ходе SNAT](#snatexhaust), чтобы понять, как спроектировать архитектуру и избежать этой проблемы.

### <a name="combinations"></a>Несколько объединенных сценариев

Сценарии, описанные в разделах выше, можно объединять для достижения определенного результата.  При наличии нескольких сценариев применяется такая очередность: у [сценария 1](#ilpip) приоритет над [сценарием 2](#lb) и [3](#defaultsnat) (только для Azure Resource Manager), а [сценарий 2](#lb) переопределяет [сценарий 3](#defaultsnat) (для Azure Resource Manager и классических развертываний).

Например, в развертывании Azure Resource Manager приложение в большей степени использует исходящие подключения к ограниченному числу мест назначения, но также принимает входящие потоки через интерфейс подсистемы балансировки нагрузки. В этом случае можно объединить сценарии 1 и 2, чтобы оптимизировать нагрузку.  Дополнительные шаблоны см. в разделе об [управлении при нехватке в ходе SNAT](#snatexhaust).

### <a name="multivipsnat"></a>Несколько интерфейсов для исходящих потоков

Если есть [несколько интерфейсов (общедоступных) IP-адресов](load-balancer-multivip-overview.md), которые можно использовать для исходящих потоков, Load Balancer (цен. категория "Базовый") выберет один интерфейс.  Выбор нельзя настроить, а его алгоритм следует рассматривать как случайный.  Вы можете указать определенный IP-адрес для исходящего подключения, как описано в подразделе об [объединении сценариев](#combinations).

## <a name="snat"></a>Основные сведения о SNAT и PAT

### <a name="pat"></a>SNAT с маскировкой портов (PAT)

Когда общедоступный ресурс Load Balancer связан с экземплярами виртуальной машины, источник каждого исходящего подключения перезаписывается. Источник перезаписывается из частного IP-адреса виртуальной сети в общедоступный IP-адрес внешнего интерфейса Load Balancer. В пространстве общедоступных IP-адресов поток из 5 кортежей (исходного IP-адреса, исходного порта, транспортного IP-протокола, конечного IP-адреса, конечного порта) должен быть уникальным.  Для обеспечения этого используются временные порты после перезаписи частного исходного IP-адреса, так как из одного общедоступного IP-адреса исходят несколько потоков.  Эти временные порты называются портами SNAT. 

Для одного потока к конечным IP-адресу, порту и протоколу используется один порт SNAT. При наличии нескольких потоков к одним и тем же конечным IP-адресу, порту и протоколу каждый поток использует отдельный порт SNAT. Это гарантирует уникальность потоков, отправляемых с одного и того же общедоступного IP-адреса к одним и тем же конечным IP-адресу, порту и протоколу. 

Несколько потоков, каждый из которых направляется к разным конечным IP-адресу, порту и протоколу, используют отдельный порт SNAT. Конечный IP-адрес, порт и протокол делают потоки уникальными, устраняя необходимость в дополнительных исходных портах, чтобы различать потоки в пространстве общедоступных IP-адресов.

Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока существующие потоки не освободят порты SNAT. Когда поток закрывается, подсистема балансировки нагрузки освобождает порты SNAT. Для их освобождения от простаивающих потоков используется [4-минутный период ожидания простоя](#idletimeout).

См. раздел об [управлении SNAT](#snatexhaust), чтобы получить шаблоны, позволяющие уменьшить риски возникновения условий, которые обычно приводят к нехватке портов.

### <a name="preallocatedports"></a>Предварительное выделение временных портов для SNAT с маскировкой портов (PAT)

При SNAT с маскировкой портов ([PAT](#pat)) Azure использует алгоритм, определяющий количество предварительно выделяемых доступных портов SNAT в зависимости от размера внутреннего пула.  Порты SNAT — это временные порты, доступные для конкретного общедоступного исходного IP-адреса.

Azure предварительно выделяет эти порты для конфигурации IP-адресов сетевой карты в каждой виртуальной машине. При добавлении конфигурации IP-адресов в пул порты SNAT уже выделены для нее, исходя из размера внутреннего пула. Для классических рабочих ролей порты выделяются на экземпляр роли.  Когда создаются исходящие потоки, эти порты динамически используются в [PAT](#pat) вплоть до предела выделения, а освобождаются они, когда поток закрывается или [истечет время ожидания простоя](#ideltimeout).

В таблице ниже указаны предварительно выделяемые порты SNAT для шести уровней размера внутреннего пула:

| Размер пула (экземпляры виртуальных машин) | Предварительно выделяемые порты SNAT на каждую конфигурацию IP-адресов|
| --- | --- |
| 1–50 | 1024 |
| 51–100 | 512 |
| 101–200 | 256 |
| 201–400 | 128 |
| 401–800 | 64 |
| 801–1000 | 32 |

Очень важно помнить, что количество доступных портов SNAT не преобразуется автоматически в количество подключений. Один порт SNAT можно использовать повторно для нескольких уникальных назначений. Порты используются, только если это необходимо, чтобы сделать поток уникальным. Советы по проектированию и уменьшению рисков, а также описание [PAT](#pat) см. [в этом разделе об управлении этим исчерпаемым ресурсом](#snatexhaust).

Изменение размера пула может повлиять на передачу некоторых имеющихся потоков. Если размер внутреннего пула увеличивается и он переходит на следующий уровень, половина предварительно выделенных портов освобождается при переходе. Время ожидания потоков, связанных с освобожденным портом SNAT, истечет, и их нужно будет отправить повторно. Новые попытки подключения сразу успешно завершатся, если предварительно выделенные порты доступны.

Если размер серверного пула уменьшается с размера одного уровня до следующего размера, количество доступных портов SNAT растет. В этом случае имеющиеся выделенные порты SNAT и их потоки не будут затронуты.

## <a name="snatexhaust"></a>Управление нехваткой портов SNAT (PAT)

[Временные порты](#preallocatedports) для [PAT[ — ограниченный ресурс. Это описано в разделах ](#pat)Автономная виртуальная машина без общедоступного IP-адреса уровня экземпляра](#defaultsnat) и [Виртуальная машина с подсистемой балансировки нагрузки без общедоступного IP-адреса уровня экземпляра](#lb).

При инициировании множества исходящих TCP- или UDP-подключений к одним и тем же конечным IP-адресу и порту подключения будут завершаться сбоем или же вы будете получать уведомления от службы поддержки о нехватке SNAT (выделенных [временных портов](#preallocatedports), используемых для [PAT](#pat)). У вас есть несколько вариантов устранения этой проблемы.  Ознакомьтесь с ними, чтобы выбрать доступный и подходящий вариант для своего сценария.  Возможно один или несколько вариантов помогут вам решить проблему.

Если вам непонятно поведение исходящих подключений, можно использовать статистику распределения IP-адресов (netstat) или записывать пакеты.  Такую запись можно выполнять в гостевой ОС экземпляра или с помощью [Наблюдателя за сетями](../network-watcher/network-watcher-packet-capture-manage-portal.md).

### <a name="connectionreuse"></a>Изменение приложения для повторного использования подключений 
Вы можете снизить потребность во временных портах, используемых для SNAT, повторно используя подключения в приложении.  Это особенно касается таких для протоколов, как HTTP/1.1, в которых подключения используются повторно по умолчанию.  В свою очередь, это может положительно повлиять на другие протоколы, использующие HTTP в качестве транспорта (например, REST).  Повторное использование всегда лучше, чем отдельные, атомарные TCP-подключения для каждого запроса. Оно позволяет повысить производительность и эффективность транзакций TCP.

### <a name="connection pooling"></a>Изменение приложения для использования пулов подключений
Можно использовать в приложении схему пула подключений, при которой внутренний механизм распределяет запросы по фиксированному набору подключений (каждое из которых повторно используется, если это возможно).  Этого ограничивает количество используемых временных портов и делает среду более предсказуемой.  Это может также повысить пропускную способность запросов, позволяя одновременно выполнять несколько операций, когда отдельное подключение блокируется, ожидая результата операции.  Возможно, пулы подключений уже существуют в платформе, которая используется вами для разработки приложения или параметров конфигурации приложения.  Их можно объединить с повторным использованием подключений. В этом случае для обработки нескольких запросов можно будет использовать фиксированное, прогнозируемое число портов для одних и тех же конечных IP-адреса и порта, а также воспользоваться преимуществами повышенной эффективности транзакций TCP, сокращающей задержки и использование ресурсов.  Транзакции UDP также могут предоставлять преимущества, так как возможность изменить число потоков UDP позволяет избежать нехватки и управлять использованием портов SNAT.

### <a name="retry logic"></a>Изменение приложения для использования менее "жесткой" логики повторных попыток
При нехватке [предварительно выделенных временных портов](#preallocatedports) для [PAT](#pat) или сбоях приложения строгая логика повтора или логика повтора методом подбора без логики отхода и времени сохранения не позволяет устранить проблему. Вы можете снизить потребность во временных портах, используя менее "жесткую" логику повторных попыток.   Для временных портов установлено время ожидания простоя 4 минуты (не регулируется) и если повторные попытки слишком частые, нехватка будет наблюдаться в любом случае.  Поэтому знать, как и как часто приложение повторяет транзакции, очень важно для проектирования.

### <a name="assignilpip"></a>Назначение общедоступного IP-адреса на уровне экземпляра для каждой виртуальной машины
При таком изменении назначается [общедоступный IP-адрес на уровне экземпляра для виртуальной машины](#ilpip).  Все временные порты общедоступного IP-адреса, используемые для каждой виртуальной машины, доступны для каждой из них (в отличие от сценариев, где временные порты общедоступного IP-адреса используются совместно со всеми виртуальными машинами, связанными с соответствующим внутренним пулом).  Существуют преимущества и недостатки, которые необходимо учитывать, например дополнительные затраты на общедоступные IP-адреса и возможное влияние добавления в список разрешений большого количества отдельных IP-адресов.

>[!NOTE] 
>Такая возможность недоступна для рабочих ролей.

### <a name="idletimeout"></a>Использование проверки активности для сброса времени ожидания простоя исходящих подключений

Для исходящих подключений задано время ожидания простоя 4 минуты. Это время не регулируется. Тем не менее вы можете использовать проверку активности транспортного уровня (т. е. TCP-подключений) или уровня приложения, чтобы обновлять простаивающие потоки и сбрасывать время ожидания, если требуется.

## <a name="discoveroutbound"></a>Обнаружение общедоступного IP-адреса, используемого виртуальной машиной
Существует много способов определить общедоступный исходный IP-адрес исходящего подключения. OpenDNS — это служба, которая может показать общедоступный IP-адрес виртуальной машины. С помощью команды nslookup можно отправить к сопоставителю OpenDNS запрос DNS для имени myip.opendns.com. Служба возвращает исходный IP-адрес, который был использован для отправки запроса. При выполнении следующего запроса, поступившего с виртуальной машины, ответ будет содержать общедоступный IP-адрес, используемый для этой виртуальной машины.

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventoutbound"></a>Запрет исходящих подключений
Иногда создание виртуальной машиной исходящих потоков может быть нежелательным. Кроме того, вам может понадобиться ограничить пункты назначения, доступные для исходящих потоков или назначения, инициирующие входящие потоки. В таком случае можно использовать [группы безопасности сети (NSG)](../virtual-network/virtual-networks-nsg.md), чтобы управлять пунктами назначений, доступными для виртуальной машины, а также выбором общедоступных назначений, способных инициировать входящие потоки. При использовании NSG для виртуальной машины с балансировкой нагрузки необходимо обратить внимание на [теги по умолчанию](../virtual-network/virtual-networks-nsg.md#default-tags) и [правила по умолчанию](../virtual-network/virtual-networks-nsg.md#default-rules).

Следует убедиться, что виртуальная машина может получать запросы проверки состояния работоспособности из Azure Load Balancer. Если NSG блокирует такие запросы от тега по умолчанию AZURE_LOADBALANCER, запрос завершается сбоем, а виртуальная машина помечается как отключенная. Подсистема балансировки нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения об [Azure Load Balancer уровня "Базовый"](load-balancer-overview.md).
- Узнайте больше о [группах безопасности сети](../virtual-network/virtual-networks-nsg.md).
- Дополнительные сведения о некоторых других ключевых [сетевых возможностях](../networking/networking-overview.md) Azure.
