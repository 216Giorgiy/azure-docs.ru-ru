<properties 
   pageTitle="Обзор подсистемы балансировки нагрузки | Microsoft Azure"
   description="Обзор функций подсистемы балансировки нагрузки Azure, ее архитектуры и реализации. Эта статья помогает понять принципы работы подсистемы балансировки нагрузки и использовать ее в облаке."
   services="load-balancer"
   documentationCenter="na"
   authors="joaoma"
   manager="adinah"
   editor="tysonn" />
<tags 
   ms.service="load-balancer"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="10/16/2015"
   ms.author="joaoma" />


# Что такое балансировщик нагрузки Azure?
 
Подсистема балансировки нагрузки Azure обеспечивает высокую доступность и производительность сети для приложения. Это подсистема балансировки нагрузки на уровне 4 (TCP, UDP), распределяющая входящий трафик между работоспособными экземплярами службы в облачных службах или виртуальных машинах, определенных в наборе балансировки нагрузки.
 
Ее можно настроить для выполнения таких функций:

- балансировка нагрузки входящего интернет-трафика виртуальных машин. Мы называем это [балансировкой нагрузки с доступом к Интернету](load-balancer-internet-overview.md);
- балансировка нагрузки трафика между виртуальными машинами в виртуальной сети, между виртуальными машинами в облачных службах или между локальными компьютерами и виртуальными машинами в распределенной виртуальной сети. Мы называем это [внутренней балансировкой нагрузки (ILB)](load-balancer-internal-overview.md);
- 	перенаправление внешнего трафика к определенному экземпляру виртуальной машины.


## Функции подсистемы балансировки нагрузки

### Подсистема балансировки нагрузки на уровне 4 с распределением на основе хэша

Подсистема балансировки нагрузки Azure использует алгоритм распределения на основе хэша. По умолчанию используется хэш 5 кортежей (исходный IP-адрес, порт источника, IP-адрес назначения, порт назначения, тип протокола) для сопоставления трафика с доступными серверами. Он позволяет закреплять IP-адреса только в рамках сеанса транспорта. Пакеты в одном сеансе TCP или UDP будут направляться на один экземпляр IP-адреса центра обработки данных (DIP) в конечной точке с балансировкой нагрузки. Когда клиент закрывает и снова открывает подключение или начинает новый сеанс с того же исходного IP-адреса, порт источника изменяется. Это может привести к перенаправлению трафика к другой конечной точке DIP.


См. дополнительную информацию о [режиме распределения балансировки нагрузки](load-balancer-distribution-mode.md).

![подсистема балансировки нагрузки на основе хэша](./media/load-balancer-overview/load-balancer-distribution.png)

### Перенаправление портов

Подсистема балансировки нагрузки Azure обеспечивает контроль над управлением входящим обменом данными, таким как трафик от узлов в Интернете или виртуальных машин в других облачных службах или виртуальных сетях. Этот контроль представлен конечной точкой (также известной как входная конечная точка).

Конечная точка прослушивает общедоступный порт и перенаправляет трафик на внутренний порт. Вы можете сопоставлять одни и те же порты для внутренних или внешних конечных точек или использовать для них другой порт. Например, можно настроить веб-сервер так, чтобы он прослушивал порт 81, а порт 80 использовался для сопоставления общедоступных конечных точек. При создании общедоступной конечной точки создается подсистема балансировки нагрузки Azure.

Конечные точки на виртуальной машине, создаваемой на портале управления Azure, по умолчанию используются и настраиваются для протокола удаленного рабочего стола (RDP) и трафика удаленного сеанса Windows PowerShell. Эти конечные точки позволяют удаленно управлять виртуальной машиной через Интернет.


### Автоматическая перенастройка для горизонтального и вертикального масштабирования

Подсистема балансировки нагрузки Azure мгновенно перенастраивается при горизонтальном или вертикальном масштабировании экземпляров (из-за увеличения числа экземпляров для веб-ролей или рабочих ролей или размещения дополнительных виртуальных машин в одном наборе балансировки нагрузки).


### Мониторинг службы
Подсистема балансировки нагрузки Azure предлагает возможность проверки работоспособности различных экземпляров сервера. Если зонд не отвечает, подсистема балансировки нагрузки Azure прекращает отправлять новое подключение неработоспособным экземплярам. Существующие подключения не затрагиваются.

Существует три типа зондов:
 
- Зонд гостевого агента (только на виртуальных машинах PaaS). Подсистема балансировки нагрузки Azure применяет гостевой агент в виртуальной машине, выполняет прослушивание и дает ответ HTTP 200 OK, только когда экземпляр находится в состоянии «Готов» (т. е. экземпляр не находится в состоянии «Занят», «Перезапуск», «Остановка» и т. д.). Если гостевой агент не дает ответ HTTP 200 OK, подсистема балансировки нагрузки Azure отмечает экземпляр как не отвечающий и перестает отправлять ему трафик. Подсистема балансировки нагрузки Azure продолжает проверять связь с экземпляром, и, если гостевой агент передаст ответ с кодом HTTP 200, подсистема снова станет направлять трафик к этому экземпляру. При использовании веб-роли код веб-сайта обычно выполняется в процессе w3wp.exe, который не находится под наблюдением структуры Azure или гостевого агента, а это значит, что ошибки в w3wp.exe (например, ответы с кодом HTTP 500) не будут сообщены агенту и подсистема балансировки нагрузки не будет знать, что нужно перестать использовать экземпляр.

- Пользовательские зонды HTTP. Пользовательский зонд подсистемы балансировки нагрузки переопределяет зонд гостевого агента по умолчанию и позволяет создать собственную пользовательскую логику для определения работоспособности экземпляра роли. Подсистема балансировки нагрузки будет регулярно зондировать конечную точку (по умолчанию каждые 15 секунд), и экземпляр будет рассматриваться как работоспособный, если он дает ответ TCP ACK или HTTP 200 за определенное время ожидания (по умолчанию 31 секунда). Это может оказаться удобным при реализации собственной логики остановки использования экземпляров для подсистемы балансировки нагрузки, например давать ответ, отличный от HTTP 200, если экземпляр потребляет более 90 % ресурсов ЦП. Для веб-ролей, использующих w3wp.exe, вы также получаете автоматический мониторинг веб-сайта, так как сбои на нем вернут при зондировании состояние, отличное от HTTP 200.

- Пользовательские зонды TCP. Зонды TCP зависят от успешности установки сеанса TCP к определенному порту зонда.

Дополнительную информацию см. в статье о [зондах работоспособности в подсистеме балансировки нагрузки](https://msdn.microsoft.com/library/azure/jj151530.aspx).

### Исходящее преобразование сетевых адресов (SNAT)


Весь исходящий трафик из вашей службы в Интернет проходит через исходящее преобразование сетевых адресов (SNAT) с использованием виртуального IP-адреса для входящего трафика. SNAT предоставляет такие важные преимущества:

- упрощение обновления и аварийного восстановления служб, так как виртуальный IP-адрес можно динамически сопоставить с другим экземпляром службы;

- упрощение управления списком управления доступом, так как его можно выразить в контексте виртуальных IP-адресов, и поэтому не вносить никаких изменений при горизонтальном или вертикальном масштабировании службы, а также ее повторном развертывании.

Конфигурация подсистемы балансировки нагрузки Azure поддерживает полный конусный NAT для протокола UDP. Полный конусный NAT — это тип NAT, где порт разрешает входящие подключения от любого внешнего узла (в ответ на исходящий запрос).

![SNAT](./media/load-balancer-overview/load-balancer-snat.png)


>[AZURE.NOTE]Обратите внимание, что для каждого нового исходящего подключения, инициированного виртуальной машиной, подсистема балансировки нагрузки Azure также выделяет исходящий порт. Внешний узел увидит трафик в виде «виртуальный IP-адрес: выделенный порт». Если в сценариях требуется большое количество исходящих подключений, мы советуем использовать в виртуальных машинах общедоступные IP-адреса уровня экземпляра для выделения исходящих IP-адресов для исходящего преобразования сетевых адресов (SNAT). Это позволит снизить риск нехватки портов.
>
>Максимальное число портов для использования виртуальным IP-адресом или ILPIP-адресом — 64 тыс. Это стандартное ограничение TCP.


**Поддержка нескольких IP-адресов с балансировкой нагрузки для виртуальных машин**

Вы можете назначить несколько общедоступных IP-адресов с балансировкой нагрузки нескольким виртуальным машинам. Благодаря этому можно разместить несколько веб-сайтов SSL и/или несколько прослушивателей групп доступности AlwaysОn SQL в одном и том же наборе виртуальных машин. Дополнительную информацию см. в разделе [Несколько виртуальных IP-адресов для облачной службы](load-balancer-multivip.md).

****Развертывания на основе шаблона с помощью диспетчера ресурсов Azure** Диспетчер ресурсов Azure представляет собой новую платформу управления для служб в Azure. Теперь подсистемой балансировки нагрузки Azure можно управлять с помощью интерфейсов API и инструментов на основе диспетчера ресурсов Azure. Дополнительную информацию о диспетчере ресурсов Azure см. в разделе [Упрощение IaaS благодаря диспетчеру ресурсов Azure](http://azure.microsoft.com/blog/2015/04/29/iaas-just-got-easier-again/).


## Дальнейшие действия

[Обзор подсистемы балансировки нагрузки, доступной в Интернете](load-balancer-internet-overview.md)

[Обзор внутренней подсистемы балансировки нагрузки](load-balancer-internal-overview.md)

[Приступая к работе с подсистемой балансировки нагрузки, доступной в Интернете](load-balancer-internet-getstarted.md)
 

<!---HONumber=Nov15_HO1-->