<properties
   pageTitle="Обзор подсистемы балансировки нагрузки | Microsoft Azure"
   description="Обзор функций балансировщика нагрузки Azure, его архитектуры и реализации. Эта статья помогает понять принципы работы балансировщика нагрузки и использовать его в облаке."
   services="load-balancer"
   documentationCenter="na"
   authors="joaoma"
   manager="adinah"
   editor="tysonn" />
<tags
   ms.service="load-balancer"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="12/09/2015"
   ms.author="joaoma" />


# Что такое балансировщик нагрузки Azure?

Балансировщик нагрузки Azure обеспечивает высокую доступность и производительность сети для приложений. Это подсистема балансировки нагрузки на уровне 4 (TCP, UDP), распределяющая входящий трафик между работоспособными экземплярами службы в облачных службах или виртуальных машинах, определенных в наборе балансировки нагрузки.

Ее можно настроить для выполнения таких функций:

- балансировка нагрузки входящего интернет-трафика виртуальных машин. Мы называем это [балансировкой нагрузки с доступом к Интернету](load-balancer-internet-overview.md).
- Балансировка нагрузки трафика между виртуальными машинами в виртуальной сети, между виртуальными машинами в облачных службах или между локальными компьютерами и виртуальными машинами в распределенной виртуальной сети. Мы называем это [внутренней балансировкой нагрузки](load-balancer-internal-overview.md).
- Перенаправление внешнего трафика к определенному экземпляру виртуальной машины.

## Балансировщик нагрузки в двух моделях развертывания

Чтобы все ресурсы облака были доступны через Интернет, им необходимы общедоступные IP-адреса. В облачной инфраструктуре Microsoft Azure в ресурсах используются немаршрутизируемые IP-адреса. Инфраструктура использует преобразования сетевых адресов (NAT) с общедоступными IP-адресов для связи с Интернетом.

### Классическая модель Azure

В классической модели развертывания Azure облачной службе назначаются общедоступный IP-адрес и полное доменное имя. Виртуальные машины, развернутые в пределах границ облачной службы, можно сгруппировать для использования балансировщика нагрузки. Балансировщик нагрузки Azure будет выполнять преобразование портов и балансировать нагрузку сетевого трафика, используя общедоступный IP-адрес для облачной службы.

В классической модели развертывания преобразование портов выполняется с помощью конечных точек, которые связывают общедоступный порт общедоступного IP-адреса и локальный порт (отношение "один-к-одному"), назначенный для отправки трафика на конкретную виртуальную машину.

Балансировка нагрузки выполняется с помощью установленных конечных точек балансировщика нагрузки. Эти конечные точки имеют отношение "один-ко-многим" между общедоступными IP-адресами и локальными портами, назначенными всем виртуальным машинам в наборе, которые будут воспринимать сбалансированный сетевой трафик.

Меткой домена для общедоступного IP-адреса, который балансировщик нагрузки будет использовать в этой модели развертывания, будет `<cloud service name>.cloudapp.net`.

Далее приведено графическое представление балансировщика нагрузки в классической модели развертывания.

![Балансировщик нагрузки в классической модели развертывания](./media/load-balancer-overview/asm-lb.png)

### Диспетчер ресурсов Azure

Концепция балансировщика нагрузки для модели развертывания диспетчера ресурсов Azure изменяется, поскольку в этом случае облачная служба для создания балансировщика нагрузки не нужна.

В диспетчере ресурсов Azure общедоступный IP-адрес — это собственный ресурс диспетчера, и его можно связать с меткой домена или DNS-именем. В этом случае общедоступный IP-адрес связывается с ресурсом балансировщика нагрузки. Таким образом, правила балансировщика нагрузки и правила для входящих подключений NAT будут использовать общедоступный IP-адрес в качестве конечной точки Интернета для ресурсов, получающих сбалансированный сетевой трафик.

Ресурс сетевого интерфейса (NIC) содержит конфигурацию IP-адреса (частного или общедоступного) виртуальной машины. После добавления сетевого интерфейса к пулу IP-адресов серверной части балансировщика нагрузки балансировщик нагрузки начинает отправлять сбалансированный сетевой трафик на основе созданных правил балансировки нагрузки.

Далее приведено графическое представление балансировщика нагрузки в диспетчере ресурсов.

![Балансировщик нагрузки в диспетчере ресурсов](./media/load-balancer-overview/arm-lb.png)

## Функции подсистемы балансировки нагрузки

### Распространение на основе хэша

Балансировщик нагрузки Azure использует алгоритм распределения на основе хэша. По умолчанию используется хэш 5 кортежей (исходный IP-адрес, порт источника, IP-адрес назначения, порт назначения, тип протокола) для сопоставления трафика с доступными серверами. Он позволяет закреплять IP-адреса только в рамках сеанса транспорта. Пакеты в одном сеансе TCP или UDP будут направляться на один экземпляр IP-адреса центра обработки данных (DIP) в конечной точке с балансировкой нагрузки. Когда клиент закрывает и снова открывает подключение или начинает новый сеанс с того же исходного IP-адреса, порт источника изменяется. Это может привести к перенаправлению трафика к другой конечной точке DIP.


Дополнительные сведения см. в статье [Режим распределения балансировщика нагрузки](load-balancer-distribution-mode.md).

На этом графике показано распределение на основе хэша.

![Распространение на основе хэша](./media/load-balancer-overview/load-balancer-distribution.png)

### Перенаправление портов

Балансировщик нагрузки Azure позволяет контролировать процесс управления входящей связью. Это взаимодействие может включать в себя трафик с узлов Интернета или виртуальных машин в других облачных службах или виртуальных сетях. Этот контроль представлен конечной точкой (также известной как входная конечная точка).

Конечная точка прослушивает общедоступный порт и перенаправляет трафик на внутренний порт. Вы можете сопоставлять одни и те же порты для внутренних или внешних конечных точек или использовать для них другой порт. Например, можно настроить веб-сервер так, чтобы он прослушивал порт 81, а порт 80 использовался для сопоставления общедоступных конечных точек. При создании общедоступной конечной точки создается экземпляр балансировщика нагрузки Azure.

Конечные точки на виртуальной машине, создаваемой на портале Azure, по умолчанию используются и настраиваются для протокола удаленного рабочего стола (RDP) и трафика удаленного сеанса Windows PowerShell. Эти конечные точки позволяют удаленно управлять виртуальной машиной через Интернет.


### Автоматическая перенастройка

Балансировщик нагрузки Azure мгновенно перенастраивает сам себя при горизонтальном и вертикальном масштабировании экземпляров. Например, такая перенастройка может произойти при увеличении количества экземпляров для веб-роли и рабочей роли или при добавлении дополнительных виртуальных машин в тот же набор с балансировкой нагрузки.


### Мониторинг службы
Балансировщик нагрузки Azure предлагает возможность проверки работоспособности различных экземпляров сервера. Если проверка не отвечает, балансировщик нагрузки Azure прекращает отправлять новое подключение неработоспособным экземплярам. Существующие подключения не затрагиваются.

Существует три типа проверки:

- Проверка гостевого агента (только на виртуальных машинах PaaS). Балансировщик нагрузки Azure использует гостевой агент внутри виртуальной машины. Он выполняет прослушивание и дает ответ HTTP 200 OK только в том случае, если экземпляр находится в состоянии готовности (т. е. экземпляр не в состоянии "Занят", "Перезапуск" или "Остановка"). Если гостевой агент не дает ответ HTTP 200 OK, балансировщик нагрузки Azure помечает экземпляр как неотвечающий и перестает отправлять ему трафик. Балансировщик нагрузки будет продолжать проверять связь с экземпляром. Если гостевой агент дает ответ HTTP 200, балансировщик нагрузки снова направит трафик к этому экземпляру. При использовании веб-роли код веб-сайта обычно выполняется в процессе w3wp.exe, который не отслеживается структурой Azure или гостевым агентом. Это означает, что ошибки в процессе w3wp.exe (например ответы HTTP 500) не будут передаваться на гостевой агент и балансировщик нагрузки не будет знать, что экземпляр перестает использоваться.

- Пользовательская проверка HTTP. Пользовательская проверка балансировщика нагрузки переопределяет проверку (гостевого агента) по умолчанию. Ее можно использовать для создания собственной настраиваемой логики для определения работоспособности экземпляра роли. Балансировщик нагрузки будет регулярно проверять конечную точку (по умолчанию каждые 15 секунд). Экземпляр будет рассматриваться как работоспособный, если он дает ответ TCP ACK или HTTP 200 за определенное время ожидания (по умолчанию 31 секунда). Это может быть полезно для реализации собственной логики для удаления экземпляров из смены балансировщика нагрузки. Например, можно настроить экземпляр для возвращения состояния, отличного от 200, если загрузка ЦП экземпляра превышает 90 %. Для веб-ролей, использующих w3wp.exe, вы также получаете автоматический мониторинг веб-сайта, так как ошибки в коде веб-сайта вернут при проверке состояние, отличное от 200.

- Пользовательская проверка TCP. Зонды TCP зависят от успешности установки сеанса TCP к определенному порту зонда.

Дополнительную информацию см. в статье о [проверке работоспособности в балансировщике нагрузки](https://msdn.microsoft.com/library/azure/jj151530.aspx).

### Исходящее преобразование сетевых адресов (SNAT)


Весь исходящий трафик из вашей службы в Интернет проходит через исходящее преобразование сетевых адресов (SNAT) с использованием виртуального IP-адреса для входящего трафика. SNAT предоставляет такие важные преимущества:

- упрощение обновления и аварийного восстановления служб, так как виртуальный IP-адрес можно динамически сопоставить с другим экземпляром службы;

- упрощение управления списком управления доступом, так как его можно выразить в контексте виртуальных IP-адресов и поэтому не вносить никаких изменений при горизонтальном или вертикальном масштабировании службы, а также ее повторном развертывании.

Конфигурация балансировщика нагрузки Azure поддерживает полный конусный NAT для протокола UDP. Полный конусный NAT — это тип NAT, где порт разрешает входящие подключения от любого внешнего узла (в ответ на исходящий запрос).


>[AZURE.NOTE]Для каждого нового исходящего подключения, инициированного виртуальной машиной, балансировщик нагрузки Azure также выделяет исходящий порт. Внешний узел увидит трафик в виде "виртуальный IP-адрес: выделенный порт". Если в сценариях требуется большое количество исходящих подключений, рекомендуется, чтобы виртуальные машины использовали общедоступные IP-адреса уровня экземпляра и могли иметь выделенный исходящий IP-адрес для SNAT. Это позволит снизить риск нехватки портов.
>
>Максимальное число портов для использования виртуальным IP-адресом или ILPIP-адресом — 64 000. Это стандартное ограничение TCP.


**Поддержка нескольких IP-адресов с балансировкой нагрузки для виртуальных машин**

Вы можете назначить несколько общедоступных IP-адресов с балансировкой нагрузки нескольким виртуальным машинам. Благодаря этому можно разместить несколько веб-сайтов SSL и/или несколько прослушивателей групп доступности AlwaysОn SQL Server в одном и том же наборе виртуальных машин. Дополнительную информацию см. в разделе [Несколько виртуальных IP-адресов для облачной службы](load-balancer-multivip.md).

**Развертывания на основе шаблона с помощью диспетчера ресурсов Azure**

Диспетчер ресурсов Azure представляет собой новую платформу управления для служб в Azure. Теперь балансировщиком нагрузки Azure можно управлять с помощью интерфейсов API и инструментов на основе диспетчера ресурсов Azure. Дополнительную информацию о диспетчере ресурсов Azure см. в разделе [Упрощение IaaS благодаря диспетчеру ресурсов Azure](http://azure.microsoft.com/blog/2015/04/29/iaas-just-got-easier-again/).


## Дальнейшие действия

[Обзор балансировщика нагрузки с доступом к Интернету](load-balancer-internet-overview.md)

[Обзор внутренней подсистемы балансировки нагрузки](load-balancer-internal-overview.md)

[Начало работы по созданию балансировщика нагрузки для Интернета](load-balancer-internet-getstarted.md)

<!---HONumber=AcomDC_0114_2016-->