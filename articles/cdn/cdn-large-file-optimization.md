---
title: "Оптимизация загрузки больших файлов через Azure CDN"
description: "Подробный обзор оптимизации загрузки больших файлов"
services: cdn
documentationcenter: 
author: smcevoy
manager: erikre
editor: 
ms.assetid: 
ms.service: cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/16/2017
ms.author: v-semcev
ms.translationtype: Human Translation
ms.sourcegitcommit: 857267f46f6a2d545fc402ebf3a12f21c62ecd21
ms.openlocfilehash: 27e202b05f86eeee7071f3fae145caeba3d66827
ms.contentlocale: ru-ru
ms.lasthandoff: 06/28/2017

---
# <a name="large-file-download-optimization-via-azure-cdn"></a>Оптимизация загрузки больших файлов через Azure CDN

Размеры файлов содержимого, поставляемого через Интернет, стабильно увеличивались из-за расширенной функциональности, улучшенных графических изображений и расширенного мультимедийного содержимого. Такой рост определяется многими факторами, включая высокоскоростное проникновение, запоминающие устройства по значительно сниженной цене, увеличение количества видео с высоким разрешением, устройства, подключенные к Интернету (IoT), и т. д.  Для потребителей критически важно предоставлять более быстрый и эффективный механизм загрузки таких больших файлов. 

Существует ряд проблем, связанных с передачей больших файлов. Во-первых, среднее время загрузки больших файлов может оказаться настолько существенным, что многие приложения могут не справиться с последовательной загрузкой всех данных. В некоторых случаях приложения могут загрузить последнюю часть файла, а не первую. Таким образом, когда запрашивается только небольшой объем файла, или пользователь приостанавливает загрузку, это может привести к тому, что загрузка завершится сбоем или будет отложена до того времени, пока из источника не будет получен целый файл с помощью CDN. 

Во-вторых, с увеличением количества больших файлов в Интернете пользователи часто наблюдают, что задержка между пользователем и файлом в конечном итоге определяет пропускную способность или скорость, при которых они могут просматривать содержимое. Кроме того, проблемы нагрузки на сеть и производительности дальше влияют на пропускную способность, а в совокупности со значительной дистанцией между сервером и пользователем создают дополнительные условия для потери пакетов, продолжая снижать качество. Снижение качества, вызванное ограниченной пропускной способностью и увеличенной частотой потери пакетов, может привести к значительному увеличению времени ожидания завершения загрузки файла. 

В конечном итоге доставка многих больших файлов целиком завершается сбоем. Пользователи могут отменить загрузку в середине процесса или просмотреть только первые несколько минут длинного видео MP4. Таким образом, многим компаниям поставки мультимедиа и программного обеспечения удобнее доставлять только часть файла, запрошенного пользователем. В таком случае только запрошенные фрагменты будут эффективно распространяться в самые отдаленные точки Интернета, что снизит исходящий трафик источника и, соответственно, выделения памяти и нагрузку операций ввода-вывода на сервере-источнике. 

Сегодня Azure CDN от Akamai предоставляет технологию, которая идеально подходит для эффективной доставки больших файлов пользователям по всему миру с минимальными задержками при сниженной нагрузке на серверы-источники. Эта технология доступна с помощью функции "Оптимизировано для" в конечной точке Azure CDN, созданной в профиле Azure CDN ценовой категории Akamai уровня "Стандартный".

## <a name="configuring-cdn-endpoint-to-optimize-delivery-of-large-files"></a>Настройка конечной точки CDN для оптимизации доставки больших файлов

Вы можете настроить конечную точку CDN, чтобы оптимизировать доставку больших файлов через портал Azure, выбрав параметр "Скачивание больших файлов" в свойствах "Оптимизировано для" во время создания конечной точки. Для этого можно также использовать наши интерфейсы REST API или любые клиентские пакеты SDK. На снимке экрана ниже показан процесс на портале Azure.

![Новая конечная точка CDN](./media/cdn-large-file-optimization/01_Adding.png)  
 
*Рис. 1. Добавление новой конечной точки CDN из профиля CDN*
 
![Выбор LFO](./media/cdn-large-file-optimization/02_Creating.png)

*Рис. 2: Создание конечной точки CDN с помощью выбранного параметра оптимизации загрузки большого файла*

После создания конечной точки CDN будет применена оптимизация для всех больших файлов, соответствующих определенным условиям. В следующем разделе это описано подробно.

## <a name="optimizing-for-delivery-of-large-files-with-azure-cdn-from-akamai"></a>Оптимизация доставки больших файлов с помощью Azure CDN от Akamai

Для Azure CDN от Akamai можно использовать функцию типа оптимизации больших файлов для включения оптимизации сети и конфигураций, с помощью которых доставка больших файлов осуществляется быстрее и надежнее. Общая веб-доставка с Akamai способна только кэшировать файлы размером менее 1,8 ГБ и туннелировать (не кэшировать) файлы размером до 150 ГБ, а оптимизация больших файлов позволяет кэшировать файлы размером до 150 ГБ.

Оптимизация больших файлов является эффективной, когда удовлетворены определенные условия в отношении функционирования сервера-источника, типов запрашиваемых файлов и их размера. Прежде чем мы детально рассмотрим этот вопрос, важно ознакомиться с общим обзором процесса оптимизации. 

### <a name="object-chunking"></a>Фрагментирование объекта 

Azure CDN от Akamai использует подход фрагментирования вызываемого объекта: при запросе большого файла CDN получает небольшие фрагменты файла из источника. Когда пограничный сервер CDN или POP-сервер получает запрос файла диапазона байтов или полного диапазона от пользователя, сначала проверяется, есть ли тип файла в списке типов файла, поддерживаемых для этой оптимизации, и соответствует ли он требованиям к размеру файлов. Если размер файла превышает 10 МБ, пограничный сервер CDN начинает запрос файла из исходного сервера в блоках по 2 МБ. Когда блок поступает на пограничный сервер CDN, он кэшируется и сразу же обрабатывается для пользователя, в то время как CDN параллельно "предварительно извлекает" следующий блок. Такое предварительное извлечение обеспечивает скорый доступ к содержимому, предварительно придерживая один блок для пользователя и уменьшая таким образом задержку. Этот процесс продолжается до загрузки всего файла (если пользователь запросил весь файл), пока не станут доступны все запрошенные диапазоны байтов (если пользователь запросил диапазоны байтов) или до завершения соединения клиентом. 

Ознакомьтесь с [RFC 7233](https://tools.ietf.org/html/rfc7233), чтобы узнать больше о запросе диапазона байтов.

CDN кэширует все блоки по мере их получения и не требует кэширования целого файла в кэше CDN. Последующие запросы файла или диапазонов байтов будут обрабатываться из кэша CDN, а также будет использоваться предварительное извлечение, чтобы запросить блоки из источника, если в CDN кэшированы не все блоки. Как можно увидеть, эта оптимизация использует сервер-источник, поддерживающий запросы диапазонов байтов. _Если сервер-источник не поддерживает запросы диапазонов байтов, оптимизация будет неэффективна._ 

### <a name="caching"></a>Caching
Оптимизация больших файлов использует другое время завершения срока действия кэширования по умолчанию в сравнении с общим режимом доставки. Существует разница между положительным и отрицательным кэшированием на основе кодов ответов HTTP. Если источник задает время, используя время окончания срока действия через заголовок Cache-Control или Expires в ответе, CDN всегда учитывает это значение. Если же источник не указывает время, а файл соответствует списку условий для типа и размера файла для этого типа оптимизации, тогда для оптимизации большого файла CDN будет использовать значения по умолчанию. В противном случае CDN будет использовать значения по умолчанию для оптимизации типа общей веб-доставки.

 
|    | Общая веб-доставка | Оптимизация больших файлов 
--- | --- | --- 
Кэширование: положительное <br> HTTP 200, 203, 300, <br> 301, 302 и 410 | 7 дней |1 день  
Кэширование: отрицательное <br> HTTP 204, 305, 404 <br> и 405 | Нет | 1 с 

### <a name="dealing-with-origin-failure"></a>Устранение сбоев источника

Для типа оптимизации больших файлов исходная продолжительность считывания времени ожидания увеличивается от 2 секунд при общей веб-доставке до 2 минут, чтобы учесть (и, соответственно, избежать) возможность преждевременного истечения времени ожидания подключения для файлов большего размера.

Как и в случае оптимизации типа общей веб-доставки после истечения времени ожидания подключения CDN повторит попытку подключения несколько раз, прежде чем отправить клиенту ошибку времени ожидания шлюза 504. 

### <a name="conditions-for-large-file-optimization"></a>Условия для оптимизации больших файлов

В следующей таблице перечислен набор критериев, которые необходимо удовлетворить для этой оптимизации:

Условие | Значения 
--- | --- 
Поддерживаемые типы файлов | 3g2, 3gp, asf, avi, bz2, dmg, exe, f4v, flv, <br> gz, hdp, iso, jxr, m4v, mkv, mov, mp4, <br> mpeg, mpg, mts, pkg, qt, rm, swf, tar, <br> tgz, wdp, webm, webp, wma, wmv, zip  
Минимальный размер файла | 10 МБ 
Максимальный размер файла | 150 ГБ 
Характеристики сервера-источника | Должен поддерживать запросы диапазонов байтов 

## <a name="optimizing-for-delivery-of-large-files-with-azure-cdn-from-verizon"></a>Оптимизация доставки больших файлов с помощью Azure CDN от Verizon

Azure CDN от Verizon может доставлять большие файлы без ограничения размера файла, а также содержит различные функции, обеспечивающие по умолчанию более быструю доставку больших файлов.

### <a name="complete-cache-fill"></a>Завершение заполнения кэша

Azure CDN от Verizon содержит функцию по умолчанию, которая называется завершением заполнения кэша: CDN извлечет файл в кэш в случае прерывания или потери исходного запроса. 

Эта функция полезна для больших ресурсов, когда пользователи, как правило, не скачивают их от начала до конца (например, поэтапная загрузка видео). В результате эта функция включена по умолчанию. Это поведение по умолчанию необходимо, чтобы принудительно инициировать получение фоновых данных ресурса с сервера-источника на пограничном сервере. После этого ресурс будет находиться в локальном кэше пограничного сервера. Когда полный объект находится в кэше, пограничный сервер может выполнять запросы диапазонов байтов в CDN для кэшированного объекта.

Поведение завершения заполнения кэша по умолчанию можно отключить с помощью обработчика правил на уровне Verizon Premium.

### <a name="peer-cache-fill-hotfiling"></a>Заполнение однорангового кэша "горячими" данными

Эту функцию по умолчанию Azure CDN от Verizon можно описать следующим образом: сложный закрытый алгоритм может использовать дополнительные пограничные серверы кэширования на основе метрик, например запросы статистической обработки и пропускной способности, чтобы выполнить клиентские запросы больших распространенных объектов. Эта функция необходима, чтобы предотвратить отправку большого количества дополнительных запросов на клиентский сервер-источник. 

### <a name="conditions-for-large-file-optimization"></a>Условия для оптимизации больших файлов

Функции оптимизации для Verizon включены по умолчанию, а для размера файла отсутствуют ограничения. 

## <a name="additional-considerations"></a>Дополнительные замечания

При использовании этого типа оптимизации есть еще несколько дополнительных аспектов, которые следует учесть.
 
### <a name="azure-cdn-from-akamai"></a>Azure CDN от Akamai

- Процесс фрагментирования вызывает отправку дополнительных запросов на сервер-источник, но общий объем данных, отправляемых из источника, будет намного меньше, так как фрагментирование приводит к улучшению характеристик кэширования в CDN.
- Также благодаря доставке небольших фрагментов файла дополнительное преимущество заключается в снижении выделений памяти и нагрузки от операций ввода-вывода на источнике. 
- Для блоков, кэшируемых в CDN, будут отсутствовать дополнительные запросы для источника до истечения срока действия содержимого из кэша или его исключения по другим причинам. 
- Пользователь может выполнять запросы диапазона в CDN, и они будут обрабатываться как и любой стандартный файл. Оптимизацию можно применить только в случае допустимого типа файла и диапазона байтов 10–150 ГБ. Если средний размер запрашиваемого файла меньше 10 МБ, вы можете использовать в качестве альтернативы оптимизацию типа общей веб-доставки.

### <a name="azure-cdn-from-verizon"></a>Azure CDN от Verizon

Оптимизация типа общей веб-доставки способна доставлять большие файлы.

